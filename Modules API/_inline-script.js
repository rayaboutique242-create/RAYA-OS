?    const DEBUG = false;
    if (!DEBUG && typeof console !== 'undefined') {
        const noop = () => {};
        console.log = noop;
        console.debug = noop;
        console.info = noop;
        console.warn = noop;
    }

    const Utils = {
        uid(prefix = 'ID') {
            const time = Date.now().toString(36);
            const random = Math.random().toString(36).slice(2, 10);
            const core = `${time}${random}`.toUpperCase();
            return prefix ? `${prefix}-${core}` : core;
        },
        safeJsonParse(str, fallback = null) {
            try { return JSON.parse(str); } catch (err) { return fallback; }
        },
        todayKey(offset = 0) {
            const date = new Date();
            if (offset) date.setDate(date.getDate() + Number(offset));
            return date.toISOString().slice(0, 10);
        },
        clamp(value, min, max) {
            const num = Number(value);
            if (Number.isNaN(num)) return min;
            return Math.min(Math.max(num, min), max);
        },
        async md5(str) {
            const input = String(str || '');
            try {
                if (window.crypto?.subtle && typeof TextEncoder !== 'undefined') {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(input);
                    const digest = await window.crypto.subtle.digest('SHA-256', data);
                    return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2, '0')).join('');
                }
            } catch (err) {}
            return this.md5Sync(input);
        },
        md5Sync(str) {
            let hash = 0;
            const input = String(str || '');
            for (let i = 0; i < input.length; i++) {
                const char = input.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0;
            }
            const absHash = Math.abs(hash);
            const hex = absHash.toString(16) || '0';
            const repeats = Math.ceil(64 / hex.length);
            return hex.repeat(repeats).slice(0, 64);
        },
        readFileAsDataUrl(file) {
            return new Promise((resolve, reject) => {
                if (!file) return reject(new Error('Fichier invalide'));
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error || new Error('Lecture impossible'));
                reader.readAsDataURL(file);
            });
        }
    };
    window.Utils = Utils;

    // =========================================================
    // API CLIENT (SaaS Backend)
    // =========================================================
    const API = {
        // Utilise le backend direct (Docker/NestJS) sans /api
        baseUrl: localStorage.getItem('raya_api_url') || 'https://rara-os-production.up.railway.app',
        setBaseUrl(url) {
            this.baseUrl = url;
            localStorage.setItem('raya_api_url', url);
        },
        getToken() {
            return localStorage.getItem('raya_token');
        },
        setToken(token) {
            if (token) localStorage.setItem('raya_token', token);
        },
        async request(path, options = {}) {
            const url = `${this.baseUrl}${path}`;
            const headers = Object.assign({ 'Content-Type': 'application/json' }, options.headers || {});
            const token = this.getToken();
            if (token) headers.Authorization = `Bearer ${token}`;

            const res = await fetch(url, {
                method: options.method || 'GET',
                headers,
                body: options.body ? JSON.stringify(options.body) : undefined
            });

            if (!res.ok) {
                const errText = await res.text();
                throw new Error(errText || `API error ${res.status}`);
            }
            const contentType = res.headers.get('content-type') || '';
            return contentType.includes('application/json') ? res.json() : res.text();
        },
        login(email, password) {
            return this.request('/auth/login', { method: 'POST', body: { email, password } });
        },
        getMe() {
            return this.request('/users/me', { method: 'GET' });
        },
        register(username, email, password, tenantId, role = 'VENDEUR') {
            return this.request('/auth/register', { method: 'POST', body: { username, email, password, tenantId, role } });
        },
        createTenant(name, ownerName, ownerEmail) {
            // Le backend attend email ET ownerEmail
            return this.request('/tenants', { method: 'POST', body: { name, ownerName, email: ownerEmail, ownerEmail } });
        },
        joinByCode(code) {
            return this.request('/invitations/join', { method: 'POST', body: { code } });
        },
        sendOtp(contact) {
            return this.request('/auth/otp/send', { method: 'POST', body: { contact } });
        },
        verifyOtp(contact, code) {
            return this.request('/auth/otp/verify', { method: 'POST', body: { contact, code } });
        },
        listJoinRequests() {
            return this.request('/invitations/requests', { method: 'GET' });
        },
        approveJoinRequest(id) {
            return this.request(`/invitations/requests/${id}/approve`, { method: 'POST' });
        },
        rejectJoinRequest(id) {
            return this.request(`/invitations/requests/${id}/reject`, { method: 'POST' });
        },

        // ==================== CATEGORIES ====================
        getCategories(query = {}) {
            const params = new URLSearchParams(query).toString();
            return this.request(`/categories${params ? '?' + params : ''}`, { method: 'GET' });
        },
        createCategory(data) {
            return this.request('/categories', { method: 'POST', body: data });
        },
        updateCategory(id, data) {
            return this.request(`/categories/${id}`, { method: 'PATCH', body: data });
        },
        deleteCategory(id) {
            return this.request(`/categories/${id}`, { method: 'DELETE' });
        },

        // ==================== PRODUCTS ====================
        getProducts(query = {}) {
            const params = new URLSearchParams(query).toString();
            return this.request(`/products${params ? '?' + params : ''}`, { method: 'GET' });
        },
        getProduct(id) {
            return this.request(`/products/${id}`, { method: 'GET' });
        },
        getProductBySku(sku) {
            return this.request(`/products/sku/${sku}`, { method: 'GET' });
        },
        getProductByBarcode(barcode) {
            return this.request(`/products/barcode/${barcode}`, { method: 'GET' });
        },
        getProductStats() {
            return this.request('/products/stats', { method: 'GET' });
        },
        getLowStockProducts() {
            return this.request('/products/low-stock', { method: 'GET' });
        },
        createProduct(data) {
            return this.request('/products', { method: 'POST', body: data });
        },
        updateProduct(id, data) {
            return this.request(`/products/${id}`, { method: 'PATCH', body: data });
        },
        updateProductStock(id, quantity) {
            return this.request(`/products/${id}/stock`, { method: 'PATCH', body: { quantity } });
        },
        adjustProductStock(id, adjustment) {
            return this.request(`/products/${id}/stock/adjust`, { method: 'PATCH', body: { adjustment } });
        },
        deleteProduct(id) {
            return this.request(`/products/${id}`, { method: 'DELETE' });
        },

        // ==================== ORDERS ====================
        getOrders(query = {}) {
            const params = new URLSearchParams(query).toString();
            return this.request(`/orders${params ? '?' + params : ''}`, { method: 'GET' });
        },
        getOrder(id) {
            return this.request(`/orders/${id}`, { method: 'GET' });
        },
        getOrderByNumber(orderNumber) {
            return this.request(`/orders/number/${orderNumber}`, { method: 'GET' });
        },
        getOrderStats(dateFrom, dateTo) {
            const params = new URLSearchParams();
            if (dateFrom) params.set('dateFrom', dateFrom);
            if (dateTo) params.set('dateTo', dateTo);
            const qs = params.toString();
            return this.request(`/orders/stats${qs ? '?' + qs : ''}`, { method: 'GET' });
        },
        createOrder(data) {
            return this.request('/orders', { method: 'POST', body: data });
        },
        updateOrder(id, data) {
            return this.request(`/orders/${id}`, { method: 'PATCH', body: data });
        },
        updateOrderStatus(id, status) {
            return this.request(`/orders/${id}/status`, { method: 'PATCH', body: { status } });
        },
        addOrderPayment(id, paymentData) {
            return this.request(`/orders/${id}/payment`, { method: 'POST', body: paymentData });
        },
        cancelOrder(id) {
            return this.request(`/orders/${id}/cancel`, { method: 'POST' });
        },

        // ==================== INVENTORY ====================
        getInventory(query = {}) {
            const params = new URLSearchParams(query).toString();
            return this.request(`/inventory${params ? '?' + params : ''}`, { method: 'GET' });
        },
        getInventoryMovements(query = {}) {
            const params = new URLSearchParams(query).toString();
            return this.request(`/inventory/movements${params ? '?' + params : ''}`, { method: 'GET' });
        },
        createStockMovement(data) {
            return this.request('/inventory/movements', { method: 'POST', body: data });
        },
        transferStock(data) {
            return this.request('/inventory/transfer', { method: 'POST', body: data });
        },

        // ==================== CUSTOMERS ====================
        getCustomers(query = {}) {
            const params = new URLSearchParams(query).toString();
            return this.request(`/customers${params ? '?' + params : ''}`, { method: 'GET' });
        },
        getCustomer(id) {
            return this.request(`/customers/${id}`, { method: 'GET' });
        },
        createCustomer(data) {
            return this.request('/customers', { method: 'POST', body: data });
        },
        updateCustomer(id, data) {
            return this.request(`/customers/${id}`, { method: 'PATCH', body: data });
        },
        deleteCustomer(id) {
            return this.request(`/customers/${id}`, { method: 'DELETE' });
        },

        // ==================== STORES (POINTS OF SALE) ====================
        getStores() {
            return this.request('/tenants/stores', { method: 'GET' });
        },
        createStore(data) {
            return this.request('/tenants/stores', { method: 'POST', body: data });
        },
        updateStore(id, data) {
            return this.request(`/tenants/stores/${id}`, { method: 'PATCH', body: data });
        },

        // ==================== USERS ====================
        getUsers() {
            return this.request('/users', { method: 'GET' });
        },
        getUser(id) {
            return this.request(`/users/${id}`, { method: 'GET' });
        },
        updateUser(id, data) {
            return this.request(`/users/${id}`, { method: 'PATCH', body: data });
        },
        deleteUser(id) {
            return this.request(`/users/${id}`, { method: 'DELETE' });
        },

        // ==================== REPORTS / ANALYTICS ====================
        getDashboardStats() {
            return this.request('/analytics/dashboard', { method: 'GET' });
        },
        getSalesReport(dateFrom, dateTo) {
            const params = new URLSearchParams();
            if (dateFrom) params.set('dateFrom', dateFrom);
            if (dateTo) params.set('dateTo', dateTo);
            return this.request(`/reports/sales?${params.toString()}`, { method: 'GET' });
        },

        // ==================== SYNC ====================
        async syncAll() {
            const results = { categories: null, products: null, orders: null, customers: null, error: null };
            try {
                const [cats, prods, orders, customers] = await Promise.all([
                    this.getCategories().catch(e => ({ error: e.message })),
                    this.getProducts().catch(e => ({ error: e.message })),
                    this.getOrders().catch(e => ({ error: e.message })),
                    this.getCustomers().catch(e => ({ error: e.message }))
                ]);
                results.categories = cats;
                results.products = prods;
                results.orders = orders;
                results.customers = customers;
            } catch (e) {
                results.error = e.message;
            }
            return results;
        }
    };

    // =========================================================
    // SYNC MODULE - Synchronisation avec le Backend
    // =========================================================
    const SyncManager = {
        isOnline: true,
        isSyncing: false,
        lastSync: null,
        syncQueue: [],
        syncMode: localStorage.getItem('raya_sync_mode') || 'auto', // 'auto', 'manual', 'offline'
        
        init() {
            this.isOnline = navigator.onLine;
            window.addEventListener('online', () => this.handleOnline());
            window.addEventListener('offline', () => this.handleOffline());
            
            // Sync automatique toutes les 5 minutes si mode auto
            if (this.syncMode === 'auto') {
                setInterval(() => this.syncIfNeeded(), 5 * 60 * 1000);
            }
        },
        
        handleOnline() {
            this.isOnline = true;
            if (typeof UI !== 'undefined') UI.toast(' Connexion r�tablie', 'success');
            this.processSyncQueue();
        },
        
        handleOffline() {
            this.isOnline = false;
            if (typeof UI !== 'undefined') UI.toast(' Mode hors-ligne', 'warning');
        },
        
        setSyncMode(mode) {
            this.syncMode = mode;
            localStorage.setItem('raya_sync_mode', mode);
        },
        
        async syncIfNeeded() {
            if (!this.isOnline || this.isSyncing || this.syncMode === 'offline') return;
            const token = API.getToken();
            if (!token) return; // Pas connect�
            
            // Sync si plus de 5 min depuis le dernier sync
            const lastSync = localStorage.getItem('raya_last_sync');
            if (lastSync) {
                const diff = Date.now() - new Date(lastSync).getTime();
                if (diff < 5 * 60 * 1000) return;
            }
            
            await this.syncAll();
        },
        
        async syncAll() {
            if (this.isSyncing) return { success: false, message: 'Sync en cours' };
            
            const token = API.getToken();
            if (!token) return { success: false, message: 'Non authentifi�' };
            
            this.isSyncing = true;
            if (typeof UI !== 'undefined') UI.toast(' Synchronisation...', 'info');
            
            try {
                // R�cup�rer les donn�es du serveur
                const [categories, products, orders, customers] = await Promise.all([
                    API.getCategories().catch(e => ({ data: [], error: e.message })),
                    API.getProducts().catch(e => ({ data: [], error: e.message })),
                    API.getOrders({ limit: 100 }).catch(e => ({ data: [], error: e.message })),
                    API.getCustomers({ limit: 100 }).catch(e => ({ data: [], error: e.message }))
                ]);
                
                // Mettre � jour CORE.db avec les donn�es du serveur
                if (categories.data && Array.isArray(categories.data)) {
                    CORE.db.categories = this.mapCategories(categories.data);
                }
                if (products.data && Array.isArray(products.data)) {
                    CORE.db.products = this.mapProducts(products.data);
                }
                if (orders.data && Array.isArray(orders.data)) {
                    CORE.db.orders = this.mapOrders(orders.data);
                }
                if (customers.data && Array.isArray(customers.data)) {
                    CORE.db.clients = this.mapCustomers(customers.data);
                }
                
                CORE.save();
                this.lastSync = new Date().toISOString();
                localStorage.setItem('raya_last_sync', this.lastSync);
                
                this.isSyncing = false;
                if (typeof UI !== 'undefined') UI.toast(' Synchronisation termin�e', 'success');
                
                return { success: true, lastSync: this.lastSync };
            } catch (error) {
                this.isSyncing = false;
                if (typeof UI !== 'undefined') UI.toast(' Erreur de sync: ' + error.message, 'error');
                return { success: false, error: error.message };
            }
        },
        
        // Mappers: Backend -> Frontend format
        mapCategories(serverCategories) {
            return serverCategories.map(cat => ({
                id: cat.id,
                name: cat.name,
                icon: cat.icon || 'tag',
                slug: cat.slug,
                description: cat.description,
                parentId: cat.parentId,
                order: cat.order,
                isActive: cat.isActive
            }));
        },
        
        mapProducts(serverProducts) {
            return serverProducts.map(prod => ({
                id: prod.id,
                name: prod.name,
                categoryId: prod.categoryId,
                price: prod.sellingPrice || prod.price,
                costPrice: prod.costPrice,
                stock: prod.stockQuantity || prod.stock || 0,
                minStock: prod.minStock || 10,
                barcode: prod.barcode,
                sku: prod.sku,
                active: prod.isActive !== false,
                posId: prod.storeId || 1,
                description: prod.description,
                unit: prod.unit,
                imageUrl: prod.imageUrl
            }));
        },
        
        mapOrders(serverOrders) {
            return serverOrders.map(order => ({
                id: order.id,
                orderRef: order.orderNumber,
                clientId: order.customerId,
                clientName: order.customerName || order.customer?.name,
                items: (order.items || []).map(item => ({
                    productId: item.productId,
                    productName: item.productName || item.product?.name,
                    quantity: item.quantity,
                    price: item.unitPrice,
                    total: item.totalPrice
                })),
                total: order.totalAmount,
                status: order.status?.toLowerCase() || 'pending',
                paymentStatus: order.paymentStatus?.toLowerCase() || 'pending',
                paidAmount: order.paidAmount || 0,
                createdAt: order.createdAt,
                notes: order.notes
            }));
        },
        
        mapCustomers(serverCustomers) {
            return serverCustomers.map(cust => ({
                id: cust.id,
                name: cust.name || `${cust.firstName || ''} ${cust.lastName || ''}`.trim(),
                phone: cust.phone,
                email: cust.email,
                address: cust.address,
                totalOrders: cust.totalOrders || 0,
                totalSpent: cust.totalSpent || 0,
                segment: cust.segment || 'regular',
                notes: cust.notes,
                posId: cust.storeId || 1
            }));
        },
        
        // Enqueue operation for offline sync
        enqueue(operation) {
            this.syncQueue.push({
                ...operation,
                timestamp: new Date().toISOString(),
                id: Date.now()
            });
            localStorage.setItem('raya_sync_queue', JSON.stringify(this.syncQueue));
        },
        
        async processSyncQueue() {
            if (!this.isOnline || this.syncQueue.length === 0) return;
            
            const queue = [...this.syncQueue];
            this.syncQueue = [];
            
            for (const op of queue) {
                try {
                    await this.processOperation(op);
                } catch (e) {
                    // Re-queue failed operations
                    this.syncQueue.push(op);
                }
            }
            
            localStorage.setItem('raya_sync_queue', JSON.stringify(this.syncQueue));
        },
        
        async processOperation(op) {
            switch (op.type) {
                case 'CREATE_PRODUCT':
                    await API.createProduct(op.data);
                    break;
                case 'UPDATE_PRODUCT':
                    await API.updateProduct(op.id, op.data);
                    break;
                case 'CREATE_ORDER':
                    await API.createOrder(op.data);
                    break;
                case 'UPDATE_ORDER':
                    await API.updateOrder(op.id, op.data);
                    break;
                case 'CREATE_CUSTOMER':
                    await API.createCustomer(op.data);
                    break;
                case 'UPDATE_CUSTOMER':
                    await API.updateCustomer(op.id, op.data);
                    break;
            }
        },
        
        // Push local changes to server
        async pushProduct(product) {
            if (!this.isOnline) {
                this.enqueue({ type: 'CREATE_PRODUCT', data: product });
                return { queued: true };
            }
            
            const serverData = {
                name: product.name,
                categoryId: product.categoryId,
                sellingPrice: product.price,
                costPrice: product.costPrice || 0,
                stockQuantity: product.stock || 0,
                minStock: product.minStock || 10,
                barcode: product.barcode,
                sku: product.sku || '',
                description: product.description || '',
                unit: product.unit || 'piece'
            };
            
            return await API.createProduct(serverData);
        },
        
        async pushOrder(order) {
            if (!this.isOnline) {
                this.enqueue({ type: 'CREATE_ORDER', data: order });
                return { queued: true };
            }
            
            const serverData = {
                customerId: order.clientId,
                items: order.items.map(item => ({
                    productId: item.productId,
                    quantity: item.quantity
                })),
                notes: order.notes || ''
            };
            
            return await API.createOrder(serverData);
        },
        
        getLastSyncTime() {
            return localStorage.getItem('raya_last_sync');
        },
        
        getQueueLength() {
            return this.syncQueue.length;
        },
        
        // Bouton de sync pour tous les modules
        renderSyncButton(compact = false) {
            const lastSync = this.lastSync || localStorage.getItem('raya_last_sync');
            const lastSyncText = lastSync ? new Date(lastSync).toLocaleTimeString('fr-FR') : 'Jamais';
            const queueCount = this.syncQueue.length;
            
            if (compact) {
                return `
                    <button onclick="SyncManager.syncAll()" class="p-2 rounded-lg bg-emerald-100 hover:bg-emerald-200 text-emerald-700 transition" title="Derni�re sync: ${lastSyncText}">
                        <i data-lucide="cloud-cog" class="w-4 h-4"></i>
                    </button>
                `;
            }
            
            return `
                <button onclick="SyncManager.showSyncDetails()" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-100 hover:bg-emerald-200 text-xs font-bold text-emerald-700 transition">
                    <i data-lucide="cloud-cog" class="w-3 h-3"></i>
                    <span>Sync</span>
                    ${(queueCount > 0 ? '<span class="w-4 h-4 bg-orange-500 text-white text-[10px] rounded-full flex items-center justify-center">'+queueCount+'</span>' : '')}
                </button>
            `;
        },
        
        showSyncDetails() {
            if (typeof PDGModule !== 'undefined' && PDGModule.showSyncModal) {
                PDGModule.showSyncModal();
            } else {
                this.syncAll();
            }
        }
    };
    
    // Init SyncManager when document ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => SyncManager.init());
    } else {
        SyncManager.init();
    }

    // =========================================================
    // GOOGLE MAPS (Embed + Optional JS API)
    // =========================================================
    // Google Maps auth error hook: fallback to iframe when key is invalid/restricted
    window.gm_authFailure = function() {
        try {
            if (window.CORE && window.CORE.config) {
                window.CORE.config.googleMapsApiKey = '';
                try { window.CORE.save && window.CORE.save(); } catch (e) {}
            }
        } catch (e) {}
        try { UI?.toast && UI.toast('Google Maps API: cl� invalide (fallback iframe).', 'warning'); } catch (e) {}
    };

    const Maps = {
        // Default center: Brazzaville
        defaultCenter: { lat: -4.263359, lng: 15.242885 },
        _apiLoaded: false,
        _apiLoading: false,
        _queue: [],

        encode(obj) {
            try {
                return btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
            } catch(e) {
                return '';
            }
        },
        decode(b64) {
            try {
                return JSON.parse(decodeURIComponent(escape(atob(b64))));
            } catch(e) {
                return null;
            }
        },

        embedUrl(query) {
            const q = String(query || '').trim() || 'Brazzaville, Congo';
            return `https://www.google.com/maps?q=${encodeURIComponent(q)}&output=embed`;
        },

        directionsUrl(destination, origin = null) {
            const dest = String(destination || '').trim();
            if (!dest) return 'https://www.google.com/maps';
            const base = 'https://www.google.com/maps/dir/?api=1';
            const params = new URLSearchParams();
            params.set('destination', dest);
            if (origin) params.set('origin', String(origin));
            params.set('travelmode', 'driving');
            return `${base}&${params.toString()}`;
        },

        openDirections(destination, origin = null) {
            window.open(this.directionsUrl(destination, origin), '_blank');
        },

        openDirectionsB64(b64) {
            const data = this.decode(b64) || {};
            const destination = data.destination || data.address || '';
            const origin = data.origin || null;
            return this.openDirections(destination, origin);
        },

        getApiKey() {
            // When served from file://, Google Maps JS API often fails due to referrer restrictions.
            // Prefer iframe mode in that case.
            try {
                if (location.protocol === 'file:') return '';
            } catch(e) {}
            const k = (window.CORE?.config?.googleMapsApiKey || '').trim();
            return k;
        },

        ensureApi(cb) {
            const key = this.getApiKey();
            if (!key) return;
            if (this._apiLoaded) return cb && cb();
            this._queue.push(cb);
            if (this._apiLoading) return;
            this._apiLoading = true;

            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&libraries=places`;
            script.async = true;
            script.defer = true;
            script.onload = () => {
                this._apiLoaded = true;
                this._apiLoading = false;
                const q = [...this._queue];
                this._queue = [];
                q.forEach(fn => { try { fn && fn(); } catch(e) {} });
            };
            script.onerror = () => {
                this._apiLoading = false;
                this._queue = [];
                // Fallback to iframe mode if API fails to load (invalid key, blocked referrer, network)
                try {
                    if (window.CORE && window.CORE.config) {
                        window.CORE.config.googleMapsApiKey = '';
                        try { window.CORE.save && window.CORE.save(); } catch(e) {}
                    }
                } catch(e) {}
                try { UI?.toast && UI.toast('Google Maps API indisponible (fallback iframe).', 'warning'); } catch(e) {}
                try { App?.rerender && App.rerender(); } catch(e) {}
            };
            document.head.appendChild(script);
        },

        initMapsFromDom() {
            const containers = document.querySelectorAll('[data-gmap]');
            if (!containers.length) return;

            const key = this.getApiKey();
            if (!key) return; // iframe mode is used when no key

            this.ensureApi(() => {
                containers.forEach((el) => {
                    if (el.__gmapInited) return;
                    const payload = el.getAttribute('data-gmap');
                    const data = this.decode(payload) || {};
                    const canvas = el.querySelector('[data-gmap-canvas]');
                    if (!canvas) return;

                    el.__gmapInited = true;

                    const map = new google.maps.Map(canvas, {
                        center: this.defaultCenter,
                        zoom: 13,
                        mapTypeControl: false,
                        streetViewControl: false,
                        fullscreenControl: false
                    });

                    const destination = String(data.destination || '').trim();
                    if (!destination) return;

                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ address: destination }, (results, status) => {
                        if (status !== 'OK' || !results || !results[0]) return;
                        const loc = results[0].geometry.location;
                        map.setCenter(loc);
                        map.setZoom(15);
                        new google.maps.Marker({ map, position: loc, title: data.label || destination });
                    });
                });
            });
        },

        afterRender() {
            // Called after each App.mount
            this.initMapsFromDom();
        }
    };

    // =========================================================
    // SYST�?ME DE TRADUCTION (i18n)
    // =========================================================
    const i18n = {
        currentLang: 'fr',
        current: 'fr',
        
        translations: {
            fr: {
                // Navigation & Menu
                'nav.home': 'Accueil',
                'nav.orders': 'Commandes',
                'nav.products': 'Produits',
                'nav.clients': 'Clients',
                'nav.delivery': 'Livraison',
                'nav.finance': 'Finance',
                'nav.settings': 'Param��tres',
                'nav.help': 'Aide',
                'nav.logout': 'D�connexion',
                'nav.profile': 'Profil',
                
                // Actions
                'action.save': 'Enregistrer',
                'action.cancel': 'Annuler',
                'action.delete': 'Supprimer',
                'action.edit': 'Modifier',
                'action.add': 'Ajouter',
                'action.search': 'Rechercher',
                'action.filter': 'Filtrer',
                'action.export': 'Exporter',
                'action.print': 'Imprimer',
                'action.confirm': 'Confirmer',
                'action.close': 'Fermer',
                'action.back': 'Retour',
                'action.next': 'Suivant',
                'action.previous': 'Pr�c�dent',
                'action.validate': 'Valider',
                'action.send': 'Envoyer',
                
                // Status
                'status.pending': 'En attente',
                'status.confirmed': 'Confirm�',
                'status.shipped': 'Exp�di�',
                'status.delivered': 'Livr�',
                'status.cancelled': 'Annul�',
                'status.returned': 'Retourn�',
                'status.active': 'Actif',
                'status.inactive': 'Inactif',
                'status.paid': 'Pay�',
                'status.unpaid': 'Non pay�',
                
                // Labels
                'label.date': 'Date',
                'label.amount': 'Montant',
                'label.total': 'Total',
                'label.quantity': 'Quantit�',
                'label.price': 'Prix',
                'label.name': 'Nom',
                'label.phone': 'T�l�phone',
                'label.address': 'Adresse',
                'label.email': 'Email',
                'label.notes': 'Notes',
                'label.description': 'Description',
                'label.category': 'Cat�gorie',
                'label.payment': 'Paiement',
                'label.customer': 'Client',
                'label.product': 'Produit',
                'label.order': 'Commande',
                'label.delivery': 'Livraison',
                'label.stock': 'Stock',
                'label.revenue': 'Chiffre d\'affaires',
                'label.profit': 'B�n�fice',
                'label.expenses': 'D�penses',
                
                // Messages
                'msg.success': 'Op�ration r�ussie',
                'msg.error': 'Une erreur est survenue',
                'msg.loading': 'Chargement...',
                'msg.noData': 'Aucune donn�e',
                'msg.confirmDelete': '�?Štes-vous s��r de vouloir supprimer ?',
                'msg.saved': 'Enregistr� avec succ��s',
                'msg.deleted': 'Supprim� avec succ��s',
                'msg.updated': 'Mis �� jour avec succ��s',
                
                // Time
                'time.today': 'Aujourd\'hui',
                'time.yesterday': 'Hier',
                'time.thisWeek': 'Cette semaine',
                'time.thisMonth': 'Ce mois',
                'time.thisYear': 'Cette ann�e',
                
                // Settings
                'settings.theme': 'Th��me',
                'settings.language': 'Langue',
                'settings.notifications': 'Notifications',
                'settings.preferences': 'Pr�f�rences',
                'settings.light': 'Clair',
                'settings.dark': 'Sombre',
                'settings.auto': 'Auto',
                
                // Dashboard
                'dashboard.welcome': 'Bienvenue',
                'dashboard.todaySales': 'Ventes du jour',
                'dashboard.pendingOrders': 'Commandes en attente',
                'dashboard.lowStock': 'Stock faible',
                'dashboard.newClients': 'Nouveaux clients',
                
                // Products
                'product.addNew': 'Nouveau produit',
                'product.inStock': 'En stock',
                'product.outOfStock': 'Rupture de stock',
                'product.lowStock': 'Stock faible',
                
                // Orders
                'order.new': 'Nouvelle commande',
                'order.details': 'D�tails de la commande',
                'order.items': 'Articles',
                'order.subtotal': 'Sous-total',
                'order.tax': 'Taxe',
                'order.discount': 'Remise',
                
                // Finance
                'finance.income': 'Revenus',
                'finance.expenses': 'D�penses',
                'finance.balance': 'Solde',
                'finance.transactions': 'Transactions',
                'finance.budget': 'Budget',
                'finance.report': 'Rapport financier',
                
                // Vendeur specific
                'vendeur.myPos': 'Mon Point de Vente',
                'vendeur.mySales': 'Mes Ventes',
                'vendeur.myClients': 'Mes Clients',
                'vendeur.newSale': 'Nouvelle Vente',
                'vendeur.cart': 'Panier',
                'vendeur.checkout': 'Paiement',
                
                // Vendor menu items
                'menu.dashboard': 'Tableau de bord',
                'menu.pos': 'Point de vente',
                'menu.clients': 'Clients',
                'menu.orders': 'Commandes',
                'menu.stock': 'Stock',
                'menu.deliverers': 'Livreurs',
                'menu.reservations': 'R�servations',
                'menu.commissions': 'Commissions',
                'menu.routing': 'Routage',
                'menu.finance': 'Finance',
                'menu.assignment': 'Assignation',
                'menu.reports': 'Rapports',
                'menu.settings': 'Param��tres',
                'menu.logout': 'D�connexion',
                'menu.all': 'Tout',
                'menu.seeAll': 'Voir tout'
            },
            
            en: {
                // Navigation & Menu
                'nav.home': 'Home',
                'nav.orders': 'Orders',
                'nav.products': 'Products',
                'nav.clients': 'Customers',
                'nav.delivery': 'Delivery',
                'nav.finance': 'Finance',
                'nav.settings': 'Settings',
                'nav.help': 'Help',
                'nav.logout': 'Logout',
                'nav.profile': 'Profile',
                
                // Actions
                'action.save': 'Save',
                'action.cancel': 'Cancel',
                'action.delete': 'Delete',
                'action.edit': 'Edit',
                'action.add': 'Add',
                'action.search': 'Search',
                'action.filter': 'Filter',
                'action.export': 'Export',
                'action.print': 'Print',
                'action.confirm': 'Confirm',
                'action.close': 'Close',
                'action.back': 'Back',
                'action.next': 'Next',
                'action.previous': 'Previous',
                'action.validate': 'Validate',
                'action.send': 'Send',
                
                // Status
                'status.pending': 'Pending',
                'status.confirmed': 'Confirmed',
                'status.shipped': 'Shipped',
                'status.delivered': 'Delivered',
                'status.cancelled': 'Cancelled',
                'status.returned': 'Returned',
                'status.active': 'Active',
                'status.inactive': 'Inactive',
                'status.paid': 'Paid',
                'status.unpaid': 'Unpaid',
                
                // Labels
                'label.date': 'Date',
                'label.amount': 'Amount',
                'label.total': 'Total',
                'label.quantity': 'Quantity',
                'label.price': 'Price',
                'label.name': 'Name',
                'label.phone': 'Phone',
                'label.address': 'Address',
                'label.email': 'Email',
                'label.notes': 'Notes',
                'label.description': 'Description',
                'label.category': 'Category',
                'label.payment': 'Payment',
                'label.customer': 'Customer',
                'label.product': 'Product',
                'label.order': 'Order',
                'label.delivery': 'Delivery',
                'label.stock': 'Stock',
                'label.revenue': 'Revenue',
                'label.profit': 'Profit',
                'label.expenses': 'Expenses',
                
                // Messages
                'msg.success': 'Operation successful',
                'msg.error': 'An error occurred',
                'msg.loading': 'Loading...',
                'msg.noData': 'No data',
                'msg.confirmDelete': 'Are you sure you want to delete?',
                'msg.saved': 'Saved successfully',
                'msg.deleted': 'Deleted successfully',
                'msg.updated': 'Updated successfully',
                
                // Time
                'time.today': 'Today',
                'time.yesterday': 'Yesterday',
                'time.thisWeek': 'This week',
                'time.thisMonth': 'This month',
                'time.thisYear': 'This year',
                
                // Settings
                'settings.theme': 'Theme',
                'settings.language': 'Language',
                'settings.notifications': 'Notifications',
                'settings.preferences': 'Preferences',
                'settings.light': 'Light',
                'settings.dark': 'Dark',
                'settings.auto': 'Auto',
                
                // Dashboard
                'dashboard.welcome': 'Welcome',
                'dashboard.todaySales': 'Today\'s Sales',
                'dashboard.pendingOrders': 'Pending Orders',
                'dashboard.lowStock': 'Low Stock',
                'dashboard.newClients': 'New Customers',
                
                // Products
                'product.addNew': 'New Product',
                'product.inStock': 'In Stock',
                'product.outOfStock': 'Out of Stock',
                'product.lowStock': 'Low Stock',
                
                // Orders
                'order.new': 'New Order',
                'order.details': 'Order Details',
                'order.items': 'Items',
                'order.subtotal': 'Subtotal',
                'order.tax': 'Tax',
                'order.discount': 'Discount',
                
                // Finance
                'finance.income': 'Income',
                'finance.expenses': 'Expenses',
                'finance.balance': 'Balance',
                'finance.transactions': 'Transactions',
                'finance.budget': 'Budget',
                'finance.report': 'Financial Report',
                
                // Vendeur specific
                'vendeur.myPos': 'My Point of Sale',
                'vendeur.mySales': 'My Sales',
                'vendeur.myClients': 'My Customers',
                'vendeur.newSale': 'New Sale',
                'vendeur.cart': 'Cart',
                'vendeur.checkout': 'Checkout',
                
                // Vendor menu items
                'menu.dashboard': 'Dashboard',
                'menu.pos': 'Point of Sale',
                'menu.clients': 'Customers',
                'menu.orders': 'Orders',
                'menu.stock': 'Stock',
                'menu.deliverers': 'Deliverers',
                'menu.reservations': 'Reservations',
                'menu.commissions': 'Commissions',
                'menu.routing': 'Routing',
                'menu.finance': 'Finance',
                'menu.assignment': 'Assignment',
                'menu.reports': 'Reports',
                'menu.settings': 'Settings',
                'menu.logout': 'Logout',
                'menu.all': 'All',
                'menu.seeAll': 'See all'
            },
            
            es: {
                // Navigation & Menu
                'nav.home': 'Inicio',
                'nav.orders': 'Pedidos',
                'nav.products': 'Productos',
                'nav.clients': 'Clientes',
                'nav.delivery': 'Entrega',
                'nav.finance': 'Finanzas',
                'nav.settings': 'Configuraci��n',
                'nav.help': 'Ayuda',
                'nav.logout': 'Cerrar sesi��n',
                'nav.profile': 'Perfil',
                
                // Actions
                'action.save': 'Guardar',
                'action.cancel': 'Cancelar',
                'action.delete': 'Eliminar',
                'action.edit': 'Editar',
                'action.add': 'Agregar',
                'action.search': 'Buscar',
                'action.filter': 'Filtrar',
                'action.export': 'Exportar',
                'action.print': 'Imprimir',
                'action.confirm': 'Confirmar',
                'action.close': 'Cerrar',
                'action.back': 'Atr��s',
                'action.next': 'Siguiente',
                'action.previous': 'Anterior',
                'action.validate': 'Validar',
                'action.send': 'Enviar',
                
                // Status
                'status.pending': 'Pendiente',
                'status.confirmed': 'Confirmado',
                'status.shipped': 'Enviado',
                'status.delivered': 'Entregado',
                'status.cancelled': 'Cancelado',
                'status.returned': 'Devuelto',
                'status.active': 'Activo',
                'status.inactive': 'Inactivo',
                'status.paid': 'Pagado',
                'status.unpaid': 'No pagado',
                
                // Labels
                'label.date': 'Fecha',
                'label.amount': 'Monto',
                'label.total': 'Total',
                'label.quantity': 'Cantidad',
                'label.price': 'Precio',
                'label.name': 'Nombre',
                'label.phone': 'Tel�fono',
                'label.address': 'Direcci��n',
                'label.email': 'Correo',
                'label.notes': 'Notas',
                'label.description': 'Descripci��n',
                'label.category': 'Categor��a',
                'label.payment': 'Pago',
                'label.customer': 'Cliente',
                'label.product': 'Producto',
                'label.order': 'Pedido',
                'label.delivery': 'Entrega',
                'label.stock': 'Stock',
                'label.revenue': 'Ingresos',
                'label.profit': 'Beneficio',
                'label.expenses': 'Gastos',
                
                // Messages
                'msg.success': 'Operaci��n exitosa',
                'msg.error': 'Ocurri�� un error',
                'msg.loading': 'Cargando...',
                'msg.noData': 'Sin datos',
                'msg.confirmDelete': '�? �Est�� seguro de que desea eliminar?',
                'msg.saved': 'Guardado exitosamente',
                'msg.deleted': 'Eliminado exitosamente',
                'msg.updated': 'Actualizado exitosamente',
                
                // Time
                'time.today': 'Hoy',
                'time.yesterday': 'Ayer',
                'time.thisWeek': 'Esta semana',
                'time.thisMonth': 'Este mes',
                'time.thisYear': 'Este a��o',
                
                // Settings
                'settings.theme': 'Tema',
                'settings.language': 'Idioma',
                'settings.notifications': 'Notificaciones',
                'settings.preferences': 'Preferencias',
                'settings.light': 'Claro',
                'settings.dark': 'Oscuro',
                'settings.auto': 'Auto',
                
                // Dashboard
                'dashboard.welcome': 'Bienvenido',
                'dashboard.todaySales': 'Ventas del d��a',
                'dashboard.pendingOrders': 'Pedidos pendientes',
                'dashboard.lowStock': 'Stock bajo',
                'dashboard.newClients': 'Nuevos clientes',
                
                // Products
                'product.addNew': 'Nuevo producto',
                'product.inStock': 'En stock',
                'product.outOfStock': 'Sin stock',
                'product.lowStock': 'Stock bajo',
                
                // Orders
                'order.new': 'Nuevo pedido',
                'order.details': 'Detalles del pedido',
                'order.items': 'Art��culos',
                'order.subtotal': 'Subtotal',
                'order.tax': 'Impuesto',
                'order.discount': 'Descuento',
                
                // Finance
                'finance.income': 'Ingresos',
                'finance.expenses': 'Gastos',
                'finance.balance': 'Saldo',
                'finance.transactions': 'Transacciones',
                'finance.budget': 'Presupuesto',
                'finance.report': 'Informe financiero',
                
                // Vendeur specific
                'vendeur.myPos': 'Mi Punto de Venta',
                'vendeur.mySales': 'Mis Ventas',
                'vendeur.myClients': 'Mis Clientes',
                'vendeur.newSale': 'Nueva Venta',
                'vendeur.cart': 'Carrito',
                'vendeur.checkout': 'Pagar',
                
                // Vendor menu items
                'menu.dashboard': 'Panel de control',
                'menu.pos': 'Punto de venta',
                'menu.clients': 'Clientes',
                'menu.orders': 'Pedidos',
                'menu.stock': 'Stock',
                'menu.deliverers': 'Repartidores',
                'menu.reservations': 'Reservaciones',
                'menu.commissions': 'Comisiones',
                'menu.routing': 'Enrutamiento',
                'menu.finance': 'Finanzas',
                'menu.assignment': 'Asignaci��n',
                'menu.reports': 'Informes',
                'menu.settings': 'Configuraci��n',
                'menu.logout': 'Cerrar sesi��n',
                'menu.all': 'Todo',
                'menu.seeAll': 'Ver todo'
            },
            
            // ��Ÿ� ���Ÿ� � Portuguese (Portugu��s)
            pt: {
                'nav.home': 'In��cio',
                'nav.orders': 'Pedidos',
                'nav.products': 'Produtos',
                'nav.clients': 'Clientes',
                'nav.delivery': 'Entrega',
                'nav.finance': 'Finan��as',
                'nav.settings': 'Configura����es',
                'nav.help': 'Ajuda',
                'nav.logout': 'Sair',
                'nav.profile': 'Perfil',
                'action.save': 'Salvar',
                'action.cancel': 'Cancelar',
                'action.delete': 'Excluir',
                'action.edit': 'Editar',
                'action.add': 'Adicionar',
                'action.search': 'Pesquisar',
                'action.filter': 'Filtrar',
                'action.export': 'Exportar',
                'action.print': 'Imprimir',
                'action.confirm': 'Confirmar',
                'action.close': 'Fechar',
                'action.back': 'Voltar',
                'action.next': 'Pr��ximo',
                'action.previous': 'Anterior',
                'action.validate': 'Validar',
                'action.send': 'Enviar',
                'status.pending': 'Pendente',
                'status.confirmed': 'Confirmado',
                'status.shipped': 'Enviado',
                'status.delivered': 'Entregue',
                'status.cancelled': 'Cancelado',
                'status.returned': 'Devolvido',
                'status.active': 'Ativo',
                'status.inactive': 'Inativo',
                'status.paid': 'Pago',
                'status.unpaid': 'N��o pago',
                'label.date': 'Data',
                'label.amount': 'Valor',
                'label.total': 'Total',
                'label.quantity': 'Quantidade',
                'label.price': 'Pre��o',
                'label.name': 'Nome',
                'label.phone': 'Telefone',
                'label.address': 'Endere��o',
                'label.email': 'Email',
                'label.notes': 'Notas',
                'label.description': 'Descri����o',
                'label.category': 'Categoria',
                'label.payment': 'Pagamento',
                'label.customer': 'Cliente',
                'label.product': 'Produto',
                'label.order': 'Pedido',
                'label.delivery': 'Entrega',
                'label.stock': 'Estoque',
                'label.revenue': 'Receita',
                'label.profit': 'Lucro',
                'label.expenses': 'Despesas',
                'msg.success': 'Opera����o bem-sucedida',
                'msg.error': 'Ocorreu um erro',
                'msg.loading': 'Carregando...',
                'msg.noData': 'Sem dados',
                'msg.confirmDelete': 'Tem certeza que deseja excluir?',
                'msg.saved': 'Salvo com sucesso',
                'msg.deleted': 'Exclu��do com sucesso',
                'msg.updated': 'Atualizado com sucesso',
                'time.today': 'Hoje',
                'time.yesterday': 'Ontem',
                'time.thisWeek': 'Esta semana',
                'time.thisMonth': 'Este m��s',
                'time.thisYear': 'Este ano',
                'settings.theme': 'Tema',
                'settings.language': 'Idioma',
                'settings.notifications': 'Notifica����es',
                'settings.preferences': 'Prefer��ncias',
                'settings.light': 'Claro',
                'settings.dark': 'Escuro',
                'settings.auto': 'Auto',
                'dashboard.welcome': 'Bem-vindo',
                'dashboard.todaySales': 'Vendas de hoje',
                'dashboard.pendingOrders': 'Pedidos pendentes',
                'dashboard.lowStock': 'Estoque baixo',
                'dashboard.newClients': 'Novos clientes',
                'finance.income': 'Receitas',
                'finance.expenses': 'Despesas',
                'finance.balance': 'Saldo',
                'finance.transactions': 'Transa����es',
                'finance.budget': 'Or��amento',
                'finance.report': 'Relat��rio financeiro',
                'menu.dashboard': 'Painel',
                'menu.pos': 'Ponto de venda',
                'menu.clients': 'Clientes',
                'menu.orders': 'Pedidos',
                'menu.stock': 'Estoque',
                'menu.deliverers': 'Entregadores',
                'menu.reservations': 'Reservas',
                'menu.commissions': 'Comiss��es',
                'menu.routing': 'Roteamento',
                'menu.finance': 'Finan��as',
                'menu.assignment': 'Atribui����o',
                'menu.reports': 'Relat��rios',
                'menu.settings': 'Configura����es',
                'menu.logout': 'Sair',
                'menu.all': 'Tudo',
                'menu.seeAll': 'Ver tudo'
            },
            
            // ��Ÿ� ���Ÿ� � German (Deutsch)
            de: {
                'nav.home': 'Startseite',
                'nav.orders': 'Bestellungen',
                'nav.products': 'Produkte',
                'nav.clients': 'Kunden',
                'nav.delivery': 'Lieferung',
                'nav.finance': 'Finanzen',
                'nav.settings': 'Einstellungen',
                'nav.help': 'Hilfe',
                'nav.logout': 'Abmelden',
                'nav.profile': 'Profil',
                'action.save': 'Speichern',
                'action.cancel': 'Abbrechen',
                'action.delete': 'L��schen',
                'action.edit': 'Bearbeiten',
                'action.add': 'Hinzuf��gen',
                'action.search': 'Suchen',
                'action.filter': 'Filtern',
                'action.export': 'Exportieren',
                'action.print': 'Drucken',
                'action.confirm': 'Best��tigen',
                'action.close': 'Schlie�?Ÿen',
                'action.back': 'Zur��ck',
                'action.next': 'Weiter',
                'action.previous': 'Zur��ck',
                'action.validate': 'Validieren',
                'action.send': 'Senden',
                'status.pending': 'Ausstehend',
                'status.confirmed': 'Best��tigt',
                'status.shipped': 'Versendet',
                'status.delivered': 'Geliefert',
                'status.cancelled': 'Storniert',
                'status.returned': 'Zur��ckgegeben',
                'status.active': 'Aktiv',
                'status.inactive': 'Inaktiv',
                'status.paid': 'Bezahlt',
                'status.unpaid': 'Unbezahlt',
                'label.date': 'Datum',
                'label.amount': 'Betrag',
                'label.total': 'Gesamt',
                'label.quantity': 'Menge',
                'label.price': 'Preis',
                'label.name': 'Name',
                'label.phone': 'Telefon',
                'label.address': 'Adresse',
                'label.email': 'E-Mail',
                'label.notes': 'Notizen',
                'label.description': 'Beschreibung',
                'label.category': 'Kategorie',
                'label.payment': 'Zahlung',
                'label.customer': 'Kunde',
                'label.product': 'Produkt',
                'label.order': 'Bestellung',
                'label.delivery': 'Lieferung',
                'label.stock': 'Lager',
                'label.revenue': 'Umsatz',
                'label.profit': 'Gewinn',
                'label.expenses': 'Ausgaben',
                'msg.success': 'Vorgang erfolgreich',
                'msg.error': 'Ein Fehler ist aufgetreten',
                'msg.loading': 'Laden...',
                'msg.noData': 'Keine Daten',
                'msg.confirmDelete': 'Sind Sie sicher, dass Sie l��schen m��chten?',
                'msg.saved': 'Erfolgreich gespeichert',
                'msg.deleted': 'Erfolgreich gel��scht',
                'msg.updated': 'Erfolgreich aktualisiert',
                'time.today': 'Heute',
                'time.yesterday': 'Gestern',
                'time.thisWeek': 'Diese Woche',
                'time.thisMonth': 'Dieser Monat',
                'time.thisYear': 'Dieses Jahr',
                'settings.theme': 'Thema',
                'settings.language': 'Sprache',
                'settings.notifications': 'Benachrichtigungen',
                'settings.preferences': 'Einstellungen',
                'settings.light': 'Hell',
                'settings.dark': 'Dunkel',
                'settings.auto': 'Auto',
                'dashboard.welcome': 'Willkommen',
                'dashboard.todaySales': 'Heutige Verk��ufe',
                'dashboard.pendingOrders': 'Offene Bestellungen',
                'dashboard.lowStock': 'Niedriger Bestand',
                'dashboard.newClients': 'Neue Kunden',
                'finance.income': 'Einnahmen',
                'finance.expenses': 'Ausgaben',
                'finance.balance': 'Saldo',
                'finance.transactions': 'Transaktionen',
                'finance.budget': 'Budget',
                'finance.report': 'Finanzbericht',
                'menu.dashboard': 'Dashboard',
                'menu.pos': 'Kasse',
                'menu.clients': 'Kunden',
                'menu.orders': 'Bestellungen',
                'menu.stock': 'Lager',
                'menu.deliverers': 'Lieferanten',
                'menu.reservations': 'Reservierungen',
                'menu.commissions': 'Provisionen',
                'menu.routing': 'Routing',
                'menu.finance': 'Finanzen',
                'menu.assignment': 'Zuweisung',
                'menu.reports': 'Berichte',
                'menu.settings': 'Einstellungen',
                'menu.logout': 'Abmelden',
                'menu.all': 'Alle',
                'menu.seeAll': 'Alle anzeigen'
            },
            
            // ��Ÿ� ���Ÿ� � Italian (Italiano)
            it: {
                'nav.home': 'Home',
                'nav.orders': 'Ordini',
                'nav.products': 'Prodotti',
                'nav.clients': 'Clienti',
                'nav.delivery': 'Consegna',
                'nav.finance': 'Finanza',
                'nav.settings': 'Impostazioni',
                'nav.help': 'Aiuto',
                'nav.logout': 'Esci',
                'nav.profile': 'Profilo',
                'action.save': 'Salva',
                'action.cancel': 'Annulla',
                'action.delete': 'Elimina',
                'action.edit': 'Modifica',
                'action.add': 'Aggiungi',
                'action.search': 'Cerca',
                'action.filter': 'Filtra',
                'action.export': 'Esporta',
                'action.print': 'Stampa',
                'action.confirm': 'Conferma',
                'action.close': 'Chiudi',
                'action.back': 'Indietro',
                'action.next': 'Avanti',
                'action.previous': 'Precedente',
                'action.validate': 'Valida',
                'action.send': 'Invia',
                'status.pending': 'In attesa',
                'status.confirmed': 'Confermato',
                'status.shipped': 'Spedito',
                'status.delivered': 'Consegnato',
                'status.cancelled': 'Annullato',
                'status.returned': 'Restituito',
                'status.active': 'Attivo',
                'status.inactive': 'Inattivo',
                'status.paid': 'Pagato',
                'status.unpaid': 'Non pagato',
                'label.date': 'Data',
                'label.amount': 'Importo',
                'label.total': 'Totale',
                'label.quantity': 'Quantit��',
                'label.price': 'Prezzo',
                'label.name': 'Nome',
                'label.phone': 'Telefono',
                'label.address': 'Indirizzo',
                'label.email': 'Email',
                'label.notes': 'Note',
                'label.description': 'Descrizione',
                'label.category': 'Categoria',
                'label.payment': 'Pagamento',
                'label.customer': 'Cliente',
                'label.product': 'Prodotto',
                'label.order': 'Ordine',
                'label.delivery': 'Consegna',
                'label.stock': 'Magazzino',
                'label.revenue': 'Fatturato',
                'label.profit': 'Profitto',
                'label.expenses': 'Spese',
                'msg.success': 'Operazione riuscita',
                'msg.error': 'Si �� verificato un errore',
                'msg.loading': 'Caricamento...',
                'msg.noData': 'Nessun dato',
                'msg.confirmDelete': 'Sei sicuro di voler eliminare?',
                'msg.saved': 'Salvato con successo',
                'msg.deleted': 'Eliminato con successo',
                'msg.updated': 'Aggiornato con successo',
                'time.today': 'Oggi',
                'time.yesterday': 'Ieri',
                'time.thisWeek': 'Questa settimana',
                'time.thisMonth': 'Questo mese',
                'time.thisYear': 'Quest\'anno',
                'settings.theme': 'Tema',
                'settings.language': 'Lingua',
                'settings.notifications': 'Notifiche',
                'settings.preferences': 'Preferenze',
                'settings.light': 'Chiaro',
                'settings.dark': 'Scuro',
                'settings.auto': 'Auto',
                'dashboard.welcome': 'Benvenuto',
                'dashboard.todaySales': 'Vendite di oggi',
                'dashboard.pendingOrders': 'Ordini in sospeso',
                'dashboard.lowStock': 'Scorte basse',
                'dashboard.newClients': 'Nuovi clienti',
                'finance.income': 'Entrate',
                'finance.expenses': 'Spese',
                'finance.balance': 'Saldo',
                'finance.transactions': 'Transazioni',
                'finance.budget': 'Budget',
                'finance.report': 'Rapporto finanziario',
                'menu.dashboard': 'Dashboard',
                'menu.pos': 'Punto vendita',
                'menu.clients': 'Clienti',
                'menu.orders': 'Ordini',
                'menu.stock': 'Magazzino',
                'menu.deliverers': 'Corrieri',
                'menu.reservations': 'Prenotazioni',
                'menu.commissions': 'Commissioni',
                'menu.routing': 'Routing',
                'menu.finance': 'Finanza',
                'menu.assignment': 'Assegnazione',
                'menu.reports': 'Rapporti',
                'menu.settings': 'Impostazioni',
                'menu.logout': 'Esci',
                'menu.all': 'Tutto',
                'menu.seeAll': 'Vedi tutto'
            },
            
            // ��Ÿ� ���Ÿ� � Arabic (�? ��??�? ��? ��? ��?Š�? �)
            ar: {
                'nav.home': '�? ��??�? ��? ��?Š�? ��?Š�? �',
                'nav.orders': '�? ��??�? ��??�? ��? ��? �',
                'nav.products': '�? ��??�?��?��? ��? ��? ��? �',
                'nav.clients': '�? ��??�? ��?��??�? ��? �',
                'nav.delivery': '�? ��??�? ��?�?�? ��?Š�??',
                'nav.finance': '�? ��??�?��? ��??�?Š�? �',
                'nav.settings': '�? ��??�? ��? ��? ��? ��? ��? ��? �',
                'nav.help': '�?��? ��? ��? ��? ��? �',
                'nav.logout': '�? ��? ��? ��?Š�?? �? ��??�? ��? ��?�?�? �',
                'nav.profile': '�? ��??�?��??�? � �? ��??�? ��? ��? ��?Š',
                'action.save': '�? ��? ��? �',
                'action.cancel': '�? ��??�? ��? ��? �',
                'action.delete': '�? ��? ��? �',
                'action.edit': '�? ��? ��? ��?Š�??',
                'action.add': '�? ��? ��? ��? ��? �',
                'action.search': '�? ��? ��? �',
                'action.filter': '�? ��? ��? ��?Š�? �',
                'action.export': '�? ��? ��? ��?Š�? �',
                'action.print': '�? ��? ��? ��? ��? �',
                'action.confirm': '�? ��? ��?�?�?Š�? �',
                'action.close': '�? ��? ��??�? ��??',
                'action.back': '�? ��? ��?�?�? �',
                'action.next': '�? ��??�? ��? ��??�?Š',
                'action.previous': '�? ��??�? ��? ��? ��??',
                'action.validate': '�? ��? ��??�??',
                'action.send': '�? ��? ��? ��? ��??',
                'status.pending': '�??�?Š�? � �? ��??�? ��?��? ��? ��? ��? �',
                'status.confirmed': '�?��? ��?�?�? �',
                'status.shipped': '�? ��?� �? ��??�? ��? ��?�',
                'status.delivered': '�? ��?� �? ��??�? ��?�?�? ��?Š�??',
                'status.cancelled': '�?��??�? ��?Š',
                'status.returned': '�?��? ��? ��? ��? �',
                'status.active': '�?��? ��? �',
                'status.inactive': '�? ��?Š�? � �?��? ��? �',
                'status.paid': '�?��? ��? ��?�?�? �',
                'status.unpaid': '�? ��?Š�? � �?��? ��? ��?�?�? �',
                'label.date': '�? ��??�? ��? ��? ��?Š�? �',
                'label.amount': '�? ��??�?��? ��??�? �',
                'label.total': '�? ��??�? ��? ��?��? ��??�?Š',
                'label.quantity': '�? ��??�?�?�?��?Š�? �',
                'label.price': '�? ��??�? ��? ��? �',
                'label.name': '�? ��??�? ��? ��?�',
                'label.phone': '�? ��??�?��? ��? ��? �',
                'label.address': '�? ��??�? ��?��?�?�? ��?�',
                'label.email': '�? ��??�? ��? ��?Š�? � �? ��??�? ��??�?�?�? ��? ��?�?�?��?Š',
                'label.notes': '�?��??�? ��? ��? ��? ��? �',
                'label.description': '�? ��??�?�?�? ��? �',
                'label.category': '�? ��??�? ��? ��? �',
                'label.payment': '�? ��??�? ��? ��? �',
                'label.customer': '�? ��??�? ��?��?Š�??',
                'label.product': '�? ��??�?��?��? ��? �',
                'label.order': '�? ��??�? ��??�? �',
                'label.delivery': '�? ��??�? ��?�?�? ��?Š�??',
                'label.stock': '�? ��??�?��? ��? ��?�?�?�',
                'label.revenue': '�? ��??�? ��?Š�? ��? ��? ��? ��? �',
                'label.profit': '�? ��??�? ��? ��? �',
                'label.expenses': '�? ��??�?��? ��? ��?�?�? ��? ��? �',
                'msg.success': '�? ��?��? � �? ��??�? ��?��??�?Š�? � �? ��?��? ��? ��? �',
                'msg.error': '�? ��? ��? � �? ��? ��? �',
                'msg.loading': '�? ��? ��? ��?Š �? ��??�? ��? ��?��?Š�??...',
                'msg.noData': '�??�? � �? ��?�?�? ��? � �? ��?Š�? ��?��? ��? �',
                'msg.confirmDelete': '�?��?? �? ��?��? � �?��? ��? ��?�?�? � �?��?� �? ��??�? ��? ��? ��?Ÿ',
                'msg.saved': '�? ��?� �? ��??�? ��? ��? � �? ��?��? ��? ��? �',
                'msg.deleted': '�? ��?� �? ��??�? ��? ��? � �? ��?��? ��? ��? �',
                'msg.updated': '�? ��?� �? ��??�? ��? ��? ��?Š�? � �? ��?��? ��? ��? �',
                'time.today': '�? ��??�?Š�?�?�?�',
                'time.yesterday': '�? ��?��? �',
                'time.thisWeek': '�?��? ��? � �? ��??�? ��? ��? ��?�?�? �',
                'time.thisMonth': '�?��? ��? � �? ��??�? ��?��? �',
                'time.thisYear': '�?��? ��?� �? ��??�? ��?��? �',
                'settings.theme': '�? ��??�?��? ��?��? �',
                'settings.language': '�? ��??�??�? ��? �',
                'settings.notifications': '�? ��??�? ��? ��? ��? ��? ��? ��? �',
                'settings.preferences': '�? ��??�? ��? ��? ��?Š�??�? ��? �',
                'settings.light': '�? ��? ��? ��? �',
                'settings.dark': '�? ��? ��?�?�?�',
                'settings.auto': '�? ��??�??�? ��? ��?Š',
                'dashboard.welcome': '�?��? ��? ��? ��? ��?�',
                'dashboard.todaySales': '�?��? ��?Š�? ��? ��? � �? ��??�?Š�?�?�?�',
                'dashboard.pendingOrders': '�? ��??�? ��? ��? � �??�?Š�? � �? ��??�? ��?��? ��? ��? ��? �',
                'dashboard.lowStock': '�?��? ��? ��?�?�?� �?��?��? ��? ��? �',
                'dashboard.newClients': '�? ��?��??�? ��? � �? ��? ��? �',
                'finance.income': '�? ��??�? ��? ��??',
                'finance.expenses': '�? ��??�?��? ��? ��?�?�? ��? ��? �',
                'finance.balance': '�? ��??�? ��? ��?Š�? �',
                'finance.transactions': '�? ��??�?��? ��? ��?��??�? ��? �',
                'finance.budget': '�? ��??�?��?Š�? ��? ��?��?Š�? �',
                'finance.report': '�? ��??�? ��??�? ��?Š�? � �? ��??�?��? ��??�?Š',
                'menu.dashboard': '�??�?�?�? ��? � �? ��??�? ��? ��?�?�?�',
                'menu.pos': '�?��??�? ��? � �? ��??�? ��?Š�? �',
                'menu.clients': '�? ��??�? ��?��??�? ��? �',
                'menu.orders': '�? ��??�? ��??�? ��? ��? �',
                'menu.stock': '�? ��??�?��? ��? ��?�?�?�',
                'menu.deliverers': '�? ��??�?��?��? ��?�?�? ��?Š�?�',
                'menu.reservations': '�? ��??�? ��? ��?�?�? ��? ��? �',
                'menu.commissions': '�? ��??�? ��?��?�?�??�? ��? �',
                'menu.routing': '�? ��??�? ��?�?�? ��?Š�?�',
                'menu.finance': '�? ��??�?��? ��??�?Š�? �',
                'menu.assignment': '�? ��??�? ��? ��?Š�?Š�?�',
                'menu.reports': '�? ��??�? ��??�? ��? ��?Š�? �',
                'menu.settings': '�? ��??�? ��? ��? ��? ��? ��? ��? �',
                'menu.logout': '�? ��? ��?�?�? �',
                'menu.all': '�? ��??�?�?�??',
                'menu.seeAll': '�? ��? ��? � �? ��??�?�?�??'
            },
            
            // ��Ÿ� ���Ÿ� � Chinese Simplified (�� � ���?��� � ?��� �?)
            zh: {
                'nav.home': '� �?� � �',
                'nav.orders': '�� � ��� ��',
                'nav.products': '�� � ���? �',
                'nav.clients': '�� � ����? �',
                'nav.delivery': 'ɦ �� ?� �',
                'nav.finance': '�� � ���Š �',
                'nav.settings': '�� � ��� � �',
                'nav.help': '�� � ���Š �',
                'nav.logout': '� ?� ?���� �',
                'nav.profile': '�� � ��� � ��� �?��? ?�',
                'action.save': '�� � ��� ��?',
                'action.cancel': '�� �?�� ��?',
                'action.delete': '���? �� ?� �',
                'action.edit': '�� �?�� �?',
                'action.add': '�� � ���Š �',
                'action.search': '�� ��?�� � �',
                'action.filter': '�� ��� ?��',
                'action.export': '�� � ���� �',
                'action.print': '���?�� � �',
                'action.confirm': '�� � ��� � �',
                'action.close': '��� ��? �',
                'action.back': '�� �����ž',
                'action.next': '�� ���� � ?��� � �',
                'action.previous': '�� �Š�� � ?��� � �',
                'action.validate': '� ��?�� � �',
                'action.send': '�� �?� ?� �',
                'status.pending': '�� ���� �?�� ��',
                'status.confirmed': '�� � ��� � ��� � �',
                'status.shipped': '�� � ��� �?�� � �',
                'status.delivered': '�� � �� ?� ��� � �',
                'status.cancelled': '�� � ��� �?�� ��?',
                'status.returned': '�� � �� ?� ?��� � �',
                'status.active': '�� � ��� ��?',
                'status.inactive': '�� ��?��� �',
                'status.paid': '�� � ���� ��� ��?',
                'status.unpaid': '���? ���� ��� ��?',
                'label.date': '��? ����?Ÿ',
                'label.amount': 'ɡ?� � �',
                'label.total': '�� ?� ��� � �',
                'label.quantity': '��� �ɡ �',
                'label.price': '�� � ��� � �',
                'label.name': '�� � ��� � �',
                'label.phone': '��� ��� � �',
                'label.address': '���? ��� � ?�',
                'label.email': '�? ��� � �',
                'label.notes': '�� ���� � �',
                'label.description': '�� � ��� � �',
                'label.category': '�� � ����? �',
                'label.payment': '��� ��� ��?',
                'label.customer': '�� � ����? �',
                'label.product': '�� � ���? �',
                'label.order': '�� � ��� ��',
                'label.delivery': 'ɦ �� ?� �',
                'label.stock': '�� �?�� ��?',
                'label.revenue': '��� ���� �',
                'label.profit': '���? ��� � �',
                'label.expenses': '��� ���� �',
                'msg.success': '��? ��� ��?���? ���ŠŸ',
                'msg.error': '�� �?���Ÿɝ ?��� � �',
                'msg.loading': '��Š ��� � ��� � �...',
                'msg.noData': '��š?��? ���� ��� � �',
                'msg.confirmDelete': '�� � ��� �š�� � ����? �� ?� ��� �?�� �Ÿ',
                'msg.saved': '�� � ��� ��?���? ���ŠŸ',
                'msg.deleted': '���? �� ?� ����? ���ŠŸ',
                'msg.updated': '��� ���? ����? ���ŠŸ',
                'time.today': '�� �Š�� � �',
                'time.yesterday': '���? ��� � �',
                'time.thisWeek': '���? ���? �',
                'time.thisMonth': '���? ����?�?',
                'time.thisYear': '�� �Š�� � �',
                'settings.theme': '�� � �� ��?',
                'settings.language': '�� � ��� � ?�',
                'settings.notifications': '� ?�š��Ÿ �',
                'settings.preferences': '�� � ��� � ��� � ��� � �',
                'settings.light': '�� ����� �',
                'settings.dark': '�� � ���� �',
                'settings.auto': '��� ���Š �',
                'dashboard.welcome': '�� � ��� �Ž',
                'dashboard.todaySales': '�� �Š��? �ɝ ?���� �',
                'dashboard.pendingOrders': '�� ���� �?�� ���� � ��� ��',
                'dashboard.lowStock': '�� �?�� ��?�� � ��� � �',
                'dashboard.newClients': '��? ��� � ����? �',
                'finance.income': '��� ���� �',
                'finance.expenses': '��� ���� �',
                'finance.balance': '�� � ?�� � �',
                'finance.transactions': '�� � ����??',
                'finance.budget': '� �?�� �?',
                'finance.report': '�� � ���Š ���Š ���?Š',
                'menu.dashboard': '�� � ��� � �����?',
                'menu.pos': 'ɝ ?���� ���? �',
                'menu.clients': '�� � ����? �',
                'menu.orders': '�� � ��� ��',
                'menu.stock': '�� �?�� ��?',
                'menu.deliverers': 'ɦ �� ?� ���?�?',
                'menu.reservations': '� �?�� � �',
                'menu.commissions': '�� � �ɡ?',
                'menu.routing': '�� � ���� �',
                'menu.finance': '�� � ���Š �',
                'menu.assignment': '���?�ɦ �',
                'menu.reports': '��Š ���?Š',
                'menu.settings': '�� � ��� � �',
                'menu.logout': '� ?� ?���� �',
                'menu.all': '��� ���? �',
                'menu.seeAll': '��Ÿ ����?���� ���? �'
            },
            
            // ��Ÿ� ���Ÿ� � Russian (�� ��?�?�? ��? ��� ��� ��� �)
            ru: {
                'nav.home': '��?�� ��� ��� ��� ��� ��? �',
                'nav.orders': '��?�� ��� ��� ��� ��?�',
                'nav.products': '�� ��� ��� ��� ��? ?��?�',
                'nav.clients': '��š�� ��� ��� ��� ��??�?�',
                'nav.delivery': '����� ��? ��??�� ��� ��� ��� �',
                'nav.finance': '�� ��� ��� ��� ��� ��? ��?�',
                'nav.settings': '�� ��� ��? ��??�? ?��� ��� ��� ��� �',
                'nav.help': '��Ÿ�� ��� ��� ��?��?�?',
                'nav.logout': '��?�?��� ��??�� �',
                'nav.profile': '��Ÿ�? ?��� ��??�� ��� ��?�?',
                'action.save': '�� ��� ��?��? ?��� ��� ��� ��??�?�?',
                'action.cancel': '��ž�??�� ��� ��� ��� �',
                'action.delete': '�� ��� ��� ��� ��� ��??�?�?',
                'action.edit': '�� ��� ��� ��� ��� ��??�� ��? ?��� ��� ��� ��??�?�?',
                'action.add': '����� ��� ��� ��� ��� ��??�?�?',
                'action.search': '��Ÿ�� ��� ��? ��� �',
                'action.filter': '�� ��� ��� ��?�?�??�? ?�',
                'action.export': '�� ��� ��? ��� ��� ��? ?��??',
                'action.print': '��Ÿ�� ��?��� ��??�?�?',
                'action.confirm': '��Ÿ�� ��� ��??�� ��� ��? ?��� ��� ��??�?�?',
                'action.close': '��?�� ��� ��? ?��?��??�?�?',
                'action.back': '�� ��� ��� ��� ��� �',
                'action.next': '����� ��� ��� ��� �',
                'action.previous': '�� ��� ��� ��� ��� �',
                'action.validate': '��Ÿ�? ?��� ��� ��� ��? ?��� ��??�?�?',
                'action.send': '��ž�??�� ��? ?��� ��� ��� ��??�?�?',
                'status.pending': '��ž�� ��� ��� ��� ��� ��??',
                'status.confirmed': '��Ÿ�� ��� ��??�� ��� ��? ?��� ��� ��??�� �',
                'status.shipped': '��ž�??�� ��? ?��� ��� ��� ��� ��� �',
                'status.delivered': '����� ��? ��??�� ��� ��� ��� ��� �',
                'status.cancelled': '��ž�??�� ��� ��� ��??�� �',
                'status.returned': '��?�� ��� ��� ��? ?��� ��??',
                'status.active': '�� ��� ��??�� ��� ��� ��� �',
                'status.inactive': '�� ��� ��� ��� ��??�� ��� ��� ��� �',
                'status.paid': '��ž�� ��� ��� ��?��� ��� �',
                'status.unpaid': '�� ��� � �� ��� ��� ��� ��?��� ��� �',
                'label.date': '����� ��??�� �',
                'label.amount': '�� ��?�?�� ��� ��� �',
                'label.total': '���?�??�� ��� ��� �',
                'label.quantity': '��š�� ��� ��� ��?��� ��? ��??�� ��� �',
                'label.price': '�� ��� ��� ��� �',
                'label.name': '���?�� ��? �',
                'label.phone': '�� ��� ��� ��� ��??�� ��� �',
                'label.address': '�� ��� ��? ?��� ��? �',
                'label.email': 'Email',
                'label.notes': '��?�� ��� ��� ��??�� ��� �',
                'label.description': '��ž�� ��� ��? ��� ��� ��� ��� �',
                'label.category': '��š�� ��??�� ��� ��� ��? ?��� ��? �',
                'label.payment': '��ž�� ��� ��� ��??�� �',
                'label.customer': '��š�� ��� ��� ��� ��??',
                'label.product': '�� ��� ��� ��� ��? ?�',
                'label.order': '��?�� ��� ��� ��� �',
                'label.delivery': '����� ��? ��??�� ��� ��� ��� �',
                'label.stock': '�� ��� ��� ��� ��� �',
                'label.revenue': '��?�?��? ?��?�?�?��� ��� �',
                'label.profit': '��Ÿ�? ?��� ��� ��?��� ��?�?',
                'label.expenses': '�� ��� ��? ��?��� ��� ��?�',
                'msg.success': '��ž�� ��� ��? ?��� ��?��� ��? � �?�?�? ��� ��� ��?�?�� ��� �',
                'msg.error': '��Ÿ�? ?��� ��� ��� ��� ��?�?�� ��� � �� ��?�?�� ��� ��� ��� �',
                'msg.loading': '��?�� ��� ��? ?��?�?�� ��� ��� �...',
                'msg.noData': '�� ��� ��?? �� ��� ��� ��� ��?��?�',
                'msg.confirmDelete': '��?�?� �?�?�� ��� ��? ?��� ��� ��?�, �?��??�� � �?��� ��??�� ��??�� � �?�?�� ��� ��� ��� ��??�?�??',
                'msg.saved': '�� ��? ��� ��� ��?�?�� ��� � �? ��� ��?��? ?��� ��� ��� ��� ��� �',
                'msg.deleted': '�� ��? ��� ��� ��?�?�� ��� � �?�?�� ��� ��� ��� ��� ��� �',
                'msg.updated': '�� ��? ��� ��� ��?�?�� ��� � �� ��� ��� ��� ��� ��� ��� ��� ��� �',
                'time.today': '�� ��� ��� ��� ��� ��� ��? �',
                'time.yesterday': '��?�?��� ��? ?��� �',
                'time.thisWeek': '�� ��� � �? ��??�� ��� � �� ��� ��� ��� ��� ��� �',
                'time.thisMonth': '��? �? ��??�� ��� � �� ��� ��? ��? ��?��� �',
                'time.thisYear': '��? �? ��??�� ��� � �� ��� ��� ��?�?',
                'settings.theme': '�� ��� ��� ��� �',
                'settings.language': '�� ��� ��?��� �',
                'settings.notifications': '�� ��� ��� ��� ��� ��� ��� ��� ��� ��� ��? �',
                'settings.preferences': '�� ��� ��? ��??�? ?��� ��� ��� ��� �',
                'settings.light': '�� ��� ��� ��??�� ��� ��? �',
                'settings.dark': '�� ��??�� ��� ��� ��? �',
                'settings.auto': '�� ��� ��??�� �',
                'dashboard.welcome': '����� ��� ��? ?��� � �� ��� ��� ��� ��� ��� ��� ��� ��??�?�?',
                'dashboard.todaySales': '��Ÿ�? ?��� ��� ��� ��� ��� � �? ��� ��� ��� ��� ��� ��? �',
                'dashboard.pendingOrders': '��?�� ��� ��� ��� ��?� �� � �� ��� ��� ��� ��� ��� ��� ��� �',
                'dashboard.lowStock': '�� ��� ��� ��� ��� ��� � �� ��� ��� ��� ��? �',
                'dashboard.newClients': '�� ��� ��� ��?��� � �� ��� ��� ��� ��� ��??�?�',
                'finance.income': '����� ��?��� ��� �',
                'finance.expenses': '�� ��� ��? ��?��� ��� ��?�',
                'finance.balance': '��?�� ��� ��� ��� ��? �',
                'finance.transactions': '�� ��? ?��� ��� ��� ��� ��� ��?��� ��� �',
                'finance.budget': '��?�?Ž�� ��� ��� ��??',
                'finance.report': '�� ��� ��� ��� ��� ��? ��� ��� ��?��� � �� ��??�?��??�??',
                'menu.dashboard': '��Ÿ�� ��� ��� ��� ��?�?',
                'menu.pos': '��š�� ��? ��? ��� �',
                'menu.clients': '��š�� ��� ��� ��� ��??�?�',
                'menu.orders': '��?�� ��� ��� ��� ��?�',
                'menu.stock': '�� ��� ��� ��� ��� �',
                'menu.deliverers': '��š�?�?�? ?��?�?�� ��? ?��?�',
                'menu.reservations': '��?�? ?��� ��� ��� ��? ?��� ��� ��� ��� ��� ��? �',
                'menu.commissions': '��š�� ��� ��� ��? ��? ��� ��� �',
                'menu.routing': '���?�� ��? ?��?�?�? ?��?�?�??�?�',
                'menu.finance': '�� ��� ��� ��� ��� ��? ��?�',
                'menu.assignment': '�� ��� ��� ��� ��� ��?��� ��� ��� ��� �',
                'menu.reports': '��ž�??�?��??�??�?�',
                'menu.settings': '�� ��� ��? ��??�? ?��� ��� ��� ��� �',
                'menu.logout': '��?�?��� ��??�� �',
                'menu.all': '��?�? ��� �',
                'menu.seeAll': '��Ÿ�� ��� ��� ��� ��� ��??�?�? �� ��? ��� �'
            }
        },
        
        // Langues RTL (Right-to-Left)
        rtlLanguages: ['ar', 'he', 'fa', 'ur'],
        
        setLang(lang) {
            if (this.translations[lang]) {
                this.currentLang = lang;
                this.current = lang;
                document.documentElement.lang = lang;
                localStorage.setItem('raya_language', lang);
                
                // G�rer RTL pour l'arabe et autres langues
                if (this.rtlLanguages.includes(lang)) {
                    document.documentElement.dir = 'rtl';
                    document.body.style.direction = 'rtl';
                } else {
                    document.documentElement.dir = 'ltr';
                    document.body.style.direction = 'ltr';
                }
            }
        },
        
        loadLang() {
            const userId = CORE?.state?.currentUser?.id;
            const perUser = userId ? localStorage.getItem(`user_language_${userId}`) : null;
            const saved = perUser || localStorage.getItem('raya_language') || localStorage.getItem('vendeur_language');
            if (saved && this.translations[saved]) {
                this.currentLang = saved;
                this.current = saved;
                document.documentElement.lang = saved;
                
                // Appliquer RTL si n�cessaire
                if (this.rtlLanguages.includes(saved)) {
                    document.documentElement.dir = 'rtl';
                    document.body.style.direction = 'rtl';
                }
            }
        },

        setLanguage(lang) {
            this.setLang(lang);
        },
        
        t(key, fallback = null) {
            const lang = this.currentLang || 'fr';
            const trans = this.translations[lang];
            if (trans && trans[key]) {
                return trans[key];
            }
            // Fallback to French
            if (this.translations.fr && this.translations.fr[key]) {
                return this.translations.fr[key];
            }
            return fallback || key;
        },

        autoTranslateMap: {
            'Dashboard': 'Tableau de bord',
            'Overview': 'Aper��u',
            'Analytics': 'Analytique',
            'Settings': 'Param��tres',
            'Profile': 'Profil',
            'Help': 'Aide',
            'Logout': 'D�connexion',
            'Login': 'Connexion',
            'Username': 'Identifiant',
            'Password': 'Mot de passe',
            'Orders': 'Commandes',
            'Order': 'Commande',
            'Products': 'Produits',
            'Product': 'Produit',
            'Clients': 'Clients',
            'Client': 'Client',
            'Delivery': 'Livraison',
            'Deliveries': 'Livraisons',
            'Finance': 'Finance',
            'Reports': 'Rapports',
            'Report': 'Rapport',
            'Inventory': 'Inventaire',
            'Stock': 'Stock',
            'Warehouse': 'Entrep��t',
            'Sales': 'Ventes',
            'Sale': 'Vente',
            'New': 'Nouveau',
            'Create': 'Cr�er',
            'Add': 'Ajouter',
            'Edit': 'Modifier',
            'Update': 'Mettre �� jour',
            'Delete': 'Supprimer',
            'Remove': 'Retirer',
            'Save': 'Enregistrer',
            'Cancel': 'Annuler',
            'Close': 'Fermer',
            'Search': 'Rechercher',
            'Filter': 'Filtrer',
            'Export': 'Exporter',
            'Import': 'Importer',
            'Print': 'Imprimer',
            'Confirm': 'Confirmer',
            'Back': 'Retour',
            'Next': 'Suivant',
            'Previous': 'Pr�c�dent',
            'Send': 'Envoyer',
            'Apply': 'Appliquer',
            'Reset': 'R�initialiser',
            'Clear': 'Effacer',
            'Yes': 'Oui',
            'No': 'Non',
            'Total': 'Total',
            'Amount': 'Montant',
            'Price': 'Prix',
            'Quantity': 'Quantit�',
            'Subtotal': 'Sous-total',
            'Discount': 'Remise',
            'Tax': 'Taxe',
            'Status': 'Statut',
            'Active': 'Actif',
            'Inactive': 'Inactif',
            'Pending': 'En attente',
            'Delivered': 'Livr�',
            'Cancelled': 'Annul�',
            'Paid': 'Pay�',
            'Unpaid': 'Non pay�',
            'Approved': 'Approuv�',
            'Rejected': 'Rejet�',
            'Success': 'Succ��s',
            'Error': 'Erreur',
            'Warning': 'Avertissement',
            'Info': 'Info',
            'Loading': 'Chargement',
            'Notifications': 'Notifications',
            'Language': 'Langue',
            'Theme': 'Th��me',
            'Dark': 'Sombre',
            'Light': 'Clair',
            'Auto': 'Auto',
            'Phone': 'T�l�phone',
            'Address': 'Adresse',
            'City': 'Ville',
            'Country': 'Pays',
            'Date': 'Date',
            'Time': 'Heure',
            'Notes': 'Notes',
            'Description': 'Description',
            'Category': 'Cat�gorie',
            'Payment': 'Paiement',
            'Customer': 'Client',
            'Revenue': 'Chiffre d\'affaires',
            'Profit': 'B�n�fice',
            'Expenses': 'D�penses',
            'Balance': 'Solde',
            'In stock': 'En stock',
            'Out of stock': 'Rupture de stock',
            'Low stock': 'Stock faible',
            'History': 'Historique',
            'Map': 'Carte',
            'Team': '�quipe',
            'Users': 'Utilisateurs',
            'User': 'Utilisateur',
            'Role': 'R��le',
            'Permission': 'Permission',
            'Access': 'Acc��s',
            'Point of Sale': 'Point de vente',
            'POS': 'PDV'
        },
        autoTranslateOrder: null,

        escapeRegExp(value) {
            return String(value).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        },

        matchCase(source, target) {
            if (!source) return target;
            if (source === source.toUpperCase()) return target.toUpperCase();
            if (source[0] === source[0].toUpperCase()) {
                return target.charAt(0).toUpperCase() + target.slice(1);
            }
            return target.toLowerCase();
        },

        autoTranslateText(text) {
            if (!text || this.currentLang !== 'fr') return text;
            const map = this.autoTranslateMap || {};
            const keys = this.autoTranslateOrder || (this.autoTranslateOrder = Object.keys(map).sort((a, b) => b.length - a.length));
            let out = text;
            keys.forEach((key) => {
                const re = new RegExp(`\\b${this.escapeRegExp(key)}\\b`, 'gi');
                out = out.replace(re, (m) => this.matchCase(m, map[key]));
            });
            return out;
        },

        autoTranslateDom(root = document.body) {
            if (!root || this.currentLang !== 'fr') return;

            const walker = document.createTreeWalker(
                root,
                NodeFilter.SHOW_TEXT,
                {
                    acceptNode: (node) => {
                        if (!node || !node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
                        const parent = node.parentElement;
                        if (!parent) return NodeFilter.FILTER_REJECT;
                        const tag = parent.tagName;
                        if (tag === 'SCRIPT' || tag === 'STYLE' || tag === 'NOSCRIPT') return NodeFilter.FILTER_REJECT;
                        return NodeFilter.FILTER_ACCEPT;
                    }
                }
            );

            let current;
            while ((current = walker.nextNode())) {
                const original = current.nodeValue;
                const translated = this.autoTranslateText(original);
                if (translated !== original) current.nodeValue = translated;
            }

            const attrs = ['placeholder', 'title', 'aria-label', 'data-tooltip'];
            const selector = attrs.map((a) => `[${a}]`).join(',');
            root.querySelectorAll(selector).forEach((el) => {
                attrs.forEach((attr) => {
                    if (!el.hasAttribute(attr)) return;
                    const val = el.getAttribute(attr);
                    const translated = this.autoTranslateText(val);
                    if (translated !== val) el.setAttribute(attr, translated);
                });
            });
        }
    };
    
    // Alias pour compatibilit� avec le code existant (I18n majuscule)
    const I18n = i18n;
    
    // Fonction globale de traduction
    function t(key, fallback = null) {
        return i18n.t(key, fallback);
    }

    // =========================================================
    // CORE SYSTEM (State + DB + Persistence)
    // =========================================================
    const CORE = {
        storageKey: 'raya_os_demo_v2',
        config: { appName: 'RAYA OS', currency: 'FCFA', language: 'fr', version: '2.2.4', googleMapsApiKey: '' },
        
        getCompanyName() {
            return this.db.systemConfig?.appName || this.config.appName;
        },
        
        setCompanyName(name) {
            if (!name || !name.trim()) return false;
            if (!this.db.systemConfig) this.db.systemConfig = {};
            this.db.systemConfig.appName = name.trim();
            this.config.appName = name.trim(); // Mise �� jour imm�diate
            this.save();
            return true;
        },

        getUserLanguage(userId) {
            if (!userId) return localStorage.getItem('raya_language') || this.config.language || 'fr';
            return localStorage.getItem(`user_language_${userId}`) || 'fr';
        },

        setUserLanguage(userId, lang) {
            if (!userId || !lang) return false;
            localStorage.setItem(`user_language_${userId}`, lang);
            return true;
        },
        state: { currentUser: null, isOnline: navigator.onLine, lastSync: new Date().toISOString() },
        db: {
            users: [
                { id: 1, name: 'Jean-Pierre Mokonzi', role: 'pdg', avatar: 'JP', active: true, username: 'jpmokonzi', password: 'test', passwordHash: '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08' },
                { id: 2, name: 'Marie Loundou', role: 'manager', avatar: 'ML', active: true, city: 1, phone: '+242 06 500 0002', vehicle: 'voiture', bio: 'Manager de la distribution', rating: 4.5, deliveryCount: 45, username: 'mloundou', password: 'test', passwordHash: '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08' },
                { id: 3, name: 'Patrick Nzaba', role: 'gestionnaire', avatar: 'PN', active: true, city: 1, pos: 1, username: 'pnzaba', password: 'test', passwordHash: '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08' },
                { id: 4, name: 'Amara Mbongo', role: 'vendeur', avatar: 'AM', active: true, city: 1, pos: 1, bio: 'Expert en produits laitiers et �picerie fine', specialties: ['Laiterie', '�picerie'], rating: 4.7, totalSales: 125000, salesCount: 89, badge: 'vendeur-mois', joinedDate: '2024-06-15', username: 'ambongo', password: 'test', passwordHash: '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08' },
                { id: 5, name: 'David Kouma', role: 'livreur', avatar: 'DK', active: true, city: 1, pos: 1, phone: '+242 06 500 0005', vehicle: 'moto', rating: 4.8, deliveryCount: 156, username: 'dkouma', password: 'test', passwordHash: '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08' },
                { id: 6, name: 'Sophie Okana', role: 'gestionnaire', avatar: 'SO', active: true, city: 1, pos: 2, username: 'sokana', password: 'test', passwordHash: '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08' },
                { id: 7, name: 'J�r��me Samba', role: 'vendeur', avatar: 'JS', active: true, city: 1, pos: 2, bio: 'Sp�cialiste en fruits et l�gumes', specialties: ['Fruits', 'L�gumes'], rating: 4.6, totalSales: 95000, salesCount: 72, username: 'jsamba', password: 'test', passwordHash: '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08' },
                { id: 8, name: '�mile Moussia', role: 'livreur', avatar: 'EM', active: true, city: 1, pos: 2, phone: '+242 06 500 0008', vehicle: 'moto', rating: 4.5, deliveryCount: 128, username: 'emoussia', password: 'test', passwordHash: '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08' }
            ],
            vendorBadges: [
                { id: 'vendeur-mois', label: 'Vendeur du Mois', icon: 'award', color: 'yellow', description: 'Meilleur vendeur du mois' },
                { id: 'top-performer', label: 'Top Performer', icon: 'star', color: 'emerald', description: 'Consistently au-dessus des objectifs' },
                { id: 'client-champion', label: 'Champion Client', icon: 'heart', color: 'red', description: 'Satisfaction client excellente' },
                { id: 'newbie', label: 'Nouveau Venu', icon: 'sparkles', color: 'blue', description: 'R�cemment rejoint' },
                { id: 'expert', label: 'Expert', icon: 'zap', color: 'purple', description: '+1 an d\'exp�rience' }
            ],
            cities: [
                { id: 1, name: 'Brazzaville', country: 'Congo' },
                { id: 2, name: 'Pointe-Noire', country: 'Congo' }
            ],
            pointsOfSale: [
                { id: 1, name: 'Centre-Ville', cityId: 1, employees: 8 },
                { id: 2, name: 'Poto-Poto', cityId: 1, employees: 5 }
            ],
            categories: [
                { id: 1, name: 'Produits laitiers', icon: 'milk' },
                { id: 2, name: 'C�r�ales', icon: 'wheat' },
                { id: 3, name: 'Huiles', icon: 'droplet' },
                { id: 4, name: '�picerie', icon: 'shopping-basket' },
                { id: 5, name: 'Boissons', icon: 'cup-soda' }
            ],
            products: [
                { id: 1, name: 'Lait Concentr� Gloria', categoryId: 1, price: 1500, stock: 245, minStock: 50, barcode: '123456789', active: true, posId: 1 },
                { id: 2, name: 'Riz Parfum� 5kg', categoryId: 2, price: 8500, stock: 120, minStock: 30, barcode: '123456790', active: true, posId: 1 },
                { id: 3, name: 'Huile de Palme 1L', categoryId: 3, price: 2500, stock: 89, minStock: 40, barcode: '123456791', active: true, posId: 1 },
                { id: 4, name: 'Sucre en Poudre 1kg', categoryId: 4, price: 1200, stock: 340, minStock: 100, barcode: '123456792', active: true, posId: 1 },
                { id: 8, name: 'Bi��re Ngok 65cl', categoryId: 5, price: 1000, stock: 450, minStock: 100, barcode: '123456796', active: true, posId: 1 }
            ],
            // ===== ISOLATION COMPL�?TE PAR POS =====
            // Clients, commandes, livraisons ISOL�S par POS
            posDataByLocation: {
                // Format: posId -> { clients: [], orders: [], deliveries: [], etc }
                '1': {
                    clients: [
                        { id: 1, name: 'Marcel Bakala', phone: '+242 06 845 1234', address: '78 Av. Foch, Brazzaville', totalOrders: 12, totalSpent: 450000, notes: 'Client r�gulier - VIP ��Ÿ�?Ÿ', lastPurchaseDate: '2025-01-10', segment: 'vip', tags: ['bon-client', 'vip'], posId: 1 }
                    ],
                    orders: [],
                    deliveries: [],
                    transactions: [],
                    notifications: [],
                    stockMovements: [],
                    transferReceipts: [],
                    notes: 'Donn�es isol�es pour POS 1'
                },
                '2': {
                    clients: [
                        { id: 2, name: 'Sylvie Moukoko', phone: '+242 05 912 5678', address: '23 Rue Lumumba, Poto-Poto', totalOrders: 8, totalSpent: 280000, notes: 'Livraison flexible possible', lastPurchaseDate: '2025-01-08', segment: 'regular', tags: [], posId: 2 }
                    ],
                    orders: [],
                    deliveries: [],
                    transactions: [],
                    notifications: [],
                    stockMovements: [],
                    transferReceipts: [],
                    notes: 'Donn�es isol�es pour POS 2'
                }
            },
            // LEGACY - Garder pour compatibilit� temporaire
            clients: [
                { id: 1, name: 'Marcel Bakala', phone: '+242 06 845 1234', address: '78 Av. Foch, Brazzaville', totalOrders: 12, totalSpent: 450000, notes: 'Client r�gulier - VIP ��Ÿ�?Ÿ', lastPurchaseDate: '2025-01-10', segment: 'vip', tags: ['bon-client', 'vip'], posId: 1 },
                { id: 2, name: 'Sylvie Moukoko', phone: '+242 05 912 5678', address: '23 Rue Lumumba, Poto-Poto', totalOrders: 8, totalSpent: 280000, notes: 'Livraison flexible possible', lastPurchaseDate: '2025-01-08', segment: 'regular', tags: [], posId: 2 }
            ],
            orders: [],
            deliveries: [],
            returns: [],
            financialTransactions: [],
            stockMovements: [],
            notifications: [],
            transferReceipts: [],
            posDeleteRequests: [],
            livreurCommissions: [], // [{ id: auto, livreurId, commissionPercent, commissionFixed, createdAt, updatedAt }]
            productVariants: [], // [{ id, productId, attributes: [{name, value}], sku, price, stock, weight, temperature, createdAt, updatedAt }]
            productAttributeTypes: [ // Attributs disponibles pour les produits
                { id: 'color', label: 'Couleur', type: 'select' },
                { id: 'size', label: 'Taille', type: 'select' },
                { id: 'weight', label: 'Poids', type: 'text' },
                { id: 'temperature', label: 'Temp�rature', type: 'select' },
                { id: 'material', label: 'Mat�riau', type: 'select' },
                { id: 'capacity', label: 'Capacit�', type: 'text' }
            ],
            deposits: [], // [{ id, timestamp, livreurId, livreurName, vendeurId, vendeurName, amount, ordersCount, ordersRef, posId, notes, status: 'enregistre'|'approuve' }]
            activityLogs: [], // [{ id, timestamp, userId, userName, userRole, action, entity, entityId, entityName, details, status, amount }]
            shiftTemplates: [ // Mod��les de shifts
                { id: 1, name: 'Matin', startTime: '07:00', endTime: '14:00', capacity: 3, posId: 1 },
                { id: 2, name: 'Apr��s-midi', startTime: '14:00', endTime: '21:00', capacity: 3, posId: 1 },
                { id: 3, name: 'Nuit', startTime: '21:00', endTime: '07:00', capacity: 2, posId: 1 }
            ],
            shifts: [], // [{ id, templateId, userId, date, status: 'scheduled'|'confirmed'|'swapped'|'cancelled', notes, replacementId, replacementName }]
            timeOff: [], // [{ id, userId, type: 'cong�'|'maladie'|'autre', startDate, endDate, reason, status: 'pending'|'approved'|'rejected' }]
            auditLogs: [], // [{ id, timestamp, userId, userName, userRole, action, entity, entityId, entityName, details, before, after, status }]
            dailyDigestConfigs: [], // [{ id, posId, enabled: true/false, sendTime: '06:00', recipients: [emails], includeVentes: true, includeDepots: true, includeIncidents: true, includeKPIs: true }]
            dailyDigestLogs: [], // [{ id, posId, timestamp, sendTime, recipients, status: 'sent'|'failed', ventes, depots, incidents, kpis }]
            incidents: [], // [{ id, timestamp, type: 'retard'|'annulation'|'litige', severity: 'basse'|'moyenne'|'haute', relatedEntity: delivery/order id, relatedType: 'delivery'|'order', assignedTo: userId, assignedToName, status: 'ouvert'|'en-cours'|'r�solu'|'ferm�', description, slaStartTime, slaEndTime, slaMinutes, slaStatus: 'en-cours'|'atteint'|'d�pass�', notes: [], resolution, createdBy, createdByName, closedAt, closedBy, tags: [], priority }]
            incidentHistory: [], // [{ id, incidentId, timestamp, userId, userName, action, oldValue, newValue, details }]
            messageTemplates: [], // [{ id, name, type: 'sms'|'whatsapp', category: 'delivery'|'reminder'|'alert'|'resolution', content, variables: [], createdBy }]
            messageLog: [], // [{ id, timestamp, recipientId, recipientName, type: 'sms'|'whatsapp'|'call', status: 'sent'|'failed'|'pending', content, duration }]
            productImages: [], // [{ id, productId, productName, url, filename, filesize, uploadedAt, uploadedBy, uploadedByName, isPrimary, alt, tags: [], order }]
            independentDeliveryMen: [], // [{ id, name, phone, vendeurId, vendeurName, createdAt, status: 'active'|'inactive', deliveryCount, totalEarnings, notes }]
            deliveryTicketTemplates: [], // [{ id, vendeurId, vendeurName, name: 'SMS'|'Direct', content, variables: [{name, label, required}], createdAt, updatedAt }]
            suppliers: [
                { id: 1, name: 'Usine CONGO-LAIT', phone: '+242 06 666 1234', email: 'contact@congo-lait.cg', city: 'Brazzaville', type: 'usine', active: true, createdAt: '2024-01-15' },
                { id: 2, name: 'Fournisseur KASAI Import', phone: '+242 06 777 5678', email: 'kasai@import.cg', city: 'Kinshasa', type: 'fournisseur', active: true, createdAt: '2024-02-01' },
                { id: 3, name: 'Riz BANGUI Distribution', phone: '+236 77 888 9012', email: 'riz@bangui.cf', city: 'Bangui', type: 'fournisseur', active: true, createdAt: '2024-03-10' }
            ],
            purchaseOrders: [], // [{ id, reference, supplierId, productId, qty, unitPrice, totalCost, status: 'pending'|'confirmed'|'received'|'cancelled', deliveryDate, note, createdAt }]
            userAdditionRequests: [], // [{ id, name, username, password, role, avatar, requestedBy, requestedByName, requestedAt, status: 'pending'|'approved'|'rejected', approvedBy, approvedByName, approvedAt, rejectionReason }]
            notifications: [], // [{ id, type: 'stock_low'|'order_rejected'|'incident_open'|'info', title, message, severity: 'low'|'medium'|'high'|'critical', relatedTo: 'product'|'order'|'delivery', relatedId, read: false, createdAt, readAt }]
            alertThresholds: [
                { id: 'stock_low', name: 'Stock Faible', enabled: true, threshold: 10, severity: 'high', description: 'Alerte quand stock < seuil' },
                { id: 'stock_critical', name: 'Stock Critique', enabled: true, threshold: 5, severity: 'critical', description: 'Alerte quand stock tr��s bas' },
                { id: 'order_rejected', name: 'Commande Rejet�e', enabled: true, severity: 'medium', description: 'Alerte quand une commande est rejet�e' },
                { id: 'incident_open', name: 'Incident Ouvert', enabled: true, severity: 'critical', description: 'Alerte quand un incident est ouvert' },
                { id: 'low_delivery_rate', name: 'Faible Taux Livraison', enabled: true, threshold: 70, severity: 'medium', description: 'Alerte quand taux livraison < seuil %' },
                { id: 'order_pending_24h', name: 'Commande en attente 24h', enabled: true, severity: 'medium', description: 'Alerte si commande en attente > 24h' }
            ],
            // ========== SYST�?ME D'ALERTES INTELLIGENTES ==========
            alertPreferences: [], // [{ id, userId, userRole, alertType: 'stock_low'|'order_pending'|'inactive_livreur'|'critical_incident', enabled: true, level: 'info'|'attention'|'critique', silenceStart: '22:00', silenceEnd: '08:00', sendEmail: false, sendSms: false, emailAddress: 'user@example.com', phoneNumber: '+242...' }]
            alertHistory: [], // [{ id, timestamp, userId, userRole, alertType, level, title, message, triggered: true, sent: true, readAt, actionTaken, notes }]
            silenceSchedules: [], // [{ id, userId, name: 'Nuit'|'R�union'|'Personnalis�', startTime: '22:00', endTime: '08:00', daysOfWeek: ['Mon', 'Tue'...], active: true, exceptions: [] }]
            alertRules: [ // R��gles d'alertes par r��le
                // GESTIONNAIRE: Stock critique
                { id: 'rule_1', role: 'gestionnaire', type: 'stock_low', condition: { field: 'stock', operator: '<', value: 10 }, level: 'attention', message: '��Ÿ? � Stock faible pour {product}', enabled: true },
                { id: 'rule_2', role: 'gestionnaire', type: 'stock_critical', condition: { field: 'stock', operator: '<', value: 5 }, level: 'critique', message: '��Ÿš � CRITIQUE: Stock �puis� {product}', enabled: true, sendEmail: true },
                // VENDEUR: Commandes en attente + Clients
                { id: 'rule_3', role: 'vendeur', type: 'pending_orders', condition: { field: 'status', operator: '=', value: 'pending', time: 3600000 }, level: 'attention', message: '�� � � {count} commande(s) en attente depuis {time}', enabled: true },
                // MANAGER: Livreurs inactifs
                { id: 'rule_4', role: 'manager', type: 'inactive_livreur', condition: { field: 'lastActivity', operator: '>', value: 1800000 }, level: 'attention', message: '��Ÿ�? � Livreur inactif: {livreur} depuis {time}', enabled: true },
                // PDG: Incidents critiques
                { id: 'rule_5', role: 'pdg', type: 'critical_incident', condition: { field: 'severity', operator: '=', value: 'haute' }, level: 'critique', message: '��Ÿ� � Incident critique: {description}', enabled: true, sendEmail: true },
                // Tout le monde: Revenus bas (30 jours)
                { id: 'rule_6', role: 'multi', type: 'low_revenue', condition: { field: 'revenue_30d', operator: '<', value: 500000 }, level: 'info', message: '��Ÿ?Š Revenu 30j: {amount}', enabled: true }
            ],
            budgets: [], // [{ id, name, category: 'salaires'|'operationnel'|'marketing'|'logistics'|'maintenance'|'other', amount: 0, startDate, endDate, spent: 0, notes, createdAt, updatedAt }]
            financialTargets: [
                { id: 'revenue_target', name: 'Objectif Revenu', category: 'revenue', amount: 0, period: 'monthly', status: 'active' },
                { id: 'profit_margin', name: 'Marge B�n�ficiaire Cible', category: 'profitability', percentage: 30, period: 'monthly', status: 'active' },
                { id: 'cost_reduction', name: 'R�duction Co��ts', category: 'cost', amount: 0, period: 'quarterly', status: 'active' }
            ],
            // ========== OPTIMISATION ROUTAGE LIVREURS ==========
            deliveryRoutes: [], // [{ id, livreurId, livreurName, date, startTime, endTime, status: 'planned'|'in_progress'|'completed', stops: [...], totalDistance: km, estimatedTime: min, estimatedCost: amount, actualTime, actualCost, completedAt }]
            routeStops: [], // [{ id, routeId, orderId, clientId, clientName, address, lat, lng, sequence, status: 'pending'|'visited'|'delivered'|'failed', arrivalTime, departureTime, notes }]
            addressClusters: [], // [{ id, date, clusterId, name, center: {lat, lng}, radius, addresses: [...], livreurId, createdAt }]
            routeOptimizations: [], // [{ id, livreurId, date, optimizedRoute: {...}, originalRoute: {...}, timeSaved: min, costSaved: amount, efficiency: %, appliedAt, result }]
            // ========== INT�GRATION PAIEMENTS MOBILES ==========
            mobileMoneProviders: [
                { id: 'mtn', name: 'MTN Money', logo: '��Ÿ? �', color: '#FFC72C', apiKey: '', enabled: true, description: 'MTN Mobile Money' },
                { id: 'airtel', name: 'Airtel Money', logo: '��Ÿ? �', color: '#E41C23', apiKey: '', enabled: true, description: 'Airtel Mobile Money' },
                { id: 'orange', name: 'Orange Money', logo: '��Ÿ? �', color: '#FF6600', apiKey: '', enabled: true, description: 'Orange Money' }
            ],
            mobilePayments: [], // [{ id, orderId, clientId, clientName, clientPhone, amount, currency: 'XAF', provider: 'mtn'|'airtel'|'orange', transactionId, status: 'pending'|'success'|'failed', qrCode, qrCodeUrl, invoicePDF, invoiceEmail, createdAt, completedAt, errorMessage, metadata }]
            paymentInvoices: [], // [{ id, paymentId, orderId, invoiceNumber, clientName, clientEmail, clientPhone, items: [{name, qty, price}], subtotal, tax, total, pdfUrl, sentAt, downloadedAt, createdAt }]
            paymentHistory: [], // [{ id, clientId, clientName, totalPaid: 0, paymentCount: 0, methods: {mtn: 0, airtel: 0, orange: 0, cash: 0}, lastPaymentDate, lastPaymentMethod, averageAmount }]
            paymentWebhooks: [], // [{ id, provider, event, status: 'pending'|'processed'|'failed', payload, receivedAt, processedAt }]
            // ========== WORKFLOW VALIDATION MULTI-NIVEAUX ==========
            orderApprovals: [], // [{ id, orderId, vendorId, vendorName, amount, status: 'pending'|'approved'|'rejected', managerId, approverName, approvedAt, rejectionReason, createdAt }]
            returnJustifications: [], // [{ id, returnId, orderId, itemCount, reason, description, status: 'pending'|'approved'|'rejected', reviewedBy, reviewedAt, notes, attachments: [] }]
            validationRules: [], // [{ id, entityType: 'order'|'return', threshold: amount|quantity, action: 'require_approval'|'require_justification', level: 'manager'|'gestionnaire', enabled: true }]
            approvalAuditTrail: [], // [{ id, entityType, entityId, action: 'created'|'submitted'|'approved'|'rejected'|'canceled', userId, userName, userRole, timestamp, reason, metadata }]
            // ========== AUDIT TRAIL & CONFORMIT� ==========
            auditTrail: [],
            complianceLogs: [],
            accessLogs: [],
            dataModificationLogs: [],
            deletionLogs: [],
            exportLogs: [],
            complianceReports: [],
            // ========== GESTION INTELLIGENTE DU STOCK ==========
            stockPredictions: [],
            stockAnalysisABC: [],
            reorderSuggestions: [],
            expiryAlerts: [],
            stockTrendHistory: [],
            // Rapports et Exports Avanc�s
            generatedReports: [],
            reportSchedules: [],
            reportTemplates: [
                { id: 'sales_summary', name: 'R�sum� Ventes', description: 'Revenu total, commandes, marges', metrics: ['totalRevenue', 'orderCount', 'profitMargin', 'averageOrder'] },
                { id: 'inventory', name: '�tat des Stocks', description: 'Produits en stock faible, valeur', metrics: ['lowStockProducts', 'stockValue', 'turnover'] },
                { id: 'deliveries', name: 'Analyse Livraisons', description: 'Taux de succ��s, temps moyen', metrics: ['deliverySuccess', 'avgDeliveryTime', 'costPerDelivery'] },
                { id: 'finance', name: 'Bilan Financier', description: 'Revenus, d�penses, b�n�fices', metrics: ['totalRevenue', 'totalExpenses', 'netProfit', 'cashFlow'] },
                { id: 'performance', name: 'Performances', description: 'KPIs par vendeur et zone', metrics: ['vendorPerformance', 'zonePerformance', 'productPerformance'] }
            ],
            financialMetrics: [],
            notificationHistory: [],
            // ========== PERSONNALISATION ET PR�F�RENCES ==========
            userPreferences: [],
            dashboardLayouts: [],
            keyboardShortcuts: [],
            themeSettings: [],
            widgetConfigs: [],
            systemConfig: {
                appName: 'RAYA OS',
                appVersion: '1.0.0',
                language: 'fr',
                timezone: 'Africa/Brazzaville',
                dateFormat: 'DD/MM/YYYY',
                currencyCode: 'XAF',
                currencySymbol: 'XAF',
                maintenanceMode: false,
                backupAutomatic: true,
                backupFrequency: 'daily', // daily, weekly, monthly
                backupRetention: 30, // days
                maxLoginAttempts: 5,
                sessionTimeout: 60, // minutes
                enableTwoFactor: false,
                enableApiLogs: true,
                logRetention: 90, // days
                maxUploadSize: 10, // MB
                enableExternalIntegration: false
            },
            backups: [], // [{ id, name, date, size, status: 'success'|'failed', notes }]
            systemLogs: [], // [{ id, timestamp, level: 'info'|'warning'|'error'|'critical', module, message, userId, ipAddress }]
            diagnostics: {
                lastCheck: null,
                cpuUsage: 0,
                memoryUsage: 0,
                storageUsage: 0,
                databaseSize: 0,
                activeUsers: 0,
                totalRequests: 0,
                averageResponseTime: 0,
                errorRate: 0
            },
            userSuspensions: [], // [{ id, userId, userName, suspendedBy, suspendedByName, reason, suspendedAt, resumedAt, duration, status: 'active'|'resolved' }]
            suspensionHistory: [], // [{ id, userId, suspension: {...}, action: 'suspended'|'resumed', timestamp, details }]
            importExportHistory: [], // [{ id, type: 'import'|'export', entity: 'users'|'orders'|'audit'|'products', timestamp, performedBy, performedByName, rowsProcessed, fileName, status: 'success'|'failed', details }]
            externalSyncConfigs: [], // [{ id, name, type: 'api'|'webhook'|'polling', url, method, frequency, lastSync, status: 'active'|'inactive', credentials }]
            roles: [
                { id: 'pdg', name: 'PDG', description: 'Pr�sident Directeur G�n�ral', color: 'indigo', icon: 'crown', permissions: ['all'], isCustom: false },
                { id: 'manager', name: 'Manager', description: 'Gestionnaire de distribution', color: 'blue', icon: 'briefcase', permissions: ['users.view', 'users.edit', 'users.delete', 'stock.view', 'stock.edit', 'orders.view', 'deliveries.view', 'deliveries.assign', 'finance.view'], isCustom: false },
                { id: 'gestionnaire', name: 'Gestionnaire', description: 'Gestionnaire de stock', color: 'green', icon: 'package', permissions: ['stock.view', 'stock.edit', 'stock.create', 'orders.view', 'products.view', 'products.edit'], isCustom: false },
                { id: 'vendeur', name: 'Vendeur', description: 'Vendeur', color: 'amber', icon: 'shopping-cart', permissions: ['orders.create', 'orders.view', 'products.view', 'clients.view'], isCustom: false },
                { id: 'livreur', name: 'Livreur', description: 'Livreur/Coursier', color: 'purple', icon: 'truck', permissions: ['deliveries.view', 'deliveries.complete', 'orders.view'], isCustom: false }
            ],
            permissions: [
                // Utilisateurs
                { id: 'users.view', label: 'Voir les utilisateurs', category: 'users', entity: 'Utilisateurs', action: 'Voir', icon: 'eye' },
                { id: 'users.create', label: 'Cr�er des utilisateurs', category: 'users', entity: 'Utilisateurs', action: 'Cr�er', icon: 'plus' },
                { id: 'users.edit', label: 'Modifier les utilisateurs', category: 'users', entity: 'Utilisateurs', action: 'Modifier', icon: 'edit' },
                { id: 'users.delete', label: 'Supprimer les utilisateurs', category: 'users', entity: 'Utilisateurs', action: 'Supprimer', icon: 'trash' },
                { id: 'users.approve', label: 'Approuver les utilisateurs', category: 'users', entity: 'Utilisateurs', action: 'Approuver', icon: 'check-circle' },
                // Stock
                { id: 'stock.view', label: 'Voir le stock', category: 'stock', entity: 'Stock', action: 'Voir', icon: 'eye' },
                { id: 'stock.create', label: 'Ajouter au stock', category: 'stock', entity: 'Stock', action: 'Cr�er', icon: 'plus' },
                { id: 'stock.edit', label: 'Modifier le stock', category: 'stock', entity: 'Stock', action: 'Modifier', icon: 'edit' },
                { id: 'stock.delete', label: 'Supprimer du stock', category: 'stock', entity: 'Stock', action: 'Supprimer', icon: 'trash' },
                // Produits
                { id: 'products.view', label: 'Voir les produits', category: 'products', entity: 'Produits', action: 'Voir', icon: 'eye' },
                { id: 'products.create', label: 'Cr�er des produits', category: 'products', entity: 'Produits', action: 'Cr�er', icon: 'plus' },
                { id: 'products.edit', label: 'Modifier les produits', category: 'products', entity: 'Produits', action: 'Modifier', icon: 'edit' },
                { id: 'products.delete', label: 'Supprimer les produits', category: 'products', entity: 'Produits', action: 'Supprimer', icon: 'trash' },
                // Commandes
                { id: 'orders.view', label: 'Voir les commandes', category: 'orders', entity: 'Commandes', action: 'Voir', icon: 'eye' },
                { id: 'orders.create', label: 'Cr�er des commandes', category: 'orders', entity: 'Commandes', action: 'Cr�er', icon: 'plus' },
                { id: 'orders.edit', label: 'Modifier les commandes', category: 'orders', entity: 'Commandes', action: 'Modifier', icon: 'edit' },
                { id: 'orders.cancel', label: 'Annuler les commandes', category: 'orders', entity: 'Commandes', action: 'Annuler', icon: 'x-circle' },
                // Livraisons
                { id: 'deliveries.view', label: 'Voir les livraisons', category: 'deliveries', entity: 'Livraisons', action: 'Voir', icon: 'eye' },
                { id: 'deliveries.assign', label: 'Assigner les livraisons', category: 'deliveries', entity: 'Livraisons', action: 'Assigner', icon: 'user-plus' },
                { id: 'deliveries.complete', label: 'Compl�ter les livraisons', category: 'deliveries', entity: 'Livraisons', action: 'Compl�ter', icon: 'check-square' },
                { id: 'deliveries.cancel', label: 'Annuler les livraisons', category: 'deliveries', entity: 'Livraisons', action: 'Annuler', icon: 'x-circle' },
                // Finances
                { id: 'finance.view', label: 'Voir les finances', category: 'finance', entity: 'Finances', action: 'Voir', icon: 'eye' },
                { id: 'finance.edit', label: 'Modifier les finances', category: 'finance', entity: 'Finances', action: 'Modifier', icon: 'edit' },
                { id: 'finance.export', label: 'Exporter les finances', category: 'finance', entity: 'Finances', action: 'Exporter', icon: 'download' },
                // Clients
                { id: 'clients.view', label: 'Voir les clients', category: 'clients', entity: 'Clients', action: 'Voir', icon: 'eye' },
                { id: 'clients.create', label: 'Cr�er des clients', category: 'clients', entity: 'Clients', action: 'Cr�er', icon: 'plus' },
                { id: 'clients.edit', label: 'Modifier les clients', category: 'clients', entity: 'Clients', action: 'Modifier', icon: 'edit' },
                // Rapports et Audit
                { id: 'reports.view', label: 'Voir les rapports', category: 'reports', entity: 'Rapports', action: 'Voir', icon: 'eye' },
                { id: 'reports.export', label: 'Exporter les rapports', category: 'reports', entity: 'Rapports', action: 'Exporter', icon: 'download' },
                { id: 'audit.view', label: 'Voir l\'audit', category: 'audit', entity: 'Audit', action: 'Voir', icon: 'eye' },
                { id: 'audit.export', label: 'Exporter l\'audit', category: 'audit', entity: 'Audit', action: 'Exporter', icon: 'download' }
            ]
        },

        // Persistence
        load() {
            const raw = localStorage.getItem(this.storageKey);
            if (!raw) return;
            const parsed = Utils.safeJsonParse(raw, null);
            if (!parsed) return;

            // Merge DB (keep defaults if missing)
            // IMPORTANT: Ne JAMAIS �craser les utilisateurs par d�faut depuis localStorage
            if (parsed.db) {
                for (const [key, value] of Object.entries(parsed.db)) {
                    if (key !== 'users' && Array.isArray(value)) {
                        this.db[key] = value;
                    }
                }
                
                // Restaurer systemConfig (objet, pas tableau) si pr�sent
                if (parsed.db.systemConfig && typeof parsed.db.systemConfig === 'object') {
                    this.db.systemConfig = { ...this.db.systemConfig, ...parsed.db.systemConfig };
                    // Mettre �� jour aussi config.appName pour coh�rence
                    if (parsed.db.systemConfig.appName) {
                        this.config.appName = parsed.db.systemConfig.appName;
                    }
                }
            }
            
            this.state = { ...this.state, ...(parsed.state || {}) };
            // Restore currentUser reference
            if (this.state.currentUser && this.state.currentUser.id) {
                const fresh = this.getUser(this.state.currentUser.id);
                this.state.currentUser = fresh || null;
            }
            
            // MIGRATION: Initialiser posStocks pour les produits existants
            this.migrateProductsToPosStocks();
        },
        
        migrateProductsToPosStocks() {
            const pos = this.db.pointsOfSale || [];
            let needsSave = false;
            
            // Pour chaque produit
            this.db.products?.forEach(p => {
                if (!p.posStocks) {
                    p.posStocks = {};
                    needsSave = true;
                    
                    // Initialiser le stock pour chaque POS
                    pos.forEach(location => {
                        // Si c'est un produit cr�� pour ce POS, utiliser son stock
                        if (p.posId === location.id) {
                            p.posStocks[location.id] = { 
                                stock: p.stock || 0, 
                                price: p.price || 0 
                            };
                        } else {
                            // Sinon, initialiser avec 0
                            p.posStocks[location.id] = { 
                                stock: 0, 
                                price: p.price || 0 
                            };
                        }
                    });
                }
            });
            
            // Aussi, pour les produits existants, s'assurer qu'ils ont posStocks[posId] pour TOUS les POS
            this.db.products?.forEach(p => {
                if (p.posStocks) {
                    pos.forEach(location => {
                        if (!p.posStocks[location.id]) {
                            p.posStocks[location.id] = { 
                                stock: p.posId === location.id ? (p.stock || 0) : 0,
                                price: p.price || 0 
                            };
                            needsSave = true;
                        }
                    });
                }
            });
            
            if (needsSave) this.save();
        },
        save() {
            const payload = {
                state: { ...this.state, currentUser: this.state.currentUser ? { id: this.state.currentUser.id } : null },
                db: this.db,
                savedAt: new Date().toISOString()
            };
            localStorage.setItem(this.storageKey, JSON.stringify(payload));
        },
        reset() {
            localStorage.removeItem(this.storageKey);
            location.reload();
        },

        // CRUD
        create(collection, item, options = {}) {
            // S'assurer que la collection existe
            if (!this.db[collection]) {
                this.db[collection] = [];
            }
            const ids = this.db[collection].map(i => i.id || 0);
            const id = (ids.length > 0 ? Math.max(...ids) : 0) + 1;
            const newItem = { ...item, id, createdAt: new Date().toISOString() };
            this.db[collection].push(newItem);
            
            // File d'attente hors-ligne am�lior�e
            if (!this.state.isOnline && typeof OfflineManager !== 'undefined') {
                const entityName = item.name || item.orderRef || item.ref || `#${id}`;
                OfflineManager.enqueue({
                    type: 'create',
                    collection,
                    id,
                    data: newItem,
                    desc: options.desc || `Cr�ation: ${entityName}`,
                    entityName,
                    userId: this.state.currentUser?.id,
                    userName: this.state.currentUser?.name
                });
            } else if (!this.state.isOnline) {
                // Fallback ancien syst��me
                this.db.pendingSyncs = this.db.pendingSyncs || [];
                this.db.pendingSyncs.push({ 
                    id: Date.now().toString(),
                    type: 'create', 
                    collection, 
                    id, 
                    desc: `Cr�ation dans ${collection}`, 
                    queuedAt: new Date().toISOString(),
                    status: 'pending',
                    retryCount: 0
                });
            }

            this.save();
            return newItem;
        },
        update(collection, id, updates, options = {}) {
            // S'assurer que la collection existe
            if (!this.db[collection]) {
                this.db[collection] = [];
                return null;
            }
            const index = this.db[collection].findIndex(i => i.id === id);
            if (index !== -1) {
                const oldItem = { ...this.db[collection][index] };
                this.db[collection][index] = { ...this.db[collection][index], ...updates, updatedAt: new Date().toISOString() };
                
                // File d'attente hors-ligne am�lior�e
                if (!this.state.isOnline && typeof OfflineManager !== 'undefined') {
                    const entityName = this.db[collection][index].name || this.db[collection][index].orderRef || this.db[collection][index].ref || `#${id}`;
                    OfflineManager.enqueue({
                        type: 'update',
                        collection,
                        id,
                        data: updates,
                        oldData: oldItem,
                        desc: options.desc || `Modification: ${entityName}`,
                        entityName,
                        userId: this.state.currentUser?.id,
                        userName: this.state.currentUser?.name
                    });
                } else if (!this.state.isOnline) {
                    this.db.pendingSyncs = this.db.pendingSyncs || [];
                    this.db.pendingSyncs.push({ 
                        id: Date.now().toString(),
                        type: 'update', 
                        collection, 
                        id, 
                        desc: `Mise �� jour dans ${collection}`, 
                        queuedAt: new Date().toISOString(),
                        status: 'pending',
                        retryCount: 0
                    });
                }

                this.save();
                return this.db[collection][index];
            }
            return null;
        },
        delete(collection, id, options = {}) {
            // S'assurer que la collection existe
            if (!this.db[collection]) {
                this.db[collection] = [];
                return null;
            }
            const index = this.db[collection].findIndex(i => i.id === id);
            if (index !== -1) {
                const removed = this.db[collection].splice(index, 1)[0];
                
                // File d'attente hors-ligne am�lior�e
                if (!this.state.isOnline && typeof OfflineManager !== 'undefined') {
                    const entityName = removed.name || removed.orderRef || removed.ref || `#${id}`;
                    OfflineManager.enqueue({
                        type: 'delete',
                        collection,
                        id,
                        data: removed,
                        desc: options.desc || `Suppression: ${entityName}`,
                        entityName,
                        userId: this.state.currentUser?.id,
                        userName: this.state.currentUser?.name
                    });
                } else if (!this.state.isOnline) {
                    this.db.pendingSyncs = this.db.pendingSyncs || [];
                    this.db.pendingSyncs.push({ 
                        id: Date.now().toString(),
                        type: 'delete', 
                        collection, 
                        id, 
                        desc: `Suppression dans ${collection}`, 
                        queuedAt: new Date().toISOString(),
                        status: 'pending',
                        retryCount: 0
                    });
                }

                this.save();
                return removed;
            }
            return null;
        },

        async processSyncQueue() {
            // D�l�guer au nouveau OfflineManager si disponible
            if (typeof OfflineManager !== 'undefined') {
                return OfflineManager.syncAll();
            }
            
            // Ancien syst��me de fallback
            const q = this.db.pendingSyncs || [];
            if (q.length === 0) {
                UI.toast('Aucune op�ration �� synchroniser', 'info');
                return;
            }

            if (!this.state.isOnline) {
                UI.toast('Impossible de synchroniser: hors ligne', 'warning');
                return;
            }

            // Feedback visuel
            const indicator = document.getElementById('sync-indicator');
            let syncedCount = 0;
            
            if (indicator) {
                indicator.innerHTML = `<div class="flex items-center gap-2 px-3 py-2 bg-blue-500 text-white rounded-full shadow-lg animate-pulse"><i data-lucide="refresh-cw" class="w-4 h-4 animate-spin"></i><span class="text-xs font-black">Synchronisation 0/${q.length}...</span></div>`;
                lucide.createIcons();
            }

            UI.toast(`Synchronisation de ${q.length} op�ration(s)...`, 'info');

            // Simuler traitement des op�rations avec d�lai progressif
            return new Promise((resolve) => {
                let processed = 0;
                const processNext = () => {
                    if (processed < q.length) {
                        processed++;
                        syncedCount = processed;
                        
                        if (indicator) {
                            indicator.innerHTML = `<div class="flex items-center gap-2 px-3 py-2 bg-blue-500 text-white rounded-full shadow-lg animate-pulse"><i data-lucide="refresh-cw" class="w-4 h-4 animate-spin"></i><span class="text-xs font-black">Synchronisation ${processed}/${q.length}...</span></div>`;
                            lucide.createIcons();
                        }
                        
                        setTimeout(processNext, 300); // 300ms par op�ration
                    } else {
                        // Tous les sync trait�s
                        this.db.pendingSyncs = [];
                        this.state.lastSync = new Date().toISOString();
                        this.save();
                        
                        if (indicator) {
                            indicator.innerHTML = `<div class="flex items-center gap-2 px-3 py-2 bg-emerald-500 text-white rounded-full shadow-lg"><i data-lucide="check-circle" class="w-4 h-4"></i><span class="text-xs font-black">���?? Synchronis� (${syncedCount})</span></div>`;
                            lucide.createIcons();
                            
                            // Dispara��tre apr��s 3 secondes
                            setTimeout(() => {
                                if (indicator && indicator.innerHTML.includes('Synchronis�')) {
                                    indicator.innerHTML = '';
                                }
                            }, 3000);
                        }
                        
                        UI.toast(`${syncedCount} op�ration(s) synchronis�e(s) avec succ��s`, 'success');
                        App.rerender();
                        resolve(true);
                    }
                };
                
                processNext();
            });
        },

        // Helpers
        getCity(id) { return this.db.cities.find(c => c.id === id); },
        getPOS(id) { return this.db.pointsOfSale.find(p => p.id === id); },
        getCategory(id) { return this.db.categories.find(c => c.id === id); },
        getProduct(id) { return this.db.products.find(p => p.id === id); },
        getUser(id) { return this.db.users.find(u => u.id === id); },
        getClient(id) { return this.db.clients.find(c => c.id === id); },
        getProductVariants(productId) { return this.db.productVariants.filter(v => v.productId === productId); },

        // Main warehouse helpers
        // Synchronisation avec le backend
        async syncToBackend(action, collection, data) {
            if (!API.getToken()) return null;
            
            const apiMap = {
                products: {
                    create: () => API.createProduct(this.mapToServerProduct(data)),
                    update: () => API.updateProduct(data.serverId || data.id, this.mapToServerProduct(data)),
                    delete: () => API.deleteProduct(data.serverId || data.id)
                },
                orders: {
                    create: () => API.createOrder(this.mapToServerOrder(data)),
                    update: () => API.updateOrder(data.serverId || data.id, data),
                    delete: () => API.cancelOrder(data.serverId || data.id)
                },
                clients: {
                    create: () => API.createCustomer(this.mapToServerCustomer(data)),
                    update: () => API.updateCustomer(data.serverId || data.id, this.mapToServerCustomer(data)),
                    delete: () => API.deleteCustomer(data.serverId || data.id)
                },
                categories: {
                    create: () => API.createCategory(data),
                    update: () => API.updateCategory(data.serverId || data.id, data),
                    delete: () => API.deleteCategory(data.serverId || data.id)
                }
            };
            
            if (apiMap[collection] && apiMap[collection][action]) {
                try {
                    const result = await apiMap[collection][action]();
                    // Stocker l'ID serveur pour syncs futures
                    if (result && result.id && action === 'create') {
                        const item = this.db[collection].find(i => i.id === data.id);
                        if (item) item.serverId = result.id;
                    }
                    return result;
                } catch (e) {
                    console.warn(`Sync ${action} ${collection} failed:`, e);
                    // Enqueue pour retry
                    if (typeof SyncManager !== 'undefined') {
                        SyncManager.enqueue({ type: action.toUpperCase() + '_' + collection.toUpperCase(), id: data.id, data });
                    }
                    throw e;
                }
            }
            return null;
        },
        
        mapToServerProduct(p) {
            return {
                name: p.name,
                sku: p.sku || p.barcode || `SKU-${Date.now()}`,
                barcode: p.barcode,
                sellingPrice: p.price || 0,
                costPrice: p.costPrice || 0,
                stockQuantity: p.stock || 0,
                minStockLevel: p.minStock || 10,
                unit: p.unit || 'piece',
                description: p.description || '',
                categoryId: p.categoryId
            };
        },
        
        mapToServerOrder(o) {
            return {
                customerId: o.clientId,
                items: (o.items || []).map(item => ({
                    productId: item.productId || item.serverId,
                    quantity: item.quantity
                })),
                notes: o.notes || ''
            };
        },
        
        mapToServerCustomer(c) {
            // Splitter le nom en firstName/lastName si necessaire
            const nameParts = (c.name || '').split(' ');
            const firstName = c.firstName || nameParts[0] || 'Client';
            const lastName = c.lastName || nameParts.slice(1).join(' ') || 'Inconnu';
            return {
                firstName: firstName,
                lastName: lastName,
                phone: c.phone,
                email: c.email,
                address: c.address,
                notes: c.notes
            };
        },
        
        // Charger les donnees du serveur
        async loadFromServer() {
            if (!API.getToken()) return { success: false, message: 'Non authentifie' };
            
            try {
                const [products, categories, orders, customers] = await Promise.all([
                    API.getProducts({ limit: 500 }).catch(() => ({ data: [] })),
                    API.getCategories().catch(() => []),
                    API.getOrders({ limit: 200 }).catch(() => ({ data: [] })),
                    API.getCustomers({ limit: 500 }).catch(() => ({ data: [] }))
                ]);
                
                // Mettre a jour CORE.db avec les donnees serveur
                if (products.data) {
                    this.db.serverProducts = products.data.map(p => ({
                        serverId: p.id,
                        name: p.name,
                        sku: p.sku,
                        barcode: p.barcode,
                        price: p.sellingPrice,
                        costPrice: p.purchasePrice,
                        stock: p.stockQuantity,
                        minStock: p.minStockLevel,
                        categoryId: p.categoryId,
                        active: p.isActive
                    }));
                }
                
                if (Array.isArray(categories)) {
                    this.db.serverCategories = categories.map(c => ({
                        serverId: c.id,
                        name: c.name,
                        slug: c.slug,
                        icon: c.iconName
                    }));
                }
                
                if (orders.data) {
                    this.db.serverOrders = orders.data;
                }
                
                if (customers.data) {
                    this.db.serverClients = customers.data.map(c => ({
                        serverId: c.id,
                        name: c.name || `${c.firstName || ''} ${c.lastName || ''}`.trim(),
                        phone: c.phone,
                        email: c.email,
                        address: c.address
                    }));
                }
                
                this.state.lastSync = new Date().toISOString();
                this.save();
                return { success: true, counts: { products: products.data?.length, categories: categories?.length, orders: orders.data?.length, customers: customers.data?.length }};
            } catch (e) {
                return { success: false, error: e.message };
            }
        },
        
        // Synchronisation avec le backend
        async syncToBackend(action, collection, data) {
            if (!API.getToken()) return null;
            
            const apiMap = {
                products: {
                    create: () => API.createProduct(this.mapToServerProduct(data)),
                    update: () => API.updateProduct(data.serverId || data.id, this.mapToServerProduct(data)),
                    delete: () => API.deleteProduct(data.serverId || data.id)
                },
                orders: {
                    create: () => API.createOrder(this.mapToServerOrder(data)),
                    update: () => API.updateOrder(data.serverId || data.id, data),
                    delete: () => API.cancelOrder(data.serverId || data.id)
                },
                clients: {
                    create: () => API.createCustomer(this.mapToServerCustomer(data)),
                    update: () => API.updateCustomer(data.serverId || data.id, this.mapToServerCustomer(data)),
                    delete: () => API.deleteCustomer(data.serverId || data.id)
                },
                categories: {
                    create: () => API.createCategory(data),
                    update: () => API.updateCategory(data.serverId || data.id, data),
                    delete: () => API.deleteCategory(data.serverId || data.id)
                }
            };
            
            if (apiMap[collection] && apiMap[collection][action]) {
                try {
                    const result = await apiMap[collection][action]();
                    // Stocker l'ID serveur pour syncs futures
                    if (result && result.id && action === 'create') {
                        const item = this.db[collection].find(i => i.id === data.id);
                        if (item) item.serverId = result.id;
                    }
                    return result;
                } catch (e) {
                    console.warn(`Sync ${action} ${collection} failed:`, e);
                    // Enqueue pour retry
                    if (typeof SyncManager !== 'undefined') {
                        SyncManager.enqueue({ type: action.toUpperCase() + '_' + collection.toUpperCase(), id: data.id, data });
                    }
                    throw e;
                }
            }
            return null;
        },
        
        mapToServerProduct(p) {
            return {
                name: p.name,
                sku: p.sku || p.barcode || `SKU-${Date.now()}`,
                barcode: p.barcode,
                sellingPrice: p.price || 0,
                costPrice: p.costPrice || 0,
                stockQuantity: p.stock || 0,
                minStockLevel: p.minStock || 10,
                unit: p.unit || 'piece',
                description: p.description || '',
                categoryId: p.categoryId
            };
        },
        
        mapToServerOrder(o) {
            return {
                customerId: o.clientId,
                items: (o.items || []).map(item => ({
                    productId: item.productId || item.serverId,
                    quantity: item.quantity
                })),
                notes: o.notes || ''
            };
        },
        
        mapToServerCustomer(c) {
            // Splitter le nom en firstName/lastName si necessaire
            const nameParts = (c.name || '').split(' ');
            const firstName = c.firstName || nameParts[0] || 'Client';
            const lastName = c.lastName || nameParts.slice(1).join(' ') || 'Inconnu';
            return {
                firstName: firstName,
                lastName: lastName,
                phone: c.phone,
                email: c.email,
                address: c.address,
                notes: c.notes
            };
        },
        
        // Charger les donnees du serveur
        async loadFromServer() {
            if (!API.getToken()) return { success: false, message: 'Non authentifie' };
            
            try {
                const [products, categories, orders, customers] = await Promise.all([
                    API.getProducts({ limit: 500 }).catch(() => ({ data: [] })),
                    API.getCategories().catch(() => []),
                    API.getOrders({ limit: 200 }).catch(() => ({ data: [] })),
                    API.getCustomers({ limit: 500 }).catch(() => ({ data: [] }))
                ]);
                
                // Mettre a jour CORE.db avec les donnees serveur
                if (products.data) {
                    this.db.serverProducts = products.data.map(p => ({
                        serverId: p.id,
                        name: p.name,
                        sku: p.sku,
                        barcode: p.barcode,
                        price: p.sellingPrice,
                        costPrice: p.purchasePrice,
                        stock: p.stockQuantity,
                        minStock: p.minStockLevel,
                        categoryId: p.categoryId,
                        active: p.isActive
                    }));
                }
                
                if (Array.isArray(categories)) {
                    this.db.serverCategories = categories.map(c => ({
                        serverId: c.id,
                        name: c.name,
                        slug: c.slug,
                        icon: c.iconName
                    }));
                }
                
                if (orders.data) {
                    this.db.serverOrders = orders.data;
                }
                
                if (customers.data) {
                    this.db.serverClients = customers.data.map(c => ({
                        serverId: c.id,
                        name: c.name || `${c.firstName || ''} ${c.lastName || ''}`.trim(),
                        phone: c.phone,
                        email: c.email,
                        address: c.address
                    }));
                }
                
                this.state.lastSync = new Date().toISOString();
                this.save();
                return { success: true, counts: { products: products.data?.length, categories: categories?.length, orders: orders.data?.length, customers: customers.data?.length }};
            } catch (e) {
                return { success: false, error: e.message };
            }
        },
        
        // Combiner produits locaux et serveur
        getAllProductsWithServer() {
            const local = this.db.products || [];
            const server = this.db.serverProducts || [];
            const merged = [...local];
            server.forEach(sp => {
                if (!merged.find(p => p.serverId === sp.serverId || (p.sku && p.sku === sp.sku))) {
                    merged.push({ ...sp, id: sp.serverId, fromServer: true });
                }
            });
            return merged;
        },
        
        getMainWarehouseProducts() { return (this.db.products || []).filter(p => p.isMainWarehouse); },
        getProductsExcludingMain() { return (this.db.products || []).filter(p => !p.isMainWarehouse); },
        getPOSProducts(posId) { return (this.db.products || []).filter(p => !p.isMainWarehouse && p.posId == posId); },

        // Stock par POS (Option 1)
        getProductStock(productId, posId) {
            const product = this.getProduct(productId);
            if (!product) return 0;
            if (!posId) return product.stock || 0;
            
            // Utiliser posStocks si disponible
            if (product.posStocks && product.posStocks[posId]) {
                return product.posStocks[posId].stock || 0;
            }
            // Fallback: si le produit appartient au POS demand�, retourner son stock
            if (product.posId == posId) {
                return product.stock || 0;
            }
            return 0;
        },

        getProductPrice(productId, posId) {
            const product = this.getProduct(productId);
            if (!product) return 0;
            // Si le produit a une structure posStocks
            if (product.posStocks && product.posStocks[posId]) {
                return product.posStocks[posId].price || product.price || 0;
            }
            // Fallback: utiliser le prix global
            return product.price || 0;
        },

        setProductStock(productId, posId, stock) {
            const product = this.getProduct(productId);
            if (!product) return;
            // If posId is null/undefined/empty -> update master stock on product (main warehouse)
            if (posId === null || posId === undefined || posId === '') {
                product.stock = Math.max(0, Number(stock) || 0);
            } else {
                if (!product.posStocks) product.posStocks = {};
                if (!product.posStocks[posId]) product.posStocks[posId] = { stock: 0, price: product.price || 0 };
                product.posStocks[posId].stock = Math.max(0, stock);
            }
            this.save();
        },

        setProductPrice(productId, posId, price) {
            const product = this.getProduct(productId);
            if (!product) return;
            if (!product.posStocks) product.posStocks = {};
            if (!product.posStocks[posId]) product.posStocks[posId] = { stock: 0, price: 0 };
            product.posStocks[posId].price = Math.max(0, price);
            this.save();
        },

        // ========== SYST�?ME DE PERMISSIONS CENTRALIS� ==========
        
        /**
         * V�rifie si l'utilisateur actuel a acc��s �� une ressource
         * @param {string} resourceType - 'product', 'order', 'user', 'pos', 'delivery'
         * @param {*} resource - l'objet ressource
         * @returns {boolean}
         */
        canAccess(resourceType, resource) {
            const user = this.state.currentUser;
            if (!user) return false;
            
            // PDG: acc��s �� tout
            if (user.role === 'pdg') return true;
            
            // Manager: acc��s �� tous les POS
            if (user.role === 'manager') return true;
            
            // Autres r��les: doivent ��tre dans le m��me POS
            if (!user.pos) return false;
            
            switch(resourceType) {
                case 'product':
                    // Vendeur/Gestionnaire: produits de leur POS seulement
                    return resource?.posId == user.pos;
                    
                case 'order':
                    // Vendeur: commandes de son POS seulement
                    // Gestionnaire: commandes de son POS seulement
                    return resource?.posId == user.pos;
                    
                case 'delivery':
                    // Livreur: livraisons assign�es �� son POS
                    // Vendeur: livraisons des commandes de son POS
                    if (user.role === 'livreur') {
                        return resource?.livreurId === user.id;
                    }
                    return resource?.posId == user.pos;
                    
                case 'user':
                    // Gestionnaire/Vendeur: voir que les utilisateurs de leur POS
                    return resource?.pos == user.pos;
                    
                case 'pos':
                    // Gestionnaire: g�rer seulement son POS
                    return resource?.id == user.pos;
                    
                case 'expense':
                case 'income':
                    // Transactions du m��me POS
                    return resource?.posId == user.pos;
                    
                default:
                    return false;
            }
        },

        /**
         * V�rifie si l'utilisateur peut MODIFIER une ressource
         * @param {string} resourceType
         * @param {*} resource
         * @returns {boolean}
         */
        canModify(resourceType, resource) {
            const user = this.state.currentUser;
            if (!user) return false;
            
            // PDG et Manager: modification compl��te
            if (user.role === 'pdg' || user.role === 'manager') return true;
            
            switch(resourceType) {
                case 'product':
                    // Gestionnaire et Vendeur: modifier produits de leur POS seulement
                    if (user.role === 'gestionnaire' || user.role === 'vendeur') {
                        return resource?.posId == user.pos;
                    }
                    return false;
                    
                case 'stock':
                    // Manager et Gestionnaire: modifier le stock
                    if (user.role === 'manager' || user.role === 'gestionnaire') {
                        if (user.role === 'gestionnaire') {
                            return resource?.posId == user.pos;
                        }
                        return true; // Manager: tous les POS
                    }
                    return false;
                    
                case 'expense':
                    // Gestionnaire: ajouter d�penses pour son POS
                    if (user.role === 'gestionnaire') {
                        return resource?.posId == user.pos;
                    }
                    return false;
                    
                case 'order':
                    // Vendeur: cr�er commandes pour son POS
                    if (user.role === 'vendeur') {
                        return resource?.posId == user.pos;
                    }
                    return false;
                    
                default:
                    return false;
            }
        },

        /**
         * Filtre un array de ressources selon les permissions
         * @param {array} resources
         * @param {string} resourceType
         * @returns {array}
         */
        filterByAccess(resources, resourceType) {
            return resources.filter(r => this.canAccess(resourceType, r));
        },

        // ========== FONCTIONS D'ACC�?S ISOL� PAR POS ==========
        /**
         * ISOLATION COMPL�?TE: R�cup��re les clients d'un POS sp�cifique uniquement
         */
        getPOSClients(posId) {
            if (!posId) return [];
            // Utilise la structure isol�e posDataByLocation
            if (this.db.posDataByLocation && this.db.posDataByLocation[posId]) {
                return this.db.posDataByLocation[posId].clients || [];
            }
            // Fallback sur les donn�es avec filtre posId
            return (this.db.clients || []).filter(c => c.posId == posId);
        },

        /**
         * ISOLATION COMPL�?TE: R�cup��re les commandes d'un POS sp�cifique uniquement
         */
        getPOSOrders(posId) {
            if (!posId) return [];
            // Utilise la structure isol�e posDataByLocation
            if (this.db.posDataByLocation && this.db.posDataByLocation[posId]) {
                return this.db.posDataByLocation[posId].orders || [];
            }
            // Fallback sur les donn�es avec filtre posId
            return (this.db.orders || []).filter(o => o.posId == posId);
        },

        /**
         * ISOLATION COMPL�?TE: R�cup��re les livraisons d'un POS sp�cifique uniquement
         */
        getPOSDeliveries(posId) {
            if (!posId) return [];
            // Utilise la structure isol�e posDataByLocation
            if (this.db.posDataByLocation && this.db.posDataByLocation[posId]) {
                return this.db.posDataByLocation[posId].deliveries || [];
            }
            // Fallback sur les donn�es avec filtre posId
            return (this.db.deliveries || []).filter(d => d.posId == posId);
        },

        /**
         * ISOLATION COMPL�?TE: R�cup��re les transactions d'un POS sp�cifique uniquement
         */
        getPOSTransactions(posId) {
            if (!posId) return [];
            // Utilise la structure isol�e posDataByLocation
            if (this.db.posDataByLocation && this.db.posDataByLocation[posId]) {
                return this.db.posDataByLocation[posId].transactions || [];
            }
            // Fallback sur les donn�es avec filtre posId
            return (this.db.financialTransactions || []).filter(t => t.posId == posId);
        },

        /**
         * R�cup��re les donn�es appropri�es selon le r��le de l'utilisateur
         * PDG/Manager: tous les POS
         * Autres: POS assign� uniquement
         */
        getDataForUser(dataType) {
            const user = this.state.currentUser;
            if (!user) return [];
            
            // PDG et Manager: voir tous les POS
            if (user.role === 'pdg' || user.role === 'manager') {
                switch(dataType) {
                    case 'orders':
                        return this.db.orders || [];
                    case 'clients':
                        return this.db.clients || [];
                    case 'deliveries':
                        return this.db.deliveries || [];
                    case 'transactions':
                        return this.db.financialTransactions || [];
                    default:
                        return [];
                }
            }
            
            // Autres r��les: donn�es du POS assign� uniquement
            if (!user.pos) return [];
            
            switch(dataType) {
                case 'orders':
                    return this.getPOSOrders(user.pos);
                case 'clients':
                    return this.getPOSClients(user.pos);
                case 'deliveries':
                    return this.getPOSDeliveries(user.pos);
                case 'transactions':
                    return this.getPOSTransactions(user.pos);
                default:
                    return [];
            }
        },

        /**
         * ISOLATION COMPL�?TE: Ajoute un client �� un POS sp�cifique
         */
        addClientToPOS(posId, client) {
            if (!posId || !client) return null;
            // Initialise la structure si elle n'existe pas
            if (!this.db.posDataByLocation) this.db.posDataByLocation = {};
            if (!this.db.posDataByLocation[posId]) {
                this.db.posDataByLocation[posId] = {
                    clients: [], orders: [], deliveries: [], transactions: []
                };
            }
            // Ajoute le client avec le posId
            client.posId = posId;
            client.id = client.id || Date.now() + Math.random();
            this.db.posDataByLocation[posId].clients.push(client);
            this.save();
            return client;
        },

        /**
         * ISOLATION COMPL�?TE: Ajoute une commande �� un POS sp�cifique
         */
        addOrderToPOS(posId, order) {
            if (!posId || !order) return null;
            // Initialise la structure si elle n'existe pas
            if (!this.db.posDataByLocation) this.db.posDataByLocation = {};
            if (!this.db.posDataByLocation[posId]) {
                this.db.posDataByLocation[posId] = {
                    clients: [], orders: [], deliveries: [], transactions: []
                };
            }
            // Ajoute la commande avec le posId
            order.posId = posId;
            order.id = order.id || Date.now() + Math.random();
            this.db.posDataByLocation[posId].orders.push(order);
            this.save();
            return order;
        },

        /**
         * ISOLATION COMPL�?TE: Ajoute une livraison �� un POS sp�cifique
         */
        addDeliveryToPOS(posId, delivery) {
            if (!posId || !delivery) return null;
            // Initialise la structure si elle n'existe pas
            if (!this.db.posDataByLocation) this.db.posDataByLocation = {};
            if (!this.db.posDataByLocation[posId]) {
                this.db.posDataByLocation[posId] = {
                    clients: [], orders: [], deliveries: [], transactions: []
                };
            }
            // Ajoute la livraison avec le posId
            delivery.posId = posId;
            delivery.id = delivery.id || Date.now() + Math.random();
            this.db.posDataByLocation[posId].deliveries.push(delivery);
            this.save();
            return delivery;
        },

        /**
         * ISOLATION COMPL�?TE: Ajoute une transaction �� un POS sp�cifique
         */
        addTransactionToPOS(posId, transaction) {
            if (!posId || !transaction) return null;
            // Initialise la structure si elle n'existe pas
            if (!this.db.posDataByLocation) this.db.posDataByLocation = {};
            if (!this.db.posDataByLocation[posId]) {
                this.db.posDataByLocation[posId] = {
                    clients: [], orders: [], deliveries: [], transactions: []
                };
            }
            // Ajoute la transaction avec le posId
            transaction.posId = posId;
            transaction.id = transaction.id || Date.now() + Math.random();
            this.db.posDataByLocation[posId].transactions.push(transaction);
            this.save();
            return transaction;
        },

        /**
         * ISOLATION COMPL�?TE: Initialise les structures isol�es pour un nouveau POS
         */
        initializePOSData(posId) {
            if (!posId) return;
            if (!this.db.posDataByLocation) this.db.posDataByLocation = {};
            if (!this.db.posDataByLocation[posId]) {
                this.db.posDataByLocation[posId] = {
                    clients: [],
                    orders: [],
                    deliveries: [],
                    transactions: [],
                    notifications: [],
                    stockMovements: [],
                    notes: `Donn�es isol�es pour POS ${posId} cr�� le ${new Date().toLocaleDateString()}`
                };
            }
            this.save();
        },

        /**
         * ISOLATION COMPL�?TE: Diagnose et v�rifie que chaque POS est compl��tement isol�
         * Retourne un rapport d�taill� d'isolation
         */
        validatePOSIsolation() {
            const report = {
                timestamp: new Date().toISOString(),
                posCount: (this.db.pointsOfSale || []).length,
                isolationStatus: 'CHECKING',
                issues: [],
                summary: {}
            };

            const pos = this.db.pointsOfSale || [];
            
            pos.forEach(posRecord => {
                const posId = posRecord.id;
                
                // V�rifie que chaque POS a une structure isol�e
                if (!this.db.posDataByLocation || !this.db.posDataByLocation[posId]) {
                    report.issues.push(`�� ��? POS ${posId} (${posRecord.name}) n'a pas de structure isol�e`);
                } else {
                    report.issues.push(`���?� POS ${posId} (${posRecord.name}) structure isol�e OK`);
                }
                
                // Compte les donn�es isol�es
                const posData = this.db.posDataByLocation?.[posId] || {};
                report.summary[`POS_${posId}`] = {
                    name: posRecord.name,
                    clients: (posData.clients || []).length,
                    orders: (posData.orders || []).length,
                    deliveries: (posData.deliveries || []).length,
                    transactions: (posData.transactions || []).length,
                    notifications: (posData.notifications || []).length,
                    stockMovements: (posData.stockMovements || []).length
                };
                
                // V�rifie qu'aucune donn�e du POS n'est accessible en dehors de sa structure
                const orphanedOrders = (this.db.orders || []).filter(o => o.posId === posId && 
                    !(posData.orders || []).find(po => po.id === o.id));
                if (orphanedOrders.length > 0) {
                    report.issues.push(`��š ��� � � POS ${posId}: ${orphanedOrders.length} commande(s) orpheline(s)`);
                }
            });

            report.isolationStatus = report.issues.filter(i => i.includes('�� ��?')).length === 0 ? 'FULLY_ISOLATED' : 'PARTIALLY_ISOLATED';
            report.issueCount = report.issues.filter(i => i.includes('�� ��?')).length;
            
            console.log('��Ÿ� � ISOLATION REPORT:', report);
            return report;
        },

        /**
         * ISOLATION COMPL�?TE: Enforces isolation by moving all legacy data to isolated structures
         */
        enforceISOLATION() {
            console.log('��Ÿ�? Enforcement de l\'isolation compl��te...');
            
            // Initialise les structures isol�es pour tous les POS
            const pos = this.db.pointsOfSale || [];
            pos.forEach(p => this.initializePOSData(p.id));
            
            // Migrate les commandes vers les structures isol�es
            (this.db.orders || []).forEach(order => {
                if (order.posId && this.db.posDataByLocation && this.db.posDataByLocation[order.posId]) {
                    if (!this.db.posDataByLocation[order.posId].orders) {
                        this.db.posDataByLocation[order.posId].orders = [];
                    }
                    if (!this.db.posDataByLocation[order.posId].orders.find(o => o.id === order.id)) {
                        this.db.posDataByLocation[order.posId].orders.push({...order});
                    }
                }
            });
            
            // Migrate les livraisons vers les structures isol�es
            (this.db.deliveries || []).forEach(delivery => {
                if (delivery.posId && this.db.posDataByLocation && this.db.posDataByLocation[delivery.posId]) {
                    if (!this.db.posDataByLocation[delivery.posId].deliveries) {
                        this.db.posDataByLocation[delivery.posId].deliveries = [];
                    }
                    if (!this.db.posDataByLocation[delivery.posId].deliveries.find(d => d.id === delivery.id)) {
                        this.db.posDataByLocation[delivery.posId].deliveries.push({...delivery});
                    }
                }
            });
            
            // Migrate les clients vers les structures isol�es
            (this.db.clients || []).forEach(client => {
                if (client.posId && this.db.posDataByLocation && this.db.posDataByLocation[client.posId]) {
                    if (!this.db.posDataByLocation[client.posId].clients) {
                        this.db.posDataByLocation[client.posId].clients = [];
                    }
                    if (!this.db.posDataByLocation[client.posId].clients.find(c => c.id === client.id)) {
                        this.db.posDataByLocation[client.posId].clients.push({...client});
                    }
                }
            });
            
            this.save();
            const report = this.validatePOSIsolation();
            console.log('���?� Isolation forc�e termin�e:', report);
            return report;
        },

        // ========== KPI ET RAPPORTS PAR POS ==========

        /**
         * Calcule les KPIs d'un POS sp�cifique
         */
        getPOSKPIs(posId) {
            const orders = (this.db.orders || []).filter(o => o.posId == posId && o.status === 'delivered');
            const allOrders = (this.db.orders || []).filter(o => o.posId == posId);
            const deliveries = (this.db.deliveries || []).filter(d => d.posId == posId);
            const products = (this.db.products || []).filter(p => p.posId == posId);
            
            const totalRevenue = orders.reduce((sum, o) => sum + (o.total || 0), 0);
            const totalOrders = allOrders.length;
            const deliveredOrders = orders.length;
            const pendingOrders = allOrders.filter(o => o.status === 'pending').length;
            const deliveryRate = totalOrders > 0 ? Math.round((deliveredOrders / totalOrders) * 100) : 0;
            
            // Stock - utiliser posStocks si disponible
            const lowStockProducts = products.filter(p => {
                const stock = p.posStocks && p.posStocks[posId] ? p.posStocks[posId].stock : (p.stock || 0);
                const minStock = p.minStock || 0;
                return stock <= minStock;
            }).length;
            const totalStockValue = products.reduce((sum, p) => {
                const stock = p.posStocks && p.posStocks[posId] ? p.posStocks[posId].stock : (p.stock || 0);
                return sum + ((p.price || 0) * stock);
            }, 0);
            
            // Livraisons
            const avgDeliveryTime = deliveries.length > 0 
                ? Math.round(deliveries.reduce((sum, d) => sum + (d.deliveryTime || 0), 0) / deliveries.length)
                : 0;
            
            // Revenue par jour
            const today = Utils.todayKey();
            const todayOrders = orders.filter(o => (o.createdAt || '').startsWith(today));
            const todayRevenue = todayOrders.reduce((sum, o) => sum + (o.total || 0), 0);
            
            return {
                posId,
                totalRevenue: Math.round(totalRevenue),
                totalOrders,
                deliveredOrders,
                pendingOrders,
                deliveryRate,
                lowStockProducts,
                totalStockValue: Math.round(totalStockValue),
                avgDeliveryTime,
                todayRevenue: Math.round(todayRevenue),
                todayOrders: todayOrders.length
            };
        },

        /**
         * Compare les KPIs de tous les POS
         */
        getAllPOSKPIs() {
            const posList = this.db.pointsOfSale || [];
            return posList.map(pos => this.getPOSKPIs(pos.id));
        },

        /**
         * Top vendeurs par POS
         */
        getTopVendorsByPOS(posId, limit = 5) {
            const vendors = (this.db.users || []).filter(u => u.role === 'vendeur' && u.pos == posId);
            
            return vendors.map(v => {
                const orders = (this.db.orders || []).filter(o => o.vendeurId === v.id && o.status === 'delivered');
                const totalRevenue = orders.reduce((sum, o) => sum + (o.total || 0), 0);
                const totalOrders = orders.length;
                const avgOrder = totalOrders > 0 ? Math.round(totalRevenue / totalOrders) : 0;
                
                return {
                    id: v.id,
                    name: v.name,
                    revenue: Math.round(totalRevenue),
                    orderCount: totalOrders,
                    avgOrder,
                    rating: v.rating || 0
                };
            }).sort((a, b) => b.revenue - a.revenue).slice(0, limit);
        },

        /**
         * Top livreurs par POS (par vitesse de livraison)
         * Inclut les livreurs employ�s ET les livreurs ind�pendants approuv�s
         */
        getTopDeliveryPersonnelByPOS(posId, limit = 5) {
            // Livreurs employ�s du POS
            const employeeLivreurs = (this.db.users || []).filter(u => u.role === 'livreur' && u.pos == posId);
            
            // Livreurs ind�pendants approuv�s du POS
            const independentLivreurs = (this.db.independentDeliveryMen || [])
                .filter(dm => dm.posId == posId && dm.approvalStatus === 'approved');
            
            // Combiner les deux listes
            const allLivreurs = [
                ...employeeLivreurs.map(l => ({
                    id: l.id,
                    name: l.name,
                    vehicle: l.vehicle || 'N/A',
                    rating: l.rating || 0,
                    isIndependent: false
                })),
                ...independentLivreurs.map(dm => ({
                    id: dm.id,
                    name: dm.name + ' �� � �',
                    vehicle: dm.vehicle || 'N/A',
                    rating: dm.rating || 0,
                    isIndependent: true
                }))
            ];
            
            return allLivreurs.map(l => {
                const deliveries = (this.db.deliveries || []).filter(d => d.livreurId === l.id && d.posId == posId);
                const completedDeliveries = deliveries.filter(d => d.status === 'livree');
                const avgTime = completedDeliveries.length > 0
                    ? Math.round(completedDeliveries.reduce((sum, d) => sum + (d.deliveryTime || 0), 0) / completedDeliveries.length)
                    : 0;
                const totalDistance = deliveries.reduce((sum, d) => sum + (d.distance || 0), 0);
                
                return {
                    id: l.id,
                    name: l.name,
                    deliveryCount: completedDeliveries.length,
                    avgDeliveryTime: avgTime,
                    totalDistance: Math.round(totalDistance),
                    vehicle: l.vehicle,
                    rating: l.rating,
                    isIndependent: l.isIndependent
                };
            }).sort((a, b) => {
                // Trier par nombre de livraisons (desc) puis par temps moyen (asc)
                if (b.deliveryCount !== a.deliveryCount) return b.deliveryCount - a.deliveryCount;
                return a.avgDeliveryTime - b.avgDeliveryTime;
            }).slice(0, limit);
        },

        /**
         * Performance comparative: POS 1 vs POS 2 vs autres
         */
        getPOSPerformanceComparison() {
            const allKPIs = this.getAllPOSKPIs();
            
            if (allKPIs.length === 0) return null;
            
            // Trier par revenue
            const sorted = [...allKPIs].sort((a, b) => b.totalRevenue - a.totalRevenue);
            
            // Calculer les moyennes
            const avgRevenue = Math.round(allKPIs.reduce((sum, k) => sum + k.totalRevenue, 0) / allKPIs.length);
            const avgDeliveryRate = Math.round(allKPIs.reduce((sum, k) => sum + k.deliveryRate, 0) / allKPIs.length);
            
            return {
                allPOS: sorted,
                averages: {
                    revenue: avgRevenue,
                    deliveryRate: avgDeliveryRate
                },
                topPOS: sorted[0],
                bottomPOS: sorted[sorted.length - 1]
            };
        },

        // ========== ASSIGNATION INTELLIGENTE DES LIVREURS ==========

        /**
         * R�cup��re les livreurs disponibles d'un POS
         * @param {string} posId - ID du POS
         * @param {boolean} onlyAvailable - Si true, ne retourne que les livreurs libres
         */
        getAvailableLivreursByPOS(posId, onlyAvailable = true) {
            const livreurs = (this.db.users || []).filter(u => u.role === 'livreur' && u.pos === posId && u.active);
            
            if (!onlyAvailable) return livreurs;
            
            // Compter les livraisons en cours par livreur
            const activeDeliveries = (this.db.deliveries || []).filter(d => 
                d.posId === posId && ['en_cours', 'assigned'].includes(d.status)
            );
            
            const deliveryCount = {};
            activeDeliveries.forEach(d => {
                if (d.livreurId) {
                    deliveryCount[d.livreurId] = (deliveryCount[d.livreurId] || 0) + 1;
                }
            });
            
            // Retourner livreurs tri�s par nombre de livraisons (moins de livraisons = disponible)
            return livreurs
                .map(l => ({
                    ...l,
                    activeDeliveries: deliveryCount[l.id] || 0
                }))
                .sort((a, b) => a.activeDeliveries - b.activeDeliveries);
        },

        /**
         * Assigne automatiquement une livraison au livreur disponible
         * @param {string} posId - ID du POS
         * @param {string} deliveryId - ID de la livraison
         */
        autoAssignDelivery(posId, deliveryId) {
            const delivery = this.db.deliveries.find(d => d.id === deliveryId);
            if (!delivery) return null;

            // V�rifier que la livraison appartient �� ce POS
            if (delivery.posId !== posId) {
                console.warn("Auto-assign: Delivery does not belong to this POS");
                return null;
            }

            // R�cup�rer les livreurs disponibles du m��me POS
            const availableLivreurs = this.getAvailableLivreursByPOS(posId, true);
            if (availableLivreurs.length === 0) {
                return null; // Pas de livreur disponible
            }

            // Assigner au livreur le moins occup�
            const selectedLivreur = availableLivreurs[0];
            delivery.livreurId = selectedLivreur.id;
            delivery.status = 'assigned';
            delivery.assignedAt = new Date().toISOString();
            
            this.logActivity('update', 'delivery', deliveryId, {
                entityName: `Livraison #${delivery.orderRef || deliveryId}`,
                description: `Auto-assign�e �� ${selectedLivreur.name}`,
                before: { livreurId: null, status: 'pending' },
                after: { livreurId: selectedLivreur.id, status: 'assigned' }
            });

            this.save();
            return { delivery, livreur: selectedLivreur };
        },

        /**
         * Assigne manuellement une livraison �� un livreur (avec v�rification POS)
         * @param {string} deliveryId - ID de la livraison
         * @param {string} livreurId - ID du livreur
         */
        assignDeliveryToLivreur(deliveryId, livreurId) {
            const delivery = this.db.deliveries.find(d => d.id === deliveryId);
            const livreur = this.db.users.find(u => u.id === livreurId && u.role === 'livreur');

            if (!delivery || !livreur) return null;

            // V�rifier que le livreur appartient au m��me POS que la livraison
            if (livreur.pos !== delivery.posId) {
                console.warn("Assignment: Livreur and Delivery not in same POS");
                return null;
            }

            const oldLivreurId = delivery.livreurId;
            delivery.livreurId = livreurId;
            delivery.status = 'assigned';
            delivery.assignedAt = new Date().toISOString();

            this.logActivity('update', 'delivery', deliveryId, {
                entityName: `Livraison #${delivery.orderRef || deliveryId}`,
                description: `Assign�e manuellement �� ${livreur.name}`,
                before: { livreurId: oldLivreurId },
                after: { livreurId: livreurId }
            });

            this.save();
            return { delivery, livreur };
        },

        /**
         * Obtient les livreurs non-assign�s du m��me POS pour une livraison
         */
        getUnassignedLivreurs(posId) {
            return this.getAvailableLivreursByPOS(posId, false)
                .map(l => ({
                    id: l.id,
                    name: l.name,
                    vehicle: l.vehicle || 'N/A',
                    phone: l.phone || '',
                    rating: l.rating || 0,
                    activeDeliveries: (this.db.deliveries || [])
                        .filter(d => d.livreurId === l.id && ['en_cours', 'assigned'].includes(d.status))
                        .length
                }));
        },

        /**
         * R�cup��re les statistiques de charge pour les livreurs d'un POS
         */
        getLivreurWorkloadStats(posId) {
            const livreurs = this.getAvailableLivreursByPOS(posId, false);
            const stats = [];

            livreurs.forEach(l => {
                const deliveries = (this.db.deliveries || []).filter(d => d.livreurId === l.id && d.posId === posId);
                const completedToday = deliveries.filter(d => 
                    d.status === 'livree' && (d.createdAt || '').startsWith(Utils.todayKey())
                ).length;
                const activeDeliveries = deliveries.filter(d => 
                    ['en_cours', 'assigned'].includes(d.status)
                ).length;

                stats.push({
                    livreurId: l.id,
                    livreurName: l.name,
                    vehicle: l.vehicle || 'N/A',
                    completedToday,
                    activeDeliveries,
                    totalDistance: deliveries.filter(d => d.status === 'livree').reduce((sum, d) => sum + (d.distance || 0), 0),
                    avgDeliveryTime: deliveries.length > 0 
                        ? Math.round(deliveries.reduce((sum, d) => sum + (d.deliveryTime || 0), 0) / deliveries.length)
                        : 0,
                    rating: l.rating || 0
                });
            });

            return stats.sort((a, b) => a.activeDeliveries - b.activeDeliveries);
        },

        // ========== MOUVEMENTS DE STOCK AUDIT�S ==========

        /**
         * Enregistre un mouvement de stock avec audit complet
         * @param {object} movement - {type, productId, quantity, fromPosId, toPosId, notes, reason}
         */
        recordStockMovement(movement) {
            const product = this.getProduct(movement.productId);
            if (!product) return null;

            const user = this.state.currentUser;
            if (!user) return null;

            const fromPos = movement.fromPosId ? this.getPOS(movement.fromPosId) : null;
            const toPos = movement.toPosId ? this.getPOS(movement.toPosId) : null;

            // D�terminer les anciens et nouveaux stocks
            let oldStock = product.stock || 0;
            let newStock = oldStock;
            const status = movement.status || 'completed';
            const meta = movement.meta ? { ...movement.meta } : null;
            const direction = movement.direction || meta?.direction || null;

            const movementRecord = {
                id: 'MOV-' + new Date().getTime(),
                type: movement.type || 'adjustment', // 'transfer', 'reception', 'adjustment', 'sale', 'return'
                productId: movement.productId,
                productName: product.name,
                productSku: product.barcode || 'N/A',
                quantity: movement.quantity,
                posId: movement.posId !== undefined ? movement.posId : user.pos, // POS source
                fromPosId: movement.fromPosId || null, // Pour les transferts
                fromPosName: fromPos?.name || null,
                toPosId: movement.toPosId || null, // Pour les transferts
                toPosName: toPos?.name || null,
                userId: user.id,
                userName: user.name,
                userRole: user.role,
                timestamp: movement.timestamp || new Date().toISOString(),
                notes: movement.notes || '',
                reason: movement.reason || '', // 'transfer_request', 'manual_adjustment', 'sale', 'return', 'restock'
                status: status, // 'completed', 'pending', 'cancelled'
                direction: direction,
                oldStock: oldStock,
                newStock: newStock,
                unitPrice: movement.unitPrice || product.price,
                totalValue: (movement.unitPrice || product.price || 0) * movement.quantity,
                document: movement.document || null, // r�f�rence �� commande, retour, etc.
                meta: meta
            };

            this.db.stockMovements.push(movementRecord);

            // Log d'audit
            this.logActivity('create', 'stock_movement', movementRecord.id, {
                entityName: `Mouvement stock: ${product.name}`,
                description: `${movement.type}: ${movement.quantity} unit�s (${oldStock} ���? ${newStock})`,
                details: movementRecord
            });

            this.save();
            return movementRecord;
        },

        /**
         * Enregistre un transfert de stock entre deux POS
         * @param {string} fromPosId - POS source
         * @param {string} toPosId - POS destination
         * @param {string} productId - ID du produit
         * @param {number} quantity - Quantit� transf�r�e
         * @param {string} notes - Notes du transfert
         */
        recordTransfer(fromPosId, toPosId, productId, quantity, notes = '') {
            const product = this.getProduct(productId);
            if (!product) return null;

            const fromPos = this.getPOS(fromPosId);
            const toPos = this.getPOS(toPosId);
            if (!fromPos || !toPos) return null;

            const qty = Math.max(0, Number(quantity) || 0);
            if (qty <= 0) return null;

            // V�rifier que le produit existe dans le POS source
            // (Normalement le produit a un posId, mais dans un syst��me multi-POS r�el, 
            // on devrait avoir une table separ�e de stock par POS)

            // ===== CRITICAL FIX: ADD PRODUCT TO DESTINATION POS =====
            // Initialize posStocks if not exists
            if (!product.posStocks) {
                product.posStocks = {};
            }

            if (!product.posStocks[fromPosId]) {
                product.posStocks[fromPosId] = {
                    stock: 0,
                    lastUpdated: new Date().toISOString()
                };
            }

            // Ensure destination POS has this product in posStocks
            if (!product.posStocks[toPosId]) {
                product.posStocks[toPosId] = { 
                    stock: 0, 
                    lastUpdated: new Date().toISOString()
                };
            }

            // Add transferred quantity to destination
            product.posStocks[toPosId].stock += qty;
            product.posStocks[toPosId].lastUpdated = new Date().toISOString();

            // Reduce stock from source POS
            if (product.posStocks[fromPosId]) {
                product.posStocks[fromPosId].stock -= qty;
                if (product.posStocks[fromPosId].stock < 0) {
                    product.posStocks[fromPosId].stock = 0;
                }
                product.posStocks[fromPosId].lastUpdated = new Date().toISOString();
            }

            const movement = this.recordStockMovement({
                type: 'transfer',
                productId,
                quantity: qty,
                posId: fromPosId,
                fromPosId,
                toPosId,
                notes,
                reason: 'transfer_request',
                meta: {
                    source: 'manager_transfer',
                    direction: 'out',
                    pairedPosId: toPosId
                }
            });

            return movement;
        },

        createTransferReceipt(data = {}) {
            const now = new Date().toISOString();
            if (!this.db.transferReceipts) this.db.transferReceipts = [];

            const product = data.productId ? this.getProduct(data.productId) : null;
            const receipt = {
                id: Utils.uid('RCPT'),
                reference: data.reference || null,
                productId: data.productId,
                productName: data.productName || product?.name || 'Produit',
                productSku: data.productSku || product?.barcode || 'N/A',
                quantity: Math.max(0, Number(data.quantity) || 0),
                fromPosId: data.fromPosId ?? null,
                fromPosName: data.fromPosName || null,
                toPosId: data.toPosId ?? null,
                toPosName: data.toPosName || null,
                note: data.note || '',
                attachments: Array.isArray(data.attachments) ? data.attachments.map(a => ({ ...a })) : [],
                trackingNumber: data.trackingNumber || '',
                estimatedArrivalAt: data.estimatedArrivalAt || null,
                recommended: data.recommended ?? null,
                status: 'pending',
                createdAt: data.createdAt || now,
                updatedAt: now,
                requestedById: data.requestedById || this.state.currentUser?.id || null,
                requestedByName: data.requestedByName || this.state.currentUser?.name || null,
                meta: { status: 'pending', ...(data.meta || {}) }
            };

            this.db.transferReceipts.push(receipt);

            if (product && receipt.toPosId !== null && receipt.toPosId !== undefined) {
                if (!product.posStocks) product.posStocks = {};
                if (!product.posStocks[receipt.toPosId]) {
                    product.posStocks[receipt.toPosId] = {
                        stock: 0,
                        price: product.price || 0,
                        lastUpdated: now,
                        pendingIncoming: 0
                    };
                }

                const entry = product.posStocks[receipt.toPosId];
                const currentPending = Number(entry.pendingIncoming || 0);
                entry.pendingIncoming = Math.max(0, currentPending + receipt.quantity);
                entry.lastUpdated = now;
            }

            this.logActivity('create', 'transfer_receipt', receipt.id, {
                entityName: `Transfert vers ${receipt.toPosName || receipt.toPosId || 'POS'}`,
                description: `${receipt.quantity} unit�(s) de ${receipt.productName}`,
                details: receipt,
                status: 'pending'
            });

            this.save();
            return receipt;
        },

        getTransferReceipt(receiptId) {
            return (this.db.transferReceipts || []).find(r => r.id === receiptId) || null;
        },

        getTransferReceipts(filters = {}) {
            const receipts = this.db.transferReceipts || [];
            return receipts
                .filter(r => {
                    if (filters.posId !== undefined && filters.posId !== null) {
                        if (Number(r.toPosId) !== Number(filters.posId)) return false;
                    }
                    if (filters.status) {
                        const statuses = Array.isArray(filters.status) ? filters.status : [filters.status];
                        if (!statuses.includes(r.status)) return false;
                    }
                    return true;
                })
                .sort((a, b) => new Date(b.createdAt || b.updatedAt || 0) - new Date(a.createdAt || a.updatedAt || 0));
        },

        approveTransferReceipt(receiptId, note = '') {
            const receipt = this.getTransferReceipt(receiptId);
            if (!receipt) return { success: false, message: 'Transfert introuvable.' };
            if (receipt.status !== 'pending') return { success: false, message: 'Transfert d�j�� trait�.' };

            const product = this.getProduct(receipt.productId);
            if (!product) return { success: false, message: 'Produit introuvable.' };

            const now = new Date().toISOString();
            receipt.status = 'accepted';
            receipt.updatedAt = now;
            receipt.receivedAt = now;
            receipt.receivedById = this.state.currentUser?.id || null;
            receipt.receivedByName = this.state.currentUser?.name || null;
            if (note) receipt.receivedNote = note;

            if (!product.posStocks) product.posStocks = {};
            if (!product.posStocks[receipt.toPosId]) {
                product.posStocks[receipt.toPosId] = { stock: 0, lastUpdated: now };
            }
            const entry = product.posStocks[receipt.toPosId];
            const previousStock = Number(entry.stock) || 0;
            const pendingBefore = Number(entry.pendingIncoming || 0);
            entry.stock = previousStock + receipt.quantity;
            entry.lastUpdated = now;
            entry.pendingIncoming = Math.max(0, pendingBefore - receipt.quantity);

            (this.db.stockMovements || []).forEach(m => {
                if (m.meta?.receiptId === receiptId) {
                    m.status = 'completed';
                    const meta = { ...(m.meta || {}) };
                    meta.status = 'accepted';
                    meta.acknowledgedAt = now;
                    meta.acknowledgedBy = receipt.receivedByName || null;
                    if (note) meta.receivedNote = note;
                    m.meta = meta;
                    if (m.direction === 'in' || m.meta?.direction === 'in') {
                        m.oldStock = previousStock;
                        m.newStock = product.posStocks[receipt.toPosId].stock;
                    }
                }
            });

            receipt.meta = { ...(receipt.meta || {}), status: 'accepted' };

            this.logActivity('update', 'transfer_receipt', receipt.id, {
                entityName: `R�ception ${receipt.reference || receipt.id}`,
                description: `R�ception confirm�e (${receipt.quantity} ${receipt.productName})`,
                details: receipt,
                status: 'accepted'
            });

            this.save();
            return { success: true, receipt };
        },

        rejectTransferReceipt(receiptId, reason = '') {
            const receipt = this.getTransferReceipt(receiptId);
            if (!receipt) return { success: false, message: 'Transfert introuvable.' };
            if (receipt.status !== 'pending') return { success: false, message: 'Transfert d�j�� trait�.' };

            const product = this.getProduct(receipt.productId);
            const now = new Date().toISOString();

            receipt.status = 'rejected';
            receipt.updatedAt = now;
            receipt.rejectedAt = now;
            receipt.rejectedById = this.state.currentUser?.id || null;
            receipt.rejectedByName = this.state.currentUser?.name || null;
            receipt.rejectedReason = reason || '';

            if (product) {
                product.stock = (Number(product.stock) || 0) + receipt.quantity;
                if (product.posStocks && receipt.toPosId !== null && receipt.toPosId !== undefined && product.posStocks[receipt.toPosId]) {
                    const entry = product.posStocks[receipt.toPosId];
                    const currentPending = Number(entry.pendingIncoming || 0);
                    entry.pendingIncoming = Math.max(0, currentPending - receipt.quantity);
                    entry.lastUpdated = now;
                }
            }

            (this.db.stockMovements || []).forEach(m => {
                if (m.meta?.receiptId === receiptId) {
                    m.status = 'cancelled';
                    const meta = { ...(m.meta || {}) };
                    meta.status = 'rejected';
                    meta.acknowledgedAt = now;
                    meta.rejectionReason = reason || '';
                    meta.acknowledgedBy = receipt.rejectedByName || null;
                    m.meta = meta;
                }
            });

            receipt.meta = { ...(receipt.meta || {}), status: 'rejected' };

            this.logActivity('update', 'transfer_receipt', receipt.id, {
                entityName: `R�ception ${receipt.reference || receipt.id}`,
                description: `R�ception rejet�e (${receipt.quantity} ${receipt.productName})`,
                details: { ...receipt, reason },
                status: 'rejected'
            });

            this.save();
            return { success: true, receipt };
        },

        getMovementHistory(filters = {}) {
                const user = this.state.currentUser;
                const movementsSource = this.db.stockMovements || [];

                const movementsEnriched = movementsSource.map(m => {
                    const product = this.getProduct(m.productId) || {};
                    const quantity = Number(m.quantity ?? m.qty ?? 0);
                    const unitPrice = Number(m.totalValue && quantity ? m.totalValue / quantity : (m.meta?.unitPrice ?? product.price ?? 0));
                    const timestamp = m.timestamp || m.createdAt || new Date(m.id || Date.now()).toISOString();
                    const direction = m.meta?.direction || m.direction || (m.type === 'transfer'
                        ? (m.fromPosId ? 'out' : (m.toPosId ? 'in' : null))
                        : (m.type === 'out' ? 'out' : (m.type === 'in' ? 'in' : null)));

                    const fromPosName = m.fromPosName
                        || m.meta?.originName
                        || (m.fromPosId !== null && m.fromPosId !== undefined
                            ? (this.getPOS(m.fromPosId)?.name || `POS ${m.fromPosId}`)
                            : (m.meta?.source === 'manager_transfer' ? 'D�p��t principal' : null));

                    const toPosName = m.toPosName
                        || m.meta?.destinationName
                        || (m.toPosId !== null && m.toPosId !== undefined
                            ? (this.getPOS(m.toPosId)?.name || `POS ${m.toPosId}`)
                            : null);

                    return {
                        ...m,
                        qty: quantity,
                        quantity,
                        productName: m.productName || product.name || '�� ?��',
                        totalValue: Number(m.totalValue ?? (quantity * unitPrice)),
                        unitPrice,
                        timestamp,
                        direction,
                        fromPosName,
                        toPosName,
                        type: m.type || m.meta?.type || 'adjust'
                    };
                });

                let movements = movementsEnriched;

                if (user && (user.role === 'gestionnaire' || user.role === 'vendeur')) {
                    const userPos = user.pos;
                    movements = movements.filter(m => {
                        const related = [m.posId, m.fromPosId, m.toPosId].filter(v => v !== null && v !== undefined);
                        if (related.length === 0) return true;
                        return related.map(Number).includes(Number(userPos));
                    });
                }

                if (filters.posId) {
                    const targetPos = Number(filters.posId);
                    movements = movements.filter(m => {
                        const related = [m.posId, m.fromPosId, m.toPosId]
                            .filter(v => v !== null && v !== undefined)
                            .map(Number);
                        return related.includes(targetPos);
                    });
                }

                if (filters.productId) {
                    movements = movements.filter(m => Number(m.productId) === Number(filters.productId));
                }

                if (filters.type) {
                    const typeList = Array.isArray(filters.type) ? filters.type : [filters.type];
                    movements = movements.filter(m => typeList.includes(m.type));
                }

                if (filters.direction) {
                    const directionList = Array.isArray(filters.direction) ? filters.direction : [filters.direction];
                    movements = movements.filter(m => m.direction && directionList.includes(m.direction));
                }

                if (filters.userId) {
                    movements = movements.filter(m => m.userId === filters.userId);
                }

                if (filters.search) {
                    const needle = filters.search.toLowerCase();
                    movements = movements.filter(m => {
                        return [m.productName, m.note, m.ref, m.userName]
                            .filter(Boolean)
                            .some(field => String(field).toLowerCase().includes(needle));
                    });
                }

                if (filters.startDate && filters.endDate) {
                    const start = new Date(filters.startDate);
                    const end = new Date(filters.endDate);
                    movements = movements.filter(m => {
                        const movDate = new Date(m.timestamp || m.createdAt);
                        return movDate >= start && movDate <= end;
                    });
                }

                return movements.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            },

        /**
         * R�cup��re l'historique des mouvements pour un produit
         */
        getProductMovementHistory(productId, posId = null) {
            const user = this.state.currentUser;
            if (!user) return [];

            let movements = (this.db.stockMovements || []).filter(m => m.productId === productId);

            // Appliquer les permissions
            if (user.role === 'gestionnaire' || user.role === 'vendeur') {
                if (posId && posId !== user.pos) return []; // Pas d'acc��s
                movements = movements.filter(m => m.posId === user.pos);
            }

            return movements.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        },

        /**
         * G�n��re un r�sum� des mouvements pour un POS et une p�riode
         */
        getStockMovementSummary(posId, startDate, endDate) {
            const movements = this.getMovementHistory({ posId, startDate, endDate });
            
            const summary = {
                totalMovements: movements.length,
                byType: {},
                byProduct: {},
                byUser: {},
                totalValue: 0,
                transfers: {
                    sent: movements.filter(m => m.type === 'transfer' && m.fromPosId === posId).length,
                    received: movements.filter(m => m.type === 'transfer' && m.toPosId === posId).length
                }
            };

            movements.forEach(m => {
                // Par type
                summary.byType[m.type] = (summary.byType[m.type] || 0) + 1;

                // Par produit
                if (!summary.byProduct[m.productName]) {
                    summary.byProduct[m.productName] = { qty: 0, value: 0, movements: 0 };
                }
                summary.byProduct[m.productName].qty += m.quantity;
                summary.byProduct[m.productName].value += m.totalValue;
                summary.byProduct[m.productName].movements += 1;

                // Par utilisateur
                if (!summary.byUser[m.userName]) {
                    summary.byUser[m.userName] = { count: 0, role: m.userRole };
                }
                summary.byUser[m.userName].count += 1;

                summary.totalValue += m.totalValue;
            });

            return summary;
        },

        // Gestion am�lior�e des variantes
        createProductVariant(productId, attributes, sku, price, stock, weight = null, temperature = null) {
            if (!this.hasPermission('products.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return null;
            }
            const product = this.getProduct(productId);
            if (!product) return null;

            const variant = {
                id: 'VAR-' + new Date().getTime(),
                productId: productId,
                attributes: attributes, // [{name, value}, ...]
                sku: sku,
                price: price || product.price,
                stock: stock || 0,
                weight: weight,
                temperature: temperature,
                barcode: null,
                active: true,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                notes: ''
            };

            this.db.productVariants.push(variant);
            this.logActivity('create', 'product_variant', variant.id, {
                entityName: `Variante de ${product.name}`,
                description: attributes.map(a => a.name + ': ' + a.value).join(', ')
            });
            this.save();
            return variant;
        },

        updateProductVariant(variantId, updates) {
            if (!this.hasPermission('products.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return null;
            }
            const variant = this.db.productVariants.find(v => v.id === variantId);
            if (!variant) return null;

            const before = { ...variant };
            Object.assign(variant, updates);
            variant.updatedAt = new Date().toISOString();

            this.logActivity('update', 'product_variant', variantId, {
                entityName: `Variante`,
                description: `Mise �� jour variante`,
                before, after: variant
            });
            this.save();
            return variant;
        },

        deleteProductVariant(variantId) {
            if (!this.hasPermission('products.delete')) {
                UI.toast('Acc��s refus�', 'error');
                return false;
            }
            const index = this.db.productVariants.findIndex(v => v.id === variantId);
            if (index === -1) return false;

            this.db.productVariants.splice(index, 1);
            this.logActivity('delete', 'product_variant', variantId, {
                entityName: `Variante`,
                description: `Variante supprim�e`
            });
            this.save();
            return true;
        },

        getVariantDescription(variant) {
            return variant.attributes.map(a => a.name + ': ' + a.value).join(' �� ?� � ');
        },

        getVariantStockStatus(variant) {
            if (variant.stock <= 0) return { status: 'rupture', label: 'Rupture', color: 'red' };
            if (variant.stock <= 5) return { status: 'critique', label: 'Critique', color: 'orange' };
            if (variant.stock <= 20) return { status: 'faible', label: 'Faible', color: 'amber' };
            return { status: 'ok', label: 'OK', color: 'emerald' };
        },

        getProductWithVariants(productId) {
            const product = this.getProduct(productId);
            if (!product) return null;

            return {
                ...product,
                variants: this.getProductVariants(productId)
            };
        },

        searchVariants(productId, searchTerm = '') {
            const variants = this.getProductVariants(productId);
            if (!searchTerm) return variants;

            const term = searchTerm.toLowerCase();
            return variants.filter(v => 
                v.sku.toLowerCase().includes(term) ||
                v.attributes.some(a => a.value.toLowerCase().includes(term))
            );
        },

        getVariantsBySKU(sku) {
            return this.db.productVariants.find(v => v.sku === sku);
        },

        // Image Management
        uploadProductImage(productId, base64Data, filename, alt = '') {
            const product = this.getProduct(productId);
            if (!product) return null;

            const filesize = Math.round((base64Data.length * 3) / 4);
            const existingImages = this.db.productImages.filter(img => img.productId === productId);
            const isPrimary = existingImages.length === 0;
            
            const image = {
                id: 'img_' + new Date().getTime(),
                productId: productId,
                productName: product.name,
                url: base64Data,
                filename: filename || `image_${Date.now()}`,
                filesize: filesize,
                uploadedAt: new Date().toISOString(),
                uploadedBy: this.state.currentUser?.id,
                uploadedByName: this.state.currentUser?.name,
                isPrimary: isPrimary,
                alt: alt,
                tags: [],
                order: existingImages.length
            };

            this.db.productImages.push(image);
            
            // Si c'est la premi��re image et que le produit n'a pas d'image, la d�finir comme principale
            if (isPrimary && !product.image) {
                this.update('products', productId, { image: base64Data });
            }
            
            this.save();
            return image;
        },

        getProductImages(productId) {
            const images = this.db.productImages.filter(img => img.productId === productId);
            return images.sort((a, b) => (a.order || 0) - (b.order || 0));
        },

        getPrimaryProductImage(productId) {
            return this.db.productImages.find(img => img.productId === productId && img.isPrimary);
        },

        setPrimaryImage(imageId) {
            const image = this.db.productImages.find(img => img.id === imageId);
            if (!image) return false;

            // Unset previous primary
            this.db.productImages.forEach(img => {
                if (img.productId === image.productId && img.isPrimary) {
                    img.isPrimary = false;
                }
            });

            image.isPrimary = true;
            this.save();
            return true;
        },

        deleteProductImage(imageId) {
            if (!this.hasPermission('products.delete')) {
                UI.toast('Acc��s refus�', 'error');
                return false;
            }
            const index = this.db.productImages.findIndex(img => img.id === imageId);
            if (index === -1) return false;

            const deleted = this.db.productImages[index];
            this.db.productImages.splice(index, 1);

            // If deleted was primary, set new primary
            const remaining = this.db.productImages.filter(img => img.productId === deleted.productId);
            if (remaining.length > 0 && !remaining.some(img => img.isPrimary)) {
                remaining[0].isPrimary = true;
            }

            // Re-order remaining images
            remaining.forEach((img, idx) => {
                img.order = idx;
            });

            this.save();
            return true;
        },

        reorderProductImages(productId, imageIds) {
            const images = this.db.productImages.filter(img => img.productId === productId);
            imageIds.forEach((id, idx) => {
                const img = images.find(i => i.id === id);
                if (img) img.order = idx;
            });
            this.save();
        },

        updateImageMetadata(imageId, alt, tags) {
            const image = this.db.productImages.find(img => img.id === imageId);
            if (!image) return false;
            image.alt = alt;
            image.tags = tags;
            this.save();
            return true;
        },

        // Independent Delivery Men Management
        createIndependentDeliveryMan(name, phone, vendeurId, notes = '') {
            const vendor = this.getUser(vendeurId);
            if (!vendor) return null;

            const settings = this.getGestionnaireSettings();
            const approvalStatus = settings.independentDeliveryMenApprovalRequired ? 'pending' : 'approved';

            const deliveryMan = {
                id: 'idm_' + new Date().getTime(),
                name: name,
                phone: phone,
                vendeurId: vendeurId,
                vendeurName: vendor.name,
                posId: vendor.pos,  // Ajouter le POS du vendeur
                createdAt: new Date().toISOString(),
                approvalStatus: approvalStatus,
                status: 'active',
                deliveryCount: 0,
                totalEarnings: 0,
                notes: notes
            };

            this.db.independentDeliveryMen.push(deliveryMan);
            this.save();
            return deliveryMan;
        },

        getIndependentDeliveryMen(vendeurId = null) {
            let men = this.db.independentDeliveryMen || [];
            if (vendeurId) {
                men = men.filter(m => m.vendeurId === vendeurId && m.approvalStatus === 'approved');
            }
            return men;
        },

        // Retourne tous les livreurs pour un POS donn�, y compris les livreurs ind�pendants approuv�s cr��s pour ce POS
        getLivreursForPOS(posId) {
            const users = (this.db.users || []).filter(u => u.role === 'livreur' && u.active && u.pos == posId);
            const indeps = (this.db.independentDeliveryMen || [])
                .filter(dm => dm.posId == posId && dm.approvalStatus === 'approved')
                .map(dm => ({
                    id: dm.id,
                    name: dm.name,
                    phone: dm.phone,
                    pos: dm.posId,
                    vehicle: dm.vehicle || null,
                    rating: dm.rating || 0,
                    independent: true,
                    active: dm.status !== 'inactive',
                    deliveryCount: dm.deliveryCount ?? (this.db.deliveries || []).filter(d => d.livreurId === dm.id).length
                }));
            return [...users, ...indeps];
        },

        // Retourne tous les livreurs actifs (utilisateurs + ind�pendants approuv�s)
        getAllActiveLivreurs() {
            const users = (this.db.users || []).filter(u => u.role === 'livreur' && u.active).map(u => ({ ...u }));
            const indeps = (this.db.independentDeliveryMen || [])
                .filter(dm => dm.approvalStatus === 'approved')
                .map(dm => ({
                    id: dm.id,
                    name: dm.name,
                    phone: dm.phone,
                    pos: dm.posId,
                    vehicle: dm.vehicle || null,
                    rating: dm.rating || 0,
                    independent: true,
                    active: dm.status !== 'inactive',
                    deliveryCount: dm.deliveryCount ?? (this.db.deliveries || []).filter(d => d.livreurId === dm.id).length
                }));
            return [...users, ...indeps];
        },

        // R�cup�rer un template de bon de livraison existant
        getDeliveryTicketTemplate(vendeurId, type) {
            this.db.deliveryTicketTemplates = this.db.deliveryTicketTemplates || [];
            return this.db.deliveryTicketTemplates.find(t => t.vendeurId === vendeurId && t.name === type);
        },

        // R�cup�rer ou cr�er un template par d�faut
        getOrCreateDefaultTemplate(vendeurId, type) {
            this.db.deliveryTicketTemplates = this.db.deliveryTicketTemplates || [];
            let template = this.db.deliveryTicketTemplates.find(t => t.vendeurId === vendeurId && t.name === type);
            
            if (!template) {
                // Cr�er un template par d�faut
                const smsDefault = '��Ÿ? � Commande {orderRef}\nClient: {clientName}\n��Ÿ? � {address}\n��Ÿ? � {clientPhone}\n��Ÿ? � Montant: {amount}\n��Ÿšš �?� collecter: {collectedAmount}\n\nProduits:\n{items}\n\n�� � � Livraison pr�vue: {deliveryTime}';
                
                const directDefault = '============================\n       BON DE LIVRAISON\n============================\nR�f: {orderRef}\nDate: ' + new Date().toLocaleDateString('fr-FR') + '\n\nClient: {clientName}\nAdresse: {address}\nT�l: {clientPhone}\n\n----------------------------\nPRODUITS:\n{items}\n----------------------------\n\nTotal: {amount}\n�?� collecter: {collectedAmount}\n\nHeure de livraison: {deliveryTime}\n============================';
                
                const defaultContent = type === 'SMS' ? smsDefault : directDefault;

                template = {
                    id: Date.now(),
                    vendeurId: vendeurId,
                    vendeurName: this.getUser(vendeurId)?.name || 'Vendeur',
                    name: type,
                    content: defaultContent,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                this.db.deliveryTicketTemplates.push(template);
                this.save();
            }
            
            return template;
        },

        updateDeliveryTicketTemplate(vendeurId, type, content) {
            let template = this.getDeliveryTicketTemplate(vendeurId, type);
            
            if (template) {
                template.content = content;
                template.updatedAt = new Date().toISOString();
                this.save();
                return template;
            }
            
            // Si le template n'existe pas, le cr�er
            template = this.getOrCreateDefaultTemplate(vendeurId, type);
            template.content = content;
            template.updatedAt = new Date().toISOString();
            this.save();
            return template;
        },

        // R�cup�rer les param��tres de re��u d'un vendeur
        getReceiptSettings(vendeurId) {
            this.db.receiptSettings = this.db.receiptSettings || {};
            return this.db.receiptSettings[vendeurId] || {
                companyName: '',
                subtitle: 'Re��u de Livraison',
                phone: '',
                address: '',
                showLogo: true,
                showItems: true,
                showSignature: true,
                showCommission: false,
                showProofPhotos: false,
                thankMessage: 'Merci pour votre confiance!',
                footerNote: ''
            };
        },

        // Sauvegarder les param��tres de re��u d'un vendeur
        saveReceiptSettings(vendeurId, settings) {
            this.db.receiptSettings = this.db.receiptSettings || {};
            this.db.receiptSettings[vendeurId] = {
                ...settings,
                updatedAt: new Date().toISOString()
            };
            this.save();
            return this.db.receiptSettings[vendeurId];
        },

        // R�cup�rer les param��tres de validation de livraison par POS
        getDeliveryValidationSettings(posId) {
            this.db.deliveryValidationSettings = this.db.deliveryValidationSettings || {};
            return this.db.deliveryValidationSettings[posId] || {
                requirePhoto: true,
                requireSignature: false,
                minPhotos: 1,
                maxPhotos: 5,
                requireBoth: false // Si true, exige photo ET signature
            };
        },

        // Sauvegarder les param��tres de validation de livraison par POS
        saveDeliveryValidationSettings(posId, settings) {
            this.db.deliveryValidationSettings = this.db.deliveryValidationSettings || {};
            this.db.deliveryValidationSettings[posId] = {
                ...settings,
                updatedAt: new Date().toISOString()
            };
            this.save();
            return this.db.deliveryValidationSettings[posId];
        },

        // V�rifier si une livraison peut ��tre valid�e selon les param��tres
        canValidateDelivery(deliveryId, photos, signature) {
            const d = this.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return { valid: false, message: 'Livraison non trouv�e' };

            // R�cup�rer le POS de la livraison
            const posId = d.posId || d.vendeurId;
            const settings = this.getDeliveryValidationSettings(posId);

            const hasPhotos = photos && photos.length > 0;
            const hasEnoughPhotos = photos && photos.length >= (settings.minPhotos || 1);
            const hasSignature = !!signature;

            // Si les deux sont d�sactiv�s, permettre la validation
            if (!settings.requirePhoto && !settings.requireSignature) {
                return { valid: true };
            }

            // Si les deux sont requis
            if (settings.requireBoth) {
                if (!hasEnoughPhotos) {
                    return { valid: false, message: `Veuillez ajouter au moins ${settings.minPhotos || 1} photo(s)` };
                }
                if (!hasSignature) {
                    return { valid: false, message: 'La signature du client est requise' };
                }
                return { valid: true };
            }

            // Si photo requise uniquement
            if (settings.requirePhoto && !settings.requireSignature) {
                if (!hasEnoughPhotos) {
                    return { valid: false, message: `Veuillez ajouter au moins ${settings.minPhotos || 1} photo(s)` };
                }
                return { valid: true };
            }

            // Si signature requise uniquement
            if (settings.requireSignature && !settings.requirePhoto) {
                if (!hasSignature) {
                    return { valid: false, message: 'La signature du client est requise' };
                }
                return { valid: true };
            }

            // Si l'un ou l'autre (photo OU signature)
            if (settings.requirePhoto || settings.requireSignature) {
                if (!hasPhotos && !hasSignature) {
                    return { valid: false, message: 'Veuillez ajouter une photo OU la signature du client' };
                }
                return { valid: true };
            }

            return { valid: true };
        },

        renderDeliveryTicket(vendeurId, type, delivery, order) {
            const template = this.getOrCreateDefaultTemplate(vendeurId, type);
            if (!template) return '';

            let content = template.content;
            
            // Remplacer les variables
            const replacements = {
                '{orderRef}': delivery?.orderRef || '',
                '{clientName}': delivery?.clientName || '',
                '{address}': delivery?.address || '',
                '{clientPhone}': delivery?.clientPhone || '',
                '{amount}': this.formatPrice(order?.total || 0),
                '{collectedAmount}': this.formatPrice(delivery?.amount || 0)
            };

            Object.entries(replacements).forEach(([key, value]) => {
                content = content.replace(new RegExp(key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), value);
            });

            return content;
        },

        approveIndependentDeliveryMan(deliveryManId) {
            const deliveryMan = this.db.independentDeliveryMen.find(dm => dm.id === deliveryManId);
            if (deliveryMan) {
                deliveryMan.approvalStatus = 'approved';
                deliveryMan.approvedAt = new Date().toISOString();
                this.save();
                return true;
            }
            return false;
        },

        rejectIndependentDeliveryMan(deliveryManId, reason = '') {
            const index = this.db.independentDeliveryMen.findIndex(dm => dm.id === deliveryManId);
            if (index !== -1) {
                const deliveryMan = this.db.independentDeliveryMen[index];
                deliveryMan.approvalStatus = 'rejected';
                deliveryMan.rejectionReason = reason;
                deliveryMan.rejectedAt = new Date().toISOString();
                this.save();
                return true;
            }
            return false;
        },

        getPendingDeliveryMen(posId = null) {
            let pending = this.db.independentDeliveryMen.filter(dm => dm.approvalStatus === 'pending');
            if (posId) {
                pending = pending.filter(dm => dm.posId == posId);
            }
            return pending;
        },

        getApprovedDeliveryMen(vendeurId) {
            return this.db.independentDeliveryMen.filter(dm => dm.vendeurId === vendeurId && dm.approvalStatus === 'approved');
        },

        // Gestionnaire Settings
        getGestionnaireSettings() {
            const raw = localStorage.getItem('gestionnaire_settings');
            if (!raw) {
                return {
                    independentDeliveryMenApprovalRequired: true,
                    slaRetardBasse: 480,
                    slaRetardMoyenne: 240,
                    slaRetardHaute: 120,
                    slaAnnulBasse: 240,
                    slaAnnulMoyenne: 120,
                    slaAnnulHaute: 60,
                    slaLitigeBasse: 1440,
                    slaLitigeMoyenne: 480,
                    slaLitigeHaute: 240,
                    // ========== NOUVELLES FONCTIONNALIT�S LIVREUR ==========
                    deliveryPhotoValidationEnabled: true,
                    deliveryPhotoSignatureEnabled: false,
                    deliveryPhotoGPSEnabled: false,
                    deliveryRatingEnabled: true
                };
            }
            try {
                const settings = JSON.parse(raw);
                // Ajouter les nouvelles cl�s si manquantes (r�trocompatibilit�)
                if (!settings.hasOwnProperty('deliveryPhotoValidationEnabled')) {
                    settings.deliveryPhotoValidationEnabled = true;
                }
                if (!settings.hasOwnProperty('deliveryPhotoSignatureEnabled')) {
                    settings.deliveryPhotoSignatureEnabled = false;
                }
                if (!settings.hasOwnProperty('deliveryPhotoGPSEnabled')) {
                    settings.deliveryPhotoGPSEnabled = false;
                }
                if (!settings.hasOwnProperty('deliveryRatingEnabled')) {
                    settings.deliveryRatingEnabled = true;
                }
                return settings;
            } catch (e) {
                return {
                    independentDeliveryMenApprovalRequired: true,
                    slaRetardBasse: 480,
                    slaRetardMoyenne: 240,
                    slaRetardHaute: 120,
                    slaAnnulBasse: 240,
                    slaAnnulMoyenne: 120,
                    slaAnnulHaute: 60,
                    slaLitigeBasse: 1440,
                    slaLitigeMoyenne: 480,
                    slaLitigeHaute: 240,
                    deliveryPhotoValidationEnabled: true,
                    deliveryPhotoSignatureEnabled: false,
                    deliveryPhotoGPSEnabled: false,
                    deliveryRatingEnabled: true
                };
            }
        },

        setGestionnaireSettings(settings) {
            localStorage.setItem('gestionnaire_settings', JSON.stringify(settings));
            return settings;
        },

        // Syst��me de param��tres globaux
        getSystemSetting(key, defaultValue = null) {
            try {
                const settings = JSON.parse(localStorage.getItem('system_settings') || '{}');
                return settings.hasOwnProperty(key) ? settings[key] : defaultValue;
            } catch (e) {
                return defaultValue;
            }
        },

        setSystemSetting(key, value) {
            try {
                const settings = JSON.parse(localStorage.getItem('system_settings') || '{}');
                settings[key] = value;
                localStorage.setItem('system_settings', JSON.stringify(settings));
                return true;
            } catch (e) {
                return false;
            }
        },

        // Role & Permission Management
        createCustomRole(name, baseRole, permissions = {}) {
            const roles = this.getCustomRoles();
            const role = {
                id: 'role_' + new Date().getTime(),
                name,
                baseRole, // 'gestionnaire', 'superviseur_vendeurs', 'responsable_livraison'
                permissions: {
                    dashboard: permissions.dashboard !== false,
                    stocks: permissions.stocks !== false,
                    deliveries: permissions.deliveries !== false,
                    team: permissions.team !== false,
                    planning: permissions.planning !== false,
                    reports: permissions.reports !== false,
                    reconciliation: permissions.reconciliation !== false,
                    auditlog: permissions.auditlog !== false,
                    incidents: permissions.incidents !== false,
                    settings: permissions.settings || false,
                    createUsers: permissions.createUsers || false,
                    editUsers: permissions.editUsers || false,
                    deleteUsers: permissions.deleteUsers || false,
                    manageRoles: permissions.manageRoles || false,
                    viewFinances: permissions.viewFinances || false,
                    exportReports: permissions.exportReports || false,
                    approveOrders: permissions.approveOrders || false,
                    resolveIncidents: permissions.resolveIncidents || false
                },
                createdAt: new Date().toISOString(),
                createdBy: this.state.currentUser?.id
            };
            roles.push(role);
            localStorage.setItem('custom_roles', JSON.stringify(roles));
            return role;
        },

        getCustomRoles() {
            const raw = localStorage.getItem('custom_roles');
            return raw ? JSON.parse(raw) : [];
        },

        updateCustomRole(roleId, updates) {
            const roles = this.getCustomRoles();
            const idx = roles.findIndex(r => r.id === roleId);
            if (idx === -1) return null;
            roles[idx] = { ...roles[idx], ...updates };
            localStorage.setItem('custom_roles', JSON.stringify(roles));
            return roles[idx];
        },

        deleteCustomRole(roleId) {
            const roles = this.getCustomRoles();
            const idx = roles.findIndex(r => r.id === roleId);
            if (idx === -1) return false;
            roles.splice(idx, 1);
            localStorage.setItem('custom_roles', JSON.stringify(roles));
            return true;
        },

        assignRoleToUser(userId, roleId) {
            const user = this.getUser(userId);
            if (!user) return false;
            user.customRole = roleId;
            this.update('users', userId, { customRole: roleId });
            return true;
        },

        hasPermission(userId, permissionKey) {
            const user = this.getUser(userId);
            if (!user) return false;
            
            // Les gestionnaires ont toutes les permissions
            if (user.role === 'gestionnaire') return true;
            
            // V�rifier les permissions personnalis�es si r��le assign�
            if (user.customRole) {
                const roles = this.getCustomRoles();
                const customRole = roles.find(r => r.id === user.customRole);
                if (customRole && customRole.permissions) {
                    return customRole.permissions[permissionKey] === true;
                }
            }
            
            return false;
        },

        getDefaultPermissionsForRole(baseRole) {
            const defaults = {
                'superviseur_vendeurs': {
                    dashboard: true,
                    stocks: true,
                    deliveries: true,
                    team: true,
                    planning: true,
                    reports: true,
                    reconciliation: false,
                    auditlog: false,
                    incidents: true,
                    settings: false,
                    createUsers: true,
                    editUsers: true,
                    deleteUsers: true,
                    manageRoles: false,
                    viewFinances: false,
                    exportReports: true,
                    approveOrders: true,
                    resolveIncidents: true
                },
                'responsable_livraison': {
                    dashboard: true,
                    stocks: false,
                    deliveries: true,
                    team: true,
                    planning: true,
                    reports: true,
                    reconciliation: false,
                    auditlog: false,
                    incidents: true,
                    settings: false,
                    createUsers: false,
                    editUsers: false,
                    deleteUsers: false,
                    manageRoles: false,
                    viewFinances: false,
                    exportReports: true,
                    approveOrders: false,
                    resolveIncidents: true
                },
                'superviseur_stocks': {
                    dashboard: true,
                    stocks: true,
                    deliveries: false,
                    team: false,
                    planning: false,
                    reports: true,
                    reconciliation: true,
                    auditlog: true,
                    incidents: false,
                    settings: false,
                    createUsers: false,
                    editUsers: false,
                    deleteUsers: false,
                    manageRoles: false,
                    viewFinances: true,
                    exportReports: true,
                    approveOrders: false,
                    resolveIncidents: false
                }
            };
            return defaults[baseRole] || {};
        },

        // Custom Reports & Export
        generateReportData(posId, dateFrom, dateTo, metrics = []) {
            const start = new Date(dateFrom);
            const end = new Date(dateTo);
            end.setHours(23, 59, 59, 999);

            const data = {
                posId,
                reportTitle: CORE.getPOS(posId)?.name || 'Rapport',
                generatedAt: new Date().toISOString(),
                period: { from: dateFrom, to: dateTo },
                metrics: {}
            };

            // Commandes
            if (metrics.includes('orders') || metrics.length === 0) {
                const orders = (CORE.db.orders || []).filter(o => {
                    const oTime = o.createdAt ? new Date(o.createdAt) : null;
                    return o.posId === posId && oTime && oTime >= start && oTime <= end;
                });
                data.metrics.orders = {
                    total: orders.length,
                    totalAmount: orders.reduce((sum, o) => sum + (o.totalAmount || 0), 0),
                    byStatus: {},
                    byVendor: {}
                };
                orders.forEach(o => {
                    data.metrics.orders.byStatus[o.status] = (data.metrics.orders.byStatus[o.status] || 0) + 1;
                    const vendor = o.vendeurId ? CORE.getUser(o.vendeurId)?.name : 'Unknown';
                    data.metrics.orders.byVendor[vendor] = (data.metrics.orders.byVendor[vendor] || 0) + 1;
                });
            }

            // Livraisons
            if (metrics.includes('deliveries') || metrics.length === 0) {
                const deliveries = (CORE.db.deliveries || []).filter(d => {
                    const dTime = d.createdAt ? new Date(d.createdAt) : null;
                    return dTime && dTime >= start && dTime <= end;
                });
                const succeeded = deliveries.filter(d => d.status === 'livree').length;
                data.metrics.deliveries = {
                    total: deliveries.length,
                    succeeded,
                    failed: deliveries.length - succeeded,
                    successRate: deliveries.length > 0 ? Math.round((succeeded / deliveries.length) * 100) : 0,
                    byStatus: {}
                };
                deliveries.forEach(d => {
                    data.metrics.deliveries.byStatus[d.status] = (data.metrics.deliveries.byStatus[d.status] || 0) + 1;
                });
            }

            // Revenus
            if (metrics.includes('revenue') || metrics.length === 0) {
                const orders = (CORE.db.orders || []).filter(o => {
                    const oTime = o.createdAt ? new Date(o.createdAt) : null;
                    return o.posId === posId && oTime && oTime >= start && oTime <= end;
                });
                const totalRevenue = orders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);
                const avgOrder = orders.length > 0 ? Math.round(totalRevenue / orders.length) : 0;
                data.metrics.revenue = {
                    total: totalRevenue,
                    average: avgOrder,
                    orders: orders.length,
                    dailyAverage: Math.round(totalRevenue / ((end - start) / (1000 * 60 * 60 * 24)))
                };
            }

            // Stocks
            if (metrics.includes('stocks') || metrics.length === 0) {
                const products = (CORE.db.products || []).filter(p => p.posId === posId);
                const lowStock = products.filter(p => {
                    const stock = p.posStocks && p.posStocks[posId] ? p.posStocks[posId].stock : (p.stock || 0);
                    const minStock = p.minStock || 0;
                    return stock <= minStock;
                });
                data.metrics.stocks = {
                    totalProducts: products.length,
                    totalUnits: products.reduce((sum, p) => {
                        const stock = p.posStocks && p.posStocks[posId] ? p.posStocks[posId].stock : (p.stock || 0);
                        return sum + stock;
                    }, 0),
                    lowStockCount: lowStock.length,
                    lowStockProducts: lowStock.map(p => ({
                        name: p.name,
                        stock: p.posStocks && p.posStocks[posId] ? p.posStocks[posId].stock : (p.stock || 0),
                        min: p.minStock || 0
                    }))
                };
            }

            // Incidents
            if (metrics.includes('incidents') || metrics.length === 0) {
                const incidents = (CORE.db.incidents || []).filter(i => {
                    const iTime = i.createdAt ? new Date(i.createdAt) : null;
                    return i.posId === posId && iTime && iTime >= start && iTime <= end;
                });
                const resolved = incidents.filter(i => i.resolved).length;
                data.metrics.incidents = {
                    total: incidents.length,
                    resolved,
                    open: incidents.length - resolved,
                    resolutionRate: incidents.length > 0 ? Math.round((resolved / incidents.length) * 100) : 0,
                    byType: {}
                };
                incidents.forEach(i => {
                    data.metrics.incidents.byType[i.type] = (data.metrics.incidents.byType[i.type] || 0) + 1;
                });
            }

            return data;
        },

        exportToCSV(data) {
            let csv = 'RAPPORT: ' + data.reportTitle + '\n';
            csv += 'G�n�r� le: ' + new Date().toLocaleString('fr-FR') + '\n';
            csv += 'P�riode: ' + data.period.from + ' �� ' + data.period.to + '\n\n';

            Object.entries(data.metrics).forEach(([key, metric]) => {
                csv += key.toUpperCase() + '\n';
                if (typeof metric === 'object') {
                    Object.entries(metric).forEach(([k, v]) => {
                        if (typeof v === 'object' && !Array.isArray(v)) {
                            csv += '  ' + k + '\n';
                            Object.entries(v).forEach(([sk, sv]) => {
                                csv += '    ' + sk + ',' + sv + '\n';
                            });
                        } else if (Array.isArray(v)) {
                            csv += '  ' + k + '\n';
                            v.forEach(item => {
                                csv += '    ' + JSON.stringify(item) + '\n';
                            });
                        } else {
                            csv += '  ' + k + ',' + v + '\n';
                        }
                    });
                }
                csv += '\n';
            });

            return csv;
        },

        exportToJSON(data) {
            return JSON.stringify(data, null, 2);
        },

        downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        },

        // Audit Trail Methods
        logAuditAction(action, details = {}) {
            const auditLog = JSON.parse(localStorage.getItem('audit_log') || '[]');
            const auditEntry = {
                id: `audit_${Date.now()}`,
                timestamp: new Date().toISOString(),
                userId: this.state.currentUser?.id || 'unknown',
                userName: this.state.currentUser?.name || 'Unknown',
                userRole: this.state.currentUser?.role || 'unknown',
                action: action,
                details: details,
                status: 'completed',
                reversible: details.reversible !== false,
                reverseFunction: details.reverseFunction || null
            };
            auditLog.push(auditEntry);
            // Keep only last 1000 entries
            if (auditLog.length > 1000) auditLog.shift();
            localStorage.setItem('audit_log', JSON.stringify(auditLog));
            return auditEntry;
        },

        getAuditLog(filters = {}) {
            const auditLog = JSON.parse(localStorage.getItem('audit_log') || '[]');
            let filtered = auditLog;

            if (filters.action) {
                filtered = filtered.filter(entry => entry.action.includes(filters.action));
            }
            if (filters.userId) {
                filtered = filtered.filter(entry => entry.userId === filters.userId);
            }
            if (filters.from && filters.to) {
                const fromTime = new Date(filters.from).getTime();
                const toTime = new Date(filters.to).getTime();
                filtered = filtered.filter(entry => {
                    const entryTime = new Date(entry.timestamp).getTime();
                    return entryTime >= fromTime && entryTime <= toTime;
                });
            }
            if (filters.reversibleOnly) {
                filtered = filtered.filter(entry => entry.reversible);
            }

            return filtered.reverse();
        },

        reverseAuditAction(auditId) {
            const auditLog = JSON.parse(localStorage.getItem('audit_log') || '[]');
            const entry = auditLog.find(e => e.id === auditId);

            if (!entry || !entry.reversible) {
                return { success: false, message: 'Cannot reverse this action' };
            }

            // Mark as reversed
            entry.status = 'reversed';
            entry.reversedAt = new Date().toISOString();
            entry.reversedBy = this.state.currentUser?.id || 'unknown';

            // Log the reversal action
            this.logAuditAction('AUDIT_REVERSE', {
                reversedAuditId: auditId,
                originalAction: entry.action,
                reversible: false
            });

            localStorage.setItem('audit_log', JSON.stringify(auditLog));
            return { success: true, message: 'Action reversed successfully' };
        },

        searchAuditLog(searchTerm) {
            const auditLog = JSON.parse(localStorage.getItem('audit_log') || '[]');
            return auditLog.filter(entry => 
                entry.action.toLowerCase().includes(searchTerm.toLowerCase()) ||
                entry.userName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                JSON.stringify(entry.details).toLowerCase().includes(searchTerm.toLowerCase())
            ).reverse();
        },

        getAuditStats() {
            const auditLog = JSON.parse(localStorage.getItem('audit_log') || '[]');
            const stats = {
                totalActions: auditLog.length,
                actionsByType: {},
                actionsByUser: {},
                actionsLast24h: 0,
                actionsLast7d: 0,
                reversedActions: 0
            };

            const now = new Date();
            const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            auditLog.forEach(entry => {
                // Count by action type
                stats.actionsByType[entry.action] = (stats.actionsByType[entry.action] || 0) + 1;
                // Count by user
                stats.actionsByUser[entry.userName] = (stats.actionsByUser[entry.userName] || 0) + 1;
                // Count recent actions
                const entryTime = new Date(entry.timestamp);
                if (entryTime >= oneDayAgo) stats.actionsLast24h++;
                if (entryTime >= sevenDaysAgo) stats.actionsLast7d++;
                // Count reversed
                if (entry.status === 'reversed') stats.reversedActions++;
            });

            return stats;
        },

        // Shift Management Methods
        getShiftsByDate(posId, date) {
            const dateStr = typeof date === 'string' ? date : date.toISOString().split('T')[0];
            return (this.db.shifts || []).filter(s => s.posId === posId && s.date === dateStr && s.status !== 'cancelled');
        },

        getActiveShifts(posId, date) {
            return this.getShiftsByDate(posId, date).filter(s => s.status === 'confirmed' || s.status === 'scheduled');
        },

        getShiftTemplate(templateId) {
            return (this.db.shiftTemplates || []).find(t => t.id === templateId);
        },

        getCapacityBySlot(posId, date) {
            const dateStr = typeof date === 'string' ? date : date.toISOString().split('T')[0];
            const templates = (this.db.shiftTemplates || []).filter(t => t.posId === posId);
            const capacity = {};

            templates.forEach(template => {
                const shiftsForSlot = (this.db.shifts || []).filter(s => 
                    s.posId === posId && 
                    s.date === dateStr && 
                    s.templateId === template.id && 
                    (s.status === 'confirmed' || s.status === 'scheduled')
                );
                capacity[template.name] = {
                    template,
                    capacity: template.capacity || 5,
                    assigned: shiftsForSlot.length,
                    available: (template.capacity || 5) - shiftsForSlot.length
                };
            });

            return capacity;
        },

        getUserTimeOff(userId, startDate = null, endDate = null) {
            let timeOff = (this.db.timeOff || []).filter(t => t.userId === userId && t.status === 'approved');
            
            if (startDate) {
                const start = new Date(startDate);
                timeOff = timeOff.filter(t => {
                    const tStart = new Date(t.startDate);
                    const tEnd = new Date(t.endDate);
                    const checkDate = new Date(startDate);
                    return checkDate >= tStart && checkDate <= tEnd;
                });
            }

            if (endDate && startDate !== endDate) {
                const end = new Date(endDate);
                timeOff = timeOff.filter(t => {
                    const tStart = new Date(t.startDate);
                    const tEnd = new Date(t.endDate);
                    const checkDate = new Date(endDate);
                    return checkDate >= tStart && checkDate <= tEnd;
                });
            }

            return timeOff;
        },

        formatPrice(amount) {
            const n = Number(amount || 0);
            return `${n.toLocaleString('fr-FR')} ${this.config.currency}`;
        },
        formatDate(date) { return new Date(date).toLocaleString('fr-FR'); },
        formatTime(date) { return new Date(date).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }); },
        formatDateForInput(date) {
            if (!date) return '';
            try {
                const d = new Date(date);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                return '';
            }
        },

        paymentMethodLabel(method) {
            const map = {
                cash: 'Cash',
                mobile: 'Mobile Money',
                card: 'Carte Bancaire',
                cod: 'Paiement �� la livraison'
            };
            if (!method) return '�� ?��';
            return map[method] || String(method);
        },

        paymentStatusLabel(status) {
            const map = {
                paid: 'Pay�',
                pending: 'En attente',
                failed: '�chou�',
                refunded: 'Rembours�'
            };
            if (!status) return '�� ?��';
            return map[status] || String(status);
        },

        // =====================
        // ROLE & PERMISSION MANAGEMENT
        // =====================
        mapPermissionToBackend(permissionId) {
            if (!permissionId) return null;
            if (permissionId.startsWith('users.')) {
                return permissionId === 'users.view' ? ['users.read'] : ['users.write'];
            }
            if (permissionId.startsWith('invitations.')) {
                return permissionId === 'invitations.view' ? ['invitations.read'] : ['invitations.write'];
            }
            if (permissionId.startsWith('settings.')) {
                return permissionId === 'settings.view' ? ['settings.read'] : ['settings.write'];
            }
            if (permissionId.startsWith('tenant.')) {
                return permissionId === 'tenant.read' ? ['tenant.read'] : ['tenant.write'];
            }
            if (permissionId.startsWith('stock.') || permissionId.startsWith('products.') || permissionId.startsWith('orders.') || permissionId.startsWith('finance.') || permissionId.startsWith('deliveries.') || permissionId.startsWith('clients.') || permissionId.startsWith('reports.')) {
                if (permissionId.endsWith('.view')) {
                    return [permissionId, permissionId.replace('.view', '.read')];
                }
                if (permissionId.endsWith('.create') || permissionId.endsWith('.edit') || permissionId.endsWith('.delete')) {
                    return [permissionId, permissionId.replace(/\.(create|edit|delete)$/, '.write')];
                }
                return [permissionId];
            }
            if (permissionId === 'managePos') {
                return ['settings.write'];
            }
            return null;
        },

        hasPermission(userIdOrPermission, permissionId) {
            const hasTwoArgs = typeof permissionId === 'string';
            const perm = hasTwoArgs ? permissionId : userIdOrPermission;
            const userId = hasTwoArgs ? userIdOrPermission : (this.state.currentUser?.id || null);
            const user = (userId ? this.getUser(userId) : null) || this.state.currentUser;
            if (!user) return false;

            // Backend permissions (si disponibles) priment
            if (Array.isArray(user.permissions) && user.permissions.length > 0) {
                const backendPerms = this.mapPermissionToBackend(perm);
                if (backendPerms && backendPerms.length > 0) {
                    return backendPerms.some(p => user.permissions.includes(p));
                }
            }

            // PDG a toutes les permissions (mode local)
            if (user.role === 'pdg') return true;

            // Trouver le r��le de l'utilisateur (mode local)
            const role = this.db.roles?.find(r => r.id === user.role);
            if (!role) return false;

            // V�rifier si la permission est dans le r��le
            return role.permissions?.includes(perm) || role.permissions?.includes('all');
        },

        getViewPermission(view) {
            const map = {
                inventory: 'stock.view',
                stocks: 'stock.view',
                mainStock: 'stock.view',
                'main-stock': 'stock.view',
                stock: 'stock.view',
                products: 'products.view',
                orders: 'orders.view',
                'orders-global': 'orders.view',
                deliveries: 'deliveries.view',
                delivery: 'deliveries.view',
                livraisons: 'deliveries.view',
                deliverymen: 'deliveries.view',
                historique: 'deliveries.view',
                finance: 'finance.view',
                wallet: 'finance.view',
                commissions: 'finance.view',
                reports: 'reports.view',
                auditlog: 'reports.view',
                reconciliation: 'reports.view',
                incidents: 'reports.view',
                planning: 'reports.view',
                analytics: 'reports.view',
                commandes: 'orders.view',
                clients: 'clients.view',
                livreurs: 'deliveries.view',
                reservations: 'orders.view',
                routage: 'deliveries.view',
                assignation: 'deliveries.assign',
                rapports: 'reports.view',
                toolbox: 'settings.view',
                team: 'users.view',
                users: 'users.view',
                settings: 'settings.view',
            };
            return map[view] || null;
        },

        canAccessView(view) {
            if (view === 'pos') {
                const role = this.state.currentUser?.role;
                if (['pdg', 'manager', 'gestionnaire', 'vendeur'].includes(role)) return true;
            }
            const perm = this.getViewPermission(view);
            if (!perm) return true;
            return this.hasPermission(perm);
        },

        hasPermissionByRole(roleId, permissionId) {
            const role = this.db.roles?.find(r => r.id === roleId);
            if (!role) return false;
            return role.permissions?.includes(permissionId) || role.permissions?.includes('all');
        },

        // Modifier les permissions d'un r��le
        updateRolePermissions(roleId, permissions) {
            const role = this.db.roles?.find(r => r.id === roleId);
            if (!role || !role.isCustom && roleId !== 'manager') return false; // Seul manager est modifiable parmi les r��les par d�faut

            const oldPermissions = [...role.permissions];
            role.permissions = permissions;
            
            this.logAudit('update', 'role', roleId, role.name, 
                { permissionsAdded: permissions.filter(p => !oldPermissions.includes(p)), permissionsRemoved: oldPermissions.filter(p => !permissions.includes(p)) },
                { permissions: oldPermissions },
                { permissions: permissions }
            );

            this.save();
            return true;
        },

        // Cr�er un r��le personnalis�
        createCustomRole(name, description, permissions, color = 'slate', icon = 'shield') {
            const id = 'role_' + Date.now();
            const customRole = {
                id,
                name,
                description,
                color,
                icon,
                permissions,
                isCustom: true,
                createdAt: new Date().toISOString(),
                createdBy: this.state.currentUser?.id
            };

            this.db.roles.push(customRole);
            
            this.logAudit('create', 'role', id, name, 
                { description, color, icon, permissions },
                null,
                customRole
            );

            this.save();
            return customRole;
        },

        // Supprimer un r��le personnalis�
        deleteCustomRole(roleId) {
            const role = this.db.roles?.find(r => r.id === roleId);
            if (!role || !role.isCustom) return false;

            const usersWithRole = this.db.users?.filter(u => u.role === roleId).length || 0;
            if (usersWithRole > 0) {
                UI.toast(`Impossible de supprimer: ${usersWithRole} utilisateur(s) ont ce r��le`, 'error');
                return false;
            }

            this.db.roles = this.db.roles.filter(r => r.id !== roleId);
            
            this.logAudit('delete', 'role', roleId, role.name, 
                { description: 'R��le personnalis� supprim�' },
                role,
                null
            );

            this.save();
            return true;
        },

        // Obtenir les r��les disponibles pour l'utilisateur
        getAvailableRoles() {
            return this.db.roles || [];
        },

        // NOTIFICATION & ALERTS SYSTEM
        createNotification(type, title, message, severity = 'medium', relatedTo = null, relatedId = null) {
            const notification = {
                id: Date.now(),
                type, // 'stock_low', 'order_rejected', 'incident_open', 'info'
                title,
                message,
                severity, // 'low', 'medium', 'high', 'critical'
                relatedTo, // 'product', 'order', 'delivery', null
                relatedId, // ID du produit/commande/livraison
                read: false,
                createdAt: new Date().toISOString(),
                readAt: null
            };
            this.db.notifications.push(notification);
            this.save();
            return notification;
        },

        dismissNotification(notificationId) {
            const notif = this.db.notifications?.find(n => n.id === notificationId);
            if (notif) {
                notif.read = true;
                notif.readAt = new Date().toISOString();
                this.save();
            }
        },

        getUnreadNotificationCount() {
            return (this.db.notifications || []).filter(n => !n.read).length;
        },

        getNotificationsByType(type) {
            return (this.db.notifications || []).filter(n => n.type === type);
        },

        checkStockLevels() {
            const threshold = this.db.alertThresholds?.find(t => t.id === 'stock_low');
            const criticalThreshold = this.db.alertThresholds?.find(t => t.id === 'stock_critical');
            
            if (!threshold?.enabled && !criticalThreshold?.enabled) return;

            (this.db.products || []).forEach(product => {
                const stockQty = product.quantity || 0;
                const criticalVal = criticalThreshold?.threshold || 5;
                const lowVal = threshold?.threshold || 10;

                // Check if already notified for this product today
                const today = new Date().toDateString();
                const alreadyNotified = this.db.notifications?.some(n => 
                    n.type === 'stock_critical' && n.relatedId === product.id && 
                    new Date(n.createdAt).toDateString() === today
                );

                if (criticalThreshold?.enabled && stockQty <= criticalVal && !alreadyNotified) {
                    this.createNotification(
                        'stock_critical',
                        `��š ��� � � Stock Critique: ${product.name}`,
                        `Le stock du produit "${product.name}" est critique (${stockQty} unit�s)`,
                        'critical',
                        'product',
                        product.id
                    );
                } else if (threshold?.enabled && stockQty <= lowVal && !alreadyNotified) {
                    this.createNotification(
                        'stock_low',
                        `��Ÿ? � Stock Faible: ${product.name}`,
                        `Le stock du produit "${product.name}" est faible (${stockQty} unit�s)`,
                        'high',
                        'product',
                        product.id
                    );
                }
            });
        },

        updateAlertThreshold(thresholdId, newValue) {
            const threshold = this.db.alertThresholds?.find(t => t.id === thresholdId);
            if (threshold) {
                threshold.threshold = newValue;
                this.save();
                return true;
            }
            return false;
        },

        toggleAlertThreshold(thresholdId, enabled) {
            const threshold = this.db.alertThresholds?.find(t => t.id === thresholdId);
            if (threshold) {
                threshold.enabled = enabled;
                this.save();
                return true;
            }
            return false;
        },

        getAlertThresholds() {
            return this.db.alertThresholds || [];
        },

        getNotificationHistory(limit = 100) {
            return (this.db.notifications || []).sort((a, b) => 
                new Date(b.createdAt) - new Date(a.createdAt)
            ).slice(0, limit);
        },

        clearOldNotifications(daysOld = 30) {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysOld);
            const before = this.db.notifications.length;
            this.db.notifications = this.db.notifications.filter(n => 
                new Date(n.createdAt) > cutoffDate
            );
            if (this.db.notifications.length < before) {
                this.save();
            }
        },

        // FINANCIAL MANAGEMENT SYSTEM
        createBudget(name, category, amount, startDate, endDate, notes = '') {
            const budget = {
                id: Date.now(),
                name,
                category, // 'salaires', 'operationnel', 'marketing', 'logistics', 'maintenance', 'other'
                amount,
                startDate,
                endDate,
                spent: 0,
                notes,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            this.db.budgets.push(budget);
            this.save();
            return budget;
        },

        updateBudgetSpent(budgetId, spentAmount) {
            const budget = this.db.budgets?.find(b => b.id === budgetId);
            if (budget) {
                budget.spent = spentAmount;
                budget.updatedAt = new Date().toISOString();
                this.save();
                return budget;
            }
            return null;
        },

        getBudgets(category = null, dateRange = null) {
            let budgets = this.db.budgets || [];
            if (category) {
                budgets = budgets.filter(b => b.category === category);
            }
            if (dateRange) {
                budgets = budgets.filter(b => {
                    const start = new Date(b.startDate);
                    const end = new Date(b.endDate);
                    return start >= dateRange.start && end <= dateRange.end;
                });
            }
            return budgets;
        },

        calculateFinancialMetrics(dateFrom, dateTo) {
            const orders = (this.db.orders || []).filter(o => {
                const orderDate = new Date(o.createdAt);
                return orderDate >= new Date(dateFrom) && orderDate <= new Date(dateTo);
            });

            const transactions = (this.db.transactions || []).filter(t => {
                const txDate = new Date(t.date);
                return txDate >= new Date(dateFrom) && txDate <= new Date(dateTo);
            });

            const expenses = (this.db.expenses || []).filter(e => {
                const expDate = new Date(e.date);
                return expDate >= new Date(dateFrom) && expDate <= new Date(dateTo);
            });

            // Calculate revenues
            const totalRevenue = orders.reduce((sum, o) => sum + (o.total || 0), 0);
            
            // Calculate costs
            const productCosts = orders.reduce((sum, o) => {
                return sum + (o.items || []).reduce((itemSum, item) => {
                    const product = this.getProduct(item.productId);
                    return itemSum + ((product?.costPrice || 0) * (item.qty || 0));
                }, 0);
            }, 0);

            const deliveryCosts = (this.db.deliveries || [])
                .filter(d => {
                    const dDate = new Date(d.createdAt);
                    return dDate >= new Date(dateFrom) && dDate <= new Date(dateTo);
                })
                .reduce((sum, d) => sum + (d.costPrice || 0), 0);

            const operatingExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
            
            const totalCosts = productCosts + deliveryCosts + operatingExpenses;
            const grossProfit = totalRevenue - productCosts;
            const netProfit = totalRevenue - totalCosts;
            const profitMargin = totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(2) : 0;
            const roi = totalCosts > 0 ? ((netProfit / totalCosts) * 100).toFixed(2) : 0;

            return {
                date: new Date().toISOString(),
                totalRevenue: parseFloat(totalRevenue.toFixed(2)),
                totalCosts: parseFloat(totalCosts.toFixed(2)),
                productCosts: parseFloat(productCosts.toFixed(2)),
                deliveryCosts: parseFloat(deliveryCosts.toFixed(2)),
                operatingExpenses: parseFloat(operatingExpenses.toFixed(2)),
                grossProfit: parseFloat(grossProfit.toFixed(2)),
                netProfit: parseFloat(netProfit.toFixed(2)),
                profitMargin: parseFloat(profitMargin),
                roi: parseFloat(roi),
                ordersCount: orders.length,
                deliveriesCount: (this.db.deliveries || []).filter(d => {
                    const dDate = new Date(d.createdAt);
                    return dDate >= new Date(dateFrom) && dDate <= new Date(dateTo);
                }).length
            };
        },

        getBudgetStatus(budgetId) {
            const budget = this.db.budgets?.find(b => b.id === budgetId);
            if (!budget) return null;

            const remaining = budget.amount - budget.spent;
            const percentageUsed = (budget.spent / budget.amount * 100).toFixed(2);
            const status = budget.spent > budget.amount ? 'over' : (percentageUsed > 80 ? 'warning' : 'ok');

            return {
                budget,
                spent: budget.spent,
                remaining: Math.max(0, remaining),
                percentageUsed: parseFloat(percentageUsed),
                status // 'ok', 'warning', 'over'
            };
        },

        getBudgetComparison(month = null) {
            const budgets = this.db.budgets || [];
            const now = new Date();
            const targetMonth = month || new Date(now.getFullYear(), now.getMonth(), 1);

            const activeBudgets = budgets.filter(b => {
                const start = new Date(b.startDate);
                const end = new Date(b.endDate);
                return start <= targetMonth && end >= targetMonth;
            });

            const totalBudgeted = activeBudgets.reduce((sum, b) => sum + b.amount, 0);
            const totalSpent = activeBudgets.reduce((sum, b) => sum + b.spent, 0);
            const totalRemaining = totalBudgeted - totalSpent;
            const overallPercentage = totalBudgeted > 0 ? ((totalSpent / totalBudgeted) * 100).toFixed(2) : 0;

            return {
                period: targetMonth.toISOString().split('T')[0],
                totalBudgeted: parseFloat(totalBudgeted.toFixed(2)),
                totalSpent: parseFloat(totalSpent.toFixed(2)),
                totalRemaining: Math.max(0, parseFloat(totalRemaining.toFixed(2))),
                overallPercentage: parseFloat(overallPercentage),
                budgets: activeBudgets.map(b => this.getBudgetStatus(b.id))
            };
        },

        setFinancialTarget(targetId, value) {
            const target = this.db.financialTargets?.find(t => t.id === targetId);
            if (target) {
                if (target.percentage) {
                    target.percentage = value;
                } else {
                    target.amount = value;
                }
                this.save();
                return target;
            }
            return null;
        },

        getFinancialHealth() {
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            const metrics = this.calculateFinancialMetrics(lastMonth.toISOString(), today.toISOString());
            const budgetComparison = this.getBudgetComparison();

            const healthScore = this.calculateHealthScore(metrics, budgetComparison);

            return {
                metrics,
                budgetComparison,
                healthScore, // 0-100
                status: healthScore >= 80 ? 'excellent' : (healthScore >= 60 ? 'bon' : (healthScore >= 40 ? 'moyen' : 'faible'))
            };
        },

        calculateHealthScore(metrics, budgetComparison) {
            let score = 100;

            // Profit margin impact
            const marginScore = Math.min(metrics.profitMargin, 100);
            score = score * (marginScore / 100);

            // Budget adherence impact
            if (budgetComparison.overallPercentage > 90) {
                score -= 10;
            } else if (budgetComparison.overallPercentage > 100) {
                score -= 30;
            }

            // Revenue vs cost ratio
            if (metrics.totalCosts > metrics.totalRevenue * 0.7) {
                score -= 15;
            }

            // Ensure score is between 0 and 100
            return Math.max(0, Math.min(100, score.toFixed(2)));
        },

        // SYSTEM MANAGEMENT
        createBackup(notes = '') {
            const backup = {
                id: Date.now(),
                name: `Backup-${new Date().toISOString().split('T')[0]}-${Math.random().toString(36).substr(2, 9)}`,
                date: new Date().toISOString(),
                size: this.getStorageSize(),
                status: 'success',
                notes,
                data: {
                    users: [...this.db.users],
                    orders: [...(this.db.orders || [])],
                    deliveries: [...(this.db.deliveries || [])],
                    products: [...(this.db.products || [])],
                    transactions: [...(this.db.transactions || [])],
                    expenses: [...(this.db.expenses || [])],
                    budgets: [...(this.db.budgets || [])]
                }
            };
            
            this.db.backups.push(backup);
            this.logSystemEvent('backup_created', `Sauvegarde cr��e: ${backup.name}`, 'info');
            this.save();
            return backup;
        },

        restoreBackup(backupId) {
            const backup = this.db.backups?.find(b => b.id === backupId);
            if (!backup) return { success: false, message: 'Sauvegarde non trouv�e' };

            try {
                // Restore data
                if (backup.data.users) this.db.users = [...backup.data.users];
                if (backup.data.orders) this.db.orders = [...backup.data.orders];
                if (backup.data.deliveries) this.db.deliveries = [...backup.data.deliveries];
                if (backup.data.products) this.db.products = [...backup.data.products];
                if (backup.data.transactions) this.db.transactions = [...backup.data.transactions];
                if (backup.data.expenses) this.db.expenses = [...backup.data.expenses];
                if (backup.data.budgets) this.db.budgets = [...backup.data.budgets];

                this.save();
                this.logSystemEvent('backup_restored', `Sauvegarde restaur�e: ${backup.name}`, 'warning');
                return { success: true, message: 'Sauvegarde restaur�e avec succ��s' };
            } catch (e) {
                this.logSystemEvent('backup_restore_failed', `Erreur lors de la restauration: ${e.message}`, 'error');
                return { success: false, message: 'Erreur lors de la restauration' };
            }
        },

        deleteBackup(backupId) {
            const before = (this.db.backups || []).length;
            this.db.backups = (this.db.backups || []).filter(b => b.id !== backupId);
            if (this.db.backups.length < before) {
                this.logSystemEvent('backup_deleted', `Sauvegarde supprim�e: ${backupId}`, 'info');
                this.save();
                return true;
            }
            return false;
        },

        getBackups() {
            return (this.db.backups || []).sort((a, b) => new Date(b.date) - new Date(a.date));
        },

        logSystemEvent(level, message, type = 'info') {
            const event = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                level: type, // 'info', 'warning', 'error', 'critical'
                module: 'SYSTEM',
                message,
                userId: this.state.currentUser?.id,
                ipAddress: 'local'
            };
            
            if (!this.db.systemLogs) this.db.systemLogs = [];
            this.db.systemLogs.push(event);
            
            // Keep only last 1000 logs
            if (this.db.systemLogs.length > 1000) {
                this.db.systemLogs = this.db.systemLogs.slice(-1000);
            }
            
            this.save();
            return event;
        },

        getSystemLogs(limit = 100, level = null) {
            let logs = (this.db.systemLogs || []).sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            ).slice(0, limit);

            if (level) {
                logs = logs.filter(l => l.level === level);
            }

            return logs;
        },

        clearOldLogs(daysOld = 90) {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysOld);
            const before = this.db.systemLogs.length;
            this.db.systemLogs = (this.db.systemLogs || []).filter(l => 
                new Date(l.timestamp) > cutoffDate
            );
            if (this.db.systemLogs.length < before) {
                this.save();
            }
        },

        updateSystemConfig(key, value) {
            if (this.db.systemConfig[key] !== undefined) {
                this.db.systemConfig[key] = value;
                this.logSystemEvent('config_updated', `Configuration mise �� jour: ${key} = ${value}`, 'info');
                this.save();
                return true;
            }
            return false;
        },

        getSystemConfig() {
            return this.db.systemConfig;
        },

        getDiagnostics() {
            const diagnostics = {
                ...this.db.diagnostics,
                lastCheck: new Date().toISOString(),
                databaseSize: this.getStorageSize(),
                activeUsers: (this.db.users || []).filter(u => u.active).length,
                totalUsers: (this.db.users || []).length,
                totalOrders: (this.db.orders || []).length,
                totalDeliveries: (this.db.deliveries || []).length,
                totalProducts: (this.db.products || []).length,
                backupsCount: (this.db.backups || []).length,
                logsCount: (this.db.systemLogs || []).length,
                auditLogsCount: (this.db.auditLogs || []).length
            };

            this.db.diagnostics = diagnostics;
            this.save();
            return diagnostics;
        },

        getStorageSize() {
            const dataStr = JSON.stringify(this.db);
            const bytes = new Blob([dataStr]).size;
            return (bytes / 1024 / 1024).toFixed(2); // MB
        },

        cleanupSystem() {
            const config = this.db.systemConfig;
            
            // Clear old logs
            this.clearOldLogs(config.logRetention);
            
            // Clear old notifications
            CORE.clearOldNotifications(30);
            
            // Clear old audit logs
            const auditCutoff = new Date();
            auditCutoff.setDate(auditCutoff.getDate() - 90);
            this.db.auditLogs = (this.db.auditLogs || []).filter(log => 
                new Date(log.timestamp) > auditCutoff
            );

            // Delete old backups beyond retention
            this.db.backups = (this.db.backups || []).filter(b => {
                const backupDate = new Date(b.date);
                const now = new Date();
                const days = (now - backupDate) / (1000 * 60 * 60 * 24);
                return days <= config.backupRetention;
            });

            this.logSystemEvent('cleanup_executed', 'Nettoyage syst��me ex�cut�', 'info');
            this.save();
            return true;
        },

        exportSystemData() {
            const data = {
                exportDate: new Date().toISOString(),
                systemConfig: this.db.systemConfig,
                statistics: this.getDiagnostics(),
                dataExport: {
                    users: this.db.users.length,
                    orders: (this.db.orders || []).length,
                    deliveries: (this.db.deliveries || []).length,
                    products: (this.db.products || []).length,
                    transactions: (this.db.transactions || []).length
                }
            };
            return data;
        },

        // USER SUSPENSION MANAGEMENT
        suspendUser(userId, reason, durationDays = 7) {
            const user = this.getUser(userId);
            if (!user) return { success: false, message: 'Utilisateur non trouv�' };

            const currentUser = this.state.currentUser;
            const suspension = {
                id: Date.now(),
                userId,
                userName: user.name,
                suspendedBy: currentUser?.id,
                suspendedByName: currentUser?.name,
                reason,
                suspendedAt: new Date().toISOString(),
                resumedAt: null,
                duration: durationDays,
                expectedResumeDate: new Date(Date.now() + durationDays * 24 * 60 * 60 * 1000).toISOString(),
                status: 'active'
            };

            user.suspended = true;
            user.suspensionId = suspension.id;
            user.suspendedAt = suspension.suspendedAt;
            user.suspensionReason = reason;

            this.db.userSuspensions.push(suspension);
            
            // Add to history
            this.suspensionHistoryEntry('suspended', suspension, { action: 'Utilisateur suspendu', reason });

            this.logAudit('suspend', 'user', userId, user.name, 
                { reason, duration: durationDays },
                { suspended: false },
                { suspended: true }
            );

            this.save();
            this.logSystemEvent('user_suspended', `Utilisateur ${user.name} suspendu pour: ${reason}`, 'warning');
            
            return { success: true, message: `${user.name} suspendu avec succ��s`, suspension };
        },

        resumeUser(userId) {
            const user = this.getUser(userId);
            if (!user) return { success: false, message: 'Utilisateur non trouv�' };

            if (!user.suspended) return { success: false, message: 'Utilisateur non suspendu' };

            const suspension = this.db.userSuspensions?.find(s => s.id === user.suspensionId);
            
            user.suspended = false;
            user.suspensionId = null;
            user.suspendedAt = null;
            user.suspensionReason = null;

            if (suspension) {
                suspension.status = 'resolved';
                suspension.resumedAt = new Date().toISOString();
            }

            // Add to history
            this.suspensionHistoryEntry('resumed', suspension, { action: 'Utilisateur r�activ�' });

            this.logAudit('resume', 'user', userId, user.name, 
                { resumeReason: 'Suspension lev�e' },
                { suspended: true },
                { suspended: false }
            );

            this.save();
            this.logSystemEvent('user_resumed', `Utilisateur ${user.name} r�activ�`, 'info');
            
            return { success: true, message: `${user.name} r�activ� avec succ��s` };
        },

        suspensionHistoryEntry(action, suspension, details) {
            const entry = {
                id: Date.now(),
                userId: suspension?.userId,
                suspension,
                action, // 'suspended' or 'resumed'
                timestamp: new Date().toISOString(),
                details,
                performedBy: this.state.currentUser?.id,
                performedByName: this.state.currentUser?.name
            };

            if (!this.db.suspensionHistory) this.db.suspensionHistory = [];
            this.db.suspensionHistory.push(entry);
        },

        getUserSuspensions(userId = null) {
            let suspensions = this.db.userSuspensions || [];
            if (userId) {
                suspensions = suspensions.filter(s => s.userId === userId);
            }
            return suspensions.sort((a, b) => new Date(b.suspendedAt) - new Date(a.suspendedAt));
        },

        getSuspensionHistory(userId = null, limit = 100) {
            let history = (this.db.suspensionHistory || []).sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );

            if (userId) {
                history = history.filter(h => h.userId === userId);
            }

            return history.slice(0, limit);
        },

        getActiveSuspensions() {
            return (this.db.userSuspensions || []).filter(s => s.status === 'active');
        },

        getSuspendedUsers() {
            return this.db.users.filter(u => u.suspended);
        },

        isSuspended(userId) {
            const user = this.getUser(userId);
            return user ? user.suspended : false;
        },

        // ========== IMPORT/EXPORT & SYNC ==========
        parseCSVData(csvContent) {
            const lines = csvContent.trim().split('\n');
            if (lines.length < 2) return { headers: [], data: [] };
            
            const headers = lines[0].split(',').map(h => h.trim());
            const data = lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim());
                const row = {};
                headers.forEach((header, idx) => {
                    row[header] = values[idx] || '';
                });
                return row;
            });
            
            return { headers, data };
        },

        importUsersFromCSV(csvContent, dryRun = false) {
            const currentUser = this.state.currentUser;
            if (!currentUser || currentUser.role !== 'pdg') {
                return { success: false, message: 'Permission denied' };
            }

            const { headers, data } = this.parseCSVData(csvContent);
            const requiredFields = ['name', 'username', 'email', 'password', 'role'];
            const missingFields = requiredFields.filter(f => !headers.includes(f));
            
            if (missingFields.length > 0) {
                return { success: false, message: `Champs manquants: ${missingFields.join(', ')}` };
            }

            let successCount = 0;
            let errorCount = 0;
            const errors = [];

            data.forEach((row, idx) => {
                try {
                    // Validation
                    if (!row.name || !row.username || !row.email || !row.password) {
                        errorCount++;
                        errors.push(`Ligne ${idx + 2}: Champs obligatoires manquants`);
                        return;
                    }

                    // V�rifier l'unicit�
                    if (this.db.users.find(u => u.username === row.username)) {
                        errorCount++;
                        errors.push(`Ligne ${idx + 2}: Utilisateur ${row.username} existe d�j��`);
                        return;
                    }

                    if (!dryRun) {
                        const newUser = {
                            id: Date.now() + Math.random(),
                            name: row.name,
                            username: row.username,
                            email: row.email,
                            password: row.password,
                            role: row.role || 'vendeur',
                            deliveryCenter: row.deliveryCenter || '',
                            active: row.active === 'true' ? true : true,
                            suspended: false,
                            createdAt: new Date().toISOString(),
                            importedFrom: 'csv'
                        };
                        
                        this.db.users.push(newUser);
                        successCount++;
                    } else {
                        successCount++;
                    }
                } catch (e) {
                    errorCount++;
                    errors.push(`Ligne ${idx + 2}: ${e.message}`);
                }
            });

            if (!dryRun) {
                this.save();
                this.logAudit('import', 'users', 'bulk', 'Import en masse', {
                    source: 'csv',
                    rowsProcessed: data.length,
                    successCount,
                    errorCount
                });
            }

            const importRecord = {
                id: Date.now(),
                type: 'import',
                entity: 'users',
                timestamp: new Date().toISOString(),
                performedBy: currentUser.id,
                performedByName: currentUser.name,
                rowsProcessed: data.length,
                fileName: 'import_users.csv',
                status: errorCount === 0 ? 'success' : 'partial',
                details: { successCount, errorCount, errors: errors.slice(0, 10) }
            };

            this.db.importExportHistory.push(importRecord);
            this.save();

            return {
                success: errorCount === 0,
                message: `Import�: ${successCount} r�ussi(s), ${errorCount} erreur(s)`,
                successCount,
                errorCount,
                errors: errors.slice(0, 10)
            };
        },

        exportUsersToCSV() {
            const headers = ['ID', 'Nom', 'Identifiant', 'Email', 'R��le', 'Centre', 'Actif', 'Suspendu', 'Date Cr�ation'];
            const rows = this.db.users.map(user => [
                user.id,
                user.name,
                user.username,
                user.email || '',
                user.role,
                user.deliveryCenter || '',
                user.active ? 'Oui' : 'Non',
                user.suspended ? 'Oui' : 'Non',
                new Date(user.createdAt).toLocaleDateString('fr-FR')
            ]);

            let csv = headers.join(',') + '\n';
            csv += rows.map(row => row.map(cell => '"' + cell + '"').join(',')).join('\n');

            const currentUser = this.state.currentUser;
            const exportRecord = {
                id: Date.now(),
                type: 'export',
                entity: 'users',
                timestamp: new Date().toISOString(),
                performedBy: currentUser.id,
                performedByName: currentUser.name,
                rowsProcessed: this.db.users.length,
                fileName: `users_${new Date().getTime()}.csv`,
                status: 'success',
                details: { totalRows: this.db.users.length }
            };

            this.db.importExportHistory.push(exportRecord);
            this.save();

            return csv;
        },

        exportOrdersToCSV() {
            const headers = ['ID', 'Num�ro', 'Client', 'Montant', 'Statut', 'Date', 'Vendeur'];
            const rows = (this.db.orders || []).map(order => [
                order.id,
                order.orderNumber || '',
                order.client || '',
                order.totalAmount || '0',
                order.status || 'pending',
                new Date(order.createdAt).toLocaleDateString('fr-FR'),
                order.vendorName || ''
            ]);

            let csv = headers.join(',') + '\n';
            csv += rows.map(row => row.map(cell => '"' + cell + '"').join(',')).join('\n');

            const currentUser = this.state.currentUser;
            const exportRecord = {
                id: Date.now(),
                type: 'export',
                entity: 'orders',
                timestamp: new Date().toISOString(),
                performedBy: currentUser.id,
                performedByName: currentUser.name,
                rowsProcessed: rows.length,
                fileName: `orders_${new Date().getTime()}.csv`,
                status: 'success',
                details: { totalRows: rows.length }
            };

            this.db.importExportHistory.push(exportRecord);
            this.save();

            return csv;
        },

        exportAuditToCSV() {
            const headers = ['Heure', 'Utilisateur', 'R��le', 'Action', 'Entit�', 'Statut', 'D�tails'];
            const rows = (this.db.auditTrail || []).map(entry => [
                new Date(entry.timestamp).toLocaleDateString('fr-FR'),
                entry.userName || '',
                entry.userRole || '',
                entry.action || '',
                entry.entity || '',
                entry.status || 'success',
                JSON.stringify(entry.details || {}).slice(0, 50)
            ]);

            let csv = headers.join(',') + '\n';
            csv += rows.map(row => row.map(cell => '"' + cell + '"').join(',')).join('\n');

            const currentUser = this.state.currentUser;
            const exportRecord = {
                id: Date.now(),
                type: 'export',
                entity: 'audit',
                timestamp: new Date().toISOString(),
                performedBy: currentUser.id,
                performedByName: currentUser.name,
                rowsProcessed: rows.length,
                fileName: `audit_${new Date().getTime()}.csv`,
                status: 'success',
                details: { totalRows: rows.length }
            };

            this.db.importExportHistory.push(exportRecord);
            this.save();

            return csv;
        },

        exportDataAsJSON(entity = 'all') {
            const currentUser = this.state.currentUser;
            let dataToExport = {};

            if (entity === 'all' || entity === 'users') dataToExport.users = this.db.users;
            if (entity === 'all' || entity === 'orders') dataToExport.orders = this.db.orders || [];
            if (entity === 'all' || entity === 'audit') dataToExport.auditTrail = this.db.auditTrail || [];
            if (entity === 'all' || entity === 'products') dataToExport.products = this.db.products || [];

            const json = JSON.stringify(dataToExport, null, 2);

            const exportRecord = {
                id: Date.now(),
                type: 'export',
                entity: entity === 'all' ? 'complete_backup' : entity,
                timestamp: new Date().toISOString(),
                performedBy: currentUser.id,
                performedByName: currentUser.name,
                rowsProcessed: Object.values(dataToExport).flat().length,
                fileName: `export_${entity}_${new Date().getTime()}.json`,
                status: 'success',
                details: { entities: Object.keys(dataToExport) }
            };

            this.db.importExportHistory.push(exportRecord);
            this.save();

            return json;
        },

        exportSaasMigrationData() {
            const companyName = this.getCompanyName();
            const users = (this.db.users || []).map(u => ({
                id: u.id,
                role: u.role,
                name: u.name,
                username: u.username,
                phone: u.phone,
                email: u.email,
                active: u.active !== false,
                passwordHash: u.passwordHash || ''
            }));

            const cities = (this.db.cities || []).map(c => ({
                id: c.id,
                name: c.name,
                country: c.country
            }));

            const pointsOfSale = (this.db.pointsOfSale || []).map(p => ({
                id: p.id,
                name: p.name,
                cityId: p.cityId
            }));

            const categories = (this.db.categories || []).map(c => ({
                id: c.id,
                name: c.name
            }));

            const products = (this.db.products || []).map(p => ({
                id: p.id,
                name: p.name,
                categoryId: p.categoryId || p.category,
                sku: p.sku,
                price: p.price || 0,
                active: p.active !== false,
                posStocks: p.posStocks || p.posStock || {}
            }));

            const clients = (this.db.clients || []).map(c => ({
                id: c.id,
                name: c.name,
                phone: c.phone,
                email: c.email,
                address: c.address
            }));

            const orders = (this.db.orders || []).map(o => ({
                id: o.id,
                posId: o.posId,
                clientId: o.clientId,
                sellerId: o.sellerId,
                status: o.status,
                total: o.total || 0,
                createdAt: o.createdAt || o.date || o.timestamp,
                items: o.items || o.cart || []
            }));

            const deliveries = (this.db.deliveries || []).map(d => ({
                id: d.id,
                orderId: d.orderId,
                delivererId: d.delivererId,
                status: d.status,
                eta: d.eta || d.expectedAt
            }));

            const financialTransactions = (this.db.financialTransactions || this.db.transactions || []).map(t => ({
                id: t.id,
                posId: t.posId,
                type: t.type,
                amount: t.amount || 0,
                note: t.note,
                createdAt: t.createdAt || t.timestamp
            }));

            const auditLogs = (this.db.auditTrail || this.db.auditLogs || []).map(a => ({
                id: a.id,
                userId: a.userId,
                action: a.action,
                payload: a.details || a.payload || {},
                createdAt: a.timestamp || a.createdAt
            }));

            const settings = [];
            if (this.config?.currency) settings.push({ key: 'currency', value: this.config.currency });
            if (this.config?.language) settings.push({ key: 'language', value: this.config.language });
            if (this.db?.systemConfig) settings.push({ key: 'systemConfig', value: this.db.systemConfig });

            return JSON.stringify({
                companyName,
                users,
                cities,
                pointsOfSale,
                categories,
                products,
                clients,
                orders,
                deliveries,
                financialTransactions,
                auditLogs,
                settings
            }, null, 2);
        },

        getImportExportHistory(limit = 50) {
            return (this.db.importExportHistory || [])
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, limit);
        },

        syncWithExternalSystem(configId) {
            const config = this.db.externalSyncConfigs?.find(c => c.id === configId);
            if (!config || config.status !== 'active') return { success: false, message: 'Config inactive' };

            const currentUser = this.state.currentUser;
            const timestamp = new Date().toISOString();

            try {
                // Simulation d'une synchronisation
                const syncData = {
                    timestamp,
                    users: this.db.users.length,
                    orders: (this.db.orders || []).length,
                    syncId: Date.now()
                };

                config.lastSync = timestamp;
                this.save();

                this.logAudit('sync', 'external_system', config.id, config.name, {
                    syncData,
                    status: 'success'
                });

                return {
                    success: true,
                    message: 'Synchronisation r�ussie',
                    syncData
                };
            } catch (e) {
                this.logAudit('sync', 'external_system', config.id, config.name, {
                    error: e.message,
                    status: 'failed'
                });

                return {
                    success: false,
                    message: `Erreur: ${e.message}`
                };
            }
        },

        addExternalSyncConfig(name, type, url, frequency = 'daily', method = 'POST') {
            const config = {
                id: Date.now(),
                name,
                type, // 'api', 'webhook', 'polling'
                url,
                method,
                frequency, // 'hourly', 'daily', 'weekly'
                lastSync: null,
                status: 'active',
                credentials: {},
                createdAt: new Date().toISOString()
            };

            this.db.externalSyncConfigs.push(config);
            this.save();

            this.logAudit('create', 'external_sync_config', config.id, name);

            return config;
        },

        deleteExternalSyncConfig(configId) {
            const idx = this.db.externalSyncConfigs.findIndex(c => c.id === configId);
            if (idx >= 0) {
                this.db.externalSyncConfigs.splice(idx, 1);
                this.save();
            }
        },

        logAudit(action, entity, entityId, entityName = '', details = {}, before = null, after = null, status = 'success') {
            const currentUser = this.state.currentUser;
            if (!currentUser) return;

            const auditEntry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                userId: currentUser.id,
                userName: currentUser.name,
                userRole: currentUser.role,
                action, // create, update, delete, approve, reject, assign, complete, cancel
                entity, // user, order, delivery, product, stock, finance, incident, pos, etc.
                entityId,
                entityName,
                details: typeof details === 'string' ? { description: details } : details,
                before: before ? JSON.stringify(before) : null,
                after: after ? JSON.stringify(after) : null,
                status, // success, error, pending, cancelled, warning
                ipAddress: 'localhost' // Sera collect� c��t� client si possible
            };

            this.db.auditLogs.unshift(auditEntry);
            this.save();
            return auditEntry;
        },

        notify(type, message, data = {}) {
            // ===== ISOLATION: Notifications isol�es par POS =====
            const posId = this.state.currentUser?.pos;
            const notification = { 
                id: Date.now(), 
                type, 
                message, 
                data, 
                read: false, 
                createdAt: new Date().toISOString(),
                posId: posId // Isoler la notification pour un POS sp�cifique
            };
            
            // Ajoute aussi aux notifications globales pour la compatibilit�
            this.db.notifications.unshift(notification);
            
            // Ajoute aussi aux notifications isol�es du POS
            if (posId && this.db.posDataByLocation && this.db.posDataByLocation[posId]) {
                if (!this.db.posDataByLocation[posId].notifications) {
                    this.db.posDataByLocation[posId].notifications = [];
                }
                this.db.posDataByLocation[posId].notifications.unshift(notification);
            }
            
            this.save();
            const toastType = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : 'success';
            UI.toast(message, toastType);
        },

        recordStockMovement({ productId, type, qty, note, ref, posId = null, fromPosId = null, toPosId = null, meta = {}, quantity = null, userId = null, userName = null }) {
            if (!productId) return null;

            const product = this.getProduct(productId);
            const currentUser = this.state.currentUser || {};
            const resolvedQty = Number((qty !== undefined && qty !== null) ? qty : (quantity !== undefined && quantity !== null ? quantity : 0));
            const effectiveQty = Number.isFinite(resolvedQty) ? resolvedQty : 0;
            const effectivePosId = (posId !== undefined && posId !== null) ? posId : (currentUser.pos ?? null);

            const movement = {
                id: Date.now(),
                productId,
                productName: product?.name || '�� ?��',
                type: type || 'adjust',
                qty: effectiveQty,
                ref: ref || null,
                note: note || null,
                userId: userId !== null && userId !== undefined ? userId : (currentUser.id ?? null),
                userName: userName || currentUser.name || 'System',
                createdAt: new Date().toISOString(),
                posId: effectivePosId,
                fromPosId: fromPosId ?? null,
                toPosId: toPosId ?? null,
                meta: meta || {}
            };

            this.db.stockMovements = this.db.stockMovements || [];
            this.db.stockMovements.unshift(movement);

            if (effectivePosId !== null && this.db.posDataByLocation && this.db.posDataByLocation[effectivePosId]) {
                const location = this.db.posDataByLocation[effectivePosId];
                if (!location.stockMovements) location.stockMovements = [];
                location.stockMovements.unshift(movement);
            }

            this.save();
            return movement;
        },

        // =====================
        // FINANCE LEDGER (Manager/PDG)
        // =====================
        recordFinancialTransaction({
            type = 'income', // income | expense
            category = 'sale', // sale | expense | commission | refund | adjustment
            amount = 0,
            method = null, // cash | mobile | cod | internal
            ref = null,
            note = null,
            orderId = null,
            deliveryId = null,
            posId = null,
            cityId = null,
            settled = null // true | false (null => auto)
        }) {
            const autoSettled = settled === null
                ? (category === 'commission' ? false : true)
                : Boolean(settled);

            const tx = {
                id: Date.now(),
                type,
                category,
                amount: Number(amount || 0),
                method,
                ref,
                note,
                orderId,
                deliveryId,
                posId,
                cityId,
                settled: autoSettled,
                settledAt: autoSettled ? new Date().toISOString() : null,
                userId: this.state.currentUser?.id || null,
                userName: this.state.currentUser?.name || 'System',
                createdAt: new Date().toISOString()
            };
            this.db.financialTransactions.unshift(tx);
            this.save();
            return tx;
        },

        ensureSaleTransaction(order) {
            if (!order) return;
            if (order.paymentStatus !== 'paid') return;
            const exists = (this.db.financialTransactions || []).some(t => t.category === 'sale' && t.orderId === order.id);
            if (exists) return;

            // Utiliser vendeurId de la commande, pas currentUser
            const vendeurId = order.vendeurId || this.state.currentUser?.id || null;
            const vendeur = this.getUser(vendeurId);
            
            const tx = {
                id: Date.now(),
                type: 'income',
                category: 'sale',
                amount: Number(order.total || 0),
                method: order.paymentMethod || null,
                ref: order.reference,
                note: `Vente ${order.reference}`,
                orderId: order.id,
                deliveryId: null,
                posId: order.posId || null,
                cityId: order.cityId || null,
                settled: true,
                settledAt: new Date().toISOString(),
                userId: vendeurId,
                userName: vendeur?.name || 'System',
                createdAt: order.createdAt || new Date().toISOString()
            };
            this.db.financialTransactions.unshift(tx);
            this.save();
        },

        ensureCommissionTransaction(delivery) {
            if (!delivery) return;
            if (delivery.status !== 'livree') return;
            const exists = (this.db.financialTransactions || []).some(t => t.category === 'commission' && t.deliveryId === delivery.id);
            if (exists) return;

            const linkedOrder = delivery.orderId ? this.db.orders.find(o => o.id === delivery.orderId) : null;
            const commission = delivery.commission || this.calculateDeliveryCommission(delivery);
            
            // Utiliser vendeurId de la commande li�e, pas currentUser
            const vendeurId = linkedOrder?.vendeurId || delivery.vendeurId || this.state.currentUser?.id || null;
            const vendeur = this.getUser(vendeurId);

            const tx = {
                id: Date.now() + Math.random(),
                type: 'expense',
                category: 'commission',
                amount: Number(commission || 0),
                method: 'internal',
                ref: delivery.orderRef,
                note: `Commission livreur (${delivery.orderRef})`,
                orderId: delivery.orderId || null,
                deliveryId: delivery.id,
                posId: linkedOrder?.posId || delivery.posId || null,
                cityId: linkedOrder?.cityId || null,
                settled: false,
                settledAt: null,
                userId: vendeurId,
                userName: vendeur?.name || 'System',
                createdAt: delivery.deliveredAt || new Date().toISOString()
            };
            this.db.financialTransactions.unshift(tx);
            this.save();
        },

        reconcileFinance() {
            // Backfill ledger entries based on existing orders/deliveries
            // Ensure sales ledger for paid orders
            (this.db.orders || []).forEach(o => {
                if ((o.paymentStatus || '') === 'paid') this.ensureSaleTransaction(o);
            });
            // Ensure commissions ledger for delivered deliveries
            (this.db.deliveries || []).forEach(d => {
                if ((d.status || '') === 'livree') this.ensureCommissionTransaction(d);
            });
        },
        
        // R�initialiser et r�g�n�rer les transactions financi��res (corrige les userId null)
        rebuildFinancialTransactions() {
            // Supprimer les transactions avec userId null ou invalides
            const validTxs = (this.db.financialTransactions || []).filter(t => t.userId && t.userId !== null);
            this.db.financialTransactions = validTxs;
            
            // Reg�n�rer les transactions manquantes
            this.reconcileFinance();
            
            UI.toast('Transactions financi��res r�g�n�r�es', 'success');
        },

        // Commissions par livreur
        getLivreurCommission(livreurId) {
            return this.db.livreurCommissions.find(c => c.livreurId === livreurId);
        },

        setLivreurCommission(livreurId, commissionPercent, commissionFixed = 0) {
            let c = this.db.livreurCommissions.find(x => x.livreurId === livreurId);
            if (!c) {
                this.db.livreurCommissions.push({
                    id: Date.now(),
                    livreurId,
                    commissionPercent: Number(commissionPercent || 0),
                    commissionFixed: Number(commissionFixed || 0),
                    createdAt: new Date().toISOString()
                });
            } else {
                c.commissionPercent = Number(commissionPercent || 0);
                c.commissionFixed = Number(commissionFixed || 0);
                c.updatedAt = new Date().toISOString();
            }
            this.save();
        },

        calculateDeliveryCommission(delivery) {
            const livreurCommission = this.getLivreurCommission(delivery.livreurId);
            if (livreurCommission) {
                // Si une commission personnalis�e est d�finie, l'utiliser
                const percent = livreurCommission.commissionPercent || 5;
                const fixed = livreurCommission.commissionFixed || 0;
                const baseCommission = Math.round((delivery.amount || 0) * (percent / 100));
                return baseCommission + fixed;
            }
            // Sinon, utiliser la commission par d�faut (5%)
            return Math.round((delivery.amount || 0) * 0.05);
        },

        // =====================
        // SYST�?ME D'ACTIVIT�
        // =====================
        logActivity(action, entity, entityId, details = {}) {
            const user = CORE.state.currentUser;
            if (!user) {
                console.warn('��š ��� � � logActivity: Pas d\'utilisateur actuellement connect�');
                return;
            }

            const entityMap = {
                order: 'Commande',
                delivery: 'Livraison',
                return: 'Retour',
                client: 'Client',
                product: 'Produit',
                payment: 'Paiement',
                discount: 'Remise',
                stock: 'Stock',
                deposits: 'D�p��t',
                shift: 'Shift',
                inventory: 'Inventaire',
                user: 'Utilisateur'
            };

            const actionMap = {
                create: 'Cr��',
                update: 'Modifi�',
                delete: 'Supprim�',
                cancel: 'Annul�',
                refund: 'Rembours�',
                paid: 'Pay�',
                delivered: 'Livr�',
                rejected: 'Rejet�',
                approved: 'Approuv�',
                deposit: 'D�p��t',
                assign: 'Affectation',
                status_change: 'Changement statut',
                validate: 'Validation'
            };

            const log = {
                id: Utils.uid('LOG'),
                timestamp: new Date().toISOString(),
                userId: user.id,
                userName: user.name,
                userRole: user.role,
                posId: user.pos || null,
                action: actionMap[action] || action,
                entity: entityMap[entity] || entity,
                entityId,
                entityName: details.entityName || '',
                details: details.description || '',
                status: details.status || 'success',
                amount: details.amount || 0
            };

            if (!CORE.db.activityLogs) CORE.db.activityLogs = [];
            CORE.db.activityLogs.push(log);
            
            // Also record in auditLogs for the gestionnaire module
            if (!CORE.db.auditLogs) CORE.db.auditLogs = [];
            CORE.db.auditLogs.push({
                id: Utils.uid('AUDIT'),
                timestamp: new Date().toISOString(),
                userId: user.id,
                userName: user.name,
                userRole: user.role,
                posId: user.pos || null,
                action: action,
                entity: entity,
                entityId,
                entityName: details.entityName || '',
                details: details.description || '',
                before: details.before || null,
                after: details.after || null,
                status: 'recorded'
            });
            
            CORE.save();
            console.log('���?? Activit� enregistr�e:', log.action, log.entity);
            return log;
        },

        getActivityLogs(filters = {}) {
            let logs = CORE.db.activityLogs || [];

            // Filtrer par POS
            if (filters.posId) {
                logs = logs.filter(l => l.posId == filters.posId);
            }

            // Filtrer par utilisateur
            if (filters.userId) {
                logs = logs.filter(l => l.userId === filters.userId);
            }

            // Filtrer par entit�
            if (filters.entity) {
                logs = logs.filter(l => l.entity === filters.entity);
            }

            // Filtrer par date de d�but
            if (filters.startDate) {
                logs = logs.filter(l => new Date(l.timestamp) >= new Date(filters.startDate));
            }

            // Filtrer par date de fin
            if (filters.endDate) {
                logs = logs.filter(l => new Date(l.timestamp) <= new Date(filters.endDate));
            }

            // Filtrer par montant minimum
            if (filters.minAmount) {
                logs = logs.filter(l => l.amount >= filters.minAmount);
            }

            // Filtrer par montant maximum
            if (filters.maxAmount) {
                logs = logs.filter(l => l.amount <= filters.maxAmount);
            }

            // Recherche texte
            if (filters.search) {
                const q = filters.search.toLowerCase();
                logs = logs.filter(l => 
                    l.userName.toLowerCase().includes(q) ||
                    l.entity.toLowerCase().includes(q) ||
                    l.entityName.toLowerCase().includes(q) ||
                    l.details.toLowerCase().includes(q)
                );
            }

            // Trier par date d�croissante
            return logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        },

        // =====================
        // DAILY DIGEST
        // =====================
        getDailyDigestConfig(posId) {
            const configs = this.db.dailyDigestConfigs || [];
            return configs.find(c => c.posId === posId) || null;
        },

        setDailyDigestConfig(posId, config) {
            if (!this.db.dailyDigestConfigs) this.db.dailyDigestConfigs = [];
            const index = this.db.dailyDigestConfigs.findIndex(c => c.posId === posId);
            
            const digestConfig = {
                id: config.id || Utils.uid('DGST'),
                posId,
                enabled: config.enabled !== false,
                sendTime: config.sendTime || '06:00',
                recipients: config.recipients || [],
                includeVentes: config.includeVentes !== false,
                includeDepots: config.includeDepots !== false,
                includeIncidents: config.includeIncidents !== false,
                includeKPIs: config.includeKPIs !== false,
                createdAt: config.createdAt || new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (index >= 0) {
                this.db.dailyDigestConfigs[index] = digestConfig;
            } else {
                this.db.dailyDigestConfigs.push(digestConfig);
            }

            this.save();
            return digestConfig;
        },

        generateDailyDigest(posId, date = null) {
            const targetDate = date ? new Date(date) : new Date();
            const startOfDay = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
            const endOfDay = new Date(startOfDay.getTime() + 24 * 60 * 60 * 1000);

            const config = this.getDailyDigestConfig(posId);
            if (!config || !config.enabled) return null;

            const pos = this.getPOS(posId);
            const digest = {
                id: Utils.uid('DIGEST'),
                posId,
                posName: pos ? pos.name : 'POS ' + posId,
                date: startOfDay.toISOString().split('T')[0],
                timestamp: new Date().toISOString(),
                status: 'pending'
            };

            // Ventes du jour
            if (config.includeVentes) {
                const orders = (this.db.orders || []).filter(o => {
                    if (o.posId !== posId) return false;
                    const oDate = new Date(o.createdAt);
                    return oDate >= startOfDay && oDate < endOfDay;
                });

                const deliveredOrders = orders.filter(o => o.status === 'delivered');
                const totalRevenue = deliveredOrders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);

                digest.ventes = {
                    total: orders.length,
                    delivered: deliveredOrders.length,
                    pending: orders.filter(o => o.status !== 'delivered').length,
                    revenue: totalRevenue,
                    avgValue: orders.length > 0 ? totalRevenue / orders.length : 0
                };
            }

            // D�p��ts du jour
            if (config.includeDepots) {
                const deposits = (this.db.deposits || []).filter(d => {
                    if (d.posId !== posId) return false;
                    const dDate = new Date(d.timestamp);
                    return dDate >= startOfDay && dDate < endOfDay;
                });

                digest.depots = {
                    total: deposits.length,
                    totalAmount: deposits.reduce((sum, d) => sum + (d.amount || 0), 0),
                    avgDeposit: deposits.length > 0 ? deposits.reduce((sum, d) => sum + (d.amount || 0), 0) / deposits.length : 0
                };
            }

            // Incidents du jour
            if (config.includeIncidents) {
                const deliveries = (this.db.deliveries || []).filter(d => {
                    const order = (this.db.orders || []).find(o => o.id === d.orderId);
                    if (!order || order.posId !== posId) return false;
                    const dDate = new Date(d.createdAt);
                    return dDate >= startOfDay && dDate < endOfDay;
                });

                const incidents = deliveries.filter(d => ['probleme', 'annulea'].includes(d.status));

                digest.incidents = {
                    total: incidents.length,
                    problems: incidents.filter(d => d.status === 'probleme').length,
                    cancelled: incidents.filter(d => d.status === 'annulea').length,
                    details: incidents.map(d => ({
                        orderRef: d.orderRef,
                        status: d.status,
                        reason: d.recallReason || 'Non sp�cifi�'
                    }))
                };
            }

            // KPIs cl�s
            if (config.includeKPIs) {
                const allDeliveries = (this.db.deliveries || []).filter(d => {
                    const order = (this.db.orders || []).find(o => o.id === d.orderId);
                    if (!order || order.posId !== posId) return false;
                    const dDate = new Date(d.createdAt);
                    return dDate >= startOfDay && dDate < endOfDay;
                });

                const delivered = allDeliveries.filter(d => d.status === 'livree');
                const onTimeDeliveries = delivered.filter(d => {
                    if (!d.assignedAt || !d.deliveredAt) return false;
                    const mins = (new Date(d.deliveredAt) - new Date(d.assignedAt)) / 60000;
                    return mins <= 60; // 60 minutes threshold
                });

                digest.kpis = {
                    deliveryRate: allDeliveries.length > 0 ? Math.round((delivered.length / allDeliveries.length) * 100) : 0,
                    onTimeRate: delivered.length > 0 ? Math.round((onTimeDeliveries.length / delivered.length) * 100) : 0,
                    avgDeliveryTime: delivered.length > 0 
                        ? Math.round(delivered.reduce((sum, d) => {
                            if (!d.assignedAt || !d.deliveredAt) return sum;
                            return sum + (new Date(d.deliveredAt) - new Date(d.assignedAt)) / 60000;
                        }, 0) / delivered.length)
                        : 0,
                    customerSatisfaction: 'N/A' // �?� calculer selon votre logique
                };
            }

            // Log du digest
            if (!this.db.dailyDigestLogs) this.db.dailyDigestLogs = [];
            this.db.dailyDigestLogs.push(digest);
            this.save();

            return digest;
        },

        sendDailyDigest(posId) {
            const config = this.getDailyDigestConfig(posId);
            if (!config || !config.enabled || !config.recipients || config.recipients.length === 0) {
                return null;
            }

            const digest = this.generateDailyDigest(posId);
            if (!digest) return null;

            // Simuler l'envoi (dans une vraie app, utiliser nodemailer ou service email)
            config.recipients.forEach(recipient => {
                console.log(`��Ÿ? � Digest envoy� �� ${recipient} pour ${digest.posName}`);
                // En production: CORE.sendEmail(recipient, subject, htmlContent);
            });

            digest.status = 'sent';
            digest.sentAt = new Date().toISOString();
            this.save();

            return digest;
        },

        initDailyDigestScheduler() {
            // V�rifier et envoyer les digests planifi�s chaque minute
            if (this._digestSchedulerId) clearInterval(this._digestSchedulerId);

            this._digestSchedulerId = setInterval(() => {
                const now = new Date();
                const currentTime = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');

                // V�rifier tous les POS configur�s
                const configs = this.db.dailyDigestConfigs || [];
                configs.forEach(config => {
                    if (config.enabled && config.sendTime === currentTime) {
                        // V�rifier que le digest du jour n'a pas d�j�� �t� envoy�
                        const today = now.toISOString().split('T')[0];
                        const alreadySent = (this.db.dailyDigestLogs || []).some(log =>
                            log.posId === config.posId &&
                            log.date === today &&
                            log.status === 'sent'
                        );

                        if (!alreadySent) {
                            this.sendDailyDigest(config.posId);
                            console.log(`���?� Digest quotidien envoy� pour POS ${config.posId}`);
                        }
                    }
                });
            }, 60000); // V�rifier chaque minute
        },

        stopDailyDigestScheduler() {
            if (this._digestSchedulerId) {
                clearInterval(this._digestSchedulerId);
                this._digestSchedulerId = null;
            }
        },

        initPendingArrivalsScheduler() {
            // V�rifier les arriv�es imminentes toutes les heures
            if (this._arrivalsSchedulerId) clearInterval(this._arrivalsSchedulerId);

            this._arrivalsSchedulerId = setInterval(() => {
                this.checkPendingArrivals();
            }, 3600000); // V�rifier chaque heure (3600000 ms)
            
            // V�rifier aussi au d�marrage
            this.checkPendingArrivals();
        },

        stopPendingArrivalsScheduler() {
            if (this._arrivalsSchedulerId) {
                clearInterval(this._arrivalsSchedulerId);
                this._arrivalsSchedulerId = null;
            }
        },

        checkPendingArrivals() {
            const purchaseOrders = this.db.purchaseOrders || [];
            const now = new Date();
            
            purchaseOrders.forEach(order => {
                // V�rifier si la commande est en attente ou confirm�e (pas re��ue)
                if (!['pending', 'confirmed'].includes(order.status)) return;
                
                // V�rifier si une date de livraison a �t� d�finie
                if (!order.deliveryDate) return;
                
                const deliveryDate = new Date(order.deliveryDate);
                const reminderDays = order.reminderDays || 3;
                
                // Calculer la date �� partir de laquelle on doit envoyer la notification
                const reminderDate = new Date(deliveryDate);
                reminderDate.setDate(reminderDate.getDate() - reminderDays);
                
                // V�rifier si on est dans la p�riode de rappel
                if (now >= reminderDate && now < deliveryDate) {
                    // V�rifier si la notification a d�j�� �t� envoy�e
                    const notificationKey = `arrival_reminder_${order.id}`;
                    const alreadyNotified = (this.db.notificationLog || []).some(log => log.key === notificationKey);
                    
                    if (!alreadyNotified) {
                        const supplier = this.db.suppliers?.find(s => s.id === order.supplierId);
                        const product = this.db.products?.find(p => p.id === order.productId);
                        const daysUntilArrival = Math.ceil((deliveryDate - now) / (1000 * 60 * 60 * 24));
                        
                        this.notify('info', `��Ÿ? � Arriv�e imminente: ${order.reference} (${product?.name || 'Produit'}) de ${supplier?.name || 'Fournisseur'} dans ${daysUntilArrival} jour(s)`, { purchaseOrderId: order.id, type: 'arrival_reminder' });
                        
                        // Enregistrer que la notification a �t� envoy�e
                        if (!this.db.notificationLog) this.db.notificationLog = [];
                        this.db.notificationLog.push({ key: notificationKey, sentAt: now.toISOString() });
                        this.save();
                    }
                }
            });
        },

        // =====================
        // CENTRE D'INCIDENTS
        // =====================
        createIncident(type, relatedEntity, relatedType, description, severity = 'moyenne') {
            // type: 'retard', 'annulation', 'litige'
            // relatedType: 'delivery' ou 'order'
            // severity: 'basse', 'moyenne', 'haute'
            const now = new Date();
            const incidentId = 'INC-' + now.getTime();
            
            // D�terminer les minutes SLA selon le type et la s�v�rit�
            const slaMinutes = {
                'retard': { 'basse': 480, 'moyenne': 240, 'haute': 120 }, // 8h, 4h, 2h
                'annulation': { 'basse': 240, 'moyenne': 120, 'haute': 60 }, // 4h, 2h, 1h
                'litige': { 'basse': 1440, 'moyenne': 480, 'haute': 240 } // 24h, 8h, 4h
            };

            const minutes = slaMinutes[type]?.[severity] || 240;
            const slaEndTime = new Date(now.getTime() + minutes * 60000).toISOString();

            const incident = {
                id: incidentId,
                timestamp: now.toISOString(),
                type: type, // retard, annulation, litige
                severity: severity,
                relatedEntity: relatedEntity,
                relatedType: relatedType,
                assignedTo: null,
                assignedToName: null,
                status: 'ouvert', // ouvert, en-cours, r�solu, ferm�
                description: description,
                slaStartTime: now.toISOString(),
                slaEndTime: slaEndTime,
                slaMinutes: minutes,
                slaStatus: 'en-cours',
                notes: [],
                resolution: null,
                createdBy: this.state.currentUser?.id,
                createdByName: this.state.currentUser?.name,
                closedAt: null,
                closedBy: null,
                tags: [],
                priority: severity === 'haute' ? 1 : (severity === 'moyenne' ? 2 : 3)
            };

            this.db.incidents.push(incident);
            this.logActivity('create', 'incident', incidentId, {
                entityName: `Incident ${type}`,
                description: description,
                severity: severity
            });
            
            // Create notification for incident
            if (this.db.alertThresholds?.find(t => t.id === 'incident_open')?.enabled) {
                this.createNotification(
                    'incident_open',
                    `��Ÿš � Incident Ouvert: ${type.toUpperCase()}`,
                    `${description} (S�v�rit�: ${severity})`,
                    severity === 'haute' ? 'critical' : 'high'
                );
            }
            
            this.save();
            return incident;
        },

        assignIncident(incidentId, userId) {
            const incident = this.db.incidents.find(i => i.id === incidentId);
            if (!incident) return null;

            const before = { assignedTo: incident.assignedTo, assignedToName: incident.assignedToName };
            const user = this.getUser(userId);
            
            incident.assignedTo = userId;
            incident.assignedToName = user?.name || 'Unknown';
            incident.status = incident.status === 'ouvert' ? 'en-cours' : incident.status;

            this.recordIncidentHistory(incidentId, 'assign', before, 
                { assignedTo: userId, assignedToName: incident.assignedToName });
            this.logActivity('assign', 'incident', incidentId, {
                entityName: `Incident #${incidentId}`,
                description: `Assign� �� ${incident.assignedToName}`,
                before, after: { assignedTo: userId }
            });
            this.save();
            return incident;
        },

        updateIncidentStatus(incidentId, newStatus) {
            const incident = this.db.incidents.find(i => i.id === incidentId);
            if (!incident) return null;

            const before = incident.status;
            incident.status = newStatus;

            if (newStatus === 'ferm�' && !incident.closedAt) {
                incident.closedAt = new Date().toISOString();
                incident.closedBy = this.state.currentUser?.id;
            }

            // Calculer SLA status �� la fermeture
            if (newStatus === 'r�solu' || newStatus === 'ferm�') {
                const closeTime = new Date();
                const slaEnd = new Date(incident.slaEndTime);
                incident.slaStatus = closeTime <= slaEnd ? 'atteint' : 'd�pass�';
            }

            this.recordIncidentHistory(incidentId, 'status_change', { status: before }, { status: newStatus });
            this.logActivity('status_change', 'incident', incidentId, {
                entityName: `Incident #${incidentId}`,
                description: `Statut chang� de ${before} �� ${newStatus}`,
                before: { status: before },
                after: { status: newStatus }
            });
            this.save();
            return incident;
        },

        addIncidentNote(incidentId, text) {
            const incident = this.db.incidents.find(i => i.id === incidentId);
            if (!incident) return null;

            const note = {
                id: 'NOTE-' + new Date().getTime(),
                timestamp: new Date().toISOString(),
                userId: this.state.currentUser?.id,
                userName: this.state.currentUser?.name,
                text: text
            };

            incident.notes.push(note);
            this.recordIncidentHistory(incidentId, 'note_added', null, { note: text });
            this.logActivity('note', 'incident', incidentId, {
                entityName: `Incident #${incidentId}`,
                description: `Note ajout�e: ${text.substring(0, 50)}...`
            });
            this.save();
            return note;
        },

        setIncidentResolution(incidentId, resolution) {
            const incident = this.db.incidents.find(i => i.id === incidentId);
            if (!incident) return null;

            incident.resolution = resolution;
            if (incident.status === 'ouvert' || incident.status === 'en-cours') {
                incident.status = 'r�solu';
            }

            this.recordIncidentHistory(incidentId, 'resolution_set', null, { resolution: resolution });
            this.logActivity('resolve', 'incident', incidentId, {
                entityName: `Incident #${incidentId}`,
                description: `R�solution: ${resolution.substring(0, 50)}...`
            });
            this.save();
            return incident;
        },

        recordIncidentHistory(incidentId, action, oldValue, newValue) {
            const historyEntry = {
                id: 'HIST-' + new Date().getTime(),
                incidentId: incidentId,
                timestamp: new Date().toISOString(),
                userId: this.state.currentUser?.id,
                userName: this.state.currentUser?.name,
                action: action, // assign, status_change, note_added, resolution_set, tag_added
                oldValue: oldValue,
                newValue: newValue,
                details: {}
            };

            this.db.incidentHistory.push(historyEntry);
            this.save();
            return historyEntry;
        },

        getIncidentStats() {
            const incidents = this.db.incidents || [];
            const now = new Date();

            return {
                total: incidents.length,
                open: incidents.filter(i => i.status === 'ouvert').length,
                inProgress: incidents.filter(i => i.status === 'en-cours').length,
                resolved: incidents.filter(i => i.status === 'r�solu' || i.status === 'ferm�').length,
                slaBreached: incidents.filter(i => i.slaStatus === 'd�pass�').length,
                bySeverity: {
                    haute: incidents.filter(i => i.severity === 'haute').length,
                    moyenne: incidents.filter(i => i.severity === 'moyenne').length,
                    basse: incidents.filter(i => i.severity === 'basse').length
                },
                byType: {
                    retard: incidents.filter(i => i.type === 'retard').length,
                    annulation: incidents.filter(i => i.type === 'annulation').length,
                    litige: incidents.filter(i => i.type === 'litige').length
                },
                avgResolutionTime: this.calculateAvgResolutionTime()
            };
        },

        calculateAvgResolutionTime() {
            const incidents = this.db.incidents.filter(i => i.closedAt);
            if (incidents.length === 0) return 0;

            const totalTime = incidents.reduce((sum, i) => {
                const created = new Date(i.timestamp);
                const closed = new Date(i.closedAt);
                return sum + (closed - created);
            }, 0);

            return Math.round(totalTime / incidents.length / 60000); // en minutes
        },

        getIncidents(filters = {}) {
            let incidents = this.db.incidents || [];

            if (filters.status) {
                incidents = incidents.filter(i => i.status === filters.status);
            }
            if (filters.type) {
                incidents = incidents.filter(i => i.type === filters.type);
            }
            if (filters.severity) {
                incidents = incidents.filter(i => i.severity === filters.severity);
            }
            if (filters.slaStatus) {
                incidents = incidents.filter(i => i.slaStatus === filters.slaStatus);
            }
            if (filters.assignedTo) {
                incidents = incidents.filter(i => i.assignedTo === filters.assignedTo);
            }
            if (filters.search) {
                const q = filters.search.toLowerCase();
                incidents = incidents.filter(i => 
                    i.id.toLowerCase().includes(q) ||
                    i.description.toLowerCase().includes(q) ||
                    i.relatedEntity.toString().includes(q) ||
                    (i.assignedToName && i.assignedToName.toLowerCase().includes(q))
                );
            }
            if (filters.startDate) {
                const start = new Date(filters.startDate);
                incidents = incidents.filter(i => new Date(i.timestamp) >= start);
            }
            if (filters.endDate) {
                const end = new Date(filters.endDate);
                end.setHours(23, 59, 59, 999);
                incidents = incidents.filter(i => new Date(i.timestamp) <= end);
            }

            // Trier par priorit� puis par date
            incidents.sort((a, b) => {
                if (a.priority !== b.priority) return a.priority - b.priority;
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            return incidents;
        },

        getIncidentHistory(incidentId) {
            return (this.db.incidentHistory || []).filter(h => h.incidentId === incidentId)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        },

        exportIncidents(filters = {}) {
            const incidents = this.getIncidents(filters);
            const headers = ['ID', 'Date', 'Type', 'S�v�rit�', 'Statut', 'SLA', 'Assign� ��', 'Description', 'R�solution'];
            const rows = incidents.map(i => [
                i.id,
                new Date(i.timestamp).toLocaleString('fr-FR'),
                i.type,
                i.severity,
                i.status,
                i.slaStatus,
                i.assignedToName || 'Non assign�',
                (i.description || '').substring(0, 50),
                (i.resolution || '').substring(0, 50)
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => '"' + (cell || '').toString().replace(/"/g, '""') + '"').join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `incidents_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        },

        // =====================
        // BO�?ŽTE �?� OUTILS MANAGER
        // =====================
        initDefaultMessageTemplates() {
            if ((this.db.messageTemplates || []).length > 0) return;

            const templates = [
                {
                    id: 'tpl_delivery_confirm',
                    name: 'Confirmation de livraison',
                    type: 'whatsapp',
                    category: 'delivery',
                    content: 'Bonjour {{name}}, votre commande {{orderRef}} a �t� confi�e au livreur {{driverName}} qui sera chez vous en {{estimatedTime}}min. Num�ro de suivi: {{trackingId}}',
                    variables: ['name', 'orderRef', 'driverName', 'estimatedTime', 'trackingId']
                },
                {
                    id: 'tpl_delivery_reminder',
                    name: 'Rappel de livraison',
                    type: 'sms',
                    category: 'reminder',
                    content: '{{name}}: Votre commande {{orderRef}} arrive dans 30min. Assurez-vous d\'��tre disponible.',
                    variables: ['name', 'orderRef']
                },
                {
                    id: 'tpl_delay_alert',
                    name: 'Alerte de retard',
                    type: 'whatsapp',
                    category: 'alert',
                    content: 'D�sol� {{name}}, votre livraison {{orderRef}} subit un l�ger retard. Nous nous excusons. ETA: {{newETA}}',
                    variables: ['name', 'orderRef', 'newETA']
                },
                {
                    id: 'tpl_resolution_confirm',
                    name: 'Confirmation de r�solution',
                    type: 'whatsapp',
                    category: 'resolution',
                    content: 'Merci {{name}}, votre incident a �t� r�solu. Voici le d�tail: {{resolution}}. N\'h�sitez pas �� nous recontacter.',
                    variables: ['name', 'resolution']
                },
                {
                    id: 'tpl_payment_reminder',
                    name: 'Rappel paiement COD',
                    type: 'sms',
                    category: 'reminder',
                    content: 'Montant �� payer �� la livraison: {{amount}} FCFA. Commande: {{orderRef}}',
                    variables: ['amount', 'orderRef']
                }
            ];

            templates.forEach(t => {
                t.createdBy = 'system';
                this.db.messageTemplates.push(t);
            });
            this.save();
        },

        getMessageTemplates(type = null, category = null) {
            let templates = this.db.messageTemplates || [];

            if (type) {
                templates = templates.filter(t => t.type === type);
            }
            if (category) {
                templates = templates.filter(t => t.category === category);
            }

            return templates;
        },

        saveMessageTemplate(template) {
            const existing = this.db.messageTemplates.find(t => t.id === template.id);
            if (existing) {
                Object.assign(existing, template);
            } else {
                template.id = 'tpl_' + new Date().getTime();
                template.createdBy = this.state.currentUser?.id;
                this.db.messageTemplates.push(template);
            }
            this.save();
            return template;
        },

        sendMessage(recipientId, templateId, variables = {}) {
            const template = this.db.messageTemplates.find(t => t.id === templateId);
            const recipient = this.getUser(recipientId);
            
            if (!template || !recipient) return null;

            // Remplacer les variables
            let content = template.content;
            Object.entries(variables).forEach(([key, value]) => {
                content = content.replace(new RegExp(`{{${key}}}`, 'g'), value);
            });

            const message = {
                id: 'MSG-' + new Date().getTime(),
                timestamp: new Date().toISOString(),
                recipientId: recipientId,
                recipientName: recipient.name,
                recipientPhone: recipient.phone,
                type: template.type,
                status: 'sent',
                content: content,
                templateId: templateId,
                sentBy: this.state.currentUser?.id,
                sentByName: this.state.currentUser?.name
            };

            this.db.messageLog.push(message);
            this.logActivity('send_message', 'message', message.id, {
                entityName: `Message ${template.type} �� ${recipient.name}`,
                description: content.substring(0, 50)
            });
            this.save();
            return message;
        },

        initiateCall(recipientId, reason = '') {
            const recipient = this.getUser(recipientId);
            if (!recipient || !recipient.phone) {
                return { error: 'Num�ro non disponible' };
            }

            const call = {
                id: 'CALL-' + new Date().getTime(),
                timestamp: new Date().toISOString(),
                recipientId: recipientId,
                recipientName: recipient.name,
                recipientPhone: recipient.phone,
                initiatedBy: this.state.currentUser?.id,
                initiatedByName: this.state.currentUser?.name,
                status: 'initiated',
                duration: 0,
                reason: reason
            };

            this.db.messageLog.push(call);
            this.logActivity('call', 'communication', call.id, {
                entityName: `Appel �� ${recipient.name}`,
                description: reason
            });
            this.save();
            return call;
        },

        quickAssignDelivery(deliveryId, userId) {
            const d = this.db.deliveries.find(x => x.id === deliveryId);
            const user = this.getUser(userId);
            if (!d || !user) return null;

            const oldLivreur = d.livreurId ? this.getUser(d.livreurId)?.name : 'Non assign�';
            d.livreurId = userId;
            d.livreurName = user.name;
            d.livreurPhone = user.phone;
            d.assignedAt = new Date().toISOString();
            d.status = 'assigned';

            this.logActivity('assign', 'delivery', d.id, {
                entityName: `Commande ${d.orderRef}`,
                description: `Assign�e �� ${user.name}`,
                before: { livreur: oldLivreur },
                after: { livreur: user.name }
            });

            this.save();
            return d;
        },

        quickRecallDelivery(deliveryId, reason = '') {
            const d = this.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return null;

            const oldLivreur = d.livreurName || 'N/A';
            d.status = 'recalled';
            d.recalledAt = new Date().toISOString();
            d.recallReason = reason;
            d.previousLivreurId = d.livreurId;
            d.livreurId = null;
            d.livreurName = null;

            this.logActivity('recall', 'delivery', d.id, {
                entityName: `Commande ${d.orderRef}`,
                description: `Rappel�e de ${oldLivreur}. Raison: ${reason}`,
                before: { status: 'assigned', livreur: oldLivreur },
                after: { status: 'recalled' }
            });

            this.save();
            return d;
        },

        notifyUser(userId, title, message, type = 'info') {
            // type: info, warning, error, success
            const notification = {
                id: 'NOTIF-' + new Date().getTime(),
                timestamp: new Date().toISOString(),
                userId: userId,
                title: title,
                message: message,
                type: type,
                read: false
            };

            if (!this.db.notifications) this.db.notifications = [];
            this.db.notifications.push(notification);
            this.save();
            return notification;
        },

        openTaxesReport(userId) {
            // G�n�rer rapport taxes pour un utilisateur
            const user = this.getUser(userId);
            if (!user) return null;

            const txs = (this.db.financialTransactions || []).filter(t => t.userId === userId);
            const sales = txs.filter(t => t.type === 'sale');
            const commissions = txs.filter(t => t.type === 'commission');
            const deposits = txs.filter(t => t.type === 'deposit');

            const totalSales = sales.reduce((sum, t) => sum + t.amount, 0);
            const totalCommissions = commissions.reduce((sum, t) => sum + t.amount, 0);
            const totalDeposits = deposits.reduce((sum, t) => sum + t.amount, 0);

            return {
                userId: user.id,
                userName: user.name,
                userRole: user.role,
                periodStart: new Date(new Date().setDate(1)).toISOString(),
                periodEnd: new Date().toISOString(),
                totalSales: totalSales,
                totalCommissions: totalCommissions,
                totalDeposits: totalDeposits,
                netIncome: totalSales - totalDeposits,
                taxableAmount: Math.max(0, totalSales * 0.15),
                transactions: txs
            };
        },

        // =====================
        // DASHBOARD FINANCIER
        // =====================
        getFinancialMetrics(userId, startDate = null, endDate = null, posId = null) {
            let txs = (this.db.financialTransactions || []);
            
            // Filtrer par userId si sp�cifi� (pour vendeur)
            if (userId) {
                txs = txs.filter(t => t.userId === userId);
            }
            
            // Filtrer par POS si sp�cifi�
            if (posId) {
                txs = txs.filter(t => t.posId == posId || !t.posId);
            }
            
            let filtered = txs;
            if (startDate) {
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
                filtered = filtered.filter(t => new Date(t.createdAt) >= start);
            }
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                filtered = filtered.filter(t => new Date(t.createdAt) <= end);
            }

            const income = filtered.filter(t => t.type === 'income').reduce((sum, t) => sum + (t.amount || 0), 0);
            const expenses = filtered.filter(t => t.type === 'expense').reduce((sum, t) => sum + (t.amount || 0), 0);
            const profit = income - expenses;

            return {
                totalIncome: income,
                totalExpenses: expenses,
                netProfit: profit,
                profitMargin: income > 0 ? ((profit / income) * 100).toFixed(2) : 0,
                transactionCount: filtered.length,
                averageTransaction: filtered.length > 0 ? (income / filtered.length).toFixed(2) : 0
            };
        },
        
        // Version pour gestionnaire/manager: filtre par POS seulement, pas par userId
        getFinancialMetricsByPOS(posId, startDate = null, endDate = null) {
            let txs = (this.db.financialTransactions || []).filter(t => t.posId == posId);
            
            let filtered = txs;
            if (startDate) {
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
                filtered = filtered.filter(t => new Date(t.createdAt) >= start);
            }
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                filtered = filtered.filter(t => new Date(t.createdAt) <= end);
            }

            const income = filtered.filter(t => t.type === 'income').reduce((sum, t) => sum + (t.amount || 0), 0);
            const expenses = filtered.filter(t => t.type === 'expense').reduce((sum, t) => sum + (t.amount || 0), 0);
            const profit = income - expenses;

            return {
                totalIncome: income,
                totalExpenses: expenses,
                netProfit: profit,
                profitMargin: income > 0 ? ((profit / income) * 100).toFixed(2) : 0,
                transactionCount: filtered.length,
                averageTransaction: filtered.length > 0 ? (income / filtered.length).toFixed(2) : 0
            };
        },
        
        // Version pour PDG/Admin: toutes les transactions, optionnellement filtr�es
        getFinancialMetricsGlobal(startDate = null, endDate = null, posId = null) {
            let txs = (this.db.financialTransactions || []);
            
            if (posId) {
                txs = txs.filter(t => t.posId == posId);
            }
            
            let filtered = txs;
            if (startDate) {
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
                filtered = filtered.filter(t => new Date(t.createdAt) >= start);
            }
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                filtered = filtered.filter(t => new Date(t.createdAt) <= end);
            }

            const income = filtered.filter(t => t.type === 'income').reduce((sum, t) => sum + (t.amount || 0), 0);
            const expenses = filtered.filter(t => t.type === 'expense').reduce((sum, t) => sum + (t.amount || 0), 0);
            const profit = income - expenses;

            return {
                totalIncome: income,
                totalExpenses: expenses,
                netProfit: profit,
                profitMargin: income > 0 ? ((profit / income) * 100).toFixed(2) : 0,
                transactionCount: filtered.length,
                averageTransaction: filtered.length > 0 ? (income / filtered.length).toFixed(2) : 0
            };
        },

        getCashFlowByPeriod(userId, period = 'daily', posId = null) {
            // period: 'daily', 'weekly', 'monthly'
            let txs = (this.db.financialTransactions || []);
            
            // Filtrer par userId si sp�cifi�
            if (userId) {
                txs = txs.filter(t => t.userId === userId);
            }
            
            // Filtrer par POS si sp�cifi�
            if (posId) {
                txs = txs.filter(t => t.posId == posId || !t.posId);
            }
            
            const cashFlow = {};

            txs.forEach(t => {
                const date = new Date(t.createdAt);
                let key;

                if (period === 'daily') {
                    key = date.toISOString().split('T')[0];
                } else if (period === 'weekly') {
                    const week = Math.floor((date.getDate() + 6) / 7);
                    const month = date.getMonth() + 1;
                    const year = date.getFullYear();
                    key = `${year}-W${week < 10 ? '0' + week : week}`;
                } else if (period === 'monthly') {
                    key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                }

                if (!cashFlow[key]) {
                    cashFlow[key] = { income: 0, expenses: 0, net: 0 };
                }

                if (t.type === 'income') {
                    cashFlow[key].income += t.amount || 0;
                } else {
                    cashFlow[key].expenses += t.amount || 0;
                }
                cashFlow[key].net = cashFlow[key].income - cashFlow[key].expenses;
            });

            return cashFlow;
        },

        getProfitByClient(userId) {
            const orders = (this.db.orders || []).filter(o => o.vendeurId === userId);
            const profit = {};

            orders.forEach(order => {
                const clientId = order.clientId || 'unknown';
                const clientName = order.clientName || 'Client inconnu';
                
                // Trouver le revenu de cette commande
                const sale = (this.db.financialTransactions || []).find(t => 
                    t.userId === userId && t.category === 'sale' && t.orderId === order.id
                );
                const revenue = sale ? sale.amount : order.total || 0;

                // Trouver les commissions associ�es �� cette commande
                const delivery = (this.db.deliveries || []).find(d => d.orderId === order.id);
                const commission = delivery ? (
                    (this.db.financialTransactions || []).find(t => 
                        t.userId === userId && t.category === 'commission' && t.deliveryId === delivery.id
                    )?.amount || 0
                ) : 0;

                if (!profit[clientId]) {
                    profit[clientId] = { name: clientName, revenue: 0, expenses: 0, profit: 0, orderCount: 0 };
                }
                profit[clientId].revenue += revenue;
                profit[clientId].expenses += commission;
                profit[clientId].profit = profit[clientId].revenue - profit[clientId].expenses;
                profit[clientId].orderCount++;
            });

            return Object.values(profit).sort((a, b) => b.profit - a.profit);
        },

        getProfitByCategory(userId) {
            const orders = (this.db.orders || []).filter(o => o.vendeurId === userId);
            const profit = {};

            orders.forEach(order => {
                const categoryId = order.categoryId || 'unknown';
                const categoryName = order.categoryName || 'Cat�gorie inconnue';

                const sale = (this.db.financialTransactions || []).find(t => 
                    t.userId === userId && t.category === 'sale' && t.orderId === order.id
                );
                const revenue = sale ? sale.amount : order.total || 0;

                if (!profit[categoryId]) {
                    profit[categoryId] = { name: categoryName, revenue: 0, expenses: 0, profit: 0, orderCount: 0 };
                }
                profit[categoryId].revenue += revenue;
                profit[categoryId].orderCount++;
            });

            Object.keys(profit).forEach(key => {
                profit[key].profit = profit[key].revenue - profit[key].expenses;
            });

            return Object.values(profit).sort((a, b) => b.profit - a.profit);
        },

        getFinancialStatement(userId, startDate = null, endDate = null, posId = null) {
            const metrics = this.getFinancialMetrics(userId, startDate, endDate, posId);
            let txs = (this.db.financialTransactions || []).filter(t => t.userId === userId);
            
            // Filtrer par POS si sp�cifi�
            if (posId) {
                txs = txs.filter(t => t.posId == posId || !t.posId);
            }
            
            let filtered = txs;
            if (startDate) {
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
                filtered = filtered.filter(t => new Date(t.createdAt) >= start);
            }
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                filtered = filtered.filter(t => new Date(t.createdAt) <= end);
            }

            // Grouper par cat�gorie
            const byCategory = {};
            filtered.forEach(t => {
                const cat = t.category || 'other';
                if (!byCategory[cat]) {
                    byCategory[cat] = { income: 0, expenses: 0 };
                }
                if (t.type === 'income') {
                    byCategory[cat].income += t.amount || 0;
                } else {
                    byCategory[cat].expenses += t.amount || 0;
                }
            });

            const taxRate = 0.19; // 19% VAT
            const grossProfit = metrics.totalIncome - metrics.totalExpenses;
            const taxes = Math.round(grossProfit * taxRate);
            const netProfit = grossProfit - taxes;

            return {
                period: { startDate, endDate },
                revenues: {
                    sales: byCategory.sale?.income || 0,
                    other: byCategory.other?.income || 0,
                    total: metrics.totalIncome
                },
                expenses: {
                    commissions: byCategory.commission?.expenses || 0,
                    operational: byCategory.expense?.expenses || 0,
                    other: byCategory.other?.expenses || 0,
                    total: metrics.totalExpenses
                },
                grossProfit,
                taxRate: (taxRate * 100).toFixed(0) + '%',
                taxes,
                netProfit,
                profitMargin: metrics.profitMargin
            };
        },

        calculateTaxesOwed(userId, startDate = null, endDate = null, posId = null) {
            const statement = this.getFinancialStatement(userId, startDate, endDate, posId);
            const vendeur = CORE.db.users.find(u => u.id === userId);
            
            // Utiliser le taux personnalis� si d�fini, sinon utiliser le taux par d�faut
            let taxRate = statement.taxRate;
            if (vendeur && vendeur.customTaxRate !== undefined && vendeur.customTaxRate !== null) {
                taxRate = vendeur.customTaxRate / 100; // Convertir le pourcentage en d�cimal
            }
            
            const taxesOwed = Math.round(statement.grossProfit * taxRate);
            
            // Utiliser la date d'�ch�ance personnalis�e si d�finie
            let dueDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            if (vendeur && vendeur.customDueDate) {
                dueDate = vendeur.customDueDate;
            }
            
            return {
                grossIncome: statement.revenues.total,
                taxableIncome: statement.grossProfit,
                taxRate: (taxRate * 100).toFixed(0) + '%',
                taxesOwed: taxesOwed,
                dueDate: dueDate
            };
        },

        // =====================
        // RECONCILIATION SYSTEM
        // =====================
        getDepositReconciliation(posId, dateFrom = null, dateTo = null) {
            const deposits = (this.db.deposits || []).filter(d => d.posId === posId && d.status === 'enregistre');
            
            let filtered = deposits;
            if (dateFrom) {
                const start = new Date(dateFrom);
                filtered = filtered.filter(d => new Date(d.timestamp) >= start);
            }
            if (dateTo) {
                const end = new Date(dateTo);
                end.setHours(23, 59, 59, 999);
                filtered = filtered.filter(d => new Date(d.timestamp) <= end);
            }

            return filtered.map(deposit => {
                // V�rifier les commandes d�clar�es
                const ordersInDeposit = (this.db.orders || []).filter(o => 
                    deposit.ordersRef && deposit.ordersRef.includes(o.orderRef)
                ) || [];
                
                // Calculer le revenu r�el de ces commandes
                const actualRevenue = ordersInDeposit.reduce((sum, o) => sum + (o.total || 0), 0);
                const declaredAmount = deposit.amount || 0;
                const discrepancy = declaredAmount - actualRevenue;
                
                // V�rifier le compte de commandes
                const declaredCount = deposit.ordersCount || 0;
                const actualCount = ordersInDeposit.length;
                const orderMismatch = declaredCount - actualCount;

                // Statut de l'�cart
                let anomalyType = 'OK';
                if (Math.abs(discrepancy) > 1000) anomalyType = 'CRITICAL_AMOUNT';
                if (orderMismatch !== 0) anomalyType = 'ORDER_MISMATCH';
                if (discrepancy > 0) anomalyType = 'OVER_DECLARED';
                if (discrepancy < 0) anomalyType = 'UNDER_DECLARED';

                return {
                    depositId: deposit.id,
                    timestamp: deposit.timestamp,
                    livreurName: deposit.livreurName,
                    vendeurName: deposit.vendeurName,
                    declaredAmount,
                    actualRevenue,
                    discrepancy,
                    discrepancyPercent: declaredAmount > 0 ? ((discrepancy / declaredAmount) * 100).toFixed(2) : 0,
                    declaredCount,
                    actualCount,
                    orderMismatch,
                    ordersRef: deposit.ordersRef || [],
                    missingOrders: deposit.ordersRef ? (this.db.orders || [])
                        .filter(o => deposit.ordersRef.includes(o.orderRef) && !ordersInDeposit.find(od => od.id === o.id))
                        .map(o => ({id: o.id, ref: o.orderRef, amount: o.total})) : [],
                    anomalyType,
                    anomalySeverity: anomalyType === 'OK' ? 'green' : anomalyType === 'CRITICAL_AMOUNT' ? 'red' : 'amber',
                    notes: deposit.notes || ''
                };
            });
        },

        getReconciliationSummary(posId, dateFrom = null, dateTo = null) {
            const reconciliations = this.getDepositReconciliation(posId, dateFrom, dateTo);
            
            const summary = {
                totalDeposits: reconciliations.length,
                totalDeclared: reconciliations.reduce((sum, r) => sum + r.declaredAmount, 0),
                totalActual: reconciliations.reduce((sum, r) => sum + r.actualRevenue, 0),
                totalDiscrepancy: reconciliations.reduce((sum, r) => sum + r.discrepancy, 0),
                totalOrderMismatch: reconciliations.reduce((sum, r) => sum + Math.abs(r.orderMismatch), 0),
                anomalies: {
                    ok: reconciliations.filter(r => r.anomalyType === 'OK').length,
                    overDeclared: reconciliations.filter(r => r.anomalyType === 'OVER_DECLARED').length,
                    underDeclared: reconciliations.filter(r => r.anomalyType === 'UNDER_DECLARED').length,
                    criticalAmount: reconciliations.filter(r => r.anomalyType === 'CRITICAL_AMOUNT').length,
                    orderMismatch: reconciliations.filter(r => r.anomalyType === 'ORDER_MISMATCH').length
                },
                recommendations: []
            };

            // G�n�rer des recommandations
            if (summary.anomalies.overDeclared > 0) {
                summary.recommendations.push('��š ��� � � D�p��ts suraugment�s d�tect�s - V�rifier les montants d�clar�s');
            }
            if (summary.anomalies.underDeclared > 0) {
                summary.recommendations.push('��š ��� � � D�p��ts sous-d�clar�s - Rechercher les commandes manquantes');
            }
            if (summary.anomalies.criticalAmount > 0) {
                summary.recommendations.push('��Ÿ� � �carts critiques > 1000 FCFA - Enqu��te recommand�e');
            }
            if (summary.anomalies.orderMismatch > 0) {
                summary.recommendations.push('�� ��? Mismatch commandes-d�p��ts - Validation urgente');
            }
            if (summary.anomalies.ok === summary.totalDeposits) {
                summary.recommendations.push('���?� Tous les d�p��ts sont r�concili�s correctement');
            }

            return summary;
        },

        validateDeposits(posId, depositIds = []) {
            // Marquer les d�p��ts comme approuv�s apr��s r�conciliation
            const idsToValidate = depositIds.length > 0 ? depositIds : 
                (this.db.deposits || [])
                    .filter(d => d.posId === posId && d.status === 'enregistre')
                    .map(d => d.id);

            idsToValidate.forEach(id => {
                const idx = (this.db.deposits || []).findIndex(d => d.id === id);
                if (idx !== -1) {
                    this.db.deposits[idx].status = 'approuve';
                    this.db.deposits[idx].validatedAt = new Date().toISOString();
                }
            });

            this.save();
            return {
                validatedCount: idsToValidate.length,
                successMessage: `${idsToValidate.length} d�p��t(s) valid�(s)`
            };
        },

        // Getter pour acc�der �� l'utilisateur courant via CORE.user
        get user() {
            return this.state.currentUser;
        }
    };

    // Expose CORE for optional integrations (e.g. Maps)
    window.CORE = CORE;

    // =========================================================
    // OFFLINE MANAGER - Gestion avanc�e du mode hors-ligne
    // =========================================================
    const OfflineManager = {
        // Configuration
        config: {
            maxRetries: 5,
            baseRetryDelay: 1000, // ms
            maxRetryDelay: 60000, // 1 minute max
            autoSyncInterval: 30000, // 30 secondes
            maxQueueSize: 500
        },

        // �tat
        state: {
            isOnline: navigator.onLine,
            isSyncing: false,
            autoSyncTimer: null,
            lastSyncAttempt: null,
            consecutiveFailures: 0
        },

        // Initialiser le gestionnaire
        init() {
            // �couter les �v�nements online/offline
            window.addEventListener('online', () => this.handleOnline());
            window.addEventListener('offline', () => this.handleOffline());
            
            // D�marrer l'auto-sync si en ligne
            if (navigator.onLine) {
                this.startAutoSync();
            }

            // Initialiser la structure dans CORE.db
            if (!CORE.db.pendingSyncs) CORE.db.pendingSyncs = [];
            if (!CORE.db.syncHistory) CORE.db.syncHistory = [];
        },

        // �v�nement: connexion r�tablie
        handleOnline() {
            this.state.isOnline = true;
            CORE.state.isOnline = true;
            this.state.consecutiveFailures = 0;
            
            UI.toast('��Ÿ�? � Connexion r�tablie!', 'success');
            
            // D�marrer la synchronisation automatique
            this.startAutoSync();
            
            // Tenter une sync imm�diate si des actions sont en attente
            const pendingCount = this.getPendingCount();
            if (pendingCount > 0) {
                setTimeout(() => {
                    this.syncAll();
                }, 2000);
            }
            
            App.rerender();
        },

        // �v�nement: connexion perdue
        handleOffline() {
            this.state.isOnline = false;
            CORE.state.isOnline = false;
            
            UI.toast('��š ��� � � Mode Hors Ligne - Les actions seront synchronis�es au retour de la connexion', 'warning');
            
            // Arr��ter l'auto-sync
            this.stopAutoSync();
            
            App.rerender();
        },

        // D�marrer la synchronisation automatique p�riodique
        startAutoSync() {
            this.stopAutoSync();
            this.state.autoSyncTimer = setInterval(() => {
                if (this.state.isOnline && !this.state.isSyncing && this.getPendingCount() > 0) {
                    this.syncAll();
                }
            }, this.config.autoSyncInterval);
        },

        // Arr��ter la synchronisation automatique
        stopAutoSync() {
            if (this.state.autoSyncTimer) {
                clearInterval(this.state.autoSyncTimer);
                this.state.autoSyncTimer = null;
            }
        },

        // Ajouter une action �� la file d'attente
        enqueue(action) {
            if (!CORE.db.pendingSyncs) CORE.db.pendingSyncs = [];
            
            // V�rifier la limite
            if (CORE.db.pendingSyncs.length >= this.config.maxQueueSize) {
                UI.toast('��š ��� � � File d\'attente pleine - supprimez d\'anciennes actions', 'error');
                return false;
            }

            const queueItem = {
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                ...action,
                queuedAt: new Date().toISOString(),
                retryCount: 0,
                status: 'pending', // pending, syncing, failed, success
                lastError: null
            };

            CORE.db.pendingSyncs.push(queueItem);
            CORE.save();
            
            // Notifier l'utilisateur
            this.updateIndicator();
            
            return queueItem.id;
        },

        // Obtenir le nombre d'actions en attente
        getPendingCount() {
            return (CORE.db.pendingSyncs || []).filter(s => s.status !== 'success').length;
        },

        // Obtenir toutes les actions en attente
        getPendingActions() {
            return (CORE.db.pendingSyncs || []).filter(s => s.status !== 'success');
        },

        // Synchroniser toutes les actions en attente
        async syncAll() {
            if (!this.state.isOnline) {
                UI.toast('��š ��� � � Impossible de synchroniser: hors ligne', 'warning');
                return { success: false, synced: 0, failed: 0 };
            }

            if (this.state.isSyncing) {
                return { success: false, synced: 0, failed: 0, reason: 'already_syncing' };
            }

            const pending = this.getPendingActions();
            if (pending.length === 0) {
                return { success: true, synced: 0, failed: 0 };
            }

            this.state.isSyncing = true;
            this.state.lastSyncAttempt = new Date().toISOString();
            this.updateIndicator('syncing', pending.length);

            let synced = 0;
            let failed = 0;

            for (let i = 0; i < pending.length; i++) {
                const action = pending[i];
                
                this.updateIndicator('syncing', pending.length, i + 1);
                
                try {
                    // Simuler la synchronisation (remplacer par vraie API)
                    await this.syncAction(action);
                    
                    // Marquer comme synchronis�
                    action.status = 'success';
                    action.syncedAt = new Date().toISOString();
                    synced++;
                    
                } catch (error) {
                    action.retryCount++;
                    action.lastError = error.message || 'Erreur inconnue';
                    
                    if (action.retryCount >= this.config.maxRetries) {
                        action.status = 'failed';
                        failed++;
                    } else {
                        action.status = 'pending';
                    }
                }
            }

            // Nettoyer les actions r�ussies
            CORE.db.pendingSyncs = CORE.db.pendingSyncs.filter(s => s.status !== 'success');
            
            // Sauvegarder l'historique de sync
            if (!CORE.db.syncHistory) CORE.db.syncHistory = [];
            CORE.db.syncHistory.push({
                date: new Date().toISOString(),
                synced,
                failed,
                remaining: CORE.db.pendingSyncs.length
            });
            
            // Limiter l'historique �� 50 entr�es
            if (CORE.db.syncHistory.length > 50) {
                CORE.db.syncHistory = CORE.db.syncHistory.slice(-50);
            }

            CORE.state.lastSync = new Date().toISOString();
            CORE.save();

            this.state.isSyncing = false;

            if (failed > 0) {
                this.state.consecutiveFailures++;
                this.updateIndicator('error', failed);
                UI.toast(`��š ��� � � ${synced} synchronis�e(s), ${failed} �chou�e(s)`, 'warning');
            } else if (synced > 0) {
                this.state.consecutiveFailures = 0;
                this.updateIndicator('success', synced);
                UI.toast(`���?� ${synced} action(s) synchronis�e(s)`, 'success');
            }

            App.rerender();

            return { success: failed === 0, synced, failed };
        },

        // Synchroniser une action individuelle (�� adapter selon l'API r�elle)
        async syncAction(action) {
            // Simuler un d�lai r�seau
            await new Promise(resolve => setTimeout(resolve, 200 + Math.random() * 300));
            
            // Simuler un taux de succ��s de 95%
            if (Math.random() < 0.05 && action.retryCount < 2) {
                throw new Error('Erreur r�seau temporaire');
            }
            
            // Ici on int�grerait la vraie synchronisation API
            // Par exemple:
            // await fetch('/api/sync', { method: 'POST', body: JSON.stringify(action) });
            
            return true;
        },

        // Supprimer une action de la file
        removeFromQueue(actionId) {
            const index = CORE.db.pendingSyncs.findIndex(a => a.id === actionId);
            if (index !== -1) {
                CORE.db.pendingSyncs.splice(index, 1);
                CORE.save();
                this.updateIndicator();
                return true;
            }
            return false;
        },

        // Vider la file d'attente
        clearQueue() {
            CORE.db.pendingSyncs = [];
            CORE.save();
            this.updateIndicator();
            UI.toast('File d\'attente vid�e', 'info');
        },

        // R�essayer les actions �chou�es
        async retryFailed() {
            const failed = (CORE.db.pendingSyncs || []).filter(s => s.status === 'failed');
            failed.forEach(a => {
                a.status = 'pending';
                a.retryCount = 0;
            });
            CORE.save();
            
            if (failed.length > 0) {
                return this.syncAll();
            }
            return { success: true, synced: 0, failed: 0 };
        },

        // Mettre �� jour l'indicateur visuel
        updateIndicator(status = 'idle', count = 0, current = 0) {
            const indicator = document.getElementById('offline-indicator');
            if (!indicator) return;

            const pendingCount = this.getPendingCount();
            const failedCount = (CORE.db.pendingSyncs || []).filter(s => s.status === 'failed').length;

            if (!this.state.isOnline) {
                indicator.innerHTML = `
                    <div class="flex items-center gap-2 px-3 py-2 bg-amber-500 text-white rounded-full shadow-lg cursor-pointer hover:bg-amber-600 transition" onclick="OfflineManager.showQueueModal()">
                        <i data-lucide="wifi-off" class="w-4 h-4"></i>
                        <span class="text-xs font-black">Hors ligne${pendingCount > 0 ? ` (${pendingCount})` : ''}</span>
                    </div>`;
            } else if (status === 'syncing') {
                indicator.innerHTML = `
                    <div class="flex items-center gap-2 px-3 py-2 bg-blue-500 text-white rounded-full shadow-lg animate-pulse">
                        <i data-lucide="refresh-cw" class="w-4 h-4 animate-spin"></i>
                        <span class="text-xs font-black">Sync ${current}/${count}...</span>
                    </div>`;
            } else if (status === 'error' || failedCount > 0) {
                indicator.innerHTML = `
                    <div class="flex items-center gap-2 px-3 py-2 bg-red-500 text-white rounded-full shadow-lg cursor-pointer hover:bg-red-600 transition" onclick="OfflineManager.showQueueModal()">
                        <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                        <span class="text-xs font-black">${failedCount} �chec(s)</span>
                    </div>`;
            } else if (status === 'success') {
                indicator.innerHTML = `
                    <div class="flex items-center gap-2 px-3 py-2 bg-emerald-500 text-white rounded-full shadow-lg">
                        <i data-lucide="check-circle" class="w-4 h-4"></i>
                        <span class="text-xs font-black">���?? Synchronis�</span>
                    </div>`;
                setTimeout(() => {
                    if (this.getPendingCount() === 0) {
                        indicator.innerHTML = '';
                    }
                }, 3000);
            } else if (pendingCount > 0) {
                indicator.innerHTML = `
                    <div class="flex items-center gap-2 px-3 py-2 bg-slate-700 text-white rounded-full shadow-lg cursor-pointer hover:bg-slate-800 transition" onclick="OfflineManager.showQueueModal()">
                        <i data-lucide="clock" class="w-4 h-4"></i>
                        <span class="text-xs font-black">${pendingCount} en attente</span>
                    </div>`;
            } else {
                indicator.innerHTML = '';
            }

            lucide.createIcons();
        },

        // Afficher le modal de gestion de la file d'attente
        showQueueModal() {
            const pending = CORE.db.pendingSyncs || [];
            const failed = pending.filter(a => a.status === 'failed');
            const waiting = pending.filter(a => a.status === 'pending');

            // Grouper par type d'action
            const grouped = {};
            pending.forEach(a => {
                const key = a.type || 'Autre';
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(a);
            });

            const typeLabels = {
                'create': '��ž� Cr�ations',
                'update': '���? ��� � � Modifications',
                'delete': '��Ÿ??�� � � Suppressions',
                'Autre': '��Ÿ?� Autres'
            };

            const typeColors = {
                'create': 'emerald',
                'update': 'blue',
                'delete': 'red',
                'Autre': 'slate'
            };

            let content = `
                <div class="space-y-4">
                    <!-- R�sum� -->
                    <div class="grid grid-cols-3 gap-3">
                        <div class="p-4 bg-slate-50 rounded-2xl text-center">
                            <div class="text-2xl font-black text-slate-900">${pending.length}</div>
                            <div class="text-xs text-slate-500">Total</div>
                        </div>
                        <div class="p-4 bg-amber-50 rounded-2xl text-center">
                            <div class="text-2xl font-black text-amber-600">${waiting.length}</div>
                            <div class="text-xs text-amber-700">En attente</div>
                        </div>
                        <div class="p-4 bg-red-50 rounded-2xl text-center">
                            <div class="text-2xl font-black text-red-600">${failed.length}</div>
                            <div class="text-xs text-red-700">�checs</div>
                        </div>
                    </div>

                    <!-- Statut connexion -->
                    <div class="p-4 rounded-2xl ${this.state.isOnline ? 'bg-emerald-50 border border-emerald-200' : 'bg-red-50 border border-red-200'}">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full ${this.state.isOnline ? 'bg-emerald-500' : 'bg-red-500'} animate-pulse"></div>
                            <div>
                                <div class="font-black ${this.state.isOnline ? 'text-emerald-800' : 'text-red-800'}">
                                    ${this.state.isOnline ? '��Ÿ�? � En ligne' : '��Ÿ? � Hors ligne'}
                                </div>
                                <div class="text-xs ${this.state.isOnline ? 'text-emerald-600' : 'text-red-600'}">
                                    Derni��re sync: ${CORE.state.lastSync ? new Date(CORE.state.lastSync).toLocaleString('fr-FR') : 'Jamais'}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions par type -->
                    ${pending.length > 0 ? `
                        <div class="space-y-3 max-h-64 overflow-y-auto">
                            ${Object.keys(grouped).map(type => `
                                <div class="p-3 bg-${typeColors[type] || 'slate'}-50 rounded-xl border border-${typeColors[type] || 'slate'}-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-black text-sm text-${typeColors[type] || 'slate'}-800">${typeLabels[type] || type}</span>
                                        <span class="text-xs font-bold text-${typeColors[type] || 'slate'}-600">${grouped[type].length}</span>
                                    </div>
                                    <div class="space-y-1">
                                        ${grouped[type].slice(0, 5).map(a => `
                                            <div class="flex items-center justify-between text-xs p-2 bg-white rounded-lg">
                                                <div class="flex-1 truncate">
                                                    <span class="${a.status === 'failed' ? 'text-red-600' : 'text-slate-600'}">${a.desc || a.collection || 'Action'}</span>
                                                    ${a.status === 'failed' ? `<span class="ml-1 text-red-500">(�chec)</span>` : ''}
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <span class="text-slate-400">${a.queuedAt ? new Date(a.queuedAt).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}) : ''}</span>
                                                    <button onclick="OfflineManager.removeFromQueue('${a.id}');OfflineManager.showQueueModal()" class="text-red-500 hover:text-red-700">
                                                        <i data-lucide="x" class="w-3 h-3"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                        ${grouped[type].length > 5 ? `<div class="text-xs text-center text-slate-400">+ ${grouped[type].length - 5} autres</div>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="p-8 text-center text-slate-400">
                            <i data-lucide="check-circle" class="w-12 h-12 mx-auto mb-3 text-emerald-400"></i>
                            <div class="font-bold">Aucune action en attente</div>
                            <div class="text-xs mt-1">Toutes les donn�es sont synchronis�es</div>
                        </div>
                    `}

                    <!-- Boutons d'action -->
                    ${pending.length > 0 ? `
                        <div class="flex flex-wrap gap-2">
                            ${this.state.isOnline ? `
                                <button onclick="OfflineManager.syncAll();UI.closeModal()" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-xl font-black hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    Synchroniser maintenant
                                </button>
                            ` : ''}
                            ${failed.length > 0 ? `
                                <button onclick="OfflineManager.retryFailed();UI.closeModal()" class="px-4 py-3 bg-amber-500 text-white rounded-xl font-black hover:bg-amber-600 transition flex items-center justify-center gap-2">
                                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                    R�essayer (${failed.length})
                                </button>
                            ` : ''}
                            <button onclick="if(confirm('Supprimer toutes les actions en attente?')){OfflineManager.clearQueue();UI.closeModal()}" class="px-4 py-3 bg-red-100 text-red-700 rounded-xl font-black hover:bg-red-200 transition">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;

            UI.modal('��Ÿ? � File de synchronisation', content, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-lg' });
        },

        // G�n�rer le badge de statut pour l'interface
        getStatusBadge() {
            const pending = this.getPendingCount();
            const failed = (CORE.db.pendingSyncs || []).filter(s => s.status === 'failed').length;

            if (!this.state.isOnline) {
                return `<span class="inline-flex items-center gap-1 px-2 py-1 bg-amber-100 text-amber-800 rounded-full text-xs font-bold">
                    <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span>
                    Hors ligne${pending > 0 ? ` (${pending})` : ''}
                </span>`;
            }
            
            if (failed > 0) {
                return `<span class="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-bold cursor-pointer" onclick="OfflineManager.showQueueModal()">
                    <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                    ${failed} �chec(s)
                </span>`;
            }
            
            if (pending > 0) {
                return `<span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold cursor-pointer" onclick="OfflineManager.showQueueModal()">
                    <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span>
                    ${pending} en attente
                </span>`;
            }

            return `<span class="inline-flex items-center gap-1 px-2 py-1 bg-emerald-100 text-emerald-800 rounded-full text-xs font-bold">
                <span class="w-2 h-2 bg-emerald-500 rounded-full"></span>
                En ligne
            </span>`;
        }
    };

    // Exposer globalement
    window.OfflineManager = OfflineManager;

    // =========================================================
    // UI
    // =========================================================
    const UI = {
        toast(message, type = 'success') {
            // V�rifier si les notifications sont activ�es
            const notificationsEnabled = VendeurModule.state?.preferences?.notificationsEnabled ?? CORE.state.preferences?.notificationsEnabled ?? true;
            if (!notificationsEnabled) {
                console.log('Notifications d�sactiv�es - toast non affich�:', message);
                return;
            }

            let container = document.getElementById('toastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'fixed top-5 right-5 z-[9999] flex flex-col gap-2 items-end pointer-events-none';
                document.body.appendChild(container);
            }
            const colors = { success: 'bg-emerald-600', error: 'bg-red-600', warning: 'bg-amber-500', info: 'bg-blue-600' };
            const icons = { success: 'check-circle', error: 'alert-circle', warning: 'alert-triangle', info: 'info' };

            const toast = document.createElement('div');
            toast.className = `toast pointer-events-auto ${colors[type] || colors.success} text-white px-4 py-3 rounded-xl shadow-xl flex items-center gap-3 min-w-[280px] backdrop-blur-md bg-opacity-95`;
            toast.innerHTML = `
                <i data-lucide="${icons[type] || icons.success}" class="w-5 h-5"></i>
                <span class="flex-1 font-medium text-sm">${message}</span>
                <button class="p-1.5 rounded-lg hover:bg-white/15 transition" aria-label="Fermer">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            `;
            container.appendChild(toast);
            lucide.createIcons();
            
            // ��Ÿ�Š Jouer le son de notification stylis�
            UI.playGenericNotificationSound(type);
            
            toast.querySelector('button').addEventListener('click', () => toast.remove());
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 250); }, 3500);
        },

        playNotificationSound() {
            try {
                // V�rifier si les sons sont activ�s
                const soundEnabled = CORE.state.preferences?.soundEnabled ?? VendeurModule.state.preferences?.soundEnabled ?? true;
                const volume = CORE.state.preferences?.soundVolume ?? VendeurModule.state.preferences?.soundVolume ?? 0.8;

                if (!soundEnabled) return;

                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const now = audioContext.currentTime;
                
                // Cr�er un son style Shopify - deux bips agr�ables
                const osc1 = audioContext.createOscillator();
                const osc2 = audioContext.createOscillator();
                const gain = audioContext.createGain();
                const gain2 = audioContext.createGain();
                
                // Premier bip (note haute - E4)
                osc1.frequency.setValueAtTime(329.63, now);
                osc1.type = 'sine';
                gain.gain.setValueAtTime(0.6 * volume, now);
                gain.gain.exponentialRampToValueAtTime(0.05 * volume, now + 0.15);
                
                osc1.connect(gain);
                gain.connect(audioContext.destination);
                
                osc1.start(now);
                osc1.stop(now + 0.15);
                
                // Deuxi��me bip (note plus haute - G4) avec d�lai
                osc2.frequency.setValueAtTime(391.995, now + 0.05);
                osc2.type = 'sine';
                gain2.gain.setValueAtTime(0.6 * volume, now + 0.05);
                gain2.gain.exponentialRampToValueAtTime(0.05 * volume, now + 0.25);
                
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                
                osc2.start(now + 0.05);
                osc2.stop(now + 0.25);
            } catch (e) {
                console.log('��Ÿ�Š Son de notification activ�');
            }
        },

        playGenericNotificationSound(type = 'success') {
            try {
                // V�rifier si les sons sont activ�s
                const soundEnabled = CORE.state.preferences?.soundEnabled ?? VendeurModule.state.preferences?.soundEnabled ?? true;
                const volume = CORE.state.preferences?.soundVolume ?? VendeurModule.state.preferences?.soundVolume ?? 0.8;

                if (!soundEnabled) return;

                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const now = audioContext.currentTime;
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                // Fr�quences diff�rentes selon le type
                const frequencies = {
                    success: 523.25,  // C5
                    error: 293.66,    // D4
                    warning: 440,     // A4
                    info: 349.23      // F4
                };
                
                const freq = frequencies[type] || frequencies.success;
                
                osc.frequency.setValueAtTime(freq, now);
                osc.type = 'sine';
                
                gain.gain.setValueAtTime(0.25 * volume, now);
                gain.gain.exponentialRampToValueAtTime(0.01 * volume, now + 0.2);
                
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.start(now);
                osc.stop(now + 0.2);
            } catch (e) {
                console.log('��Ÿ�Š Son de notification activ�');
            }
        },

        modal(title, content, actions = [], options = {}) {
            // Support pour l'ancienne signature avec onBack comme 4��me param��tre
            let onBack = null;
            let maxWidth = 'max-w-lg';
            let noPadding = false;
            
            if (typeof options === 'function') {
                onBack = options;
            } else if (typeof options === 'object' && options !== null) {
                onBack = options.onBack || null;
                maxWidth = options.maxWidth || 'max-w-lg';
                noPadding = options.noPadding || false;
            }
            
            let container = document.getElementById('modalContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'modalContainer';
                document.body.appendChild(container);
            }
            
            // Initialiser l'historique des modales s'il n'existe pas
            if (!window.modalStack) window.modalStack = [];
            if (!window.currentModalBack) window.currentModalBack = null;
            
            // Sauvegarder l'�tat actuel avant d'afficher la nouvelle modale
            const currentModal = container.innerHTML;
            if (currentModal && currentModal.length > 0) {
                window.modalStack.push(currentModal);
            }
            
            // Cr�er le bouton retour - TOUJOURS visible
            const backButtonHTML = `
                <button onclick="UI.goBack()" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition font-bold text-sm flex items-center gap-1" aria-label="Retour" title="Retour">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i> Retour
                </button>
            `;
            
            container.innerHTML = `
                <div class="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm" data-modal-overlay>
                    <div class="slide-up bg-white rounded-3xl shadow-2xl ${maxWidth} w-full max-h-[90vh] overflow-hidden flex flex-col" role="dialog" aria-modal="true" aria-label="${title}">
                        ${noPadding ? '' : `<div class="flex items-center justify-between p-6 border-b border-slate-100 bg-slate-50/50 gap-3">
                            ${backButtonHTML}
                            <h3 class="text-lg font-black text-slate-800 flex-1">${title}</h3>
                            <button onclick="UI.closeModal()" class="p-2 hover:bg-slate-200 rounded-full transition flex-shrink-0" aria-label="Fermer">
                                <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
                            </button>
                        </div>`}
                        <div class="modal-content ${noPadding ? '' : 'p-6'} overflow-y-auto">${content}</div>
                        ${actions.length > 0 ? `<div class="flex items-center justify-end gap-3 p-6 border-t border-slate-100 bg-slate-50">${actions.map(a => `<button onclick="${a.onclick}" class="${a.class || 'px-5 py-2.5 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200 transition'}">${a.label}</button>`).join('')}</div>` : ''}
                    </div>
                </div>`;
            
            // Sauvegarder le callback de retour
            if (onBack) {
                window.currentModalBack = onBack;
            }
            
            // Cr�er les ic��nes lucide
            setTimeout(() => {
                lucide.createIcons();
            }, 0);

            const overlay = container.querySelector('[data-modal-overlay]');
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) UI.closeModal();
            });

            // Focus first input if exists
            setTimeout(() => {
                const first = container.querySelector('input,select,textarea,button');
                if (first && first !== container.querySelector('[aria-label="Retour"]') && first !== container.querySelector('[aria-label="Fermer"]')) {
                    first.focus();
                }
            }, 0);
        },

        updateModalContent(content) {
            const container = document.querySelector('#modalContainer .modal-content');
            if (!container) return;
            container.innerHTML = content;
            setTimeout(() => {
                if (window.lucide) lucide.createIcons();
            }, 0);
        },

        confirm({ title, message, confirmLabel = 'Confirmer', confirmClass = 'bg-red-600 hover:bg-red-700 text-white', onConfirm }) {
            this.modal(title, `<p class="text-slate-600 font-medium">${message}</p>`, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: confirmLabel, onclick: `(${onConfirm.toString()})()`, class: `px-5 py-2.5 rounded-xl font-bold transition ${confirmClass}` }
            ]);
        },

        closeModal() { 
            document.getElementById('modalContainer').innerHTML = '';
            if (window.modalStack) window.modalStack = [];
            if (window.currentModalBack) window.currentModalBack = null;
        },

        goBack() {
            const container = document.getElementById('modalContainer');
            
            // Si on a un callback de retour personnalis�, l'utiliser
            if (window.currentModalBack) {
                const backFn = window.currentModalBack;
                window.currentModalBack = null;
                if (window.modalStack) window.modalStack.pop(); // Enlever la modale actuelle
                backFn();
                return;
            }
            
            // Sinon, restaurer la modale pr�c�dente de l'historique
            if (window.modalStack && window.modalStack.length > 0) {
                container.innerHTML = window.modalStack.pop();
                setTimeout(() => lucide.createIcons(), 0);
                
                const overlay = container.querySelector('[data-modal-overlay]');
                if (overlay) {
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) UI.closeModal();
                    });
                }
            } else {
                // Sinon, juste fermer la modale
                this.closeModal();
            }
        },

        badge(text, color = 'slate') {
            const colors = {
                slate: 'bg-slate-100 text-slate-600',
                emerald: 'bg-emerald-100 text-emerald-700',
                amber: 'bg-amber-100 text-amber-700',
                red: 'bg-red-100 text-red-700',
                blue: 'bg-blue-100 text-blue-700',
                purple: 'bg-purple-100 text-purple-700'
            };
            return `<span class="px-2.5 py-0.5 ${colors[color] || colors.slate} rounded-full text-xs font-bold border border-transparent bg-opacity-60">${text}</span>`;
        },

        input(id, label, type = 'text', value = '', placeholder = '', required = false) {
            return `
                <div>
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-wider mb-1.5">${label}${required ? ' *' : ''}</label>
                    <input type="${type}" id="${id}" value="${value}" placeholder="${placeholder}"
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:bg-white focus:border-transparent outline-none transition font-medium text-slate-800 placeholder-slate-400"
                        ${required ? 'required' : ''}>
                </div>`;
        },

        select(id, label, options, selected = '', required = false) {
            return `
                <div>
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-wider mb-1.5">${label}${required ? ' *' : ''}</label>
                    <select id="${id}" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:bg-white focus:border-transparent outline-none transition font-medium text-slate-800" ${required ? 'required' : ''}>
                        <option value="">S�lectionner...</option>
                        ${options.map(o => `<option value="${o.value}" ${String(o.value) === String(selected) ? 'selected' : ''}>${o.label}</option>`).join('')}
                    </select>
                </div>`;
        },

        textarea(id, label, value = '', placeholder = '', rows = 3) {
            return `
                <div>
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-wider mb-1.5">${label}</label>
                    <textarea id="${id}" rows="${rows}" placeholder="${placeholder}" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:bg-white focus:border-transparent outline-none transition font-medium text-slate-800 placeholder-slate-400">${value}</textarea>
                </div>`;
        },

        val(id) {
            const el = document.getElementById(id);
            return el ? el.value : '';
        }
    };

    const NotificationUtils = {
        severityConfig: {
            critical: {
                label: 'Critique',
                panel: 'border-l-4 border-l-red-600 bg-red-50 border border-red-200',
                badge: 'bg-red-200 text-red-800',
                dot: 'bg-red-500',
                chip: 'bg-red-600 text-white'
            },
            high: {
                label: '�lev�e',
                panel: 'border-l-4 border-l-orange-500 bg-orange-50 border border-orange-200',
                badge: 'bg-orange-200 text-orange-800',
                dot: 'bg-orange-500',
                chip: 'bg-orange-500 text-white'
            },
            medium: {
                label: 'Mod�r�e',
                panel: 'border-l-4 border-l-amber-500 bg-amber-50 border border-amber-200',
                badge: 'bg-amber-200 text-amber-800',
                dot: 'bg-amber-500',
                chip: 'bg-amber-500 text-white'
            },
            low: {
                label: 'Faible',
                panel: 'border-l-4 border-l-slate-400 bg-slate-50 border border-slate-200',
                badge: 'bg-slate-200 text-slate-700',
                dot: 'bg-slate-400',
                chip: 'bg-slate-500 text-white'
            },
            info: {
                label: 'Information',
                panel: 'border-l-4 border-l-blue-500 bg-blue-50 border border-blue-200',
                badge: 'bg-blue-200 text-blue-800',
                dot: 'bg-blue-500',
                chip: 'bg-blue-500 text-white'
            }
        },

        defaultFilters() {
            return {
                severity: 'all',
                period: '7d',
                type: 'all',
                search: '',
                showUnread: false
            };
        },

        ensureFilters(filters) {
            return { ...this.defaultFilters(), ...(filters || {}) };
        },

        normalizeSeverity(raw) {
            const map = {
                critical: 'critical',
                danger: 'critical',
                red: 'critical',
                high: 'high',
                warning: 'high',
                orange: 'high',
                amber: 'high',
                medium: 'medium',
                success: 'medium',
                yellow: 'medium',
                low: 'low',
                minor: 'low',
                green: 'low',
                info: 'info',
                blue: 'info'
            };
            const key = String(raw || 'info').toLowerCase();
            return map[key] || 'info';
        },

        getSeverityMeta(raw) {
            const key = this.normalizeSeverity(raw);
            return this.severityConfig[key] || this.severityConfig.info;
        },

        getTimestamp(notification) {
            if (!notification) return null;
            const value = notification.createdAt || notification.timestamp || notification.date || notification.created_at;
            if (!value) return null;
            const date = value instanceof Date ? value : new Date(value);
            return isNaN(date.getTime()) ? null : date;
        },

        matchesPeriod(date, period) {
            if (!period || period === 'all') return true;
            if (!date) return false;
            const now = new Date();
            const diff = now.getTime() - date.getTime();
            const day = 24 * 60 * 60 * 1000;
            if (period === '24h') return diff <= day;
            if (period === '7d') return diff <= day * 7;
            if (period === '30d') return diff <= day * 30;
            return true;
        },

        applyFilters(list, filters) {
            const f = this.ensureFilters(filters);
            const search = String(f.search || '').trim().toLowerCase();
            return list.filter(n => {
                const severity = this.normalizeSeverity(n.severity);
                if (f.severity !== 'all' && severity !== f.severity) return false;
                if (f.showUnread && n.read) return false;
                if (f.type !== 'all') {
                    const typeKey = n.type ? String(n.type) : '';
                    if (typeKey.toLowerCase() !== f.type.toLowerCase()) return false;
                }
                const ts = this.getTimestamp(n);
                if (!this.matchesPeriod(ts, f.period)) return false;
                if (search) {
                    const haystack = [n.title, n.message, n.type, n.relatedTo].map(part => String(part || '').toLowerCase()).join(' ');
                    if (!haystack.includes(search)) return false;
                }
                return true;
            });
        },

        groupByDate(list) {
            const buckets = {};
            list.forEach(item => {
                const date = this.getTimestamp(item);
                const key = date ? date.toISOString().slice(0, 10) : 'unknown';
                if (!buckets[key]) buckets[key] = [];
                buckets[key].push(item);
            });

            return Object.entries(buckets)
                .sort((a, b) => {
                    if (a[0] === 'unknown') return 1;
                    if (b[0] === 'unknown') return -1;
                    return new Date(b[0]) - new Date(a[0]);
                })
                .map(([key, items]) => ({
                    key,
                    label: this.formatDateLabel(key),
                    items: items.sort((a, b) => {
                        const tsA = this.getTimestamp(a) || 0;
                        const tsB = this.getTimestamp(b) || 0;
                        return tsB - tsA;
                    })
                }));
        },

        formatDateLabel(key) {
            if (key === 'unknown') return 'Date inconnue';
            const date = new Date(key);
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);

            const isSameDay = (d1, d2) => d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();

            if (isSameDay(date, today)) return 'Aujourd\'hui';
            if (isSameDay(date, yesterday)) return 'Hier';

            return date.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
        },

        formatRelative(date) {
            if (!date) return 'Date inconnue';
            const now = new Date();
            const diff = now.getTime() - date.getTime();
            const minute = 60 * 1000;
            const hour = 60 * minute;
            const day = 24 * hour;
            if (diff < minute) return '�� l\'instant';
            if (diff < hour) {
                const mins = Math.floor(diff / minute);
                return `il y a ${mins} min`;
            }
            if (diff < day) {
                const hours = Math.floor(diff / hour);
                return `il y a ${hours} h`;
            }
            const days = Math.floor(diff / day);
            if (days < 30) return `il y a ${days} j`;
            return date.toLocaleDateString('fr-FR');
        },

        getTypeOptions(list) {
            const set = new Set();
            list.forEach(item => {
                if (item.type) set.add(String(item.type));
            });
            return Array.from(set).sort((a, b) => a.localeCompare(b));
        },

        getTypeLabel(type) {
            if (!type) return 'Syst��me';
            return String(type)
                .replace(/_/g, ' ')
                .replace(/\s+/g, ' ')
                .trim()
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        },

        escape(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        },

        countBySeverity(list) {
            const counts = { all: list.length, critical: 0, high: 0, medium: 0, low: 0, info: 0 };
            list.forEach(item => {
                const key = this.normalizeSeverity(item.severity);
                counts[key] = (counts[key] || 0) + 1;
            });
            return counts;
        }
    };

    // ========== ROUTING & LOAD BALANCING ==========
    const RoutingEngine = {
        getUnassignedDeliveries(posId = null) {
            return (CORE.db.deliveries || []).filter(d => !d.livreurId && d.status !== 'livree' && d.status !== 'cancelled' && (!posId || d.posId === posId));
        },
        getLivreurLoad(livreurId) {
            const pending = (CORE.db.deliveries || []).filter(d => d.livreurId === livreurId && ['en_cours','en_attente'].includes(d.status));
            const totalVolume = pending.reduce((a, d) => a + (d.amount || 0), 0);
            return { count: pending.length, volume: totalVolume };
        },
        getAvailableLivreurs(posId, zoneId = null) {
            const users = CORE.getLivreursForPOS(posId);
            return users.map(u => ({
                ...u,
                load: this.getLivreurLoad(u.id),
                capacity: 5,
                available: this.getLivreurLoad(u.id).count < 5
            }));
        },
        getDeliveryPriority(delivery) {
            const order = CORE.db.orders.find(o => o.id === delivery.orderId);
            if (!order) return 1;
            let score = 1;
            if (order.tags && order.tags.includes('express')) score += 10;
            if (order.tags && order.tags.includes('vip')) score += 5;
            const createdTime = new Date(order.createdAt);
            const ageMins = (Date.now() - createdTime) / 60000;
            score += Math.min(5, ageMins / 60);
            return score;
        },
        suggestAssignment(delivery, posId) {
            const livreurs = this.getAvailableLivreurs(posId, delivery.zoneId);
            if (livreurs.length === 0) return null;
            const inZone = livreurs.filter(l => l.zoneId === delivery.zoneId);
            const candidates = inZone.length > 0 ? inZone : livreurs;
            const best = candidates.reduce((a, b) => a.load.count < b.load.count ? a : b);
            return best;
        },
        suggestRouteBatch(posId, limit = 10) {
            const unassigned = this.getUnassignedDeliveries(posId).slice(0, limit);
            const sorted = unassigned.sort((a, b) => this.getDeliveryPriority(b) - this.getDeliveryPriority(a));
            return sorted.map(d => ({
                delivery: d,
                priority: this.getDeliveryPriority(d),
                suggestion: this.suggestAssignment(d, posId),
                reason: d.status === 'pending' ? 'new' : 'pending'
            }));
        },
        autoAssignBatch(posId, limit = 10) {
            const batch = this.suggestRouteBatch(posId, limit);
            let assigned = 0;
            batch.forEach(item => {
                if (item.suggestion) {
                    CORE.update('deliveries', item.delivery.id, {
                        livreurId: item.suggestion.id,
                        status: 'en_attente'
                    });
                    assigned += 1;
                }
            });
            return assigned;
        },

        // =====================
        // GESTION DES UTILISATEURS (MANAGER)
        // =====================
        showUsersManagementModal() {
            const users = (CORE.db.users || []).filter(u => {
                // Le Manager ne voit le PDG que si pdg_manager_access est activ�
                if (u.role === 'pdg' && !CORE.getSystemSetting('pdg_manager_access', false)) {
                    return false;
                }
                return true;
            });
            
            UI.modal('Gestion des Utilisateurs', `
                <div class="mb-4">
                    <button onclick="ManagerModule.showAddUserModal()" class="w-full px-4 py-3 ${CORE.getSystemSetting('manager_manage_users', false) ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-slate-400 cursor-not-allowed'} text-white rounded-xl text-sm font-black transition" ${!CORE.getSystemSetting('manager_manage_users', false) ? 'disabled' : ''}>
                        + Ajouter un utilisateur ${!CORE.getSystemSetting('manager_manage_users', false) ? '(Non autoris�)' : ''}
                    </button>
                </div>
                <div class="space-y-4 max-h-[50vh] overflow-y-auto">
                    ${users.length === 0 ? '<div class="p-4 text-center text-slate-500">Aucun utilisateur �� g�rer</div>' : users.map(u => `
                        <div class="p-4 rounded-2xl border border-slate-200 bg-white">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex items-center gap-3 flex-1">
                                    ${u.profileImage ? `<img src="${u.profileImage}" class="w-12 h-12 rounded-xl object-cover">` : `<div class="w-12 h-12 gradient-${u.role} rounded-xl flex items-center justify-center text-white font-black text-sm">${u.avatar}</div>`}
                                    <div class="flex-1">
                                        <div class="font-black text-slate-900">${u.name}</div>
                                        <div class="text-xs text-slate-500 space-y-1">
                                            <div>Role: <span class="font-bold text-slate-700">${u.role}</span></div>
                                            <div>Identifiant: <span class="font-mono text-emerald-600">${u.username || 'N/A'}</span></div>
                                            <div>Mot de passe: <span class="font-mono text-cyan-600">${u.password || 'N/A'}</span></div>
                                            <div>Statut: <span class="font-bold ${u.active ? 'text-emerald-600' : 'text-red-600'}">${u.active ? 'Actif' : 'Inactif'}</span></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <button onclick="ManagerModule.showUserDetailsModal(${u.id})" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-xs font-black hover:bg-indigo-700 transition">��Ÿ?� D�tails</button>
                                    <button onclick="ManagerModule.showEditUserModal(${u.id})" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-black hover:bg-blue-700 transition">Modifier</button>
                                    <button onclick="ManagerModule.toggleUserActive(${u.id})" class="px-3 py-2 ${u.active ? 'bg-red-600 hover:bg-red-700' : 'bg-emerald-600 hover:bg-emerald-700'} text-white rounded-lg text-xs font-black transition">${u.active ? 'D�sactiver' : 'Activer'}</button>
                                    <button onclick="ManagerModule.showChangePasswordModal(${u.id})" class="px-3 py-2 bg-amber-600 text-white rounded-lg text-xs font-black hover:bg-amber-700 transition">Mot de passe</button>
                                    <button onclick="ManagerModule.deleteUser(${u.id})" class="px-3 py-2 ${CORE.getSystemSetting('manager_manage_users', false) ? 'bg-rose-600 hover:bg-rose-700' : 'bg-slate-400 cursor-not-allowed'} text-white rounded-lg text-xs font-black transition" ${!CORE.getSystemSetting('manager_manage_users', false) ? 'disabled' : ''}>��Ÿ??�� � � Supprimer</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showUserDetailsModal(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');

            // V�rifier que le Manager peut voir le PDG
            if (user.role === 'pdg' && !CORE.getSystemSetting('pdg_manager_access', false)) {
                return UI.toast('Vous n\'avez pas la permission de voir les d�tails du PDG', 'error');
            }

            const roleColors = {
                'pdg': 'text-purple-700 bg-purple-50',
                'manager': 'text-blue-700 bg-blue-50',
                'gestionnaire': 'text-slate-700 bg-slate-50',
                'vendeur': 'text-emerald-700 bg-emerald-50',
                'livreur': 'text-orange-700 bg-orange-50'
            };

            const roleColor = roleColors[user.role] || 'text-slate-700 bg-slate-50';

            UI.modal(`D�tails: ${user.name}`, `
                <div class="space-y-4 max-h-[60vh] overflow-y-auto">
                    <div class="flex items-start gap-4 pb-4 border-b border-slate-200">
                        <div>
                            ${user.profileImage && typeof user.profileImage === 'string' && user.profileImage.trim() ? `<img src="${user.profileImage}" class="w-20 h-20 rounded-xl object-cover" onerror="this.style.display='none'">` : `<div class="w-20 h-20 gradient-${user.role} rounded-xl flex items-center justify-center text-white font-black text-2xl">${user.avatar}</div>`}
                        </div>
                        <div class="flex-1">
                            <div class="font-black text-lg text-slate-900">${user.name}</div>
                            <div class="text-xs font-bold ${roleColor} px-3 py-1 rounded-full inline-block mt-2">${user.role.toUpperCase()}</div>
                            <div class="text-xs text-slate-600 mt-2">ID: ${user.id}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 rounded-lg bg-slate-50">
                            <div class="text-xs font-black text-slate-600 uppercase">Identifiant</div>
                            <div class="text-sm font-mono text-slate-900 mt-1">${user.username || 'N/A'}</div>
                        </div>
                        <div class="p-3 rounded-lg bg-slate-50">
                            <div class="text-xs font-black text-slate-600 uppercase">Mot de passe</div>
                            <div class="text-sm font-mono text-slate-900 mt-1">${user.password || 'N/A'}</div>
                        </div>
                    </div>

                    <div class="p-3 rounded-lg bg-emerald-50 border border-emerald-200">
                        <div class="text-xs font-black text-emerald-700 uppercase">Statut</div>
                        <div class="text-sm font-bold text-emerald-900 mt-1">${user.active ? '���?? Actif' : '���?? Inactif'}</div>
                    </div>

                    ${user.city ? `<div class="p-3 rounded-lg bg-cyan-50 border border-cyan-200">
                        <div class="text-xs font-black text-cyan-700 uppercase">Ville</div>
                        <div class="text-sm text-cyan-900 mt-1">${(() => {
                            const city = CORE.db.cities?.find(c => c.id === user.city);
                            return city ? city.name : 'N/A';
                        })()}</div>
                    </div>` : ''}

                    ${user.pos ? `<div class="p-3 rounded-lg bg-lime-50 border border-lime-200">
                        <div class="text-xs font-black text-lime-700 uppercase">Point de Vente</div>
                        <div class="text-sm text-lime-900 mt-1">${(() => {
                            const pos = CORE.db.pointsOfSale?.find(p => p.id === user.pos);
                            return pos ? pos.name : 'N/A';
                        })()}</div>
                    </div>` : ''}

                    ${user.bio ? `<div class="p-3 rounded-lg bg-blue-50 border border-blue-200">
                        <div class="text-xs font-black text-blue-700 uppercase">Bio</div>
                        <div class="text-sm text-blue-900 mt-1">${user.bio}</div>
                    </div>` : ''}

                    ${user.specialties ? `<div class="p-3 rounded-lg bg-indigo-50 border border-indigo-200">
                        <div class="text-xs font-black text-indigo-700 uppercase">Sp�cialit�s</div>
                        <div class="text-sm text-indigo-900 mt-1">${user.specialties.join(', ')}</div>
                    </div>` : ''}

                    ${user.rating || user.totalSales || user.salesCount ? `<div class="grid grid-cols-3 gap-3">
                        ${user.rating ? `<div class="p-3 rounded-lg bg-yellow-50">
                            <div class="text-xs font-black text-yellow-700 uppercase">Note</div>
                            <div class="text-lg font-black text-yellow-900 mt-1">�� � � ${user.rating}</div>
                        </div>` : ''}
                        ${user.totalSales ? `<div class="p-3 rounded-lg bg-purple-50">
                            <div class="text-xs font-black text-purple-700 uppercase">Ventes</div>
                            <div class="text-sm text-purple-900 mt-1">${CORE.formatPrice(user.totalSales)}</div>
                        </div>` : ''}
                        ${user.salesCount ? `<div class="p-3 rounded-lg bg-pink-50">
                            <div class="text-xs font-black text-pink-700 uppercase">Nb Ventes</div>
                            <div class="text-lg font-black text-pink-900 mt-1">${user.salesCount}</div>
                        </div>` : ''}
                    </div>` : ''}

                    ${user.badge ? `<div class="p-3 rounded-lg bg-yellow-50 border border-yellow-200">
                        <div class="text-xs font-black text-yellow-700 uppercase">Badge</div>
                        <div class="text-sm text-yellow-900 mt-1">${(() => {
                            const badge = CORE.db.vendorBadges?.find(b => b.id === user.badge);
                            return badge ? badge.label : user.badge;
                        })()}</div>
                    </div>` : ''}

                    ${user.deliveryCount ? `<div class="p-3 rounded-lg bg-orange-50 border border-orange-200">
                        <div class="text-xs font-black text-orange-700 uppercase">Livraisons effectu�es</div>
                        <div class="text-sm font-black text-orange-900 mt-1">${user.deliveryCount}</div>
                    </div>` : ''}

                    ${user.phone ? `<div class="p-3 rounded-lg bg-teal-50 border border-teal-200">
                        <div class="text-xs font-black text-teal-700 uppercase">T�l�phone</div>
                        <div class="text-sm text-teal-900 mt-1">${user.phone}</div>
                    </div>` : ''}

                    ${user.vehicle ? `<div class="p-3 rounded-lg bg-red-50 border border-red-200">
                        <div class="text-xs font-black text-red-700 uppercase">V�hicule</div>
                        <div class="text-sm text-red-900 mt-1">${user.vehicle}</div>
                    </div>` : ''}

                    ${user.joinedDate ? `<div class="p-3 rounded-lg bg-gray-50 border border-gray-200">
                        <div class="text-xs font-black text-gray-700 uppercase">Date d'adh�sion</div>
                        <div class="text-sm text-gray-900 mt-1">${user.joinedDate}</div>
                    </div>` : ''}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showEditUserModal(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');
            
            // V�rifier que le Manager n'essaie pas de modifier le PDG sans permission
            if (user.role === 'pdg' && !CORE.getSystemSetting('pdg_manager_access', false)) {
                return UI.toast('Vous n\'avez pas la permission de modifier le PDG', 'error');
            }

            UI.modal(`Modifier: ${user.name}`, `
                <div class="space-y-4">
                    <div id="user-edit-save-status" class="hidden p-3 bg-emerald-100 border border-emerald-300 rounded-lg text-sm text-emerald-700 font-bold flex items-center gap-2">
                        <span>���?? Sauvegard� automatiquement</span>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Identifiant</label>
                        <input type="text" id="edit-username" value="${user.username || ''}" placeholder="Identifiant" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none" onchange="ManagerModule.autoSaveEditUser(${userId})">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">R��le</label>
                        <select id="edit-role" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none" onchange="ManagerModule.autoSaveEditUser(${userId})">
                            <option value="pdg" ${user.role === 'pdg' ? 'selected' : ''}>PDG</option>
                            <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Manager</option>
                            <option value="gestionnaire" ${user.role === 'gestionnaire' ? 'selected' : ''}>Gestionnaire</option>
                            <option value="vendeur" ${user.role === 'vendeur' ? 'selected' : ''}>Vendeur</option>
                            <option value="livreur" ${user.role === 'livreur' ? 'selected' : ''}>Livreur</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 p-4 bg-red-50 border border-red-200 rounded-2xl">
                    <div class="text-xs font-black text-red-700 mb-3">��Ÿ� � R�initialiser le mot de passe</div>
                    <button onclick="ManagerModule.resetUserPassword(${userId})" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg text-xs font-black hover:bg-red-700 transition">
                        R�initialiser le mot de passe
                    </button>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        autoSaveEditUser(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');

            const newUsername = document.getElementById('edit-username')?.value?.trim();
            const newRole = document.getElementById('edit-role')?.value;

            if (!newUsername) return UI.toast('L\'identifiant est requis', 'warning');

            // V�rifier que l'identifiant n'existe pas ailleurs
            const exists = CORE.db.users.some(u => u.id !== userId && u.username === newUsername);
            if (exists) return UI.toast('Cet identifiant existe d�j��', 'error');

            user.username = newUsername;
            user.role = newRole || user.role;

            CORE.save();
            
            // Afficher le message de sauvegarde
            const statusDiv = document.getElementById('user-edit-save-status');
            if (statusDiv) {
                statusDiv.classList.remove('hidden');
                setTimeout(() => statusDiv.classList.add('hidden'), 2000);
            }
        },

        saveEditUser(userId) {

            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');

            const newUsername = document.getElementById('edit-username')?.value?.trim();
            const newRole = document.getElementById('edit-role')?.value;

            if (!newUsername) return UI.toast('L\'identifiant est requis', 'warning');

            // V�rifier que l'identifiant n'existe pas ailleurs
            const exists = CORE.db.users.some(u => u.id !== userId && u.username === newUsername);
            if (exists) return UI.toast('Cet identifiant existe d�j��', 'error');

            user.username = newUsername;
            user.role = newRole || user.role;

            CORE.save();
            UI.toast('Utilisateur modifi� avec succ��s', 'success');
            UI.closeModal();
            this.showUsersManagementModal();
        },

        resetUserPassword(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');
            
            // V�rifier que le Manager n'essaie pas de modifier le mot de passe du PDG sans permission
            if (user.role === 'pdg' && !CORE.getSystemSetting('pdg_manager_access', false)) {
                return UI.toast('Vous n\'avez pas la permission de r�initialiser le mot de passe du PDG', 'error');
            }

            // R�initialiser �� un mot de passe par d�faut : "123456"
            Utils.md5('123456').then(hash => {
                user.password = '123456';
                user.passwordHash = hash;
                CORE.save();
                UI.toast(`���?? Mot de passe de ${user.name} r�initialis� �� "123456"`, 'success');
                UI.closeModal();
                this.showUsersManagementModal();
            });
        },

        showChangePasswordModal(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');
            
            // V�rifier que le Manager n'essaie pas de modifier le mot de passe du PDG sans permission
            if (user.role === 'pdg' && !CORE.getSystemSetting('pdg_manager_access', false)) {
                return UI.toast('Vous n\'avez pas la permission de modifier le mot de passe du PDG', 'error');
            }

            UI.modal(`Changer le mot de passe: ${user.name}`, `
                <div class="space-y-4">
                    <div id="password-change-save-status" class="hidden p-3 bg-emerald-100 border border-emerald-300 rounded-lg text-sm text-emerald-700 font-bold flex items-center gap-2">
                        <span>���?? Mot de passe chang� automatiquement</span>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4 mb-4">
                        <div class="text-sm text-blue-800">
                            <div class="font-black mb-2">��š ��� � � Attention</div>
                            <div>Le mot de passe sera chang� d��s que vous validez. L'utilisateur devra se reconnecter.</div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Nouveau mot de passe</label>
                        <input type="password" id="change-password-input" placeholder="Entrez le nouveau mot de passe" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-amber-500 focus:outline-none">
                        <div class="text-xs text-slate-500 mt-2">Minimum 6 caract��res requis</div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            
            // Ajouter l'�v�nement onchange pour sauvegarder automatiquement
            setTimeout(() => {
                const passwordInput = document.getElementById('change-password-input');
                if (passwordInput) {
                    passwordInput.addEventListener('blur', () => {
                        const pwd = passwordInput.value;
                        if (pwd.length >= 6) {
                            ManagerModule.autoSavePasswordChange(userId);
                        }
                    });
                    passwordInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && passwordInput.value.length >= 6) {
                            ManagerModule.autoSavePasswordChange(userId);
                        }
                    });
                }
            }, 100);
        },

        autoSavePasswordChange(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');

            const newPassword = document.getElementById('change-password-input')?.value || '';
            if (newPassword.length < 6) return UI.toast('Le mot de passe doit avoir au minimum 6 caract��res', 'warning');

            // Hacher le nouveau mot de passe
            Utils.md5(newPassword).then(hash => {
                user.password = newPassword;
                user.passwordHash = hash;
                CORE.save();
                
                // Afficher le message de sauvegarde
                const statusDiv = document.getElementById('password-change-save-status');
                if (statusDiv) {
                    statusDiv.classList.remove('hidden');
                    setTimeout(() => {
                        UI.closeModal();
                        UI.toast(`Mot de passe de ${user.name} chang� avec succ��s`, 'success');
                        ManagerModule.showUsersManagementModal();
                    }, 1500);
                }
            });
        },

        savePasswordChange(userId) {
            // La sauvegarde se fait automatiquement via autoSavePasswordChange
            const user = CORE.getUser(userId);
            if (!user) return;
            ManagerModule.showUsersManagementModal();
        },

        toggleUserActive(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');
            
            // V�rifier que le Manager n'essaie pas de d�sactiver le PDG sans permission
            if (user.role === 'pdg' && !CORE.getSystemSetting('pdg_manager_access', false)) {
                return UI.toast('Vous n\'avez pas la permission de modifier l\'�tat du PDG', 'error');
            }

            user.active = !user.active;
            CORE.save();
            UI.toast(`${user.name} est maintenant ${user.active ? 'actif' : 'inactif'}`, 'info');
            this.showUsersManagementModal();
        },

        // ========== GESTION DES PARAM�?TRES LIVREUR ==========
        showDeliveryFeaturesSettings() {
            const settings = CORE.getGestionnaireSettings();
            
            const modalContent = `
                <div class="space-y-5">
                    <!-- HEADER -->
                    <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl">
                        <h3 class="font-black text-slate-900">��Ÿšš Param��tres des fonctionnalit�s livreur</h3>
                        <p class="text-sm text-slate-600 mt-1">Activez ou d�sactivez les fonctionnalit�s disponibles pour les livreurs</p>
                    </div>

                    <!-- VALIDATION PAR PHOTO -->
                    <div class="p-5 border-2 border-slate-200 rounded-xl hover:shadow-md transition">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h4 class="font-black text-slate-900">��Ÿ? � Validation par photo</h4>
                                <p class="text-sm text-slate-600 mt-1">Les livreurs doivent prendre une photo pour valider les livraisons</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="feature_photo" ${settings.deliveryPhotoValidationEnabled ? 'checked' : ''} class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                            </label>
                        </div>
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-800">
                            <span class="font-bold">��? ��� � � Impact:</span> Obligation de preuve photo pour chaque livraison (tra��abilit� accrue)
                        </div>
                    </div>

                    <!-- SIGNATURE CLIENT -->
                    <div class="p-5 border-2 border-slate-200 rounded-xl hover:shadow-md transition opacity-60">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h4 class="font-black text-slate-900">���? ��� � � Signature client (Prochainement)</h4>
                                <p class="text-sm text-slate-600 mt-1">Demander la signature �lectronique du client</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="feature_signature" ${settings.deliveryPhotoSignatureEnabled ? 'checked' : ''} disabled class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-300 rounded-full"></div>
                            </label>
                        </div>
                        <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-xs text-amber-800">
                            <span class="font-bold">�� � � Status:</span> Fonctionnalit� en d�veloppement
                        </div>
                    </div>

                    <!-- G�OLOCALISATION -->
                    <div class="p-5 border-2 border-slate-200 rounded-xl hover:shadow-md transition opacity-60">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h4 class="font-black text-slate-900">��Ÿ? � G�olocalisation GPS (Prochainement)</h4>
                                <p class="text-sm text-slate-600 mt-1">Enregistrer la position GPS lors de chaque livraison</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="feature_gps" ${settings.deliveryPhotoGPSEnabled ? 'checked' : ''} disabled class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-300 rounded-full"></div>
                            </label>
                        </div>
                        <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-xs text-amber-800">
                            <span class="font-bold">�� � � Status:</span> Fonctionnalit� en d�veloppement
                        </div>
                    </div>

                    <!-- NOTATION CLIENT -->
                    <div class="p-5 border-2 border-slate-200 rounded-xl hover:shadow-md transition">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h4 class="font-black text-slate-900">�� � � Notation des clients</h4>
                                <p class="text-sm text-slate-600 mt-1">Les clients peuvent �valuer les livreurs apr��s livraison</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="feature_rating" ${settings.deliveryRatingEnabled ? 'checked' : ''} class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                            </label>
                        </div>
                        <div class="p-3 bg-purple-50 border border-purple-200 rounded-lg text-xs text-purple-800">
                            <span class="font-bold">��? ��� � � Impact:</span> Am�liore la qualit� du service et la responsabilit� des livreurs
                        </div>
                    </div>

                    <!-- R�SUM� DES STATUTS -->
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
                        <div class="font-black text-slate-900 mb-3">���?� R�sum�</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full ${settings.deliveryPhotoValidationEnabled ? 'bg-emerald-500' : 'bg-slate-300'} flex items-center justify-center text-white text-xs font-bold">���??</span>
                                <span class="text-slate-700">Validation par photo: <span class="font-bold">${settings.deliveryPhotoValidationEnabled ? '��ŸŸ � ACTIV�' : '��Ÿ� � D�SACTIV�'}</span></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full ${settings.deliveryRatingEnabled ? 'bg-emerald-500' : 'bg-slate-300'} flex items-center justify-center text-white text-xs font-bold">���??</span>
                                <span class="text-slate-700">Notation clients: <span class="font-bold">${settings.deliveryRatingEnabled ? '��ŸŸ � ACTIV�' : '��Ÿ� � D�SACTIV�'}</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- CONSEIL -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-800">
                        <span class="font-bold">��Ÿ? � Conseil:</span> Activez la validation par photo pour am�liorer la tra��abilit� et r�duire les litiges avec les clients.
                    </div>
                </div>
            `;

            UI.modal(`��š ?��� � � Param��tres des fonctionnalit�s livreur`, modalContent, [
                { label: 'Enregistrer', onclick: 'ManagerModule.saveDeliveryFeaturesSettings()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);

            lucide.createIcons();
        },

        saveDeliveryFeaturesSettings() {
            const settings = CORE.getGestionnaireSettings();

            // R�cup�rer les valeurs des checkboxes
            settings.deliveryPhotoValidationEnabled = document.getElementById('feature_photo')?.checked || false;
            settings.deliveryRatingEnabled = document.getElementById('feature_rating')?.checked || false;

            // Sauvegarder
            CORE.setGestionnaireSettings(settings);

            UI.closeModal();
            UI.toast('���?� Param��tres de livraison enregistr�s!', 'success');
        },

        loadUserPreferences() {
            const user = CORE.state.currentUser;
            if (!user) return;

            // Charger le th��me sauvegard�
            const savedTheme = localStorage.getItem('user_theme_' + user.id);
            if (savedTheme) {
                // this.applyTheme(savedTheme); // Si la m�thode existe
            }

            // Charger les autres pr�f�rences
            const userPrefs = CORE.db.userPreferences?.find(p => p.userId === user.id);
            if (userPrefs?.compactMode) {
                document.body.classList.add('compact-mode');
            }

            // Initialiser les raccourcis clavier
            if (this.setupKeyboardShortcuts) {
                this.setupKeyboardShortcuts();
            }
        },

        showAddUserModal() {
            // V�rifier si le PDG a autoris� le Manager �� ajouter des utilisateurs
            if (!CORE.getSystemSetting('manager_manage_users', false)) {
                return UI.toast('Le PDG n\'a pas autoris� l\'ajout d\'utilisateurs par le Manager', 'error');
            }
            
            UI.modal('Ajouter un nouvel utilisateur', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Nom complet</label>
                        <input type="text" id="add-name" placeholder="Nom de l'utilisateur" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Identifiant</label>
                        <input type="text" id="add-username" placeholder="Identifiant unique" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Mot de passe initial</label>
                        <input type="password" id="add-password" placeholder="Mot de passe temporaire" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                        <div class="text-xs text-slate-500 mt-2">Minimum 6 caract��res</div>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">R��le</label>
                        <select id="add-role" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                            <option value="gestionnaire">Gestionnaire</option>
                            <option value="vendeur">Vendeur</option>
                            <option value="livreur">Livreur</option>
                            <option value="manager">Manager</option>
                            <option value="pdg">PDG</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Avatar (2 caract��res)</label>
                        <input type="text" id="add-avatar" placeholder="Ex: JD" maxlength="2" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                    </div>
                </div>
            `, [
                { label: 'Demander l\'ajout', onclick: 'ManagerModule.requestAddUser()' },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        requestAddUser() {
            const name = document.getElementById('add-name')?.value?.trim() || '';
            const username = document.getElementById('add-username')?.value?.trim() || '';
            const password = document.getElementById('add-password')?.value || '';
            const role = document.getElementById('add-role')?.value || 'gestionnaire';
            const avatar = document.getElementById('add-avatar')?.value?.trim().toUpperCase() || 'XX';

            if (!name || !username || !password) return UI.toast('Tous les champs sont requis', 'warning');
            if (password.length < 6) return UI.toast('Le mot de passe doit avoir au minimum 6 caract��res', 'warning');

            // V�rifier que l'identifiant n'existe pas (ni dans les utilisateurs, ni dans les demandes approuv�es)
            const exists = CORE.db.users.some(u => u.username === username);
            if (exists) return UI.toast('Cet identifiant existe d�j��', 'error');

            // Hacher le mot de passe
            Utils.md5(password).then(hash => {
                const currentUser = CORE.state.currentUser;
                const request = {
                    id: Math.max(...(CORE.db.userAdditionRequests || []).map(r => r.id || 0), 0) + 1,
                    name,
                    username,
                    password,
                    passwordHash: hash,
                    role,
                    avatar,
                    requestedBy: currentUser.id,
                    requestedByName: currentUser.name,
                    requestedAt: new Date().toISOString(),
                    status: 'pending',
                    approvedBy: null,
                    approvedByName: null,
                    approvedAt: null,
                    rejectionReason: null
                };

                if (!CORE.db.userAdditionRequests) CORE.db.userAdditionRequests = [];
                CORE.db.userAdditionRequests.push(request);
                CORE.save();
                UI.toast(`Demande d'ajout de ${name} envoy�e au PDG pour approbation`, 'success');
                UI.closeModal();
                this.showUsersManagementModal();
            });
        },

        saveNewUser() {
            const name = document.getElementById('add-name')?.value?.trim() || '';
            const username = document.getElementById('add-username')?.value?.trim() || '';
            const password = document.getElementById('add-password')?.value || '';
            const role = document.getElementById('add-role')?.value || 'gestionnaire';
            const avatar = document.getElementById('add-avatar')?.value?.trim().toUpperCase() || 'XX';

            if (!name || !username || !password) return UI.toast('Tous les champs sont requis', 'warning');
            if (password.length < 6) return UI.toast('Le mot de passe doit avoir au minimum 6 caract��res', 'warning');

            // V�rifier que l'identifiant n'existe pas
            const exists = CORE.db.users.some(u => u.username === username);
            if (exists) return UI.toast('Cet identifiant existe d�j��', 'error');

            // Hacher le mot de passe
            Utils.md5(password).then(hash => {
                const newUser = {
                    id: Math.max(...CORE.db.users.map(u => u.id), 0) + 1,
                    name,
                    username,
                    password,
                    passwordHash: hash,
                    role,
                    avatar,
                    active: true,
                    joinedDate: new Date().toISOString()
                };

                CORE.db.users.push(newUser);
                CORE.save();
                UI.toast(`${name} a �t� cr�� avec succ��s`, 'success');
                UI.closeModal();
                this.showUsersManagementModal();
            });
        },

        deleteUser(userId) {
            // V�rifier si le PDG a autoris� le Manager �� supprimer des utilisateurs
            if (!CORE.getSystemSetting('manager_manage_users', false)) {
                return UI.toast('Le PDG n\'a pas autoris� la suppression d\'utilisateurs par le Manager', 'error');
            }
            
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');
            
            // Le Manager ne peut pas supprimer le PDG
            if (user.role === 'pdg') return UI.toast('Impossible de supprimer le PDG', 'error');

            // Confirmation avant suppression
            if (!confirm(`�?Štes-vous s��r de vouloir supprimer ${user.name} ?`)) {
                return;
            }

            // Supprimer l'utilisateur
            const index = CORE.db.users.findIndex(u => u.id === userId);
            if (index !== -1) {
                CORE.db.users.splice(index, 1);
                CORE.save();
                UI.toast(`${user.name} a �t� supprim�`, 'success');
                this.showUsersManagementModal();
            } else {
                UI.toast('Utilisateur non trouv�', 'error');
            }
        },

        showSettingsModal() {
            const currentLang = I18n.current || 'fr';
            const currentTheme = this.state?.theme || 'light';
            const languages = [
                { code: 'fr', flag: '��Ÿ� ���Ÿ� �', name: 'Fran��ais' },
                { code: 'en', flag: '��Ÿ� ���Ÿ� �', name: 'English' },
                { code: 'es', flag: '��Ÿ� ���Ÿ� �', name: 'Espa��ol' },
                { code: 'pt', flag: '��Ÿ� ���Ÿ� �', name: 'Portugu��s' },
                { code: 'de', flag: '��Ÿ� ���Ÿ� �', name: 'Deutsch' },
                { code: 'it', flag: '��Ÿ� ���Ÿ� �', name: 'Italiano' },
                { code: 'ar', flag: '��Ÿ� ���Ÿ� �', name: '�? ��??�? ��? ��? ��?Š�? �' },
                { code: 'zh', flag: '��Ÿ� ���Ÿ� �', name: '�� � ���?�' },
                { code: 'ru', flag: '��Ÿ� ���Ÿ� �', name: '�� ��?�?�? ��? ��� ��� ��� �' }
            ];
            
            UI.modal('��š ?��� � � Param��tres Manager', `
                <div class="space-y-4">
                    <!-- Section Langue -->
                    <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-2xl">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
                                <i data-lucide="globe" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-slate-900">${t('settings.language')}</div>
                                <div class="text-xs text-slate-500">Choisissez votre langue pr�f�r�e</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-5 gap-2">
                            ${languages.map(lang => `
                                <button onclick="ManagerModule.setLanguage('${lang.code}')" class="p-2 rounded-xl border-2 transition-all text-2xl hover:scale-110 flex flex-col items-center gap-1 ${currentLang === lang.code ? 'border-blue-500 bg-blue-100 shadow-lg scale-105' : 'border-slate-200 hover:border-slate-300 bg-white'}">
                                    <span>${lang.flag}</span>
                                    <span class="text-[9px] font-bold text-slate-600">${lang.name.slice(0, 4)}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Section Th��me -->
                    <div class="p-4 bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-2xl">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center">
                                <i data-lucide="palette" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-slate-900">${t('settings.theme')}</div>
                                <div class="text-xs text-slate-500">Personnalisez l'apparence</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            ${[
                                { id: 'light', icon: '���? ?��� � �', label: t('settings.light'), gradient: 'from-amber-400 to-orange-500' },
                                { id: 'dark', icon: '��Ÿ�? ?�', label: t('settings.dark'), gradient: 'from-slate-700 to-slate-900' },
                                { id: 'auto', icon: '��Ÿ�?', label: t('settings.auto'), gradient: 'from-blue-500 to-purple-600' }
                            ].map(theme => `
                                <button onclick="ManagerModule.setTheme('${theme.id}')" class="group p-3 rounded-xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${currentTheme === theme.id ? 'border-purple-500 shadow-lg shadow-purple-100 scale-105' : 'border-slate-200 hover:border-slate-300 hover:shadow-md'}">
                                    <div class="w-12 h-12 bg-gradient-to-br ${theme.gradient} rounded-lg flex items-center justify-center text-xl shadow-md ${currentTheme === theme.id ? 'ring-2 ring-purple-300' : ''}">
                                        ${theme.icon}
                                    </div>
                                    <span class="text-xs font-bold ${currentTheme === theme.id ? 'text-purple-700' : 'text-slate-600'}">${theme.label}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Section Utilisateurs -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center border border-blue-200"><i data-lucide="users" class="w-5 h-5 text-blue-600"></i></div>
                            <div>
                                <div class="font-black text-blue-900">Gestion des Utilisateurs</div>
                                <div class="text-xs text-blue-700">Modifier les identifiants et mots de passe</div>
                            </div>
                        </div>
                        <button onclick="ManagerModule.showUsersManagementModal()" class="text-xs font-black text-blue-600 hover:text-blue-700">G�rer</button>
                    </div>

                    <div class="h-px bg-slate-200 my-2"></div>

                    <div class="border-t border-slate-200 pt-4">
                        <div class="text-xs font-black text-slate-600 uppercase tracking-wider mb-3">��Ÿ�? S�curit� et Confidentialit�</div>
                        <button onclick="ManagerModule.showChangePersonalPasswordModal()" class="w-full p-3 rounded-2xl bg-sky-50 border border-sky-200 hover:bg-sky-100 transition flex items-center gap-3 mb-3">
                            <i data-lucide="key" class="w-5 h-5 text-sky-600"></i>
                            <div class="text-left flex-1">
                                <div class="text-xs font-black text-sky-700">Changer votre mot de passe</div>
                                <div class="text-[10px] text-sky-600">Modifiez votre mot de passe personnel</div>
                            </div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-sky-400"></i>
                        </button>
                    </div>

                    <div class="h-px bg-slate-200 my-2"></div>

                    <button onclick="App.logout()" class="w-full py-3 bg-red-50 text-red-600 font-black rounded-xl hover:bg-red-100 transition flex items-center justify-center gap-2">
                        <i data-lucide="log-out" class="w-4 h-4"></i> D�connexion
                    </button>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            
            setTimeout(() => lucide?.createIcons?.(), 50);
        },
        
        setLanguage(code) {
            const userId = CORE.state.currentUser?.id;
            CORE.setUserLanguage(userId, code);
            I18n.setLanguage(code);
            UI.closeModal();
            UI.toast(`���?? Langue chang�e: ${code.toUpperCase()}`, 'success');
            App.rerender();
        },
        
        setTheme(theme) {
            this.state.theme = theme;
            VendeurModule.setTheme(theme);
            UI.closeModal();
            this.showSettingsModal();
        },
        
        applyTheme() {
            // D�l�guer �� VendeurModule car Manager utilise le m��me syst��me de th��me
            if (VendeurModule?.applyTheme) {
                VendeurModule.applyTheme();
            }
        },

        showChangePersonalPasswordModal() {
            UI.modal('��Ÿ�? Changer votre mot de passe', `
                <div class="space-y-4">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl flex items-center gap-3">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-amber-600 flex-shrink-0"></i>
                        <div class="text-sm text-amber-800 font-medium">Utilisez un mot de passe fort (min 6 caract��res)</div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Ancien mot de passe</label>
                        <input type="password" id="old_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Entrez votre ancien mot de passe">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Nouveau mot de passe</label>
                        <input type="password" id="new_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Entrez un nouveau mot de passe">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Confirmation du nouveau mot de passe</label>
                        <input type="password" id="confirm_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Confirmez le nouveau mot de passe">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Changer le mot de passe', onclick: 'ManagerModule.savePersonalPasswordChange()', class: 'px-5 py-2.5 bg-sky-600 text-white font-black rounded-xl hover:bg-sky-700' }
            ]);
        },

        async savePersonalPasswordChange() {
            const oldPwd = UI.val('old_pwd');
            const newPwd = UI.val('new_pwd');
            const confirmPwd = UI.val('confirm_pwd');
            const user = CORE.state.currentUser;
            
            if (!oldPwd || !newPwd || !confirmPwd) {
                UI.toast('Tous les champs sont obligatoires', 'error');
                return;
            }
            
            if (newPwd.length < 6) {
                UI.toast('Le nouveau mot de passe doit contenir au moins 6 caract��res', 'error');
                return;
            }
            
            if (newPwd !== confirmPwd) {
                UI.toast('Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            const oldPwdHash = await Utils.md5(oldPwd);
            if (oldPwdHash !== user.passwordHash) {
                UI.toast('Ancien mot de passe incorrect', 'error');
                return;
            }
            
            const newPwdHash = await Utils.md5(newPwd);
            user.passwordHash = newPwdHash;
            
            const userIndex = CORE.db.users.findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
                CORE.db.users[userIndex] = user;
                CORE.save();
                UI.closeModal();
                UI.toast('���?? Mot de passe chang� avec succ��s', 'success');
                App.rerender();
            } else {
                UI.toast('Erreur lors de la mise �� jour de l\'utilisateur', 'error');
            }
        }
    };

    // =========================================================
    // MODULE: VENDEUR
    // =========================================================
    const VendeurModule = {
        state: {
            currentView: 'dashboard',
            theme: 'light',
            // posMode: 'sale' | 'reservation'
            posMode: 'sale',
            cart: [],
            cartDrawerOpen: false,

            // REMISES & PROMO
            globalDiscount: { type: 'percent', value: 0 }, // type: 'percent' | 'fixed'
            promoCode: null,

            // Panier sp�cial R�servations (visible uniquement en mode r�servation)
            reservationCart: [],
            reservationCartDrawerOpen: false,
            reservationManualDeliveryFee: 0,

            // D�tails de livraison saisis par le vendeur (obligatoires pour COD)
            deliveryDetails: { name: '', phone: '', address: '', date: '', time: '' },
            categoryFilter: null,
            searchQuery: '',
            ordersFilter: 'all',
            ordersSearch: '',
            clientsSearch: '',
            livreursSearch: '',
            deliveriesSearch: '',
            deliveriesStatus: 'all',
            reservationsSearch: '',
            reservationsStatus: 'all',
            deliveryZoneId: null,
            manualDeliveryFee: 0,
            parkedCarts: [], // Paniers en attente
            
            // Retours
            returnsSearch: '',
            returnCart: [], // Items s�lectionn�s pour retour
            
            // Stock pagination & filtres
            stockSearch: '',
            stockCategoryFilter: 'all',
            stockStatusFilter: 'all',
            stockSortBy: 'name',
            stockPage: 1,
            stockPerPage: 30,
            
            // Clients Favoris
            favoriteClients: [], // [clientId]
            lastAccessedClients: [], // [{clientId, lastAccessDate}]
            
            // Pr�f�rences Personnelles
            preferences: {
                language: 'fr', // 'fr' | 'en' | 'es'
                notificationsEnabled: true,
                theme: 'light', // 'light' | 'dark' | 'auto'
                favoritedPaymentMethods: [], // ['cash', 'card', 'mobile_money']
                soundEnabled: true, // Audio notifications
                soundVolume: 0.5, // Volume 0 to 1
                keyboardShortcutsEnabled: true,
                soundNotificationsEnabled: true,
                emailNotificationsEnabled: false,
                compactMode: false,
                receiptLogoText: '', // Texte personnalis� pour le logo sur le re��u
                receiptSubtitle: '' // Sous-titre personnalis� pour le re��u
            }
        },

        // =====================
        // LOGIQUE PROMO / REMISES
        // =====================
        
        applyPromoCode(code) {
            const c = (code || '').trim().toUpperCase();
            if (!c) {
                this.state.promoCode = null;
                this.state.globalDiscount = { type: 'percent', value: 0 };
                return UI.toast('Code promo retir�', 'info');
            }

            // Mock simple de codes promo
            const promos = {
                'BIENVENUE': { type: 'percent', value: 10, label: '10% de bienvenue' },
                'RAYA20': { type: 'fixed', value: 2000, label: '2000 FCFA offerts' },
                'VIP': { type: 'percent', value: 15, label: '15% VIP' }
            };

            if (promos[c]) {
                this.state.promoCode = c;
                this.state.globalDiscount = { type: promos[c].type, value: promos[c].value };
                UI.toast(`Code ${c} appliqu� : ${promos[c].label}`, 'success');
            } else {
                UI.toast('Code promo invalide', 'error');
            }
            App.rerender();
        },

        promptGlobalDiscount() {
            UI.modal('Remise Globale', `
                <div class="space-y-4">
                    <p class="text-xs text-slate-500">Appliquer une r�duction sur le total du panier.</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="VendeurModule.setGlobalDiscount('percent', 5)" class="p-3 border border-slate-200 rounded-xl hover:bg-emerald-50 hover:border-emerald-200 font-bold text-sm">-5%</button>
                        <button onclick="VendeurModule.setGlobalDiscount('percent', 10)" class="p-3 border border-slate-200 rounded-xl hover:bg-emerald-50 hover:border-emerald-200 font-bold text-sm">-10%</button>
                        <button onclick="VendeurModule.setGlobalDiscount('percent', 15)" class="p-3 border border-slate-200 rounded-xl hover:bg-emerald-50 hover:border-emerald-200 font-bold text-sm">-15%</button>
                        <button onclick="VendeurModule.setGlobalDiscount('percent', 20)" class="p-3 border border-slate-200 rounded-xl hover:bg-emerald-50 hover:border-emerald-200 font-bold text-sm">-20%</button>
                    </div>
                    <div class="border-t border-slate-100 pt-3">
                        ${UI.input('custom_disc_val', 'Ou montant personnalis�', 'number', '', 'Montant en FCFA')}
                        <button onclick="VendeurModule.setGlobalDiscount('fixed', document.getElementById('custom_disc_val').value)" class="mt-2 w-full py-2 bg-slate-900 text-white rounded-xl font-bold text-sm">Appliquer montant</button>
                    </div>
                    <button onclick="VendeurModule.setGlobalDiscount('percent', 0)" class="w-full py-2 bg-red-50 text-red-600 rounded-xl font-bold text-sm">Annuler remise</button>
                </div>
            `, [ { label: 'Fermer', onclick: 'UI.closeModal()' } ]);
        },

        setGlobalDiscount(type, val) {
            const value = Number(val || 0);
            this.state.globalDiscount = { type, value };
            this.state.promoCode = null; // Reset promo code if manual override
            UI.closeModal();
            UI.toast(`Remise globale appliqu�e`, 'success');
            App.rerender();
        },

        promptLineDiscount(index) {
            const item = this.state.cart[index];
            if (!item) return;
            UI.modal(`Remise sur ${item.name}`, `
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="VendeurModule.setLineDiscount(${index}, 0)" class="p-2 border border-slate-200 rounded-xl text-xs font-bold hover:bg-red-50 text-red-600">0%</button>
                        <button onclick="VendeurModule.setLineDiscount(${index}, 5)" class="p-2 border border-slate-200 rounded-xl text-xs font-bold hover:bg-emerald-50">5%</button>
                        <button onclick="VendeurModule.setLineDiscount(${index}, 10)" class="p-2 border border-slate-200 rounded-xl text-xs font-bold hover:bg-emerald-50">10%</button>
                    </div>
                    ${UI.input('line_disc_custom', 'Autre %', 'number', item.discountPercent || '', 'Ex: 25')}
                    <button onclick="VendeurModule.setLineDiscount(${index}, document.getElementById('line_disc_custom').value)" class="w-full py-2 bg-slate-900 text-white rounded-xl font-bold text-sm">Appliquer</button>
                </div>
            `, [ { label: 'Fermer', onclick: 'UI.closeModal()' } ]);
        },

        setLineDiscount(index, percent) {
            const p = Utils.clamp(Number(percent || 0), 0, 100);
            if (this.state.cart[index]) {
                this.state.cart[index].discountPercent = p;
                // Recalc price logic handles the rest
            }
            UI.closeModal();
            App.rerender();
        },

        // Calcul du prix final d'une ligne (avec remise ligne + gros volume)
        getLinePrice(item) {
            let price = item.price;
            
            // 1. Prix de gros automatique (simul�) : si qty >= 10, -10% sur le prix de base
            if (item.qty >= 10) {
                // On applique le prix de gros sur la base, sauf si une remise ligne manuelle est plus forte ?
                // Ici on cumule ou on prend le meilleur ? Disons qu'on applique le prix de gros comme base.
                // Pour simplifier : Wholesale est une "remise ligne automatique".
                // Si l'utilisateur a mis une remise manuelle, on prend celle-l��. Sinon on checke le volume.
                if (item.discountPercent === undefined || item.discountPercent === null) {
                    // Pas de remise manuelle, on check le volume
                    return Math.round(price * 0.9); // -10% auto
                }
            }

            // 2. Remise ligne manuelle
            if (item.discountPercent > 0) {
                price = price * (1 - (item.discountPercent / 100));
            }

            return Math.round(price);
        },

        // =====================
        // PANIERS EN ATTENTE (Park/Retrieve)
        // =====================
        parkCurrentCart() {
            if (this.state.cart.length === 0) return UI.toast('Panier vide', 'warning');
            
            const clientName = this.state.deliveryDetails?.name || (this.state.selectedClientId ? CORE.getClient(this.state.selectedClientId)?.name : '');
            const defaultName = clientName ? `Client: ${clientName}` : `Panier ${new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})}`;

            UI.modal('Mettre en attente', `
                <div class="space-y-4">
                    <p class="text-slate-500 text-sm">Mettre ce panier de c��t� pour le reprendre plus tard.</p>
                    ${UI.input('park_name', 'Nom de r�f�rence', 'text', defaultName, 'Ex: Client chemise bleue', true)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Mettre en attente', onclick: 'VendeurModule.saveParkedCart()', class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        saveParkedCart() {
            const name = UI.val('park_name').trim() || 'Panier sans nom';
            
            this.state.parkedCarts.push({
                id: Date.now(),
                name: name,
                items: [...this.state.cart], // Copie du tableau
                deliveryDetails: { ...this.state.deliveryDetails },
                selectedClientId: this.state.selectedClientId,
                manualDeliveryFee: this.state.manualDeliveryFee,
                total: this.getGrandTotal(),
                savedAt: new Date()
            });

            this.clearCart(); // Vide le panier actuel
            UI.closeModal();
            UI.toast('Panier mis en attente', 'success');
            App.rerender();
        },

        showParkedCartsModal() {
            const list = this.state.parkedCarts.sort((a,b) => b.savedAt - a.savedAt);
            
            UI.modal('Paniers en attente (' + list.length + ')', `
                <div class="space-y-3 max-h-[60vh] overflow-y-auto">
                    ${list.length === 0 ? '<div class="p-8 text-center text-slate-400 font-medium">Aucun panier en attente</div>' : list.map(p => `
                        <div class="p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 transition flex items-center justify-between gap-4">
                            <div class="min-w-0">
                                <div class="font-black text-slate-900 truncate">${p.name}</div>
                                <div class="text-xs text-slate-500">
                                    ${p.items.length} articles �� ?� � ${CORE.formatPrice(p.total)}
                                    <span class="mx-1">�� ?� �</span> ${CORE.formatTime(p.savedAt)}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="VendeurModule.deleteParkedCart(${p.id})" class="p-2 rounded-xl bg-red-50 text-red-600 hover:bg-red-100 transition" title="Supprimer">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                                <button onclick="VendeurModule.restoreParkedCart(${p.id})" class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700 transition flex items-center gap-2">
                                    Reprendre <i data-lucide="arrow-right" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        restoreParkedCart(id) {
            const index = this.state.parkedCarts.findIndex(p => p.id === id);
            if (index === -1) return;
            const parked = this.state.parkedCarts[index];

            // Si le panier actuel n'est pas vide, on demande confirmation ou on propose d'�changer
            if (this.state.cart.length > 0) {
                if (!confirm("Le panier actuel n'est pas vide. Voulez-vous l'�craser par le panier en attente ?")) return;
            }

            // Restauration
            this.state.cart = [...parked.items];
            this.state.deliveryDetails = { ...parked.deliveryDetails };
            this.state.selectedClientId = parked.selectedClientId;
            this.state.manualDeliveryFee = parked.manualDeliveryFee || 0;

            // Suppression de la liste des attentes
            this.state.parkedCarts.splice(index, 1);

            UI.closeModal();
            UI.toast('Panier repris', 'success');
            App.rerender();
        },

        deleteParkedCart(id) {
            this.state.parkedCarts = this.state.parkedCarts.filter(p => p.id !== id);
            // R�actualiser la modale
            this.showParkedCartsModal();
        },

        init() {
            console.log('[VendeurModule] init called');
            console.log('[VendeurModule] init - this.state.theme:', this.state.theme);
            
            // R�initialiser la vue et les paniers
            this.state.currentView = 'dashboard';
            this.state.cart = [];
            this.state.cartDrawerOpen = false;
            this.state.reservationCart = [];
            this.state.reservationCartDrawerOpen = false;
            this.state.returnCart = [];
            this.state.parkedCarts = [];
            this.state.posMode = 'sale';
            this.state.categoryFilter = null;
            this.state.searchQuery = '';
            this.state.ordersFilter = 'all';
            this.state.deliveriesStatus = 'all';
            this.state.reservationsStatus = 'all';
            
            this.loadPreferences(); // Charger les pr�f�rences sauvegard�es
            this.loadThemePreference(); // Charger et appliquer le th��me sauvegard�
            this.loadLanguagePreference(); // Charger la langue pr�f�r�e
            this.loadReservationCart(); // Charger le panier de r�servation isol� par utilisateur/POS
            console.log('[VendeurModule] init - after loadThemePreference, this.state.theme:', this.state.theme);
            CORE.initDefaultMessageTemplates(); // Initialiser les templates de messages
            if (CORE.db.orders.length === 0) this.seed();
        },

        seed() {
            const now = Date.now();
            const makeOrder = (i, status, total) => ({
                reference: `CMD-${String(i).padStart(4,'0')}`,
                subtotal: total,
                deliveryFee: 0,
                total,
                status,
                paymentMethod: status === 'delivered' ? 'cash' : null,
                paymentStatus: status === 'delivered' ? 'paid' : 'pending',
                sellerId: 4,
                posId: 1,
                cityId: 1,
                items: [{ productId: 1, name: 'Lait Concentr� Gloria', qty: 2, price: 1500 }],
                createdAt: new Date(now - i * 3600_000).toISOString()
            });

            // commandes simples
            [
                makeOrder(1, 'delivered', 15000),
                makeOrder(3, 'cancelled', 45000),
                makeOrder(4, 'delivered', 12000)
            ].forEach(o => CORE.db.orders.push({ id: CORE.db.orders.length + 1, ...o }));

            // Historique d'achats pour Marcel Bakala (clientId: 1)
            const marcelsOrders = [
                { reference: 'CMD-0010', status: 'delivered', total: 25000, clientId: 1, sellerId: 4, posId: 1, cityId: 1, items: [{ productId: 1, name: 'Lait Concentr� Gloria', qty: 5, price: 1500 }, { productId: 3, name: 'Huile de Palme 1L', qty: 3, price: 2500 }], createdAt: new Date(now - 8 * 86400_000).toISOString() },
                { reference: 'CMD-0011', status: 'delivered', total: 18000, clientId: 1, sellerId: 4, posId: 1, cityId: 1, items: [{ productId: 2, name: 'Riz Parfum� 5kg', qty: 2, price: 8500 }], createdAt: new Date(now - 5 * 86400_000).toISOString() },
                { reference: 'CMD-0012', status: 'delivered', total: 12500, clientId: 1, sellerId: 4, posId: 1, cityId: 1, items: [{ productId: 4, name: 'Sucre en Poudre 1kg', qty: 10, price: 1200 }], createdAt: new Date(now - 2 * 86400_000).toISOString() }
            ];
            marcelsOrders.forEach(o => CORE.db.orders.push({ id: CORE.db.orders.length + 1, ...o }));

            // Historique d'achats pour Sylvie Moukoko (clientId: 2)
            const sylviesOrders = [
                { reference: 'CMD-0013', status: 'delivered', total: 20000, clientId: 2, sellerId: 4, posId: 1, cityId: 1, items: [{ productId: 1, name: 'Lait Concentr� Gloria', qty: 3, price: 1500 }, { productId: 8, name: 'Bi��re Ngok 65cl', qty: 2, price: 1000 }], createdAt: new Date(now - 10 * 86400_000).toISOString() },
                { reference: 'CMD-0014', status: 'delivered', total: 15000, clientId: 2, sellerId: 4, posId: 1, cityId: 1, items: [{ productId: 3, name: 'Huile de Palme 1L', qty: 6, price: 2500 }], createdAt: new Date(now - 7 * 86400_000).toISOString() }
            ];
            sylviesOrders.forEach(o => CORE.db.orders.push({ id: CORE.db.orders.length + 1, ...o }));

            // commande COD + livraison
            const codSubtotal = 8500;
            const defaultZone = { id: 1, name: 'Centre-Ville', fee: 1500 };
            const zone = (CORE.db.deliveryZones && CORE.db.deliveryZones[0]) ? CORE.db.deliveryZones[0] : defaultZone;
            const codOrderId = CORE.db.orders.length + 1;
            CORE.db.orders.push({
                id: codOrderId,
                reference: 'CMD-0002',
                subtotal: codSubtotal,
                deliveryFee: zone.fee,
                total: codSubtotal + zone.fee,
                status: 'delivering',
                paymentMethod: 'cod',
                paymentStatus: 'pending',
                sellerId: 4,
                posId: 1,
                cityId: 1,
                clientId: 1,
                clientName: 'Marcel Bakala',
                clientPhone: '+242 06 845 1234',
                clientAddress: '78 Av. Foch, Brazzaville',
                zoneId: zone.id,
                zoneName: zone.name,
                items: [{ productId: 2, name: 'Riz Parfum� 5kg', qty: 1, price: codSubtotal }],
                createdAt: new Date(now - 2 * 3600_000).toISOString()
            });

            CORE.db.deliveries.push({
                id: 1,
                orderId: codOrderId,
                orderRef: 'CMD-0002',
                clientName: 'Marcel Bakala',
                clientPhone: '+242 06 845 1234',
                address: '78 Av. Foch, Brazzaville',
                zoneId: zone.id,
                zoneName: zone.name,
                livreurId: 5,
                posId: 1,
                status: 'en_cours',
                amount: codSubtotal + zone.fee,
                commission: Math.round((codSubtotal + zone.fee) * 0.05),
                createdAt: new Date(now - 2 * 3600_000).toISOString()
            });

            // Seed variantes de d�monstration
            // Variantes pour Lait Concentr� Gloria (productId: 1)
            const laitVariants = [
                { attributes: [{ name: 'Temp�rature', value: 'Froid' }], sku: 'LAIT-001-FROID', price: 1800, stock: 50 },
                { attributes: [{ name: 'Poids', value: '500g' }], sku: 'LAIT-001-500', price: 900, stock: 75 },
                { attributes: [{ name: 'Poids', value: '1kg' }, { name: 'Temp�rature', value: 'Temp�r�' }], sku: 'LAIT-001-1K-TEMP', price: 1600, stock: 60 }
            ];
            laitVariants.forEach(v => {
                CORE.db.productVariants.push({
                    id: Date.now() + Math.random(),
                    productId: 1,
                    attributes: v.attributes,
                    sku: v.sku,
                    price: v.price,
                    stock: v.stock,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
            });

            // Variantes pour Riz Parfum� 5kg (productId: 2)
            const rizVariants = [
                { attributes: [{ name: 'Couleur', value: 'Blanc' }], sku: 'RIZ-001-BLANC', price: 8500, stock: 100 },
                { attributes: [{ name: 'Couleur', value: 'Rouge' }], sku: 'RIZ-001-ROUGE', price: 8000, stock: 80 },
                { attributes: [{ name: 'Poids', value: '2kg' }, { name: 'Couleur', value: 'Blanc' }], sku: 'RIZ-001-2K-B', price: 3500, stock: 150 }
            ];
            rizVariants.forEach(v => {
                CORE.db.productVariants.push({
                    id: Date.now() + Math.random(),
                    productId: 2,
                    attributes: v.attributes,
                    sku: v.sku,
                    price: v.price,
                    stock: v.stock,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
            });

            CORE.save();
        },

        navigateTo(view) {
            if (!CORE.canAccessView(view)) {
                return UI.toast('Acc��s refus�', 'error');
            }
            this.state.currentView = view;
            App.rerender();
        },

        getOfflineStatus() {
            const pendingCount = (CORE.db.pendingSyncs || []).length;
            return {
                isOnline: CORE.state.isOnline,
                pendingCount,                // ...existing code...
                showPOSModal() {
                  if (!CORE.hasPermission('managePos')) {
                    return UI.showToast('Acc��s refus�', 'error');
                  }
                  // Si ManagerModule expose le gestionnaire POS, l'utiliser
                  if (typeof ManagerModule?.showPosManager === 'function') {
                    return ManagerModule.showPosManager();
                  }
                  // Sinon utiliser un module POS partag�
                  if (typeof POSModule?.showManager === 'function') {
                    return POSModule.showManager();
                  }
                  UI.showToast('Module POS indisponible', 'warning');
                },
                // ...existing code...
                lastSync: CORE.state.lastSync,
                offlineWarning: !CORE.state.isOnline && this.state.cart.length > 0
            };
        },

        setTheme(theme) {
            console.log('[VendeurModule] setTheme - START with theme:', theme);
            this.state.theme = theme;
            this.state.preferences.theme = theme;
            const userId = CORE.user?.id || 'default';
            localStorage.setItem(`vendeur_theme_${userId}`, theme);
            console.log('[VendeurModule] setTheme - saved theme to localStorage for user:', userId, theme);
            console.log('[VendeurModule] setTheme - calling savePreferences...');
            this.savePreferences();
            console.log('[VendeurModule] setTheme - savePreferences done');
            
            // Appliquer le th��me directement (pas d'appel �� this.applyTheme)
            const html = document.documentElement;
            const body = document.body;
            console.log('[VendeurModule] setTheme - applying theme directly:', theme);

            html.classList.remove('vendeur-dark', 'vendeur-light', 'vendeur-auto');
            if (body) body.classList.remove('vendeur-dark', 'vendeur-light', 'vendeur-auto');

            if (theme === 'dark') {
                html.classList.add('vendeur-dark');
                if (body) body.classList.add('vendeur-dark');
                html.style.filter = 'none';
                html.style.backgroundColor = '#111b21';
                console.log('[VendeurModule] setTheme - applied WhatsApp dark theme');
            } else if (theme === 'light') {
                html.classList.add('vendeur-light');
                if (body) body.classList.add('vendeur-light');
                html.style.filter = 'none';
                html.style.backgroundColor = '#ffffff';
                console.log('[VendeurModule] setTheme - applied light theme');
            } else if (theme === 'auto') {
                html.classList.add('vendeur-auto');
                if (body) body.classList.add('vendeur-auto');
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.filter = 'none';
                html.style.backgroundColor = isDark ? '#111b21' : '#ffffff';
                if (isDark) {
                    html.classList.add('vendeur-dark');
                    if (body) body.classList.add('vendeur-dark');
                }
                console.log('[VendeurModule] setTheme - auto theme, isDark:', isDark);
            }
            
            UI.toast(`Th��me: ${theme === 'light' ? 'Clair' : theme === 'dark' ? 'Sombre' : 'Auto'}`, 'success');
            console.log('[VendeurModule] setTheme - UI.toast done, calling App.rerender...');
            App.rerender();
            console.log('[VendeurModule] setTheme - DONE');
        },

        applyTheme() {
            const html = document.documentElement;
            const body = document.body;
            const theme = this.state.theme;
            console.log('[VendeurModule] applyTheme - applying theme:', theme);

            // Enlever toutes les classes de th��me
            html.classList.remove('vendeur-dark', 'vendeur-light', 'vendeur-auto');
            if (body) body.classList.remove('vendeur-dark', 'vendeur-light', 'vendeur-auto');

            if (theme === 'dark') {
                html.classList.add('vendeur-dark');
                if (body) body.classList.add('vendeur-dark');
                html.style.filter = 'none';
                html.style.backgroundColor = '#111b21';
                console.log('[VendeurModule] applyTheme - applied WhatsApp dark theme');
            } else if (theme === 'light') {
                html.classList.add('vendeur-light');
                if (body) body.classList.add('vendeur-light');
                html.style.filter = 'none';
                html.style.backgroundColor = '#ffffff';
                console.log('[VendeurModule] applyTheme - applied light theme');
            } else if (theme === 'auto') {
                html.classList.add('vendeur-auto');
                if (body) body.classList.add('vendeur-auto');
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.filter = 'none';
                html.style.backgroundColor = isDark ? '#111b21' : '#ffffff';
                if (isDark) {
                    html.classList.add('vendeur-dark');
                    if (body) body.classList.add('vendeur-dark');
                }
                console.log('[VendeurModule] applyTheme - auto theme, isDark:', isDark);
            }
        },

        loadThemePreference() {
            const userId = CORE.user?.id || 'default';
            const saved = localStorage.getItem(`vendeur_theme_${userId}`);
            console.log('[VendeurModule] loadThemePreference - saved from localStorage for user:', userId, saved);
            if (saved) {
                this.state.theme = saved;
                console.log('[VendeurModule] loadThemePreference - set theme to:', this.state.theme);
                this.applyTheme();
            }
        },

        // Changer la langue
        setLanguage(lang) {
            this.state.preferences.language = lang;
            CORE.db.config = CORE.db.config || {};
            CORE.db.config.language = lang;
            const userId = CORE.state.currentUser?.id;
            CORE.setUserLanguage(userId, lang);
            
            // Utiliser le syst��me i18n global
            i18n.setLang(lang);
            
            this.savePreferences();
            CORE.save();
            
            const langNames = { fr: 'Fran��ais', en: 'English', es: 'Espa��ol' };
            UI.toast(`���?? ${t('settings.language')}: ${langNames[lang] || lang}`, 'success');
            App.rerender();
        },

        loadLanguagePreference() {
            const userId = CORE.state.currentUser?.id;
            const saved = CORE.getUserLanguage(userId);
            if (saved) {
                this.state.preferences.language = saved;
                CORE.db.config = CORE.db.config || {};
                CORE.db.config.language = saved;
                // Synchroniser avec i18n global
                i18n.setLang(saved);
            }
        },

        // =====================
        // PROFIL VENDEUR PERSONNALIS�
        // =====================
        getVendorProfile(userId) {
            const user = CORE.getUser(userId);
            if (!user || user.role !== 'vendeur') return null;
            return user;
        },

        getVendorStats(userId) {
            const user = CORE.getUser(userId);
            if (!user) return null;

            const userOrders = CORE.db.orders.filter(o => o.sellerId === userId && o.status === 'delivered');
            const totalSales = userOrders.reduce((a, o) => a + (o.total || 0), 0);
            const orderCount = userOrders.length;
            const avgOrder = orderCount > 0 ? Math.round(totalSales / orderCount) : 0;

            return {
                totalSales,
                salesCount: orderCount,
                avgOrder,
                rating: user.rating || 4.5,
                specialties: user.specialties || [],
                badge: user.badge || null,
                joinedDate: user.joinedDate || null
            };
        },

        // Independent Delivery Men Management
        showAddIndependentDeliveryManModal() {
            const settings = CORE.getGestionnaireSettings();
            
            UI.modal('��ž� Ajouter livreur ind�pendant', `
                <div class="space-y-4">
                    ${UI.input('idm_name','Nom complet','text','','Ex: Mohamed Diallo',true)}
                    ${UI.input('idm_phone','T�l�phone','tel','','+242 ...', true)}
                    ${UI.textarea('idm_notes','Notes (optionnel)','','Ex: Livre pour Plateau/Poto-Poto...',2)}
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl text-xs text-blue-700">
                        <div class="font-black mb-2">��Ÿ? � Bons de livraison par SMS</div>
                        <p>Ce livreur ind�pendant recevra les bons de livraison uniquement par SMS avec tous les d�tails (client, adresse, montant).</p>
                    </div>
                    ${settings.independentDeliveryMenApprovalRequired ? 
                        `<div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl text-xs text-amber-700">
                            <div class="font-black mb-1">�� � � Approbation requise</div>
                            <p>Ce livreur doit ��tre approuv� par le gestionnaire avant d'��tre utilis�.</p>
                        </div>` : 
                        `<div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl text-xs text-emerald-700">
                            <div class="font-black mb-1">���?� Approbation automatique</div>
                            <p>Ce livreur sera imm�diatement disponible pour les livraisons.</p>
                        </div>`
                    }
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Ajouter', onclick: 'VendeurModule.saveIndependentDeliveryMan()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        saveIndependentDeliveryMan() {
            const name = UI.val('idm_name').trim();
            const phone = UI.val('idm_phone').trim();
            const notes = UI.val('idm_notes').trim();

            if (!name || !phone) return UI.toast('Nom et t�l�phone requis', 'warning');

            const vendeurId = CORE.state.currentUser?.id;
            const currentUser = CORE.state.currentUser;
            const created = CORE.createIndependentDeliveryMan(name, phone, vendeurId, notes);

            if (created) {
                // Enregistrer dans le journal d'audit
                CORE.db.auditLogs = CORE.db.auditLogs || [];
                CORE.db.auditLogs.push({
                    id: 'audit_' + Date.now(),
                    timestamp: new Date().toISOString(),
                    userId: currentUser.id,
                    userName: currentUser.name,
                    userRole: currentUser.role,
                    posId: currentUser.pos,
                    action: 'create',
                    entity: 'livreur_independant',
                    entityId: created.id,
                    entityName: name,
                    details: `Livreur ind�pendant cr��: ${name} (${phone})`,
                    status: created.approvalStatus === 'approved' ? 'success' : 'pending'
                });
                CORE.save();

                UI.closeModal();
                UI.toast(`Livreur ind�pendant "${name}" ajout�`, 'success');
                VendeurModule.showIndependentDeliveryMenList();
            }
        },

        showIndependentDeliveryMenList() {
            const vendeurId = CORE.state.currentUser?.id;
            const settings = CORE.getGestionnaireSettings();
            const allDeliveryMen = CORE.db.independentDeliveryMen.filter(dm => dm.vendeurId === vendeurId);
            const approvedDeliveryMen = allDeliveryMen.filter(dm => dm.approvalStatus === 'approved');
            const pendingDeliveryMen = allDeliveryMen.filter(dm => dm.approvalStatus === 'pending');
            const rejectedDeliveryMen = allDeliveryMen.filter(dm => dm.approvalStatus === 'rejected');

            UI.modal('��Ÿ? � Mes livreurs ind�pendants', `
                <div class="space-y-4 max-h-[600px] overflow-y-auto">
                    <div class="flex gap-2">
                        <button onclick="VendeurModule.showAddIndependentDeliveryManModal()" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-xl font-black text-sm hover:bg-emerald-700 transition flex items-center justify-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i> Ajouter
                        </button>
                    </div>

                    ${settings.independentDeliveryMenApprovalRequired && pendingDeliveryMen.length > 0 ? `
                        <div class="p-4 bg-amber-50 border-2 border-amber-300 rounded-2xl">
                            <div class="flex items-start gap-2">
                                <i data-lucide="hourglass" class="w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0"></i>
                                <div>
                                    <div class="font-black text-amber-900">En attente d'approbation</div>
                                    <div class="text-sm text-amber-800">${pendingDeliveryMen.length} livreur(s) doit/doivent ��tre approuv�(s) par le gestionnaire avant d'��tre utilis�(s).</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    ${approvedDeliveryMen.length === 0 && allDeliveryMen.length === 0 ? `
                        <div class="text-center py-12 text-slate-400">
                            <i data-lucide="users" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                            <div class="font-medium">Aucun livreur ind�pendant</div>
                            <div class="text-xs mt-1">Cliquez sur "Ajouter" pour commencer</div>
                        </div>
                    ` : `
                        <div class="border-t border-slate-200 pt-4">
                            ${approvedDeliveryMen.length > 0 ? `
                                <div class="mb-4">
                                    <div class="text-xs font-black text-emerald-700 uppercase mb-2">���?� Livreurs actifs (${approvedDeliveryMen.length})</div>
                                    <div class="space-y-2">
                                        ${approvedDeliveryMen.map(dm => `
                                            <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-xl">
                                                <div class="flex items-start justify-between">
                                                    <div>
                                                        <div class="font-black text-slate-900">${dm.name}</div>
                                                        <div class="text-sm text-slate-500 mt-1">��Ÿ? � ${dm.phone}</div>
                                                    </div>
                                                    <span class="px-2 py-1 bg-emerald-600 text-white text-xs font-black rounded">Approuv�</span>
                                                </div>
                                                ${dm.notes ? `<div class="text-xs text-slate-600 mb-2 mt-2">��Ÿ? � ${dm.notes}</div>` : ''}
                                                <div class="grid grid-cols-2 gap-2 text-xs text-slate-600 mb-3">
                                                    <div>Livraisons: <b>${dm.deliveryCount}</b></div>
                                                    <div>Gains: <b>${CORE.formatPrice(dm.totalEarnings)}</b></div>
                                                </div>
                                                <div class="flex gap-2">
                                                    <button onclick="VendeurModule.editIndependentDeliveryMan('${dm.id}')" class="flex-1 px-3 py-1.5 bg-blue-600 text-white text-xs font-black rounded hover:bg-blue-700">�diter</button>
                                                    <button onclick="VendeurModule.deleteIndependentDeliveryMan('${dm.id}'); VendeurModule.showIndependentDeliveryMenList()" class="flex-1 px-3 py-1.5 bg-red-600 text-white text-xs font-black rounded hover:bg-red-700">Supprimer</button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${pendingDeliveryMen.length > 0 ? `
                                <div class="mb-4">
                                    <div class="text-xs font-black text-amber-700 uppercase mb-2">�� � � En attente (${pendingDeliveryMen.length})</div>
                                    <div class="space-y-2">
                                        ${pendingDeliveryMen.map(dm => `
                                            <div class="p-3 bg-amber-50 border border-amber-200 rounded-xl opacity-60">
                                                <div class="flex items-start justify-between">
                                                    <div>
                                                        <div class="font-black text-slate-900">${dm.name}</div>
                                                        <div class="text-sm text-slate-500 mt-1">��Ÿ? � ${dm.phone}</div>
                                                    </div>
                                                    <span class="px-2 py-1 bg-amber-600 text-white text-xs font-black rounded">Attente</span>
                                                </div>
                                                ${dm.notes ? `<div class="text-xs text-slate-600 mb-2 mt-2">��Ÿ? � ${dm.notes}</div>` : ''}
                                                <div class="flex gap-2">
                                                    <button onclick="VendeurModule.editIndependentDeliveryMan('${dm.id}')" class="flex-1 px-3 py-1.5 bg-blue-600 text-white text-xs font-black rounded hover:bg-blue-700">�diter</button>
                                                    <button onclick="VendeurModule.deleteIndependentDeliveryMan('${dm.id}'); VendeurModule.showIndependentDeliveryMenList()" class="flex-1 px-3 py-1.5 bg-red-600 text-white text-xs font-black rounded hover:bg-red-700">Supprimer</button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${rejectedDeliveryMen.length > 0 ? `
                                <div>
                                    <div class="text-xs font-black text-red-700 uppercase mb-2">�� ��? Rejet�s (${rejectedDeliveryMen.length})</div>
                                    <div class="space-y-2">
                                        ${rejectedDeliveryMen.map(dm => `
                                            <div class="p-3 bg-red-50 border border-red-200 rounded-xl">
                                                <div class="flex items-start justify-between">
                                                    <div>
                                                        <div class="font-black text-slate-900">${dm.name}</div>
                                                        <div class="text-sm text-slate-500 mt-1">��Ÿ? � ${dm.phone}</div>
                                                    </div>
                                                    <span class="px-2 py-1 bg-red-600 text-white text-xs font-black rounded">Rejet�</span>
                                                </div>
                                                ${dm.rejectionReason ? `<div class="text-xs text-red-700 font-medium mt-2 p-2 bg-red-100 rounded">Raison: ${dm.rejectionReason}</div>` : ''}
                                                <div class="flex gap-2 mt-2">
                                                    <button onclick="VendeurModule.deleteIndependentDeliveryMan('${dm.id}'); VendeurModule.showIndependentDeliveryMenList()" class="flex-1 px-3 py-1.5 bg-red-600 text-white text-xs font-black rounded hover:bg-red-700">Supprimer</button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        editIndependentDeliveryMan(deliveryManId) {
            const dm = CORE.db.independentDeliveryMen.find(m => m.id === deliveryManId);
            if (!dm) return UI.toast('Livreur introuvable', 'error');
            
            // Sauvegarder l'ID pour l'utiliser dans updateIndependentDeliveryMan
            this.editingDeliveryManId = deliveryManId;

            UI.modal('���? ��� � � �diter livreur ind�pendant', `
                <div class="space-y-4">
                    ${UI.input('edit_idm_name','Nom complet','text', dm.name || '', '',true)}
                    ${UI.input('edit_idm_phone','T�l�phone','tel', dm.phone || '', '', true)}
                    ${UI.textarea('edit_idm_notes','Notes', dm.notes || '', 'Notes optionnelles', 2)}
                    ${UI.select('edit_idm_status','Statut', [{value:'active',label:'Actif'},{value:'inactive',label:'Inactif'}], dm.status || 'active', true)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'VendeurModule.showIndependentDeliveryMenList()', class: 'px-5 py-2.5 bg-slate-200 text-slate-700 font-black rounded-xl hover:bg-slate-300 transition' },
                { label: 'Enregistrer', onclick: 'VendeurModule.updateIndependentDeliveryMan()', class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        updateIndependentDeliveryMan(deliveryManId) {
            // Utiliser l'ID sauvegard� si non fourni
            const actualId = deliveryManId || this.editingDeliveryManId;
            const dm = CORE.db.independentDeliveryMen.find(m => m.id === actualId);
            if (!dm) return UI.toast('Livreur introuvable', 'error');

            const name = UI.val('edit_idm_name').trim();
            const phone = UI.val('edit_idm_phone').trim();
            const notes = UI.val('edit_idm_notes').trim();
            const status = UI.val('edit_idm_status');

            if (!name || !phone) return UI.toast('Nom et t�l�phone requis', 'warning');

            const oldName = dm.name;
            dm.name = name;
            dm.phone = phone;
            dm.notes = notes;
            dm.status = status;
            
            // Enregistrer dans le journal d'audit
            const currentUser = CORE.state.currentUser;
            CORE.db.auditLogs = CORE.db.auditLogs || [];
            CORE.db.auditLogs.push({
                id: 'audit_' + Date.now(),
                timestamp: new Date().toISOString(),
                userId: currentUser?.id,
                userName: currentUser?.name,
                userRole: currentUser?.role,
                posId: currentUser?.pos,
                action: 'update',
                entity: 'livreur_independant',
                entityId: actualId,
                entityName: name,
                details: `Livreur ind�pendant modifi�: ${oldName} ���? ${name}`,
                status: 'success'
            });
            CORE.save();
            
            // Nettoyer l'ID temporaire
            this.editingDeliveryManId = null;

            UI.closeModal();
            UI.toast('Livreur mis �� jour', 'success');
            VendeurModule.showIndependentDeliveryMenList();
            App.rerender();
        },

        deleteIndependentDeliveryMan(deliveryManId) {
            if (!confirm('Supprimer ce livreur ind�pendant?')) return;

            const index = CORE.db.independentDeliveryMen.findIndex(m => m.id === deliveryManId);
            if (index !== -1) {
                const dm = CORE.db.independentDeliveryMen[index];
                const dmName = dm?.name || 'Inconnu';
                
                CORE.db.independentDeliveryMen.splice(index, 1);
                
                // Enregistrer dans le journal d'audit
                const currentUser = CORE.state.currentUser;
                CORE.db.auditLogs = CORE.db.auditLogs || [];
                CORE.db.auditLogs.push({
                    id: 'audit_' + Date.now(),
                    timestamp: new Date().toISOString(),
                    userId: currentUser?.id,
                    userName: currentUser?.name,
                    userRole: currentUser?.role,
                    posId: currentUser?.pos,
                    action: 'delete',
                    entity: 'livreur_independant',
                    entityId: deliveryManId,
                    entityName: dmName,
                    details: `Livreur ind�pendant supprim�: ${dmName}`,
                    status: 'success'
                });
                CORE.save();
                UI.toast('Livreur supprim�', 'success');
            }
        },

        sendDeliveryBySMS(deliveryId, deliveryManId) {
            const result = CORE.sendDeliveryBySMS(deliveryId, deliveryManId);
            if (result) {
                UI.toast('Bon envoy� par SMS', 'success');
                App.rerender();
            } else {
                UI.toast('Erreur lors de l\'envoi', 'error');
            }
        },

        // Delivery Ticket Templates
        showDeliveryTemplatesModal() {
            const vendeurId = CORE.state.currentUser?.id;
            const smsTemplate = CORE.getOrCreateDefaultTemplate(vendeurId, 'SMS');
            const directTemplate = CORE.getOrCreateDefaultTemplate(vendeurId, 'Direct');
            const receiptSettings = CORE.getReceiptSettings(vendeurId);

            UI.modal('��Ÿ?� Formats des bons et re��us', `
                <div class="space-y-6 max-h-[700px] overflow-y-auto">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl text-sm text-blue-700">
                        <div class="font-black mb-1">��Ÿ? � Personnalisation</div>
                        <p>Personnalisez les formats des bons de livraison et des re��us imprim�s par vos livreurs.</p>
                    </div>

                    <!-- Tabs -->
                    <div class="flex gap-2 border-b border-slate-200 pb-2">
                        <button onclick="VendeurModule.switchTemplateTab('sms')" id="tab_sms" class="px-4 py-2 rounded-xl font-bold text-sm bg-blue-100 text-blue-700">��Ÿ? � SMS</button>
                        <button onclick="VendeurModule.switchTemplateTab('direct')" id="tab_direct" class="px-4 py-2 rounded-xl font-bold text-sm bg-slate-100 text-slate-600">��Ÿ? ��� � � Direct</button>
                        <button onclick="VendeurModule.switchTemplateTab('receipt')" id="tab_receipt" class="px-4 py-2 rounded-xl font-bold text-sm bg-slate-100 text-slate-600">��Ÿ � � Re��u</button>
                    </div>

                    <!-- SMS Template -->
                    <div id="panel_sms" class="template-panel">
                        <div class="border border-slate-200 rounded-2xl overflow-hidden">
                            <div class="p-4 bg-slate-50 border-b border-slate-200 font-black text-slate-900">��Ÿ? � Format SMS</div>
                            <div class="p-4">
                                <textarea id="sms_template" class="w-full h-40 px-3 py-2 border border-slate-200 rounded-xl font-mono text-sm" placeholder="Contenu du SMS...">${smsTemplate?.content || ''}</textarea>
                                <div class="mt-3 text-xs text-slate-600">
                                    <div class="font-black mb-2">Variables disponibles:</div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <span>�� ?� � {orderRef} - R�f�rence</span>
                                        <span>�� ?� � {clientName} - Nom client</span>
                                        <span>�� ?� � {address} - Adresse</span>
                                        <span>�� ?� � {clientPhone} - T�l�phone</span>
                                        <span>�� ?� � {amount} - Montant total</span>
                                        <span>�� ?� � {collectedAmount} - �?� collecter</span>
                                        <span>�� ?� � {items} - Produits �� livrer</span>
                                        <span>�� ?� � {deliveryTime} - Heure de livraison</span>
                                    </div>
                                </div>
                                <button onclick="VendeurModule.saveDeliveryTemplate('SMS')" class="w-full mt-3 px-4 py-2 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition">
                                    ��Ÿ? � Enregistrer format SMS
                                </button>
                            </div>
                        </div>
                        <div class="border border-slate-200 rounded-2xl overflow-hidden mt-4">
                            <div class="p-4 bg-slate-50 border-b border-slate-200 font-black text-slate-900">��Ÿ? ��� � � Aper��u SMS</div>
                            <div class="p-4 bg-slate-900 text-white rounded-xl font-mono text-sm whitespace-pre-wrap break-words max-h-48 overflow-y-auto" id="sms_preview">
                                (aper��u du SMS)
                            </div>
                        </div>
                    </div>

                    <!-- Direct Template -->
                    <div id="panel_direct" class="template-panel hidden">
                        <div class="border border-slate-200 rounded-2xl overflow-hidden">
                            <div class="p-4 bg-slate-50 border-b border-slate-200 font-black text-slate-900">��Ÿ? ��� � � Format Direct</div>
                            <div class="p-4">
                                <textarea id="direct_template" class="w-full h-40 px-3 py-2 border border-slate-200 rounded-xl font-mono text-sm" placeholder="Contenu du bon direct...">${directTemplate?.content || ''}</textarea>
                                <div class="mt-3 text-xs text-slate-600">
                                    <div class="font-black mb-2">Variables disponibles:</div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <span>�� ?� � {orderRef} - R�f�rence</span>
                                        <span>�� ?� � {clientName} - Nom client</span>
                                        <span>�� ?� � {address} - Adresse</span>
                                        <span>�� ?� � {clientPhone} - T�l�phone</span>
                                        <span>�� ?� � {amount} - Montant total</span>
                                        <span>�� ?� � {collectedAmount} - �?� collecter</span>
                                        <span>�� ?� � {items} - Produits �� livrer</span>
                                        <span>�� ?� � {deliveryTime} - Heure de livraison</span>
                                    </div>
                                </div>
                                <button onclick="VendeurModule.saveDeliveryTemplate('Direct')" class="w-full mt-3 px-4 py-2 bg-orange-600 text-white font-black rounded-xl hover:bg-orange-700 transition">
                                    ��Ÿ? � Enregistrer format Direct
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Receipt Template -->
                    <div id="panel_receipt" class="template-panel hidden">
                        <div class="border border-slate-200 rounded-2xl overflow-hidden">
                            <div class="p-4 bg-slate-50 border-b border-slate-200 font-black text-slate-900">��Ÿ � � Format Re��u de Livraison</div>
                            <div class="p-4 space-y-4">
                                <!-- En-t��te personnalis� -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Nom de l'entreprise</label>
                                    <input type="text" id="receipt_company_name" value="${receiptSettings.companyName || ''}" class="w-full px-3 py-2 border border-slate-200 rounded-xl" placeholder="Ex: Ma Boutique SARL">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Slogan / Sous-titre</label>
                                    <input type="text" id="receipt_subtitle" value="${receiptSettings.subtitle || ''}" class="w-full px-3 py-2 border border-slate-200 rounded-xl" placeholder="Ex: Livraison rapide et s��re">
                                </div>

                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">T�l�phone boutique</label>
                                    <input type="text" id="receipt_phone" value="${receiptSettings.phone || ''}" class="w-full px-3 py-2 border border-slate-200 rounded-xl" placeholder="Ex: +225 07 00 00 00">
                                </div>

                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Adresse boutique</label>
                                    <input type="text" id="receipt_address" value="${receiptSettings.address || ''}" class="w-full px-3 py-2 border border-slate-200 rounded-xl" placeholder="Ex: Abidjan, Cocody">
                                </div>

                                <!-- Options d'affichage -->
                                <div class="border-t border-slate-200 pt-4">
                                    <div class="font-bold text-slate-700 mb-3">Options d'affichage</div>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="receipt_show_logo" ${receiptSettings.showLogo !== false ? 'checked' : ''} class="w-4 h-4 rounded border-slate-300">
                                            <span class="text-sm">Afficher le logo/emoji</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="receipt_show_items" ${receiptSettings.showItems !== false ? 'checked' : ''} class="w-4 h-4 rounded border-slate-300">
                                            <span class="text-sm">Afficher le d�tail des articles</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="receipt_show_signature" ${receiptSettings.showSignature !== false ? 'checked' : ''} class="w-4 h-4 rounded border-slate-300">
                                            <span class="text-sm">Zone de signature client</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="receipt_show_commission" ${receiptSettings.showCommission ? 'checked' : ''} class="w-4 h-4 rounded border-slate-300">
                                            <span class="text-sm">Afficher la commission livreur</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="receipt_show_proof_photos" ${receiptSettings.showProofPhotos ? 'checked' : ''} class="w-4 h-4 rounded border-slate-300">
                                            <span class="text-sm">Mention "Photos de preuve"</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Message de remerciement -->
                                <div class="border-t border-slate-200 pt-4">
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Message de remerciement</label>
                                    <input type="text" id="receipt_thank_message" value="${receiptSettings.thankMessage || 'Merci pour votre confiance!'}" class="w-full px-3 py-2 border border-slate-200 rounded-xl" placeholder="Ex: Merci pour votre confiance!">
                                </div>

                                <!-- Note de bas de page -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Note de bas de page (optionnel)</label>
                                    <textarea id="receipt_footer_note" class="w-full h-20 px-3 py-2 border border-slate-200 rounded-xl text-sm" placeholder="Ex: Conditions de retour, politique de remboursement...">${receiptSettings.footerNote || ''}</textarea>
                                </div>

                                <button onclick="VendeurModule.saveReceiptSettings()" class="w-full mt-3 px-4 py-2 bg-green-600 text-white font-black rounded-xl hover:bg-green-700 transition">
                                    ��Ÿ? � Enregistrer format Re��u
                                </button>
                            </div>
                        </div>

                        <!-- Aper��u du re��u -->
                        <div class="border border-slate-200 rounded-2xl overflow-hidden mt-4">
                            <div class="p-4 bg-slate-50 border-b border-slate-200 font-black text-slate-900 flex justify-between items-center">
                                <span>��Ÿ? ��� � � Aper��u du Re��u</span>
                                <button onclick="VendeurModule.refreshReceiptPreview()" class="px-3 py-1 bg-slate-200 text-slate-700 rounded-lg text-xs font-bold hover:bg-slate-300">��Ÿ�? Actualiser</button>
                            </div>
                            <div id="receipt_preview" class="p-4 bg-white max-h-80 overflow-y-auto">
                                <div class="mx-auto bg-slate-50 p-4 rounded-xl font-mono text-xs" style="max-width: 280px;">
                                    (Cliquez sur "Actualiser" pour voir l'aper��u)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            // Ajouter listeners pour l'aper��u SMS
            const smsInput = document.getElementById('sms_template');
            if (smsInput) {
                smsInput.addEventListener('input', () => {
                    document.getElementById('sms_preview').textContent = smsInput.value;
                });
            }
        },

        // Changer d'onglet de template
        switchTemplateTab(tab) {
            // Masquer tous les panels
            document.querySelectorAll('.template-panel').forEach(p => p.classList.add('hidden'));
            // R�initialiser tous les tabs
            ['sms', 'direct', 'receipt'].forEach(t => {
                const btn = document.getElementById(`tab_${t}`);
                if (btn) {
                    btn.classList.remove('bg-blue-100', 'text-blue-700');
                    btn.classList.add('bg-slate-100', 'text-slate-600');
                }
            });
            // Afficher le panel s�lectionn�
            const panel = document.getElementById(`panel_${tab}`);
            if (panel) panel.classList.remove('hidden');
            // Activer le tab
            const activeBtn = document.getElementById(`tab_${tab}`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-slate-100', 'text-slate-600');
                activeBtn.classList.add('bg-blue-100', 'text-blue-700');
            }
            // Rafra��chir l'aper��u du re��u si on est sur l'onglet re��u
            if (tab === 'receipt') {
                setTimeout(() => this.refreshReceiptPreview(), 100);
            }
        },

        // Rafra��chir l'aper��u du re��u
        refreshReceiptPreview() {
            const settings = {
                companyName: UI.val('receipt_company_name') || CORE.getCompanyName(),
                subtitle: UI.val('receipt_subtitle') || 'Re��u de Livraison',
                phone: UI.val('receipt_phone') || '',
                address: UI.val('receipt_address') || '',
                showLogo: document.getElementById('receipt_show_logo')?.checked !== false,
                showItems: document.getElementById('receipt_show_items')?.checked !== false,
                showSignature: document.getElementById('receipt_show_signature')?.checked !== false,
                showCommission: document.getElementById('receipt_show_commission')?.checked || false,
                showProofPhotos: document.getElementById('receipt_show_proof_photos')?.checked || false,
                thankMessage: UI.val('receipt_thank_message') || 'Merci pour votre confiance!',
                footerNote: UI.val('receipt_footer_note') || ''
            };

            const previewHtml = `
                <div class="mx-auto bg-white border border-slate-200 p-3 rounded-lg font-mono text-[10px]" style="max-width: 280px;">
                    <div class="text-center border-b border-dashed border-slate-400 pb-2 mb-2">
                        ${settings.showLogo ? '<div class="text-lg">��Ÿšš</div>' : ''}
                        <div class="font-bold text-sm">${settings.companyName}</div>
                        <div class="text-slate-500 text-[9px]">${settings.subtitle}</div>
                        ${settings.phone ? `<div class="text-[9px]">��Ÿ?ž ${settings.phone}</div>` : ''}
                        ${settings.address ? `<div class="text-[9px]">��Ÿ? � ${settings.address}</div>` : ''}
                    </div>
                    <div class="border-b border-dashed border-slate-300 pb-2 mb-2">
                        <div class="flex justify-between"><span class="text-slate-500">N�? � Bon:</span><span class="font-bold">CMD-001</span></div>
                        <div class="flex justify-between"><span class="text-slate-500">Date:</span><span>${new Date().toLocaleDateString('fr-FR')}</span></div>
                        <div class="flex justify-between"><span class="text-slate-500">Statut:</span><span class="bg-green-500 text-white px-1 rounded text-[8px]">���?? LIVR�E</span></div>
                    </div>
                    <div class="border-b border-dashed border-slate-300 pb-2 mb-2">
                        <div class="flex justify-between"><span class="text-slate-500">Client:</span><span>Jean Dupont</span></div>
                        <div class="flex justify-between"><span class="text-slate-500">T�l:</span><span>+225 07 00 00 00</span></div>
                    </div>
                    ${settings.showItems ? `
                        <div class="border-b border-dashed border-slate-300 pb-2 mb-2">
                            <div class="font-bold mb-1">Articles (2)</div>
                            <div class="flex justify-between text-[9px]"><span>Produit A</span><span>x2</span><span>5 000 F</span></div>
                            <div class="flex justify-between text-[9px]"><span>Produit B</span><span>x1</span><span>3 000 F</span></div>
                        </div>
                    ` : ''}
                    <div class="text-center font-bold text-sm py-2 bg-slate-100 rounded my-2">
                        TOTAL: 8 000 F
                    </div>
                    ${settings.showCommission ? `
                        <div class="flex justify-between text-[9px] text-slate-500 border-b border-dashed border-slate-300 pb-2 mb-2">
                            <span>Commission livreur:</span><span>400 F</span>
                        </div>
                    ` : ''}
                    ${settings.showProofPhotos ? `
                        <div class="text-center text-[9px] text-green-600 border-b border-dashed border-slate-300 pb-2 mb-2">
                            ��Ÿ? � Photos de preuve jointes
                        </div>
                    ` : ''}
                    ${settings.showSignature ? `
                        <div class="text-center mt-3">
                            <div class="text-[9px] text-slate-500">Signature client</div>
                            <div class="border-b border-slate-400 w-24 mx-auto mt-4 mb-1"></div>
                        </div>
                    ` : ''}
                    <div class="text-center text-slate-500 mt-3 pt-2 border-t border-dashed border-slate-400">
                        <div>${settings.thankMessage}</div>
                        ${settings.footerNote ? `<div class="mt-1 text-[8px]">${settings.footerNote}</div>` : ''}
                    </div>
                </div>
            `;
            document.getElementById('receipt_preview').innerHTML = previewHtml;
        },

        // Sauvegarder les param��tres du re��u
        saveReceiptSettings() {
            const vendeurId = CORE.state.currentUser?.id;
            const settings = {
                companyName: UI.val('receipt_company_name')?.trim() || '',
                subtitle: UI.val('receipt_subtitle')?.trim() || '',
                phone: UI.val('receipt_phone')?.trim() || '',
                address: UI.val('receipt_address')?.trim() || '',
                showLogo: document.getElementById('receipt_show_logo')?.checked !== false,
                showItems: document.getElementById('receipt_show_items')?.checked !== false,
                showSignature: document.getElementById('receipt_show_signature')?.checked !== false,
                showCommission: document.getElementById('receipt_show_commission')?.checked || false,
                showProofPhotos: document.getElementById('receipt_show_proof_photos')?.checked || false,
                thankMessage: UI.val('receipt_thank_message')?.trim() || 'Merci pour votre confiance!',
                footerNote: UI.val('receipt_footer_note')?.trim() || ''
            };
            
            CORE.saveReceiptSettings(vendeurId, settings);
            UI.toast('Format du re��u enregistr�', 'success');
            this.refreshReceiptPreview();
        },

        saveDeliveryTemplate(type) {
            const vendeurId = CORE.state.currentUser?.id;
            const content = type === 'SMS' ? UI.val('sms_template').trim() : UI.val('direct_template').trim();

            if (!content) return UI.toast('Le contenu ne peut pas ��tre vide', 'warning');

            CORE.updateDeliveryTicketTemplate(vendeurId, type, content);
            UI.toast(`Format ${type} enregistr�`, 'success');
        },

        showVendorProfileModal(userId) {
            const user = CORE.getUser(userId);
            if (!user || user.role !== 'vendeur') return;

            const stats = this.getVendorStats(userId);
            const badges = CORE.db.vendorBadges || [];
            const currentBadge = user.badge ? badges.find(b => b.id === user.badge) : null;
            const joinedDate = user.joinedDate ? new Date(user.joinedDate).toLocaleDateString('fr-FR') : '�� ?��';

            UI.modal(`��Ÿ? � Profil - ${user.name}`, `
                <div class="space-y-6">
                    <!-- Header Profile -->
                    <div class="flex items-start gap-4">
                        <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-slate-300 to-slate-400 flex items-center justify-center text-2xl font-black text-white shadow-lg">
                            ${user.avatar}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h2 class="text-lg font-black text-slate-900">${user.name}</h2>
                                <div class="flex items-center gap-1">
                                    ${[...Array(Math.floor(stats.rating))].map(() => `<i data-lucide="star" class="w-4 h-4 text-yellow-400 fill-yellow-400"></i>`).join('')}
                                    <span class="text-xs font-black text-slate-600 ml-1">${stats.rating.toFixed(1)}</span>
                                </div>
                            </div>
                            <div class="text-xs text-slate-500">Membre depuis ${joinedDate}</div>
                            ${currentBadge ? `
                                <div class="mt-2 inline-flex items-center gap-1 px-2 py-1 bg-${currentBadge.color}-100 text-${currentBadge.color}-700 rounded-full text-xs font-bold">
                                    <i data-lucide="${currentBadge.icon}" class="w-3 h-3"></i> ${currentBadge.label}
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Bio & Sp�cialit�s -->
                    ${user.bio ? `
                        <div class="p-3 bg-slate-50 rounded-xl border border-slate-200">
                            <div class="text-xs font-bold text-slate-600 mb-1 uppercase">��Ÿ? � Bio</div>
                            <div class="text-sm text-slate-700">${user.bio}</div>
                        </div>
                    ` : ''}

                    ${stats.specialties && stats.specialties.length > 0 ? `
                        <div class="p-3 bg-blue-50 rounded-xl border border-blue-200">
                            <div class="text-xs font-bold text-blue-600 mb-2 uppercase">��ŸŽ � Sp�cialit�s</div>
                            <div class="flex flex-wrap gap-1">
                                ${stats.specialties.map(s => `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-black">${s}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Statistiques -->
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="p-3 bg-emerald-50 rounded-xl">
                            <div class="text-2xl font-black text-emerald-600">${stats.salesCount}</div>
                            <div class="text-[10px] font-bold text-emerald-600 uppercase mt-1">Ventes</div>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-xl">
                            <div class="text-2xl font-black text-blue-600">${CORE.formatPrice(stats.totalSales).split(' ')[0]}</div>
                            <div class="text-[10px] font-bold text-blue-600 uppercase mt-1">Total</div>
                        </div>
                        <div class="p-3 bg-purple-50 rounded-xl">
                            <div class="text-2xl font-black text-purple-600">${CORE.formatPrice(stats.avgOrder).split(' ')[0]}</div>
                            <div class="text-[10px] font-bold text-purple-600 uppercase mt-1">Moyenne</div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showEditVendorProfileModal(userId) {
            const user = CORE.getUser(userId);
            if (!user || user.role !== 'vendeur') return;

            const specialtiesList = [
                'Laiterie', '�picerie', 'Huiles', 'C�r�ales', 'Boissons', 'Surgel�s', '�lectronique', 'Hygi��ne',
                'Viande & Poisson', 'Fruits & L�gumes', 'Boulangerie', 'P��tisserie', 'Cosm�tiques', 'V��tements',
                'Chaussures', 'Accessoires', 'Pharmacie', 'Jouets', 'Livres', 'Fournitures Scolaires',
                '�quipement Maison', 'Mobilier', 'D�coration', 'Jardin', 'Animaux', 'Sport & Loisirs',
                'Beaut� & Wellness', 'Technologie', 'Informatique', 'Travaux & Outils'
            ];

            UI.modal(`���? ��� � � �diter Profil - ${user.name}`, `
                <div class="space-y-4">
                    <div id="vendor-profile-save-status" class="hidden p-3 bg-emerald-100 border border-emerald-300 rounded-lg text-sm text-emerald-700 font-bold flex items-center gap-2">
                        <span>���?? Sauvegard� automatiquement</span>
                    </div>
                    ${UI.textarea('vendor_bio', 'Bio / Description', user.bio || '', 'D�crivez vos exp�riences et sp�cialit�s...', 3)}
                    
                    <div>
                        <label class="block text-xs font-black text-slate-500 uppercase tracking-wider mb-2">Sp�cialit�s (cochez celles qui vous correspondent)</label>
                        <div class="grid grid-cols-2 gap-2 max-h-96 overflow-y-auto p-2 border border-slate-200 rounded-xl bg-slate-50">
                            ${specialtiesList.map(s => `<label class="flex items-center gap-2 p-2 rounded-lg border border-slate-200 hover:bg-white cursor-pointer bg-white"><input type="checkbox" class="specialty-checkbox" value="${s}" ${(user.specialties || []).includes(s) ? 'checked' : ''} onchange="VendeurModule.autoSaveVendorProfile(${userId})"><span class="text-sm font-bold text-slate-700">${s}</span></label>`).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            
            // Ajouter l'�v�nement onchange pour la bio
            setTimeout(() => {
                const bioInput = document.getElementById('vendor_bio');
                if (bioInput) {
                    bioInput.addEventListener('change', () => VendeurModule.autoSaveVendorProfile(userId));
                }
            }, 100);
        },

        autoSaveVendorProfile(userId) {
            const user = CORE.getUser(userId);
            if (!user) return;

            const bio = UI.val('vendor_bio')?.trim() || '';
            const specialtyCheckboxes = document.querySelectorAll('.specialty-checkbox:checked');
            const specialties = Array.from(specialtyCheckboxes).map(cb => cb.value);

            user.bio = bio;
            user.specialties = specialties;
            CORE.save();

            // Afficher le message de sauvegarde
            const statusDiv = document.getElementById('vendor-profile-save-status');
            if (statusDiv) {
                statusDiv.classList.remove('hidden');
                setTimeout(() => statusDiv.classList.add('hidden'), 2000);
            }
        },

        saveVendorProfile(userId) {
            this.autoSaveVendorProfile(userId);
            UI.closeModal();
            App.rerender();
        },

        showVendorProfileModalFromSettings(userId) {
            this.showVendorProfileModal(userId);
            window.currentModalBack = () => this.showSettingsModal();
        },

        showEditVendorProfileModalFromSettings(userId) {
            this.showEditVendorProfileModal(userId);
            window.currentModalBack = () => this.showSettingsModal();
        },

        // =====================
        // KPIs & PERFORMANCES
        // =====================
        getKPIs(userId, period = 'today') {
            const user = CORE.getUser(userId);
            if (!user) return null;

            // D�terminer la date de d�but
            const now = new Date();
            let startDate = new Date();
            
            if (period === 'today') {
                startDate.setHours(0, 0, 0, 0);
            } else if (period === 'week') {
                startDate.setDate(now.getDate() - 7);
            } else if (period === 'month') {
                startDate.setDate(now.getDate() - 30);
            }

            const startTime = startDate.getTime();
            const userPos = user.pos;

            // R�cup�rer les commandes du vendeur pendant la p�riode (filtr� par POS)
            const userOrders = CORE.db.orders.filter(o => 
                o.sellerId === userId && 
                new Date(o.createdAt).getTime() >= startTime &&
                (o.posId == userPos || !o.posId || !userPos)
            );

            // Commandes livr�es vs totales
            const deliveredOrders = userOrders.filter(o => o.status === 'delivered');
            const totalOrders = userOrders.length;

            // KPIs de vente
            const totalSales = deliveredOrders.reduce((a, o) => a + (o.total || 0), 0);
            const avgTicket = deliveredOrders.length > 0 ? Math.round(totalSales / deliveredOrders.length) : 0;
            const conversionRate = totalOrders > 0 ? Math.round((deliveredOrders.length / totalOrders) * 100) : 0;

            // Nombre de clients uniques
            const uniqueClients = [...new Set(userOrders
                .filter(o => o.clientId)
                .map(o => o.clientId))].length;

            // Clients par jour
            const daysInPeriod = Math.max(1, Math.ceil((now - startDate) / (1000 * 60 * 60 * 24)));
            const clientsPerDay = Math.round(uniqueClients / daysInPeriod);

            // Satisfaction client (bas�e sur les notes des clients)
            const clientsWithOrders = new Set(deliveredOrders.map(o => o.clientId).filter(Boolean));
            let satisfactionScore = 4.5; // Par d�faut
            let satisfactionCount = 0;

            clientsWithOrders.forEach(clientId => {
                const c = CORE.getClient(clientId);
                if (c && c.tags) {
                    if (c.tags.includes('bon-client')) satisfactionScore += 1;
                    if (c.tags.includes('mauvais-client')) satisfactionScore -= 1;
                    satisfactionCount++;
                }
            });

            if (satisfactionCount > 0) {
                satisfactionScore = Math.max(1, Math.min(5, satisfactionScore / (satisfactionCount || 1)));
            }

            return {
                period,
                totalSales,
                avgTicket,
                uniqueClients,
                clientsPerDay,
                conversionRate,
                deliveredOrders: deliveredOrders.length,
                totalOrders,
                satisfactionScore: satisfactionScore.toFixed(1),
                daysInPeriod
            };
        },

        showKPIsModal(userId) {
            const user = CORE.getUser(userId);
            const kpis = {
                today: this.getKPIs(userId, 'today'),
                week: this.getKPIs(userId, 'week'),
                month: this.getKPIs(userId, 'month')
            };

            const currentKPIs = kpis.today;
            
            // R�cup�rer le nom du POS
            const posName = user?.pos ? (CORE.db.pos?.find(p => p.id === user.pos)?.name || 'POS inconnu') : 'Tous les POS';

            UI.modal('��Ÿ?�? KPIs & Performances', `
                <div class="space-y-6">
                    <!-- POS Filter Info -->
                    <div class="p-3 bg-indigo-50 rounded-xl border border-indigo-200 flex items-center gap-2">
                        <span class="text-xl">��Ÿ? �</span>
                        <div>
                            <div class="text-xs font-bold text-indigo-600 uppercase">Filtr� par Point de Vente</div>
                            <div class="text-sm font-bold text-indigo-700">${posName}</div>
                        </div>
                    </div>

                    <!-- Period Selector -->
                    <div class="flex gap-2">
                        <button onclick="document.querySelectorAll('.kpi-period').forEach(e => e.classList.add('hidden')); document.getElementById('kpi-today').classList.remove('hidden'); this.classList.add('bg-emerald-600','text-white'); this.classList.remove('bg-slate-100','text-slate-700'); document.querySelectorAll('.kpi-btn').forEach(b => { if(b !== this) { b.classList.remove('bg-emerald-600','text-white'); b.classList.add('bg-slate-100','text-slate-700'); } })" class="kpi-btn px-4 py-2 bg-emerald-600 text-white rounded-lg font-bold text-sm hover:bg-emerald-700 transition">Aujourd'hui</button>
                        <button onclick="document.querySelectorAll('.kpi-period').forEach(e => e.classList.add('hidden')); document.getElementById('kpi-week').classList.remove('hidden'); this.classList.add('bg-emerald-600','text-white'); this.classList.remove('bg-slate-100','text-slate-700'); document.querySelectorAll('.kpi-btn').forEach(b => { if(b !== this) { b.classList.remove('bg-emerald-600','text-white'); b.classList.add('bg-slate-100','text-slate-700'); } })" class="kpi-btn px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-bold text-sm hover:bg-slate-200 transition">7 jours</button>
                        <button onclick="document.querySelectorAll('.kpi-period').forEach(e => e.classList.add('hidden')); document.getElementById('kpi-month').classList.remove('hidden'); this.classList.add('bg-emerald-600','text-white'); this.classList.remove('bg-slate-100','text-slate-700'); document.querySelectorAll('.kpi-btn').forEach(b => { if(b !== this) { b.classList.remove('bg-emerald-600','text-white'); b.classList.add('bg-slate-100','text-slate-700'); } })" class="kpi-btn px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-bold text-sm hover:bg-slate-200 transition">30 jours</button>
                    </div>

                    <!-- Today KPIs -->
                    <div id="kpi-today" class="kpi-period space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-4 bg-emerald-50 rounded-xl border border-emerald-200">
                                <div class="text-xs font-bold text-emerald-600 uppercase mb-1">��Ÿ? � Total Ventes</div>
                                <div class="text-2xl font-black text-emerald-700">${CORE.formatPrice(kpis.today.totalSales)}</div>
                                <div class="text-xs text-emerald-600 mt-1">${kpis.today.deliveredOrders} ventes livr�es</div>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
                                <div class="text-xs font-bold text-blue-600 uppercase mb-1">��Ÿ?Š Ticket Moyen</div>
                                <div class="text-2xl font-black text-blue-700">${CORE.formatPrice(kpis.today.avgTicket)}</div>
                                <div class="text-xs text-blue-600 mt-1">Par transaction</div>
                            </div>
                            <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
                                <div class="text-xs font-bold text-purple-600 uppercase mb-1">��Ÿ? � Clients Uniques</div>
                                <div class="text-2xl font-black text-purple-700">${kpis.today.uniqueClients}</div>
                                <div class="text-xs text-purple-600 mt-1">${kpis.today.clientsPerDay} par jour</div>
                            </div>
                            <div class="p-4 bg-amber-50 rounded-xl border border-amber-200">
                                <div class="text-xs font-bold text-amber-600 uppercase mb-1">��ŸŽ � Conversion</div>
                                <div class="text-2xl font-black text-amber-700">${kpis.today.conversionRate}%</div>
                                <div class="text-xs text-amber-600 mt-1">${kpis.today.totalOrders} paniers cr��s</div>
                            </div>
                        </div>

                        <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-xs font-bold text-yellow-600 uppercase">�� � � Satisfaction Client</div>
                                <div class="text-2xl font-black text-yellow-700">${kpis.today.satisfactionScore}/5</div>
                            </div>
                            <div class="flex gap-1">
                                ${[...Array(5)].map((_, i) => `
                                    <div class="h-1 flex-1 rounded-full ${i < Math.floor(kpis.today.satisfactionScore) ? 'bg-yellow-400' : 'bg-slate-200'}"></div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Week KPIs -->
                    <div id="kpi-week" class="kpi-period hidden space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-4 bg-emerald-50 rounded-xl border border-emerald-200">
                                <div class="text-xs font-bold text-emerald-600 uppercase mb-1">��Ÿ? � Total Ventes</div>
                                <div class="text-2xl font-black text-emerald-700">${CORE.formatPrice(kpis.week.totalSales)}</div>
                                <div class="text-xs text-emerald-600 mt-1">${kpis.week.deliveredOrders} ventes</div>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
                                <div class="text-xs font-bold text-blue-600 uppercase mb-1">��Ÿ?Š Ticket Moyen</div>
                                <div class="text-2xl font-black text-blue-700">${CORE.formatPrice(kpis.week.avgTicket)}</div>
                                <div class="text-xs text-blue-600 mt-1">7 derniers jours</div>
                            </div>
                            <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
                                <div class="text-xs font-bold text-purple-600 uppercase mb-1">��Ÿ? � Clients Uniques</div>
                                <div class="text-2xl font-black text-purple-700">${kpis.week.uniqueClients}</div>
                                <div class="text-xs text-purple-600 mt-1">${kpis.week.clientsPerDay} par jour</div>
                            </div>
                            <div class="p-4 bg-amber-50 rounded-xl border border-amber-200">
                                <div class="text-xs font-bold text-amber-600 uppercase mb-1">��ŸŽ � Conversion</div>
                                <div class="text-2xl font-black text-amber-700">${kpis.week.conversionRate}%</div>
                                <div class="text-xs text-amber-600 mt-1">${kpis.week.totalOrders} paniers</div>
                            </div>
                        </div>
                        <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-xs font-bold text-yellow-600 uppercase">�� � � Satisfaction Client</div>
                                <div class="text-2xl font-black text-yellow-700">${kpis.week.satisfactionScore}/5</div>
                            </div>
                            <div class="flex gap-1">
                                ${[...Array(5)].map((_, i) => `
                                    <div class="h-1 flex-1 rounded-full ${i < Math.floor(kpis.week.satisfactionScore) ? 'bg-yellow-400' : 'bg-slate-200'}"></div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Month KPIs -->
                    <div id="kpi-month" class="kpi-period hidden space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-4 bg-emerald-50 rounded-xl border border-emerald-200">
                                <div class="text-xs font-bold text-emerald-600 uppercase mb-1">��Ÿ? � Total Ventes</div>
                                <div class="text-2xl font-black text-emerald-700">${CORE.formatPrice(kpis.month.totalSales)}</div>
                                <div class="text-xs text-emerald-600 mt-1">${kpis.month.deliveredOrders} ventes</div>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
                                <div class="text-xs font-bold text-blue-600 uppercase mb-1">��Ÿ?Š Ticket Moyen</div>
                                <div class="text-2xl font-black text-blue-700">${CORE.formatPrice(kpis.month.avgTicket)}</div>
                                <div class="text-xs text-blue-600 mt-1">30 derniers jours</div>
                            </div>
                            <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
                                <div class="text-xs font-bold text-purple-600 uppercase mb-1">��Ÿ? � Clients Uniques</div>
                                <div class="text-2xl font-black text-purple-700">${kpis.month.uniqueClients}</div>
                                <div class="text-xs text-purple-600 mt-1">${kpis.month.clientsPerDay} par jour</div>
                            </div>
                            <div class="p-4 bg-amber-50 rounded-xl border border-amber-200">
                                <div class="text-xs font-bold text-amber-600 uppercase mb-1">��ŸŽ � Conversion</div>
                                <div class="text-2xl font-black text-amber-700">${kpis.month.conversionRate}%</div>
                                <div class="text-xs text-amber-600 mt-1">${kpis.month.totalOrders} paniers</div>
                            </div>
                        </div>
                        <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-xs font-bold text-yellow-600 uppercase">�� � � Satisfaction Client</div>
                                <div class="text-2xl font-black text-yellow-700">${kpis.month.satisfactionScore}/5</div>
                            </div>
                            <div class="flex gap-1">
                                ${[...Array(5)].map((_, i) => `
                                    <div class="h-1 flex-1 rounded-full ${i < Math.floor(kpis.month.satisfactionScore) ? 'bg-yellow-400' : 'bg-slate-200'}"></div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        // =====================
        // CLIENTS FAVORIS & HISTORIQUE
        // =====================
        toggleFavoriteClient(clientId) {
            const idx = this.state.favoriteClients.indexOf(clientId);
            if (idx >= 0) {
                this.state.favoriteClients.splice(idx, 1);
                UI.toast('Client retir� des favoris', 'info');
            } else {
                this.state.favoriteClients.push(clientId);
                UI.toast('Client ajout� aux favoris �� � �', 'success');
            }
            CORE.save();
            App.rerender();
        },

        isFavoriteClient(clientId) {
            return this.state.favoriteClients.includes(clientId);
        },

        recordClientAccess(clientId) {
            if (!clientId) return;
            const now = new Date().toISOString();
            const idx = this.state.lastAccessedClients.findIndex(a => a.clientId === clientId);
            if (idx >= 0) {
                this.state.lastAccessedClients.splice(idx, 1);
            }
            this.state.lastAccessedClients.unshift({ clientId, lastAccessDate: now });
            // Garder seulement les 10 derniers acc��s
            this.state.lastAccessedClients = this.state.lastAccessedClients.slice(0, 10);
            CORE.save();
        },

        getFavoriteClients() {
            return this.state.favoriteClients
                .map(clientId => CORE.getClient(clientId))
                .filter(c => c !== null)
                .map(c => {
                    const orders = CORE.db.orders.filter(o => o.clientId === c.id && o.status === 'delivered');
                    return {
                        ...c,
                        orderCount: orders.length,
                        totalSpent: orders.reduce((a, o) => a + (o.total || 0), 0),
                        lastOrder: orders.length > 0 ? orders[orders.length - 1].createdAt : null
                    };
                });
        },

        getRecentClients() {
            return this.state.lastAccessedClients
                .map(a => CORE.getClient(a.clientId))
                .filter(c => c !== null)
                .slice(0, 5);
        },

        showFavoritesModal() {
            const favorites = this.getFavoriteClients();
            
            if (favorites.length === 0) {
                UI.toast('Aucun client favori pour le moment', 'info');
                return;
            }

            UI.modal(`�� � � Clients Favoris (${favorites.length})`, `
                <div class="space-y-3 max-h-96 overflow-y-auto">
                    ${favorites.map(c => {
                        const lastOrderDate = c.lastOrder ? new Date(c.lastOrder).toLocaleDateString('fr-FR') : '�� ?��';
                        return `
                            <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl hover:bg-slate-100 transition cursor-pointer" onclick="VendeurModule.recordClientAccess(${c.id}); VendeurModule.selectClient(${c.id}); UI.closeModal()">
                                <div class="flex items-start justify-between mb-2">
                                    <div class="flex-1">
                                        <h3 class="font-bold text-slate-900">${c.name}</h3>
                                        <p class="text-xs text-slate-600">${c.phone || '�� ?��'}</p>
                                    </div>
                                    <button onclick="event.stopPropagation(); VendeurModule.toggleFavoriteClient(${c.id})" class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-lg text-xs font-bold hover:bg-yellow-200 transition">�� � � Retirer</button>
                                </div>
                                <div class="grid grid-cols-3 gap-2 text-xs">
                                    <div class="p-2 bg-white rounded-lg border border-slate-200">
                                        <div class="font-bold text-slate-900">${c.orderCount}</div>
                                        <div class="text-slate-600">Commandes</div>
                                    </div>
                                    <div class="p-2 bg-white rounded-lg border border-slate-200">
                                        <div class="font-bold text-slate-900">${CORE.formatPrice(c.totalSpent).split(' ')[0]}</div>
                                        <div class="text-slate-600">D�pens�</div>
                                    </div>
                                    <div class="p-2 bg-white rounded-lg border border-slate-200">
                                        <div class="font-bold text-slate-900">${lastOrderDate}</div>
                                        <div class="text-slate-600">Dernier</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        // =====================
        // PR�F�RENCES PERSONNELLES
        // =====================
        loadPreferences() {
            const saved = localStorage.getItem('vendeur_preferences');
            if (saved) {
                try {
                    this.state.preferences = { ...this.state.preferences, ...JSON.parse(saved) };
                } catch(e) {}
            }
        },

        savePreferences() {
            console.log('[VendeurModule] savePreferences called');
            try {
                localStorage.setItem('vendeur_preferences', JSON.stringify(this.state.preferences));
                console.log('[VendeurModule] savePreferences - saved to localStorage');
                CORE.save();
                console.log('[VendeurModule] savePreferences - CORE.save() called');
            } catch(e) {
                console.error('[VendeurModule] savePreferences ERROR:', e);
            }
        },

        // =====================
        // PANIER R�SERVATION ISOL� PAR UTILISATEUR/POS
        // =====================
        getReservationCartKey() {
            // Cl� unique par utilisateur et POS pour isoler les paniers de r�servation
            const userId = CORE.user?.id || 'unknown';
            const posId = CORE.user?.pos || 'unknown';
            return `vendeur_reservationCart_${userId}_${posId}`;
        },

        loadReservationCart() {
            const key = this.getReservationCartKey();
            const saved = localStorage.getItem(key);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    this.state.reservationCart = data.cart || [];
                    this.state.reservationManualDeliveryFee = data.deliveryFee || 0;
                    console.log('[VendeurModule] loadReservationCart - loaded for key:', key);
                } catch(e) {
                    console.error('[VendeurModule] loadReservationCart ERROR:', e);
                    this.state.reservationCart = [];
                    this.state.reservationManualDeliveryFee = 0;
                }
            } else {
                // Pas de panier sauvegard� pour cet utilisateur/POS
                this.state.reservationCart = [];
                this.state.reservationManualDeliveryFee = 0;
            }
        },

        saveReservationCart() {
            const key = this.getReservationCartKey();
            try {
                const data = {
                    cart: this.state.reservationCart,
                    deliveryFee: this.state.reservationManualDeliveryFee || 0,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem(key, JSON.stringify(data));
                console.log('[VendeurModule] saveReservationCart - saved for key:', key);
            } catch(e) {
                console.error('[VendeurModule] saveReservationCart ERROR:', e);
            }
        },

        clearSavedReservationCart() {
            const key = this.getReservationCartKey();
            localStorage.removeItem(key);
            console.log('[VendeurModule] clearSavedReservationCart - cleared for key:', key);
        },

        showPreferencesModal() {
            const prefs = this.state.preferences;
            const user = CORE.state.currentUser;
            const posData = CORE.getPOS(user?.pos);
            
            const paymentMethods = [
                { id: 'cash', label: 'Esp��ces', icon: '��Ÿ? �', desc: 'Paiement comptant' },
                { id: 'card', label: 'Carte', icon: '��Ÿ? �', desc: 'Visa, Mastercard' },
                { id: 'mobile_money', label: 'Mobile Money', icon: '��Ÿ? �', desc: 'Orange, MTN, Airtel' },
                { id: 'check', label: 'Ch��que', icon: '���? ��� � �', desc: 'Paiement diff�r�' }
            ];

            const languages = [
                { code: 'fr', flag: '��Ÿ� ���Ÿ� �', name: 'Fran��ais' },
                { code: 'en', flag: '��Ÿ� ���Ÿ� �', name: 'English' },
                { code: 'es', flag: '��Ÿ� ���Ÿ� �', name: 'Espa��ol' },
                { code: 'pt', flag: '��Ÿ� ���Ÿ� �', name: 'Portugu��s' },
                { code: 'de', flag: '��Ÿ� ���Ÿ� �', name: 'Deutsch' },
                { code: 'it', flag: '��Ÿ� ���Ÿ� �', name: 'Italiano' },
                { code: 'ar', flag: '��Ÿ� ���Ÿ� �', name: '�? ��??�? ��? ��? ��?Š�? �' },
                { code: 'zh', flag: '��Ÿ� ���Ÿ� �', name: '�� � ���?�' },
                { code: 'ru', flag: '��Ÿ� ���Ÿ� �', name: '�� ��?�?�? ��? ��� ��� ��� �' }
            ];

            UI.modal('��š ?��� � � Pr�f�rences', `
                <div class="space-y-4">
                    <!-- Tabs de navigation -->
                    <div class="flex border-b border-slate-200 -mx-6 px-6">
                        <button onclick="VendeurModule.switchSettingsTab('general')" id="tab-general" class="flex-1 px-4 py-3 text-sm font-bold text-emerald-600 border-b-2 border-emerald-500 bg-emerald-50/50 flex items-center justify-center gap-2">
                            <i data-lucide="sliders" class="w-4 h-4"></i>
                            G�n�ral
                        </button>
                        <button onclick="VendeurModule.switchSettingsTab('appearance')" id="tab-appearance" class="flex-1 px-4 py-3 text-sm font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 flex items-center justify-center gap-2 transition">
                            <i data-lucide="palette" class="w-4 h-4"></i>
                            Apparence
                        </button>
                        <button onclick="VendeurModule.switchSettingsTab('notifications')" id="tab-notifications" class="flex-1 px-4 py-3 text-sm font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 flex items-center justify-center gap-2 transition">
                            <i data-lucide="bell" class="w-4 h-4"></i>
                            Alertes
                        </button>
                        <button onclick="VendeurModule.switchSettingsTab('advanced')" id="tab-advanced" class="flex-1 px-4 py-3 text-sm font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 flex items-center justify-center gap-2 transition">
                            <i data-lucide="cog" class="w-4 h-4"></i>
                            Avanc�
                        </button>
                    </div>
                    
                    <!-- Contenu des tabs -->
                    <div class="max-h-[60vh] overflow-y-auto">
                        
                        <!-- Tab: G�n�ral -->
                        <div id="content-general" class="space-y-6">
                            <!-- Langue -->
                                <div>
                                    <div class="flex items-center gap-2 mb-4">
                                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
                                            <i data-lucide="globe" class="w-5 h-5 text-white"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-black text-slate-800">${t('settings.language')}</h3>
                                            <p class="text-xs text-slate-500">Choisissez votre langue pr�f�r�e</p>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-3 gap-2">
                                        ${languages.map(lang => `
                                            <button onclick="VendeurModule.setLanguage('${lang.code}')" class="group relative px-3 py-3 rounded-xl font-bold text-sm transition-all duration-300 flex flex-col items-center gap-1 ${prefs.language === lang.code ? 'bg-gradient-to-br from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-200 scale-105' : 'bg-slate-50 text-slate-700 hover:bg-slate-100 hover:scale-102'}">
                                                <span class="text-2xl">${lang.flag}</span>
                                                <span class="text-xs">${lang.name}</span>
                                                ${prefs.language === lang.code ? '<div class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full flex items-center justify-center"><i data-lucide="check" class="w-2.5 h-2.5 text-white"></i></div>' : ''}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <!-- Modes de paiement -->
                                <div>
                                    <div class="flex items-center gap-2 mb-4">
                                        <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center">
                                            <i data-lucide="wallet" class="w-5 h-5 text-white"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-black text-slate-800">Paiements favoris</h3>
                                            <p class="text-xs text-slate-500">S�lectionnez vos modes pr�f�r�s</p>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        ${paymentMethods.map(pm => {
                                            const isFav = prefs.favoritedPaymentMethods?.includes(pm.id);
                                            return `
                                                <button onclick="VendeurModule.togglePaymentMethodPreference('${pm.id}')" class="group p-4 rounded-xl border-2 transition-all duration-300 flex items-center gap-3 ${isFav ? 'bg-gradient-to-br from-emerald-50 to-green-50 border-emerald-400 shadow-lg shadow-emerald-100' : 'bg-white border-slate-200 hover:border-slate-300 hover:shadow-md'}">
                                                    <span class="text-2xl">${pm.icon}</span>
                                                    <div class="text-left flex-1">
                                                        <div class="font-bold text-sm ${isFav ? 'text-emerald-700' : 'text-slate-700'}">${pm.label}</div>
                                                        <div class="text-[10px] ${isFav ? 'text-emerald-600' : 'text-slate-400'}">${pm.desc}</div>
                                                    </div>
                                                    ${isFav ? '<i data-lucide="check-circle" class="w-5 h-5 text-emerald-500"></i>' : '<i data-lucide="circle" class="w-5 h-5 text-slate-300 group-hover:text-slate-400"></i>'}
                                                </button>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tab: Apparence -->
                            <div id="content-appearance" class="space-y-6 hidden">
                                <!-- Th��me -->
                                <div>
                                    <div class="flex items-center gap-2 mb-4">
                                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center">
                                            <i data-lucide="sun-moon" class="w-5 h-5 text-white"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-black text-slate-800">${t('settings.theme')}</h3>
                                            <p class="text-xs text-slate-500">Personnalisez l'apparence</p>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-3 gap-3">
                                        ${[
                                            { id: 'light', icon: '���? ?��� � �', label: t('settings.light'), desc: 'Interface claire', gradient: 'from-amber-400 to-orange-500' },
                                            { id: 'dark', icon: '��Ÿ�? ?�', label: t('settings.dark'), desc: 'Mode sombre WhatsApp', gradient: 'from-slate-700 to-slate-900' },
                                            { id: 'auto', icon: '��Ÿ�?', label: t('settings.auto'), desc: 'Suit le syst��me', gradient: 'from-blue-500 to-purple-600' }
                                        ].map(theme => `
                                            <button onclick="VendeurModule.setTheme('${theme.id}')" class="group p-4 rounded-2xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${prefs.theme === theme.id ? 'border-emerald-400 shadow-xl shadow-emerald-100 scale-105' : 'border-slate-200 hover:border-slate-300 hover:shadow-lg'}">
                                                <div class="w-16 h-16 bg-gradient-to-br ${theme.gradient} rounded-xl flex items-center justify-center text-3xl shadow-lg ${prefs.theme === theme.id ? 'ring-4 ring-emerald-200' : ''}">
                                                    ${theme.icon}
                                                </div>
                                                <div class="text-center">
                                                    <div class="font-black text-sm text-slate-800">${theme.label}</div>
                                                    <div class="text-[10px] text-slate-500">${theme.desc}</div>
                                                </div>
                                                ${prefs.theme === theme.id ? '<div class="w-6 h-6 bg-emerald-500 rounded-full flex items-center justify-center"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>' : ''}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <!-- Mode compact -->
                                <div class="p-4 rounded-2xl bg-gradient-to-r from-slate-50 to-slate-100 border border-slate-200">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-white rounded-xl shadow-sm flex items-center justify-center">
                                                <i data-lucide="minimize-2" class="w-5 h-5 text-slate-600"></i>
                                            </div>
                                            <div>
                                                <div class="font-bold text-sm text-slate-800">Mode compact</div>
                                                <div class="text-xs text-slate-500">Interface plus dense</div>
                                            </div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" ${prefs.compactMode ? 'checked' : ''} onchange="VendeurModule.state.preferences.compactMode = this.checked; VendeurModule.savePreferences(); App.rerender()" class="sr-only peer">
                                            <div class="w-14 h-7 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all after:shadow-md peer-checked:bg-emerald-500"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tab: Notifications -->
                            <div id="content-notifications" class="space-y-4 hidden">
                                <div class="flex items-center gap-2 mb-4">
                                    <div class="w-10 h-10 bg-gradient-to-br from-rose-500 to-red-600 rounded-xl flex items-center justify-center">
                                        <i data-lucide="bell-ring" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-black text-slate-800">Alertes & Sons</h3>
                                        <p class="text-xs text-slate-500">Configurez vos notifications</p>
                                    </div>
                                </div>
                                
                                ${[
                                    { id: 'notificationsEnabled', icon: '��Ÿ��', label: 'Notifications push', desc: 'Alertes dans le navigateur', checked: prefs.notificationsEnabled },
                                    { id: 'soundNotificationsEnabled', icon: '��Ÿ�Š', label: 'Sons', desc: 'Alertes sonores', checked: prefs.soundNotificationsEnabled },
                                    { id: 'emailNotificationsEnabled', icon: '��Ÿ? �', label: 'Emails', desc: 'R�sum� quotidien', checked: prefs.emailNotificationsEnabled }
                                ].map(opt => `
                                    <div class="p-4 rounded-2xl bg-white border border-slate-200 hover:shadow-md transition-all">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-3">
                                                <span class="text-2xl">${opt.icon}</span>
                                                <div>
                                                    <div class="font-bold text-sm text-slate-800">${opt.label}</div>
                                                    <div class="text-xs text-slate-500">${opt.desc}</div>
                                                </div>
                                            </div>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" ${opt.checked ? 'checked' : ''} onchange="VendeurModule.state.preferences.${opt.id} = this.checked; VendeurModule.savePreferences()" class="sr-only peer">
                                                <div class="w-14 h-7 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all after:shadow-md peer-checked:bg-emerald-500"></div>
                                            </label>
                                        </div>
                                    </div>
                                `).join('')}
                                
                                <!-- Volume -->
                                <div class="p-4 rounded-2xl bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200">
                                    <div class="flex items-center gap-3 mb-3">
                                        <span class="text-2xl">��ŸŽš�� � �</span>
                                        <div class="flex-1">
                                            <div class="font-bold text-sm text-slate-800">Volume des sons</div>
                                        </div>
                                        <span class="text-sm font-bold text-blue-600">${Math.round((prefs.soundVolume || 0.5) * 100)}%</span>
                                    </div>
                                    <input type="range" min="0" max="1" step="0.1" value="${prefs.soundVolume || 0.5}" onchange="VendeurModule.state.preferences.soundVolume = parseFloat(this.value); VendeurModule.savePreferences(); UI.playGenericNotificationSound('info')" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                                </div>
                            </div>
                            
                            <!-- Tab: Avanc� -->
                            <div id="content-advanced" class="space-y-4 hidden">
                                <div class="flex items-center gap-2 mb-4">
                                    <div class="w-10 h-10 bg-gradient-to-br from-slate-600 to-slate-800 rounded-xl flex items-center justify-center">
                                        <i data-lucide="settings-2" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-black text-slate-800">Param��tres avanc�s</h3>
                                        <p class="text-xs text-slate-500">Options pour utilisateurs exp�riment�s</p>
                                    </div>
                                </div>
                                
                                <!-- Raccourcis clavier -->
                                <div class="p-4 rounded-2xl bg-white border border-slate-200">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">���? ��� � �</span>
                                            <div>
                                                <div class="font-bold text-sm text-slate-800">Raccourcis clavier</div>
                                                <div class="text-xs text-slate-500">Productivit� accrue</div>
                                            </div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" ${prefs.keyboardShortcutsEnabled ? 'checked' : ''} onchange="VendeurModule.state.preferences.keyboardShortcutsEnabled = this.checked; VendeurModule.savePreferences(); VendeurModule.showPreferencesModal()" class="sr-only peer">
                                            <div class="w-14 h-7 bg-slate-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all after:shadow-md peer-checked:bg-emerald-500"></div>
                                        </label>
                                    </div>
                                    ${prefs.keyboardShortcutsEnabled ? `
                                        <div class="grid grid-cols-2 gap-2 mt-3 p-3 bg-slate-50 rounded-xl">
                                            ${[
                                                { keys: 'Ctrl+S', action: 'Valider panier' },
                                                { keys: 'Ctrl+P', action: 'Imprimer ticket' },
                                                { keys: 'Ctrl+N', action: 'Nouveau panier' },
                                                { keys: 'Ctrl+F', action: 'Rechercher' }
                                            ].map(sc => `
                                                <div class="flex items-center gap-2">
                                                    <kbd class="px-2 py-1 bg-white border border-slate-300 rounded text-xs font-mono font-bold text-slate-700 shadow-sm">${sc.keys}</kbd>
                                                    <span class="text-xs text-slate-600">${sc.action}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <!-- Personnalisation du Ticket -->
                                <div class="p-4 rounded-2xl bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200">
                                    <div class="flex items-center gap-3 mb-4">
                                        <span class="text-2xl">��Ÿ � �</span>
                                        <div>
                                            <div class="font-bold text-sm text-slate-800">Personnalisation du ticket</div>
                                            <div class="text-xs text-slate-500">Texte affich� sur les re��us de vente</div>
                                        </div>
                                    </div>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs font-bold text-slate-600 mb-1">Nom de la boutique (logo)</label>
                                            <input type="text" id="pref_receipt_logo" value="${prefs.receiptLogoText || ''}" placeholder="${CORE.getCompanyName()}" 
                                                class="w-full px-3 py-2 border border-emerald-200 rounded-xl text-sm font-bold focus:ring-2 focus:ring-emerald-300 focus:border-emerald-400"
                                                onchange="VendeurModule.state.preferences.receiptLogoText = this.value; VendeurModule.savePreferences();">
                                            <div class="text-[10px] text-slate-400 mt-1">Laissez vide pour utiliser le nom par d�faut</div>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-slate-600 mb-1">Sous-titre / Slogan</label>
                                            <input type="text" id="pref_receipt_subtitle" value="${prefs.receiptSubtitle || ''}" placeholder="Ex: Votre satisfaction, notre priorit�" 
                                                class="w-full px-3 py-2 border border-emerald-200 rounded-xl text-sm focus:ring-2 focus:ring-emerald-300 focus:border-emerald-400"
                                                onchange="VendeurModule.state.preferences.receiptSubtitle = this.value; VendeurModule.savePreferences();">
                                        </div>
                                        <button onclick="VendeurModule.previewReceipt()" class="w-full px-3 py-2 bg-emerald-600 text-white rounded-xl text-xs font-bold hover:bg-emerald-700 transition flex items-center justify-center gap-2">
                                            <i data-lucide="eye" class="w-3 h-3"></i>
                                            Aper��u du ticket
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Donn�es -->
                                <div class="p-4 rounded-2xl bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200">
                                    <div class="flex items-center gap-3 mb-3">
                                        <span class="text-2xl">��Ÿ? �</span>
                                        <div>
                                            <div class="font-bold text-sm text-slate-800">Donn�es locales</div>
                                            <div class="text-xs text-slate-500">G�rer le stockage</div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="VendeurModule.exportAllData()" class="flex-1 px-3 py-2 bg-white border border-amber-300 text-amber-700 rounded-xl text-xs font-bold hover:bg-amber-50 transition flex items-center justify-center gap-1">
                                            <i data-lucide="download" class="w-3 h-3"></i>
                                            Exporter
                                        </button>
                                        <button onclick="if(confirm('R�initialiser tous les param��tres ?')) { localStorage.removeItem('vendeur_preferences'); location.reload(); }" class="flex-1 px-3 py-2 bg-white border border-red-300 text-red-600 rounded-xl text-xs font-bold hover:bg-red-50 transition flex items-center justify-center gap-1">
                                            <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                                            R�initialiser
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Version -->
                                <div class="p-4 rounded-2xl bg-gradient-to-r from-slate-800 to-slate-900 text-white">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center text-xl font-black">${CORE.getCompanyName().charAt(0)}</div>
                                            <div>
                                                <div class="font-black">${CORE.getCompanyName()}</div>
                                                <div class="text-xs text-slate-400">Version ${CORE.config.version}</div>
                                            </div>
                                        </div>
                                        <span class="px-3 py-1 bg-emerald-500/20 text-emerald-400 rounded-full text-xs font-bold">�?� jour</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer actions -->
                    <div class="p-4 flex justify-between items-center">
                        <button onclick="App.logout()" class="px-4 py-2 bg-red-50 text-red-600 rounded-xl font-bold text-sm hover:bg-red-100 transition flex items-center gap-2">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            ${t('menu.logout')}
                        </button>
                        <button onclick="VendeurModule.savePreferences(); UI.closeModal(); UI.toast('���?? Pr�f�rences enregistr�es', 'success')" class="px-6 py-2.5 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-xl font-bold text-sm hover:shadow-lg hover:shadow-emerald-200 transition-all flex items-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            ${t('action.save')}
                    </div>
                </div>
            `, [], { maxWidth: 'max-w-2xl' });
            
            setTimeout(() => lucide.createIcons(), 50);
        },

        switchSettingsTab(tabId) {
            // Cacher tous les contenus
            ['general', 'appearance', 'notifications', 'advanced'].forEach(id => {
                const content = document.getElementById('content-' + id);
                const tab = document.getElementById('tab-' + id);
                if (content) content.classList.add('hidden');
                if (tab) {
                    tab.classList.remove('text-emerald-600', 'border-b-2', 'border-emerald-500', 'bg-emerald-50/50');
                    tab.classList.add('text-slate-500');
                }
            });
            
            // Afficher le contenu s�lectionn�
            const activeContent = document.getElementById('content-' + tabId);
            const activeTab = document.getElementById('tab-' + tabId);
            if (activeContent) activeContent.classList.remove('hidden');
            if (activeTab) {
                activeTab.classList.remove('text-slate-500');
                activeTab.classList.add('text-emerald-600', 'border-b-2', 'border-emerald-500', 'bg-emerald-50/50');
            }
            
            setTimeout(() => lucide.createIcons(), 50);
        },

        previewReceipt() {
            const prefs = this.state.preferences || {};
            const logoText = prefs.receiptLogoText?.trim() || CORE.getCompanyName();
            const subtitleText = prefs.receiptSubtitle?.trim() || '';
            const posName = CORE.getPOS(CORE.state.currentUser?.pos)?.name || 'Point de vente';
            const now = new Date();
            const reference = 'CMD-DEMO-' + now.getTime().toString().slice(-6);
            
            const demoItems = [
                { name: 'Produit exemple 1', qty: 2, price: 5000 },
                { name: 'Produit exemple 2', qty: 1, price: 12500 },
                { name: 'Produit exemple 3', qty: 3, price: 2500 }
            ];
            const subtotal = demoItems.reduce((a, it) => a + (it.qty * it.price), 0);
            
            UI.modal('��Ÿ? ��� � � Aper��u du ticket', `
                <div class="p-4 bg-white border-2 border-dashed border-slate-300 rounded-xl">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="font-black text-slate-900 text-xl">${logoText}</div>
                            ${subtitleText ? `<div class="text-xs text-emerald-600 font-medium italic">${subtitleText}</div>` : ''}
                            <div class="text-xs text-slate-500 font-bold uppercase tracking-wider">${posName}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-black">${reference}</div>
                            <div class="text-xs text-slate-500">${now.toLocaleDateString('fr-FR')} ${now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                    </div>
                    <div class="my-4 h-px bg-slate-200"></div>
                    <div class="space-y-2">
                        ${demoItems.map(it => `<div class="flex justify-between text-sm"><span>${it.qty}�?? ${it.name}</span><span class="font-bold">${CORE.formatPrice(it.qty * it.price)}</span></div>`).join('')}
                    </div>
                    <div class="my-4 h-px bg-slate-200"></div>
                    <div class="flex justify-between items-center">
                        <div class="text-sm font-bold text-slate-600">Total</div>
                        <div class="text-2xl font-black text-emerald-600">${CORE.formatPrice(subtotal)}</div>
                    </div>
                    <div class="mt-2 text-xs text-slate-500">Paiement: <span class="font-bold">Esp��ces</span></div>
                    <div class="mt-4 text-center text-xs text-slate-400">--- Merci de votre visite ! ---</div>
                </div>
                <div class="mt-3 p-3 bg-emerald-50 border border-emerald-200 rounded-xl text-xs text-emerald-700">
                    <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                    Ceci est un aper��u. Les modifications sont automatiquement sauvegard�es.
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            setTimeout(() => lucide.createIcons(), 50);
        },

        exportAllData() {
            const data = {
                preferences: this.state.preferences,
                exportDate: new Date().toISOString(),
                version: CORE.config.version
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'raya-preferences-' + Utils.todayKey() + '.json';
            a.click();
            URL.revokeObjectURL(url);
            UI.toast('���?? Donn�es export�es', 'success');
        },

        togglePaymentMethodPreference(methodId) {
            const idx = this.state.preferences.favoritedPaymentMethods.indexOf(methodId);
            if (idx >= 0) {
                this.state.preferences.favoritedPaymentMethods.splice(idx, 1);
            } else {
                this.state.preferences.favoritedPaymentMethods.push(methodId);
            }
            this.savePreferences();
            App.rerender();
        },

        // =====================
        // HISTORIQUE D'ACTIVIT�
        // =====================
        showActivityHistoryModal() {
            this.activityFilters = this.activityFilters || {};
            const userPos = CORE.user?.pos;
            const filters = { ...this.activityFilters, posId: userPos };
            const logs = CORE.getActivityLogs(filters);

            const allLogs = CORE.db.activityLogs?.filter(l => l.posId == userPos) || [];
            const entities = [...new Set(allLogs.map(l => l.entity))];

            UI.modal(`��Ÿ?� Historique d'Activit�`, `
                <div class="space-y-4">
                    <!-- Filtres -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-black text-slate-600 mb-1">��Ÿ?� Du</label>
                            <input type="date" id="activity_date_from" value="${filters.startDate || ''}" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm" onchange="VendeurModule.activityFilters.startDate = this.value; VendeurModule.showActivityHistoryModal();">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-slate-600 mb-1">��Ÿ?� Au</label>
                            <input type="date" id="activity_date_to" value="${filters.endDate || ''}" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm" onchange="VendeurModule.activityFilters.endDate = this.value; VendeurModule.showActivityHistoryModal();">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-600 mb-1">��Ÿ � ��� � � Entit�</label>
                        <select id="activity_entity" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm" onchange="VendeurModule.activityFilters.entity = this.value || null; VendeurModule.showActivityHistoryModal();">
                            <option value="">Toutes les entit�s</option>
                            ${entities.map(e => `<option value="${e}" ${filters.entity === e ? 'selected' : ''}>${e}</option>`).join('')}
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-600 mb-1">��Ÿ� � Recherche</label>
                        <input type="text" id="activity_search" value="${filters.search || ''}" placeholder="Utilisateur, client, description..." class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm" onchange="VendeurModule.activityFilters.search = this.value; VendeurModule.showActivityHistoryModal();">
                    </div>

                    <div class="flex gap-2">
                        <button onclick="VendeurModule.exportActivityCSV()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm hover:bg-blue-700 transition flex items-center justify-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            CSV
                        </button>
                        <button onclick="VendeurModule.exportActivityPDF()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-bold text-sm hover:bg-red-700 transition flex items-center justify-center gap-2">
                            <i data-lucide="file-pdf" class="w-4 h-4"></i>
                            PDF
                        </button>
                    </div>

                    <!-- Timeline -->
                    <div class="space-y-2 max-h-96 overflow-y-auto">
                        ${logs.length > 0 ? logs.map((log, idx) => {
                            const date = new Date(log.timestamp);
                            const dateStr = date.toLocaleDateString('fr-FR');
                            const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                            const isLast = idx === logs.length - 1;
                            
                            // Couleurs par action
                            const colors = {
                                'Cr��': 'bg-green-50 border-green-200',
                                'Modifi�': 'bg-blue-50 border-blue-200',
                                'Supprim�': 'bg-red-50 border-red-200',
                                'Annul�': 'bg-amber-50 border-amber-200',
                                'Rembours�': 'bg-purple-50 border-purple-200',
                                'Pay�': 'bg-emerald-50 border-emerald-200',
                                'Livr�': 'bg-cyan-50 border-cyan-200'
                            };

                            return `
                                <div class="relative">
                                    ${!isLast ? '<div class="absolute left-4 top-10 w-0.5 h-12 bg-slate-200"></div>' : ''}
                                    <div class="p-4 rounded-xl border-2 ${colors[log.action] || 'bg-slate-50 border-slate-200'}">
                                        <div class="flex items-start gap-3">
                                            <div class="w-8 h-8 rounded-full bg-slate-300 flex items-center justify-center text-xs font-black text-white flex-shrink-0">
                                                ${log.userName.charAt(0).toUpperCase()}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="font-bold text-slate-900">${log.action} ${log.entity}</div>
                                                <div class="text-xs text-slate-600 mt-1">
                                                    <strong>${log.userName}</strong> �� ?� � ${dateStr} �� ${timeStr}
                                                </div>
                                                ${log.entityName ? `<div class="text-sm font-bold text-slate-700 mt-1">${log.entityName}</div>` : ''}
                                                ${log.details ? `<div class="text-xs text-slate-700 mt-1 italic">${log.details}</div>` : ''}
                                                ${log.amount > 0 ? `<div class="text-sm font-bold text-slate-800 mt-2">${CORE.formatPrice(log.amount)}</div>` : ''}
                                            </div>
                                            <span class="px-2 py-1 rounded-full text-xs font-black ${log.status === 'success' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
                                                ${log.status === 'success' ? '���??' : '���??'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('') : `
                            <div class="text-center py-8 text-slate-500">
                                <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                <p class="text-sm font-bold">Aucune activit�</p>
                            </div>
                        `}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showVendeurAuditLog() {
            const posId = CORE.state.currentUser?.pos;
            // Filtrer par POS ET par r��le (vendeur et livreur uniquement - pas les sup�rieurs)
            const allowedRoles = ['vendeur', 'livreur'];
            const auditLogs = (CORE.db.auditLogs || []).filter(log => 
                log.posId == posId && allowedRoles.includes(log.userRole)
            ).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            UI.modal('��Ÿ?� Journal d\'Audit', `
                <div class="space-y-4">
                    <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center">
                                <i data-lucide="book-open" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-blue-800">Tra��abilit� des actions</div>
                                <div class="text-xs text-blue-600">${auditLogs.length} �v�nement(s)</div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistiques rapides -->
                    <div class="grid grid-cols-3 gap-3">
                        <div class="bg-white p-3 rounded-lg border border-slate-200">
                            <div class="text-xs font-black text-slate-600">Total</div>
                            <div class="text-2xl font-black text-slate-900">${auditLogs.length}</div>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-slate-200">
                            <div class="text-xs font-black text-slate-600">Cr�ations</div>
                            <div class="text-2xl font-black text-emerald-600">${auditLogs.filter(l => l.action === 'create').length}</div>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-slate-200">
                            <div class="text-xs font-black text-slate-600">Modifications</div>
                            <div class="text-2xl font-black text-blue-600">${auditLogs.filter(l => l.action === 'update').length}</div>
                        </div>
                    </div>

                    <!-- Timeline des �v�nements -->
                    <div class="space-y-2 max-h-96 overflow-y-auto">
                        ${auditLogs.length === 0 ? `
                            <div class="text-center py-8 text-slate-400">
                                <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                <p class="text-sm font-bold">Aucun �v�nement</p>
                            </div>
                        ` : auditLogs.map(log => {
                            const date = new Date(log.timestamp);
                            const dateStr = date.toLocaleDateString('fr-FR');
                            const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                            
                            const actionColors = {
                                'create': 'bg-emerald-50 border-emerald-200 text-emerald-700',
                                'update': 'bg-blue-50 border-blue-200 text-blue-700',
                                'delete': 'bg-red-50 border-red-200 text-red-700'
                            };
                            
                            const color = actionColors[log.action] || 'bg-slate-50 border-slate-200 text-slate-700';
                            
                            return `
                                <div class="p-3 rounded-lg border-2 ${color}">
                                    <div class="flex items-start justify-between gap-2">
                                        <div class="flex-1 min-w-0">
                                            <div class="font-black text-sm">${log.entityName || log.entity}</div>
                                            <div class="text-xs opacity-75 mt-0.5">${dateStr} �� ${timeStr}</div>
                                            ${log.details ? `<div class="text-xs mt-1 opacity-75">${log.details}</div>` : ''}
                                        </div>
                                        <span class="px-2 py-1 rounded text-xs font-black bg-white/50">${log.action}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        exportActivityCSV() {
            const userPos = CORE.user?.pos;
            const filters = { ...this.activityFilters || {}, posId: userPos };
            const logs = CORE.getActivityLogs(filters);

            const headers = ['Date', 'Heure', 'Utilisateur', 'R��le', 'Action', 'Entit�', 'Nom', 'D�tails', 'Montant'];
            const rows = logs.map(log => {
                const date = new Date(log.timestamp);
                return [
                    date.toLocaleDateString('fr-FR'),
                    date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                    log.userName,
                    log.userRole,
                    log.action,
                    log.entity,
                    log.entityName,
                    log.details,
                    log.amount > 0 ? log.amount : ''
                ];
            });

            let csv = headers.join(',') + '\n';
            csv += rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `historique-activite-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            UI.toast('Historique export� en CSV ���??', 'success');
        },

        exportActivityPDF() {
            const userPos = CORE.user?.pos;
            const filters = { ...this.activityFilters || {}, posId: userPos };
            const logs = CORE.getActivityLogs(filters);

            let html = `
                <html>
                <head>

                    <title>Historique d'Activit�</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; background: white; }
                        h1 { color: #1f2937; border-bottom: 2px solid #059669; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background: #f3f4f6; padding: 10px; text-align: left; border: 1px solid #d1d5db; font-weight: bold; }
                        td { padding: 10px; border: 1px solid #d1d5db; }
                        tr:nth-child(even) { background: #f9fafb; }
                        .amount { font-weight: bold; text-align: right; }
                        .success { color: #059669; }
                        .error { color: #dc2626; }
                    </style>
                </head>
                <body>
                    <h1>��Ÿ?� Historique d'Activit�</h1>
                    <p>G�n�r� le ${new Date().toLocaleDateString('fr-FR')} �� ${new Date().toLocaleTimeString('fr-FR')}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Date/Heure</th>
                                <th>Utilisateur</th>
                                <th>Action</th>
                                <th>Entit�</th>
                                <th>D�tails</th>
                                <th>Montant</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${logs.map(log => {
                                const date = new Date(log.timestamp);
                                const dateTime = date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                                return `
                                    <tr>
                                        <td>${dateTime}</td>
                                        <td>${log.userName} (${log.userRole})</td>
                                        <td>${log.action}</td>
                                        <td>${log.entity}</td>
                                        <td>${log.entityName} ${log.details ? `<br>${log.details}` : ''}</td>
                                        <td class="amount ${log.status === 'success' ? 'success' : 'error'}">${log.amount > 0 ? CORE.formatPrice(log.amount) : ''}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            const blob = new Blob([html], { type: 'text/html;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `historique-activite-${new Date().toISOString().split('T')[0]}.html`;
            link.click();

            UI.toast('Historique export� en PDF ���??', 'success');
        },

        // =====================
        // MODE R�SERVATION (Panier d�di�)
        // =====================
        openReservationCart() {
            // Le panier r�servation est s�par�. Par d�faut, on copie le panier courant si non vide,
            // pour que le vendeur puisse transformer rapidement un panier en r�servation.
            if (this.state.cart.length > 0 && this.state.reservationCart.length === 0) {
                this.state.reservationCart = this.state.cart.map(i => ({ ...i }));
                this.saveReservationCart(); // Persister la copie du panier
                // On ne vide pas le panier normal, c'est volontaire (panier s�par�)
            }
            this.state.reservationCartDrawerOpen = true;
            App.rerender();
        },
        closeReservationCart() { this.state.reservationCartDrawerOpen = false; App.rerender(); },
        clearReservationCart() {
            this.state.reservationCart = [];
            this.state.reservationManualDeliveryFee = 0;
            this.state.reservationCartDrawerOpen = false;
            this.saveReservationCart(); // Persister le panier vid�
            App.rerender();
        },
        addToReservationCart(productId) {
            const p = CORE.getProduct(productId);
            if (!p || !p.active) return UI.toast('Produit indisponible', 'error');
            
            // Get stock for this POS (supports posStocks)
            const userPos = CORE.user?.pos;
            
            // V�rifier que le produit appartient au POS de l'utilisateur (filtre par POS)
            if (p.posId && p.posId != userPos) {
                return UI.toast('Ce produit n\'appartient pas �� votre POS', 'error');
            }
            
            const posStock = CORE.getProductStock(productId, userPos);
            if (posStock <= 0) return UI.toast('Stock �puis�', 'warning');

            const item = this.state.reservationCart.find(i => i.productId === productId);
            if (item) {
                if (item.qty < posStock) item.qty++;
                else UI.toast('Stock maximum atteint', 'warning');
            } else {
                // Get price for this POS (supports posStocks)
                const posPrice = CORE.getProductPrice(productId, userPos);
                this.state.reservationCart.push({ productId: p.id, name: p.name, price: posPrice, qty: 1, maxStock: posStock });
            }
            this.saveReservationCart(); // Persister les modifications
            App.rerender();
        },
        updateReservationCartQty(index, delta) {
            const item = this.state.reservationCart[index];
            if (!item) return;
            const newQty = item.qty + delta;
            if (newQty <= 0) this.state.reservationCart.splice(index, 1);
            else item.qty = Math.min(newQty, item.maxStock);
            this.saveReservationCart(); // Persister les modifications
            App.rerender();
        },
        removeReservationCartItem(index) {
            if (index < 0 || index >= this.state.reservationCart.length) return;
            this.state.reservationCart.splice(index, 1);
            this.saveReservationCart(); // Persister les modifications
            App.rerender();
        },
        getReservationCartTotal() { return this.state.reservationCart.reduce((a, b) => a + (b.price * b.qty), 0); },
        getReservationDeliveryFee() {
            return this.state.reservationManualDeliveryFee !== undefined ? this.state.reservationManualDeliveryFee : 0;
        },
        setReservationManualDeliveryFee(val) {
            const amount = Number(val) || 0;
            this.state.reservationManualDeliveryFee = amount;
            this.saveReservationCart(); // Persister les frais de livraison
            const totalEl = document.getElementById('res-cart-total-display');
            if(totalEl) totalEl.textContent = CORE.formatPrice(this.getReservationGrandTotal());
        },
        getReservationGrandTotal() { return this.getReservationCartTotal() + this.getReservationDeliveryFee(); },

        // Cart
        addToCart(productId) {
            const p = CORE.getProduct(productId);
            if (!p || !p.active) return UI.toast('Produit indisponible', 'error');
            
            // Get stock for this POS (supports posStocks)
            const userPos = CORE.user?.pos;
            
            // V�rifier que le produit appartient au POS de l'utilisateur (filtre par POS)
            if (p.posId && p.posId != userPos) {
                return UI.toast('Ce produit n\'appartient pas �� votre POS', 'error');
            }
            
            const posStock = CORE.getProductStock(productId, userPos);
            if (posStock <= 0) return UI.toast('Stock �puis�', 'warning');

            // V�rifier s'il y a des variantes
            const variants = CORE.getProductVariants(productId);
            if (variants.length > 0) {
                // Afficher le s�lecteur de variante
                this.showVariantPickerModal(productId);
                return;
            }

            const item = this.state.cart.find(i => i.productId === productId && !i.variantId);
            if (item) {
                if (item.qty < posStock) item.qty++;
                else UI.toast('Stock maximum atteint', 'warning');
            } else {
                // Get price for this POS (supports posStocks)
                const posPrice = CORE.getProductPrice(productId, userPos);
                // Init with no discount
                this.state.cart.push({ productId: p.id, name: p.name, price: posPrice, qty: 1, maxStock: posStock, discountPercent: 0 });
            }
            App.rerender();
        },
        updateCartQty(index, delta) {
            const item = this.state.cart[index];
            if (!item) return;
            const newQty = item.qty + delta;
            if (newQty <= 0) this.state.cart.splice(index, 1);
            else item.qty = Math.min(newQty, item.maxStock);
            App.rerender();
        },
        removeCartItem(index) {
            if (index < 0 || index >= this.state.cart.length) return;
            this.state.cart.splice(index, 1);
            App.rerender();
        },
        openCartDrawer() { this.state.cartDrawerOpen = true; App.rerender(); },
        closeCartDrawer() { this.state.cartDrawerOpen = false; App.rerender(); },
        toggleCartDrawer() { this.state.cartDrawerOpen = !this.state.cartDrawerOpen; App.rerender(); },
        clearCart() {
            this.state.cart = [];
            this.state.selectedClientId = null;
            this.state.deliveryZoneId = null;
            this.state.cartDrawerOpen = false;
            this.state.globalDiscount = { type: 'percent', value: 0 };
            this.state.promoCode = null;
            App.rerender();
        },
        // Total Panier avec remises ligne
        getCartTotal() {
            return this.state.cart.reduce((a, b) => {
                const linePrice = this.getLinePrice(b);
                return a + (linePrice * b.qty);
            }, 0);
        },
        getDeliveryFee() {
            return this.state.manualDeliveryFee !== undefined ? this.state.manualDeliveryFee : 0;
        },
        setManualDeliveryFee(val) {
            const amount = Number(val) || 0;
            this.state.manualDeliveryFee = amount;
            const totalEl = document.getElementById('cart-total-display');
            if(totalEl) totalEl.textContent = CORE.formatPrice(this.getGrandTotal());
        },
        // Grand Total avec remise globale
        getGrandTotal() {
            const subtotal = this.getCartTotal();
            const delivery = this.getDeliveryFee();
            let total = subtotal;

            // Appliquer remise globale
            if (this.state.globalDiscount.type === 'percent' && this.state.globalDiscount.value > 0) {
                total = total * (1 - (this.state.globalDiscount.value / 100));
            } else if (this.state.globalDiscount.type === 'fixed' && this.state.globalDiscount.value > 0) {
                total = Math.max(0, total - this.state.globalDiscount.value);
            }

            return Math.round(total) + delivery;
        },

        getStats() {
            const today = Utils.todayKey();
            const posId = CORE.state.currentUser?.pos;
            const ordersToday = CORE.db.orders.filter(o => (o.createdAt || '').startsWith(today) && (!posId || o.posId == posId));
            const revenueToday = ordersToday.filter(o => o.status === 'delivered').reduce((a, o) => a + (o.total || 0), 0);
            
            // Calculer le stock bas avec le stock du POS
            const lowStock = CORE.db.products.filter(p => {
                if (p.isMainWarehouse) return false;
                // V�rifier si le produit appartient au POS ou a du stock dans ce POS
                const belongsToPos = p.posId == posId;
                const hasStockInPos = p.posStocks && p.posStocks[posId] && p.posStocks[posId].stock > 0;
                if (!belongsToPos && !hasStockInPos) return false;
                
                // Obtenir le stock r�el du POS
                const stock = p.posStocks && p.posStocks[posId] ? p.posStocks[posId].stock : (belongsToPos ? (p.stock || 0) : 0);
                const minStock = p.minStock || 0;
                return stock <= minStock;
            }).length;
            
            const pending = CORE.db.orders.filter(o => ['pending','confirmed','delivering'].includes(o.status) && (!posId || o.posId == posId)).length;
            return {
                todayRevenue: revenueToday,
                todayTransactions: ordersToday.length,
                pendingDeliveries: pending,
                lowStockProducts: lowStock
            };
        },

        // =====================
        // R�SERVATIONS (widgets + historique)
        // =====================
        getReservationsList() {
            const userPos = CORE.user?.pos;
            const res = CORE.db.deliveries
                .filter(d => (!d.posId || d.posId == userPos) && d.status === 'reservation')
                .sort((a, b) => {
                    const ad = (a.deliveryDate || a.createdAt || '');
                    const bd = (b.deliveryDate || b.createdAt || '');
                    const cmp = String(ad).localeCompare(String(bd));
                    if (cmp !== 0) return cmp;
                    return String(a.deliveryTime || '').localeCompare(String(b.deliveryTime || ''));
                });
            return res;
        },

        getReservationsStats() {
            const today = Utils.todayKey();
            const list = this.getReservationsList();
            const total = list.length;
            const todayCount = list.filter(d => (d.deliveryDate || '').startsWith(today)).length;
            const upcomingCount = list.filter(d => {
                const dd = (d.deliveryDate || '').trim();
                return dd && dd >= today;
            }).length;
            return { total, todayCount, upcomingCount };
        },

        formatReservationWhen(d) {
            const date = (d?.deliveryDate || '').trim();
            const time = (d?.deliveryTime || '').trim();
            if (!date && !time) return '�� ?��';
            return `${date || '�� ?��'}${time ? ' ' + time : ''}`;
        },

        renderReservationsWidget() {
            const stats = this.getReservationsStats();
            const list = this.getReservationsList().slice(0, 5);
            return `
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                    <div class="flex items-center justify-between mb-5">
                        <div>
                            <h3 class="font-black text-lg text-slate-800">R�servations</h3>
                            <p class="text-xs text-slate-500 font-bold">Livraisons futures (non assign�es)</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="VendeurModule.navigateTo('reservations')" class="px-3 py-2 rounded-xl bg-slate-100 text-slate-700 text-xs font-black hover:bg-slate-200 transition">Historique</button>
                            <button onclick="VendeurModule.showReservationModal()" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700 transition flex items-center gap-2">
                                <i data-lucide="calendar-plus" class="w-4 h-4"></i>
                                Nouvelle
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="p-4 rounded-2xl bg-slate-50 border border-slate-200">
                            <div class="text-[10px] font-black text-slate-500 uppercase tracking-wider">Aujourd'hui</div>
                            <div class="mt-1 text-2xl font-black text-slate-900">${stats.todayCount}</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-slate-50 border border-slate-200">
                            <div class="text-[10px] font-black text-slate-500 uppercase tracking-wider">�?� venir</div>
                            <div class="mt-1 text-2xl font-black text-slate-900">${stats.upcomingCount}</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-slate-50 border border-slate-200">
                            <div class="text-[10px] font-black text-slate-500 uppercase tracking-wider">Total</div>
                            <div class="mt-1 text-2xl font-black text-slate-900">${stats.total}</div>
                        </div>
                    </div>

                    ${stats.total === 0 ? `
                        <div class="p-6 rounded-2xl border border-dashed border-slate-200 bg-white text-center">
                            <div class="mx-auto w-12 h-12 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center">
                                <i data-lucide="calendar-clock" class="w-6 h-6"></i>
                            </div>
                            <div class="mt-3 font-black text-slate-900">Aucune r�servation</div>
                            <div class="text-xs text-slate-500">Cr�ez une livraison future (COD) puis assignez-la �� l'heure pr�vue.</div>
                            <button onclick="VendeurModule.showReservationModal()" class="mt-4 px-4 py-2.5 rounded-xl bg-slate-900 text-white text-xs font-black hover:bg-slate-800 transition">Cr�er une r�servation</button>
                        </div>
                    ` : `
                        <div class="space-y-2">
                            ${list.map(d => {
                                const when = this.formatReservationWhen(d);
                                return `
                                <div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 flex items-start justify-between gap-4">
                                    <div class="min-w-0">
                                        <div class="flex items-center gap-2 flex-wrap">
                                            <div class="font-black text-slate-900">${d.orderRef}</div>
                                            ${UI.badge('R�servation', 'purple')}
                                        </div>
                                        <div class="text-xs text-slate-500 truncate">${d.clientName || '�� ?��'} �� ?� � ${d.address || '�� ?��'}</div>
                                        <div class="mt-1 text-xs text-emerald-700 font-black">Pr�vu: ${when}</div>
                                    </div>
                                    <div class="text-right shrink-0">
                                        <div class="font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                                        <div class="mt-2 flex flex-wrap gap-2 justify-end">
                                            <button onclick="VendeurModule.showEditDeliveryModal(${d.id})" class="px-3 py-2 rounded-xl bg-slate-100 text-xs font-black text-slate-700 hover:bg-slate-200">Modifier</button>
                                            <button onclick="VendeurModule.showAssignDeliveryModal(${d.id})" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-black hover:bg-slate-800">Assigner</button>
                                        </div>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    `}

                    ${stats.total > 5 ? `<div class="mt-4 text-xs text-slate-500">Affichage des 5 prochaines r�servations. Ouvrez l�� ?� ?�historique pour tout voir.</div>` : ''}
                </div>
            `;
        },

        renderDepositsWidget() {
            const deposits = (CORE.db.deposits || []).filter(d => d.vendeurId === CORE.state.currentUser?.id);
            const totalAmount = deposits.reduce((sum, d) => sum + d.amount, 0);
            const monthDeposits = deposits.filter(d => {
                const date = new Date(d.timestamp);
                const now = new Date();
                return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            }).length;
            const avgAmount = deposits.length > 0 ? Math.round(deposits.reduce((sum, d) => sum + d.amount, 0) / deposits.length) : 0;

            return `
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                    <div class="flex items-center justify-between mb-5">
                        <div>
                            <h3 class="font-black text-lg text-slate-800">��Ÿ? � D�p��ts Livreurs</h3>
                            <p class="text-xs text-slate-500 font-bold">Montants re��us en caisse</p>
                        </div>
                        ${CORE.hasPermission('finance.edit') ? `
                            ${CORE.hasPermission('finance.edit') ? `
                                <button onclick="VendeurModule.recordDeposit()" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs font-black hover:bg-indigo-700 transition flex items-center gap-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    Nouveau
                                </button>
                            ` : ''}
                        ` : ''}
                    </div>

                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="p-4 rounded-2xl bg-indigo-50 border border-indigo-200">
                            <div class="text-xs text-indigo-600 font-black uppercase tracking-wider mb-1">Total</div>
                            <div class="text-2xl font-black text-indigo-700">${totalAmount.toLocaleString()} F</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-purple-50 border border-purple-200">
                            <div class="text-xs text-purple-600 font-black uppercase tracking-wider mb-1">Mois</div>
                            <div class="text-2xl font-black text-purple-700">${monthDeposits}</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-pink-50 border border-pink-200">
                            <div class="text-xs text-pink-600 font-black uppercase tracking-wider mb-1">Moyenne</div>
                            <div class="text-2xl font-black text-pink-700">${avgAmount.toLocaleString()} F</div>
                        </div>
                    </div>

                    ${deposits.length > 0 ? `
                        <div class="space-y-2">
                            ${deposits.slice(-5).reverse().map(d => `
                                <div class="p-3 bg-slate-50 rounded-xl border border-slate-200 flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center">
                                            <i data-lucide="user" class="w-4 h-4 text-indigo-600"></i>
                                        </div>
                                        <div>
                                            <div class="font-black text-slate-900 text-sm">${d.livreurName}</div>
                                            <div class="text-xs text-slate-500">${new Date(d.timestamp).toLocaleDateString('fr-FR')}</div>
                                        </div>
                                    </div>
                                    <div class="font-black text-indigo-600">${d.amount.toLocaleString()} F</div>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="VendeurModule.showDepositsModal()" class="mt-4 w-full py-2 text-xs font-black text-indigo-600 hover:text-indigo-700">Voir tout ���?</button>
                    ` : `
                        <div class="text-center py-8 text-slate-500">
                            <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                            <p class="text-sm font-bold">Aucun d�p��t enregistr�</p>
                            <p class="text-xs opacity-75">Enregistrez le premier d�p��t</p>
                        </div>
                    `}
                </div>
            `;
        },

        createOrder(paymentMethod = 'cash') {
            if (!CORE.hasPermission('orders.create')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            if (this.state.cart.length === 0) return UI.toast('Panier vide', 'error');

            // V�rifier le statut offline
            if (!CORE.state.isOnline) {
                UI.toast('��š ��� � � Mode Hors Ligne: la vente sera synchronis�e quand la connexion revient', 'warning');
            }

            if (paymentMethod === 'cod') {
                this.showCODConfirmationModal();
                return;
            }

            this.finalizeOrder({
                paymentMethod,
                paymentStatus: 'paid',
                deliveryDetails: null,
                livreurId: null
            });
        },

        // =====================
        // R�SERVATION (livraison future)
        // =====================
        showReservationModal() {
            // R�servation = cr�ation d'une commande COD + bon de livraison planifi� (non assign�)
            // Ouvre le mode panier R�servation (panier s�par�)
            this.state.posMode = 'reservation';
            if (this.state.reservationCart.length === 0 && this.state.cart.length > 0) {
                // Copie rapide du panier normal si d�j�� pr�par�
                this.state.reservationCart = this.state.cart.map(i => ({ ...i }));
                this.state.reservationManualDeliveryFee = this.state.manualDeliveryFee || 0;
            }

            if (this.state.reservationCart.length === 0) {
                UI.toast('Ajoutez des articles au panier R�servation avant de cr�er une r�servation', 'warning');
                this.navigateTo('pos');
                this.openReservationCart();
                return;
            }

            const userPos = CORE.user?.pos;
            const livreurs = CORE.getLivreursForPOS(userPos);
            const activeDeliveries = CORE.db.deliveries.filter(d => d.posId == userPos && d.status === 'en_cours');
            const counts = {};
            activeDeliveries.forEach(d => {
                if (d.livreurId) counts[d.livreurId] = (counts[d.livreurId] || 0) + 1;
            });
            livreurs.sort((a, b) => (counts[a.id] || 0) - (counts[b.id] || 0));

            const dd = this.state.deliveryDetails || {};
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const ddDay = String(today.getDate()).padStart(2, '0');
            const todayStr = `${yyyy}-${mm}-${ddDay}`;

            const optionsLivreurs = [
                { value: '', label: '-- Choisir un livreur (Optionnel) --' },
                ...livreurs.map(l => {
                    const c = counts[l.id] || 0;
                    const status = c > 0 ? `(${c} en cours ��Ÿ� �)` : `(${c} en cours ��ŸŸ �)`;
                    return { value: l.id, label: `${l.name} ${status}` };
                })
            ];

            UI.modal('R�servation (livraison future)', `
                <div class="space-y-4">
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl text-sm">
                        <div class="flex justify-between mb-1">
                            <span class="text-slate-500">Total pr�vu:</span>
                            <span class="font-black text-slate-800">${CORE.formatPrice(this.getGrandTotal())}</span>
                        </div>
                        <div class="text-xs text-slate-500">La r�servation cr�e une commande en <b>paiement �� la livraison</b> (COD) + un bon de livraison.</div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        ${UI.input('res_date', 'Date de livraison', 'date', dd.date || todayStr, '', true)}
                        ${UI.input('res_time', 'Heure', 'time', dd.time || '', '', false)}
                    </div>

                    <div class="space-y-3">
                        ${UI.input('res_name', 'Nom du client', 'text', dd.name || '', '', true)}
                        ${UI.input('res_phone', 'T�l�phone', 'tel', dd.phone || '', '', true)}
                        ${UI.textarea('res_address', 'Adresse de livraison', dd.address || '', 'Quartier, rue, rep��res...', 2)}
                    </div>

                    <div class="pt-2 border-t border-slate-100">
                        <label class="block text-sm font-bold text-slate-700 mb-2">Assigner un livreur (optionnel)</label>
                        <select id="res_livreur" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-emerald-500 outline-none font-medium">
                            ${optionsLivreurs.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                        </select>
                        <div class="text-xs text-slate-500 mt-1">Vous pouvez assigner un livreur d�j�� occup� (cumul de courses).</div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 pt-4 border-t border-slate-100">
                        <button onclick="VendeurModule.submitReservation(false)" class="py-3 px-4 bg-slate-100 text-slate-700 font-black rounded-xl hover:bg-slate-200 transition text-sm">
                            Enregistrer
                        </button>
                        <button onclick="VendeurModule.submitReservation(true)" class="py-3 px-4 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="message-square" class="w-4 h-4"></i> Enregistrer + SMS
                        </button>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        submitReservation(sendSms = false) {
            const date = (document.getElementById('res_date')?.value || '').trim();
            const time = (document.getElementById('res_time')?.value || '').trim();
            const name = (document.getElementById('res_name')?.value || '').trim();
            const phone = (document.getElementById('res_phone')?.value || '').trim();
            const address = (document.getElementById('res_address')?.value || '').trim();
            const livreurIdRaw = document.getElementById('res_livreur')?.value;
            const livreurId = livreurIdRaw ? parseInt(livreurIdRaw, 10) : null;

            if (!date || !name || !phone || !address) {
                return UI.toast('Date, nom, t�l�phone et adresse requis', 'warning');
            }

            // Une r�servation ne doit PAS ��tre assign�e automatiquement.
            // On enregistre la commande COD + un bon de livraison au statut "reservation" (planifi�).
            this.state.deliveryDetails = { name, phone, address, date, time };

            // Utiliser le panier R�servation sans toucher au panier normal
            const prevCart = this.state.cart;
            const prevFee = this.state.manualDeliveryFee;
            this.state.cart = this.state.reservationCart.map(i => ({ ...i }));
            this.state.manualDeliveryFee = this.state.reservationManualDeliveryFee || 0;

            const { order, delivery } = this.finalizeOrder({
                paymentMethod: 'cod',
                paymentStatus: 'pending',
                deliveryDetails: { name, phone, address, date, time },
                livreurId: null,
                deliveryStatus: 'reservation'
            }) || {};

            // Restaurer panier normal
            this.state.cart = prevCart;
            this.state.manualDeliveryFee = prevFee;

            // Vider le panier R�servation apr��s enregistrement
            this.state.reservationCart = [];
            this.state.reservationManualDeliveryFee = 0;
            this.state.reservationCartDrawerOpen = false;
            this.clearSavedReservationCart(); // Supprimer la sauvegarde localStorage

            // Optionnel: pr�parer un SMS au livreur choisi (sans assigner). On n'envoie que si demand� et si un livreur est s�lectionn�.
            if (sendSms && livreurId) {
                const l = CORE.getUser(livreurId);
                const phoneTo = (l?.phone || '').trim();
                if (phoneTo) {
                    const ref = delivery?.orderRef || order?.reference || 'Course';
                    const when = `${date}${time ? ' ' + time : ''}`;
                    const amount = order?.total || 0;
                    const msg = `R�servation ${ref}. Livraison pr�vue: ${when}. Client: ${name}, ${phone}. Adr: ${address}. A encaisser: ${CORE.formatPrice(amount)}. (Assignation �� faire �� l'heure pr�vue)`;
                    window.open(`sms:${phoneTo}?body=${encodeURIComponent(msg)}`, '_blank');
                } else {
                    UI.toast('T�l�phone du livreur manquant', 'warning');
                }
            }

            UI.closeModal();
            UI.toast('R�servation enregistr�e (non assign�e)', 'success');
            // aller sur l'historique des r�servations
            this.navigateTo('reservations');
        },

        showCODConfirmationModal() {
            const userPos = CORE.user?.pos;
            const livreurs = CORE.getLivreursForPOS(userPos);
            
            // Count active deliveries for this POS
            const activeDeliveries = CORE.db.deliveries.filter(d => d.status === 'en_cours' && d.posId == userPos);
            const counts = {};
            activeDeliveries.forEach(d => {
                if (d.livreurId) counts[d.livreurId] = (counts[d.livreurId] || 0) + 1;
            });
            
            // Sort by workload (ascending) so freer drivers appear first, but all are selectable
            livreurs.sort((a, b) => (counts[a.id] || 0) - (counts[b.id] || 0));

            const dd = this.state.deliveryDetails || {};
            
            const optionsLivreurs = [
                { value: '', label: '-- Choisir un livreur (Optionnel) --' },
                ...livreurs.map(l => {
                    const count = counts[l.id] || 0;
                    // Affichage clair du nombre de courses
                    const status = count > 0 ? `(${count} en cours ��Ÿ� �)` : `(${count} en cours ��ŸŸ �)`;
                    return { value: l.id, label: `${l.name} ${status}` };
                })
            ];

            UI.modal('Validation Livraison (COD)', `
                <div class="space-y-4">
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl text-sm">
                        <div class="flex justify-between mb-1">
                            <span class="text-slate-500">Total �� encaisser:</span>
                            <span class="font-black text-slate-800">${CORE.formatPrice(this.getGrandTotal())}</span>
                        </div>
                    </div>

                    <div class="space-y-3">
                        ${UI.input('cod_name', 'Nom du client', 'text', dd.name || '', '', true)}
                        ${UI.input('cod_phone', 'T�l�phone', 'tel', dd.phone || '', '', true)}
                        ${UI.textarea('cod_address', 'Adresse de livraison', dd.address || '', 'Quartier, rue, rep��res...', 2)}
                        ${UI.input('cod_date', 'Date de livraison', 'date', dd.date || '', '', false)}
                        ${UI.input('cod_time', 'Heure de livraison', 'time', dd.time || '', 'Imm�diat', false)}
                    </div>

                    <div class="pt-2 border-t border-slate-100">
                        <label class="block text-sm font-bold text-slate-700 mb-2">Assigner un livreur</label>
                        <select id="cod_livreur" onchange="VendeurModule.updateCodAssignButtons()" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-emerald-500 outline-none font-medium">
                            ${optionsLivreurs.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                        </select>
                        <div class="text-xs text-slate-500 mt-1">Vous pouvez assigner un livreur d�j�� occup� (cumul de courses).</div>
                    </div>

                    <div id="cod-assign-buttons-container" class="grid grid-cols-2 gap-3 pt-4 border-t border-slate-100">
                        <button onclick="VendeurModule.submitCODOrder(false)" class="py-3 px-4 bg-slate-100 text-slate-700 font-black rounded-xl hover:bg-slate-200 transition text-sm">
                            Assignation Directe
                        </button>
                        <button onclick="VendeurModule.submitCODOrder(true)" class="py-3 px-4 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="message-square" class="w-4 h-4"></i> SMS
                        </button>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
            // Initialiser le rendu des boutons selon la s�lection actuelle
            setTimeout(() => this.updateCodAssignButtons(), 120);
        },

        submitCODOrder(sendSms = false) {
            const name = document.getElementById('cod_name').value.trim();
            const phone = document.getElementById('cod_phone').value.trim();
            const address = document.getElementById('cod_address').value.trim();
            const date = document.getElementById('cod_date').value.trim();
            const time = document.getElementById('cod_time').value.trim();
            const livreurIdRaw = document.getElementById('cod_livreur').value;
            // Supporter les IDs string pour les livreurs ind�pendants
            const livreurId = livreurIdRaw ? (String(livreurIdRaw).startsWith('idm_') ? livreurIdRaw : parseInt(livreurIdRaw, 10)) : null;

            if (!name || !phone || !address) {
                return UI.toast('Nom, t�l�phone et adresse requis pour la livraison', 'warning');
            }

            this.state.deliveryDetails = { name, phone, address, date, time };

            // V�rifier si validation requise
            const cartTotal = this.getCartTotal();
            const validation = ValidationModule.checkValidationRequired('order', cartTotal);

            if (validation.required) {
                // Afficher modal pour confirmation
                const content = `
                    <div class="space-y-4">
                        <div class="bg-amber-50 rounded-lg p-4 border border-amber-200">
                            <div class="text-sm text-amber-800">
                                <strong>��š ��� � � Cette commande d�passe le seuil de ${CORE.formatPrice(validation.rule.threshold)}</strong>
                            </div>
                            <div class="text-sm text-amber-700 mt-2">
                                Montant: <strong>${CORE.formatPrice(cartTotal)}</strong>
                            </div>
                            <div class="text-sm text-amber-700 mt-2">
                                Cette commande devra ��tre approuv�e par un Manager avant traitement.
                            </div>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                            <div class="text-sm text-blue-700">
                                Les validations seront enregistr�es dans l'audit trail.
                            </div>
                        </div>
                    </div>
                `;
                
                UI.showModal(content, [
                    { label: '���?? Continuer & Soumettre', onclick: `VendeurModule.confirmAndSubmitCODOrder(${sendSms ? 'true' : 'false'})` },
                    { label: 'Annuler', onclick: 'UI.closeModal()' }
                ], '��š ��� � � Validation Requise');
                return;
            }

            const { order, delivery } = this.finalizeOrder({
                paymentMethod: 'cod',
                paymentStatus: 'pending',
                deliveryDetails: { name, phone, address, date, time },
                livreurId
            }) || {};

            // Envoi SMS (optionnel) au livreur s�lectionn�
            if (sendSms) {
                if (!livreurId) {
                    UI.toast('Aucun livreur s�lectionn� pour SMS', 'warning');
                } else {
                    // V�rifier si c'est un livreur ind�pendant (ID commence par 'idm_')
                    const isIndependent = String(livreurId).startsWith('idm_');
                    let l = null;
                    if (isIndependent) {
                        l = CORE.db.independentDeliveryMen.find(dm => dm.id === livreurId);
                    } else {
                        l = CORE.getUser(livreurId);
                    }
                    const phoneTo = (l?.phone || '').trim();
                    if (!phoneTo) {
                        UI.toast('T�l�phone du livreur manquant', 'warning');
                    } else {
                        const ref = delivery?.orderRef || order?.reference || 'Course';
                        const amount = delivery?.amount || order?.total || 0;
                        const msg = `Course ${ref} assign�e. Client: ${name}, ${phone}. Adr: ${address}. Heure: ${time || '�� ?��'}. A encaisser: ${CORE.formatPrice(amount)}.`;
                        window.open(`sms:${phoneTo}?body=${encodeURIComponent(msg)}`, '_blank');
                    }
                }
            }

            UI.closeModal();
        },

        // Mettre �� jour les boutons d'assignation dans la modal COD (WhatsApp pour ind�pendants)
        updateCodAssignButtons() {
            const livreurIdRaw = UI.val('cod_livreur') || '';
            const isIndependent = String(livreurIdRaw).startsWith('idm_');
            const container = document.getElementById('cod-assign-buttons-container');
            if (!container) return;

            if (isIndependent) {
                container.innerHTML = `
                    <button onclick="VendeurModule.submitCODOrderWhatsApp()" class="py-3 px-4 bg-green-500 text-white font-black rounded-xl hover:bg-green-600 shadow-lg shadow-green-200 transition flex items-center justify-center gap-2 text-sm">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                        WhatsApp
                    </button>
                    <button onclick="VendeurModule.submitCODOrder(true)" class="py-3 px-4 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition flex items-center justify-center gap-2 text-sm">
                        <i data-lucide="message-square" class="w-4 h-4"></i> SMS
                    </button>
                `;
            } else {
                container.innerHTML = `
                    <button onclick="VendeurModule.submitCODOrder(false)" class="py-3 px-4 bg-slate-100 text-slate-700 font-black rounded-xl hover:bg-slate-200 transition text-sm">
                        Assignation Directe
                    </button>
                    <button onclick="VendeurModule.submitCODOrder(true)" class="py-3 px-4 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition flex items-center justify-center gap-2 text-sm">
                        <i data-lucide="message-square" class="w-4 h-4"></i> SMS
                    </button>
                `;
            }
            setTimeout(() => lucide.createIcons(), 50);
        },

        // Soumettre la commande COD en ouvrant d'abord WhatsApp pour le livreur ind�pendant
        submitCODOrderWhatsApp() {
            const livreurIdRaw = UI.val('cod_livreur') || '';
            if (!livreurIdRaw) return UI.toast('S�lectionnez un livreur ind�pendant', 'warning');
            if (!String(livreurIdRaw).startsWith('idm_')) return this.submitCODOrder(false);

            const livreur = CORE.db.independentDeliveryMen.find(dm => dm.id === livreurIdRaw);
            const phoneTo = (livreur?.phone || '').trim();
            if (!phoneTo) return UI.toast('T�l�phone du livreur manquant', 'warning');

            const name = document.getElementById('cod_name')?.value.trim() || '';
            const phone = document.getElementById('cod_phone')?.value.trim() || '';
            const address = document.getElementById('cod_address')?.value.trim() || '';
            const time = document.getElementById('cod_time')?.value.trim() || '';
            const amount = this.getGrandTotal();

            const msg = `Course COD. Client: ${name}, ${phone}. Adr: ${address}. Heure: ${time || '�� ?��'}. A encaisser: ${CORE.formatPrice(amount)}.`;
            window.open(`https://wa.me/${phoneTo.replace(/[^0-9+]/g, '')}?text=${encodeURIComponent(msg)}`, '_blank');

            // Soumettre ensuite la commande normalement
            this.submitCODOrder(false);
        },

        confirmAndSubmitCODOrder(sendSms = false) {
            if (!CORE.hasPermission('orders.create')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const name = document.getElementById('cod_name')?.value.trim() || this.state.deliveryDetails?.name;
            const phone = document.getElementById('cod_phone')?.value.trim() || this.state.deliveryDetails?.phone;
            const address = document.getElementById('cod_address')?.value.trim() || this.state.deliveryDetails?.address;
            const date = document.getElementById('cod_date')?.value.trim() || this.state.deliveryDetails?.date;
            const time = document.getElementById('cod_time')?.value.trim() || this.state.deliveryDetails?.time;
            const livreurIdRaw = document.getElementById('cod_livreur')?.value;
            // Supporter les IDs string pour les livreurs ind�pendants
            const livreurId = livreurIdRaw ? (String(livreurIdRaw).startsWith('idm_') ? livreurIdRaw : parseInt(livreurIdRaw, 10)) : null;

            const { order, delivery } = this.finalizeOrder({
                paymentMethod: 'cod',
                paymentStatus: 'pending',
                deliveryDetails: { name, phone, address, date, time },
                livreurId
            }) || {};

            if (order) {
                // Soumettre pour approbation
                ValidationModule.submitOrderForApproval(order.id);
                UI.showNotification(`���?? Commande cr��e et soumise pour approbation`, 'success');
            }

            UI.closeModal();
        },

        finalizeOrder({ paymentMethod, paymentStatus, deliveryDetails, livreurId, deliveryStatus = null }) {
            if (!CORE.hasPermission('orders.create')) {
                UI.toast('Acc��s refus�', 'error');
                return null;
            }
            const subtotal = this.getCartTotal();
            const deliveryFee = this.getDeliveryFee();
            const total = subtotal + deliveryFee;
            const ref = `CMD-${String(CORE.db.orders.length + 1).padStart(4,'0')}`;

            // Stock checks
            for (const it of this.state.cart) {
                const p = CORE.getProduct(it.productId);
                if (!p || p.stock < it.qty) return UI.toast(`Stock insuffisant: ${it.name}`, 'error');
            }

            // Deduct stock
            for (const it of this.state.cart) {
                const p = CORE.getProduct(it.productId);
                CORE.update('products', p.id, { stock: p.stock - it.qty });
                CORE.recordStockMovement({ productId: p.id, type: 'out', qty: it.qty, ref, note: 'Vente' });
            }

            const clientName = deliveryDetails?.name || (this.state.selectedClientId ? CORE.getClient(this.state.selectedClientId)?.name : 'Client');
            const clientPhone = deliveryDetails?.phone || '';
            const clientAddress = deliveryDetails?.address || '';
            const deliveryDate = deliveryDetails?.date || null;
            const deliveryTime = deliveryDetails?.time || null;

            // D�tection de client existant ou cr�ation automatique
            let clientId = this.state.selectedClientId || null;
            const userPos = CORE.user?.pos || CORE.state.currentUser?.pos || 1;
            if (!clientId && clientPhone) {
                // Chercher par t�l�phone - filtr� par POS
                const existingClient = (CORE.db.clients || []).find(c => 
                    (c.phone || '').replace(/\s+/g, '') === clientPhone.replace(/\s+/g, '') &&
                    c.posId == userPos
                );
                if (existingClient) {
                    clientId = existingClient.id;
                    // Mettre �� jour les infos du client si n�cessaire
                    if (clientAddress && !existingClient.address) {
                        CORE.update('clients', clientId, { address: clientAddress });
                    }
                    if (clientName && clientName !== 'Client' && !existingClient.name) {
                        CORE.update('clients', clientId, { name: clientName });
                    }
                } else if (clientName && clientName !== 'Client') {
                    // Cr�er automatiquement un nouveau client
                    const newClient = CORE.create('clients', {
                        name: clientName,
                        phone: clientPhone,
                        address: clientAddress || '',
                        posId: CORE.user?.pos || 1,
                        createdAt: new Date().toISOString()
                    });
                    clientId = newClient.id;
                    console.log('���?� Nouveau client cr�� automatiquement:', newClient);
                }
            } else if (!clientId && clientName && clientName !== 'Client') {
                // M��me sans t�l�phone, cr�er le client si on a un nom
                const existingByName = (CORE.db.clients || []).find(c => 
                    c.name?.toLowerCase().trim() === clientName.toLowerCase().trim() &&
                    c.posId == (CORE.user?.pos || 1)
                );
                if (existingByName) {
                    clientId = existingByName.id;
                    // Mettre �� jour le t�l�phone si fourni
                    if (clientPhone && !existingByName.phone) {
                        CORE.update('clients', clientId, { phone: clientPhone });
                    }
                } else {
                    const newClient = CORE.create('clients', {
                        name: clientName,
                        phone: clientPhone || '',
                        address: clientAddress || '',
                        posId: CORE.user?.pos || 1,
                        createdAt: new Date().toISOString()
                    });
                    clientId = newClient.id;
                    console.log('���?� Nouveau client cr�� automatiquement (sans t�l�phone):', newClient);
                }
            }

            const order = CORE.create('orders', {
                reference: ref,
                subtotal,
                deliveryFee,
                total,
                status: paymentMethod === 'cod' ? (livreurId ? 'delivering' : 'pending') : 'delivered',
                paymentMethod, // garder le code (cash/mobile/card/cod)
                paymentStatus,
                sellerId: CORE.state.currentUser?.id,
                posId: CORE.state.currentUser?.pos || 1,
                cityId: CORE.state.currentUser?.city || 1,
                clientId: clientId || undefined, // Lier au client existant si trouv�
                clientName,
                clientPhone,
                clientAddress,
                deliveryDate,
                deliveryTime,
                items: this.state.cart.map(i => ({ productId: i.productId, name: i.name, qty: i.qty, price: i.price }))
            });

            // Enregistrer l'activit�
            CORE.logActivity('create', 'order', order.id, {
                entityName: `Commande ${order.reference}`,
                description: `${order.items?.length || 0} articles - ${clientName}`,
                amount: order.total,
                status: 'success'
            });

            if (paymentStatus === 'paid') CORE.ensureSaleTransaction(order);

            let delivery = null;
            if (paymentMethod === 'cod') {
                const forcedStatus = deliveryStatus ? String(deliveryStatus) : null;
                const effectiveLivreurId = forcedStatus ? null : (livreurId || null);
                // Statut initial toujours 'en_attente' - c'est au livreur de signaler 'en_cours'
                const effectiveStatus = forcedStatus ? forcedStatus : 'en_attente';

                delivery = CORE.create('deliveries', {
                    orderId: order.id,
                    orderRef: order.reference,
                    clientName,
                    clientPhone,
                    address: clientAddress,
                    deliveryDate,
                    deliveryTime,
                    livreurId: effectiveLivreurId,
                    posId: CORE.state.currentUser?.pos || 1,
                    status: effectiveStatus,
                    amount: total,
                    commission: Math.round(total * 0.05)
                });

                if (forcedStatus === 'reservation') {
                    UI.toast('Bon de livraison planifi� (r�servation)', 'info');
                } else if (effectiveLivreurId) {
                    const l = CORE.getUser(effectiveLivreurId);
                    UI.toast(`Course assign�e �� ${l?.name || 'Livreur'}`, 'info');
                } else {
                    UI.toast('Course mise en attente (Dispatch)', 'info');
                }
            }

            this.state.cart = [];
            this.state.deliveryDetails = null; // Reset details after successful order
            
            UI.toast(`Commande ${order.reference} cr��e`, 'success');
            this.showReceiptModal(order.id);
            App.rerender();
            return { order, delivery };
        },

        showReceiptModal(orderId) {
            const o = CORE.db.orders.find(x => x.id === orderId);
            if (!o) return;
            const items = (o.items || []).map(it => `<div class="flex justify-between text-sm"><span>${it.qty}�?? ${it.name}</span><span class="font-bold">${CORE.formatPrice(it.qty * it.price)}</span></div>`).join('');

            const subtotal = o.subtotal ?? (o.items || []).reduce((a,it)=>a+(Number(it.qty||0)*Number(it.price||0)),0);
            const deliveryFee = Number(o.deliveryFee || 0);
            const hasDelivery = deliveryFee > 0;
            
            // Texte personnalis� du logo
            const prefs = this.state.preferences || {};
            const logoText = prefs.receiptLogoText?.trim() || CORE.getCompanyName();
            const subtitleText = prefs.receiptSubtitle?.trim() || '';

            UI.modal('Ticket de caisse', `
                <div class="print-area">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="font-black text-slate-900 text-xl">${logoText}</div>
                            ${subtitleText ? `<div class="text-xs text-emerald-600 font-medium italic">${subtitleText}</div>` : ''}
                            <div class="text-xs text-slate-500 font-bold uppercase tracking-wider">${CORE.getPOS(o.posId)?.name || 'Point de vente'}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-black">${o.reference}</div>
                            <div class="text-xs text-slate-500">${CORE.formatDate(o.createdAt)}</div>
                        </div>
                    </div>
                    <div class="my-4 h-px bg-slate-200"></div>
                    <div class="space-y-2">${items}</div>
                    <div class="my-4 h-px bg-slate-200"></div>

                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between"><span class="font-bold text-slate-600">Sous-total</span><span class="font-black">${CORE.formatPrice(subtotal)}</span></div>
                        ${hasDelivery ? `<div class="flex justify-between"><span class="font-bold text-slate-600">Livraison</span><span class="font-black">${CORE.formatPrice(deliveryFee)}</span></div>` : ''}
                    </div>

                    <div class="mt-3 flex justify-between items-center">
                        <div class="text-sm font-bold text-slate-600">Total</div>
                        <div class="text-2xl font-black text-emerald-600">${CORE.formatPrice(o.total)}</div>
                    </div>
                    <div class="mt-2 text-xs text-slate-500">Paiement: <span class="font-bold">${CORE.paymentMethodLabel(o.paymentMethod)}</span></div>
                    ${o.zoneName ? `<div class="mt-1 text-xs text-slate-500">Zone: <span class="font-bold">${o.zoneName}</span></div>` : ''}
                </div>
                <div class="no-print mt-5 p-4 bg-slate-50 rounded-2xl border border-slate-200 text-xs text-slate-600">
                    Astuce: cliquez sur <b>Imprimer</b> pour g�n�rer un ticket.
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' },
                { label: 'Imprimer', onclick: 'window.print()', class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        // =====================
        // GESTION CLIENTS L�G�?RE
        // =====================
        getClientOrderHistory(clientId) {
            return CORE.db.orders
                .filter(o => o.clientId === clientId)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        },

        getClientStats(clientId) {
            const orders = this.getClientOrderHistory(clientId);
            const totalSpent = orders.reduce((a, o) => a + (o.total || 0), 0);
            const totalItems = orders.reduce((a, o) => a + (o.items?.reduce((x, i) => x + i.qty, 0) || 0), 0);
            const avgOrder = orders.length > 0 ? Math.round(totalSpent / orders.length) : 0;
            const lastOrder = orders[0];
            const lastOrderDate = lastOrder ? lastOrder.createdAt : null;
            return { totalSpent, totalItems, avgOrder, lastOrderDate, orderCount: orders.length };
        },

        updateClientNotes(clientId, notes) {
            const c = CORE.getClient(clientId);
            if (c) {
                c.notes = notes.trim();
                
                // Enregistrer dans le journal d'audit
                const currentUser = CORE.state.currentUser;
                CORE.db.auditLogs = CORE.db.auditLogs || [];
                CORE.db.auditLogs.push({
                    id: 'audit_' + Date.now(),
                    timestamp: new Date().toISOString(),
                    userId: currentUser?.id,
                    userName: currentUser?.name,
                    userRole: currentUser?.role,
                    posId: currentUser?.pos,
                    action: 'update',
                    entity: 'client',
                    entityId: clientId,
                    entityName: c.name,
                    details: `Notes client modifi�es: ${c.name}`,
                    status: 'success'
                });
                CORE.save();
                UI.toast('Notes sauvegard�es', 'success');
                this.showClientPickerModal();
            }
        },

        updateClientTags(clientId, tags) {
            const c = CORE.getClient(clientId);
            if (c) {
                c.tags = Array.isArray(tags) ? tags : [];
                
                // Enregistrer dans le journal d'audit
                const currentUser = CORE.state.currentUser;
                CORE.db.auditLogs = CORE.db.auditLogs || [];
                CORE.db.auditLogs.push({
                    id: 'audit_' + Date.now(),
                    timestamp: new Date().toISOString(),
                    userId: currentUser?.id,
                    userName: currentUser?.name,
                    userRole: currentUser?.role,
                    posId: currentUser?.pos,
                    action: 'update',
                    entity: 'client',
                    entityId: clientId,
                    entityName: c.name,
                    details: `Tags client modifi�s: ${c.name}`,
                    status: 'success'
                });
                CORE.save();
                UI.toast('Tags sauvegard�s', 'success');
                this.showClientPickerModal();
            }
        },

        showClientTagsModal(clientId) {
            const c = CORE.getClient(clientId);
            if (!c) return;

            const availableTags = CORE.db.clientTags || [];
            const clientTags = c.tags || [];

            UI.modal(`Classifier - ${c.name}`, `
                <div class="space-y-4">
                    <p class="text-xs text-slate-500">S�lectionnez les tags pour classifier ce client.</p>
                    
                    <div class="grid grid-cols-2 gap-2">
                        ${availableTags.map(tag => {
                            const isSelected = clientTags.includes(tag.id);
                            const colorMap = {
                                emerald: 'border-emerald-300 bg-emerald-50',
                                red: 'border-red-300 bg-red-50',
                                purple: 'border-purple-300 bg-purple-50',
                                amber: 'border-amber-300 bg-amber-50',
                                blue: 'border-blue-300 bg-blue-50',
                                cyan: 'border-cyan-300 bg-cyan-50'
                            };
                            const colorText = {
                                emerald: 'text-emerald-700',
                                red: 'text-red-700',
                                purple: 'text-purple-700',
                                amber: 'text-amber-700',
                                blue: 'text-blue-700',
                                cyan: 'text-cyan-700'
                            };
                            const color = colorMap[tag.color] || colorMap.slate;
                            const textColor = colorText[tag.color] || 'text-slate-700';

                            return `
                                <button onclick="VendeurModule.toggleClientTag('${tag.id}', ${clientTags.includes(tag.id) ? 'true' : 'false'}, ${clientId})" class="p-3 rounded-xl border-2 transition ${isSelected ? color + ' border-opacity-100' : 'border-slate-200 bg-white hover:border-slate-300'}">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="${tag.icon}" class="w-4 h-4 ${isSelected ? textColor : 'text-slate-400'}"></i>
                                        <span class="text-xs font-black ${isSelected ? textColor : 'text-slate-600'}">${tag.label}</span>
                                    </div>
                                </button>
                            `;
                        }).join('')}
                    </div>

                    ${clientTags.length > 0 ? `
                        <div class="p-3 bg-slate-50 rounded-xl border border-slate-200">
                            <div class="text-xs font-bold text-slate-600 mb-2">Tags actuels:</div>
                            <div class="flex flex-wrap gap-1">
                                ${clientTags.map(tagId => {
                                    const tag = availableTags.find(t => t.id === tagId);
                                    if (!tag) return '';
                                    return `<span class="px-2 py-1 bg-slate-100 text-slate-700 text-xs font-bold rounded-full flex items-center gap-1">
                                        <i data-lucide="${tag.icon}" class="w-3 h-3"></i> ${tag.label}
                                    </span>`;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Sauvegarder', onclick: `VendeurModule.updateClientTags(${clientId}, [${clientTags.map(t => `'${t}'`).join(', ')}])`, class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition' }
            ]);
        },

        toggleClientTag(tagId, isSelected, clientId) {
            const c = CORE.getClient(clientId);
            if (!c) return;
            
            c.tags = c.tags || [];
            if (isSelected) {
                c.tags = c.tags.filter(t => t !== tagId);
            } else {
                if (!c.tags.includes(tagId)) {
                    c.tags.push(tagId);
                }
            }
            
            CORE.save();
            this.showClientTagsModal(clientId);
        },

        // Clients - debounce pour la recherche
        clientPickerSearchTimeout: null,
        handleClientPickerSearch(value) {
            this.state.clientPickerSearch = value;
            // Debounce: attendre 300ms apr��s la derni��re frappe
            clearTimeout(this.clientPickerSearchTimeout);
            this.clientPickerSearchTimeout = setTimeout(() => {
                this.showClientPickerModal();
                // Restaurer le focus apr��s le rerender
                setTimeout(() => {
                    const input = document.getElementById('client-picker-search');
                    if (input) {
                        input.focus();
                        input.setSelectionRange(input.value.length, input.value.length);
                    }
                }, 50);
            }, 300);
        },

        showClientPickerModal() {
            const userPos = CORE.user?.pos || CORE.state.currentUser?.pos;
            const q = (this.state.clientPickerSearch || '').toLowerCase().trim();
            const clients = CORE.db.clients
                .filter(c => c.posId == userPos) // Filtrer par POS
                .filter(c => !q || (c.name || '').toLowerCase().includes(q) || (c.phone || '').toLowerCase().includes(q) || (c.notes || '').toLowerCase().includes(q))
                .sort((a, b) => {
                    // Trier: segment VIP en premier, puis par derni��re date d'achat
                    const aVip = (a.segment === 'vip') ? 0 : 1;
                    const bVip = (b.segment === 'vip') ? 0 : 1;
                    if (aVip !== bVip) return aVip - bVip;
                    return new Date(b.lastPurchaseDate || 0) - new Date(a.lastPurchaseDate || 0);
                })
                .slice(0, 30);

            UI.modal('S�lectionner un client', `
                <div class="space-y-4">
                    <div class="relative flex gap-2">
                        <div class="relative flex-1">
                            <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                            <input id="client-picker-search" value="${this.state.clientPickerSearch}" onkeyup="VendeurModule.handleClientPickerSearch(this.value)" onkeypress="if(event.key==='Enter'){event.preventDefault();}" placeholder="Nom, t�l�phone ou notes..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-2 max-h-[55vh] overflow-auto">
                        ${clients.length === 0 ? `<div class="p-6 text-center text-slate-400 font-medium">Aucun client trouv�</div>` : ''}
                        ${clients.map(c => {
                            const selected = this.state.selectedClientId === c.id;
                            const stats = this.getClientStats(c.id);
                            const isVip = c.segment === 'vip';
                            const clientTags = c.tags || [];
                            const availableTags = CORE.db.clientTags || [];
                            
                            return `
                            <div class="rounded-2xl border ${selected ? 'border-emerald-300 bg-emerald-50' : 'border-slate-100 bg-white hover:bg-slate-50'} transition p-3">
                                <div class="flex items-start justify-between gap-2 mb-2">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2">
                                            <div class="font-black text-slate-900 truncate">${c.name}</div>
                                            ${isVip ? `<span class="text-xs font-black px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded">VIP</span>` : ''}
                                        </div>
                                        <div class="text-xs text-slate-500">${c.phone || ''}</div>
                                    </div>
                                    <button onclick="VendeurModule.selectClient(${c.id})" class="${selected ? 'bg-emerald-500 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'} px-3 py-1.5 rounded-lg font-black text-xs transition">
                                        Choisir
                                    </button>
                                </div>

                                <div class="text-xs text-slate-600 mb-2">
                                    <div><b>Adresse:</b> ${c.address || '�� ?��'}</div>
                                </div>

                                ${c.notes ? `<div class="mb-2 p-2 bg-blue-50 border border-blue-100 rounded-lg"><div class="text-xs text-blue-700"><b>��Ÿ? � Notes:</b> ${c.notes}</div></div>` : ''}

                                ${clientTags.length > 0 ? `
                                    <div class="mb-2 flex flex-wrap gap-1">
                                        ${clientTags.map(tagId => {
                                            const tag = availableTags.find(t => t.id === tagId);
                                            if (!tag) return '';
                                            const colorBg = {
                                                emerald: 'bg-emerald-100 text-emerald-700',
                                                red: 'bg-red-100 text-red-700',
                                                purple: 'bg-purple-100 text-purple-700',
                                                amber: 'bg-amber-100 text-amber-700',
                                                blue: 'bg-blue-100 text-blue-700',
                                                cyan: 'bg-cyan-100 text-cyan-700'
                                            }[tag.color] || 'bg-slate-100 text-slate-700';
                                            return `<span class="px-2 py-0.5 ${colorBg} text-[10px] font-black rounded-full flex items-center gap-1">
                                                <i data-lucide="${tag.icon}" class="w-3 h-3"></i> ${tag.label}
                                            </span>`;
                                        }).join('')}
                                    </div>
                                ` : ''}

                                <div class="grid grid-cols-4 gap-1 text-xs mb-2">
                                    <div class="bg-slate-50 p-1.5 rounded">
                                        <div class="text-slate-500 font-bold">Achats</div>
                                        <div class="font-black text-slate-800">${stats.orderCount}</div>
                                    </div>
                                    <div class="bg-emerald-50 p-1.5 rounded">
                                        <div class="text-emerald-600 font-bold">Total</div>
                                        <div class="font-black text-emerald-700 text-xs">${CORE.formatPrice(stats.totalSpent).split(' ')[0]}</div>
                                    </div>
                                    <div class="bg-blue-50 p-1.5 rounded">
                                        <div class="text-blue-600 font-bold">Articles</div>
                                        <div class="font-black text-blue-700">${stats.totalItems}</div>
                                    </div>
                                    <div class="bg-amber-50 p-1.5 rounded">
                                        <div class="text-amber-600 font-bold">Moy.</div>
                                        <div class="font-black text-amber-700 text-xs">${CORE.formatPrice(stats.avgOrder).split(' ')[0]}</div>
                                    </div>
                                </div>

                                <div class="flex gap-2">
                                    <button onclick="VendeurModule.showClientHistoryModal(${c.id})" class="flex-1 px-2 py-1.5 bg-blue-100 text-blue-700 rounded-lg font-bold text-xs hover:bg-blue-200 transition flex items-center justify-center gap-1">
                                        <i data-lucide="history" class="w-3 h-3"></i> Historique
                                    </button>
                                    <button onclick="VendeurModule.showClientNotesModal(${c.id})" class="flex-1 px-2 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold text-xs hover:bg-purple-200 transition flex items-center justify-center gap-1">
                                        <i data-lucide="edit-2" class="w-3 h-3"></i> Notes
                                    </button>
                                    <button onclick="VendeurModule.showClientTagsModal(${c.id})" class="flex-1 px-2 py-1.5 bg-amber-100 text-amber-700 rounded-lg font-bold text-xs hover:bg-amber-200 transition flex items-center justify-center gap-1">
                                        <i data-lucide="tag" class="w-3 h-3"></i> Classer
                                    </button>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `, [
                { label: 'Nouveau client', onclick: 'VendeurModule.showNewClientModal()', class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showClientHistoryModal(clientId) {
            const c = CORE.getClient(clientId);
            if (!c) return;

            const orders = this.getClientOrderHistory(clientId);
            const stats = this.getClientStats(clientId);

            UI.modal(`Historique - ${c.name}`, `
                <div class="space-y-4">
                    <div class="grid grid-cols-4 gap-2 text-xs">
                        <div class="bg-slate-50 p-3 rounded-xl">
                            <div class="text-slate-500 font-bold uppercase">Commandes</div>
                            <div class="font-black text-lg text-slate-800">${stats.orderCount}</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-xl">
                            <div class="text-emerald-600 font-bold uppercase">D�pens�</div>
                            <div class="font-black text-emerald-700">${CORE.formatPrice(stats.totalSpent)}</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-xl">
                            <div class="text-blue-600 font-bold uppercase">Articles</div>
                            <div class="font-black text-lg text-blue-700">${stats.totalItems}</div>
                        </div>
                        <div class="bg-amber-50 p-3 rounded-xl">
                            <div class="text-amber-600 font-bold uppercase">Moyenne</div>
                            <div class="font-black text-amber-700">${CORE.formatPrice(stats.avgOrder)}</div>
                        </div>
                    </div>

                    <div class="space-y-2 max-h-[40vh] overflow-y-auto">
                        ${orders.length === 0 ? `<div class="p-6 text-center text-slate-400 font-medium">Aucune commande</div>` : ''}
                        ${orders.map((o, idx) => `
                            <div class="p-3 border border-slate-200 rounded-xl bg-slate-50">
                                <div class="flex items-center justify-between mb-1">
                                    <div class="font-bold text-slate-800">${o.reference}</div>
                                    <div class="text-xs font-bold text-emerald-600">${CORE.formatPrice(o.total)}</div>
                                </div>
                                <div class="text-xs text-slate-500 mb-1">
                                    ${CORE.formatDate(o.createdAt)}
                                </div>
                                <div class="text-xs text-slate-600">
                                    ${o.items?.map(it => `${it.qty}�?? ${it.name}`).join(', ') || '�� ?��'}
                                </div>
                                <div class="mt-1 flex gap-1">
                                    <span class="px-2 py-0.5 text-xs font-bold rounded ${
                                        o.status === 'delivered' ? 'bg-emerald-100 text-emerald-700' :
                                        o.status === 'cancelled' ? 'bg-red-100 text-red-700' :
                                        'bg-blue-100 text-blue-700'
                                    }">${o.status === 'delivered' ? '���?? Livr�e' : o.status === 'cancelled' ? '���?� Annul�e' : '�� � � ' + o.status}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showClientNotesModal(clientId) {
            const c = CORE.getClient(clientId);
            if (!c) return;

            UI.modal(`Modifier notes - ${c.name}`, `
                <div class="space-y-4">
                    <p class="text-xs text-slate-500">Ajoutez des notes rapides pour ce client (statut VIP, pr�f�rences, etc.)</p>
                    <textarea id="client_notes" rows="4" placeholder="Ex: Client VIP, pr�f��re livraison le jeudi, num�ro de compte: XXXX..." class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:bg-white focus:border-transparent outline-none transition font-medium text-slate-800 placeholder-slate-400">${c.notes || ''}</textarea>
                    <div class="text-xs text-slate-400">
                        ${(c.notes || '').length} / 500 caract��res
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Sauvegarder', onclick: `VendeurModule.updateClientNotes(${clientId}, document.getElementById('client_notes').value)`, class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition' }
            ]);
        },

        selectClient(clientId) {
            const c = CORE.getClient(clientId);
            if (!c) return;
            this.state.selectedClientId = c.id;
            this.recordClientAccess(clientId); // Enregistrer l'acc��s
            // Pr�-remplir d�tails de livraison depuis le client (si non d�j�� saisis)
            const dd = this.state.deliveryDetails || { name: '', phone: '', address: '', date: '', time: '' };
            this.state.deliveryDetails = {
                name: dd.name || c.name || '',
                phone: dd.phone || c.phone || '',
                address: dd.address || c.address || '',
                date: dd.date || '',
                time: dd.time || ''
            };
            UI.closeModal();
            UI.toast('Client s�lectionn�', 'success');
            App.rerender();
        },

        showNewClientModal() {
            UI.modal('Nouveau client', `
                <div class="space-y-4">
                    ${UI.input('new_client_name','Nom complet','text','','Ex: Ibrahim Bakary',true)}
                    ${UI.input('new_client_phone','T�l�phone','tel','','+242 ...',true)}
                    ${UI.textarea('new_client_address','Adresse','','Rue / Quartier')}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'VendeurModule.saveNewClient()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },
        saveNewClient() {
            const name = UI.val('new_client_name').trim();
            const phone = UI.val('new_client_phone').trim();
            const address = UI.val('new_client_address').trim();
            if (!name || !phone) return UI.toast('Nom et t�l�phone requis', 'warning');
            const currentUser = CORE.state.currentUser;
            const created = CORE.create('clients', { name, phone, address, totalOrders: 0, totalSpent: 0, posId: currentUser?.pos });
            this.state.selectedClientId = created.id;
            // Pr�-remplir d�tails livraison avec le client cr��
            this.state.deliveryDetails = { name: created.name || '', phone: created.phone || '', address: created.address || '', date: '', time: '' };
            
            // Enregistrer dans le journal d'audit
            CORE.db.auditLogs = CORE.db.auditLogs || [];
            CORE.db.auditLogs.push({
                id: 'audit_' + Date.now(),
                timestamp: new Date().toISOString(),
                userId: currentUser?.id,
                userName: currentUser?.name,
                userRole: currentUser?.role,
                posId: currentUser?.pos,
                action: 'create',
                entity: 'client',
                entityId: created.id,
                entityName: name,
                details: `Client cr��: ${name} (${phone})`,
                status: 'success'
            });
            CORE.save();
            
            UI.closeModal();
            UI.toast('Client ajout�', 'success');
            App.rerender();
        },

        // D�tails de livraison (saisie manuelle par le vendeur)
        showDeliveryDetailsModal() {
            const selectedClient = this.state.selectedClientId ? CORE.getClient(this.state.selectedClientId) : null;
            const dd = this.state.deliveryDetails || { name: '', phone: '', address: '', date: '', time: '' };

            // Si aucun d�tail saisi, on propose par d�faut ceux du client
            const initName = dd.name || selectedClient?.name || '';
            const initPhone = dd.phone || selectedClient?.phone || '';
            const initAddress = dd.address || selectedClient?.address || '';
            const initDate = dd.date || '';
            const initTime = dd.time || '';

            const suggestionsHtml = `
                <div id="client-suggestions-container" class="hidden p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                    <div class="text-xs font-black text-blue-700 mb-3">��Ÿ? � Clients correspondants trouv�s:</div>
                    <div id="client-suggestions-list" class="space-y-2"></div>
                </div>
            `;

            UI.modal('D�tails de livraison', `
                <div class="space-y-4">
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">
                        Ces informations seront utilis�es sur le <b>bon de livraison</b> (paiement �� la livraison).
                    </div>
                    ${UI.input('dd_name','Nom','text', initName, 'Nom du client / r�ception', true)}
                    ${UI.input('dd_phone','T�l�phone','tel', initPhone, '+242 ...', true)}
                    ${UI.input('dd_date','Date de livraison','date', initDate, '', false)}
                    ${UI.input('dd_time','Heure de livraison','time', initTime, '', false)}
                    ${UI.textarea('dd_address','Adresse', initAddress, 'Adresse compl��te (quartier, rue, rep��res)', 3)}
                    ${suggestionsHtml}
                </div>
            `, [
                { label: 'Effacer', onclick: 'VendeurModule.clearDeliveryDetails()', class: 'px-5 py-2.5 bg-slate-100 text-slate-700 font-black rounded-xl hover:bg-slate-200 transition' },
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'VendeurModule.saveDeliveryDetails()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);

            // Ajouter les �couteurs pour les suggestions en temps r�el
            setTimeout(() => {
                const nameInput = document.getElementById('dd_name');
                const phoneInput = document.getElementById('dd_phone');
                const addressInput = document.getElementById('dd_address');

                const onInput = () => {
                    const name = nameInput?.value?.trim() || '';
                    const phone = phoneInput?.value?.trim() || '';
                    const address = addressInput?.value?.trim() || '';
                    VendeurModule.updateClientSuggestions(name, phone, address);
                };

                nameInput?.addEventListener('input', onInput);
                phoneInput?.addEventListener('input', onInput);
                addressInput?.addEventListener('input', onInput);
            }, 100);
        },

        updateClientSuggestions(name, phone, address) {
            const userPos = CORE.user?.pos || CORE.state.currentUser?.pos;
            const suggestions = [];

            // Rechercher par t�l�phone (exact) - filtr� par POS
            if (phone) {
                const cleanPhone = phone.replace(/\s+/g, '').replace(/[^0-9]/g, '');
                if (cleanPhone.length >= 7) {
                    const byPhone = (CORE.db.clients || []).filter(c => {
                        if (c.posId != userPos) return false; // Filtre POS
                        const cPhone = (c.phone || '').replace(/\s+/g, '').replace(/[^0-9]/g, '');
                        return cPhone.endsWith(cleanPhone) || cleanPhone.endsWith(cPhone);
                    });
                    suggestions.push(...byPhone);
                }
            }

            // Rechercher par nom (d�but du nom) - filtr� par POS
            if (name && name.length >= 2) {
                const nameQuery = name.toLowerCase();
                const byName = (CORE.db.clients || []).filter(c =>
                    c.posId == userPos && // Filtre POS
                    (c.name || '').toLowerCase().startsWith(nameQuery) &&
                    !suggestions.find(s => s.id === c.id)
                );
                suggestions.push(...byName);
            }

            // Rechercher par adresse (partielle) - filtr� par POS
            if (address && address.length >= 3) {
                const addressQuery = address.toLowerCase();
                const byAddress = (CORE.db.clients || []).filter(c =>
                    c.posId == userPos && // Filtre POS
                    (c.address || '').toLowerCase().includes(addressQuery) &&
                    !suggestions.find(s => s.id === c.id)
                );
                suggestions.push(...byAddress);
            }

            // Limiter �� 5 suggestions
            const uniqueSuggestions = suggestions.slice(0, 5);

            // Afficher les suggestions
            const container = document.getElementById('client-suggestions-container');
            const list = document.getElementById('client-suggestions-list');

            if (uniqueSuggestions.length > 0) {
                container?.classList.remove('hidden');
                list.innerHTML = uniqueSuggestions.map(c => `
                    <div class="p-3 bg-white border border-blue-200 rounded-xl flex items-center justify-between cursor-pointer hover:bg-blue-50 transition group">
                        <div class="flex-1">
                            <div class="font-black text-slate-900 text-sm">${c.name}</div>
                            <div class="text-xs text-slate-500">${c.phone || 'N/A'} �� ?� � ${c.address || 'Adresse non d�finie'}</div>
                        </div>
                        <button onclick="VendeurModule.selectClientSuggestion(${c.id})" class="px-3 py-1.5 bg-blue-600 text-white text-xs font-black rounded-lg opacity-0 group-hover:opacity-100 transition">Utiliser</button>
                    </div>
                `).join('');
            } else {
                container?.classList.add('hidden');
            }
        },

        selectClientSuggestion(clientId) {
            const client = CORE.getClient(clientId);
            if (!client) return;

            // Pr�-remplir avec les infos du client
            document.getElementById('dd_name').value = client.name || '';
            document.getElementById('dd_phone').value = client.phone || '';
            document.getElementById('dd_address').value = client.address || '';

            // S�lectionner le client aussi
            this.state.selectedClientId = clientId;

            // Masquer les suggestions
            const container = document.getElementById('client-suggestions-container');
            container?.classList.add('hidden');

            UI.toast(`Client ${client.name} s�lectionn�`, 'success');
        },

        saveDeliveryDetails() {
            const name = UI.val('dd_name').trim();
            const phoneRaw = UI.val('dd_phone').trim();
            const date = UI.val('dd_date').trim();
            const time = UI.val('dd_time').trim();
            const address = UI.val('dd_address').trim();
            if (!name || !phoneRaw) return UI.toast('Nom et t�l�phone requis', 'warning');

            const phone = phoneRaw.replace(/\s+/g, ' ').trim();
            const digits = phone.replace(/[^0-9]/g, '');
            if (digits.length < 7) return UI.toast('Num�ro de t�l�phone invalide', 'warning');

            // V�rifier si le client existe d�j�� (par t�l�phone) - filtr� par POS
            const cleanPhone = phone.replace(/\s+/g, '').replace(/[^0-9]/g, '');
            const userPos = CORE.user?.pos || CORE.state.currentUser?.pos || 1;
            let existingClient = (CORE.db.clients || []).find(c => {
                const cPhone = (c.phone || '').replace(/\s+/g, '').replace(/[^0-9]/g, '');
                return (cPhone.endsWith(cleanPhone) || cleanPhone.endsWith(cPhone)) && c.posId == userPos;
            });

            // Si le client n'existe pas, le cr�er automatiquement
            if (!existingClient) {
                existingClient = CORE.create('clients', {
                    name,
                    phone,
                    address: address || '',
                    email: '',
                    totalOrders: 0,
                    totalSpent: 0,
                    status: 'active',
                    segment: 'nouveau',
                    tags: [],
                    notes: 'Cr�� automatiquement lors d\'une saisie de livraison',
                    posId: userPos
                });
                UI.toast(`���? � Nouveau client cr��: ${name}`, 'success');
            }

            // S�lectionner le client (nouveau ou existant)
            this.state.selectedClientId = existingClient.id;
            this.state.deliveryDetails = { name, phone, address, date, time };

            UI.closeModal();
            UI.toast('D�tails de livraison enregistr�s', 'success');
            App.rerender();
        },

        clearDeliveryDetails() {
            this.state.deliveryDetails = { name: '', phone: '', address: '', date: '', time: '' };
            UI.closeModal();
            UI.toast('D�tails de livraison effac�s', 'info');
            App.rerender();
        },

        // =====================
        // VARIANTES AVANC�ES
        // =====================
        showProductVariantsModal(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return;

            const variants = CORE.getProductVariants(productId);
            const attrTypes = CORE.db.productAttributeTypes || [];

            UI.modal(`Variantes: ${product.name}`, `
                <div class="space-y-4">
                    <div class="text-xs text-slate-500">G�rez les SKU, prix et stocks par variante.</div>
                    
                    <div class="max-h-[50vh] overflow-y-auto space-y-3">
                        ${variants.length === 0 ? `
                            <div class="p-6 text-center text-slate-400 bg-slate-50 rounded-xl border border-slate-200">
                                <div class="text-sm font-medium">Aucune variante</div>
                                <div class="text-xs mt-1">Cliquez ci-dessous pour ajouter une variante.</div>
                            </div>
                        ` : ''}

                        ${variants.map((v, idx) => `
                            <div class="border border-slate-200 rounded-xl p-3 bg-slate-50">
                                <div class="flex items-start justify-between mb-2">
                                    <div>
                                        <div class="text-xs font-black text-slate-500 uppercase">SKU</div>
                                        <div class="font-mono text-sm font-bold text-slate-800">${v.sku || '�� ?��'}</div>
                                    </div>
                                    <button onclick="VendeurModule.deleteProductVariant(${productId}, ${idx})" class="px-2 py-1 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-xs font-bold">
                                        Supprimer
                                    </button>
                                </div>

                                <div class="grid grid-cols-3 gap-2 mb-2 text-xs">
                                    <div>
                                        <div class="font-black text-slate-500 uppercase mb-0.5">Prix</div>
                                        <div class="font-bold text-slate-800">${CORE.formatPrice(v.price || product.price)}</div>
                                    </div>
                                    <div>
                                        <div class="font-black text-slate-500 uppercase mb-0.5">Stock</div>
                                        <div class="font-bold text-slate-800">${v.stock ?? product.stock}</div>
                                    </div>
                                    <div>
                                        <div class="font-black text-slate-500 uppercase mb-0.5">Attributs</div>
                                        <div class="text-slate-700">${(v.attributes || []).length}</div>
                                    </div>
                                </div>

                                ${(v.attributes || []).map(attr => `
                                    <div class="text-xs bg-white border border-slate-200 rounded px-2 py-1 mb-1 flex items-center justify-between">
                                        <span class="font-medium text-slate-600">${attr.name}:</span>
                                        <span class="font-bold text-slate-800">${attr.value}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `).join('')}
                    </div>

                    <div class="pt-3 border-t border-slate-100">
                        <button onclick="VendeurModule.showAddVariantModal(${productId})" class="w-full py-3 px-4 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition text-sm flex items-center justify-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i> Ajouter une variante
                        </button>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showAddVariantModal(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return;

            const attrTypes = CORE.db.productAttributeTypes || [];
            let selectedAttrs = {};

            UI.modal(`Nouvelle variante: ${product.name}`, `
                <div class="space-y-4">
                    <div class="text-xs text-slate-500">D�finissez les attributs, SKU, prix et stock.</div>

                    <div id="variant_attrs_container" class="space-y-3 bg-slate-50 p-3 rounded-xl border border-slate-200">
                        <div class="text-xs font-bold text-slate-600">Attributs (optionnel)</div>
                        ${attrTypes.map((at, idx) => `
                            <div>
                                <label class="text-xs font-black text-slate-500 uppercase block mb-1">${at.label}</label>
                                ${at.type === 'select' ? `
                                    <select id="attr_${at.id}" class="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium focus:ring-2 focus:ring-emerald-500 outline-none">
                                        <option value="">�� ?�� Aucun �� ?��</option>
                                        ${at.id === 'color' ? ['Rouge', 'Bleu', 'Vert', 'Noir', 'Blanc'].map(v => `<option value="${v}">${v}</option>`).join('') : ''}
                                        ${at.id === 'size' ? ['XS', 'S', 'M', 'L', 'XL', 'XXL'].map(v => `<option value="${v}">${v}</option>`).join('') : ''}
                                        ${at.id === 'temperature' ? ['Froid', 'Temp�r�', 'Chaud'].map(v => `<option value="${v}">${v}</option>`).join('') : ''}
                                    </select>
                                ` : `
                                    <input type="text" id="attr_${at.id}" placeholder="Valeur..." class="w-full px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm font-medium focus:ring-2 focus:ring-emerald-500 outline-none">
                                `}
                            </div>
                        `).join('')}
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        ${UI.input('var_sku', 'SKU (optionnel)', 'text', '', 'Ex: PROD-001-RED-M')}
                        ${UI.input('var_price', 'Prix (vide = prix du produit)', 'number', '', (product.price || 0).toString())}
                    </div>

                    ${UI.input('var_stock', 'Stock', 'number', Math.max(0, parseInt(product.stock) || 0).toString(), '', true)}

                    <div class="text-xs text-slate-500 bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <div class="font-bold text-blue-700 mb-1">��Ÿ? � Conseil</div>
                        Vous pouvez cr�er plusieurs variantes avec les m��mes attributs pour avoir diff�rents SKU/prix/stocks.
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Cr�er', onclick: `VendeurModule.saveProductVariant(${productId})`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        saveProductVariant(productId) {
            if (!CORE.hasPermission('products.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const product = CORE.getProduct(productId);
            if (!product) return;

            const attrTypes = CORE.db.productAttributeTypes || [];
            const attributes = [];

            attrTypes.forEach(at => {
                const val = UI.val(`attr_${at.id}`).trim();
                if (val) {
                    attributes.push({ name: at.label, value: val });
                }
            });

            const sku = UI.val('var_sku').trim() || null;
            const priceRaw = UI.val('var_price').trim();
            const price = priceRaw ? Number(priceRaw) : null;
            const stock = Number(UI.val('var_stock') || 0);

            if (stock <= 0) return UI.toast('Stock doit ��tre > 0', 'warning');

            const variant = {
                id: Date.now(),
                productId,
                attributes,
                sku: sku || null,
                price: price || null,
                stock,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            CORE.db.productVariants.push(variant);
            
            // Enregistrer dans le journal d'audit
            const currentUser = CORE.state.currentUser;
            CORE.db.auditLogs = CORE.db.auditLogs || [];
            CORE.db.auditLogs.push({
                id: 'audit_' + Date.now(),
                timestamp: new Date().toISOString(),
                userId: currentUser?.id,
                userName: currentUser?.name,
                userRole: currentUser?.role,
                posId: currentUser?.pos,
                action: 'create',
                entity: 'variante_produit',
                entityId: variant.id,
                entityName: product.name,
                details: `Variante cr��e pour ${product.name}: ${attributes.map(a => a.value).join(', ')}`,
                status: 'success'
            });
            CORE.save();

            UI.closeModal();
            UI.toast('Variante cr��e', 'success');
            this.showProductVariantsModal(productId);
        },

        deleteProductVariant(productId, variantIdx) {
            if (!CORE.hasPermission('products.delete')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const variants = CORE.getProductVariants(productId);
            const product = CORE.getProduct(productId);
            if (variantIdx >= 0 && variantIdx < variants.length) {
                const v = variants[variantIdx];
                CORE.db.productVariants = CORE.db.productVariants.filter(x => x.id !== v.id);
                
                // Enregistrer dans le journal d'audit
                const currentUser = CORE.state.currentUser;
                CORE.db.auditLogs = CORE.db.auditLogs || [];
                CORE.db.auditLogs.push({
                    id: 'audit_' + Date.now(),
                    timestamp: new Date().toISOString(),
                    userId: currentUser?.id,
                    userName: currentUser?.name,
                    userRole: currentUser?.role,
                    posId: currentUser?.pos,
                    action: 'delete',
                    entity: 'variante_produit',
                    entityId: v.id,
                    entityName: product?.name || 'Produit',
                    details: `Variante supprim�e du produit ${product?.name || productId}`,
                    status: 'success'
                });
                CORE.save();
                UI.toast('Variante supprim�e', 'success');
                this.showProductVariantsModal(productId);
            }
        },

        // Vue vendeur: afficher TOUTES les variantes d'un produit
        showVariantsList(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return;

            const variants = CORE.getProductVariants(productId);

            UI.modal(`Variantes: ${product.name}`, `
                <div class="space-y-2 max-h-[70vh] overflow-y-auto">
                    ${variants.length === 0 ? `
                        <div class="p-6 text-center text-slate-400 bg-slate-50 rounded-xl border border-slate-200">
                            <div class="text-sm font-medium">Aucune variante</div>
                            <div class="text-xs mt-1">Ajoutez une variante depuis le Stock Control Center</div>
                        </div>
                    ` : ''}

                    ${variants.map((v, idx) => `
                        <div class="p-3 border border-slate-200 rounded-xl bg-slate-50 hover:bg-slate-100 transition">
                            <div class="grid grid-cols-4 gap-2 mb-2">
                                <div>
                                    <div class="text-[9px] font-bold text-slate-500 uppercase">Prix</div>
                                    <div class="font-black text-emerald-600">${CORE.formatPrice(v.price || product.price)}</div>
                                </div>
                                <div>
                                    <div class="text-[9px] font-bold text-slate-500 uppercase">Stock</div>
                                    <div class="font-black ${v.stock > 0 ? 'text-slate-900' : 'text-red-600'}">${v.stock}</div>
                                </div>
                                <div>
                                    <div class="text-[9px] font-bold text-slate-500 uppercase">SKU</div>
                                    <div class="font-mono text-xs">${v.sku || '�� ?��'}</div>
                                </div>
                                <div class="text-right">
                                    <button onclick="VendeurModule.addToCartWithVariant(${productId}, ${idx})" class="px-2 py-1 bg-emerald-600 text-white rounded font-black text-xs hover:bg-emerald-700">Ajouter</button>
                                </div>
                            </div>
                            ${(v.attributes || []).length > 0 ? `
                                <div class="flex flex-wrap gap-1">
                                    ${(v.attributes || []).map(attr => `
                                        <span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-[10px] font-bold">${attr.name}: ${attr.value}</span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        // Afficher les variantes au moment d'ajouter au panier
        showVariantPickerModal(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return;

            const variants = CORE.getProductVariants(productId);

            if (variants.length === 0) {
                // Pas de variante: ajouter directement
                this.addToCart(productId);
                return;
            }

            UI.modal(`S�lectionner variante: ${product.name}`, `
                <div class="space-y-3 max-h-[60vh] overflow-y-auto">
                    ${variants.map((v, idx) => `
                        <button onclick="VendeurModule.addToCartWithVariant(${productId}, ${idx})" class="w-full p-3 border-2 border-slate-200 rounded-xl hover:border-emerald-500 hover:bg-emerald-50 transition text-left">
                            <div class="flex items-start justify-between mb-1">
                                <div class="flex-1">
                                    ${(v.attributes || []).map(attr => `
                                        <div class="text-xs text-slate-600 font-medium">${attr.name}: <span class="font-bold text-slate-800">${attr.value}</span></div>
                                    `).join('')}
                                </div>
                                <div class="text-right ml-2">
                                    <div class="font-black text-emerald-600">${CORE.formatPrice(v.price || product.price)}</div>
                                    <div class="text-xs text-slate-500">Stock: ${v.stock ?? product.stock}</div>
                                </div>
                            </div>
                            ${v.sku ? `<div class="text-xs font-mono text-slate-500">SKU: ${v.sku}</div>` : ''}
                        </button>
                    `).join('')}
                </div>
            `, [
                { label: 'Ajouter sans variante', onclick: `VendeurModule.addToCart(${productId}); UI.closeModal();` },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        addToCartWithVariant(productId, variantIdx) {
            const p = CORE.getProduct(productId);
            if (!p || !p.active) return UI.toast('Produit indisponible', 'error');

            const variants = CORE.getProductVariants(productId);
            if (variantIdx >= variants.length) return UI.toast('Variante invalide', 'error');

            const variant = variants[variantIdx];
            const availableStock = variant.stock ?? p.stock;

            if (availableStock <= 0) return UI.toast('Stock �puis� pour cette variante', 'warning');

            const variantKey = JSON.stringify(variant.attributes || []);
            const existingItem = this.state.cart.find(i => i.productId === productId && i.variantKey === variantKey);

            if (existingItem) {
                if (existingItem.qty < availableStock) {
                    existingItem.qty++;
                } else {
                    UI.toast('Stock maximum pour cette variante', 'warning');
                }
            } else {
                this.state.cart.push({
                    productId: p.id,
                    name: p.name,
                    price: variant.price || p.price,
                    qty: 1,
                    maxStock: availableStock,
                    discountPercent: 0,
                    variantId: variant.id,
                    variantKey,
                    sku: variant.sku,
                    attributes: variant.attributes
                });
            }

            UI.closeModal();
            App.rerender();
        },

        showOrderDetail(orderId) {
            const o = CORE.db.orders.find(x => x.id === orderId);
            if (!o) return;
            const statusColors = { pending: 'amber', delivering: 'purple', delivered: 'emerald', cancelled: 'red' };
            
            // Chercher la livraison associ�e
            const delivery = CORE.db.deliveries.find(d => d.orderId === orderId);
            const hasProof = delivery && (delivery.proofPhotos?.length > 0 || delivery.proofSignature);
            const isDelivered = delivery && delivery.status === 'livree';
            
            // Section livraison si applicable
            let deliverySection = '';
            if (delivery) {
                const livreur = delivery.livreurId ? CORE.getUser(delivery.livreurId) : null;
                const deliveryStatusColors = { en_attente: 'slate', en_cours: 'amber', livree: 'emerald', probleme: 'red', annulee: 'red' };
                const deliveryStatusLabels = { en_attente: 'En attente', en_cours: 'En cours', livree: 'Livr�e', probleme: 'Probl��me', annulee: 'Annul�e' };
                
                deliverySection = `
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-2xl p-4">
                        <div class="text-xs font-black text-blue-600 uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i data-lucide="truck" class="w-4 h-4"></i> Livraison
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-bold text-slate-700">R�f�rence</span>
                                <span class="text-sm font-black text-slate-900">${delivery.orderRef}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-bold text-slate-700">Statut</span>
                                ${UI.badge(deliveryStatusLabels[delivery.status] || delivery.status, deliveryStatusColors[delivery.status] || 'slate')}
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-bold text-slate-700">Livreur</span>
                                <span class="text-sm font-black text-slate-900">${livreur ? livreur.name : '<span class="text-slate-400">Non assign�</span>'}</span>
                            </div>
                            ${delivery.address ? `
                                <div class="flex items-start justify-between">
                                    <span class="text-sm font-bold text-slate-700">Adresse</span>
                                    <span class="text-sm text-slate-900 text-right max-w-[60%]">${delivery.address}</span>
                                </div>
                            ` : ''}
                            ${delivery.deliveryTime ? `
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-bold text-slate-700">Heure pr�vue</span>
                                    <span class="text-sm font-black text-amber-700">${delivery.deliveryTime}</span>
                                </div>
                            ` : ''}
                            ${delivery.deliveredAt ? `
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-bold text-slate-700">Livr�e le</span>
                                    <span class="text-sm text-emerald-700 font-bold">${new Date(delivery.deliveredAt).toLocaleString('fr-FR')}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${hasProof ? `
                            <div class="mt-4 pt-3 border-t border-blue-200">
                                <button onclick="VendeurModule.showDeliveryProofModal(${delivery.id})" class="w-full py-3 px-4 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition flex items-center justify-center gap-2">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                    Voir les preuves de livraison
                                    ${delivery.proofPhotos?.length ? `<span class="px-2 py-0.5 bg-white/20 rounded-full text-xs">${delivery.proofPhotos.length} ��Ÿ? �</span>` : ''}
                                    ${delivery.proofSignature ? `<span class="px-2 py-0.5 bg-white/20 rounded-full text-xs">���? ��� � �</span>` : ''}
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            UI.modal(`Commande ${o.reference}`, `
                <div class="space-y-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-xs text-slate-500 font-bold uppercase">Statut</div>
                            <div class="mt-1">${UI.badge(o.status, statusColors[o.status] || 'slate')}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-500 font-bold uppercase">Total</div>
                            <div class="text-2xl font-black text-slate-900">${CORE.formatPrice(o.total)}</div>
                        </div>
                    </div>
                    <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-2">Articles</div>
                        <div class="space-y-2">
                            ${(o.items || []).map(it => `
                                <div class="flex justify-between text-sm">
                                    <div class="font-bold text-slate-800">${it.qty}�?? ${it.name}</div>
                                    <div class="font-black">${CORE.formatPrice(it.qty * it.price)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-2">Paiement</div>
                        <div class="flex items-center justify-between">
                            <div class="text-sm font-bold text-slate-800">M�thode</div>
                            <div class="text-sm font-black">${CORE.paymentMethodLabel(o.paymentMethod)}</div>
                        </div>
                        <div class="flex items-center justify-between mt-2">
                            <div class="text-sm font-bold text-slate-800">Statut</div>
                            <div>${UI.badge(CORE.paymentStatusLabel(o.paymentStatus), o.paymentStatus === 'paid' ? 'emerald' : 'amber')}</div>
                        </div>
                    </div>

                    ${deliverySection}

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="VendeurModule.setOrderStatus(${o.id},\'delivered\')" class="px-4 py-3 rounded-xl bg-emerald-600 text-white font-black hover:bg-emerald-700 transition">Marquer livr�</button>
                        <button onclick="VendeurModule.setOrderStatus(${o.id},\'cancelled\')" class="px-4 py-3 rounded-xl bg-red-600 text-white font-black hover:bg-red-700 transition">Annuler</button>
                    </div>
                    <div class="text-xs text-slate-500">Cr��e: ${CORE.formatDate(o.createdAt)}</div>
                </div>
            `);
        },

        // Modal pour afficher les preuves de livraison (photos + signature)
        showDeliveryProofModal(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return UI.toast('Livraison introuvable', 'error');

            const hasPhotos = d.proofPhotos && d.proofPhotos.length > 0;
            const hasSignature = !!d.proofSignature;
            const livreur = d.livreurId ? CORE.getUser(d.livreurId) : null;

            if (!hasPhotos && !hasSignature) {
                return UI.toast('Aucune preuve de livraison disponible', 'info');
            }

            UI.modal(`��Ÿ? � Preuves de livraison - ${d.orderRef}`, `
                <div class="space-y-4">
                    <!-- Info livraison -->
                    <div class="p-4 bg-gradient-to-r from-emerald-50 to-teal-50 rounded-2xl border border-emerald-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-black text-emerald-900">${d.clientName || 'Client'}</div>
                                <div class="text-xs text-emerald-700">${d.address || ''}</div>
                                ${livreur ? `<div class="text-xs text-emerald-600 mt-1">Livreur: <span class="font-bold">${livreur.name}</span></div>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                                <div class="text-xs text-emerald-600">���?? Livr�e</div>
                            </div>
                        </div>
                    </div>

                    ${hasPhotos ? `
                        <!-- Galerie photos -->
                        <div>
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                                <i data-lucide="camera" class="w-4 h-4"></i>
                                Photos de preuve (${d.proofPhotos.length})
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                ${d.proofPhotos.map((photo, idx) => `
                                    <div class="aspect-square rounded-2xl overflow-hidden border-2 border-emerald-300 cursor-pointer hover:border-emerald-500 transition shadow-lg" onclick="VendeurModule.viewProofPhoto('${photo.replace(/'/g, "\\'")}')">
                                        <img src="${photo}" class="w-full h-full object-cover hover:scale-105 transition">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${hasSignature ? `
                        <!-- Signature client -->
                        <div>
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                                <span class="text-lg">���? ��� � �</span>
                                Signature client
                            </div>
                            <div class="p-4 bg-white rounded-2xl border-2 border-blue-200 cursor-pointer hover:border-blue-400 transition shadow-lg" onclick="VendeurModule.viewProofSignature(${d.id})">
                                <img src="${d.proofSignature}" class="w-full max-h-40 object-contain" alt="Signature du client">
                            </div>
                        </div>
                    ` : ''}

                    <!-- Note du livreur -->
                    ${d.proofNote ? `
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-2">Note du livreur</div>
                            <div class="text-sm text-slate-700">${d.proofNote}</div>
                        </div>
                    ` : ''}

                    <!-- Horodatage -->
                    <div class="text-center text-xs text-slate-400 pt-2 border-t border-slate-100">
                        Valid�e le ${d.proofTimestamp ? new Date(d.proofTimestamp).toLocaleString('fr-FR') : (d.deliveredAt ? new Date(d.deliveredAt).toLocaleString('fr-FR') : '�� ?��')}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-lg' });

            setTimeout(() => lucide.createIcons(), 50);
        },

        // Voir une photo de preuve en plein �cran
        viewProofPhoto(photoSrc) {
            UI.modal('��Ÿ? � Photo de preuve', `
                <div class="flex flex-col items-center gap-4">
                    <div class="max-w-full max-h-[70vh] overflow-auto rounded-xl border border-slate-200 shadow-lg">
                        <img src="${photoSrc}" class="max-w-full" alt="Photo de preuve">
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-2xl' });
        },

        setOrderStatus(orderId, status) {
            const o = CORE.db.orders.find(x => x.id === orderId);
            if (!o) return;

            // Coh�rence: on ne marque pas "delivered" manuellement une commande COD si la livraison n'est pas livr�e
            if (status === 'delivered' && o.paymentMethod === 'cod') {
                const del = CORE.db.deliveries.find(d => d.orderId === o.id);
                if (!del || del.status !== 'livree') {
                    return UI.toast('Commande COD: livrez d�� ?� ?�abord la course', 'warning');
                }
            }

            // Si on annule une commande non annul�e => remettre stock
            if (status === 'cancelled' && o.status !== 'cancelled') {
                for (const it of (o.items || [])) {
                    const p = CORE.getProduct(it.productId);
                    if (!p) continue;
                    CORE.update('products', p.id, { stock: Number(p.stock || 0) + Number(it.qty || 0) });
                    CORE.recordStockMovement({ productId: p.id, type: 'in', qty: Number(it.qty || 0), ref: o.reference, note: 'Annulation commande (retour stock)' });
                }

                // Si une course existe, l�� ?� ?�annuler aussi
                const d = CORE.db.deliveries.find(x => x.orderId === o.id && ['en_cours','en_attente','reservation'].includes(x.status));
                if (d) {
                    CORE.update('deliveries', d.id, { status: 'annulee', livreurId: null, cancelledAt: new Date().toISOString() });
                }
            }

            const updated = CORE.update('orders', orderId, { status });
            if (updated) {
                // Enregistrer l'activit�
                const statusLabel = { delivered: 'Livr�', cancelled: 'Annul�', paid: 'Pay�', pending: 'En attente' }[status] || status;
                CORE.logActivity(status, 'order', orderId, {
                    entityName: `Commande ${o.reference}`,
                    description: `Statut chang� �� ${statusLabel}`,
                    amount: o.total,
                    status: 'success'
                });

                // Create notification for cancelled orders
                if (status === 'cancelled' && CORE.db.alertThresholds?.find(t => t.id === 'order_rejected')?.enabled) {
                    CORE.createNotification(
                        'order_rejected',
                        `�� ��? Commande Annul�e: ${o.reference}`,
                        `La commande ${o.reference} a �t� annul�e. Montant: ${o.total} XAF`,
                        'medium',
                        'order',
                        o.id
                    );
                }

                UI.toast(`Statut mis �� jour: ${status}`, 'success');
                UI.closeModal();
                App.rerender();
            }
        },

        // UI chunks
        renderStatCard(label, value, icon, colorClass) {
            return `
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm card-hover group">
                    <div class="w-12 h-12 ${colorClass} rounded-2xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                        <i data-lucide="${icon}" class="w-6 h-6"></i>
                    </div>
                    <div class="text-3xl font-black text-slate-800 tracking-tight">${value}</div>
                    <div class="text-sm text-slate-400 font-bold uppercase tracking-wider mt-1">${label}</div>
                </div>`;
        },
        renderOrderRow(o) {
            const colors = { pending: 'amber', delivering: 'purple', delivered: 'emerald', cancelled: 'red' };
            const pm = o.paymentMethod ? CORE.paymentMethodLabel(o.paymentMethod) : null;
            
            // V�rifier si une livraison avec preuves existe
            const delivery = CORE.db.deliveries.find(d => d.orderId === o.id);
            const hasPhotos = delivery?.proofPhotos?.length > 0;
            const hasSignature = !!delivery?.proofSignature;
            const hasProof = hasPhotos || hasSignature;
            
            // Badge de preuve
            let proofBadge = '';
            if (hasProof) {
                if (hasPhotos && hasSignature) {
                    proofBadge = `<span class="text-[10px] font-bold text-emerald-700 bg-emerald-50 px-1.5 py-0.5 rounded-lg">��Ÿ? �+���? ��� � �</span>`;
                } else if (hasPhotos) {
                    proofBadge = `<span class="text-[10px] font-bold text-emerald-700 bg-emerald-50 px-1.5 py-0.5 rounded-lg">��Ÿ? � ${delivery.proofPhotos.length}</span>`;
                } else if (hasSignature) {
                    proofBadge = `<span class="text-[10px] font-bold text-blue-700 bg-blue-50 px-1.5 py-0.5 rounded-lg">���? ��� � �</span>`;
                }
            }
            
            return `
                <button onclick="VendeurModule.showOrderDetail(${o.id})" class="w-full text-left flex items-center justify-between p-4 rounded-2xl hover:bg-slate-50 border border-transparent hover:border-slate-100 transition group">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-xs text-slate-500 group-hover:bg-white group-hover:shadow-md transition">#${o.id}</div>
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-slate-800">${o.reference}</span>
                                ${proofBadge}
                            </div>
                            <div class="text-xs text-slate-400 font-medium">${CORE.formatDate(o.createdAt)}</div>
                            ${pm ? `<div class="mt-1 text-[10px] text-slate-500 font-bold uppercase tracking-wider">${pm}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="font-bold text-slate-800">${CORE.formatPrice(o.total)}</div>
                        ${UI.badge(o.status, colors[o.status] || 'slate')}
                    </div>
                </button>`;
        },

        // ==================
        // ANALYTICS AVANC�E
        // ==================
        getAdvancedDashboardMetrics() {
            const userId = CORE.state.currentUser?.id;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const last7Days = new Date(today);
            last7Days.setDate(last7Days.getDate() - 7);
            const last30Days = new Date(today);
            last30Days.setDate(last30Days.getDate() - 30);

            // Commandes d'aujourd'hui
            const todayOrders = (CORE.db.orders || []).filter(o => {
                const orderDate = new Date(o.createdAt || new Date());
                return o.sellerId === userId && orderDate >= today && orderDate < new Date(today.getTime() + 86400000);
            });

            // Commandes des 7 derniers jours
            const last7DaysOrders = (CORE.db.orders || []).filter(o => {
                const orderDate = new Date(o.createdAt || new Date());
                return o.sellerId === userId && orderDate >= last7Days;
            });

            // Commandes des 30 derniers jours
            const last30DaysOrders = (CORE.db.orders || []).filter(o => {
                const orderDate = new Date(o.createdAt || new Date());
                return o.sellerId === userId && orderDate >= last30Days;
            });

            // Clients nouveaux d'aujourd'hui
            const todayNewClients = (CORE.db.clients || []).filter(c => {
                const clientDate = new Date(c.createdAt || new Date());
                return clientDate >= today && clientDate < new Date(today.getTime() + 86400000);
            }).length;

            // Clients nouveaux 7 jours
            const last7DaysNewClients = (CORE.db.clients || []).filter(c => {
                const clientDate = new Date(c.createdAt || new Date());
                return clientDate >= last7Days;
            }).length;

            // Top 5 produits
            const productSales = {};
            last30DaysOrders.forEach(o => {
                (o.items || []).forEach(item => {
                    if (!productSales[item.productId]) {
                        productSales[item.productId] = { qty: 0, revenue: 0, name: item.name };
                    }
                    productSales[item.productId].qty += item.qty;
                    productSales[item.productId].revenue += item.qty * item.price;
                });
            });

            const top5Products = Object.values(productSales)
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 5);

            // Top 5 clients
            const clientOrders = {};
            last30DaysOrders.forEach(o => {
                const key = `${o.clientName}-${o.clientPhone}`;
                if (!clientOrders[key]) {
                    clientOrders[key] = { name: o.clientName, phone: o.clientPhone, count: 0, total: 0 };
                }
                clientOrders[key].count += 1;
                clientOrders[key].total += o.total;
            });

            const top5Clients = Object.values(clientOrders)
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);

            // Temps moyen de traitement
            const completedDeliveries = (CORE.db.deliveries || []).filter(d => d.status === 'livree' && d.deliveredAt);
            const avgProcessingTime = completedDeliveries.length > 0 
                ? completedDeliveries.reduce((sum, d) => {
                    const created = new Date(d.createdAt || 0);
                    const delivered = new Date(d.deliveredAt || 0);
                    return sum + ((delivered - created) / 3600000); // en heures
                }, 0) / completedDeliveries.length 
                : 0;

            // CA journalier 7 jours
            const sales7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const dayEnd = new Date(dayStart.getTime() + 86400000);
                const daySales = (CORE.db.orders || [])
                    .filter(o => {
                        const oDate = new Date(o.createdAt || new Date());
                        return o.sellerId === userId && oDate >= dayStart && oDate < dayEnd;
                    })
                    .reduce((sum, o) => sum + o.total, 0);
                sales7Days.push({
                    date: date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' }),
                    value: daySales
                });
            }

            return {
                todayRevenue: todayOrders.reduce((sum, o) => sum + o.total, 0),
                todayOrders: todayOrders.length,
                todayNewClients,
                last7DaysRevenue: last7DaysOrders.reduce((sum, o) => sum + o.total, 0),
                last7DaysOrders: last7DaysOrders.length,
                last7DaysNewClients,
                last30DaysRevenue: last30DaysOrders.reduce((sum, o) => sum + o.total, 0),
                last30DaysOrders: last30DaysOrders.length,
                avgOrderValue: last30DaysOrders.length > 0 ? Math.round(last30DaysOrders.reduce((sum, o) => sum + o.total, 0) / last30DaysOrders.length) : 0,
                top5Products,
                top5Clients,
                avgProcessingTime: Math.round(avgProcessingTime * 10) / 10,
                sales7Days,
                completedDeliveries: completedDeliveries.length
            };
        },

        renderDashboard() {
            const posId = CORE.state.currentUser?.pos;
            const stats = this.getStats();
            const vendorProfile = this.getVendorProfile(CORE.state.currentUser?.id);
            const vendorStats = vendorProfile ? this.getVendorStats(CORE.state.currentUser?.id) : null;
            const badges = CORE.db.vendorBadges || [];
            const currentBadge = vendorProfile && vendorProfile.badge ? badges.find(b => b.id === vendorProfile.badge) : null;

            return `
                <div class="fade-in max-w-5xl mx-auto space-y-8">
                    <!-- Profil Vendeur Card -->
                    ${vendorProfile && vendorStats ? `
                        <div class="bg-gradient-to-r from-slate-900 to-slate-800 rounded-3xl p-6 text-white shadow-lg overflow-hidden relative">
                            <div class="absolute top-0 right-0 w-40 h-40 bg-slate-700/20 rounded-full -mr-10 -mt-10"></div>
                            <div class="relative z-10">
                                <div class="flex items-start justify-between mb-6">
                                    <div class="flex items-center gap-4">
                                        <div class="w-16 h-16 rounded-2xl bg-white/20 flex items-center justify-center text-3xl font-black">
                                            ${vendorProfile.avatar}
                                        </div>
                                        <div>
                                            <h2 class="text-2xl font-black">${CORE.state.currentUser.name}</h2>
                                            <div class="flex items-center gap-2 mt-1">
                                                ${[...Array(Math.floor(vendorStats.rating))].map(() => `<i data-lucide="star" class="w-4 h-4 text-yellow-300 fill-yellow-300"></i>`).join('')}
                                                <span class="text-sm font-bold">${vendorStats.rating.toFixed(1)}/5</span>
                                            </div>
                                        </div>
                                    </div>
                                    <button onclick="VendeurModule.showVendorProfileModal(${CORE.state.currentUser?.id})" class="px-4 py-2 bg-white/20 text-white rounded-xl font-bold hover:bg-white/30 transition">
                                        ��Ÿ? ��� � � Voir Profil
                                    </button>
                                </div>

                                <div class="grid grid-cols-4 gap-3 text-center">
                                    <div>
                                        <div class="text-2xl font-black">${vendorStats.salesCount}</div>
                                        <div class="text-xs font-bold opacity-75">Ventes</div>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-black">${CORE.formatPrice(vendorStats.totalSales).split(' ')[0]}</div>
                                        <div class="text-xs font-bold opacity-75">Total</div>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-black">${CORE.formatPrice(vendorStats.avgOrder).split(' ')[0]}</div>
                                        <div class="text-xs font-bold opacity-75">Moyenne</div>
                                    </div>
                                    <div>
                                        ${currentBadge ? `
                                            <div class="text-sm font-black">${currentBadge.label}</div>
                                            <div class="text-xs font-bold opacity-75">Badge</div>
                                        ` : ''}
                                    </div>
                                </div>

                                ${vendorStats.specialties && vendorStats.specialties.length > 0 ? `
                                    <div class="mt-4 flex flex-wrap gap-2">
                                        ${vendorStats.specialties.map(s => `<span class="px-2 py-1 bg-white/15 text-white text-xs font-black rounded-full">${s}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h1 class="text-3xl font-black text-slate-800">Tableau de Bord</h1>
                            <p class="text-slate-500 font-medium">Ventes, commandes, stock �� ?�� tout au m��me endroit.</p>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="VendeurModule.navigateTo('clients')" class="px-5 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-50 transition flex items-center gap-2">
                                <i data-lucide="users" class="w-5 h-5"></i> Clients
                            </button>
                            <button onclick="VendeurModule.showActivityHistoryModal()" class="px-5 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-50 transition flex items-center gap-2">
                                <i data-lucide="history" class="w-5 h-5"></i> Activit�
                            </button>
                            <button onclick="VendeurModule.showVendeurAuditLog()" class="px-5 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-50 transition flex items-center gap-2">
                                <i data-lucide="book-open" class="w-5 h-5"></i> Journal
                            </button>
                            <button onclick="VendeurModule.showReservationModal()" class="px-5 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-50 transition flex items-center gap-2">
                                <i data-lucide="calendar-clock" class="w-5 h-5"></i> R�servation
                            </button>
                            <button onclick="VendeurModule.navigateTo('livreurs')" class="px-5 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-50 transition flex items-center gap-2">
                                <i data-lucide="bike" class="w-5 h-5"></i> Livreurs
                            </button>
                            <button onclick="VendeurModule.state.posMode='sale';VendeurModule.navigateTo('pos')" class="px-6 py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-700 transition flex items-center gap-2">
                                <i data-lucide="plus" class="w-5 h-5"></i> Nouvelle vente
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        ${this.renderStatCard('CA (aujourd\'hui)', CORE.formatPrice(stats.todayRevenue), 'wallet', 'bg-blue-50 text-blue-600')}
                        ${this.renderStatCard('Transactions', stats.todayTransactions, 'shopping-bag', 'bg-emerald-50 text-emerald-600')}
                        ${this.renderStatCard('En attente', stats.pendingDeliveries, 'truck', 'bg-amber-50 text-amber-600')}
                        ${this.renderStatCard('Stock critique', stats.lowStockProducts, 'alert-circle', 'bg-red-50 text-red-600')}
                    </div>

                    ${(() => {
                        const metrics = this.getAdvancedDashboardMetrics();
                        return `
                            <!-- KPI Avanc�es -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm">
                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">CA Aujourd'hui</div>
                                    <div class="text-2xl font-black text-blue-600 mt-2">${CORE.formatPrice(metrics.todayRevenue)}</div>
                                    <div class="text-xs text-slate-400 mt-2">��Ÿ?Š ${metrics.todayOrders} commandes</div>
                                </div>
                                <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm">
                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">CA 7 jours</div>
                                    <div class="text-2xl font-black text-purple-600 mt-2">${CORE.formatPrice(metrics.last7DaysRevenue)}</div>
                                    <div class="text-xs text-slate-400 mt-2">��Ÿ?�? ${metrics.last7DaysOrders} commandes</div>
                                </div>
                                <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm">
                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">CA 30 jours</div>
                                    <div class="text-2xl font-black text-emerald-600 mt-2">${CORE.formatPrice(metrics.last30DaysRevenue)}</div>
                                    <div class="text-xs text-slate-400 mt-2">��Ÿ? � Moyen: ${CORE.formatPrice(metrics.avgOrderValue)}</div>
                                </div>
                                <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm">
                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Clients Nouveaux</div>
                                    <div class="text-2xl font-black text-cyan-600 mt-2">${metrics.todayNewClients}/${metrics.last7DaysNewClients}</div>
                                    <div class="text-xs text-slate-400 mt-2">��Ÿ? � Aujourd'hui/7j</div>
                                </div>
                            </div>

                            <!-- Graphique Ventes 7 jours -->
                            <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
                                <div class="mb-4">
                                    <h3 class="font-black text-slate-900">��Ÿ?�? Ventes - 7 derniers jours</h3>
                                    <p class="text-xs text-slate-500">Chiffre d'affaires quotidien</p>
                                </div>
                                <div class="flex items-end gap-2 h-32">
                                    ${metrics.sales7Days.map((day, idx) => {
                                        const maxVal = Math.max(...metrics.sales7Days.map(d => d.value)) || 1;
                                        const height = (day.value / maxVal) * 100;
                                        return `
                                            <div class="flex-1 flex flex-col items-center gap-2">
                                                <div class="w-full bg-gradient-to-t from-emerald-500 to-emerald-400 rounded-t-xl transition hover:from-emerald-600 hover:to-emerald-500" style="height: ${Math.max(height, 10)}%" title="${CORE.formatPrice(day.value)}"></div>
                                                <span class="text-xs font-bold text-slate-600">${day.date}</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>

                            <!-- Top Produits et Clients -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Top 5 Produits -->
                                <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
                                    <h3 class="font-black text-slate-900 mb-4">��Ÿ �� Top 5 Produits</h3>
                                    <div class="space-y-3">
                                        ${metrics.top5Products.length === 0 ? `
                                            <div class="p-4 text-center text-slate-400 text-sm">Aucune vente sur 30 jours</div>
                                        ` : metrics.top5Products.map((p, idx) => `
                                            <div class="flex items-center gap-3">
                                                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-emerald-100 text-emerald-600 font-black text-xs flex items-center justify-center">${idx + 1}</div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="font-bold text-slate-900 truncate">${p.name}</div>
                                                    <div class="text-xs text-slate-500">${p.qty} ventes �� ?� � ${CORE.formatPrice(p.revenue)}</div>
                                                </div>
                                                <div class="text-sm font-black text-emerald-600">${Math.round((p.revenue / metrics.last30DaysRevenue) * 100)}%</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <!-- Top 5 Clients -->
                                <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
                                    <h3 class="font-black text-slate-900 mb-4">��Ÿ?? Top 5 Clients</h3>
                                    <div class="space-y-3">
                                        ${metrics.top5Clients.length === 0 ? `
                                            <div class="p-4 text-center text-slate-400 text-sm">Aucune vente sur 30 jours</div>
                                        ` : metrics.top5Clients.map((c, idx) => `
                                            <div class="flex items-center gap-3">
                                                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 font-black text-xs flex items-center justify-center">${idx + 1}</div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="font-bold text-slate-900 truncate">${c.name}</div>
                                                    <div class="text-xs text-slate-500">${c.count} commandes �� ?� � ${CORE.formatPrice(c.total)}</div>
                                                </div>
                                                <div class="text-sm font-black text-blue-600">${Math.round((c.total / metrics.last30DaysRevenue) * 100)}%</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>

                            <!-- Temps de traitement -->
                            <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl p-6 border border-amber-200">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <div class="text-xs font-black text-amber-600 uppercase tracking-wider">�� � ��� � � Temps moyen</div>
                                        <div class="text-3xl font-black text-amber-700 mt-2">${metrics.avgProcessingTime}h</div>
                                        <div class="text-xs text-amber-600 mt-2">Traitement commande</div>
                                    </div>
                                    <div>
                                        <div class="text-xs font-black text-orange-600 uppercase tracking-wider">���?� Livr�s</div>
                                        <div class="text-3xl font-black text-orange-700 mt-2">${metrics.completedDeliveries}</div>
                                        <div class="text-xs text-orange-600 mt-2">Commandes compl�t�es</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    })()}

                    ${this.renderReservationsWidget()}

                    <!-- Widget D�p��ts Livreurs -->
                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                        <div class="flex items-center justify-between mb-5">
                            <div>
                                <h3 class="font-black text-lg text-slate-800">��Ÿ? � D�p��ts Livreurs</h3>
                                <p class="text-xs text-slate-500 font-bold">Montants re��us en caisse</p>
                            </div>
                            <button onclick="VendeurModule.recordDeposit()" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs font-black hover:bg-indigo-700 transition flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Nouveau
                            </button>
                        </div>

                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div class="p-4 rounded-2xl bg-indigo-50 border border-indigo-200">
                                <div class="text-xs text-indigo-600 font-black uppercase tracking-wider mb-1">Total</div>
                                <div class="text-2xl font-black text-indigo-700">${(() => {
                                    const deposits = (CORE.db.deposits || []).filter(d => d.vendeurId === CORE.state.currentUser?.id);
                                    return deposits.reduce((sum, d) => sum + d.amount, 0).toLocaleString();
                                })()} F</div>
                            </div>
                            <div class="p-4 rounded-2xl bg-purple-50 border border-purple-200">
                                <div class="text-xs text-purple-600 font-black uppercase tracking-wider mb-1">Mois</div>
                                <div class="text-2xl font-black text-purple-700">${(() => {
                                    const deposits = (CORE.db.deposits || []).filter(d => {
                                        const date = new Date(d.timestamp);
                                        const now = new Date();
                                        return d.vendeurId === CORE.state.currentUser?.id && date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
                                    });
                                    return deposits.length;
                                })()}</div>
                            </div>
                            <div class="p-4 rounded-2xl bg-pink-50 border border-pink-200">
                                <div class="text-xs text-pink-600 font-black uppercase tracking-wider mb-1">Moyenne</div>
                                <div class="text-2xl font-black text-pink-700">${(() => {
                                    const deposits = (CORE.db.deposits || []).filter(d => d.vendeurId === CORE.state.currentUser?.id);
                                    const avg = deposits.length > 0 ? Math.round(deposits.reduce((sum, d) => sum + d.amount, 0) / deposits.length) : 0;
                                    return avg.toLocaleString();
                                })()} F</div>
                            </div>
                        </div>

                        ${(() => {
                            const deposits = (CORE.db.deposits || []).filter(d => d.vendeurId === CORE.state.currentUser?.id);
                            return deposits.length > 0 ? `
                                <div class="space-y-2">
                                    ${deposits.slice(-5).reverse().map(d => `
                                        <div class="p-3 bg-slate-50 rounded-xl border border-slate-200 flex items-center justify-between">
                                            <div class="flex items-center gap-3">
                                                <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center">
                                                    <i data-lucide="user" class="w-4 h-4 text-indigo-600"></i>
                                                </div>
                                                <div>
                                                    <div class="font-black text-slate-900 text-sm">${d.livreurName}</div>
                                                    <div class="text-xs text-slate-500">${new Date(d.timestamp).toLocaleDateString('fr-FR')}</div>
                                                </div>
                                            </div>
                                            <div class="font-black text-indigo-600">${d.amount.toLocaleString()} F</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <button onclick="VendeurModule.showDepositsModal()" class="mt-4 w-full py-2 text-xs font-black text-indigo-600 hover:text-indigo-700">Voir tout ���?</button>
                            ` : `
                                <div class="text-center py-8 text-slate-500">
                                    <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                    <p class="text-sm font-bold">Aucun d�p��t enregistr�</p>
                                    <p class="text-xs opacity-75">Enregistrez le premier d�p��t</p>
                                </div>
                            `;
                        })()}
                    </div>

                    <!-- Clients Favoris & Historique -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Clients Favoris -->
                        <div class="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-3xl p-6 shadow-sm border border-amber-200">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="font-black text-lg text-slate-800 flex items-center gap-2">
                                    <i data-lucide="star" class="w-5 h-5 text-yellow-500 fill-yellow-500"></i>
                                    Clients Favoris
                                </h3>
                                ${this.state.favoriteClients.length > 0 ? `
                                    <button onclick="VendeurModule.showFavoritesModal()" class="text-xs font-black text-amber-700 hover:text-amber-800 bg-white px-3 py-1 rounded-lg hover:bg-amber-50 transition">
                                        Voir tous (${this.state.favoriteClients.length})
                                    </button>
                                ` : ''}
                            </div>
                            ${(() => {
                                const favorites = this.getFavoriteClients().slice(0, 3);
                                return favorites.length > 0 ? `
                                    <div class="space-y-2">
                                        ${favorites.map(c => `
                                            <div class="p-3 bg-white rounded-xl border border-amber-100 hover:border-amber-300 transition cursor-pointer hover:bg-amber-50" onclick="VendeurModule.recordClientAccess(${c.id}); VendeurModule.selectClient(${c.id})">
                                                <div class="flex items-center justify-between mb-1">
                                                    <div class="font-bold text-slate-800 text-sm">${c.name}</div>
                                                    <button onclick="event.stopPropagation(); VendeurModule.toggleFavoriteClient(${c.id})" class="text-yellow-500 hover:text-yellow-600" title="Retirer des favoris">�� � �</button>
                                                </div>
                                                <div class="flex items-center justify-between text-xs text-slate-600">
                                                    <span>${c.orderCount} commandes</span>
                                                    <span>${CORE.formatPrice(c.totalSpent).split(' ')[0]}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="text-center py-8 text-slate-500">
                                        <i data-lucide="heart" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                        <p class="text-sm font-bold">Aucun client favori</p>
                                        <p class="text-xs opacity-75">�pinglez vos meilleurs clients</p>
                                    </div>
                                `;
                            })()}
                        </div>

                        <!-- Historique d'Acc��s Rapide -->
                        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-3xl p-6 shadow-sm border border-blue-200">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="font-black text-lg text-slate-800 flex items-center gap-2">
                                    <i data-lucide="history" class="w-5 h-5 text-blue-600"></i>
                                    Acc��s Rapide
                                </h3>
                            </div>
                            ${(() => {
                                const recent = this.getRecentClients();
                                return recent.length > 0 ? `
                                    <div class="space-y-2">
                                        ${recent.map((c, idx) => `
                                            <div class="p-3 bg-white rounded-xl border border-blue-100 hover:border-blue-300 transition cursor-pointer hover:bg-blue-50" onclick="VendeurModule.recordClientAccess(${c.id}); VendeurModule.selectClient(${c.id})">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <div class="font-bold text-slate-800 text-sm">${c.name}</div>
                                                        <div class="text-xs text-slate-600">${c.phone || '�� ?��'}</div>
                                                    </div>
                                                    <button onclick="event.stopPropagation(); VendeurModule.toggleFavoriteClient(${c.id}); event.stopPropagation();" class="text-slate-400 hover:text-yellow-500 transition" title="Ajouter aux favoris">
                                                        ${this.isFavoriteClient(c.id) ? '�� � �' : '���?�'}
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="text-center py-8 text-slate-500">
                                        <i data-lucide="clock" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                        <p class="text-sm font-bold">Aucun historique</p>
                                        <p class="text-xs opacity-75">S�lectionnez un client</p>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>

                    <!-- Historique d'Activit� Rapide -->
                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-black text-lg text-slate-800 flex items-center gap-2">
                                <i data-lucide="activity" class="w-5 h-5"></i>
                                Activit� R�cente
                            </h3>
                            <button onclick="VendeurModule.showActivityHistoryModal()" class="px-4 py-2 bg-emerald-100 text-emerald-700 rounded-lg font-black text-sm hover:bg-emerald-200 transition flex items-center gap-2">
                                <i data-lucide="history" class="w-4 h-4"></i>
                                Voir tout
                            </button>
                        </div>
                        <div class="space-y-2">
                            ${(() => {
                                const recentLogs = CORE.getActivityLogs({}).slice(0, 5);
                                return recentLogs.length > 0 ? recentLogs.map(log => {
                                    const date = new Date(log.timestamp);
                                    const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                                    return `
                                        <div class="flex items-center gap-3 p-3 rounded-lg bg-slate-50 hover:bg-slate-100 transition">
                                            <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                                            <div class="flex-1 min-w-0">
                                                <div class="text-xs font-black text-slate-900">${log.action} ${log.entity}</div>
                                                <div class="text-[10px] text-slate-600">${log.userName} �� ?� � ${timeStr}</div>
                                            </div>
                                            ${log.amount > 0 ? `<div class="text-xs font-bold text-slate-800">${CORE.formatPrice(log.amount)}</div>` : ''}
                                        </div>
                                    `;
                                }).join('') : `
                                    <div class="text-center py-4 text-slate-500">
                                        <p class="text-xs font-bold">Aucune activit�</p>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-black text-lg text-slate-800">Derni��res commandes</h3>
                            <button onclick="VendeurModule.navigateTo('orders')" class="text-sm font-black text-emerald-700 hover:text-emerald-800">Voir tout</button>
                        </div>
                        <div class="space-y-3">
                            ${(CORE.db.orders || []).filter(o => o.posId == posId).slice(-6).reverse().map(o => this.renderOrderRow(o)).join('')}
                        </div>
                    </div>
                </div>`;
        },

        renderPOS() {
            const userPos = CORE.user?.pos;
            if (!userPos) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assign�</div></div>`;
            }
            
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'POS ' + userPos;
            const categories = (CORE.db.categories || []).filter(c => !c.posId || c.posId == userPos);
            const q = (this.state.searchQuery || '').toLowerCase().trim();
            // Utiliser le filtre par POS pour afficher uniquement les produits cr��s pour ce POS (hors d�p��t principal)
            const allProductsForPos = CORE.getPOSProducts(userPos);
            const products = allProductsForPos.filter(p => {
                return (!this.state.categoryFilter || p.categoryId === this.state.categoryFilter) &&
                       (!q || (p.name || '').toLowerCase().includes(q));
            });
            const getCatColor = (id) => ['bg-orange-100 text-orange-600', 'bg-blue-100 text-blue-600', 'bg-indigo-100 text-indigo-600', 'bg-emerald-100 text-emerald-600'][id%4];

            const selectedClient = this.state.selectedClientId ? CORE.getClient(this.state.selectedClientId) : null;
            const isReservationMode = (this.state.posMode === 'reservation');

            return `
                <div class="flex flex-col gap-4 h-full fade-in pb-24 lg:pb-0">
                    <!-- POS Header -->
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-black text-slate-900">Point de Vente</h2>
                            <p class="text-sm text-slate-500 font-medium">${posName} - ${products.length} produit(s)</p>
                        </div>
                    </div>
                    
                    ${!CORE.state.isOnline ? `
                        <button onclick="OfflineManager.showQueueModal()" class="w-full p-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-2xl border border-orange-600 shadow-lg flex items-start gap-3 hover:shadow-xl transition cursor-pointer text-left">
                            <i data-lucide="wifi-off" class="w-5 h-5 mt-0.5 flex-shrink-0"></i>
                            <div class="flex-1">
                                <div class="font-black text-sm">�� � ��� � � Mode Hors Ligne Activ�</div>
                                <div class="text-xs opacity-90 mt-0.5">Toutes vos actions seront sauvegard�es et synchronis�es au retour de la connexion. Cliquez pour voir la file d'attente.</div>
                            </div>
                            <div class="px-3 py-1 bg-white/20 rounded-full text-xs font-bold">
                                ${(CORE.db.pendingSyncs || []).filter(s => s.status !== 'success').length} en attente
                            </div>
                        </button>
                    ` : ''}
                    
                    <div class="flex flex-col lg:flex-row lg:items-center gap-3">
                        <div class="flex-1">
                            <div class="relative">
                                <i data-lucide="search" class="w-5 h-5 text-slate-400 absolute left-4 top-1/2 -translate-y-1/2"></i>
                                <input id="pos-search-input" type="text" value="${this.state.searchQuery}" onkeyup="VendeurModule.updatePOSSearch(this.value)" placeholder="Rechercher un produit..." class="w-full pl-12 pr-4 py-3 rounded-2xl border border-slate-200 bg-white focus:ring-2 focus:ring-emerald-500 outline-none font-medium" style="direction: ltr; text-align: left;" autocomplete="off">
                            </div>
                        </div>
                        
                        <!-- Sync Indicator / Offline Manager -->
                        <div id="sync-indicator">
                            ${(() => {
                                const pendingCount = (CORE.db.pendingSyncs || []).filter(s => s.status !== 'success').length;
                                const failedCount = (CORE.db.pendingSyncs || []).filter(s => s.status === 'failed').length;
                                const lastSync = CORE.state.lastSync ? new Date(CORE.state.lastSync).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}) : '�� ?��';
                                
                                if (!CORE.state.isOnline) {
                                    return `
                                        <button onclick="OfflineManager.showQueueModal()" class="flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-amber-100 to-orange-100 text-amber-800 rounded-2xl border-2 border-amber-300 shadow-sm hover:shadow-md transition cursor-pointer" title="Voir la file d'attente">
                                            <i data-lucide="wifi-off" class="w-5 h-5"></i>
                                            <div>
                                                <div class="text-xs font-black uppercase tracking-wider">�� � ��� � � Hors Ligne</div>
                                                <div class="text-[10px] opacity-75">${pendingCount} action(s) en attente</div>
                                            </div>
                                        </button>
                                    `;
                                } else if (failedCount > 0) {
                                    return `
                                        <button onclick="OfflineManager.showQueueModal()" class="flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-red-100 to-red-200 text-red-800 rounded-2xl border-2 border-red-300 shadow-sm hover:shadow-md transition cursor-pointer">
                                            <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                                            <div>
                                                <div class="text-xs font-black uppercase tracking-wider">��š ��� � � �checs de sync</div>
                                                <div class="text-[10px] opacity-75">${failedCount} action(s) �chou�e(s)</div>
                                            </div>
                                        </button>
                                    `;
                                } else if (pendingCount > 0) {
                                    return `
                                        <button onclick="OfflineManager.syncAll()" class="flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl border border-blue-600 shadow-lg hover:shadow-xl transition animate-pulse">
                                            <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                                            <div>
                                                <div class="text-xs font-black uppercase tracking-wider">��Ÿ�? Synchroniser</div>
                                                <div class="text-[10px] opacity-90">${pendingCount} action(s) en attente</div>
                                            </div>
                                        </button>
                                    `;
                                } else {
                                    return `
                                        <div class="flex items-center gap-3 px-4 py-3 bg-emerald-50 text-emerald-700 rounded-2xl border border-emerald-200" title="Synchronis�">
                                            <i data-lucide="cloud-check" class="w-5 h-5"></i>
                                            <div>
                                                <div class="text-xs font-black uppercase tracking-wider">���?? En Ligne</div>
                                                <div class="text-[10px] opacity-75">Sync: ${lastSync}</div>
                                            </div>
                                        </div>
                                    `;
                                }
                            })()}
                        </div>
                        
                        <!-- Offline Indicator pour les mises �� jour dynamiques -->
                        <div id="offline-indicator"></div>

                        <div class="flex gap-2 flex-wrap">
                            <button onclick="VendeurModule.showDeliveryDetailsModal()" class="px-4 py-3 rounded-2xl bg-white border border-slate-200 font-bold hover:bg-slate-50 transition flex items-center gap-2">
                                <i data-lucide="map-pin" class="w-5 h-5"></i>
                                ${(() => {
                                    const dd = VendeurModule.state.deliveryDetails || { name:'', phone:'', address:'', date:'', time:'' };
                                    const ok = (dd.name || '').trim() && (dd.phone || '').trim() && (dd.address || '').trim();
                                    const when = (dd.date ? dd.date : '') + (dd.time ? (dd.date ? ' ' : '') + dd.time : '');
                                    return ok ? (when ? `${dd.name} �� ?� � ${when}` : dd.name) : 'Livraison';
                                })()}
                            </button>

                            ${isReservationMode ? `
                                <button onclick="VendeurModule.openReservationCart()" class="px-4 py-3 rounded-2xl bg-emerald-600 text-white font-black hover:bg-emerald-700 transition flex items-center gap-2">
                                    <i data-lucide="calendar-clock" class="w-5 h-5"></i>
                                    Panier r�servation
                                </button>
                            ` : `
                                <button onclick="VendeurModule.state.posMode='reservation';VendeurModule.openReservationCart()" class="px-4 py-3 rounded-2xl bg-white border border-slate-200 font-black hover:bg-slate-50 transition flex items-center gap-2">
                                    <i data-lucide="calendar-clock" class="w-5 h-5"></i>
                                    R�servation
                                </button>
                            `}

                            <button onclick="${isReservationMode ? 'VendeurModule.clearReservationCart()' : 'VendeurModule.clearCart()'}" class="px-4 py-3 rounded-2xl bg-red-50 text-red-600 font-black hover:bg-red-100 transition">Vider</button>
                            
                            ${!isReservationMode && this.state.parkedCarts && this.state.parkedCarts.length > 0 ? `
                                <button onclick="VendeurModule.showParkedCartsModal()" class="px-4 py-3 rounded-2xl bg-amber-100 text-amber-800 font-black hover:bg-amber-200 transition flex items-center gap-2 relative">
                                    <i data-lucide="layers" class="w-5 h-5"></i>
                                    <span class="hidden xl:inline">En attente</span>
                                    <span class="w-6 h-6 rounded-full bg-white text-amber-700 flex items-center justify-center text-xs font-black">${this.state.parkedCarts.length}</span>
                                </button>
                            ` : ''}
                        </div>
                    </div>

                    <div class="flex gap-6 flex-1 min-h-0">
                        <div class="flex-1 flex flex-col min-w-0">
                            <div class="overflow-x-auto pb-3 hide-scrollbar flex gap-3">
                                <button onclick="VendeurModule.state.categoryFilter=null;App.rerender()" class="px-5 py-2.5 rounded-2xl font-black transition-all ${!this.state.categoryFilter ? 'bg-slate-900 text-white shadow-lg' : 'bg-white text-slate-700 border border-slate-200 hover:bg-slate-50'}">Tout</button>
                                ${categories.map(c => `
                                    <button onclick="VendeurModule.state.categoryFilter=${c.id};App.rerender()" class="px-5 py-2.5 rounded-2xl font-black transition-all whitespace-nowrap flex items-center gap-2 ${this.state.categoryFilter === c.id ? 'bg-slate-900 text-white shadow-lg' : 'bg-white text-slate-700 border border-slate-200 hover:bg-slate-50'}">
                                        <i data-lucide="${c.icon}" class="w-4 h-4"></i> ${c.name}
                                    </button>
                                `).join('')}
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 overflow-y-auto pr-2 pb-4">
                                ${products.map(p => {
                                    const variants = CORE.getProductVariants(p.id);
                                    // Get stock for this POS (supports posStocks)
                                    const posStock = CORE.getProductStock(p.id, userPos);
                                    return `
                                    <div onclick="${isReservationMode ? `VendeurModule.addToReservationCart(${p.id})` : `VendeurModule.addToCart(${p.id})`}" class="bg-white p-4 rounded-3xl border border-slate-100 cursor-pointer card-hover group relative overflow-hidden">
                                        <div class="absolute top-4 right-4 z-10 flex flex-col gap-1">
                                            <span class="bg-white text-slate-800 text-[10px] font-black px-2 py-1 rounded-full shadow-sm border border-slate-200">${posStock} stock</span>
                                            ${variants.length > 0 ? `<span class="bg-purple-600 text-white text-[10px] font-black px-2 py-1 rounded-full shadow-sm">${variants.length} var.</span>` : ''}
                                        </div>
                                        <div class="w-full aspect-[4/3] ${getCatColor(p.categoryId)} rounded-2xl mb-3 flex items-center justify-center group-hover:scale-105 transition-transform">
                                            <i data-lucide="package" class="w-10 h-10 opacity-50"></i>
                                        </div>
                                        <div class="font-black text-slate-800 truncate">${p.name}</div>
                                        
                                        <div class="flex justify-between items-center mt-1">
                                            <div class="text-emerald-600 font-black">${CORE.formatPrice(CORE.getProductPrice(p.id, userPos))}</div>
                                            <div class="flex items-center gap-2">
                                                <button onclick="event.stopPropagation(); ManagerModule.showProductInfoModal(${p.id})" class="px-3 py-1 rounded-xl bg-blue-600 text-white text-xs font-black hover:bg-blue-700">Info</button>
                                                ${variants.length > 0 ? `<button onclick="event.stopPropagation(); VendeurModule.showVariantsList(${p.id})" class="px-3 py-1 rounded-xl bg-purple-600 text-white text-xs font-black hover:bg-purple-700">Var.</button>` : ''}
                                                <button onclick="event.stopPropagation(); (${isReservationMode} ? VendeurModule.addToReservationCart(${p.id}) : VendeurModule.addToCart(${p.id}))" class="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 group-hover:bg-emerald-500 group-hover:text-white transition">
                                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                        ${posStock <= p.minStock ? `<div class="mt-2 text-xs font-black text-red-600">Stock bas (min ${p.minStock})</div>` : ''}
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        </div>

                        ${(() => {
                            // =====================================================
                            // Panier NORMAL vs Panier R�SERVATION
                            // =====================================================
                            if (isReservationMode) {
                                const cartCount = this.state.reservationCart.reduce((a,b)=>a+b.qty,0);
                                const subtotal = this.getReservationCartTotal();
                                const deliveryFee = this.getReservationDeliveryFee();
                                const total = this.getReservationGrandTotal();

                                const itemsHtml = this.state.reservationCart.length === 0
                                    ? `
                                        <div class="h-40 flex flex-col items-center justify-center text-slate-300">
                                            <i data-lucide="calendar-clock" class="w-8 h-8 mb-2"></i>
                                            <p class="text-xs font-bold uppercase tracking-wider">Panier r�servation vide</p>
                                        </div>
                                    `
                                    : this.state.reservationCart.map((item, index) => `
                                        <div class="p-3 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 transition">
                                            <div class="flex items-start gap-3">
                                                <div class="flex-1 min-w-0">
                                                    <div class="text-sm font-black text-slate-900 truncate">${item.name}</div>
                                                    <div class="mt-0.5 text-xs text-slate-500">
                                                        PU <span class="font-bold text-slate-700">${CORE.formatPrice(item.price)}</span>
                                                        <span class="mx-1">�� ?� �</span>
                                                        Ligne <span class="font-black text-slate-900">${CORE.formatPrice(item.price * item.qty)}</span>
                                                    </div>
                                                </div>
                                                <button onclick="VendeurModule.removeReservationCartItem(${index})" class="no-select w-8 h-8 rounded-xl bg-white border border-slate-200 text-slate-500 hover:text-red-600 hover:border-red-200 hover:bg-red-50 flex items-center justify-center transition" title="Supprimer">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </div>

                                            <div class="mt-2 flex items-center justify-between">
                                                <div class="inline-flex items-center gap-1 bg-slate-100 rounded-xl p-1">
                                                    <button aria-label="Diminuer" onclick="VendeurModule.updateReservationCartQty(${index}, -1)" class="no-select w-7 h-7 rounded-lg bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 flex items-center justify-center transition"><i data-lucide="minus" class="w-4 h-4"></i></button>
                                                    <span class="no-select w-8 text-center font-black text-slate-900">${item.qty}</span>
                                                    <button aria-label="Augmenter" onclick="VendeurModule.updateReservationCartQty(${index}, 1)" class="no-select w-7 h-7 rounded-lg bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 flex items-center justify-center transition"><i data-lucide="plus" class="w-4 h-4"></i></button>
                                                </div>
                                                <div class="text-[11px] font-black text-slate-500">Stock: ${item.maxStock}</div>
                                            </div>
                                        </div>
                                    `).join('');

                                const footerHtml = `
                                    <div class="space-y-3">
                                        <div class="space-y-1">
                                            <div class="flex justify-between text-xs font-bold text-slate-600">
                                                <span>Sous-total</span>
                                                <span class="font-black text-slate-900">${CORE.formatPrice(subtotal)}</span>
                                            </div>
                                            <div class="flex justify-between items-center text-xs font-bold text-slate-600">
                                                <span>Livraison</span>
                                                <input type="number" value="${Math.max(0, parseInt(this.state.reservationManualDeliveryFee) || 0)}" oninput="VendeurModule.setReservationManualDeliveryFee(this.value)" class="w-20 text-right bg-slate-100 border border-slate-300 rounded px-1 py-0.5 text-xs font-black focus:ring-1 focus:ring-emerald-500 outline-none" placeholder="0">
                                            </div>
                                        </div>

                                        <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200 flex items-end justify-between">
                                            <div>
                                                <div class="text-[10px] font-black text-slate-500 uppercase tracking-wider">Total r�servation</div>
                                                <div class="text-xs text-slate-500">(incl. livraison)</div>
                                            </div>
                                            <div id="res-cart-total-display" class="text-2xl font-black text-emerald-600 tracking-tight">${CORE.formatPrice(total)}</div>
                                        </div>

                                        <button onclick="VendeurModule.showReservationModal()" class="w-full py-3 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700 transition flex items-center justify-center gap-2">
                                            <i data-lucide="calendar-check" class="w-4 h-4"></i>
                                            Cr�er une r�servation
                                        </button>

                                        <div class="grid grid-cols-2 gap-2">
                                            <button onclick="VendeurModule.clearReservationCart()" class="py-3 rounded-xl bg-red-50 text-red-700 text-xs font-black hover:bg-red-100 transition">Vider</button>
                                            <button onclick="VendeurModule.state.posMode='sale';VendeurModule.closeReservationCart();App.rerender()" class="py-3 rounded-xl bg-slate-100 text-slate-700 text-xs font-black hover:bg-slate-200 transition">Retour vente</button>
                                        </div>
                                    </div>
                                `;

                                const floatingCart = `
                                    <div class="fixed right-4 bottom-6 z-30 pb-safe">
                                        <button onclick="VendeurModule.openReservationCart()" class="no-select group relative">
                                            ${cartCount > 0 ? `
                                                <span class="absolute -top-2 -right-2 z-10 min-w-[24px] h-6 px-1.5 bg-purple-500 text-white text-xs font-black rounded-full flex items-center justify-center shadow-lg shadow-purple-500/40 animate-bounce">${cartCount > 99 ? '99+' : cartCount}</span>
                                            ` : ''}
                                            <div class="relative w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-500 via-purple-600 to-purple-700 text-white shadow-2xl shadow-purple-500/50 flex items-center justify-center transition-all duration-300 group-hover:scale-110 group-hover:shadow-purple-500/70 group-active:scale-95 group-hover:rotate-[-5deg]">
                                                <i data-lucide="calendar-clock" class="w-7 h-7"></i>
                                                <div class="absolute inset-0 rounded-2xl bg-gradient-to-tr from-white/20 to-transparent pointer-events-none"></div>
                                            </div>
                                            ${cartCount > 0 ? `
                                                <div class="absolute right-full mr-3 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-x-2 group-hover:translate-x-0 pointer-events-none">
                                                    <div class="bg-slate-900 text-white px-4 py-2 rounded-xl shadow-xl whitespace-nowrap">
                                                        <div class="text-[10px] font-bold text-purple-300 uppercase">R�servation</div>
                                                        <div class="text-lg font-black">${CORE.formatPrice(total)}</div>
                                                    </div>
                                                    <div class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-1 w-2 h-2 bg-slate-900 rotate-45"></div>
                                                </div>
                                            ` : ''}
                                        </button>
                                    </div>
                                `;

                                const drawer = this.state.reservationCartDrawerOpen ? `
                                    <div class="fixed inset-0 z-40">
                                        <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm" onclick="VendeurModule.closeReservationCart()"></div>
                                        <div class="absolute inset-y-0 right-0 w-full max-w-md bg-white shadow-2xl overflow-hidden flex flex-col slide-in-right">
                                            <div class="p-5 bg-gradient-to-r from-purple-700 to-purple-600 text-white">
                                                <div class="flex items-start justify-between gap-3">
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center">
                                                            <i data-lucide="calendar-clock" class="w-5 h-5"></i>
                                                        </div>
                                                        <div>
                                                            <div class="font-black text-xl tracking-tight">Panier R�servation</div>
                                                            <div class="text-[11px] text-purple-200 font-bold uppercase tracking-wider">${CORE.getPOS(CORE.user?.pos)?.name || 'POS'} �� ?� � ${cartCount} article(s)</div>
                                                        </div>
                                                    </div>
                                                    <button onclick="VendeurModule.closeReservationCart()" class="w-10 h-10 rounded-xl bg-white/10 hover:bg-white/20 flex items-center justify-center transition">
                                                        <i data-lucide="x" class="w-5 h-5"></i>
                                                    </button>
                                                </div>

                                                <div class="mt-4 grid grid-cols-2 gap-2">
                                                    <button onclick="VendeurModule.showDeliveryDetailsModal()" class="w-full py-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-white font-black text-xs transition flex items-center justify-center gap-2">
                                                        <i data-lucide="map-pin" class="w-4 h-4"></i>
                                                        Livraison
                                                    </button>
                                                    <button onclick="VendeurModule.state.posMode='sale';VendeurModule.closeReservationCart();App.rerender()" class="w-full py-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-white font-black text-xs transition flex items-center justify-center gap-2">
                                                        <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                                                        Vente
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="flex-1 overflow-auto p-4 space-y-3 bg-slate-50">
                                                ${itemsHtml}
                                            </div>

                                            <div class="sticky bottom-0 p-4 border-t border-slate-200 bg-white">
                                                ${footerHtml}
                                            </div>
                                        </div>
                                    </div>
                                ` : '';

                                return `${floatingCart}${drawer}`;
                            }

                            // ====== Panier NORMAL (vente)
                            const cartCount = this.state.cart.reduce((a,b)=>a+b.qty,0);
                            const subtotal = this.getCartTotal();
                            const total = this.getGrandTotal();

                            const itemsHtml = this.state.cart.length === 0
                                ? `
                                    <div class="h-48 flex flex-col items-center justify-center text-slate-400">
                                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center mb-4">
                                            <i data-lucide="shopping-bag" class="w-8 h-8 text-slate-400"></i>
                                        </div>
                                        <p class="text-sm font-black text-slate-500">Panier vide</p>
                                        <p class="text-xs text-slate-400 mt-1">Ajoutez des produits pour commencer</p>
                                    </div>
                                `
                                : this.state.cart.map((item, index) => `
                                    <div class="p-4 rounded-2xl border border-slate-200 bg-gradient-to-br from-white to-slate-50 hover:shadow-md hover:border-slate-300 transition-all duration-200">
                                        <div class="flex items-start gap-3">
                                            <div class="flex-1 min-w-0">
                                                <div class="text-sm font-black text-slate-900 truncate">${item.name}</div>
                                                ${item.attributes && item.attributes.length > 0 ? `
                                                    <div class="mt-1.5 flex flex-wrap gap-1">
                                                        ${item.attributes.map(attr => `
                                                            <span class="text-[10px] px-2 py-1 bg-gradient-to-r from-purple-100 to-indigo-100 text-purple-700 rounded-lg font-bold">${attr.name}: ${attr.value}</span>
                                                        `).join('')}
                                                    </div>
                                                ` : ''}
                                                ${item.sku ? `<div class="text-[10px] text-slate-400 font-mono mt-1">SKU: ${item.sku}</div>` : ''}
                                                <div class="mt-1.5 text-xs text-slate-500">
                                                    <span class="text-slate-400">Unit�:</span> <span class="font-bold text-slate-700">${CORE.formatPrice(item.price)}</span>
                                                    <span class="mx-2 text-slate-300">|</span>
                                                    <span class="text-slate-400">Total:</span> <span class="font-black text-emerald-600">${CORE.formatPrice(item.price * item.qty)}</span>
                                                </div>
                                            </div>
                                            <button onclick="VendeurModule.removeCartItem(${index})" class="no-select w-9 h-9 rounded-xl bg-red-50 border border-red-100 text-red-400 hover:text-red-600 hover:border-red-300 hover:bg-red-100 flex items-center justify-center transition-all duration-200" title="Supprimer">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>

                                        <div class="mt-3 flex items-center justify-between">
                                            <div class="inline-flex items-center gap-1 bg-slate-100 rounded-xl p-1 shadow-inner">
                                                <button aria-label="Diminuer" onclick="VendeurModule.updateCartQty(${index}, -1)" class="no-select w-8 h-8 rounded-lg bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 hover:border-slate-300 flex items-center justify-center transition shadow-sm"><i data-lucide="minus" class="w-4 h-4"></i></button>
                                                <span class="no-select w-10 text-center font-black text-slate-900 text-lg">${item.qty}</span>
                                                <button aria-label="Augmenter" onclick="VendeurModule.updateCartQty(${index}, 1)" class="no-select w-8 h-8 rounded-lg bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 hover:border-slate-300 flex items-center justify-center transition shadow-sm"><i data-lucide="plus" class="w-4 h-4"></i></button>
                                            </div>
                                            <div class="text-[11px] font-bold text-slate-400 flex items-center gap-1">
                                                <i data-lucide="package" class="w-3 h-3"></i>
                                                Stock: <span class="text-slate-600">${item.maxStock}</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('');

                            const footerHtml = `
                                <div class="space-y-4">
                                    <div class="space-y-2 p-3 rounded-xl bg-slate-50 border border-slate-100">
                                        <div class="flex justify-between text-sm font-bold text-slate-600">
                                            <span class="flex items-center gap-2"><i data-lucide="shopping-bag" class="w-4 h-4 text-slate-400"></i>Sous-total</span>
                                            <span class="font-black text-slate-900">${CORE.formatPrice(subtotal)}</span>
                                        </div>
                                        <div class="flex justify-between items-center text-sm font-bold text-slate-600">
                                            <span class="flex items-center gap-2"><i data-lucide="truck" class="w-4 h-4 text-slate-400"></i>Livraison</span>
                                            <input type="number" value="${Math.max(0, parseInt(this.state.manualDeliveryFee) || 0)}" oninput="VendeurModule.setManualDeliveryFee(this.value)" class="w-24 text-right bg-white border border-slate-200 rounded-lg px-2 py-1.5 text-sm font-black focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition" placeholder="0">
                                        </div>
                                    </div>

                                    <div class="p-4 rounded-2xl bg-gradient-to-br from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-500/30">
                                        <div class="flex items-end justify-between">
                                            <div>
                                                <div class="text-[10px] font-black text-emerald-100 uppercase tracking-wider">Total �� payer</div>
                                                <div class="text-xs text-emerald-200 mt-0.5">Livraison incluse</div>
                                            </div>
                                            <div id="cart-total-display" class="text-3xl font-black tracking-tight">${CORE.formatPrice(total)}</div>
                                        </div>
                                    </div>

                                    ${CORE.hasPermission('orders.create') ? `
                                        <div class="grid grid-cols-3 gap-2">
                                            <button onclick="VendeurModule.createOrder('cash')" class="py-3.5 rounded-xl bg-gradient-to-br from-slate-800 to-slate-900 text-white text-xs font-black hover:from-slate-700 hover:to-slate-800 transition-all shadow-md hover:shadow-lg flex flex-col items-center gap-1">
                                                <i data-lucide="banknote" class="w-4 h-4"></i>
                                                <span>Cash</span>
                                            </button>
                                            <button onclick="VendeurModule.createOrder('mobile')" class="py-3.5 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 text-white text-xs font-black hover:from-blue-400 hover:to-blue-500 transition-all shadow-md hover:shadow-lg flex flex-col items-center gap-1">
                                                <i data-lucide="smartphone" class="w-4 h-4"></i>
                                                <span>Mobile</span>
                                            </button>
                                            <button onclick="VendeurModule.createOrder('card')" class="py-3.5 rounded-xl bg-gradient-to-br from-indigo-500 to-indigo-600 text-white text-xs font-black hover:from-indigo-400 hover:to-indigo-500 transition-all shadow-md hover:shadow-lg flex flex-col items-center gap-1">
                                                <i data-lucide="credit-card" class="w-4 h-4"></i>
                                                <span>Carte</span>
                                            </button>
                                        </div>
                                        
                                        <button onclick="VendeurModule.createOrder('cod')" class="w-full py-3.5 rounded-xl bg-gradient-to-r from-amber-400 to-orange-500 text-white text-sm font-black hover:from-amber-500 hover:to-orange-600 transition-all shadow-lg shadow-amber-500/30 hover:shadow-amber-500/50 flex items-center justify-center gap-2">
                                            <i data-lucide="package" class="w-5 h-5"></i>
                                            Paiement �� la livraison (COD)
                                        </button>
                                    ` : `
                                        <div class="text-xs text-slate-400 text-center py-2">Acc��s restreint</div>
                                    `}

                                    <div class="flex gap-2">
                                        <button onclick="VendeurModule.parkCurrentCart()" class="flex-1 py-2.5 rounded-xl bg-slate-100 text-slate-600 text-xs font-black hover:bg-slate-200 transition flex items-center justify-center gap-2">
                                            <i data-lucide="pause-circle" class="w-4 h-4"></i> Mettre en attente
                                        </button>
                                        <button onclick="VendeurModule.clearCart()" class="px-4 py-2.5 rounded-xl bg-red-50 text-red-500 text-xs font-black hover:bg-red-100 hover:text-red-600 transition flex items-center justify-center gap-1">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `;

                            const floatingCart = `
                                <div class="fixed right-4 bottom-6 z-30 pb-safe">
                                    <button onclick="VendeurModule.openCartDrawer()" class="no-select group relative">
                                        <!-- Badge compteur -->
                                        ${cartCount > 0 ? `
                                            <span class="absolute -top-2 -right-2 z-10 min-w-[24px] h-6 px-1.5 bg-red-500 text-white text-xs font-black rounded-full flex items-center justify-center shadow-lg shadow-red-500/40 animate-bounce">${cartCount > 99 ? '99+' : cartCount}</span>
                                        ` : ''}
                                        
                                        <!-- Bouton principal -->
                                        <div class="relative w-16 h-16 rounded-2xl bg-gradient-to-br from-emerald-500 via-emerald-600 to-emerald-700 text-white shadow-2xl shadow-emerald-500/50 flex items-center justify-center transition-all duration-300 group-hover:scale-110 group-hover:shadow-emerald-500/70 group-active:scale-95 group-hover:rotate-[-5deg]">
                                            <i data-lucide="shopping-bag" class="w-7 h-7"></i>
                                            
                                            <!-- Effet brillance -->
                                            <div class="absolute inset-0 rounded-2xl bg-gradient-to-tr from-white/20 to-transparent pointer-events-none"></div>
                                        </div>
                                        
                                        <!-- Info bulle avec total -->
                                        ${cartCount > 0 ? `
                                            <div class="absolute right-full mr-3 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-x-2 group-hover:translate-x-0 pointer-events-none">
                                                <div class="bg-slate-900 text-white px-4 py-2 rounded-xl shadow-xl whitespace-nowrap">
                                                    <div class="text-[10px] font-bold text-slate-400 uppercase">Total</div>
                                                    <div class="text-lg font-black">${CORE.formatPrice(total)}</div>
                                                </div>
                                                <div class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-1 w-2 h-2 bg-slate-900 rotate-45"></div>
                                            </div>
                                        ` : ''}
                                    </button>
                                </div>
                            `;

                            const drawer = this.state.cartDrawerOpen ? `
                                <div class="fixed inset-0 z-40">
                                    <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm" onclick="VendeurModule.closeCartDrawer()"></div>
                                    
                                    <!-- Drawer depuis la droite sur desktop, depuis le bas sur mobile -->
                                    <div class="absolute inset-y-0 right-0 w-full max-w-md bg-white shadow-2xl overflow-hidden flex flex-col slide-in-right">
                                        <!-- Header -->
                                        <div class="p-5 bg-gradient-to-r from-slate-900 to-slate-800 text-white">
                                            <div class="flex items-start justify-between gap-3">
                                                <div>
                                                    <div class="flex items-center gap-2">
                                                        <div class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center">
                                                            <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                                                        </div>
                                                        <div>
                                                            <div class="font-black text-xl tracking-tight">Panier</div>
                                                            <div class="text-[11px] text-slate-300 font-bold uppercase tracking-wider">${CORE.getPOS(CORE.user?.pos)?.name || 'POS'} �� ?� � ${cartCount} article(s)</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button onclick="VendeurModule.closeCartDrawer()" class="w-10 h-10 rounded-xl bg-white/10 hover:bg-white/20 flex items-center justify-center transition">
                                                    <i data-lucide="x" class="w-5 h-5"></i>
                                                </button>
                                            </div>

                                            <div class="grid grid-cols-2 gap-2 mt-4">
                                                <button onclick="VendeurModule.showClientPickerModal()" class="w-full py-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-white font-black text-xs transition flex items-center justify-center gap-2">
                                                    <i data-lucide="user" class="w-4 h-4"></i>
                                                    ${selectedClient ? selectedClient.name : 'Client'}
                                                </button>
                                                <button onclick="VendeurModule.showDeliveryDetailsModal()" class="w-full py-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-white font-black text-xs transition flex items-center justify-center gap-2">
                                                    <i data-lucide="map-pin" class="w-4 h-4"></i>
                                                    Livraison
                                                </button>
                                            </div>
                                            ${selectedClient ? `
                                                <div class="mt-3 p-3 rounded-xl bg-emerald-500/20 border border-emerald-400/30">
                                                    <div class="text-xs font-black text-emerald-100">��Ÿ? � ${selectedClient.name}</div>
                                                    <div class="text-[10px] text-emerald-200/80 mt-0.5">${selectedClient.phone || '�� ?��'}</div>
                                                </div>
                                            ` : ''}
                                        </div>

                                        <!-- Items -->
                                        <div class="flex-1 overflow-auto p-4 space-y-3 bg-slate-50">
                                            ${itemsHtml}
                                        </div>

                                        <!-- Footer -->
                                        <div class="p-4 border-t border-slate-200 bg-white">
                                            ${footerHtml}
                                        </div>
                                    </div>
                                </div>
                            ` : '';

                            return `${floatingCart}${drawer}`;
                        })()}
                    </div>
                </div>`;
        },

        renderOrders() {
            const user = CORE.state.currentUser;
            const userPos = CORE.user?.pos;
            
            // Pour PDG/Manager: voir tous les POS
            if (user?.role === 'pdg' || user?.role === 'manager') {
                const q = (document.getElementById('orders-search-input')?.value || '').toLowerCase().trim();
                const filter = this.state.ordersFilter;
                let orders = CORE.db.orders.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                if (filter !== 'all') orders = orders.filter(o => o.status === filter);
                if (q) orders = orders.filter(o => (o.reference || '').toLowerCase().includes(q));
                
                const statuses = [
                    { value: 'all', label: 'Toutes' },
                    { value: 'pending', label: 'En attente' },
                    { value: 'delivered', label: 'Livr�es' },
                    { value: 'cancelled', label: 'Annul�es' }
                ];

                return `
                    <div class="fade-in max-w-5xl mx-auto space-y-6">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 class="text-2xl font-black text-slate-900">Commandes (Tous les POS)</h2>
                                <p class="text-slate-500 font-medium">${orders.length} commande(s)</p>
                            </div>
                            <div class="flex gap-3">
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input id="orders-search-input" type="text" value="${this.state.ordersSearch}" onkeyup="VendeurModule.updateOrdersSearch(this.value)" placeholder="CMD-0001..." class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="direction: ltr; text-align: left;" autocomplete="off">
                                </div>
                                <select onchange="VendeurModule.state.ordersFilter=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${statuses.map(s => `<option value="${s.value}" ${s.value===filter?'selected':''}>${s.label}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                            <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                                <div class="text-sm font-black text-slate-700">${orders.length} r�sultat(s)</div>
                                <button onclick="CORE.reset()" class="text-xs font-black text-slate-500 hover:text-red-600">R�initialiser demo</button>
                            </div>
                            <div class="p-4 space-y-2">
                                ${orders.length === 0 ? `<div class="p-10 text-center text-slate-400 font-medium">Aucune commande</div>` : ''}
                                ${orders.map(o => this.renderOrderRow(o)).join('')}
                            </div>
                        </div>
                    </div>`;
            }
            
            // Pour autres r��les: voir seulement le POS assign�
            if (!userPos) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assign�</div></div>`;
            }
            
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'POS ' + userPos;
            const q = (document.getElementById('orders-search-input')?.value || '').toLowerCase().trim();
            const filter = this.state.ordersFilter;
            let orders = CORE.db.orders.filter(o => o.posId == userPos).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            if (filter !== 'all') orders = orders.filter(o => o.status === filter);
            if (q) orders = orders.filter(o => (o.reference || '').toLowerCase().includes(q));

            const statuses = [
                { value: 'all', label: 'Toutes' },
                { value: 'pending', label: 'En attente' },
                { value: 'delivered', label: 'Livr�es' },
                { value: 'cancelled', label: 'Annul�es' }
            ];

            return `
                <div class="fade-in max-w-5xl mx-auto space-y-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">Commandes</h2>
                            <p class="text-slate-500 font-medium">${posName} - ${orders.length} commande(s)</p>
                        </div>
                        <div class="flex gap-3">
                            <div class="relative">
                                <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                <input id="orders-search-input" type="text" value="${this.state.ordersSearch}" onkeyup="VendeurModule.updateOrdersSearch(this.value)" placeholder="CMD-0001..." class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="direction: ltr; text-align: left;" autocomplete="off">
                            </div>
                            <select onchange="VendeurModule.state.ordersFilter=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                ${statuses.map(s => `<option value="${s.value}" ${s.value===filter?'selected':''}>${s.label}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <div class="text-sm font-black text-slate-700">${orders.length} r�sultat(s)</div>
                            <button onclick="CORE.reset()" class="text-xs font-black text-slate-500 hover:text-red-600">R�initialiser demo</button>
                        </div>
                        <div class="p-4 space-y-2">
                            ${orders.length === 0 ? `<div class="p-10 text-center text-slate-400 font-medium">Aucune commande</div>` : ''}
                            ${orders.map(o => this.renderOrderRow(o)).join('')}
                        </div>
                    </div>
                </div>`;
        },

        renderStock() {
            const posId = CORE.user?.pos;
            if (!posId) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assign�</div></div>`;
            }
            
            const posData = CORE.getPOS(posId);
            const posName = posData?.name || 'POS ' + posId;
            const pendingReceipts = CORE.getTransferReceipts({ posId, status: 'pending' });
            const pendingCount = pendingReceipts.length;
            
            // State filters
            const searchQuery = (this.state.stockSearch || '').toLowerCase().trim();
            const categoryFilter = this.state.stockCategoryFilter || 'all';
            const statusFilter = this.state.stockStatusFilter || 'all';
            const sortBy = this.state.stockSortBy || 'name';
            const page = this.state.stockPage || 1;
            const perPage = this.state.stockPerPage || 30;
            
            // Get all products for this POS
            // Afficher uniquement les produits cr��s pour ce POS (hors d�p��t principal)
            const allProducts = CORE.getPOSProducts(posId);
            
            // Apply filters
            let filteredProducts = allProducts.filter(p => {
                // Search filter
                if (searchQuery && !(p.name || '').toLowerCase().includes(searchQuery) && 
                    !(p.barcode || '').toLowerCase().includes(searchQuery) &&
                    !(p.reference || '').toLowerCase().includes(searchQuery)) return false;
                
                // Category filter
                if (categoryFilter !== 'all' && p.categoryId != categoryFilter) return false;
                
                // Status filter
                const stock = CORE.getProductStock(p.id, posId);
                const minStock = p.minStock || 0;
                if (statusFilter === 'critical' && stock > minStock * 0.5) return false;
                if (statusFilter === 'low' && (stock > minStock || stock <= minStock * 0.5)) return false;
                if (statusFilter === 'ok' && stock <= minStock) return false;
                if (statusFilter === 'outofstock' && stock > 0) return false;
                
                return true;
            });
            
            // Sorting
            filteredProducts.sort((a, b) => {
                const stockA = CORE.getProductStock(a.id, posId);
                const stockB = CORE.getProductStock(b.id, posId);
                switch (sortBy) {
                    case 'stock_asc': return stockA - stockB;
                    case 'stock_desc': return stockB - stockA;
                    case 'price_asc': return (a.price || 0) - (b.price || 0);
                    case 'price_desc': return (b.price || 0) - (a.price || 0);
                    case 'critical': return (stockA - (a.minStock || 0)) - (stockB - (b.minStock || 0));
                    default: return (a.name || '').localeCompare(b.name || '');
                }
            });
            
            // Calculate stats
            const totalProducts = allProducts.length;
            const totalFiltered = filteredProducts.length;
            const totalPages = Math.ceil(totalFiltered / perPage);
            const currentPage = Math.min(page, totalPages || 1);
            
            // Stats
            const okCount = allProducts.filter(p => CORE.getProductStock(p.id, posId) > (p.minStock || 0)).length;
            const lowCount = allProducts.filter(p => {
                const s = CORE.getProductStock(p.id, posId);
                return s <= (p.minStock || 0) && s > (p.minStock || 0) * 0.5;
            }).length;
            const criticalCount = allProducts.filter(p => {
                const s = CORE.getProductStock(p.id, posId);
                return s <= (p.minStock || 0) * 0.5 && s > 0;
            }).length;
            const outCount = allProducts.filter(p => CORE.getProductStock(p.id, posId) === 0).length;
            
            // Pagination
            const startIdx = (currentPage - 1) * perPage;
            const paginatedProducts = filteredProducts.slice(startIdx, startIdx + perPage);
            
            // Categories for filter
            const categories = (CORE.db.categories || []).filter(c => !c.posId || c.posId == posId);
            
            // Generate pagination buttons
            const pages = [];
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    pages.push(i);
                } else if (pages[pages.length - 1] !== '...') {
                    pages.push('...');
                }
            }
            
            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="package" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-black text-slate-900">��Ÿ? � Stock</h2>
                                    <p class="text-slate-500 font-medium">${posName} �� ?� � ${totalFiltered}/${totalProducts} produit(s)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${pendingCount > 0 ? `
                        <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <div>
                                <div class="font-black text-amber-900">${pendingCount} transfert(s) en attente de validation</div>
                                <div class="text-xs text-amber-700 space-y-1 mt-2">
                                    ${pendingReceipts.slice(0, 2).map(r => `<div>�� ?� � ${r.quantity} �?? ${r.productName} (${r.reference || r.id})</div>`).join('')}
                                    ${pendingCount > 2 ? `<div class="italic">+ ${pendingCount - 2} autre(s) transfert(s)...</div>` : ''}
                                </div>
                            </div>
                            <button onclick="GestionnaireModule.showTransferReceiptsCenter()" class="px-4 py-2.5 bg-amber-600 text-white text-xs font-black rounded-xl hover:bg-amber-700 transition">Valider maintenant</button>
                        </div>
                    ` : ''}

                    <!-- Stats KPIs -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-2xl border border-emerald-200 cursor-pointer hover:shadow-md transition" onclick="VendeurModule.state.stockStatusFilter='ok';VendeurModule.state.stockPage=1;App.rerender()">
                            <div class="text-xs font-black text-emerald-600 uppercase">Stock OK</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${okCount}</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-2xl border border-amber-200 cursor-pointer hover:shadow-md transition" onclick="VendeurModule.state.stockStatusFilter='low';VendeurModule.state.stockPage=1;App.rerender()">
                            <div class="text-xs font-black text-amber-600 uppercase">Stock Bas</div>
                            <div class="text-2xl font-black text-amber-900 mt-1">${lowCount}</div>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-2xl border border-red-200 cursor-pointer hover:shadow-md transition" onclick="VendeurModule.state.stockStatusFilter='critical';VendeurModule.state.stockPage=1;App.rerender()">
                            <div class="text-xs font-black text-red-600 uppercase">Critique</div>
                            <div class="text-2xl font-black text-red-900 mt-1">${criticalCount}</div>
                        </div>
                        <div class="bg-gradient-to-br from-slate-50 to-slate-100 p-4 rounded-2xl border border-slate-200 cursor-pointer hover:shadow-md transition" onclick="VendeurModule.state.stockStatusFilter='outofstock';VendeurModule.state.stockPage=1;App.rerender()">
                            <div class="text-xs font-black text-slate-600 uppercase">Rupture</div>
                            <div class="text-2xl font-black text-slate-900 mt-1">${outCount}</div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <div class="flex flex-wrap gap-3 items-center">
                            <!-- Search -->
                            <div class="relative flex-1 min-w-[200px]">
                                <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                <input type="text" value="${searchQuery}" 
                                    oninput="VendeurModule.state.stockSearch=this.value;VendeurModule.state.stockPage=1;App.rerender()" 
                                    placeholder="Rechercher produit, code..." 
                                    class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium">
                            </div>
                            <!-- Category -->
                            <select onchange="VendeurModule.state.stockCategoryFilter=this.value;VendeurModule.state.stockPage=1;App.rerender()" 
                                class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold min-w-[150px]">
                                <option value="all" ${categoryFilter === 'all' ? 'selected' : ''}>Toutes cat�gories</option>
                                ${categories.map(c => `<option value="${c.id}" ${categoryFilter == c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                            </select>
                            <!-- Status -->
                            <select onchange="VendeurModule.state.stockStatusFilter=this.value;VendeurModule.state.stockPage=1;App.rerender()" 
                                class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold min-w-[150px]">
                                <option value="all" ${statusFilter === 'all' ? 'selected' : ''}>Tous les stocks</option>
                                <option value="ok" ${statusFilter === 'ok' ? 'selected' : ''}>���?� Stock OK</option>
                                <option value="low" ${statusFilter === 'low' ? 'selected' : ''}>��š ��� � � Stock bas</option>
                                <option value="critical" ${statusFilter === 'critical' ? 'selected' : ''}>��Ÿ� � Critique</option>
                                <option value="outofstock" ${statusFilter === 'outofstock' ? 'selected' : ''}>�� ��? Rupture</option>
                            </select>
                            <!-- Sort -->
                            <select onchange="VendeurModule.state.stockSortBy=this.value;App.rerender()" 
                                class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold min-w-[130px]">
                                <option value="name" ${sortBy === 'name' ? 'selected' : ''}>Nom A-Z</option>
                                <option value="stock_asc" ${sortBy === 'stock_asc' ? 'selected' : ''}>Stock ���?</option>
                                <option value="stock_desc" ${sortBy === 'stock_desc' ? 'selected' : ''}>Stock ���?</option>
                                <option value="price_asc" ${sortBy === 'price_asc' ? 'selected' : ''}>Prix ���?</option>
                                <option value="price_desc" ${sortBy === 'price_desc' ? 'selected' : ''}>Prix ���?</option>
                                <option value="critical" ${sortBy === 'critical' ? 'selected' : ''}>+ Critiques</option>
                            </select>
                            <!-- Reset -->
                            ${(searchQuery || categoryFilter !== 'all' || statusFilter !== 'all') ? `
                            <button onclick="VendeurModule.state.stockSearch='';VendeurModule.state.stockCategoryFilter='all';VendeurModule.state.stockStatusFilter='all';VendeurModule.state.stockPage=1;App.rerender()" 
                                class="px-3 py-2.5 bg-red-100 text-red-700 rounded-xl font-bold hover:bg-red-200 transition flex items-center gap-1">
                                <i data-lucide="x" class="w-4 h-4"></i> Reset
                            </button>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Products Table -->
                    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                        <!-- Pagination info header -->
                        <div class="p-4 border-b border-slate-100 flex flex-wrap items-center justify-between gap-2">
                            <span class="text-sm text-slate-600 font-medium">
                                ${totalFiltered === 0 ? 'Aucun produit' : `Affichage ${startIdx + 1}-${Math.min(startIdx + perPage, totalFiltered)} sur ${totalFiltered}`}
                            </span>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-500">Par page:</span>
                                <select onchange="VendeurModule.state.stockPerPage=parseInt(this.value);VendeurModule.state.stockPage=1;App.rerender()" class="px-2 py-1 rounded-lg border border-slate-200 bg-white text-sm font-bold">
                                    <option value="20" ${perPage === 20 ? 'selected' : ''}>20</option>
                                    <option value="30" ${perPage === 30 ? 'selected' : ''}>30</option>
                                    <option value="50" ${perPage === 50 ? 'selected' : ''}>50</option>
                                    <option value="100" ${perPage === 100 ? 'selected' : ''}>100</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-left min-w-[700px]">
                                <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4">Produit</th>
                                        <th class="px-6 py-4">Cat�gorie</th>
                                        <th class="px-6 py-4 text-right">Prix</th>
                                        <th class="px-6 py-4 text-center">Stock</th>
                                        <th class="px-6 py-4 text-center">Min</th>
                                        <th class="px-6 py-4">Statut</th>
                                        <th class="px-6 py-4 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${paginatedProducts.length === 0 ? `
                                    <tr><td colspan="6" class="px-6 py-12 text-center text-slate-400 font-medium">
                                        <i data-lucide="package-x" class="w-10 h-10 mx-auto mb-2 opacity-50"></i>
                                        <div>Aucun produit trouv�</div>
                                    </td></tr>
                                    ` : paginatedProducts.map(p => {
                                        const posStock = CORE.getProductStock(p.id, posId);
                                        const posPrice = CORE.getProductPrice(p.id, posId);
                                        const minStock = p.minStock || 0;
                                        const isCritical = posStock <= minStock * 0.5;
                                        const isLow = posStock <= minStock && !isCritical;
                                        const isOut = posStock === 0;
                                        return `
                                        <tr class="hover:bg-slate-50 transition">
                                            <td class="px-6 py-4">
                                                <div class="font-black text-slate-900">${p.name}</div>
                                                <div class="text-[10px] text-slate-400">#${p.barcode || p.id}</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <span class="px-3 py-1 bg-slate-100 rounded-lg text-xs font-bold text-slate-600">${CORE.getCategory(p.categoryId)?.name || '�� ?��'}</span>
                                            </td>
                                            <td class="px-6 py-4 text-right font-black">${CORE.formatPrice(posPrice)}</td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="text-lg font-black ${isOut || isCritical ? 'text-red-600' : isLow ? 'text-amber-600' : 'text-slate-900'}">${posStock}</span>
                                            </td>
                                            <td class="px-6 py-4 text-center font-bold text-slate-500">${minStock}</td>
                                            <td class="px-6 py-4">
                                                ${isOut ? UI.badge('Rupture', 'red') :
                                                  isCritical ? UI.badge('Critique', 'red') : 
                                                  isLow ? UI.badge('Bas', 'amber') : 
                                                  UI.badge('OK', 'emerald')}
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <!-- Bouton �diter retir� pour le vendeur -->
                                            </td>
                                        </tr>
                                    `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination controls -->
                        ${totalPages > 1 ? `
                        <div class="p-4 border-t border-slate-100 flex items-center justify-center gap-2">
                            <button onclick="VendeurModule.state.stockPage=1;App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === 1 ? 'disabled' : ''}><i data-lucide="chevrons-left" class="w-4 h-4"></i></button>
                            <button onclick="VendeurModule.state.stockPage=Math.max(1,VendeurModule.state.stockPage-1);App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === 1 ? 'disabled' : ''}><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                            ${pages.map(p => p === '...' ? `<span class="px-2 text-slate-400">...</span>` : `<button onclick="VendeurModule.state.stockPage=${p};App.rerender()" class="px-3 py-2 rounded-lg ${p === currentPage ? 'bg-emerald-600 text-white' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm">${p}</button>`).join('')}
                            <button onclick="VendeurModule.state.stockPage=Math.min(${totalPages},VendeurModule.state.stockPage+1);App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === totalPages ? 'disabled' : ''}><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                            <button onclick="VendeurModule.state.stockPage=${totalPages};App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === totalPages ? 'disabled' : ''}><i data-lucide="chevrons-right" class="w-4 h-4"></i></button>
                        </div>
                        ` : ''}
                    </div>
                </div>`;
        },

        renderMovements() {
            const userPos = CORE.user?.pos;
            const movements = CORE.getMovementHistory({ posId: userPos });
            const typeIcons = {
                'transfer': '��Ÿ? � Transfert',
                'reception': '��Ÿ? � R�ception',
                'adjustment': '���? ��� � � Ajustement',
                'sale': '��Ÿ�? Vente',
                'return': '��� ��� � � Retour'
            };
            const reasonLabels = {
                'transfer_request': 'Demande de transfert',
                'manual_adjustment': 'Ajustement manuel',
                'sale': 'Vente',
                'return': 'Retour client',
                'restock': 'R�approvisionnement'
            };

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div class="flex items-end justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">��Ÿ? � Mouvements de Stock</h2>
                            <p class="text-slate-500 font-medium">Historique audit� de chaque mouvement avec tra��abilit� compl��te.</p>
                        </div>
                        <button onclick="GestionnaireModule.showTransferModal()" class="px-5 py-3 bg-slate-900 text-white rounded-xl font-black hover:bg-slate-800 transition flex items-center gap-2">
                            <i data-lucide="arrow-right-left" class="w-5 h-5"></i> Transf�rer
                        </button>
                    </div>

                    <div class="grid grid-cols-4 gap-4">
                        <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Total mouvements</div>
                            <div class="text-2xl font-black text-slate-900 mt-2">${movements.length}</div>
                        </div>
                        <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Transferts</div>
                            <div class="text-2xl font-black text-blue-600 mt-2">${movements.filter(m => m.type === 'transfer').length}</div>
                        </div>
                        <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Ajustements</div>
                            <div class="text-2xl font-black text-amber-600 mt-2">${movements.filter(m => m.type === 'adjustment').length}</div>
                        </div>
                        <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Valeur totale</div>
                            <div class="text-2xl font-black text-emerald-600 mt-2">${CORE.formatPrice(movements.reduce((sum, m) => sum + (m.totalValue || 0), 0))}</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider border-b border-slate-100">
                                <tr>
                                    <th class="px-6 py-4">Date & Heure</th>
                                    <th class="px-6 py-4">Type</th>
                                    <th class="px-6 py-4">Produit</th>
                                    <th class="px-6 py-4 text-center">Quantit�</th>
                                    <th class="px-6 py-4">De / �?�</th>
                                    <th class="px-6 py-4">Qui</th>
                                    <th class="px-6 py-4">Notes</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50">
                                ${movements.length === 0 ? `
                                    <tr>
                                        <td colspan="7" class="px-6 py-12 text-center text-slate-400 font-medium">
                                            <div class="flex flex-col items-center gap-2">
                                                <i data-lucide="inbox" class="w-8 h-8"></i>
                                                <span>Aucun mouvement de stock enregistr�</span>
                                            </div>
                                        </td>
                                    </tr>
                                ` : movements.map(m => `
                                    <tr class="hover:bg-slate-50 transition cursor-pointer" onclick="GestionnaireModule.showMovementDetail('${m.id}')">
                                        <td class="px-6 py-4 font-mono text-xs">
                                            <div class="font-black text-slate-900">${new Date(m.timestamp).toLocaleDateString('fr-FR')}</div>
                                            <div class="text-slate-400">${new Date(m.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <span class="px-3 py-1 bg-slate-100 rounded-lg text-xs font-bold text-slate-700">${typeIcons[m.type] || m.type}</span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="font-black text-slate-900">${m.productName}</div>
                                            <div class="text-[10px] text-slate-400">SKU: ${m.productSku}</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <span class="font-black text-slate-900">${m.quantity > 0 ? '+' : ''}${m.quantity}</span>
                                        </td>
                                        <td class="px-6 py-4 text-xs">
                                            ${m.type === 'transfer' ? `
                                                <div class="font-black text-slate-900">${m.fromPosName} ���? ${m.toPosName}</div>
                                            ` : `
                                                <div class="text-slate-500">${reasonLabels[m.reason] || m.reason || '�� ?��'}</div>
                                            `}
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="font-black text-slate-900">${m.userName}</div>
                                            <div class="text-[10px] text-slate-400">${m.userRole}</div>
                                        </td>
                                        <td class="px-6 py-4 max-w-xs truncate text-slate-600 text-xs">
                                            ${m.notes ? `<span title="${m.notes}">${m.notes.substring(0, 30)}${m.notes.length > 30 ? '...' : ''}</span>` : '<span class="text-slate-300">�� ?��</span>'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        },

        showTransferReceiptsCenter(tab = null) {
            const posId = CORE.user?.pos || CORE.state.currentUser?.pos || null;
            if (!posId) {
                UI.toast('POS non d�fini', 'error');
                return;
            }

            const activeTab = tab || this.state.transferReceiptsTab || 'pending';
            this.state.transferReceiptsTab = activeTab;

            const allReceipts = CORE.getTransferReceipts({ posId });
            const counts = { pending: 0, accepted: 0, rejected: 0 };
            allReceipts.forEach(r => {
                if (counts[r.status] !== undefined) counts[r.status] += 1;
            });

            const grouped = {
                pending: allReceipts.filter(r => r.status === 'pending'),
                accepted: allReceipts.filter(r => r.status === 'accepted'),
                rejected: allReceipts.filter(r => r.status === 'rejected')
            };

            const activeList = grouped[activeTab] || [];
            const emptyLabel = activeTab === 'pending'
                ? 'Aucun transfert en attente'
                : activeTab === 'accepted'
                    ? 'Aucune r�ception valid�e'
                    : 'Aucun transfert rejet�';

            const listHtml = activeList.length
                ? activeList.map(r => this.renderTransferReceiptCard(r, activeTab === 'pending')).join('')
                : `<div class="p-6 text-center text-slate-400 font-medium">${emptyLabel}</div>`;

            const tabs = [
                { key: 'pending', label: `En attente (${counts.pending})` },
                { key: 'accepted', label: `Valid�es (${counts.accepted})` },
                { key: 'rejected', label: `Rejet�es (${counts.rejected})` }
            ];

            UI.modal('��Ÿ? � R�ceptions de stock', `
                <div class="space-y-4">
                    <div class="flex flex-wrap gap-2">
                        ${tabs.map(t => `<button onclick="GestionnaireModule.showTransferReceiptsCenter('${t.key}')" class="px-4 py-2 rounded-xl font-black text-sm ${activeTab === t.key ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">${t.label}</button>`).join('')}
                    </div>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-1">${listHtml}</div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            setTimeout(() => { lucide?.createIcons?.(); }, 50);
        },

        renderTransferReceiptCard(receipt, showActions = false) {
            const statusBadge = receipt.status === 'accepted'
                ? UI.badge('Valid�e', 'emerald')
                : receipt.status === 'rejected'
                    ? UI.badge('Rejet�e', 'red')
                    : UI.badge('En attente', 'amber');
            const etaLabel = receipt.estimatedArrivalAt ? new Date(receipt.estimatedArrivalAt).toLocaleDateString('fr-FR') : '�� ?��';
            const createdLabel = receipt.createdAt ? new Date(receipt.createdAt).toLocaleString('fr-FR') : '�� ?��';
            const attachmentsCount = Array.isArray(receipt.attachments) ? receipt.attachments.length : 0;
            const proofCount = Array.isArray(receipt.proofAttachments) ? receipt.proofAttachments.length : 0;

            return `
                <div class="p-4 bg-white border border-slate-200 rounded-2xl shadow-sm">
                    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                        <div>
                            <div class="flex items-center gap-2">
                                <div class="font-black text-slate-900">${receipt.productName}</div>
                                ${statusBadge}
                            </div>
                            <div class="text-xs text-slate-500 mt-1">R�f: ${receipt.reference || receipt.id}</div>
                            <div class="text-xs text-slate-500 mt-1">Quantit�: <span class="font-black text-slate-900">${receipt.quantity}</span></div>
                            <div class="text-xs text-slate-500 mt-1">Envoy� par: ${receipt.fromPosName || 'D�p��t principal'}</div>
                            <div class="text-xs text-slate-500 mt-1">Cr�� le ${createdLabel}</div>
                            <div class="text-xs text-slate-500 mt-1">ETA: ${etaLabel}</div>
                            ${attachmentsCount ? `<div class="text-xs text-slate-500 mt-1">��Ÿ?Ž ${attachmentsCount} pi��ce(s) exp�diteur</div>` : ''}
                            ${proofCount ? `<div class="text-xs text-emerald-600 mt-1">���?� ${proofCount} preuve(s) re��ues</div>` : ''}
                        </div>
                        <div class="flex flex-col items-stretch md:items-end gap-2">
                            <button onclick="GestionnaireModule.showTransferReceiptDetails('${receipt.id}')" class="px-4 py-2 bg-slate-900 text-white text-xs font-black rounded-xl hover:bg-slate-800 transition">D�tails</button>
                            ${showActions ? `
                                <div class="flex gap-2">
                                    <button onclick="GestionnaireModule.showApproveTransferReceiptModal('${receipt.id}')" class="px-4 py-2 bg-emerald-600 text-white text-xs font-black rounded-xl hover:bg-emerald-700 transition">Valider</button>
                                    <button onclick="GestionnaireModule.showRejectTransferReceiptModal('${receipt.id}')" class="px-4 py-2 bg-red-600 text-white text-xs font-black rounded-xl hover:bg-red-700 transition">Rejeter</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ${receipt.note ? `<div class="mt-3 text-xs text-slate-600 bg-slate-50 border border-slate-100 rounded-xl p-3">${receipt.note}</div>` : ''}
                </div>
            `;
        },

        showTransferReceiptDetails(receiptId) {
            const receipt = CORE.getTransferReceipt(receiptId);
            if (!receipt) {
                UI.toast('Transfert introuvable', 'error');
                return;
            }

            const etaLabel = receipt.estimatedArrivalAt ? new Date(receipt.estimatedArrivalAt).toLocaleString('fr-FR') : '�� ?��';
            const createdLabel = receipt.createdAt ? new Date(receipt.createdAt).toLocaleString('fr-FR') : '�� ?��';
            const updatedLabel = receipt.updatedAt ? new Date(receipt.updatedAt).toLocaleString('fr-FR') : '�� ?��';
            const attachments = Array.isArray(receipt.attachments) ? receipt.attachments : [];
            const proofs = Array.isArray(receipt.proofAttachments) ? receipt.proofAttachments : [];

            UI.modal(`��Ÿ? � ${receipt.productName}`, `
                <div class="space-y-4 text-sm text-slate-600">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">R�f�rence</div>
                            <div class="font-black text-slate-900">${receipt.reference || receipt.id}</div>
                        </div>
                        <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Quantit�</div>
                            <div class="font-black text-slate-900">${receipt.quantity}</div>
                        </div>
                        <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Origine</div>
                            <div class="font-black text-slate-900">${receipt.fromPosName || 'D�p��t principal'}</div>
                        </div>
                        <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Destinataire</div>
                            <div class="font-black text-slate-900">${receipt.toPosName || `POS ${receipt.toPosId}`}</div>
                        </div>
                        <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Cr�� le</div>
                            <div class="font-black text-slate-900">${createdLabel}</div>
                        </div>
                        <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Mise �� jour</div>
                            <div class="font-black text-slate-900">${updatedLabel}</div>
                        </div>
                        <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Statut</div>
                            <div>${receipt.status === 'accepted' ? UI.badge('Valid�e','emerald') : receipt.status === 'rejected' ? UI.badge('Rejet�e','red') : UI.badge('En attente','amber')}</div>
                        </div>
                        <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">ETA</div>
                            <div class="font-black text-slate-900">${etaLabel}</div>
                        </div>
                    </div>
                    ${receipt.note ? `<div class="p-3 bg-white border border-slate-200 rounded-xl">${receipt.note}</div>` : ''}
                    ${attachments.length ? `
                        <div>
                            <div class="text-xs font-black text-slate-500 uppercase mb-2">Pi��ces jointes exp�diteur</div>
                            <div class="flex flex-wrap gap-2">
                                ${attachments.map((att, idx) => `<a href="${att.dataUrl}" target="_blank" class="px-3 py-2 bg-slate-100 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 hover:bg-slate-200 transition">Pi��ce ${idx + 1}</a>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${proofs.length ? `
                        <div>
                            <div class="text-xs font-black text-slate-500 uppercase mb-2">Preuves de r�ception</div>
                            <div class="flex flex-wrap gap-2">
                                ${proofs.map((att, idx) => `<a href="${att.dataUrl}" target="_blank" class="px-3 py-2 bg-emerald-100 border border-emerald-200 rounded-xl text-xs font-bold text-emerald-700 hover:bg-emerald-200 transition">Preuve ${idx + 1}</a>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            setTimeout(() => { lucide?.createIcons?.(); }, 50);
        },

        resetReceiptProofState() {
            this.state.pendingReceiptFiles = [];
            const preview = document.getElementById('transfer_receipt_preview');
            if (preview) preview.innerHTML = '<div class="text-xs text-slate-500">Aucune pi��ce jointe</div>';
        },

        handleReceiptAttachmentChange(event) {
            const files = Array.from(event?.target?.files || []);
            this.state.pendingReceiptFiles = files;
            this.updateReceiptAttachmentPreview(files);
        },

        updateReceiptAttachmentPreview(files = null) {
            const list = Array.isArray(files) ? files : (this.state.pendingReceiptFiles || []);
            const preview = document.getElementById('transfer_receipt_preview');
            if (!preview) return;
            if (!list.length) {
                preview.innerHTML = '<div class="text-xs text-slate-500">Aucune pi��ce jointe</div>';
                return;
            }
            preview.innerHTML = list.map((file, idx) => {
                const sizeKb = file.size ? Math.round(file.size / 1024) : 0;
                const type = (file.type || 'fichier').split('/')[0];
                return `
                    <div class="flex items-center justify-between gap-3 px-3 py-2 bg-white border border-slate-200 rounded-xl">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-black text-slate-900">${idx + 1}.</span>
                            <div class="text-xs font-bold text-slate-700 truncate max-w-[220px]" title="${file.name}">${file.name || 'Pi��ce jointe'}</div>
                            <span class="text-[10px] uppercase font-black text-slate-400">${type}</span>
                        </div>
                        <span class="text-[10px] text-slate-500">${sizeKb} Ko</span>
                    </div>
                `;
            }).join('');
        },

        showApproveTransferReceiptModal(receiptId) {
            const receipt = CORE.getTransferReceipt(receiptId);
            if (!receipt) {
                UI.toast('Transfert introuvable', 'error');
                return;
            }

            this.resetReceiptProofState();

            UI.modal('���?� Valider la r�ception', `
                <div class="space-y-4">
                    <p class="text-sm text-slate-600">Confirmez la r�ception de <span class="font-black text-slate-900">${receipt.quantity}</span> ${receipt.productName}.</p>
                    <textarea id="transfer_receipt_note" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500" rows="3" placeholder="Note de r�ception (optionnel)"></textarea>
                    <div class="space-y-2">
                        <label class="text-xs font-black text-slate-600 uppercase">Ajoutez des preuves (photos/vid�os)</label>
                        <input id="transfer_receipt_files" type="file" accept="image/*,video/*" multiple onchange="GestionnaireModule.handleReceiptAttachmentChange(event)" class="w-full text-sm text-slate-600">
                        <div id="transfer_receipt_preview" class="space-y-2 p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs text-slate-500">Aucune pi��ce jointe</div>
                        <div class="text-[11px] text-slate-400">Formats accept�s: images et vid�os. Minimum une pi��ce requise.</div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Valider', onclick: `GestionnaireModule.executeApproveTransferReceipt('${receipt.id}')`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);

            setTimeout(() => { this.updateReceiptAttachmentPreview(); }, 50);
        },

        async executeApproveTransferReceipt(receiptId) {
            const note = (document.getElementById('transfer_receipt_note')?.value || '').trim();
            const files = Array.from(this.state.pendingReceiptFiles || []);
            if (!files.length) {
                UI.toast('Ajoutez au moins une preuve visuelle', 'warning');
                return;
            }

            let attachments = [];
            try {
                attachments = await Promise.all(files.map(async (file) => {
                    const dataUrl = await Utils.readFileAsDataUrl(file);
                    return {
                        id: Utils.uid('ATT'),
                        name: file.name || 'attachment',
                        type: file.type || 'application/octet-stream',
                        size: file.size || 0,
                        dataUrl,
                        uploadedAt: new Date().toISOString()
                    };
                }));
            } catch (err) {
                UI.toast('Lecture des pi��ces jointe(s) impossible', 'error');
                return;
            }

            const result = CORE.approveTransferReceipt(receiptId, note, attachments);
            if (!result?.success) {
                UI.toast(result?.message || 'Impossible de valider la r�ception', 'error');
                return;
            }

            UI.closeModal();
            this.resetReceiptProofState();
            UI.toast('R�ception valid�e', 'success');
            setTimeout(() => {
                this.showTransferReceiptsCenter(this.state.transferReceiptsTab || 'pending');
                App.rerender();
            }, 50);
        },


        showRejectTransferReceiptModal(receiptId) {
            const receipt = CORE.getTransferReceipt(receiptId);
            if (!receipt) {
                UI.toast('Transfert introuvable', 'error');
                return;
            }

            UI.modal('���??�� � � Rejeter la r�ception', `
                <div class="space-y-4">
                    <p class="text-sm text-slate-600">Expliquez la raison du rejet pour ${receipt.reference || receipt.id}.</p>
                    <textarea id="transfer_receipt_reason" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-red-500" rows="3" placeholder="Motif du rejet (obligatoire)"></textarea>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Rejeter', onclick: `GestionnaireModule.executeRejectTransferReceipt('${receipt.id}')`, class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);
        },

        executeRejectTransferReceipt(receiptId) {
            const reason = (document.getElementById('transfer_receipt_reason')?.value || '').trim();
            if (!reason) {
                UI.toast('Motif requis pour rejeter', 'warning');
                return;
            }

            const result = CORE.rejectTransferReceipt(receiptId, reason);
            if (!result?.success) {
                UI.toast(result?.message || 'Impossible de rejeter la r�ception', 'error');
                return;
            }

            UI.closeModal();
            UI.toast('R�ception rejet�e', 'info');
            setTimeout(() => {
                this.showTransferReceiptsCenter(this.state.transferReceiptsTab || 'pending');
                App.rerender();
            }, 50);
        },

        // =====================
        // LIVREURS (Vendeur)
        // =====================
        getLivreursForSeller() {
            const userPos = CORE.user?.pos;
            const livreurs = CORE.getLivreursForPOS(userPos);
            const activeStatuses = ['en_cours', 'en_attente', 'assigned'];
            const activeDeliveries = CORE.db.deliveries.filter(d => d.posId === userPos && activeStatuses.includes(d.status));
            const counts = {};
            activeDeliveries.forEach(d => {
                if (d.livreurId) counts[d.livreurId] = (counts[d.livreurId] || 0) + 1;
            });

            return livreurs.map(l => {
                const activeCount = counts[l.id] || 0;
                return {
                    ...l,
                    activeCount,
                    isBusy: activeCount > 0,
                    activeDelivery: activeDeliveries.find(d => d.livreurId === l.id) || null
                };
            });
        },

        showAssignDeliveryModal(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;
            
            // R�cup�rer les livreurs disponibles du m��me POS
            const unassignedLivreurs = CORE.getUnassignedLivreurs(d.posId);
            
            // R�cup�rer les livreurs ind�pendants approuv�s du m��me POS
            const approvedIndependentMen = CORE.getApprovedDeliveryMen(CORE.state.currentUser?.id)
                .filter(dm => dm.posId == d.posId);
            
            // Combiner les livreurs
            const allLivreurs = [
                ...unassignedLivreurs,
                ...approvedIndependentMen.map(dm => ({
                    id: dm.id,
                    name: `${dm.name} (Ind�pendant)`,
                    vehicle: dm.vehicle || 'N/A',
                    phone: dm.phone || '',
                    rating: dm.rating || 0,
                    activeDeliveries: (CORE.db.deliveries || [])
                        .filter(dlv => dlv.livreurId === dm.id && ['en_cours', 'assigned'].includes(dlv.status))
                        .length,
                    isIndependent: true
                }))
            ];

            UI.modal(`Assigner ${d.orderRef}`, `
                <div class="space-y-4">
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Client</div>
                        <div class="mt-1 font-black text-slate-900">${d.clientName}</div>
                        <div class="text-xs text-slate-500">${d.address}</div>
                    </div>

                    ${allLivreurs.length > 0 ? `
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-xl flex items-center gap-2">
                            <i data-lucide="info" class="w-4 h-4 text-blue-600 flex-shrink-0"></i>
                            <span class="text-xs text-blue-800">${allLivreurs.filter(l => l.activeDeliveries === 0).length} livreur(s) enti��rement disponible(s)</span>
                        </div>
                    ` : `
                        <div class="p-3 bg-amber-50 border border-amber-200 rounded-xl flex items-center gap-2">
                            <i data-lucide="alert-circle" class="w-4 h-4 text-amber-600 flex-shrink-0"></i>
                            <span class="text-xs text-amber-800">��š ��� � � Aucun livreur disponible pour ce POS</span>
                        </div>
                    `}

                    ${allLivreurs.length > 0 ? `
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Livreur</label>
                            <select id="assign_livreur" onchange="VendeurModule.updateAssignButtons(${d.id})" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-emerald-500 outline-none font-medium">
                                ${allLivreurs.map(l => {
                                    const status = l.activeDeliveries > 0 ? l.activeDeliveries + ' en cours ��Ÿ� �' : 'Libre ��ŸŸ �';
                                    const badge = l.isIndependent ? ' �� � �' : '';
                                    const selected = l.id == d.livreurId ? 'selected' : '';
                                    return '<option value="' + l.id + '" ' + selected + '>' + l.name + ' (' + (l.vehicle || 'N/A') + ') - ' + status + badge + '</option>';
                                }).join('')}
                            </select>
                        </div>
                    ` : ''}
                    
                    <div id="assign-buttons-container" class="grid grid-cols-2 gap-3 pt-4 border-t border-slate-100">
                        <button onclick="VendeurModule.assignDelivery(${d.id}, false)" class="py-3 px-4 bg-slate-100 text-slate-700 font-black rounded-xl hover:bg-slate-200 transition text-xs" ${allLivreurs.length === 0 ? 'disabled' : ''}>
                            Assignation
                        </button>
                        <button onclick="VendeurModule.assignDelivery(${d.id}, true)" class="py-3 px-4 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition flex items-center justify-center gap-2 text-xs" ${allLivreurs.length === 0 ? 'disabled' : ''}>
                            <i data-lucide="message-square" class="w-4 h-4"></i> SMS
                        </button>
                    </div>

                    <button onclick="VendeurModule.autoAssignDelivery(${d.id})" class="w-full py-3 px-4 bg-emerald-50 text-emerald-700 font-black rounded-xl hover:bg-emerald-100 transition border border-emerald-200 text-sm flex items-center justify-center gap-2">
                        <i data-lucide="zap" class="w-4 h-4"></i> Assignation Intelligente Automatique
                    </button>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
            
            // Mettre �� jour les boutons selon le livreur s�lectionn� par d�faut
            setTimeout(() => this.updateAssignButtons(d.id), 100);
        },
        
        updateAssignButtons(deliveryId) {
            const livreurIdRaw = UI.val('assign_livreur') || '';
            const isIndependent = String(livreurIdRaw).startsWith('idm_');
            const container = document.getElementById('assign-buttons-container');
            if (!container) return;
            
            if (isIndependent) {
                // Pour les livreurs ind�pendants: WhatsApp + SMS
                container.innerHTML = `
                    <button onclick="VendeurModule.assignDeliveryWhatsApp(${deliveryId})" class="py-3 px-4 bg-green-500 text-white font-black rounded-xl hover:bg-green-600 shadow-lg shadow-green-200 transition flex items-center justify-center gap-2 text-xs">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                        WhatsApp
                    </button>
                    <button onclick="VendeurModule.assignDelivery(${deliveryId}, true)" class="py-3 px-4 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition flex items-center justify-center gap-2 text-xs">
                        <i data-lucide="message-square" class="w-4 h-4"></i> SMS
                    </button>
                `;
            } else {
                // Pour les livreurs employ�s: Assignation + SMS
                container.innerHTML = `
                    <button onclick="VendeurModule.assignDelivery(${deliveryId}, false)" class="py-3 px-4 bg-slate-100 text-slate-700 font-black rounded-xl hover:bg-slate-200 transition text-xs">
                        Assignation
                    </button>
                    <button onclick="VendeurModule.assignDelivery(${deliveryId}, true)" class="py-3 px-4 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition flex items-center justify-center gap-2 text-xs">
                        <i data-lucide="message-square" class="w-4 h-4"></i> SMS
                    </button>
                `;
            }
            lucide.createIcons();
        },
        
        assignDeliveryWhatsApp(deliveryId) {
            const livreurIdRaw = UI.val('assign_livreur') || '0';
            if (!livreurIdRaw || livreurIdRaw === '0') return UI.toast('S�lectionnez un livreur', 'warning');

            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;

            // R�cup�rer le livreur ind�pendant
            const livreur = CORE.db.independentDeliveryMen.find(dm => dm.id === livreurIdRaw);
            if (!livreur) return UI.toast('Livreur introuvable', 'error');
            if (!livreur.phone) return UI.toast('Num�ro de t�l�phone du livreur manquant', 'warning');

            // Assigner la livraison
            const previousLivreurId = d.livreurId || d.previousLivreurId || null;
            CORE.update('deliveries', d.id, {
                previousLivreurId,
                livreurId: livreurIdRaw,
                isIndependentLivreur: true,
                status: 'en_attente',
                assignedAt: new Date().toISOString(),
                recallReason: null,
                recalledAt: null
            });

            // Audit log
            CORE.logActivity('assign', 'delivery', d.id, {
                entityName: `Commande ${d.orderRef}`,
                description: `Affectation �� ${livreur.name} (ind�pendant) via WhatsApp`,
                before: { livreurId: previousLivreurId },
                after: { livreurId: livreurIdRaw }
            });

            // Construire le message WhatsApp
            const msg = `��Ÿšš *Nouvelle course assign�e*\n\n` +
                `��Ÿ?� R�f: ${d.orderRef}\n` +
                `��Ÿ? � Client: ${d.clientName}\n` +
                `��Ÿ? � T�l: ${d.clientPhone || '�� ?��'}\n` +
                `��Ÿ? � Adresse: ${d.address}\n` +
                `��Ÿ� � Heure: ${d.deliveryTime || 'D��s que possible'}\n` +
                `��Ÿ? � �?� encaisser: ${CORE.formatPrice(d.amount)}\n\n` +
                `Merci de confirmer la prise en charge.`;

            // Formater le num�ro pour WhatsApp (enlever les espaces et le +)
            const phoneNumber = livreur.phone.replace(/[\s+()-]/g, '');
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(msg)}`;
            
            window.open(whatsappUrl, '_blank');
            
            UI.closeModal();
            UI.toast(`Course assign�e �� ${livreur.name} - WhatsApp ouvert`, 'success');
            App.rerender();
        },

        autoAssignDelivery(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return UI.toast('Livraison introuvable', 'error');

            const result = CORE.autoAssignDelivery(d.posId, deliveryId);
            if (!result) {
                return UI.toast('Aucun livreur disponible pour ce POS', 'warning');
            }

            UI.closeModal();
            UI.toast(`���?? Auto-assign�e �� ${result.livreur.name}`, 'success');
            App.rerender();
        },

        assignDelivery(deliveryId, sendSms = false) {
            const livreurIdRaw = UI.val('assign_livreur') || '0';
            if (!livreurIdRaw || livreurIdRaw === '0') return UI.toast('S�lectionnez un livreur', 'warning');

            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;

            // V�rifier si c'est un livreur ind�pendant (id commence par 'idm_')
            const isIndependent = String(livreurIdRaw).startsWith('idm_');
            let livreur = null;
            let livreurId = livreurIdRaw;
            
            if (isIndependent) {
                livreur = CORE.db.independentDeliveryMen.find(dm => dm.id === livreurIdRaw);
                if (!livreur) return UI.toast('Livreur ind�pendant introuvable', 'error');
                // V�rifier que le livreur ind�pendant est approuv� et du m��me POS
                if (livreur.approvalStatus !== 'approved') return UI.toast('Ce livreur ind�pendant n\'est pas encore approuv�', 'warning');
                if (livreur.posId != d.posId) return UI.toast('Le livreur n\'appartient pas au m��me POS que la livraison', 'error');
            } else {
                livreurId = parseInt(livreurIdRaw, 10);
                livreur = CORE.getUser(livreurId);
                if (!livreur || livreur.role !== 'livreur') return UI.toast('Livreur invalide', 'error');
                // V�rifier que le livreur appartient au m��me POS que la livraison
                if (livreur.pos != d.posId) {
                    return UI.toast('Le livreur n\'appartient pas au m��me POS que la livraison', 'error');
                }
            }

            // Assignation/r�assignation possible m��me si la course �tait "annul�e", "rappel�e" ou une "reservation".
            // Le statut reste 'en_attente' apr��s assignation - c'est au livreur de signaler 'en_cours'
            const nextStatus = (d.status === 'livree') ? 'livree' : 'en_attente';
            const previousLivreurId = d.livreurId || d.previousLivreurId || null;
            const oldDelivery = { ...d };
            
            CORE.update('deliveries', d.id, {
                previousLivreurId,
                livreurId,
                isIndependentLivreur: isIndependent,
                status: nextStatus,
                assignedAt: nextStatus === 'en_cours' ? new Date().toISOString() : (d.assignedAt || null),
                // clear recall info on reassign
                recallReason: null,
                recalledAt: null
            });

            const o = CORE.db.orders.find(x => x.id === d.orderId);
            if (o && nextStatus === 'en_cours' && o.status !== 'delivered') {
                CORE.update('orders', o.id, { status: 'delivering' });
            }

            // Record audit log
            CORE.logActivity('assign', 'delivery', d.id, {
                entityName: `Commande ${d.orderRef}`,
                description: `Affectation �� ${livreur.name}${isIndependent ? ' (ind�pendant)' : ''} - Statut: ${nextStatus}`,
                before: { livreurId: previousLivreurId },
                after: { livreurId: livreurId }
            });

            if (sendSms && livreur.phone) {
                const msg = `Course ${d.orderRef} assign�e. Client: ${d.clientName}, ${d.clientPhone}. Adr: ${d.address}. Heure: ${d.deliveryTime || '�� ?��'}. A encaisser: ${CORE.formatPrice(d.amount)}.`;
                window.open(`sms:${livreur.phone}?body=${encodeURIComponent(msg)}`, '_blank');
            }

            CORE.notify('info', `Course ${d.orderRef} assign�e �� ${livreur.name}`, { deliveryId: d.id, livreurId });
            
            // ��Ÿ�Š Jouer le son de notification pour le livreur
            UI.playNotificationSound();
            
            UI.closeModal();
            UI.toast(`Course assign�e �� ${livreur.name}`, 'success');
            App.rerender();
        },

        setDeliveryStatusBySeller(deliveryId, status) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;

            const oldStatus = d.status;
            const calculatedCommission = d.commission || CORE.calculateDeliveryCommission(d);
            CORE.update('deliveries', d.id, { 
                status, 
                commission: status === 'livree' ? calculatedCommission : d.commission,
                deliveredAt: status === 'livree' ? new Date().toISOString() : (d.deliveredAt || null) 
            });

            // Cr�er automatiquement des incidents pour les probl��mes
            if (status === 'probleme' && oldStatus !== 'probleme') {
                CORE.createIncident('retard', d.id, 'delivery', `Probl��me de livraison: ${d.orderRef}`, 'haute');
            } else if (status === 'annulee' && oldStatus !== 'annulee') {
                CORE.createIncident('annulation', d.id, 'delivery', `Livraison annul�e: ${d.orderRef}`, 'haute');
            }

            // Synchroniser commande (si existante)
            const o = CORE.db.orders.find(x => x.id === d.orderId);
            if (o) {
                if (status === 'livree') {
                    // Pour COD: le paymentStatus reste 'pending' jusqu'�� encaissement manuel par le vendeur
                    // Pour autres m�thodes: conserver le statut actuel
                    const updatedOrder = CORE.update('orders', o.id, {
                        status: 'delivered',
                        paymentStatus: o.paymentStatus // Ne pas changer - sera mis �� 'paid' via markCODCollected()
                    });

                    // Ledger: enregistrer la vente si COD encaiss� maintenant
                    CORE.ensureSaleTransaction(updatedOrder);

                    // Ledger: commission livreur
                    CORE.ensureCommissionTransaction({ ...d, status: 'livree' });
                    
                    // Mettre �� jour le compteur de livraisons du livreur
                    if (d.livreurId) {
                        const isIndependent = String(d.livreurId).startsWith('idm_');
                        if (isIndependent) {
                            // Livreur ind�pendant
                            const dm = CORE.db.independentDeliveryMen.find(m => m.id === d.livreurId);
                            if (dm) {
                                dm.deliveryCount = (dm.deliveryCount || 0) + 1;
                                dm.totalEarnings = (dm.totalEarnings || 0) + (calculatedCommission || 0);
                            }
                        } else {
                            // Livreur employ�
                            const livreur = CORE.getUser(d.livreurId);
                            if (livreur) {
                                CORE.update('users', d.livreurId, {
                                    deliveryCount: (livreur.deliveryCount || 0) + 1
                                });
                            }
                        }
                    }
                }
                if (status === 'probleme') {
                    // laisse la commande en pending/delivering selon votre logique; on garde simple
                    CORE.update('orders', o.id, { status: o.status === 'delivered' ? o.status : 'delivering' });
                }
            }

            // Record audit log for status change
            CORE.logActivity('status_change', 'delivery', d.id, {
                entityName: `Commande ${d.orderRef}`,
                description: `Statut modifi�: ${oldStatus} ���? ${status}`,
                before: { status: oldStatus },
                after: { status: status }
            });

            UI.toast(`Course mise �� jour: ${status}`, 'success');
            App.rerender();
        },

        // Rappeler un bon de livraison d�j�� envoy� �� un livreur
        // - permet de d�sassigner un livreur et remettre en dispatch
        // - garde l'historique: recalledAt, recallReason, previousLivreurId
        // - la livraison reste modifiable ensuite

        showDeliveryDetailModal(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;

            const livreur = d.livreurId ? CORE.getUser(d.livreurId) : null;
            const order = d.orderId ? CORE.db.orders.find(o => o.id === d.orderId) : null;
            const orderItems = order?.items || [];
            
            const statusBadge = d.status === 'livree' ? UI.badge('Livr�e', 'emerald') :
                                d.status === 'probleme' ? UI.badge('Probl��me', 'red') :
                                d.status === 'en_attente' ? UI.badge('�?� assigner', 'blue') :
                                d.status === 'annulee' ? UI.badge('Annul�e', 'slate') :
                                UI.badge('En cours', 'amber');

            const phone = (livreur?.phone || '').trim();
            const livreurHtml = !livreur ? '<div class="text-sm text-slate-500">Aucun livreur assign�</div>' : 
                '<div class="flex items-start justify-between gap-3"><div><div class="font-black text-slate-900">' + livreur.name + '</div><div class="text-xs text-slate-500">' + (livreur.vehicle || '�� ?��') + ' �� ?� � note ' + (livreur.rating || '�� ?��') + '</div>' + (phone ? '<div class="mt-1 text-xs text-slate-600"><b>' + phone + '</b></div>' : '<div class="mt-1 text-xs text-amber-700 font-bold">T�l�phone manquant</div>') + '</div><div class="flex flex-col gap-2"><button onclick="VendeurModule.showEditLivreurModal(' + livreur.id + ')" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-50">Modifier tel.</button><button onclick="VendeurModule.callLivreur(' + livreur.id + ')" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700">Appeler</button></div></div>';

            const productsContent = orderItems.length === 0 ? '<div class="text-xs text-blue-700">Aucun produit</div>' : 
                '<div class="space-y-2 max-h-48 overflow-y-auto">' + orderItems.map(item => '<div class="p-2 bg-white rounded border border-blue-200"><div class="flex items-center justify-between gap-2"><div class="flex-1 text-xs"><div class="font-bold text-slate-900">' + item.name + '</div><div class="text-blue-700">Qty: <strong>' + item.qty + '</strong> �?? ' + CORE.formatPrice(item.price) + '</div></div><div class="font-bold text-slate-900 text-xs">' + CORE.formatPrice(item.qty * item.price) + '</div></div></div>').join('') + '</div>';

            // Historique des rappels pour la vue d�tail
            const recallHistory = d.recallHistory || [];
            let recallHistoryHtml = '';
            if (recallHistory.length > 0) {
                recallHistoryHtml = '<div class="p-4 bg-red-50 border border-red-200 rounded-2xl"><div class="text-xs font-black text-red-600 uppercase tracking-wider mb-2">��š ��� � � Historique des rappels (' + recallHistory.length + ')</div><div class="space-y-2 max-h-32 overflow-y-auto">' + recallHistory.map((r, idx) => {
                    const liv = r.livreurId ? CORE.getUser(r.livreurId) : null;
                    const dateStr = r.date ? new Date(r.date).toLocaleString('fr-FR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : '�� ?��';
                    return '<div class="p-2 bg-white rounded-xl border border-red-100 text-xs"><div class="flex items-center justify-between"><span class="font-bold text-red-700">#' + (idx + 1) + ' - ' + (liv?.name || r.livreurName || 'Livreur inconnu') + '</span><span class="text-slate-400">' + dateStr + '</span></div><div class="mt-1 text-slate-600">' + (r.reason || 'Aucune raison sp�cifi�e') + '</div></div>';
                }).join('') + '</div></div>';
            }

            // Photos de preuve de livraison
            let proofPhotosHtml = '';
            if (d.proofPhotos && d.proofPhotos.length > 0) {
                proofPhotosHtml = '<div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl"><div class="text-xs font-black text-emerald-600 uppercase tracking-wider mb-2 flex items-center gap-2"><i data-lucide="camera" class="w-4 h-4"></i> Photos de preuve (' + d.proofPhotos.length + ')</div><div class="grid grid-cols-4 gap-2">' + d.proofPhotos.map((photo, idx) => '<div class="aspect-square rounded-xl overflow-hidden border border-emerald-300 cursor-pointer" onclick="VendeurModule.viewProofPhoto(\'' + photo.substring(0, 50) + '...\', ' + d.id + ', ' + idx + ')"><img src="' + photo + '" class="w-full h-full object-cover hover:scale-110 transition"></div>').join('') + '</div>' + (d.proofNote ? '<div class="mt-2 p-2 bg-white rounded-lg text-xs text-slate-600"><b>Note:</b> ' + d.proofNote + '</div>' : '') + (d.proofTimestamp ? '<div class="mt-1 text-xs text-emerald-700 text-right">Valid� le ' + new Date(d.proofTimestamp).toLocaleString('fr-FR') + '</div>' : '') + '</div>';
            }

            // Signature de preuve
            let proofSignatureHtml = '';
            if (d.proofSignature) {
                proofSignatureHtml = '<div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl"><div class="text-xs font-black text-blue-600 uppercase tracking-wider mb-2 flex items-center gap-2">���? ��� � � Signature client</div><div class="bg-white p-3 rounded-xl border border-blue-200 cursor-pointer" onclick="VendeurModule.viewProofSignature(' + d.id + ')"><img src="' + d.proofSignature + '" class="w-full max-h-32 object-contain"></div>' + (d.proofTimestamp ? '<div class="mt-1 text-xs text-blue-700 text-right">Sign� le ' + new Date(d.proofTimestamp).toLocaleString('fr-FR') + '</div>' : '') + '</div>';
            }

            UI.modal('Course ' + d.orderRef, '<div class="space-y-4 max-h-[80vh] overflow-y-auto"><div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl flex items-start justify-between gap-4"><div><div class="text-xs font-black text-slate-500 uppercase tracking-wider">Statut</div><div class="mt-1">' + statusBadge + '</div></div><div class="text-right"><div class="text-xs font-black text-slate-500 uppercase tracking-wider">Montant</div><div class="text-2xl font-black text-emerald-600">' + CORE.formatPrice(d.amount) + '</div></div></div><div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl"><div class="text-xs font-black text-slate-500 uppercase tracking-wider">Client</div><div class="mt-1 font-black text-slate-900">' + (d.clientName || '�� ?��') + '</div><div class="text-xs text-slate-600">' + (d.clientPhone || '') + '</div><div class="mt-2 text-xs text-slate-600"><b>Adresse:</b> ' + (d.address || '�� ?��') + '</div>' + (d.deliveryTime ? '<div class="mt-1 text-xs text-slate-600"><b>Heure souhait�e:</b> ' + d.deliveryTime + '</div>' : '') + (d.recallReason ? '<div class="mt-3 p-3 rounded-xl bg-amber-50 border border-amber-100 text-xs text-amber-800"><b>Dernier rappel:</b> ' + d.recallReason + '</div>' : '') + '</div>' + recallHistoryHtml + proofPhotosHtml + proofSignatureHtml + '<div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl"><div class="font-black text-blue-900 mb-3">��Ÿ? � Produits (' + orderItems.length + ')</div>' + productsContent + '</div><div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl"><div class="text-xs font-black text-slate-500 uppercase tracking-wider">Livreur</div><div class="mt-2">' + livreurHtml + '</div></div><div class="grid grid-cols-2 gap-2"><button onclick="UI.closeModal();VendeurModule.showEditDeliveryModal(' + d.id + ')" class="px-4 py-3 rounded-xl bg-slate-900 text-white font-black hover:bg-slate-800 transition">Modifier livraison</button><button onclick="UI.closeModal();VendeurModule.showAssignDeliveryModal(' + d.id + ')" class="px-4 py-3 rounded-xl bg-white border border-slate-200 font-black hover:bg-slate-50 transition">R�assigner</button><button onclick="VendeurModule.sendDeliveryToWhatsApp(' + d.id + ')" class="px-4 py-3 rounded-xl bg-green-500 text-white font-black hover:bg-green-600 transition col-span-2 flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg> Envoyer via WhatsApp</button>' + (d.livreurId && ['en_cours','probleme'].includes(d.status) ? '<button onclick="UI.closeModal();VendeurModule.showRecallDeliveryModal(' + d.id + ')" class="px-4 py-3 rounded-xl bg-red-50 text-red-700 font-black hover:bg-red-100 transition col-span-2">Rappeler bon de livraison</button>' : '') + (d.status !== 'livree' ? '<button onclick="VendeurModule.setDeliveryStatusBySeller(' + d.id + ',\'livree\');UI.closeModal()" class="px-4 py-3 rounded-xl bg-emerald-600 text-white font-black hover:bg-emerald-700 transition col-span-2">Marquer livr�e</button>' : '') + '</div></div>', [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        // Voir une photo de preuve en plein �cran
        viewProofPhoto(preview, deliveryId, photoIndex) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d || !d.proofPhotos || !d.proofPhotos[photoIndex]) return;
            
            const photo = d.proofPhotos[photoIndex];
            UI.modal('��Ÿ? � Photo de preuve', `
                <div class="flex items-center justify-center">
                    <img src="${photo}" class="max-w-full max-h-[70vh] rounded-2xl shadow-lg">
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-3xl' });
        },

        // Voir la signature de preuve en plein �cran
        viewProofSignature(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d || !d.proofSignature) return;
            
            UI.modal('���? ��� � � Signature client', `
                <div class="flex flex-col items-center gap-4">
                    <div class="p-6 bg-white rounded-2xl border-2 border-slate-200 shadow-lg">
                        <img src="${d.proofSignature}" class="max-w-full max-h-[50vh]" alt="Signature du client">
                    </div>
                    <div class="text-sm text-slate-600">
                        Signature pour la commande <span class="font-bold">${d.orderRef}</span>
                    </div>
                    <div class="text-xs text-slate-400">
                        ${d.proofTimestamp ? new Date(d.proofTimestamp).toLocaleString('fr-FR') : ''}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-md' });
        },

        // Envoyer le bon de livraison via WhatsApp �� un livreur ind�pendant
        sendDeliveryToWhatsApp(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;

            const order = d.orderId ? CORE.db.orders.find(o => o.id === d.orderId) : null;
            const orderItems = order?.items || [];
            const pdv = CORE.db.pointsDeVente?.find(p => p.id === CORE.state.activePDV);
            const pdvName = pdv?.nom || `${CORE.getCompanyName()} STORE`;

            // Construire le message du bon de livraison
            let message = "��Ÿ? � *BON DE LIVRAISON*\n";
            message += "��� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� �\n\n";
            message += "��Ÿ � � *De:* " + pdvName + "\n";
            message += "��Ÿ?� *R�f:* " + (d.orderRef || 'N/A') + "\n";
            message += "��Ÿ?� *Date:* " + new Date().toLocaleDateString('fr-FR') + "\n\n";
            
            message += "��Ÿ? � *CLIENT*\n";
            message += "��� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� �\n";
            message += "Nom: " + (d.clientName || 'Non sp�cifi�') + "\n";
            if (d.clientPhone) message += "T�l: " + d.clientPhone + "\n";
            message += "��Ÿ? � Adresse: " + (d.address || 'Non sp�cifi�e') + "\n";
            if (d.deliveryTime) message += "�� � � Heure souhait�e: " + d.deliveryTime + "\n";
            message += "\n";
            
            message += "��Ÿ? � *ARTICLES �?� LIVRER*\n";
            message += "��� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� �\n";
            if (orderItems.length > 0) {
                orderItems.forEach((item, idx) => {
                    message += (idx + 1) + ". " + item.name + "\n";
                    message += "   Qt�: " + item.qty + " �?? " + CORE.formatPrice(item.price) + " = " + CORE.formatPrice(item.qty * item.price) + "\n";
                });
            } else {
                message += "(Aucun d�tail disponible)\n";
            }
            message += "\n";
            
            message += "��Ÿ? � *MONTANT TOTAL: " + CORE.formatPrice(d.amount) + "*\n\n";
            
            message += "��� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� �\n";
            message += "��š ��� � � Merci de confirmer la livraison une fois effectu�e.\n";
            message += "��Ÿ?ž Contact boutique: " + (pdv?.telephone || 'N/A');

            // Afficher modal pour saisir le num�ro WhatsApp
            UI.modal('��Ÿ? � Envoyer via WhatsApp', `
                <div class="space-y-4">
                    <div class="p-4 bg-green-50 border border-green-200 rounded-2xl">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                            </div>
                            <div>
                                <div class="font-black text-green-800">Envoyer �� un livreur ind�pendant</div>
                                <div class="text-sm text-green-600">Le bon de livraison sera envoy� via WhatsApp</div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Num�ro WhatsApp du livreur</label>
                        <input type="tel" id="whatsappNumber" placeholder="Ex: 06 12 34 56 78" class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-green-500 focus:ring-4 focus:ring-green-100 text-lg font-bold" autofocus>
                        <div class="mt-1 text-xs text-slate-500">Format: num�ro fran��ais (commen��ant par 0) ou international (+XX...)</div>
                    </div>
                    
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
                        <div class="text-xs font-bold text-slate-500 uppercase mb-2">Aper��u du message</div>
                        <div class="max-h-48 overflow-y-auto text-xs text-slate-700 whitespace-pre-wrap bg-white p-3 rounded-lg border border-slate-200">${message.replace(/\*/g, '').replace(/\n/g, '<br>')}</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="UI.closeModal()" class="px-4 py-3 rounded-xl bg-slate-100 text-slate-700 font-bold hover:bg-slate-200 transition">Annuler</button>
                        <button onclick="VendeurModule.openWhatsAppDelivery('${encodeURIComponent(message)}')" class="px-4 py-3 rounded-xl bg-green-500 text-white font-bold hover:bg-green-600 transition flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                            Envoyer
                        </button>
                    </div>
                </div>
            `, [], { maxWidth: 'max-w-lg' });
        },

        // Ouvrir WhatsApp avec le bon de livraison
        openWhatsAppDelivery(encodedMessage) {
            const phoneInput = document.getElementById('whatsappNumber');
            if (!phoneInput) return;

            let phone = phoneInput.value.trim().replace(/\s+/g, '').replace(/-/g, '');
            
            if (!phone) {
                UI.toast('Veuillez saisir un num�ro de t�l�phone', 'error');
                return;
            }

            // Convertir les num�ros fran��ais au format international
            if (phone.startsWith('0')) {
                phone = '33' + phone.substring(1);
            } else if (phone.startsWith('+')) {
                phone = phone.substring(1);
            }

            // V�rifier que le num�ro semble valide
            if (!/^\d{10,15}$/.test(phone)) {
                UI.toast('Format de num�ro invalide', 'error');
                return;
            }

            const message = decodeURIComponent(encodedMessage);
            const whatsappUrl = 'https://wa.me/' + phone + '?text=' + encodeURIComponent(message);
            
            window.open(whatsappUrl, '_blank');
            UI.closeModal();
            UI.toast('WhatsApp ouvert avec le bon de livraison', 'success');
        },

        showEditDeliveryModal(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;

            // getLivreursForSeller() appelle CORE.getLivreursForPOS() qui inclut d�j�� les livreurs ind�pendants approuv�s
            // Donc pas besoin d'ajouter getApprovedDeliveryMen() s�par�ment (�vite les doublons)
            const allLivreurs = this.getLivreursForSeller().filter(l => l.active).map(l => ({
                id: l.id,
                name: l.independent ? l.name + ' �� � �' : l.name,
                activeCount: l.activeCount || 0,
                isIndependent: l.independent || false
            }));
            
            // R�cup�rer la commande associ�e
            const order = d.orderId ? CORE.db.orders.find(o => o.id === d.orderId) : null;
            const orderItems = order?.items || [];

            UI.modal(`Modifier ${d.orderRef}`, `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    ${UI.input('edit_del_client','Client','text', d.clientName || '', 'Nom client', true)}
                    ${UI.input('edit_del_phone','T�l�phone','tel', d.clientPhone || '', '+242 ...', false)}
                    ${UI.input('edit_del_time','Heure de livraison','time', d.deliveryTime || '', '', false)}
                    ${UI.textarea('edit_del_address','Adresse', d.address || '', 'Adresse compl��te', 3)}

                    ${UI.select('edit_del_livreur','Livreur', allLivreurs.map(l => {
                        const c = l.activeCount || 0;
                        const statusTxt = c > 0 ? `(${c} en cours ��Ÿ� �)` : `(${c} en cours ��ŸŸ �)`;
                        return { value: l.id, label: `${l.name} ${statusTxt}` };
                    }), d.livreurId || '')}

                    ${UI.select('edit_del_status','Statut', [
                        { value: 'en_attente', label: '�?� assigner' },
                        { value: 'en_cours', label: 'En cours' },
                        { value: 'livree', label: 'Livr�e' },
                        { value: 'probleme', label: 'Probl��me' },
                        { value: 'annulee', label: 'Annul�e' }
                    ], d.status || 'en_cours')}

                    <!-- Produits de la commande -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="font-black text-blue-900 mb-3">��Ÿ? � Produits (${orderItems.length})</div>
                        ${orderItems.length === 0 ? `
                            <div class="text-xs text-blue-700">Aucun produit</div>
                        ` : `
                            <div class="space-y-2 max-h-48 overflow-y-auto">
                                ${orderItems.map((item, idx) => `
                                    <div class="flex items-center gap-2 p-2 bg-white rounded border border-blue-200">
                                        <div class="flex-1 text-xs">
                                            <div class="font-bold text-slate-900">${item.name}</div>
                                            <div class="text-blue-700">Qty: <strong>${item.qty}</strong> �?? ${CORE.formatPrice(item.price)}</div>
                                        </div>
                                        ${CORE.hasPermission('orders.edit') ? `<button onclick="VendeurModule.removeOrderItem(${order.id}, ${idx})" class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">���?�</button>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        `}
                        ${CORE.hasPermission('orders.edit') ? `<button onclick="VendeurModule.showAddProductToOrderModal(${order?.id || 0})" class="w-full mt-3 px-3 py-2 bg-blue-600 text-white text-xs font-black rounded hover:bg-blue-700">+ Ajouter produit</button>` : ''}
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">
                        Vous pouvez modifier une livraison m��me si elle est <b>annul�e</b> ou <b>rappel�e</b>.
                        ${d.recalledAt ? `<div class="mt-1">Dernier rappel: <b>${CORE.formatDate(d.recalledAt)}</b></div>` : ''}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 pt-2 border-t border-slate-100">
                        <button onclick="VendeurModule.saveDeliveryEdits(${d.id}, false, false)" class="py-3 px-4 bg-slate-100 text-slate-700 font-black rounded-xl hover:bg-slate-200 transition text-xs">
                            Enregistrer
                        </button>
                        <button onclick="VendeurModule.saveDeliveryEdits(${d.id}, false, true)" class="py-3 px-4 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition text-xs">
                            Enregistrer + R�assigner
                        </button>
                        <button onclick="VendeurModule.saveDeliveryEdits(${d.id}, true, false)" class="py-3 px-4 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition flex items-center justify-center gap-2 text-xs">
                            <i data-lucide="message-square" class="w-4 h-4"></i> Enregistrer + SMS
                        </button>
                    </div>

                    <div class="text-xs text-slate-500">Astuce: utilisez <b>Enregistrer + R�assigner</b> pour ouvrir directement la s�lection du livreur apr��s modification.</div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        removeOrderItem(orderId, itemIndex) {
            if (!CORE.hasPermission('orders.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const order = CORE.db.orders.find(o => o.id === orderId);
            if (!order || !order.items || !order.items[itemIndex]) {
                alert('Impossible de retirer cet article');
                return;
            }
            
            // Retirer l'article
            order.items.splice(itemIndex, 1);
            
            // Recalculer le total
            if (order.items.length > 0) {
                order.total = order.items.reduce((sum, item) => sum + (item.qty * item.price), 0);
            } else {
                order.total = 0;
            }
            
            // Sauvegarder
            CORE.save('orders', order, order.id);
            
            // Recharger le modal
            const delivery = CORE.db.deliveries.find(d => d.orderId === orderId);
            if (delivery) VendeurModule.showEditDeliveryModal(delivery.id);
            console.log(`Article ${itemIndex} retir� de la commande ${orderId}`);
        },

        showAddProductToOrderModal(orderId) {
            if (!CORE.hasPermission('orders.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const order = CORE.db.orders.find(o => o.id === orderId);
            if (!order) {
                alert('Commande introuvable');
                return;
            }

            const products = CORE.db.products || [];
            const userPos = CORE.user?.pos;
            const vendorProducts = products.filter(p => p.posId === userPos && p.active);

            if (vendorProducts.length === 0) {
                alert('Aucun produit disponible');
                return;
            }

            UI.modal('Ajouter un produit', `
                <div class="space-y-3">
                    <div class="text-xs text-slate-600 mb-3">S�lectionnez un produit �� ajouter �� cette commande</div>
                    
                    <div class="max-h-64 overflow-y-auto space-y-2">
                        ${vendorProducts.map(p => `
                            <div class="p-3 border border-slate-200 rounded-lg hover:border-slate-400 hover:bg-slate-50 cursor-pointer transition" onclick="VendeurModule.selectProductForOrder(${orderId}, ${p.id}, '${p.name.replace(/'/g, "\\'")}', ${p.price || 0})">
                                <div class="font-bold text-slate-900 text-sm">${p.name}</div>
                                <div class="text-xs text-blue-600 font-semibold">${CORE.formatPrice(p.price || 0)}</div>
                                ${p.sku ? `<div class="text-xs text-slate-500">SKU: ${p.sku}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>

                    <div class="text-xs text-slate-500 text-center p-3 bg-slate-50 rounded">
                        Cliquez sur un produit pour le s�lectionner et entrer la quantit�
                    </div>
                </div>
            `, false, true);
        },

        selectProductForOrder(orderId, productId, productName, productPrice) {
            if (!CORE.hasPermission('orders.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            UI.closeModal();

            const qty = prompt('Entrez la quantit�:', '1');
            if (!qty || isNaN(qty) || parseInt(qty) <= 0) {
                return;
            }

            const order = CORE.db.orders.find(o => o.id === orderId);
            if (!order) {
                alert('Commande introuvable');
                return;
            }

            // Initialiser items s'il n'existe pas
            if (!order.items) order.items = [];

            // V�rifier si le produit existe d�j��
            const existingItem = order.items.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.qty += parseInt(qty);
            } else {
                order.items.push({
                    productId: productId,
                    name: productName,
                    qty: parseInt(qty),
                    price: productPrice
                });
            }

            // Recalculer le total
            order.total = order.items.reduce((sum, item) => sum + (item.qty * item.price), 0);

            // Sauvegarder
            CORE.save('orders', order, order.id);

            // Recharger le modal
            const delivery = CORE.db.deliveries.find(d => d.orderId === orderId);
            if (delivery) VendeurModule.showEditDeliveryModal(delivery.id);
            console.log(`Produit ${productId} ajout� �� la commande ${orderId}`);
        },

        saveDeliveryEdits(deliveryId, sendSms = false, openAssign = false) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;

            const clientName = UI.val('edit_del_client').trim();
            const clientPhone = UI.val('edit_del_phone').trim();
            const deliveryTime = UI.val('edit_del_time').trim();
            const address = UI.val('edit_del_address').trim();
            const livreurId = parseInt(UI.val('edit_del_livreur') || '0', 10) || null;
            let status = UI.val('edit_del_status') || d.status;

            if (!clientName) return UI.toast('Nom client requis', 'warning');
            if (!address) return UI.toast('Adresse requise', 'warning');

            // Normalisation: si un livreur est s�lectionn� => la livraison devient "en_cours" (m��me si elle �tait annul�e/rappel�e)
            if (livreurId) {
                if (status !== 'livree') status = 'en_cours';
            } else {
                // Pas de livreur: on �vite un statut incoh�rent
                if (status === 'en_cours') status = 'en_attente';
            }

            // Update delivery
            const deliveryUpdates = { clientName, clientPhone, address, deliveryTime: deliveryTime || null, livreurId, status };
            // Si on r�active (en_cours), on efface les traces de rappel
            if (status === 'en_cours') {
                deliveryUpdates.recallReason = null;
                deliveryUpdates.recalledAt = null;
            }
            // Si annul�e, on force d�sassignation
            if (status === 'annulee') {
                deliveryUpdates.livreurId = null;
            }
            CORE.update('deliveries', d.id, deliveryUpdates);

            // Update linked order (client fields + statut)
            const o = CORE.db.orders.find(x => x.id === d.orderId);
            if (o) {
                CORE.update('orders', o.id, { clientName, clientPhone, clientAddress: address, deliveryTime: deliveryTime || null });
                if (o.status !== 'delivered') {
                    if (status === 'en_cours') CORE.update('orders', o.id, { status: 'delivering' });
                    if (status === 'en_attente') CORE.update('orders', o.id, { status: 'pending' });
                }
            }

            // If seller sets status to livree/probleme, sync order + ledger
            if (status === 'livree' || status === 'probleme') {
                this.setDeliveryStatusBySeller(d.id, status);
            }

            // Optional SMS to assigned driver
            const updatedDelivery = CORE.db.deliveries.find(x => x.id === d.id);
            const livreur = livreurId ? CORE.getUser(livreurId) : null;
            if (sendSms && livreur?.phone) {
                const msg = `MAJ Course ${updatedDelivery.orderRef}. Client: ${updatedDelivery.clientName}, ${updatedDelivery.clientPhone}. Adr: ${updatedDelivery.address}. Heure: ${updatedDelivery.deliveryTime || '�� ?��'}. A encaisser: ${CORE.formatPrice(updatedDelivery.amount)}.`;
                window.open(`sms:${livreur.phone}?body=${encodeURIComponent(msg)}`, '_blank');
            }

            UI.toast('Livraison mise �� jour', 'success');
            UI.closeModal();
            App.rerender();

            if (openAssign) {
                // Ouvre directement la modale d�� ?� ?�assignation apr��s l�� ?� ?�enregistrement
                setTimeout(() => {
                    try { VendeurModule.showAssignDeliveryModal(deliveryId); } catch(e) {}
                }, 0);
            }

            if (livreurId && !sendSms) {
                UI.toast(`R�assign�e �� ${CORE.getUser(livreurId)?.name || 'livreur'}`, 'info');
            }
        },

        // Rappeler un bon de livraison d�j�� envoy� �� un livreur
        // Permet aussi de rappeler une livraison m��me si elle est "probleme".
        showRecallDeliveryModal(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;

            const livreur = d.livreurId ? CORE.getUser(d.livreurId) : null;
            const previous = d.previousLivreurId ? CORE.getUser(d.previousLivreurId) : null;
            
            // Afficher l'historique des rappels si existant
            const recallHistory = d.recallHistory || [];
            let historyHtml = '';
            if (recallHistory.length > 0) {
                historyHtml = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-2xl">
                        <div class="text-xs font-black text-red-600 uppercase tracking-wider mb-2">
                            ��š ��� � � Historique des rappels (${recallHistory.length})
                        </div>
                        <div class="space-y-2 max-h-32 overflow-y-auto">
                            ${recallHistory.map((r, idx) => {
                                const liv = r.livreurId ? CORE.getUser(r.livreurId) : null;
                                const dateStr = r.date ? new Date(r.date).toLocaleString('fr-FR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : '�� ?��';
                                return `
                                    <div class="p-2 bg-white rounded-xl border border-red-100 text-xs">
                                        <div class="flex items-center justify-between">
                                            <span class="font-bold text-red-700">#${idx + 1} - ${liv?.name || 'Livreur inconnu'}</span>
                                            <span class="text-slate-400">${dateStr}</span>
                                        </div>
                                        <div class="mt-1 text-slate-600">${r.reason || 'Aucune raison sp�cifi�e'}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            UI.modal(`Rappeler ${d.orderRef}`, `
                <div class="space-y-4">
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Bon de livraison</div>
                        <div class="mt-1 font-black text-slate-900">${d.orderRef}</div>
                        <div class="text-xs text-slate-500">Client: <b>${d.clientName || '�� ?��'}</b></div>
                        <div class="text-xs text-slate-500">Adresse: <b>${d.address || '�� ?��'}</b></div>
                        <div class="mt-2 text-xs text-slate-500">
                            Livreur actuel: <span class="font-bold text-red-600">${livreur?.name || 'Aucun'}</span>
                        </div>
                        ${previous ? `<div class="mt-1 text-xs text-slate-400">Pr�c�dent: ${previous.name}</div>` : ''}
                    </div>

                    ${historyHtml}

                    ${UI.select('recall_action','Action',[
                        { value: 'en_attente', label: 'Remettre en Dispatch (d�sassigner le livreur)' },
                        { value: 'annulee', label: 'Annuler d�finitivement la livraison' }
                    ], 'en_attente', true)}

                    ${UI.textarea('recall_reason','Raison du rappel', '', 'ex: client absent, erreur adresse, changement livreur...', 3)}

                    <div class="p-4 bg-amber-50 border border-amber-100 rounded-2xl text-xs text-amber-800">
                        <b>Attention :</b> Le livreur sera notifi� que la course lui est retir�e. La commande repassera en statut "En attente".
                    </div>
                </div>
            `, [
                { label: 'Retour', onclick: 'UI.closeModal()' },
                { label: 'Confirmer le Rappel', onclick: `VendeurModule.recallDelivery(${d.id})`, class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);
        },

        recallDelivery(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;

            const action = UI.val('recall_action') || 'en_attente';
            const reason = UI.val('recall_reason').trim();

            const previousLivreurId = d.livreurId || null;
            const previousLivreur = previousLivreurId ? CORE.getUser(previousLivreurId) : null;

            // Construire l'historique des rappels (ajouter cette entr�e)
            const recallHistory = Array.isArray(d.recallHistory) ? [...d.recallHistory] : [];
            recallHistory.push({
                date: new Date().toISOString(),
                livreurId: previousLivreurId,
                livreurName: previousLivreur?.name || null,
                reason: reason || null,
                action: action,
                recalledBy: CORE.state.currentUser?.id || null
            });

            // D�sassigner + changer le statut (on garde trace du livreur pr�c�dent + historique complet)
            CORE.update('deliveries', d.id, {
                status: action,
                previousLivreurId: previousLivreurId,
                livreurId: null,
                recallReason: reason || null,
                recalledAt: new Date().toISOString(),
                recallHistory: recallHistory,
                recallCount: recallHistory.length
            });

            // Synchroniser la commande li�e : Si on rappelle le bon, la commande n'est plus "en cours de livraison"
            const o = CORE.db.orders.find(x => x.id === d.orderId);
            if (o) {
                if (o.status !== 'delivered') {
                    // Force le statut en attente car il n'y a plus de livreur
                    CORE.update('orders', o.id, { status: 'pending' });
                }
            }

            // Notifier l'ancien livreur (si SMS possible)
            if (previousLivreur?.phone) {
                try {
                    const msg = `Rappel course ${d.orderRef}. Cette course vous a �t� retir�e. Raison: ${reason || '�� ?��'}.`;
                    // Ne force pas l'ouverture SMS automatiquement (pas souhait�). On garde juste une notification interne.
                    CORE.notify('info', `Livreur inform� (rappel): ${previousLivreur.name}`, { deliveryId: d.id, previousLivreurId });
                } catch(e) {}
            }

            UI.closeModal();
            UI.toast(`Bon de livraison rappel� (${recallHistory.length}x)`, 'success');
            CORE.notify('info', `Bon de livraison ${d.orderRef} rappel�${previousLivreur ? ` (d�sassign�: ${previousLivreur.name})` : ''} - Rappel #${recallHistory.length}`, { deliveryId: d.id, action, previousLivreurId, recallCount: recallHistory.length });
            App.rerender();
        },

        showSettingsModal() {
            const user = CORE.state.currentUser;
            console.log('showSettingsModal called, user:', user);
            if (!user) {
                console.log('No user found');
                return;
            }
            
            const posData = CORE.getPOS(user?.pos);
            const prefs = this.state.preferences;
            const currentTheme = this.state?.theme || 'light';

            UI.modal('', `
                <div class="relative -m-6">
                    <!-- Header avec gradient -->
                    <div class="bg-gradient-to-br from-emerald-500 via-emerald-600 to-teal-600 px-6 pt-4 pb-14 relative overflow-hidden">
                        <div class="absolute inset-0 bg-[url('data:image/svg+xml,%3Csvg width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cg fill=\"none\" fill-rule=\"evenodd\"%3E%3Cg fill=\"%23ffffff\" fill-opacity=\"0.05\"%3E%3Cpath d=\"M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E')] opacity-30"></div>
                        
                        <div class="relative flex items-center gap-3">
                            <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-2xl font-black text-white border-2 border-white/30 shadow-xl">
                                ${user.avatar || user.name.charAt(0).toUpperCase()}
                            </div>
                            <div class="flex-1">
                                <h2 class="text-xl font-black text-white drop-shadow-lg">${user.name}</h2>
                                <p class="text-emerald-100 font-medium text-xs">${posData?.name || 'Point de vente'}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="px-2 py-0.5 bg-white/20 backdrop-blur-sm rounded-full text-[10px] font-bold text-white capitalize">${user.role}</span>
                                    <span class="px-2 py-0.5 bg-white/20 backdrop-blur-sm rounded-full text-[10px] font-bold text-white flex items-center gap-1">
                                        <span class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span>
                                        En ligne
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="UI.closeModal()" class="absolute top-3 right-3 w-8 h-8 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-lg flex items-center justify-center text-white transition-all hover:scale-110">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <!-- Grille d'actions principales -->
                    <div class="bg-white -mt-12 mx-4 rounded-2xl shadow-xl border border-slate-100 p-4">
                        <div class="grid grid-cols-4 gap-3">
                            <button onclick="VendeurModule.showVendorProfileModalFromSettings(${user.id})" class="group p-4 rounded-xl bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 hover:shadow-lg hover:scale-105 transition-all flex flex-col items-center gap-2">
                                <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center shadow-lg shadow-blue-200 group-hover:shadow-xl">
                                    <i data-lucide="user" class="w-6 h-6 text-white"></i>
                                </div>
                                <span class="text-xs font-black text-blue-700">Profil</span>
                            </button>
                            <button onclick="VendeurModule.showEditVendorProfileModalFromSettings(${user.id})" class="group p-4 rounded-xl bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 hover:shadow-lg hover:scale-105 transition-all flex flex-col items-center gap-2">
                                <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center shadow-lg shadow-purple-200 group-hover:shadow-xl">
                                    <i data-lucide="edit-3" class="w-6 h-6 text-white"></i>
                                </div>
                                <span class="text-xs font-black text-purple-700">�diter</span>
                            </button>
                            <button onclick="VendeurModule.showDeliveryTemplatesModal()" class="group p-4 rounded-xl bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 hover:shadow-lg hover:scale-105 transition-all flex flex-col items-center gap-2">
                                <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center shadow-lg shadow-orange-200 group-hover:shadow-xl">
                                    <i data-lucide="receipt" class="w-6 h-6 text-white"></i>
                                </div>
                                <span class="text-xs font-black text-orange-700">Bons</span>
                            </button>
                            <button onclick="VendeurModule.showKPIsModal(${user.id})" class="group p-4 rounded-xl bg-gradient-to-br from-emerald-50 to-emerald-100 border border-emerald-200 hover:shadow-lg hover:scale-105 transition-all flex flex-col items-center gap-2">
                                <div class="w-12 h-12 bg-emerald-500 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-200 group-hover:shadow-xl">
                                    <i data-lucide="trending-up" class="w-6 h-6 text-white"></i>
                                </div>
                                <span class="text-xs font-black text-emerald-700">KPIs</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Contenu principal -->
                    <div class="p-4 space-y-4 max-h-[60vh] overflow-y-auto">
                        
                        <!-- Section Apparence -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center">
                                    <i data-lucide="palette" class="w-5 h-5 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-slate-800">${t('settings.theme')}</h3>
                                    <p class="text-xs text-slate-500">Personnalisez l'interface</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                ${[
                                    { id: 'light', icon: 'sun', label: t('settings.light'), color: 'amber' },
                                    { id: 'dark', icon: 'moon', label: t('settings.dark'), color: 'slate' },
                                    { id: 'auto', icon: 'monitor', label: t('settings.auto'), color: 'blue' }
                                ].map(theme => `
                                    <button onclick="VendeurModule.setTheme('${theme.id}')" class="p-3 rounded-xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${currentTheme === theme.id ? 'border-emerald-500 bg-emerald-50 shadow-lg shadow-emerald-100' : 'border-slate-200 hover:border-slate-300 hover:bg-slate-50'}">
                                        <i data-lucide="${theme.icon}" class="w-6 h-6 ${currentTheme === theme.id ? 'text-emerald-600' : 'text-slate-400'}"></i>
                                        <span class="text-xs font-bold ${currentTheme === theme.id ? 'text-emerald-700' : 'text-slate-600'}">${theme.label}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Section Langue -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-xl flex items-center justify-center">
                                    <i data-lucide="globe" class="w-5 h-5 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-slate-800">${t('settings.language')}</h3>
                                    <p class="text-xs text-slate-500">Langue de l'interface</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-5 gap-2">
                                ${[
                                    { code: 'fr', flag: '��Ÿ� ���Ÿ� �' },
                                    { code: 'en', flag: '��Ÿ� ���Ÿ� �' },
                                    { code: 'es', flag: '��Ÿ� ���Ÿ� �' },
                                    { code: 'pt', flag: '��Ÿ� ���Ÿ� �' },
                                    { code: 'de', flag: '��Ÿ� ���Ÿ� �' },
                                    { code: 'it', flag: '��Ÿ� ���Ÿ� �' },
                                    { code: 'ar', flag: '��Ÿ� ���Ÿ� �' },
                                    { code: 'zh', flag: '��Ÿ� ���Ÿ� �' },
                                    { code: 'ru', flag: '��Ÿ� ���Ÿ� �' }
                                ].map(lang => `
                                    <button onclick="VendeurModule.setLanguage('${lang.code}')" class="p-2 rounded-xl border-2 transition-all text-2xl hover:scale-110 ${prefs.language === lang.code ? 'border-blue-500 bg-blue-50 shadow-lg' : 'border-slate-200 hover:border-slate-300'}">
                                        ${lang.flag}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Section Notifications -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 bg-gradient-to-br from-rose-500 to-red-500 rounded-xl flex items-center justify-center">
                                    <i data-lucide="bell" class="w-5 h-5 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-slate-800">${t('settings.notifications')}</h3>
                                    <p class="text-xs text-slate-500">Alertes et sons</p>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50">
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg">��Ÿ��</span>
                                        <span class="text-sm font-bold text-slate-700">Notifications</span>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" ${prefs.notificationsEnabled ? 'checked' : ''} onchange="VendeurModule.state.preferences.notificationsEnabled = this.checked; VendeurModule.savePreferences()" class="sr-only peer">
                                        <div class="w-11 h-6 bg-slate-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-3 rounded-xl bg-slate-50">
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg">��Ÿ�Š</span>
                                        <span class="text-sm font-bold text-slate-700">Sons</span>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" ${prefs.soundEnabled ? 'checked' : ''} onchange="VendeurModule.state.preferences.soundEnabled = this.checked; VendeurModule.savePreferences()" class="sr-only peer">
                                        <div class="w-11 h-6 bg-slate-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section S�curit� -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl flex items-center justify-center">
                                    <i data-lucide="shield" class="w-5 h-5 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-slate-800">S�curit�</h3>
                                    <p class="text-xs text-slate-500">Mot de passe et confidentialit�</p>
                                </div>
                            </div>
                            <button onclick="VendeurModule.showChangePersonalPasswordModal()" class="w-full p-3 rounded-xl bg-amber-50 border border-amber-200 hover:bg-amber-100 transition flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="key" class="w-5 h-5 text-amber-600"></i>
                                    <span class="text-sm font-bold text-amber-700">Changer mon mot de passe</span>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-amber-400"></i>
                            </button>
                        </div>
                        
                        <!-- Section Validation Livraisons -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 bg-gradient-to-br from-teal-500 to-cyan-500 rounded-xl flex items-center justify-center">
                                    <i data-lucide="check-circle" class="w-5 h-5 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-slate-800">Validation livraisons</h3>
                                    <p class="text-xs text-slate-500">Preuves requises par les livreurs</p>
                                </div>
                            </div>
                            <button onclick="VendeurModule.showDeliveryValidationSettingsModal()" class="w-full p-3 rounded-xl bg-teal-50 border border-teal-200 hover:bg-teal-100 transition flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="settings-2" class="w-5 h-5 text-teal-600"></i>
                                    <span class="text-sm font-bold text-teal-700">Configurer les preuves requises</span>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-teal-400"></i>
                            </button>
                        </div>
                        
                        <!-- Section Infos -->
                        <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl p-4 text-white">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center text-xl font-black">${CORE.getCompanyName().charAt(0)}</div>
                                    <div>
                                        <div class="font-black">${CORE.getCompanyName()}</div>
                                        <div class="text-xs text-slate-400">v${CORE.config.version} �� ?� � POS: ${posData?.name || 'N/A'}</div>
                                    </div>
                                </div>
                                <span class="px-3 py-1 bg-emerald-500/20 text-emerald-400 rounded-full text-xs font-bold">���?? �?� jour</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer actions -->
                    <div class="p-4 border-t border-slate-100 flex justify-between items-center bg-slate-50">
                        <button onclick="App.logout()" class="px-4 py-2.5 bg-red-50 text-red-600 rounded-xl font-bold text-sm hover:bg-red-100 transition flex items-center gap-2 border border-red-200">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            ${t('menu.logout')}
                        </button>
                        <button onclick="VendeurModule.showPreferencesModal()" class="px-4 py-2.5 bg-slate-100 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-200 transition flex items-center gap-2">
                            <i data-lucide="settings-2" class="w-4 h-4"></i>
                            Plus d'options
                        </button>
                    </div>
                </div>
            `, [], { maxWidth: 'max-w-4xl', noPadding: true });
            
            setTimeout(() => lucide.createIcons(), 50);
        },

        openSettings() {
            this.showSettingsModal();
        },

        recordDeposit() {
            if (!CORE.hasPermission('finance.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const userPos = CORE.user?.pos;
            // FILTRER les livreurs par POS du vendeur
            const livreurOptions = CORE.getLivreursForPOS(userPos).map(u => ({ value: u.id, label: u.name }));
            const today = new Date().toISOString().split('T')[0];
            
            UI.modal('��Ÿ? � Enregistrer D�p��t Livreur', `
                <div class="space-y-4">
                    ${livreurOptions.length === 0 ? '<div class="p-4 bg-amber-50 border border-amber-200 rounded-xl text-amber-700 text-sm font-bold">��š ��� � � Aucun livreur disponible pour ce point de vente</div>' : ''}
                    ${UI.select('dep_livreur', 'Livreur', livreurOptions, '', true)}
                    ${UI.input('dep_date', 'Date', 'date', today, '', true)}
                    ${UI.input('dep_amount', 'Montant', 'number', '', 'ex: 50000', true)}
                    ${UI.input('dep_ordersCount', 'Nombre de commandes', 'number', '', 'ex: 5', true)}
                    ${UI.input('dep_ordersRef', 'R�f�rences commandes', 'text', '', 'ex: CMD001, CMD002', false)}
                    ${UI.textarea('dep_notes', 'Notes', '', 'facultatif')}
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-xl text-xs text-blue-700">
                        ��Ÿ? � S�lectionnez le livreur et la date pour remplissage automatique des commandes
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'VendeurModule.saveDeposit()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);

            // Ajouter event listener au select du livreur et �� la date
            setTimeout(() => {
                const livreurSelect = document.getElementById('dep_livreur');
                const dateInput = document.getElementById('dep_date');

                const fillOrdersData = () => {
                    const livreurId = parseInt(livreurSelect.value, 10);
                    const date = dateInput.value;

                    if (!livreurId || !date) return;

                    // Chercher les commandes livr�es par ce livreur �� cette date
                    const deliveries = (CORE.db.deliveries || []).filter(d => {
                        if (d.livreurId !== livreurId) return false;
                        const dDate = d.actualDeliveryDate || d.deliveryDate;
                        return dDate && dDate.split('T')[0] === date;
                    });

                    if (deliveries.length > 0) {
                        const ordersCount = deliveries.length;
                        const ordersRef = deliveries.map(d => d.orderRef).join(', ');
                        
                        document.getElementById('dep_ordersCount').value = ordersCount;
                        document.getElementById('dep_ordersRef').value = ordersRef;
                        
                        UI.toast(`${ordersCount} commande(s) trouv�e(s) pour cette date`, 'success');
                    } else {
                        document.getElementById('dep_ordersCount').value = '';
                        document.getElementById('dep_ordersRef').value = '';
                    }
                };

                if (livreurSelect) livreurSelect.addEventListener('change', fillOrdersData);
                if (dateInput) dateInput.addEventListener('change', fillOrdersData);
            }, 100);
        },

        saveDeposit() {
            if (!CORE.hasPermission('finance.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const livreurId = parseInt(UI.val('dep_livreur'), 10);
            const amount = parseFloat(UI.val('dep_amount')) || 0;
            const ordersCount = parseInt(UI.val('dep_ordersCount'), 10) || 0;
            const ordersRef = UI.val('dep_ordersRef');
            const notes = UI.val('dep_notes');
            const depositDate = UI.val('dep_date') || new Date().toISOString().split('T')[0];
            const vendeur = CORE.state.currentUser;
            const livreur = CORE.getUser(livreurId);

            if (!livreurId || !amount) return UI.toast('Veuillez remplir le livreur et le montant', 'warning');
            if (!livreur) return UI.toast('Livreur introuvable', 'error');
            if (amount < 0) return UI.toast('Le montant ne peut pas ��tre n�gatif', 'error');

            CORE.db.deposits = CORE.db.deposits || [];
            const deposit = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                depositDate,
                livreurId,
                livreurName: livreur.name,
                vendeurId: vendeur.id,
                vendeurName: vendeur.name,
                amount,
                ordersCount,
                ordersRef: ordersRef || '',
                posId: vendeur.pos || 1,
                notes: notes || '',
                status: 'enregistre'
            };

            CORE.db.deposits.push(deposit);
            CORE.save();
            
            // Log l'activit� (cr�e �� la fois activityLogs et auditLogs)
            CORE.logActivity('deposit', 'deposits', deposit.id, { 
                entityName: `D�p��t de ${livreur.name}`,
                description: `Montant: ${amount} FCFA, Commandes: ${ordersCount}`,
                amount: amount
            });

            UI.closeModal();
            UI.toast(`D�p��t de ${amount} FCFA enregistr�`, 'success');
            App.rerender();
        },

        showDepositsModal() {
            const deposits = CORE.db.deposits || [];
            const vendeur = CORE.state.currentUser;
            const userPos = CORE.user?.pos;
            // FILTRER par POS du vendeur
            const myDeposits = deposits.filter(d => d.vendeurId === vendeur.id && (d.posId == userPos || !d.posId));
            const totalAmount = myDeposits.reduce((sum, d) => sum + d.amount, 0);
            const totalOrders = myDeposits.reduce((sum, d) => sum + d.ordersCount, 0);

            const depositsHTML = myDeposits.length === 0 
                ? '<div class="text-center text-slate-400 py-8">Aucun d�p��t enregistr�</div>'
                : myDeposits.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(d => `
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl space-y-2">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center">
                                    <i data-lucide="user" class="w-5 h-5 text-emerald-700"></i>
                                </div>
                                <div>
                                    <div class="font-black text-slate-900">${d.livreurName}</div>
                                    <div class="text-xs text-slate-500">${new Date(d.timestamp).toLocaleDateString('fr-FR')}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-black text-emerald-600 text-lg">${d.amount.toLocaleString()} F</div>
                                <div class="text-xs text-slate-500">${d.ordersCount} commande(s)</div>
                            </div>
                        </div>
                        ${d.ordersRef ? `<div class="text-xs text-slate-600">Commandes: ${d.ordersRef}</div>` : ''}
                        ${d.notes ? `<div class="text-xs text-slate-600 italic">Note: ${d.notes}</div>` : ''}
                        ${CORE.hasPermission('finance.edit') ? `
                            <div class="flex gap-2 pt-2">
                                <button onclick="VendeurModule.deleteDeposit(${d.id})" class="flex-1 px-3 py-1 bg-red-50 text-red-600 text-xs font-black rounded-lg hover:bg-red-100 transition">Supprimer</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('');

            UI.modal('��Ÿ? � Historique des D�p��ts', `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                            <div class="text-xs text-emerald-600 font-black uppercase mb-1">Total D�p��ts</div>
                            <div class="text-2xl font-black text-emerald-700">${totalAmount.toLocaleString()} F</div>
                        </div>
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl">
                            <div class="text-xs text-blue-600 font-black uppercase mb-1">Total Commandes</div>
                            <div class="text-2xl font-black text-blue-700">${totalOrders}</div>
                        </div>
                    </div>
                    <div class="border-t border-slate-200 pt-4">
                        <div class="text-xs font-black text-slate-600 uppercase mb-3">D�tail des d�p��ts</div>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            ${depositsHTML}
                        </div>
                    </div>
                </div>
            `, [
                ...(CORE.hasPermission('finance.edit') ? [{ label: 'Nouveau D�p��t', onclick: 'VendeurModule.recordDeposit()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }] : []),
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        deleteDeposit(depositId) {
            if (!CORE.hasPermission('finance.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            if (!confirm('�?Štes-vous s��r de vouloir supprimer ce d�p��t?')) return;
            CORE.db.deposits = CORE.db.deposits.filter(d => d.id !== depositId);
            CORE.save();
            CORE.logActivity('delete', 'deposits', depositId, 'D�p��t supprim�');
            UI.toast('D�p��t supprim�', 'success');
            this.showDepositsModal();
        },

        toggleLivreurActive(livreurId) {
            const l = CORE.getUser(livreurId);
            if (!l || l.role !== 'livreur') return;
            CORE.update('users', l.id, { active: !l.active });
            UI.toast(!l.active ? 'Livreur d�sactiv�' : 'Livreur activ�', 'info');
            App.rerender();
        },

        copyToClipboard(text) {
            if (!text) return UI.toast('Aucune donn�e �� copier', 'warning');
            if (navigator.clipboard?.writeText) {
                navigator.clipboard.writeText(text).then(() => UI.toast('Copi�', 'success')).catch(() => UI.toast('Impossible de copier', 'error'));
            } else {
                // fallback
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                try { document.execCommand('copy'); UI.toast('Copi�', 'success'); }
                catch { UI.toast('Impossible de copier', 'error'); }
                ta.remove();
            }
        },

        callLivreur(livreurId) {
            // Supporter les livreurs ind�pendants
            const isIndependent = typeof livreurId === 'string' && livreurId.startsWith('idm_');
            let l = null;
            if (isIndependent) {
                l = CORE.db.independentDeliveryMen.find(dm => dm.id === livreurId);
            } else {
                l = CORE.getUser(livreurId);
            }
            const phone = (l?.phone || '').trim();
            if (!phone) return UI.toast('Num�ro de t�l�phone manquant', 'warning');
            // Sur mobile, tel: ouvrira l'application T�l�phone
            window.location.href = `tel:${phone}`;
        },

        showEditLivreurModal(livreurId) {
            const l = CORE.getUser(livreurId);
            if (!l || l.role !== 'livreur') return;
            UI.modal(`Modifier le livreur`, `
                <div class="space-y-4">
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Livreur</div>
                        <div class="mt-1 font-black text-slate-900">${l.name}</div>
                    </div>

                    ${UI.input('edit_livreur_phone','Num�ro de t�l�phone','tel', l.phone || '', '+242 ...', true)}
                    <div class="text-xs text-slate-500">Le vendeur peut <b>modifier</b> ce num�ro pour pouvoir appeler le livreur.</div>

                    ${UI.select('edit_livreur_vehicle','V�hicule',[{value:'moto',label:'Moto'},{value:'voiture',label:'Voiture'},{value:'velo',label:'V�lo'},{value:'',label:'�� ?��'}], l.vehicle || '')}
                    ${UI.input('edit_livreur_rating','Note (0-5)','number', l.rating ?? '', 'ex: 4.8')}

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">
                        Astuce: apr��s modification, utilisez <b>Copier</b> ou <b>Appeler</b> depuis la liste.
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: `VendeurModule.saveLivreur(${l.id})`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        saveLivreur(livreurId) {
            const l = CORE.getUser(livreurId);
            if (!l || l.role !== 'livreur') return;
            const phoneRaw = UI.val('edit_livreur_phone').trim();
            const vehicle = UI.val('edit_livreur_vehicle').trim();
            const ratingRaw = UI.val('edit_livreur_rating');
            const rating = ratingRaw === '' ? null : Utils.clamp(parseFloat(ratingRaw), 0, 5);

            if (!phoneRaw) return UI.toast('T�l�phone requis', 'warning');

            // Normalisation + validation l�g��re (�vite les num�ros vides / trop courts)
            const phone = phoneRaw.replace(/\s+/g, ' ').trim();
            const digits = phone.replace(/[^0-9]/g, '');
            if (digits.length < 7) return UI.toast('Num�ro de t�l�phone invalide', 'warning');

            CORE.update('users', l.id, { phone, vehicle: vehicle || null, rating: rating ?? l.rating ?? null });
            UI.closeModal();
            UI.toast('T�l�phone du livreur mis �� jour', 'success');
            App.rerender();
        },

        renderLivreurRow(l) {
            const badge = !l.active ? UI.badge('Inactif', 'slate') : (l.activeCount || 0) > 0 ? UI.badge('En course', 'amber') : UI.badge('Disponible', 'emerald');
            const vehicle = l.vehicle ? `<div class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">${l.vehicle}</div>` : '';
            
            // D�tecter si c'est un livreur ind�pendant (ID string vs number)
            const isIndependent = typeof l.id === 'string' && l.id.startsWith('idm_');
            const livreurIdStr = isIndependent ? `'${l.id}'` : l.id;
            const dm = isIndependent ? CORE.db.independentDeliveryMen.find(x => x.id === l.id) : null;
            const displayName = dm?.name || l.name;
            const phone = (dm?.phone || l.phone || '').trim();

            const phoneLine = phone ? `
                <button onclick="VendeurModule.callLivreur(${livreurIdStr})" class="mt-1 text-xs text-slate-600 flex items-center gap-2 hover:text-emerald-700 transition" title="Appeler">
                    <i data-lucide="phone" class="w-3.5 h-3.5 text-slate-400"></i>
                    <span class="font-bold underline decoration-dotted underline-offset-2">${phone}</span>
                </button>
            ` : `
                <div class="mt-1 text-xs text-amber-700 flex items-center gap-2">
                    <i data-lucide="alert-triangle" class="w-3.5 h-3.5"></i>
                    <span class="font-bold">T�l�phone manquant</span>
                </div>
            `;

            const editLabel = phone ? 'Modifier t�l�phone' : 'Ajouter t�l�phone';
            
            // Pour les livreurs ind�pendants, utiliser editIndependentDeliveryMan
            const editButton = isIndependent 
                ? `<button onclick="VendeurModule.editIndependentDeliveryMan(${livreurIdStr})" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-50">Modifier</button>`
                : `<button onclick="VendeurModule.showEditLivreurModal(${livreurIdStr})" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-50">${editLabel}</button>`;

            return `
                <div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 flex items-start justify-between gap-4">
                    <div class="flex items-start gap-3 min-w-0">
                        <div class="w-12 h-12 ${isIndependent ? 'bg-gradient-to-br from-purple-500 to-indigo-600' : 'gradient-livreur'} rounded-2xl flex items-center justify-center text-white font-black shrink-0">${l.avatar || (l.name||'?').slice(0,2).toUpperCase()}</div>
                        <div class="min-w-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                <div class="font-black text-slate-900 truncate">${displayName}</div>
                                ${badge}
                                ${isIndependent ? UI.badge('Ind�pendant', 'purple') : ''}
                            </div>
                            <div class="mt-1 grid grid-cols-2 gap-x-4 gap-y-1">
                                <div class="text-xs text-slate-500">Note: <span class="font-black">${l.rating || '�� ?��'}</span></div>
                                <div class="text-xs text-slate-500">Courses: <span class="font-black">${l.deliveryCount || '�� ?��'}</span></div>
                                <div class="text-xs text-slate-500 col-span-2">En cours: <span class="font-black">${l.activeCount ?? 0}</span></div>
                            </div>
                            ${vehicle}
                            ${phoneLine}
                            ${l.activeDelivery ? `<div class="mt-1 text-[11px] text-slate-600">Course: <b>${l.activeDelivery.orderRef}</b></div>` : ''}

                            <div class="mt-3 flex flex-wrap gap-2">
                                ${editButton}
                                <button onclick="VendeurModule.copyToClipboard('${(phone || '').replace(/'/g, '&#39;')}')" class="px-3 py-2 rounded-xl bg-slate-100 text-xs font-black text-slate-700 hover:bg-slate-200">Copier</button>
                                <button onclick="VendeurModule.callLivreur(${livreurIdStr})" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700">Appeler</button>
                            </div>
                        </div>
                    </div>

                    <div class="text-right space-y-2 shrink-0">
                        ${isIndependent ? '' : `
                        <button onclick="VendeurModule.toggleLivreurActive(${livreurIdStr})" class="px-3 py-2 rounded-xl ${l.active ? 'bg-slate-100 text-slate-700 hover:bg-slate-200' : 'bg-emerald-600 text-white hover:bg-emerald-700'} text-xs font-black transition">
                            ${l.active ? 'D�sactiver' : 'Activer'}
                        </button>
                        `}
                        ${l.activeDelivery ? `<button onclick="VendeurModule.showDeliveryDetailModal(${l.activeDelivery.id})" class="w-full px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-50">D�tails course</button>` : `<button onclick="UI.toast('Aucune course en cours', 'info')" class="w-full px-3 py-2 rounded-xl bg-slate-100 text-xs font-black text-slate-600">�� ?��</button>`}
                    </div>
                </div>`;
        },

        renderReservations() {
            const userPos = CORE.user?.pos;
            if (!userPos) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assign�</div></div>`;
            }
            
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'POS ' + userPos;
            const q = (document.getElementById('reservations-search-input')?.value || '').toLowerCase().trim();
            const st = this.state.reservationsStatus || 'all';

            let res = CORE.db.deliveries
                .filter(d => d.status === 'reservation' && (!d.posId || d.posId == userPos))
                .sort((a,b)=> {
                    const ad = (a.deliveryDate || a.createdAt || '');
                    const bd = (b.deliveryDate || b.createdAt || '');
                    return String(ad).localeCompare(String(bd));
                });

            if (q) {
                res = res.filter(d =>
                    (d.orderRef || '').toLowerCase().includes(q) ||
                    (d.clientName || '').toLowerCase().includes(q) ||
                    (d.address || '').toLowerCase().includes(q)
                );
            }

            // filtre simple: all | today | upcoming
            const todayKey = Utils.todayKey();
            if (st === 'today') {
                res = res.filter(d => (d.deliveryDate || '').startsWith(todayKey));
            }
            if (st === 'upcoming') {
                res = res.filter(d => {
                    const dd = (d.deliveryDate || '').trim();
                    return dd && dd >= todayKey;
                });
            }

            return `
                <div class="fade-in max-w-6xl mx-auto space-y-6">
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">R�servations</h2>
                            <p class="text-slate-500 font-medium">${posName} - Livraisons futures (non assign�es)</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                <input id="reservations-search-input" type="text" value="${this.state.reservationsSearch}" onkeyup="VendeurModule.updateReservationsSearch(this.value)" placeholder="Ref, client, adresse..." class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="direction: ltr; text-align: left;" autocomplete="off">
                            </div>
                            <select onchange="VendeurModule.state.reservationsStatus=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                ${[
                                    {value:'all',label:'Toutes'},
                                    {value:'today',label:"Aujourd'hui"},
                                    {value:'upcoming',label:'�?� venir'}
                                ].map(o=>`<option value="${o.value}" ${o.value===this.state.reservationsStatus?'selected':''}>${o.label}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <div class="text-sm font-black text-slate-700">${res.length} r�servation(s)</div>
                            <button onclick="VendeurModule.showReservationModal()" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-black hover:bg-emerald-700 transition text-xs">Nouvelle r�servation</button>
                        </div>
                        <div class="p-4 space-y-2">
                            ${res.length === 0 ? `<div class="p-10 text-center text-slate-400 font-medium">Aucune r�servation</div>` : ''}
                            ${res.map(d => {
                                const when = (d.deliveryDate ? d.deliveryDate : '�� ?��') + (d.deliveryTime ? ' ' + d.deliveryTime : '');
                                return `
                                <div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 flex items-start justify-between gap-4">
                                    <div class="min-w-0">
                                        <div class="flex items-center gap-2 flex-wrap">
                                            <div class="font-black text-slate-900">${d.orderRef}</div>
                                            ${UI.badge('R�servation', 'purple')}
                                        </div>
                                        <div class="text-xs text-slate-500 truncate">${d.clientName || '�� ?��'} �� ?� � ${d.address || '�� ?��'}</div>
                                        <div class="mt-1 text-xs text-emerald-700 font-black">Pr�vu: ${when}</div>
                                    </div>
                                    <div class="text-right shrink-0">
                                        <div class="font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                                        <div class="mt-2 flex flex-wrap gap-2 justify-end">
                                            <button onclick="VendeurModule.showEditDeliveryModal(${d.id})" class="px-3 py-2 rounded-xl bg-slate-100 text-xs font-black text-slate-700 hover:bg-slate-200">Modifier</button>
                                            <button onclick="VendeurModule.showAssignDeliveryModal(${d.id})" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-black hover:bg-slate-800">Assigner</button>
                                            <button onclick="VendeurModule.showAssignDeliveryModal(${d.id});UI.toast('S�lectionnez le livreur puis cliquez sur SMS', 'info')" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700">Assigner + SMS</button>
                                        </div>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        },

        renderClients() {
            const user = CORE.state.currentUser;
            const userPos = CORE.user?.pos;
            
            // D�terminer les clients �� afficher selon le r��le
            let clients = [];
            let posName = '';
            let allClientsForStats = [];
            
            if (user?.role === 'pdg' || user?.role === 'manager') {
                // PDG/Manager: voir tous les clients
                clients = CORE.db.clients || [];
                posName = 'Tous les POS';
                allClientsForStats = clients;
            } else {
                // Autres r��les: voir les clients du POS assign� seulement
                if (!userPos) {
                    return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assign�</div></div>`;
                }
                const posData = CORE.getPOS(userPos);
                posName = posData?.name || 'POS ' + userPos;
                clients = (CORE.db.clients || []).filter(c => c.posId == userPos);
                allClientsForStats = clients;
            }
            
            const q = (document.getElementById('vendeur-clients-search-input')?.value || '').toLowerCase().trim();
            clients = clients
                .filter(c => !q || (c.name || '').toLowerCase().includes(q) || (c.phone || '').toLowerCase().includes(q) || (c.address || '').toLowerCase().includes(q))
                .sort((a, b) => {
                    const aVip = (a.segment === 'vip') ? 0 : 1;
                    const bVip = (b.segment === 'vip') ? 0 : 1;
                    if (aVip !== bVip) return aVip - bVip;
                    return new Date(b.lastPurchaseDate || 0) - new Date(a.lastPurchaseDate || 0);
                });

            const totalClients = allClientsForStats.length;
            const vipClients = allClientsForStats.filter(c => c.segment === 'vip').length;
            const totalSpent = allClientsForStats.reduce((a, c) => a + (c.totalSpent || 0), 0);
            const avgSpent = totalClients > 0 ? Math.round(totalSpent / totalClients) : 0;

            return `
                <div class="fade-in max-w-6xl mx-auto space-y-6 pb-20">
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h1 class="text-3xl font-black text-slate-800">Gestion des Clients</h1>
                            <p class="text-slate-500 font-medium">${posName} - ${totalClients} client(s)</p>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="VendeurModule.showNewClientModal()" class="px-6 py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-700 transition flex items-center gap-2">
                                <i data-lucide="plus" class="w-5 h-5"></i> Nouveau client
                            </button>
                            <button onclick="VendeurModule.showClientPickerModal()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition flex items-center gap-2">
                                <i data-lucide="search" class="w-5 h-5"></i> S�lectionner
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-3xl p-5 border border-blue-200">
                            <div class="text-xs text-blue-600 font-black uppercase tracking-wider mb-2">Total Clients</div>
                            <div class="text-3xl font-black text-blue-700">${totalClients}</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-3xl p-5 border border-purple-200">
                            <div class="text-xs text-purple-600 font-black uppercase tracking-wider mb-2">Clients VIP</div>
                            <div class="text-3xl font-black text-purple-700">${vipClients}</div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-green-50 rounded-3xl p-5 border border-emerald-200">
                            <div class="text-xs text-emerald-600 font-black uppercase tracking-wider mb-2">Total D�pens�</div>
                            <div class="text-3xl font-black text-emerald-700">${CORE.formatPrice(totalSpent).split(' ')[0]}</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-3xl p-5 border border-amber-200">
                            <div class="text-xs text-amber-600 font-black uppercase tracking-wider mb-2">Moyenne/Client</div>
                            <div class="text-3xl font-black text-amber-700">${CORE.formatPrice(avgSpent).split(' ')[0]}</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                            <div>
                                <h2 class="font-black text-slate-900">Tous les clients</h2>
                                <p class="text-xs text-slate-500 mt-1">Cliquez sur un client pour voir ses d�tails et modifier ses param��tres</p>
                            </div>
                            <div class="relative">
                                <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                <input id="vendeur-clients-search-input" type="text" value="${this.state.clientsSearch || ''}" onkeyup="VendeurModule.updateClientsSearch(this.value)" placeholder="Nom, t�l�phone, adresse..." class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium" style="direction: ltr; text-align: left;" autocomplete="off">
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50 border-b border-slate-200">
                                    <tr class="text-xs font-black text-slate-600 uppercase tracking-wider">
                                        <th class="px-6 py-3 text-left">Nom</th>
                                        <th class="px-6 py-3 text-left">T�l�phone</th>
                                        <th class="px-6 py-3 text-left">Adresse</th>
                                        <th class="px-6 py-3 text-right">Commandes</th>
                                        <th class="px-6 py-3 text-right">Total D�pens�</th>
                                        <th class="px-6 py-3 text-center">Segment</th>
                                        <th class="px-6 py-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${clients.length === 0 ? `
                                        <tr>
                                            <td colspan="7" class="px-6 py-10 text-center text-slate-400 font-medium">
                                                Aucun client trouv�. <a href="javascript:VendeurModule.showNewClientModal()" class="text-blue-600 font-bold hover:underline">Cr�er un nouveau client</a>
                                            </td>
                                        </tr>
                                    ` : ''}
                                    ${clients.map(c => {
                                        const orders = CORE.db.orders.filter(o => o.clientId === c.id && o.status === 'delivered');
                                        const totalSpent = orders.reduce((a, o) => a + (o.total || 0), 0);
                                        const isFavorite = this.isFavoriteClient(c.id);
                                        const tags = c.tags || [];
                                        const availableTags = CORE.db.clientTags || [];
                                        
                                        return `
                                            <tr class="hover:bg-slate-50 transition">
                                                <td class="px-6 py-4">
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-300 to-slate-400 flex items-center justify-center text-white font-black text-sm">
                                                            ${c.name.charAt(0).toUpperCase()}
                                                        </div>
                                                        <div>
                                                            <div class="font-bold text-slate-900">${c.name}</div>
                                                            ${c.segment === 'vip' ? '<span class="text-xs font-black text-purple-600 bg-purple-50 px-2 py-0.5 rounded-full">VIP</span>' : ''}
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 text-slate-700 font-medium">${c.phone || '�� ?��'}</td>
                                                <td class="px-6 py-4 text-slate-600 text-sm">${c.address || '�� ?��'}</td>
                                                <td class="px-6 py-4 text-right font-bold text-slate-900">${orders.length}</td>
                                                <td class="px-6 py-4 text-right font-bold text-emerald-600">${CORE.formatPrice(totalSpent)}</td>
                                                <td class="px-6 py-4 text-center">
                                                    ${c.segment === 'vip' ? '<span class="text-xs font-black bg-purple-100 text-purple-700 px-3 py-1 rounded-full">VIP</span>' : 
                                                      c.segment === 'regular' ? '<span class="text-xs font-black bg-blue-100 text-blue-700 px-3 py-1 rounded-full">R�gulier</span>' : 
                                                      '<span class="text-xs font-black bg-slate-100 text-slate-700 px-3 py-1 rounded-full">Standard</span>'}
                                                </td>
                                                <td class="px-6 py-4 text-center">
                                                    <div class="flex items-center justify-center gap-2">
                                                        <button onclick="VendeurModule.toggleFavoriteClient(${c.id})" class="px-2 py-1 rounded text-sm font-bold hover:bg-yellow-50 transition" title="Ajouter/retirer des favoris">
                                                            ${isFavorite ? '�� � �' : '���?�'}
                                                        </button>
                                                        <button onclick="VendeurModule.showClientHistoryModal(${c.id})" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-200 transition">Historique</button>
                                                        <button onclick="VendeurModule.showClientNotesModal(${c.id})" class="px-3 py-1 bg-purple-100 text-purple-700 rounded-lg text-xs font-bold hover:bg-purple-200 transition">Notes</button>
                                                        <button onclick="VendeurModule.showClientTagsModal(${c.id})" class="px-3 py-1 bg-amber-100 text-amber-700 rounded-lg text-xs font-bold hover:bg-amber-200 transition">Classer</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        },

        livreursSearchTimer: null,
        updateOrdersSearch(value) {
            // Mettre �� jour le state
            this.state.ordersSearch = value;
            
            // Annuler le timer pr�c�dent
            if (this.ordersSearchTimer) clearTimeout(this.ordersSearchTimer);
            
            // Attendre 500ms avant de rerender pour laisser l'utilisateur taper
            this.ordersSearchTimer = setTimeout(() => {
                // Sauvegarder la position du curseur avant rerender
                const input = document.getElementById('orders-search-input');
                const cursorPos = input?.selectionStart || 0;
                
                // Rerender
                App.rerender();
                
                // Restaurer la position du curseur apr��s rerender
                setTimeout(() => {
                    const newInput = document.getElementById('orders-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updatePOSSearch(value) {
            // Mettre �� jour le state
            this.state.searchQuery = value;
            
            // Annuler le timer pr�c�dent
            if (this.posSearchTimer) clearTimeout(this.posSearchTimer);
            
            // Attendre 500ms avant de rerender pour laisser l'utilisateur taper
            this.posSearchTimer = setTimeout(() => {
                // Sauvegarder la position du curseur avant rerender
                const input = document.getElementById('pos-search-input');
                const cursorPos = input?.selectionStart || 0;
                
                // Rerender
                this.navigateTo('pos');
                
                // Restaurer la position du curseur apr��s rerender
                setTimeout(() => {
                    const newInput = document.getElementById('pos-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateReservationsSearch(value) {
            // Mettre �� jour le state
            this.state.reservationsSearch = value;
            
            // Annuler le timer pr�c�dent
            if (this.reservationsSearchTimer) clearTimeout(this.reservationsSearchTimer);
            
            // Attendre 500ms avant de rerender pour laisser l'utilisateur taper
            this.reservationsSearchTimer = setTimeout(() => {
                // Sauvegarder la position du curseur avant rerender
                const input = document.getElementById('reservations-search-input');
                const cursorPos = input?.selectionStart || 0;
                
                // Rerender
                App.rerender();
                
                // Restaurer la position du curseur apr��s rerender
                setTimeout(() => {
                    const newInput = document.getElementById('reservations-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateClientsSearch(value) {
            // Mettre �� jour le state
            this.state.clientsSearch = value;
            
            // Annuler le timer pr�c�dent
            if (this.clientsSearchTimer) clearTimeout(this.clientsSearchTimer);
            
            // Attendre 500ms avant de rerender
            this.clientsSearchTimer = setTimeout(() => {
                const input = document.getElementById('vendeur-clients-search-input');
                const cursorPos = input?.selectionStart || 0;
                
                App.rerender();
                
                setTimeout(() => {
                    const newInput = document.getElementById('vendeur-clients-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateDeliveriesSearch(value) {
            // Mettre �� jour le state
            this.state.deliveriesSearch = value;
            
            // Annuler le timer pr�c�dent
            if (this.deliveriesSearchTimer) clearTimeout(this.deliveriesSearchTimer);
            
            // Attendre 500ms avant de rerender
            this.deliveriesSearchTimer = setTimeout(() => {
                const input = document.getElementById('vendeur-deliveries-search-input');
                const cursorPos = input?.selectionStart || 0;
                
                App.rerender();
                
                setTimeout(() => {
                    const newInput = document.getElementById('vendeur-deliveries-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateLivreursSearch(value) {
            // Mettre �� jour le state imm�diatement pour le filtre
            this.state.livreursSearch = value;
            
            // Annuler le timer pr�c�dent
            if (this.livreursSearchTimer) clearTimeout(this.livreursSearchTimer);
            
            // Attendre 300ms avant de rerender pour laisser l'utilisateur taper
            this.livreursSearchTimer = setTimeout(() => {
                App.rerender();
            }, 300);
        },

        renderLivreurs() {
            const userPos = CORE.user?.pos;
            if (!userPos) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assign�</div></div>`;
            }
            
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'POS ' + userPos;
            const q = (this.state.livreursSearch || '').toLowerCase().trim();
            let livreurs = this.getLivreursForSeller();
            if (q) livreurs = livreurs.filter(l => 
                (l.name || '').toLowerCase().includes(q) ||
                (l.email || '').toLowerCase().includes(q) ||
                (l.phone || '').toLowerCase().includes(q) ||
                (l.username || '').toLowerCase().includes(q)
            );

            const activeCount = livreurs.filter(l => l.active).length;
            const availableCount = livreurs.filter(l => l.active && !l.isBusy).length;
            const busyCount = livreurs.filter(l => l.active && l.isBusy).length;

            // courses (toutes selon filtre) - FILTR�ES PAR POS
            const dq = (document.getElementById('vendeur-deliveries-search-input')?.value || '').toLowerCase().trim();
            const ds = this.state.deliveriesStatus || 'all';
            let deliveriesInProgress = CORE.db.deliveries
                .filter(d => {
                    // Filtre par POS (inclure si posId manquant pour compatibilit�)
                    if (d.posId && d.posId != userPos) return false;
                    if (ds === 'all') return true;
                    if (ds === 'open') return ['en_cours','en_attente','probleme','reservation'].includes(d.status);
                    return d.status === ds;
                })
                .sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));

            if (dq) {
                deliveriesInProgress = deliveriesInProgress.filter(d =>
                    (d.orderRef || '').toLowerCase().includes(dq) ||
                    (d.clientName || '').toLowerCase().includes(dq) ||
                    (d.address || '').toLowerCase().includes(dq)
                );
            }

            return `
                <div class="fade-in max-w-6xl mx-auto space-y-6">
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">Livreurs</h2>
                            <p class="text-slate-500 font-medium">${posName} - Disponibilit�s et courses en cours</p>
                        </div>
                        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 flex-1 sm:flex-none">
                            <button onclick="VendeurModule.showIndependentDeliveryMenList()" class="px-4 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition flex items-center justify-center gap-2 text-sm whitespace-nowrap">
                                <i data-lucide="users" class="w-4 h-4"></i> Livreurs ind�pendants
                            </button>
                            <div class="relative flex-1 sm:flex-auto">
                                <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none"></i>
                                <input id="livreurs-search-input" placeholder="Saisissez le nom du livreur..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" type="text" autocomplete="off" onkeyup="VendeurModule.updateLivreursSearch(this.value)">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-3xl border border-slate-100 p-5">
                            <div class="text-xs text-slate-500 font-black uppercase tracking-wider">Livreurs actifs</div>
                            <div class="text-3xl font-black text-slate-900 mt-1">${activeCount}</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-100 p-5">
                            <div class="text-xs text-slate-500 font-black uppercase tracking-wider">Disponibles</div>
                            <div class="text-3xl font-black text-emerald-600 mt-1">${availableCount}</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-100 p-5">
                            <div class="text-xs text-slate-500 font-black uppercase tracking-wider">En course</div>
                            <div class="text-3xl font-black text-amber-600 mt-1">${busyCount}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                                <h3 class="font-black text-slate-900">�quipe de livraison</h3>
                                <div class="text-xs text-slate-400 font-bold">${livreurs.length} total</div>
                            </div>
                            <div class="p-4 space-y-2">
                                ${livreurs.length === 0 ? `
                                    <div class="p-10 text-center text-slate-400 font-medium">
                                        Aucun livreur trouv�.
                                        <div class="mt-2 text-xs">Astuce: ajoutez/activez un utilisateur avec le r��le <b>livreur</b> dans la base (demo).</div>
                                    </div>` : ''}
                                ${livreurs.map(l => this.renderLivreurRow(l)).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-slate-100 flex flex-col gap-3">
                                <div class="flex items-center justify-between">
                                    <h3 class="font-black text-slate-900">Bons de livraison</h3>
                                    <div class="text-xs text-slate-400 font-bold">${deliveriesInProgress.length}</div>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <select onchange="VendeurModule.state.deliveriesStatus=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold text-xs">
                                        ${[
                                            {value:'all',label:'Tous'},
                                            {value:'open',label:'Ouverts'},
                                            {value:'en_attente',label:'�?� assigner'},
                                            {value:'en_cours',label:'En cours'},
                                            {value:'probleme',label:'Probl��me'},
                                            {value:'livree',label:'Livr�e'},
                                            {value:'annulee',label:'Annul�e'}
                                        ].map(o => `<option value="${o.value}" ${o.value===VendeurModule.state.deliveriesStatus?'selected':''}>${o.label}</option>`).join('')}
                                    </select>
                                    <div class="relative">
                                        <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                        <input id="vendeur-deliveries-search-input" type="text" value="${this.state.deliveriesSearch}" onkeyup="VendeurModule.updateDeliveriesSearch(this.value)" placeholder="Rechercher bon..." class="pl-10 pr-4 py-2 rounded-xl border border-slate-200 bg-white font-medium text-xs w-[220px] max-w-full" style="direction: ltr; text-align: left;" autocomplete="off">
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 space-y-2">
                                ${deliveriesInProgress.length === 0 ? `<div class="p-10 text-center text-slate-400 font-medium">Aucune course en cours</div>` : ''}
                                ${deliveriesInProgress.map(d => {
                                    const badge = d.status === 'livree' ? UI.badge('Livr�e', 'emerald') :
                                                  d.status === 'probleme' ? UI.badge('Probl��me', 'red') :
                                                  d.status === 'en_attente' ? UI.badge('�?� assigner', 'blue') :
                                                  d.status === 'annulee' ? UI.badge('Annul�e', 'slate') :
                                                  UI.badge('En cours', 'amber');
                                    const isIndependentLivreur = d.livreurId && String(d.livreurId).startsWith('idm_');
                                    const livreurName = isIndependentLivreur 
                                        ? (CORE.db.independentDeliveryMen.find(dm => dm.id === d.livreurId)?.name || '�� ?��') + ' �� � �'
                                        : (CORE.getUser(d.livreurId)?.name || '�� ?��');
                                    const canRecall = d.livreurId && ['en_cours', 'probleme'].includes(d.status);
                                    const recalled = !!d.recalledAt;
                                    const recallCount = d.recallCount || (d.recallHistory?.length || 0);
                                    const isCancelled = d.status === 'annulee';
                                    const dId = d.id;
                                    
                                    return '<div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 flex items-start justify-between gap-4">' +
                                        '<div class="min-w-0">' +
                                        '<div class="flex items-center gap-2 flex-wrap">' +
                                        '<div class="font-black text-slate-900">' + d.orderRef + '</div>' +
                                        badge +
                                        (recallCount >= 2 ? UI.badge(recallCount + 'x rappel�', 'red') : (recalled ? UI.badge('Rappel�', 'amber') : '')) +
                                        '</div>' +
                                        '<div class="text-xs text-slate-500 truncate">' + d.clientName + ' �� ?� � ' + d.address + '</div>' +
                                        (d.deliveryTime ? '<div class="mt-1 text-xs text-emerald-700 font-black">Heure: ' + d.deliveryTime + '</div>' : '') +
                                        '<div class="mt-1 text-xs text-slate-400">Livreur: <span class="font-black text-slate-700">' + livreurName + '</span></div>' +
                                        (d.recallReason ? '<div class="mt-1 text-[11px] text-amber-800 truncate"><b>Rappel:</b> ' + d.recallReason + '</div>' : '') +
                                        '</div>' +
                                        '<div class="text-right shrink-0">' +
                                        '<div class="font-black text-emerald-600">' + CORE.formatPrice(d.amount) + '</div>' +
                                        '<div class="mt-2 flex flex-wrap gap-2 justify-end">' +
                                        (isIndependentLivreur ? '' : '<button onclick="VendeurModule.openChat(' + dId + ')" class="px-3 py-2 rounded-xl bg-indigo-50 text-indigo-600 border border-indigo-100 text-xs font-black hover:bg-indigo-100 flex items-center gap-1"><i data-lucide="message-circle" class="w-3 h-3"></i> Chat</button>') +
                                        '<button onclick="VendeurModule.showDeliveryDetailModal(' + dId + ')" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-50">D�tails</button>' +
                                        '<button onclick="VendeurModule.showEditDeliveryModal(' + dId + ')" class="px-3 py-2 rounded-xl bg-slate-100 text-xs font-black text-slate-700 hover:bg-slate-200">Modifier</button>' +
                                        '<button onclick="VendeurModule.showAssignDeliveryModal(' + dId + ')" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-black hover:bg-slate-800">' + (isCancelled ? 'R�activer' : 'R�assigner') + '</button>' +
                                        (canRecall ? '<button onclick="VendeurModule.showRecallDeliveryModal(' + dId + ')" class="px-3 py-2 rounded-xl bg-red-50 text-red-700 text-xs font-black hover:bg-red-100">Rappeler</button>' : '') +
                                        '</div>' +
                                        '</div>' +
                                        '</div>';
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>`;
        },

        renderRoutage() {
            const posId = CORE.user?.pos;
            if (!posId) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assign�</div></div>`;
            }
            
            const posData = CORE.getPOS(posId);
            const posName = posData?.name || 'POS ' + posId;
            const batch = RoutingEngine.suggestRouteBatch(posId, 15);
            
            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">��Ÿš? Routage & Charge</h2>
                            <p class="text-slate-500 font-medium">${posName} - �quilibrage automatique des livraisons</p>
                        </div>
                        <button onclick="RoutingEngine.autoAssignBatch(${posId}, 15); UI.toast('${batch.filter(b => b.suggestion).length} livraisons assign�es', 'success'); App.rerender()" class="px-4 py-3 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition flex items-center gap-2">
                            <i data-lucide="zap" class="w-5 h-5"></i> Assigner tout
                        </button>
                    </div>

                    <!-- Livraisons en attente -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 space-y-4">
                        <div class="flex items-center gap-2">
                            <h3 class="text-xl font-black text-slate-900">��Ÿ? � �?� Affecter (${batch.length})</h3>
                            ${batch.length > 0 ? `<span class="px-3 py-1 bg-amber-100 text-amber-700 text-xs font-black rounded-full">${batch.filter(b => !b.suggestion).length} sans suggestion</span>` : ''}
                        </div>
                        
                        ${batch.length === 0 ? `
                            <div class="p-10 text-center text-slate-400">
                                <i data-lucide="check-circle" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                <p class="font-bold">Toutes les livraisons sont assign�es ���??</p>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${batch.map((item, idx) => {
                                    const d = item.delivery;
                                    const s = item.suggestion;
                                    const order = CORE.db.orders.find(o => o.id === d.orderId);
                                    const isExpress = order?.tags?.includes('express');
                                    const isVip = order?.tags?.includes('vip');
                                    
                                    return `
                                        <div class="p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 transition flex items-start gap-4">
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="text-sm font-black text-slate-900">${d.orderRef}</span>
                                                    ${isExpress ? `<span class="px-2 py-0.5 bg-red-100 text-red-700 text-xs font-black rounded">EXPRESS</span>` : ''}
                                                    ${isVip ? `<span class="px-2 py-0.5 bg-purple-100 text-purple-700 text-xs font-black rounded">VIP</span>` : ''}
                                                    <span class="text-sm font-black text-amber-600">Pri: ${item.priority.toFixed(1)}</span>
                                                </div>
                                                <div class="text-xs text-slate-500">${d.clientName} �� ?� � ${d.address}</div>
                                                <div class="text-xs text-slate-400 mt-1">Montant: <b>${CORE.formatPrice(d.amount)}</b></div>
                                            </div>
                                            <div class="text-right shrink-0">
                                                ${s ? `
                                                    <div class="mb-2">
                                                        <div class="text-sm font-black text-emerald-700 mb-1">Sugg�r�:</div>
                                                        <div class="text-xs text-slate-600"><b>${s.name}</b></div>
                                                        <div class="text-xs text-slate-400">Charge: ${s.load.count}/${s.capacity}</div>
                                                    </div>
                                                    <button onclick="VendeurModule.assignDelivery(${d.id}, false); RoutingEngine.suggestRouteBatch(${posId}, 15); App.rerender()" class="w-full px-3 py-2 bg-emerald-600 text-white text-xs font-black rounded-lg hover:bg-emerald-700 transition">Assigner</button>
                                                ` : `
                                                    <div class="text-xs text-slate-400">
                                                        <i data-lucide="alert-circle" class="w-4 h-4 text-red-500 inline"></i> Aucun livreur disponible
                                                    </div>
                                                `}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>

                    <!-- Charge par livreur -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 space-y-4">
                        <h3 class="text-xl font-black text-slate-900">��Ÿ? � Charge par Livreur</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${RoutingEngine.getAvailableLivreurs(posId).map(l => {
                                const load = l.load;
                                const percent = Math.min(100, (load.count / l.capacity) * 100);
                                
                                return `
                                    <div class="p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 transition">
                                        <div class="font-bold text-slate-900 mb-2">${l.name}</div>
                                        <div class="text-xs text-slate-500 mb-3">${l.vehicle || 'N/A'}</div>
                                        <div class="flex items-center gap-2 mb-2">
                                            <div class="text-sm font-black text-slate-900">${load.count}/${l.capacity}</div>
                                            <div class="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
                                                <div class="h-full ${percent > 75 ? 'bg-red-500' : percent > 50 ? 'bg-amber-500' : 'bg-emerald-500'}" data-width="${percent}"></div>
                                            </div>
                                        </div>
                                        <div class="text-xs text-slate-500">Vol: <b>${CORE.formatPrice(load.volume)}</b></div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>`;
        },

        // =====================
        // FINANCE (Vendeur)
        // =====================
        renderFinance() {
            const uid = CORE.state.currentUser?.id;
            const view = CORE.state.financeView || 'overview';
            
            return view === 'overview' ? this.renderFinanceOverview() :
                   view === 'transactions' ? this.renderFinanceTransactions() :
                   view === 'statement' ? this.renderFinanceStatement() :
                   view === 'expenses' ? this.renderFinanceExpenses() :
                   view === 'income' ? this.renderFinanceIncome() :
                   view === 'budgets' ? this.renderFinanceBudgets() :
                   view === 'profitability' ? this.renderProfitabilityAnalysis() :
                   view === 'activity' ? this.renderFinanceActivity() : this.renderFinanceOverview();
        },

        renderFinanceOverview() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'Mon POS';
            const dateFrom = CORE.state.financeDateFrom || '';
            const dateTo = CORE.state.financeDateTo || '';
            
            const metrics = CORE.getFinancialMetrics(uid, dateFrom || null, dateTo || null, userPos);
            const cashFlow = CORE.getCashFlowByPeriod(uid, 'daily', userPos);
            const lastDays = Object.entries(cashFlow).slice(-7).map(([date, flow]) => ({
                date,
                ...flow
            }));

            // Calculer les taxes une fois
            const taxes = CORE.calculateTaxesOwed(uid, null, null, userPos);
            
            // Stats par type de transaction - FILTR� PAR POS
            let allTxs = CORE.db.financialTransactions?.filter(t => t.userId === uid && (t.posId == userPos || !t.posId)) || [];
            const incomeTxs = allTxs.filter(t => t.type === 'income');
            const expenseTxs = allTxs.filter(t => t.type === 'expense');
            
            // Stats par m�thode de paiement
            const orders = CORE.db.orders.filter(o => o.posId == userPos);
            const paymentMethods = {
                cash: orders.filter(o => o.paymentMethod === 'cash').reduce((s, o) => s + (o.total || 0), 0),
                mobile: orders.filter(o => o.paymentMethod === 'mobile').reduce((s, o) => s + (o.total || 0), 0),
                card: orders.filter(o => o.paymentMethod === 'card').reduce((s, o) => s + (o.total || 0), 0),
                cod: orders.filter(o => o.paymentMethod === 'cod').reduce((s, o) => s + (o.total || 0), 0)
            };
            const totalPayments = Object.values(paymentMethods).reduce((a, b) => a + b, 0) || 1;
            
            // COD en attente d'encaissement (livraisons COD valid�es mais pas encore encaiss�es)
            const codOutstandingOrders = CORE.db.orders.filter(o => 
                o.posId == userPos && 
                o.paymentMethod === 'cod' && 
                o.paymentStatus !== 'paid'
            );
            // Filtrer pour ne garder que celles qui ont �t� livr�es
            const codReadyToCollect = codOutstandingOrders.filter(o => {
                const delivery = CORE.db.deliveries.find(d => d.orderId === o.id);
                return delivery && delivery.status === 'livree';
            });
            const codOutstandingAmount = codReadyToCollect.reduce((sum, o) => sum + (o.total || 0), 0);
            
            // Top cat�gories de d�penses
            const expenseByCategory = {};
            expenseTxs.forEach(t => {
                const cat = t.category || 'autre';
                expenseByCategory[cat] = (expenseByCategory[cat] || 0) + (t.amount || 0);
            });
            const topExpenseCategories = Object.entries(expenseByCategory)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            // Derni��res transactions
            const recentTxs = [...allTxs].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="CORE.state.financeView = '${v}'; App.rerender()" class="px-4 py-2.5 rounded-xl font-bold text-sm transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-500/30' : 'bg-white text-slate-600 hover:bg-slate-50 border border-slate-200'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-6">
                    <!-- Header avec navigation -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-emerald-500/30">
                                    <i data-lucide="wallet" class="w-6 h-6"></i>
                                </div>
                                Finance & Comptabilit�
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">${posName} �� ?� � Suivi complet des flux financiers</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aper��u', 'layout-grid', true)}
                            ${navBtn('transactions', 'Transactions', 'list')}
                            ${navBtn('income', 'Revenus', 'trending-up')}
                            ${navBtn('expenses', 'D�penses', 'trending-down')}
                            ${navBtn('budgets', 'Budgets', 'pie-chart')}
                            ${navBtn('statement', '�tats', 'file-text')}
                        </div>
                    </div>

                    <!-- Filtres Date -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <div class="flex flex-wrap items-end gap-4">
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">P�riode du</label>
                                <input type="date" value="${dateFrom}" 
                                    onchange="CORE.state.financeDateFrom = this.value; App.rerender()"
                                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none font-medium">
                            </div>
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Au</label>
                                <input type="date" value="${dateTo}" 
                                    onchange="CORE.state.financeDateTo = this.value; App.rerender()"
                                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none font-medium">
                            </div>
                            <button onclick="CORE.state.financeDateFrom=''; CORE.state.financeDateTo=''; App.rerender()" class="px-4 py-2.5 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-200 transition">
                                R�initialiser
                            </button>
                            <button onclick="CORE.rebuildFinancialTransactions(); App.rerender()" class="px-4 py-2.5 bg-amber-500 text-white rounded-xl font-bold text-sm hover:bg-amber-600 transition flex items-center gap-2" title="R�g�n�rer les transactions �� partir des commandes et livraisons">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Actualiser
                            </button>
                            <button onclick="VendeurModule.exportFinanceReport()" class="px-4 py-2.5 bg-emerald-600 text-white rounded-xl font-bold text-sm hover:bg-emerald-700 transition flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> Exporter
                            </button>
                        </div>
                    </div>

                    <!-- KPIs Principaux -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-5 text-white shadow-lg shadow-emerald-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-up" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Revenus</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(metrics.totalIncome)}</div>
                                <div class="text-xs opacity-70 mt-2">${incomeTxs.length} entr�es</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl p-5 text-white shadow-lg shadow-red-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-down" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">D�penses</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(metrics.totalExpenses)}</div>
                                <div class="text-xs opacity-70 mt-2">${expenseTxs.length} sorties</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-5 text-white shadow-lg shadow-blue-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="bar-chart-3" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">B�n�fice Net</span>
                                </div>
                                <div class="text-3xl font-black">${metrics.netProfit >= 0 ? '+' : ''}${CORE.formatPrice(metrics.netProfit)}</div>
                                <div class="text-xs opacity-70 mt-2">Marge: ${metrics.profitMargin}%</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-5 text-white shadow-lg shadow-amber-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="receipt" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Imp��ts Est.</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(taxes.taxesOwed)}</div>
                                <div class="text-xs opacity-70 mt-2">Taux: ${taxes.taxRate}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Grille principale -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Colonne gauche: Cash Flow + R�partition paiements -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Cash Flow 7 Derniers Jours -->
                            <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-black text-slate-900 flex items-center gap-2">
                                        <i data-lucide="activity" class="w-5 h-5 text-emerald-500"></i>
                                        Cash Flow - 7 Derniers Jours
                                    </h3>
                                    <div class="flex items-center gap-4 text-xs">
                                        <span class="flex items-center gap-1"><span class="w-3 h-3 bg-emerald-500 rounded-full"></span> Entr�es</span>
                                        <span class="flex items-center gap-1"><span class="w-3 h-3 bg-red-500 rounded-full"></span> Sorties</span>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    ${lastDays.length === 0 ? '<div class="text-center py-8 text-slate-400">Aucune donn�e disponible</div>' : lastDays.map(day => {
                                        const maxVal = Math.max(...lastDays.map(d => Math.max(d.income || 0, d.expenses || 0))) || 1;
                                        const incomeWidth = ((day.income || 0) / maxVal) * 100;
                                        const expenseWidth = ((day.expenses || 0) / maxVal) * 100;
                                        return `
                                            <div class="flex items-center gap-4 group hover:bg-slate-50 p-2 rounded-xl transition">
                                                <div class="w-20 text-sm font-bold text-slate-600">${day.date}</div>
                                                <div class="flex-1 space-y-1">
                                                    <div class="flex items-center gap-2">
                                                        <div class="h-4 bg-gradient-to-r from-emerald-400 to-emerald-500 rounded-full transition-all" style="width: ${incomeWidth}%"></div>
                                                        <span class="text-xs font-bold text-emerald-600">+${CORE.formatPrice(day.income || 0)}</span>
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <div class="h-4 bg-gradient-to-r from-red-400 to-red-500 rounded-full transition-all" style="width: ${expenseWidth}%"></div>
                                                        <span class="text-xs font-bold text-red-600">-${CORE.formatPrice(day.expenses || 0)}</span>
                                                    </div>
                                                </div>
                                                <div class="text-right min-w-[80px]">
                                                    <div class="text-sm font-black ${(day.income || 0) - (day.expenses || 0) >= 0 ? 'text-emerald-600' : 'text-red-600'}">
                                                        ${(day.income || 0) - (day.expenses || 0) >= 0 ? '+' : ''}${CORE.formatPrice((day.income || 0) - (day.expenses || 0))}
                                                    </div>
                                                    <div class="text-[10px] text-slate-400">Solde</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>

                            <!-- R�partition par m�thode de paiement -->
                            <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                <h3 class="text-lg font-black text-slate-900 flex items-center gap-2 mb-6">
                                    <i data-lucide="credit-card" class="w-5 h-5 text-blue-500"></i>
                                    R�partition par M�thode de Paiement
                                </h3>
                                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div class="text-center p-4 bg-slate-50 rounded-xl">
                                        <div class="w-12 h-12 bg-slate-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                            <i data-lucide="banknote" class="w-6 h-6 text-slate-600"></i>
                                        </div>
                                        <div class="text-lg font-black text-slate-900">${CORE.formatPrice(paymentMethods.cash)}</div>
                                        <div class="text-xs text-slate-500 font-bold">Cash</div>
                                        <div class="text-[10px] text-slate-400">${Math.round((paymentMethods.cash / totalPayments) * 100)}%</div>
                                    </div>
                                    <div class="text-center p-4 bg-blue-50 rounded-xl">
                                        <div class="w-12 h-12 bg-blue-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                            <i data-lucide="smartphone" class="w-6 h-6 text-blue-600"></i>
                                        </div>
                                        <div class="text-lg font-black text-blue-900">${CORE.formatPrice(paymentMethods.mobile)}</div>
                                        <div class="text-xs text-blue-700 font-bold">Mobile Money</div>
                                        <div class="text-[10px] text-blue-500">${Math.round((paymentMethods.mobile / totalPayments) * 100)}%</div>
                                    </div>
                                    <div class="text-center p-4 bg-indigo-50 rounded-xl">
                                        <div class="w-12 h-12 bg-indigo-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                            <i data-lucide="credit-card" class="w-6 h-6 text-indigo-600"></i>
                                        </div>
                                        <div class="text-lg font-black text-indigo-900">${CORE.formatPrice(paymentMethods.card)}</div>
                                        <div class="text-xs text-indigo-700 font-bold">Carte</div>
                                        <div class="text-[10px] text-indigo-500">${Math.round((paymentMethods.card / totalPayments) * 100)}%</div>
                                    </div>
                                    <div class="text-center p-4 bg-amber-50 rounded-xl">
                                        <div class="w-12 h-12 bg-amber-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                            <i data-lucide="truck" class="w-6 h-6 text-amber-600"></i>
                                        </div>
                                        <div class="text-lg font-black text-amber-900">${CORE.formatPrice(paymentMethods.cod)}</div>
                                        <div class="text-xs text-amber-700 font-bold">COD</div>
                                        <div class="text-[10px] text-amber-500">${Math.round((paymentMethods.cod / totalPayments) * 100)}%</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Colonne droite: Actions rapides + Top d�penses + Derni��res transactions -->
                        <div class="space-y-6">
                            <!-- Actions rapides -->
                            <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 text-white">
                                <h3 class="text-lg font-black mb-4 flex items-center gap-2">
                                    <i data-lucide="zap" class="w-5 h-5 text-amber-400"></i>
                                    Actions Rapides
                                </h3>
                                <div class="space-y-3">
                                    <button onclick="VendeurModule.showNewExpenseModal()" class="w-full px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                        <i data-lucide="minus-circle" class="w-5 h-5"></i>
                                        Enregistrer une d�pense
                                    </button>
                                    <button onclick="VendeurModule.showNewIncomeModal()" class="w-full px-4 py-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                        <i data-lucide="plus-circle" class="w-5 h-5"></i>
                                        Enregistrer un revenu
                                    </button>
                                    <button onclick="VendeurModule.showDepositsModal()" class="w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                        <i data-lucide="download" class="w-5 h-5"></i>
                                        D�p��ts livreurs
                                    </button>
                                    <button onclick="VendeurModule.showTransferModal()" class="w-full px-4 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                        <i data-lucide="arrow-right-left" class="w-5 h-5"></i>
                                        Transfert de fonds
                                    </button>
                                    ${codReadyToCollect.length > 0 ? `
                                        <button onclick="VendeurModule.showCODOutstandingModal()" class="w-full px-4 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3 relative">
                                            <i data-lucide="truck" class="w-5 h-5"></i>
                                            COD �� encaisser
                                            <span class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white text-xs font-black rounded-full flex items-center justify-center">${codReadyToCollect.length}</span>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- COD en attente d'encaissement -->
                            ${codReadyToCollect.length > 0 ? `
                                <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl border border-amber-200 p-6 shadow-sm">
                                    <h3 class="text-lg font-black text-amber-900 flex items-center gap-2 mb-4">
                                        <i data-lucide="alert-circle" class="w-5 h-5 text-amber-600"></i>
                                        ��Ÿ? � COD �� Encaisser
                                        <span class="ml-auto text-2xl font-black text-amber-700">${CORE.formatPrice(codOutstandingAmount)}</span>
                                    </h3>
                                    <p class="text-sm text-amber-700 mb-4">
                                        ${codReadyToCollect.length} livraison(s) COD effectu�e(s). L'argent est avec le(s) livreur(s).
                                    </p>
                                    <div class="space-y-2 max-h-48 overflow-y-auto">
                                        ${codReadyToCollect.slice(0, 5).map(o => {
                                            const delivery = CORE.db.deliveries.find(d => d.orderId === o.id);
                                            const livreurName = delivery?.livreurId 
                                                ? (String(delivery.livreurId).startsWith('idm_') 
                                                    ? (CORE.db.independentDeliveryMen.find(dm => dm.id === delivery.livreurId)?.name + ' �� � �' || 'Livreur ind�p.')
                                                    : (CORE.getUser(delivery.livreurId)?.name || 'Livreur'))
                                                : '�� ?��';
                                            return `
                                                <div class="flex items-center justify-between p-3 bg-white rounded-xl border border-amber-200">
                                                    <div>
                                                        <div class="font-bold text-sm text-slate-900">${o.reference}</div>
                                                        <div class="text-xs text-slate-500">${livreurName} �� ?� � ${o.clientName || 'Client'}</div>
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <span class="font-black text-amber-700">${CORE.formatPrice(o.total)}</span>
                                                        <button onclick="VendeurModule.markCODCollected(${o.id})" class="px-3 py-1.5 bg-emerald-500 text-white text-xs font-black rounded-lg hover:bg-emerald-600">Encaiss�</button>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    ${codReadyToCollect.length > 5 ? `
                                        <button onclick="VendeurModule.showCODOutstandingModal()" class="w-full mt-3 px-4 py-2 bg-amber-600 text-white rounded-xl font-bold text-sm hover:bg-amber-700 transition">
                                            Voir tout (${codReadyToCollect.length})
                                        </button>
                                    ` : ''}
                                </div>
                            ` : ''}

                            <!-- Top d�penses par cat�gorie -->
                            <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                <h3 class="text-lg font-black text-slate-900 flex items-center gap-2 mb-4">
                                    <i data-lucide="pie-chart" class="w-5 h-5 text-red-500"></i>
                                    Top D�penses
                                </h3>
                                ${topExpenseCategories.length === 0 ? '<div class="text-center py-4 text-slate-400 text-sm">Aucune d�pense enregistr�e</div>' : `
                                    <div class="space-y-3">
                                        ${topExpenseCategories.map(([cat, amount], i) => {
                                            const colors = ['bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-yellow-500', 'bg-lime-500'];
                                            const maxAmount = topExpenseCategories[0][1] || 1;
                                            return `
                                                <div class="flex items-center gap-3">
                                                    <div class="w-8 h-8 ${colors[i]} rounded-lg flex items-center justify-center text-white text-xs font-black">${i + 1}</div>
                                                    <div class="flex-1">
                                                        <div class="flex justify-between mb-1">
                                                            <span class="text-sm font-bold text-slate-700 capitalize">${cat}</span>
                                                            <span class="text-sm font-black text-red-600">${CORE.formatPrice(amount)}</span>
                                                        </div>
                                                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                                            <div class="${colors[i]} h-full rounded-full" style="width: ${(amount / maxAmount) * 100}%"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `}
                                <button onclick="CORE.state.financeView = 'expenses'; App.rerender()" class="w-full mt-4 px-4 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-200 transition">
                                    Voir toutes les d�penses ���?
                                </button>
                            </div>

                            <!-- Derni��res transactions -->
                            <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                <h3 class="text-lg font-black text-slate-900 flex items-center gap-2 mb-4">
                                    <i data-lucide="clock" class="w-5 h-5 text-slate-500"></i>
                                    Derni��res Transactions
                                </h3>
                                <div class="space-y-3">
                                    ${recentTxs.length === 0 ? '<div class="text-center py-4 text-slate-400 text-sm">Aucune transaction</div>' : recentTxs.map(t => `
                                        <div class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded-lg transition">
                                            <div class="w-10 h-10 rounded-xl flex items-center justify-center ${t.type === 'income' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}">
                                                <i data-lucide="${t.type === 'income' ? 'arrow-down-left' : 'arrow-up-right'}" class="w-5 h-5"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="text-sm font-bold text-slate-900 truncate">${t.category || t.note || 'Transaction'}</div>
                                                <div class="text-xs text-slate-500">${CORE.formatDate(t.createdAt)}</div>
                                            </div>
                                            <div class="text-sm font-black ${t.type === 'income' ? 'text-emerald-600' : 'text-red-600'}">
                                                ${t.type === 'income' ? '+' : '-'}${CORE.formatPrice(t.amount)}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <button onclick="CORE.state.financeView = 'transactions'; App.rerender()" class="w-full mt-4 px-4 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-200 transition">
                                    Voir tout l'historique ���?
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
        },

        // Page d�taill�e des transactions
        renderFinanceTransactions() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            const dateFrom = CORE.state.financeDateFrom || '';
            const dateTo = CORE.state.financeDateTo || '';
            const filter = CORE.state.financeFilter || 'all';
            const search = CORE.state.financeSearch || '';
            
            // FILTR� PAR POS
            let txs = CORE.db.financialTransactions?.filter(t => t.userId === uid && (t.posId == userPos || !t.posId)) || [];

            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                fromDate.setHours(0, 0, 0, 0);
                txs = txs.filter(t => new Date(t.createdAt) >= fromDate);
            }
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                txs = txs.filter(t => new Date(t.createdAt) <= toDate);
            }
            if (filter !== 'all') {
                txs = txs.filter(t => t.type === filter);
            }
            if (search) {
                const q = search.toLowerCase();
                txs = txs.filter(t => 
                    (t.category || '').toLowerCase().includes(q) ||
                    (t.note || '').toLowerCase().includes(q) ||
                    (t.reference || '').toLowerCase().includes(q)
                );
            }

            txs = txs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            const totalIncome = txs.filter(t => t.type === 'income').reduce((s, t) => s + (t.amount || 0), 0);
            const totalExpense = txs.filter(t => t.type === 'expense').reduce((s, t) => s + (t.amount || 0), 0);

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="CORE.state.financeView = '${v}'; App.rerender()" class="px-4 py-2.5 rounded-xl font-bold text-sm transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-500/30' : 'bg-white text-slate-600 hover:bg-slate-50 border border-slate-200'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-slate-700 to-slate-800 rounded-2xl flex items-center justify-center text-white shadow-lg">
                                    <i data-lucide="list" class="w-6 h-6"></i>
                                </div>
                                Historique des Transactions
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">${txs.length} transaction(s) trouv�e(s)</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aper��u', 'layout-grid')}
                            ${navBtn('transactions', 'Transactions', 'list', true)}
                            ${navBtn('income', 'Revenus', 'trending-up')}
                            ${navBtn('expenses', 'D�penses', 'trending-down')}
                        </div>
                    </div>

                    <!-- Filtres et recherche -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <div class="flex flex-wrap items-end gap-4">
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Rechercher</label>
                                <div class="flex gap-2">
                                    <input type="text" id="finance-search-input" placeholder="Cat�gorie, note, r�f�rence..." value="${search}"
                                        onkeypress="if(event.key==='Enter'){CORE.state.financeSearch = this.value; App.rerender();}"
                                        class="flex-1 px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none font-medium">
                                    <button onclick="CORE.state.financeSearch = document.getElementById('finance-search-input').value; App.rerender()" class="px-4 py-2.5 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 transition">
                                        <i data-lucide="search" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="min-w-[150px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Type</label>
                                <select onchange="CORE.state.financeFilter = this.value; App.rerender()" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none font-medium">
                                    <option value="all" ${filter === 'all' ? 'selected' : ''}>Tous</option>
                                    <option value="income" ${filter === 'income' ? 'selected' : ''}>Revenus</option>
                                    <option value="expense" ${filter === 'expense' ? 'selected' : ''}>D�penses</option>
                                </select>
                            </div>
                            <div class="min-w-[150px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Du</label>
                                <input type="date" value="${dateFrom}" 
                                    onchange="CORE.state.financeDateFrom = this.value; App.rerender()"
                                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none font-medium">
                            </div>
                            <div class="min-w-[150px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Au</label>
                                <input type="date" value="${dateTo}" 
                                    onchange="CORE.state.financeDateTo = this.value; App.rerender()"
                                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none font-medium">
                            </div>
                        </div>
                    </div>

                    <!-- R�sum� -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-4 text-center">
                            <div class="text-xs font-bold text-emerald-600 uppercase tracking-wider mb-1">Total Revenus</div>
                            <div class="text-2xl font-black text-emerald-700">+${CORE.formatPrice(totalIncome)}</div>
                        </div>
                        <div class="bg-red-50 border border-red-200 rounded-2xl p-4 text-center">
                            <div class="text-xs font-bold text-red-600 uppercase tracking-wider mb-1">Total D�penses</div>
                            <div class="text-2xl font-black text-red-700">-${CORE.formatPrice(totalExpense)}</div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4 text-center">
                            <div class="text-xs font-bold text-blue-600 uppercase tracking-wider mb-1">Solde Net</div>
                            <div class="text-2xl font-black ${totalIncome - totalExpense >= 0 ? 'text-blue-700' : 'text-red-700'}">${totalIncome - totalExpense >= 0 ? '+' : ''}${CORE.formatPrice(totalIncome - totalExpense)}</div>
                        </div>
                    </div>

                    <!-- Tableau des transactions -->
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4">Date</th>
                                        <th class="px-6 py-4">Type</th>
                                        <th class="px-6 py-4">Cat�gorie</th>
                                        <th class="px-6 py-4">Description</th>
                                        <th class="px-6 py-4">R�f�rence</th>
                                        <th class="px-6 py-4 text-right">Montant</th>
                                        <th class="px-6 py-4 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${txs.length === 0 ? `<tr><td colspan="7" class="px-6 py-12 text-center text-slate-400 italic">Aucune transaction trouv�e</td></tr>` : ''}
                                    ${txs.map(t => `
                                        <tr class="hover:bg-slate-50 transition">
                                            <td class="px-6 py-4 text-slate-600">${CORE.formatDate(t.createdAt)}</td>
                                            <td class="px-6 py-4">
                                                <span class="px-3 py-1.5 rounded-full text-xs font-bold ${
                                                    t.type === 'income' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'
                                                }">
                                                    ${t.type === 'income' ? '���? Entr�e' : '���? Sortie'}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 font-bold text-slate-900 capitalize">${t.category || '�� ?��'}</td>
                                            <td class="px-6 py-4 text-slate-600 max-w-[200px] truncate">${t.note || '�� ?��'}</td>
                                            <td class="px-6 py-4 text-xs text-slate-400 font-mono">${t.reference || '�� ?��'}</td>
                                            <td class="px-6 py-4 text-right font-black text-lg ${t.type === 'income' ? 'text-emerald-600' : 'text-red-600'}">
                                                ${t.type === 'income' ? '+' : '-'}${CORE.formatPrice(t.amount)}
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <button onclick="VendeurModule.showTransactionDetail(${t.id})" class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition">
                                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="VendeurModule.deleteTransaction(${t.id})" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        },

        // Page des d�penses d�taill�es
        renderFinanceExpenses() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            // FILTR� PAR POS
            let expenses = (CORE.db.financialTransactions?.filter(t => t.userId === uid && t.type === 'expense' && (t.posId == userPos || !t.posId)) || [])
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Grouper par cat�gorie
            const byCategory = {};
            expenses.forEach(e => {
                const cat = e.category || 'autre';
                if (!byCategory[cat]) byCategory[cat] = { total: 0, count: 0, items: [] };
                byCategory[cat].total += e.amount || 0;
                byCategory[cat].count++;
                byCategory[cat].items.push(e);
            });
            
            const totalExpenses = expenses.reduce((s, e) => s + (e.amount || 0), 0);
            const categories = Object.entries(byCategory).sort((a, b) => b[1].total - a[1].total);

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="CORE.state.financeView = '${v}'; App.rerender()" class="px-4 py-2.5 rounded-xl font-bold text-sm transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-red-500 to-red-600 text-white shadow-lg shadow-red-500/30' : 'bg-white text-slate-600 hover:bg-slate-50 border border-slate-200'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-red-500/30">
                                    <i data-lucide="trending-down" class="w-6 h-6"></i>
                                </div>
                                Suivi des D�penses
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Total: <span class="text-red-600 font-black">${CORE.formatPrice(totalExpenses)}</span> r�partis en ${categories.length} cat�gorie(s)</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aper��u', 'layout-grid')}
                            ${navBtn('transactions', 'Transactions', 'list')}
                            ${navBtn('expenses', 'D�penses', 'trending-down', true)}
                            <button onclick="VendeurModule.showNewExpenseModal()" class="px-4 py-2.5 bg-red-600 text-white rounded-xl font-bold text-sm hover:bg-red-700 transition flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Nouvelle d�pense
                            </button>
                        </div>
                    </div>

                    <!-- R�partition par cat�gorie -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Graphique visuel -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="text-lg font-black text-slate-900 mb-6">R�partition par Cat�gorie</h3>
                            <div class="space-y-4">
                                ${categories.map(([cat, data], i) => {
                                    const percent = totalExpenses > 0 ? Math.round((data.total / totalExpenses) * 100) : 0;
                                    const colors = ['from-red-500 to-red-600', 'from-orange-500 to-orange-600', 'from-amber-500 to-amber-600', 'from-yellow-500 to-yellow-600', 'from-lime-500 to-lime-600', 'from-green-500 to-green-600', 'from-teal-500 to-teal-600', 'from-cyan-500 to-cyan-600'];
                                    return `
                                        <div class="space-y-2">
                                            <div class="flex justify-between items-center">
                                                <span class="font-bold text-slate-700 capitalize flex items-center gap-2">
                                                    <span class="w-3 h-3 bg-gradient-to-r ${colors[i % colors.length]} rounded-full"></span>
                                                    ${cat}
                                                </span>
                                                <span class="text-sm">
                                                    <span class="font-black text-red-600">${CORE.formatPrice(data.total)}</span>
                                                    <span class="text-slate-400 ml-2">(${percent}%)</span>
                                                </span>
                                            </div>
                                            <div class="h-4 bg-slate-100 rounded-full overflow-hidden">
                                                <div class="h-full bg-gradient-to-r ${colors[i % colors.length]} rounded-full transition-all" style="width: ${percent}%"></div>
                                            </div>
                                            <div class="text-xs text-slate-400">${data.count} transaction(s)</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Liste d�taill�e par cat�gorie -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm max-h-[600px] overflow-y-auto">
                            <h3 class="text-lg font-black text-slate-900 mb-6">D�tail par Cat�gorie</h3>
                            <div class="space-y-6">
                                ${categories.map(([cat, data]) => `
                                    <div class="border-b border-slate-100 pb-4 last:border-0">
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="font-black text-slate-800 capitalize">${cat}</h4>
                                            <span class="text-lg font-black text-red-600">${CORE.formatPrice(data.total)}</span>
                                        </div>
                                        <div class="space-y-2">
                                            ${data.items.slice(0, 5).map(item => `
                                                <div class="flex items-center justify-between text-sm p-2 bg-slate-50 rounded-lg">
                                                    <div class="flex-1 min-w-0">
                                                        <div class="text-slate-600 truncate">${item.note || 'Sans description'}</div>
                                                        <div class="text-xs text-slate-400">${CORE.formatDate(item.createdAt)}</div>
                                                    </div>
                                                    <div class="font-bold text-red-600 ml-4">${CORE.formatPrice(item.amount)}</div>
                                                </div>
                                            `).join('')}
                                            ${data.items.length > 5 ? `<div class="text-xs text-slate-400 text-center">+ ${data.items.length - 5} autres transactions</div>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Tableau complet -->
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="p-4 border-b border-slate-200 bg-slate-50">
                            <h3 class="font-black text-slate-900">Toutes les D�penses</h3>
                        </div>
                        <div class="overflow-x-auto max-h-[400px]">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3">Date</th>
                                        <th class="px-6 py-3">Cat�gorie</th>
                                        <th class="px-6 py-3">Description</th>
                                        <th class="px-6 py-3 text-right">Montant</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${expenses.map(e => `
                                        <tr class="hover:bg-red-50 transition">
                                            <td class="px-6 py-3 text-slate-600">${CORE.formatDate(e.createdAt)}</td>
                                            <td class="px-6 py-3 font-bold text-slate-900 capitalize">${e.category || '�� ?��'}</td>
                                            <td class="px-6 py-3 text-slate-600">${e.note || '�� ?��'}</td>
                                            <td class="px-6 py-3 text-right font-black text-red-600">-${CORE.formatPrice(e.amount)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        },

        // Page des revenus d�taill�s
        renderFinanceIncome() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            // FILTR� PAR POS
            let incomes = (CORE.db.financialTransactions?.filter(t => t.userId === uid && t.type === 'income' && (t.posId == userPos || !t.posId)) || [])
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Grouper par source/cat�gorie
            const bySource = {};
            incomes.forEach(i => {
                const src = i.category || 'vente';
                if (!bySource[src]) bySource[src] = { total: 0, count: 0, items: [] };
                bySource[src].total += i.amount || 0;
                bySource[src].count++;
                bySource[src].items.push(i);
            });
            
            // Stats des ventes
            const orders = CORE.db.orders.filter(o => o.posId == userPos);
            const totalSales = orders.reduce((s, o) => s + (o.total || 0), 0);
            const todayOrders = orders.filter(o => {
                const d = new Date(o.createdAt);
                const today = new Date();
                return d.toDateString() === today.toDateString();
            });
            const todaySales = todayOrders.reduce((s, o) => s + (o.total || 0), 0);
            
            const totalIncome = incomes.reduce((s, i) => s + (i.amount || 0), 0);
            const sources = Object.entries(bySource).sort((a, b) => b[1].total - a[1].total);

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="CORE.state.financeView = '${v}'; App.rerender()" class="px-4 py-2.5 rounded-xl font-bold text-sm transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-500/30' : 'bg-white text-slate-600 hover:bg-slate-50 border border-slate-200'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-emerald-500/30">
                                    <i data-lucide="trending-up" class="w-6 h-6"></i>
                                </div>
                                Suivi des Revenus
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Total enregistr�: <span class="text-emerald-600 font-black">${CORE.formatPrice(totalIncome)}</span></p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aper��u', 'layout-grid')}
                            ${navBtn('transactions', 'Transactions', 'list')}
                            ${navBtn('income', 'Revenus', 'trending-up', true)}
                            <button onclick="VendeurModule.showNewIncomeModal()" class="px-4 py-2.5 bg-emerald-600 text-white rounded-xl font-bold text-sm hover:bg-emerald-700 transition flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Nouveau revenu
                            </button>
                        </div>
                    </div>

                    <!-- KPIs Ventes -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl p-5 text-white">
                            <div class="text-xs font-bold uppercase tracking-wider opacity-80 mb-2">Ventes Totales</div>
                            <div class="text-2xl font-black">${CORE.formatPrice(totalSales)}</div>
                            <div class="text-xs opacity-70 mt-1">${orders.length} commandes</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-5 text-white">
                            <div class="text-xs font-bold uppercase tracking-wider opacity-80 mb-2">Ventes Aujourd'hui</div>
                            <div class="text-2xl font-black">${CORE.formatPrice(todaySales)}</div>
                            <div class="text-xs opacity-70 mt-1">${todayOrders.length} commandes</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl p-5 text-white">
                            <div class="text-xs font-bold uppercase tracking-wider opacity-80 mb-2">Panier Moyen</div>
                            <div class="text-2xl font-black">${CORE.formatPrice(orders.length > 0 ? totalSales / orders.length : 0)}</div>
                            <div class="text-xs opacity-70 mt-1">Par commande</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-5 text-white">
                            <div class="text-xs font-bold uppercase tracking-wider opacity-80 mb-2">Autres Revenus</div>
                            <div class="text-2xl font-black">${CORE.formatPrice(totalIncome)}</div>
                            <div class="text-xs opacity-70 mt-1">${incomes.length} entr�es</div>
                        </div>
                    </div>

                    <!-- R�partition par source -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="text-lg font-black text-slate-900 mb-6">Sources de Revenus</h3>
                            <div class="space-y-4">
                                ${sources.length === 0 ? '<div class="text-center py-8 text-slate-400">Aucun revenu enregistr�</div>' : sources.map(([src, data], i) => {
                                    const percent = totalIncome > 0 ? Math.round((data.total / totalIncome) * 100) : 0;
                                    const colors = ['from-emerald-500 to-emerald-600', 'from-teal-500 to-teal-600', 'from-cyan-500 to-cyan-600', 'from-blue-500 to-blue-600', 'from-indigo-500 to-indigo-600'];
                                    return `
                                        <div class="space-y-2">
                                            <div class="flex justify-between items-center">
                                                <span class="font-bold text-slate-700 capitalize">${src}</span>
                                                <span class="font-black text-emerald-600">${CORE.formatPrice(data.total)} <span class="text-slate-400 text-sm">(${percent}%)</span></span>
                                            </div>
                                            <div class="h-4 bg-slate-100 rounded-full overflow-hidden">
                                                <div class="h-full bg-gradient-to-r ${colors[i % colors.length]} rounded-full" style="width: ${percent}%"></div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm max-h-[400px] overflow-y-auto">
                            <h3 class="text-lg font-black text-slate-900 mb-6">Derniers Revenus</h3>
                            <div class="space-y-3">
                                ${incomes.slice(0, 10).map(i => `
                                    <div class="flex items-center gap-3 p-3 bg-emerald-50 rounded-xl">
                                        <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center text-emerald-600">
                                            <i data-lucide="arrow-down-left" class="w-5 h-5"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-slate-900 capitalize">${i.category || 'Revenu'}</div>
                                            <div class="text-xs text-slate-500">${i.note || '�� ?��'} �� ?� � ${CORE.formatDate(i.createdAt)}</div>
                                        </div>
                                        <div class="font-black text-emerald-600">+${CORE.formatPrice(i.amount)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>`;
        },

        // Page de gestion des budgets
        renderFinanceBudgets() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            
            // Budgets FILTR�S PAR POS
            const budgets = CORE.db.budgets?.filter(b => b.userId === uid && (b.posId == userPos || !b.posId)) || [];
            
            // Calculer les d�penses par cat�gorie pour le mois en cours - FILTR� PAR POS
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const expenses = (CORE.db.financialTransactions?.filter(t => 
                t.userId === uid && 
                t.type === 'expense' && 
                (t.posId == userPos || !t.posId) &&
                new Date(t.createdAt) >= monthStart
            ) || []);
            
            const expenseByCategory = {};
            expenses.forEach(e => {
                const cat = e.category || 'autre';
                expenseByCategory[cat] = (expenseByCategory[cat] || 0) + (e.amount || 0);
            });

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="CORE.state.financeView = '${v}'; App.rerender()" class="px-4 py-2.5 rounded-xl font-bold text-sm transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow-lg shadow-purple-500/30' : 'bg-white text-slate-600 hover:bg-slate-50 border border-slate-200'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-purple-500/30">
                                    <i data-lucide="pie-chart" class="w-6 h-6"></i>
                                </div>
                                Gestion des Budgets
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Planifiez et suivez vos d�penses par cat�gorie</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aper��u', 'layout-grid')}
                            ${navBtn('budgets', 'Budgets', 'pie-chart', true)}
                            <button onclick="VendeurModule.showNewBudgetModal()" class="px-4 py-2.5 bg-purple-600 text-white rounded-xl font-bold text-sm hover:bg-purple-700 transition flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Nouveau budget
                            </button>
                        </div>
                    </div>

                    <!-- Budgets actifs -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${budgets.length === 0 ? `
                            <div class="col-span-full bg-white rounded-2xl border-2 border-dashed border-slate-200 p-12 text-center">
                                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i data-lucide="pie-chart" class="w-8 h-8 text-slate-400"></i>
                                </div>
                                <h3 class="text-lg font-black text-slate-900 mb-2">Aucun budget d�fini</h3>
                                <p class="text-slate-500 mb-4">Cr�ez des budgets pour suivre vos d�penses par cat�gorie</p>
                                <button onclick="VendeurModule.showNewBudgetModal()" class="px-6 py-3 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition">
                                    Cr�er mon premier budget
                                </button>
                            </div>
                        ` : budgets.map(b => {
                            const spent = expenseByCategory[b.category] || 0;
                            const percent = b.amount > 0 ? Math.min(Math.round((spent / b.amount) * 100), 100) : 0;
                            const remaining = Math.max(b.amount - spent, 0);
                            const isOver = spent > b.amount;
                            return `
                                <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm ${isOver ? 'border-red-300 bg-red-50' : ''} relative group">
                                    <!-- Actions en haut �� droite -->
                                    <div class="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onclick="VendeurModule.editBudget(${b.id})" class="p-1.5 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition" title="Modifier">
                                            <i data-lucide="edit-2" class="w-3.5 h-3.5"></i>
                                        </button>
                                        <button onclick="VendeurModule.deleteBudget(${b.id})" class="p-1.5 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition" title="Supprimer">
                                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                        </button>
                                    </div>
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="font-black text-slate-900 capitalize">${b.category}</h4>
                                        <span class="px-2 py-1 rounded-full text-xs font-bold ${isOver ? 'bg-red-100 text-red-600' : percent >= 80 ? 'bg-amber-100 text-amber-600' : 'bg-emerald-100 text-emerald-600'}">
                                            ${isOver ? '��š ��� � � D�pass�!' : percent >= 80 ? '��š � Attention' : '���?? OK'}
                                        </span>
                                    </div>
                                    <div class="space-y-3">
                                        <div class="flex justify-between text-sm">
                                            <span class="text-slate-500">D�pens�</span>
                                            <span class="font-black ${isOver ? 'text-red-600' : 'text-slate-900'}">${CORE.formatPrice(spent)}</span>
                                        </div>
                                        <div class="h-3 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full rounded-full transition-all ${isOver ? 'bg-gradient-to-r from-red-500 to-red-600' : percent >= 80 ? 'bg-gradient-to-r from-amber-500 to-amber-600' : 'bg-gradient-to-r from-purple-500 to-purple-600'}" style="width: ${Math.min(percent, 100)}%"></div>
                                        </div>
                                        <div class="flex justify-between text-sm">
                                            <span class="text-slate-500">Budget</span>
                                            <span class="font-bold text-slate-700">${CORE.formatPrice(b.amount)}</span>
                                        </div>
                                        <div class="flex justify-between text-sm">
                                            <span class="text-slate-500">Utilis�</span>
                                            <span class="font-bold ${isOver ? 'text-red-600' : percent >= 80 ? 'text-amber-600' : 'text-purple-600'}">${percent}%</span>
                                        </div>
                                        <div class="pt-3 border-t border-slate-100 flex justify-between">
                                            <span class="text-sm text-slate-500">Restant</span>
                                            <span class="font-black ${isOver ? 'text-red-600' : 'text-emerald-600'}">${isOver ? '-' : ''}${CORE.formatPrice(isOver ? spent - b.amount : remaining)}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <!-- R�sum� des d�penses du mois -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                        <h3 class="text-lg font-black text-slate-900 mb-6">D�penses du Mois en Cours</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            ${Object.entries(expenseByCategory).sort((a, b) => b[1] - a[1]).map(([cat, amount]) => `
                                <div class="text-center p-4 bg-slate-50 rounded-xl">
                                    <div class="text-lg font-black text-red-600">${CORE.formatPrice(amount)}</div>
                                    <div class="text-xs font-bold text-slate-600 capitalize mt-1">${cat}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
        },

        // Fonctions utilitaires pour la finance
        
        // Marquer un COD comme encaiss� (argent r�cup�r� du livreur)
        markCODCollected(orderId) {
            const o = CORE.db.orders.find(x => x.id === orderId);
            if (!o) return UI.toast('Commande introuvable', 'error');
            if (o.paymentMethod !== 'cod') return UI.toast('Ce n\'est pas une commande COD', 'warning');
            if (o.paymentStatus === 'paid') return UI.toast('D�j�� encaiss�', 'info');
            
            // V�rifier que la livraison est bien effectu�e
            const delivery = CORE.db.deliveries.find(d => d.orderId === orderId);
            if (!delivery || delivery.status !== 'livree') {
                return UI.toast('La livraison n\'est pas encore valid�e', 'warning');
            }
            
            // R�cup�rer le nom du livreur pour le log
            let livreurName = '�� ?��';
            if (delivery.livreurId) {
                if (String(delivery.livreurId).startsWith('idm_')) {
                    const dm = CORE.db.independentDeliveryMen.find(dm => dm.id === delivery.livreurId);
                    livreurName = dm ? dm.name + ' (Ind�pendant)' : 'Livreur ind�pendant';
                } else {
                    livreurName = CORE.getUser(delivery.livreurId)?.name || 'Livreur';
                }
            }

            // Mettre �� jour le statut de paiement
            const updated = CORE.update('orders', o.id, { paymentStatus: 'paid', codCollectedAt: new Date().toISOString() });
            
            // Cr�er la transaction financi��re de vente
            CORE.ensureSaleTransaction(updated);
            
            // Log dans l'audit
            CORE.logActivity('COD_COLLECTED', 'order', o.id, {
                entityName: o.reference,
                description: `COD encaiss�: ${o.reference} - ${CORE.formatPrice(o.total)} r�cup�r� de ${livreurName}`,
                amount: o.total,
                livreurName: livreurName,
                posId: o.posId,
                status: 'success'
            });
            
            UI.toast(`���?� ${CORE.formatPrice(o.total)} encaiss� (${o.reference})`, 'success');
            App.rerender();
        },
        
        // Afficher tous les COD en attente
        showCODOutstandingModal() {
            const userPos = CORE.user?.pos;
            
            // COD livr�s mais pas encore encaiss�s
            const codOutstanding = CORE.db.orders.filter(o => 
                o.posId == userPos && 
                o.paymentMethod === 'cod' && 
                o.paymentStatus !== 'paid'
            ).filter(o => {
                const delivery = CORE.db.deliveries.find(d => d.orderId === o.id);
                return delivery && delivery.status === 'livree';
            });
            
            const totalAmount = codOutstanding.reduce((sum, o) => sum + (o.total || 0), 0);
            
            let listHtml = codOutstanding.length === 0 
                ? '<div class="text-center py-8 text-slate-400">Aucun COD en attente d\'encaissement</div>'
                : codOutstanding.map(o => {
                    const delivery = CORE.db.deliveries.find(d => d.orderId === o.id);
                    let livreurName = '�� ?��';
                    if (delivery?.livreurId) {
                        if (String(delivery.livreurId).startsWith('idm_')) {
                            const dm = CORE.db.independentDeliveryMen.find(dm => dm.id === delivery.livreurId);
                            livreurName = dm ? dm.name + ' �� � �' : 'Livreur ind�p.';
                        } else {
                            livreurName = CORE.getUser(delivery.livreurId)?.name || 'Livreur';
                        }
                    }
                    const deliveredAt = delivery?.deliveredAt ? CORE.formatDate(delivery.deliveredAt) : '�� ?��';
                    
                    return `
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-200 hover:bg-slate-100 transition">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-black text-slate-900">${o.reference}</span>
                                    <span class="px-2 py-0.5 bg-amber-100 text-amber-700 text-xs font-bold rounded">COD</span>
                                </div>
                                <div class="text-sm text-slate-600">${o.clientName || 'Client'}</div>
                                <div class="text-xs text-slate-400 mt-1">
                                    <span class="font-bold">Livreur:</span> ${livreurName} �� ?� � 
                                    <span class="font-bold">Livr�:</span> ${deliveredAt}
                                </div>
                            </div>
                            <div class="text-right ml-4">
                                <div class="text-xl font-black text-amber-700 mb-2">${CORE.formatPrice(o.total)}</div>
                                <button onclick="VendeurModule.markCODCollected(${o.id})" class="px-4 py-2 bg-emerald-500 text-white text-sm font-black rounded-lg hover:bg-emerald-600 transition">
                                    ���?? Encaiss�
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            
            UI.modal('��Ÿ? � COD �� Encaisser', `
                <div class="space-y-4">
                    <div class="p-4 bg-gradient-to-r from-amber-500 to-orange-500 rounded-xl text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm font-bold opacity-80">Total �� r�cup�rer</div>
                                <div class="text-3xl font-black">${CORE.formatPrice(totalAmount)}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-4xl font-black">${codOutstanding.length}</div>
                                <div class="text-sm font-bold opacity-80">commande(s)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-sm text-slate-600 p-3 bg-blue-50 border border-blue-200 rounded-xl">
                        <i data-lucide="info" class="w-4 h-4 inline text-blue-600"></i>
                        Ces commandes ont �t� <b>livr�es</b>. L'argent est avec le livreur. Cliquez "Encaiss�" quand vous r�cup�rez l'argent.
                    </div>
                    
                    <div class="space-y-3 max-h-[50vh] overflow-y-auto">
                        ${listHtml}
                    </div>
                    
                    ${codOutstanding.length > 0 ? `
                        <button onclick="VendeurModule.markAllCODCollected()" class="w-full px-4 py-3 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition">
                            ���?? Tout marquer comme encaiss�
                        </button>
                    ` : ''}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },
        
        // Marquer tous les COD comme encaiss�s
        markAllCODCollected() {
            const userPos = CORE.user?.pos;
            
            const codOutstanding = CORE.db.orders.filter(o => 
                o.posId == userPos && 
                o.paymentMethod === 'cod' && 
                o.paymentStatus !== 'paid'
            ).filter(o => {
                const delivery = CORE.db.deliveries.find(d => d.orderId === o.id);
                return delivery && delivery.status === 'livree';
            });
            
            if (codOutstanding.length === 0) return;
            
            if (!confirm(`Marquer ${codOutstanding.length} commande(s) COD comme encaiss�es ?`)) return;
            
            let totalCollected = 0;
            codOutstanding.forEach(o => {
                const updated = CORE.update('orders', o.id, { paymentStatus: 'paid', codCollectedAt: new Date().toISOString() });
                CORE.ensureSaleTransaction(updated);
                totalCollected += o.total || 0;
            });
            
            CORE.logActivity('COD_BATCH_COLLECTED', 'orders', null, {
                entityName: `${codOutstanding.length} commandes COD`,
                description: `${codOutstanding.length} COD encaiss�s pour un total de ${CORE.formatPrice(totalCollected)}`,
                amount: totalCollected,
                count: codOutstanding.length,
                posId: userPos,
                status: 'success'
            });
            
            UI.closeModal();
            UI.toast(`���?� ${codOutstanding.length} COD encaiss�s (${CORE.formatPrice(totalCollected)})`, 'success');
            App.rerender();
        },
        
        showNewIncomeModal() {
            const incomeCategories = [
                { value: 'vente', label: '��Ÿ�? Vente directe' },
                { value: 'service', label: '��Ÿ� � Service rendu' },
                { value: 'remboursement', label: '��� ��� � � Remboursement re��u' },
                { value: 'depot_livreur', label: '��Ÿ? � D�p��t livreur' },
                { value: 'investissement', label: '��Ÿ? � Investissement/Capital' },
                { value: 'pret', label: '��Ÿ � � Pr��t re��u' },
                { value: 'autre', label: '��Ÿ?� Autre' }
            ];

            UI.modal('Nouveau Revenu', `
                <div class="space-y-4">
                    ${UI.input('vi_amount', 'Montant', 'number', '', 'ex: 50000', true)}
                    ${UI.select('vi_category', 'Source / Cat�gorie', incomeCategories, 'vente', true)}
                    ${UI.textarea('vi_note', 'Description', '', 'D�tails du revenu...', 2)}
                    ${UI.input('vi_ref', 'R�f�rence (optionnel)', 'text', '', 'Num�ro de re��u...')}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'VendeurModule.saveNewIncome()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' }
            ]);
        },

        saveNewIncome() {
            const amount = parseFloat(UI.val('vi_amount')) || 0;
            const category = UI.val('vi_category') || 'autre';
            const note = UI.val('vi_note') || '';
            const reference = UI.val('vi_ref') || '';

            if (amount <= 0) {
                return UI.toast('Montant invalide', 'warning');
            }

            CORE.db.financialTransactions = CORE.db.financialTransactions || [];
            CORE.db.financialTransactions.push({
                id: Date.now(),
                userId: CORE.state.currentUser?.id,
                posId: CORE.user?.pos,
                type: 'income',
                amount,
                category,
                note,
                reference,
                createdAt: new Date().toISOString()
            });
            CORE.save();
            UI.closeModal();
            UI.toast('Revenu enregistr� avec succ��s', 'success');
            App.rerender();
        },

        showTransferModal() {
            UI.modal('Transfert de Fonds', `
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl text-sm text-blue-700">
                        <i data-lucide="info" class="w-4 h-4 inline mr-2"></i>
                        Enregistrez un transfert entre comptes ou vers un fournisseur
                    </div>
                    ${UI.input('vt_amount', 'Montant', 'number', '', 'ex: 100000', true)}
                    ${UI.select('vt_type', 'Type de transfert', [
                        { value: 'bank_deposit', label: '��Ÿ � � D�p��t en banque' },
                        { value: 'supplier_payment', label: '��Ÿ? � Paiement fournisseur' },
                        { value: 'salary', label: '��Ÿ? � Paiement salaire' },
                        { value: 'transfer_out', label: '��ž ��� � � Transfert sortant' },
                        { value: 'transfer_in', label: '�� ���� � � Transfert entrant' }
                    ], 'bank_deposit', true)}
                    ${UI.textarea('vt_note', 'Description', '', 'D�tails du transfert...', 2)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'VendeurModule.saveTransfer()', class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700' }
            ]);
        },

        saveTransfer() {
            const amount = parseFloat(UI.val('vt_amount')) || 0;
            const type = UI.val('vt_type') || 'transfer_out';
            const note = UI.val('vt_note') || '';

            if (amount <= 0) {
                return UI.toast('Montant invalide', 'warning');
            }

            const isIncome = type === 'transfer_in';
            
            CORE.db.financialTransactions = CORE.db.financialTransactions || [];
            CORE.db.financialTransactions.push({
                id: Date.now(),
                userId: CORE.state.currentUser?.id,
                posId: CORE.user?.pos,
                type: isIncome ? 'income' : 'expense',
                amount,
                category: type,
                note,
                createdAt: new Date().toISOString()
            });
            CORE.save();
            UI.closeModal();
            UI.toast('Transfert enregistr�', 'success');
            App.rerender();
        },

        showNewBudgetModal() {
            UI.modal('��ž� Nouveau Budget', `
                <div class="space-y-4">
                    <div class="p-4 bg-purple-50 border border-purple-200 rounded-xl text-sm text-purple-700">
                        <i data-lucide="info" class="w-4 h-4 inline mr-2"></i>
                        D�finissez un budget mensuel pour suivre vos d�penses par cat�gorie
                    </div>
                    ${UI.select('vb_category', 'Cat�gorie', [
                        { value: 'stock', label: '��Ÿ? � Stock/Produits' },
                        { value: 'transport', label: '��Ÿšš Transport' },
                        { value: 'salaire', label: '��Ÿ? � Salaires' },
                        { value: 'loyer', label: '��Ÿ � � Loyer' },
                        { value: 'electricite', label: '��š � �lectricit�/Eau' },
                        { value: 'telephone', label: '��Ÿ? � T�l�phone/Internet' },
                        { value: 'maintenance', label: '��Ÿ� � Maintenance' },
                        { value: 'hygieneEntretien', label: '��Ÿ � � Hygi��ne/Entretien' },
                        { value: 'publicite', label: '��Ÿ? � Publicit�' },
                        { value: 'assurance', label: '��Ÿ� ��� � � Assurance' },
                        { value: 'taxe', label: '��Ÿ? � Taxes/Imp��ts' },
                        { value: 'banque', label: '��Ÿ � � Frais bancaires' },
                        { value: 'deplacement', label: '��Ÿš? D�placement' },
                        { value: 'formation', label: '��Ÿ?š Formation' },
                        { value: 'equipement', label: '��Ÿ� ��� � � �quipement' },
                        { value: 'autre', label: '��Ÿ?� Autre' }
                    ], 'stock', true)}
                    ${UI.input('vb_amount', 'Budget mensuel (FCFA)', 'number', '', 'ex: 500000', true)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Cr�er le budget', onclick: 'VendeurModule.saveNewBudget()', class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700' }
            ]);
        },

        saveNewBudget() {
            const category = UI.val('vb_category');
            const amount = parseFloat(UI.val('vb_amount')) || 0;

            if (amount <= 0) {
                return UI.toast('Montant invalide', 'warning');
            }

            CORE.db.budgets = CORE.db.budgets || [];
            CORE.db.budgets.push({
                id: Date.now(),
                userId: CORE.state.currentUser?.id,
                posId: CORE.user?.pos,
                category,
                amount,
                createdAt: new Date().toISOString()
            });
            CORE.save();
            UI.closeModal();
            UI.toast('Budget cr�� avec succ��s', 'success');
            App.rerender();
        },

        editBudget(budgetId) {
            const budget = CORE.db.budgets?.find(b => b.id === budgetId);
            if (!budget) return UI.toast('Budget introuvable', 'error');

            const categories = [
                { value: 'stock', label: '��Ÿ? � Stock/Produits' },
                { value: 'transport', label: '��Ÿšš Transport' },
                { value: 'salaire', label: '��Ÿ? � Salaires' },
                { value: 'loyer', label: '��Ÿ � � Loyer' },
                { value: 'electricite', label: '��š � �lectricit�/Eau' },
                { value: 'telephone', label: '��Ÿ? � T�l�phone/Internet' },
                { value: 'maintenance', label: '��Ÿ� � Maintenance' },
                { value: 'hygieneEntretien', label: '��Ÿ � � Hygi��ne/Entretien' },
                { value: 'publicite', label: '��Ÿ? � Publicit�' },
                { value: 'assurance', label: '��Ÿ� ��� � � Assurance' },
                { value: 'taxe', label: '��Ÿ? � Taxes/Imp��ts' },
                { value: 'banque', label: '��Ÿ � � Frais bancaires' },
                { value: 'deplacement', label: '��Ÿš? D�placement' },
                { value: 'formation', label: '��Ÿ?š Formation' },
                { value: 'equipement', label: '��Ÿ� ��� � � �quipement' },
                { value: 'autre', label: '��Ÿ?� Autre' }
            ];

            UI.modal('���? ��� � � Modifier Budget', `
                <div class="space-y-4">
                    <div class="p-4 bg-purple-50 border border-purple-200 rounded-xl">
                        <div class="text-xs font-bold text-purple-600 uppercase mb-1">Budget actuel</div>
                        <div class="text-2xl font-black text-purple-700 capitalize">${budget.category} - ${CORE.formatPrice(budget.amount)}</div>
                    </div>
                    ${UI.select('vbe_category', 'Cat�gorie', categories, budget.category, true)}
                    ${UI.input('vbe_amount', 'Nouveau montant mensuel', 'number', budget.amount, 'ex: 500000', true)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: `VendeurModule.updateBudget(${budgetId})`, class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700' }
            ]);
        },

        updateBudget(budgetId) {
            const category = UI.val('vbe_category');
            const amount = parseFloat(UI.val('vbe_amount')) || 0;

            if (amount <= 0) {
                return UI.toast('Montant invalide', 'warning');
            }

            const budgetIndex = CORE.db.budgets?.findIndex(b => b.id === budgetId);
            if (budgetIndex === -1) return UI.toast('Budget introuvable', 'error');

            CORE.db.budgets[budgetIndex].category = category;
            CORE.db.budgets[budgetIndex].amount = amount;
            CORE.db.budgets[budgetIndex].updatedAt = new Date().toISOString();
            
            CORE.save();
            UI.closeModal();
            UI.toast('Budget modifi� avec succ��s', 'success');
            App.rerender();
        },

        deleteBudget(budgetId) {
            if (!confirm('�?Štes-vous s��r de vouloir supprimer ce budget ?')) return;
            
            CORE.db.budgets = CORE.db.budgets?.filter(b => b.id !== budgetId) || [];
            CORE.save();
            UI.toast('Budget supprim�', 'success');
            App.rerender();
        },

        showTransactionDetail(txId) {
            const tx = CORE.db.financialTransactions?.find(t => t.id === txId);
            if (!tx) return UI.toast('Transaction introuvable', 'error');

            UI.modal('D�tail Transaction', `
                <div class="space-y-4">
                    <div class="p-4 rounded-2xl ${tx.type === 'income' ? 'bg-emerald-50 border border-emerald-200' : 'bg-red-50 border border-red-200'}">
                        <div class="text-center">
                            <div class="text-xs font-bold uppercase tracking-wider ${tx.type === 'income' ? 'text-emerald-600' : 'text-red-600'} mb-2">
                                ${tx.type === 'income' ? 'ENTR�E' : 'SORTIE'}
                            </div>
                            <div class="text-3xl font-black ${tx.type === 'income' ? 'text-emerald-700' : 'text-red-700'}">
                                ${tx.type === 'income' ? '+' : '-'}${CORE.formatPrice(tx.amount)}
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between py-2 border-b border-slate-100">
                            <span class="text-slate-500">Cat�gorie</span>
                            <span class="font-bold text-slate-900 capitalize">${tx.category || '�� ?��'}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-slate-100">
                            <span class="text-slate-500">Description</span>
                            <span class="font-bold text-slate-900">${tx.note || '�� ?��'}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-slate-100">
                            <span class="text-slate-500">R�f�rence</span>
                            <span class="font-mono text-slate-600">${tx.reference || '�� ?��'}</span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-slate-500">Date</span>
                            <span class="font-bold text-slate-900">${CORE.formatDate(tx.createdAt)} �� ${CORE.formatTime(tx.createdAt)}</span>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' },
                { label: 'Supprimer', onclick: `VendeurModule.deleteTransaction(${txId})`, class: 'px-4 py-2 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700' }
            ]);
        },

        deleteTransaction(txId) {
            if (!confirm('Supprimer cette transaction ?')) return;
            CORE.db.financialTransactions = CORE.db.financialTransactions?.filter(t => t.id !== txId) || [];
            CORE.save();
            UI.closeModal();
            UI.toast('Transaction supprim�e', 'success');
            App.rerender();
        },

        exportFinanceReport() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            // FILTR� PAR POS
            const txs = CORE.db.financialTransactions?.filter(t => t.userId === uid && (t.posId == userPos || !t.posId)) || [];
            const metrics = CORE.getFinancialMetrics(uid, null, null, userPos);
            
            let csv = 'Date,Type,Cat�gorie,Description,R�f�rence,Montant\\n';
            txs.forEach(t => {
                csv += `"${CORE.formatDate(t.createdAt)}","${t.type}","${t.category || ''}","${(t.note || '').replace(/"/g, '""')}","${t.reference || ''}","${t.type === 'income' ? '+' : '-'}${t.amount}"\\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'rapport_financier_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
            UI.toast('Rapport export� en CSV', 'success');
        },

        renderProfitabilityAnalysis() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'Mon POS';
            const byClient = CORE.getProfitByClient(uid);
            const byCategory = CORE.getProfitByCategory(uid);

            return `
                <div class="fade-in max-w-6xl mx-auto space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">��Ÿ?�? Analyse de Rentabilit�</h2>
                            <p class="text-slate-500 font-medium mt-1">${posName} - Profit par client et par cat�gorie</p>
                        </div>
                        <button onclick="CORE.state.financeView = 'overview'; App.rerender()" class="px-4 py-2 bg-slate-200 text-slate-900 rounded-xl font-bold hover:bg-slate-300 transition">Retour</button>
                    </div>

                    <!-- Profit par Client -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm">
                        <h3 class="text-xl font-black text-slate-900 mb-4">��Ÿ? � Top Clients par Profit</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50">
                                    <tr class="text-xs font-black text-slate-500 uppercase">
                                        <th class="px-4 py-3">Client</th>
                                        <th class="px-4 py-3 text-right">Commandes</th>
                                        <th class="px-4 py-3 text-right">Revenu</th>
                                        <th class="px-4 py-3 text-right">D�penses</th>
                                        <th class="px-4 py-3 text-right">Profit</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${byClient.slice(0, 10).map(c => `
                                        <tr class="hover:bg-slate-50 transition">
                                            <td class="px-4 py-3 font-bold">${c.name}</td>
                                            <td class="px-4 py-3 text-right">${c.orderCount}</td>
                                            <td class="px-4 py-3 text-right text-emerald-600 font-bold">+${CORE.formatPrice(c.revenue)}</td>
                                            <td class="px-4 py-3 text-right text-red-600">-${CORE.formatPrice(c.expenses)}</td>
                                            <td class="px-4 py-3 text-right font-black ${c.profit > 0 ? 'text-blue-600' : 'text-red-600'}">${c.profit > 0 ? '+' : ''}${CORE.formatPrice(c.profit)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Profit par Cat�gorie -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm">
                        <h3 class="text-xl font-black text-slate-900 mb-4">��Ÿ? � Profit par Cat�gorie</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${byCategory.map(cat => `
                                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                                    <div class="font-bold text-slate-900 mb-2">${cat.name}</div>
                                    <div class="text-2xl font-black text-blue-600">${CORE.formatPrice(cat.profit)}</div>
                                    <div class="text-xs text-slate-500 mt-2">${cat.orderCount} commandes �� ?� � ${CORE.formatPrice(cat.revenue)} CA</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
        },

        renderFinanceStatement() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'Mon POS';
            const dateFrom = CORE.state.financeDateFrom || null;
            const dateTo = CORE.state.financeDateTo || null;
            // FILTR� PAR POS
            const stmt = CORE.getFinancialStatement(uid, dateFrom, dateTo, userPos);
            const taxes = CORE.calculateTaxesOwed(uid, dateFrom, dateTo, userPos);

            return `
                <div class="fade-in max-w-4xl mx-auto space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">��Ÿ?� �tats Financiers</h2>
                            <p class="text-slate-500 font-medium mt-1">${posName} - Compte de r�sultat simplifi�</p>
                        </div>
                        <button onclick="CORE.state.financeView = 'overview'; App.rerender()" class="px-4 py-2 bg-slate-200 text-slate-900 rounded-xl font-bold hover:bg-slate-300 transition">Retour</button>
                    </div>

                    <!-- Compte de R�sultat (P&L) -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-8 shadow-sm space-y-6">
                        <div>
                            <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-6">Compte de R�sultat</div>
                            
                            <div class="space-y-4 border-b-2 border-slate-200 pb-6 mb-6">
                                <div class="flex justify-between items-center">
                                    <div class="font-bold text-slate-900">Ventes</div>
                                    <div class="text-right">
                                        <div class="font-bold text-emerald-600">${CORE.formatPrice(stmt.revenues.sales)}</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <div class="text-sm text-slate-600">Autres Revenus</div>
                                    <div class="text-right text-emerald-600">${CORE.formatPrice(stmt.revenues.other)}</div>
                                </div>
                                <div class="flex justify-between items-center font-black text-lg">
                                    <div>Total Revenus</div>
                                    <div class="text-emerald-600">${CORE.formatPrice(stmt.revenues.total)}</div>
                                </div>
                            </div>

                            <div class="space-y-4 border-b-2 border-slate-200 pb-6 mb-6">
                                <div class="flex justify-between items-center">
                                    <div class="font-bold text-slate-900">Commissions Livreurs</div>
                                    <div class="text-right">
                                        <div class="font-bold text-red-600">-${CORE.formatPrice(stmt.expenses.commissions)}</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <div class="text-sm text-slate-600">Frais Op�rationnels</div>
                                    <div class="text-right text-red-600">-${CORE.formatPrice(stmt.expenses.operational)}</div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <div class="text-sm text-slate-600">Autres D�penses</div>
                                    <div class="text-right text-red-600">-${CORE.formatPrice(stmt.expenses.other)}</div>
                                </div>
                                <div class="flex justify-between items-center font-black text-lg">
                                    <div>Total D�penses</div>
                                    <div class="text-red-600">-${CORE.formatPrice(stmt.expenses.total)}</div>
                                </div>
                            </div>

                            <div class="space-y-4 border-b-2 border-slate-200 pb-6 mb-6">
                                <div class="flex justify-between items-center font-bold text-lg">
                                    <div>B�n�fice Brut</div>
                                    <div class="text-blue-600">${CORE.formatPrice(stmt.grossProfit)}</div>
                                </div>
                            </div>

                            <div class="space-y-4 pb-6">
                                <div class="flex justify-between items-center">
                                    <div class="font-bold text-slate-900">Imp��ts (${stmt.taxRate})</div>
                                    <div class="text-right">
                                        <div class="font-bold text-orange-600">-${CORE.formatPrice(stmt.taxes)}</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center font-black text-xl bg-emerald-50 p-4 rounded-2xl">
                                    <div>B�n�fice Net</div>
                                    <div class="text-emerald-600">${CORE.formatPrice(stmt.netProfit)}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Taxes Dues -->
                    <div class="bg-orange-50 border border-orange-200 rounded-3xl p-6">
                        <h3 class="text-lg font-black text-slate-900 mb-4">��š ��� � � Simulation d'Imp��ts</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <div class="text-sm text-slate-600 mb-1">Revenu imposable</div>
                                <div class="text-2xl font-black text-slate-900">${CORE.formatPrice(taxes.taxableIncome)}</div>
                            </div>
                            <div>
                                <div class="text-sm text-slate-600 mb-1">Imp��ts estim�s</div>
                                <div class="text-2xl font-black text-orange-600">${CORE.formatPrice(taxes.taxesOwed)}</div>
                            </div>
                        </div>
                        
                        <!-- Champs modifiables -->
                        <div class="border-t border-orange-200 pt-4">
                            <div class="text-xs font-black text-orange-700 uppercase mb-3">Param��tres personnalis�s</div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-700 mb-1">Taux personnalis� (%)</label>
                                    <input type="number" id="custom_tax_rate" placeholder="${taxes.taxRate}" min="0" max="100" step="0.1" class="w-full px-3 py-2 border border-orange-300 rounded-lg bg-white text-sm font-bold focus:ring-2 focus:ring-orange-500 outline-none">
                                    <div class="text-[10px] text-slate-500 mt-1">Laisser vide pour valeur par d�faut</div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-700 mb-1">�ch�ance (date)</label>
                                    <input type="date" id="custom_due_date" value="${taxes.dueDate}" class="w-full px-3 py-2 border border-orange-300 rounded-lg bg-white text-sm font-bold focus:ring-2 focus:ring-orange-500 outline-none">
                                </div>
                            </div>
                            <button onclick="VendeurModule.recalculateTaxes()" class="w-full mt-3 px-4 py-2 bg-orange-600 text-white rounded-lg font-black text-sm hover:bg-orange-700 transition flex items-center justify-center gap-2">
                                <i data-lucide="calculator" class="w-4 h-4"></i> Recalculer
                            </button>
                        </div>
                    </div>
                </div>`;
        },

        renderFinanceActivity() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'Mon POS';
            const dateFrom = CORE.state.financeDateFrom || '';
            const dateTo = CORE.state.financeDateTo || '';
            
            // FILTR� PAR POS
            let txs = CORE.db.financialTransactions.filter(t => t.userId === uid && (t.posId == userPos || !t.posId));

            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                fromDate.setHours(0, 0, 0, 0);
                txs = txs.filter(t => new Date(t.createdAt) >= fromDate);
            }
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                txs = txs.filter(t => new Date(t.createdAt) <= toDate);
            }

            txs = txs.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

            return `
                <div class="fade-in max-w-5xl mx-auto space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">��Ÿ�? Activit� Financi��re</h2>
                            <p class="text-slate-500 font-medium mt-1">${posName} - Historique d�taill� de toutes les transactions</p>
                        </div>
                        <button onclick="CORE.state.financeView = 'overview'; App.rerender()" class="px-4 py-2 bg-slate-200 text-slate-900 rounded-xl font-bold hover:bg-slate-300 transition">Retour</button>
                    </div>

                    <!-- Filtres Date -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-900 mb-2">De</label>
                                <input type="date" value="${dateFrom}" 
                                    onchange="CORE.state.financeDateFrom = this.value; App.rerender()"
                                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-900 mb-2">Jusqu'��</label>
                                <input type="date" value="${dateTo}" 
                                    onchange="CORE.state.financeDateTo = this.value; App.rerender()"
                                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                        ${dateFrom || dateTo ? `<div class="text-xs text-slate-500 mt-4">Affichage de ${txs.length} transaction(s)</div>` : ''}
                    </div>

                    <!-- Tableau Transactions -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                <tr>
                                    <th class="px-6 py-4">Type</th>
                                    <th class="px-6 py-4">Cat�gorie</th>
                                    <th class="px-6 py-4">Note</th>
                                    <th class="px-6 py-4 text-right">Montant</th>
                                    <th class="px-6 py-4 text-right">Date</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50">
                                ${txs.length === 0 ? `<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400 italic">Aucune transaction trouv�e</td></tr>` : ''}
                                ${txs.map(t => `
                                    <tr class="hover:bg-slate-50 transition">
                                        <td class="px-6 py-4">
                                            <span class="px-3 py-1 rounded-full text-xs font-bold ${
                                                t.type === 'income' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'
                                            }">
                                                ${t.type === 'income' ? '��Ÿ?�? Revenu' : '��Ÿ?� D�pense'}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 font-bold text-slate-900">${t.category || 'N/A'}</td>
                                        <td class="px-6 py-4">${t.note || 'N/A'}</td>
                                        <td class="px-6 py-4 text-right font-black ${t.type === 'income' ? 'text-emerald-600' : 'text-red-600'}">
                                            ${t.type === 'income' ? '+' : '-'}${CORE.formatPrice(t.amount)}
                                        </td>
                                        <td class="px-6 py-4 text-right text-xs text-slate-500">${CORE.formatDate(t.createdAt)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        },

        showTaxesModal() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            // FILTR� PAR POS
            const taxes = CORE.calculateTaxesOwed(uid, null, null, userPos);

            UI.modal('Simulation d\'Imp��ts', `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-blue-50 rounded-2xl border border-blue-200">
                            <div class="text-sm text-blue-700 font-bold mb-2">Revenu Imposable</div>
                            <div class="text-2xl font-black text-blue-900">${CORE.formatPrice(taxes.taxableIncome)}</div>
                        </div>
                        <div class="p-4 bg-orange-50 rounded-2xl border border-orange-200">
                            <div class="text-sm text-orange-700 font-bold mb-2">Imp��ts Estim�s</div>
                            <div class="text-2xl font-black text-orange-900">${CORE.formatPrice(taxes.taxesOwed)}</div>
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-2xl">
                        <div class="text-sm text-slate-600 mb-2">Taux: <strong>${taxes.taxRate}</strong></div>
                        <div class="text-sm text-slate-600 mb-2">�ch�ance: <strong>${taxes.dueDate}</strong></div>
                        <div class="text-xs text-slate-500 pt-3 border-t border-slate-200 mt-3">
                            Cette estimation est bas�e sur vos transactions financi��res enregistr�es. Consultez un expert-comptable pour validation.
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showNewExpenseModal() {
            const expenseCategories = [
                { value: 'stock', label: '��Ÿ? � Achat de stock/produits' },
                { value: 'transport', label: '��Ÿšš Frais de transport' },
                { value: 'salaire', label: '��Ÿ? � Salaires' },
                { value: 'loyer', label: '��Ÿ � � Loyer/Local' },
                { value: 'electricite', label: '��š � �lectricit�/Eau' },
                { value: 'telephone', label: '��Ÿ? � T�l�phone/Internet' },
                { value: 'maintenance', label: '��Ÿ� � Maintenance/R�paration' },
                { value: 'hygieneEntretien', label: '��Ÿ � � Hygi��ne/Entretien' },
                { value: 'publicite', label: '��Ÿ? � Publicit�/Marketing' },
                { value: 'assurance', label: '��Ÿ� ��� � � Assurance' },
                { value: 'taxe', label: '��Ÿ? � Taxes/Imp��ts' },
                { value: 'banque', label: '��Ÿ � � Frais bancaires' },
                { value: 'deplacement', label: '��Ÿš? D�placement/Carburant' },
                { value: 'formation', label: '��Ÿ?š Formation/Cours' },
                { value: 'equipement', label: '��Ÿ� ��� � � �quipement/Mat�riel' },
                { value: 'autre', label: '��Ÿ?� Autre' }
            ];

            UI.modal('Nouvelle d�pense', `
                <div class="space-y-4">
                    ${UI.input('ve_amount', 'Montant', 'number', '', 'ex: 5000', true)}
                    ${UI.select('ve_category', 'Motif / Cat�gorie', expenseCategories, 'stock', true)}
                    ${UI.textarea('ve_note', 'D�tails additionnels', '', 'ex: Achat de produits �� Kinshasa le 15 Jan...', 2)}
                    ${UI.input('ve_ref', 'R�f�rence (optionnel)', 'text', '', 'Ticket de caisse...')}
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">
                        Cette d�pense sera enregistr�e dans la comptabilit� du point de vente en tant que "Sortie Cash".
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Valider', onclick: 'VendeurModule.saveExpense()', class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);
        },

        saveExpense() {
            const amount = Number(UI.val('ve_amount') || 0);
            const category = UI.val('ve_category') || 'autre';
            const note = UI.val('ve_note').trim();
            const ref = UI.val('ve_ref').trim();

            if (amount <= 0) return UI.toast('Montant invalide', 'warning');
            if (!category) return UI.toast('Veuillez s�lectionner une cat�gorie', 'warning');

            // Construire la note compl��te avec la cat�gorie s�lectionn�e
            const categoryLabels = {
                'stock': 'Achat de stock/produits',
                'transport': 'Frais de transport',
                'salaire': 'Salaires',
                'loyer': 'Loyer/Local',
                'electricite': '�lectricit�/Eau',
                'telephone': 'T�l�phone/Internet',
                'maintenance': 'Maintenance/R�paration',
                'hygieneEntretien': 'Hygi��ne/Entretien',
                'publicite': 'Publicit�/Marketing',
                'assurance': 'Assurance',
                'taxe': 'Taxes/Imp��ts',
                'banque': 'Frais bancaires',
                'deplacement': 'D�placement/Carburant',
                'formation': 'Formation/Cours',
                'equipement': '�quipement/Mat�riel',
                'autre': 'Autre'
            };

            const categoryLabel = categoryLabels[category] || category;
            const fullNote = `[${categoryLabel}] ${note}`;

            CORE.recordFinancialTransaction({
                type: 'expense',
                category: 'expense',
                amount,
                method: 'cash',
                ref,
                note: fullNote,
                posId: CORE.state.currentUser?.pos,
                cityId: CORE.state.currentUser?.city,
                settled: true
            });

            UI.closeModal();
            UI.toast('D�pense enregistr�e', 'success');
            App.rerender();
        },

        recalculateTaxes() {
            const customTaxRate = document.getElementById('custom_tax_rate')?.value;
            const customDueDate = document.getElementById('custom_due_date')?.value;
            
            if (!customTaxRate && !customDueDate) {
                UI.toast('Veuillez modifier au moins un param��tre', 'warning');
                return;
            }
            
            // Sauvegarder les param��tres personnalis�s
            this.state.customTaxRate = customTaxRate ? parseFloat(customTaxRate) : null;
            this.state.customDueDate = customDueDate || null;
            
            CORE.save();
            UI.toast('Param��tres d\'imp��t mises �� jour ���??', 'success');
            App.rerender();
        },

        renderCommissions() {
            const userPos = CORE.user?.pos;
            if (!userPos) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assign�</div></div>`;
            }
            
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'POS ' + userPos;
            const livreurs = CORE.getLivreursForPOS(userPos);
            
            return `
                <div class="space-y-6 max-w-6xl fade-in">
                    <div>
                        <h2 class="text-2xl font-black text-slate-900">Gestion des Commissions</h2>
                        <p class="text-sm text-slate-500 font-medium mt-1">${posName} - Fixez les taux de commission pour chaque livreur.</p>
                    </div>

                    ${livreurs.length === 0 ? `
                        <div class="bg-white rounded-3xl border border-slate-200 p-12 text-center">
                            <div class="text-6xl mb-4">��Ÿ? �</div>
                            <div class="text-xl font-bold text-slate-700">Aucun livreur</div>
                            <p class="text-slate-500 mt-2">Aucun livreur n'est assign� �� ${posName}</p>
                        </div>
                    ` : `
                        <div class="grid grid-cols-1 gap-4">
                            ${livreurs.map(l => {
                                const comm = CORE.getLivreurCommission(l.id);
                                const percent = comm?.commissionPercent || 5;
                                const fixed = comm?.commissionFixed || 0;
                                const escapedName = (l.name || '').replace(/'/g, "\\'");
                                return `
                                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden hover:shadow-lg transition">
                                        <div class="p-6">
                                            <div class="flex items-center gap-4 mb-6">
                                                <div class="w-12 h-12 gradient-livreur rounded-2xl flex items-center justify-center text-white font-black text-lg">${l.avatar || '��Ÿšš'}</div>
                                                <div class="flex-1">
                                                    <div class="font-black text-slate-900 text-lg">${l.name}${l.independent ? ' �� � �' : ''}</div>
                                                    <div class="text-xs text-slate-500 font-bold">${l.vehicle || 'V�hicule non sp�cifi�'}${l.independent ? ' �� ?� � Ind�pendant' : ''}</div>
                                                </div>
                                                <button onclick="VendeurModule.editLivreurCommission('${l.id}', '${escapedName}')" class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-black hover:bg-emerald-700 transition">
                                                    Modifier
                                                </button>
                                            </div>

                                            <div class="grid grid-cols-2 gap-4">
                                                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Commission %</div>
                                                    <div class="text-2xl font-black text-slate-900 mt-2">${percent}%</div>
                                                    <div class="text-[10px] text-slate-400 mt-1">du montant</div>
                                                </div>
                                                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Commission Fixe</div>
                                                    <div class="text-2xl font-black text-slate-900 mt-2">${CORE.formatPrice(fixed)}</div>
                                                    <div class="text-[10px] text-slate-400 mt-1">par livraison</div>
                                                </div>
                                            </div>

                                            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-2xl">
                                                <div class="text-xs text-blue-700 font-bold">Exemple</div>
                                                <div class="text-sm text-blue-900 font-bold mt-1">Livraison de 50 000 FCFA = ${CORE.formatPrice(Math.round(50000 * (percent/100)) + fixed)}</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>`;
        },

        editLivreurCommission(livreurId, livreurName) {
            const comm = CORE.getLivreurCommission(livreurId);
            const percent = comm?.commissionPercent || 5;
            const fixed = comm?.commissionFixed || 0;
            const escapedName = (livreurName || '').replace(/'/g, "\\'");

            UI.modal(`Modifier Commission - ${livreurName}`, `
                <div class="space-y-5">
                    <div>
                        <label class="text-sm font-black text-slate-700 block mb-2">Pourcentage (%)</label>
                        <div class="flex items-center gap-3">
                            <input type="number" id="comm_percent" value="${percent}" min="0" max="100" step="0.5" class="flex-1 px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            <span class="text-2xl font-black text-slate-900">%</span>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Pourcentage appliqu� au montant total de chaque livraison</p>
                    </div>

                    <div>
                        <label class="text-sm font-black text-slate-700 block mb-2">Commission Fixe (FCFA)</label>
                        <input type="number" id="comm_fixed" value="${fixed}" min="0" step="500" class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                        <p class="text-xs text-slate-500 mt-2">Montant fixe ajout� �� chaque livraison</p>
                    </div>

                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                        <div class="text-xs font-black text-emerald-700 uppercase">Exemple Calcul�</div>
                        <div class="mt-2 text-sm">
                            <div class="text-emerald-900 font-bold">Livraison 50 000 FCFA:</div>
                            <div class="text-emerald-700 mt-1">= (50 000 �?? <span id="percent_display">${percent}</span>%) + <span id="fixed_display">${CORE.formatPrice(fixed)}</span></div>
                            <div class="text-lg font-black text-emerald-900 mt-2">= <span id="total_display">${CORE.formatPrice(Math.round(50000 * (percent/100)) + fixed)}</span></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="document.getElementById('comm_percent').value=5; VendeurModule.updateCommissionPreview('${livreurId}')" class="py-2 px-3 bg-slate-100 text-slate-700 rounded-lg text-xs font-black hover:bg-slate-200">5% (d�faut)</button>
                        <button onclick="document.getElementById('comm_percent').value=10; VendeurModule.updateCommissionPreview('${livreurId}')" class="py-2 px-3 bg-slate-100 text-slate-700 rounded-lg text-xs font-black hover:bg-slate-200">10%</button>
                        <button onclick="document.getElementById('comm_percent').value=15; VendeurModule.updateCommissionPreview('${livreurId}')" class="py-2 px-3 bg-slate-100 text-slate-700 rounded-lg text-xs font-black hover:bg-slate-200">15%</button>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()', class: 'px-4 py-2 rounded-xl bg-slate-200 text-slate-700 font-black hover:bg-slate-300' },
                { label: 'Sauvegarder', onclick: `VendeurModule.saveLivreurCommission('${livreurId}', '${escapedName}')`, class: 'px-4 py-2 rounded-xl bg-emerald-600 text-white font-black hover:bg-emerald-700' }
            ]);
        },

        updateCommissionPreview(livreurId) {
            const percent = Number(document.getElementById('comm_percent')?.value || 5);
            const fixed = Number(document.getElementById('comm_fixed')?.value || 0);
            const sample = 50000;
            const total = Math.round(sample * (percent / 100)) + fixed;
            
            document.getElementById('percent_display').textContent = percent;
            document.getElementById('fixed_display').textContent = CORE.formatPrice(fixed);
            document.getElementById('total_display').textContent = CORE.formatPrice(total);
        },

        saveLivreurCommission(livreurId, livreurName) {
            const percent = Number(document.getElementById('comm_percent')?.value || 5);
            const fixed = Number(document.getElementById('comm_fixed')?.value || 0);

            if (percent < 0 || percent > 100) {
                UI.toast('Le pourcentage doit ��tre entre 0 et 100', 'error');
                return;
            }

            if (fixed < 0) {
                UI.toast('La commission fixe ne peut pas ��tre n�gative', 'error');
                return;
            }

            CORE.setLivreurCommission(livreurId, percent, fixed);
            UI.closeModal();
            UI.toast(`Commission de ${livreurName} mise �� jour`, 'success');
            App.rerender();
        },

        showChangePersonalPasswordModal() {
            UI.modal('��Ÿ�? Changer votre mot de passe', `
                <div class="space-y-4">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl flex items-center gap-3">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-amber-600 flex-shrink-0"></i>
                        <div class="text-sm text-amber-800 font-medium">Utilisez un mot de passe fort (min 6 caract��res)</div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Ancien mot de passe</label>
                        <input type="password" id="old_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Entrez votre ancien mot de passe">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Nouveau mot de passe</label>
                        <input type="password" id="new_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Entrez un nouveau mot de passe">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Confirmation du nouveau mot de passe</label>
                        <input type="password" id="confirm_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Confirmez le nouveau mot de passe">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Changer le mot de passe', onclick: 'VendeurModule.savePersonalPasswordChange()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' }
            ]);
        },

        async savePersonalPasswordChange() {
            const oldPwd = UI.val('old_pwd');
            const newPwd = UI.val('new_pwd');
            const confirmPwd = UI.val('confirm_pwd');
            const user = CORE.state.currentUser;
            
            if (!oldPwd || !newPwd || !confirmPwd) {
                UI.toast('Tous les champs sont obligatoires', 'error');
                return;
            }
            
            if (newPwd.length < 6) {
                UI.toast('Le nouveau mot de passe doit contenir au moins 6 caract��res', 'error');
                return;
            }
            
            if (newPwd !== confirmPwd) {
                UI.toast('Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            const oldPwdHash = await Utils.md5(oldPwd);
            if (oldPwdHash !== user.passwordHash) {
                UI.toast('Ancien mot de passe incorrect', 'error');
                return;
            }
            
            const newPwdHash = await Utils.md5(newPwd);
            user.passwordHash = newPwdHash;
            
            const userIndex = CORE.db.users.findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
                CORE.db.users[userIndex] = user;
                CORE.save();
                UI.closeModal();
                UI.toast('���?? Mot de passe chang� avec succ��s', 'success');
                App.rerender();
            } else {
                UI.toast('Erreur lors de la mise �� jour de l\'utilisateur', 'error');
            }
        },

        // Modal de configuration des preuves de validation de livraison
        showDeliveryValidationSettingsModal() {
            const user = CORE.state.currentUser;
            if (!user) return;

            const posId = user.pos;
            const settings = CORE.getDeliveryValidationSettings(posId);
            const posData = CORE.getPOS(posId);

            UI.modal('���?? Param��tres de validation des livraisons', `
                <div class="space-y-4">
                    <!-- En-t��te info POS -->
                    <div class="p-4 bg-gradient-to-r from-teal-50 to-cyan-50 border border-teal-200 rounded-2xl">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-teal-500 rounded-xl flex items-center justify-center">
                                <i data-lucide="store" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-teal-900">${posData?.name || 'Point de vente'}</div>
                                <div class="text-xs text-teal-600">Ces param��tres s'appliquent aux livreurs de ce POS</div>
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="flex items-start gap-3">
                            <i data-lucide="info" class="w-5 h-5 text-blue-600 mt-0.5"></i>
                            <div class="text-sm text-blue-800">
                                Configurez les preuves que vos livreurs doivent fournir pour valider une livraison. 
                                Ces param��tres affectent tous les livreurs assign�s �� ce point de vente.
                            </div>
                        </div>
                    </div>

                    <!-- Options principales -->
                    <div class="space-y-3">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Preuves requises</div>
                        
                        <!-- Exiger photo -->
                        <div class="flex items-center justify-between p-4 rounded-xl bg-white border border-slate-200 hover:border-emerald-300 transition">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="camera" class="w-5 h-5 text-emerald-600"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-slate-800">Photos de livraison</div>
                                    <div class="text-xs text-slate-500">Le livreur doit prendre des photos</div>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="validation_require_photo" ${settings.requirePhoto ? 'checked' : ''} onchange="VendeurModule.toggleValidationPhotoOptions()" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                            </label>
                        </div>

                        <!-- Options photos (min photos) -->
                        <div id="photo_options_container" class="${settings.requirePhoto ? '' : 'hidden'} ml-6 p-3 bg-slate-50 rounded-xl border border-slate-200">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-slate-700">Nombre minimum de photos</span>
                                <select id="validation_min_photos" onchange="VendeurModule.updateValidationSummary()" class="px-3 py-1.5 rounded-lg border border-slate-200 text-sm font-bold">
                                    ${[1, 2, 3, 4, 5].map(n => `<option value="${n}" ${settings.minPhotos === n ? 'selected' : ''}>${n}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <!-- Exiger signature -->
                        <div class="flex items-center justify-between p-4 rounded-xl bg-white border border-slate-200 hover:border-blue-300 transition">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                    <span class="text-xl">���? ��� � �</span>
                                </div>
                                <div>
                                    <div class="font-bold text-slate-800">Signature client</div>
                                    <div class="text-xs text-slate-500">Le client doit signer sur l'�cran</div>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="validation_require_signature" ${settings.requireSignature ? 'checked' : ''} onchange="VendeurModule.updateValidationSummary()" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                            </label>
                        </div>

                        <!-- Exiger les deux -->
                        <div class="flex items-center justify-between p-4 rounded-xl bg-white border border-slate-200 hover:border-purple-300 transition">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="shield-check" class="w-5 h-5 text-purple-600"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-slate-800">Exiger les deux</div>
                                    <div class="text-xs text-slate-500">Photo ET signature obligatoires</div>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="validation_require_both" ${settings.requireBoth ? 'checked' : ''} onchange="VendeurModule.updateValidationSummary()" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-500"></div>
                            </label>
                        </div>
                    </div>

                    <!-- R�sum� de la configuration -->
                    <div id="validation_summary" class="p-4 bg-slate-100 rounded-xl">
                        <div class="text-xs font-bold text-slate-500 uppercase mb-2">Configuration actuelle</div>
                        <div class="text-sm text-slate-700" id="validation_summary_text">
                            ${this.getValidationSummaryText(settings)}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: '��Ÿ? � Enregistrer', onclick: 'VendeurModule.saveDeliveryValidationSettings()', class: 'px-5 py-2.5 bg-teal-600 text-white font-black rounded-xl hover:bg-teal-700' }
            ]);

            setTimeout(() => lucide.createIcons(), 50);
        },

        // Toggle des options photo
        toggleValidationPhotoOptions() {
            const photoEnabled = document.getElementById('validation_require_photo')?.checked;
            const container = document.getElementById('photo_options_container');
            if (container) {
                if (photoEnabled) {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            }
            this.updateValidationSummary();
        },

        // Mettre �� jour le r�sum�
        updateValidationSummary() {
            const settings = {
                requirePhoto: document.getElementById('validation_require_photo')?.checked || false,
                requireSignature: document.getElementById('validation_require_signature')?.checked || false,
                requireBoth: document.getElementById('validation_require_both')?.checked || false,
                minPhotos: parseInt(document.getElementById('validation_min_photos')?.value || '1')
            };
            const summaryEl = document.getElementById('validation_summary_text');
            if (summaryEl) {
                summaryEl.textContent = this.getValidationSummaryText(settings);
            }
        },

        // G�n�rer le texte de r�sum�
        getValidationSummaryText(settings) {
            if (!settings.requirePhoto && !settings.requireSignature) {
                return '��š ��� � � Aucune preuve requise - Les livreurs peuvent valider sans justificatif';
            }
            if (settings.requireBoth) {
                return `��Ÿ? � + ���? ��� � � Les livreurs doivent fournir ${settings.minPhotos || 1} photo(s) ET la signature du client`;
            }
            if (settings.requirePhoto && settings.requireSignature) {
                return `��Ÿ? � OU ���? ��� � � Les livreurs doivent fournir ${settings.minPhotos || 1} photo(s) OU la signature du client`;
            }
            if (settings.requirePhoto) {
                return `��Ÿ? � Les livreurs doivent fournir ${settings.minPhotos || 1} photo(s) de livraison`;
            }
            if (settings.requireSignature) {
                return '���? ��� � � Les livreurs doivent obtenir la signature du client';
            }
            return 'Configuration personnalis�e';
        },

        // Sauvegarder les param��tres de validation
        saveDeliveryValidationSettings() {
            const user = CORE.state.currentUser;
            if (!user) return;

            const posId = user.pos;
            const settings = {
                requirePhoto: document.getElementById('validation_require_photo')?.checked || false,
                requireSignature: document.getElementById('validation_require_signature')?.checked || false,
                requireBoth: document.getElementById('validation_require_both')?.checked || false,
                minPhotos: parseInt(document.getElementById('validation_min_photos')?.value || '1'),
                maxPhotos: 5
            };

            CORE.saveDeliveryValidationSettings(posId, settings);
            UI.closeModal();
            UI.toast('���?? Param��tres de validation enregistr�s', 'success');
        },

        // ========== RAPPORTS ET KPIs PAR POS ==========
        renderReports() {
            const userPos = CORE.user?.pos;
            if (!userPos) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assign�</div></div>`;
            }
            
            const kpis = CORE.getPOSKPIs(userPos);
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'POS ' + userPos;
            const topVendors = CORE.getTopVendorsByPOS(userPos, 5);
            const topDelivery = CORE.getTopDeliveryPersonnelByPOS(userPos, 5);
            
            // Trouver le rang du vendeur actuel
            const currentUser = CORE.user;
            const myRank = topVendors.findIndex(v => v.id === currentUser?.id) + 1;
            const myStats = topVendors.find(v => v.id === currentUser?.id) || { revenue: 0, orderCount: 0, avgOrder: 0, rating: 0 };
            
            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div class="flex items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">��Ÿ?Š Mes Rapports et KPIs</h2>
                            <p class="text-slate-500 font-medium">Performance de ${posName}</p>
                        </div>
                    </div>

                    <!-- Mes Performances Personnelles -->
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl p-6 text-white shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-2xl font-black">${currentUser?.avatar || '��Ÿ? �'}</div>
                            <div>
                                <h3 class="text-xl font-black">${currentUser?.name || 'Vendeur'}</h3>
                                <p class="text-blue-200 text-sm">${myRank > 0 ? '��Ÿ �� Rang #' + myRank + ' dans votre POS' : 'Nouveau vendeur'}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-white/10 rounded-xl p-4">
                                <div class="text-xs text-blue-200 uppercase tracking-wider">Mon Revenu</div>
                                <div class="mt-1 text-2xl font-black">${CORE.formatPrice(myStats.revenue)}</div>
                            </div>
                            <div class="bg-white/10 rounded-xl p-4">
                                <div class="text-xs text-blue-200 uppercase tracking-wider">Mes Commandes</div>
                                <div class="mt-1 text-2xl font-black">${myStats.orderCount}</div>
                            </div>
                            <div class="bg-white/10 rounded-xl p-4">
                                <div class="text-xs text-blue-200 uppercase tracking-wider">Panier Moyen</div>
                                <div class="mt-1 text-2xl font-black">${CORE.formatPrice(myStats.avgOrder)}</div>
                            </div>
                            <div class="bg-white/10 rounded-xl p-4">
                                <div class="text-xs text-blue-200 uppercase tracking-wider">Ma Note</div>
                                <div class="mt-1 text-2xl font-black">�� � � ${myStats.rating || 0}</div>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs du POS -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="p-6 bg-white rounded-2xl border border-slate-200 shadow-sm">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Revenu POS</div>
                            <div class="mt-2 text-3xl font-black text-slate-900">${CORE.formatPrice(kpis?.totalRevenue || 0)}</div>
                            <div class="mt-2 text-xs text-slate-600">${posName}</div>
                        </div>
                        <div class="p-6 bg-white rounded-2xl border border-slate-200 shadow-sm">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Commandes POS</div>
                            <div class="mt-2 text-3xl font-black text-blue-600">${kpis?.totalOrders || 0}</div>
                            <div class="mt-2 text-xs text-slate-600">Dont ${kpis?.deliveredOrders || 0} livr�es</div>
                        </div>
                        <div class="p-6 bg-white rounded-2xl border border-slate-200 shadow-sm">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Taux Livraison</div>
                            <div class="mt-2 text-3xl font-black text-emerald-600">${kpis?.deliveryRate || 0}%</div>
                            <div class="mt-2 text-xs text-slate-600">Succ��s livraisons</div>
                        </div>
                        <div class="p-6 bg-white rounded-2xl border border-slate-200 shadow-sm">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Stock Critique</div>
                            <div class="mt-2 text-3xl font-black ${(kpis?.lowStockProducts || 0) > 0 ? 'text-red-600' : 'text-green-600'}">${kpis?.lowStockProducts || 0}</div>
                            <div class="mt-2 text-xs text-slate-600">Produits �� r�approvisionner</div>
                        </div>
                    </div>

                    <!-- Top Vendeurs et Livreurs du POS -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Top Vendeurs de mon POS -->
                        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-slate-200">
                                <h3 class="text-lg font-black text-slate-900">��Ÿ �� Top Vendeurs - ${posName}</h3>
                            </div>
                            <div class="p-6 space-y-3">
                                ${topVendors.length > 0 ? topVendors.map((v, i) => `
                                    <div class="flex items-center justify-between p-3 ${v.id === currentUser?.id ? 'bg-blue-50 border border-blue-200' : 'bg-slate-50'} rounded-lg">
                                        <div class="flex items-center gap-3">
                                            <span class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 text-white flex items-center justify-center text-sm font-black">${i+1}</span>
                                            <div>
                                                <div class="font-bold text-sm text-slate-900">${v.name} ${v.id === currentUser?.id ? '(Moi)' : ''}</div>
                                                <div class="text-xs text-slate-500">${v.orderCount} cmd �� ?� � ${CORE.formatPrice(v.avgOrder)} moy</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-emerald-600">${CORE.formatPrice(v.revenue)}</div>
                                            <div class="text-xs text-slate-500">�� � � ${v.rating || 0}</div>
                                        </div>
                                    </div>
                                `).join('') : '<div class="text-center text-slate-500 py-4">Aucun vendeur</div>'}
                            </div>
                        </div>

                        <!-- Top Livreurs de mon POS -->
                        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-slate-200">
                                <h3 class="text-lg font-black text-slate-900">��š � Top Livreurs - ${posName}</h3>
                            </div>
                            <div class="p-6 space-y-3">
                                ${topDelivery.length > 0 ? topDelivery.map((l, i) => `
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div class="flex items-center gap-3">
                                            <span class="w-8 h-8 rounded-full bg-gradient-to-br from-orange-400 to-orange-600 text-white flex items-center justify-center text-sm font-black">${i+1}</span>
                                            <div>
                                                <div class="font-bold text-sm text-slate-900">${l.name}</div>
                                                <div class="text-xs text-slate-500">${l.deliveryCount} liv �� ?� � ${l.vehicle}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-blue-600">${l.avgDeliveryTime} min</div>
                                            <div class="text-xs text-slate-500">�� � � ${l.rating || 0}</div>
                                        </div>
                                    </div>
                                `).join('') : '<div class="text-center text-slate-500 py-4">Aucun livreur</div>'}
                            </div>
                        </div>
                    </div>

                    <!-- Revenu Aujourd'hui -->
                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-black text-slate-900">��Ÿ?�? Performance du Jour</h3>
                                <p class="text-slate-500 text-sm">Revenu et commandes aujourd'hui</p>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-black text-emerald-600">${CORE.formatPrice(kpis?.todayRevenue || 0)}</div>
                                <div class="text-sm text-slate-500">${kpis?.todayOrders || 0} commandes</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        showPOSDetailedReportModal(posId) {
            const posData = CORE.getPOS(posId);
            const kpis = CORE.getPOSKPIs(posId);
            const topVendors = CORE.getTopVendorsByPOS(posId, 5);
            const topDelivery = CORE.getTopDeliveryPersonnelByPOS(posId, 5);
            
            let vendorHtml = "";
            topVendors.forEach((v, i) => {
                vendorHtml += '<div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg"><div class="flex items-center gap-2"><span class="font-black text-lg w-8 h-8 flex items-center justify-center bg-gradient-to-br from-blue-400 to-blue-600 text-white rounded-full">' + (i+1) + '</span><div><div class="font-bold text-slate-900">' + v.name + '</div><div class="text-xs text-slate-500">' + v.orderCount + ' commandes</div></div></div><div class="text-right"><div class="font-black text-emerald-600">' + CORE.formatPrice(v.revenue) + '</div><div class="text-xs text-slate-500">Moy: ' + CORE.formatPrice(v.avgOrder) + '</div></div></div>';
            });

            let deliveryHtml = "";
            topDelivery.forEach((l, i) => {
                deliveryHtml += '<div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg"><div class="flex items-center gap-2"><span class="font-black text-lg w-8 h-8 flex items-center justify-center bg-gradient-to-br from-orange-400 to-orange-600 text-white rounded-full">' + (i+1) + '</span><div><div class="font-bold text-slate-900">' + l.name + '</div><div class="text-xs text-slate-500">' + l.vehicle + ' �� ?� � ' + l.deliveryCount + ' livraisons</div></div></div><div class="text-right"><div class="font-black text-blue-600">' + l.avgDeliveryTime + ' min</div><div class="text-xs text-slate-500">' + Math.round(l.totalDistance) + ' km</div></div></div>';
            });
            
            const modalTitle = "Report for " + (posData?.name || "POS " + posId);
            const content = `
                <div class="space-y-6 max-h-[80vh] overflow-y-auto">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl">
                            <div class="text-xs font-black text-blue-600 uppercase">Revenue</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${CORE.formatPrice(kpis.totalRevenue)}</div>
                        </div>
                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                            <div class="text-xs font-black text-emerald-600 uppercase">Orders</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${kpis.totalOrders}</div>
                        </div>
                        <div class="p-4 bg-orange-50 border border-orange-200 rounded-xl">
                            <div class="text-xs font-black text-orange-600 uppercase">Delivery Rate</div>
                            <div class="text-2xl font-black text-orange-900 mt-1">${kpis.deliveryRate}%</div>
                        </div>
                        <div class="p-4 bg-purple-50 border border-purple-200 rounded-xl">
                            <div class="text-xs font-black text-purple-600 uppercase">Low Stock</div>
                            <div class="text-2xl font-black text-purple-900 mt-1">${kpis.lowStockProducts}</div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl border border-slate-200 p-4">
                        <h4 class="font-black text-slate-900 mb-3">Top Vendors</h4>
                        <div class="space-y-2">${vendorHtml}</div>
                    </div>
                    <div class="bg-white rounded-xl border border-slate-200 p-4">
                        <h4 class="font-black text-slate-900 mb-3">Top Delivery Personnel</h4>
                        <div class="space-y-2">${deliveryHtml}</div>
                    </div>
                </div>
            `;
            
            UI.modal(modalTitle, content, [
                { label: "Close", onclick: "UI.closeModal()" }
            ]);
        },

        renderSmartAssignment() {
            const userPos = CORE.user?.pos;
            if (!userPos) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assign�</div></div>`;
            }
            
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'POS ' + userPos;
            const stats = CORE.getLivreurWorkloadStats(userPos);
            const totalDeliveries = stats.reduce((sum, s) => sum + s.completedToday, 0);
            const availableCount = stats.filter(s => s.activeDeliveries === 0).length;
            
            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div class="flex items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">��Ÿšš Assignation Intelligente</h2>
                            <p class="text-slate-500 font-medium">Livreurs de ${posName}</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="px-4 py-2 bg-emerald-100 text-emerald-700 rounded-xl font-bold">
                                ${availableCount} disponible(s)
                            </div>
                            <div class="px-4 py-2 bg-blue-100 text-blue-700 rounded-xl font-bold">
                                ${totalDeliveries} livraisons aujourd'hui
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="p-6 border-b border-slate-200 bg-gradient-to-r from-blue-50 to-indigo-50">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-xl font-black text-slate-900">${posName}</h3>
                                    <p class="text-sm text-slate-600 mt-1">${stats.length} livreur(s) assign�(s)</p>
                                </div>
                            </div>
                        </div>

                        ${stats.length > 0 ? `
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-slate-50 border-b border-slate-200">
                                        <tr>
                                            <th class="px-6 py-3 text-left font-black text-slate-600 uppercase tracking-wider text-xs">Livreur</th>
                                            <th class="px-6 py-3 text-left font-black text-slate-600 uppercase tracking-wider text-xs">V�hicule</th>
                                            <th class="px-6 py-3 text-center font-black text-slate-600 uppercase tracking-wider text-xs">En cours</th>
                                            <th class="px-6 py-3 text-center font-black text-slate-600 uppercase tracking-wider text-xs">Aujourd'hui</th>
                                            <th class="px-6 py-3 text-center font-black text-slate-600 uppercase tracking-wider text-xs">Temps moy</th>
                                            <th class="px-6 py-3 text-right font-black text-slate-600 uppercase tracking-wider text-xs">Distance</th>
                                            <th class="px-6 py-3 text-center font-black text-slate-600 uppercase tracking-wider text-xs">Rating</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-200">
                                        ${stats.map(s => `
                                            <tr class="hover:bg-slate-50 transition">
                                                <td class="px-6 py-4 font-bold text-slate-900">${s.livreurName}</td>
                                                <td class="px-6 py-4 text-slate-700">${s.vehicle}</td>
                                                <td class="px-6 py-4 text-center">
                                                    <span class="px-3 py-1 rounded-lg font-bold text-xs ${s.activeDeliveries === 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">
                                                        ${s.activeDeliveries} 
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 text-center font-bold text-slate-900">${s.completedToday}</td>
                                                <td class="px-6 py-4 text-center text-slate-700">${s.avgDeliveryTime} min</td>
                                                <td class="px-6 py-4 text-right text-slate-700">${Math.round(s.totalDistance)} km</td>
                                                <td class="px-6 py-4 text-center font-bold text-slate-900">�� � � ${s.rating}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div class="p-12 text-center">
                                <div class="text-6xl mb-4">��Ÿšš</div>
                                <div class="text-xl font-bold text-slate-700">Aucun livreur assign�</div>
                                <p class="text-slate-500 mt-2">Aucun livreur n'est actuellement assign� �� ${posName}</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        },

        renderAuditLog() {
            const posId = CORE.state.currentUser?.pos;
            // Filtrer par POS ET par r��le (vendeur et livreur uniquement - pas les sup�rieurs)
            const allowedRoles = ['vendeur', 'livreur'];
            const auditLogs = (CORE.db.auditLogs || []).filter(log => 
                log.posId == posId && allowedRoles.includes(log.userRole)
            ).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            const actionColors = {
                'create': 'emerald',
                'update': 'blue',
                'delete': 'red',
                'assign': 'purple',
                'deposit': 'amber',
                'status_change': 'cyan',
                'export': 'slate',
                'validate': 'green',
                'transfer_out': 'orange'
            };

            const entityIcons = {
                'order': 'receipt',
                'delivery': 'truck',
                'deposit': 'wallet',
                'product': 'box',
                'user': 'user',
                'shift': 'calendar',
                'inventory': 'package',
                'stock': 'package'
            };

            const posName = CORE.getPOS(posId)?.name || 'Mon POS';

            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">��Ÿ?� Journal d'Audit</h2>
                            <p class="text-slate-500 font-medium">Tra��abilit� des actions sur <strong>${posName}</strong></p>
                        </div>
                        <button onclick="VendeurModule.exportVendeurAuditLog()" class="px-4 py-2 bg-slate-900 text-white rounded-xl font-black hover:bg-slate-800 transition flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Exporter
                        </button>
                    </div>

                    <!-- Statistiques -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">Total �v�nements</div>
                            <div class="text-4xl font-black text-slate-900 mt-2">${auditLogs.length}</div>
                            <p class="text-xs text-slate-400 mt-2">Enregistr�s</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">Cr�ations</div>
                            <div class="text-4xl font-black text-emerald-600 mt-2">${auditLogs.filter(l => l.action === 'create').length}</div>
                            <p class="text-xs text-slate-400 mt-2">Nouveaux �l�ments</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">Modifications</div>
                            <div class="text-4xl font-black text-blue-600 mt-2">${auditLogs.filter(l => l.action === 'update' || l.action === 'status_change').length}</div>
                            <p class="text-xs text-slate-400 mt-2">Changements</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">Transferts</div>
                            <div class="text-4xl font-black text-orange-600 mt-2">${auditLogs.filter(l => l.action === 'transfer_out').length}</div>
                            <p class="text-xs text-slate-400 mt-2">Sorties de stock</p>
                        </div>
                    </div>

                    <!-- Tableau des logs -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="text-xl font-black text-slate-900">Historique des actions</h3>
                            <span class="text-sm text-slate-500">${auditLogs.length} r�sultat(s)</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 border-b border-slate-100">
                                    <tr>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Date/Heure</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Utilisateur</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Action</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Entit�</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">D�tails</th>
                                        <th class="px-6 py-3 text-center font-black text-slate-900">Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${auditLogs.length === 0 ? '<tr><td colspan="6" class="px-6 py-10 text-center text-slate-400 italic">Aucun �v�nement enregistr�</td></tr>' : ''}
                                    ${auditLogs.slice(0, 100).map(log => {
                                        return `<tr class="border-b border-slate-100 hover:bg-slate-50 transition">
                                            <td class="px-6 py-4">
                                                <div class="font-black text-slate-900 text-xs">${new Date(log.timestamp).toLocaleDateString('fr-FR')}</div>
                                                <div class="text-[10px] text-slate-500">${new Date(log.timestamp).toLocaleTimeString('fr-FR')}</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="font-black text-slate-900">${log.userName || 'Syst��me'}</div>
                                                <div class="text-[10px] text-slate-500 uppercase">${log.userRole || ''}</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                ${UI.badge(log.action, actionColors[log.action] || 'slate')}
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="flex items-center gap-2">
                                                    <i data-lucide="${entityIcons[log.entity] || 'file'}" class="w-4 h-4 text-slate-400"></i>
                                                    <span class="font-black text-slate-900">${log.entity || '�� ?��'}</span>
                                                </div>
                                                <div class="text-[10px] text-slate-500">#${log.entityId || '�� ?��'}</div>
                                            </td>
                                            <td class="px-6 py-4 text-sm text-slate-600">
                                                <div class="max-w-xs truncate">${log.entityName || '�� ?��'}</div>
                                                <div class="text-[10px] text-slate-400 mt-1">${log.details || '�� ?��'}</div>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                ${UI.badge(log.status || 'recorded', 'emerald')}
                                            </td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                            ${auditLogs.length > 100 ? `<div class="p-4 text-center text-slate-500 text-xs">Affichage des 100 premiers r�sultats. Total: ${auditLogs.length}</div>` : ''}
                        </div>
                    </div>
                </div>`;
        },

        exportVendeurAuditLog() {
            const posId = CORE.state.currentUser?.pos;
            // Filtrer par POS ET par r��le (vendeur et livreur uniquement)
            const allowedRoles = ['vendeur', 'livreur'];
            const auditLogs = (CORE.db.auditLogs || []).filter(log => 
                log.posId == posId && allowedRoles.includes(log.userRole)
            );
            if (auditLogs.length === 0) {
                UI.toast('Aucun �v�nement �� exporter', 'warning');
                return;
            }

            const headers = ['Date', 'Heure', 'Utilisateur', 'R��le', 'Action', 'Entit�', 'ID', 'Nom', 'D�tails', 'Statut'];
            const rows = auditLogs.map(log => [
                new Date(log.timestamp).toLocaleDateString('fr-FR'),
                new Date(log.timestamp).toLocaleTimeString('fr-FR'),
                log.userName || '�� ?��',
                log.userRole || '�� ?��',
                log.action || '�� ?��',
                log.entity || '�� ?��',
                log.entityId || '�� ?��',
                log.entityName || '�� ?��',
                log.details || '�� ?��',
                log.status || '�� ?��'
            ]);

            let csv = headers.map(h => `"${h}"`).join(',') + '\n';
            csv += rows.map(r => r.map(v => {
                const str = String(v || '');
                return `"${str.replace(/"/g, '""')}"`;
            }).join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `journal_audit_vendeur_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            UI.toast('Journal d\'audit export� en CSV', 'success');
        },

        render() {
            const view = this.state.currentView;
            this.loadThemePreference(); // Charger le th��me pr�f�r�
            const content = view === 'dashboard' ? this.renderDashboard() :
                            view === 'pos' ? this.renderPOS() :
                            view === 'orders' ? this.renderOrders() :
                            view === 'stock' ? this.renderStock() :
                            view === 'clients' ? this.renderClients() :
                            view === 'livreurs' ? this.renderLivreurs() :
                            view === 'commissions' ? this.renderCommissions() :
                            view === 'reservations' ? this.renderReservations() :
                            view === 'routage' ? this.renderRoutage() :
                            view === 'finance' ? this.renderFinance() :
                            view === 'rapports' ? this.renderReports() :
                            view === 'assignation' ? this.renderSmartAssignment() :
                            view === 'auditlog' ? this.renderAuditLog() :
                            this.renderDashboard();

            return `
                <div class="flex h-screen bg-slate-50 overflow-hidden">
                    <aside class="w-20 lg:w-72 bg-gradient-to-b from-slate-900 via-slate-800 to-slate-900 flex flex-col z-20 no-print transition-all duration-300 relative overflow-hidden">
                        <!-- Effet lumineux de fond -->
                        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top,rgba(16,185,129,0.15),transparent_50%)] pointer-events-none"></div>
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-400 via-emerald-500 to-emerald-600"></div>
                        
                        <!-- Header -->
                        <div class="p-4 lg:p-6 flex items-center justify-center lg:justify-start gap-3 flex-shrink-0 relative">
                            <div class="w-12 h-12 bg-gradient-to-br from-emerald-400 via-emerald-500 to-emerald-600 rounded-2xl flex items-center justify-center text-white font-black text-xl shadow-lg shadow-emerald-500/30 ring-2 ring-white/10">${(CORE.getCompanyName() || 'R').charAt(0).toUpperCase()}</div>
                            <div class="hidden lg:block">
                                <h1 class="font-black text-xl text-white tracking-tight">${CORE.getCompanyName()}<span class="text-emerald-400">.pos</span></h1>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">${CORE.getPOS(CORE.user?.pos)?.name || 'Vendeur'}</p>
                            </div>
                        </div>
                        
                        <!-- Navigation -->
                        <nav class="flex-1 px-2 lg:px-4 py-4 space-y-1 overflow-y-auto scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent">
                            ${this.renderNavIcon('dashboard', 'layout-grid', t('menu.dashboard'))}
                            ${this.renderNavIcon('pos', 'shopping-cart', t('menu.pos'))}
                            ${this.renderNavIcon('clients', 'users', t('menu.clients'))}
                            ${this.renderNavIcon('orders', 'receipt', t('menu.orders'))}
                            ${this.renderNavIcon('stock', 'package', t('menu.stock'))}
                            ${this.renderNavIcon('livreurs', 'bike', t('menu.deliverers'))}
                            ${this.renderNavIcon('reservations', 'calendar-clock', t('menu.reservations'))}
                            ${this.renderNavIcon('commissions', 'percent', t('menu.commissions'))}
                            ${this.renderNavIcon('routage', 'route', t('menu.routing'))}
                            ${this.renderNavIcon('finance', 'wallet', t('menu.finance'))}
                            ${this.renderNavIcon('assignation', 'send', t('menu.assignment'))}
                            ${this.renderNavIcon('rapports', 'bar-chart-2', t('menu.reports'))}
                            ${this.renderNavIcon('auditlog', 'book-open', 'Journal Audit')}
                        </nav>
                        
                        <!-- Footer -->
                        ${CORE.canAccessView('settings') ? `
                        <div class="p-3 lg:p-4 border-t border-white/5 relative">
                            <button id="settingsBtn" class="w-full p-3 rounded-xl bg-white/5 hover:bg-white/10 text-slate-400 hover:text-white transition-all duration-200 flex items-center justify-center lg:justify-start gap-3 group" title="${t('menu.settings')}">
                                <i data-lucide="settings" class="w-5 h-5 group-hover:rotate-90 transition-transform duration-300"></i>
                                <span class="hidden lg:inline text-sm font-bold">${t('menu.settings')}</span>
                            </button>
                        </div>
                        ` : ''}
                    </aside>
                    <main class="flex-1 flex flex-col min-w-0">
                        <div class="flex-1 overflow-y-auto p-6 relative">${content}</div>
                    </main>
                </div>`;
        },

        renderNavIcon(view, icon, label = '') {
            if (!CORE.canAccessView(view)) return '';
            const active = this.state.currentView === view;
            const title = label || view.charAt(0).toUpperCase() + view.slice(1);
            return `<button onclick="VendeurModule.navigateTo('${view}')" class="w-full p-3 lg:px-4 lg:py-3 rounded-xl flex items-center justify-center lg:justify-start gap-3 transition-all duration-200 group relative ${active ? 'bg-gradient-to-r from-emerald-500/20 to-emerald-600/10 text-emerald-400 shadow-lg shadow-emerald-500/10 border-l-2 border-emerald-400' : 'text-slate-400 hover:bg-white/5 hover:text-white'}" aria-label="${title}" title="${title}">
                <i data-lucide="${icon}" class="w-5 h-5 flex-shrink-0 ${active ? 'drop-shadow-[0_0_8px_rgba(16,185,129,0.5)]' : ''}"></i>
                <span class="hidden lg:inline text-sm font-bold truncate">${title}</span>
                ${active ? '<div class="hidden lg:block ml-auto w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>' : ''}
                <span class="lg:hidden absolute left-full ml-3 bg-slate-800 text-white px-3 py-2 rounded-xl text-xs font-black whitespace-nowrap opacity-0 group-hover:opacity-100 transition-all duration-200 transform translate-x-2 group-hover:translate-x-0 pointer-events-none shadow-xl z-50">${title}</span>
            </button>`;
        },

        openChat(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;
            CORE.db.messages = CORE.db.messages || [];
            const currentUser = CORE.state.currentUser;
            
            const renderMessages = () => {
                const msgs = CORE.db.messages.filter(m => m.deliveryId === deliveryId).sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
                if (msgs.length === 0) return '<div class="text-center text-slate-400 text-sm py-10">Aucun message.</div>';
                return msgs.map(m => {
                    const isMe = m.senderId === currentUser.id;
                    return `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[80%]">
                                <div class="px-4 py-2 rounded-2xl text-sm ${isMe ? 'bg-emerald-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-800 rounded-tl-none'}">${m.text}</div>
                                <div class="text-[10px] text-slate-400 mt-1 ${isMe ? 'text-right' : 'text-left'}">${isMe ? 'Moi' : m.senderName} �� ?� � ${CORE.formatTime(m.createdAt)}</div>
                            </div>
                        </div>`;
                }).join('');
            };

            UI.modal(`Chat: ${d.orderRef}`, `
                <div class="flex flex-col h-[50vh]">
                    <div class="p-3 bg-slate-50 border-b border-slate-200 text-xs text-slate-500 flex justify-between">
                        <span>Client: <b>${d.clientName}</b></span>
                        <span>Livreur: <b>${CORE.getUser(d.livreurId)?.name || '...'}</b></span>
                    </div>
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3">${renderMessages()}</div>
                    <div class="mt-4 flex gap-2">
                        <input id="chat-input" class="flex-1 px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500 bg-slate-50 focus:bg-white transition" placeholder="Message..." onkeypress="if(event.key==='Enter') VendeurModule.sendChat(${deliveryId})">
                        <button onclick="VendeurModule.sendChat(${deliveryId})" class="px-4 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition"><i data-lucide="send" class="w-5 h-5"></i></button>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
            setTimeout(() => { const el = document.getElementById('chat-messages'); if(el) el.scrollTop = el.scrollHeight; }, 50);
        },

        sendChat(deliveryId) {
            const input = document.getElementById('chat-input');
            const text = input ? input.value.trim() : '';
            if (!text) return;
            CORE.db.messages = CORE.db.messages || [];
            CORE.db.messages.push({ id: Date.now(), deliveryId, senderId: CORE.state.currentUser.id, senderName: CORE.state.currentUser.name, role: CORE.state.currentUser.role, text, createdAt: new Date().toISOString() });
            CORE.save();
            
            // ��Ÿ�Š Jouer le son de notification pour le message
            UI.playGenericNotificationSound('info');
            
            this.openChat(deliveryId); // Refresh
        },

        // ========== RAPPORTS ET EXPORTS AVANC�S ==========
        showReportsModal() {
            UI.modal('��Ÿ?Š Rapports & Exports Avanc�s', `
                <div class="space-y-4 max-h-[75vh] overflow-y-auto">
                    <!-- G�n�rateur de Rapports Personnalis�s -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="flex items-center gap-3 mb-3">
                            <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                            <div class="font-black text-blue-900">G�n�rer un Rapport Personnalis�</div>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs font-black text-slate-600">Nom du rapport</label>
                                <input type="text" id="report_name" placeholder="Ex: Ventes Janvier 2025" class="w-full mt-1 px-3 py-2 border border-blue-200 rounded-xl bg-white">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs font-black text-slate-600">Du</label>
                                    <input type="date" id="report_from" class="w-full mt-1 px-3 py-2 border border-blue-200 rounded-xl bg-white">
                                </div>
                                <div>
                                    <label class="text-xs font-black text-slate-600">Au</label>
                                    <input type="date" id="report_to" class="w-full mt-1 px-3 py-2 border border-blue-200 rounded-xl bg-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600">M�triques �� inclure</label>
                                <div class="mt-2 space-y-2">
                                    <label class="flex items-center gap-2"><input type="checkbox" id="report_metric_revenue" checked class="w-4 h-4 rounded"><span class="text-sm">Revenus totaux</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" id="report_metric_orders" checked class="w-4 h-4 rounded"><span class="text-sm">Nombre de commandes</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" id="report_metric_profit" checked class="w-4 h-4 rounded"><span class="text-sm">B�n�fices et marges</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" id="report_metric_products" class="w-4 h-4 rounded"><span class="text-sm">Produits les plus vendus</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" id="report_metric_vendors" class="w-4 h-4 rounded"><span class="text-sm">Performance vendeurs</span></label>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600">Format d'export</label>
                                <div class="mt-2 space-y-2">
                                    <label class="flex items-center gap-2"><input type="radio" name="report_format" value="html" checked class="w-4 h-4"><span class="text-sm">��Ÿ?? HTML (Aper��u)</span></label>
                                    <label class="flex items-center gap-2"><input type="radio" name="report_format" value="excel" class="w-4 h-4"><span class="text-sm">��Ÿ?Š Excel (Tableaux)</span></label>
                                    <label class="flex items-center gap-2"><input type="radio" name="report_format" value="pdf" class="w-4 h-4"><span class="text-sm">��Ÿ?� PDF (Impression)</span></label>
                                </div>
                            </div>
                            <button onclick="ManagerModule.generateCustomReport()" class="w-full px-4 py-2 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition">G�n�rer le Rapport</button>
                        </div>
                    </div>

                    <!-- Rapports Automatiques par Email -->
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                        <div class="flex items-center gap-3 mb-3">
                            <i data-lucide="mail" class="w-5 h-5 text-emerald-600"></i>
                            <div class="font-black text-emerald-900">Rapports Automatiques par Email</div>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs font-black text-slate-600">Nom du programme</label>
                                <input type="text" id="schedule_name" placeholder="Ex: Rapport Ventes Hebdo" class="w-full mt-1 px-3 py-2 border border-emerald-200 rounded-xl bg-white">
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600">Email destinataire</label>
                                <input type="email" id="schedule_email" placeholder="direction@company.cg" class="w-full mt-1 px-3 py-2 border border-emerald-200 rounded-xl bg-white">
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600">Fr�quence</label>
                                <select id="schedule_frequency" class="w-full mt-1 px-3 py-2 border border-emerald-200 rounded-xl bg-white">
                                    <option value="daily">��Ÿ?� Quotidien</option>
                                    <option value="weekly">��Ÿ?� Hebdomadaire</option>
                                    <option value="monthly">��Ÿ?Š Mensuel</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600">Heure d'envoi</label>
                                <input type="time" id="schedule_time" value="08:00" class="w-full mt-1 px-3 py-2 border border-emerald-200 rounded-xl bg-white">
                            </div>
                            <button onclick="ManagerModule.createReportSchedule()" class="w-full px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition">Cr�er le Programme</button>
                        </div>
                    </div>

                    <!-- Rapports G�n�r�s R�cents -->
                    <div class="p-4 bg-purple-50 border border-purple-200 rounded-2xl">
                        <div class="flex items-center gap-3 mb-3">
                            <i data-lucide="history" class="w-5 h-5 text-purple-600"></i>
                            <div class="font-black text-purple-900">Historique des Rapports (${CORE.db.generatedReports.length})</div>
                        </div>
                        <div class="space-y-2 max-h-[300px] overflow-y-auto">
                            ${CORE.db.generatedReports.length === 0 ? `
                                <div class="text-center py-6 text-slate-400 text-sm">Aucun rapport g�n�r�</div>
                            ` : CORE.db.generatedReports.sort((a,b) => new Date(b.generatedAt) - new Date(a.generatedAt)).map(r => `
                                <div class="p-3 bg-white rounded-xl border border-purple-100 flex items-center justify-between">
                                    <div>
                                        <div class="font-black text-slate-900 text-sm">${r.name}</div>
                                        <div class="text-xs text-slate-500">${CORE.formatDate(r.generatedAt)} �� ?� � ${r.format.toUpperCase()} �� ?� � ${r.generatedByName}</div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="ManagerModule.downloadReport('${r.id}')" class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">T�l�charger</button>
                                        <button onclick="ManagerModule.deleteReport('${r.id}')" class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">Supprimer</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Programmes Actifs -->
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                        <div class="flex items-center gap-3 mb-3">
                            <i data-lucide="clock" class="w-5 h-5 text-amber-600"></i>
                            <div class="font-black text-amber-900">Programmes Actifs (${CORE.db.reportSchedules.filter(s => s.enabled).length})</div>
                        </div>
                        <div class="space-y-2 max-h-[250px] overflow-y-auto">
                            ${CORE.db.reportSchedules.filter(s => s.enabled).length === 0 ? `
                                <div class="text-center py-4 text-slate-400 text-sm">Aucun programme actif</div>
                            ` : CORE.db.reportSchedules.filter(s => s.enabled).map(s => `
                                <div class="p-3 bg-white rounded-xl border border-amber-100 flex items-center justify-between">
                                    <div>
                                        <div class="font-black text-slate-900 text-sm">${s.name}</div>
                                        <div class="text-xs text-slate-500">${s.frequency === 'daily' ? '��Ÿ?� Quotidien' : s.frequency === 'weekly' ? '��Ÿ?� Hebdo' : '��Ÿ?Š Mensuel'} �� ?� � ${s.time} �� ?� � ${s.recipient}</div>
                                    </div>
                                    <button onclick="ManagerModule.toggleSchedule('${s.id}')" class="px-3 py-1 bg-red-500 text-white text-xs font-black rounded hover:bg-red-600">D�sactiver</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        generateCustomReport() {
            const name = UI.val('report_name');
            const from = UI.val('report_from');
            const to = UI.val('report_to');
            const format = document.querySelector('input[name="report_format"]:checked')?.value || 'html';
            
            if (!name || !from || !to) return UI.toast('Remplissez tous les champs', 'warning');

            const metrics = [];
            if (document.getElementById('report_metric_revenue')?.checked) metrics.push('revenue');
            if (document.getElementById('report_metric_orders')?.checked) metrics.push('orders');
            if (document.getElementById('report_metric_profit')?.checked) metrics.push('profit');
            if (document.getElementById('report_metric_products')?.checked) metrics.push('products');
            if (document.getElementById('report_metric_vendors')?.checked) metrics.push('vendors');

            // G�n�rer les donn�es du rapport
            const reportData = this.generateReportData(from, to, metrics);

            // Cr�er l'enregistrement du rapport
            const report = {
                id: 'report_' + Date.now(),
                name: name,
                type: 'custom',
                generatedBy: CORE.state.currentUser?.id,
                generatedByName: CORE.state.currentUser?.name,
                generatedAt: new Date().toISOString(),
                metrics: metrics,
                format: format,
                data: reportData,
                downloadCount: 0,
                isArchived: false
            };

            CORE.db.generatedReports.push(report);
            CORE.logAuditAction('REPORT_GENERATED', { reportName: name, format: format, metrics: metrics.join(', ') });
            CORE.save();

            UI.toast('���?? Rapport g�n�r� avec succ��s', 'success');
            
            // Exporter selon le format
            if (format === 'html') {
                this.exportReportToHTML(report);
            } else if (format === 'excel') {
                this.exportReportToExcel(report);
            } else if (format === 'pdf') {
                this.exportReportToPDF(report);
            }

            this.showReportsModal();
        },

        generateReportData(fromDate, toDate, metrics) {
            const data = {
                period: { from: fromDate, to: toDate },
                generatedAt: new Date().toLocaleString('fr-FR'),
                metrics: {}
            };

            if (metrics.includes('revenue')) {
                const orders = CORE.db.orders.filter(o => {
                    const oDate = new Date(o.createdAt).toISOString().split('T')[0];
                    return oDate >= fromDate && oDate <= toDate;
                });
                data.metrics.totalRevenue = orders.reduce((a, o) => a + (o.totalAmount || 0), 0);
                data.metrics.orderCount = orders.length;
                data.metrics.averageOrder = orders.length > 0 ? data.metrics.totalRevenue / orders.length : 0;
            }

            if (metrics.includes('profit')) {
                const totalExpenses = CORE.db.financialTransactions
                    .filter(t => {
                        const tDate = new Date(t.createdAt || t.date).toISOString().split('T')[0];
                        return tDate >= fromDate && tDate <= toDate && t.type === 'expense';
                    })
                    .reduce((a, t) => a + (t.amount || 0), 0);
                const totalRevenue = data.metrics.totalRevenue || 0;
                data.metrics.totalExpenses = totalExpenses;
                data.metrics.netProfit = totalRevenue - totalExpenses;
                data.metrics.profitMargin = totalRevenue > 0 ? ((data.metrics.netProfit / totalRevenue) * 100).toFixed(2) : 0;
            }

            if (metrics.includes('products')) {
                const orderItems = [];
                CORE.db.orders.forEach(o => {
                    if (o.items && Array.isArray(o.items)) {
                        orderItems.push(...o.items);
                    }
                });
                const productSales = {};
                orderItems.forEach(item => {
                    if (!productSales[item.productId]) {
                        productSales[item.productId] = { qty: 0, revenue: 0 };
                    }
                    productSales[item.productId].qty += item.qty || 0;
                    productSales[item.productId].revenue += (item.price || 0) * (item.qty || 0);
                });
                data.metrics.topProducts = Object.entries(productSales)
                    .map(([pId, sales]) => {
                        const prod = CORE.db.products.find(p => p.id === parseInt(pId));
                        return { name: prod?.name || 'Inconnu', qty: sales.qty, revenue: sales.revenue };
                    })
                    .sort((a, b) => b.revenue - a.revenue)
                    .slice(0, 10);
            }

            if (metrics.includes('vendors')) {
                const vendors = CORE.db.users.filter(u => u.role === 'vendeur');
                data.metrics.vendorPerformance = vendors.map(v => {
                    const vOrders = CORE.db.orders.filter(o => o.vendeurId === v.id);
                    const vRevenue = vOrders.reduce((a, o) => a + (o.totalAmount || 0), 0);
                    return { name: v.name, totalSales: vRevenue, orderCount: vOrders.length, rating: v.rating || 0 };
                });
            }

            return data;
        },

        exportReportToHTML(report) {
            const html = `<!DOCTYPE html>
<html lang="fr">
<head>

    <title>Rapport: ${report.name}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        h1 { color: #1e293b; border-bottom: 3px solid #0284c7; padding-bottom: 10px; }
        h2 { color: #475569; margin-top: 30px; border-left: 4px solid #0284c7; padding-left: 10px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 12px; text-align: left; border: 1px solid #e2e8f0; }
        th { background: #f1f5f9; font-weight: bold; color: #1e293b; }
        tr:nth-child(even) { background: #f8fafc; }
        .metric-box { display: inline-block; background: #e0f2fe; border: 2px solid #0284c7; border-radius: 8px; padding: 15px; margin: 10px; min-width: 200px; }
        .metric-value { font-size: 24px; font-weight: bold; color: #0284c7; }
        .metric-label { font-size: 12px; color: #64748b; margin-top: 5px; }
        @media print { body { margin: 0; } .container { box-shadow: none; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>��Ÿ?Š ${report.name}</h1>
        <p><strong>P�riode:</strong> ${report.data.period.from} au ${report.data.period.to}</p>
        <p><strong>G�n�r� le:</strong> ${report.data.generatedAt}</p>
        <p><strong>G�n�r� par:</strong> ${report.data.generatedByName || 'Syst��me'}</p>

        ${report.data.metrics.totalRevenue !== undefined ? `
        <h2>��Ÿ? � Revenus</h2>
        <div class="metric-box">
            <div class="metric-value">${CORE.formatPrice(report.data.metrics.totalRevenue)}</div>
            <div class="metric-label">Revenu Total</div>
        </div>
        <div class="metric-box">
            <div class="metric-value">${report.data.metrics.orderCount}</div>
            <div class="metric-label">Nombre de Commandes</div>
        </div>
        <div class="metric-box">
            <div class="metric-value">${CORE.formatPrice(report.data.metrics.averageOrder)}</div>
            <div class="metric-label">Commande Moyenne</div>
        </div>
        ` : ''}

        ${report.data.metrics.netProfit !== undefined ? `
        <h2>��Ÿ?�? Rentabilit�</h2>
        <div class="metric-box">
            <div class="metric-value">${CORE.formatPrice(report.data.metrics.netProfit)}</div>
            <div class="metric-label">B�n�fice Net</div>
        </div>
        <div class="metric-box">
            <div class="metric-value">${report.data.metrics.profitMargin}%</div>
            <div class="metric-label">Marge B�n�ficiaire</div>
        </div>
        ` : ''}

        ${report.data.metrics.topProducts ? `
        <h2>��Ÿ �� Produits les Plus Vendus</h2>
        <table>
            <thead><tr><th>Produit</th><th>Quantit�</th><th>Revenu</th></tr></thead>
            <tbody>
            ${report.data.metrics.topProducts.map(p => `
                <tr><td>${p.name}</td><td>${p.qty}</td><td>${CORE.formatPrice(p.revenue)}</td></tr>
            `).join('')}
            </tbody>
        </table>
        ` : ''}

        ${report.data.metrics.vendorPerformance ? `
        <h2>��Ÿ? � Performance Vendeurs</h2>
        <table>
            <thead><tr><th>Vendeur</th><th>Ventes</th><th>Commandes</th><th>Note</th></tr></thead>
            <tbody>
            ${report.data.metrics.vendorPerformance.map(v => `
                <tr><td>${v.name}</td><td>${CORE.formatPrice(v.totalSales)}</td><td>${v.orderCount}</td><td>${v.rating.toFixed(1)}/5 �� � �</td></tr>
            `).join('')}
            </tbody>
        </table>
        ` : ''}

        <p style="margin-top: 40px; text-align: center; color: #64748b; font-size: 12px;">
            Document g�n�r� par ${CORE.getCompanyName()} �� ?� � ${new Date().toLocaleString('fr-FR')}
        </p>
    </div>
</body>
</html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name}_${new Date().getTime()}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            report.downloadCount = (report.downloadCount || 0) + 1;
            CORE.save();
        },

        exportReportToExcel(report) {
            let csv = 'sep=,\n';
            csv += `Rapport,${report.name}\n`;
            csv += `P�riode,${report.data.period.from} au ${report.data.period.to}\n`;
            csv += `G�n�r� le,${report.data.generatedAt}\n\n`;

            if (report.data.metrics.totalRevenue !== undefined) {
                csv += 'REVENUS\n';
                csv += `Revenu Total,${report.data.metrics.totalRevenue}\n`;
                csv += `Nombre de Commandes,${report.data.metrics.orderCount}\n`;
                csv += `Commande Moyenne,${report.data.metrics.averageOrder}\n\n`;
            }

            if (report.data.metrics.netProfit !== undefined) {
                csv += 'RENTABILIT�\n';
                csv += `B�n�fice Net,${report.data.metrics.netProfit}\n`;
                csv += `Marge B�n�ficiaire,${report.data.metrics.profitMargin}%\n`;
                csv += `D�penses Totales,${report.data.metrics.totalExpenses}\n\n`;
            }

            if (report.data.metrics.topProducts) {
                csv += 'PRODUITS LES PLUS VENDUS\n';
                csv += 'Produit,Quantit�,Revenu\n';
                report.data.metrics.topProducts.forEach(p => {
                    csv += `${p.name},${p.qty},${p.revenue}\n`;
                });
                csv += '\n';
            }

            if (report.data.metrics.vendorPerformance) {
                csv += 'PERFORMANCE VENDEURS\n';
                csv += 'Vendeur,Ventes,Commandes,Note\n';
                report.data.metrics.vendorPerformance.forEach(v => {
                    csv += `${v.name},${v.totalSales},${v.orderCount},${v.rating}\n`;
                });
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `${report.name}_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            report.downloadCount = (report.downloadCount || 0) + 1;
            CORE.save();
        },

        exportReportToPDF(report) {
            // Simuler un PDF (en production, utiliser une librairie comme jsPDF)
            const pdfContent = `Rapport: ${report.name}\nP�riode: ${report.data.period.from} au ${report.data.period.to}\n\n${JSON.stringify(report.data, null, 2)}`;
            const blob = new Blob([pdfContent], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name}_${new Date().getTime()}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            report.downloadCount = (report.downloadCount || 0) + 1;
            CORE.save();
            UI.toast('��Ÿ?? PDF g�n�r� (version basique)', 'success');
        },

        createReportSchedule() {
            const name = UI.val('schedule_name');
            const email = UI.val('schedule_email');
            const frequency = UI.val('schedule_frequency');
            const time = UI.val('schedule_time');

            if (!name || !email || !frequency) return UI.toast('Remplissez tous les champs', 'warning');

            const schedule = {
                id: 'schedule_' + Date.now(),
                name: name,
                recipient: email,
                frequency: frequency,
                time: time,
                dayOfWeek: frequency === 'weekly' ? new Date().getDay() : null,
                enabled: true,
                nextRun: new Date().toISOString(),
                createdBy: CORE.state.currentUser?.id,
                createdAt: new Date().toISOString()
            };

            CORE.db.reportSchedules.push(schedule);
            CORE.logAuditAction('SCHEDULE_CREATED', { scheduleName: name, frequency: frequency, recipient: email });
            CORE.save();

            UI.toast('���?? Programme cr��. Les rapports seront envoy�s �� ' + email, 'success');
            document.getElementById('schedule_name').value = '';
            document.getElementById('schedule_email').value = '';
            this.showReportsModal();
        },

        toggleSchedule(scheduleId) {
            const schedule = CORE.db.reportSchedules.find(s => s.id === scheduleId);
            if (schedule) {
                schedule.enabled = !schedule.enabled;
                CORE.logAuditAction('SCHEDULE_' + (schedule.enabled ? 'ENABLED' : 'DISABLED'), { scheduleName: schedule.name });
                CORE.save();
                this.showReportsModal();
            }
        },

        downloadReport(reportId) {
            const report = CORE.db.generatedReports.find(r => r.id === reportId);
            if (!report) return UI.toast('Rapport introuvable', 'error');

            if (report.format === 'html') {
                this.exportReportToHTML(report);
            } else if (report.format === 'excel') {
                this.exportReportToExcel(report);
            } else if (report.format === 'pdf') {
                this.exportReportToPDF(report);
            }
        },

        deleteReport(reportId) {
            if (!confirm('Supprimer ce rapport ?')) return;
            const idx = CORE.db.generatedReports.findIndex(r => r.id === reportId);
            if (idx !== -1) {
                CORE.db.generatedReports.splice(idx, 1);
                CORE.logAuditAction('REPORT_DELETED', { reportId: reportId });
                CORE.save();
                this.showReportsModal();
            }
        },

        // ========== AUDIT TRAIL & CONFORMIT� ==========
        showAuditTrailModal() {
            const user = CORE.state.currentUser;
            const logs = (CORE.db.auditLogs || []).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            UI.modal('��Ÿ?� Audit Trail - Historique Complet', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="text-xs text-blue-600 font-black">Total Actions</div>
                            <div class="text-2xl font-black text-blue-700">${logs.length}</div>
                        </div>
                        <div class="p-3 bg-red-50 rounded-lg border border-red-200">
                            <div class="text-xs text-red-600 font-black">Erreurs</div>
                            <div class="text-2xl font-black text-red-700">${logs.filter(l => l.status === 'failed').length}</div>
                        </div>
                        <div class="p-3 bg-amber-50 rounded-lg border border-amber-200">
                            <div class="text-xs text-amber-600 font-black">Avertissements</div>
                            <div class="text-2xl font-black text-amber-700">${logs.filter(l => l.status === 'warning').length}</div>
                        </div>
                        <div class="p-3 bg-emerald-50 rounded-lg border border-emerald-200">
                            <div class="text-xs text-emerald-600 font-black">Succ��s</div>
                            <div class="text-2xl font-black text-emerald-700">${logs.filter(l => l.status === 'success').length}</div>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <div class="text-xs font-black text-slate-600 uppercase mb-3">Actions R�centes</div>
                        <div class="space-y-2">
                            ${logs.length === 0 ? `<div class="text-center py-8 text-slate-400">Aucune action enregistr�e</div>` : logs.slice(0, 50).map(log => `
                                <div class="p-3 rounded-lg border ${log.status === 'failed' ? 'border-red-200 bg-red-50' : log.status === 'warning' ? 'border-amber-200 bg-amber-50' : 'border-slate-200 bg-slate-50'} flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-xs font-black px-2 py-1 rounded ${log.status === 'failed' ? 'bg-red-200 text-red-700' : log.status === 'warning' ? 'bg-amber-200 text-amber-700' : 'bg-emerald-200 text-emerald-700'}">${log.status === 'failed' ? '�� ��?' : log.status === 'warning' ? '��š ��� � �' : '���?�'} ${log.status.toUpperCase()}</span>
                                            <span class="text-xs text-slate-500">${CORE.formatDate(log.timestamp)}</span>
                                        </div>
                                        <div class="font-black text-slate-900 text-sm">${log.action}</div>
                                        <div class="text-xs text-slate-600 mt-1">${log.description || log.entityName || ''}</div>
                                        <div class="text-[10px] text-slate-500 mt-1">Par: <b>${log.userName}</b> �� ?� � ${log.category || 'system'}</div>
                                    </div>
                                    ${log.before && log.after ? `<button onclick="ManagerModule.showAuditDetails('${log.id}')" class="px-2 py-1 text-xs font-black text-blue-600 hover:text-blue-800">D�tails</button>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Exporter', onclick: 'ManagerModule.exportAuditTrail()', class: 'px-4 py-2 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700' },
                { label: 'Rapport Conformit�', onclick: 'ManagerModule.showComplianceReport()', class: 'px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showAccessLogs() {
            const logs = CORE.db.accessLogs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            const today = logs.filter(l => new Date(l.timestamp).toDateString() === new Date().toDateString());
            
            UI.modal('��Ÿ�? Historique des Acc��s', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="p-3 bg-purple-50 rounded-lg border border-purple-200">
                            <div class="text-xs text-purple-600 font-black">Total Acc��s</div>
                            <div class="text-2xl font-black text-purple-700">${logs.length}</div>
                        </div>
                        <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                            <div class="text-xs text-indigo-600 font-black">Aujourd'hui</div>
                            <div class="text-2xl font-black text-indigo-700">${today.length}</div>
                        </div>
                        <div class="p-3 bg-cyan-50 rounded-lg border border-cyan-200">
                            <div class="text-xs text-cyan-600 font-black">Erreurs Login</div>
                            <div class="text-2xl font-black text-cyan-700">${logs.filter(l => !l.success).length}</div>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <div class="text-xs font-black text-slate-600 uppercase mb-3">Acc��s R�cents</div>
                        <div class="space-y-2">
                            ${logs.slice(0, 50).map(log => `
                                <div class="p-3 rounded-lg border border-slate-200 bg-slate-50 flex items-start justify-between">
                                    <div>
                                        <div class="font-black text-slate-900 text-sm">${log.action}: ${log.resource || 'N/A'}</div>
                                        <div class="text-xs text-slate-600 mt-1">${log.userName} �� ?� � ${CORE.formatDate(log.timestamp)}</div>
                                        <div class="text-[10px] text-slate-500">Dur�e: ${log.duration || 0}ms �� ?� � ${log.deviceType || 'web'}</div>
                                    </div>
                                    <span class="text-xs font-black px-2 py-1 rounded ${log.success ? 'bg-emerald-200 text-emerald-700' : 'bg-red-200 text-red-700'}">
                                        ${log.success ? '���?� OK' : '�� ��? FAILED'}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Exporter', onclick: 'ManagerModule.exportAccessLogs()', class: 'px-4 py-2 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showDataModificationLogs() {
            const logs = CORE.db.dataModificationLogs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            UI.modal('��Ÿ? � Modifications de Donn�es', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                            <div class="text-xs text-indigo-600 font-black">Total Modifs</div>
                            <div class="text-2xl font-black text-indigo-700">${logs.length}</div>
                        </div>
                        <div class="p-3 bg-teal-50 rounded-lg border border-teal-200">
                            <div class="text-xs text-teal-600 font-black">Approuv�es</div>
                            <div class="text-2xl font-black text-teal-700">${logs.filter(l => l.approvedBy).length}</div>
                        </div>
                        <div class="p-3 bg-orange-50 rounded-lg border border-orange-200">
                            <div class="text-xs text-orange-600 font-black">En Attente</div>
                            <div class="text-2xl font-black text-orange-700">${logs.filter(l => !l.approvedBy).length}</div>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <div class="text-xs font-black text-slate-600 uppercase mb-3">Historique des Modifications</div>
                        <div class="space-y-2">
                            ${logs.slice(0, 50).map(log => `
                                <div class="p-3 rounded-lg border border-slate-200 bg-slate-50">
                                    <div class="flex items-start justify-between mb-2">
                                        <div>
                                            <div class="font-black text-slate-900 text-sm">${log.table}</div>
                                            <div class="text-xs text-slate-600">${log.recordName || log.recordId}</div>
                                        </div>
                                        <span class="text-xs font-black px-2 py-1 rounded ${log.approvedBy ? 'bg-emerald-200 text-emerald-700' : 'bg-amber-200 text-amber-700'}">
                                            ${log.approvedBy ? '���?� APPROUV�' : '�� � � ATTENTE'}
                                        </span>
                                    </div>
                                    <div class="text-xs text-slate-600 mt-2">
                                        <b>${log.fieldName}:</b> 
                                        <span class="line-through text-red-600">${log.oldValue}</span>
                                        ���? <span class="text-emerald-600">${log.newValue}</span>
                                    </div>
                                    <div class="text-[10px] text-slate-500 mt-1">Par: ${log.userName} �� ?� � ${CORE.formatDate(log.timestamp)}</div>
                                    ${log.reason ? `<div class="text-[10px] text-slate-500">Raison: ${log.reason}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Exporter', onclick: 'ManagerModule.exportDataModificationLogs()', class: 'px-4 py-2 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showComplianceReport() {
            const period = 'monthly';
            const logs = CORE.db.auditTrail;
            const criticalEvents = logs.filter(l => l.status === 'failed' || l.action.includes('DELETE'));
            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            const monthLogs = logs.filter(l => new Date(l.timestamp) >= lastMonth);

            UI.modal('��Ÿ?Š Rapport de Conformit�', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <div class="p-4 bg-gradient-to-r from-slate-900 to-slate-800 text-white rounded-2xl">
                        <div class="font-black text-lg mb-1">Rapport de Conformit� - ${period === 'daily' ? 'Quotidien' : period === 'weekly' ? 'Hebdomadaire' : 'Mensuel'}</div>
                        <div class="text-xs text-white/60">G�n�r� le ${CORE.formatDate(new Date().toISOString())}</div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                            <div class="text-xs text-blue-600 font-black uppercase">Actions Totales</div>
                            <div class="text-3xl font-black text-blue-700 mt-2">${logs.length}</div>
                            <div class="text-xs text-blue-600 mt-2">${monthLogs.length} ce mois</div>
                        </div>

                        <div class="p-4 bg-red-50 border border-red-200 rounded-2xl">
                            <div class="text-xs text-red-600 font-black uppercase">�v�nements Critiques</div>
                            <div class="text-3xl font-black text-red-700 mt-2">${criticalEvents.length}</div>
                            <div class="text-xs text-red-600 mt-2">D�passe le seuil: ${criticalEvents.length > 10 ? '��š ��� � � OUI' : '���?� NON'}</div>
                        </div>

                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                            <div class="text-xs text-emerald-600 font-black uppercase">Taux de Succ��s</div>
                            <div class="text-3xl font-black text-emerald-700 mt-2">${logs.length > 0 ? ((logs.filter(l => l.status === 'success').length / logs.length) * 100).toFixed(1) : 0}%</div>
                            <div class="text-xs text-emerald-600 mt-2">Cible: ��� � 95%</div>
                        </div>

                        <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                            <div class="text-xs text-amber-600 font-black uppercase">Acc��s Non Autoris�s</div>
                            <div class="text-3xl font-black text-amber-700 mt-2">${CORE.db.accessLogs.filter(l => !l.success).length}</div>
                            <div class="text-xs text-amber-600 mt-2">Tentatives bloqu�es</div>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <div class="font-black text-slate-900 mb-3">R�sum� de Conformit�</div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <span class="font-black text-slate-900">RGPD - Tra��abilit� des acc��s</span>
                                <span class="px-3 py-1 rounded-full bg-emerald-200 text-emerald-700 text-xs font-black">���?� CONFORME</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <span class="font-black text-slate-900">Audit Trail compl��te (${logs.length} actions)</span>
                                <span class="px-3 py-1 rounded-full bg-emerald-200 text-emerald-700 text-xs font-black">���?� CONFORME</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <span class="font-black text-slate-900">Modifications trac�es et approuv�es</span>
                                <span class="px-3 py-1 rounded-full ${CORE.db.dataModificationLogs.filter(l => !l.approvedBy).length > 0 ? 'bg-amber-200 text-amber-700' : 'bg-emerald-200 text-emerald-700'} text-xs font-black">
                                    ${CORE.db.dataModificationLogs.filter(l => !l.approvedBy).length > 0 ? '��š ��� � � ATTENTE' : '���?� CONFORME'}
                                </span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <span class="font-black text-slate-900">Suppressions authentifi�es</span>
                                <span class="px-3 py-1 rounded-full bg-emerald-200 text-emerald-700 text-xs font-black">���?� CONFORME</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                        <div class="font-black text-emerald-900 mb-2">��ŸŽ � Score de Conformit� Global</div>
                        <div class="flex items-center">
                            <div class="flex-1 h-3 bg-slate-200 rounded-full overflow-hidden mr-3">
                                <div class="h-full bg-emerald-600" style="width: 92%"></div>
                            </div>
                            <div class="text-2xl font-black text-emerald-700">92%</div>
                        </div>
                        <div class="text-xs text-emerald-700 mt-2">���?? Tous les crit��res majeurs respect�s</div>
                    </div>
                </div>
            `, [
                { label: 'Exporter Rapport', onclick: 'ManagerModule.exportComplianceReport()', class: 'px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        exportAuditTrail() {
            const logs = CORE.db.auditTrail.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            let csv = 'sep=,\n';
            csv += 'Timestamp,User,Action,Entity,Status,Description\n';
            logs.forEach(log => {
                csv += `"${log.timestamp}","${log.userName}","${log.action}","${log.entityName || log.entity}","${log.status}","${(log.description || '').replace(/"/g, '""')}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `audit_trail_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('���?? Audit trail export�', 'success');
        },

        exportAccessLogs() {
            const logs = CORE.db.accessLogs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            let csv = 'sep=,\n';
            csv += 'Timestamp,User,Role,Action,Resource,Success,Duration(ms),Device\n';
            logs.forEach(log => {
                csv += `"${log.timestamp}","${log.userName}","${log.userRole}","${log.action}","${log.resource || ''}","${log.success}","${log.duration || 0}","${log.deviceType || 'web'}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `access_logs_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('���?? Acc��s export�s', 'success');
        },

        exportDataModificationLogs() {
            const logs = CORE.db.dataModificationLogs;
            let csv = 'sep=,\n';
            csv += 'Timestamp,User,Table,Record,Field,OldValue,NewValue,ApprovedBy,ApprovedDate\n';
            logs.forEach(log => {
                csv += `"${log.timestamp}","${log.userName}","${log.table}","${log.recordName}","${log.fieldName}","${(log.oldValue || '').replace(/"/g, '""')}","${(log.newValue || '').replace(/"/g, '""')}","${log.approvedBy || ''}","${log.approvedAt || ''}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `data_modifications_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('���?? Modifications export�es', 'success');
        },

        exportComplianceReport() {
            const report = `
RAPPORT DE CONFORMIT� - ${CORE.getCompanyName()}
G�n�r� le: ${CORE.formatDate(new Date().toISOString())}

=== R�SUM� ===
Total Actions: ${CORE.db.auditTrail.length}
�v�nements Critiques: ${CORE.db.auditTrail.filter(l => l.status === 'failed').length}
Acc��s Non Autoris�s: ${CORE.db.accessLogs.filter(l => !l.success).length}

=== CONFORMIT� ===
���?? RGPD - Tra��abilit�: CONFORME
���?? Audit Trail: CONFORME (${CORE.db.auditTrail.length} actions)
���?? Modifications: ${CORE.db.dataModificationLogs.filter(l => !l.approvedBy).length > 0 ? 'EN ATTENTE' : 'CONFORME'}
���?? Suppressions: CONFORME

=== SCORE GLOBAL ===
92% de conformit�

Approuv� par: Manager System
Date d'approbation: ${new Date().toLocaleDateString('fr-FR')}
            `;

            const blob = new Blob([report], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `compliance_report_${new Date().getTime()}.txt`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('���?? Rapport de conformit� export�', 'success');
        },

        logManagerAction(action, description, entity = null, entityId = null, changes = null) {
            const user = CORE.state.currentUser;
            if (!user) return;

            const auditLog = {
                id: 'audit_' + Date.now(),
                timestamp: new Date().toISOString(),
                userId: user.id,
                userName: user.name,
                userRole: user.role,
                action: action,
                category: 'manager',
                entity: entity,
                entityId: entityId,
                entityName: description,
                actionType: 'update',
                description: description,
                status: 'success',
                changes: changes || [],
                before: null,
                after: null
            };

            CORE.db.auditTrail = CORE.db.auditTrail || [];
            CORE.db.auditTrail.push(auditLog);
            CORE.save();
        },

        logAccessEvent(action, resource = null, success = true) {
            const user = CORE.state.currentUser;
            if (!user) return;

            const accessLog = {
                id: 'access_' + Date.now(),
                timestamp: new Date().toISOString(),
                userId: user.id,
                userName: user.name,
                userRole: user.role,
                action: action,
                resource: resource,
                resourceId: null,
                duration: 0,
                ipAddress: 'N/A',
                location: 'Manager Module',
                deviceType: 'web',
                success: success
            };

            CORE.db.accessLogs = CORE.db.accessLogs || [];
            CORE.db.accessLogs.push(accessLog);
            CORE.save();
        },

        logDataModification(table, recordId, recordName, fieldName, oldValue, newValue, reason = null) {
            const user = CORE.state.currentUser;
            if (!user) return;

            const modLog = {
                id: 'mod_' + Date.now(),
                timestamp: new Date().toISOString(),
                userId: user.id,
                userName: user.name,
                table: table,
                recordId: recordId,
                recordName: recordName,
                fieldName: fieldName,
                oldValue: oldValue,
                newValue: newValue,
                reason: reason,
                approvedBy: null,
                approvedAt: null
            };

            CORE.db.dataModificationLogs = CORE.db.dataModificationLogs || [];
            CORE.db.dataModificationLogs.push(modLog);
            CORE.save();
        },

        // ========== GESTION INTELLIGENTE DU STOCK ==========
        
        // ��Ÿ?Š Analyse ABC (Pareto) - Cat�gorise les produits par importance
        performABCAnalysis() {
            const userPos = CORE.user?.pos;
            const products = CORE.getProductsExcludingMain();
            if (products.length === 0) return [];

            // Calculer le CA par produit
            const productMetrics = products.map(p => {
                const orders = CORE.db.orders.filter(o => o.posId == userPos && o.items?.some(i => i.productId === p.id));
                const totalRevenue = orders.reduce((sum, o) => sum + (o.items.find(i => i.productId === p.id)?.total || 0), 0);
                const totalQty = orders.reduce((sum, o) => sum + (o.items.find(i => i.productId === p.id)?.quantity || 0), 0);
                
                return {
                    id: p.id,
                    name: p.name,
                    sku: p.sku,
                    stock: p.stock,
                    revenue: totalRevenue,
                    qty: totalQty,
                    profitMargin: p.profitMargin || 20,
                    profitValue: (totalRevenue * (p.profitMargin || 20)) / 100
                };
            }).sort((a, b) => b.revenue - a.revenue);

            // Calculer les pourcentages cumul�s
            const totalRevenue = productMetrics.reduce((sum, p) => sum + p.revenue, 0);
            let cumulativePercentage = 0;
            const analysis = productMetrics.map(p => {
                cumulativePercentage += (p.revenue / totalRevenue) * 100;
                let category = 'C';
                if (cumulativePercentage <= 80) category = 'A';
                else if (cumulativePercentage <= 95) category = 'B';
                
                return {
                    id: p.id,
                    name: p.name,
                    sku: p.sku,
                    category: category,
                    revenue: p.revenue,
                    qty: p.qty,
                    profitValue: p.profitValue,
                    revenuePct: (p.revenue / totalRevenue) * 100,
                    cumulativePct: cumulativePercentage,
                    stock: p.stock,
                    priority: category === 'A' ? '��Ÿ� � CRITIQUE' : category === 'B' ? '��ŸŸ � IMPORTANT' : '��ŸŸ � NORMAL'
                };
            });

            CORE.db.stockAnalysisABC = analysis;
            CORE.save();
            return analysis;
        },

        // ��Ÿ?�? Pr�dictions de stock bas�es sur tendances
        predictStockLevels(daysAhead = 30) {
            const userPos = CORE.user?.pos;
            const predictions = [];
            const products = CORE.getProductsExcludingMain();

            products.forEach(product => {
                // R�cup�rer les mouvements r�cents (90 derniers jours)
                const now = new Date();
                const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                
                const recentMovements = (CORE.db.stockMovements || [])
                    .filter(m => m.productId === product.id && (!m.posId || m.posId == userPos) && new Date(m.createdAt) >= ninetyDaysAgo)
                    .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

                // Calculer la tendance de consommation moyenne
                const outMovements = recentMovements.filter(m => m.type === 'out');
                const totalQtyOut = outMovements.reduce((sum, m) => sum + m.qty, 0);
                const daysWithData = 90;
                const avgDailyConsumption = totalQtyOut / daysWithData;

                // Pr�dire le stock dans N jours
                const predictedStock = product.stock - (avgDailyConsumption * daysAhead);
                const daysUntilStockOut = predictedStock > 0 ? Math.floor(product.stock / (avgDailyConsumption || 1)) : 0;
                
                // Estimer si on va passer sous le minimum
                const willGoUnderMinimum = predictedStock < (product.minStock || 10);
                const riskLevel = predictedStock < 0 ? '��Ÿ� � RUPTURE' : predictedStock < product.minStock ? '��ŸŸ � RISQUE' : '��ŸŸ � OK';

                predictions.push({
                    id: product.id,
                    name: product.name,
                    sku: product.sku,
                    currentStock: product.stock,
                    minStock: product.minStock,
                    avgDailyConsumption: avgDailyConsumption.toFixed(2),
                    predictedStock: Math.max(0, predictedStock).toFixed(2),
                    daysUntilStockOut: daysUntilStockOut,
                    riskLevel: riskLevel,
                    willGoUnderMinimum: willGoUnderMinimum,
                    recommendedReorder: willGoUnderMinimum,
                    daysAhead: daysAhead,
                    confidence: recentMovements.length > 10 ? 'HAUTE' : 'MOYENNE'
                });
            });

            CORE.db.stockPredictions = predictions;
            CORE.save();
            return predictions.sort((a, b) => {
                if (a.riskLevel.includes('RUPTURE')) return -1;
                if (b.riskLevel.includes('RUPTURE')) return 1;
                if (a.riskLevel.includes('RISQUE')) return -1;
                if (b.riskLevel.includes('RISQUE')) return 1;
                return 0;
            });
        },

        // ��Ÿ �? G�n�rer suggestions d'approvisionnement automatique
        generateReorderSuggestions() {
            const predictions = this.predictStockLevels(30);
            const abc = this.performABCAnalysis();
            const suggestions = [];

            predictions.forEach(pred => {
                if (pred.willGoUnderMinimum || pred.currentStock < pred.minStock) {
                    const abcItem = abc.find(a => a.id === pred.id);
                    const product = CORE.db.products.find(p => p.id === pred.id);
                    
                    // D�terminer la quantit� optimale �� commander
                    let orderQty = product.minStock * 3; // Commande 3x le minimum par d�faut
                    if (abcItem?.category === 'A') orderQty = product.minStock * 4; // Plus pour les produits critiques
                    if (abcItem?.category === 'C') orderQty = product.minStock * 2; // Moins pour les produits ordinaires

                    // Urgence
                    let urgency = 'NORMAL';
                    if (pred.currentStock < product.minStock) urgency = '��Ÿ� � URGENT';
                    else if (pred.daysUntilStockOut < 7) urgency = '��ŸŸ � HAUTE';
                    else if (pred.daysUntilStockOut < 14) urgency = '��ŸŸ � MOYEN';

                    suggestions.push({
                        id: 'sugg_' + Date.now() + '_' + pred.id,
                        productId: pred.id,
                        productName: pred.name,
                        sku: pred.sku,
                        currentStock: pred.currentStock,
                        minStock: pred.minStock,
                        suggestedQty: Math.ceil(orderQty),
                        estimatedCost: (product.costPrice || 0) * orderQty,
                        urgency: urgency,
                        reason: pred.riskLevel,
                        daysUntilStockOut: pred.daysUntilStockOut,
                        abcCategory: abcItem?.category || 'N/A',
                        priority: abcItem?.category === 'A' ? 1 : abcItem?.category === 'B' ? 2 : 3,
                        createdAt: new Date().toISOString(),
                        status: 'pending',
                        estimatedDelivery: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString()
                    });
                }
            });

            // Trier par urgence et priorit�
            suggestions.sort((a, b) => {
                if (a.priority !== b.priority) return a.priority - b.priority;
                return b.urgency.localeCompare(a.urgency);
            });

            CORE.db.reorderSuggestions = suggestions;
            CORE.save();
            return suggestions;
        },

        // ��š ��� � � Gestion des alertes de p�remption/obsolescence
        generateExpiryAlerts() {
            const alerts = [];
            const now = new Date();
            const userPos = CORE.user?.pos;
            const products = (CORE.db.products || []).filter(p => !p.posId || p.posId == userPos);

            products.forEach(product => {
                let alert = null;
                let severity = 'INFO';
                let reason = '';

                // V�rifier la date de p�remption si disponible
                if (product.expiryDate) {
                    const expiryDate = new Date(product.expiryDate);
                    const daysUntilExpiry = Math.floor((expiryDate - now) / (1000 * 60 * 60 * 24));

                    if (daysUntilExpiry < 0) {
                        severity = '��Ÿ� � EXPIR�';
                        reason = `Expir� depuis ${Math.abs(daysUntilExpiry)} jour(s)`;
                    } else if (daysUntilExpiry < 7) {
                        severity = '��Ÿ� � CRITIQUE';
                        reason = `Expire dans ${daysUntilExpiry} jour(s)`;
                    } else if (daysUntilExpiry < 30) {
                        severity = '��ŸŸ � ATTENTION';
                        reason = `Expire dans ${daysUntilExpiry} jour(s)`;
                    } else if (daysUntilExpiry < 60) {
                        severity = '��ŸŸ � PR�AVIS';
                        reason = `Expire dans ${daysUntilExpiry} jour(s)`;
                    }

                    if (severity !== 'INFO') {
                        alert = {
                            id: 'alert_' + Date.now() + '_' + product.id,
                            productId: product.id,
                            productName: product.name,
                            sku: product.sku,
                            type: 'expiry',
                            severity: severity,
                            reason: reason,
                            expiryDate: product.expiryDate,
                            daysUntilExpiry: Math.max(0, daysUntilExpiry),
                            stock: product.stock,
                            action: daysUntilExpiry < 7 ? 'PROMO_IMM�DIATE' : daysUntilExpiry < 30 ? 'PROMO' : 'SURVEILLANCE',
                            createdAt: new Date().toISOString()
                        };
                    }
                }

                // V�rifier l'obsolescence (pas vendu depuis X jours)
                const lastMovement = (CORE.db.stockMovements || [])
                    .filter(m => m.productId === product.id && m.type === 'out' && (!m.posId || m.posId == userPos))
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];

                if (!lastMovement) {
                    const daysWithoutMovement = Math.floor((now - new Date(product.createdAt)) / (1000 * 60 * 60 * 24));
                    if (daysWithoutMovement > 90) {
                        severity = '��ŸŸ � OBSOL�?TE';
                        reason = `Aucune vente depuis ${daysWithoutMovement} jour(s)`;
                        alert = {
                            id: 'alert_' + Date.now() + '_obs_' + product.id,
                            productId: product.id,
                            productName: product.name,
                            sku: product.sku,
                            type: 'obsolescence',
                            severity: severity,
                            reason: reason,
                            daysWithoutMovement: daysWithoutMovement,
                            stock: product.stock,
                            action: 'REVOIR_PRIX',
                            createdAt: new Date().toISOString()
                        };
                    }
                } else {
                    const daysSinceLastMovement = Math.floor((now - new Date(lastMovement.createdAt)) / (1000 * 60 * 60 * 24));
                    if (daysSinceLastMovement > 60 && product.stock > product.minStock * 2) {
                        severity = '��ŸŸ � LENT';
                        reason = `Faible rotation (${daysSinceLastMovement} jours sans vente)`;
                        alert = {
                            id: 'alert_' + Date.now() + '_slow_' + product.id,
                            productId: product.id,
                            productName: product.name,
                            sku: product.sku,
                            type: 'slow_moving',
                            severity: severity,
                            reason: reason,
                            daysSinceLastSale: daysSinceLastMovement,
                            stock: product.stock,
                            action: 'PROMO_OU_R�DUCTION',
                            createdAt: new Date().toISOString()
                        };
                    }
                }

                if (alert) alerts.push(alert);
            });

            CORE.db.expiryAlerts = alerts;
            CORE.save();
            return alerts;
        },

        // Interface d'affichage - Tableau de bord Gestion Intelligente
        showSmartStockDashboard() {
            const predictions = this.predictStockLevels(30);
            const abc = this.performABCAnalysis();
            const suggestions = this.generateReorderSuggestions();
            const alerts = this.generateExpiryAlerts();

            const criticalCount = predictions.filter(p => p.riskLevel.includes('RUPTURE')).length;
            const atRiskCount = predictions.filter(p => p.riskLevel.includes('RISQUE')).length;
            const expiryAlertsCount = alerts.filter(a => a.type === 'expiry').length;
            const obsoleteCount = alerts.filter(a => a.type === 'obsolescence').length;

            UI.modal('��Ÿ �? Gestion Intelligente du Stock', `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <!-- Indicateurs cl�s -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="p-4 bg-red-50 border border-red-200 rounded-2xl">
                            <div class="text-xs text-red-600 font-black uppercase">Rupture</div>
                            <div class="text-3xl font-black text-red-700 mt-2">${criticalCount}</div>
                            <div class="text-[10px] text-red-600 mt-1">Produits �� risque imm�diat</div>
                        </div>
                        <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                            <div class="text-xs text-amber-600 font-black uppercase">Risque</div>
                            <div class="text-3xl font-black text-amber-700 mt-2">${atRiskCount}</div>
                            <div class="text-[10px] text-amber-600 mt-1">Sous le minimum</div>
                        </div>
                        <div class="p-4 bg-orange-50 border border-orange-200 rounded-2xl">
                            <div class="text-xs text-orange-600 font-black uppercase">P�remption</div>
                            <div class="text-3xl font-black text-orange-700 mt-2">${expiryAlertsCount}</div>
                            <div class="text-[10px] text-orange-600 mt-1">�?� g�rer d'urgence</div>
                        </div>
                        <div class="p-4 bg-purple-50 border border-purple-200 rounded-2xl">
                            <div class="text-xs text-purple-600 font-black uppercase">Obsol��te</div>
                            <div class="text-3xl font-black text-purple-700 mt-2">${obsoleteCount}</div>
                            <div class="text-[10px] text-purple-600 mt-1">Faible rotation</div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="flex gap-2 border-b border-slate-200">
                        <button onclick="ManagerModule.showStockPredictions()" class="px-4 py-3 font-black text-sm border-b-2 border-blue-500 text-blue-600">��Ÿ?�? Pr�dictions</button>
                        <button onclick="ManagerModule.showABCAnalysis()" class="px-4 py-3 font-black text-sm text-slate-500 hover:text-slate-700">��Ÿ?Š Analyse ABC</button>
                        <button onclick="ManagerModule.showReorderSuggestions()" class="px-4 py-3 font-black text-sm text-slate-500 hover:text-slate-700">��Ÿ �? Suggestions</button>
                        <button onclick="ManagerModule.showExpiryAlerts()" class="px-4 py-3 font-black text-sm text-slate-500 hover:text-slate-700">��š ��� � � Alertes</button>
                    </div>

                    <!-- Contenu pr�dictions -->
                    <div id="smartstock-content" class="space-y-3">
                        ${predictions.slice(0, 10).map(p => `
                            <div class="p-4 rounded-xl border ${p.riskLevel.includes('RUPTURE') ? 'border-red-300 bg-red-50' : p.riskLevel.includes('RISQUE') ? 'border-amber-300 bg-amber-50' : 'border-emerald-300 bg-emerald-50'} flex items-center justify-between">
                                <div>
                                    <div class="font-black text-slate-900">${p.name} <span class="text-xs text-slate-500">(${p.sku})</span></div>
                                    <div class="text-sm text-slate-600 mt-1">
                                        Stock: <b>${p.currentStock}</b> ���? Pr�dit: <b>${p.predictedStock}</b> | Consommation: <b>${p.avgDailyConsumption}/jour</b>
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1">Rupture dans ${p.daysUntilStockOut} jours �� ?� � Confiance: ${p.confidence}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-black">${p.riskLevel}</div>
                                    <button onclick="ManagerModule.createReorder(${p.id})" class="mt-2 px-3 py-1 text-xs font-black rounded-lg bg-blue-600 text-white hover:bg-blue-700">Commander</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `, [
                { label: 'Exporter Rapport', onclick: 'ManagerModule.exportSmartStockReport()', class: 'px-4 py-2 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showStockPredictions() {
            const predictions = CORE.db.stockPredictions || this.predictStockLevels(30);
            document.getElementById('smartstock-content').innerHTML = predictions.map(p => `
                <div class="p-4 rounded-xl border ${p.riskLevel.includes('RUPTURE') ? 'border-red-300 bg-red-50' : p.riskLevel.includes('RISQUE') ? 'border-amber-300 bg-amber-50' : 'border-emerald-300 bg-emerald-50'} flex items-center justify-between">
                    <div>
                        <div class="font-black text-slate-900">${p.name} <span class="text-xs text-slate-500">(${p.sku})</span></div>
                        <div class="text-sm text-slate-600 mt-1">
                            Stock: <b>${p.currentStock}</b> ���? Pr�dit: <b>${p.predictedStock}</b> | Consommation: <b>${p.avgDailyConsumption}/jour</b>
                        </div>
                        <div class="text-xs text-slate-500 mt-1">Rupture dans ${p.daysUntilStockOut} jours �� ?� � Confiance: ${p.confidence}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-black">${p.riskLevel}</div>
                        <button onclick="ManagerModule.createReorder(${p.id})" class="mt-2 px-3 py-1 text-xs font-black rounded-lg bg-blue-600 text-white hover:bg-blue-700">Commander</button>
                    </div>
                </div>
            `).join('');
        },

        showABCAnalysis() {
            const abc = CORE.db.stockAnalysisABC || this.performABCAnalysis();
            document.getElementById('smartstock-content').innerHTML = `
                <div class="space-y-4">
                    ${['A', 'B', 'C'].map(cat => {
                        const items = abc.filter(a => a.category === cat);
                        const label = cat === 'A' ? '��Ÿ� � CRITIQUE (80% CA)' : cat === 'B' ? '��ŸŸ � IMPORTANT (15% CA)' : '��ŸŸ � NORMAL (5% CA)';
                        return `
                            <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                <div class="font-black text-slate-900 mb-3">${label}</div>
                                <div class="space-y-2">
                                    ${items.slice(0, 8).map(item => `
                                        <div class="p-3 bg-white rounded-lg border border-slate-100 flex items-center justify-between">
                                            <div class="flex-1">
                                                <div class="font-black text-slate-900 text-sm">${item.name}</div>
                                                <div class="text-xs text-slate-600 mt-1">CA: ${CORE.formatPrice(item.revenue)} �� ?� � Stock: ${item.stock} �� ?� � Marge: ${CORE.formatPrice(item.profitValue)}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-black text-slate-900">${item.revenuePct.toFixed(1)}%</div>
                                                <div class="text-xs text-slate-500">CA cumul�</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        },

        showReorderSuggestions() {
            const suggestions = CORE.db.reorderSuggestions || this.generateReorderSuggestions();
            document.getElementById('smartstock-content').innerHTML = suggestions.length === 0 ? `
                <div class="text-center py-10 text-slate-400">���?� Aucune suggestion d'approvisionnement</div>
            ` : suggestions.map(s => `
                <div class="p-4 rounded-xl border border-slate-200 bg-slate-50 flex items-start justify-between">
                    <div>
                        <div class="font-black text-slate-900">${s.productName} <span class="text-xs text-slate-500">${s.sku}</span></div>
                        <div class="text-sm text-slate-600 mt-1">
                            Stock: ${s.currentStock} ���? Sugg�r�: <b>${s.suggestedQty}</b> unit�s
                        </div>
                        <div class="text-xs text-slate-500 mt-1">
                            Cat�gorie ${s.abcCategory} �� ?� � Urgence: ${s.urgency} �� ?� � Co��t: ${CORE.formatPrice(s.estimatedCost)}
                        </div>
                        <div class="text-[10px] text-slate-400 mt-1">Raison: ${s.reason}</div>
                    </div>
                    <button onclick="ManagerModule.acceptReorderSuggestion('${s.id}')" class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700">���?? Accepter</button>
                </div>
            `).join('');
        },

        showExpiryAlerts() {
            const alerts = CORE.db.expiryAlerts || this.generateExpiryAlerts();
            document.getElementById('smartstock-content').innerHTML = alerts.length === 0 ? `
                <div class="text-center py-10 text-slate-400">���?� Aucune alerte de p�remption</div>
            ` : alerts.map(a => `
                <div class="p-4 rounded-xl border ${a.type === 'expiry' ? 'border-red-200 bg-red-50' : a.type === 'obsolescence' ? 'border-purple-200 bg-purple-50' : 'border-orange-200 bg-orange-50'} flex items-start justify-between">
                    <div>
                        <div class="font-black ${a.type === 'expiry' ? 'text-red-900' : a.type === 'obsolescence' ? 'text-purple-900' : 'text-orange-900'}">${a.productName}</div>
                        <div class="text-sm text-slate-600 mt-1">${a.reason}</div>
                        <div class="text-xs text-slate-500 mt-1">Action recommand�e: <b>${a.action}</b></div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-black">${a.severity}</div>
                        <button onclick="alert('Action: ${a.action}')" class="mt-2 px-3 py-1 text-xs font-black rounded-lg bg-slate-700 text-white hover:bg-slate-800">���? Agir</button>
                    </div>
                </div>
            `).join('');
        },

        createReorder(productId) {
            const product = CORE.db.products.find(p => p.id === productId);
            if (!product) return;

            const qty = product.minStock * 3;
            const cost = (product.costPrice || 0) * qty;

            UI.modal('Cr�er une commande d\'approvisionnement', `
                <div class="space-y-4">
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <div class="font-black text-slate-900 mb-2">${product.name}</div>
                        <div class="grid grid-cols-2 gap-4 mt-3">
                            <div>
                                <div class="text-xs text-slate-500 font-black uppercase">Stock actuel</div>
                                <div class="text-2xl font-black text-slate-900">${product.stock}</div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-500 font-black uppercase">Qt� �� commander</div>
                                <div class="text-2xl font-black text-blue-600">${qty}</div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-500 font-black uppercase">Co��t unitaire</div>
                                <div class="text-lg font-black text-slate-900">${CORE.formatPrice(product.costPrice || 0)}</div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-500 font-black uppercase">Co��t total</div>
                                <div class="text-2xl font-black text-emerald-600">${CORE.formatPrice(cost)}</div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="font-black text-blue-900 text-sm">��? ��� � � Cette commande a �t� sugg�r�e par le syst��me d'IA</div>
                        <div class="text-xs text-blue-700 mt-2">Vous pouvez ajuster les quantit�s ou ajouter des commentaires avant de valider.</div>
                    </div>
                </div>
            `, [
                { label: 'Cr�er la commande', onclick: 'ManagerModule.confirmReorder(' + productId + ', ' + qty + ')', class: 'px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        confirmReorder(productId, qty) {
            const product = CORE.db.products.find(p => p.id === productId);
            if (!product) return;

            const order = {
                id: 'po_' + Date.now(),
                reference: 'PO-' + Date.now().toString().slice(-6),
                type: 'purchase_order',
                productId: productId,
                productName: product.name,
                qty: qty,
                unitPrice: product.costPrice || 0,
                totalCost: (product.costPrice || 0) * qty,
                status: 'pending',
                createdAt: new Date().toISOString(),
                createdBy: CORE.state.currentUser?.id,
                createdByName: CORE.state.currentUser?.name,
                expectedDelivery: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),
                notes: 'G�n�r� automatiquement par le syst��me d\'IA'
            };

            CORE.db.purchaseOrders = CORE.db.purchaseOrders || [];
            CORE.db.purchaseOrders.push(order);
            ManagerModule.logManagerAction('REORDER_CREATED', `Commande d'approvisionnement cr��e: ${product.name} (${qty} unit�s)`, 'stock', productId);
            CORE.save();
            
            UI.toast('���?? Commande d\'approvisionnement cr��e', 'success');
            UI.closeModal();
        },

        acceptReorderSuggestion(suggestionId) {
            const suggestion = CORE.db.reorderSuggestions.find(s => s.id === suggestionId);
            if (!suggestion) return;

            this.confirmReorder(suggestion.productId, suggestion.suggestedQty);
            suggestion.status = 'accepted';
            CORE.save();
        },

        exportSmartStockReport() {
            const predictions = CORE.db.stockPredictions || [];
            const abc = CORE.db.stockAnalysisABC || [];
            const suggestions = CORE.db.reorderSuggestions || [];
            const alerts = CORE.db.expiryAlerts || [];

            const report = `
RAPPORT GESTION INTELLIGENTE DU STOCK
G�n�r� le: ${CORE.formatDate(new Date().toISOString())}

========== R�SUM� EX�CUTIF ==========
Produits �� risque de rupture: ${predictions.filter(p => p.riskLevel.includes('RUPTURE')).length}
Produits �� risque: ${predictions.filter(p => p.riskLevel.includes('RISQUE')).length}
Suggestions d'approvisionnement: ${suggestions.length}
Alertes de p�remption: ${alerts.filter(a => a.type === 'expiry').length}
Produits obsol��tes: ${alerts.filter(a => a.type === 'obsolescence').length}

========== PR�DICTIONS STOCK (30 JOURS) ==========
${predictions.slice(0, 20).map(p => `
${p.name} (${p.sku})
- Stock actuel: ${p.currentStock} ���? Pr�dit: ${p.predictedStock}
- Consommation moyenne: ${p.avgDailyConsumption}/jour
- Risque: ${p.riskLevel}
- Confiance: ${p.confidence}
`).join('')}

========== ANALYSE ABC (PARETO) ==========
${['A', 'B', 'C'].map(cat => {
    const items = abc.filter(a => a.category === cat);
    const label = cat === 'A' ? 'CAT�GORIE A - CRITIQUE' : cat === 'B' ? 'CAT�GORIE B - IMPORTANT' : 'CAT�GORIE C - NORMAL';
    return `
${label}
Nombre de produits: ${items.length}
Chiffre d'affaires total: ${CORE.formatPrice(items.reduce((s, i) => s + i.revenue, 0))}
Marge totale: ${CORE.formatPrice(items.reduce((s, i) => s + i.profitValue, 0))}
`;
}).join('')}

========== SUGGESTIONS D'APPROVISIONNEMENT ==========
${suggestions.slice(0, 20).map(s => `
${s.productName} (${s.sku}) - Urgence: ${s.urgency}
- Quantit� �� commander: ${s.suggestedQty}
- Co��t estim�: ${CORE.formatPrice(s.estimatedCost)}
- Raison: ${s.reason}
`).join('')}

========== ALERTES DE P�REMPTION/OBSOLESCENCE ==========
${alerts.slice(0, 20).map(a => `
${a.productName} (${a.sku})
- Type: ${a.type}
- S�v�rit�: ${a.severity}
- Raison: ${a.reason}
- Action: ${a.action}
`).join('')}

========== RECOMMANDATIONS ==========
1. Traiter en priorit� les produits en rupture imm�diate
2. Valider les suggestions d'approvisionnement pour les cat�gories A et B
3. G�rer les promo pour les produits proches de l'expiration
4. Revoir la strat�gie de prix pour les produits obsol��tes

Rapport g�n�r� par le syst��me d'IA de gestion du stock
            `;

            const blob = new Blob([report], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `smart_stock_report_${new Date().getTime()}.txt`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('���?? Rapport export�', 'success');
        },

        // ========== PERSONNALISATION ET PR�F�RENCES ==========

        // ��ŸŽ � Tableau de bord personnalisable avec drag & drop
        showPersonalizationModal() {
            const user = CORE.state.currentUser;
            if (!user) return;

            const userPrefs = CORE.db.userPreferences?.find(p => p.userId === user.id) || {
                userId: user.id,
                userName: user.name,
                theme: 'light',
                language: 'fr',
                compactMode: false,
                enableNotifications: true,
                enableSounds: true,
                defaultDashboard: 'overview',
                sidebarCollapsed: false,
                dateFormat: 'DD/MM/YYYY',
                numberFormat: 'fr-FR'
            };

            const themeSettings = CORE.db.themeSettings?.find(t => t.userId === user.id);
            const alertPrefs = AlertesModule.getAlertPreferences(user.id);
            const silenceSchedules = AlertesModule.getSilenceSchedules(user.id);

            UI.modal('��š ?��� � � Personnalisation & Pr�f�rences', `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <!-- Onglets -->
                    <div class="flex gap-2 border-b border-slate-200 overflow-x-auto">
                        <button onclick="document.getElementById('pref-theme').classList.remove('hidden'); document.getElementById('pref-dashboard').classList.add('hidden'); document.getElementById('pref-shortcuts').classList.add('hidden'); document.getElementById('pref-alerts').classList.add('hidden')" class="px-4 py-3 font-black text-sm border-b-2 border-blue-500 text-blue-600 whitespace-nowrap">��ŸŽ � Th��me</button>
                        <button onclick="document.getElementById('pref-dashboard').classList.remove('hidden'); document.getElementById('pref-theme').classList.add('hidden'); document.getElementById('pref-shortcuts').classList.add('hidden'); document.getElementById('pref-alerts').classList.add('hidden')" class="px-4 py-3 font-black text-sm text-slate-500 hover:text-slate-700 whitespace-nowrap">��Ÿ?Š Dashboard</button>
                        <button onclick="document.getElementById('pref-shortcuts').classList.remove('hidden'); document.getElementById('pref-theme').classList.add('hidden'); document.getElementById('pref-dashboard').classList.add('hidden'); document.getElementById('pref-alerts').classList.add('hidden')" class="px-4 py-3 font-black text-sm text-slate-500 hover:text-slate-700 whitespace-nowrap">���? ��� � � Raccourcis</button>
                        <button onclick="document.getElementById('pref-alerts').classList.remove('hidden'); document.getElementById('pref-theme').classList.add('hidden'); document.getElementById('pref-dashboard').classList.add('hidden'); document.getElementById('pref-shortcuts').classList.add('hidden')" class="px-4 py-3 font-black text-sm text-slate-500 hover:text-slate-700 whitespace-nowrap">��Ÿ�� Alertes</button>
                    </div>

                    <!-- Tab Th��me -->
                    <div id="pref-theme" class="space-y-4">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-slate-900 mb-4">��Ÿ�? ?� Mode sombre/clair</div>
                            <div class="space-y-3">
                                <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100">
                                    <input type="radio" name="theme" value="light" ${userPrefs.theme === 'light' ? 'checked' : ''} onchange="ManagerModule.saveThemePreference('light')">
                                    <span>���? ?��� � � Mode Clair (Jour)</span>
                                </label>
                                <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100">
                                    <input type="radio" name="theme" value="dark" ${userPrefs.theme === 'dark' ? 'checked' : ''} onchange="ManagerModule.saveThemePreference('dark')">
                                    <span>��Ÿ�? ?� Mode Sombre (Nuit)</span>
                                </label>
                                <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100">
                                    <input type="radio" name="theme" value="auto" ${userPrefs.theme === 'auto' ? 'checked' : ''} onchange="ManagerModule.saveThemePreference('auto')">
                                    <span>��Ÿ�? Auto (Syst��me)</span>
                                </label>
                            </div>
                        </div>

                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-slate-900 mb-4">��ŸŽ � Couleur d'accent</div>
                            <div class="grid grid-cols-4 gap-3">
                                ${['blue', 'emerald', 'purple', 'amber', 'red', 'cyan', 'indigo', 'rose'].map(color => `
                                    <button onclick="ManagerModule.setAccentColor('${color}')" class="p-4 rounded-xl font-black text-xs transition hover:scale-110 ${themeSettings?.accentColor === color ? 'ring-4 ring-offset-2' : ''}" style="background: var(--${color}-600, #3b82f6); color: white;">
                                        ${color === themeSettings?.accentColor ? '���??' : ''} ${color}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-slate-900 mb-3">��š ?��� � � Pr�f�rences d'interface</div>
                            <div class="space-y-3">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" ${userPrefs.compactMode ? 'checked' : ''} onchange="ManagerModule.updateUserPref('compactMode', this.checked)">
                                    <span class="text-sm font-black">Mode compact</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" ${userPrefs.sidebarCollapsed ? 'checked' : ''} onchange="ManagerModule.updateUserPref('sidebarCollapsed', this.checked)">
                                    <span class="text-sm font-black">Barre lat�rale r�duite</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Dashboard -->
                    <div id="pref-dashboard" class="hidden space-y-4">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-slate-900 mb-4">��Ÿ?Š Layout par d�faut</div>
                            <div class="space-y-2">
                                ${['overview', 'inventory', 'finance', 'team'].map(layout => `
                                    <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100">
                                        <input type="radio" name="defaultDashboard" value="${layout}" ${userPrefs.defaultDashboard === layout ? 'checked' : ''} onchange="ManagerModule.updateUserPref('defaultDashboard', '${layout}')">
                                        <span class="font-black text-sm">${layout === 'overview' ? '��Ÿ?�? Aper��u' : layout === 'inventory' ? '��Ÿ? � Inventaire' : layout === 'finance' ? '��Ÿ? � Finance' : '��Ÿ? � �quipe'}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>

                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                            <div class="font-black text-blue-900 text-sm">��? ��� � � Widgets personnalisables</div>
                            <div class="text-xs text-blue-700 mt-2">Glissez & d�posez les widgets pour r�organiser votre dashboard</div>
                        </div>

                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-slate-900 mb-3">��Ÿ?�? Widgets visibles</div>
                            <div class="space-y-2">
                                ${['dashboard_overview', 'audit_trail', 'compliance', 'smart_stock', 'recent_orders', 'critical_products'].map((widget, idx) => `
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" checked onchange="ManagerModule.toggleWidget('${widget}', this.checked)">
                                        <span class="text-sm font-black">${widget === 'dashboard_overview' ? '��Ÿ?�? Vue d\'ensemble' : widget === 'audit_trail' ? '��Ÿ?� Audit' : widget === 'compliance' ? '���?� Conformit�' : widget === 'smart_stock' ? '��Ÿ �? Stock IA' : widget === 'recent_orders' ? '��Ÿ? � Commandes' : '��š ��� � � Produits critiques'}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Tab Raccourcis clavier -->
                    <div id="pref-shortcuts" class="hidden space-y-4">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-slate-900 mb-4">���? ��� � � Raccourcis clavier</div>
                            <div class="space-y-2 max-h-96 overflow-y-auto">
                                <div class="grid grid-cols-2 gap-4 text-xs">
                                    <div class="p-3 bg-white rounded-lg border border-slate-200">
                                        <span class="font-black">Ctrl + K</span>
                                        <div class="text-slate-600 mt-1">Palette de commandes</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-lg border border-slate-200">
                                        <span class="font-black">Ctrl + /</span>
                                        <div class="text-slate-600 mt-1">Aide (raccourcis)</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-lg border border-slate-200">
                                        <span class="font-black">Ctrl + D</span>
                                        <div class="text-slate-600 mt-1">Dashboard</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-lg border border-slate-200">
                                        <span class="font-black">Ctrl + 1</span>
                                        <div class="text-slate-600 mt-1">Inventaire</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-lg border border-slate-200">
                                        <span class="font-black">Ctrl + 2</span>
                                        <div class="text-slate-600 mt-1">Finance</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-lg border border-slate-200">
                                        <span class="font-black">Ctrl + 3</span>
                                        <div class="text-slate-600 mt-1">�quipe</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-lg border border-slate-200">
                                        <span class="font-black">Ctrl + S</span>
                                        <div class="text-slate-600 mt-1">Recherche</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-lg border border-slate-200">
                                        <span class="font-black">Esc</span>
                                        <div class="text-slate-600 mt-1">Fermer modal</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                            <div class="font-black text-emerald-900 text-sm">���?� Raccourcis clavier activ�s</div>
                            <div class="text-xs text-emerald-700 mt-2">Appuyez sur Ctrl + / pour voir tous les raccourcis</div>
                        </div>
                    </div>

                    <!-- Tab Alertes Intelligentes -->
                    <div id="pref-alerts" class="hidden space-y-4">
                        <!-- Types d'alertes -->
                        <div class="grid grid-cols-3 gap-3">
                            <div class="p-3 bg-blue-50 rounded-lg border border-blue-200 text-center">
                                <span class="font-black text-blue-700">��Ÿ� � Info</span>
                                <div class="text-xs text-blue-600 mt-1">Informations g�n�rales</div>
                            </div>
                            <div class="p-3 bg-amber-50 rounded-lg border border-amber-200 text-center">
                                <span class="font-black text-amber-700">��ŸŸ � Attention</span>
                                <div class="text-xs text-amber-600 mt-1">�?� surveiller</div>
                            </div>
                            <div class="p-3 bg-red-50 rounded-lg border border-red-200 text-center">
                                <span class="font-black text-red-700">��Ÿ� � Critique</span>
                                <div class="text-xs text-red-600 mt-1">Action requise</div>
                            </div>
                        </div>

                        <!-- Pr�f�rences d'alertes par type -->
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-slate-900 mb-4">��Ÿ�� Alertes par type</div>
                            <div class="space-y-3">
                                ${Object.entries(alertPrefs.alerts || {}).map(([type, config]) => `
                                    <div class="p-3 border border-slate-200 rounded-lg bg-white">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="font-black text-sm">
                                                ${type === 'stock_low' ? '��Ÿ? �' : type === 'stock_critical' ? '��Ÿš �' : type === 'order_pending' ? '�� � �' : type === 'inactive_livreur' ? '��Ÿ�? �' : type === 'critical_incident' ? '��Ÿ� �' : '��Ÿ?Š'} 
                                                ${type.replace(/_/g, ' ')}
                                            </span>
                                            <label class="flex items-center gap-2">
                                                <input type="checkbox" ${config.enabled ? 'checked' : ''} onchange="AlertesModule.updateAlertPreference(${user.id}, '${type}', this.checked, '${config.level}', ${config.sendEmail || false}, ${config.sendSms || false}); App.rerender()">
                                                <span class="text-xs font-black">Actif</span>
                                            </label>
                                        </div>
                                        <div class="flex gap-2 items-center text-xs">
                                            <span>Niveau:</span>
                                            <select onchange="AlertesModule.updateAlertPreference(${user.id}, '${type}', ${config.enabled}, this.value, ${config.sendEmail || false}, ${config.sendSms || false}); App.rerender()" class="px-2 py-1 rounded border border-slate-300 text-xs font-black">
                                                <option value="info" ${config.level === 'info' ? 'selected' : ''}>Info</option>
                                                <option value="attention" ${config.level === 'attention' ? 'selected' : ''}>Attention</option>
                                                <option value="critique" ${config.level === 'critique' ? 'selected' : ''}>Critique</option>
                                            </select>
                                            ${['stock_critical', 'critical_incident'].includes(type) ? `
                                                <label class="flex items-center gap-1 cursor-pointer ml-auto">
                                                    <input type="checkbox" ${config.sendEmail ? 'checked' : ''} onchange="AlertesModule.updateAlertPreference(${user.id}, '${type}', ${config.enabled}, '${config.level}', this.checked, ${config.sendSms || false}); App.rerender()">
                                                    <span class="text-xs">��Ÿ? � Email</span>
                                                </label>
                                                <label class="flex items-center gap-1 cursor-pointer">
                                                    <input type="checkbox" ${config.sendSms ? 'checked' : ''} onchange="AlertesModule.updateAlertPreference(${user.id}, '${type}', ${config.enabled}, '${config.level}', ${config.sendEmail || false}, this.checked); App.rerender()">
                                                    <span class="text-xs">��Ÿ? � SMS</span>
                                                </label>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Mode Silence Programmable -->
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-slate-900 mb-4">��Ÿ � � Mode silence programmable</div>
                            <div class="space-y-3">
                                ${silenceSchedules.length > 0 ? silenceSchedules.map((schedule, idx) => `
                                    <div class="p-3 bg-white rounded-lg border border-slate-200 flex items-center justify-between">
                                        <div>
                                            <div class="font-black text-sm">${schedule.name}</div>
                                            <div class="text-xs text-slate-500">�� � � ${schedule.startTime} - ${schedule.endTime}</div>
                                        </div>
                                        <button onclick="AlertesModule.deleteSilenceSchedule(${schedule.id}); App.rerender()" class="px-2 py-1 text-xs font-black bg-red-100 text-red-600 rounded hover:bg-red-200">Supprimer</button>
                                    </div>
                                `).join('') : `<div class="text-center text-sm text-slate-500">Aucun mode silence configur�</div>`}
                                
                                <button onclick="AlertesModule.showAddSilenceSchedule(${user.id})" class="w-full px-3 py-2 bg-emerald-600 text-white font-black rounded-lg hover:bg-emerald-700 mt-2">+ Ajouter un mode silence</button>
                            </div>
                        </div>

                        <!-- Informations de contact pour alertes critiques -->
                        <div class="p-4 bg-blue-50 rounded-2xl border border-blue-200">
                            <div class="font-black text-blue-900 mb-3">��Ÿ? � Contact pour alertes critiques</div>
                            <div class="space-y-2">
                                <input type="email" placeholder="Email" value="${alertPrefs.emailAddress || ''}" onchange="AlertesModule.updateContactInfo(${user.id}, 'email', this.value)" class="w-full px-3 py-2 border border-blue-300 rounded-lg text-xs font-black placeholder-blue-400">
                                <input type="tel" placeholder="T�l�phone" value="${alertPrefs.phoneNumber || ''}" onchange="AlertesModule.updateContactInfo(${user.id}, 'phone', this.value)" class="w-full px-3 py-2 border border-blue-300 rounded-lg text-xs font-black placeholder-blue-400">
                            </div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'R�initialiser', onclick: 'ManagerModule.resetPreferences()', class: 'px-4 py-2 bg-slate-600 text-white font-black rounded-xl hover:bg-slate-700' },
                { label: 'Exporter', onclick: 'ManagerModule.exportPreferences()', class: 'px-4 py-2 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        // ��Ÿ�? ?� Gestion du th��me sombre/clair
        saveThemePreference(theme) {
            const user = CORE.state.currentUser;
            if (!user) return;

            let userPrefs = CORE.db.userPreferences?.find(p => p.userId === user.id);
            if (!userPrefs) {
                userPrefs = { userId: user.id, userName: user.name };
                CORE.db.userPreferences = CORE.db.userPreferences || [];
                CORE.db.userPreferences.push(userPrefs);
            }

            userPrefs.theme = theme;
            this.applyTheme(theme);
            CORE.save();
            localStorage.setItem('user_theme_' + user.id, theme);
            UI.toast(`���?? Th��me chang�: ${theme === 'light' ? 'Clair' : theme === 'dark' ? 'Sombre' : 'Auto'}`, 'success');
        },

        applyTheme(theme) {
            const html = document.documentElement;
            
            if (theme === 'dark') {
                html.style.filter = 'invert(1) hue-rotate(180deg)';
                html.style.backgroundColor = '#000';
                document.body.style.backgroundColor = '#000';
            } else if (theme === 'light') {
                html.style.filter = 'none';
                html.style.backgroundColor = '#fff';
                document.body.style.backgroundColor = '#fff';
            } else if (theme === 'auto') {
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.filter = isDark ? 'invert(1) hue-rotate(180deg)' : 'none';
                html.style.backgroundColor = isDark ? '#000' : '#fff';
            }
        },

        setAccentColor(color) {
            const user = CORE.state.currentUser;
            if (!user) return;

            let themeSettings = CORE.db.themeSettings?.find(t => t.userId === user.id);
            if (!themeSettings) {
                themeSettings = { userId: user.id, accentColor: color };
                CORE.db.themeSettings = CORE.db.themeSettings || [];
                CORE.db.themeSettings.push(themeSettings);
            } else {
                themeSettings.accentColor = color;
            }

            CORE.save();
            localStorage.setItem('user_accent_' + user.id, color);
            UI.toast(`���?? Couleur d'accent chang�e`, 'success');
        },

        // ��Ÿ� � Raccourcis clavier
        setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl + K = Palette de commandes
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    this.showCommandPalette();
                }
                // Ctrl + / = Aide
                if (e.ctrlKey && e.key === '/') {
                    e.preventDefault();
                    this.showKeyboardHelp();
                }
                // Ctrl + D = Dashboard
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    this.navigateTo('dashboard');
                }
                // Ctrl + 1 = Inventaire
                if (e.ctrlKey && e.key === '1') {
                    e.preventDefault();
                    this.navigateTo('inventory');
                }
                // Ctrl + 2 = Finance
                if (e.ctrlKey && e.key === '2') {
                    e.preventDefault();
                    this.navigateTo('finance');
                }
                // Ctrl + 3 = �quipe
                if (e.ctrlKey && e.key === '3') {
                    e.preventDefault();
                    this.navigateTo('team');
                }
                // Ctrl + S = Recherche
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    this.showSearchModal();
                }
                // Esc = Fermer modal
                if (e.key === 'Escape') {
                    UI.closeModal();
                }
            });
        },

        showCommandPalette() {
            let query = '';
            const commands = [
                { name: 'Dashboard', icon: '��Ÿ?�?', action: 'ManagerModule.navigateTo("dashboard")' },
                { name: 'Inventaire', icon: '��Ÿ? �', action: 'ManagerModule.navigateTo("inventory")' },
                { name: 'Finance', icon: '��Ÿ? �', action: 'ManagerModule.navigateTo("finance")' },
                { name: '�quipe', icon: '��Ÿ? �', action: 'ManagerModule.navigateTo("team")' },
                { name: 'Audit Trail', icon: '��Ÿ?�', action: 'ManagerModule.showAuditTrailModal()' },
                { name: 'Rapport de Conformit�', icon: '���?�', action: 'ManagerModule.showComplianceReport()' },
                { name: 'Gestion Intelligente', icon: '��Ÿ �?', action: 'ManagerModule.showSmartStockDashboard()' },
                { name: 'Pr�f�rences', icon: '��š ?��� � �', action: 'ManagerModule.showPersonalizationModal()' },
                { name: 'D�connexion', icon: '��Ÿš �', action: 'CORE.logout()' }
            ];

            UI.modal('��Ÿ� � Palette de Commandes', `
                <div class="space-y-3">
                    <input id="cmd-search" type="text" placeholder="Rechercher une commande..." class="w-full px-4 py-3 rounded-xl border border-slate-300 outline-none focus:ring-2 focus:ring-blue-500 font-black" onkeyup="ManagerModule.filterCommands(this.value)">
                    <div id="cmd-list" class="space-y-2 max-h-80 overflow-y-auto">
                        ${commands.map((cmd, idx) => `
                            <div id="cmd-${idx}" class="p-3 rounded-lg border border-slate-200 bg-slate-50 cursor-pointer hover:bg-blue-50 transition flex items-center gap-3" onclick="${cmd.action}; UI.closeModal();">
                                <span class="text-xl">${cmd.icon}</span>
                                <div>
                                    <div class="font-black text-slate-900">${cmd.name}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);

            setTimeout(() => document.getElementById('cmd-search')?.focus(), 100);
        },

        filterCommands(query) {
            const items = document.querySelectorAll('[id^="cmd-"]');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query.toLowerCase()) ? 'flex' : 'none';
            });
        },

        showKeyboardHelp() {
            UI.modal('���? ��� � � Aide - Raccourcis clavier', `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-xs text-slate-600 uppercase mb-3">Navigation</div>
                            <div class="space-y-2 text-sm">
                                <div><span class="font-black bg-slate-200 px-2 py-1 rounded">Ctrl + D</span> Dashboard</div>
                                <div><span class="font-black bg-slate-200 px-2 py-1 rounded">Ctrl + 1</span> Inventaire</div>
                                <div><span class="font-black bg-slate-200 px-2 py-1 rounded">Ctrl + 2</span> Finance</div>
                                <div><span class="font-black bg-slate-200 px-2 py-1 rounded">Ctrl + 3</span> �quipe</div>
                            </div>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-xs text-slate-600 uppercase mb-3">Recherche & Commandes</div>
                            <div class="space-y-2 text-sm">
                                <div><span class="font-black bg-slate-200 px-2 py-1 rounded">Ctrl + K</span> Palette</div>
                                <div><span class="font-black bg-slate-200 px-2 py-1 rounded">Ctrl + S</span> Recherche</div>
                                <div><span class="font-black bg-slate-200 px-2 py-1 rounded">Esc</span> Fermer</div>
                            </div>
                        </div>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showSearchModal() {
            UI.modal('��Ÿ� � Recherche Globale', `
                <div class="space-y-4">
                    <input id="global-search" type="text" placeholder="Rechercher partout..." class="w-full px-4 py-3 rounded-xl border border-slate-300 outline-none focus:ring-2 focus:ring-blue-500 font-black" onkeyup="ManagerModule.performGlobalSearch(this.value)">
                    <div id="search-results" class="space-y-2 max-h-80 overflow-y-auto">
                        <div class="text-center text-slate-400">Entrez une recherche...</div>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);

            setTimeout(() => document.getElementById('global-search')?.focus(), 100);
        },

        performGlobalSearch(query) {
            if (!query || query.length < 2) {
                document.getElementById('search-results').innerHTML = '<div class="text-center text-slate-400">Entrez au moins 2 caract��res...</div>';
                return;
            }

            const q = query.toLowerCase();
            const results = [];

            // Chercher dans les produits
            CORE.db.products.slice(0, 5).forEach(p => {
                if (p.name.toLowerCase().includes(q) || p.sku?.toLowerCase().includes(q)) {
                    results.push({ type: 'product', name: p.name, icon: '��Ÿ? �' });
                }
            });

            // Chercher dans les commandes
            CORE.db.orders.slice(0, 5).forEach(o => {
                if (o.reference.toLowerCase().includes(q)) {
                    results.push({ type: 'order', name: o.reference, icon: '��Ÿ�?' });
                }
            });

            // Chercher dans les utilisateurs
            CORE.db.users.slice(0, 5).forEach(u => {
                if (u.name.toLowerCase().includes(q) || u.email?.toLowerCase().includes(q)) {
                    results.push({ type: 'user', name: u.name, icon: '��Ÿ? �' });
                }
            });

            if (results.length === 0) {
                document.getElementById('search-results').innerHTML = '<div class="text-center text-slate-400">Aucun r�sultat trouv�</div>';
                return;
            }

            document.getElementById('search-results').innerHTML = results.map(r => `
                <div class="p-3 rounded-lg border border-slate-200 bg-slate-50 cursor-pointer hover:bg-blue-50 transition flex items-center gap-3">
                    <span class="text-xl">${r.icon}</span>
                    <div>
                        <div class="font-black text-slate-900">${r.name}</div>
                        <div class="text-xs text-slate-500">${r.type}</div>
                    </div>
                </div>
            `).join('');
        },

        // ��Ÿ? � Gestion des pr�f�rences utilisateur
        updateUserPref(key, value) {
            const user = CORE.state.currentUser;
            if (!user) return;

            let userPrefs = CORE.db.userPreferences?.find(p => p.userId === user.id);
            if (!userPrefs) {
                userPrefs = { userId: user.id, userName: user.name };
                CORE.db.userPreferences = CORE.db.userPreferences || [];
                CORE.db.userPreferences.push(userPrefs);
            }

            userPrefs[key] = value;
            CORE.save();
            localStorage.setItem('user_pref_' + key + '_' + user.id, JSON.stringify(value));
        },

        toggleWidget(widgetId, visible) {
            const user = CORE.state.currentUser;
            if (!user) return;

            let config = CORE.db.widgetConfigs?.find(c => c.userId === user.id);
            if (!config) {
                config = { userId: user.id, widgets: {} };
                CORE.db.widgetConfigs = CORE.db.widgetConfigs || [];
                CORE.db.widgetConfigs.push(config);
            }

            if (!config.widgets) config.widgets = {};
            config.widgets[widgetId] = visible;
            CORE.save();
        },

        resetPreferences() {
            if (!confirm('�?Štes-vous s��r de vouloir r�initialiser toutes les pr�f�rences?')) return;

            const user = CORE.state.currentUser;
            if (!user) return;

            // Supprimer les pr�f�rences utilisateur
            const prefIdx = CORE.db.userPreferences?.findIndex(p => p.userId === user.id);
            if (prefIdx >= 0) CORE.db.userPreferences.splice(prefIdx, 1);

            // Supprimer les param��tres de th��me
            const themeIdx = CORE.db.themeSettings?.findIndex(t => t.userId === user.id);
            if (themeIdx >= 0) CORE.db.themeSettings.splice(themeIdx, 1);

            // Supprimer les layouts
            const layoutIdx = CORE.db.dashboardLayouts?.findIndex(l => l.userId === user.id);
            if (layoutIdx >= 0) CORE.db.dashboardLayouts.splice(layoutIdx, 1);

            CORE.save();
            localStorage.removeItem('user_theme_' + user.id);
            UI.toast('���?? Pr�f�rences r�initialis�es', 'success');
            setTimeout(() => location.reload(), 500);
        },

        exportPreferences() {
            const user = CORE.state.currentUser;
            if (!user) return;

            const userPrefs = CORE.db.userPreferences?.find(p => p.userId === user.id) || {};
            const themeSettings = CORE.db.themeSettings?.find(t => t.userId === user.id) || {};
            const widgets = CORE.db.widgetConfigs?.find(c => c.userId === user.id)?.widgets || {};

            const data = {
                exportedAt: new Date().toISOString(),
                user: user.name,
                preferences: userPrefs,
                theme: themeSettings,
                widgets: widgets
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `preferences_${user.id}_${Date.now()}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('���?? Pr�f�rences export�es', 'success');
        },

        loadUserPreferences() {
            const user = CORE.state.currentUser;
            if (!user) return;

            // Charger le th��me sauvegard�
            const savedTheme = localStorage.getItem('user_theme_' + user.id);
            if (savedTheme) {
                this.applyTheme(savedTheme);
            }

            // Charger les autres pr�f�rences
            const userPrefs = CORE.db.userPreferences?.find(p => p.userId === user.id);
            if (userPrefs?.compactMode) {
                document.body.classList.add('compact-mode');
            }

            // Initialiser les raccourcis clavier
            this.setupKeyboardShortcuts();
        }
    };

    // =========================================================
    // MODULE: GESTIONNAIRE (Logistique / Stock)
    // =========================================================
    const GestionnaireModule = {
        state: { 
            currentView: 'dashboard', 
            financeView: 'overview',
            theme: 'light', 
            notificationsEnabled: true,
            preferences: { notificationsEnabled: true, soundEnabled: true, soundVolume: 0.8 },
            slaThresholds: { minOnTimeRate: 80, maxPendingOrders: 10, minDailyDeposits: 50000, maxDeliveryMinutes: 60 }, 
            kpiTimerId: null,
            notifications: [],
            notificationHistory: [],
            notificationFilters: NotificationUtils.defaultFilters(),
            criticalAlerts: {},
            transferReceiptsTab: 'pending',
            pendingReceiptFiles: [],
            // Livraisons filtres
            deliveryStatus: 'all',
            deliverySearch: '',
            // Stock pagination et filtres
            stockSearch: '',
            stockCategoryFilter: 'all',
            stockStatusFilter: 'all',
            stockSortBy: 'name',
            stockViewMode: 'table',
            stockPage: 1,
            stockPerPage: 50,
            stockTab: 'dashboard', // dashboard | indicators | history | analysis | recommendations
            // Cache syst��me
            cache: {
                products: { data: null, timestamp: 0, ttl: 30000 },
                stocks: { data: null, timestamp: 0, ttl: 20000 },
                movements: { data: null, timestamp: 0, ttl: 30000 }
            }
        },

        // =====================
        // INITIALISATION
        // =====================
        init() {
            // R�initialiser la vue par d�faut
            this.state.currentView = 'dashboard';
            this.state.financeView = 'overview';
            this.loadThemePreference();
        },

        // ============ SYST�?ME DE CACHING ============
        getCachedData(key) {
            const cache = this.state.cache[key];
            if (!cache) return null;
            const now = Date.now();
            if (now - cache.timestamp > cache.ttl) {
                cache.data = null;
                return null;
            }
            return cache.data;
        },

        setCachedData(key, data) {
            if (this.state.cache[key]) {
                this.state.cache[key].data = data;
                this.state.cache[key].timestamp = Date.now();
            }
        },

        invalidateCache(keys = null) {
            if (!keys) {
                Object.keys(this.state.cache).forEach(k => {
                    this.state.cache[k].data = null;
                });
            } else {
                (Array.isArray(keys) ? keys : [keys]).forEach(k => {
                    if (this.state.cache[k]) this.state.cache[k].data = null;
                });
            }
        },

        getProductsOptimized() {
            let cached = this.getCachedData('products');
            if (cached) return cached;
            
            const user = CORE.state.currentUser;
            const posId = user?.pos;
            const isPdgOrManager = user?.role === 'pdg' || user?.role === 'manager';
            
            // PDG/Manager: voir tous les produits
            if (isPdgOrManager) {
                const products = (CORE.db.products || []).map(p => ({
                    ...p,
                    stock: p.stock || 0,
                    displayPrice: p.price || 0
                }));
                this.setCachedData('products', products);
                return products;
            }
            
            // Gestionnaire: produits qui appartiennent au POS OU qui ont du stock dans ce POS
            const products = (CORE.db.products || []).filter(p => {
                // Produit appartient directement au POS
                if (p.posId == posId) return true;
                // Produit a du stock dans ce POS via posStocks
                if (p.posStocks && p.posStocks[posId] && p.posStocks[posId].stock > 0) return true;
                return false;
            }).map(p => {
                // Enrichir le produit avec le stock du POS actuel
                const posStock = p.posStocks && p.posStocks[posId] ? p.posStocks[posId].stock : (p.posId == posId ? (p.stock || 0) : 0);
                const posPrice = p.posStocks && p.posStocks[posId] ? (p.posStocks[posId].price || p.price || 0) : (p.price || 0);
                return {
                    ...p,
                    stock: posStock,
                    displayPrice: posPrice
                };
            });
            
            this.setCachedData('products', products);
            return products;
        },

        getStockMovementsOptimized(limit = 100) {
            let cached = this.getCachedData('movements');
            if (cached) return cached;
            
            const user = CORE.state.currentUser;
            const posId = user?.pos;
            const isPdgOrManager = user?.role === 'pdg' || user?.role === 'manager';
            
            // PDG/Manager: voir tous les mouvements
            const movements = isPdgOrManager
                ? (CORE.db.stockMovements || []).slice(0, limit)
                : (CORE.db.stockMovements || []).filter(m => m.posId == posId || !m.posId).slice(0, limit);
            
            this.setCachedData('movements', movements);
            return movements;
        },

        renderNavItem(view, icon, label, badge = 0) {
            if (!CORE.canAccessView(view)) return '';
            const isActive = this.state.currentView === view;
            return `
                <button onclick="GestionnaireModule.navigateTo('${view}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group ${isActive ? 'bg-gradient-to-r from-cyan-500/20 to-teal-500/10 text-cyan-400 border-l-2 border-cyan-400' : 'text-slate-400 hover:bg-white/5 hover:text-white'}">
                    <div class="w-9 h-9 rounded-xl ${isActive ? 'bg-cyan-500/20' : 'bg-white/5 group-hover:bg-white/10'} flex items-center justify-center transition-all duration-200 relative">
                        <i data-lucide="${icon}" class="w-5 h-5 ${isActive ? 'drop-shadow-[0_0_8px_rgba(6,182,212,0.5)]' : ''}"></i>
                        ${badge > 0 ? `<span class="absolute -top-1 -right-1 w-5 h-5 bg-amber-500 text-white text-[10px] font-black rounded-full flex items-center justify-center animate-pulse">${badge}</span>` : ''}
                    </div>
                    <span class="font-bold text-sm">${label}</span>
                    ${isActive ? '<div class="ml-auto w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>' : ''}
                </button>`;
        },

        navigateTo(view) { 
            if (!CORE.canAccessView(view)) {
                return UI.toast('Acc��s refus�', 'error');
            }
            this.state.currentView = view; 
            if (view === 'team') this.startKpiTimer(); else this.stopKpiTimer();
            App.rerender(); 
        },

        setTheme(theme) {
            this.state.theme = theme;
            const userId = CORE.user?.id || 'default';
            localStorage.setItem(`gestionnaire_theme_${userId}`, theme);
            
            // Appliquer le th��me directement (style WhatsApp comme Vendeur)
            const html = document.documentElement;
            const body = document.body;

            html.classList.remove('gestionnaire-dark', 'gestionnaire-light', 'gestionnaire-auto');
            if (body) body.classList.remove('gestionnaire-dark', 'gestionnaire-light', 'gestionnaire-auto');
            html.style.filter = 'none';

            if (theme === 'dark') {
                html.classList.add('gestionnaire-dark');
                if (body) body.classList.add('gestionnaire-dark');
                html.style.backgroundColor = '#111b21';
            } else if (theme === 'light') {
                html.classList.add('gestionnaire-light');
                if (body) body.classList.add('gestionnaire-light');
                html.style.backgroundColor = '#ffffff';
            } else if (theme === 'auto') {
                html.classList.add('gestionnaire-auto');
                if (body) body.classList.add('gestionnaire-auto');
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.backgroundColor = isDark ? '#111b21' : '#ffffff';
                if (isDark) {
                    html.classList.add('gestionnaire-dark');
                    if (body) body.classList.add('gestionnaire-dark');
                }
            }
            
            UI.toast('Th��me: ' + (theme === 'light' ? 'Clair' : theme === 'dark' ? 'Sombre' : 'Auto'), 'success');
            App.rerender();
        },

        applyTheme() {
            const html = document.documentElement;
            const body = document.body;
            const theme = this.state.theme;

            html.classList.remove('gestionnaire-dark', 'gestionnaire-light', 'gestionnaire-auto');
            if (body) body.classList.remove('gestionnaire-dark', 'gestionnaire-light', 'gestionnaire-auto');
            html.style.filter = 'none';

            if (theme === 'dark') {
                html.classList.add('gestionnaire-dark');
                if (body) body.classList.add('gestionnaire-dark');
                html.style.backgroundColor = '#111b21';
            } else if (theme === 'light') {
                html.classList.add('gestionnaire-light');
                if (body) body.classList.add('gestionnaire-light');
                html.style.backgroundColor = '#ffffff';
            } else if (theme === 'auto') {
                html.classList.add('gestionnaire-auto');
                if (body) body.classList.add('gestionnaire-auto');
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.backgroundColor = isDark ? '#111b21' : '#ffffff';
                if (isDark) {
                    html.classList.add('gestionnaire-dark');
                    if (body) body.classList.add('gestionnaire-dark');
                }
            }
        },

        loadThemePreference() {
            const userId = CORE.user?.id || 'default';
            const saved = localStorage.getItem(`gestionnaire_theme_${userId}`);
            if (saved) {
                this.state.theme = saved;
                this.applyTheme();
            }
            this.loadNotificationPreference();
            this.loadSlaThresholds();
        },

        loadSlaThresholds() {
            const raw = localStorage.getItem('gestionnaire_sla_thresholds');
            if (!raw) return;
            try {
                const parsed = JSON.parse(raw);
                if (parsed && typeof parsed === 'object') {
                    this.state.slaThresholds = { ...this.state.slaThresholds, ...parsed };
                }
            } catch (e) {}
        },
        saveSlaThresholds(th = null) {
            const next = th || this.state.slaThresholds;
            localStorage.setItem('gestionnaire_sla_thresholds', JSON.stringify(next));
            UI.toast('Seuils SLA enregistr�s', 'success');
            App.rerender();
        },
        getTeamKPIs(posId) {
            const th = this.state.slaThresholds;
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const orders = (CORE.db.orders || []).filter(o => o.posId === posId);
            const pendingOrders = orders.filter(o => ['pending','delivering','reserved'].includes(o.status)).length;
            const deliveries = (CORE.db.deliveries || []).filter(d => {
                const o = (CORE.db.orders || []).find(x => x.id === d.orderId);
                return o && o.posId === posId;
            });
            const delivered = deliveries.filter(d => d.status === 'livree' && d.deliveredAt);
            const onTimeDelivered = delivered.filter(d => {
                const startTs = d.assignedAt || d.createdAt;
                const endTs = d.deliveredAt;
                if (!startTs || !endTs) return false;
                const mins = (new Date(endTs) - new Date(startTs)) / 60000;
                return mins <= th.maxDeliveryMinutes;
            });
            const onTimeRate = delivered.length > 0 ? Math.round((onTimeDelivered.length / delivered.length) * 100) : 0;
            const depositsToday = (CORE.db.deposits || []).filter(d => {
                if (!d.timestamp) return false;
                const t = new Date(d.timestamp);
                return t >= startOfDay && t <= now && d.posId === posId;
            });
            const dailyDeposits = Math.round(depositsToday.reduce((a, d) => a + (d.amount || 0), 0));
            return { onTimeRate, dailyDeposits, pendingOrders };
        },
        evaluateSLA(kpis) {
            const th = this.state.slaThresholds;
            const alerts = [];
            if (kpis.onTimeRate < th.minOnTimeRate) alerts.push({ key: 'onTimeRate', label: 'Taux livraison dans les d�lais', value: kpis.onTimeRate + '%', threshold: th.minOnTimeRate + '%', severity: 'red' });
            if (kpis.pendingOrders > th.maxPendingOrders) alerts.push({ key: 'pendingOrders', label: 'Commandes en attente', value: kpis.pendingOrders, threshold: th.maxPendingOrders, severity: 'amber' });
            if (kpis.dailyDeposits < th.minDailyDeposits) alerts.push({ key: 'dailyDeposits', label: 'D�p��ts journaliers', value: CORE.formatPrice(kpis.dailyDeposits), threshold: CORE.formatPrice(th.minDailyDeposits), severity: 'red' });
            return alerts;
        },
        startKpiTimer() {
            if (this.state.kpiTimerId) return;
            // refresh KPIs every 10s
            this.state.kpiTimerId = setInterval(() => { App.rerender(); }, 10000);
        },
        stopKpiTimer() {
            if (this.state.kpiTimerId) { clearInterval(this.state.kpiTimerId); this.state.kpiTimerId = null; }
        },

        addNotification(type, title, message, severity = 'info') {
            const notification = {
                id: Date.now(),
                type,
                title,
                message,
                severity,
                timestamp: new Date(),
                read: false
            };
            
            this.state.notifications.push(notification);
            this.state.notificationHistory.push(notification);
            
            // Garder seulement les 100 derni��res notifications en historique
            if (this.state.notificationHistory.length > 100) {
                this.state.notificationHistory.shift();
            }
            
            // Auto-remove apr��s 10s
            setTimeout(() => {
                this.state.notifications = this.state.notifications.filter(n => n.id !== notification.id);
            }, 10000);
            
            // Toast visuel
            UI.toast(title + ': ' + message, severity);
        },

        checkCriticalEvents() {
            // Si notifications d�sactiv�es, ne pas v�rifier
            if (!this.state.notificationsEnabled) return;
            
            const posId = CORE.state.currentUser?.pos;
            if (!posId) return; // �viter les erreurs si pas connect�
            
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            // V�rifier SLA d�pass�
            const kpis = this.getTeamKPIs(posId);
            const th = this.state.slaThresholds;
            
            if (kpis.onTimeRate < th.minOnTimeRate && !this.state.criticalAlerts['sla_rate']) {
                this.addNotification('sla', '��Ÿ?Š SLA Taux livraison', 
                    `Taux ${kpis.onTimeRate}% < ${th.minOnTimeRate}% (seuil)`, 'red');
                this.state.criticalAlerts['sla_rate'] = true;
            } else if (kpis.onTimeRate >= th.minOnTimeRate) {
                delete this.state.criticalAlerts['sla_rate'];
            }
            
            if (kpis.pendingOrders > th.maxPendingOrders && !this.state.criticalAlerts['pending']) {
                this.addNotification('pending', '�� � ��� � � Commandes en attente', 
                    `${kpis.pendingOrders} commandes en attente (max: ${th.maxPendingOrders})`, 'amber');
                this.state.criticalAlerts['pending'] = true;
            } else if (kpis.pendingOrders <= th.maxPendingOrders) {
                delete this.state.criticalAlerts['pending'];
            }
            
            if (kpis.dailyDeposits < th.minDailyDeposits && !this.state.criticalAlerts['deposits']) {
                this.addNotification('deposits', '��Ÿ? � D�p��ts en retard', 
                    `D�p��ts: ${CORE.formatPrice(kpis.dailyDeposits)} < ${CORE.formatPrice(th.minDailyDeposits)}`, 'red');
                this.state.criticalAlerts['deposits'] = true;
            } else if (kpis.dailyDeposits >= th.minDailyDeposits) {
                delete this.state.criticalAlerts['deposits'];
            }
            
            // V�rifier stocks faibles (utiliser le stock du POS)
            const lowStockProducts = (CORE.db.products || []).filter(p => {
                // V�rifier si le produit appartient au POS ou a du stock dans ce POS
                const belongsToPos = p.posId == posId;
                const hasStockInPos = p.posStocks && p.posStocks[posId] && p.posStocks[posId].stock > 0;
                if (!belongsToPos && !hasStockInPos) return false;
                if (this.state.criticalAlerts['stock_' + p.id]) return false;
                
                // Obtenir le stock r�el du POS
                const stock = p.posStocks && p.posStocks[posId] ? p.posStocks[posId].stock : (belongsToPos ? (p.stock || 0) : 0);
                const minStock = p.minStock || 0;
                return stock <= minStock;
            });
            
            lowStockProducts.forEach(p => {
                this.addNotification('stock', '��Ÿ? � Stock faible', 
                    `${p.name}: ${p.stock}/${p.minStock} min`, 'amber');
                this.state.criticalAlerts['stock_' + p.id] = true;
            });
            
            // V�rifier incidents ouverts
            const incidents = (CORE.db.incidents || []).filter(i => i.posId === posId && !i.resolved);
            incidents.forEach(inc => {
                if (!this.state.criticalAlerts['incident_' + inc.id]) {
                    this.addNotification('incident', '��Ÿš � Incident escalad�', 
                        `${inc.type}: ${inc.description || 'Nouveau probl��me'}`, 'red');
                    this.state.criticalAlerts['incident_' + inc.id] = true;
                }
            });
        },

        testNotification() {
            this.addNotification('test', '��Ÿ�� Notification test', 'Ceci est une notification de test pour v�rifier que le syst��me fonctionne', 'success');
        },

        toggleNotifications() {
            this.state.notificationsEnabled = !this.state.notificationsEnabled;
            localStorage.setItem('gestionnaire_notifications_enabled', this.state.notificationsEnabled);
            const status = this.state.notificationsEnabled ? 'Activ�es' : 'D�sactiv�es';
            UI.toast(`Notifications ${status}`, this.state.notificationsEnabled ? 'success' : 'info');
            App.rerender();
        },

        loadNotificationPreference() {
            const saved = localStorage.getItem('gestionnaire_notifications_enabled');
            if (saved !== null) {
                this.state.notificationsEnabled = saved === 'true';
            }
        },

        generateTestAlerts() {
            // Cr�er des conditions pour d�clencher toutes les alertes
            
            // 1. Alert SLA - cr�er des commandes avec mauvais taux de livraison
            const posId = CORE.state.currentUser?.pos;
            if (!posId) return UI.toast('POS non d�fini', 'error');
            
            // Cr�er une commande non livr�e �� temps
            const testOrder = {
                id: 'test_order_' + Date.now(),
                posId: posId,
                status: 'delivering',
                createdAt: new Date(Date.now() - 120 * 60000).toISOString() // 120 min ago
            };
            CORE.db.orders.push(testOrder);
            
            // Cr�er une livraison non livr�e
            const testDelivery = {
                id: 'test_delivery_' + Date.now(),
                orderId: testOrder.id,
                status: 'livree',
                assignedAt: new Date(Date.now() - 120 * 60000).toISOString(),
                deliveredAt: new Date().toISOString()
            };
            CORE.db.deliveries.push(testDelivery);
            
            // 2. Alert Stock - cr�er un produit avec stock faible
            const testProduct = {
                id: 'test_product_' + Date.now(),
                posId: posId,
                name: 'Produit Test Stock Faible',
                stock: 2,
                minStock: 5
            };
            CORE.db.products.push(testProduct);
            
            // 3. Alert Incident - cr�er un incident ouvert
            const testIncident = {
                id: 'test_incident_' + Date.now(),
                posId: posId,
                type: 'Probl��me logistique',
                description: 'Test incident pour v�rifier les notifications',
                resolved: false
            };
            CORE.db.incidents.push(testIncident);
            
            CORE.save();
            UI.toast('Donn�es de test cr��es - Les alertes devraient appara��tre', 'success');
            App.rerender();
        },

        renderNotificationCenter() {
            if (!this.state.notifications || this.state.notifications.length === 0) return '';
            
            return `
                <div class="fixed top-4 right-4 max-w-sm z-50 space-y-2">
                    ${this.state.notifications.map(n => `
                        <div class="animate-slideIn p-4 rounded-2xl backdrop-blur-md border shadow-2xl transition-all hover:shadow-xl ${
                            n.severity === 'red' ? 'bg-red-50/95 border-red-200 text-red-900' :
                            n.severity === 'amber' ? 'bg-amber-50/95 border-amber-200 text-amber-900' :
                            n.severity === 'success' ? 'bg-emerald-50/95 border-emerald-200 text-emerald-900' :
                            'bg-blue-50/95 border-blue-200 text-blue-900'
                        }">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 text-xl">
                                    ${n.severity === 'red' ? '�� ��?' :
                                      n.severity === 'amber' ? '��š ��� � �' :
                                      n.severity === 'success' ? '���?�' :
                                      '��? ��� � �'}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="font-black text-sm leading-tight">${n.title}</p>
                                    <p class="text-xs opacity-90 mt-1">${n.message}</p>
                                </div>
                                <button onclick="GestionnaireModule.dismissNotification(${n.id})" class="flex-shrink-0 text-lg opacity-60 hover:opacity-100 transition">���?�</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        },

        dismissNotification(id) {
            this.state.notifications = this.state.notifications.filter(n => n.id !== id);
            const record = this.state.notificationHistory.find(n => n.id === id);
            if (record) {
                record.read = true;
                record.readAt = new Date();
            }
        },

        getNotificationFilters() {
            if (!this.state.notificationFilters) {
                this.state.notificationFilters = NotificationUtils.defaultFilters();
            }
            return NotificationUtils.ensureFilters(this.state.notificationFilters);
        },

        updateNotificationFilter(key, value) {
            const current = this.getNotificationFilters();
            this.state.notificationFilters = { ...current, [key]: value };
            this.refreshNotificationHistoryModal();
        },

        toggleUnreadFilter() {
            const current = this.getNotificationFilters();
            this.state.notificationFilters = { ...current, showUnread: !current.showUnread };
            this.refreshNotificationHistoryModal();
        },

        resetNotificationFilters() {
            this.state.notificationFilters = NotificationUtils.defaultFilters();
            this.refreshNotificationHistoryModal();
        },

        markAllNotificationHistoryRead() {
            this.state.notificationHistory.forEach(item => {
                item.read = true;
                item.readAt = item.readAt || new Date();
            });
            this.refreshNotificationHistoryModal();
        },

        toggleNotificationRead(id) {
            const notification = this.state.notificationHistory.find(n => n.id === id);
            if (!notification) return;
            const nextState = !notification.read;
            notification.read = nextState;
            notification.readAt = nextState ? new Date() : null;
            this.refreshNotificationHistoryModal();
        },

        refreshNotificationHistoryModal() {
            const container = document.querySelector('#modalContainer .modal-content');
            if (!container) return;
            UI.updateModalContent(this.renderNotificationHistoryContent());
        },

        renderNotificationHistoryContent() {
            const filters = this.getNotificationFilters();
            const allHistory = this.state.notificationHistory.slice().reverse();
            const filtered = NotificationUtils.applyFilters(allHistory, filters);
            const grouped = NotificationUtils.groupByDate(filtered);
            const counts = NotificationUtils.countBySeverity(allHistory);
            const typeOptions = NotificationUtils.getTypeOptions(allHistory);

            const severityOptions = [
                { key: 'all', label: 'Toutes', chip: 'bg-slate-200 text-slate-700' },
                { key: 'critical', label: 'Critiques' },
                { key: 'high', label: '�lev�es' },
                { key: 'medium', label: 'Mod�r�es' },
                { key: 'low', label: 'Faibles' },
                { key: 'info', label: 'Info' }
            ];

            const periodOptions = [
                { key: '24h', label: '24h' },
                { key: '7d', label: '7j' },
                { key: '30d', label: '30j' },
                { key: 'all', label: 'Tout' }
            ];

            return `
                <div class="space-y-5">
                    <div class="flex flex-col gap-4 bg-slate-50 border border-slate-200 rounded-2xl p-4">
                        <div class="flex flex-wrap items-center gap-3 justify-between">
                            <div>
                                <div class="font-black text-slate-900 text-sm">${filtered.length} r�sultat${filtered.length > 1 ? 's' : ''}</div>
                                <div class="text-xs text-slate-500">${allHistory.length} notifications enregistr�es</div>
                            </div>
                            <div class="flex flex-wrap gap-2 text-xs font-black">
                                <button class="px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-100 transition" onclick="GestionnaireModule.resetNotificationFilters()">R�initialiser</button>
                                <button class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition" onclick="GestionnaireModule.markAllNotificationHistoryRead()">Tout marquer lu</button>
                            </div>
                        </div>

                        <div class="grid gap-3">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div class="relative flex gap-2">
                                    <input type="search" id="gestionnaire-notif-search" value="${NotificationUtils.escape(filters.search)}" onkeypress="if(event.key==='Enter'){GestionnaireModule.updateNotificationFilter('search', this.value)}" placeholder="Rechercher titre, message, type..." class="flex-1 px-4 py-2.5 rounded-xl border border-slate-200 bg-white text-sm focus:ring-2 focus:ring-emerald-500 focus:border-transparent" />
                                    <button onclick="GestionnaireModule.updateNotificationFilter('search', document.getElementById('gestionnaire-notif-search').value)" class="px-3 py-2 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition"><i data-lucide="search" class="w-4 h-4"></i></button>
                                </div>
                                <div class="flex items-center gap-2">
                                    ${periodOptions.map(option => `
                                        <button class="px-3 py-2 rounded-lg text-xs font-black border ${filters.period === option.key ? 'bg-slate-900 text-white border-slate-900' : 'bg-white border-slate-200 hover:bg-slate-100'}" onclick="GestionnaireModule.updateNotificationFilter('period', '${option.key}')">${option.label}</button>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="flex flex-wrap items-center gap-2">
                                ${severityOptions.map(option => {
                                    const meta = option.key !== 'all' ? NotificationUtils.getSeverityMeta(option.key) : null;
                                    const isActive = filters.severity === option.key;
                                    const base = option.key === 'all' ? option.chip : meta?.chip;
                                    return `<button class="px-3 py-1.5 rounded-full text-[11px] font-black border ${isActive ? (option.key === 'all' ? 'border-slate-900 bg-slate-900 text-white' : 'border-transparent ' + base) : 'border-slate-200 bg-white text-slate-600'}" onclick=\"GestionnaireModule.updateNotificationFilter('severity','${option.key}')\">${option.label} (${counts[option.key] ?? 0})</button>`;
                                }).join('')}
                                <button class="px-3 py-1.5 rounded-full text-[11px] font-black border ${filters.showUnread ? 'bg-amber-500 border-transparent text-white' : 'bg-white border-slate-200 text-slate-600'}" onclick="GestionnaireModule.toggleUnreadFilter()">${filters.showUnread ? 'Non lues uniquement' : 'Inclure non lues'}</button>
                            </div>

                            ${typeOptions.length > 0 ? `
                                <div>
                                    <label class="text-[11px] uppercase font-black text-slate-500 tracking-wide mb-1 block">Type</label>
                                    <select class="w-full md:w-auto px-3 py-2 border border-slate-200 rounded-lg text-sm font-black bg-white" onchange="GestionnaireModule.updateNotificationFilter('type', this.value)">
                                        <option value="all" ${filters.type === 'all' ? 'selected' : ''}>Tous les types</option>
                                        ${typeOptions.map(type => `<option value="${NotificationUtils.escape(type)}" ${filters.type.toLowerCase() === type.toLowerCase() ? 'selected' : ''}>${NotificationUtils.escape(NotificationUtils.getTypeLabel(type))}</option>`).join('')}
                                    </select>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    ${filtered.length === 0 ? `
                        <div class="p-10 text-center border border-dashed border-slate-200 rounded-2xl bg-white">
                            <div class="text-4xl mb-2">��Ÿ�Š�� � �</div>
                            <div class="font-black text-slate-700">Aucun r�sultat</div>
                            <div class="text-xs text-slate-500 mt-1">Ajustez vos filtres ou �largissez la p�riode.</div>
                        </div>
                    ` : `
                        <div class="space-y-6">
                            ${grouped.map(group => `
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between text-xs font-black text-slate-500 uppercase tracking-wide">
                                        <span>${group.label}</span>
                                        <span>${group.items.length} notification${group.items.length > 1 ? 's' : ''}</span>
                                    </div>
                                    <div class="space-y-3">
                                        ${group.items.map(item => {
                                            const meta = NotificationUtils.getSeverityMeta(item.severity);
                                            const ts = NotificationUtils.getTimestamp(item);
                                            const relative = NotificationUtils.formatRelative(ts);
                                            const readClass = item.read ? 'opacity-80' : 'ring-2 ring-offset-2 ring-slate-300';
                                            return `
                                                <div class="p-4 rounded-2xl transition ${meta.panel} ${readClass}">
                                                    <div class="flex flex-col gap-3">
                                                        <div class="flex items-start gap-3">
                                                            <span class="w-2 h-2 mt-1 rounded-full ${meta.dot}"></span>
                                                            <div class="flex-1">
                                                                <div class="flex flex-wrap items-start gap-2 justify-between">
                                                                    <div>
                                                                        <div class="text-sm font-black text-slate-900">${NotificationUtils.escape(item.title)}</div>
                                                                        ${item.message ? `<div class="text-xs text-slate-600 mt-1">${NotificationUtils.escape(item.message)}</div>` : ''}
                                                                    </div>
                                                                    <button class="text-[10px] font-black px-2 py-1 rounded-full border border-transparent ${item.read ? 'bg-white text-slate-500 border-slate-200' : 'bg-slate-900 text-white'}" onclick="GestionnaireModule.toggleNotificationRead(${item.id})">${item.read ? 'Marquer non lu' : 'Marquer lu'}</button>
                                                                </div>
                                                                <div class="flex flex-wrap items-center gap-2 mt-3 text-[10px] font-black text-slate-500">
                                                                    <span class="px-2 py-1 rounded-full ${meta.badge}">${meta.label}</span>
                                                                    <span class="px-2 py-1 rounded-full bg-slate-200 text-slate-700">${NotificationUtils.escape(NotificationUtils.getTypeLabel(item.type))}</span>
                                                                    <span>${relative}</span>
                                                                    ${ts ? `<span class="text-slate-400">${CORE.formatDate(ts)}</span>` : ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        },

        showNotificationHistory() {
            UI.modal('��Ÿ?� Historique des notifications', this.renderNotificationHistoryContent(), [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showAddShiftModal() {
            const posId = CORE.state.currentUser?.pos;
            const vendeurs = CORE.db.users.filter(u => u.role === 'vendeur' && u.pos === posId);
            const livreurs = CORE.getLivreursForPOS(posId);
            const allUsers = [...vendeurs, ...livreurs];
            const templates = CORE.db.shiftTemplates.filter(t => t.posId === posId);
            const userOptions = allUsers.map(u => ({ value: u.id, label: u.name }));
            const templateOptions = templates.map(t => ({ value: t.id, label: `${t.name} (${t.startTime}-${t.endTime})` }));

            UI.modal('Ajouter un Shift', `
                <div class="space-y-4">
                    ${UI.select('shift_user','Personne', userOptions, '', true)}
                    ${UI.input('shift_date','Date','date', new Date().toISOString().split('T')[0], '', true)}
                    
                    <!-- Section Cr�neau -->
                    <div class="border-t border-slate-200 pt-4 space-y-3">
                        <div class="font-black text-slate-900">��Ÿ� � Cr�neau Horaire:</div>
                        
                        <!-- Option 1: Template pr�d�fini -->
                        <div class="space-y-2">
                            <label class="flex items-center gap-2">
                                <input type="radio" id="shift_mode_template" name="shift_mode" value="template" ${templateOptions.length > 0 ? 'checked' : 'disabled'} class="w-4 h-4">
                                <span class="text-sm font-bold text-slate-700">Utiliser un template</span>
                            </label>
                            ${templateOptions.length > 0 ? `
                                <select id="shift_template" class="w-full px-3 py-2.5 rounded-lg border border-slate-200 font-bold text-sm">
                                    <option value="">-- S�lectionner un template --</option>
                                    ${templateOptions.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                                </select>
                            ` : `
                                <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-xs text-amber-800">
                                    Aucun template disponible. Utilisez la saisie manuelle.
                                </div>
                            `}
                        </div>
                        
                        <!-- Option 2: Saisie manuelle -->
                        <div class="space-y-2">
                            <label class="flex items-center gap-2">
                                <input type="radio" id="shift_mode_manual" name="shift_mode" value="manual" class="w-4 h-4">
                                <span class="text-sm font-bold text-slate-700">Saisir manuellement</span>
                            </label>
                            <div class="grid grid-cols-2 gap-3 opacity-50 transition" id="shift_manual_inputs">
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-slate-600">Heure de d�but</label>
                                    <input type="time" id="shift_start_time" class="w-full px-3 py-2 rounded-lg border border-slate-200 font-bold" value="08:00" disabled>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-slate-600">Heure de fin</label>
                                    <input type="time" id="shift_end_time" class="w-full px-3 py-2 rounded-lg border border-slate-200 font-bold" value="18:00" disabled>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${UI.textarea('shift_notes','Notes', '', 'notes optionnelles')}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Ajouter', onclick: 'GestionnaireModule.saveShift()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
            
            // Ajouter les event listeners pour les radio buttons
            setTimeout(() => {
                const templateRadio = document.getElementById('shift_mode_template');
                const manualRadio = document.getElementById('shift_mode_manual');
                const templateSelect = document.getElementById('shift_template');
                const manualInputs = document.getElementById('shift_manual_inputs');
                const startTimeInput = document.getElementById('shift_start_time');
                const endTimeInput = document.getElementById('shift_end_time');
                
                if (templateRadio) {
                    templateRadio.addEventListener('change', () => {
                        if (templateRadio.checked) {
                            if (templateSelect) templateSelect.disabled = false;
                            startTimeInput.disabled = true;
                            endTimeInput.disabled = true;
                            manualInputs.classList.add('opacity-50');
                            if (templateSelect) templateSelect.parentElement.classList.remove('opacity-50');
                        }
                    });
                }
                
                if (manualRadio) {
                    manualRadio.addEventListener('change', () => {
                        if (manualRadio.checked) {
                            if (templateSelect) templateSelect.disabled = true;
                            startTimeInput.disabled = false;
                            endTimeInput.disabled = false;
                            manualInputs.classList.remove('opacity-50');
                            if (templateSelect) templateSelect.parentElement.classList.add('opacity-50');
                        }
                    });
                }
                
                // Initialiser l'�tat
                if (templateOptions.length > 0 && templateRadio) {
                    templateRadio.checked = true;
                    if (templateSelect) templateSelect.disabled = false;
                    startTimeInput.disabled = true;
                    endTimeInput.disabled = true;
                } else if (manualRadio) {
                    manualRadio.checked = true;
                    if (templateSelect) templateSelect.disabled = true;
                    startTimeInput.disabled = false;
                    endTimeInput.disabled = false;
                    manualInputs.classList.remove('opacity-50');
                }
                
                lucide.createIcons();
            }, 50);
        },

        saveShift() {
            const userId = parseInt(UI.val('shift_user') || '0', 10);
            const date = UI.val('shift_date');
            const notes = UI.val('shift_notes') || '';
            if (!userId || !date) return UI.toast('Champs requis', 'warning');
            
            const shiftMode = document.querySelector('input[name="shift_mode"]:checked')?.value;
            let templateId = null;
            let startTime = null;
            let endTime = null;
            
            if (shiftMode === 'template') {
                templateId = parseInt(UI.val('shift_template') || '0', 10);
                if (!templateId) return UI.toast('S�lectionnez un template', 'warning');
            } else if (shiftMode === 'manual') {
                startTime = document.getElementById('shift_start_time')?.value;
                endTime = document.getElementById('shift_end_time')?.value;
                if (!startTime || !endTime) return UI.toast('Saisissez les heures', 'warning');
                if (startTime >= endTime) return UI.toast('L\'heure de fin doit ��tre apr��s le d�but', 'warning');
            } else {
                return UI.toast('S�lectionnez un mode de cr�neau', 'warning');
            }
            
            const posId = CORE.state.currentUser?.pos;
            const shift = CORE.create('shifts', {
                templateId: templateId || null,
                manualStartTime: startTime,
                manualEndTime: endTime,
                userId,
                date,
                posId,
                status: 'scheduled',
                notes
            });
            UI.closeModal();
            UI.toast('Shift ajout�', 'success');
            App.rerender();
        },

        showTimeOffModal() {
            const posId = CORE.state.currentUser?.pos;
            const vendeurs = CORE.db.users.filter(u => u.role === 'vendeur' && u.pos === posId);
            const livreurs = CORE.getLivreursForPOS(posId);
            const allUsers = [...vendeurs, ...livreurs];
            const userOptions = allUsers.map(u => ({ value: u.id, label: u.name }));

            UI.modal('Demander un Cong�/Absence', `
                <div class="space-y-4">
                    ${UI.select('timeoff_user','Personne', userOptions, '', true)}
                    ${UI.select('timeoff_type','Type', [
                        {value:'cong�',label:'Cong�'},
                        {value:'maladie',label:'Maladie'},
                        {value:'autre',label:'Autre'}
                    ], 'cong�', true)}
                    ${UI.input('timeoff_start','Date d�but','date', new Date().toISOString().split('T')[0], '', true)}
                    ${UI.input('timeoff_end','Date fin','date', new Date().toISOString().split('T')[0], '', true)}
                    ${UI.textarea('timeoff_reason','Raison', '', 'facultatif')}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'GestionnaireModule.saveTimeOff()', class: 'px-5 py-2.5 bg-amber-600 text-white font-black rounded-xl hover:bg-amber-700 transition' }
            ]);
        },

        saveTimeOff() {
            const userId = parseInt(UI.val('timeoff_user') || '0', 10);
            const type = UI.val('timeoff_type');
            const startDate = UI.val('timeoff_start');
            const endDate = UI.val('timeoff_end');
            const reason = UI.val('timeoff_reason') || '';
            if (!userId || !startDate || !endDate) return UI.toast('Champs requis', 'warning');
            
            if (new Date(endDate) < new Date(startDate)) return UI.toast('Date fin avant date d�but', 'error');

            const timeOff = CORE.create('timeOff', {
                userId,
                type,
                startDate,
                endDate,
                reason,
                status: 'approved'
            });
            UI.closeModal();
            UI.toast('Absence enregistr�e', 'success');
            App.rerender();
        },

        quickReplacement(slotName, posId, date) {
            const vendeurs = CORE.db.users.filter(u => u.role === 'vendeur' && u.pos === posId && u.active);
            const livreurs = CORE.getLivreursForPOS(posId);
            const allUsers = [...vendeurs, ...livreurs];
            const userOptions = allUsers.map(u => ({ value: u.id, label: u.name }));

            UI.modal(`Remplacement Rapide - ${slotName}`, `
                <div class="space-y-4">
                    <p class="text-sm text-slate-600">S�lectionnez une personne pour couvrir le cr�neau <b>${slotName}</b> du <b>${new Date(date).toLocaleDateString('fr-FR')}</b>.</p>
                    ${UI.select('repl_user','Personne disponible', userOptions, '', true)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Assigner', onclick: `GestionnaireModule.assignQuickReplacement('${slotName}', ${posId}, '${date}')`, class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        assignQuickReplacement(slotName, posId, date) {
            const userId = parseInt(UI.val('repl_user') || '0', 10);
            if (!userId) return UI.toast('S�lectionnez une personne', 'warning');

            const template = CORE.db.shiftTemplates.find(t => t.name === slotName && t.posId === posId);
            if (!template) return UI.toast('Cr�neau non trouv�', 'error');

            const shift = CORE.create('shifts', {
                templateId: template.id,
                userId,
                date,
                posId,
                status: 'confirmed',
                notes: `Remplacement rapide - ${slotName}`
            });

            UI.closeModal();
            const user = CORE.getUser(userId);
            UI.toast(`${user.name} assign� au cr�neau ${slotName}`, 'success');
            App.rerender();
        },

        quickRestockModal() {
            const options = CORE.db.products.filter(p => !p.isMainWarehouse).map(p => ({ value: p.id, label: `${p.name} (stock: ${p.stock})` }));
            UI.modal('Ajustement stock', `
                <div class="space-y-4">
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-xl text-xs text-blue-700">
                        <strong>��Ÿ? � Astuce:</strong> Pour des ajustements en masse, utilisez <button class="text-blue-600 font-bold hover:underline" onclick="UI.closeModal(); GestionnaireModule.showImportMovementsModal()">l'import CSV</button>
                    </div>
                    ${UI.select('mov_product','Produit',options,'',true)}
                    ${UI.input('mov_qty','Quantit�','number','1','ex: 10',true)}
                    ${UI.select('mov_type','Type',[{value:'in',label:'Entr�e (r�appro)'},{value:'out',label:'Sortie'},{value:'adjust',label:'Ajustement'}],'in',true)}
                    ${UI.textarea('mov_note','Note','','facultatif')}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'GestionnaireModule.applyStockMovement()', class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        quickAdjustStock(productId) {
            const p = CORE.getProduct(productId);
            if (!p) return;
            UI.modal(`Ajuster: ${p.name}`, `
                <div class="space-y-4">
                    ${UI.input('adj_qty','Quantit� (+/-)','number','1','ex: 10',true)}
                    ${UI.select('adj_dir','Sens',[{value:'in',label:'Ajouter'},{value:'out',label:'Retirer'}],'in',true)}
                    ${UI.textarea('adj_note','Note','','facultatif')}
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">
                        Stock actuel: <b>${p.stock}</b> �� ?� � Min: <b>${p.minStock}</b>
                    </div>
                    <div id="adj_preview" class="p-4 bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-200 rounded-xl hidden">
                        <div class="font-black text-amber-900 mb-3">���?? Aper��u de l'ajustement:</div>
                        <div id="adj_preview_text" class="p-3 bg-white rounded border border-amber-200">
                            <div class="font-black text-lg text-slate-900">${p.stock} <span class="text-amber-500 mx-1">���?</span> ${p.stock}</div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Appliquer', onclick: `GestionnaireModule.applyQuickAdjust(${p.id})`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
            
            // Ajouter event listeners pour aper��u en temps r�el
            setTimeout(() => {
                const updatePreview = () => {
                    const dir = UI.val('adj_dir') || 'in';
                    const qty = Math.abs(parseInt(UI.val('adj_qty') || '0', 10));
                    const preview = document.getElementById('adj_preview');
                    const previewText = document.getElementById('adj_preview_text');
                    
                    if (qty > 0) {
                        const newStock = dir === 'out' ? Math.max(0, p.stock - qty) : p.stock + qty;
                        preview.classList.remove('hidden');
                        previewText.innerHTML = `<div class="font-black text-lg text-slate-900">${p.stock} <span class="text-amber-500 mx-1">���?</span> ${newStock}</div>`;
                    } else {
                        preview.classList.add('hidden');
                    }
                };
                
                ['adj_qty', 'adj_dir'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('change', updatePreview);
                        el.addEventListener('input', updatePreview);
                    }
                });
            }, 100);
        },

        applyQuickAdjust(productId) {
            const dir = UI.val('adj_dir');
            const qty = Math.abs(parseInt(UI.val('adj_qty') || '0', 10));
            const note = UI.val('adj_note');
            if (!qty) return UI.toast('Quantit� invalide', 'warning');
            const p = CORE.getProduct(productId);
            if (!p) return;

            const next = dir === 'out' ? p.stock - qty : p.stock + qty;
            if (next < 0) return UI.toast('Stock ne peut pas ��tre n�gatif', 'error');
            CORE.update('products', p.id, { stock: next });
            CORE.recordStockMovement({ productId: p.id, type: dir === 'out' ? 'out' : 'in', qty, note: note || 'Ajustement rapide' });
            UI.closeModal();
            UI.toast('Stock mis �� jour', 'success');
            App.rerender();
        },

        showManageVariantsModal(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return;

            const variants = CORE.getProductVariants(productId);
            const attributeTypes = CORE.db.productAttributeTypes || [];

            const variantHTML = variants.length === 0 
                ? '<div class="p-8 text-center text-slate-400 font-medium">Aucune variante encore</div>'
                : `<div class="space-y-2 max-h-80 overflow-y-auto">
                    ${variants.map(v => {
                        const status = CORE.getVariantStockStatus(v);
                        return `
                            <div class="p-3 bg-slate-50 rounded-xl border border-slate-100 hover:bg-slate-100 transition group">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="text-xs text-slate-500 mt-1">
                                            SKU: <code class="bg-slate-200 px-1 rounded">${v.sku}</code> �� ?� � 
                                            Prix: ${CORE.formatPrice(v.price)} �� ?� � 
                                            Stock: <span class="font-bold text-${status.color}-600">${v.stock}</span>
                                        </div>
                                    </div>
                                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                                        <button onclick="GestionnaireModule.editVariantModal('${productId}', '${v.id}')" class="px-2 py-1 bg-blue-600 text-white text-xs font-black rounded">�diter</button>
                                        <button onclick="GestionnaireModule.deleteVariant('${productId}', '${v.id}')" class="px-2 py-1 bg-red-600 text-white text-xs font-black rounded">Supprimer</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>`;

            UI.modal(`��Ÿ? � Variantes: ${product.name}`, `
                <div class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 p-3 rounded-xl text-xs text-blue-700 font-bold">
                        ${variants.length} variante(s) existante(s)
                    </div>
                    ${variantHTML}
                    <button onclick="GestionnaireModule.addVariantModal('${productId}')" class="w-full py-2 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition">
                        ��ž� Ajouter variante
                    </button>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        addVariantModal(productId) {
            const product = CORE.getProduct(productId);
            const attributeTypes = CORE.db.productAttributeTypes || [];

            window.variantAttrsCount = 3; // Start with 3 default fields

            UI.modal(`��ž� Nouvelle variante: ${product.name}`, `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">SKU (r�f. variante)</label>
                        <input id="var_sku" type="text" placeholder="Ex: PROD-001-BLU-S" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Attributs</label>
                        <div id="variant-attrs-container" class="space-y-3">
                            ${attributeTypes.slice(0, 3).map((attr, idx) => `
                                <div class="flex gap-2 items-end">
                                    <div class="flex-1">
                                        <input id="var_attr_name_${idx}" type="text" placeholder="Nom attribut" value="${attr.label}" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                                    </div>
                                    <div class="flex-1">
                                        <input id="var_attr_${idx}" type="text" placeholder="Valeur" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                                    </div>
                                    <button onclick="document.getElementById('var_attr_row_${idx}').remove()" class="px-2 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200 text-xs font-black">���?�</button>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="GestionnaireModule.addAttributeField()" class="mt-3 w-full py-2 px-3 bg-blue-100 text-blue-700 rounded-xl font-black text-xs hover:bg-blue-200 transition">
                            + Ajouter un attribut
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Prix</label>
                            <input id="var_price" type="number" value="${Math.max(0, parseFloat(product.price) || 0)}" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Stock</label>
                            <input id="var_stock" type="number" value="0" min="0" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                        </div>
                    </div>
                    <textarea id="var_notes" placeholder="Notes sp�ciales..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm" rows="2"></textarea>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Cr�er', onclick: `GestionnaireModule.createVariant('${productId}')`, class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        addAttributeField() {
            const idx = window.variantAttrsCount++;
            const container = document.getElementById('variant-attrs-container');
            if (!container) return;
            
            const div = document.createElement('div');
            div.id = `var_attr_row_${idx}`;
            div.className = 'flex gap-2 items-end';
            div.innerHTML = `
                <div class="flex-1">
                    <input id="var_attr_name_${idx}" type="text" placeholder="Nom attribut" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                </div>
                <div class="flex-1">
                    <input id="var_attr_${idx}" type="text" placeholder="Valeur" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                </div>
                <button onclick="document.getElementById('var_attr_row_${idx}').remove()" class="px-2 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200 text-xs font-black">���?�</button>
            `;
            container.appendChild(div);
        },

        createVariant(productId) {
            const sku = UI.val('var_sku');
            const price = parseInt(UI.val('var_price') || '0');
            const stock = parseInt(UI.val('var_stock') || '0');
            const notes = UI.val('var_notes');

            if (!sku || !price) {
                return UI.toast('SKU et Prix obligatoires', 'warning');
            }

            // R�cup�rer les attributs remplis dynamiquement
            const attributes = [];
            for (let i = 0; i < window.variantAttrsCount; i++) {
                const nameInput = document.getElementById(`var_attr_name_${i}`);
                const valueInput = document.getElementById(`var_attr_${i}`);
                
                if (nameInput && valueInput) {
                    const name = nameInput.value?.trim();
                    const value = valueInput.value?.trim();
                    
                    if (name && value) {
                        attributes.push({ name: name, value: value });
                    }
                }
            }

            if (attributes.length === 0) {
                return UI.toast('Au moins un attribut est obligatoire', 'warning');
            }

            CORE.createProductVariant(productId, attributes, sku, price, stock);
            UI.closeModal();
            UI.toast('Variante cr��e', 'success');
            App.rerender();
        },

        editVariantModal(productId, variantId) {
            const variant = CORE.db.productVariants.find(v => v.id === variantId);
            if (!variant) return;

            UI.modal(`���? ��� � � �diter variante`, `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">SKU</label>
                        <input id="edit_var_sku" type="text" value="${variant.sku}" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Prix</label>
                            <input id="edit_var_price" type="number" value="${Math.max(0, parseFloat(variant.price) || 0)}" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Stock</label>
                            <input id="edit_var_stock" type="number" value="${Math.max(0, parseInt(variant.stock) || 0)}" min="0" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                        </div>
                    </div>
                    <div class="p-3 bg-slate-50 rounded-xl border border-slate-100 text-sm">
                        <div class="font-black text-slate-900 mb-2">Attributs actuels:</div>
                    </div>
                    <textarea id="edit_var_notes" placeholder="Notes..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm" rows="2">${variant.notes || ''}</textarea>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Sauvegarder', onclick: `GestionnaireModule.saveVariantEdit('${variantId}')`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        saveVariantEdit(variantId) {
            const sku = UI.val('edit_var_sku');
            const price = parseInt(UI.val('edit_var_price') || '0');
            const stock = parseInt(UI.val('edit_var_stock') || '0');
            const notes = UI.val('edit_var_notes');

            CORE.updateProductVariant(variantId, { sku, price, stock, notes });
            UI.closeModal();
            UI.toast('Variante mise �� jour', 'success');
            App.rerender();
        },

        deleteVariant(productId, variantId) {
            if (!confirm('Supprimer cette variante?')) return;
            CORE.deleteProductVariant(variantId);
            UI.toast('Variante supprim�e', 'success');
            App.rerender();
        },

        showImageManagementModal(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return;

            const images = CORE.getProductImages(productId);

            UI.modal(`��Ÿ? � Galerie: ${product.name}`, `
                <div class="space-y-4 max-h-[600px] overflow-y-auto">
                    <div class="p-4 bg-blue-50 border-2 border-dashed border-blue-300 rounded-2xl text-center cursor-pointer hover:bg-blue-100 transition" onclick="GestionnaireModule.showImageUploadModal(${productId})">
                        <div><i data-lucide="upload-cloud" class="w-8 h-8 text-blue-600 mx-auto mb-2"></i></div>
                        <div class="font-black text-blue-900 text-sm">Ajouter des images</div>
                        <div class="text-xs text-blue-700">Cliquez ou glissez-d�posez</div>
                    </div>

                    ${images.length > 0 ? `
                        <div class="grid grid-cols-3 gap-3">
                            ${images.map(img => `
                                <div class="relative group border border-slate-200 rounded-xl overflow-hidden hover:border-blue-400 transition">
                                    <img src="${img.url}" alt="${img.alt || 'Produit'}" class="w-full h-32 object-cover">
                                    ${img.isPrimary ? '<div class="absolute top-2 left-2 px-2 py-1 bg-emerald-500 text-white text-xs font-black rounded">Principale</div>' : ''}
                                    <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-2">
                                        ${!img.isPrimary ? `<button onclick="CORE.setPrimaryImage('${img.id}'); GestionnaireModule.showImageManagementModal(${productId})" class="p-2 bg-emerald-600 text-white rounded hover:bg-emerald-700" title="D�finir comme principale"><i data-lucide="star" class="w-4 h-4"></i></button>` : ''}
                                        <button onclick="GestionnaireModule.showImageEditModal(${productId}, '${img.id}')" class="p-2 bg-blue-600 text-white rounded hover:bg-blue-700" title="�diter"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                        <button onclick="GestionnaireModule.deleteImage('${img.id}', ${productId})" class="p-2 bg-red-600 text-white rounded hover:bg-red-700" title="Supprimer"><i data-lucide="trash" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="text-xs text-slate-500 text-center pt-2">${images.length} image(s)</div>
                    ` : `
                        <div class="p-8 text-center text-slate-500">
                            <i data-lucide="image-off" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                            <div class="text-sm">Aucune image pour ce produit</div>
                        </div>
                    `}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showImageUploadModal(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return;

            UI.modal(`�� ���� � � T�l�charger image: ${product.name}`, `
                <div class="space-y-4">
                    <div id="upload_preview" class="hidden">
                        <img id="img_preview" class="w-full h-64 object-contain rounded-xl border border-slate-200 mb-3">
                    </div>

                    <div class="p-6 bg-slate-50 border-2 border-dashed border-slate-300 rounded-2xl text-center cursor-pointer hover:bg-slate-100 transition" 
                         ondrop="event.preventDefault(); GestionnaireModule.handleImageDrop(event, ${productId})" 
                         ondragover="event.preventDefault(); event.currentTarget.classList.add('bg-blue-50', 'border-blue-400')"
                         ondragleave="event.currentTarget.classList.remove('bg-blue-50', 'border-blue-400')">
                        <input id="file_input" type="file" accept="image/*" style="display:none" onchange="GestionnaireModule.handleImageSelect(event, ${productId})">
                        <button onclick="document.getElementById('file_input').click()" type="button" class="w-full">
                            <i data-lucide="image" class="w-12 h-12 text-slate-400 mx-auto mb-2"></i>
                            <div class="font-bold text-slate-900">S�lectionner image</div>
                            <div class="text-xs text-slate-500">PNG, JPG, WebP (Max 5MB)</div>
                        </button>
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Texte alternatif (alt)</label>
                        <input id="img_alt" type="text" placeholder="D�crire l'image..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Tags (optionnel)</label>
                        <input id="img_tags" type="text" placeholder="Ex: Face avant, D�tail, Couleur..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'T�l�charger', onclick: `GestionnaireModule.saveProductImage(${productId})`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        handleImageSelect(event, productId) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                UI.toast('Fichier trop volumineux (max 5MB)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('upload_preview');
                const previewImg = document.getElementById('img_preview');
                if (preview && previewImg) {
                    previewImg.src = e.target.result;
                    preview.classList.remove('hidden');
                    GestionnaireModule.currentImageData = { base64: e.target.result, filename: file.name };
                }
            };
            reader.readAsDataURL(file);
        },

        handleImageDrop(event, productId) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('file_input').files = files;
                GestionnaireModule.handleImageSelect({ target: { files: files } }, productId);
            }
        },

        saveProductImage(productId) {
            if (!GestionnaireModule.currentImageData) {
                UI.toast('S�lectionnez une image', 'error');
                return;
            }

            const alt = UI.val('img_alt') || '';
            const tagsStr = UI.val('img_tags') || '';
            const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()) : [];

            const image = CORE.uploadProductImage(
                productId,
                GestionnaireModule.currentImageData.base64,
                GestionnaireModule.currentImageData.filename,
                alt
            );

            if (image) {
                CORE.updateImageMetadata(image.id, alt, tags);
                GestionnaireModule.currentImageData = null;
                UI.toast('Image t�l�charg�e', 'success');
                UI.closeModal();
                GestionnaireModule.showImageManagementModal(productId);
            }
        },






        showImageEditModal(productId, imageId) {
            const image = CORE.db.productImages.find(img => img.id === imageId);
            if (!image) return;

            UI.modal(`���? ��� � � �diter image`, `
                <div class="space-y-4">
                    <img src="${image.url}" alt="${image.alt}" class="w-full h-48 object-contain rounded-xl border border-slate-200">
                    
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Texte alternatif</label>
                        <input id="edit_img_alt" type="text" value="${image.alt || ''}" placeholder="D�crire l'image..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Tags</label>
                        <input id="edit_img_tags" type="text" value="${image.tags ? image.tags.join(', ') : ''}" placeholder="Ex: Face avant, D�tail..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                    </div>

                    <div class="p-3 bg-slate-50 rounded-xl border border-slate-100 text-xs text-slate-600">
                        <div class="font-black mb-1">Informations:</div>
                        <div>��Ÿ?� ${CORE.formatDate(image.uploadedAt)}</div>
                        <div>��Ÿ? � ${image.uploadedByName || 'Unknown'}</div>
                        <div>��Ÿ? � ${Math.round(image.filesize / 1024)}KB</div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: `GestionnaireModule.updateImageMetadata('${imageId}', ${productId})`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        updateImageMetadata(imageId, productId) {
            const alt = UI.val('edit_img_alt') || '';
            const tagsStr = UI.val('edit_img_tags') || '';
            const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()) : [];

            if (CORE.updateImageMetadata(imageId, alt, tags)) {
                UI.toast('Image mise �� jour', 'success');
                UI.closeModal();
                GestionnaireModule.showImageManagementModal(productId);
            }
        },

        deleteImage(imageId, productId) {
            if (!confirm('Supprimer cette image?')) return;
            if (CORE.deleteProductImage(imageId)) {
                UI.toast('Image supprim�e', 'success');
                GestionnaireModule.showImageManagementModal(productId);
            }
        },

        currentImageData: null,

        showSettingsModal() {
            const currentLang = I18n.current || 'fr';
            const languages = [
                { code: 'fr', flag: '��Ÿ� ���Ÿ� �' },
                { code: 'en', flag: '��Ÿ� ���Ÿ� �' },
                { code: 'es', flag: '��Ÿ� ���Ÿ� �' },
                { code: 'pt', flag: '��Ÿ� ���Ÿ� �' },
                { code: 'de', flag: '��Ÿ� ���Ÿ� �' },
                { code: 'it', flag: '��Ÿ� ���Ÿ� �' },
                { code: 'ar', flag: '��Ÿ� ���Ÿ� �' },
                { code: 'zh', flag: '��Ÿ� ���Ÿ� �' },
                { code: 'ru', flag: '��Ÿ� ���Ÿ� �' }
            ];
            
            UI.modal('��š ?��� � � Param��tres Gestionnaire', `
                <div class="space-y-4">
                    <!-- Section Langue -->
                    <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-2xl">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
                                <i data-lucide="globe" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-slate-900">${t('settings.language')}</div>
                                <div class="text-xs text-slate-500">Interface multilingue</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-9 gap-1">
                            ${languages.map(lang => `
                                <button onclick="GestionnaireModule.setLanguage('${lang.code}')" class="p-2 rounded-lg border-2 transition-all text-xl hover:scale-110 ${currentLang === lang.code ? 'border-blue-500 bg-blue-100 shadow-lg scale-110' : 'border-slate-200 hover:border-slate-300 bg-white'}">
                                    ${lang.flag}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="p-4 bg-cyan-50 border border-cyan-200 rounded-2xl flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center border border-cyan-200"><i data-lucide="bell" class="w-5 h-5 ${this.state.notificationsEnabled ? 'text-cyan-600' : 'text-slate-400'}"></i></div>
                            <div>
                                <div class="font-black text-cyan-900">Notifications</div>
                                <div class="text-xs text-cyan-700">${this.state.notificationsEnabled ? 'Activ�es' : 'D�sactiv�es'}</div>
                            </div>
                        </div>
                        <button onclick="GestionnaireModule.toggleNotifications()" class="text-xs font-black ${this.state.notificationsEnabled ? 'text-cyan-600' : 'text-slate-400'}">${this.state.notificationsEnabled ? 'D�sactiver' : 'Activer'}</button>
                    </div>

                    <div class="h-px bg-slate-200 my-2"></div>

                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl flex items-center justify-between cursor-pointer hover:bg-amber-100 transition" onclick="UI.closeModal(); GestionnaireModule.showThemeModal()">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center border border-amber-200"><i data-lucide="palette" class="w-5 h-5 text-amber-600"></i></div>
                            <div>
                                <div class="font-black text-slate-900">Th��me</div>
                                <div class="text-xs text-slate-500">Choisissez votre th��me pr�f�r�</div>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
                    </div>

                    <div class="p-4 bg-purple-50 border border-purple-200 rounded-2xl flex items-center justify-between cursor-pointer hover:bg-purple-100 transition" onclick="UI.closeModal(); GestionnaireModule.showSlaConfigModal()">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center border border-purple-200"><i data-lucide="activity" class="w-5 h-5 text-purple-600"></i></div>
                            <div>
                                <div class="font-black text-slate-900">SLA & KPIs</div>
                                <div class="text-xs text-slate-500">Configurer les seuils d'alerte</div>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
                    </div>

                    <div class="h-px bg-slate-200 my-2"></div>

                    <button onclick="GestionnaireModule.showChangePersonalPasswordModal()" class="w-full p-3 rounded-2xl bg-sky-50 border border-sky-200 hover:bg-sky-100 transition flex items-center gap-3">
                        <i data-lucide="key" class="w-5 h-5 text-sky-600"></i>
                        <div class="text-left flex-1">
                            <div class="text-xs font-black text-sky-700">Changer votre mot de passe</div>
                            <div class="text-[10px] text-sky-600">Modifiez votre mot de passe personnel</div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-sky-400"></i>
                    </button>

                    <div class="h-px bg-slate-200 my-2"></div>

                    <button onclick="App.logout()" class="w-full py-3 bg-red-50 text-red-600 font-black rounded-xl hover:bg-red-100 transition flex items-center justify-center gap-2">
                        <i data-lucide="log-out" class="w-4 h-4"></i> D�connexion
                    </button>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            
            setTimeout(() => lucide?.createIcons?.(), 50);
        },
        
        setLanguage(code) {
            const userId = CORE.state.currentUser?.id;
            CORE.setUserLanguage(userId, code);
            I18n.setLanguage(code);
            UI.closeModal();
            UI.toast(`���?? Langue: ${code.toUpperCase()}`, 'success');
            App.rerender();
        },

        showThemeModal() {
            UI.modal('��ŸŽ � Th��me', `
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="GestionnaireModule.setTheme('light'); UI.closeModal()" class="p-4 rounded-xl border-2 transition flex flex-col items-center justify-center gap-2 ${this.state.theme === 'light' ? 'border-amber-500 bg-amber-50' : 'border-slate-200 hover:border-slate-300'}">
                            <i data-lucide="sun" class="w-6 h-6 ${this.state.theme === 'light' ? 'text-amber-600' : 'text-slate-400'}"></i>
                            <span class="text-xs font-black ${this.state.theme === 'light' ? 'text-amber-700' : 'text-slate-600'}">Clair</span>
                        </button>
                        <button onclick="GestionnaireModule.setTheme('dark'); UI.closeModal()" class="p-4 rounded-xl border-2 transition flex flex-col items-center justify-center gap-2 ${this.state.theme === 'dark' ? 'border-amber-500 bg-amber-50' : 'border-slate-200 hover:border-slate-300'}">
                            <i data-lucide="moon" class="w-6 h-6 ${this.state.theme === 'dark' ? 'text-amber-600' : 'text-slate-400'}"></i>
                            <span class="text-xs font-black ${this.state.theme === 'dark' ? 'text-amber-700' : 'text-slate-600'}">Sombre</span>
                        </button>
                        <button onclick="GestionnaireModule.setTheme('auto'); UI.closeModal()" class="p-4 rounded-xl border-2 transition flex flex-col items-center justify-center gap-2 ${this.state.theme === 'auto' ? 'border-amber-500 bg-amber-50' : 'border-slate-200 hover:border-slate-300'}">
                            <i data-lucide="monitor" class="w-6 h-6 ${this.state.theme === 'auto' ? 'text-amber-600' : 'text-slate-400'}"></i>
                            <span class="text-xs font-black ${this.state.theme === 'auto' ? 'text-amber-700' : 'text-slate-600'}">Auto</span>
                        </button>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showSlaConfigModal() {
            UI.modal('��š � SLA & KPIs', `
                <div class="space-y-4 max-h-[500px] overflow-y-auto">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Taux dans les d�lais min (%)</label>
                            <input id="sla_onTime" type="number" min="0" max="100" value="${this.state.slaThresholds.minOnTimeRate}" class="w-full px-3 py-2 bg-white border border-slate-200 rounded-xl text-sm font-medium" />
                        </div>
                        <div>
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Commandes en attente max</label>
                            <input id="sla_pending" type="number" min="0" value="${this.state.slaThresholds.maxPendingOrders}" class="w-full px-3 py-2 bg-white border border-slate-200 rounded-xl text-sm font-medium" />
                        </div>
                        <div>
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">D�p��ts journaliers min (FCFA)</label>
                            <input id="sla_deposits" type="number" min="0" value="${this.state.slaThresholds.minDailyDeposits}" class="w-full px-3 py-2 bg-white border border-slate-200 rounded-xl text-sm font-medium" />
                        </div>
                        <div>
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">D�lai livraison max (min)</label>
                            <input id="sla_minutes" type="number" min="1" value="${this.state.slaThresholds.maxDeliveryMinutes}" class="w-full px-3 py-2 bg-white border border-slate-200 rounded-xl text-sm font-medium" />
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: '(function(){ const t={ minOnTimeRate: parseInt(document.getElementById("sla_onTime").value||"80",10), maxPendingOrders: parseInt(document.getElementById("sla_pending").value||"10",10), minDailyDeposits: parseInt(document.getElementById("sla_deposits").value||"50000",10), maxDeliveryMinutes: parseInt(document.getElementById("sla_minutes").value||"60",10)}; GestionnaireModule.state.slaThresholds=t; GestionnaireModule.saveSlaThresholds(t); UI.closeModal(); })()', class: 'px-4 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700' }
            ]);
        },

        showChangePersonalPasswordModal() {
            UI.modal('��Ÿ�? Changer votre mot de passe', `
                <div class="space-y-4">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl flex items-center gap-3">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-amber-600 flex-shrink-0"></i>
                        <div class="text-sm text-amber-800 font-medium">Utilisez un mot de passe fort (min 6 caract��res)</div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Ancien mot de passe</label>
                        <input type="password" id="old_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Entrez votre ancien mot de passe">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Nouveau mot de passe</label>
                        <input type="password" id="new_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Entrez un nouveau mot de passe">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Confirmation du nouveau mot de passe</label>
                        <input type="password" id="confirm_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Confirmez le nouveau mot de passe">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Changer le mot de passe', onclick: 'GestionnaireModule.savePersonalPasswordChange()', class: 'px-5 py-2.5 bg-sky-600 text-white font-black rounded-xl hover:bg-sky-700' }
            ]);
        },

        savePersonalPasswordChange() {
            const oldPwd = UI.val('old_pwd');
            const newPwd = UI.val('new_pwd');
            const confirmPwd = UI.val('confirm_pwd');
            const user = CORE.state.currentUser;
            
            if (!oldPwd || !newPwd || !confirmPwd) {
                UI.toast('Tous les champs sont obligatoires', 'error');
                return;
            }
            
            if (newPwd.length < 6) {
                UI.toast('Le nouveau mot de passe doit contenir au moins 6 caract��res', 'error');
                return;
            }
            
            if (newPwd !== confirmPwd) {
                UI.toast('Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            if (oldPwd === newPwd) {
                UI.toast('Le nouveau mot de passe doit ��tre diff�rent', 'error');
                return;
            }
            
            // V�rifier l'ancien mot de passe
            if (user.password !== oldPwd) {
                UI.toast('Ancien mot de passe incorrect', 'error');
                return;
            }
            
            // Mettre �� jour
            user.password = newPwd;
            CORE.save();
            UI.closeModal();
            UI.toast('Mot de passe modifi� avec succ��s', 'success');
        },

        applyStockMovement() {
            const productId = parseInt(UI.val('mov_product') || '0', 10);
            const qty = Math.abs(parseInt(UI.val('mov_qty') || '0', 10));
            const type = UI.val('mov_type');
            const note = UI.val('mov_note');
            if (!productId || !qty || !type) return UI.toast('Champs requis', 'warning');
            const p = CORE.getProduct(productId);
            if (!p) return;

            let next = p.stock;
            if (type === 'in') next = p.stock + qty;
            if (type === 'out') next = p.stock - qty;
            if (type === 'adjust') next = qty;
            if (next < 0) return UI.toast('Stock ne peut pas ��tre n�gatif', 'error');

            CORE.update('products', p.id, { stock: next });
            CORE.recordStockMovement({ productId: p.id, type, qty, note });
            this.invalidateCache(['products', 'stocks']);
            UI.closeModal();
            UI.toast('Mouvement enregistr�', 'success');
            App.rerender();
        },

        // ============ IMPORT/EXPORT DE PRODUITS ============
        showImportProductsModal() {
            UI.modal('��Ÿ? � Importer des produits (CSV)', `
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="text-sm text-blue-700 font-bold">��Ÿ?� Format attendu:</div>
                        <div class="text-xs text-blue-600 mt-2 font-mono bg-white p-2 rounded border border-blue-100">
                            nom,reference,prix,stock,minStock,category
                            <br/>Produit1,REF001,15000,50,10,�lectronique
                        </div>
                    </div>

                    <div class="border-2 border-dashed border-slate-300 rounded-2xl p-6 text-center cursor-pointer hover:border-blue-400 transition" 
                         ondrop="event.preventDefault(); GestionnaireModule.handleImportDrop(event)" 
                         ondragover="event.preventDefault(); event.currentTarget.classList.add('border-blue-400', 'bg-blue-50')"
                         ondragleave="event.currentTarget.classList.remove('border-blue-400', 'bg-blue-50')">
                        <input id="import_csv" type="file" accept=".csv" style="display:none" onchange="GestionnaireModule.handleImportFile(event)">
                        <button onclick="document.getElementById('import_csv').click()" type="button" class="w-full">
                            <i data-lucide="upload-cloud" class="w-12 h-12 text-slate-400 mx-auto mb-2"></i>
                            <div class="font-bold text-slate-900">S�lectionner un fichier CSV</div>
                            <div class="text-xs text-slate-500">ou glissez-d�posez un fichier</div>
                        </button>
                    </div>

                    <div class="space-y-2 text-xs text-slate-600">
                        <div>���?? Formats accept�s: CSV (UTF-8)</div>
                        <div>���?? Taille max: 5MB</div>
                        <div>���?? Colonnes requises: nom, reference, prix, stock</div>
                        <div id="import_preview" class="hidden mt-4 p-4 bg-slate-50 rounded-xl">
                            <div class="font-bold text-slate-900 mb-2">Aper��u (premiers �l�ments):</div>
                            <div id="import_preview_content"></div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Importer', onclick: 'GestionnaireModule.applyImport()', id: 'btn_apply_import', disabled: true, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed' }
            ]);
            lucide.createIcons();
        },

        handleImportDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('import_csv').files = files;
                this.handleImportFile({ target: { files: files } });
            }
        },

        handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                UI.toast('Fichier trop volumineux (max 5MB)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\\n').filter(l => l.trim());
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                    
                    const requiredFields = ['nom', 'reference', 'prix'];
                    const missingFields = requiredFields.filter(f => !headers.includes(f));
                    if (missingFields.length > 0) {
                        return UI.toast(`Champs manquants: ${missingFields.join(', ')}`, 'error');
                    }

                    const products = [];
                    for (let i = 1; i < Math.min(lines.length, 11); i++) {
                        const values = lines[i].split(',').map(v => v.trim());
                        const product = {};
                        headers.forEach((h, idx) => {
                            product[h] = values[idx] || '';
                        });
                        if (product.nom) products.push(product);
                    }

                    window._importData = {
                        file: file.name,
                        products: products,
                        totalLines: lines.length - 1
                    };

                    const preview = products.slice(0, 5).map(p => 
                        `<div class="text-xs border-t border-slate-200 py-2">
                            <strong>${p.nom}</strong> (${p.reference}) - ${p.prix} FCFA
                        </div>`
                    ).join('');

                    document.getElementById('import_preview').classList.remove('hidden');
                    document.getElementById('import_preview_content').innerHTML = preview;
                    document.getElementById('btn_apply_import').disabled = false;

                    UI.toast(`��Ÿ?� ${window._importData.totalLines} produits trouv�s`, 'success');
                } catch (err) {
                    UI.toast('Erreur lors de la lecture du fichier: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        },

        applyImport() {
            if (!window._importData || !window._importData.products.length) {
                return UI.toast('Aucun produit �� importer', 'warning');
            }

            const posId = CORE.state.currentUser?.pos;
            if (!posId) return UI.toast('POS non d�fini', 'error');

            let imported = 0, skipped = 0, errors = 0;
            const results = [];

            window._importData.products.forEach((p, idx) => {
                try {
                    if (!p.nom || !p.reference || !p.prix) {
                        skipped++;
                        results.push(`�� � ��� � � Ligne ${idx + 2}: Donn�es incompl��tes`);
                        return;
                    }

                    // V�rifier doublon
                    const existing = CORE.db.products.find(prod => 
                        prod.reference === p.reference && prod.posId === posId
                    );
                    if (existing) {
                        skipped++;
                        results.push(`�� � ��� � � Ligne ${idx + 2}: ${p.reference} existe d�j��`);
                        return;
                    }

                    // Cr�er le produit
                    const newProduct = CORE.create('products', {
                        name: p.nom,
                        reference: p.reference,
                        price: Math.max(0, parseFloat(p.prix) || 0),
                        stock: Math.max(0, parseInt(p.stock) || 0),
                        minStock: Math.max(0, parseInt(p.minstock) || 5),
                        category: p.category || 'Non cat�goris�',
                        posId: posId,
                        active: true
                    });

                    imported++;
                    results.push(`���?� Ligne ${idx + 2}: ${p.reference} import�`);
                } catch (err) {
                    errors++;
                    results.push(`�� ��? Ligne ${idx + 2}: ${err.message}`);
                }
            });

            CORE.save();
            this.invalidateCache(['products', 'stocks']);

            const message = `���?� ${imported} produit(s) import�(s) | �� � ��� � � ${skipped} ignor�(s) | �� ��? ${errors} erreur(s)`;
            UI.toast(message, imported > 0 ? 'success' : 'warning');
            
            // Afficher d�tails
            const details = results.slice(0, 20).join('<br/>');
            UI.modal('��Ÿ?Š R�sum� import', `
                <div class="space-y-4">
                    <div class="p-4 ${imported > 0 ? 'bg-emerald-50 border-emerald-200' : 'bg-amber-50 border-amber-200'} border rounded-xl text-sm font-bold">
                        ${message}
                    </div>
                    <div class="max-h-64 overflow-y-auto text-xs space-y-1">
                        ${details}
                        ${results.length > 20 ? `<div class="text-slate-500 italic">... et ${results.length - 20} autres</div>` : ''}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal(); GestionnaireModule.state.currentView = "stocks"; App.rerender();' }
            ]);
        },

        showExportProductsModal() {
            const products = this.getProductsOptimized();
            
            UI.modal('��Ÿ? � Exporter les produits', `
                <div class="space-y-4">
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition">
                            <input type="radio" id="export_all" name="export_range" value="all" checked class="w-4 h-4">
                            <div>
                                <div class="font-black text-slate-900">Tous les produits</div>
                                <div class="text-xs text-slate-500">${products.length} produits</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition">
                            <input type="radio" id="export_lowstock" name="export_range" value="lowstock" class="w-4 h-4">
                            <div>
                                <div class="font-black text-slate-900">Stock faible uniquement</div>
                                <div class="text-xs text-slate-500">${products.filter(p => (p.stock || 0) <= (p.minStock || 0)).length} produits</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition">
                            <input type="radio" id="export_selected" name="export_range" value="selected" class="w-4 h-4">
                            <div>
                                <div class="font-black text-slate-900">Produits avec variantes</div>
                                <div class="text-xs text-slate-500">${products.filter(p => CORE.getProductVariants(p.id).length > 0).length} produits</div>
                            </div>
                        </label>
                    </div>

                    <div class="border-t pt-4">
                        <label class="text-xs font-black text-slate-600 uppercase mb-2 block">Colonnes �� exporter</label>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="col_name" checked class="w-4 h-4"> <span class="text-sm">Nom</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="col_ref" checked class="w-4 h-4"> <span class="text-sm">R�f�rence</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="col_prix" checked class="w-4 h-4"> <span class="text-sm">Prix</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="col_stock" checked class="w-4 h-4"> <span class="text-sm">Stock</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="col_minstock" checked class="w-4 h-4"> <span class="text-sm">Stock Min</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="col_category" class="w-4 h-4"> <span class="text-sm">Cat�gorie</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="col_status" class="w-4 h-4"> <span class="text-sm">Statut</span>
                            </label>
                        </div>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-3 text-xs text-blue-700">
                        <strong>��Ÿ? � Format:</strong> CSV (Excel/Calc compatible)
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'T�l�charger', onclick: 'GestionnaireModule.applyExport()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        applyExport() {
            const range = document.querySelector('input[name="export_range"]:checked')?.value || 'all';
            let products = this.getProductsOptimized();

            if (range === 'lowstock') {
                products = products.filter(p => (p.stock || 0) <= (p.minStock || 0));
            } else if (range === 'selected') {
                products = products.filter(p => CORE.getProductVariants(p.id).length > 0);
            }

            const columns = [
                { id: 'name', label: 'Nom', checked: document.getElementById('col_name')?.checked },
                { id: 'reference', label: 'R�f�rence', checked: document.getElementById('col_ref')?.checked },
                { id: 'price', label: 'Prix', checked: document.getElementById('col_prix')?.checked },
                { id: 'stock', label: 'Stock', checked: document.getElementById('col_stock')?.checked },
                { id: 'minStock', label: 'Stock Min', checked: document.getElementById('col_minstock')?.checked },
                { id: 'category', label: 'Cat�gorie', checked: document.getElementById('col_category')?.checked },
                { id: 'active', label: 'Statut', checked: document.getElementById('col_status')?.checked }
            ].filter(c => c.checked);

            if (columns.length === 0) {
                return UI.toast('S�lectionnez au moins une colonne', 'warning');
            }

            // G�n�rer CSV
            let csv = columns.map(c => `"${c.label}"`).join(',') + '\\n';
            csv += products.map(p => {
                return columns.map(col => {
                    let value = p[col.id] || '';
                    if (col.id === 'active') value = p.active ? 'Actif' : 'Inactif';
                    value = String(value).replace(/"/g, '""');
                    return `"${value}"`;
                }).join(',');
            }).join('\\n');

            // T�l�charger
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `produits_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            UI.closeModal();
            UI.toast(`���?� ${products.length} produit(s) export�(s)`, 'success');
        },

        showImportMovementsModal() {
            UI.modal('��Ÿ? � Importer des mouvements stock', `
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="text-sm text-blue-700 font-bold">��Ÿ?� Format attendu:</div>
                        <div class="text-xs text-blue-600 mt-2 font-mono bg-white p-2 rounded border border-blue-100">
                            reference,type,quantite,note
                            <br/>REF001,in,50,R�appro fournisseur
                        </div>
                        <div class="text-xs text-blue-600 mt-2">Types: <code>in</code> (entr�e), <code>out</code> (sortie), <code>adjust</code> (ajustement)</div>
                    </div>

                    <div class="border-2 border-dashed border-slate-300 rounded-2xl p-6 text-center cursor-pointer hover:border-blue-400 transition" 
                         ondrop="event.preventDefault(); GestionnaireModule.handleMovementsImportDrop(event)" 
                         ondragover="event.preventDefault(); event.currentTarget.classList.add('border-blue-400', 'bg-blue-50')"
                         ondragleave="event.currentTarget.classList.remove('border-blue-400', 'bg-blue-50')">
                        <input id="import_movements_csv" type="file" accept=".csv" style="display:none" onchange="GestionnaireModule.handleMovementsImportFile(event)">
                        <button onclick="document.getElementById('import_movements_csv').click()" type="button" class="w-full">
                            <i data-lucide="upload-cloud" class="w-12 h-12 text-slate-400 mx-auto mb-2"></i>
                            <div class="font-bold text-slate-900">S�lectionner un fichier CSV</div>
                        </button>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Importer', onclick: 'GestionnaireModule.applyMovementsImport()', id: 'btn_import_movements', disabled: true, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl disabled:opacity-50' }
            ]);
        },

        handleMovementsImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\\n').filter(l => l.trim());
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());

                    const movements = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim());
                        movements.push({
                            reference: values[0],
                            type: values[1],
                            qty: parseInt(values[2]) || 0,
                            note: values[3] || ''
                        });
                    }

                    window._movementsImportData = movements;
                    document.getElementById('btn_import_movements').disabled = false;
                    UI.toast(`���?� ${movements.length} mouvements trouv�s`, 'success');
                } catch (err) {
                    UI.toast('Erreur: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        },

        handleMovementsImportDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                this.handleMovementsImportFile({ target: { files: files } });
            }
        },

        applyMovementsImport() {
            if (!window._movementsImportData || !window._movementsImportData.length) {
                return UI.toast('Aucun mouvement �� importer', 'warning');
            }

            let applied = 0, failed = 0;
            window._movementsImportData.forEach(m => {
                const product = CORE.db.products.find(p => p.reference === m.reference);
                if (!product) {
                    failed++;
                    return;
                }

                if (!['in', 'out', 'adjust'].includes(m.type)) {
                    failed++;
                    return;
                }

                let newStock = product.stock;
                if (m.type === 'in') newStock += m.qty;
                if (m.type === 'out') newStock = Math.max(0, newStock - m.qty);
                if (m.type === 'adjust') newStock = m.qty;

                CORE.update('products', product.id, { stock: newStock });
                CORE.recordStockMovement({
                    productId: product.id,
                    type: m.type,
                    qty: m.qty,
                    note: m.note || 'Import en masse'
                });
                applied++;
            });

            CORE.save();
            this.invalidateCache(['products', 'stocks']);
            UI.closeModal();
            UI.toast(`���?� ${applied} mouvement(s) import�(s) | �� ��? ${failed} erreur(s)`, applied > 0 ? 'success' : 'warning');
            App.rerender();
        },

        renderDashboard() {
            const user = CORE.state.currentUser;
            const posId = user?.pos;
            
            // Utiliser getProductsOptimized pour avoir les stocks corrects par POS
            const products = this.getProductsOptimized();
            const lastMov = this.getStockMovementsOptimized(8);
            
            // Calculer lowStockCount avec le stock r�el du POS
            const lowStockCount = products.filter(p => {
                if (p.isMainWarehouse) return false;
                const stock = p.stock || 0;
                const minStock = p.minStock || 0;
                return stock <= minStock;
            }).length;
            
            const totalMovements = (user?.role === 'pdg' || user?.role === 'manager')
                ? (CORE.db.stockMovements || []).length
                : (CORE.db.stockMovements || []).filter(m => m.posId == posId || !m.posId).length;
            
            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-end justify-between mb-6">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">��Ÿ?Š Tableau de bord Logistique</h2>
                            <p class="text-slate-500 font-medium">Vue d'ensemble des stocks et mouvements</p>
                        </div>
                        <button onclick="GestionnaireModule.showImportProductsModal()" class="px-4 py-2.5 bg-blue-600 text-white rounded-xl font-black text-sm hover:bg-blue-700 transition flex items-center gap-2">
                            <i data-lucide="upload" class="w-4 h-4"></i> Import en masse
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-sm font-black uppercase tracking-wider">Alertes stock</div>
                            <div class="text-4xl font-black ${lowStockCount > 0 ? 'text-red-600' : 'text-emerald-600'} mt-2">${lowStockCount}</div>
                            <p class="text-xs text-slate-400 mt-2">Produits sous seuil critique</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-sm font-black uppercase tracking-wider">Produits</div>
                            <div class="text-4xl font-black text-slate-900 mt-2">${products.length}</div>
                            <p class="text-xs text-slate-400 mt-2">R�f�rences actives</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-sm font-black uppercase tracking-wider">Mouvements</div>
                            <div class="text-4xl font-black text-slate-900 mt-2">${totalMovements}</div>
                            <p class="text-xs text-slate-400 mt-2">Historique (derniers 100)</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-black text-slate-900">Mouvements r�cents</h3>
                            <button onclick="GestionnaireModule.quickRestockModal()" class="text-xs font-black text-sky-700">Nouveau mouvement</button>
                        </div>
                        <div class="p-0">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4">Produit</th>
                                        <th class="px-6 py-4">Type</th>
                                        <th class="px-6 py-4 text-right">Qt�</th>
                                        <th class="px-6 py-4 text-right">Date</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${lastMov.length === 0 ? `<tr><td colspan="4" class="px-6 py-10 text-center text-slate-400 italic">Aucun mouvement enregistr�</td></tr>` : ''}
                                    ${lastMov.map(m => `
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-6 py-4">
                                                <div class="font-black text-slate-900">${m.productName || '�� ?��'}</div>
                                                <div class="text-[10px] text-slate-400">${m.ref || ''}</div>
                                            </td>
                                            <td class="px-6 py-4">${UI.badge(m.type, m.type==='out'?'red':m.type==='in'?'emerald':'blue')}</td>
                                            <td class="px-6 py-4 text-right font-black ${m.type==='out'?'text-red-600':'text-slate-900'}">${m.type==='out' ? '-' : '+'}${m.qty}</td>
                                            <td class="px-6 py-4 text-right text-xs text-slate-500">${CORE.formatDate(m.createdAt)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        },

        renderStocks() {
            const posId = CORE.state.currentUser?.pos || null;
            const pos = posId ? CORE.getPOS(posId) : null;
            const products = this.getProductsOptimized();
            const searchQuery = (this.state.stockSearch || '').toLowerCase().trim();
            const categoryFilter = this.state.stockCategoryFilter || 'all';
            const statusFilter = this.state.stockStatusFilter || 'all';
            const sortBy = this.state.stockSortBy || 'name';
            const viewMode = this.state.stockViewMode || 'table';
            const page = this.state.stockPage || 1;
            const perPage = this.state.stockPerPage || 50;
            
            // Filtrer les produits
            let filteredProducts = products.filter(p => {
                if (searchQuery && !(p.name || '').toLowerCase().includes(searchQuery) && 
                    !(p.barcode || '').toLowerCase().includes(searchQuery) &&
                    !(p.reference || '').toLowerCase().includes(searchQuery)) return false;
                if (categoryFilter !== 'all' && p.categoryId != categoryFilter) return false;
                
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                const minStock = p.minStock || 0;
                if (statusFilter === 'critical' && stock > minStock * 0.5) return false;
                if (statusFilter === 'low' && (stock > minStock || stock <= minStock * 0.5)) return false;
                if (statusFilter === 'ok' && stock <= minStock) return false;
                if (statusFilter === 'outofstock' && stock > 0) return false;
                
                return true;
            });
            
            // Tri
            filteredProducts.sort((a, b) => {
                const stockA = posId ? (CORE.getProductStock(a.id, posId) || a.stock || 0) : (a.stock || 0);
                const stockB = posId ? (CORE.getProductStock(b.id, posId) || b.stock || 0) : (b.stock || 0);
                switch (sortBy) {
                    case 'stock_asc': return stockA - stockB;
                    case 'stock_desc': return stockB - stockA;
                    case 'price_asc': return (a.price || 0) - (b.price || 0);
                    case 'price_desc': return (b.price || 0) - (a.price || 0);
                    case 'value_desc': return (stockB * (b.price || 0)) - (stockA * (a.price || 0));
                    case 'name_desc': return (b.name || '').localeCompare(a.name || '');
                    default: return (a.name || '').localeCompare(b.name || '');
                }
            });
            
            // Pagination
            const totalFiltered = filteredProducts.length;
            const totalPages = Math.ceil(totalFiltered / perPage);
            const currentPage = Math.min(page, totalPages || 1);
            const startIdx = (currentPage - 1) * perPage;
            const paginatedProducts = filteredProducts.slice(startIdx, startIdx + perPage);
            
            // Generate pagination buttons
            const paginationPages = [];
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationPages.push(i);
                } else if (paginationPages[paginationPages.length - 1] !== '...') {
                    paginationPages.push('...');
                }
            }
            
            // Calculs des m�triques
            const totalProducts = products.length;
            const totalStock = products.reduce((sum, p) => {
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                return sum + stock;
            }, 0);
            const totalValue = products.reduce((sum, p) => {
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                return sum + (stock * (p.price || 0));
            }, 0);
            const lowStockCount = products.filter(p => {
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                return stock <= (p.minStock || 0) && stock > (p.minStock || 0) * 0.5;
            }).length;
            const criticalCount = products.filter(p => {
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                return stock <= (p.minStock || 0) * 0.5;
            }).length;
            const outOfStockCount = products.filter(p => {
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                return stock === 0;
            }).length;
            const healthyCount = products.filter(p => {
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                return stock > (p.minStock || 0);
            }).length;
            
            // Cat�gories
            const categories = (CORE.db.categories || []).filter(c => !c.posId || c.posId == posId);
            const categoryStats = {};
            products.forEach(p => {
                const catName = CORE.getCategory(p.categoryId)?.name || 'Non cat�goris�';
                if (!categoryStats[catName]) categoryStats[catName] = { count: 0, value: 0, stock: 0 };
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                categoryStats[catName].count++;
                categoryStats[catName].stock += stock;
                categoryStats[catName].value += stock * (p.price || 0);
            });
            
            // Mouvements r�cents (derni��res 24h)
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
            const recentMovements = (CORE.db.stockMovements || [])
                .filter(m => m.posId == posId && m.createdAt >= yesterday)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 10);
            
            // Produits les plus critiques
            const criticalProducts = products
                .map(p => {
                    const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                    const minStock = p.minStock || 1;
                    const ratio = stock / minStock;
                    return { ...p, stock, ratio };
                })
                .filter(p => p.ratio <= 1)
                .sort((a, b) => a.ratio - b.ratio)
                .slice(0, 8);
            
            // Valeur par cat�gorie pour graphique
            const categoryChartData = Object.entries(categoryStats)
                .sort((a, b) => b[1].value - a[1].value)
                .slice(0, 6);
            const maxCatValue = Math.max(...categoryChartData.map(c => c[1].value), 1);
            
            return `
                <div class="fade-in space-y-6">
                    <!-- En-t��te -->
                    <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
                        <div>
                            <div class="flex items-center gap-3">
                                <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="package" class="w-7 h-7 text-white"></i>
                                </div>
                                <div>
                                    <h2 class="text-3xl font-black text-slate-900">��Ÿ? � Gestion du Stock</h2>
                                    <p class="text-slate-500 font-medium">${pos?.name || 'Tous POS'} �� ?� � ${filteredProducts.length}/${totalProducts} produit(s) affich�s</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="GestionnaireModule.showAddProductModal()" class="px-4 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-xl font-black text-sm hover:from-emerald-600 hover:to-teal-700 transition shadow-lg shadow-emerald-500/30 flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Nouveau produit
                            </button>
                            <button onclick="GestionnaireModule.showAddStockModal()" class="px-4 py-2.5 bg-blue-600 text-white rounded-xl font-black text-sm hover:bg-blue-700 transition flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> Entr�e stock
                            </button>
                            <button onclick="GestionnaireModule.exportStockCSV()" class="px-4 py-2.5 bg-slate-700 text-white rounded-xl font-black text-sm hover:bg-slate-800 transition flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> Export CSV
                            </button>
                        </div>
                    </div>

                    <!-- Alerte transferts en attente -->
                    ${(() => {
                        const pendingCount = this.getPendingTransfersCount ? this.getPendingTransfersCount() : 0;
                        return pendingCount > 0 ? `
                        <div class="bg-gradient-to-r from-amber-500 to-orange-500 rounded-2xl p-4 text-white shadow-lg cursor-pointer hover:from-amber-600 hover:to-orange-600 transition" onclick="GestionnaireModule.showPendingTransfersModal()">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center animate-pulse">
                                        <i data-lucide="package-check" class="w-6 h-6"></i>
                                    </div>
                                    <div>
                                        <div class="font-black text-lg">��Ÿ? � ${pendingCount} transfert(s) �� r�ceptionner</div>
                                        <div class="text-sm opacity-90">Cliquez pour valider ou rejeter</div>
                                    </div>
                                </div>
                                <i data-lucide="chevron-right" class="w-6 h-6"></i>
                            </div>
                        </div>
                        ` : '';
                    })()}

                    <!-- Alerte notifications transferts (confirmations/rejets) -->
                    ${(() => {
                        const notifCount = this.getTransferNotificationsCount ? this.getTransferNotificationsCount() : 0;
                        return notifCount > 0 ? `
                        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl p-4 text-white shadow-lg cursor-pointer hover:from-blue-600 hover:to-indigo-700 transition" onclick="GestionnaireModule.showTransferNotificationsModal()">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center animate-pulse">
                                        <i data-lucide="bell-ring" class="w-6 h-6"></i>
                                    </div>
                                    <div>
                                        <div class="font-black text-lg">��Ÿ�� ${notifCount} notification(s) de transfert</div>
                                        <div class="text-sm opacity-90">R�ponses des POS destinataires - Cliquez pour voir les preuves</div>
                                    </div>
                                </div>
                                <i data-lucide="chevron-right" class="w-6 h-6"></i>
                            </div>
                        </div>
                        ` : '';
                    })()}

                    <!-- Barre d'actions rapides -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <div class="flex items-center gap-2 mb-3">
                            <i data-lucide="zap" class="w-5 h-5 text-amber-500"></i>
                            <span class="font-black text-slate-800">Actions rapides</span>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-5 lg:grid-cols-10 gap-3">
                            <button onclick="GestionnaireModule.showAddProductModal()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-slate-200 hover:border-emerald-300 hover:bg-emerald-50/50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="package-plus" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Nouveau produit</span>
                            </button>
                            <button class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-blue-500 bg-blue-50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="layout-dashboard" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Dashboard</span>
                            </button>
                            <button onclick="GestionnaireModule.showPendingTransfersModal()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 ${this.getPendingTransfersCount && this.getPendingTransfersCount() > 0 ? 'border-amber-500 bg-amber-50 animate-pulse' : 'border-slate-200 hover:border-amber-300 hover:bg-amber-50/50'} transition group relative">
                                <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="package-check" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">R�ceptions</span>
                                ${this.getPendingTransfersCount && this.getPendingTransfersCount() > 0 ? `<span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-black rounded-full flex items-center justify-center">${this.getPendingTransfersCount()}</span>` : ''}
                            </button>
                            <button onclick="GestionnaireModule.showTransferNotificationsModal()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 ${this.getTransferNotificationsCount && this.getTransferNotificationsCount() > 0 ? 'border-blue-500 bg-blue-50' : 'border-slate-200 hover:border-blue-300 hover:bg-blue-50/50'} transition group relative">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="bell-ring" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Notifs Transferts</span>
                                ${this.getTransferNotificationsCount && this.getTransferNotificationsCount() > 0 ? `<span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-black rounded-full flex items-center justify-center">${this.getTransferNotificationsCount()}</span>` : ''}
                            </button>
                            <button onclick="GestionnaireModule.showStockIndicators()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-slate-200 hover:border-emerald-300 hover:bg-emerald-50/50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="gauge" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Indicateurs</span>
                            </button>
                            <button onclick="GestionnaireModule.showStockHistory()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-slate-200 hover:border-purple-300 hover:bg-purple-50/50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-violet-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="history" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Historique</span>
                            </button>
                            <button onclick="GestionnaireModule.showBulkReorderModal()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-slate-200 hover:border-amber-300 hover:bg-amber-50/50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="repeat" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">R�appro masse</span>
                            </button>
                            <button onclick="GestionnaireModule.showTransferStockModal()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-slate-200 hover:border-cyan-300 hover:bg-cyan-50/50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="send" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Envoyer Stock</span>
                            </button>
                            <button onclick="GestionnaireModule.showStockAnalysis()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-slate-200 hover:border-pink-300 hover:bg-pink-50/50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-pink-500 to-rose-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="bar-chart-3" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Analyse</span>
                            </button>
                            <button onclick="GestionnaireModule.showStockRecommendations()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-slate-200 hover:border-indigo-300 hover:bg-indigo-50/50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="lightbulb" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Recommandations</span>
                            </button>
                            <button onclick="GestionnaireModule.exportStockCSV()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-slate-200 hover:border-slate-400 hover:bg-slate-50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-slate-600 to-slate-800 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="download" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Export CSV</span>
                            </button>
                        </div>
                    </div>

                    <!-- KPIs Principaux -->
                    <div class="grid grid-cols-2 lg:grid-cols-6 gap-4">
                        <div class="bg-gradient-to-br from-slate-50 to-slate-100 p-5 rounded-2xl border border-slate-200 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Total Produits</div>
                                    <div class="text-3xl font-black text-slate-900 mt-2">${totalProducts}</div>
                                </div>
                                <div class="w-12 h-12 bg-slate-200 rounded-xl flex items-center justify-center">
                                    <i data-lucide="box" class="w-6 h-6 text-slate-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-5 rounded-2xl border border-blue-200 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-black text-blue-600 uppercase tracking-wider">Unit�s Stock</div>
                                    <div class="text-3xl font-black text-blue-900 mt-2">${totalStock.toLocaleString()}</div>
                                </div>
                                <div class="w-12 h-12 bg-blue-200 rounded-xl flex items-center justify-center">
                                    <i data-lucide="layers" class="w-6 h-6 text-blue-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-5 rounded-2xl border border-emerald-200 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-black text-emerald-600 uppercase tracking-wider">Valeur Totale</div>
                                    <div class="text-2xl font-black text-emerald-900 mt-2">${CORE.formatPrice(totalValue)}</div>
                                </div>
                                <div class="w-12 h-12 bg-emerald-200 rounded-xl flex items-center justify-center">
                                    <i data-lucide="banknote" class="w-6 h-6 text-emerald-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-5 rounded-2xl border border-green-200 shadow-sm cursor-pointer hover:shadow-md transition" onclick="GestionnaireModule.state.stockStatusFilter='ok';App.rerender()">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-black text-green-600 uppercase tracking-wider">Stock OK</div>
                                    <div class="text-3xl font-black text-green-900 mt-2">${healthyCount}</div>
                                </div>
                                <div class="w-12 h-12 bg-green-200 rounded-xl flex items-center justify-center">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-5 rounded-2xl border border-amber-200 shadow-sm cursor-pointer hover:shadow-md transition" onclick="GestionnaireModule.state.stockStatusFilter='low';App.rerender()">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-black text-amber-600 uppercase tracking-wider">Stock Bas</div>
                                    <div class="text-3xl font-black text-amber-900 mt-2">${lowStockCount}</div>
                                </div>
                                <div class="w-12 h-12 bg-amber-200 rounded-xl flex items-center justify-center">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-amber-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-red-100 p-5 rounded-2xl border border-red-200 shadow-sm cursor-pointer hover:shadow-md transition" onclick="GestionnaireModule.state.stockStatusFilter='critical';App.rerender()">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-black text-red-600 uppercase tracking-wider">Critique</div>
                                    <div class="text-3xl font-black text-red-900 mt-2">${criticalCount}</div>
                                </div>
                                <div class="w-12 h-12 bg-red-200 rounded-xl flex items-center justify-center">
                                    <i data-lucide="alert-octagon" class="w-6 h-6 text-red-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alertes critiques -->
                    ${criticalProducts.length > 0 ? `
                    <div class="bg-gradient-to-r from-red-500 to-orange-500 rounded-2xl p-6 text-white shadow-xl">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <div class="font-black text-lg">��š ��� � � Alertes Stock Critique</div>
                                <div class="text-white/80 text-sm">${criticalProducts.length} produit(s) n�cessitent une attention imm�diate</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                            ${criticalProducts.map(p => {
                                const percent = Math.round(p.ratio * 100);
                                return `
                                <div class="bg-white/10 backdrop-blur rounded-xl p-4 hover:bg-white/20 transition cursor-pointer" onclick="GestionnaireModule.showQuickStockModal(${p.id})">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-bold text-sm truncate flex-1">${p.name}</span>
                                        <span class="px-2 py-1 bg-white/20 rounded-lg text-xs font-black ml-2">${percent}%</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="flex-1 h-2 bg-white/20 rounded-full overflow-hidden">
                                            <div class="h-full ${percent <= 25 ? 'bg-red-300' : 'bg-amber-300'} rounded-full" style="width: ${Math.max(5, percent)}%"></div>
                                        </div>
                                        <span class="text-xs font-bold">${p.stock}/${p.minStock || 0}</span>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : `
                    <div class="bg-gradient-to-r from-emerald-500 to-teal-500 rounded-2xl p-6 text-white shadow-xl">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                <i data-lucide="check-circle" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <div class="font-black text-lg">���?� Tous les stocks sont OK</div>
                                <div class="text-white/80 text-sm">Aucun produit en situation critique</div>
                            </div>
                        </div>
                    </div>
                    `}

                    <!-- Graphiques et statistiques -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- R�partition par cat�gorie -->
                        <div class="lg:col-span-2 bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-black text-slate-900">��Ÿ?Š Valeur par Cat�gorie</h3>
                                <span class="text-xs text-slate-500">${Object.keys(categoryStats).length} cat�gories</span>
                            </div>
                            <div class="space-y-4">
                                ${categoryChartData.map(([cat, data], idx) => {
                                    const percent = Math.round((data.value / totalValue) * 100) || 0;
                                    const widthPercent = Math.round((data.value / maxCatValue) * 100);
                                    const colors = ['bg-blue-500', 'bg-emerald-500', 'bg-amber-500', 'bg-purple-500', 'bg-pink-500', 'bg-cyan-500'];
                                    return `
                                    <div class="group">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-2">
                                                <div class="w-3 h-3 ${colors[idx % colors.length]} rounded-full"></div>
                                                <span class="font-bold text-slate-900">${cat}</span>
                                                <span class="text-xs text-slate-500">(${data.count} produits)</span>
                                            </div>
                                            <div class="text-right">
                                                <span class="font-black text-slate-900">${CORE.formatPrice(data.value)}</span>
                                                <span class="text-xs text-slate-500 ml-2">${percent}%</span>
                                            </div>
                                        </div>
                                        <div class="h-3 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full ${colors[idx % colors.length]} rounded-full transition-all duration-500 group-hover:opacity-80" style="width: ${widthPercent}%"></div>
                                        </div>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Mouvements r�cents -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-black text-slate-900">��Ÿ�? Mouvements (24h)</h3>
                                <span class="px-2 py-1 bg-slate-100 rounded-lg text-xs font-bold text-slate-600">${recentMovements.length}</span>
                            </div>
                            <div class="space-y-3 max-h-80 overflow-y-auto">
                                ${recentMovements.length === 0 ? `
                                <div class="text-center py-8 text-slate-400">
                                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                    <div class="text-sm">Aucun mouvement r�cent</div>
                                </div>
                                ` : recentMovements.map(m => {
                                    const isIn = m.type === 'in';
                                    const isOut = m.type === 'out';
                                    return `
                                    <div class="flex items-center gap-3 p-3 rounded-xl ${isIn ? 'bg-emerald-50' : isOut ? 'bg-red-50' : 'bg-blue-50'} transition hover:shadow-sm">
                                        <div class="w-10 h-10 ${isIn ? 'bg-emerald-200 text-emerald-700' : isOut ? 'bg-red-200 text-red-700' : 'bg-blue-200 text-blue-700'} rounded-xl flex items-center justify-center font-black text-sm">
                                            ${isIn ? '+' : isOut ? '-' : '�? �'}${m.qty}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-slate-900 truncate">${m.productName || 'Produit #' + m.productId}</div>
                                            <div class="text-xs text-slate-500">${m.ref || m.note || '�� ?��'}</div>
                                        </div>
                                        <div class="text-xs text-slate-400">${new Date(m.createdAt).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</div>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                            ${recentMovements.length > 0 ? `
                            <button onclick="GestionnaireModule.showImportMovementsModal()" class="w-full mt-4 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition text-sm">
                                Voir tous les mouvements
                            </button>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Filtres et recherche -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                        <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                            <div class="flex flex-wrap gap-3 items-center">
                                <!-- Recherche -->
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input type="text" value="${searchQuery}" 
                                        oninput="GestionnaireModule.state.stockSearch=this.value;GestionnaireModule.state.stockPage=1;App.rerender()" 
                                        placeholder="Rechercher produit, code..." 
                                        class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium w-64">
                                </div>
                                <!-- Cat�gorie -->
                                <select onchange="GestionnaireModule.state.stockCategoryFilter=this.value;GestionnaireModule.state.stockPage=1;App.rerender()" 
                                    class="px-4 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    <option value="all" ${categoryFilter === 'all' ? 'selected' : ''}>Toutes cat�gories</option>
                                    ${categories.map(c => `<option value="${c.id}" ${categoryFilter == c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                </select>
                                <!-- Statut stock -->
                                <select onchange="GestionnaireModule.state.stockStatusFilter=this.value;GestionnaireModule.state.stockPage=1;App.rerender()" 
                                    class="px-4 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    <option value="all" ${statusFilter === 'all' ? 'selected' : ''}>Tous les stocks</option>
                                    <option value="ok" ${statusFilter === 'ok' ? 'selected' : ''}>���?� Stock OK</option>
                                    <option value="low" ${statusFilter === 'low' ? 'selected' : ''}>��š ��� � � Stock bas</option>
                                    <option value="critical" ${statusFilter === 'critical' ? 'selected' : ''}>��Ÿ� � Critique</option>
                                    <option value="outofstock" ${statusFilter === 'outofstock' ? 'selected' : ''}>�� ��? Rupture</option>
                                </select>
                                <!-- Tri -->
                                <select onchange="GestionnaireModule.state.stockSortBy=this.value;App.rerender()" 
                                    class="px-4 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    <option value="name" ${sortBy === 'name' ? 'selected' : ''}>Nom A-Z</option>
                                    <option value="name_desc" ${sortBy === 'name_desc' ? 'selected' : ''}>Nom Z-A</option>
                                    <option value="stock_asc" ${sortBy === 'stock_asc' ? 'selected' : ''}>Stock ���?</option>
                                    <option value="stock_desc" ${sortBy === 'stock_desc' ? 'selected' : ''}>Stock ���?</option>
                                    <option value="price_asc" ${sortBy === 'price_asc' ? 'selected' : ''}>Prix ���?</option>
                                    <option value="price_desc" ${sortBy === 'price_desc' ? 'selected' : ''}>Prix ���?</option>
                                    <option value="value_desc" ${sortBy === 'value_desc' ? 'selected' : ''}>Valeur ���?</option>
                                </select>
                            </div>
                            <div class="flex gap-2">
                                <!-- Mode vue -->
                                <button onclick="GestionnaireModule.state.stockViewMode='table';App.rerender()" 
                                    class="p-2.5 rounded-xl ${viewMode === 'table' ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">
                                    <i data-lucide="list" class="w-5 h-5"></i>
                                </button>
                                <button onclick="GestionnaireModule.state.stockViewMode='grid';App.rerender()" 
                                    class="p-2.5 rounded-xl ${viewMode === 'grid' ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">
                                    <i data-lucide="grid-3x3" class="w-5 h-5"></i>
                                </button>
                                <!-- R�initialiser filtres -->
                                ${(searchQuery || categoryFilter !== 'all' || statusFilter !== 'all') ? `
                                <button onclick="GestionnaireModule.state.stockSearch='';GestionnaireModule.state.stockCategoryFilter='all';GestionnaireModule.state.stockStatusFilter='all';App.rerender()" 
                                    class="px-4 py-2.5 bg-red-100 text-red-700 rounded-xl font-bold hover:bg-red-200 transition">
                                    <i data-lucide="x" class="w-4 h-4"></i> Reset
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Liste des produits -->
                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <div class="font-black text-slate-900">${filteredProducts.length} produit(s) trouv�(s)</div>
                            <div class="flex gap-2">
                                <button onclick="GestionnaireModule.showBulkRestockModal()" class="px-4 py-2 bg-amber-100 text-amber-700 rounded-xl font-bold text-sm hover:bg-amber-200 transition flex items-center gap-2">
                                    <i data-lucide="truck" class="w-4 h-4"></i> R�appro group�e
                                </button>
                            </div>
                        </div>

                        ${viewMode === 'grid' ? `
                        <div class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            ${filteredProducts.length === 0 ? `
                            <div class="col-span-full py-16 text-center text-slate-400">
                                <i data-lucide="package-x" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                                <div class="font-bold">Aucun produit trouv�</div>
                                <div class="text-sm">Modifiez vos filtres de recherche</div>
                            </div>
                            ` : paginatedProducts.map(p => {
                                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                                const minStock = p.minStock || 0;
                                const ratio = minStock > 0 ? (stock / minStock) : 1;
                                const percent = Math.round(ratio * 100);
                                const isCritical = ratio <= 0.5;
                                const isLow = ratio <= 1 && !isCritical;
                                const isOK = ratio > 1;
                                const statusColor = isCritical ? 'red' : isLow ? 'amber' : 'emerald';
                                const value = stock * (p.price || 0);
                                
                                return `
                                <div class="bg-slate-50 rounded-2xl p-5 border border-slate-200 hover:shadow-lg hover:border-${statusColor}-300 transition group cursor-pointer" onclick="GestionnaireModule.showQuickStockModal(${p.id})">
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex-1 min-w-0">
                                            <div class="font-black text-slate-900 truncate">${p.name}</div>
                                            <div class="text-xs text-slate-500">${CORE.getCategory(p.categoryId)?.name || '�� ?��'}</div>
                                        </div>
                                        <span class="px-2 py-1 ${isCritical ? 'bg-red-100 text-red-700' : isLow ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'} rounded-lg text-xs font-black">
                                            ${isCritical ? '��Ÿ� �' : isLow ? '��š ��� � �' : '���?�'}
                                        </span>
                                    </div>
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="text-3xl font-black ${isCritical ? 'text-red-600' : isLow ? 'text-amber-600' : 'text-slate-900'}">${stock}</div>
                                        <div class="text-xs text-slate-500">/ min ${minStock}</div>
                                    </div>
                                    <div class="h-2 bg-slate-200 rounded-full overflow-hidden mb-3">
                                        <div class="h-full ${isCritical ? 'bg-red-500' : isLow ? 'bg-amber-500' : 'bg-emerald-500'} rounded-full transition-all" style="width: ${Math.min(100, percent)}%"></div>
                                    </div>
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="font-bold text-slate-700">${CORE.formatPrice(p.price || 0)}</span>
                                        <span class="text-slate-500">Val: ${CORE.formatPrice(value)}</span>
                                    </div>
                                    <div class="mt-3 pt-3 border-t border-slate-200 opacity-0 group-hover:opacity-100 transition flex gap-2">
                                        <button onclick="event.stopPropagation();GestionnaireModule.showQuickStockModal(${p.id})" class="flex-1 py-2 bg-emerald-600 text-white rounded-lg text-xs font-bold hover:bg-emerald-700">+ Entr�e</button>
                                        <button onclick="event.stopPropagation();GestionnaireModule.showQuickSortieModal(${p.id})" class="flex-1 py-2 bg-red-600 text-white rounded-lg text-xs font-bold hover:bg-red-700">- Sortie</button>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                        ` : `
                        <div class="overflow-x-auto">
                            <table class="w-full text-left min-w-[900px]">
                                <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4">Produit</th>
                                        <th class="px-6 py-4">Cat�gorie</th>
                                        <th class="px-6 py-4 text-right">Prix</th>
                                        <th class="px-6 py-4 text-center">Stock</th>
                                        <th class="px-6 py-4 text-center">Min</th>
                                        <th class="px-6 py-4">�tat</th>
                                        <th class="px-6 py-4 text-right">Valeur</th>
                                        <th class="px-6 py-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${filteredProducts.length === 0 ? `
                                    <tr><td colspan="8" class="px-6 py-16 text-center text-slate-400">
                                        <i data-lucide="package-x" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                                        <div class="font-bold">Aucun produit trouv�</div>
                                    </td></tr>
                                    ` : paginatedProducts.map(p => {
                                        const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                                        const minStock = p.minStock || 0;
                                        const ratio = minStock > 0 ? (stock / minStock) : 1;
                                        const isCritical = ratio <= 0.5;
                                        const isLow = ratio <= 1 && !isCritical;
                                        const value = stock * (p.price || 0);
                                        
                                        return `
                                        <tr class="hover:bg-slate-50 transition group">
                                            <td class="px-6 py-4">
                                                <div class="font-black text-slate-900">${p.name}</div>
                                                <div class="text-[10px] text-slate-400">#${p.barcode || p.reference || p.id}</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <span class="px-3 py-1 bg-slate-100 rounded-lg text-xs font-bold text-slate-600">${CORE.getCategory(p.categoryId)?.name || '�� ?��'}</span>
                                            </td>
                                            <td class="px-6 py-4 text-right font-black text-slate-900">${CORE.formatPrice(p.price || 0)}</td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="text-xl font-black ${isCritical ? 'text-red-600' : isLow ? 'text-amber-600' : 'text-slate-900'}">${stock}</span>
                                            </td>
                                            <td class="px-6 py-4 text-center font-bold text-slate-500">${minStock}</td>
                                            <td class="px-6 py-4">
                                                ${isCritical ? `<span class="px-3 py-1 bg-red-100 text-red-700 rounded-lg text-xs font-black">��Ÿ� � Critique</span>` :
                                                  isLow ? `<span class="px-3 py-1 bg-amber-100 text-amber-700 rounded-lg text-xs font-black">��š ��� � � Bas</span>` :
                                                  `<span class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-lg text-xs font-black">���?� OK</span>`}
                                            </td>
                                            <td class="px-6 py-4 text-right font-bold text-slate-700">${CORE.formatPrice(value)}</td>
                                            <td class="px-6 py-4 text-right">
                                                <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition">
                                                    <button onclick="GestionnaireModule.showQuickStockModal(${p.id})" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700" title="Entr�e stock">
                                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="GestionnaireModule.showQuickSortieModal(${p.id})" class="px-3 py-2 rounded-xl bg-red-600 text-white text-xs font-black hover:bg-red-700" title="Sortie stock">
                                                        <i data-lucide="minus" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="ManagerModule.showEditProductModal(${p.id})" class="px-3 py-2 rounded-xl bg-blue-600 text-white text-xs font-black hover:bg-blue-700" title="�diter produit">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="GestionnaireModule.showProductDetailModal(${p.id})" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300" title="D�tails">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination controls -->
                        ${totalPages > 1 ? `
                        <div class="p-4 border-t border-slate-100 flex flex-wrap items-center justify-between gap-4">
                            <div class="text-sm text-slate-600 font-medium">
                                ${totalFiltered === 0 ? 'Aucun produit' : `Affichage ${startIdx + 1}-${Math.min(startIdx + perPage, totalFiltered)} sur ${totalFiltered} produit(s)`}
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-500">Par page:</span>
                                <select onchange="GestionnaireModule.state.stockPerPage=parseInt(this.value);GestionnaireModule.state.stockPage=1;App.rerender()" class="px-2 py-1 rounded-lg border border-slate-200 bg-white text-sm font-bold">
                                    <option value="25" ${perPage === 25 ? 'selected' : ''}>25</option>
                                    <option value="50" ${perPage === 50 ? 'selected' : ''}>50</option>
                                    <option value="100" ${perPage === 100 ? 'selected' : ''}>100</option>
                                    <option value="200" ${perPage === 200 ? 'selected' : ''}>200</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="GestionnaireModule.state.stockPage=1;App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === 1 ? 'disabled' : ''}><i data-lucide="chevrons-left" class="w-4 h-4"></i></button>
                                <button onclick="GestionnaireModule.state.stockPage=Math.max(1,GestionnaireModule.state.stockPage-1);App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === 1 ? 'disabled' : ''}><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                                ${paginationPages.map(p => p === '...' ? `<span class="px-2 text-slate-400">...</span>` : `<button onclick="GestionnaireModule.state.stockPage=${p};App.rerender()" class="px-3 py-2 rounded-lg ${p === currentPage ? 'bg-blue-600 text-white' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm">${p}</button>`).join('')}
                                <button onclick="GestionnaireModule.state.stockPage=Math.min(${totalPages},GestionnaireModule.state.stockPage+1);App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === totalPages ? 'disabled' : ''}><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                                <button onclick="GestionnaireModule.state.stockPage=${totalPages};App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === totalPages ? 'disabled' : ''}><i data-lucide="chevrons-right" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        ` : totalFiltered > 0 ? `
                        <div class="p-4 text-center text-sm text-slate-500 border-t border-slate-100">
                            ${totalFiltered} produit(s) affich�(s)
                        </div>
                        ` : ''}
                        `}
                    </div>
                </div>
            `;
        },

        // Modal rapide pour entr�e stock
        showQuickStockModal(productId) {
            if (!CORE.hasPermission('stock.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const p = CORE.db.products.find(x => x.id === productId);
            if (!p) return UI.toast('Produit introuvable', 'error');
            const posId = CORE.state.currentUser?.pos;
            const currentStock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
            
            UI.modal(`��Ÿ? � Entr�e Stock: ${p.name}`, `
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl flex items-center justify-between">
                        <span class="font-bold text-blue-900">Stock actuel</span>
                        <span class="text-2xl font-black text-blue-600">${currentStock}</span>
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Quantit� �� ajouter</label>
                        <input type="number" id="quick_stock_qty" min="1" value="1" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold text-xl text-center" autofocus>
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Note/R�f�rence</label>
                        <input type="text" id="quick_stock_note" placeholder="Ex: Livraison fournisseur #123" class="w-full px-4 py-3 border border-slate-200 rounded-xl">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Ajouter au stock', onclick: `GestionnaireModule.applyQuickStock(${productId}, 'in')`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        // Modal rapide pour sortie stock
        showQuickSortieModal(productId) {
            if (!CORE.hasPermission('stock.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const p = CORE.db.products.find(x => x.id === productId);
            if (!p) return UI.toast('Produit introuvable', 'error');
            const posId = CORE.state.currentUser?.pos;
            const currentStock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
            
            UI.modal(`��Ÿ? � Sortie Stock: ${p.name}`, `
                <div class="space-y-4">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl flex items-center justify-between">
                        <span class="font-bold text-amber-900">Stock actuel</span>
                        <span class="text-2xl font-black text-amber-600">${currentStock}</span>
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Quantit� �� retirer</label>
                        <input type="number" id="quick_stock_qty" min="1" max="${currentStock}" value="1" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold text-xl text-center" autofocus>
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Raison</label>
                        <select id="quick_stock_reason" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold">
                            <option value="Vente directe">Vente directe</option>
                            <option value="Perte/Casse">Perte/Casse</option>
                            <option value="P�rim�">P�rim�</option>
                            <option value="Transfert">Transfert</option>
                            <option value="Retour fournisseur">Retour fournisseur</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Note</label>
                        <input type="text" id="quick_stock_note" placeholder="D�tails suppl�mentaires" class="w-full px-4 py-3 border border-slate-200 rounded-xl">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Retirer du stock', onclick: `GestionnaireModule.applyQuickStock(${productId}, 'out')`, class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);
        },

        applyQuickStock(productId, type) {
            if (!CORE.hasPermission('stock.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const p = CORE.db.products.find(x => x.id === productId);
            if (!p) return UI.toast('Produit introuvable', 'error');
            
            const qty = parseInt(document.getElementById('quick_stock_qty')?.value) || 0;
            const note = document.getElementById('quick_stock_note')?.value || '';
            const reason = document.getElementById('quick_stock_reason')?.value || '';
            
            if (qty <= 0) return UI.toast('Quantit� invalide', 'error');
            
            const posId = CORE.state.currentUser?.pos;
            const currentStock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
            const newStock = type === 'in' ? currentStock + qty : currentStock - qty;
            
            if (newStock < 0) return UI.toast('Stock insuffisant', 'error');
            
            CORE.update('products', p.id, { stock: newStock });
            CORE.recordStockMovement({ 
                productId: p.id, 
                type, 
                qty, 
                note: reason ? `${reason}: ${note}` : note,
                posId: posId,
                userName: CORE.state.currentUser?.name
            });
            
            this.invalidateCache(['products', 'stocks']);
            UI.closeModal();
            UI.toast(`${type === 'in' ? 'Entr�e' : 'Sortie'} de ${qty} unit�(s) enregistr�e`, 'success');
            App.rerender();
        },

        // Modal d'inventaire
        showStockInventoryModal() {
            const products = this.getProductsOptimized();
            const posId = CORE.state.currentUser?.pos;
            
            UI.modal('��Ÿ?� Lancer un Inventaire', `
                <div class="space-y-4">
                    <div class="p-4 bg-purple-50 border border-purple-200 rounded-2xl">
                        <div class="font-black text-purple-900 mb-2">�?� propos de l'inventaire</div>
                        <div class="text-sm text-purple-700">L'inventaire permet de recenser et ajuster les stocks r�els. ${products.length} produits seront inclus.</div>
                    </div>
                    
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 p-4 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50">
                            <input type="radio" name="inventory_type" value="full" checked class="w-4 h-4">
                            <div>
                                <div class="font-black text-slate-900">Inventaire complet</div>
                                <div class="text-xs text-slate-500">Tous les produits (${products.length})</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-4 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50">
                            <input type="radio" name="inventory_type" value="alerts" class="w-4 h-4">
                            <div>
                                <div class="font-black text-slate-900">Produits en alerte uniquement</div>
                                <div class="text-xs text-slate-500">${products.filter(p => (p.stock || 0) <= (p.minStock || 0)).length} produits</div>
                            </div>
                        </label>
                    </div>
                    
                    <div class="pt-4 border-t">
                        <button onclick="GestionnaireModule.exportInventorySheet()" class="w-full py-3 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition flex items-center justify-center gap-2">
                            <i data-lucide="download" class="w-5 h-5"></i>
                            T�l�charger feuille d'inventaire (CSV)
                        </button>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            lucide.createIcons();
        },

        exportInventorySheet() {
            const products = this.getProductsOptimized();
            const posId = CORE.state.currentUser?.pos;
            const pos = posId ? CORE.getPOS(posId) : null;
            const now = new Date().toLocaleDateString('fr-FR');
            
            let csv = 'ID,Produit,Code-barres,Cat�gorie,Stock syst��me,Stock r�el (�� compl�ter),�cart,Notes\n';
            products.forEach(p => {
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                csv += `${p.id},"${(p.name || '').replace(/"/g, '""')}","${p.barcode || ''}","${CORE.getCategory(p.categoryId)?.name || ''}",${stock},,,\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `inventaire_${pos?.name || 'pos'}_${now.replace(/\//g, '-')}.csv`;
            link.click();
            
            UI.toast("Feuille d'inventaire t�l�charg�e", 'success');
        },

        // Modal de r�appro group�e
        showBulkRestockModal() {
            const products = this.getProductsOptimized().filter(p => {
                const stock = p.stock || 0;
                return stock <= (p.minStock || 0);
            });
            
            if (products.length === 0) {
                return UI.toast('Aucun produit en alerte de stock', 'info');
            }
            
            UI.modal('��Ÿšš R�approvisionnement Group�', `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                        <div class="font-black text-amber-900">${products.length} produit(s) en alerte</div>
                        <div class="text-sm text-amber-700">S�lectionnez les produits �� r�approvisionner</div>
                    </div>
                    
                    <div class="space-y-2">
                        ${products.map(p => {
                            const stock = p.stock || 0;
                            const minStock = p.minStock || 0;
                            const toOrder = Math.max(0, minStock * 2 - stock);
                            return `
                            <div class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl hover:bg-slate-50">
                                <input type="checkbox" id="restock_${p.id}" checked class="w-4 h-4 rounded">
                                <div class="flex-1">
                                    <div class="font-bold text-slate-900">${p.name}</div>
                                    <div class="text-xs text-slate-500">Stock: ${stock} / Min: ${minStock}</div>
                                </div>
                                <input type="number" id="restock_qty_${p.id}" value="${toOrder}" min="1" class="w-20 px-3 py-2 border border-slate-200 rounded-lg text-center font-bold">
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Appliquer r�appro', onclick: 'GestionnaireModule.applyBulkRestock()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        applyBulkRestock() {
            const products = this.getProductsOptimized().filter(p => (p.stock || 0) <= (p.minStock || 0));
            let count = 0;
            
            products.forEach(p => {
                const checkbox = document.getElementById(`restock_${p.id}`);
                const qtyInput = document.getElementById(`restock_qty_${p.id}`);
                
                if (checkbox?.checked && qtyInput) {
                    const qty = parseInt(qtyInput.value) || 0;
                    if (qty > 0) {
                        const newStock = (p.stock || 0) + qty;
                        CORE.update('products', p.id, { stock: newStock });
                        CORE.recordStockMovement({
                            productId: p.id,
                            type: 'in',
                            qty: qty,
                            note: 'R�approvisionnement group�',
                            posId: CORE.state.currentUser?.pos,
                            userName: CORE.state.currentUser?.name
                        });
                        count++;
                    }
                }
            });
            
            this.invalidateCache(['products', 'stocks']);
            UI.closeModal();
            UI.toast(`${count} produit(s) r�approvisionn�(s)`, 'success');
            App.rerender();
        },

        showProductDetailModal(productId) {
            const p = CORE.db.products.find(x => x.id === productId);
            if (!p) return UI.toast('Produit introuvable', 'error');
            
            const posId = CORE.state.currentUser?.pos;
            const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
            const movements = (CORE.db.stockMovements || [])
                .filter(m => m.productId === productId)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 10);
            
            UI.modal(`��Ÿ? � ${p.name}`, `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-slate-50 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase">Prix</div>
                            <div class="text-2xl font-black text-slate-900 mt-1">${CORE.formatPrice(p.price || 0)}</div>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-2xl">
                            <div class="text-xs font-black text-blue-600 uppercase">Stock</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${stock}</div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-slate-50 rounded-2xl">
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><span class="font-bold text-slate-500">Cat�gorie:</span> ${CORE.getCategory(p.categoryId)?.name || '�� ?��'}</div>
                            <div><span class="font-bold text-slate-500">Code-barres:</span> ${p.barcode || '�� ?��'}</div>
                            <div><span class="font-bold text-slate-500">Stock min:</span> ${p.minStock || 0}</div>
                            <div><span class="font-bold text-slate-500">Valeur:</span> ${CORE.formatPrice(stock * (p.price || 0))}</div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="font-black text-slate-900 mb-3">Derniers mouvements</div>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            ${movements.length === 0 ? '<div class="text-slate-400 text-sm">Aucun mouvement</div>' :
                            movements.map(m => `
                                <div class="flex items-center gap-3 p-2 rounded-lg ${m.type === 'in' ? 'bg-emerald-50' : m.type === 'out' ? 'bg-red-50' : 'bg-blue-50'}">
                                    <span class="font-black ${m.type === 'in' ? 'text-emerald-600' : m.type === 'out' ? 'text-red-600' : 'text-blue-600'}">${m.type === 'in' ? '+' : '-'}${m.qty}</span>
                                    <span class="flex-1 text-sm text-slate-600">${m.note || m.ref || '�� ?��'}</span>
                                    <span class="text-xs text-slate-400">${CORE.formatDate(m.createdAt)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' },
                { label: 'Entr�e stock', onclick: `UI.closeModal();GestionnaireModule.showQuickStockModal(${productId})`, class: 'px-4 py-2 bg-emerald-600 text-white font-bold rounded-xl' }
            ]);
        },

        // ========== NOUVELLES FONCTIONS STOCK ==========

        showAddProductModal() {
            if (!CORE.hasPermission('products.create')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const posId = CORE.state.currentUser?.pos || 1;
            // Filtrer les cat�gories pour le POS du gestionnaire
            const categories = (CORE.db.categories || []).filter(c => !c.posId || c.posId == posId);
            
            UI.modal('��ž� Nouveau Produit', `
                <div class="space-y-4">
                    <div class="p-4 bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 rounded-xl">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center">
                                <i data-lucide="package-plus" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-emerald-800">Ajouter un nouveau produit</div>
                                <div class="text-xs text-emerald-600">Remplissez les informations du produit</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-black text-slate-700 mb-2">Nom du produit *</label>
                            <input type="text" id="new_product_name" placeholder="Ex: T-shirt Nike" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium">
                        </div>
                        <div>
                            <label class="block text-sm font-black text-slate-700 mb-2">Code/SKU</label>
                            <input type="text" id="new_product_code" placeholder="Ex: TSH-001" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium">
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-black text-slate-700">Cat�gorie</label>
                                <button type="button" onclick="GestionnaireModule.showNewCategoryModal()" class="text-xs px-2.5 py-1 bg-emerald-100 text-emerald-700 font-black rounded-lg hover:bg-emerald-200 transition">+ Nouvelle</button>
                            </div>
                            <select id="new_product_category" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold">
                                <option value="">Sans cat�gorie</option>
                                ${categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-black text-slate-700 mb-2">Prix d'achat</label>
                            <input type="number" id="new_product_cost" min="0" placeholder="0" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold">
                        </div>
                        <div>
                            <label class="block text-sm font-black text-slate-700 mb-2">Prix de vente *</label>
                            <input type="number" id="new_product_price" min="0" placeholder="0" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold">
                        </div>
                        <div>
                            <label class="block text-sm font-black text-slate-700 mb-2">Stock initial</label>
                            <input type="number" id="new_product_stock" min="0" value="0" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold">
                        </div>
                        <div>
                            <label class="block text-sm font-black text-slate-700 mb-2">Stock minimum</label>
                            <input type="number" id="new_product_min" min="0" value="5" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-black text-slate-700 mb-2">Description</label>
                            <textarea id="new_product_desc" placeholder="Description du produit..." rows="2" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium"></textarea>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Cr�er le produit', onclick: 'GestionnaireModule.saveNewProduct()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' }
            ]);
            setTimeout(() => lucide.createIcons(), 50);
        },

        saveNewProduct() {
            if (!CORE.hasPermission('products.create')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const name = document.getElementById('new_product_name')?.value?.trim();
            const code = document.getElementById('new_product_code')?.value?.trim() || '';
            const categoryId = parseInt(document.getElementById('new_product_category')?.value) || null;
            const cost = parseFloat(document.getElementById('new_product_cost')?.value) || 0;
            const price = parseFloat(document.getElementById('new_product_price')?.value) || 0;
            const stock = parseInt(document.getElementById('new_product_stock')?.value) || 0;
            const minStock = parseInt(document.getElementById('new_product_min')?.value) || 5;
            const description = document.getElementById('new_product_desc')?.value?.trim() || '';
            
            if (!name) return UI.toast('Le nom du produit est requis', 'warning');
            if (price <= 0) return UI.toast('Le prix de vente doit ��tre sup�rieur �� 0', 'warning');
            
            const posId = CORE.state.currentUser?.pos || 1;
            const newProduct = {
                id: Math.max(...(CORE.db.products || []).map(p => p.id || 0), 0) + 1,
                name,
                code,
                categoryId,
                costPrice: cost,
                price,
                stock,
                minStock,
                description,
                posId,
                createdAt: new Date().toISOString(),
                createdBy: CORE.state.currentUser?.id
            };
            
            CORE.db.products.push(newProduct);
            CORE.save();
            this.invalidateCache('products');
            
            // Enregistrer dans le journal d'audit
            CORE.db.auditLogs = CORE.db.auditLogs || [];
            CORE.db.auditLogs.push({
                id: 'AUDIT-' + Date.now(),
                timestamp: new Date().toISOString(),
                userId: CORE.state.currentUser?.id,
                userName: CORE.state.currentUser?.name || 'Syst��me',
                userRole: CORE.state.currentUser?.role || 'gestionnaire',
                posId: posId,
                action: 'create',
                entity: 'product',
                entityId: newProduct.id,
                entityName: newProduct.name,
                details: 'Cr�� avec code: ' + (code || 'N/A') + ', Prix: ' + price + ' FC',
                status: 'recorded'
            });
            
            UI.closeModal();
            UI.toast('Produit cr�� avec succ��s', 'success');
            App.rerender();
        },

        showNewCategoryModal() {
            if (!CORE.hasPermission('products.create')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            // Sauvegarder les valeurs actuelles du formulaire de produit
            const savedProductForm = {
                name: document.getElementById('new_product_name')?.value || '',
                code: document.getElementById('new_product_code')?.value || '',
                category: document.getElementById('new_product_category')?.value || '',
                cost: document.getElementById('new_product_cost')?.value || '',
                price: document.getElementById('new_product_price')?.value || '',
                stock: document.getElementById('new_product_stock')?.value || '',
                minStock: document.getElementById('new_product_min')?.value || '',
                description: document.getElementById('new_product_desc')?.value || ''
            };
            // Stocker dans window pour que saveNewCategory puisse y acc�der
            window.savedProductFormData = savedProductForm;
            
            UI.modal('��ž� Nouvelle Cat�gorie', `
                <div class="space-y-4">
                    <div class="p-4 bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-xl">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center">
                                <i data-lucide="plus" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-purple-800">Cr�er une nouvelle cat�gorie</div>
                                <div class="text-xs text-purple-600">Ajoutez une cat�gorie pour organiser les produits</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-black text-slate-700 mb-2">Nom de la cat�gorie *</label>
                            <input type="text" id="new_category_name" placeholder="Ex: �lectronique, Cosm�tiques..." class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-black text-slate-700 mb-2">Ic��ne (optionnel)</label>
                            <input type="text" id="new_category_icon" placeholder="Ex: package, star, heart..." class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <div class="text-xs text-slate-500 mt-1">Ic��nes disponibles: package, star, heart, shopping-bag, tag, zap, et autres ic��nes Lucide</div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Cr�er la cat�gorie', onclick: 'GestionnaireModule.saveNewCategory()', class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700' }
            ]);
            setTimeout(() => lucide.createIcons(), 50);
        },

        saveNewCategory() {
            if (!CORE.hasPermission('products.create')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const name = document.getElementById('new_category_name')?.value?.trim();
            const icon = document.getElementById('new_category_icon')?.value?.trim() || 'package';
            const posId = CORE.state.currentUser?.pos || 1;
            
            if (!name) return UI.toast('Le nom de la cat�gorie est requis', 'warning');
            if (name.length < 2) return UI.toast('Le nom doit contenir au moins 2 caract��res', 'warning');
            
            // V�rifier que le nom n'existe pas d�j�� pour ce POS
            const existingInPos = (CORE.db.categories || []).filter(c => !c.posId || c.posId == posId);
            if (existingInPos.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                return UI.toast('Cette cat�gorie existe d�j�� dans ce POS', 'warning');
            }
            
            const newCategory = {
                id: Math.max(...(CORE.db.categories || []).map(c => c.id || 0), 0) + 1,
                name,
                icon,
                posId: posId,
                createdAt: new Date().toISOString(),
                createdBy: CORE.state.currentUser?.id
            };
            
            if (!CORE.db.categories) CORE.db.categories = [];
            CORE.db.categories.push(newCategory);
            CORE.save();
            
            UI.toast('���? � Cat�gorie "' + name + '" cr��e!', 'success');
            
            // Fermer le modal de cat�gorie et revenir au modal de produit
            setTimeout(() => {
                UI.goBack();
                
                // Apr��s la restauration du modal, restaurer les valeurs sauvegard�es et mettre �� jour le select
                setTimeout(() => {
                    const categories = (CORE.db.categories || []).filter(c => !c.posId || c.posId == posId);
                    const select = document.getElementById('new_product_category');
                    
                    if (select) {
                        select.innerHTML = '<option value="">Sans cat�gorie</option>' + 
                                          categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                        // S�lectionner la nouvelle cat�gorie
                        select.value = newCategory.id;
                    }
                    
                    // Restaurer les valeurs sauvegard�es des autres champs
                    if (window.savedProductFormData) {
                        const data = window.savedProductFormData;
                        if (document.getElementById('new_product_name')) document.getElementById('new_product_name').value = data.name;
                        if (document.getElementById('new_product_code')) document.getElementById('new_product_code').value = data.code;
                        if (document.getElementById('new_product_cost')) document.getElementById('new_product_cost').value = data.cost;
                        if (document.getElementById('new_product_price')) document.getElementById('new_product_price').value = data.price;
                        if (document.getElementById('new_product_stock')) document.getElementById('new_product_stock').value = data.stock;
                        if (document.getElementById('new_product_min')) document.getElementById('new_product_min').value = data.minStock;
                        if (document.getElementById('new_product_desc')) document.getElementById('new_product_desc').value = data.description;
                        // Nettoyer
                        window.savedProductFormData = null;
                    }
                }, 50);
            }, 50);
        },

        exportStockCSV() {
            const posId = CORE.state.currentUser?.pos || 1;
            const products = this.getProductsOptimized();
            const categories = (CORE.db.categories || []).filter(c => !c.posId || c.posId == posId);
            
            let csv = 'sep=,\n';
            csv += 'ID,Code,Nom,Categorie,Stock,Stock Min,Prix Achat,Prix Vente,Valeur Stock,Statut\n';
            
            products.forEach(p => {
                const cat = categories.find(c => c.id === p.categoryId);
                const value = (p.stock || 0) * (p.price || 0);
                const status = (p.stock || 0) <= 0 ? 'Rupture' : (p.stock || 0) <= (p.minStock || 0) ? 'Critique' : 'OK';
                csv += `${p.id},"${p.code || ''}","${p.name || ''}","${cat?.name || 'Sans categorie'}",${p.stock || 0},${p.minStock || 0},${p.costPrice || 0},${p.price || 0},${value},"${status}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'stock_export_' + new Date().toISOString().slice(0,10) + '.csv';
            link.click();
            
            UI.toast('Export CSV termin� (' + products.length + ' produits)', 'success');
        },

        showBulkReorderModal() {
            const products = this.getProductsOptimized();
            const lowStock = products.filter(p => (p.stock || 0) <= (p.minStock || 0));
            
            UI.modal('��Ÿ�? R�approvisionnement en Masse', `
                <div class="space-y-4">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-xl">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-amber-500 rounded-xl flex items-center justify-center">
                                <i data-lucide="alert-triangle" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-amber-800">${lowStock.length} produit(s) �� r�approvisionner</div>
                                <div class="text-xs text-amber-600">S�lectionnez les produits et quantit�s</div>
                            </div>
                        </div>
                    </div>
                    
                    ${lowStock.length === 0 ? `
                        <div class="text-center py-8 text-slate-400">
                            <i data-lucide="check-circle" class="w-16 h-16 mx-auto mb-3 text-emerald-400"></i>
                            <div class="font-bold text-emerald-600">Tous les stocks sont OK!</div>
                            <div class="text-sm">Aucun produit ne n�cessite de r�approvisionnement</div>
                        </div>
                    ` : `
                        <div class="space-y-3 max-h-[50vh] overflow-y-auto">
                            ${lowStock.map(p => {
                                const deficit = Math.max(0, (p.minStock || 5) * 2 - (p.stock || 0));
                                return `
                                <div class="flex items-center gap-4 p-4 bg-white border border-slate-200 rounded-xl">
                                    <input type="checkbox" id="reorder_${p.id}" checked class="w-5 h-5 rounded border-slate-300 text-emerald-600">
                                    <div class="flex-1">
                                        <div class="font-bold text-slate-900">${p.name}</div>
                                        <div class="text-xs text-slate-500">Stock: ${p.stock || 0} / Min: ${p.minStock || 0}</div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-slate-500">Qt�:</span>
                                        <input type="number" id="reorder_qty_${p.id}" value="${deficit}" min="1" class="w-20 px-3 py-2 border border-slate-200 rounded-lg font-bold text-center">
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-xl text-sm text-blue-700">
                            <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                            Les quantit�s sugg�r�es ram��nent le stock �� 2x le minimum
                        </div>
                    `}
                </div>
            `, lowStock.length > 0 ? [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Appliquer le r�approvisionnement', onclick: 'GestionnaireModule.applyBulkReorder()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl' }
            ] : [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            setTimeout(() => lucide.createIcons(), 50);
        },

        applyBulkReorder() {
            const products = this.getProductsOptimized();
            let updated = 0;
            
            products.forEach(p => {
                const checkbox = document.getElementById('reorder_' + p.id);
                const qtyInput = document.getElementById('reorder_qty_' + p.id);
                
                if (checkbox?.checked && qtyInput) {
                    const qty = parseInt(qtyInput.value) || 0;
                    if (qty > 0) {
                        p.stock = (p.stock || 0) + qty;
                        CORE.recordStockMovement(p.id, qty, 'in', 'R�appro masse', CORE.state.currentUser?.pos);
                        updated++;
                    }
                }
            });
            
            if (updated > 0) {
                CORE.save();
                this.invalidateCache();
                UI.closeModal();
                UI.toast(updated + ' produit(s) r�approvisionn�s', 'success');
                App.rerender();
            } else {
                UI.toast('Aucun produit s�lectionn�', 'warning');
            }
        },

        showTransferStockModal() {
            const products = CORE.db.products || [];
            const posList = CORE.db.pointsOfSale || [];
            const currentPosId = CORE.state.currentUser?.pos;
            
            if (posList.length < 2) {
                return UI.toast('Vous devez avoir au moins 2 POS pour transf�rer du stock', 'warning');
            }

            // POS source = POS actuel du gestionnaire
            const sourcePos = CORE.getPOS(currentPosId) || posList[0];
            const otherPos = posList.filter(p => p.id !== sourcePos.id);

            // Calculer les stats
            const stockStats = {};
            posList.forEach(pos => {
                const posProducts = products.filter(p => (CORE.getProductStock(p.id, pos.id) || 0) > 0);
                const totalStock = posProducts.reduce((sum, p) => sum + (CORE.getProductStock(p.id, pos.id) || 0), 0);
                const totalValue = posProducts.reduce((sum, p) => sum + ((CORE.getProductStock(p.id, pos.id) || 0) * (p.price || 0)), 0);
                const criticalCount = posProducts.filter(p => (CORE.getProductStock(p.id, pos.id) || 0) <= (p.minStock || 0)).length;
                stockStats[pos.id] = { totalStock, totalValue, criticalCount, productCount: posProducts.length };
            });

            // Suggestions intelligentes
            const suggestions = [];
            otherPos.forEach((destPos) => {
                products.forEach(p => {
                    const srcStock = CORE.getProductStock(p.id, sourcePos.id) || 0;
                    const dstStock = CORE.getProductStock(p.id, destPos.id) || 0;
                    const minStock = p.minStock || 0;
                    const destTarget = Math.max(minStock * 2, minStock + 20);
                    const destDeficit = Math.max(0, destTarget - dstStock);
                    
                    if (srcStock <= 0 || destDeficit <= 0) return;
                    
                    const suggestedQty = Math.min(srcStock, destDeficit);
                    suggestions.push({
                        productId: p.id,
                        productName: p.name,
                        destPosId: destPos.id,
                        destPosName: destPos.name,
                        sourceStock: srcStock,
                        destStock: dstStock,
                        minStock,
                        suggestedQty,
                        severity: dstStock <= Math.max(1, minStock * 0.5) ? 'critical' : 'low'
                    });
                });
            });

            suggestions.sort((a, b) => {
                if (a.severity !== b.severity) return a.severity === 'critical' ? -1 : 1;
                return b.suggestedQty - a.suggestedQty;
            });

            const topSuggestions = suggestions.slice(0, 6);
            const defaultDestPos = otherPos[0] || posList[0];
            const productsWithStock = products.filter(p => (CORE.getProductStock(p.id, sourcePos.id) || 0) > 0);
            const defaultProduct = productsWithStock[0];
            const sourceStats = stockStats[sourcePos.id] || {};

            const html = `
                <div class="space-y-5 max-h-[85vh] overflow-y-auto">
                    <!-- Header avec stats -->
                    <div class="p-4 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl text-white">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <i data-lucide="arrow-left-right" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <div class="font-black text-lg">Transfert depuis ${sourcePos.name}</div>
                                <div class="text-sm opacity-90">Envoyez du stock vers un autre point de vente</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="p-3 bg-white/10 rounded-xl text-center">
                                <div class="text-2xl font-black">${sourceStats.totalStock?.toLocaleString() || 0}</div>
                                <div class="text-xs opacity-80">Unit�s disponibles</div>
                            </div>
                            <div class="p-3 bg-white/10 rounded-xl text-center">
                                <div class="text-2xl font-black">${CORE.formatPrice ? CORE.formatPrice(sourceStats.totalValue || 0) : (sourceStats.totalValue || 0).toLocaleString() + ' F'}</div>
                                <div class="text-xs opacity-80">Valeur stock</div>
                            </div>
                            <div class="p-3 bg-white/10 rounded-xl text-center">
                                <div class="text-2xl font-black">${suggestions.length}</div>
                                <div class="text-xs opacity-80">Opportunit�s</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                        <!-- Formulaire de transfert -->
                        <div class="space-y-4">
                            <div class="p-5 bg-white rounded-2xl border border-slate-200 shadow-sm space-y-4">
                                <div class="flex items-center gap-2 text-sm font-black text-slate-700 uppercase">
                                    <i data-lucide="send" class="w-4 h-4 text-purple-500"></i>
                                    Nouveau transfert
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Produit �� transf�rer</label>
                                    <select id="gtf_product" class="w-full px-4 py-3 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-purple-500">
                                        <option value="">S�lectionner un produit</option>
                                        ${productsWithStock.map(p => `
                                            <option value="${p.id}" ${p.id === defaultProduct?.id ? 'selected' : ''}>
                                                ${p.name} �� ?� � Stock: ${CORE.getProductStock(p.id, sourcePos.id) || 0}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">POS Destination</label>
                                    <select id="gtf_dest_pos" class="w-full px-4 py-3 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-purple-500">
                                        ${otherPos.map(pos => `
                                            <option value="${pos.id}" ${pos.id === defaultDestPos.id ? 'selected' : ''}>
                                                ${pos.name} ${stockStats[pos.id]?.criticalCount > 0 ? '��š ��� � �' : ''}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-3 text-center text-sm">
                                    <div class="p-3 rounded-xl bg-blue-50 border border-blue-200">
                                        <div class="text-xs font-bold text-blue-600 uppercase">Stock source</div>
                                        <div id="gtf_summary_source" class="text-2xl font-black text-blue-900">0</div>
                                    </div>
                                    <div class="p-3 rounded-xl bg-emerald-50 border border-emerald-200">
                                        <div class="text-xs font-bold text-emerald-600 uppercase">Stock dest.</div>
                                        <div id="gtf_summary_dest" class="text-2xl font-black text-emerald-900">0</div>
                                    </div>
                                </div>

                                <div class="p-3 rounded-xl bg-purple-50 border border-purple-200">
                                    <div class="flex items-center justify-between text-sm font-bold text-purple-700">
                                        <span>Stock source apr��s transfert</span>
                                        <span id="gtf_summary_after" class="text-lg">0</span>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Quantit� �� transf�rer</label>
                                    <div class="flex gap-2">
                                        <input id="gtf_qty" type="number" min="0" value="0" class="flex-1 px-4 py-3 rounded-xl border border-slate-200 font-black text-xl text-center bg-white focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div id="gtf_warning" class="mt-2 text-xs font-bold text-red-600 hidden">��š ��� � � Stock insuffisant</div>
                                </div>

                                <div class="flex flex-wrap gap-2">
                                    <button data-gtf-set="25" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300 transition">25%</button>
                                    <button data-gtf-set="50" class="px-3 py-2 rounded-xl bg-purple-600 text-white text-xs font-black hover:bg-purple-700 transition">50%</button>
                                    <button data-gtf-set="75" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300 transition">75%</button>
                                    <button data-gtf-set="+10" class="px-3 py-2 rounded-xl bg-slate-100 text-slate-600 text-xs font-black hover:bg-slate-200 transition">+10</button>
                                    <button data-gtf-set="+25" class="px-3 py-2 rounded-xl bg-slate-100 text-slate-600 text-xs font-black hover:bg-slate-200 transition">+25</button>
                                    <button data-gtf-set="clear" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-100 transition">Reset</button>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Motif du transfert</label>
                                    <textarea id="gtf_reason" class="w-full px-4 py-3 rounded-xl border border-slate-200 font-medium bg-white" rows="2" placeholder="Ex: R��quilibrage stocks, demande POS..."></textarea>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">��Ÿ?� Date d'arriv�e estim�e</label>
                                    <input type="datetime-local" id="gtf_eta" class="w-full px-4 py-3 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-purple-500">
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">��Ÿ? � Photos/Vid�os du stock (optionnel)</label>
                                    <div class="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center hover:border-purple-400 transition cursor-pointer" onclick="document.getElementById('gtf_media_input').click()">
                                        <input type="file" id="gtf_media_input" accept="image/*,video/*" multiple class="hidden" onchange="GestionnaireModule.handleTransferMediaUpload(event)">
                                        <i data-lucide="camera" class="w-8 h-8 text-slate-400 mx-auto mb-2"></i>
                                        <div class="text-sm text-slate-500">Cliquez pour ajouter photos/vid�os</div>
                                        <div class="text-xs text-slate-400">Preuve de l'�tat du stock avant envoi</div>
                                    </div>
                                    <div id="gtf_media_preview" class="grid grid-cols-4 gap-2 mt-3"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Suggestions et destinations -->
                        <div class="space-y-4">
                            ${topSuggestions.length > 0 ? `
                            <div class="p-5 bg-white rounded-2xl border border-slate-200 shadow-sm">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center gap-2 text-sm font-black text-slate-700 uppercase">
                                        <i data-lucide="sparkles" class="w-4 h-4 text-amber-500"></i>
                                        Suggestions intelligentes
                                    </div>
                                    <span class="text-xs font-bold text-slate-500">${topSuggestions.length} opportunit�s</span>
                                </div>
                                <div class="space-y-2 max-h-60 overflow-y-auto">
                                    ${topSuggestions.map(s => `
                                        <div class="p-3 rounded-xl border ${s.severity === 'critical' ? 'border-red-200 bg-red-50' : 'border-amber-200 bg-amber-50'} flex items-center justify-between gap-3 hover:shadow-md transition cursor-pointer" data-gtf-suggestion data-dest-id="${s.destPosId}" data-product-id="${s.productId}" data-suggested-qty="${s.suggestedQty}">
                                            <div class="flex-1 min-w-0">
                                                <div class="font-black text-slate-900 text-sm truncate">${s.productName}</div>
                                                <div class="text-xs text-slate-600">���? ${s.destPosName} (Stock: ${s.destStock}/${s.minStock})</div>
                                            </div>
                                            <div class="text-right flex-shrink-0">
                                                <div class="text-lg font-black ${s.severity === 'critical' ? 'text-red-600' : 'text-amber-600'}">${s.suggestedQty}</div>
                                                <div class="text-[10px] text-slate-500">sugg�r�</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}

                            <div class="p-5 bg-white rounded-2xl border border-slate-200 shadow-sm">
                                <div class="flex items-center gap-2 text-sm font-black text-slate-700 uppercase mb-4">
                                    <i data-lucide="map-pin" class="w-4 h-4 text-blue-500"></i>
                                    POS Destinations
                                </div>
                                <div class="space-y-2">
                                    ${otherPos.map(pos => {
                                        const stats = stockStats[pos.id] || {};
                                        return `
                                            <div class="p-3 rounded-xl ${stats.criticalCount > 0 ? 'bg-red-50 border border-red-200' : 'bg-slate-50 border border-slate-200'} hover:shadow-sm transition">
                                                <div class="flex items-center justify-between mb-1">
                                                    <span class="font-black text-slate-900">${pos.name}</span>
                                                    ${stats.criticalCount > 0 ? `<span class="px-2 py-0.5 bg-red-500 text-white text-[10px] font-black rounded-full">${stats.criticalCount} critique(s)</span>` : ''}
                                                </div>
                                                <div class="flex items-center justify-between text-xs text-slate-600">
                                                    <span>${stats.productCount || 0} produits</span>
                                                    <span class="font-bold">${stats.totalStock || 0} unit�s</span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            UI.modal('������ � � Transfert de Stock', html, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Effectuer le transfert', onclick: 'GestionnaireModule.executeStockTransfer()', class: 'px-5 py-2.5 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-black rounded-xl hover:from-purple-700 hover:to-indigo-700 transition' }
            ]);

            setTimeout(() => {
                const modalEl = document.querySelector('#modalContainer .slide-up');
                if (modalEl) {
                    modalEl.classList.remove('max-w-lg');
                    modalEl.classList.add('max-w-4xl');
                }
                lucide.createIcons();

                const destPosSelect = document.getElementById('gtf_dest_pos');
                const productSelect = document.getElementById('gtf_product');
                const qtyInput = document.getElementById('gtf_qty');
                const summarySource = document.getElementById('gtf_summary_source');
                const summaryDest = document.getElementById('gtf_summary_dest');
                const summaryAfter = document.getElementById('gtf_summary_after');
                const warning = document.getElementById('gtf_warning');
                const sourcePosId = CORE.state.currentUser?.pos || 1;

                const updateSummary = function() {
                    const productId = parseInt(productSelect?.value || 0, 10);
                    const destId = parseInt(destPosSelect?.value || 0, 10);
                    const qty = parseInt(qtyInput?.value || 0, 10);
                    
                    const sourceStock = CORE.getProductStock(productId, sourcePosId) || 0;
                    const destStock = CORE.getProductStock(productId, destId) || 0;
                    const newSourceStock = Math.max(0, sourceStock - qty);

                    if (summarySource) summarySource.textContent = sourceStock;
                    if (summaryDest) summaryDest.textContent = destStock;
                    if (summaryAfter) summaryAfter.textContent = newSourceStock + ' unit�s';
                    if (warning) warning.classList.toggle('hidden', qty <= sourceStock);
                };

                if (destPosSelect) destPosSelect.addEventListener('change', updateSummary);
                if (productSelect) productSelect.addEventListener('change', updateSummary);
                if (qtyInput) qtyInput.addEventListener('input', updateSummary);

                // Boutons de pourcentage
                document.querySelectorAll('[data-gtf-set]').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        const action = btn.getAttribute('data-gtf-set');
                        const productId = parseInt(productSelect?.value || 0, 10);
                        const sourceStock = CORE.getProductStock(productId, sourcePosId) || 0;

                        if (action === '25') qtyInput.value = Math.floor(sourceStock * 0.25);
                        else if (action === '50') qtyInput.value = Math.floor(sourceStock * 0.5);
                        else if (action === '75') qtyInput.value = Math.floor(sourceStock * 0.75);
                        else if (action === 'clear') qtyInput.value = 0;
                        else if (action.startsWith('+')) qtyInput.value = parseInt(qtyInput.value || 0, 10) + parseInt(action.substring(1), 10);
                        
                        updateSummary();
                    });
                });

                // Suggestions cliquables
                document.querySelectorAll('[data-gtf-suggestion]').forEach(function(el) {
                    el.addEventListener('click', function() {
                        const destId = el.getAttribute('data-dest-id');
                        const productId = el.getAttribute('data-product-id');
                        const suggestedQty = el.getAttribute('data-suggested-qty');
                        
                        if (destPosSelect) destPosSelect.value = destId;
                        if (productSelect) productSelect.value = productId;
                        if (qtyInput) qtyInput.value = suggestedQty;
                        updateSummary();
                    });
                });

                updateSummary();
            }, 100);
        },

        // M�dia pour le transfert sortant
        _transferMedia: [],
        
        handleTransferMediaUpload(event) {
            const files = event.target.files;
            if (!files.length) return;
            
            const preview = document.getElementById('gtf_media_preview');
            if (!preview) return;
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                const isVideo = file.type.startsWith('video/');
                
                reader.onload = (e) => {
                    this._transferMedia.push({ 
                        type: isVideo ? 'video' : 'image', 
                        data: e.target.result, 
                        name: file.name 
                    });
                    
                    const div = document.createElement('div');
                    div.className = 'rounded-lg overflow-hidden border border-slate-200 relative';
                    if (isVideo) {
                        div.innerHTML = `<video src="${e.target.result}" class="w-full h-16 object-cover"></video>
                            <div class="absolute inset-0 flex items-center justify-center bg-black/30">
                                <i data-lucide="play" class="w-6 h-6 text-white"></i>
                            </div>`;
                    } else {
                        div.innerHTML = `<img src="${e.target.result}" class="w-full h-16 object-cover">`;
                    }
                    preview.appendChild(div);
                    lucide.createIcons();
                };
                reader.readAsDataURL(file);
            });
        },

        executeStockTransfer() {
            const productId = parseInt(document.getElementById('gtf_product')?.value || 0);
            const destPosId = parseInt(document.getElementById('gtf_dest_pos')?.value || 0);
            const qty = parseInt(document.getElementById('gtf_qty')?.value || 0);
            const reason = document.getElementById('gtf_reason')?.value?.trim() || 'Transfert inter-POS';
            const eta = document.getElementById('gtf_eta')?.value || null;
            const media = this._transferMedia || [];
            const sourcePosId = CORE.state.currentUser?.pos;
            
            if (!productId) return UI.toast('S�lectionnez un produit', 'warning');
            if (!destPosId) return UI.toast('S�lectionnez une destination', 'warning');
            if (qty <= 0) return UI.toast('La quantit� doit ��tre sup�rieure �� 0', 'warning');
            
            const product = CORE.getProduct ? CORE.getProduct(productId) : CORE.db.products.find(p => p.id === productId);
            const sourcePos = CORE.getPOS ? CORE.getPOS(sourcePosId) : (CORE.db.pointsOfSale || []).find(p => p.id === sourcePosId);
            const destPos = CORE.getPOS ? CORE.getPOS(destPosId) : (CORE.db.pointsOfSale || []).find(p => p.id === destPosId);
            
            if (!product || !sourcePos || !destPos) {
                return UI.toast('Donn�es invalides', 'error');
            }
            
            // V�rifier le stock source
            const sourceStock = CORE.getProductStock ? (CORE.getProductStock(productId, sourcePosId) || 0) : (product.stock || 0);
            if (sourceStock < qty) {
                return UI.toast('Stock insuffisant (disponible: ' + sourceStock + ')', 'error');
            }
            
            // NOUVEAU: Cr�er un transfert en attente au lieu d'appliquer directement
            const transferId = 'TRF-' + Date.now().toString(36).toUpperCase();
            CORE.db.stockTransfers = CORE.db.stockTransfers || [];
            
            const transfer = {
                id: transferId,
                productId: productId,
                productName: product.name,
                qty: qty,
                sourcePosId: sourcePosId,
                sourcePosName: sourcePos.name,
                destPosId: destPosId,
                destPosName: destPos.name,
                reason: reason,
                status: 'pending', // pending, accepted, rejected
                createdBy: CORE.state.currentUser?.id,
                createdByName: CORE.state.currentUser?.name || 'Inconnu',
                createdAt: new Date().toISOString(),
                // Nouvelles infos: date d'arriv�e et m�dias d'envoi
                estimatedArrival: eta,
                sendMedia: media, // Photos/vid�os du stock avant envoi
                // Champs pour la r�ception
                receivedBy: null,
                receivedByName: null,
                receivedAt: null,
                receptionNote: null,
                receptionMedia: [], // URLs des images/vid�os de preuve
                rejectionReason: null
            };
            
            CORE.db.stockTransfers.push(transfer);
            
            // D�duire le stock source imm�diatement (r�serv� pour transfert)
            const newSourceStock = sourceStock - qty;
            if (CORE.setProductStock) {
                CORE.setProductStock(productId, sourcePosId, newSourceStock);
            }
            
            // Enregistrer le mouvement de sortie (r�servation)
            if (CORE.recordStockMovement) {
                CORE.recordStockMovement({
                    productId: productId,
                    type: 'out',
                    qty: qty,
                    ref: transferId,
                    note: reason + ' - Transfert en attente vers ' + destPos.name,
                    posId: sourcePosId
                });
            }
            
            // Cr�er une notification pour le POS destinataire
            CORE.db.notifications = CORE.db.notifications || [];
            CORE.db.notifications.push({
                id: 'NOTIF-' + Date.now(),
                type: 'transfer_incoming',
                title: '��Ÿ? � Transfert entrant',
                message: qty + ' x ' + product.name + ' en provenance de ' + sourcePos.name,
                details: eta ? 'Arriv�e estim�e: ' + new Date(eta).toLocaleString('fr-FR') : '',
                transferId: transferId,
                posId: destPosId,
                createdAt: new Date().toISOString(),
                read: false,
                hasMedia: media.length > 0,
                mediaCount: media.length
            });
            
            // R�initialiser les m�dias temporaires
            this._transferMedia = [];
            
            // Enregistrer dans le journal d'audit
            CORE.db.auditLogs = CORE.db.auditLogs || [];
            CORE.db.auditLogs.push({
                id: 'AUDIT-' + Date.now(),
                timestamp: new Date().toISOString(),
                userId: CORE.state.currentUser?.id,
                userName: CORE.state.currentUser?.name || 'Syst��me',
                userRole: CORE.state.currentUser?.role || 'gestionnaire',
                posId: sourcePosId,
                action: 'transfer_out',
                entity: 'stock',
                entityId: transferId,
                entityName: product.name,
                details: 'Transfert de ' + qty + ' unit�s vers ' + destPos.name,
                status: 'recorded'
            });
            
            CORE.save();
            this.invalidateCache();
            UI.closeModal();
            UI.toast('��Ÿ? � Transfert envoy�! En attente de r�ception par ' + destPos.name, 'success');
            App.rerender();
        },

        // ========== SYST�?ME DE R�CEPTION DES TRANSFERTS ==========
        
        getPendingIncomingTransfers() {
            const currentPosId = CORE.state.currentUser?.pos;
            return (CORE.db.stockTransfers || []).filter(t => 
                t.destPosId == currentPosId && t.status == 'pending'
            );
        },

        getPendingOutgoingTransfers() {
            const currentPosId = CORE.state.currentUser?.pos;
            return (CORE.db.stockTransfers || []).filter(t => 
                t.sourcePosId == currentPosId && t.status == 'pending'
            );
        },

        getTransferHistory() {
            const currentPosId = CORE.state.currentUser?.pos;
            return (CORE.db.stockTransfers || []).filter(t => 
                (t.destPosId == currentPosId || t.sourcePosId == currentPosId) && t.status != 'pending'
            ).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        },

        showPendingTransfersModal() {
            const incoming = this.getPendingIncomingTransfers();
            const outgoing = this.getPendingOutgoingTransfers();
            const currentPosName = CORE.getPOS(CORE.state.currentUser?.pos)?.name || 'Mon POS';
            
            const html = `
                <div class="space-y-5 max-h-[80vh] overflow-y-auto">
                    <!-- Alerte transferts entrants -->
                    ${incoming.length > 0 ? `
                    <div class="p-4 bg-gradient-to-r from-amber-500 to-orange-500 rounded-2xl text-white">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <i data-lucide="package-check" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <div class="font-black text-lg">��Ÿ? � ${incoming.length} transfert(s) �� r�ceptionner</div>
                                <div class="text-sm opacity-90">Validez la r�ception avec preuves</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Transferts entrants -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="download" class="w-5 h-5 text-emerald-600"></i>
                            <span class="font-black text-slate-900">Transferts entrants (�� r�ceptionner)</span>
                            <span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-black">${incoming.length}</span>
                        </div>
                        ${incoming.length === 0 ? `
                            <div class="text-center py-6 text-slate-400">
                                <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                <div>Aucun transfert en attente</div>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${incoming.map(t => `
                                    <div class="p-4 rounded-xl border-2 border-amber-300 bg-amber-50 hover:shadow-lg transition">
                                        <div class="flex items-start justify-between gap-4">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="font-black text-slate-900">${t.productName}</span>
                                                    <span class="px-2 py-0.5 bg-amber-500 text-white text-xs font-black rounded-full">EN ATTENTE</span>
                                                </div>
                                                <div class="text-2xl font-black text-amber-600 mb-2">${t.qty} unit�s</div>
                                                <div class="text-sm text-slate-600">
                                                    <div>��Ÿ? � De: <strong>${t.sourcePosName}</strong></div>
                                                    <div>��Ÿ? � Par: ${t.createdByName}</div>
                                                    <div>��Ÿ?� Envoy� le: ${new Date(t.createdAt).toLocaleString('fr-FR')}</div>
                                                    ${t.estimatedArrival ? `<div class="mt-1 px-2 py-1 bg-purple-100 text-purple-700 rounded-lg inline-block">��Ÿšš <strong>Arriv�e estim�e:</strong> ${new Date(t.estimatedArrival).toLocaleString('fr-FR')}</div>` : ''}
                                                    ${t.reason ? `<div class="mt-1">��Ÿ? � Motif: ${t.reason}</div>` : ''}
                                                </div>
                                                ${t.sendMedia && t.sendMedia.length > 0 ? `
                                                    <div class="mt-3">
                                                        <div class="text-xs font-bold text-slate-500 mb-2">��Ÿ? � Photos/vid�os du stock envoy� (${t.sendMedia.length})</div>
                                                        <div class="grid grid-cols-4 gap-2">
                                                            ${t.sendMedia.slice(0, 4).map(m => `
                                                                <div class="rounded-lg overflow-hidden border border-slate-200 relative cursor-pointer" onclick="window.open('${m.data}', '_blank')">
                                                                    ${m.type === 'video' ? `
                                                                        <video src="${m.data}" class="w-full h-12 object-cover"></video>
                                                                        <div class="absolute inset-0 flex items-center justify-center bg-black/30">
                                                                            <i data-lucide="play" class="w-4 h-4 text-white"></i>
                                                                        </div>
                                                                    ` : `
                                                                        <img src="${m.data}" class="w-full h-12 object-cover hover:opacity-80">
                                                                    `}
                                                                </div>
                                                            `).join('')}
                                                            ${t.sendMedia.length > 4 ? `<div class="flex items-center justify-center text-xs font-bold text-slate-500">+${t.sendMedia.length - 4}</div>` : ''}
                                                        </div>
                                                        <button onclick="GestionnaireModule.showSendMedia('${t.id}')" class="mt-2 text-xs text-purple-600 hover:underline font-bold">Voir toutes les photos/vid�os</button>
                                                    </div>
                                                ` : ''}
                                            </div>
                                            <div class="flex flex-col gap-2">
                                                <button onclick="GestionnaireModule.showReceiveTransferModal('${t.id}')" class="px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition flex items-center gap-2">
                                                    <i data-lucide="check-circle" class="w-4 h-4"></i> R�ceptionner
                                                </button>
                                                <button onclick="GestionnaireModule.showRejectTransferModal('${t.id}')" class="px-4 py-2 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition flex items-center gap-2">
                                                    <i data-lucide="x-circle" class="w-4 h-4"></i> Rejeter
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                    
                    <!-- Transferts sortants -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="upload" class="w-5 h-5 text-blue-600"></i>
                            <span class="font-black text-slate-900">Transferts sortants (en attente de r�ception)</span>
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-black">${outgoing.length}</span>
                        </div>
                        ${outgoing.length === 0 ? `
                            <div class="text-center py-6 text-slate-400">
                                <i data-lucide="send" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                <div>Aucun transfert en cours</div>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${outgoing.map(t => `
                                    <div class="p-4 rounded-xl border border-blue-200 bg-blue-50">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="font-black text-slate-900">${t.productName}</div>
                                                <div class="text-lg font-bold text-blue-600">${t.qty} unit�s ���? ${t.destPosName}</div>
                                                <div class="text-xs text-slate-500">Envoy� le ${new Date(t.createdAt).toLocaleString('fr-FR')}</div>
                                            </div>
                                            <div class="px-3 py-1.5 bg-blue-500 text-white text-xs font-black rounded-full flex items-center gap-1">
                                                <i data-lucide="clock" class="w-3 h-3"></i> En attente
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                    
                    <!-- Bouton historique -->
                    <button onclick="UI.closeModal();GestionnaireModule.showTransferHistoryModal()" class="w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition flex items-center justify-center gap-2">
                        <i data-lucide="history" class="w-4 h-4"></i> Voir l'historique des transferts
                    </button>
                </div>
            `;
            
            UI.modal('��Ÿ? � Gestion des Transferts', html, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            
            setTimeout(() => {
                const modalEl = document.querySelector('#modalContainer .slide-up');
                if (modalEl) {
                    modalEl.classList.remove('max-w-lg');
                    modalEl.classList.add('max-w-3xl');
                }
                lucide.createIcons();
            }, 50);
        },

        showReceiveTransferModal(transferId) {
            const transfer = (CORE.db.stockTransfers || []).find(t => t.id === transferId);
            if (!transfer) return UI.toast('Transfert introuvable', 'error');
            
            // Stocker temporairement les m�dias
            this._receptionMedia = [];
            
            const html = `
                <div class="space-y-5">
                    <div class="p-4 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-2xl text-white">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <i data-lucide="package-check" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <div class="font-black text-lg">R�ception de transfert</div>
                                <div class="text-sm opacity-90">Confirmez la r�ception avec preuves</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="text-slate-500">Produit</div>
                                <div class="font-black text-slate-900 text-lg">${transfer.productName}</div>
                            </div>
                            <div>
                                <div class="text-slate-500">Quantit�</div>
                                <div class="font-black text-emerald-600 text-2xl">${transfer.qty} unit�s</div>
                            </div>
                            <div>
                                <div class="text-slate-500">Provenance</div>
                                <div class="font-bold text-slate-900">${transfer.sourcePosName}</div>
                            </div>
                            <div>
                                <div class="text-slate-500">Envoy� par</div>
                                <div class="font-bold text-slate-900">${transfer.createdByName}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">��Ÿ? � Preuves de r�ception (photos/vid�os)</label>
                        <div class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center hover:border-emerald-400 transition cursor-pointer" onclick="document.getElementById('reception_media').click()">
                            <input type="file" id="reception_media" multiple accept="image/*,video/*" class="hidden" onchange="GestionnaireModule.handleReceptionMediaUpload(event)">
                            <i data-lucide="upload-cloud" class="w-10 h-10 mx-auto mb-2 text-slate-400"></i>
                            <div class="font-bold text-slate-600">Cliquez pour ajouter des photos/vid�os</div>
                            <div class="text-xs text-slate-400 mt-1">JPG, PNG, MP4 accept�s</div>
                        </div>
                        <div id="reception_media_preview" class="grid grid-cols-4 gap-2 mt-3"></div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">��Ÿ? � Note de r�ception</label>
                        <textarea id="reception_note" rows="2" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium" placeholder="Ex: Colis en bon �tat, quantit� v�rifi�e..."></textarea>
                    </div>
                    
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-xl">
                        <div class="flex items-start gap-3">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600 mt-0.5"></i>
                            <div class="text-sm text-amber-700">
                                <div class="font-bold">Important</div>
                                <div>En validant, le stock sera ajout� �� votre inventaire et le POS source recevra la confirmation.</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            UI.modal('���?� Valider la R�ception', html, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Confirmer la r�ception', onclick: `GestionnaireModule.confirmTransferReception('${transferId}')`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' }
            ]);
            
            setTimeout(() => lucide.createIcons(), 50);
        },

        handleReceptionMediaUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('reception_media_preview');
            if (!preview) return;
            
            this._receptionMedia = this._receptionMedia || [];
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const isVideo = file.type.startsWith('video/');
                    const mediaData = {
                        type: isVideo ? 'video' : 'image',
                        data: e.target.result,
                        name: file.name,
                        date: new Date().toISOString()
                    };
                    this._receptionMedia.push(mediaData);
                    
                    // Afficher la preview
                    const div = document.createElement('div');
                    div.className = 'relative rounded-lg overflow-hidden border border-slate-200';
                    if (isVideo) {
                        div.innerHTML = `
                            <video src="${e.target.result}" class="w-full h-20 object-cover"></video>
                            <div class="absolute inset-0 bg-black/30 flex items-center justify-center">
                                <i data-lucide="play-circle" class="w-8 h-8 text-white"></i>
                            </div>
                        `;
                    } else {
                        div.innerHTML = `<img src="${e.target.result}" class="w-full h-20 object-cover">`;
                    }
                    preview.appendChild(div);
                    lucide.createIcons();
                };
                reader.readAsDataURL(file);
            });
        },

        confirmTransferReception(transferId) {
            // Utiliser comparaison non-stricte pour trouver le transfert
            const transfer = (CORE.db.stockTransfers || []).find(t => t.id == transferId);
            if (!transfer) {
                console.error('Transfert introuvable:', transferId);
                return UI.toast('Transfert introuvable', 'error');
            }
            
            console.log('Transfert trouv�:', transfer);
            
            const note = document.getElementById('reception_note')?.value?.trim() || '';
            const media = this._receptionMedia || [];
            
            // S'assurer que les IDs sont coh�rents (comparer en tant que strings ou numbers)
            const productId = transfer.productId;
            const destPosId = parseInt(transfer.destPosId, 10);
            const sourcePosId = parseInt(transfer.sourcePosId, 10);
            const qty = parseInt(transfer.qty, 10) || 0;
            
            // Chercher le produit avec comparaison flexible (== au lieu de ===)
            let product = CORE.db.products.find(p => p.id == productId);
            
            console.log('Transfert r�ception - Recherche produit:', { productId, found: !!product, productsCount: CORE.db.products.length });
            
            // Si le produit n'existe pas, le cr�er �� partir des infos du transfert
            if (!product) {
                console.log('Produit non trouv�, cr�ation automatique...');
                
                // Cr�er le produit avec les informations disponibles
                const newProductId = Date.now();
                product = {
                    id: newProductId,
                    name: transfer.productName || 'Produit transf�r�',
                    price: 0,
                    category: null,
                    description: 'Produit cr�� automatiquement lors du transfert depuis ' + transfer.sourcePosName,
                    posStocks: {},
                    createdAt: new Date().toISOString(),
                    createdViaTransfer: true,
                    originalTransferId: transferId
                };
                
                CORE.db.products.push(product);
                console.log('Nouveau produit cr��:', product);
                
                UI.toast('��? ��� � � Nouveau produit cr��: ' + product.name, 'info');
            }
            
            // Mettre �� jour le transfert
            transfer.status = 'accepted';
            transfer.receivedBy = CORE.state.currentUser?.id;
            transfer.receivedByName = CORE.state.currentUser?.name || 'Inconnu';
            transfer.receivedAt = new Date().toISOString();
            transfer.receptionNote = note;
            transfer.receptionMedia = media;
            
            // Ajouter le stock au POS destinataire
            const destStock = (product.posStocks && product.posStocks[destPosId]) ? (product.posStocks[destPosId].stock || 0) : 0;
            const newDestStock = destStock + qty;
            
            console.log('Transfert r�ception - Mise �� jour stock:', { productId: product.id, destPosId, destStock, qty, newDestStock });
            
            // Mettre �� jour directement la structure posStocks
            if (!product.posStocks) product.posStocks = {};
            if (!product.posStocks[destPosId]) product.posStocks[destPosId] = { stock: 0, price: product.price || 0 };
            product.posStocks[destPosId].stock = Math.max(0, newDestStock);
            
            console.log('Stock apr��s mise �� jour:', product.posStocks[destPosId]);
            
            // Enregistrer le mouvement d'entr�e
            CORE.db.stockMovements = CORE.db.stockMovements || [];
            CORE.db.stockMovements.push({
                id: 'MOV-' + Date.now(),
                productId: product.id,
                productName: product.name,
                type: 'in',
                qty: qty,
                ref: transferId,
                note: 'R�ception transfert depuis ' + transfer.sourcePosName + (note ? ' - ' + note : ''),
                posId: destPosId,
                createdBy: CORE.state.currentUser?.id,
                createdByName: CORE.state.currentUser?.name,
                createdAt: new Date().toISOString()
            });
            
            // Notification au POS source avec preuves
            CORE.db.notifications = CORE.db.notifications || [];
            CORE.db.notifications.push({
                id: 'NOTIF-' + Date.now(),
                type: 'transfer_received',
                title: '���?� Transfert r�ceptionn�',
                message: qty + ' x ' + product.name + ' re��us par ' + transfer.destPosName,
                details: note ? 'Note: ' + note : '',
                transferId: transferId,
                posId: sourcePosId,
                createdAt: new Date().toISOString(),
                read: false,
                hasMedia: media.length > 0,
                mediaCount: media.length,
                receivedByName: CORE.state.currentUser?.name || 'Inconnu'
            });
            
            this._receptionMedia = [];
            
            // Marquer la notification entrante comme lue
            (CORE.db.notifications || []).forEach(n => {
                if (n.transferId == transferId && n.type === 'transfer_incoming') {
                    n.read = true;
                    n.processedAt = new Date().toISOString();
                }
            });
            
            // Enregistrer dans le journal d'audit
            CORE.db.auditLogs = CORE.db.auditLogs || [];
            CORE.db.auditLogs.push({
                id: 'AUDIT-' + Date.now(),
                timestamp: new Date().toISOString(),
                userId: CORE.state.currentUser?.id,
                userName: CORE.state.currentUser?.name || 'Syst��me',
                userRole: CORE.state.currentUser?.role || 'gestionnaire',
                posId: destPosId,
                action: 'transfer_in',
                entity: 'stock',
                entityId: transferId,
                entityName: product.name,
                details: 'R�ception de ' + qty + ' unit�s depuis ' + transfer.sourcePosName,
                status: 'recorded'
            });
            
            CORE.save();
            this.invalidateCache();
            UI.closeModal();
            UI.toast('���?� R�ception confirm�e! ' + qty + ' ' + product.name + ' ajout�s au stock', 'success');
            
            // Rafra��chir l'interface
            App.rerender();
            
            // Rouvrir le modal des transferts apr��s un d�lai
            setTimeout(() => this.showPendingTransfersModal(), 500);
        },

        showRejectTransferModal(transferId) {
            const transfer = (CORE.db.stockTransfers || []).find(t => t.id === transferId);
            if (!transfer) return UI.toast('Transfert introuvable', 'error');
            
            const html = `
                <div class="space-y-5">
                    <div class="p-4 bg-gradient-to-r from-red-500 to-rose-500 rounded-2xl text-white">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <i data-lucide="x-circle" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <div class="font-black text-lg">Rejeter le transfert</div>
                                <div class="text-sm opacity-90">Le stock sera retourn� au POS source</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <div class="font-black text-slate-900">${transfer.productName}</div>
                        <div class="text-lg font-bold text-red-600">${transfer.qty} unit�s de ${transfer.sourcePosName}</div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">��Ÿ? � Motif du rejet *</label>
                        <textarea id="rejection_reason" rows="3" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium" placeholder="Ex: Colis endommag�, quantit� incorrecte, produit non conforme..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">��Ÿ? � Photos du probl��me (optionnel)</label>
                        <div class="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center hover:border-red-400 transition cursor-pointer" onclick="document.getElementById('rejection_media').click()">
                            <input type="file" id="rejection_media" multiple accept="image/*" class="hidden" onchange="GestionnaireModule.handleRejectionMediaUpload(event)">
                            <i data-lucide="camera" class="w-8 h-8 mx-auto mb-1 text-slate-400"></i>
                            <div class="text-sm font-bold text-slate-600">Ajouter des photos</div>
                        </div>
                        <div id="rejection_media_preview" class="grid grid-cols-4 gap-2 mt-2"></div>
                    </div>
                </div>
            `;
            
            this._rejectionMedia = [];
            
            UI.modal('�� ��? Rejeter le Transfert', html, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Confirmer le rejet', onclick: `GestionnaireModule.confirmTransferRejection('${transferId}')`, class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700' }
            ]);
            
            setTimeout(() => lucide.createIcons(), 50);
        },

        handleRejectionMediaUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('rejection_media_preview');
            if (!preview) return;
            
            this._rejectionMedia = this._rejectionMedia || [];
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this._rejectionMedia.push({ type: 'image', data: e.target.result, name: file.name });
                    const div = document.createElement('div');
                    div.className = 'rounded-lg overflow-hidden border border-slate-200';
                    div.innerHTML = `<img src="${e.target.result}" class="w-full h-16 object-cover">`;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        },

        confirmTransferRejection(transferId) {
            // Utiliser comparaison non-stricte pour trouver le transfert
            const transfer = (CORE.db.stockTransfers || []).find(t => t.id == transferId);
            if (!transfer) {
                console.error('Transfert introuvable:', transferId);
                return UI.toast('Transfert introuvable', 'error');
            }
            
            const reason = document.getElementById('rejection_reason')?.value?.trim();
            if (!reason) return UI.toast('Veuillez indiquer le motif du rejet', 'warning');
            
            const media = this._rejectionMedia || [];
            
            // S'assurer que les IDs sont coh�rents
            const productId = transfer.productId;
            const sourcePosId = parseInt(transfer.sourcePosId, 10);
            const qty = parseInt(transfer.qty, 10) || 0;
            
            // Chercher le produit avec comparaison flexible
            const product = CORE.db.products.find(p => p.id == productId);
            if (!product) {
                console.error('Produit introuvable:', productId);
                return UI.toast('Produit introuvable', 'error');
            }
            
            // Mettre �� jour le transfert
            transfer.status = 'rejected';
            transfer.rejectedBy = CORE.state.currentUser?.id;
            transfer.rejectedByName = CORE.state.currentUser?.name || 'Inconnu';
            transfer.rejectedAt = new Date().toISOString();
            transfer.rejectionReason = reason;
            transfer.rejectionMedia = media;
            
            // Retourner le stock au POS source (mise �� jour directe posStocks)
            const sourceStock = CORE.getProductStock ? (CORE.getProductStock(productId, sourcePosId) || 0) : 0;
            const newSourceStock = sourceStock + qty;
            
            console.log('Transfert rejet - Retour stock:', { productId, sourcePosId, sourceStock, qty, newSourceStock });
            
            if (!product.posStocks) product.posStocks = {};
            if (!product.posStocks[sourcePosId]) product.posStocks[sourcePosId] = { stock: 0, price: product.price || 0 };
            product.posStocks[sourcePosId].stock = Math.max(0, newSourceStock);
            
            // Enregistrer le mouvement de retour
            CORE.db.stockMovements = CORE.db.stockMovements || [];
            CORE.db.stockMovements.push({
                id: 'MOV-' + Date.now(),
                productId: productId,
                productName: product.name,
                type: 'in',
                qty: qty,
                ref: transferId + '-RETURN',
                note: 'Retour transfert rejet� par ' + transfer.destPosName + ': ' + reason,
                posId: sourcePosId,
                createdBy: CORE.state.currentUser?.id,
                createdByName: CORE.state.currentUser?.name,
                createdAt: new Date().toISOString()
            });
            
            // Notification au POS source avec preuves
            CORE.db.notifications = CORE.db.notifications || [];
            CORE.db.notifications.push({
                id: 'NOTIF-' + Date.now(),
                type: 'transfer_rejected',
                title: '�� ��? Transfert rejet�',
                message: transfer.destPosName + ' a rejet� ' + qty + ' x ' + product.name,
                details: 'Motif: ' + reason,
                transferId: transferId,
                posId: sourcePosId,
                createdAt: new Date().toISOString(),
                read: false,
                hasMedia: media.length > 0,
                mediaCount: media.length,
                rejectedByName: CORE.state.currentUser?.name || 'Inconnu'
            });
            
            this._rejectionMedia = [];
            
            // Marquer la notification entrante comme lue
            (CORE.db.notifications || []).forEach(n => {
                if (n.transferId == transferId && n.type === 'transfer_incoming') {
                    n.read = true;
                    n.processedAt = new Date().toISOString();
                }
            });
            
            // Enregistrer dans le journal d'audit
            const destPosId = parseInt(transfer.destPosId, 10);
            CORE.db.auditLogs = CORE.db.auditLogs || [];
            CORE.db.auditLogs.push({
                id: 'AUDIT-' + Date.now(),
                timestamp: new Date().toISOString(),
                userId: CORE.state.currentUser?.id,
                userName: CORE.state.currentUser?.name || 'Syst��me',
                userRole: CORE.state.currentUser?.role || 'gestionnaire',
                posId: destPosId,
                action: 'transfer_reject',
                entity: 'stock',
                entityId: transferId,
                entityName: product.name,
                details: 'Rejet de ' + qty + ' unit�s depuis ' + transfer.sourcePosName + ' - Motif: ' + reason,
                status: 'recorded'
            });
            
            CORE.save();
            this.invalidateCache();
            UI.closeModal();
            UI.toast('�� ��? Transfert rejet�. Stock retourn� �� ' + transfer.sourcePosName, 'info');
            
            setTimeout(() => this.showPendingTransfersModal(), 300);
        },

        showTransferHistoryModal() {
            const history = this.getTransferHistory().slice(0, 20);
            const currentPosId = CORE.state.currentUser?.pos;
            
            const html = `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    ${history.length === 0 ? `
                        <div class="text-center py-12 text-slate-400">
                            <i data-lucide="archive" class="w-16 h-16 mx-auto mb-3 opacity-50"></i>
                            <div class="font-bold">Aucun historique de transfert</div>
                        </div>
                    ` : history.map(t => {
                        const isIncoming = t.destPosId == currentPosId;
                        const statusColors = {
                            accepted: 'bg-emerald-100 text-emerald-700 border-emerald-200',
                            rejected: 'bg-red-100 text-red-700 border-red-200'
                        };
                        const statusLabels = {
                            accepted: '���?� R�ceptionn�',
                            rejected: '�� ��? Rejet�'
                        };
                        return `
                            <div class="p-4 rounded-xl border ${statusColors[t.status] || 'border-slate-200 bg-slate-50'}">
                                <div class="flex items-start justify-between gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="${isIncoming ? 'text-emerald-600' : 'text-blue-600'}">${isIncoming ? '��Ÿ? �' : '��Ÿ? �'}</span>
                                            <span class="font-black text-slate-900">${t.productName}</span>
                                            <span class="px-2 py-0.5 text-xs font-bold rounded-full ${statusColors[t.status]}">${statusLabels[t.status]}</span>
                                        </div>
                                        <div class="text-lg font-bold text-slate-700">${t.qty} unit�s</div>
                                        <div class="text-sm text-slate-600">
                                            ${isIncoming ? 'De ' + t.sourcePosName : 'Vers ' + t.destPosName}
                                            �� ?� � ${new Date(t.createdAt).toLocaleDateString('fr-FR')}
                                        </div>
                                        ${t.status === 'accepted' && t.receivedByName ? `
                                            <div class="text-xs text-emerald-600 mt-1">Re��u par ${t.receivedByName} le ${new Date(t.receivedAt).toLocaleString('fr-FR')}</div>
                                        ` : ''}
                                        ${t.status === 'rejected' && t.rejectionReason ? `
                                            <div class="text-xs text-red-600 mt-1">Motif: ${t.rejectionReason}</div>
                                        ` : ''}
                                    </div>
                                    ${(t.receptionMedia?.length > 0 || t.rejectionMedia?.length > 0) ? `
                                        <button onclick="GestionnaireModule.showTransferMedia('${t.id}')" class="px-3 py-1.5 bg-slate-200 text-slate-700 rounded-lg text-xs font-bold hover:bg-slate-300 flex items-center gap-1">
                                            <i data-lucide="image" class="w-3 h-3"></i> Preuves
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            UI.modal('��Ÿ?� Historique des Transferts', html, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            
            setTimeout(() => {
                const modalEl = document.querySelector('#modalContainer .slide-up');
                if (modalEl) {
                    modalEl.classList.remove('max-w-lg');
                    modalEl.classList.add('max-w-2xl');
                }
                lucide.createIcons();
            }, 50);
        },

        showTransferMedia(transferId) {
            const transfer = (CORE.db.stockTransfers || []).find(t => t.id === transferId);
            if (!transfer) return;
            
            const media = [...(transfer.receptionMedia || []), ...(transfer.rejectionMedia || [])];
            
            if (media.length === 0) {
                return UI.toast('Aucune preuve disponible', 'info');
            }
            
            const html = `
                <div class="space-y-4">
                    <div class="text-sm text-slate-600 text-center">${media.length} fichier(s) de preuve</div>
                    <div class="grid grid-cols-2 gap-4">
                        ${media.map(m => `
                            <div class="rounded-xl overflow-hidden border border-slate-200">
                                ${m.type === 'video' ? `
                                    <video src="${m.data}" controls class="w-full"></video>
                                ` : `
                                    <img src="${m.data}" class="w-full cursor-pointer hover:opacity-90" onclick="window.open('${m.data}', '_blank')">
                                `}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            UI.modal('��Ÿ? � Preuves de ' + (transfer.status === 'accepted' ? 'R�ception' : 'Rejet'), html, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showSendMedia(transferId) {
            const transfer = (CORE.db.stockTransfers || []).find(t => t.id === transferId);
            if (!transfer) return;
            
            const media = transfer.sendMedia || [];
            
            if (media.length === 0) {
                return UI.toast('Aucune photo/vid�o d\'envoi disponible', 'info');
            }
            
            const html = `
                <div class="space-y-4">
                    <div class="p-4 bg-purple-50 border border-purple-200 rounded-xl">
                        <div class="font-bold text-purple-800">��Ÿ? � ${transfer.productName}</div>
                        <div class="text-sm text-purple-600">${transfer.qty} unit�s envoy�es par ${transfer.sourcePosName}</div>
                        ${transfer.estimatedArrival ? `<div class="text-sm text-purple-600 mt-1">��Ÿšš Arriv�e estim�e: ${new Date(transfer.estimatedArrival).toLocaleString('fr-FR')}</div>` : ''}
                    </div>
                    <div class="text-sm text-slate-600 text-center">${media.length} fichier(s) joints �� l'envoi</div>
                    <div class="grid grid-cols-2 gap-4 max-h-[50vh] overflow-y-auto">
                        ${media.map(m => `
                            <div class="rounded-xl overflow-hidden border border-slate-200">
                                ${m.type === 'video' ? `
                                    <video src="${m.data}" controls class="w-full"></video>
                                ` : `
                                    <img src="${m.data}" class="w-full cursor-pointer hover:opacity-90" onclick="window.open('${m.data}', '_blank')">
                                `}
                                <div class="p-2 text-xs text-slate-500 truncate">${m.name || 'Fichier'}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            UI.modal('��Ÿ? � Photos/Vid�os du stock envoy�', html, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        // Compteur pour badge notification
        getPendingTransfersCount() {
            return this.getPendingIncomingTransfers().length;
        },

        // Notifications de transferts (r�ceptions confirm�es/rejet�es)
        getTransferNotifications() {
            const currentPosId = CORE.state.currentUser?.pos;
            return (CORE.db.notifications || []).filter(n => 
                n.posId == currentPosId && 
                (n.type === 'transfer_received' || n.type === 'transfer_rejected') &&
                !n.read
            ).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        },

        getTransferNotificationsCount() {
            return this.getTransferNotifications().length;
        },

        showTransferNotificationsModal() {
            const notifications = this.getTransferNotifications();
            const allNotifications = (CORE.db.notifications || []).filter(n => 
                n.posId == CORE.state.currentUser?.pos && 
                (n.type === 'transfer_received' || n.type === 'transfer_rejected')
            ).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 20);
            
            const html = `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    ${notifications.length > 0 ? `
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-xl text-sm">
                            <span class="font-bold text-blue-700">${notifications.length} nouvelle(s) notification(s)</span>
                        </div>
                    ` : ''}
                    
                    ${allNotifications.length === 0 ? `
                        <div class="text-center py-12 text-slate-400">
                            <i data-lucide="bell-off" class="w-16 h-16 mx-auto mb-3 opacity-50"></i>
                            <div class="font-bold">Aucune notification de transfert</div>
                        </div>
                    ` : allNotifications.map(n => {
                        const isReceived = n.type === 'transfer_received';
                        const transfer = (CORE.db.stockTransfers || []).find(t => t.id === n.transferId);
                        return `
                            <div class="p-4 rounded-xl border ${!n.read ? 'border-blue-300 bg-blue-50' : 'border-slate-200 bg-white'} ${isReceived ? '' : 'border-red-200 bg-red-50'}">
                                <div class="flex items-start justify-between gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-xl">${isReceived ? '���?�' : '�� ��?'}</span>
                                            <span class="font-black text-slate-900">${n.title}</span>
                                            ${!n.read ? '<span class="px-2 py-0.5 bg-blue-500 text-white text-[10px] font-black rounded-full">NOUVEAU</span>' : ''}
                                        </div>
                                        <div class="text-sm text-slate-700 mb-2">${n.message}</div>
                                        ${n.details ? `<div class="text-xs text-slate-500 italic">${n.details}</div>` : ''}
                                        <div class="text-xs text-slate-400 mt-2">
                                            ${new Date(n.createdAt).toLocaleString('fr-FR')}
                                            ${n.receivedByName ? ' �� ?� � Par ' + n.receivedByName : ''}
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        ${transfer && (transfer.receptionMedia?.length > 0 || transfer.rejectionMedia?.length > 0) ? `
                                            <button onclick="GestionnaireModule.showTransferMedia('${n.transferId}')" class="px-3 py-2 bg-slate-800 text-white rounded-xl text-xs font-bold hover:bg-slate-900 flex items-center gap-1">
                                                <i data-lucide="image" class="w-4 h-4"></i> 
                                                Voir preuves (${(transfer.receptionMedia?.length || 0) + (transfer.rejectionMedia?.length || 0)})
                                            </button>
                                        ` : ''}
                                        ${!n.read ? `
                                            <button onclick="GestionnaireModule.markNotificationRead('${n.id}')" class="px-3 py-2 bg-slate-200 text-slate-700 rounded-xl text-xs font-bold hover:bg-slate-300">
                                                Marquer lu
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                    
                    ${notifications.length > 0 ? `
                        <button onclick="GestionnaireModule.markAllTransferNotificationsRead()" class="w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition">
                            Tout marquer comme lu
                        </button>
                    ` : ''}
                </div>
            `;
            
            UI.modal('��Ÿ�� Notifications de Transferts', html, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            
            setTimeout(() => {
                const modalEl = document.querySelector('#modalContainer .slide-up');
                if (modalEl) {
                    modalEl.classList.remove('max-w-lg');
                    modalEl.classList.add('max-w-2xl');
                }
                lucide.createIcons();
            }, 50);
        },

        markNotificationRead(notifId) {
            const notif = (CORE.db.notifications || []).find(n => n.id === notifId);
            if (notif) {
                notif.read = true;
                CORE.save();
                this.showTransferNotificationsModal();
            }
        },

        markAllTransferNotificationsRead() {
            const currentPosId = CORE.state.currentUser?.pos;
            (CORE.db.notifications || []).forEach(n => {
                if (n.posId == currentPosId && (n.type === 'transfer_received' || n.type === 'transfer_rejected')) {
                    n.read = true;
                }
            });
            CORE.save();
            UI.closeModal();
            UI.toast('Toutes les notifications marqu�es comme lues', 'success');
            App.rerender();
        },

        showStockAnalysis() {
            const products = this.getProductsOptimized();
            const totalProducts = products.length;
            const totalStock = products.reduce((s, p) => s + (p.stock || 0), 0);
            const totalValue = products.reduce((s, p) => s + (p.stock || 0) * (p.price || 0), 0);
            const lowStock = products.filter(p => (p.stock || 0) <= (p.minStock || 0)).length;
            const outOfStock = products.filter(p => (p.stock || 0) === 0).length;
            
            // Top 5 produits par valeur
            const topByValue = [...products].sort((a, b) => ((b.stock || 0) * (b.price || 0)) - ((a.stock || 0) * (a.price || 0))).slice(0, 5);
            
            UI.modal('��Ÿ?Š Analyse du Stock', `
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="p-4 bg-blue-50 rounded-xl text-center">
                            <div class="text-3xl font-black text-blue-600">${totalProducts}</div>
                            <div class="text-xs font-bold text-blue-500">Produits</div>
                        </div>
                        <div class="p-4 bg-emerald-50 rounded-xl text-center">
                            <div class="text-3xl font-black text-emerald-600">${totalStock}</div>
                            <div class="text-xs font-bold text-emerald-500">Unit�s</div>
                        </div>
                        <div class="p-4 bg-violet-50 rounded-xl text-center">
                            <div class="text-2xl font-black text-violet-600">${(totalValue/1000).toFixed(1)}k</div>
                            <div class="text-xs font-bold text-violet-500">Valeur</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-amber-50 border border-amber-200 rounded-xl">
                            <div class="flex items-center gap-2">
                                <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600"></i>
                                <div>
                                    <div class="text-xl font-black text-amber-600">${lowStock}</div>
                                    <div class="text-xs text-amber-500">Stock faible</div>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 bg-red-50 border border-red-200 rounded-xl">
                            <div class="flex items-center gap-2">
                                <i data-lucide="x-circle" class="w-5 h-5 text-red-600"></i>
                                <div>
                                    <div class="text-xl font-black text-red-600">${outOfStock}</div>
                                    <div class="text-xs text-red-500">Rupture</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-slate-50 rounded-xl">
                        <div class="font-black text-slate-800 mb-3">��Ÿ �� Top 5 par valeur stock</div>
                        <div class="space-y-2">
                            ${topByValue.map((p, i) => `
                                <div class="flex items-center gap-3">
                                    <div class="w-6 h-6 bg-gradient-to-r ${i === 0 ? 'from-amber-400 to-amber-500' : i === 1 ? 'from-slate-300 to-slate-400' : i === 2 ? 'from-orange-300 to-orange-400' : 'from-slate-200 to-slate-300'} rounded-full flex items-center justify-center text-xs font-black text-white">${i + 1}</div>
                                    <div class="flex-1 text-sm font-bold text-slate-700">${p.name}</div>
                                    <div class="text-sm font-black text-slate-900">${((p.stock || 0) * (p.price || 0)).toLocaleString()} F</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            setTimeout(() => lucide.createIcons(), 50);
        },

        showStockRecommendations() {
            const products = this.getProductsOptimized();
            const recommendations = [];
            
            // Produits en rupture
            const outOfStock = products.filter(p => (p.stock || 0) === 0);
            if (outOfStock.length > 0) {
                recommendations.push({
                    type: 'danger',
                    icon: 'x-circle',
                    title: outOfStock.length + ' produit(s) en rupture',
                    desc: 'Commander imm�diatement: ' + outOfStock.slice(0, 3).map(p => p.name).join(', ') + (outOfStock.length > 3 ? '...' : ''),
                    action: 'GestionnaireModule.showBulkReorderModal()'
                });
            }
            
            // Stock faible
            const lowStock = products.filter(p => (p.stock || 0) > 0 && (p.stock || 0) <= (p.minStock || 0));
            if (lowStock.length > 0) {
                recommendations.push({
                    type: 'warning',
                    icon: 'alert-triangle',
                    title: lowStock.length + ' produit(s) stock faible',
                    desc: 'Anticiper la commande: ' + lowStock.slice(0, 3).map(p => p.name).join(', '),
                    action: 'GestionnaireModule.showBulkReorderModal()'
                });
            }
            
            // Surstock
            const overStock = products.filter(p => (p.stock || 0) > (p.minStock || 5) * 5);
            if (overStock.length > 0) {
                recommendations.push({
                    type: 'info',
                    icon: 'package',
                    title: overStock.length + ' produit(s) en surstock',
                    desc: 'Envisager une promotion ou un transfert',
                    action: null
                });
            }
            
            if (recommendations.length === 0) {
                recommendations.push({
                    type: 'success',
                    icon: 'check-circle',
                    title: 'Stock optimal!',
                    desc: 'Aucune action requise pour le moment',
                    action: null
                });
            }
            
            const colors = { danger: 'red', warning: 'amber', info: 'blue', success: 'emerald' };
            
            UI.modal('��Ÿ? � Recommandations Stock', `
                <div class="space-y-4">
                    ${recommendations.map(r => `
                        <div class="p-4 bg-${colors[r.type]}-50 border border-${colors[r.type]}-200 rounded-xl">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-${colors[r.type]}-500 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="${r.icon}" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="font-black text-${colors[r.type]}-800">${r.title}</div>
                                    <div class="text-sm text-${colors[r.type]}-600">${r.desc}</div>
                                    ${r.action ? `<button onclick="${r.action}" class="mt-2 px-4 py-2 bg-${colors[r.type]}-600 text-white text-sm font-bold rounded-lg hover:bg-${colors[r.type]}-700">Agir maintenant</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            setTimeout(() => lucide.createIcons(), 50);
        },

        showStockHistory() {
            const movements = (CORE.db.stockMovements || []).filter(m => m.posId === CORE.state.currentUser?.pos);
            const recent = movements.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 30);
            const products = CORE.db.products || [];
            
            UI.modal('��Ÿ?�? Historique des Mouvements', `
                <div class="space-y-4">
                    <div class="p-3 bg-slate-50 rounded-xl">
                        <div class="text-sm font-bold text-slate-600">30 derniers mouvements</div>
                    </div>
                    
                    ${recent.length === 0 ? `
                        <div class="text-center py-8 text-slate-400">
                            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2"></i>
                            <div>Aucun mouvement enregistr�</div>
                        </div>
                    ` : `
                        <div class="space-y-2 max-h-[60vh] overflow-y-auto">
                            ${recent.map(m => {
                                const product = products.find(p => p.id === m.productId);
                                const isIn = m.type === 'in';
                                return `
                                <div class="flex items-center gap-3 p-3 bg-white border border-slate-200 rounded-xl">
                                    <div class="w-8 h-8 ${isIn ? 'bg-emerald-100' : 'bg-red-100'} rounded-lg flex items-center justify-center">
                                        <i data-lucide="${isIn ? 'arrow-down' : 'arrow-up'}" class="w-4 h-4 ${isIn ? 'text-emerald-600' : 'text-red-600'}"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-bold text-slate-900">${product?.name || 'Produit #' + m.productId}</div>
                                        <div class="text-xs text-slate-500">${m.note || 'Mouvement'} �� ?� � ${new Date(m.date).toLocaleDateString('fr-FR')}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-black ${isIn ? 'text-emerald-600' : 'text-red-600'}">${isIn ? '+' : '-'}${m.quantity}</div>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            setTimeout(() => lucide.createIcons(), 50);
        },

        showStockIndicators() {
            const products = this.getProductsOptimized();
            const posId = CORE.state.currentUser?.pos || 1;
            const categories = (CORE.db.categories || []).filter(c => !c.posId || c.posId == posId);
            
            // Stats par cat�gorie
            const catStats = categories.map(cat => {
                const catProducts = products.filter(p => p.categoryId === cat.id);
                return {
                    name: cat.name,
                    count: catProducts.length,
                    stock: catProducts.reduce((s, p) => s + (p.stock || 0), 0),
                    value: catProducts.reduce((s, p) => s + (p.stock || 0) * (p.price || 0), 0)
                };
            }).filter(c => c.count > 0);
            
            const totalValue = products.reduce((s, p) => s + (p.stock || 0) * (p.price || 0), 0);
            const avgPrice = products.length > 0 ? products.reduce((s, p) => s + (p.price || 0), 0) / products.length : 0;
            const rotationRate = 85; // Taux fictif
            
            UI.modal('��Ÿ?�? Indicateurs Stock', `
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="p-4 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl text-center text-white">
                            <div class="text-3xl font-black">${(totalValue/1000000).toFixed(2)}M</div>
                            <div class="text-xs opacity-90">Valeur totale</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl text-center text-white">
                            <div class="text-3xl font-black">${avgPrice.toFixed(0)}</div>
                            <div class="text-xs opacity-90">Prix moyen</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-violet-500 to-violet-600 rounded-xl text-center text-white">
                            <div class="text-3xl font-black">${rotationRate}%</div>
                            <div class="text-xs opacity-90">Rotation</div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-slate-50 rounded-xl">
                        <div class="font-black text-slate-800 mb-3">Stock par cat�gorie</div>
                        <div class="space-y-3">
                            ${catStats.length === 0 ? '<div class="text-center text-slate-400 py-4">Aucune cat�gorie</div>' : catStats.map(cat => `
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="font-bold text-slate-700">${cat.name}</span>
                                        <span class="font-black text-slate-900">${cat.stock} unit�s</span>
                                    </div>
                                    <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-blue-500 to-emerald-500 rounded-full" style="width: ${Math.min(100, (cat.value / totalValue) * 100)}%"></div>
                                    </div>
                                    <div class="text-xs text-slate-500 text-right">${cat.value.toLocaleString()} F</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            setTimeout(() => lucide.createIcons(), 50);
        },

        showAddStockModal() {
            const products = this.getProductsOptimized();
            
            UI.modal('��Ÿ? � Nouvelle Entr�e Stock', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Produit</label>
                        <select id="add_stock_product" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold">
                            <option value="">S�lectionner un produit</option>
                            ${products.map(p => `<option value="${p.id}">${p.name} (Stock: ${p.stock || 0})</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Quantit�</label>
                        <input type="number" id="add_stock_qty" min="1" value="1" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold text-center text-xl">
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Note/R�f�rence</label>
                        <input type="text" id="add_stock_note" placeholder="Ex: Livraison #456" class="w-full px-4 py-3 border border-slate-200 rounded-xl">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Ajouter', onclick: 'GestionnaireModule.applyAddStock()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        applyAddStock() {
            const productId = parseInt(document.getElementById('add_stock_product')?.value);
            const qty = parseInt(document.getElementById('add_stock_qty')?.value) || 0;
            const note = document.getElementById('add_stock_note')?.value || '';
            
            if (!productId) return UI.toast('S�lectionnez un produit', 'error');
            if (qty <= 0) return UI.toast('Quantit� invalide', 'error');
            
            const p = CORE.db.products.find(x => x.id === productId);
            if (!p) return UI.toast('Produit introuvable', 'error');
            
            const newStock = (p.stock || 0) + qty;
            CORE.update('products', productId, { stock: newStock });
            CORE.recordStockMovement({
                productId,
                type: 'in',
                qty,
                note,
                posId: CORE.state.currentUser?.pos,
                userName: CORE.state.currentUser?.name
            });
            
            this.invalidateCache(['products', 'stocks']);
            UI.closeModal();
            UI.toast(`+${qty} unit�(s) ajout�e(s) �� ${p.name}`, 'success');
            App.rerender();
        },

        // Fonction pour afficher les d�tails d'une livraison avec preuves (Gestionnaire)
        showDeliveryDetail(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return UI.toast('Livraison introuvable', 'error');
            const livreur = d.livreurId ? CORE.getUser(d.livreurId) : null;
            const badge = d.status === 'livree' ? UI.badge('Livr�e','emerald') :
                          d.status === 'probleme' ? UI.badge('Probl��me','red') :
                          d.status === 'en_attente' ? UI.badge('�?� assigner','blue') :
                          d.status === 'annulee' ? UI.badge('Annul�e','slate') : UI.badge('En cours','amber');
            
            const hasProofPhotos = d.proofPhotos && d.proofPhotos.length > 0;
            const hasProofSignature = !!d.proofSignature;
            const hasProof = hasProofPhotos || hasProofSignature;

            UI.modal(`��Ÿ? � Livraison ${d.orderRef}`, `
                <div class="space-y-4 max-h-[75vh] overflow-y-auto">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Statut</div>
                            <div class="mt-1">${badge}</div>
                        </div>
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-right">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Montant</div>
                            <div class="mt-1 text-2xl font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Client</div>
                        <div class="mt-1 font-black text-slate-900">${d.clientName || '�� ?��'}</div>
                        <div class="text-xs text-slate-600">${d.clientPhone || ''}</div>
                        <div class="mt-2 text-xs text-slate-600"><b>Adresse:</b> ${d.address || '�� ?��'}</div>
                        ${d.deliveryTime ? `<div class="mt-1 text-xs text-slate-600"><b>Heure:</b> ${d.deliveryTime}</div>` : ''}
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Livreur</div>
                        <div class="mt-1 font-black">${livreur?.name || 'Non assign�'}</div>
                        <div class="text-xs text-slate-600">${livreur?.phone || ''}</div>
                    </div>

                    ${hasProof ? `
                    <!-- PREUVES DE LIVRAISON -->
                    <div class="p-4 bg-gradient-to-r from-emerald-50 to-teal-50 border-2 border-emerald-300 rounded-2xl">
                        <div class="text-xs font-black text-emerald-700 uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i data-lucide="camera" class="w-4 h-4"></i>
                            ��Ÿ? � Preuves de livraison
                        </div>
                        
                        ${hasProofPhotos ? `
                        <div class="mb-3">
                            <div class="text-xs font-bold text-emerald-600 mb-2">Photos (${d.proofPhotos.length})</div>
                            <div class="grid grid-cols-3 gap-2">
                                ${d.proofPhotos.map((photo, idx) => `
                                    <div class="aspect-square rounded-xl overflow-hidden border-2 border-emerald-300 cursor-pointer hover:border-emerald-500 transition shadow-md" onclick="window.open('${photo.replace(/'/g, "\\'")}', '_blank')">
                                        <img src="${photo}" class="w-full h-full object-cover hover:scale-105 transition" alt="Preuve ${idx + 1}">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${hasProofSignature ? `
                        <div>
                            <div class="text-xs font-bold text-emerald-600 mb-2">���? ��� � � Signature client</div>
                            <div class="p-3 bg-white rounded-xl border-2 border-blue-200 cursor-pointer hover:border-blue-400 transition" onclick="window.open('${d.proofSignature.replace(/'/g, "\\'")}', '_blank')">
                                <img src="${d.proofSignature}" class="w-full max-h-24 object-contain" alt="Signature">
                            </div>
                        </div>
                        ` : ''}
                        
                        ${d.proofNote ? `
                        <div class="mt-3 p-3 bg-white rounded-xl border border-emerald-200">
                            <div class="text-xs font-bold text-slate-500 mb-1">Note du livreur</div>
                            <div class="text-sm text-slate-700">${d.proofNote}</div>
                        </div>
                        ` : ''}
                        
                        <div class="text-center text-xs text-emerald-600 mt-3">
                            Valid�e le ${d.proofTimestamp ? new Date(d.proofTimestamp).toLocaleString('fr-FR') : (d.deliveredAt ? new Date(d.deliveredAt).toLocaleString('fr-FR') : '�� ?��')}
                        </div>
                    </div>
                    ` : (d.status === 'livree' ? `
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-center">
                        <div class="text-slate-400 text-sm">��Ÿ? � Aucune preuve de livraison disponible</div>
                    </div>
                    ` : '')}

                    ${d.recallReason ? `<div class="p-4 bg-amber-50 border border-amber-100 rounded-2xl text-xs text-amber-800"><b>Rappel:</b> ${d.recallReason}</div>` : ''}
                    ${d.recalledAt ? `<div class="text-xs text-slate-500">Rappel�e: ${CORE.formatDate(d.recalledAt)}</div>` : ''}
                    <div class="text-xs text-slate-500">Cr��e: ${CORE.formatDate(d.createdAt)}</div>
                    ${d.deliveredAt ? `<div class="text-xs text-emerald-600">Livr�e: ${CORE.formatDate(d.deliveredAt)}</div>` : ''}
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        renderDeliveries() {
            const user = CORE.state.currentUser;
            const posId = user?.pos;
            const statusFilter = this.state.deliveryStatus || 'all';
            const searchQuery = (this.state.deliverySearch || '').toLowerCase().trim();
            
            // PDG/Manager: voir toutes les livraisons
            let allDeliveries = (user?.role === 'pdg' || user?.role === 'manager') 
                ? CORE.db.deliveries 
                : CORE.db.deliveries.filter(d => d.posId == posId);
            
            let all = allDeliveries;
            
            // Filtrer par statut
            if (statusFilter !== 'all') {
                all = all.filter(d => d.status === statusFilter);
            }
            
            // Filtrer par recherche
            if (searchQuery) {
                all = all.filter(d => 
                    (d.orderRef || '').toLowerCase().includes(searchQuery) ||
                    (d.clientName || '').toLowerCase().includes(searchQuery) ||
                    (d.address || '').toLowerCase().includes(searchQuery) ||
                    (CORE.getUser(d.livreurId)?.name || '').toLowerCase().includes(searchQuery)
                );
            }
            
            all = all.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 50);
            
            const stats = {
                total: allDeliveries.length,
                livree: allDeliveries.filter(d => d.status === 'livree').length,
                en_cours: allDeliveries.filter(d => d.status === 'en_cours').length,
                en_attente: allDeliveries.filter(d => d.status === 'en_attente').length,
                probleme: allDeliveries.filter(d => d.status === 'probleme').length
            };
            
            return `
                <div class="fade-in space-y-6">
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">��Ÿ? � Historique des livraisons</h2>
                            <p class="text-slate-500 font-medium">Suivi complet avec preuves de livraison</p>
                        </div>
                    </div>
                    
                    <!-- Stats rapides -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                        <div class="p-4 bg-slate-100 rounded-2xl text-center">
                            <div class="text-2xl font-black text-slate-900">${stats.total}</div>
                            <div class="text-xs text-slate-600 font-bold">Total</div>
                        </div>
                        <div class="p-4 bg-emerald-100 rounded-2xl text-center">
                            <div class="text-2xl font-black text-emerald-700">${stats.livree}</div>
                            <div class="text-xs text-emerald-600 font-bold">Livr�es</div>
                        </div>
                        <div class="p-4 bg-amber-100 rounded-2xl text-center">
                            <div class="text-2xl font-black text-amber-700">${stats.en_cours}</div>
                            <div class="text-xs text-amber-600 font-bold">En cours</div>
                        </div>
                        <div class="p-4 bg-blue-100 rounded-2xl text-center">
                            <div class="text-2xl font-black text-blue-700">${stats.en_attente}</div>
                            <div class="text-xs text-blue-600 font-bold">�?� assigner</div>
                        </div>
                        <div class="p-4 bg-red-100 rounded-2xl text-center">
                            <div class="text-2xl font-black text-red-700">${stats.probleme}</div>
                            <div class="text-xs text-red-600 font-bold">Probl��mes</div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex flex-col md:flex-row md:items-center gap-3 justify-between">
                            <div class="font-black text-slate-900">${all.length} r�sultat(s)</div>
                            <div class="flex gap-3 flex-wrap">
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input type="text" value="${this.state.deliverySearch || ''}" 
                                        onkeyup="GestionnaireModule.state.deliverySearch=this.value;App.rerender()" 
                                        placeholder="Rechercher..." 
                                        class="pl-10 pr-4 py-2 rounded-xl border border-slate-200 bg-white font-medium w-48">
                                </div>
                                <select onchange="GestionnaireModule.state.deliveryStatus=this.value;App.rerender()" 
                                    class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                                    <option value="all" ${statusFilter === 'all' ? 'selected' : ''}>Tous statuts</option>
                                    <option value="livree" ${statusFilter === 'livree' ? 'selected' : ''}>Livr�es</option>
                                    <option value="en_cours" ${statusFilter === 'en_cours' ? 'selected' : ''}>En cours</option>
                                    <option value="en_attente" ${statusFilter === 'en_attente' ? 'selected' : ''}>�?� assigner</option>
                                    <option value="probleme" ${statusFilter === 'probleme' ? 'selected' : ''}>Probl��mes</option>
                                    <option value="annulee" ${statusFilter === 'annulee' ? 'selected' : ''}>Annul�es</option>
                                </select>
                            </div>
                        </div>
                        <div class="divide-y divide-slate-50">
                            ${all.length === 0 ? `<div class="p-10 text-center text-slate-400 font-medium">Aucune livraison trouv�e</div>` : ''}
                            ${all.map(d => {
                                const hasProof = (d.proofPhotos && d.proofPhotos.length > 0) || d.proofSignature;
                                const badge = d.status === 'livree' ? UI.badge('Livr�e','emerald') : 
                                              d.status === 'en_cours' ? UI.badge('En cours','amber') : 
                                              d.status === 'en_attente' ? UI.badge('�?� assigner','blue') : 
                                              d.status === 'probleme' ? UI.badge('Probl��me','red') : UI.badge('Annul�e','slate');
                                return `
                                <button onclick="GestionnaireModule.showDeliveryDetail(${d.id})" class="w-full text-left p-4 hover:bg-slate-50 flex items-center justify-between transition">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-12 ${hasProof ? 'bg-emerald-100' : 'bg-slate-100'} rounded-xl flex items-center justify-center flex-shrink-0">
                                            ${hasProof ? '<i data-lucide="camera" class="w-5 h-5 text-emerald-600"></i>' : '<i data-lucide="package" class="w-5 h-5 text-slate-500"></i>'}
                                        </div>
                                        <div>
                                            <div class="font-black text-slate-900">${d.orderRef}</div>
                                            <div class="text-xs text-slate-500">${d.clientName} �� ?� � ${d.address || '�� ?��'}</div>
                                            <div class="text-xs text-slate-400">Livreur: ${CORE.getUser(d.livreurId)?.name || 'Non assign�'}</div>
                                        </div>
                                    </div>
                                    <div class="text-right flex flex-col items-end gap-1">
                                        <div class="font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                                        ${badge}
                                        ${hasProof ? '<span class="text-[10px] text-emerald-600 font-bold">��Ÿ? � Preuve dispo</span>' : ''}
                                    </div>
                                </button>
                            `}).join('')}
                        </div>
                    </div>
                </div>`;
        },

        renderReports() {
            const posId = CORE.state.currentUser?.pos;
            const dateFrom = CORE.state.reportDateFrom || '';
            const dateTo = CORE.state.reportDateTo || '';
            
            const allDeliveries = CORE.db.deliveries.filter(d => d.posId === posId);
            const filteredDeliveries = dateFrom && dateTo 
                ? allDeliveries.filter(d => {
                    const deliveryDate = new Date(d.createdAt).toISOString().split('T')[0];
                    return deliveryDate >= dateFrom && deliveryDate <= dateTo;
                })
                : allDeliveries;
            
            const delivered = filteredDeliveries.filter(d => d.status === 'livree').length;
            const pending = filteredDeliveries.filter(d => ['en_attente', 'en_cours'].includes(d.status)).length;
            const cancelled = filteredDeliveries.filter(d => d.status === 'annulee').length;
            const totalRevenue = filteredDeliveries.filter(d => d.status === 'livree').reduce((a, d) => a + (d.amount || 0), 0);
            const avgDeliveryTime = filteredDeliveries.length > 0 ? Math.round(filteredDeliveries.reduce((a, d) => {
                if (!d.assignedAt || !d.deliveredAt) return a;
                return a + (new Date(d.deliveredAt) - new Date(d.assignedAt)) / 60000;
            }, 0) / filteredDeliveries.filter(d => d.assignedAt && d.deliveredAt).length) : 0;

            const deliveriesByStatus = {
                livree: filteredDeliveries.filter(d => d.status === 'livree').length,
                en_cours: filteredDeliveries.filter(d => d.status === 'en_cours').length,
                en_attente: filteredDeliveries.filter(d => d.status === 'en_attente').length,
                probleme: filteredDeliveries.filter(d => d.status === 'probleme').length,
                annulee: filteredDeliveries.filter(d => d.status === 'annulee').length
            };

            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">��Ÿ?Š Rapports & Analyses</h2>
                            <p class="text-slate-500 font-medium">Statistiques des livraisons et performance du POS</p>
                        </div>
                    </div>

                    <!-- Filtres de date -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 flex gap-4 items-end flex-wrap">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Du</label>
                            <input type="date" id="reportDateFrom" value="${dateFrom}" onchange="CORE.state.reportDateFrom = this.value; GestionnaireModule.state.currentView = 'reports'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl">
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Au</label>
                            <input type="date" id="reportDateTo" value="${dateTo}" onchange="CORE.state.reportDateTo = this.value; GestionnaireModule.state.currentView = 'reports'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl">
                        </div>
                        <button onclick="CORE.state.reportDateFrom = ''; CORE.state.reportDateTo = ''; GestionnaireModule.state.currentView = 'reports'; App.rerender()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-black hover:bg-slate-200 transition text-sm">R�initialiser</button>
                    </div>

                    <!-- KPIs principaux -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-3xl border border-emerald-200 p-6 shadow-sm">
                            <div class="text-emerald-700 text-xs font-black uppercase tracking-wider mb-2">Livr�es</div>
                            <div class="text-3xl font-black text-emerald-600">${delivered}</div>
                            <div class="text-xs text-emerald-600 mt-1">${filteredDeliveries.length > 0 ? Math.round(delivered / filteredDeliveries.length * 100) : 0}% du total</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-3xl border border-amber-200 p-6 shadow-sm">
                            <div class="text-amber-700 text-xs font-black uppercase tracking-wider mb-2">En cours</div>
                            <div class="text-3xl font-black text-amber-600">${pending}</div>
                            <div class="text-xs text-amber-600 mt-1">${filteredDeliveries.length > 0 ? Math.round(pending / filteredDeliveries.length * 100) : 0}% du total</div>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-3xl border border-red-200 p-6 shadow-sm">
                            <div class="text-red-700 text-xs font-black uppercase tracking-wider mb-2">Annul�es</div>
                            <div class="text-3xl font-black text-red-600">${cancelled}</div>
                            <div class="text-xs text-red-600 mt-1">${filteredDeliveries.length > 0 ? Math.round(cancelled / filteredDeliveries.length * 100) : 0}% du total</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-3xl border border-blue-200 p-6 shadow-sm">
                            <div class="text-blue-700 text-xs font-black uppercase tracking-wider mb-2">Revenu</div>
                            <div class="text-3xl font-black text-blue-600">${CORE.formatPrice(totalRevenue)}</div>
                            <div class="text-xs text-blue-600 mt-1">Livraisons confirm�es</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-3xl border border-purple-200 p-6 shadow-sm">
                            <div class="text-purple-700 text-xs font-black uppercase tracking-wider mb-2">Temps moy</div>
                            <div class="text-3xl font-black text-purple-600">${avgDeliveryTime}m</div>
                            <div class="text-xs text-purple-600 mt-1">Affectation ���? Livraison</div>
                        </div>
                    </div>

                    <!-- Graphique de statuts -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6">
                        <h3 class="text-xl font-black text-slate-900 mb-4">R�partition par statut</h3>
                        <div class="space-y-3">
                            ${['livree', 'en_cours', 'en_attente', 'probleme', 'annulee'].map(status => {
                                const count = deliveriesByStatus[status];
                                const percent = filteredDeliveries.length > 0 ? Math.round(count / filteredDeliveries.length * 100) : 0;
                                const colors = {
                                    'livree': 'bg-emerald-500',
                                    'en_cours': 'bg-amber-500',
                                    'en_attente': 'bg-blue-500',
                                    'probleme': 'bg-red-500',
                                    'annulee': 'bg-slate-400'
                                };
                                const labels = {
                                    'livree': 'Livr�es',
                                    'en_cours': 'En cours',
                                    'en_attente': 'En attente',
                                    'probleme': 'Probl��me',
                                    'annulea': 'Annul�es'
                                };
                                return `
                                    <div class="flex items-center gap-4">
                                        <div class="w-32 text-sm font-black text-slate-900">${labels[status]}</div>
                                        <div class="flex-1 h-8 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full ${colors[status]} transition-all duration-300" data-width="${percent}"></div>
                                        </div>
                                        <div class="w-20 text-right text-sm font-black text-slate-900">${count} (${percent}%)</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Tableau d�taill� -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="text-xl font-black text-slate-900">D�tail des livraisons</h3>
                            <span class="text-sm text-slate-500">${filteredDeliveries.length} r�sultat(s)</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 border-b border-slate-100">
                                    <tr>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Commande</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Client</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Livreur</th>
                                        <th class="px-6 py-3 text-right font-black text-slate-900">Montant</th>
                                        <th class="px-6 py-3 text-center font-black text-slate-900">Statut</th>
                                        <th class="px-6 py-3 text-right font-black text-slate-900">Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredDeliveries.slice(0, 50).map(d => `
                                        <tr class="border-b border-slate-100 hover:bg-slate-50 transition">
                                            <td class="px-6 py-3 font-black text-slate-900">${d.orderRef}</td>
                                            <td class="px-6 py-3 text-slate-600">${d.clientName}</td>
                                            <td class="px-6 py-3 text-slate-600">${CORE.getUser(d.livreurId)?.name || '�� ?��'}</td>
                                            <td class="px-6 py-3 text-right font-black text-slate-900">${CORE.formatPrice(d.amount)}</td>
                                            <td class="px-6 py-3 text-center">${UI.badge(d.status, d.status === 'livree' ? 'emerald' : d.status === 'en_cours' ? 'amber' : d.status === 'annulea' ? 'red' : 'slate')}</td>
                                            <td class="px-6 py-3 text-right text-slate-500 text-xs">${CORE.formatDate(d.createdAt)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ${filteredDeliveries.length > 50 ? `<div class="p-4 text-center text-slate-500 text-xs">Affichage des 50 premiers r�sultats. Total: ${filteredDeliveries.length}</div>` : ''}
                        </div>
                    </div>
                </div>`;
        },

        recordAuditLog(action, entity, entityId, entityName = '', details = '', before = null, after = null) {
            const user = CORE.state.currentUser;
            const audit = CORE.create('auditLogs', {
                timestamp: new Date().toISOString(),
                userId: user?.id,
                userName: user?.name || 'Syst��me',
                userRole: user?.role || 'system',
                action,
                entity,
                entityId,
                entityName,
                details,
                before,
                after,
                status: 'recorded'
            });
            return audit;
        },

        renderAuditLog() {
            const posId = CORE.state.currentUser?.pos;
            const filterUser = CORE.state.auditFilterUser || '';
            const filterAction = CORE.state.auditFilterAction || '';
            const filterEntity = CORE.state.auditFilterEntity || '';
            const dateFrom = CORE.state.auditDateFrom || '';
            const dateTo = CORE.state.auditDateTo || '';

            // Utilisateurs du POS du gestionnaire
            const posUsers = CORE.db.users.filter(u => u.active && u.pos == posId);
            const posUserIds = posUsers.map(u => u.id);
            const currentUserId = CORE.state.currentUser?.id;

            // Filtrer STRICTEMENT par POS du gestionnaire
            let auditLogs = (CORE.db.auditLogs || []).filter(log => {
                // Tous les logs doivent avoir posId == POS du gestionnaire
                return log.posId == posId;
            });

            // Filter by date range
            if (dateFrom || dateTo) {
                auditLogs = auditLogs.filter(log => {
                    const logDate = new Date(log.timestamp).toISOString().split('T')[0];
                    if (dateFrom && logDate < dateFrom) return false;
                    if (dateTo && logDate > dateTo) return false;
                    return true;
                });
            }

            // Filter by user
            if (filterUser) {
                auditLogs = auditLogs.filter(log => log.userId == filterUser);
            }

            // Filter by action
            if (filterAction) {
                auditLogs = auditLogs.filter(log => log.action === filterAction);
            }

            // Filter by entity
            if (filterEntity) {
                auditLogs = auditLogs.filter(log => log.entity === filterEntity);
            }

            // Sort by date descending
            auditLogs = auditLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Actions et entit�s bas�es sur les logs filtr�s du POS
            const actions = [...new Set(auditLogs.map(l => l.action).filter(a => a))];
            const entities = [...new Set(auditLogs.map(l => l.entity).filter(e => e))];

            const actionColors = {
                'create': 'emerald',
                'update': 'blue',
                'delete': 'red',
                'assign': 'purple',
                'deposit': 'amber',
                'status_change': 'cyan',
                'export': 'slate',
                'validate': 'green'
            };

            const entityIcons = {
                'order': 'receipt',
                'delivery': 'truck',
                'deposit': 'wallet',
                'product': 'box',
                'user': 'user',
                'shift': 'calendar',
                'inventory': 'package'
            };

            const posName = CORE.getPOS(posId)?.name || 'Mon POS';

            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">��Ÿ?� Journal d'Audit</h2>
                            <p class="text-slate-500 font-medium">Tra��abilit� des actions sur <strong>${posName}</strong></p>
                        </div>
                        <button onclick="GestionnaireModule.exportAuditLog()" class="px-4 py-2 bg-slate-900 text-white rounded-xl font-black hover:bg-slate-800 transition flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Exporter
                        </button>
                    </div>

                    <!-- Filtres -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 space-y-4">
                        <h3 class="font-black text-slate-900">Filtres</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                            <!-- Filtre par utilisateur -->
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Utilisateur</label>
                                <select onchange="CORE.state.auditFilterUser = this.value; GestionnaireModule.state.currentView = 'auditlog'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-amber-500 transition">
                                    <option value="">Tous</option>
                                    ${posUsers.map(u => `<option value="${u.id}" ${filterUser == u.id ? 'selected' : ''}>${u.name}</option>`).join('')}
                                </select>
                            </div>

                            <!-- Filtre par action -->
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Action</label>
                                <select onchange="CORE.state.auditFilterAction = this.value; GestionnaireModule.state.currentView = 'auditlog'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-amber-500 transition">
                                    <option value="">Toutes</option>
                                    ${actions.map(a => `<option value="${a}" ${filterAction === a ? 'selected' : ''}>${a}</option>`).join('')}
                                </select>
                            </div>

                            <!-- Filtre par entit� -->
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Entit�</label>
                                <select onchange="CORE.state.auditFilterEntity = this.value; GestionnaireModule.state.currentView = 'auditlog'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-amber-500 transition">
                                    <option value="">Toutes</option>
                                    ${entities.map(e => `<option value="${e}" ${filterEntity === e ? 'selected' : ''}>${e}</option>`).join('')}
                                </select>
                            </div>

                            <!-- Date depuis -->
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Du</label>
                                <input type="date" value="${dateFrom}" onchange="CORE.state.auditDateFrom = this.value; GestionnaireModule.state.currentView = 'auditlog'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-amber-500 transition">
                            </div>

                            <!-- Date jusqu'�� -->
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Au</label>
                                <input type="date" value="${dateTo}" onchange="CORE.state.auditDateTo = this.value; GestionnaireModule.state.currentView = 'auditlog'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-amber-500 transition">
                            </div>
                        </div>
                        <button onclick="CORE.state.auditFilterUser = ''; CORE.state.auditFilterAction = ''; CORE.state.auditFilterEntity = ''; CORE.state.auditDateFrom = ''; CORE.state.auditDateTo = ''; GestionnaireModule.state.currentView = 'auditlog'; App.rerender()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-black hover:bg-slate-200 transition">R�initialiser les filtres</button>
                    </div>

                    <!-- Statistiques -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">Total �v�nements</div>
                            <div class="text-4xl font-black text-slate-900 mt-2">${auditLogs.length}</div>
                            <p class="text-xs text-slate-400 mt-2">Enregistr�s</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">Modifications statuts</div>
                            <div class="text-4xl font-black text-blue-600 mt-2">${auditLogs.filter(l => l.action === 'status_change').length}</div>
                            <p class="text-xs text-slate-400 mt-2">Changements</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">D�p��ts enregistr�s</div>
                            <div class="text-4xl font-black text-amber-600 mt-2">${auditLogs.filter(l => l.action === 'deposit').length}</div>
                            <p class="text-xs text-slate-400 mt-2">D�p��ts</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">Affectations</div>
                            <div class="text-4xl font-black text-purple-600 mt-2">${auditLogs.filter(l => l.action === 'assign').length}</div>
                            <p class="text-xs text-slate-400 mt-2">Assignations</p>
                        </div>
                    </div>

                    <!-- Tableau des logs -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="text-xl font-black text-slate-900">Historique des actions</h3>
                            <span class="text-sm text-slate-500">${auditLogs.length} r�sultat(s)</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 border-b border-slate-100">
                                    <tr>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Date/Heure</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Utilisateur</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Action</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Entit�</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">D�tails</th>
                                        <th class="px-6 py-3 text-center font-black text-slate-900">Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${auditLogs.length === 0 ? '<tr><td colspan="6" class="px-6 py-10 text-center text-slate-400 italic">Aucun �v�nement enregistr�</td></tr>' : ''}
                                    ${auditLogs.slice(0, 100).map(log => {
                                        return `<tr class="border-b border-slate-100 hover:bg-slate-50 transition">
                                            <td class="px-6 py-4">
                                                <div class="font-black text-slate-900 text-xs">${new Date(log.timestamp).toLocaleDateString('fr-FR')}</div>
                                                <div class="text-[10px] text-slate-500">${new Date(log.timestamp).toLocaleTimeString('fr-FR')}</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="font-black text-slate-900">${log.userName}</div>
                                                <div class="text-[10px] text-slate-500 uppercase">${log.userRole}</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                ${UI.badge(log.action, actionColors[log.action] || 'slate')}
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="flex items-center gap-2">
                                                    <i data-lucide="${entityIcons[log.entity] || 'file'}" class="w-4 h-4 text-slate-400"></i>
                                                    <span class="font-black text-slate-900">${log.entity}</span>
                                                </div>
                                                <div class="text-[10px] text-slate-500">#${log.entityId}</div>
                                            </td>
                                            <td class="px-6 py-4 text-sm text-slate-600">
                                                <div class="max-w-xs truncate">${log.entityName || '�� ?��'}</div>
                                                <div class="text-[10px] text-slate-400 mt-1">${log.details || '�� ?��'}</div>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                ${UI.badge(log.status || 'recorded', 'emerald')}
                                            </td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                            ${auditLogs.length > 100 ? `<div class="p-4 text-center text-slate-500 text-xs">Affichage des 100 premiers r�sultats. Total: ${auditLogs.length}</div>` : ''}
                        </div>
                    </div>
                </div>`;
        },

        exportAuditLog() {
            const auditLogs = CORE.db.auditLogs || [];
            if (auditLogs.length === 0) {
                UI.toast('Aucun �v�nement �� exporter', 'warning');
                return;
            }

            // Prepare CSV data
            const headers = ['Date', 'Heure', 'Utilisateur', 'R��le', 'Action', 'Entit�', 'ID', 'Nom', 'D�tails', 'Avant', 'Apr��s', 'Statut'];
            const rows = auditLogs.map(log => [
                new Date(log.timestamp).toLocaleDateString('fr-FR'),
                new Date(log.timestamp).toLocaleTimeString('fr-FR'),
                log.userName || '�� ?��',
                log.userRole || '�� ?��',
                log.action || '�� ?��',
                log.entity || '�� ?��',
                log.entityId || '�� ?��',
                log.entityName || '�� ?��',
                log.details || '�� ?��',
                log.before ? JSON.stringify(log.before) : '�� ?��',
                log.after ? JSON.stringify(log.after) : '�� ?��',
                log.status || '�� ?��'
            ]);

            // Create CSV content
            let csv = headers.map(h => `"${h}"`).join(',') + '\n';
            csv += rows.map(r => r.map(v => {
                const str = String(v || '');
                return `"${str.replace(/"/g, '""')}"`;
            }).join(',')).join('\n');

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `journal_audit_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            UI.toast('Audit log export� en CSV', 'success');
        },

        showDailyDigestConfig() {
            const posId = CORE.state.currentUser?.pos;
            const config = CORE.getDailyDigestConfig(posId) || {
                posId,
                enabled: false,
                sendTime: '06:00',
                recipients: [],
                includeVentes: true,
                includeDepots: true,
                includeIncidents: true,
                includeKPIs: true
            };

            UI.modal('�� � � Configuration Digest Quotidien', `
                <div class="space-y-4">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                        <div class="flex items-start gap-3">
                            <i data-lucide="info" class="w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0"></i>
                            <p class="text-sm text-amber-700">Le digest quotidien r�capitule les ventes, d�p��ts, incidents et KPIs chaque matin.</p>
                        </div>
                    </div>

                    <!-- Activation -->
                    <div class="flex items-center justify-between p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div>
                            <div class="font-black text-slate-900">Activer le digest</div>
                            <div class="text-xs text-slate-500">Envoyer chaque matin</div>
                        </div>
                        <input type="checkbox" id="digest_enabled" ${config.enabled ? 'checked' : ''} class="w-5 h-5">
                    </div>

                    <!-- Heure d'envoi -->
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Heure d'envoi</label>
                        <input type="time" id="digest_time" value="${config.sendTime}" class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-amber-500">
                    </div>

                    <!-- Email destinataires -->
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Destinataires (emails)</label>
                        <textarea id="digest_recipients" placeholder="user@example.com&#10;autre@example.com" class="w-full px-4 py-2 border border-slate-200 rounded-xl h-20 focus:ring-2 focus:ring-amber-500">${config.recipients.join('\\n')}</textarea>
                        <div class="text-[10px] text-slate-500 mt-1">Un email par ligne</div>
                    </div>

                    <!-- Contenu du digest -->
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl space-y-3">
                        <div class="font-black text-slate-900 text-sm">�l�ments �� inclure</div>
                        
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="digest_ventes" ${config.includeVentes ? 'checked' : ''}>
                            <label for="digest_ventes" class="text-sm font-black text-slate-700 cursor-pointer">��Ÿ?Š R�sum� des ventes</label>
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="digest_depots" ${config.includeDepots ? 'checked' : ''}>
                            <label for="digest_depots" class="text-sm font-black text-slate-700 cursor-pointer">��Ÿ? � D�p��ts du jour</label>
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="digest_incidents" ${config.includeIncidents ? 'checked' : ''}>
                            <label for="digest_incidents" class="text-sm font-black text-slate-700 cursor-pointer">��š ��� � � Incidents</label>
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="digest_kpis" ${config.includeKPIs ? 'checked' : ''}>
                            <label for="digest_kpis" class="text-sm font-black text-slate-700 cursor-pointer">��Ÿ?�? KPIs cl�s</label>
                        </div>
                    </div>

                    <!-- Test -->
                    <button onclick="GestionnaireModule.testDailyDigest()" class="w-full px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-black hover:bg-slate-200 transition text-sm">
                        ��Ÿ? � Envoyer un test maintenant
                    </button>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'GestionnaireModule.saveDailyDigestConfig()', class: 'px-5 py-2.5 bg-amber-600 text-white font-black rounded-xl hover:bg-amber-700 transition' }
            ]);
        },

        saveDailyDigestConfig() {
            const posId = CORE.state.currentUser?.pos;
            const enabled = document.getElementById('digest_enabled')?.checked || false;
            const sendTime = document.getElementById('digest_time')?.value || '06:00';
            const recipientsText = document.getElementById('digest_recipients')?.value || '';
            const recipients = recipientsText.split('\\n').map(e => e.trim()).filter(e => e.length > 0);
            
            const includeVentes = document.getElementById('digest_ventes')?.checked !== false;
            const includeDepots = document.getElementById('digest_depots')?.checked !== false;
            const includeIncidents = document.getElementById('digest_incidents')?.checked !== false;
            const includeKPIs = document.getElementById('digest_kpis')?.checked !== false;

            const config = CORE.setDailyDigestConfig(posId, {
                enabled,
                sendTime,
                recipients,
                includeVentes,
                includeDepots,
                includeIncidents,
                includeKPIs
            });

            UI.closeModal();
            UI.toast('Configuration du digest enregistr�e', 'success');
            App.rerender();
        },

        testDailyDigest() {
            const posId = CORE.state.currentUser?.pos;
            const digest = CORE.sendDailyDigest(posId);
            if (!digest) {
                UI.toast('Le digest n\'est pas configur� ou pas activ�', 'warning');
            } else {
                UI.toast(`Test de digest envoy� pour ${digest.posName}`, 'success');
            }
        },

        renderIncidentCenter() {
            const posId = CORE.state.currentUser?.pos;
            const filters = {
                status: document.getElementById('inc_status')?.value || 'tous',
                type: document.getElementById('inc_type')?.value || 'tous',
                severity: document.getElementById('inc_severity')?.value || 'tous',
                slaStatus: document.getElementById('inc_sla')?.value || 'tous',
                search: document.getElementById('inc_search')?.value || ''
            };

            const filterObj = {};
            if (filters.status !== 'tous') filterObj.status = filters.status;
            if (filters.type !== 'tous') filterObj.type = filters.type;
            if (filters.severity !== 'tous') filterObj.severity = filters.severity;
            if (filters.slaStatus !== 'tous') filterObj.slaStatus = filters.slaStatus;
            if (filters.search) filterObj.search = filters.search;

            // Filtrer les incidents par POS du gestionnaire
            const allIncidents = CORE.getIncidents(filterObj);
            const incidents = allIncidents.filter(i => i.posId == posId || !i.posId);
            
            // Calculer les stats filtr�es par POS
            const posIncidents = (CORE.db.incidents || []).filter(i => i.posId == posId || !i.posId);
            const stats = {
                open: posIncidents.filter(i => i.status === 'ouvert').length,
                inProgress: posIncidents.filter(i => i.status === 'en-cours').length,
                resolved: posIncidents.filter(i => i.status === 'r�solu' || i.status === 'ferm�').length,
                slaBreached: posIncidents.filter(i => i.slaStatus === 'd�pass�').length
            };
            
            const slaColorMap = { 'en-cours': 'bg-blue-50 border-blue-200', 'atteint': 'bg-emerald-50 border-emerald-200', 'd�pass�': 'bg-red-50 border-red-200' };
            const statusColorMap = { 'ouvert': 'bg-red-100 text-red-800', 'en-cours': 'bg-blue-100 text-blue-800', 'r�solu': 'bg-emerald-100 text-emerald-800', 'ferm�': 'bg-slate-100 text-slate-800' };
            const severityColorMap = { 'haute': 'text-red-600', 'moyenne': 'text-amber-600', 'basse': 'text-blue-600' };

            return `
                <div class="fade-in space-y-6">
                    <!-- Statistiques -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-red-500 to-red-600 text-white p-6 rounded-2xl shadow-sm">
                            <div class="text-xs font-black uppercase tracking-wider opacity-90">Incidents ouverts</div>
                            <div class="text-3xl font-black mt-2">${stats.open}</div>
                            <div class="text-xs opacity-75 mt-1">En attente d'action</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-orange-600 text-white p-6 rounded-2xl shadow-sm">
                            <div class="text-xs font-black uppercase tracking-wider opacity-90">SLA d�pass�s</div>
                            <div class="text-3xl font-black mt-2">${stats.slaBreached}</div>
                            <div class="text-xs opacity-75 mt-1">Hors d�lai</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-2xl shadow-sm">
                            <div class="text-xs font-black uppercase tracking-wider opacity-90">En cours</div>
                            <div class="text-3xl font-black mt-2">${stats.inProgress}</div>
                            <div class="text-xs opacity-75 mt-1">Assign�s</div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 text-white p-6 rounded-2xl shadow-sm">
                            <div class="text-xs font-black uppercase tracking-wider opacity-90">R�solus</div>
                            <div class="text-3xl font-black mt-2">${stats.resolved}</div>
                            <div class="text-xs opacity-75 mt-1">Ferm�s avec succ��s</div>
                        </div>
                    </div>

                    <!-- Filtres -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 space-y-4">
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                            <div>
                                <input type="text" id="inc_search" placeholder="Chercher..." class="w-full px-3 py-2 border border-slate-200 rounded-xl text-sm" onkeyup="App.rerender()">
                            </div>
                            <select id="inc_status" class="px-3 py-2 border border-slate-200 rounded-xl text-sm" onchange="App.rerender()">
                                <option value="tous">Tous les statuts</option>
                                <option value="ouvert">Ouvert</option>
                                <option value="en-cours">En cours</option>
                                <option value="r�solu">R�solu</option>
                                <option value="ferm�">Ferm�</option>
                            </select>
                            <select id="inc_type" class="px-3 py-2 border border-slate-200 rounded-xl text-sm" onchange="App.rerender()">
                                <option value="tous">Tous les types</option>
                                <option value="retard">Retard</option>
                                <option value="annulation">Annulation</option>
                                <option value="litige">Litige</option>
                            </select>
                            <select id="inc_severity" class="px-3 py-2 border border-slate-200 rounded-xl text-sm" onchange="App.rerender()">
                                <option value="tous">Toutes s�v�rit�s</option>
                                <option value="haute">Haute</option>
                                <option value="moyenne">Moyenne</option>
                                <option value="basse">Basse</option>
                            </select>
                            <select id="inc_sla" class="px-3 py-2 border border-slate-200 rounded-xl text-sm" onchange="App.rerender()">
                                <option value="tous">Tous SLA</option>
                                <option value="en-cours">En cours</option>
                                <option value="atteint">Atteint</option>
                                <option value="d�pass�">D�pass� ��š ��� � �</option>
                            </select>
                        </div>
                    </div>

                    <!-- Table d'incidents -->
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-black text-slate-900">Incidents (${incidents.length})</h3>
                            <div class="flex gap-2">
                                ${window._incidentDrafts && window._incidentDrafts.length > 0 ? `
                                    <button onclick="GestionnaireModule.showDraftsModal()" class="px-3 py-1.5 bg-amber-500 text-white text-xs font-black rounded-lg hover:bg-amber-600 transition flex items-center gap-1">
                                        ��Ÿ?� Brouillons (${window._incidentDrafts.length})
                                    </button>
                                ` : ''}
                                <button onclick="GestionnaireModule.showNewIncidentModal()" class="px-3 py-1.5 bg-red-600 text-white text-xs font-black rounded-lg hover:bg-red-700 transition">
                                    ��ž� Nouvel incident
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th class="px-6 py-3 font-black text-slate-600">ID</th>
                                        <th class="px-6 py-3 font-black text-slate-600">Type</th>
                                        <th class="px-6 py-3 font-black text-slate-600">Description</th>
                                        <th class="px-6 py-3 font-black text-slate-600">Statut</th>
                                        <th class="px-6 py-3 font-black text-slate-600">Assign�</th>
                                        <th class="px-6 py-3 font-black text-slate-600">SLA</th>
                                        <th class="px-6 py-3 font-black text-slate-600">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${incidents.length === 0 ? `<tr><td colspan="7" class="px-6 py-8 text-center text-slate-400 italic">Aucun incident trouv�</td></tr>` : ''}
                                    ${incidents.map(inc => {
                                        const timeRemaining = Math.max(0, new Date(inc.slaEndTime) - new Date());
                                        const hoursRemaining = Math.round(timeRemaining / 3600000);
                                        return `
                                            <tr class="hover:bg-slate-50 transition">
                                                <td class="px-6 py-3">
                                                    <span class="font-black text-slate-900">${inc.id}</span>
                                                </td>
                                                <td class="px-6 py-3">
                                                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100 text-xs font-bold">
                                                        ${inc.type === 'retard' ? '�� � ��� � �' : inc.type === 'annulation' ? '�� ��?' : '��š?�� � �'} ${inc.type}
                                                    </span>
                                                </td>
                                                <td class="px-6 py-3">
                                                    <div class="text-slate-900 font-medium">${inc.description.substring(0, 40)}</div>
                                                    <div class="text-xs text-slate-400">S�v�rit�: <span class="${severityColorMap[inc.severity]}">${inc.severity}</span></div>
                                                </td>
                                                <td class="px-6 py-3">
                                                    <span class="px-2 py-1 rounded-lg text-xs font-black ${statusColorMap[inc.status]}">${inc.status}</span>
                                                </td>
                                                <td class="px-6 py-3">
                                                    <div class="text-sm font-medium">${inc.assignedToName || '�� ?��'}</div>
                                                </td>
                                                <td class="px-6 py-3">
                                                    <div class="text-xs font-black">
                                                        <span class="px-2 py-1 rounded-lg ${slaColorMap[inc.slaStatus]}">${inc.slaStatus}</span>
                                                        <div class="text-slate-500 text-[10px] mt-1">${hoursRemaining}h restantes</div>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-3">
                                                    <button onclick="GestionnaireModule.showIncidentDetail('${inc.id}')" class="text-xs font-black text-blue-600 hover:text-blue-800">
                                                        Voir d�tails
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        },

        showNewIncidentModal() {
            // Types d'incidents pr�d�finis + types personnalis�s
            const defaultTypes = [
                {value: 'retard', label: '�� � ��� � � Retard de livraison'},
                {value: 'annulation', label: '�� ��? Annulation'},
                {value: 'litige', label: '��š?�� � � Litige client'}
            ];
            
            const customTypes = (CORE.db.customIncidentTypes || []).map(t => ({
                value: t.id,
                label: `${t.icon || '�� ?� �'} ${t.name}`
            }));
            
            const allTypes = [...defaultTypes, ...customTypes];
            
            // R�cup�rer les donn�es sauvegard�es si brouillon existant
            const savedDraft = window._incidentDraft;
            
            UI.modal('��ž� Cr�er un nouvel incident', `
                <div class="space-y-4">
                    <!-- Brouillons existants -->
                    ${window._incidentDrafts && window._incidentDrafts.length > 0 ? `
                        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 space-y-3">
                            <div class="font-black text-amber-900">��Ÿ?� Brouillons en attente (${window._incidentDrafts.length})</div>
                            <div class="space-y-2">
                                ${window._incidentDrafts.map((draft, idx) => `
                                    <div class="flex items-center justify-between bg-white p-2 rounded border border-amber-100">
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-slate-900 text-sm truncate">${draft.type || 'Sans type'}</div>
                                            <div class="text-xs text-slate-500 truncate">${draft.description?.substring(0, 40) || 'Sans description'}...</div>
                                        </div>
                                        <div class="flex gap-1 flex-shrink-0">
                                            <button onclick="GestionnaireModule.loadIncidentDraft(${idx})" class="px-2 py-1 bg-blue-600 text-white text-xs font-bold rounded hover:bg-blue-700 transition">Charger</button>
                                            <button onclick="GestionnaireModule.deleteIncidentDraft(${idx})" class="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded hover:bg-red-700 transition">���?�</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="border-t border-slate-200 pt-4 space-y-4">
                        <div class="space-y-2">
                            <label class="text-sm font-black text-slate-700">Type d'incident</label>
                            <div class="flex gap-2">
                                <select id="new_inc_type" class="flex-1 px-3 py-2.5 rounded-lg border border-slate-200 font-bold">
                                    <option value="">-- S�lectionner un type --</option>
                                    ${allTypes.map(t => `<option value="${t.value}" ${savedDraft?.type === t.value ? 'selected' : ''}>${t.label}</option>`).join('')}
                                    <option value="__new__" class="border-t-2 border-slate-300">��ž� Cr�er un nouveau type...</option>
                                </select>
                                <button onclick="GestionnaireModule.showNewIncidentTypeModal()" class="px-3 py-2.5 bg-blue-600 text-white font-black rounded-lg hover:bg-blue-700 transition text-sm" title="Ajouter un type">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                        
                        ${UI.select('new_inc_severity', 'S�v�rit�', [
                            {value: 'basse', label: 'Basse'},
                            {value: 'moyenne', label: 'Moyenne'},
                            {value: 'haute', label: 'Haute'}
                        ], savedDraft?.severity || 'moyenne', true)}
                        
                        <div class="space-y-2">
                            <label class="text-sm font-bold text-slate-700">Description</label>
                            <textarea id="new_inc_desc" placeholder="D�crivez l'incident en d�tail" class="w-full px-3 py-2 rounded-lg border border-slate-200 font-medium h-24 resize-none">${savedDraft?.description || ''}</textarea>
                        </div>
                        
                        ${UI.input('new_inc_entity', 'Entit� associ�e', 'text', savedDraft?.entity || '', 'ID de livraison ou commande')}
                    </div>
                </div>
            `, [
                { label: 'Mettre en pause', onclick: 'GestionnaireModule.pauseIncidentCreation()', class: 'px-5 py-2.5 bg-amber-600 text-white font-black rounded-xl hover:bg-amber-700 transition' },
                { label: 'Annuler', onclick: 'UI.closeModal(); window._incidentDraft = null;' },
                { label: 'Cr�er', onclick: 'GestionnaireModule.createNewIncident()', class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);
            
            // Gestion du changement de type
            setTimeout(() => {
                const typeSelect = document.getElementById('new_inc_type');
                if (typeSelect) {
                    typeSelect.addEventListener('change', () => {
                        if (typeSelect.value === '__new__') {
                            UI.closeModal();
                            GestionnaireModule.showNewIncidentTypeModal();
                        }
                    });
                }
                lucide.createIcons();
            }, 50);
        },

        pauseIncidentCreation() {
            const type = UI.val('new_inc_type');
            const severity = UI.val('new_inc_severity');
            const description = document.getElementById('new_inc_desc')?.value || '';
            const entity = UI.val('new_inc_entity');
            
            if (!type && !severity && !description && !entity) {
                return UI.toast('Aucune donn�e �� sauvegarder', 'info');
            }
            
            // Initialiser le tableau de brouillons
            if (!window._incidentDrafts) {
                window._incidentDrafts = [];
            }
            
            // Cr�er le brouillon
            const draft = {
                type: type,
                severity: severity,
                description: description,
                entity: entity,
                savedAt: new Date().toISOString()
            };
            
            // Ajouter le brouillon
            window._incidentDrafts.push(draft);
            
            UI.closeModal();
            UI.toast(`���?� Brouillon sauvegard�! (${window._incidentDrafts.length} brouillon(s) en attente)`, 'success');
            
            // Mettre �� jour le badge si en liste
            App.rerender();
        },

        loadIncidentDraft(index) {
            if (!window._incidentDrafts || !window._incidentDrafts[index]) {
                return UI.toast('Brouillon introuvable', 'error');
            }
            
            const draft = window._incidentDrafts[index];
            window._incidentDraft = draft;
            
            UI.closeModal();
            setTimeout(() => {
                GestionnaireModule.showNewIncidentModal();
            }, 100);
        },

        deleteIncidentDraft(index) {
            if (!window._incidentDrafts) return;
            
            window._incidentDrafts.splice(index, 1);
            
            if (window._incidentDrafts.length === 0) {
                UI.closeModal();
                UI.toast('���?� Brouillon supprim�', 'info');
            } else {
                UI.toast('���?� Brouillon supprim�', 'info');
                GestionnaireModule.showDraftsModal();
            }
        },

        showNewIncidentTypeModal() {
            UI.modal('��ž� Cr�er un nouveau type d\'incident', `
                <div class="space-y-4">
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                        Cr�ez un type d'incident personnalis� pour votre organisation
                    </div>
                    
                    <div class="space-y-2">
                        <label class="text-sm font-bold text-slate-700">Nom du type</label>
                        <input type="text" id="new_type_name" placeholder="ex: Produit endommag�, Retour" class="w-full px-3 py-2 rounded-lg border border-slate-200 font-medium">
                    </div>
                    
                    <div class="space-y-2">
                        <label class="text-sm font-bold text-slate-700">Ic��ne/Emoji (optionnel)</label>
                        <input type="text" id="new_type_icon" placeholder="ex: ��Ÿ? � ��Ÿšš ��š ��� � �" class="w-full px-3 py-2 rounded-lg border border-slate-200 font-medium" maxlength="3">
                    </div>
                    
                    <div class="space-y-2">
                        <label class="text-sm font-bold text-slate-700">Description</label>
                        <textarea id="new_type_desc" placeholder="D�crivez quand ce type d'incident devrait ��tre utilis�..." class="w-full px-3 py-2 rounded-lg border border-slate-200 font-medium h-20 resize-none"></textarea>
                    </div>
                    
                    <div class="space-y-2">
                        <label class="text-sm font-bold text-slate-700">S�v�rit� par d�faut</label>
                        <select id="new_type_severity" class="w-full px-3 py-2 rounded-lg border border-slate-200 font-bold">
                            <option value="basse">Basse</option>
                            <option value="moyenne" selected>Moyenne</option>
                            <option value="haute">Haute</option>
                        </select>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Cr�er le type', onclick: 'GestionnaireModule.createNewIncidentType()', class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        createNewIncidentType() {
            const name = document.getElementById('new_type_name')?.value?.trim();
            const icon = document.getElementById('new_type_icon')?.value?.trim() || '�� ?� �';
            const desc = document.getElementById('new_type_desc')?.value?.trim() || '';
            const defaultSeverity = document.getElementById('new_type_severity')?.value || 'moyenne';
            
            if (!name) return UI.toast('Nom requis', 'warning');
            
            // Initialiser le tableau si n�cessaire
            if (!CORE.db.customIncidentTypes) {
                CORE.db.customIncidentTypes = [];
            }
            
            // Cr�er le nouveau type
            const newType = CORE.create('customIncidentTypes', {
                name: name,
                icon: icon,
                description: desc,
                defaultSeverity: defaultSeverity,
                active: true,
                createdAt: new Date().toISOString()
            });
            
            UI.closeModal();
            UI.toast(`���?� Type d'incident "${name}" cr��!`, 'success');
            
            // R�ouvrir le modal d'incident
            setTimeout(() => {
                GestionnaireModule.showNewIncidentModal();
            }, 300);
        },

        createNewIncident() {
            const type = UI.val('new_inc_type');
            const severity = UI.val('new_inc_severity');
            const description = UI.val('new_inc_desc');
            const entity = UI.val('new_inc_entity');

            if (!type || !severity || !description || !entity) {
                return UI.toast('Tous les champs sont obligatoires', 'warning');
            }

            CORE.createIncident(type, entity, 'delivery', description, severity);
            UI.closeModal();
            UI.toast('Incident cr�� avec succ��s', 'success');
            App.rerender();
        },

        showDraftsModal() {
            if (!window._incidentDrafts || window._incidentDrafts.length === 0) {
                UI.toast('Aucun brouillon en attente', 'info');
                return;
            }

            const drafts = window._incidentDrafts;
            const draftsList = drafts.map((draft, idx) => `
                <div class="p-4 border border-slate-200 rounded-lg bg-slate-50 hover:bg-slate-100 transition">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-lg font-black">${draft.type === 'retard' ? '�� � ��� � �' : draft.type === 'annulation' ? '�� ��?' : '��š?�� � �'}</span>
                                <span class="font-black text-slate-900">${draft.type}</span>
                                <span class="px-2 py-0.5 rounded bg-slate-200 text-xs font-bold text-slate-700">${draft.severity}</span>
                            </div>
                            <div class="text-sm text-slate-700 mb-2">
                                <strong>Entit�:</strong> ${draft.entity}
                            </div>
                            <div class="text-sm text-slate-600 line-clamp-2">
                                ${draft.description}
                            </div>
                            <div class="text-xs text-slate-400 mt-2">
                                Sauvegard�: ${new Date(draft.savedAt).toLocaleString('fr-FR')}
                            </div>
                        </div>
                        <div class="flex gap-2 ml-3">
                            <button onclick="GestionnaireModule.loadIncidentDraft(${idx})" class="px-3 py-1.5 bg-blue-600 text-white text-xs font-black rounded-lg hover:bg-blue-700 transition">
                                ��� ��� � � Charger
                            </button>
                            <button onclick="GestionnaireModule.deleteIncidentDraft(${idx})" class="px-3 py-1.5 bg-red-600 text-white text-xs font-black rounded-lg hover:bg-red-700 transition">
                                ���?�
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            UI.modal(`
                <div class="space-y-4">
                    <h2 class="text-xl font-black text-slate-900">��Ÿ?� Brouillons en attente (${drafts.length})</h2>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto">
                        ${draftsList}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            lucide.createIcons();
        },

        showIncidentDetail(incidentId) {
            const incident = CORE.db.incidents.find(i => i.id === incidentId);
            if (!incident) {
                UI.toast('Incident non trouv�', 'error');
                return;
            }
            
            const history = CORE.getIncidentHistory(incident.id);
            const slaColorMap = { 'en-cours': 'text-blue-600', 'atteint': 'text-emerald-600', 'd�pass�': 'text-red-600' };
            const statusColorMap = { 'ouvert': 'bg-red-100 text-red-800', 'en-cours': 'bg-blue-100 text-blue-800', 'r�solu': 'bg-emerald-100 text-emerald-800', 'ferm�': 'bg-slate-100 text-slate-800' };

            const timeRemaining = Math.max(0, new Date(incident.slaEndTime) - new Date());
            const daysRemaining = Math.floor(timeRemaining / 86400000);
            const hoursRemaining = Math.floor((timeRemaining % 86400000) / 3600000);

            UI.modal(`Incident ${incident.id}`, `
                <div class="space-y-6">
                    <!-- En-t��te -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs text-slate-500 font-black uppercase">Type</div>
                            <div class="text-lg font-black text-slate-900 mt-1">${incident.type}</div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-500 font-black uppercase">S�v�rit�</div>
                            <div class="text-lg font-black text-slate-900 mt-1">${incident.severity}</div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div>
                        <div class="text-xs text-slate-500 font-black uppercase">Description</div>
                        <div class="mt-2 p-3 bg-slate-50 rounded-lg text-sm text-slate-700">${incident.description}</div>
                    </div>

                    <!-- Statut et SLA -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs text-slate-500 font-black uppercase">Statut</div>
                            <div class="mt-2">
                                <select id="detail_status" class="px-3 py-2 border border-slate-200 rounded-lg text-sm font-black w-full">
                                    <option value="ouvert" ${incident.status === 'ouvert' ? 'selected' : ''}>Ouvert</option>
                                    <option value="en-cours" ${incident.status === 'en-cours' ? 'selected' : ''}>En cours</option>
                                    <option value="r�solu" ${incident.status === 'r�solu' ? 'selected' : ''}>R�solu</option>
                                    <option value="ferm�" ${incident.status === 'ferm�' ? 'selected' : ''}>Ferm�</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-500 font-black uppercase">SLA</div>
                            <div class="mt-2 px-3 py-2 rounded-lg bg-slate-50 text-sm">
                                <span class="${slaColorMap[incident.slaStatus]} font-black">${incident.slaStatus}</span>
                                <div class="text-xs text-slate-500 mt-1">${daysRemaining}j ${hoursRemaining}h restantes</div>
                            </div>
                        </div>
                    </div>

                    <!-- Assignation -->
                    <div>
                        <div class="text-xs text-slate-500 font-black uppercase">Assign� ��</div>
                        <div class="mt-2">
                            <select id="detail_assignee" class="px-3 py-2 border border-slate-200 rounded-lg text-sm font-black w-full">
                                <option value="">Non assign�</option>
                                ${CORE.db.users.filter(u => u.role === 'gestionnaire' || u.role === 'manager').map(u => 
                                    `<option value="${u.id}" ${incident.assignedTo === u.id ? 'selected' : ''}>${u.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <div class="text-xs text-slate-500 font-black uppercase mb-2">Notes (${incident.notes.length})</div>
                        <div class="space-y-3 max-h-48 overflow-y-auto">
                            ${incident.notes.map(n => `
                                <div class="p-3 bg-slate-50 rounded-lg border-l-2 border-blue-400">
                                    <div class="flex justify-between text-xs">
                                        <span class="font-black text-slate-700">${n.userName}</span>
                                        <span class="text-slate-400">${new Date(n.timestamp).toLocaleString('fr-FR')}</span>
                                    </div>
                                    <div class="text-sm text-slate-700 mt-2">${n.text}</div>
                                </div>
                            `).join('')}
                        </div>
                        <textarea id="detail_note" placeholder="Ajouter une note..." class="w-full mt-3 px-3 py-2 border border-slate-200 rounded-lg text-sm" rows="3"></textarea>
                    </div>

                    <!-- R�solution -->
                    <div>
                        <div class="text-xs text-slate-500 font-black uppercase">R�solution</div>
                        <textarea id="detail_resolution" placeholder="Comment l\'incident a �t� r�solu..." class="w-full mt-2 px-3 py-2 border border-slate-200 rounded-lg text-sm" rows="2">${incident.resolution || ''}</textarea>
                    </div>

                    <!-- Historique -->
                    <div>
                        <div class="text-xs text-slate-500 font-black uppercase mb-2">Historique</div>
                        <div class="space-y-2 max-h-32 overflow-y-auto text-xs">
                            ${history.map(h => `
                                <div class="p-2 bg-slate-50 rounded text-slate-600">
                                    <span class="font-black">${h.userName}</span> - ${h.action} - ${new Date(h.timestamp).toLocaleString('fr-FR')}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Sauvegarder', onclick: `GestionnaireModule.saveIncidentChanges('${incident.id}')`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        saveIncidentChanges(incidentId) {
            const newStatus = document.getElementById('detail_status')?.value;
            const newAssignee = document.getElementById('detail_assignee')?.value;
            const noteText = document.getElementById('detail_note')?.value;
            const resolutionText = document.getElementById('detail_resolution')?.value;

            if (newStatus) {
                CORE.updateIncidentStatus(incidentId, newStatus);
            }

            if (newAssignee) {
                CORE.assignIncident(incidentId, newAssignee);
            }

            if (noteText?.trim()) {
                CORE.addIncidentNote(incidentId, noteText.trim());
            }

            if (resolutionText?.trim()) {
                CORE.setIncidentResolution(incidentId, resolutionText.trim());
            }

            UI.closeModal();
            UI.toast('Incident mis �� jour', 'success');
            App.rerender();
        },

        showIncidentConfig() {
            UI.modal('��š ��� � � Configuration Centre d\'Incidents', `
                <div class="space-y-4">
                    <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
                        <div class="font-black text-slate-900 mb-3">SLA par type et s�v�rit� (en minutes)</div>
                        
                        <div class="space-y-3">
                            <div>
                                <div class="text-xs font-black text-slate-600 mb-2">RETARDS</div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">S�v�rit� basse</label>
                                        <input type="number" id="sla_retard_basse" value="480" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">S�v�rit� moyenne</label>
                                        <input type="number" id="sla_retard_moyenne" value="240" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">S�v�rit� haute</label>
                                        <input type="number" id="sla_retard_haute" value="120" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div class="text-xs font-black text-slate-600 mb-2">ANNULATIONS</div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">S�v�rit� basse</label>
                                        <input type="number" id="sla_annul_basse" value="240" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">S�v�rit� moyenne</label>
                                        <input type="number" id="sla_annul_moyenne" value="120" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">S�v�rit� haute</label>
                                        <input type="number" id="sla_annul_haute" value="60" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div class="text-xs font-black text-slate-600 mb-2">LITIGES</div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">S�v�rit� basse</label>
                                        <input type="number" id="sla_litige_basse" value="1440" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">S�v�rit� moyenne</label>
                                        <input type="number" id="sla_litige_moyenne" value="480" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">S�v�rit� haute</label>
                                        <input type="number" id="sla_litige_haute" value="240" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                        <div class="text-xs text-blue-700 font-bold">
                            <strong>��Ÿ? � SLA:</strong> Temps imparti pour r�soudre l'incident. Les incidents avec un SLA d�pass� n�cessitent une escalade imm�diate.
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'GestionnaireModule.saveIncidentConfig()', class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);
        },

        saveIncidentConfig() {
            // Les SLA sont appliqu�s directement lors de la cr�ation d'incident dans CORE.createIncident()
            // Cette config est juste pour l'affichage et la documentation
            const config = {
                retard: {
                    basse: parseInt(document.getElementById('sla_retard_basse')?.value || 480),
                    moyenne: parseInt(document.getElementById('sla_retard_moyenne')?.value || 240),
                    haute: parseInt(document.getElementById('sla_retard_haute')?.value || 120)
                },
                annulation: {
                    basse: parseInt(document.getElementById('sla_annul_basse')?.value || 240),
                    moyenne: parseInt(document.getElementById('sla_annul_moyenne')?.value || 120),
                    haute: parseInt(document.getElementById('sla_annul_haute')?.value || 60)
                },
                litige: {
                    basse: parseInt(document.getElementById('sla_litige_basse')?.value || 1440),
                    moyenne: parseInt(document.getElementById('sla_litige_moyenne')?.value || 480),
                    haute: parseInt(document.getElementById('sla_litige_haute')?.value || 240)
                }
            };
            
            localStorage.setItem('incident_sla_config', JSON.stringify(config));
            UI.closeModal();
            UI.toast('Configuration des SLA sauvegard�e', 'success');
            App.rerender();
        },

        renderIndependentDeliveryMenApproval() {
            const posId = CORE.state.currentUser?.pos;
            const pending = CORE.getPendingDeliveryMen(posId);
            const approved = CORE.db.independentDeliveryMen.filter(dm => dm.approvalStatus === 'approved' && dm.posId == posId);
            const rejected = CORE.db.independentDeliveryMen.filter(dm => dm.approvalStatus === 'rejected' && dm.posId == posId);
            const pos = CORE.getPOS(posId);

            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">��Ÿ? � Approbation Livreurs Ind�pendants</h2>
                            <p class="text-slate-500 font-medium">Validez les demandes d'ajout de livreurs ind�pendants ${pos ? `�� ?� � <span class="text-cyan-600 font-bold">${pos.name}</span>` : ''}</p>
                        </div>
                    </div>

                    <!-- Statistiques -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm">
                            <div class="text-amber-700 text-xs font-black uppercase tracking-wider mb-2">En attente</div>
                            <div class="text-3xl font-black text-amber-600">${pending.length}</div>
                            <div class="text-xs text-amber-600 mt-1">�?� examiner</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm">
                            <div class="text-emerald-700 text-xs font-black uppercase tracking-wider mb-2">Approuv�s</div>
                            <div class="text-3xl font-black text-emerald-600">${approved.length}</div>
                            <div class="text-xs text-emerald-600 mt-1">Actifs</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm">
                            <div class="text-red-700 text-xs font-black uppercase tracking-wider mb-2">Rejet�s</div>
                            <div class="text-3xl font-black text-red-600">${rejected.length}</div>
                            <div class="text-xs text-red-600 mt-1">Refus�s</div>
                        </div>
                    </div>

                    <!-- Demandes en attente -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100">
                            <h3 class="text-xl font-black text-slate-900">�� � � En attente d'approbation</h3>
                        </div>
                        ${pending.length === 0 ? 
                            `<div class="p-12 text-center text-slate-400 italic">Aucune demande en attente</div>` :
                            `<div class="divide-y divide-slate-100">
                                ${pending.map(dm => `
                                    <div class="p-6 hover:bg-slate-50 transition flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-3 mb-2">
                                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-400 to-amber-600 flex items-center justify-center text-white font-black text-lg">
                                                    ${dm.name.charAt(0).toUpperCase()}
                                                </div>
                                                <div>
                                                    <div class="font-black text-slate-900 text-lg">${dm.name}</div>
                                                    <div class="text-sm text-slate-600">��Ÿ?ž ${dm.phone}</div>
                                                </div>
                                            </div>
                                            <div class="mt-3 space-y-2 text-sm">
                                                <div class="text-slate-700"><strong>Vendeur:</strong> ${dm.vendeurName}</div>
                                                ${dm.notes ? `<div class="text-slate-600 italic">��Ÿ? � ${dm.notes}</div>` : ''}
                                                <div class="text-xs text-slate-500">Cr��: ${CORE.formatDate(dm.createdAt)}</div>
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="GestionnaireModule.approveLivreur('${dm.id}')" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black text-sm hover:bg-emerald-700 transition flex items-center gap-2">
                                                <i data-lucide="check-circle" class="w-4 h-4"></i>
                                                Approuver
                                            </button>
                                            <button onclick="GestionnaireModule.showRejectModal('${dm.id}', '${dm.name}')" class="px-4 py-2 bg-red-600 text-white rounded-xl font-black text-sm hover:bg-red-700 transition flex items-center gap-2">
                                                <i data-lucide="x-circle" class="w-4 h-4"></i>
                                                Rejeter
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>

                    <!-- Approuv�s -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100">
                            <h3 class="text-xl font-black text-slate-900">���?� Livreurs approuv�s</h3>
                        </div>
                        ${approved.length === 0 ? 
                            `<div class="p-12 text-center text-slate-400 italic">Aucun livreur approuv�</div>` :
                            `<div class="divide-y divide-slate-100">
                                ${approved.map(dm => `
                                    <div class="p-6 hover:bg-slate-50 transition flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-3 mb-2">
                                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center text-white font-black text-lg">
                                                    ${dm.name.charAt(0).toUpperCase()}
                                                </div>
                                                <div>
                                                    <div class="font-black text-slate-900 text-lg">${dm.name}</div>
                                                    <div class="text-sm text-slate-600">��Ÿ?ž ${dm.phone}</div>
                                                </div>
                                            </div>
                                            <div class="mt-3 space-y-2 text-sm">
                                                <div class="text-slate-700"><strong>Vendeur:</strong> ${dm.vendeurName}</div>
                                                <div class="text-slate-600"><strong>Livraisons:</strong> ${dm.deliveryCount}</div>
                                                <div class="text-xs text-slate-500">Approuv�: ${CORE.formatDate(dm.approvedAt)}</div>
                                            </div>
                                        </div>
                                        <button onclick="GestionnaireModule.rejectApprovedLivreur('${dm.id}')" class="px-4 py-2 bg-red-100 text-red-700 rounded-xl font-black text-sm hover:bg-red-200 transition">
                                            Retirer
                                        </button>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>

                    <!-- Rejet�s -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100">
                            <h3 class="text-xl font-black text-slate-900">�� ��? Livreurs rejet�s</h3>
                        </div>
                        ${rejected.length === 0 ? 
                            `<div class="p-12 text-center text-slate-400 italic">Aucun livreur rejet�</div>` :
                            `<div class="divide-y divide-slate-100">
                                ${rejected.map(dm => `
                                    <div class="p-6 hover:bg-slate-50 transition">
                                        <div class="flex items-start gap-3 mb-2">
                                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center text-white font-black text-lg">
                                                ${dm.name.charAt(0).toUpperCase()}
                                            </div>
                                            <div class="flex-1">
                                                <div class="font-black text-slate-900 text-lg">${dm.name}</div>
                                                <div class="text-sm text-slate-600">��Ÿ?ž ${dm.phone}</div>
                                            </div>
                                        </div>
                                        <div class="mt-3 space-y-2 text-sm">
                                            <div class="text-slate-700"><strong>Vendeur:</strong> ${dm.vendeurName}</div>
                                            ${dm.rejectionReason ? `<div class="p-3 bg-red-50 rounded-lg text-red-700 font-medium">Raison: ${dm.rejectionReason}</div>` : ''}
                                            <div class="text-xs text-slate-500">Rejet�: ${CORE.formatDate(dm.rejectedAt)}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                </div>`;
        },

        approveLivreur(deliveryManId) {
            if (CORE.approveIndependentDeliveryMan(deliveryManId)) {
                UI.toast('Livreur approuv� avec succ��s', 'success');
                this.state.currentView = 'deliverymen';
                App.rerender();
            }
        },

        showRejectModal(deliveryManId, deliveryManName) {
            UI.modal(`Rejeter ${deliveryManName}`, `
                <div class="space-y-4">
                    <div class="p-4 bg-red-50 border border-red-200 rounded-2xl">
                        <div class="text-sm text-red-700">
                            Vous ��tes sur le point de rejeter ce livreur. Veuillez fournir une raison.
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Raison du rejet</label>
                        <textarea id="reject_reason" placeholder="Ex: Num�ro de t�l�phone invalide, documents manquants..." class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-red-500" rows="3"></textarea>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Rejeter', onclick: `GestionnaireModule.rejectLivreur('${deliveryManId}')`, class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);
        },

        rejectLivreur(deliveryManId) {
            const reason = UI.val('reject_reason') || '';
            if (CORE.rejectIndependentDeliveryMan(deliveryManId, reason)) {
                UI.closeModal();
                UI.toast('Livreur rejet�', 'success');
                this.state.currentView = 'deliverymen';
                App.rerender();
            }
        },

        rejectApprovedLivreur(deliveryManId) {
            if (!confirm('�?Štes-vous s��r de vouloir retirer ce livreur approuv�?')) return;
            if (CORE.rejectIndependentDeliveryMan(deliveryManId, 'Retir� par gestionnaire')) {
                UI.toast('Livreur retir�', 'success');
                this.state.currentView = 'deliverymen';
                App.rerender();
            }
        },

        saveSettingsConfig() {
            const enableApproval = document.getElementById('enable_approval')?.checked || false;
            
            const config = {
                independentDeliveryMenApprovalRequired: enableApproval
            };
            
            CORE.setGestionnaireSettings(config);
            UI.toast('Param��tre d\'approbation enregistr�', 'success');
            App.rerender();
        },

        getDashboardMetrics() {
            const posId = CORE.state.currentUser?.pos;
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

            // Commandes du jour
            const ordersToday = (CORE.db.orders || []).filter(o => {
                const oTime = o.createdAt ? new Date(o.createdAt) : null;
                return o.posId === posId && oTime && oTime >= startOfDay && oTime <= now;
            });

            // Revenu du jour
            const revenueToday = ordersToday.reduce((sum, o) => sum + (o.totalAmount || 0), 0);

            // Livraisons du jour
            const deliveriesToday = (CORE.db.deliveries || []).filter(d => {
                const dTime = d.createdAt ? new Date(d.createdAt) : null;
                return d.posId === posId && dTime && dTime >= startOfDay && dTime <= now;
            });

            const deliveriesSucceeded = deliveriesToday.filter(d => d.status === 'livree').length;
            const deliverySuccessRate = deliveriesToday.length > 0 ? Math.round((deliveriesSucceeded / deliveriesToday.length) * 100) : 0;

            // Tendance 7 jours
            const ordersLast7 = (CORE.db.orders || []).filter(o => {
                const oTime = o.createdAt ? new Date(o.createdAt) : null;
                return o.posId === posId && oTime && oTime >= sevenDaysAgo && oTime <= now;
            });
            const ordersPerDay7 = (ordersLast7.length / 7).toFixed(1);

            // Tendance 30 jours
            const ordersLast30 = (CORE.db.orders || []).filter(o => {
                const oTime = o.createdAt ? new Date(o.createdAt) : null;
                return o.posId === posId && oTime && oTime >= thirtyDaysAgo && oTime <= now;
            });
            const totalRevenue30 = ordersLast30.reduce((sum, o) => sum + (o.totalAmount || 0), 0);

            // Commandes en cours
            const ordersPending = ordersToday.filter(o => ['pending', 'confirmed', 'preparing'].includes(o.status)).length;

            // Incidents
            const incidents = (CORE.db.incidents || []).filter(i => i.posId === posId && !i.resolved);

            return {
                ordersToday: ordersToday.length,
                revenueToday,
                deliverySuccessRate,
                ordersPerDay7,
                totalRevenue30,
                ordersPending,
                incidentsOpen: incidents.length,
                deliveriesToday: deliveriesToday.length
            };
        },

        renderDashboard() {
            const posId = CORE.state.currentUser?.pos;
            const pos = CORE.getPOS(posId);
            const metrics = this.getDashboardMetrics();
            const now = new Date();
            const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            return `
                <div class="fade-in space-y-6">
                    <!-- En-t��te avec heure -->
                    <div class="flex items-start justify-between">
                        <div>
                            <h1 class="text-3xl font-black text-slate-900">��Ÿ?Š Tableau de bord</h1>
                            <p class="text-slate-500 font-medium mt-1">${pos ? pos.name : 'POS'} �� ?� � Mise �� jour: ${timeStr}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-400">${now.toLocaleDateString('fr-FR')}</div>
                            <div class="text-2xl font-black text-slate-900 mt-1">${timeStr}</div>
                        </div>
                    </div>

                    <!-- Cartes de synth��se principales -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <!-- Commandes du jour -->
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-2xl p-6 shadow-sm">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-blue-600 text-sm font-bold uppercase tracking-wider">Commandes</p>
                                    <p class="text-4xl font-black text-slate-900 mt-2">${metrics.ordersToday}</p>
                                    <p class="text-xs text-blue-700 mt-3">��Ÿ?�? ${metrics.ordersPerDay7}/jour (moy 7j)</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-200 rounded-xl flex items-center justify-center text-blue-600">
                                    <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Revenu du jour -->
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 border border-emerald-200 rounded-2xl p-6 shadow-sm">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-emerald-600 text-sm font-bold uppercase tracking-wider">Revenu jour</p>
                                    <p class="text-4xl font-black text-slate-900 mt-2">${CORE.formatPrice(metrics.revenueToday)}</p>
                                    <p class="text-xs text-emerald-700 mt-3">��Ÿ?Š ${CORE.formatPrice(metrics.totalRevenue30 / 30)}/jour (moy 30j)</p>
                                </div>
                                <div class="w-12 h-12 bg-emerald-200 rounded-xl flex items-center justify-center text-emerald-600">
                                    <i data-lucide="trending-up" class="w-6 h-6"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Taux r�ussite livraisons -->
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 border border-amber-200 rounded-2xl p-6 shadow-sm">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-amber-600 text-sm font-bold uppercase tracking-wider">Livraisons</p>
                                    <p class="text-4xl font-black text-slate-900 mt-2">${metrics.deliverySuccessRate}%</p>
                                    <p class="text-xs text-amber-700 mt-3">${metrics.deliveriesToday} course${metrics.deliveriesToday > 1 ? 's' : ''} (${metrics.deliveriesSucceeded} r�ussies)</p>
                                </div>
                                <div class="w-12 h-12 bg-amber-200 rounded-xl flex items-center justify-center text-amber-600">
                                    <i data-lucide="truck" class="w-6 h-6"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Incidents ouverts -->
                        <div class="bg-gradient-to-br from-red-50 to-red-100 border ${metrics.incidentsOpen > 0 ? 'border-red-300' : 'border-red-200'} rounded-2xl p-6 shadow-sm">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-red-600 text-sm font-bold uppercase tracking-wider">Incidents</p>
                                    <p class="text-4xl font-black text-slate-900 mt-2">${metrics.incidentsOpen}</p>
                                    <p class="text-xs text-red-700 mt-3">${metrics.ordersPending} commande${metrics.ordersPending > 1 ? 's' : ''} en attente</p>
                                </div>
                                <div class="w-12 h-12 bg-red-200 rounded-xl flex items-center justify-center text-red-600">
                                    <i data-lucide="alert-circle" class="w-6 h-6"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Graphiques de tendance -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Tendance commandes 7 jours -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-black text-slate-900">��Ÿ?�? Commandes (7 derniers jours)</h3>
                                <span class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold">Tendance</span>
                            </div>
                            <div class="h-48 flex items-end justify-around gap-2">
                                ${Array.from({length: 7}).map((_, i) => {
                                    const date = new Date(new Date().getTime() - (6 - i) * 24 * 60 * 60 * 1000);
                                    const startOfDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                                    const endOfDay = new Date(startOfDay.getTime() + 24 * 60 * 60 * 1000);
                                    const posId = CORE.state.currentUser?.pos;
                                    const dayOrders = (CORE.db.orders || []).filter(o => {
                                        const oTime = o.createdAt ? new Date(o.createdAt) : null;
                                        return o.posId === posId && oTime && oTime >= startOfDay && oTime < endOfDay;
                                    });
                                    const maxHeight = 100;
                                    const height = Math.max(10, (dayOrders.length / (metrics.ordersToday || 1)) * maxHeight);
                                    return `
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="w-6 bg-gradient-to-t from-blue-500 to-blue-400 rounded-t transition hover:from-blue-600 hover:to-blue-500" style="height: ${height}%;" title="${dayOrders.length} cmd"></div>
                                            <span class="text-[10px] text-slate-500 font-bold">${['L', 'M', 'M', 'J', 'V', 'S', 'D'][date.getDay()]}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Tendance revenu 30 jours -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-black text-slate-900">��Ÿ? � Revenu (30 derniers jours)</h3>
                                <span class="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full font-bold">Total</span>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-600">Total 30j</span>
                                    <span class="font-black text-emerald-600">${CORE.formatPrice(metrics.totalRevenue30)}</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-3">
                                    <div class="bg-gradient-to-r from-emerald-400 to-emerald-600 h-3 rounded-full" data-width="${Math.min(100, (metrics.totalRevenue30 / 1000000) * 100)}"></div>
                                </div>
                                <div class="flex items-center justify-between pt-2">
                                    <span class="text-sm text-slate-600">Moyenne/jour</span>
                                    <span class="font-bold text-slate-900">${CORE.formatPrice(metrics.totalRevenue30 / 30)}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alertes et recommandations -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                        <h3 class="font-black text-slate-900 mb-4">��ŸŽ � Recommandations</h3>
                        <div class="space-y-2">
                            ${metrics.deliverySuccessRate < 80 ? `<div class="p-3 bg-amber-50 border border-amber-200 rounded-xl text-sm"><span class="font-bold text-amber-700">��š ��� � � Taux livraison:</span> <span class="text-amber-600">${metrics.deliverySuccessRate}% (cible: 80%+)</span></div>` : ''}
                            ${metrics.ordersPending > 10 ? `<div class="p-3 bg-red-50 border border-red-200 rounded-xl text-sm"><span class="font-bold text-red-700">��Ÿ� � Commandes en attente:</span> <span class="text-red-600">${metrics.ordersPending} commandes (r�duire les retards)</span></div>` : ''}
                            ${metrics.incidentsOpen > 0 ? `<div class="p-3 bg-red-50 border border-red-200 rounded-xl text-sm"><span class="font-bold text-red-700">��Ÿš � Incidents ouverts:</span> <span class="text-red-600">${metrics.incidentsOpen} incident(s) �� r�soudre</span></div>` : ''}
                            ${metrics.deliverySuccessRate >= 80 && metrics.ordersPending <= 10 && metrics.incidentsOpen === 0 ? `<div class="p-3 bg-emerald-50 border border-emerald-200 rounded-xl text-sm"><span class="font-bold text-emerald-700">���?� Tout va bien!</span> <span class="text-emerald-600">Continuez comme ��a!</span></div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        },

        showRoleManagementModal() {
            const customRoles = CORE.getCustomRoles();
            
            UI.modal('��Ÿ� � Gestion des R��les et Permissions', `
                <div class="max-h-[600px] overflow-y-auto">
                    <div class="space-y-4">
                        <!-- Bouton cr�er r��le -->
                        <button onclick="GestionnaireModule.showCreateRoleModal()" class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-black hover:from-blue-700 hover:to-blue-800 transition">
                            ��ž� Cr�er un nouveau r��le personnalis�
                        </button>

                        <!-- R��les standard pr�d�finis -->
                        <div class="bg-slate-50 rounded-2xl border border-slate-200 p-4">
                            <h3 class="font-black text-slate-900 mb-3">��Ÿ?� R��les pr�d�finis</h3>
                            <div class="space-y-2">
                                <div class="p-3 rounded-lg bg-white border border-emerald-200 cursor-pointer hover:shadow-md transition" onclick="GestionnaireModule.showRoleDetails('superviseur_vendeurs', 'Superviseur Vendeurs')">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-black text-slate-900">��Ÿ? � Superviseur Vendeurs</p>
                                            <p class="text-xs text-slate-500 mt-1">G��re les vendeurs et les commandes</p>
                                        </div>
                                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
                                    </div>
                                </div>
                                <div class="p-3 rounded-lg bg-white border border-blue-200 cursor-pointer hover:shadow-md transition" onclick="GestionnaireModule.showRoleDetails('responsable_livraison', 'Responsable Livraison')">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-black text-slate-900">��Ÿšš Responsable Livraison</p>
                                            <p class="text-xs text-slate-500 mt-1">G��re les livraisons et les incidents</p>
                                        </div>
                                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
                                    </div>
                                </div>
                                <div class="p-3 rounded-lg bg-white border border-amber-200 cursor-pointer hover:shadow-md transition" onclick="GestionnaireModule.showRoleDetails('superviseur_stocks', 'Superviseur Stocks')">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-black text-slate-900">��Ÿ? � Superviseur Stocks</p>
                                            <p class="text-xs text-slate-500 mt-1">G��re les stocks et la r�conciliation</p>
                                        </div>
                                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- R��les personnalis�s -->
                        ${customRoles.length > 0 ? `
                            <div class="bg-slate-50 rounded-2xl border border-slate-200 p-4">
                                <h3 class="font-black text-slate-900 mb-3">��š ?��� � � R��les personnalis�s (${customRoles.length})</h3>
                                <div class="space-y-2">
                                    ${customRoles.map(role => `
                                        <div class="p-3 rounded-lg bg-white border border-slate-200 hover:shadow-md transition">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <p class="font-black text-slate-900">${role.name}</p>
                                                    <p class="text-xs text-slate-500 mt-1">Base: ${role.baseRole === 'superviseur_vendeurs' ? '��Ÿ? � Superviseur Vendeurs' : role.baseRole === 'responsable_livraison' ? '��Ÿšš Responsable Livraison' : '��Ÿ? � Superviseur Stocks'}</p>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <button onclick="GestionnaireModule.showEditRoleModal('${role.id}')" class="text-blue-600 font-black text-xs hover:text-blue-700">�diter</button>
                                                    <button onclick="GestionnaireModule.deleteRole('${role.id}')" class="text-red-600 font-black text-xs hover:text-red-700">Supprimer</button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Info -->
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-xl text-xs text-blue-700">
                            <strong>��Ÿ? � Tip:</strong> Les r��les personnalis�s permettent une gestion fine des permissions par utilisateur.
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showCreateRoleModal() {
            UI.modal('Cr�er un nouveau r��le', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-black text-slate-600 mb-2">Nom du r��le</label>
                        <input type="text" id="role_name" placeholder="Ex: Responsable Qualit�" class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-600 mb-2">Bas� sur</label>
                        <select id="role_base" class="w-full px-4 py-2 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-500">
                            <option value="">-- S�lectionner --</option>
                            <option value="superviseur_vendeurs">��Ÿ? � Superviseur Vendeurs</option>
                            <option value="responsable_livraison">��Ÿšš Responsable Livraison</option>
                            <option value="superviseur_stocks">��Ÿ? � Superviseur Stocks</option>
                        </select>
                    </div>
                    <div class="p-3 bg-amber-50 border border-amber-200 rounded-xl text-xs text-amber-700">
                        Les permissions seront pr�configu�es selon le r��le de base choisi.
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Cr�er', onclick: 'GestionnaireModule.createRole()', class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        createRole() {
            const name = UI.val('role_name');
            const baseRole = UI.val('role_base');
            if (!name || !baseRole) return UI.toast('Tous les champs sont requis', 'warning');
            
            const defaultPerms = CORE.getDefaultPermissionsForRole(baseRole);
            CORE.createCustomRole(name, baseRole, defaultPerms);
            
            // Log audit action
            CORE.logAuditAction('ROLE_CREATE', {
                roleName: name,
                baseRole: baseRole,
                permissions: Object.keys(defaultPerms),
                reversible: true
            });
            
            UI.closeModal();
            UI.toast(`R��le "${name}" cr��`, 'success');
            App.rerender();
        },

        deleteRole(roleId) {
            if (!confirm('�?Štes-vous s��r de vouloir supprimer ce r��le?')) return;
            CORE.deleteCustomRole(roleId);
            
            // Log audit action
            CORE.logAuditAction('ROLE_DELETE', {
                roleId: roleId,
                reversible: true
            });
            
            UI.toast('R��le supprim�', 'success');
            App.rerender();
        },

        showRoleDetails(baseRole, roleName) {
            const perms = CORE.getDefaultPermissionsForRole(baseRole);
            const permLabels = {
                dashboard: '��Ÿ?Š Tableau de bord',
                stocks: '��Ÿ? � Gestion stocks',
                deliveries: '��Ÿšš Suivi livraisons',
                team: '��Ÿ? � �quipe',
                planning: '��Ÿ?� Planification',
                reports: '��Ÿ?�? Rapports',
                reconciliation: '��Ÿ? � R�conciliation',
                auditlog: '��Ÿ?� Journal d\'audit',
                incidents: '��š ��� � � Centre d\'Incidents',
                settings: '��š ?��� � � Param��tres',
                createUsers: '��ž� Cr�er utilisateurs',
                editUsers: '���? ��� � � �diter utilisateurs',
                deleteUsers: '��Ÿ??�� � � Supprimer utilisateurs',
                manageRoles: '��Ÿ� � G�rer les r��les',
                viewFinances: '��Ÿ? � Voir les finances',
                exportReports: '��Ÿ? � Exporter les rapports',
                approveOrders: '���?� Approuver les commandes',
                resolveIncidents: '��Ÿ� � R�soudre les incidents'
            };

            const permGrid = Object.entries(perms).map(([key, val]) => `
                <div class="flex items-center gap-2">
                    ${val ? `<i data-lucide="check-circle" class="w-4 h-4 text-emerald-600"></i>` : `<i data-lucide="circle" class="w-4 h-4 text-slate-300"></i>`}
                    <span class="text-sm ${val ? 'text-slate-900 font-black' : 'text-slate-400'}">${permLabels[key]}</span>
                </div>
            `).join('');

            UI.modal(`��Ÿ?� D�tails: ${roleName}`, `
                <div class="space-y-3">
                    <div class="grid grid-cols-1 gap-2">
                        ${permGrid}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showEditRoleModal(roleId) {
            const roles = CORE.getCustomRoles();
            const role = roles.find(r => r.id === roleId);
            if (!role) return;

            const perms = role.permissions || {};
            const permLabels = {
                dashboard: '��Ÿ?Š Tableau de bord',
                stocks: '��Ÿ? � Gestion stocks',
                deliveries: '��Ÿšš Suivi livraisons',
                team: '��Ÿ? � �quipe',
                planning: '��Ÿ?� Planification',
                reports: '��Ÿ?�? Rapports',
                reconciliation: '��Ÿ? � R�conciliation',
                auditlog: '��Ÿ?� Journal d\'audit',
                incidents: '��š ��� � � Centre d\'Incidents',
                settings: '��š ?��� � � Param��tres',
                createUsers: '��ž� Cr�er utilisateurs',
                editUsers: '���? ��� � � �diter utilisateurs',
                deleteUsers: '��Ÿ??�� � � Supprimer utilisateurs',
                manageRoles: '��Ÿ� � G�rer les r��les',
                viewFinances: '��Ÿ? � Voir les finances',
                exportReports: '��Ÿ? � Exporter les rapports',
                approveOrders: '���?� Approuver les commandes',
                resolveIncidents: '��Ÿ� � R�soudre les incidents'
            };

            UI.modal(`�diter: ${role.name}`, `
                <div class="max-h-96 overflow-y-auto space-y-2">
                    ${Object.entries(permLabels).map(([key, label]) => `
                        <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50 cursor-pointer">
                            <input type="checkbox" id="perm_${key}" ${perms[key] ? 'checked' : ''} class="w-4 h-4">
                            <span class="text-sm font-black text-slate-900">${label}</span>
                        </label>
                    `).join('')}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: `GestionnaireModule.saveRoleChanges('${roleId}')`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        saveRoleChanges(roleId) {
            const permLabels = {
                dashboard: '��Ÿ?Š Tableau de bord',
                stocks: '��Ÿ? � Gestion stocks',
                deliveries: '��Ÿšš Suivi livraisons',
                team: '��Ÿ? � �quipe',
                planning: '��Ÿ?� Planification',
                reports: '��Ÿ?�? Rapports',
                reconciliation: '��Ÿ? � R�conciliation',
                auditlog: '��Ÿ?� Journal d\'audit',
                incidents: '��š ��� � � Centre d\'Incidents',
                settings: '��š ?��� � � Param��tres',
                createUsers: '��ž� Cr�er utilisateurs',
                editUsers: '���? ��� � � �diter utilisateurs',
                deleteUsers: '��Ÿ??�� � � Supprimer utilisateurs',
                manageRoles: '��Ÿ� � G�rer les r��les',
                viewFinances: '��Ÿ? � Voir les finances',
                exportReports: '��Ÿ? � Exporter les rapports',
                approveOrders: '���?� Approuver les commandes',
                resolveIncidents: '��Ÿ� � R�soudre les incidents'
            };

            const newPerms = {};
            Object.keys(permLabels).forEach(key => {
                newPerms[key] = document.getElementById('perm_' + key)?.checked || false;
            });

            CORE.updateCustomRole(roleId, { permissions: newPerms });
            
            // Log audit action
            CORE.logAuditAction('ROLE_UPDATE', {
                roleId: roleId,
                updatedPermissions: Object.keys(newPerms).filter(k => newPerms[k]),
                reversible: true
            });
            
            UI.closeModal();
            UI.toast('R��le mis �� jour', 'success');
            App.rerender();
        },

        showCustomReportBuilder() {
            const posId = CORE.state.currentUser?.pos;
            const today = new Date().toISOString().split('T')[0];
            const thirtyDaysAgo = new Date(new Date().getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            UI.modal('��Ÿ?Š G�n�rateur de Rapports Personnalis�s', `
                <div class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- P�riode -->
                    <div class="p-4 border border-slate-200 rounded-2xl">
                        <h3 class="font-black text-slate-900 mb-3">��Ÿ?� S�lection de la p�riode</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-600 mb-1">Du</label>
                                <input type="date" id="report_from" value="${thirtyDaysAgo}" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-600 mb-1">Au</label>
                                <input type="date" id="report_to" value="${today}" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- M�triques -->
                    <div class="p-4 border border-slate-200 rounded-2xl">
                        <h3 class="font-black text-slate-900 mb-3">��Ÿ?�? S�lection des m�triques</h3>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="metric_orders" checked class="w-4 h-4">
                                <span class="text-sm font-black text-slate-900">��Ÿ? � Commandes</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="metric_deliveries" checked class="w-4 h-4">
                                <span class="text-sm font-black text-slate-900">��Ÿšš Livraisons</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="metric_revenue" checked class="w-4 h-4">
                                <span class="text-sm font-black text-slate-900">��Ÿ? � Revenus</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="metric_stocks" class="w-4 h-4">
                                <span class="text-sm font-black text-slate-900">��Ÿ? � Stocks</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="metric_incidents" class="w-4 h-4">
                                <span class="text-sm font-black text-slate-900">��š ��� � � Incidents</span>
                            </label>
                        </div>
                    </div>

                    <!-- Format export -->
                    <div class="p-4 border border-slate-200 rounded-2xl">
                        <h3 class="font-black text-slate-900 mb-3">��Ÿ? � Format d'export</h3>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="export_format" value="csv" checked class="w-4 h-4">
                                <span class="text-sm font-black text-slate-900">��Ÿ?Š CSV (Excel)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="export_format" value="json" class="w-4 h-4">
                                <span class="text-sm font-black text-slate-900">��Ÿ?? JSON</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="export_format" value="html" class="w-4 h-4">
                                <span class="text-sm font-black text-slate-900">��Ÿ? ��� � � HTML (Impression)</span>
                            </label>
                        </div>
                    </div>

                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-xl text-xs text-blue-700">
                        <strong>��Ÿ? � Conseil:</strong> S�lectionnez les m�triques pertinentes pour r�duire la taille du rapport.
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'G�n�rer le rapport', onclick: 'GestionnaireModule.generateCustomReport()', class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        generateCustomReport() {
            const posId = CORE.state.currentUser?.pos;
            const from = UI.val('report_from');
            const to = UI.val('report_to');
            const format = document.querySelector('input[name="export_format"]:checked')?.value || 'csv';

            const metrics = [];
            if (document.getElementById('metric_orders')?.checked) metrics.push('orders');
            if (document.getElementById('metric_deliveries')?.checked) metrics.push('deliveries');
            if (document.getElementById('metric_revenue')?.checked) metrics.push('revenue');
            if (document.getElementById('metric_stocks')?.checked) metrics.push('stocks');
            if (document.getElementById('metric_incidents')?.checked) metrics.push('incidents');

            if (metrics.length === 0) return UI.toast('S�lectionnez au moins une m�trique', 'warning');
            if (!from || !to) return UI.toast('S�lectionnez une p�riode', 'warning');

            const reportData = CORE.generateReportData(posId, from, to, metrics);
            
            // Log audit action
            CORE.logAuditAction('REPORT_GENERATED', {
                dateFrom: from,
                dateTo: to,
                metrics: metrics.join(', '),
                format: format,
                reversible: false
            });
            
            UI.closeModal();
            UI.toast('Rapport g�n�r� avec succ��s', 'success');

            if (format === 'csv') {
                const csv = CORE.exportToCSV(reportData);
                const company = CORE.getCompanyName ? CORE.getCompanyName() : 'entreprise';
                const safeCompany = company.replace(/[^a-zA-Z0-9-_]/g, '_');
                const filename = `${safeCompany}_rapport_${from}_${to}.csv`;
                CORE.downloadFile(csv, filename, 'text/csv;charset=utf-8;');
            } else if (format === 'json') {
                const json = CORE.exportToJSON(reportData);
                const filename = `rapport_${from}_${to}.json`;
                CORE.downloadFile(json, filename, 'application/json;charset=utf-8;');
            } else if (format === 'html') {
                this.exportToHTML(reportData);
            }
        },

        exportToHTML(reportData) {
            const getHtmlContent = () => {
                let html = `<!DOCTYPE html>
<html lang="fr">
<head>

    <title>${reportData.reportTitle}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: white; }
        h1 { color: #1e293b; border-bottom: 3px solid #3b82f6; padding-bottom: 10px; }
        h2 { color: #475569; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 10px; text-align: left; border: 1px solid #e2e8f0; }
        th { background-color: #f1f5f9; font-weight: bold; }
        tr:nth-child(even) { background-color: #f8fafc; }
        .metric-card { background: #f0f9ff; border: 1px solid #e0f2fe; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .metric-label { font-weight: bold; color: #0369a1; }
        .metric-value { font-size: 24px; color: #1e293b; font-weight: bold; }
        .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #64748b; }
        @media print { body { margin: 0; } }
    </style>
</head>
<body>
    <h1>��Ÿ?Š ${reportData.reportTitle}</h1>
    <p><strong>P�riode:</strong> ${reportData.period.from} au ${reportData.period.to}</p>
    <p><strong>G�n�r� le:</strong> ${new Date().toLocaleString('fr-FR')}</p>`;

                // Commandes
                if (reportData.metrics.orders) {
                    const o = reportData.metrics.orders;
                    html += `
    <h2>��Ÿ? � Commandes</h2>
    <div class="metric-card">
        <div class="metric-label">Total des commandes</div>
        <div class="metric-value">${o.total}</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Montant total</div>
        <div class="metric-value">${CORE.formatPrice(o.totalAmount)}</div>
    </div>`;
                    if (Object.keys(o.byVendor || {}).length > 0) {
                        html += `<table>
        <thead><tr><th>Vendeur</th><th>Nombre de commandes</th></tr></thead>
        <tbody>`;
                        Object.entries(o.byVendor || {}).forEach(([v, count]) => {
                            html += `<tr><td>${v}</td><td>${count}</td></tr>`;
                        });
                        html += `</tbody></table>`;
                    }
                }

                // Livraisons
                if (reportData.metrics.deliveries) {
                    const d = reportData.metrics.deliveries;
                    html += `
    <h2>��Ÿšš Livraisons</h2>
    <div class="metric-card">
        <div class="metric-label">Total</div>
        <div class="metric-value">${d.total}</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Taux de r�ussite</div>
        <div class="metric-value">${d.successRate}%</div>
    </div>`;
                }

                // Revenus
                if (reportData.metrics.revenue) {
                    const r = reportData.metrics.revenue;
                    html += `
    <h2>��Ÿ? � Revenus</h2>
    <div class="metric-card">
        <div class="metric-label">Total</div>
        <div class="metric-value">${CORE.formatPrice(r.total)}</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Moyenne par jour</div>
        <div class="metric-value">${CORE.formatPrice(r.dailyAverage)}</div>
    </div>`;
                }

                // Stocks
                if (reportData.metrics.stocks) {
                    const s = reportData.metrics.stocks;
                    html += `
    <h2>��Ÿ? � Stocks</h2>
    <div class="metric-card">
        <div class="metric-label">Produits en stock faible</div>
        <div class="metric-value">${s.lowStockCount}</div>
    </div>`;
                    if (s.lowStockProducts && s.lowStockProducts.length > 0) {
                        html += `<table>
        <thead><tr><th>Produit</th><th>Stock</th><th>Minimum</th></tr></thead>
        <tbody>`;
                        s.lowStockProducts.forEach(p => {
                            html += `<tr><td>${p.name}</td><td>${p.stock}</td><td>${p.min}</td></tr>`;
                        });
                        html += `</tbody></table>`;
                    }
                }

                // Incidents
                if (reportData.metrics.incidents) {
                    const i = reportData.metrics.incidents;
                    html += `
    <h2>��š ��� � � Incidents</h2>
    <div class="metric-card">
        <div class="metric-label">Total des incidents</div>
        <div class="metric-value">${i.total}</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Taux de r�solution</div>
        <div class="metric-value">${i.resolutionRate}%</div>
    </div>`;
                }

                html += `
    <div class="footer">
        <p>Rapport g�n�r� automatiquement par ${CORE.getCompanyName()}</p>
    </div>
</body>
</html>`;
                return html;
            };

            const html = getHtmlContent();
            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
        },

        showAuditTrail() {
            const auditLog = CORE.getAuditLog();
            const stats = CORE.getAuditStats();

            let content = `
                <div class="space-y-4 max-h-[700px] overflow-y-auto">
                    <!-- Statistics -->
                    <div class="grid grid-cols-4 gap-3">
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-xl text-center">
                            <div class="text-lg font-black text-blue-600">${stats.totalActions}</div>
                            <div class="text-xs text-blue-600">Total actions</div>
                        </div>
                        <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-xl text-center">
                            <div class="text-lg font-black text-emerald-600">${stats.actionsLast24h}</div>
                            <div class="text-xs text-emerald-600">Last 24h</div>
                        </div>
                        <div class="p-3 bg-amber-50 border border-amber-200 rounded-xl text-center">
                            <div class="text-lg font-black text-amber-600">${stats.actionsLast7d}</div>
                            <div class="text-xs text-amber-600">Last 7 days</div>
                        </div>
                        <div class="p-3 bg-red-50 border border-red-200 rounded-xl text-center">
                            <div class="text-lg font-black text-red-600">${stats.reversedActions}</div>
                            <div class="text-xs text-red-600">Reversed</div>
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="flex gap-2">
                        <input type="text" id="audit_search" placeholder="��Ÿ� � Rechercher une action..." class="flex-1 px-3 py-2 border border-slate-200 rounded-xl text-sm" 
                            onkeyup="GestionnaireModule.filterAuditLog(this.value)">
                    </div>

                    <!-- Audit Log Entries -->
                    <div id="audit_entries" class="space-y-2">
            `;

            if (auditLog.length === 0) {
                content += `<div class="p-4 text-center text-slate-500">Aucune action enregistr�e</div>`;
            } else {
                auditLog.forEach(entry => {
                    const date = new Date(entry.timestamp);
                    const timeStr = date.toLocaleString('fr-FR');
                    const isReversed = entry.status === 'reversed';
                    const canReverse = entry.reversible && entry.status === 'completed';

                    let actionColor = 'bg-blue-50 border-blue-200';
                    if (entry.action.includes('DELETE')) actionColor = 'bg-red-50 border-red-200';
                    else if (entry.action.includes('CREATE')) actionColor = 'bg-emerald-50 border-emerald-200';
                    else if (entry.action.includes('UPDATE')) actionColor = 'bg-amber-50 border-amber-200';
                    else if (entry.action.includes('REVERSE')) actionColor = 'bg-purple-50 border-purple-200';

                    content += `
                        <div class="p-3 border rounded-xl ${actionColor} ${isReversed ? 'opacity-50' : ''}">
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex-1 min-w-0">
                                    <div class="font-black text-slate-900 text-sm">${entry.action}</div>
                                    <div class="text-xs text-slate-600 mt-1">
                                        <div>��Ÿ? � ${entry.userName} (${entry.userRole})</div>
                                        <div>��Ÿ� � ${timeStr}</div>
                                    </div>
                                    ${Object.keys(entry.details || {}).length > 0 ? `
                                        <div class="mt-2 p-2 bg-white bg-opacity-50 rounded text-xs text-slate-700">
                                            ${Object.entries(entry.details).map(([k, v]) => 
                                                `<div><strong>${k}:</strong> ${typeof v === 'object' ? JSON.stringify(v) : v}</div>`
                                            ).join('')}
                                        </div>
                                    ` : ''}
                                    ${isReversed ? `<div class="mt-2 text-xs font-black text-purple-600">���?? Annul�</div>` : ''}
                                </div>
                                ${canReverse ? `
                                    <button onclick="GestionnaireModule.reverseAuditAction('${entry.id}')" class="px-3 py-1 bg-red-500 text-white rounded text-xs font-black hover:bg-red-600 transition whitespace-nowrap">
                                        Annuler
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            content += `
                    </div>
                </div>
            `;

            UI.modal('��Ÿ?� Journal d\'Audit Complet', content, [
                { label: 'Fermer', onclick: 'UI.closeModal()' },
                { label: '��Ÿ? � Exporter l\'audit', onclick: 'GestionnaireModule.exportAuditLog()', class: 'px-4 py-2 bg-slate-600 text-white font-black rounded-xl hover:bg-slate-700 transition text-sm' }
            ]);
        },

        filterAuditLog(searchTerm) {
            const filtered = searchTerm ? CORE.searchAuditLog(searchTerm) : CORE.getAuditLog();
            const entriesContainer = document.getElementById('audit_entries');
            
            if (!entriesContainer) return;

            let html = '';
            if (filtered.length === 0) {
                html = `<div class="p-4 text-center text-slate-500">Aucune action trouv�e</div>`;
            } else {
                filtered.forEach(entry => {
                    const date = new Date(entry.timestamp);
                    const timeStr = date.toLocaleString('fr-FR');
                    const isReversed = entry.status === 'reversed';
                    const canReverse = entry.reversible && entry.status === 'completed';

                    let actionColor = 'bg-blue-50 border-blue-200';
                    if (entry.action.includes('DELETE')) actionColor = 'bg-red-50 border-red-200';
                    else if (entry.action.includes('CREATE')) actionColor = 'bg-emerald-50 border-emerald-200';
                    else if (entry.action.includes('UPDATE')) actionColor = 'bg-amber-50 border-amber-200';
                    else if (entry.action.includes('REVERSE')) actionColor = 'bg-purple-50 border-purple-200';

                    html += `
                        <div class="p-3 border rounded-xl ${actionColor} ${isReversed ? 'opacity-50' : ''}">
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex-1 min-w-0">
                                    <div class="font-black text-slate-900 text-sm">${entry.action}</div>
                                    <div class="text-xs text-slate-600 mt-1">
                                        <div>��Ÿ? � ${entry.userName} (${entry.userRole})</div>
                                        <div>��Ÿ� � ${timeStr}</div>
                                    </div>
                                    ${Object.keys(entry.details || {}).length > 0 ? `
                                        <div class="mt-2 p-2 bg-white bg-opacity-50 rounded text-xs text-slate-700">
                                            ${Object.entries(entry.details).map(([k, v]) => 
                                                `<div><strong>${k}:</strong> ${typeof v === 'object' ? JSON.stringify(v) : v}</div>`
                                            ).join('')}
                                        </div>
                                    ` : ''}
                                    ${isReversed ? `<div class="mt-2 text-xs font-black text-purple-600">���?? Annul�</div>` : ''}
                                </div>
                                ${canReverse ? `
                                    <button onclick="GestionnaireModule.reverseAuditAction('${entry.id}')" class="px-3 py-1 bg-red-500 text-white rounded text-xs font-black hover:bg-red-600 transition whitespace-nowrap">
                                        Annuler
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            entriesContainer.innerHTML = html;
        },

        reverseAuditAction(auditId) {
            if (!confirm('�?Štes-vous s��r de vouloir annuler cette action?')) return;
            
            const result = CORE.reverseAuditAction(auditId);
            if (result.success) {
                UI.toast('Action annul�e avec succ��s', 'success');
                this.showAuditTrail();
            } else {
                UI.toast(result.message, 'error');
            }
        },

        exportAuditLog() {
            const auditLog = CORE.getAuditLog();
            const csv = ['Timestamp,User,Role,Action,Details,Status'].concat(
                auditLog.map(entry => {
                    const details = Object.entries(entry.details || {})
                        .map(([k, v]) => `${k}:${v}`)
                        .join('|');
                    return `"${entry.timestamp}","${entry.userName}","${entry.userRole}","${entry.action}","${details}","${entry.status}"`;
                })
            ).join('\n');

            const company = CORE.getCompanyName ? CORE.getCompanyName() : 'entreprise';
            const safeCompany = company.replace(/[^a-zA-Z0-9-_]/g, '_');
            const filename = `${safeCompany}_audit_log_${new Date().toISOString().split('T')[0]}.csv`;
            CORE.downloadFile(csv, filename, 'text/csv;charset=utf-8;');
            UI.toast('Audit log export�', 'success');
        },

        renderFinance() {
            const view = this.state.financeView || 'overview';
            
            return view === 'overview' ? this.renderFinanceGestionnaire() :
                   view === 'transactions' ? this.renderFinanceTransactionsGestionnaire() :
                   view === 'income' ? this.renderFinanceIncomeGestionnaire() :
                   view === 'expenses' ? this.renderFinanceExpensesGestionnaire() :
                   this.renderFinanceGestionnaire();
        },

        renderFinanceTransactionsGestionnaire() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.state.currentUser?.pos;
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'Mon POS';
            const dateFrom = CORE.state.financeDateFrom || '';
            const dateTo = CORE.state.financeDateTo || '';
            
            let allTxs = CORE.db.financialTransactions?.filter(t => t.posId == userPos) || [];
            if (dateFrom) allTxs = allTxs.filter(t => new Date(t.createdAt) >= new Date(dateFrom));
            if (dateTo) allTxs = allTxs.filter(t => new Date(t.createdAt) <= new Date(dateTo));
            allTxs = allTxs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="GestionnaireModule.state.currentView = 'finance'; GestionnaireModule.state.financeView = '${v}'; App.rerender()" class="px-3 py-2 rounded-lg font-bold text-xs transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-cyan-500 to-teal-600 text-white shadow-lg shadow-cyan-500/30' : 'bg-slate-400/10 text-slate-400 hover:bg-slate-400/20 border border-slate-400/30'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-5">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-teal-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-cyan-500/30">
                                    <i data-lucide="list" class="w-6 h-6"></i>
                                </div>
                                Transactions - ${posName}
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Liste compl��te des transactions financi��res</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aper��u', 'layout-grid')}
                            ${navBtn('transactions', 'Transactions', 'list', true)}
                            ${navBtn('income', 'Revenus', 'trending-up')}
                            ${navBtn('expenses', 'D�penses', 'trending-down')}
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="p-6 border-b border-slate-100">
                            <div class="flex flex-wrap items-center gap-4">
                                <div class="flex-1 min-w-[150px]">
                                    <input type="date" value="${dateFrom}" 
                                        onchange="CORE.state.financeDateFrom = this.value; App.rerender()"
                                        class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none font-medium" placeholder="Du">
                                </div>
                                <div class="flex-1 min-w-[150px]">
                                    <input type="date" value="${dateTo}" 
                                        onchange="CORE.state.financeDateTo = this.value; App.rerender()"
                                        class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none font-medium" placeholder="Au">
                                </div>
                                <button onclick="CORE.state.financeDateFrom=''; CORE.state.financeDateTo=''; App.rerender()" class="px-4 py-2.5 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-200 transition">
                                    R�initialiser
                                </button>
                            </div>
                        </div>

                        ${allTxs.length === 0 ? `
                            <div class="p-12 text-center">
                                <div class="text-5xl mb-2">��Ÿ? �</div>
                                <p class="text-slate-500 font-medium">Aucune transaction enregistr�e</p>
                            </div>
                        ` : `
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-slate-50 border-b border-slate-100">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-black text-slate-900 uppercase">Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-black text-slate-900 uppercase">Cat�gorie</th>
                                            <th class="px-6 py-3 text-left text-xs font-black text-slate-900 uppercase">Description</th>
                                            <th class="px-6 py-3 text-right text-xs font-black text-slate-900 uppercase">Montant</th>
                                            <th class="px-6 py-3 text-center text-xs font-black text-slate-900 uppercase">Type</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${allTxs.map(t => `
                                            <tr class="border-b border-slate-100 hover:bg-slate-50">
                                                <td class="px-6 py-3 text-sm font-bold text-slate-900">${CORE.formatDate(t.createdAt)}</td>
                                                <td class="px-6 py-3 text-sm font-bold text-slate-700">${t.category || 'Autre'}</td>
                                                <td class="px-6 py-3 text-sm text-slate-600">${t.note || '-'}</td>
                                                <td class="px-6 py-3 text-sm font-black text-right ${t.type === 'income' ? 'text-emerald-600' : 'text-red-600'}">${t.type === 'income' ? '+' : '-'}${CORE.formatPrice(t.amount)}</td>
                                                <td class="px-6 py-3 text-center text-xs font-black">
                                                    <span class="px-2 py-1 rounded-full text-white ${t.type === 'income' ? 'bg-emerald-500' : 'bg-red-500'}">${t.type === 'income' ? 'Revenu' : 'D�pense'}</span>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>
                </div>
            `;
        },

        renderFinanceIncomeGestionnaire() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.state.currentUser?.pos;
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'Mon POS';
            const dateFrom = CORE.state.financeDateFrom || '';
            const dateTo = CORE.state.financeDateTo || '';
            
            let incomeTxs = CORE.db.financialTransactions?.filter(t => t.posId == userPos && t.type === 'income') || [];
            if (dateFrom) incomeTxs = incomeTxs.filter(t => new Date(t.createdAt) >= new Date(dateFrom));
            if (dateTo) incomeTxs = incomeTxs.filter(t => new Date(t.createdAt) <= new Date(dateTo));
            
            const incomeByCategory = {};
            incomeTxs.forEach(t => {
                const cat = t.category || 'autre';
                incomeByCategory[cat] = (incomeByCategory[cat] || 0) + (t.amount || 0);
            });
            const totalIncome = Object.values(incomeByCategory).reduce((a, b) => a + b, 0);

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="GestionnaireModule.state.currentView = 'finance'; GestionnaireModule.state.financeView = '${v}'; App.rerender()" class="px-3 py-2 rounded-lg font-bold text-xs transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-cyan-500 to-teal-600 text-white shadow-lg shadow-cyan-500/30' : 'bg-slate-400/10 text-slate-400 hover:bg-slate-400/20 border border-slate-400/30'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-5">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-green-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-emerald-500/30">
                                    <i data-lucide="trending-up" class="w-6 h-6"></i>
                                </div>
                                Revenus - ${posName}
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Total: <span class="font-black text-emerald-600">${CORE.formatPrice(totalIncome)}</span></p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aper��u', 'layout-grid')}
                            ${navBtn('transactions', 'Transactions', 'list')}
                            ${navBtn('income', 'Revenus', 'trending-up', true)}
                            ${navBtn('expenses', 'D�penses', 'trending-down')}
                            <button onclick="GestionnaireModule.showNewIncomeModal()" class="px-4 py-2.5 bg-emerald-600 text-white rounded-xl font-bold text-sm hover:bg-emerald-700 transition flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> Nouveau revenu
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="text-lg font-black text-slate-900 mb-4">R�partition par Cat�gorie</h3>
                            <div class="space-y-3">
                                ${Object.entries(incomeByCategory).sort((a, b) => b[1] - a[1]).map(([cat, amount]) => {
                                    const percent = totalIncome > 0 ? Math.round((amount / totalIncome) * 100) : 0;
                                    return `
                                        <div class="p-3 rounded-xl bg-emerald-50 border border-emerald-200">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="font-bold text-slate-900">${cat}</span>
                                                <span class="text-xs font-black text-emerald-600">${percent}%</span>
                                            </div>
                                            <div class="w-full bg-emerald-200 rounded-full h-2">
                                                <div class="bg-emerald-500 h-2 rounded-full" style="width: ${percent}%"></div>
                                            </div>
                                            <div class="text-sm font-black text-slate-900 mt-2">${CORE.formatPrice(amount)}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="text-lg font-black text-slate-900 mb-4">Derniers Revenus</h3>
                            <div class="space-y-2">
                                ${incomeTxs.slice(0, 10).map(t => `
                                    <div class="p-3 rounded-xl bg-emerald-50 border border-emerald-200 flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-slate-900">${t.category}</div>
                                            <div class="text-xs text-slate-500">${CORE.formatDate(t.createdAt)}</div>
                                        </div>
                                        <div class="font-black text-emerald-600">${CORE.formatPrice(t.amount)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        renderFinanceExpensesGestionnaire() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.state.currentUser?.pos;
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'Mon POS';
            const dateFrom = CORE.state.financeDateFrom || '';
            const dateTo = CORE.state.financeDateTo || '';
            
            let expenseTxs = CORE.db.financialTransactions?.filter(t => t.posId == userPos && t.type === 'expense') || [];
            if (dateFrom) expenseTxs = expenseTxs.filter(t => new Date(t.createdAt) >= new Date(dateFrom));
            if (dateTo) expenseTxs = expenseTxs.filter(t => new Date(t.createdAt) <= new Date(dateTo));
            
            const expenseByCategory = {};
            expenseTxs.forEach(t => {
                const cat = t.category || 'autre';
                expenseByCategory[cat] = (expenseByCategory[cat] || 0) + (t.amount || 0);
            });
            const totalExpense = Object.values(expenseByCategory).reduce((a, b) => a + b, 0);

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="GestionnaireModule.state.currentView = 'finance'; GestionnaireModule.state.financeView = '${v}'; App.rerender()" class="px-3 py-2 rounded-lg font-bold text-xs transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-cyan-500 to-teal-600 text-white shadow-lg shadow-cyan-500/30' : 'bg-slate-400/10 text-slate-400 hover:bg-slate-400/20 border border-slate-400/30'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-5">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-red-500/30">
                                    <i data-lucide="trending-down" class="w-6 h-6"></i>
                                </div>
                                D�penses - ${posName}
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Total: <span class="font-black text-red-600">${CORE.formatPrice(totalExpense)}</span></p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aper��u', 'layout-grid')}
                            ${navBtn('transactions', 'Transactions', 'list')}
                            ${navBtn('income', 'Revenus', 'trending-up')}
                            ${navBtn('expenses', 'D�penses', 'trending-down', true)}
                            <button onclick="GestionnaireModule.showNewExpenseModal()" class="px-4 py-2.5 bg-red-600 text-white rounded-xl font-bold text-sm hover:bg-red-700 transition flex items-center gap-2">
                                <i data-lucide="minus-circle" class="w-4 h-4"></i> Nouvelle d�pense
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="text-lg font-black text-slate-900 mb-4">R�partition par Cat�gorie</h3>
                            <div class="space-y-3">
                                ${Object.entries(expenseByCategory).sort((a, b) => b[1] - a[1]).map(([cat, amount]) => {
                                    const percent = totalExpense > 0 ? Math.round((amount / totalExpense) * 100) : 0;
                                    return `
                                        <div class="p-3 rounded-xl bg-red-50 border border-red-200">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="font-bold text-slate-900">${cat}</span>
                                                <span class="text-xs font-black text-red-600">${percent}%</span>
                                            </div>
                                            <div class="w-full bg-red-200 rounded-full h-2">
                                                <div class="bg-red-500 h-2 rounded-full" style="width: ${percent}%"></div>
                                            </div>
                                            <div class="text-sm font-black text-slate-900 mt-2">${CORE.formatPrice(amount)}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="text-lg font-black text-slate-900 mb-4">Derni��res D�penses</h3>
                            <div class="space-y-2">
                                ${expenseTxs.slice(0, 10).map(t => `
                                    <div class="p-3 rounded-xl bg-red-50 border border-red-200 flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-slate-900">${t.category}</div>
                                            <div class="text-xs text-slate-500">${CORE.formatDate(t.createdAt)}</div>
                                        </div>
                                        <div class="font-black text-red-600">${CORE.formatPrice(t.amount)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        renderFinanceGestionnaire() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.state.currentUser?.pos;
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'Mon POS';
            const dateFrom = CORE.state.financeDateFrom || '';
            const dateTo = CORE.state.financeDateTo || '';
            
            // M�triques financi��res du POS (toutes les transactions du POS, pas seulement celles du gestionnaire)
            const metrics = CORE.getFinancialMetricsByPOS(userPos, dateFrom || null, dateTo || null);
            const cashFlow = CORE.getCashFlowByPeriod(null, 'daily', userPos);
            const lastDays = Object.entries(cashFlow).slice(-7).map(([date, flow]) => ({
                date,
                ...flow
            }));

            // Transactions filtr�es par POS
            let allTxs = CORE.db.financialTransactions?.filter(t => t.posId == userPos) || [];
            const incomeTxs = allTxs.filter(t => t.type === 'income');
            const expenseTxs = allTxs.filter(t => t.type === 'expense');

            // R�partition par m�thode de paiement
            const orders = CORE.db.orders.filter(o => o.posId == userPos);
            const paymentMethods = {
                cash: orders.filter(o => o.paymentMethod === 'cash').reduce((s, o) => s + (o.total || 0), 0),
                mobile: orders.filter(o => o.paymentMethod === 'mobile').reduce((s, o) => s + (o.total || 0), 0),
                card: orders.filter(o => o.paymentMethod === 'card').reduce((s, o) => s + (o.total || 0), 0),
                cod: orders.filter(o => o.paymentMethod === 'cod').reduce((s, o) => s + (o.total || 0), 0)
            };

            // COD en attente d'encaissement (livraisons COD valid�es mais pas encore encaiss�es)
            const codOutstandingOrders = orders.filter(o => 
                o.paymentMethod === 'cod' && 
                o.paymentStatus !== 'paid'
            );
            // Filtrer pour ne garder que celles qui ont �t� livr�es
            const codReadyToCollect = codOutstandingOrders.filter(o => {
                const delivery = CORE.db.deliveries.find(d => d.orderId === o.id);
                return delivery && delivery.status === 'livree';
            });
            const codOutstandingAmount = codReadyToCollect.reduce((sum, o) => sum + (o.total || 0), 0);

            // Top d�penses
            const expenseByCategory = {};
            expenseTxs.forEach(t => {
                const cat = t.category || 'autre';
                expenseByCategory[cat] = (expenseByCategory[cat] || 0) + (t.amount || 0);
            });
            const topExpenseCategories = Object.entries(expenseByCategory)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            // Derni��res transactions
            const recentTxs = [...allTxs].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="GestionnaireModule.state.currentView = 'finance'; GestionnaireModule.state.financeView = '${v}'; App.rerender()" class="px-3 py-2 rounded-lg font-bold text-xs transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-cyan-500 to-teal-600 text-white shadow-lg shadow-cyan-500/30' : 'bg-slate-400/10 text-slate-400 hover:bg-slate-400/20 border border-slate-400/30'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-5">
                    <!-- Header -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-teal-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-cyan-500/30">
                                    <i data-lucide="wallet" class="w-6 h-6"></i>
                                </div>
                                Finance - ${posName}
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Suivi financier de votre point de vente assign�</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aper��u', 'layout-grid', true)}
                            ${navBtn('transactions', 'Transactions', 'list')}
                            ${navBtn('income', 'Revenus', 'trending-up')}
                            ${navBtn('expenses', 'D�penses', 'trending-down')}
                        </div>
                    </div>

                    <!-- Filtres Date -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <div class="flex flex-wrap items-end gap-4">
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Du</label>
                                <input type="date" value="${dateFrom}" 
                                    onchange="CORE.state.financeDateFrom = this.value; App.rerender()"
                                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none font-medium">
                            </div>
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Au</label>
                                <input type="date" value="${dateTo}" 
                                    onchange="CORE.state.financeDateTo = this.value; App.rerender()"
                                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none font-medium">
                            </div>
                            <button onclick="CORE.state.financeDateFrom=''; CORE.state.financeDateTo=''; App.rerender()" class="px-4 py-2.5 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-200 transition">
                                R�initialiser
                            </button>
                            <button onclick="CORE.rebuildFinancialTransactions(); App.rerender()" class="px-4 py-2.5 bg-amber-500 text-white rounded-xl font-bold text-sm hover:bg-amber-600 transition flex items-center gap-2" title="R�g�n�rer les transactions">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Actualiser
                            </button>
                        </div>
                    </div>

                    <!-- KPIs Principaux -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-cyan-500 to-teal-600 rounded-2xl p-5 text-white shadow-lg shadow-cyan-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-up" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Revenus</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(metrics.totalIncome)}</div>
                                <div class="text-xs opacity-70 mt-2">${incomeTxs.length} transactions</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl p-5 text-white shadow-lg shadow-red-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-down" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">D�penses</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(metrics.totalExpenses)}</div>
                                <div class="text-xs opacity-70 mt-2">${expenseTxs.length} sorties</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-5 text-white shadow-lg shadow-blue-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="bar-chart-3" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">B�n�fice</span>
                                </div>
                                <div class="text-3xl font-black">${metrics.netProfit >= 0 ? '+' : ''}${CORE.formatPrice(metrics.netProfit)}</div>
                                <div class="text-xs opacity-70 mt-2">Marge: ${metrics.profitMargin}%</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-slate-500 to-slate-600 rounded-2xl p-5 text-white shadow-lg shadow-slate-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="package" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Total Cdes</span>
                                </div>
                                <div class="text-3xl font-black">${orders.length}</div>
                                <div class="text-xs opacity-70 mt-2">Montant: ${CORE.formatPrice(orders.reduce((s, o) => s + (o.total || 0), 0))}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Alerte COD en attente -->
                    ${codReadyToCollect.length > 0 ? `
                        <div class="bg-gradient-to-r from-amber-500 to-orange-500 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full -mr-16 -mt-16"></div>
                            <div class="relative flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center">
                                        <i data-lucide="alert-circle" class="w-8 h-8"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-black">��Ÿ? � COD �� Encaisser</h3>
                                        <p class="text-sm opacity-80">${codReadyToCollect.length} livraison(s) effectu�e(s) - L'argent est avec le(s) livreur(s)</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="text-right">
                                        <div class="text-3xl font-black">${CORE.formatPrice(codOutstandingAmount)}</div>
                                        <div class="text-xs opacity-80">�?� r�cup�rer</div>
                                    </div>
                                    <button onclick="GestionnaireModule.showCODOutstandingModal()" class="px-6 py-3 bg-white text-amber-600 rounded-xl font-black hover:bg-amber-50 transition shadow-lg">
                                        G�rer
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Contenu principal -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Gauche: M�thodes de paiement -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                <h3 class="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">
                                    <i data-lucide="credit-card" class="w-5 h-5 text-cyan-500"></i>
                                    R�partition par Paiement
                                </h3>
                                <div class="space-y-3">
                                    ${[
                                        { method: 'cash', label: '��Ÿ? � Esp��ces', color: 'emerald' },
                                        { method: 'mobile', label: '��Ÿ? � Mobile Money', color: 'blue' },
                                        { method: 'card', label: '��Ÿ? � Carte', color: 'purple' },
                                        { method: 'cod', label: '��Ÿ? � �?� la Livraison', color: 'amber' }
                                    ].map(({ method, label, color }) => {
                                        const amount = paymentMethods[method] || 0;
                                        const percent = orders.length > 0 ? Math.round((amount / (orders.reduce((s, o) => s + (o.total || 0), 0) || 1)) * 100) : 0;
                                        return `
                                            <div class="p-4 rounded-xl bg-${color}-50 border border-${color}-200">
                                                <div class="flex items-center justify-between mb-2">
                                                    <span class="font-bold text-slate-900">${label}</span>
                                                    <span class="text-xs font-black text-${color}-600">${percent}%</span>
                                                </div>
                                                <div class="w-full bg-${color}-200 rounded-full h-2">
                                                    <div class="bg-${color}-500 h-2 rounded-full" style="width: ${percent}%"></div>
                                                </div>
                                                <div class="text-sm font-black text-slate-900 mt-2">${CORE.formatPrice(amount)}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>

                            <!-- Derni��res Transactions -->
                            <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                <h3 class="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">
                                    <i data-lucide="history" class="w-5 h-5 text-teal-500"></i>
                                    Derni��res Transactions
                                </h3>
                                <div class="space-y-2">
                                    ${recentTxs.length === 0 ? `
                                        <div class="text-center text-slate-500 text-sm py-6">Aucune transaction r�cente</div>
                                    ` : recentTxs.map(t => `
                                        <div class="p-3 rounded-xl bg-slate-50 border border-slate-200 flex items-center justify-between">
                                            <div>
                                                <div class="font-black text-slate-900 text-sm">${t.category || 'Autre'}</div>
                                                <div class="text-xs text-slate-500">${CORE.formatDate(t.createdAt)}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-black text-slate-900">${t.type === 'income' ? '+' : '-'}${CORE.formatPrice(t.amount)}</div>
                                                <div class="text-xs font-bold ${t.type === 'income' ? 'text-emerald-600' : 'text-red-600'}">${t.type === 'income' ? 'Revenu' : 'D�pense'}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Droite: Top D�penses -->
                        <div class="space-y-6">
                            <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                <h3 class="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">
                                    <i data-lucide="pie-chart" class="w-5 h-5 text-red-500"></i>
                                    Top D�penses
                                </h3>
                                <div class="space-y-2">
                                    ${topExpenseCategories.length === 0 ? `
                                        <div class="text-center text-slate-500 text-sm py-6">Aucune d�pense enregistr�e</div>
                                    ` : topExpenseCategories.map(([cat, amount]) => `
                                        <div class="p-3 rounded-xl bg-red-50 border border-red-200">
                                            <div class="flex items-center justify-between mb-1">
                                                <span class="font-bold text-slate-900 text-sm">${cat}</span>
                                                <span class="text-xs font-black text-red-600">${CORE.formatPrice(amount)}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Infos POS -->
                            <div class="bg-gradient-to-br from-cyan-50 to-teal-50 rounded-2xl border border-cyan-200 p-6">
                                <h3 class="text-lg font-black text-slate-900 mb-4">��Ÿ? � Point de Vente</h3>
                                <div class="space-y-2 text-sm">
                                    <div><span class="font-bold text-slate-600">Nom:</span> <span class="font-black text-slate-900">${posName}</span></div>
                                    <div><span class="font-bold text-slate-600">Commandes:</span> <span class="font-black text-slate-900">${orders.length}</span></div>
                                    <div><span class="font-bold text-slate-600">Revenus:</span> <span class="font-black text-emerald-600">${CORE.formatPrice(metrics.totalIncome)}</span></div>
                                    <div><span class="font-bold text-slate-600">D�penses:</span> <span class="font-black text-red-600">${CORE.formatPrice(metrics.totalExpenses)}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        render() {
            const view = this.state.currentView;
            this.loadThemePreference(); // Charger le th��me pr�f�r�
            this.checkCriticalEvents(); // V�rifier les �v�nements critiques
            
            const content = view === 'dashboard' ? this.renderDashboard() :
                            view === 'stocks' ? this.renderStocks() :
                            view === 'deliveries' ? this.renderDeliveries() :
                            view === 'team' ? this.renderTeam() :
                            view === 'planning' ? this.renderPlanning() :
                            view === 'reports' ? this.renderReports() :
                            view === 'reconciliation' ? this.renderReconciliation() :
                            view === 'finance' ? this.renderFinance() :
                            view === 'auditlog' ? this.renderAuditLog() :
                            view === 'incidents' ? this.renderIncidentCenter() :
                            view === 'deliverymen' ? this.renderIndependentDeliveryMenApproval() :
                            `<div class="p-10 text-center text-slate-400 font-medium">Vue en construction</div>`;

            return `
                <div class="flex h-screen bg-slate-100">
                    <aside class="w-72 bg-gradient-to-b from-cyan-900 via-slate-900 to-slate-950 text-white flex flex-col no-print relative overflow-hidden">
                        <!-- Effets de fond -->
                        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,rgba(6,182,212,0.2),transparent_50%)] pointer-events-none"></div>
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-400 via-cyan-500 to-teal-500"></div>
                        
                        <!-- Header -->
                        <div class="p-6 flex items-center gap-4 flex-shrink-0 relative">
                            <div class="w-12 h-12 bg-gradient-to-br from-cyan-400 to-teal-500 rounded-2xl flex items-center justify-center shadow-lg shadow-cyan-500/30 ring-2 ring-white/10">
                                <i data-lucide="package" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h1 class="font-black text-xl tracking-tight">${CORE.getCompanyName()}<span class="text-cyan-400">.log</span></h1>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Gestionnaire</p>
                            </div>
                        </div>
                        
                        <!-- Navigation -->
                        <nav class="flex-1 px-4 py-2 space-y-1 overflow-y-auto">
                            ${this.renderNavItem('dashboard','layout-dashboard','Tableau de bord')}
                            ${this.renderNavItem('stocks','box','Gestion stocks')}
                            ${this.renderNavItem('deliveries','truck','Suivi livraisons')}
                            ${this.renderNavItem('deliverymen','user-check','Livreurs Ind�p.', CORE.getPendingDeliveryMen(CORE.state.currentUser?.pos).length)}
                            ${this.renderNavItem('team','users','�quipe')}
                            ${this.renderNavItem('planning','calendar','Planification')}
                            ${this.renderNavItem('finance','wallet','Finance')}
                            ${this.renderNavItem('reports','file-bar-chart','Rapports')}
                            ${this.renderNavItem('reconciliation','check-circle','R�conciliation')}
                            ${this.renderNavItem('auditlog','history','Journal d\'audit')}
                            ${this.renderNavItem('incidents','alert-circle','Centre d\'Incidents')}
                        </nav>
                        
                        <!-- Footer -->
                        <div class="p-4 border-t border-white/5 relative">
                            <button onclick="GestionnaireModule.showSettingsModal()" class="w-full flex items-center gap-3 px-4 py-3 bg-white/5 hover:bg-white/10 rounded-xl transition-all duration-200 group">
                                <i data-lucide="settings" class="w-5 h-5 text-slate-400 group-hover:text-cyan-400 group-hover:rotate-90 transition-all duration-300"></i>
                                <span class="text-sm font-bold text-slate-300 group-hover:text-white">Param��tres</span>
                            </button>
                        </div>
                    </aside>

                    <main class="flex-1 overflow-auto bg-slate-50">
                        <header class="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-20">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-xl font-black text-slate-900">Logistique & Stocks</h2>
                                    <p class="text-sm text-slate-500">Gestionnaire: ${CORE.state.currentUser?.name}</p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <button onclick="GestionnaireModule.testNotification()" class="px-3 py-2 text-xs bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition font-black">
                                        ��Ÿ�� Test
                                    </button>
                                    <button onclick="GestionnaireModule.showNotificationHistory()" class="relative px-3 py-2 rounded-xl hover:bg-slate-100 transition">
                                        <i data-lucide="bell" class="w-5 h-5 text-slate-600"></i>
                                        ${this.state.notificationHistory.length > 0 ? `<span class="absolute top-0 right-0 w-5 h-5 bg-red-500 text-white text-[10px] font-black rounded-full flex items-center justify-center">${Math.min(this.state.notificationHistory.length, 9)}${this.state.notificationHistory.length > 9 ? '+' : ''}</span>` : ''}
                                    </button>
                                    <div class="flex items-center gap-2 px-3 py-1.5 bg-amber-50 rounded-full">
                                        <span class="w-2 h-2 bg-amber-500 rounded-full pulse-dot"></span>
                                        <span class="text-sm text-amber-700 font-black">CORE connect�</span>
                                    </div>
                                </div>
                            </div>
                        </header>
                        <div class="p-6">${content}</div>
                    </main>
                    
                    ${this.renderNotificationCenter()}
                </div>`;
        },

        renderTeam() {
            const posId = CORE.state.currentUser?.pos;
            const pos = CORE.getPOS(posId);
            const vendeurs = CORE.db.users.filter(u => u.role === 'vendeur' && u.pos === posId);
            const livreurs = CORE.getLivreursForPOS(posId);
            const kpis = this.getTeamKPIs(posId);
            const alerts = this.evaluateSLA(kpis);

            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">��Ÿ? � �quipe du POS</h2>
                            <p class="text-slate-500 font-medium">${pos ? pos.name : 'POS inconnu'} �� ?� � Gestion vendeurs et livreurs</p>
                        </div>
                        <button onclick="GestionnaireModule.showSettingsModal()" class="px-3 py-2 bg-slate-900 text-white rounded-xl font-black hover:bg-slate-800 transition text-sm">Configurer SLA</button>
                    </div>

                    ${alerts.length > 0 ? `
                    <div class="p-4 rounded-2xl border ${alerts.some(a=>a.severity==='red')?'border-red-200 bg-red-50':'border-amber-200 bg-amber-50'}">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="alert-triangle" class="w-4 h-4 ${alerts.some(a=>a.severity==='red')?'text-red-600':'text-amber-600'}"></i>
                            <span class="font-black ${alerts.some(a=>a.severity==='red')?'text-red-700':'text-amber-700'}">Alertes SLA</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                            ${alerts.map(a => `<div class="text-sm"><span class="font-black">${a.label}:</span> <span class="${a.severity==='red'?'text-red-700':'text-amber-700'}">${a.value}</span> �� ?� � Seuil: ${a.threshold}</div>`).join('')}
                        </div>
                    </div>` : ''}

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">Taux livraison (d�lais)</div>
                            <div class="text-3xl font-black ${kpis.onTimeRate >= this.state.slaThresholds.minOnTimeRate ? 'text-emerald-600' : 'text-red-600'} mt-2">${kpis.onTimeRate}%</div>
                            <p class="text-[11px] text-slate-400 mt-1">Max ${this.state.slaThresholds.maxDeliveryMinutes} min</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">D�p��ts journaliers</div>
                            <div class="text-3xl font-black ${kpis.dailyDeposits >= this.state.slaThresholds.minDailyDeposits ? 'text-emerald-600' : 'text-red-600'} mt-2">${CORE.formatPrice(kpis.dailyDeposits)}</div>
                            <p class="text-[11px] text-slate-400 mt-1">Seuil min ${CORE.formatPrice(this.state.slaThresholds.minDailyDeposits)}</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">Commandes en attente</div>
                            <div class="text-3xl font-black ${kpis.pendingOrders <= this.state.slaThresholds.maxPendingOrders ? 'text-slate-900' : 'text-amber-600'} mt-2">${kpis.pendingOrders}</div>
                            <p class="text-[11px] text-slate-400 mt-1">Max ${this.state.slaThresholds.maxPendingOrders}</p>
                        </div>
                    </div>

                    <!-- Vendeurs -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-emerald-50">
                            <div>
                                <h3 class="font-black text-slate-900 text-lg">��Ÿ? � Vendeurs</h3>
                                <p class="text-xs text-slate-500 mt-1">${vendeurs.length} vendeur(s) assign�(s)</p>
                            </div>
                        </div>
                        <div class="p-4 space-y-3">
                            ${vendeurs.length === 0 ? `<div class="p-10 text-center text-slate-400 font-medium">Aucun vendeur assign� �� ce POS</div>` : ''}
                            ${vendeurs.map(v => `
                                <div class="p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 transition flex items-start justify-between">
                                    <div class="flex items-start gap-3">
                                        <div class="w-12 h-12 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-xl flex items-center justify-center text-white font-black text-lg">${v.avatar || v.name.charAt(0).toUpperCase()}</div>
                                        <div>
                                            <div class="font-black text-slate-900">${v.name}</div>
                                            <div class="text-xs text-slate-500 mt-1">${v.phone || 'Pas de t�l�phone'}</div>
                                            <div class="text-xs text-slate-400">${v.city ? CORE.getCity(v.city)?.name : 'Ville non d�finie'}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        ${v.active ? `<span class="px-3 py-1 bg-emerald-100 text-emerald-700 text-xs font-black rounded-full">Actif</span>` : `<span class="px-3 py-1 bg-slate-100 text-slate-600 text-xs font-black rounded-full">Inactif</span>`}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Livreurs -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-blue-50">
                            <div>
                                <h3 class="font-black text-slate-900 text-lg">��Ÿšš Livreurs</h3>
                                <p class="text-xs text-slate-500 mt-1">${livreurs.length} livreur(s) assign�(s)</p>
                            </div>
                        </div>
                        <div class="p-4 space-y-3">
                            ${livreurs.length === 0 ? `<div class="p-10 text-center text-slate-400 font-medium">Aucun livreur assign� �� ce POS</div>` : ''}
                            ${livreurs.map(l => `
                                <div class="p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 transition flex items-start justify-between">
                                    <div class="flex items-start gap-3">
                                        <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl flex items-center justify-center text-white font-black text-lg">${l.avatar || l.name.charAt(0).toUpperCase()}</div>
                                        <div>
                                            <div class="font-black text-slate-900">${l.name}</div>
                                            <div class="text-xs text-slate-500 mt-1">${l.phone || 'Pas de t�l�phone'}</div>
                                            <div class="text-xs text-slate-400">${l.vehicle || 'V�hicule non sp�cifi�'}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs font-black text-slate-600 mb-1">Note: ${l.rating || '�� ?��'}</div>
                                        ${l.active ? `<span class="px-3 py-1 bg-emerald-100 text-emerald-700 text-xs font-black rounded-full">Actif</span>` : `<span class="px-3 py-1 bg-slate-100 text-slate-600 text-xs font-black rounded-full">Inactif</span>`}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
        },

        renderReconciliation() {
            const posId = CORE.state.currentUser?.pos;
            const pos = CORE.getPOS(posId);
            const dateFrom = CORE.state.reconcDateFrom || '';
            const dateTo = CORE.state.reconcDateTo || '';
            
            const summary = CORE.getReconciliationSummary(posId, dateFrom || null, dateTo || null);
            const reconciliations = CORE.getDepositReconciliation(posId, dateFrom || null, dateTo || null);

            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">���?? R�conciliation des D�p��ts</h2>
                            <p class="text-slate-500 font-medium">Contr��le automatis� des �carts d�p��ts vs encaissements</p>
                        </div>
                    </div>

                    <!-- Filtres de date -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 flex gap-4 items-end flex-wrap">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Du</label>
                            <input type="date" value="${dateFrom}" onchange="CORE.state.reconcDateFrom = this.value; GestionnaireModule.state.currentView = 'reconciliation'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl">
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Au</label>
                            <input type="date" value="${dateTo}" onchange="CORE.state.reconcDateTo = this.value; GestionnaireModule.state.currentView = 'reconciliation'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl">
                        </div>
                        <button onclick="CORE.state.reconcDateFrom = ''; CORE.state.reconcDateTo = ''; GestionnaireModule.state.currentView = 'reconciliation'; App.rerender()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-black hover:bg-slate-200 transition text-sm">R�initialiser</button>
                    </div>

                    <!-- R�sum� des anomalies -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-3xl border border-slate-200 p-6">
                            <div class="text-slate-700 text-xs font-black uppercase tracking-wider mb-2">Total D�p��ts</div>
                            <div class="text-3xl font-black text-slate-900">${summary.totalDeposits}</div>
                            <div class="text-xs text-slate-600 mt-1">${CORE.formatPrice(summary.totalDeclared)}</div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-3xl border border-emerald-200 p-6">
                            <div class="text-emerald-700 text-xs font-black uppercase tracking-wider mb-2">R�concili�s ���??</div>
                            <div class="text-3xl font-black text-emerald-600">${summary.anomalies.ok}</div>
                            <div class="text-xs text-emerald-600 mt-1">${summary.anomalies.ok === summary.totalDeposits ? 'Tous OK!' : 'En cours'}</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-3xl border border-amber-200 p-6">
                            <div class="text-amber-700 text-xs font-black uppercase tracking-wider mb-2">�carts D�tect�s</div>
                            <div class="text-3xl font-black text-amber-600">${summary.anomalies.overDeclared + summary.anomalies.underDeclared}</div>
                            <div class="text-xs text-amber-600 mt-1">Montants incorrects</div>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-3xl border border-red-200 p-6">
                            <div class="text-red-700 text-xs font-black uppercase tracking-wider mb-2">Critiques ��Ÿ� �</div>
                            <div class="text-3xl font-black text-red-600">${summary.anomalies.criticalAmount}</div>
                            <div class="text-xs text-red-600 mt-1">>1000 FCFA</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-3xl border border-blue-200 p-6">
                            <div class="text-blue-700 text-xs font-black uppercase tracking-wider mb-2">Mismatch Cdes</div>
                            <div class="text-3xl font-black text-blue-600">${summary.anomalies.orderMismatch}</div>
                            <div class="text-xs text-blue-600 mt-1">Commandes manquantes</div>
                        </div>
                    </div>

                    <!-- Recommandations -->
                    ${summary.recommendations.length > 0 ? `
                    <div class="bg-white rounded-3xl border border-slate-200 p-6">
                        <h3 class="text-lg font-black text-slate-900 mb-4">��ŸŽ � Recommandations</h3>
                        <div class="space-y-2">
                            ${summary.recommendations.map(rec => `
                                <div class="p-3 rounded-xl bg-slate-50 text-sm text-slate-700"><strong>${rec.substring(0, 2)}</strong> ${rec.substring(2)}</div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- D�tail des d�p��ts -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="text-xl font-black text-slate-900">Analyse D�taill�e</h3>
                            ${reconciliations.some(r => r.anomalyType !== 'OK') ? `
                                <button onclick="GestionnaireModule.validateAllDeposits()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition text-sm">���?? Valider Tous</button>
                            ` : ''}
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 border-b border-slate-100">
                                    <tr>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">D�p��t</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">D�clar�</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">R�el</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">�cart</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Cdes</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Statut</th>
                                        <th class="px-6 py-3 text-center font-black text-slate-900">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${reconciliations.map(r => `
                                        <tr class="border-b border-slate-100 hover:bg-slate-50">
                                            <td class="px-6 py-4">
                                                <div class="font-black text-slate-900">${r.livreurName}</div>
                                                <div class="text-xs text-slate-500">${CORE.formatDate(r.timestamp)}</div>
                                            </td>
                                            <td class="px-6 py-4 font-black text-slate-900">${CORE.formatPrice(r.declaredAmount)}</td>
                                            <td class="px-6 py-4 font-black text-slate-900">${CORE.formatPrice(r.actualRevenue)}</td>
                                            <td class="px-6 py-4">
                                                <div class="font-black ${r.discrepancy > 0 ? 'text-red-600' : r.discrepancy < 0 ? 'text-orange-600' : 'text-emerald-600'}">${r.discrepancy > 0 ? '+' : ''}${CORE.formatPrice(r.discrepancy)}</div>
                                                <div class="text-xs text-slate-500">${r.discrepancyPercent}%</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="font-black text-slate-900">${r.actualCount}/${r.declaredCount}</div>
                                                ${r.orderMismatch !== 0 ? `<div class="text-xs text-red-600">��š ��� � � Mismatch: ${r.orderMismatch}</div>` : ''}
                                            </td>
                                            <td class="px-6 py-4">
                                                ${(() => {
                                                    const statusMap = {
                                                        'OK': '<span class="px-3 py-1 bg-emerald-100 text-emerald-700 text-xs font-black rounded-full">OK ���??</span>',
                                                        'OVER_DECLARED': '<span class="px-3 py-1 bg-red-100 text-red-700 text-xs font-black rounded-full">Suraugment�</span>',
                                                        'UNDER_DECLARED': '<span class="px-3 py-1 bg-orange-100 text-orange-700 text-xs font-black rounded-full">Sous-d�clar�</span>',
                                                        'CRITICAL_AMOUNT': '<span class="px-3 py-1 bg-red-100 text-red-700 text-xs font-black rounded-full">��Ÿ� � Critique</span>',
                                                        'ORDER_MISMATCH': '<span class="px-3 py-1 bg-blue-100 text-blue-700 text-xs font-black rounded-full">Mismatch Cdes</span>'
                                                    };
                                                    return statusMap[r.anomalyType] || '<span class="text-slate-500">�� ?��</span>';
                                                })()}
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                ${r.anomalyType === 'OK' ? `
                                                    <span class="text-emerald-600 font-black">���??</span>
                                                ` : `
                                                    <button onclick="GestionnaireModule.showReconciliationDetails(${r.depositId})" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg font-black text-xs hover:bg-blue-100 transition">D�tails</button>
                                                `}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- R�sum� des montants -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-slate-600 text-xs font-black uppercase mb-2">Total D�clar�</div>
                            <div class="text-3xl font-black text-slate-900">${CORE.formatPrice(summary.totalDeclared)}</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-slate-600 text-xs font-black uppercase mb-2">Total R�el</div>
                            <div class="text-3xl font-black text-emerald-600">${CORE.formatPrice(summary.totalActual)}</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-slate-600 text-xs font-black uppercase mb-2">�cart Total</div>
                            <div class="text-3xl font-black ${summary.totalDiscrepancy > 0 ? 'text-red-600' : 'text-emerald-600'}">${summary.totalDiscrepancy > 0 ? '+' : ''}${CORE.formatPrice(summary.totalDiscrepancy)}</div>
                        </div>
                    </div>
                </div>`;
        },

        renderPlanning() {
            const posId = CORE.state.currentUser?.pos;
            const pos = CORE.getPOS(posId);
            const vendeurs = CORE.db.users.filter(u => u.role === 'vendeur' && u.pos === posId);
            const livreurs = CORE.getLivreursForPOS(posId);
            const allUsers = [...vendeurs, ...livreurs];
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            
            // Afficher une semaine (7 jours)
            const days = Array.from({length: 7}, (_, i) => {
                const d = new Date(weekStart);
                d.setDate(d.getDate() + i);
                return d;
            });

            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">��Ÿ?� Planification �quipe</h2>
                            <p class="text-slate-500 font-medium">${pos ? pos.name : 'POS inconnu'} �� ?� � Calendrier des shifts et disponibilit�s</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="GestionnaireModule.showAddShiftModal()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition text-sm">+ Shift</button>
                            <button onclick="GestionnaireModule.showTimeOffModal()" class="px-4 py-2 bg-amber-600 text-white rounded-xl font-black hover:bg-amber-700 transition text-sm">Cong�s</button>
                        </div>
                    </div>

                    <!-- Calendrier des shifts -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100">
                            <h3 class="font-black text-slate-900">Semaine du ${weekStart.toLocaleDateString('fr-FR', {day:'numeric', month:'short', year:'numeric'})}</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-black text-slate-600">Personne</th>
                                        ${days.map(d => `<th class="px-4 py-3 text-center font-black text-slate-600">${d.toLocaleDateString('fr-FR', {weekday:'short', day:'numeric'})}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${allUsers.map(u => `
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-4 py-4 font-black text-slate-900">${u.name}</td>
                                            ${days.map(day => {
                                                const shifts = CORE.getShiftsByDate(posId, day).filter(s => s.userId === u.id);
                                                const timeOff = CORE.getUserTimeOff(u.id, day.toISOString().split('T')[0], day.toISOString().split('T')[0]);
                                                const hasTimeOff = timeOff.length > 0;
                                                const shiftText = shifts.length > 0 ? shifts.map(s => { const t = CORE.getShiftTemplate(s.templateId); return t ? t.name.substring(0,3) : '�� ?��'; }).join(',') : '';
                                                return `<td class="px-4 py-4 text-center"><div class="px-2 py-1 rounded-lg ${hasTimeOff ? 'bg-red-100 text-red-700 font-black text-xs' : shiftText ? 'bg-blue-100 text-blue-700 font-black text-xs' : 'text-slate-400'}">${hasTimeOff ? '�� ��?' : shiftText || '�� ?��'}</div></td>`;
                                            }).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Capacit� par cr�neau -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100">
                            <h3 class="font-black text-slate-900">Capacit� par Cr�neau (Aujourd'hui)</h3>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${Object.entries(CORE.getCapacityBySlot(posId, today)).map(([slotName, cap]) => `
                                <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                                    <div class="font-black text-slate-900 mb-2">${slotName}</div>
                                    <div class="text-xs text-slate-600 mb-3">${cap.template.startTime} - ${cap.template.endTime}</div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="text-lg font-black text-emerald-600">${cap.assigned}/${cap.capacity}</div>
                                        <div class="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
                                            <div class="h-full bg-emerald-600" data-width="${Math.min(100, (cap.assigned/cap.capacity)*100)}"></div>
                                        </div>
                                    </div>
                                    <button onclick="GestionnaireModule.quickReplacement('${slotName}', ${posId}, '${today.toISOString().split('T')[0]}')" class="w-full mt-2 px-3 py-2 bg-slate-900 text-white rounded-lg font-black text-xs hover:bg-slate-800 transition">Remplacement rapide</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
        },

        // ===== OPTIMISATION ROUTAGE LIVREURS =====
        showRouteOptimization() {
            const livreurs = CORE.getAllActiveLivreurs();
            const pendingOrders = CORE.db.orders.filter(o => o.status === 'pending');

            UI.modal('��Ÿšš Optimisation Routage Livreurs', `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <!-- S�lection livreur et commandes -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-black text-slate-900 mb-2">S�lectionner livreur</label>
                            <select id="route_livreur" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-black text-sm">
                                <option value="">-- Choisir un livreur --</option>
                                ${livreurs.map(l => `<option value="${l.id}">${l.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-black text-slate-900 mb-2">Commandes �� router (${pendingOrders.length})</label>
                            <input type="number" id="route_order_count" value="${pendingOrders.length}" min="1" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-black text-sm" readonly>
                        </div>
                    </div>

                    <!-- Aper��u des commandes -->
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <div class="font-black text-slate-900 mb-3">��Ÿ? � Commandes en attente</div>
                        <div class="max-h-48 overflow-y-auto space-y-2">
                            ${pendingOrders.length > 0 ? pendingOrders.slice(0, 10).map(o => `
                                <div class="p-2 bg-white rounded border border-slate-200 text-sm">
                                    <div class="flex justify-between">
                                        <span class="font-black">${o.clientName}</span>
                                        <span class="text-xs text-slate-500">${CORE.formatPrice(o.total)}</span>
                                    </div>
                                    <div class="text-xs text-slate-600">��Ÿ? � ${o.deliveryAddress}</div>
                                </div>
                            `).join('') : `<div class="text-slate-400 text-sm">Aucune commande en attente</div>`}
                        </div>
                    </div>

                    <!-- Options de clustering -->
                    <div class="p-4 bg-blue-50 rounded-2xl border border-blue-200">
                        <div class="font-black text-blue-900 mb-3">��š ?��� � � Param��tres d'optimisation</div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm font-black text-blue-800">Nombre de clusters</label>
                                <input type="number" id="route_clusters" value="${Math.ceil(pendingOrders.length / 8)}" min="1" max="10" class="w-full px-3 py-2 border border-blue-300 rounded-lg font-black text-sm mt-1">
                                <div class="text-xs text-blue-600 mt-1">Groupes g�ographiques d'adresses</div>
                            </div>
                        </div>
                    </div>

                    <!-- R�sultats (sera rempli apr��s optimisation) -->
                    <div id="route_results" class="hidden p-4 bg-emerald-50 rounded-2xl border border-emerald-200">
                        <div class="font-black text-emerald-900 mb-3">���?? Route Optimis�e</div>
                        <div id="route_results_content"></div>
                    </div>

                    <!-- Stats de l'optimisation -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <div class="text-xs font-black text-slate-600">Distance totale</div>
                            <div class="text-lg font-black text-slate-900 mt-2" id="route_distance">-</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <div class="text-xs font-black text-slate-600">Temps estim�</div>
                            <div class="text-lg font-black text-slate-900 mt-2" id="route_time">-</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <div class="text-xs font-black text-slate-600">Co��t estim�</div>
                            <div class="text-lg font-black text-slate-900 mt-2" id="route_cost">-</div>
                        </div>
                    </div>
                </div>
            `, [
                { 
                    label: '��Ÿ�? Optimiser Route', 
                    onclick: `
                        const livreurId = parseInt(document.getElementById('route_livreur').value);
                        const clusters = parseInt(document.getElementById('route_clusters').value);
                        if (!livreurId) {
                            UI.toast('S�lectionnez un livreur', 'warning');
                            return;
                        }
                        
                        const orders = CORE.db.orders.filter(o => o.status === 'pending');
                        if (orders.length === 0) {
                            UI.toast('Aucune commande en attente', 'warning');
                            return;
                        }

                        const route = RoutageModule.createOptimizedRoute(livreurId, orders);
                        if (route) {
                            document.getElementById('route_distance').textContent = route.totalDistance.toFixed(1) + ' km';
                            document.getElementById('route_time').textContent = route.estimatedTime + ' min';
                            document.getElementById('route_cost').textContent = CORE.formatPrice(route.estimatedCost);
                            document.getElementById('route_results').classList.remove('hidden');
                            document.getElementById('route_results_content').innerHTML = RoutageModule.visualizeRoute(route);
                            UI.toast('���?? Route optimis�e avec succ��s!', 'success');
                        } else {
                            UI.toast('Erreur lors de l\\'optimisation', 'error');
                        }
                    `, 
                    class: 'px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' 
                },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showLivreurRoutes() {
            const livreurs = CORE.getAllActiveLivreurs();

            UI.modal('��Ÿšš Routes Planifi�es - Vue Manager', `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    ${livreurs.map(livreur => {
                        const routes = RoutageModule.getRoutesByLivreur(livreur.id, CORE.todayKey());
                        return `
                            <div class="p-4 border border-slate-200 rounded-2xl">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="font-black text-slate-900">${livreur.name}</div>
                                    <span class="px-3 py-1 rounded-full text-xs font-black ${
                                        routes.length > 0 
                                        ? 'bg-emerald-100 text-emerald-700' 
                                        : 'bg-slate-100 text-slate-600'
                                    }">
                                        ${routes.length} route(s)
                                    </span>
                                </div>
                                ${routes.length > 0 ? routes.map(route => `
                                    <div class="mb-3 p-3 bg-slate-50 rounded-lg border border-slate-200">
                                        <div class="flex justify-between mb-2">
                                            <span class="font-black text-sm">${route.status === 'completed' ? '���?�' : route.status === 'in_progress' ? '��Ÿšš' : '��Ÿ?�'} ${route.status}</span>
                                            <span class="text-xs font-black text-slate-600">${route.stops.length} arr��ts �� ?� � ${route.totalDistance.toFixed(1)} km</span>
                                        </div>
                                        <button onclick="RoutageModule.showRouteDetails(${route.id})" class="text-xs font-black text-blue-600 hover:underline">
                                            Voir d�tails ���?
                                        </button>
                                    </div>
                                `).join('') : `<div class="text-sm text-slate-400">Aucune route programm�e</div>`}
                            </div>
                        `;
                    }).join('')}
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showPaymentsDashboard() {
            const posId = CORE.state.currentUser?.pos;
            const payments = (CORE.db.mobilePayments || []).filter(p => !p.posId || p.posId == posId);
            const history = CORE.db.paymentHistory || [];
            
            // Revenue by provider
            const revenueByProvider = {};
            const successByProvider = {};
            const countByProvider = {};
            payments.forEach(p => {
                if (!revenueByProvider[p.provider]) {
                    revenueByProvider[p.provider] = 0;
                    successByProvider[p.provider] = 0;
                    countByProvider[p.provider] = 0;
                }
                revenueByProvider[p.provider] += p.amount || 0;
                countByProvider[p.provider]++;
                if (p.status === 'completed') successByProvider[p.provider]++;
            });

            // Top clients by spending
            const clientSpending = {};
            payments.filter(p => p.status === 'completed').forEach(p => {
                if (!clientSpending[p.clientId]) clientSpending[p.clientId] = 0;
                clientSpending[p.clientId] += p.amount || 0;
            });
            const topClients = Object.entries(clientSpending)
                .map(([cid, amount]) => ({ clientId: cid, amount }))
                .sort((a, b) => b.amount - a.amount)
                .slice(0, 5);

            // Payment success rate
            const totalPayments = payments.length;
            const completedPayments = payments.filter(p => p.status === 'completed').length;
            const successRate = totalPayments > 0 ? Math.round((completedPayments / totalPayments) * 100) : 0;

            // Total revenue
            const totalRevenue = payments
                .filter(p => p.status === 'completed')
                .reduce((sum, p) => sum + (p.amount || 0), 0);

            const content = `
                <div class="space-y-6">
                    <!-- KPI Cards -->
                    <div class="grid grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                            <div class="text-xs font-semibold text-green-700 uppercase tracking-wide">Chiffre Affaires</div>
                            <div class="text-2xl font-bold text-green-900 mt-2">${totalRevenue.toLocaleString()} FCFA</div>
                            <div class="text-xs text-green-600 mt-1">Depuis le d�but</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                            <div class="text-xs font-semibold text-blue-700 uppercase tracking-wide">Taux Succ��s</div>
                            <div class="text-2xl font-bold text-blue-900 mt-2">${successRate}%</div>
                            <div class="text-xs text-blue-600 mt-1">${completedPayments} / ${totalPayments} paiements</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200">
                            <div class="text-xs font-semibold text-purple-700 uppercase tracking-wide">Paiements</div>
                            <div class="text-2xl font-bold text-purple-900 mt-2">${totalPayments}</div>
                            <div class="text-xs text-purple-600 mt-1">${completedPayments} compl�t�s</div>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border border-orange-200">
                            <div class="text-xs font-semibold text-orange-700 uppercase tracking-wide">Ticket Moyen</div>
                            <div class="text-2xl font-bold text-orange-900 mt-2">${totalPayments > 0 ? Math.round(totalRevenue / totalPayments).toLocaleString() : '0'} FCFA</div>
                            <div class="text-xs text-orange-600 mt-1">Par paiement</div>
                        </div>
                    </div>

                    <!-- Revenue by Provider -->
                    <div class="bg-white rounded-lg border border-slate-200 p-4">
                        <h3 class="font-bold text-slate-900 mb-4">��Ÿ? � Revenus par Fournisseur</h3>
                        <div class="space-y-3">
                            ${['MTN Money', 'Airtel Money', 'Orange Money'].map(provider => {
                                const key = provider.split(' ')[0].toUpperCase();
                                const amount = revenueByProvider[key] || 0;
                                const count = countByProvider[key] || 0;
                                const success = successByProvider[key] || 0;
                                const rate = count > 0 ? Math.round((success / count) * 100) : 0;
                                const color = key === 'MTN' ? 'yellow' : key === 'AIRTEL' ? 'red' : 'orange';
                                return `
                                    <div class="flex items-center justify-between p-3 bg-${color}-50 rounded border border-${color}-200">
                                        <div>
                                            <div class="font-semibold text-slate-900">${provider}</div>
                                            <div class="text-xs text-slate-600">${count} paiements (${rate}% succ��s)</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-${color}-900">${amount.toLocaleString()} FCFA</div>
                                            <div class="text-xs text-${color}-700">${success} compl�t�s</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Top Clients by Spending -->
                    <div class="bg-white rounded-lg border border-slate-200 p-4">
                        <h3 class="font-bold text-slate-900 mb-4">��Ÿ? � Top 5 Clients (D�penses)</h3>
                        ${topClients.length > 0 ? `
                            <div class="space-y-2">
                                ${topClients.map((client, idx) => {
                                    const clientObj = CORE.db.clients?.find(c => c.id === client.clientId);
                                    const clientName = clientObj?.name || 'Client inconnu';
                                    return `
                                        <div class="flex items-center justify-between p-2 hover:bg-slate-50 rounded">
                                            <div class="flex items-center space-x-2">
                                                <div class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-xs font-bold">${idx + 1}</div>
                                                <div class="text-sm font-medium text-slate-900">${clientName}</div>
                                            </div>
                                            <div class="text-sm font-bold text-green-600">${client.amount.toLocaleString()} FCFA</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `<div class="text-sm text-slate-400">Aucun paiement compl�t�</div>`}
                    </div>

                    <!-- Recent Payments -->
                    <div class="bg-white rounded-lg border border-slate-200 p-4">
                        <h3 class="font-bold text-slate-900 mb-4">��Ÿ?� Paiements R�cents</h3>
                        ${payments.length > 0 ? `
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="border-b border-slate-200">
                                            <th class="text-left py-2 px-2 font-semibold text-slate-600">Client</th>
                                            <th class="text-left py-2 px-2 font-semibold text-slate-600">Fournisseur</th>
                                            <th class="text-right py-2 px-2 font-semibold text-slate-600">Montant</th>
                                            <th class="text-left py-2 px-2 font-semibold text-slate-600">Statut</th>
                                            <th class="text-left py-2 px-2 font-semibold text-slate-600">Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${payments.slice(0, 10).map(p => {
                                            const clientObj = CORE.db.clients?.find(c => c.id === p.clientId);
                                            const clientName = clientObj?.name || 'Client inconnu';
                                            const statusColor = p.status === 'completed' ? 'green' : p.status === 'failed' ? 'red' : 'yellow';
                                            const statusLabel = p.status === 'completed' ? '���?? Compl�t�' : p.status === 'failed' ? '���?? �chou�' : '�� � � En attente';
                                            return `
                                                <tr class="border-b border-slate-100 hover:bg-slate-50">
                                                    <td class="py-2 px-2 text-slate-900">${clientName}</td>
                                                    <td class="py-2 px-2 text-slate-700">${p.provider}</td>
                                                    <td class="py-2 px-2 text-right font-semibold text-slate-900">${(p.amount || 0).toLocaleString()} FCFA</td>
                                                    <td class="py-2 px-2"><span class="px-2 py-1 rounded text-xs font-semibold bg-${statusColor}-100 text-${statusColor}-700">${statusLabel}</span></td>
                                                    <td class="py-2 px-2 text-slate-600 text-xs">${new Date(p.createdAt).toLocaleDateString('fr-FR')}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `<div class="text-sm text-slate-400">Aucun paiement enregistr�</div>`}
                    </div>
                </div>
            `;

            UI.showModal(content, [
                { label: 'Exporter', onclick: `ManagerModule.exportPaymentsReport()` },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], 'Tableau de Bord des Paiements Mobiles');
        },

        exportPaymentsReport() {
            const posId = CORE.state.currentUser?.pos;
            const payments = (CORE.db.mobilePayments || []).filter(p => !p.posId || p.posId == posId);
            const headers = ['Date', 'Client', 'Fournisseur', 'Montant', 'Statut'];
            const rows = payments.map(p => {
                const clientObj = CORE.db.clients?.find(c => c.id === p.clientId);
                return [
                    new Date(p.createdAt).toLocaleDateString('fr-FR'),
                    clientObj?.name || 'Client inconnu',
                    p.provider,
                    (p.amount || 0).toLocaleString() + ' FCFA',
                    p.status === 'completed' ? '���?? Compl�t�' : p.status === 'failed' ? '���?? �chou�' : '�� � � En attente'
                ];
            });

            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `paiements_mobiles_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            UI.showNotification('Rapport export� avec succ��s', 'success');
        }
    };

    // =========================================================
    // MODULE: VALIDATION MULTI-NIVEAUX
    // =========================================================
    const ValidationModule = {
        
        // ===== INITIALISER R�?GLES PAR D�FAUT =====
        initializeRules() {
            if (!CORE.db.validationRules || CORE.db.validationRules.length === 0) {
                CORE.db.validationRules = [
                    { id: Utils.uid('RULE'), entityType: 'order', threshold: 500000, action: 'require_approval', level: 'manager', enabled: true, description: 'Commandes > 500k' },
                    { id: Utils.uid('RULE'), entityType: 'return', threshold: 3, action: 'require_justification', level: 'manager', enabled: true, description: 'Retours > 3 articles' }
                ];
                CORE.save();
            }
        },

        // ===== V�RIFIER SI VALIDATION REQUISE =====
        checkValidationRequired(entityType, amount, quantity = 0) {
            const rules = CORE.db.validationRules.filter(r => r.entityType === entityType && r.enabled);
            for (let rule of rules) {
                if (entityType === 'order' && amount > rule.threshold) {
                    return { required: true, rule };
                }
                if (entityType === 'return' && quantity > rule.threshold) {
                    return { required: true, rule };
                }
            }
            return { required: false };
        },

        // ===== SOUMETTRE COMMANDE POUR APPROBATION =====
        submitOrderForApproval(orderId) {
            const order = CORE.db.orders.find(o => o.id === orderId);
            if (!order) return false;

            const vendor = CORE.db.vendors?.find(v => v.id === order.vendorId);
            const approval = {
                id: Utils.uid('APPR'),
                orderId: orderId,
                posId: order.posId,
                vendorId: order.vendorId,
                vendorName: vendor?.name || 'Vendeur inconnu',
                amount: order.totalAmount || 0,
                status: 'pending',
                managerId: null,
                approverName: null,
                approvedAt: null,
                rejectionReason: null,
                createdAt: new Date().toISOString()
            };

            CORE.db.orderApprovals.push(approval);
            this.logAuditTrail('order', orderId, 'submitted', CORE.state.currentUser?.id, CORE.state.currentUser?.name, 'Soumise pour approbation', { amount: order.totalAmount });
            
            CORE.save();
            return approval.id;
        },

        // ===== APPROUVER COMMANDE =====
        approveOrder(approvalId, comments = '') {
            const approval = CORE.db.orderApprovals.find(a => a.id === approvalId);
            if (!approval) return false;

            approval.status = 'approved';
            approval.managerId = CORE.state.currentUser?.id;
            approval.approverName = CORE.state.currentUser?.name;
            approval.approvedAt = new Date().toISOString();

            const order = CORE.db.orders.find(o => o.id === approval.orderId);
            if (order) {
                order.approvalStatus = 'approved';
                order.approvedBy = CORE.state.currentUser?.name;
                order.approvedAt = new Date().toISOString();
            }

            this.logAuditTrail('order', approval.orderId, 'approved', CORE.state.currentUser?.id, CORE.state.currentUser?.name, comments || 'Approuv�e', {});
            
            CORE.save();
            UI.showNotification(`���?? Commande approuv�e (${CORE.formatPrice(approval.amount)})`, 'success');
            return true;
        },

        // ===== REJETER COMMANDE =====
        rejectOrder(approvalId, reason = '') {
            const approval = CORE.db.orderApprovals.find(a => a.id === approvalId);
            if (!approval) return false;

            approval.status = 'rejected';
            approval.managerId = CORE.state.currentUser?.id;
            approval.approverName = CORE.state.currentUser?.name;
            approval.rejectionReason = reason;

            const order = CORE.db.orders.find(o => o.id === approval.orderId);
            if (order) {
                order.approvalStatus = 'rejected';
                order.rejectionReason = reason;
            }

            this.logAuditTrail('order', approval.orderId, 'rejected', CORE.state.currentUser?.id, CORE.state.currentUser?.name, reason || 'Rejet�e', {});
            
            CORE.save();
            UI.showNotification(`���?? Commande rejet�e`, 'error');
            return true;
        },

        // ===== SOUMETTRE RETOUR POUR JUSTIFICATION =====
        submitReturnForJustification(returnId, reason, description, itemCount) {
            const returnObj = CORE.db.returns?.find(r => r.id === returnId);
            if (!returnObj) return false;

            const justification = {
                id: Utils.uid('JUST'),
                returnId: returnId,
                orderId: returnObj.orderId,
                posId: returnObj.posId || CORE.state.currentUser?.pos,
                itemCount: itemCount,
                reason: reason,
                description: description,
                status: 'pending',
                reviewedBy: null,
                reviewedAt: null,
                notes: '',
                attachments: [],
                createdAt: new Date().toISOString()
            };

            CORE.db.returnJustifications.push(justification);
            this.logAuditTrail('return', returnId, 'submitted', CORE.state.currentUser?.id, CORE.state.currentUser?.name, `Justification soumise: ${reason}`, { itemCount, reason });
            
            CORE.save();
            return justification.id;
        },

        // ===== APPROUVER RETOUR =====
        approveReturn(justificationId, notes = '') {
            const justification = CORE.db.returnJustifications.find(j => j.id === justificationId);
            if (!justification) return false;

            justification.status = 'approved';
            justification.reviewedBy = CORE.state.currentUser?.name;
            justification.reviewedAt = new Date().toISOString();
            justification.notes = notes;

            const returnObj = CORE.db.returns?.find(r => r.id === justification.returnId);
            if (returnObj) {
                returnObj.justificationStatus = 'approved';
                returnObj.approvedBy = CORE.state.currentUser?.name;
            }

            this.logAuditTrail('return', justification.returnId, 'approved', CORE.state.currentUser?.id, CORE.state.currentUser?.name, notes || 'Justification approuv�e', {});
            
            CORE.save();
            UI.showNotification(`���?? Retour approuv� (${justification.itemCount} articles)`, 'success');
            return true;
        },

        // ===== REJETER RETOUR =====
        rejectReturn(justificationId, reason = '') {
            const justification = CORE.db.returnJustifications.find(j => j.id === justificationId);
            if (!justification) return false;

            justification.status = 'rejected';
            justification.reviewedBy = CORE.state.currentUser?.name;
            justification.reviewedAt = new Date().toISOString();
            justification.notes = reason;

            const returnObj = CORE.db.returns?.find(r => r.id === justification.returnId);
            if (returnObj) {
                returnObj.justificationStatus = 'rejected';
            }

            this.logAuditTrail('return', justification.returnId, 'rejected', CORE.state.currentUser?.id, CORE.state.currentUser?.name, reason || 'Justification rejet�e', {});
            
            CORE.save();
            UI.showNotification(`���?? Retour rejet�`, 'error');
            return true;
        },

        // ===== LOG AUDIT TRAIL =====
        logAuditTrail(entityType, entityId, action, userId, userName, reason, metadata = {}) {
            const auditEntry = {
                id: Utils.uid('AUDIT'),
                entityType: entityType,
                entityId: entityId,
                action: action,
                posId: CORE.state.currentUser?.pos,
                userId: userId,
                userName: userName,
                userRole: CORE.state.currentUser?.role,
                timestamp: new Date().toISOString(),
                reason: reason,
                metadata: metadata
            };
            
            CORE.db.approvalAuditTrail.push(auditEntry);
        },

        // ===== R�CUP�RER APPROBATIONS EN ATTENTE =====
        getPendingApprovals() {
            const posId = CORE.state.currentUser?.pos;
            return (CORE.db.orderApprovals || []).filter(a => a.status === 'pending' && (!a.posId || a.posId == posId));
        },

        // ===== R�CUP�RER JUSTIFICATIONS EN ATTENTE =====
        getPendingJustifications() {
            const posId = CORE.state.currentUser?.pos;
            return (CORE.db.returnJustifications || []).filter(j => j.status === 'pending' && (!j.posId || j.posId == posId));
        },

        // ===== AFFICHER MODAL APPROBATIONS MANAGER =====
        showApprovalsModal() {
            const posId = CORE.state.currentUser?.pos;
            const approvals = this.getPendingApprovals();
            const allApprovals = (CORE.db.orderApprovals || []).filter(a => !a.posId || a.posId == posId);
            const approved = allApprovals.filter(a => a.status === 'approved').length;
            const rejected = allApprovals.filter(a => a.status === 'rejected').length;

            const content = `
                <div class="space-y-6">
                    <!-- Stats -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-amber-50 rounded-lg p-4 border border-amber-200">
                            <div class="text-xs font-bold text-amber-700 uppercase">En attente</div>
                            <div class="text-3xl font-black text-amber-900 mt-2">${approvals.length}</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                            <div class="text-xs font-bold text-green-700 uppercase">Approuv�es</div>
                            <div class="text-3xl font-black text-green-900 mt-2">${approved}</div>
                        </div>
                        <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                            <div class="text-xs font-bold text-red-700 uppercase">Rejet�es</div>
                            <div class="text-3xl font-black text-red-900 mt-2">${rejected}</div>
                        </div>
                    </div>

                    <!-- Approbations en attente -->
                    <div class="bg-white rounded-lg border border-slate-200 p-4">
                        <h3 class="font-bold text-slate-900 mb-4">��Ÿ?� Approbations en Attente</h3>
                        ${approvals.length === 0 ? `
                            <div class="text-center text-slate-400 py-8">���?? Aucune approbation en attente</div>
                        ` : `
                            <div class="space-y-3">
                                ${approvals.map(a => `
                                    <div class="border border-slate-200 rounded-lg p-4 hover:shadow-md transition">
                                        <div class="flex items-start justify-between mb-3">
                                            <div>
                                                <div class="font-bold text-slate-900">${a.vendorName}</div>
                                                <div class="text-xs text-slate-500">Commande: ${a.orderId}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-lg font-black text-slate-900">${CORE.formatPrice(a.amount)}</div>
                                                <div class="text-xs text-amber-600 font-bold">�� � � Depuis ${new Date(a.createdAt).toLocaleDateString('fr-FR')}</div>
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="ValidationModule.showApprovalDetail('${a.id}')" class="flex-1 px-3 py-2 bg-blue-500 text-white rounded text-xs font-bold hover:bg-blue-600">��Ÿ?� D�tails</button>
                                            <button onclick="ValidationModule.showApproveModal('${a.id}')" class="flex-1 px-3 py-2 bg-green-600 text-white rounded text-xs font-bold hover:bg-green-700">���?? Approuver</button>
                                            <button onclick="ValidationModule.showRejectModal('${a.id}')" class="flex-1 px-3 py-2 bg-red-600 text-white rounded text-xs font-bold hover:bg-red-700">���?? Rejeter</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>

                    <!-- Historique -->
                    <div class="bg-white rounded-lg border border-slate-200 p-4">
                        <h3 class="font-bold text-slate-900 mb-4">��Ÿ?Š Historique Validations</h3>
                        <div class="space-y-2">
                            ${allApprovals.slice(0, 10).map(a => {
                                const statusBadge = a.status === 'approved' ? '���?? Approuv�e' : a.status === 'rejected' ? '���?? Rejet�e' : '�� � � En attente';
                                const statusColor = a.status === 'approved' ? 'green' : a.status === 'rejected' ? 'red' : 'amber';
                                return `
                                    <div class="flex items-center justify-between p-2 hover:bg-slate-50">
                                        <div>
                                            <div class="text-sm font-medium text-slate-900">${a.vendorName}</div>
                                            <div class="text-xs text-slate-500">${new Date(a.createdAt).toLocaleDateString('fr-FR')}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-slate-900">${CORE.formatPrice(a.amount)}</div>
                                            <span class="px-2 py-1 rounded text-xs font-bold bg-${statusColor}-100 text-${statusColor}-700">${statusBadge}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;

            UI.showModal(content, [
                { label: 'Audit Trail', onclick: 'ValidationModule.showAuditTrail()' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], '���?? Gestion des Approbations');
        },

        // ===== AFFICHER MODAL JUSTIFICATIONS RETOURS =====
        showJustificationsModal() {
            const posId = CORE.state.currentUser?.pos;
            const justifications = this.getPendingJustifications();
            const allJustifications = (CORE.db.returnJustifications || []).filter(j => !j.posId || j.posId == posId);
            const approved = allJustifications.filter(j => j.status === 'approved').length;
            const rejected = allJustifications.filter(j => j.status === 'rejected').length;

            const content = `
                <div class="space-y-6">
                    <!-- Stats -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-amber-50 rounded-lg p-4 border border-amber-200">
                            <div class="text-xs font-bold text-amber-700 uppercase">En attente</div>
                            <div class="text-3xl font-black text-amber-900 mt-2">${justifications.length}</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                            <div class="text-xs font-bold text-green-700 uppercase">Approuv�es</div>
                            <div class="text-3xl font-black text-green-900 mt-2">${approved}</div>
                        </div>
                        <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                            <div class="text-xs font-bold text-red-700 uppercase">Rejet�es</div>
                            <div class="text-3xl font-black text-red-900 mt-2">${rejected}</div>
                        </div>
                    </div>

                    <!-- Justifications en attente -->
                    <div class="bg-white rounded-lg border border-slate-200 p-4">
                        <h3 class="font-bold text-slate-900 mb-4">��Ÿ?� Justifications en Attente</h3>
                        ${justifications.length === 0 ? `
                            <div class="text-center text-slate-400 py-8">���?? Aucune justification en attente</div>
                        ` : `
                            <div class="space-y-3">
                                ${justifications.map(j => `
                                    <div class="border border-slate-200 rounded-lg p-4 hover:shadow-md transition">
                                        <div class="flex items-start justify-between mb-2">
                                            <div>
                                                <div class="font-bold text-slate-900">Retour: ${j.returnId}</div>
                                                <div class="text-xs text-slate-500">Commande: ${j.orderId} | ${j.itemCount} articles</div>
                                                <div class="text-sm text-slate-700 mt-1"><strong>Raison:</strong> ${j.reason}</div>
                                                <div class="text-sm text-slate-600 mt-1">${j.description}</div>
                                            </div>
                                        </div>
                                        <div class="flex gap-2 mt-3">
                                            <button onclick="ValidationModule.showJustificationDetail('${j.id}')" class="flex-1 px-3 py-2 bg-blue-500 text-white rounded text-xs font-bold hover:bg-blue-600">��Ÿ?� D�tails</button>
                                            <button onclick="ValidationModule.showApproveReturnModal('${j.id}')" class="flex-1 px-3 py-2 bg-green-600 text-white rounded text-xs font-bold hover:bg-green-700">���?? Approuver</button>
                                            <button onclick="ValidationModule.showRejectReturnModal('${j.id}')" class="flex-1 px-3 py-2 bg-red-600 text-white rounded text-xs font-bold hover:bg-red-700">���?? Rejeter</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;

            UI.showModal(content, [
                { label: 'Audit Trail', onclick: 'ValidationModule.showAuditTrail()' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], '���?? Gestion des Justifications');
        },

        // ===== AFFICHER MODAL APPROBATION =====
        showApproveModal(approvalId) {
            const approval = CORE.db.orderApprovals.find(a => a.id === approvalId);
            if (!approval) return;

            const content = `
                <div class="space-y-4">
                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <div class="text-sm text-blue-700"><strong>Vendeur:</strong> ${approval.vendorName}</div>
                        <div class="text-sm text-blue-700 mt-1"><strong>Montant:</strong> ${CORE.formatPrice(approval.amount)}</div>
                        <div class="text-sm text-blue-700 mt-1"><strong>Commande:</strong> ${approval.orderId}</div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-900 mb-2">Commentaire (optionnel)</label>
                        <textarea id="approval-comments" class="w-full px-4 py-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-green-500 bg-slate-50" rows="4" placeholder="Ajoutez un commentaire..."></textarea>
                    </div>

                    <div class="bg-green-50 rounded-lg p-4 border border-green-200 text-sm text-green-700">
                        ���?? Cette approbation sera enregistr�e dans l'audit trail
                    </div>
                </div>
            `;

            UI.showModal(content, [
                { label: '���?? Approuver', onclick: `ValidationModule.approveOrder('${approvalId}', document.getElementById('approval-comments')?.value || '')` },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ], '���?? Approuver Commande');
        },

        // ===== AFFICHER MODAL REJET =====
        showRejectModal(approvalId) {
            const approval = CORE.db.orderApprovals.find(a => a.id === approvalId);
            if (!approval) return;

            const content = `
                <div class="space-y-4">
                    <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                        <div class="text-sm text-red-700"><strong>Vendeur:</strong> ${approval.vendorName}</div>
                        <div class="text-sm text-red-700 mt-1"><strong>Montant:</strong> ${CORE.formatPrice(approval.amount)}</div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-900 mb-2">Raison du rejet</label>
                        <textarea id="reject-reason" class="w-full px-4 py-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-red-500 bg-slate-50" rows="4" placeholder="Expliquez pourquoi vous rejetez cette commande..."></textarea>
                    </div>

                    <div class="bg-red-50 rounded-lg p-4 border border-red-200 text-sm text-red-700">
                        ���?? Le vendeur sera notifi� du rejet
                    </div>
                </div>
            `;

            UI.showModal(content, [
                { label: '���?? Rejeter', onclick: `ValidationModule.rejectOrder('${approvalId}', document.getElementById('reject-reason')?.value || '')` },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ], '���?? Rejeter Commande');
        },

        // ===== AFFICHER MODAL APPROBATION RETOUR =====
        showApproveReturnModal(justificationId) {
            const justification = CORE.db.returnJustifications.find(j => j.id === justificationId);
            if (!justification) return;

            const content = `
                <div class="space-y-4">
                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <div class="text-sm text-blue-700"><strong>Retour:</strong> ${justification.returnId}</div>
                        <div class="text-sm text-blue-700 mt-1"><strong>Articles:</strong> ${justification.itemCount}</div>
                        <div class="text-sm text-blue-700 mt-1"><strong>Raison:</strong> ${justification.reason}</div>
                        <div class="text-sm text-blue-700 mt-1"><strong>Description:</strong> ${justification.description}</div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-900 mb-2">Notes (optionnel)</label>
                        <textarea id="return-approve-notes" class="w-full px-4 py-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-green-500 bg-slate-50" rows="4" placeholder="Ajoutez vos notes..."></textarea>
                    </div>
                </div>
            `;

            UI.showModal(content, [
                { label: '���?? Approuver', onclick: `ValidationModule.approveReturn('${justificationId}', document.getElementById('return-approve-notes')?.value || '')` },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ], '���?? Approuver Retour');
        },

        // ===== AFFICHER MODAL REJET RETOUR =====
        showRejectReturnModal(justificationId) {
            const justification = CORE.db.returnJustifications.find(j => j.id === justificationId);
            if (!justification) return;

            const content = `
                <div class="space-y-4">
                    <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                        <div class="text-sm text-red-700"><strong>Retour:</strong> ${justification.returnId}</div>
                        <div class="text-sm text-red-700 mt-1"><strong>Articles:</strong> ${justification.itemCount}</div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-900 mb-2">Raison du rejet</label>
                        <textarea id="return-reject-reason" class="w-full px-4 py-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-red-500 bg-slate-50" rows="4" placeholder="Expliquez pourquoi vous rejetez ce retour..."></textarea>
                    </div>
                </div>
            `;

            UI.showModal(content, [
                { label: '���?? Rejeter', onclick: `ValidationModule.rejectReturn('${justificationId}', document.getElementById('return-reject-reason')?.value || '')` },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ], '���?? Rejeter Retour');
        },

        // ===== AFFICHER AUDIT TRAIL COMPLET =====
        showAuditTrail() {
            const posId = CORE.state.currentUser?.pos;
            const entries = (CORE.db.approvalAuditTrail || []).filter(e => !e.posId || e.posId == posId).slice(-50);
            const content = `
                <div class="bg-white rounded-lg border border-slate-200">
                    <div class="p-4 border-b border-slate-200">
                        <h3 class="font-bold text-slate-900">��Ÿ?Š Audit Trail (derni��res 50 actions)</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-slate-200 bg-slate-50">
                                    <th class="text-left py-2 px-3 font-bold text-slate-600">Date/Heure</th>
                                    <th class="text-left py-2 px-3 font-bold text-slate-600">Action</th>
                                    <th class="text-left py-2 px-3 font-bold text-slate-600">Utilisateur</th>
                                    <th class="text-left py-2 px-3 font-bold text-slate-600">Raison/Commentaire</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${entries.map(e => {
                                    const actionLabel = {
                                        'submitted': '��Ÿ?� Soumise',
                                        'approved': '���?? Approuv�e',
                                        'rejected': '���?? Rejet�e',
                                        'created': '��ž� Cr��e'
                                    }[e.action] || e.action;
                                    return `
                                        <tr class="border-b border-slate-100 hover:bg-slate-50">
                                            <td class="py-2 px-3 text-xs text-slate-600">${new Date(e.timestamp).toLocaleString('fr-FR')}</td>
                                            <td class="py-2 px-3"><strong>${e.entityType}</strong> - ${actionLabel}</td>
                                            <td class="py-2 px-3 text-slate-700">${e.userName} (${e.userRole})</td>
                                            <td class="py-2 px-3 text-slate-600">${e.reason}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            UI.showModal(content, [
                { label: 'Export', onclick: 'ValidationModule.exportAuditTrail()' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], '��Ÿ?Š Audit Trail Complet');
        },

        // ===== EXPORTER AUDIT TRAIL =====
        exportAuditTrail() {
            const posId = CORE.state.currentUser?.pos;
            const entries = (CORE.db.approvalAuditTrail || []).filter(e => !e.posId || e.posId == posId);
            const headers = ['Date', 'Heure', 'Type', 'Action', 'ID Entit�', 'Utilisateur', 'R��le', 'Raison'];
            const rows = entries.map(e => {
                const dt = new Date(e.timestamp);
                return [
                    dt.toLocaleDateString('fr-FR'),
                    dt.toLocaleTimeString('fr-FR'),
                    e.entityType,
                    e.action,
                    e.entityId,
                    e.userName,
                    e.userRole,
                    e.reason
                ];
            });

            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `audit_trail_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            UI.showNotification('Audit trail export�', 'success');
        },

        showApprovalDetail(id) { UI.showNotification('D�tails approbation #' + id, 'info'); },
        showJustificationDetail(id) { UI.showNotification('D�tails justification #' + id, 'info'); }
    };

    // =========================================================
    // MODULE: LIVREUR
    // =========================================================
    const LivreurModule = {
        state: { 
            currentView: 'dashboard', 
            isOnService: true, 
            theme: 'light', 
            historyFilters: { status: '', dateFrom: '', dateTo: '', clientName: '', searchQuery: '' }, 
            preferences: { notificationsEnabled: true, soundEnabled: true, soundVolume: 0.8 },
            // Notification polling
            lastKnownDeliveryIds: [],
            pollingInterval: null,
            // GPS tracking
            currentPosition: null,
            watchId: null
        },

        init() {
            // R�initialiser la vue
            this.state.currentView = 'dashboard';
            this.state.historyFilters = { status: '', dateFrom: '', dateTo: '', clientName: '', searchQuery: '' };
            
            // Charger le th��me pr�f�r�
            this.loadThemePreference();
        },

        // =====================
        // NOTIFICATION POLLING (30s)
        // =====================
        startPolling() {
            if (this.state.pollingInterval) return;
            
            // Initialiser les IDs connus
            this.state.lastKnownDeliveryIds = this.getMyDeliveries().map(d => d.id);
            
            this.state.pollingInterval = setInterval(() => {
                this.checkNewDeliveries();
            }, 30000); // 30 secondes
            
            console.log('[LivreurModule] Polling d�marr� (30s)');
        },

        stopPolling() {
            if (this.state.pollingInterval) {
                clearInterval(this.state.pollingInterval);
                this.state.pollingInterval = null;
                console.log('[LivreurModule] Polling arr��t�');
            }
        },

        checkNewDeliveries() {
            // V�rifier nouvelles courses assign�es
            const currentDeliveries = this.getMyDeliveries();
            const currentIds = currentDeliveries.map(d => d.id);
            const newDeliveries = currentDeliveries.filter(d => !this.state.lastKnownDeliveryIds.includes(d.id));
            
            if (newDeliveries.length > 0) {
                // Nouvelles courses assign�es !
                newDeliveries.forEach(d => {
                    this.showNewDeliveryNotification(d);
                });
                
                // Jouer le son si activ�
                if (this.state.preferences.soundEnabled) {
                    UI.playNotificationSound();
                }
            }
            
            this.state.lastKnownDeliveryIds = currentIds;

            // V�rifier aussi les nouvelles courses disponibles (non assign�es)
            const pendingDeliveries = this.getPendingDeliveries();
            const pendingIds = pendingDeliveries.map(d => d.id);
            const lastKnownPendingIds = this.state.lastKnownPendingIds || [];
            const newPending = pendingDeliveries.filter(d => !lastKnownPendingIds.includes(d.id));

            if (newPending.length > 0) {
                // Nouvelles courses disponibles !
                this.showNewPendingNotification(newPending.length);
                
                if (this.state.preferences.soundEnabled) {
                    UI.playNotificationSound();
                }
                
                // Rafra��chir l'affichage
                App.rerender();
            }
            
            this.state.lastKnownPendingIds = pendingIds;
        },

        // Notification pour nouvelles courses disponibles
        showNewPendingNotification(count) {
            const notifContainer = document.getElementById('livreur-notifications') || this.createNotificationContainer();
            
            const notifId = 'notif-pending-' + Date.now();
            const notifHtml = `
                <div id="${notifId}" class="bg-gradient-to-r from-amber-500 to-orange-500 text-white p-4 rounded-2xl shadow-2xl mb-3 slide-up cursor-pointer" onclick="LivreurModule.navigateTo('dashboard'); document.getElementById('${notifId}').remove();">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <span class="text-2xl">��Ÿ? �</span>
                        </div>
                        <div class="flex-1">
                            <div class="font-black">${count} nouvelle(s) course(s) disponible(s) !</div>
                            <div class="text-sm text-white/90">Cliquez pour voir et accepter</div>
                        </div>
                        <button onclick="event.stopPropagation(); document.getElementById('${notifId}').remove();" class="text-xs text-white/70 hover:text-white">���?�</button>
                    </div>
                </div>`;
            
            notifContainer.insertAdjacentHTML('beforeend', notifHtml);
            
            // Auto-fermeture apr��s 10 secondes
            setTimeout(() => {
                const el = document.getElementById(notifId);
                if (el) el.remove();
            }, 10000);
        },

        showNewDeliveryNotification(delivery) {
            // Notification visuelle persistante
            const notifContainer = document.getElementById('livreur-notifications') || this.createNotificationContainer();
            
            const notifId = 'notif-' + delivery.id;
            const notifHtml = `
                <div id="${notifId}" class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white p-4 rounded-2xl shadow-2xl mb-3 slide-up cursor-pointer" onclick="LivreurModule.viewDeliveryDetail(${delivery.id}); document.getElementById('${notifId}').remove();">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <span class="text-2xl">��Ÿšš</span>
                        </div>
                        <div class="flex-1">
                            <div class="font-black">Nouvelle course !</div>
                            <div class="text-sm text-white/90">${delivery.orderRef} �� ?� � ${delivery.clientName}</div>
                            <div class="text-xs text-white/70 mt-1">${delivery.address || 'Adresse non sp�cifi�e'}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-black text-lg">${CORE.formatPrice(delivery.amount)}</div>
                            <button onclick="event.stopPropagation(); document.getElementById('${notifId}').remove();" class="text-xs text-white/70 hover:text-white mt-1">���?� Fermer</button>
                        </div>
                    </div>
                </div>
            `;
            
            notifContainer.insertAdjacentHTML('beforeend', notifHtml);
            
            // Auto-disparition apr��s 15 secondes
            setTimeout(() => {
                const el = document.getElementById(notifId);
                if (el) el.remove();
            }, 15000);
        },

        createNotificationContainer() {
            const container = document.createElement('div');
            container.id = 'livreur-notifications';
            container.className = 'fixed top-20 left-4 right-4 z-[100] pointer-events-auto';
            document.body.appendChild(container);
            return container;
        },

        // =====================
        // GPS TRACKING
        // =====================
        startGPSTracking() {
            if (!navigator.geolocation) {
                console.warn('[LivreurModule] G�olocalisation non support�e');
                return;
            }
            
            this.state.watchId = navigator.geolocation.watchPosition(
                (position) => {
                    this.state.currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };
                    this.updatePositionInDB();
                },
                (error) => {
                    console.error('[LivreurModule] Erreur GPS:', error);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 5000
                }
            );
            
            console.log('[LivreurModule] GPS tracking d�marr�');
        },

        stopGPSTracking() {
            if (this.state.watchId) {
                navigator.geolocation.clearWatch(this.state.watchId);
                this.state.watchId = null;
                console.log('[LivreurModule] GPS tracking arr��t�');
            }
        },

        updatePositionInDB() {
            const uid = CORE.state.currentUser?.id;
            if (!uid || !this.state.currentPosition) return;
            
            // Stocker la position dans la DB pour que le vendeur puisse la voir
            CORE.db.livreurPositions = CORE.db.livreurPositions || {};
            CORE.db.livreurPositions[uid] = {
                ...this.state.currentPosition,
                livreurId: uid,
                livreurName: CORE.state.currentUser?.name,
                isOnService: this.state.isOnService
            };
            
            // Sauvegarder (optionnel - peut ��tre lourd si fr�quent)
            // CORE.save();
        },

        // =====================
        // ESTIMATION TEMPS LIVRAISON
        // =====================
        estimateDeliveryTime(delivery) {
            if (!delivery || !delivery.address) return null;
            
            // Estimation bas�e sur la distance (si disponible)
            const distance = delivery.estimatedDistance || 5; // km par d�faut
            const avgSpeed = 25; // km/h en ville
            const prepTime = 10; // minutes de pr�paration
            
            const travelTime = Math.round((distance / avgSpeed) * 60);
            const totalTime = prepTime + travelTime;
            
            return {
                prepTime,
                travelTime,
                totalTime,
                estimatedArrival: new Date(Date.now() + totalTime * 60000).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })
            };
        },

        // =====================
        // INITIALISATION
        // =====================
        init() {
            this.loadThemePreference();
            this.loadPreferences();
            this.startPolling();
            
            if (this.state.isOnService) {
                this.startGPSTracking();
            }
        },

        cleanup() {
            this.stopPolling();
            this.stopGPSTracking();
        },

        loadPreferences() {
            try {
                const saved = localStorage.getItem('livreur_preferences');
                if (saved) {
                    this.state.preferences = { ...this.state.preferences, ...JSON.parse(saved) };
                }
            } catch(e) {}
        },

        getMyDeliveries() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.state.currentUser?.pos;
            return CORE.db.deliveries.filter(d => 
                d.livreurId === uid && 
                (String(d.posId) === String(userPos) || !d.posId || !userPos)
            ).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
        },

        // Livraisons en attente d'assignation (non assign�es) du POS du livreur
        getPendingDeliveries() {
            const userPos = CORE.state.currentUser?.pos;
            if (!userPos) return [];
            // Inclure toutes les livraisons en attente du POS (non assign�es ou status r�servation)
            return CORE.db.deliveries.filter(d => 
                !d.livreurId && 
                String(d.posId) === String(userPos) && 
                (d.status === 'en_attente' || d.status === 'reservation')
            ).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
        },

        // Auto-accepter une livraison en attente
        acceptPendingDelivery(deliveryId) {
            const uid = CORE.state.currentUser?.id;
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return UI.toast('Livraison introuvable', 'error');
            if (d.livreurId) return UI.toast('Cette livraison a d�j�� �t� prise', 'warning');
            
            CORE.update('deliveries', d.id, {
                livreurId: uid,
                status: 'en_attente',
                assignedAt: new Date().toISOString()
            });

            CORE.logActivity('accept', 'delivery', d.id, {
                entityName: `Commande ${d.orderRef}`,
                description: `Livraison accept�e par le livreur`,
                before: { livreurId: null },
                after: { livreurId: uid }
            });

            UI.toast(`���?? Livraison ${d.orderRef} accept�e!`, 'success');
            App.rerender();
        },

        getFilteredDeliveries() {
            let all = this.getMyDeliveries();
            const f = this.state.historyFilters;
            
            // Filtre statut
            if (f.status) {
                all = all.filter(d => d.status === f.status);
            }
            
            // Filtre date depuis
            if (f.dateFrom) {
                const fromDate = new Date(f.dateFrom);
                all = all.filter(d => new Date(d.createdAt) >= fromDate);
            }
            
            // Filtre date jusqu'��
            if (f.dateTo) {
                const toDate = new Date(f.dateTo);
                toDate.setHours(23, 59, 59, 999);
                all = all.filter(d => new Date(d.createdAt) <= toDate);
            }
            
            // Filtre client
            if (f.clientName) {
                all = all.filter(d => d.clientName.toLowerCase().includes(f.clientName.toLowerCase()));
            }
            
            // Filtre recherche globale
            if (f.searchQuery) {
                const q = f.searchQuery.toLowerCase();
                all = all.filter(d => 
                    d.orderRef.toLowerCase().includes(q) ||
                    d.clientName.toLowerCase().includes(q) ||
                    (d.address || '').toLowerCase().includes(q) ||
                    (d.clientPhone || '').toLowerCase().includes(q)
                );
            }
            
            return all;
        },

        navigateTo(view) { 
            if (!CORE.canAccessView(view)) {
                return UI.toast('Acc��s refus�', 'error');
            }
            this.state.currentView = view; 
            if (view !== 'historique') { 
                this.state.historyFilters = { status: '', dateFrom: '', dateTo: '', clientName: '', searchQuery: '' }; 
            } 
            App.rerender(); 
        },
        toggleService() { this.state.isOnService = !this.state.isOnService; UI.toast(this.state.isOnService ? 'En service' : 'Hors service', 'info'); App.rerender(); },

        setTheme(theme) {
            this.state.theme = theme;
            const userId = CORE.user?.id || 'default';
            localStorage.setItem(`livreur_theme_${userId}`, theme);
            this.applyTheme();
            UI.toast(`Th��me: ${theme === 'light' ? '���? ?��� � � Clair' : theme === 'dark' ? '��Ÿ�? ?� Sombre' : '��Ÿ�? Auto'}`, 'success');
            App.rerender();
        },

        applyTheme() {
            const html = document.documentElement;
            const theme = this.state.theme;

            // Retirer les autres classes de th��me
            html.classList.remove('livreur-dark', 'vendeur-dark');
            html.style.filter = 'none';

            if (theme === 'dark') {
                html.classList.add('livreur-dark');
            } else if (theme === 'auto') {
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (isDark) {
                    html.classList.add('livreur-dark');
                }
            }
            // 'light' = pas de classe, th��me par d�faut
        },

        loadThemePreference() {
            const userId = CORE.user?.id || 'default';
            const saved = localStorage.getItem(`livreur_theme_${userId}`);
            if (saved) {
                this.state.theme = saved;
                this.applyTheme();
            }
        },

        savePreferences() {
            try {
                localStorage.setItem('livreur_preferences', JSON.stringify(this.state.preferences));
                CORE.save();
            } catch(e) {
                console.error('Error saving livreur preferences:', e);
            }
        },

        // Support & �?� propos
        showFAQModal() {
            UI.modal('�� �? Foire Aux Questions', `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                        <div class="font-black text-emerald-800 mb-2">Comment recevoir des livraisons ?</div>
                        <div class="text-sm text-emerald-700">Activez votre statut "En service" depuis le tableau de bord. Vous recevrez automatiquement les nouvelles courses assign�es par les vendeurs.</div>
                    </div>
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="font-black text-blue-800 mb-2">Comment valider une livraison ?</div>
                        <div class="text-sm text-blue-700">Une fois chez le client, utilisez le bouton "Valider livraison" et ajoutez une photo de preuve ou une signature du client pour confirmer.</div>
                    </div>
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                        <div class="font-black text-amber-800 mb-2">Que faire en cas de probl��me ?</div>
                        <div class="text-sm text-amber-700">Signalez le probl��me via le bouton "Signaler probl��me" sur la livraison. D�crivez la situation et contactez le vendeur si n�cessaire.</div>
                    </div>
                    <div class="p-4 bg-purple-50 border border-purple-200 rounded-2xl">
                        <div class="font-black text-purple-800 mb-2">Comment voir mes gains ?</div>
                        <div class="text-sm text-purple-700">Consultez l'onglet "Historique" pour voir toutes vos livraisons et le total de vos commissions.</div>
                    </div>
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="font-black text-slate-800 mb-2">Comment utiliser la navigation GPS ?</div>
                        <div class="text-sm text-slate-700">Cliquez sur "Naviguer" sur une livraison pour ouvrir l'adresse dans Google Maps ou votre application de navigation pr�f�r�e.</div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-lg' });
            setTimeout(() => lucide.createIcons(), 50);
        },

        showSupportModal() {
            const pdv = CORE.db.pointsDeVente?.find(p => p.id === CORE.state.activePDV);
            const pdvPhone = pdv?.telephone || 'Non disponible';
            const pdvEmail = pdv?.email || 'support@raya.com';
            
            UI.modal('��Ÿ?ž Contacter le Support', `
                <div class="space-y-4">
                    <div class="p-5 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl text-white text-center">
                        <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="headphones" class="w-8 h-8"></i>
                        </div>
                        <div class="font-black text-xl">Besoin d'aide ?</div>
                        <div class="text-sm text-white/80">Notre �quipe est l�� pour vous aider</div>
                    </div>
                    
                    <div class="space-y-3">
                        <a href="tel:${pdvPhone.replace(/\s/g, '')}" class="flex items-center gap-4 p-4 bg-blue-50 border border-blue-200 rounded-2xl hover:bg-blue-100 transition">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                                <i data-lucide="phone" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-blue-800">Appeler la boutique</div>
                                <div class="text-sm text-blue-600">${pdvPhone}</div>
                            </div>
                        </a>
                        
                        <a href="mailto:${pdvEmail}" class="flex items-center gap-4 p-4 bg-purple-50 border border-purple-200 rounded-2xl hover:bg-purple-100 transition">
                            <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center">
                                <i data-lucide="mail" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-purple-800">Envoyer un email</div>
                                <div class="text-sm text-purple-600">${pdvEmail}</div>
                            </div>
                        </a>
                        
                        <a href="https://wa.me/${pdvPhone.replace(/\s/g, '').replace(/^0/, '33')}" target="_blank" class="flex items-center gap-4 p-4 bg-green-50 border border-green-200 rounded-2xl hover:bg-green-100 transition">
                            <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                            </div>
                            <div>
                                <div class="font-black text-green-800">WhatsApp</div>
                                <div class="text-sm text-green-600">Envoyer un message</div>
                            </div>
                        </a>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-md' });
            setTimeout(() => lucide.createIcons(), 50);
        },

        showVersionModal() {
            UI.modal(`��? ��� � � �?� propos de ${CORE.getCompanyName()}`, `
                <div class="text-center space-y-6">
                    <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-3xl shadow-lg">
                        <span class="text-4xl font-black text-white">${CORE.getCompanyName().charAt(0)}</span>
                    </div>
                    
                    <div>
                        <div class="text-2xl font-black text-slate-900">${CORE.getCompanyName()}</div>
                        <div class="text-sm text-slate-500">Syst��me de gestion de boutique</div>
                    </div>
                    
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase mb-2">Version</div>
                        <div class="text-xl font-black text-emerald-600">${CORE.config.version || '1.0.0'}</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 text-xs">
                        <div class="p-3 bg-blue-50 rounded-xl">
                            <div class="font-black text-blue-800">Interface</div>
                            <div class="text-blue-600">Livreur Mobile</div>
                        </div>
                        <div class="p-3 bg-purple-50 rounded-xl">
                            <div class="font-black text-purple-800">Plateforme</div>
                            <div class="text-purple-600">Web Progressive</div>
                        </div>
                    </div>
                    
                    <div class="text-xs text-slate-400">
                        �? � ${new Date().getFullYear()} ${CORE.getCompanyName()} - Tous droits r�serv�s
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-sm' });
            setTimeout(() => lucide.createIcons(), 50);
        },

        loadPreferences() {
            try {
                const saved = localStorage.getItem('livreur_preferences');
                if (saved) {
                    this.state.preferences = { ...this.state.preferences, ...JSON.parse(saved) };
                }
            } catch(e) {
                console.error('Error loading livreur preferences:', e);
            }
        },

        getStats() {
            const all = this.getMyDeliveries();
            const done = all.filter(d => d.status === 'livree').length;
            const inProgress = all.filter(d => d.status === 'en_cours').length;
            const gainsJour = all.filter(d => (d.createdAt || '').startsWith(Utils.todayKey()) && d.status === 'livree').reduce((a,d)=>a+(d.commission||Math.round(d.amount*0.05)||0),0);
            return { done, inProgress, gainsJour };
        },

        getHistoryStats() {
            const filtered = this.getFilteredDeliveries();
            const totalLivrees = filtered.filter(d => d.status === 'livree').length;
            const totalProblemes = filtered.filter(d => d.status === 'probleme').length;
            const totalGains = filtered.filter(d => d.status === 'livree').reduce((a,d)=>a+(d.commission||Math.round(d.amount*0.05)||0),0);
            const totalChiffre = filtered.reduce((a,d)=>a+(d.amount||0),0);
            const moyennParLivraison = totalLivrees > 0 ? Math.round(totalChiffre / totalLivrees) : 0;
            
            return {
                total: filtered.length,
                livrees: totalLivrees,
                problemes: totalProblemes,
                gains: totalGains,
                chiffre: totalChiffre,
                moyenne: moyennParLivraison,
                tauxReussite: filtered.length > 0 ? Math.round((totalLivrees / filtered.length) * 100) : 0
            };
        },

        updateFilter(key, value) {
            this.state.historyFilters[key] = value;
            App.rerender();
        },

        updateLivreurSearch(value) {
            // Mettre �� jour le state
            this.state.historyFilters.searchQuery = value;
            
            // Annuler le timer pr�c�dent
            if (this.searchQueryTimer) clearTimeout(this.searchQueryTimer);
            
            // Attendre 500ms avant de rerender
            this.searchQueryTimer = setTimeout(() => {
                const input = document.getElementById('livreur-search-input');
                const cursorPos = input?.selectionStart || 0;
                
                App.rerender();
                
                setTimeout(() => {
                    const newInput = document.getElementById('livreur-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateLivreurClientSearch(value) {
            // Mettre �� jour le state
            this.state.historyFilters.clientName = value;
            
            // Annuler le timer pr�c�dent
            if (this.clientNameTimer) clearTimeout(this.clientNameTimer);
            
            // Attendre 500ms avant de rerender
            this.clientNameTimer = setTimeout(() => {
                const input = document.getElementById('livreur-client-search-input');
                const cursorPos = input?.selectionStart || 0;
                
                App.rerender();
                
                setTimeout(() => {
                    const newInput = document.getElementById('livreur-client-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        // �tat temporaire pour les photos de validation
        validationPhotos: [],
        signatureData: null,
        signatureCanvas: null,
        isDrawing: false,
        currentValidationSettings: null,

        // Afficher le modal de validation avec photos et signature
        showDeliveryValidationModal(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;

            // R�cup�rer les param��tres de validation du POS
            const posId = d.posId || d.vendeurId;
            const settings = CORE.getDeliveryValidationSettings(posId);
            this.currentValidationSettings = settings;

            // R�initialiser les photos et signature
            this.validationPhotos = d.proofPhotos || [];
            this.signatureData = d.proofSignature || null;

            // D�terminer les instructions selon les param��tres
            let instructionText = '';
            let instructionIcon = 'camera';
            if (!settings.requirePhoto && !settings.requireSignature) {
                instructionText = 'Aucune preuve requise - Vous pouvez valider directement ou ajouter des preuves optionnellement';
                instructionIcon = 'check-circle';
            } else if (settings.requireBoth) {
                instructionText = `Ajoutez au moins ${settings.minPhotos || 1} photo(s) <strong>ET</strong> la signature du client pour valider`;
                instructionIcon = 'shield-check';
            } else if (settings.requirePhoto && settings.requireSignature) {
                instructionText = `Ajoutez ${settings.minPhotos || 1} photo(s) <strong>OU</strong> la signature du client pour valider`;
                instructionIcon = 'camera';
            } else if (settings.requirePhoto) {
                instructionText = `Ajoutez au moins ${settings.minPhotos || 1} photo(s) comme preuve de livraison`;
                instructionIcon = 'camera';
            } else if (settings.requireSignature) {
                instructionText = 'Obtenez la signature du client pour valider la livraison';
                instructionIcon = 'pen-tool';
            }

            // Masquer les sections non requises
            const showPhotoSection = settings.requirePhoto || settings.requireBoth || (!settings.requirePhoto && !settings.requireSignature);
            const showSignatureSection = settings.requireSignature || settings.requireBoth || (!settings.requirePhoto && !settings.requireSignature);

            UI.modal('��Ÿ? � Valider la livraison', `
                <div class="space-y-4">
                    <!-- Info livraison -->
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-black text-slate-900">${d.orderRef}</div>
                                <div class="text-xs text-slate-500">${d.clientName || 'Client'}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Instructions dynamiques selon les param��tres -->
                    <div class="p-4 bg-blue-50 rounded-2xl border border-blue-200">
                        <div class="flex items-start gap-3">
                            <i data-lucide="${instructionIcon}" class="w-5 h-5 text-blue-600 mt-0.5"></i>
                            <div>
                                <div class="font-bold text-blue-900">Preuves de livraison</div>
                                <div class="text-xs text-blue-700 mt-1">${instructionText}</div>
                            </div>
                        </div>
                    </div>

                    ${showPhotoSection ? `
                    <!-- Zone photos -->
                    <div class="space-y-3">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">��Ÿ? � Photos de preuve ${settings.requirePhoto ? '<span class="text-red-500">*</span>' : '(optionnel)'}</div>
                        
                        <!-- Aper��u des photos -->
                        <div id="validation-photos-preview" class="grid grid-cols-3 gap-2">
                            ${this.validationPhotos.map((photo, idx) => `
                                <div class="relative aspect-square rounded-xl overflow-hidden border-2 border-emerald-400">
                                    <img src="${photo}" class="w-full h-full object-cover">
                                    <button onclick="LivreurModule.removeValidationPhoto(${idx})" class="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600">
                                        <i data-lucide="x" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            `).join('')}
                            
                            ${this.validationPhotos.length < 5 ? `
                                <label class="aspect-square rounded-xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center cursor-pointer hover:border-emerald-500 hover:bg-emerald-50 transition">
                                    <i data-lucide="camera" class="w-8 h-8 text-slate-400"></i>
                                    <span class="text-xs text-slate-500 mt-1">Ajouter</span>
                                    <input type="file" accept="image/*" capture="environment" class="hidden" onchange="LivreurModule.handlePhotoUpload(event)">
                                </label>
                            ` : ''}
                        </div>
                        
                        <div class="text-xs text-slate-400 text-center">${this.validationPhotos.length}/${settings.maxPhotos || 5} photos ${settings.requirePhoto && settings.minPhotos > 1 ? '(min ' + settings.minPhotos + ')' : ''}</div>
                    </div>
                    ` : ''}

                    ${showSignatureSection ? `
                    <!-- Zone signature -->
                    <div class="space-y-3 border-t border-slate-200 pt-4">
                        <div class="flex items-center justify-between">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">���? ��� � � Signature client ${settings.requireSignature ? '<span class="text-red-500">*</span>' : '(optionnel)'}</div>
                            <button onclick="LivreurModule.clearSignature()" class="text-xs text-red-500 hover:text-red-700 font-bold flex items-center gap-1">
                                <i data-lucide="trash-2" class="w-3 h-3"></i> Effacer
                            </button>
                        </div>
                        
                        <div class="relative border-2 border-slate-200 rounded-xl overflow-hidden bg-white" style="touch-action: none;">
                            <canvas id="signature-canvas" class="w-full cursor-crosshair" style="height: 150px;"></canvas>
                            <div id="signature-placeholder" class="absolute inset-0 flex items-center justify-center pointer-events-none ${this.signatureData ? 'hidden' : ''}">
                                <span class="text-slate-300 text-sm">Signez ici avec le doigt ou la souris</span>
                            </div>
                        </div>
                        
                        <div id="signature-status" class="text-xs text-center ${this.signatureData ? 'text-emerald-600' : 'text-slate-400'}">
                            ${this.signatureData ? '���?? Signature enregistr�e' : 'Pas de signature'}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Note optionnelle -->
                    <div>
                        <label class="block text-xs font-black text-slate-500 uppercase tracking-wider mb-2">Note (optionnelle)</label>
                        <textarea id="delivery_validation_note" rows="2" class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm resize-none" placeholder="Ex: Colis remis �� la r�ception..."></textarea>
                    </div>

                    <!-- Avertissement dynamique selon les param��tres -->
                    ${(settings.requirePhoto || settings.requireSignature || settings.requireBoth) ? `
                    <div id="validation-warning" class="${this.getValidationStatus(settings) ? 'hidden' : ''} p-3 bg-amber-50 rounded-xl border border-amber-200 text-xs text-amber-800">
                        <i data-lucide="alert-triangle" class="w-4 h-4 inline mr-1"></i>
                        ${this.getValidationWarningMessage(settings)}
                    </div>
                    ` : ''}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: '���?? Confirmer la livraison', onclick: `LivreurModule.confirmDeliveryWithPhotos(${d.id})`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 disabled:opacity-50' }
            ]);

            // Initialiser le canvas de signature apr��s l'affichage du modal (si visible)
            if (showSignatureSection) {
                setTimeout(() => this.initSignatureCanvas(), 100);
            }
        },

        // Obtenir le statut de validation actuel
        getValidationStatus(settings) {
            if (!settings) settings = this.currentValidationSettings || {};
            const hasPhotos = this.validationPhotos && this.validationPhotos.length > 0;
            const hasEnoughPhotos = this.validationPhotos && this.validationPhotos.length >= (settings.minPhotos || 1);
            const hasSignature = !!this.signatureData;

            if (!settings.requirePhoto && !settings.requireSignature) return true;
            if (settings.requireBoth) return hasEnoughPhotos && hasSignature;
            if (settings.requirePhoto && !settings.requireSignature) return hasEnoughPhotos;
            if (settings.requireSignature && !settings.requirePhoto) return hasSignature;
            return hasPhotos || hasSignature;
        },

        // Obtenir le message d'avertissement
        getValidationWarningMessage(settings) {
            if (!settings) settings = this.currentValidationSettings || {};
            if (settings.requireBoth) {
                return `Veuillez ajouter ${settings.minPhotos || 1} photo(s) ET la signature du client`;
            }
            if (settings.requirePhoto && !settings.requireSignature) {
                return `Veuillez ajouter au moins ${settings.minPhotos || 1} photo(s)`;
            }
            if (settings.requireSignature && !settings.requirePhoto) {
                return 'La signature du client est requise';
            }
            return 'Veuillez ajouter une photo OU la signature du client';
        },

        // Initialiser le canvas de signature
        initSignatureCanvas() {
            const canvas = document.getElementById('signature-canvas');
            if (!canvas) return;

            // Ajuster la taille du canvas
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = 150;

            const ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#1e293b';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            this.signatureCanvas = canvas;

            // Si une signature existe d�j��, la charger
            if (this.signatureData) {
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, 0, 0);
                };
                img.src = this.signatureData;
            }

            // �v�nements souris
            canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
            canvas.addEventListener('mousemove', (e) => this.draw(e));
            canvas.addEventListener('mouseup', () => this.stopDrawing());
            canvas.addEventListener('mouseleave', () => this.stopDrawing());

            // �v�nements tactiles
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                this.startDrawing(e.touches[0]);
            });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                this.draw(e.touches[0]);
            });
            canvas.addEventListener('touchend', () => this.stopDrawing());
        },

        // Commencer �� dessiner
        startDrawing(e) {
            this.isDrawing = true;
            const canvas = this.signatureCanvas;
            if (!canvas) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const ctx = canvas.getContext('2d');
            ctx.beginPath();
            ctx.moveTo(x, y);

            // Masquer le placeholder
            const placeholder = document.getElementById('signature-placeholder');
            if (placeholder) placeholder.classList.add('hidden');
        },

        // Dessiner
        draw(e) {
            if (!this.isDrawing || !this.signatureCanvas) return;

            const canvas = this.signatureCanvas;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const ctx = canvas.getContext('2d');
            ctx.lineTo(x, y);
            ctx.stroke();
        },

        // Arr��ter de dessiner et sauvegarder
        stopDrawing() {
            if (!this.isDrawing) return;
            this.isDrawing = false;

            // Sauvegarder la signature
            if (this.signatureCanvas) {
                // V�rifier si le canvas contient quelque chose
                const ctx = this.signatureCanvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, this.signatureCanvas.width, this.signatureCanvas.height);
                const hasDrawing = imageData.data.some((value, index) => index % 4 === 3 && value > 0);

                if (hasDrawing) {
                    this.signatureData = this.signatureCanvas.toDataURL('image/png');
                    this.updateValidationWarning();
                    
                    // Mettre �� jour le statut
                    const status = document.getElementById('signature-status');
                    if (status) {
                        status.textContent = '���?? Signature enregistr�e';
                        status.classList.remove('text-slate-400');
                        status.classList.add('text-emerald-600');
                    }
                }
            }
        },

        // Effacer la signature
        clearSignature() {
            if (this.signatureCanvas) {
                const ctx = this.signatureCanvas.getContext('2d');
                ctx.clearRect(0, 0, this.signatureCanvas.width, this.signatureCanvas.height);
            }
            this.signatureData = null;

            // Afficher le placeholder
            const placeholder = document.getElementById('signature-placeholder');
            if (placeholder) placeholder.classList.remove('hidden');

            // Mettre �� jour le statut
            const status = document.getElementById('signature-status');
            if (status) {
                status.textContent = 'Pas de signature';
                status.classList.remove('text-emerald-600');
                status.classList.add('text-slate-400');
            }

            this.updateValidationWarning();
        },

        // Mettre �� jour l'avertissement de validation
        updateValidationWarning() {
            const warning = document.getElementById('validation-warning');
            if (warning) {
                const settings = this.currentValidationSettings || {};
                if (this.getValidationStatus(settings)) {
                    warning.classList.add('hidden');
                } else {
                    warning.classList.remove('hidden');
                }
            }
        },

        // G�rer l'upload de photo
        handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // V�rifier le type
            if (!file.type.startsWith('image/')) {
                UI.toast('Veuillez s�lectionner une image', 'error');
                return;
            }

            // V�rifier la taille (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                UI.toast('Image trop grande (max 5MB)', 'error');
                return;
            }

            // Lire et compresser l'image
            const reader = new FileReader();
            reader.onload = (e) => {
                // Compresser l'image
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const maxSize = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > height && width > maxSize) {
                        height = (height * maxSize) / width;
                        width = maxSize;
                    } else if (height > maxSize) {
                        width = (width * maxSize) / height;
                        height = maxSize;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convertir en base64 compress�
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // Ajouter �� la liste
                    if (this.validationPhotos.length < 5) {
                        this.validationPhotos.push(compressedDataUrl);
                        this.refreshPhotoPreview();
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        },

        // Supprimer une photo
        removeValidationPhoto(index) {
            this.validationPhotos.splice(index, 1);
            this.refreshPhotoPreview();
        },

        // Rafra��chir l'aper��u des photos
        refreshPhotoPreview() {
            const container = document.getElementById('validation-photos-preview');
            const warning = document.getElementById('validation-warning');
            
            if (container) {
                container.innerHTML = `
                    ${this.validationPhotos.map((photo, idx) => `
                        <div class="relative aspect-square rounded-xl overflow-hidden border-2 border-emerald-400">
                            <img src="${photo}" class="w-full h-full object-cover">
                            <button onclick="LivreurModule.removeValidationPhoto(${idx})" class="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                    `).join('')}
                    
                    ${this.validationPhotos.length < 5 ? `
                        <label class="aspect-square rounded-xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center cursor-pointer hover:border-emerald-500 hover:bg-emerald-50 transition">
                            <i data-lucide="camera" class="w-8 h-8 text-slate-400"></i>
                            <span class="text-xs text-slate-500 mt-1">Ajouter</span>
                            <input type="file" accept="image/*" capture="environment" class="hidden" onchange="LivreurModule.handlePhotoUpload(event)">
                        </label>
                    ` : ''}
                `;
                lucide.createIcons();
            }

            // Mettre �� jour le compteur
            const counter = container?.parentElement?.querySelector('.text-slate-400');
            if (counter) {
                counter.textContent = `${this.validationPhotos.length}/5 photos`;
            }

            // Afficher/masquer l'avertissement
            this.updateValidationWarning();
        },

        // Confirmer la livraison avec les photos et/ou signature
        confirmDeliveryWithPhotos(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;

            // Utiliser les param��tres de validation du POS
            const validation = CORE.canValidateDelivery(deliveryId, this.validationPhotos, this.signatureData);
            if (!validation.valid) {
                UI.toast(validation.message, 'error');
                return;
            }

            const note = UI.val('delivery_validation_note')?.trim() || null;

            // Calculer la commission
            const calculatedCommission = d.commission || CORE.calculateDeliveryCommission(d);

            // Mettre �� jour la livraison avec les photos et la signature
            CORE.update('deliveries', d.id, {
                status: 'livree',
                proofPhotos: this.validationPhotos.length > 0 ? this.validationPhotos : null,
                proofSignature: this.signatureData || null,
                proofNote: note,
                proofTimestamp: new Date().toISOString(),
                commission: calculatedCommission,
                deliveredAt: new Date().toISOString()
            });

            // Sync order
            const o = CORE.db.orders.find(x => x.id === d.orderId);
            if (o) {
                // Pour COD: le paymentStatus reste 'pending' jusqu'�� encaissement manuel par le vendeur
                // L'argent est maintenant avec le livreur, pas encore encaiss� par le vendeur
                const updatedOrder = CORE.update('orders', o.id, {
                    status: 'delivered',
                    paymentStatus: o.paymentStatus // Conserver le statut actuel (pending pour COD)
                });

                // Ledger: enregistrer encaissement
                CORE.ensureSaleTransaction(updatedOrder);

                // Ledger: commission livreur
                const updatedDelivery = CORE.db.deliveries.find(x => x.id === deliveryId);
                CORE.ensureCommissionTransaction({ ...updatedDelivery, status: 'livree' });
            }

            // Mettre �� jour le compteur de livraisons du livreur
            if (d.livreurId) {
                const isIndependent = String(d.livreurId).startsWith('idm_');
                if (isIndependent) {
                    // Livreur ind�pendant
                    const dm = CORE.db.independentDeliveryMen.find(m => m.id === d.livreurId);
                    if (dm) {
                        dm.deliveryCount = (dm.deliveryCount || 0) + 1;
                        dm.totalEarnings = (dm.totalEarnings || 0) + (calculatedCommission || 0);
                    }
                } else {
                    // Livreur employ�
                    const livreur = CORE.getUser(d.livreurId);
                    if (livreur) {
                        CORE.update('users', d.livreurId, {
                            deliveryCount: (livreur.deliveryCount || 0) + 1
                        });
                    }
                }
            }

            // D�terminer le message selon le type de preuve
            let proofType = '';
            if (this.validationPhotos.length > 0 && this.signatureData) {
                proofType = 'photo et signature';
            } else if (this.signatureData) {
                proofType = 'signature';
            } else if (this.validationPhotos.length > 0) {
                proofType = 'photo';
            }

            // Enregistrer dans le journal d'audit
            const currentUser = CORE.state.currentUser;
            CORE.db.auditLogs = CORE.db.auditLogs || [];
            CORE.db.auditLogs.push({
                id: 'audit_' + Date.now(),
                timestamp: new Date().toISOString(),
                userId: currentUser?.id,
                userName: currentUser?.name,
                userRole: currentUser?.role,
                posId: currentUser?.pos,
                action: 'deliver',
                entity: 'livraison',
                entityId: deliveryId,
                entityName: d.clientName || 'Client',
                details: `Livraison confirm�e${proofType ? ` avec ${proofType}` : ''} - ${d.clientName || 'Client'} - ${CORE.formatPrice(d.total || 0)}`,
                status: 'success'
            });
            CORE.save();

            // R�initialiser
            this.validationPhotos = [];
            this.signatureData = null;
            this.signatureCanvas = null;
            this.currentValidationSettings = null;

            UI.closeModal();
            UI.toast(`���?? Livraison valid�e${proofType ? ` avec preuve ${proofType}` : ''}!`, 'success');
            App.rerender();
        },

        setDeliveryStatus(deliveryId, status) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;

            // Si on veut marquer comme livr�e, ouvrir le modal de validation avec photos
            if (status === 'livree') {
                this.showDeliveryValidationModal(deliveryId);
                return;
            }

            const oldStatus = d.status;
            
            // Si la livraison est compl�t�e, mettre �� jour la commission si pas d�j�� d�finie
            if (status === 'livree' && !d.commission) {
                const calculatedCommission = CORE.calculateDeliveryCommission(d);
                CORE.update('deliveries', d.id, { status, commission: calculatedCommission, deliveredAt: new Date().toISOString() });
            } else {
                CORE.update('deliveries', d.id, { status, deliveredAt: status === 'livree' ? new Date().toISOString() : (d.deliveredAt || null) });
            }

            // Enregistrer dans le journal d'audit
            const currentUser = CORE.state.currentUser;
            const statusLabels = { en_attente: 'En attente', en_cours: 'En cours', livree: 'Livr�e', probleme: 'Probl��me' };
            CORE.db.auditLogs = CORE.db.auditLogs || [];
            CORE.db.auditLogs.push({
                id: 'audit_' + Date.now(),
                timestamp: new Date().toISOString(),
                userId: currentUser?.id,
                userName: currentUser?.name,
                userRole: currentUser?.role,
                posId: currentUser?.pos,
                action: 'status_change',
                entity: 'livraison',
                entityId: deliveryId,
                entityName: d.clientName || 'Client',
                details: `Statut livraison: ${statusLabels[oldStatus] || oldStatus} ���? ${statusLabels[status] || status}`,
                status: 'success'
            });
            CORE.save();

            // Sync order
            const o = CORE.db.orders.find(x => x.id === d.orderId);
            if (o) {
                if (status === 'en_cours') {
                    if (o.status !== 'delivered') CORE.update('orders', o.id, { status: 'delivering' });
                }
                if (status === 'livree') {
                    // Pour COD: le paymentStatus reste 'pending' jusqu'�� encaissement manuel par le vendeur
                    // L'argent est maintenant avec le livreur, pas encore encaiss� par le vendeur
                    const updatedOrder = CORE.update('orders', o.id, {
                        status: 'delivered',
                        paymentStatus: o.paymentStatus // Conserver le statut actuel (pending pour COD)
                    });

                    // Ledger: enregistrer encaissement (cash/mobile d�j�� pay�, cod encaiss� �� la livraison)
                    CORE.ensureSaleTransaction(updatedOrder);

                    // Ledger: commission livreur (mise �� jour avec la commission calcul�e)
                    const updatedDelivery = CORE.db.deliveries.find(x => x.id === deliveryId);
                    CORE.ensureCommissionTransaction({ ...updatedDelivery, status: 'livree' });
                }
                if (status === 'probleme') {
                    if (o.status !== 'delivered') CORE.update('orders', o.id, { status: 'delivering' });
                }
            }

            UI.toast(`Course: ${status}`, 'success');
            App.rerender();
        },

        viewDeliveryDetail(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;
            
            const order = CORE.db.orders.find(o => o.id === d.orderId);
            const livreur = CORE.getUser(d.livreurId);
            
            let itemsHtml = '<div class="text-sm text-slate-500">Pas d\'articles</div>';
            if (order && order.items && order.items.length > 0) {
                itemsHtml = order.items.map(item => `
                    <div class="p-3 rounded-xl border border-slate-200 bg-slate-50">
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex-1">
                                <div class="font-bold text-slate-900">${item.name}</div>
                                <div class="text-xs text-slate-500 mt-1">Code produit: #${item.productId}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-black text-slate-900">${item.qty}�??</div>
                                <div class="text-xs text-slate-500">${CORE.formatPrice(item.price)}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            let statusBadge = '';
            if (d.status === 'livree') {
                statusBadge = UI.badge('���?? Livr�e', 'emerald');
            } else if (d.status === 'en_cours') {
                statusBadge = UI.badge('En cours', 'amber');
            } else if (d.status === 'en_attente') {
                statusBadge = UI.badge('En attente', 'slate');
            } else if (d.status === 'probleme') {
                statusBadge = UI.badge('Probl��me', 'red');
            } else if (d.status === 'reservation') {
                statusBadge = UI.badge('R�servation', 'blue');
            }

            return UI.modal(`Bon de livraison ${d.orderRef}`, `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <!-- En-t��te avec statut -->
                    <div class="flex items-center justify-between p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div>
                            <div class="text-xs text-slate-500 font-black uppercase">Num�ro de bon</div>
                            <div class="text-lg font-black text-slate-900">${d.orderRef}</div>
                        </div>
                        <div class="text-right">
                            ${statusBadge}
                        </div>
                    </div>

                    <!-- Informations client -->
                    <div class="border border-slate-200 rounded-2xl overflow-hidden">
                        <div class="p-3 bg-slate-50 border-b border-slate-200 font-black text-xs text-slate-700 uppercase">Client</div>
                        <div class="p-4 space-y-3">
                            <div>
                                <div class="text-xs text-slate-500 font-bold">Nom</div>
                                <div class="font-black text-slate-900">${d.clientName || '�� ?��'}</div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-500 font-bold">T�l�phone</div>
                                <div class="flex items-center justify-between gap-3 mt-1">
                                    <div class="font-bold text-slate-900">${d.clientPhone || '�� ?��'}</div>
                                    ${d.clientPhone ? `
                                        <a href="tel:${d.clientPhone}" class="px-3 py-2 bg-emerald-600 text-white text-xs font-black rounded-lg hover:bg-emerald-700 transition flex items-center gap-2 whitespace-nowrap">
                                            <i data-lucide="phone" class="w-4 h-4"></i>
                                            <span>Appeler</span>
                                        </a>
                                    ` : ''}
                                </div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-500 font-bold">Adresse de livraison</div>
                                <div class="font-bold text-slate-900 mt-1">${d.address || '�� ?��'}</div>
                            </div>
                        </div>
                    </div>

                    <!-- D�tails de livraison -->
                    <div class="border border-slate-200 rounded-2xl overflow-hidden">
                        <div class="p-3 bg-slate-50 border-b border-slate-200 font-black text-xs text-slate-700 uppercase">D�tails de livraison</div>
                        <div class="p-4 space-y-3">
                            ${d.deliveryDate ? `
                                <div>
                                    <div class="text-xs text-slate-500 font-bold">Date pr�vue</div>
                                    <div class="font-bold text-slate-900">${new Date(d.deliveryDate).toLocaleDateString('fr-FR')}</div>
                                </div>
                            ` : ''}
                            ${d.deliveryTime ? `
                                <div>
                                    <div class="text-xs text-slate-500 font-bold">Heure pr�vue</div>
                                    <div class="font-bold text-slate-900">${d.deliveryTime}</div>
                                </div>
                            ` : ''}
                            <div>
                                <div class="text-xs text-slate-500 font-bold">Date de cr�ation</div>
                                <div class="font-bold text-slate-900">${CORE.formatDate(d.createdAt)}</div>
                            </div>
                            ${d.status === 'livree' ? `
                                <div>
                                    <div class="text-xs text-slate-500 font-bold">Date de livraison</div>
                                    <div class="font-bold text-emerald-700">${d.completedAt ? CORE.formatDate(d.completedAt) : 'Non enregistr�e'}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Montants et paiement -->
                    ${order ? `
                        <div class="border border-slate-200 rounded-2xl overflow-hidden">
                            <div class="p-3 bg-slate-50 border-b border-slate-200 font-black text-xs text-slate-700 uppercase">Montants</div>
                            <div class="p-4 space-y-2">
                                <div class="flex items-center justify-between">
                                    <div class="text-sm text-slate-600">Sous-total</div>
                                    <div class="font-black text-slate-900">${CORE.formatPrice(order.subtotal || 0)}</div>
                                </div>
                                ${order.deliveryFee > 0 ? `
                                    <div class="flex items-center justify-between">
                                        <div class="text-sm text-slate-600">Frais de livraison</div>
                                        <div class="font-black text-slate-900">${CORE.formatPrice(order.deliveryFee || 0)}</div>
                                    </div>
                                ` : ''}
                                <div class="border-t border-slate-200 pt-2 flex items-center justify-between">
                                    <div class="font-black text-slate-700">Total</div>
                                    <div class="text-xl font-black text-emerald-600">${CORE.formatPrice(order.total || 0)}</div>
                                </div>
                                <div class="mt-3 p-3 bg-blue-50 border border-blue-100 rounded-xl">
                                    <div class="text-xs text-blue-700 font-bold">M�thode de paiement</div>
                                    <div class="font-black text-blue-900 mt-1">${CORE.paymentMethodLabel(order.paymentMethod || 'Inconnue')}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Articles -->
                    ${order ? `
                        <div class="border border-slate-200 rounded-2xl overflow-hidden">
                            <div class="p-3 bg-slate-50 border-b border-slate-200 font-black text-xs text-slate-700 uppercase">Articles (${order.items ? order.items.length : 0})</div>
                            <div class="p-4 space-y-2">
                                ${itemsHtml}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Informations du livreur -->
                    ${livreur ? `
                        <div class="border border-slate-200 rounded-2xl overflow-hidden">
                            <div class="p-3 bg-slate-50 border-b border-slate-200 font-black text-xs text-slate-700 uppercase">Livreur</div>
                            <div class="p-4 space-y-2">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 gradient-livreur rounded-xl flex items-center justify-center text-white font-black text-sm">${livreur.avatar}</div>
                                    <div>
                                        <div class="font-black text-slate-900">${livreur.name}</div>
                                        <div class="text-xs text-slate-500">${livreur.vehicle || 'V�hicule non sp�cifi�'}</div>
                                    </div>
                                </div>
                                ${livreur.phone ? `
                                    <div class="text-xs text-slate-500 mt-2">T�l�phone: <span class="font-bold text-slate-900">${livreur.phone}</span></div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Commission -->
                    <div class="p-3 bg-amber-50 border border-amber-200 rounded-xl">
                        <div class="text-xs text-amber-700 font-bold">Commission</div>
                        <div class="text-lg font-black text-amber-900 mt-1">${CORE.formatPrice(d.commission || Math.round(d.amount * 0.05))}</div>
                    </div>

                    <!-- Photos de preuve (si livr�e) -->
                    ${d.proofPhotos && d.proofPhotos.length > 0 ? `
                        <div class="border border-emerald-200 rounded-2xl overflow-hidden">
                            <div class="p-3 bg-emerald-50 border-b border-emerald-200 font-black text-xs text-emerald-700 uppercase flex items-center gap-2">
                                <i data-lucide="camera" class="w-4 h-4"></i>
                                Photos de preuve (${d.proofPhotos.length})
                            </div>
                            <div class="p-4">
                                <div class="grid grid-cols-3 gap-2">
                                    ${d.proofPhotos.map((photo, idx) => `
                                        <div class="aspect-square rounded-xl overflow-hidden border border-emerald-200 cursor-pointer" onclick="LivreurModule.viewProofPhoto('${photo.replace(/'/g, "\\'")}')">
                                            <img src="${photo}" class="w-full h-full object-cover hover:scale-110 transition">
                                        </div>
                                    `).join('')}
                                </div>
                                ${d.proofNote ? `
                                    <div class="mt-3 p-3 bg-slate-50 rounded-xl text-xs text-slate-600">
                                        <span class="font-bold">Note:</span> ${d.proofNote}
                                    </div>
                                ` : ''}
                                ${d.proofTimestamp ? `
                                    <div class="mt-2 text-xs text-slate-400 text-right">
                                        Valid� le ${new Date(d.proofTimestamp).toLocaleString('fr-FR')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `, (() => {
                const buttons = [];
                if (d.status !== 'livree') {
                    buttons.push({ label: 'En cours', onclick: `LivreurModule.setDeliveryStatus(${d.id},'en_cours'); UI.closeModal();`, class: 'px-4 py-2 rounded-xl bg-amber-500 text-white font-black hover:bg-amber-600' });
                    buttons.push({ label: '��Ÿ? � Valider', onclick: `UI.closeModal(); LivreurModule.showDeliveryValidationModal(${d.id});`, class: 'px-4 py-2 rounded-xl bg-emerald-600 text-white font-black hover:bg-emerald-700' });
                    buttons.push({ label: 'Probl��me', onclick: `LivreurModule.setDeliveryStatus(${d.id},'probleme'); UI.closeModal();`, class: 'px-4 py-2 rounded-xl bg-red-600 text-white font-black hover:bg-red-700' });
                }
                buttons.push({ label: 'Fermer', onclick: 'UI.closeModal()', class: 'px-4 py-2 rounded-xl bg-slate-200 text-slate-700 font-black hover:bg-slate-300' });
                return buttons;
            })());
        },

        // Voir une photo de preuve en plein �cran
        viewProofPhoto(photoSrc) {
            UI.modal('��Ÿ? � Photo de preuve', `
                <div class="flex items-center justify-center">
                    <img src="${photoSrc}" class="max-w-full max-h-[70vh] rounded-2xl shadow-lg">
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-3xl' });
        },

        renderNavItem(view, icon, label) {
            if (!CORE.canAccessView(view)) return '';
            const active = this.state.currentView === view;
            return `
                <button onclick="LivreurModule.navigateTo(\'${view}\')" class="flex flex-col items-center gap-1 px-3 py-2 rounded-2xl transition ${active ? 'text-slate-900' : 'text-slate-400 hover:text-slate-700'}">
                    <i data-lucide="${icon}" class="w-6 h-6"></i>
                    <span class="text-[10px] font-black">${label}</span>
                </button>`;
        },

        renderDashboard() {
            const stats = this.getStats();
            const inProgress = this.getMyDeliveries().filter(d => d.status === 'en_cours');
            const pendingDeliveries = this.getPendingDeliveries();
            
            return `
                <div class="space-y-4 fade-in">
                    <div class="gradient-livreur p-6 rounded-3xl text-white shadow-xl shadow-red-200 relative overflow-hidden">
                        <div class="relative z-10">
                            <div class="text-white/80 text-sm font-medium mb-1">Gains du jour</div>
                            <div class="text-4xl font-black">${CORE.formatPrice(stats.gainsJour)}</div>
                            <div class="mt-4 flex gap-2">
                                <span class="bg-white/20 backdrop-blur px-3 py-1 rounded-lg text-xs font-black">Livr�es: ${stats.done}</span>
                                <span class="bg-white/20 backdrop-blur px-3 py-1 rounded-lg text-xs font-black">En cours: ${stats.inProgress}</span>
                            </div>
                        </div>
                        <div class="absolute right-0 bottom-0 opacity-10"><i data-lucide="trending-up" class="w-32 h-32"></i></div>
                    </div>

                    ${pendingDeliveries.length > 0 ? `
                    <!-- Livraisons disponibles �� accepter -->
                    <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-3xl border-2 border-amber-300 overflow-hidden shadow-lg">
                        <div class="p-5 border-b border-amber-200 flex items-center justify-between bg-amber-100/50">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">��Ÿ? �</span>
                                <h3 class="font-black text-amber-900">Courses disponibles</h3>
                                <span class="px-2 py-1 bg-amber-500 text-white text-xs font-black rounded-full">${pendingDeliveries.length}</span>
                            </div>
                            <span class="text-xs font-bold text-amber-700">Cliquez pour accepter</span>
                        </div>
                        <div class="p-4 space-y-3">
                            ${pendingDeliveries.slice(0, 5).map(d => this.renderPendingDeliveryCard(d)).join('')}
                            ${pendingDeliveries.length > 5 ? `
                                <div class="text-center text-xs text-amber-700 font-bold">
                                    +${pendingDeliveries.length - 5} autre(s) course(s) disponible(s)
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="font-black text-slate-900">En cours</h3>
                            <button onclick="LivreurModule.navigateTo('livraisons')" class="text-xs font-black text-red-600">Voir tout</button>
                        </div>
                        <div class="p-4">
                            ${inProgress.length === 0 ? `<div class="p-6 text-center text-slate-400 font-medium">Aucune course active</div>` : ''}
                            ${inProgress.slice(0,2).map(d => this.renderDeliveryCard(d)).join('')}
                        </div>
                    </div>
                </div>`;
        },

        // Carte pour une livraison en attente (non assign�e)
        renderPendingDeliveryCard(d) {
            const hasTime = d.deliveryTime ? `<span class="text-xs text-amber-700 font-bold"><i data-lucide="clock" class="w-3 h-3 inline"></i> ${d.deliveryTime}</span>` : '';
            
            return `
                <div class="bg-white border-2 border-amber-200 rounded-2xl p-4 hover:border-amber-400 hover:shadow-lg transition-all cursor-pointer" onclick="LivreurModule.showAcceptDeliveryModal(${d.id})">
                    <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0 flex-1">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-xs font-black text-amber-800 bg-amber-200 px-2.5 py-1 rounded-lg">${d.orderRef}</span>
                                ${hasTime}
                            </div>
                            <div class="mt-2 font-black text-slate-900 truncate">${d.clientName}</div>
                            <div class="text-xs text-slate-500 flex items-center gap-1 mt-1 truncate"><i data-lucide="map-pin" class="w-3 h-3 flex-shrink-0"></i>${d.address}</div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <div class="font-black text-emerald-600 text-lg">${CORE.formatPrice(d.amount)}</div>
                            <div class="text-xs text-amber-700 font-bold mt-1">~${CORE.formatPrice(Math.round(d.amount * 0.05))}</div>
                            <button onclick="event.stopPropagation(); LivreurModule.acceptPendingDelivery(${d.id})" class="mt-2 px-4 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700 transition shadow-lg shadow-emerald-200">
                                ���?? Accepter
                            </button>
                        </div>
                    </div>
                </div>`;
        },

        // Modal de confirmation d'acceptation
        showAcceptDeliveryModal(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;

            const order = CORE.db.orders.find(o => o.id === d.orderId);
            const itemsCount = order?.items?.length || 0;
            const itemsList = order?.items?.map(it => `<li class="flex justify-between text-sm"><span>${it.qty}�?? ${it.name}</span><span class="font-bold">${CORE.formatPrice(it.qty * it.price)}</span></li>`).join('') || '';

            UI.modal('��Ÿ? � Accepter cette course ?', `
                <div class="space-y-4">
                    <div class="p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl border border-amber-200">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <div class="text-xs font-black text-amber-800 bg-amber-200 px-2 py-1 rounded-lg inline-block">${d.orderRef}</div>
                                <div class="mt-2 font-black text-slate-900">${d.clientName}</div>
                                <div class="text-xs text-slate-500 mt-1">${d.clientPhone || ''}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                                <div class="text-xs text-amber-700 font-bold">Commission: ~${CORE.formatPrice(Math.round(d.amount * 0.05))}</div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <div class="flex items-start gap-2">
                            <i data-lucide="map-pin" class="w-4 h-4 text-slate-500 mt-0.5 flex-shrink-0"></i>
                            <div class="text-sm text-slate-700">${d.address}</div>
                        </div>
                        ${d.deliveryTime ? `
                            <div class="flex items-center gap-2 mt-2">
                                <i data-lucide="clock" class="w-4 h-4 text-amber-600"></i>
                                <span class="text-sm font-bold text-amber-700">Livraison �� ${d.deliveryTime}</span>
                            </div>
                        ` : ''}
                    </div>

                    ${itemsCount > 0 ? `
                        <div class="p-4 bg-white rounded-2xl border border-slate-200">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-2">Articles (${itemsCount})</div>
                            <ul class="space-y-1">${itemsList}</ul>
                        </div>
                    ` : ''}

                    <div class="p-4 bg-blue-50 rounded-2xl border border-blue-200">
                        <div class="flex items-start gap-2">
                            <i data-lucide="info" class="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0"></i>
                            <div class="text-xs text-blue-800">
                                En acceptant cette course, elle sera assign�e �� votre compte et vous devrez la livrer.
                            </div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: '���?? Accepter cette course', onclick: `LivreurModule.acceptPendingDelivery(${d.id}); UI.closeModal()`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' }
            ]);
        },

        renderDeliveryCard(d) {
            const badge = d.status === 'livree' ? UI.badge('���?? Livr�e', 'emerald') : d.status === 'probleme' ? UI.badge('��š � Probl��me','red') : d.status === 'en_attente' ? UI.badge('En attente', 'slate') : UI.badge('En cours','amber');
            const order = CORE.db.orders.find(o => o.id === d.orderId);
            const itemsCount = order?.items?.length || 0;
            const hasTime = d.deliveryTime ? `<span class="text-xs text-slate-500"><i data-lucide="clock" class="w-3 h-3 inline"></i> ${d.deliveryTime}</span>` : '';
            const hasPhotos = d.proofPhotos && d.proofPhotos.length > 0;
            const hasSignature = !!d.proofSignature;
            const hasProof = hasPhotos || hasSignature;
            
            // Badge de preuve
            let proofBadge = '';
            if (hasPhotos && hasSignature) {
                proofBadge = `<span class="text-xs font-bold text-emerald-700 bg-emerald-50 px-2 py-1 rounded-lg flex items-center gap-1"><i data-lucide="camera" class="w-3 h-3"></i>${d.proofPhotos.length} + ���? ��� � �</span>`;
            } else if (hasPhotos) {
                proofBadge = `<span class="text-xs font-bold text-emerald-700 bg-emerald-50 px-2 py-1 rounded-lg flex items-center gap-1"><i data-lucide="camera" class="w-3 h-3"></i> ${d.proofPhotos.length}</span>`;
            } else if (hasSignature) {
                proofBadge = `<span class="text-xs font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded-lg flex items-center gap-1">���? ��� � � Sign�</span>`;
            }
            
            return `
                <div class="bg-white border border-slate-200 rounded-3xl p-4 mb-3 hover:shadow-lg transition-shadow cursor-pointer" onclick="LivreurModule.viewDeliveryDetail(${d.id})">
                    <div class="flex items-start justify-between gap-4">
                        <div class="min-w-0 flex-1">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-xs font-black text-slate-700 bg-slate-100 px-2.5 py-1 rounded-lg">${d.orderRef}</span>
                                ${badge}
                                ${proofBadge}
                            </div>
                            <div class="mt-2 font-black text-slate-900 truncate text-lg">${d.clientName}</div>
                            <div class="text-xs text-slate-500 flex items-center gap-1 mt-1"><i data-lucide="map-pin" class="w-3 h-3"></i>${d.address}</div>
                            <div class="mt-2 flex items-center gap-3">
                                ${hasTime}
                                ${itemsCount > 0 ? `<span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-lg"><i data-lucide="package" class="w-3 h-3 inline"></i> ${itemsCount} article${itemsCount > 1 ? 's' : ''}</span>` : ''}
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <div class="font-black text-emerald-600 text-lg">${CORE.formatPrice(d.amount)}</div>
                            <div class="text-xs text-amber-700 font-bold mt-1">Commission: ${CORE.formatPrice(d.commission || Math.round(d.amount * 0.05))}</div>
                            <div class="mt-3 flex flex-col gap-2 items-end">
                                ${hasProof ? `
                                    <button onclick="event.stopPropagation(); LivreurModule.showProofPhotosGallery(${d.id})" class="px-3 py-1.5 rounded-lg bg-emerald-50 text-emerald-700 text-[10px] font-black hover:bg-emerald-100 transition flex items-center gap-1 border border-emerald-200">
                                        <i data-lucide="eye" class="w-3 h-3"></i> Voir preuves
                                    </button>
                                ` : ''}
                                ${d.status === 'livree' ? `
                                    <button onclick="event.stopPropagation(); LivreurModule.printDeliveryReceipt(${d.id})" class="px-3 py-1.5 rounded-lg bg-blue-50 text-blue-700 text-[10px] font-black hover:bg-blue-100 transition flex items-center gap-1 border border-blue-200">
                                        <i data-lucide="printer" class="w-3 h-3"></i> Re��u
                                    </button>
                                ` : ''}
                                ${d.status !== 'livree' ? `
                                    <button onclick="event.stopPropagation(); LivreurModule.setDeliveryStatus(${d.id},\'en_cours\')" class="px-3 py-1.5 rounded-lg bg-amber-500 text-white text-[10px] font-black hover:bg-amber-600 transition">En cours</button>
                                    <button onclick="event.stopPropagation(); LivreurModule.setDeliveryStatus(${d.id},\'livree\')" class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-[10px] font-black hover:bg-emerald-700 transition">��Ÿ? � Valider</button>
                                ` : ''}
                                <button onclick="event.stopPropagation(); LivreurModule.openChat(${d.id})" class="px-2 py-1.5 rounded-lg bg-indigo-50 text-indigo-600 text-[10px] font-black hover:bg-indigo-100 flex items-center gap-1 transition"><i data-lucide="message-circle" class="w-3 h-3"></i> Chat</button>
                            </div>
                        </div>
                    </div>
                </div>`;
        },

        // Afficher la galerie des photos de preuve et signature
        showProofPhotosGallery(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d || ((!d.proofPhotos || d.proofPhotos.length === 0) && !d.proofSignature)) {
                UI.toast('Aucune preuve de livraison', 'info');
                return;
            }

            const hasPhotos = d.proofPhotos && d.proofPhotos.length > 0;
            const hasSignature = !!d.proofSignature;

            UI.modal(`��Ÿ? � Preuves - ${d.orderRef}`, `
                <div class="space-y-4">
                    <!-- Info livraison -->
                    <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-black text-emerald-900">${d.clientName || 'Client'}</div>
                                <div class="text-xs text-emerald-700">${d.address || ''}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                                <div class="text-xs text-emerald-600">���?? Livr�e</div>
                            </div>
                        </div>
                    </div>

                    ${hasPhotos ? `
                        <!-- Galerie photos -->
                        <div>
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-2">��Ÿ? � Photos de preuve (${d.proofPhotos.length})</div>
                            <div class="grid grid-cols-2 gap-3">
                                ${d.proofPhotos.map((photo, idx) => `
                                    <div class="aspect-square rounded-2xl overflow-hidden border-2 border-emerald-300 cursor-pointer hover:border-emerald-500 transition" onclick="LivreurModule.viewSingleProofPhoto(${d.id}, ${idx})">
                                        <img src="${photo}" class="w-full h-full object-cover hover:scale-105 transition">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${hasSignature ? `
                        <!-- Signature client -->
                        <div>
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-2">���? ��� � � Signature client</div>
                            <div class="p-4 bg-white rounded-2xl border-2 border-blue-200 cursor-pointer hover:border-blue-400 transition" onclick="LivreurModule.viewSignatureFullscreen(${d.id})">
                                <img src="${d.proofSignature}" class="w-full max-h-40 object-contain" alt="Signature du client">
                            </div>
                        </div>
                    ` : ''}

                    <!-- Note -->
                    ${d.proofNote ? `
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-1">Note du livreur</div>
                            <div class="text-sm text-slate-700">${d.proofNote}</div>
                        </div>
                    ` : ''}

                    <!-- Horodatage -->
                    <div class="text-center text-xs text-slate-400">
                        Valid� le ${d.proofTimestamp ? new Date(d.proofTimestamp).toLocaleString('fr-FR') : (d.deliveredAt ? new Date(d.deliveredAt).toLocaleString('fr-FR') : '�� ?��')}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-lg' });
        },

        // Voir la signature en plein �cran
        viewSignatureFullscreen(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d || !d.proofSignature) return;

            UI.modal('���? ��� � � Signature client', `
                <div class="flex flex-col items-center gap-4">
                    <div class="p-6 bg-white rounded-2xl border-2 border-slate-200 shadow-lg">
                        <img src="${d.proofSignature}" class="max-w-full max-h-[50vh]" alt="Signature du client">
                    </div>
                    <div class="text-sm text-slate-600">
                        Signature pour la commande <span class="font-bold">${d.orderRef}</span>
                    </div>
                    <div class="text-xs text-slate-400">
                        ${d.proofTimestamp ? new Date(d.proofTimestamp).toLocaleString('fr-FR') : ''}
                    </div>
                </div>
            `, [
                { label: 'Retour', onclick: `LivreurModule.showProofPhotosGallery(${deliveryId})` },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-md' });
        },

        // Voir une photo en plein �cran
        viewSingleProofPhoto(deliveryId, photoIndex) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d || !d.proofPhotos || !d.proofPhotos[photoIndex]) return;
            
            const photo = d.proofPhotos[photoIndex];
            const total = d.proofPhotos.length;
            
            UI.modal(`��Ÿ? � Photo ${photoIndex + 1}/${total}`, `
                <div class="flex flex-col items-center gap-4">
                    <img src="${photo}" class="max-w-full max-h-[65vh] rounded-2xl shadow-lg">
                    <div class="flex items-center gap-3">
                        ${photoIndex > 0 ? `
                            <button onclick="LivreurModule.viewSingleProofPhoto(${deliveryId}, ${photoIndex - 1})" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-700 font-black hover:bg-slate-300 transition">
                                ��� � Pr�c�dente
                            </button>
                        ` : ''}
                        ${photoIndex < total - 1 ? `
                            <button onclick="LivreurModule.viewSingleProofPhoto(${deliveryId}, ${photoIndex + 1})" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-700 font-black hover:bg-slate-300 transition">
                                Suivante ���?
                            </button>
                        ` : ''}
                    </div>
                </div>
            `, [
                { label: 'Retour galerie', onclick: `LivreurModule.showProofPhotosGallery(${deliveryId})` },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-3xl' });
        },

        // Imprimer un re��u de livraison
        printDeliveryReceipt(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;

            const order = CORE.db.orders.find(o => o.id === d.orderId);
            const livreur = CORE.getUser(d.livreurId);
            const pos = d.posId ? CORE.getPOS(d.posId) : null;
            const items = order?.items || [];

            // R�cup�rer les param��tres personnalis�s du vendeur
            const vendeurId = d.vendeurId || order?.vendeurId;
            const settings = vendeurId ? CORE.getReceiptSettings(vendeurId) : {};

            const companyName = settings.companyName || CORE.getCompanyName();
            const subtitle = settings.subtitle || 'Re��u de Livraison';
            const shopPhone = settings.phone || '';
            const shopAddress = settings.address || '';
            const showLogo = settings.showLogo !== false;
            const showItems = settings.showItems !== false;
            const showSignature = settings.showSignature !== false;
            const showCommission = settings.showCommission || false;
            const showProofPhotos = settings.showProofPhotos || false;
            const thankMessage = settings.thankMessage || 'Merci pour votre confiance!';
            const footerNote = settings.footerNote || '';

            const deliveredDate = d.deliveredAt ? new Date(d.deliveredAt).toLocaleString('fr-FR') : new Date().toLocaleString('fr-FR');
            const commission = d.commission || Math.round(d.amount * 0.05);
            const hasProofPhotos = d.proofPhotos && d.proofPhotos.length > 0;

            // G�n�rer le HTML du re��u avec les param��tres personnalis�s
            const receiptHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Re��u ${d.orderRef}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            font-family: 'Courier New', monospace; 
                            font-size: 12px; 
                            padding: 10px;
                            max-width: 300px;
                            margin: 0 auto;
                        }
                        .header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
                        .logo { font-size: 18px; font-weight: bold; }
                        .subtitle { font-size: 10px; color: #666; }
                        .shop-info { font-size: 9px; color: #888; margin-top: 3px; }
                        .section { margin: 10px 0; padding: 8px 0; border-bottom: 1px dashed #ccc; }
                        .row { display: flex; justify-content: space-between; margin: 3px 0; }
                        .label { color: #666; }
                        .value { font-weight: bold; text-align: right; }
                        .items { margin: 10px 0; }
                        .item { display: flex; justify-content: space-between; padding: 3px 0; font-size: 11px; }
                        .item-name { flex: 1; }
                        .item-qty { width: 40px; text-align: center; }
                        .item-price { width: 70px; text-align: right; }
                        .total { font-size: 16px; font-weight: bold; text-align: center; padding: 10px; background: #f0f0f0; margin: 10px 0; }
                        .footer { text-align: center; font-size: 10px; color: #666; margin-top: 15px; padding-top: 10px; border-top: 2px dashed #000; }
                        .signature { margin-top: 20px; padding-top: 30px; border-top: 1px solid #000; text-align: center; font-size: 10px; }
                        .status { background: #10b981; color: white; padding: 5px 10px; display: inline-block; border-radius: 4px; font-weight: bold; }
                        .proof-photos { text-align: center; font-size: 10px; color: #10b981; padding: 8px 0; border-bottom: 1px dashed #ccc; }
                        .footer-note { font-size: 9px; color: #888; margin-top: 5px; font-style: italic; }
                        @media print {
                            body { max-width: 80mm; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        ${showLogo ? '<div class="logo">��Ÿšš</div>' : ''}
                        <div class="logo">${companyName}</div>
                        <div class="subtitle">${subtitle}</div>
                        ${pos ? `<div class="subtitle">${pos.name}</div>` : ''}
                        ${shopPhone ? `<div class="shop-info">��Ÿ?ž ${shopPhone}</div>` : ''}
                        ${shopAddress ? `<div class="shop-info">��Ÿ? � ${shopAddress}</div>` : ''}
                    </div>

                    <div class="section">
                        <div class="row">
                            <span class="label">N�? � Bon:</span>
                            <span class="value">${d.orderRef}</span>
                        </div>
                        <div class="row">
                            <span class="label">Date:</span>
                            <span class="value">${deliveredDate}</span>
                        </div>
                        <div class="row">
                            <span class="label">Statut:</span>
                            <span class="status">���?? LIVR�E</span>
                        </div>
                    </div>

                    <div class="section">
                        <div class="row">
                            <span class="label">Client:</span>
                            <span class="value">${d.clientName || '�� ?��'}</span>
                        </div>
                        <div class="row">
                            <span class="label">T�l:</span>
                            <span class="value">${d.clientPhone || '�� ?��'}</span>
                        </div>
                        <div class="row">
                            <span class="label">Adresse:</span>
                        </div>
                        <div style="font-size: 11px; margin-top: 3px;">${d.address || '�� ?��'}</div>
                    </div>

                    ${showItems && items.length > 0 ? `
                        <div class="section">
                            <div style="font-weight: bold; margin-bottom: 5px;">Articles (${items.length})</div>
                            <div class="items">
                                ${items.map(item => `
                                    <div class="item">
                                        <span class="item-name">${item.name}</span>
                                        <span class="item-qty">x${item.qty}</span>
                                        <span class="item-price">${CORE.formatPrice(item.qty * item.price)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="total">
                        TOTAL: ${CORE.formatPrice(d.amount)}
                    </div>

                    <div class="section">
                        <div class="row">
                            <span class="label">Livreur:</span>
                            <span class="value">${livreur?.name || '�� ?��'}</span>
                        </div>
                        ${showCommission ? `
                            <div class="row">
                                <span class="label">Commission:</span>
                                <span class="value">${CORE.formatPrice(commission)}</span>
                            </div>
                        ` : ''}
                    </div>

                    ${showProofPhotos && hasProofPhotos ? `
                        <div class="proof-photos">
                            ��Ÿ? � ${d.proofPhotos.length} photo(s) de preuve jointe(s)
                        </div>
                    ` : ''}

                    ${showSignature ? `
                        <div class="signature">
                            <div>Signature client</div>
                            <div style="margin-top: 25px; border-bottom: 1px solid #000; width: 150px; margin-left: auto; margin-right: auto;"></div>
                        </div>
                    ` : ''}

                    <div class="footer">
                        <div>${thankMessage}</div>
                        ${footerNote ? `<div class="footer-note">${footerNote}</div>` : ''}
                        <div style="margin-top: 5px;">${companyName}</div>
                        <div>${new Date().toLocaleDateString('fr-FR')}</div>
                    </div>

                    <div class="no-print" style="margin-top: 20px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 30px; font-size: 14px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            ��Ÿ? ��� � � Imprimer
                        </button>
                        <button onclick="window.close()" style="padding: 10px 30px; font-size: 14px; background: #64748b; color: white; border: none; border-radius: 8px; cursor: pointer; margin-left: 10px;">
                            Fermer
                        </button>
                    </div>
                </body>
                </html>
            `;

            // Ouvrir dans une nouvelle fen��tre pour impression
            const printWindow = window.open('', '_blank', 'width=400,height=600');
            printWindow.document.write(receiptHtml);
            printWindow.document.close();
        },

        openChat(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;
            CORE.db.messages = CORE.db.messages || [];
            const currentUser = CORE.state.currentUser;
            
            const renderMessages = () => {
                const msgs = CORE.db.messages.filter(m => m.deliveryId === deliveryId).sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
                if (msgs.length === 0) return '<div class="text-center text-slate-400 text-sm py-10">Aucun message.</div>';
                return msgs.map(m => {
                    const isMe = m.senderId === currentUser.id;
                    return `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[80%]">
                                <div class="px-4 py-2 rounded-2xl text-sm ${isMe ? 'bg-emerald-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-800 rounded-tl-none'}">${m.text}</div>
                                <div class="text-[10px] text-slate-400 mt-1 ${isMe ? 'text-right' : 'text-left'}">${isMe ? 'Moi' : m.senderName} �� ?� � ${CORE.formatTime(m.createdAt)}</div>
                            </div>
                        </div>`;
                }).join('');
            };

            UI.modal(`Chat: ${d.orderRef}`, `
                <div class="flex flex-col h-[50vh]">
                    <div class="p-3 bg-slate-50 border-b border-slate-200 text-xs text-slate-500 flex justify-between">
                        <span>Client: <b>${d.clientName}</b></span>
                        <span>${d.clientPhone}</span>
                    </div>
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3">${renderMessages()}</div>
                    <div class="mt-4 flex gap-2">
                        <input id="chat-input" class="flex-1 px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500 bg-slate-50 focus:bg-white transition" placeholder="Message..." onkeypress="if(event.key==='Enter') LivreurModule.sendChat(${deliveryId})">
                        <button onclick="LivreurModule.sendChat(${deliveryId})" class="px-4 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition"><i data-lucide="send" class="w-5 h-5"></i></button>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
            setTimeout(() => { const el = document.getElementById('chat-messages'); if(el) el.scrollTop = el.scrollHeight; }, 50);
        },

        sendChat(deliveryId) {
            const input = document.getElementById('chat-input');
            const text = input ? input.value.trim() : '';
            if (!text) return;
            CORE.db.messages = CORE.db.messages || [];
            CORE.db.messages.push({ id: Date.now(), deliveryId, senderId: CORE.state.currentUser.id, senderName: CORE.state.currentUser.name, role: CORE.state.currentUser.role, text, createdAt: new Date().toISOString() });
            CORE.save();
            
            // ��Ÿ�Š Jouer le son de notification pour le message
            UI.playGenericNotificationSound('info');
            
            this.openChat(deliveryId); // Refresh
        },

        renderDeliveries() {
            const all = this.getMyDeliveries();
            const pending = this.getPendingDeliveries();
            const myWaiting = all.filter(d => d.status === 'en_attente');
            const myInProgress = all.filter(d => d.status === 'en_cours');
            const myCompleted = all.filter(d => d.status === 'livree');
            
            return `
                <div class="space-y-4 fade-in">
                    <div class="flex items-end justify-between">
                        <div>
                            <h2 class="text-xl font-black text-slate-900">Mes courses</h2>
                            <p class="text-sm text-slate-500 font-medium">Toutes vos livraisons</p>
                        </div>
                        <button onclick="LivreurModule.toggleService()" class="px-4 py-2 rounded-full text-xs font-black transition ${this.state.isOnService ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-200 text-slate-600'}">
                            ${this.state.isOnService ? '��? � EN SERVICE' : '��?� HORS SERVICE'}
                        </button>
                    </div>

                    ${pending.length > 0 ? `
                    <!-- Courses disponibles �� prendre -->
                    <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-3xl border-2 border-amber-300 overflow-hidden">
                        <div class="p-4 border-b border-amber-200 flex items-center justify-between bg-amber-100/50">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">��Ÿ? �</span>
                                <span class="font-black text-amber-900">Courses disponibles</span>
                                <span class="px-2 py-0.5 bg-amber-500 text-white text-xs font-black rounded-full">${pending.length}</span>
                            </div>
                        </div>
                        <div class="p-4 space-y-3">
                            ${pending.map(d => this.renderPendingDeliveryCard(d)).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${myWaiting.length > 0 ? `
                    <!-- Mes courses en attente (assign�es mais pas d�marr�es) -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">�� � �</span>
                                <span class="font-black text-slate-800">En attente</span>
                                <span class="px-2 py-0.5 bg-slate-500 text-white text-xs font-black rounded-full">${myWaiting.length}</span>
                            </div>
                        </div>
                        <div class="p-4">
                            ${myWaiting.map(d => this.renderDeliveryCard(d)).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${myInProgress.length > 0 ? `
                    <!-- Mes courses en cours -->
                    <div class="bg-white rounded-3xl border-2 border-amber-400 overflow-hidden">
                        <div class="p-4 border-b border-amber-200 flex items-center justify-between bg-amber-50">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">��Ÿšš</span>
                                <span class="font-black text-amber-900">En cours</span>
                                <span class="px-2 py-0.5 bg-amber-500 text-white text-xs font-black rounded-full">${myInProgress.length}</span>
                            </div>
                        </div>
                        <div class="p-4">
                            ${myInProgress.map(d => this.renderDeliveryCard(d)).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${myCompleted.length > 0 ? `
                    <!-- Mes courses livr�es -->
                    <div class="bg-white rounded-3xl border border-emerald-200 overflow-hidden">
                        <div class="p-4 border-b border-emerald-100 flex items-center justify-between bg-emerald-50">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">���??</span>
                                <span class="font-black text-emerald-800">Livr�es</span>
                                <span class="px-2 py-0.5 bg-emerald-500 text-white text-xs font-black rounded-full">${myCompleted.length}</span>
                            </div>
                            <button onclick="LivreurModule.navigateTo('historique')" class="text-xs font-bold text-emerald-600">Voir tout</button>
                        </div>
                        <div class="p-4">
                            ${myCompleted.slice(0, 3).map(d => this.renderDeliveryCard(d)).join('')}
                            ${myCompleted.length > 3 ? `<div class="text-center text-xs text-slate-500 mt-2">+${myCompleted.length - 3} autre(s)</div>` : ''}
                        </div>
                    </div>
                    ` : ''}

                    ${all.length === 0 && pending.length === 0 ? `
                    <div class="bg-white rounded-3xl border border-slate-200 p-8 text-center">
                        <div class="text-4xl mb-3">��Ÿ? �</div>
                        <div class="font-black text-slate-700">Aucune course</div>
                        <div class="text-sm text-slate-500 mt-1">Les nouvelles courses appara��tront ici</div>
                    </div>
                    ` : ''}
                </div>`;
        },

        renderMap() {
            const active = this.getMyDeliveries().find(d => d.status === 'en_cours') || this.getMyDeliveries()[0] || null;
            const destination = (active?.address || `${CORE.getCity(CORE.state.currentUser?.city || 1)?.name || 'Brazzaville'}, Congo`).trim();
            const label = active ? `${active.orderRef} �� ?� � ${active.clientName}` : 'Destination';
            const payload = Maps.encode({ destination, label });
            const hasKey = (CORE.config.googleMapsApiKey || '').trim().length > 0;

            return `
                <div class="relative h-[calc(100vh-160px)] rounded-3xl overflow-hidden border border-slate-200 bg-white fade-in">
                    ${hasKey ? `
                        <div class="absolute inset-0" data-gmap="${payload}">
                            <div class="w-full h-full" data-gmap-canvas></div>
                        </div>
                    ` : `
                        <iframe class="absolute inset-0 w-full h-full" loading="lazy" referrerpolicy="no-referrer-when-downgrade" src="${Maps.embedUrl(destination)}"></iframe>
                    `}

                    <div class="absolute bottom-4 left-4 right-4 bg-white/95 p-4 rounded-2xl shadow-2xl flex items-center gap-4 slide-up">
                        <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center"><i data-lucide="map" class="w-6 h-6 text-slate-700"></i></div>
                        <div class="flex-1 min-w-0">
                            <div class="font-black text-slate-900 truncate">${active ? active.clientName : 'Carte'}</div>
                            <div class="text-xs text-slate-500 truncate">${destination}</div>
                        </div>
                        <button onclick="Maps.openDirectionsB64(\'${payload}\')" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700 transition">Itin�raire</button>
                    </div>
                </div>`;
        },

        renderWallet() {
            const uid = CORE.state.currentUser?.id;
            const all = this.getMyDeliveries().filter(d => d.status === 'livree');
            const balance = all.reduce((a,d)=>a+(d.commission||Math.round(d.amount*0.05)||0),0);
            
            // D�p��ts enregistr�s par le vendeur pour ce livreur
            const deposits = (CORE.db.deposits || []).filter(d => d.livreurId === uid);
            const totalDeposits = deposits.reduce((sum, d) => sum + d.amount, 0);
            
            return `
                <div class="space-y-4 fade-in">
                    <!-- Solde et d�p��ts -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Commissions</div>
                            <div class="text-2xl font-black text-emerald-600 mt-2">${CORE.formatPrice(balance)}</div>
                            <div class="mt-2 text-[10px] text-slate-500">Estim� 5% des livraisons</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">D�p��ts</div>
                            <div class="text-2xl font-black text-blue-600 mt-2">${CORE.formatPrice(totalDeposits)}</div>
                            <div class="mt-2 text-[10px] text-slate-500">${deposits.length} d�p��t(s)</div>
                        </div>
                    </div>

                    ${deposits.length > 0 ? `
                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                            <div class="p-5 border-b border-slate-100 font-black">D�p��ts enregistr�s</div>
                            <div class="p-4 space-y-2">
                                ${deposits.slice(0,10).map(d => `
                                    <div class="flex items-center justify-between p-4 rounded-2xl border border-slate-100 hover:bg-slate-50">
                                        <div>
                                            <div class="font-black text-slate-900">D�p��t du ${CORE.formatDate(d.timestamp)}</div>
                                            <div class="text-xs text-slate-500 mt-1">Par: ${d.vendeurName}</div>
                                            ${d.ordersCount > 0 ? `<div class="text-xs text-blue-600 mt-1">��Ÿ? � ${d.ordersCount} commande(s)</div>` : ''}
                                            ${d.notes ? `<div class="text-xs text-slate-500 mt-1">��Ÿ? � ${d.notes}</div>` : ''}
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-blue-600 text-lg">${CORE.formatPrice(d.amount)}</div>
                                            <div class="text-[10px] text-slate-400">
                                                ${d.status === 'enregistre' ? 'Enregistr�' : d.status === 'approuve' ? 'Approuv�' : d.status}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 font-black">Commissions des livraisons</div>
                        <div class="p-4 space-y-2">
                            ${all.length === 0 ? `<div class="p-8 text-center text-slate-400 font-medium">Aucune commission</div>` : ''}
                            ${all.slice(0,10).map(d => `
                                <div class="flex items-center justify-between p-4 rounded-2xl border border-slate-100 hover:bg-slate-50">
                                    <div>
                                        <div class="font-black text-slate-900">${d.orderRef}</div>
                                        <div class="text-xs text-slate-500">${CORE.formatDate(d.createdAt)}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-black text-emerald-600">+ ${CORE.formatPrice(d.commission||Math.round(d.amount*0.05)||0)}</div>
                                        <div class="text-[10px] text-slate-400">commission</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
        },

        renderHistory() {
            const filtered = this.getFilteredDeliveries();
            const stats = this.getHistoryStats();
            const f = this.state.historyFilters;
            
            return `
                <div class="space-y-4 fade-in">
                    <div>
                        <h2 class="text-xl font-black text-slate-900">Historique des livraisons</h2>
                        <p class="text-sm text-slate-500 font-medium">Consultez tous vos bons de livraison.</p>
                    </div>

                    <!-- Statistiques filtr�es -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="bg-white rounded-2xl border border-slate-200 p-4">
                            <div class="text-xs font-black text-slate-500 uppercase">Total</div>
                            <div class="text-2xl font-black text-slate-900 mt-1">${stats.total}</div>
                        </div>
                        <div class="bg-white rounded-2xl border border-slate-200 p-4">
                            <div class="text-xs font-black text-slate-500 uppercase">Livr�es</div>
                            <div class="text-2xl font-black text-emerald-600 mt-1">${stats.livrees}</div>
                        </div>
                        <div class="bg-white rounded-2xl border border-slate-200 p-4">
                            <div class="text-xs font-black text-slate-500 uppercase">Probl��mes</div>
                            <div class="text-2xl font-black text-red-600 mt-1">${stats.problemes}</div>
                        </div>
                        <div class="bg-white rounded-2xl border border-slate-200 p-4">
                            <div class="text-xs font-black text-slate-500 uppercase">Taux</div>
                            <div class="text-2xl font-black text-blue-600 mt-1">${stats.tauxReussite}%</div>
                        </div>
                    </div>

                    <!-- Chiffre et gains -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl border border-blue-200 p-4">
                            <div class="text-xs font-black text-blue-700 uppercase">Chiffre</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${CORE.formatPrice(stats.chiffre)}</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-2xl border border-amber-200 p-4">
                            <div class="text-xs font-black text-amber-700 uppercase">Commissions</div>
                            <div class="text-2xl font-black text-amber-900 mt-1">${CORE.formatPrice(stats.gains)}</div>
                        </div>
                    </div>

                    <!-- Filtres -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 font-black text-slate-700">Filtres</div>
                        <div class="p-5 space-y-4">
                            <!-- Recherche globale -->
                            <div>
                                <label class="text-xs font-black text-slate-700 uppercase">Recherche</label>
                                <input id="livreur-search-input" type="text" placeholder="Bon, client, adresse, t�l�phone..." 
                                    value="${f.searchQuery}" 
                                    onkeyup="LivreurModule.updateLivreurSearch(this.value)"
                                    style="direction: ltr; text-align: left;" autocomplete="off"
                                    class="w-full mt-2 px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-red-500 bg-slate-50 focus:bg-white transition">
                            </div>

                            <!-- Ligne 1: Statut et Client -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs font-black text-slate-700 uppercase">Statut</label>
                                    <select onchange="LivreurModule.updateFilter('status', this.value)" class="w-full mt-2 px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-red-500 bg-slate-50 focus:bg-white transition">
                                        <option value="">Tous</option>
                                        <option value="livree" ${f.status === 'livree' ? 'selected' : ''}>Livr�es</option>
                                        <option value="en_cours" ${f.status === 'en_cours' ? 'selected' : ''}>En cours</option>
                                        <option value="en_attente" ${f.status === 'en_attente' ? 'selected' : ''}>En attente</option>
                                        <option value="probleme" ${f.status === 'probleme' ? 'selected' : ''}>Probl��me</option>
                                        <option value="reservation" ${f.status === 'reservation' ? 'selected' : ''}>R�servation</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-black text-slate-700 uppercase">Client</label>
                                    <input id="livreur-client-search-input" type="text" placeholder="Nom du client..." 
                                        value="${f.clientName}" 
                                        onkeyup="LivreurModule.updateLivreurClientSearch(this.value)"
                                        style="direction: ltr; text-align: left;" autocomplete="off"
                                        class="w-full mt-2 px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-red-500 bg-slate-50 focus:bg-white transition">
                                </div>
                            </div>

                            <!-- Ligne 2: Dates -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs font-black text-slate-700 uppercase">Date depuis</label>
                                    <input type="date" 
                                        value="${f.dateFrom}" 
                                        onchange="LivreurModule.updateFilter('dateFrom', this.value)"
                                        class="w-full mt-2 px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-red-500 bg-slate-50 focus:bg-white transition">
                                </div>
                                <div>
                                    <label class="text-xs font-black text-slate-700 uppercase">Date jusqu'��</label>
                                    <input type="date" 
                                        value="${f.dateTo}" 
                                        onchange="LivreurModule.updateFilter('dateTo', this.value)"
                                        class="w-full mt-2 px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-red-500 bg-slate-50 focus:bg-white transition">
                                </div>
                            </div>

                            <!-- Bouton r�initialiser -->
                            <button onclick="LivreurModule.state.historyFilters = { status: '', dateFrom: '', dateTo: '', clientName: '', searchQuery: '' }; App.rerender();" class="w-full py-2 px-4 rounded-xl bg-slate-100 text-slate-700 font-black hover:bg-slate-200 transition">
                                R�initialiser les filtres
                            </button>
                        </div>
                    </div>

                    <!-- R�sultats -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <div class="font-black text-slate-700">${filtered.length} r�sultat(s)</div>
                        </div>
                        <div class="p-4">
                            ${filtered.length === 0 ? `
                                <div class="p-12 text-center">
                                    <div class="text-slate-400 text-sm font-medium mb-2">Aucun r�sultat</div>
                                    <div class="text-xs text-slate-400">Essayez de modifier vos filtres</div>
                                </div>
                            ` : ''}
                            ${filtered.map(d => this.renderDeliveryCard(d)).join('')}
                        </div>
                    </div>
                </div>`;
        },

        renderProfile() {
            const u = CORE.state.currentUser;
            return `
                <div class="space-y-4 fade-in">
                    <div class="bg-white rounded-3xl border border-slate-200 p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 gradient-livreur rounded-2xl flex items-center justify-center text-white font-black text-xl">${u.avatar}</div>
                            <div>
                                <div class="text-xl font-black text-slate-900">${u.name}</div>
                                <div class="text-xs text-slate-500 font-bold uppercase tracking-wider">Livreur</div>
                            </div>
                        </div>
                        <div class="mt-6 grid grid-cols-2 gap-3">
                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                                <div class="text-xs text-slate-500 font-black uppercase">V�hicule</div>
                                <div class="font-black text-slate-900">${u.vehicle || '�� ?��'}</div>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                                <div class="text-xs text-slate-500 font-black uppercase">Note</div>
                                <div class="font-black text-slate-900">${u.rating || '�� ?��'}</div>
                            </div>
                        </div>
                        <button onclick="App.logout()" class="mt-5 w-full py-3 rounded-2xl bg-slate-900 text-white font-black hover:bg-slate-800 transition">D�connexion</button>
                    </div>
                </div>`;
        },

        renderSettings() {
            const u = CORE.state.currentUser;
            return `
                <div class="space-y-4 fade-in max-w-2xl">
                    <div>
                        <h2 class="text-xl font-black text-slate-900">Param��tres</h2>
                        <p class="text-sm text-slate-500 font-medium">G�rez vos param��tres et pr�f�rences.</p>
                    </div>

                    <!-- Profil -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 font-black text-slate-700 flex items-center gap-2">
                            <i data-lucide="user" class="w-5 h-5"></i>
                            <span>Profil</span>
                        </div>
                        <div class="p-5 space-y-4">
                            <div>
                                <label class="text-xs font-black text-slate-700 uppercase mb-2 block">Nom complet</label>
                                <input type="text" value="${u.name}" readonly class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 text-slate-700 font-bold">
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-700 uppercase mb-2 block">T�l�phone</label>
                                <input type="text" value="${u.phone || 'Non d�fini'}" readonly class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 text-slate-700 font-bold">
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-700 uppercase mb-2 block">V�hicule</label>
                                <input type="text" value="${u.vehicle || 'Non d�fini'}" readonly class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 text-slate-700 font-bold">
                            </div>
                        </div>
                    </div>

                    <!-- S�curit� -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 font-black text-slate-700 flex items-center gap-2">
                            <i data-lucide="lock" class="w-5 h-5"></i>
                            <span>S�curit�</span>
                        </div>
                        <div class="p-5 space-y-3">
                            <div>
                                <label class="text-xs font-black text-slate-700 uppercase mb-2 block">Identifiant</label>
                                <input type="text" value="${u.username || 'N/A'}" readonly class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 text-slate-700 font-bold cursor-not-allowed">
                                <div class="text-xs text-slate-500 mt-1">L'identifiant ne peut pas ��tre modifi�</div>
                            </div>
                            <button onclick="LivreurModule.showChangePersonalPasswordModal()" class="w-full p-4 rounded-2xl bg-red-50 border border-red-200 hover:bg-red-100 transition flex items-center gap-3">
                                <i data-lucide="key" class="w-5 h-5 text-red-600"></i>
                                <div class="text-left flex-1">
                                    <div class="text-sm font-black text-red-700">Changer votre mot de passe</div>
                                    <div class="text-xs text-red-600">Modifiez votre mot de passe de connexion</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-red-400"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Notifications & Son -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 font-black text-slate-700 flex items-center gap-2">
                            <i data-lucide="bell" class="w-5 h-5"></i>
                            <span>Notifications</span>
                        </div>
                        <div class="p-5 space-y-4">
                            <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center border border-slate-200">
                                        <i data-lucide="bell" class="w-5 h-5 text-slate-600"></i>
                                    </div>
                                    <div>
                                        <div class="font-black text-slate-900 text-sm">Notifications</div>
                                        <div class="text-xs text-slate-500">${this.state.preferences.notificationsEnabled ? 'Activ�es' : 'D�sactiv�es'}</div>
                                    </div>
                                </div>
                                <button onclick="LivreurModule.state.preferences.notificationsEnabled = !LivreurModule.state.preferences.notificationsEnabled; LivreurModule.savePreferences(); App.rerender()" class="text-xs font-black ${this.state.preferences.notificationsEnabled ? 'text-emerald-600' : 'text-slate-400'} hover:opacity-75">
                                    ${this.state.preferences.notificationsEnabled ? 'D�sactiver' : 'Activer'}
                                </button>
                            </div>

                            <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center border border-slate-200">
                                        <i data-lucide="volume-2" class="w-5 h-5 text-slate-600"></i>
                                    </div>
                                    <div>
                                        <div class="font-black text-slate-900 text-sm">Sons des Notifications</div>
                                        <div class="text-xs text-slate-500">${this.state.preferences.soundEnabled ? 'Activ�s' : 'D�sactiv�s'}</div>
                                    </div>
                                </div>
                                <button onclick="LivreurModule.state.preferences.soundEnabled = !LivreurModule.state.preferences.soundEnabled; LivreurModule.savePreferences(); App.rerender()" class="text-xs font-black ${this.state.preferences.soundEnabled ? 'text-emerald-600' : 'text-slate-400'} hover:opacity-75">
                                    ${this.state.preferences.soundEnabled ? 'D�sactiver' : 'Activer'}
                                </button>
                            </div>

                            ${this.state.preferences.soundEnabled ? `
                            <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
                                <div class="text-xs font-black text-slate-700 mb-3">Volume: <span class="text-emerald-600">${Math.round(this.state.preferences.soundVolume * 100)}%</span></div>
                                <input type="range" min="0" max="1" step="0.1" value="${this.state.preferences.soundVolume}" 
                                    onchange="LivreurModule.state.preferences.soundVolume = parseFloat(this.value); LivreurModule.savePreferences(); UI.playGenericNotificationSound('info'); App.rerender()"
                                    class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-600">
                                <div class="flex justify-between text-[10px] text-slate-500 mt-2">
                                    <span>Muet</span>
                                    <span>Maximum</span>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Th��me -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 font-black text-slate-700 flex items-center gap-2">
                            <i data-lucide="palette" class="w-5 h-5"></i>
                            <span>Apparence</span>
                        </div>
                        <div class="p-5 space-y-4">
                            <div>
                                <label class="text-xs font-black text-slate-700 uppercase mb-3 block">Th��me</label>
                                <div class="grid grid-cols-3 gap-3">
                                    <button onclick="LivreurModule.setTheme('light')" class="p-4 rounded-2xl border-2 transition flex flex-col items-center justify-center gap-2 ${this.state.theme === 'light' ? 'border-emerald-500 bg-emerald-50' : 'border-slate-200 hover:border-slate-300'}">
                                        <i data-lucide="sun" class="w-6 h-6 ${this.state.theme === 'light' ? 'text-emerald-600' : 'text-slate-400'}"></i>
                                        <span class="text-xs font-black ${this.state.theme === 'light' ? 'text-emerald-700' : 'text-slate-600'}">Clair</span>
                                    </button>
                                    <button onclick="LivreurModule.setTheme('dark')" class="p-4 rounded-2xl border-2 transition flex flex-col items-center justify-center gap-2 ${this.state.theme === 'dark' ? 'border-emerald-500 bg-emerald-50' : 'border-slate-200 hover:border-slate-300'}">
                                        <i data-lucide="moon" class="w-6 h-6 ${this.state.theme === 'dark' ? 'text-emerald-600' : 'text-slate-400'}"></i>
                                        <span class="text-xs font-black ${this.state.theme === 'dark' ? 'text-emerald-700' : 'text-slate-600'}">Sombre</span>
                                    </button>
                                    <button onclick="LivreurModule.setTheme('auto')" class="p-4 rounded-2xl border-2 transition flex flex-col items-center justify-center gap-2 ${this.state.theme === 'auto' ? 'border-emerald-500 bg-emerald-50' : 'border-slate-200 hover:border-slate-300'}">
                                        <i data-lucide="monitor" class="w-6 h-6 ${this.state.theme === 'auto' ? 'text-emerald-600' : 'text-slate-400'}"></i>
                                        <span class="text-xs font-black ${this.state.theme === 'auto' ? 'text-emerald-700' : 'text-slate-600'}">Auto</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- �?� propos & Support -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 font-black text-slate-700 flex items-center gap-2">
                            <i data-lucide="help-circle" class="w-5 h-5"></i>
                            <span>Support & �?� propos</span>
                        </div>
                        <div class="p-5 space-y-3">
                            <button onclick="LivreurModule.showFAQModal()" class="w-full text-left p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 transition flex items-center justify-between">
                                <div>
                                    <div class="font-black text-slate-900 text-sm">FAQ</div>
                                    <div class="text-xs text-slate-500">Questions fr�quemment pos�es</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i>
                            </button>
                            <button onclick="LivreurModule.showSupportModal()" class="w-full text-left p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 transition flex items-center justify-between">
                                <div>
                                    <div class="font-black text-slate-900 text-sm">Contacter le support</div>
                                    <div class="text-xs text-slate-500">T�l�phone, Email, WhatsApp</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i>
                            </button>
                            <button onclick="LivreurModule.showVersionModal()" class="w-full text-left p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 transition flex items-center justify-between">
                                <div>
                                    <div class="font-black text-slate-900 text-sm">�?� propos</div>
                                    <div class="text-xs text-slate-500">Version ${CORE.config.version}</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Danger Zone -->
                    <div class="bg-red-50 rounded-3xl border border-red-200 overflow-hidden">
                        <div class="p-5 border-b border-red-200 font-black text-red-700 flex items-center gap-2">
                            <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                            <span>Zone de danger</span>
                        </div>
                        <div class="p-5">
                            <button onclick="App.logout()" class="w-full py-3 rounded-2xl bg-red-600 text-white font-black hover:bg-red-700 transition flex items-center justify-center gap-2">
                                <i data-lucide="log-out" class="w-5 h-5"></i>
                                <span>D�connexion</span>
                            </button>
                        </div>
                    </div>
                </div>`;
        },

        renderProfile() {
        },

        showChangePersonalPasswordModal() {
            UI.modal('��Ÿ�? Changer votre mot de passe', `
                <div class="space-y-4">
                    <div class="p-4 bg-red-50 border border-red-200 rounded-2xl flex items-center gap-3">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-red-600 flex-shrink-0"></i>
                        <div class="text-sm text-red-800 font-medium">Utilisez un mot de passe fort (min 6 caract��res)</div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Ancien mot de passe</label>
                        <input type="password" id="old_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-red-500 outline-none" placeholder="Entrez votre ancien mot de passe">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Nouveau mot de passe</label>
                        <input type="password" id="new_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-red-500 outline-none" placeholder="Entrez un nouveau mot de passe">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Confirmation du nouveau mot de passe</label>
                        <input type="password" id="confirm_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-red-500 outline-none" placeholder="Confirmez le nouveau mot de passe">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Changer le mot de passe', onclick: 'LivreurModule.savePersonalPasswordChange()', class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700' }
            ]);
        },

        async savePersonalPasswordChange() {
            const oldPwd = UI.val('old_pwd');
            const newPwd = UI.val('new_pwd');
            const confirmPwd = UI.val('confirm_pwd');
            const user = CORE.state.currentUser;
            
            if (!oldPwd || !newPwd || !confirmPwd) {
                UI.toast('Tous les champs sont obligatoires', 'error');
                return;
            }
            
            if (newPwd.length < 6) {
                UI.toast('Le nouveau mot de passe doit contenir au moins 6 caract��res', 'error');
                return;
            }
            
            if (newPwd !== confirmPwd) {
                UI.toast('Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            const oldPwdHash = await Utils.md5(oldPwd);
            if (oldPwdHash !== user.passwordHash) {
                UI.toast('Ancien mot de passe incorrect', 'error');
                return;
            }
            
            const newPwdHash = await Utils.md5(newPwd);
            user.passwordHash = newPwdHash;
            
            const userIndex = CORE.db.users.findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
                CORE.db.users[userIndex] = user;
                CORE.save();
                UI.closeModal();
                UI.toast('���?? Mot de passe chang� avec succ��s', 'success');
                App.rerender();
            } else {
                UI.toast('Erreur lors de la mise �� jour de l\'utilisateur', 'error');
            }
        },

        render() {
            const u = CORE.state.currentUser;
            const view = this.state.currentView;
            this.loadThemePreference(); // Charger le th��me pr�f�r�
            const content = view === 'dashboard' ? this.renderDashboard() :
                            view === 'livraisons' ? this.renderDeliveries() :
                            view === 'historique' ? this.renderHistory() :
                            view === 'map' ? this.renderMap() :
                            view === 'wallet' ? this.renderWallet() :
                            view === 'settings' ? this.renderSettings() :
                            view === 'profile' ? this.renderProfile() :
                            this.renderDashboard();

            return `
                <div class="flex flex-col h-screen bg-slate-100">
                    <header class="bg-white border-b border-slate-200 px-5 py-4 flex justify-between items-center sticky top-0 z-30 shadow-sm pt-safe">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 gradient-livreur rounded-2xl flex items-center justify-center text-white font-black">${u.avatar}</div>
                            <div>
                                <h1 class="font-black text-slate-800 text-sm">${CORE.getCompanyName()} LIVREUR</h1>
                                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">${u.name}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="LivreurModule.navigateTo('settings')" class="p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition" title="Param��tres">
                                <i data-lucide="settings" class="w-5 h-5"></i>
                            </button>
                            <button onclick="LivreurModule.toggleService()" class="px-3 py-1.5 rounded-full text-xs font-black transition ${this.state.isOnService ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-200 text-slate-500'}">
                                ${this.state.isOnService ? '��? � EN SERVICE' : '��?� HORS SERVICE'}
                            </button>
                        </div>
                    </header>

                    <main class="flex-1 overflow-auto p-4 pb-safe">${content}</main>

                    <nav class="bg-white border-t border-slate-200 px-2 py-2 flex items-center justify-around pb-safe no-print">
                        ${this.renderNavItem('dashboard', 'home', 'Accueil')}
                        ${this.renderNavItem('livraisons', 'package', 'Courses')}
                        <button onclick="LivreurModule.navigateTo('map')" class="relative -top-6 w-16 h-16 rounded-full gradient-livreur flex items-center justify-center text-white shadow-xl shadow-red-300 transform transition active:scale-95">
                            <i data-lucide="map" class="w-8 h-8"></i>
                        </button>
                        ${this.renderNavItem('historique', 'history', 'Historique')}
                        ${this.renderNavItem('wallet', 'wallet', 'Solde')}
                    </nav>
                </div>`;
        }
    }

    ;

    // =========================================================
    // MODULE: PAIEMENTS MOBILES (MTN, Airtel, Orange)
    // =========================================================
    const PaymentModule = {
        // ===== G�N�RATION CODES QR =====
        generateQRCode(text) {
            // Utiliser une API externe (QR Code generator)
            // Format: https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=
            const encoded = encodeURIComponent(text);
            return `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encoded}`;
        },

        // ===== G�N�RATION PAYLOAD PAIEMENT =====
        generatePaymentPayload(order, provider) {
            const amount = order.total || 0;
            const reference = `ORD-${order.id}-${Date.now()}`;
            
            // Format selon le provider
            let payload = '';
            switch(provider) {
                case 'mtn':
                    // MTN Money Format
                    payload = `MTN|${order.clientPhone}|${amount}|${reference}|${order.clientName}`;
                    break;
                case 'airtel':
                    // Airtel Money Format
                    payload = `AIRTEL|${order.clientPhone}|${amount}|${reference}`;
                    break;
                case 'orange':
                    // Orange Money Format
                    payload = `ORANGE|${order.clientPhone}|${amount}|${reference}|${order.id}`;
                    break;
            }
            return payload;
        },

        // ===== CR�ATION PAIEMENT MOBILE =====
        initiatePayment(orderId, provider, clientPhone = null) {
            const order = CORE.db.orders.find(o => o.id === orderId);
            if (!order) return null;

            const phone = clientPhone || order.clientPhone;
            if (!phone) {
                console.error('Num�ro de t�l�phone requis pour le paiement');
                return null;
            }

            const payload = this.generatePaymentPayload({ ...order, clientPhone: phone }, provider);
            const qrCodeUrl = this.generateQRCode(payload);
            
            const payment = {
                id: Utils.uid('PAY'),
                orderId: orderId,
                clientId: order.clientId,
                clientName: order.clientName,
                clientPhone: phone,
                amount: order.total,
                currency: 'XAF',
                provider: provider,
                transactionId: null,
                status: 'pending',
                qrCode: payload,
                qrCodeUrl: qrCodeUrl,
                invoicePDF: null,
                invoiceEmail: null,
                createdAt: new Date().toISOString(),
                completedAt: null,
                errorMessage: null,
                metadata: {
                    orderId: order.id,
                    itemCount: (order.items || []).length,
                    deliveryAddress: order.deliveryAddress
                }
            };

            CORE.db.mobilePayments.push(payment);
            CORE.save();
            return payment;
        },

        // ===== G�N�RER FACTURE PDF =====
        generateInvoicePDF(paymentId) {
            const payment = CORE.db.mobilePayments.find(p => p.id === paymentId);
            if (!payment) return null;

            const order = CORE.db.orders.find(o => o.id === payment.orderId);
            if (!order) return null;

            const invoiceNumber = `INV-${payment.orderId}-${Date.now().toString().slice(-6)}`;
            
            // Simuler g�n�ration PDF (dans un vrai syst��me: utiliser pdfkit ou similaire)
            const pdfContent = `
                FACTURE DE COMMANDE
                ==================
                
                Num�ro: ${invoiceNumber}
                Date: ${new Date(payment.createdAt).toLocaleDateString('fr-FR')}
                
                CLIENT
                ------
                Nom: ${payment.clientName}
                T�l�phone: ${payment.clientPhone}
                
                COMMANDE #${order.id}
                -------------------
                Livraison ��: ${order.deliveryAddress}
                
                D�TAILS ARTICLES
                ----------------
                ${(order.items || []).map(item => `
                ${item.name} x${item.quantity} = ${CORE.formatPrice(item.price * item.quantity)}
                `).join('\n')}
                
                MONTANT
                -------
                Sous-total: ${CORE.formatPrice(order.subtotal || order.total)}
                Frais livraison: ${CORE.formatPrice(order.deliveryFee || 0)}
                Taxes: ${CORE.formatPrice(order.tax || 0)}
                ---
                TOTAL: ${CORE.formatPrice(order.total)}
                
                MODE DE PAIEMENT
                ----------------
                ${payment.provider.toUpperCase()}
                
                Statut: ${payment.status.toUpperCase()}
                Transaction ID: ${payment.transactionId || 'Pendante'}
                
                Merci de votre commande!
            `;

            // Convertir en base64 (simulation)
            const pdfBase64 = btoa(pdfContent);
            const pdfUrl = `data:application/pdf;base64,${pdfBase64}`;

            const invoice = {
                id: Utils.uid('INV'),
                paymentId: paymentId,
                orderId: payment.orderId,
                invoiceNumber: invoiceNumber,
                clientName: payment.clientName,
                clientEmail: order.clientEmail,
                clientPhone: payment.clientPhone,
                items: order.items || [],
                subtotal: order.subtotal || order.total,
                tax: order.tax || 0,
                total: order.total,
                pdfUrl: pdfUrl,
                sentAt: null,
                downloadedAt: null,
                createdAt: new Date().toISOString()
            };

            CORE.db.paymentInvoices.push(invoice);
            CORE.save();
            return invoice;
        },

        // ===== ENVOYER FACTURE PAR EMAIL =====
        sendInvoiceByEmail(invoiceId, recipientEmail = null) {
            const invoice = CORE.db.paymentInvoices.find(i => i.id === invoiceId);
            if (!invoice) return false;

            const email = recipientEmail || invoice.clientEmail;
            if (!email) {
                console.error('Email requis pour envoyer la facture');
                return false;
            }

            // Simulation d'envoi email
            console.log(`��Ÿ? � EMAIL FACTURE ENVOY�: ${invoice.invoiceNumber} ���? ${email}`);
            console.log(`Fichier: invoice-${invoice.invoiceNumber}.pdf`);

            // Dans un vrai syst��me:
            // ApiService.sendEmail(email, {
            //     subject: `Facture de commande #${invoice.orderId}`,
            //     body: `Veuillez trouver ci-joint votre facture...`,
            //     attachment: invoice.pdfUrl
            // })

            invoice.sentAt = new Date().toISOString();
            CORE.save();
            return true;
        },

        // ===== CONFIRMER PAIEMENT =====
        confirmPayment(paymentId, transactionId = null) {
            const payment = CORE.db.mobilePayments.find(p => p.id === paymentId);
            if (!payment) return false;

            payment.status = 'success';
            payment.transactionId = transactionId || `TXN-${Date.now()}`;
            payment.completedAt = new Date().toISOString();

            // Mettre �� jour la commande
            const order = CORE.db.orders.find(o => o.id === payment.orderId);
            if (order) {
                order.status = 'paid';
                order.paymentMethod = payment.provider;
                order.paymentDate = new Date().toISOString();
                order.transactionId = payment.transactionId;
            }

            // G�n�rer facture
            const invoice = this.generateInvoicePDF(paymentId);
            if (invoice && order?.clientEmail) {
                this.sendInvoiceByEmail(invoice.id, order.clientEmail);
            }

            // Mettre �� jour historique paiements
            this.updatePaymentHistory(payment.clientId, payment.provider, payment.amount);

            CORE.save();
            return true;
        },

        // ===== ANNULER PAIEMENT =====
        cancelPayment(paymentId, errorMessage = null) {
            const payment = CORE.db.mobilePayments.find(p => p.id === paymentId);
            if (!payment) return false;

            payment.status = 'failed';
            payment.errorMessage = errorMessage || 'Paiement annul� par l\'utilisateur';

            CORE.save();
            return true;
        },

        // ===== METTRE �?� JOUR HISTORIQUE PAIEMENTS =====
        updatePaymentHistory(clientId, provider, amount) {
            let history = CORE.db.paymentHistory.find(h => h.clientId === clientId);
            
            if (!history) {
                const client = (CORE.db.clients || []).find(c => c.id === clientId);
                history = {
                    id: Utils.uid('PAYHIST'),
                    clientId: clientId,
                    clientName: client?.name || 'Client',
                    totalPaid: 0,
                    paymentCount: 0,
                    methods: { mtn: 0, airtel: 0, orange: 0, cash: 0 },
                    lastPaymentDate: null,
                    lastPaymentMethod: null,
                    averageAmount: 0
                };
                CORE.db.paymentHistory.push(history);
            }

            history.totalPaid += amount;
            history.paymentCount += 1;
            history.methods[provider] = (history.methods[provider] || 0) + 1;
            history.lastPaymentDate = new Date().toISOString();
            history.lastPaymentMethod = provider;
            history.averageAmount = Math.round(history.totalPaid / history.paymentCount);

            return history;
        },

        // ===== R�CUP�RER PAIEMENTS PAR STATUT =====
        getPaymentsByStatus(status) {
            return CORE.db.mobilePayments.filter(p => p.status === status);
        },

        // ===== R�CUP�RER PAIEMENTS PAR CLIENT =====
        getClientPayments(clientId) {
            return CORE.db.mobilePayments.filter(p => p.clientId === clientId);
        },

        // ===== R�CUP�RER PAIEMENTS PAR PROVIDER =====
        getPaymentsByProvider(provider) {
            return CORE.db.mobilePayments.filter(p => p.provider === provider);
        },

        // ===== STATISTIQUES PAIEMENTS =====
        getPaymentStats() {
            const allPayments = CORE.db.mobilePayments;
            const successfulPayments = allPayments.filter(p => p.status === 'success');
            
            const stats = {
                totalPayments: allPayments.length,
                successfulPayments: successfulPayments.length,
                pendingPayments: allPayments.filter(p => p.status === 'pending').length,
                failedPayments: allPayments.filter(p => p.status === 'failed').length,
                successRate: allPayments.length > 0 ? Math.round((successfulPayments.length / allPayments.length) * 100) : 0,
                totalRevenue: successfulPayments.reduce((s, p) => s + (p.amount || 0), 0),
                byProvider: {
                    mtn: successfulPayments.filter(p => p.provider === 'mtn').reduce((s, p) => s + (p.amount || 0), 0),
                    airtel: successfulPayments.filter(p => p.provider === 'airtel').reduce((s, p) => s + (p.amount || 0), 0),
                    orange: successfulPayments.filter(p => p.provider === 'orange').reduce((s, p) => s + (p.amount || 0), 0)
                },
                averageAmount: successfulPayments.length > 0 ? Math.round(successfulPayments.reduce((s, p) => s + (p.amount || 0), 0) / successfulPayments.length) : 0
            };

            return stats;
        },

        // ===== MODAL INITIATION PAIEMENT =====
        showPaymentModal(orderId) {
            const order = CORE.db.orders.find(o => o.id === orderId);
            if (!order) return;

            const providers = CORE.db.mobileMoneProviders.filter(p => p.enabled);

            UI.modal('��Ÿ? � Paiement Mobile', `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <!-- R�sum� commande -->
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <div class="font-black text-slate-900 mb-2">Commande #${order.id}</div>
                        <div class="text-sm text-slate-600 mb-3">${order.clientName}</div>
                        <div class="text-2xl font-black text-emerald-600">${CORE.formatPrice(order.total)}</div>
                    </div>

                    <!-- S�lection provider -->
                    <div class="p-4 bg-blue-50 rounded-2xl border border-blue-200">
                        <div class="font-black text-blue-900 mb-3">Choisir un op�rateur</div>
                        <div class="space-y-2">
                            ${providers.map(provider => `
                                <button onclick="PaymentModule.initiatePaymentUI(${orderId}, '${provider.id}')" class="w-full p-4 rounded-lg border border-blue-200 bg-white hover:bg-blue-50 transition text-left">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">${provider.logo}</span>
                                        <div>
                                            <div class="font-black text-slate-900">${provider.name}</div>
                                            <div class="text-xs text-slate-600">${provider.description}</div>
                                        </div>
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Info importantes -->
                    <div class="p-4 bg-amber-50 rounded-2xl border border-amber-200">
                        <div class="font-black text-amber-900 mb-3">��š ��� � � Informations importantes</div>
                        <ul class="text-sm text-amber-800 space-y-2">
                            <li>���?? Vous allez recevoir un code QR �� scanner</li>
                            <li>���?? Ouvrez l'app du fournisseur s�lectionn�</li>
                            <li>���?? Scannez le code QR ou entrez les d�tails</li>
                            <li>���?? La facture sera envoy�e par email</li>
                        </ul>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        // ===== AFFICHER D�TAILS PAIEMENT AVEC QR CODE =====
        initiatePaymentUI(orderId, provider) {
            const payment = this.initiatePayment(orderId, provider);
            if (!payment) {
                UI.toast('Erreur lors de l\'initiation du paiement', 'error');
                return;
            }

            UI.modal(`��Ÿ? � Paiement ${payment.provider.toUpperCase()}`, `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <!-- Code QR -->
                    <div class="p-6 bg-white rounded-2xl border border-slate-200 text-center">
                        <div class="font-black text-slate-900 mb-4">Scannez ce code QR</div>
                        <img src="${payment.qrCodeUrl}" alt="QR Code" class="w-64 h-64 mx-auto rounded-lg border-4 border-slate-200">
                        <div class="mt-4 text-sm text-slate-600">
                            <div class="font-black">Montant: ${CORE.formatPrice(payment.amount)}</div>
                            <div class="text-xs text-slate-500 mt-1">T�l�phone: ${payment.clientPhone}</div>
                        </div>
                    </div>

                    <!-- Informations texte (fallback) -->
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <div class="font-black text-slate-900 mb-3">Paiement Manuel</div>
                        <div class="space-y-3 text-sm">
                            <div class="p-3 bg-white rounded border border-slate-200">
                                <div class="text-xs font-black text-slate-600">NUM�RO T�L�PHONE</div>
                                <div class="text-base font-black text-slate-900 mt-1">${payment.clientPhone}</div>
                            </div>
                            <div class="p-3 bg-white rounded border border-slate-200">
                                <div class="text-xs font-black text-slate-600">MONTANT</div>
                                <div class="text-base font-black text-slate-900 mt-1">${CORE.formatPrice(payment.amount)}</div>
                            </div>
                            <div class="p-3 bg-white rounded border border-slate-200">
                                <div class="text-xs font-black text-slate-600">R�F�RENCE</div>
                                <div class="text-base font-black text-slate-900 mt-1">ORD-${payment.orderId}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Statut paiement -->
                    <div class="p-4 bg-blue-50 rounded-2xl border border-blue-200">
                        <div class="font-black text-blue-900 mb-3">���?? Statut</div>
                        <div class="text-sm text-blue-800">
                            En attente de confirmation...
                            <div class="mt-2 text-xs text-blue-600">ID Paiement: ${payment.id}</div>
                        </div>
                    </div>
                </div>
            `, [
                { 
                    label: '���?? Paiement Re��u', 
                    onclick: `PaymentModule.confirmPayment('${payment.id}'); UI.toast('���?? Paiement confirm�!', 'success'); UI.closeModal(); App.rerender();`,
                    class: 'px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700'
                },
                { 
                    label: '���?? Annuler', 
                    onclick: `PaymentModule.cancelPayment('${payment.id}'); UI.toast('Paiement annul�', 'warning'); UI.closeModal();`,
                    class: 'px-4 py-2 bg-red-600 text-white font-black rounded-xl hover:bg-red-700'
                }
            ]);
        },

        // ===== AFFICHER HISTORIQUE PAIEMENTS =====
        showPaymentHistory(clientId = null) {
            let payments = CORE.db.mobilePayments;
            if (clientId) payments = payments.filter(p => p.clientId === clientId);

            const stats = this.getPaymentStats();

            UI.modal('��Ÿ? � Historique Paiements Mobiles', `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <!-- Statistiques -->
                    <div class="grid grid-cols-4 gap-4">
                        <div class="p-3 bg-emerald-50 rounded-lg border border-emerald-200">
                            <div class="text-xs font-black text-emerald-600">Totaux</div>
                            <div class="text-lg font-black text-emerald-700 mt-1">${stats.totalPayments}</div>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="text-xs font-black text-blue-600">R�ussis</div>
                            <div class="text-lg font-black text-blue-700 mt-1">${stats.successfulPayments}</div>
                        </div>
                        <div class="p-3 bg-amber-50 rounded-lg border border-amber-200">
                            <div class="text-xs font-black text-amber-600">En attente</div>
                            <div class="text-lg font-black text-amber-700 mt-1">${stats.pendingPayments}</div>
                        </div>
                        <div class="p-3 bg-red-50 rounded-lg border border-red-200">
                            <div class="text-xs font-black text-red-600">�chou�s</div>
                            <div class="text-lg font-black text-red-700 mt-1">${stats.failedPayments}</div>
                        </div>
                    </div>

                    <!-- Revenus par provider -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <div class="font-black text-yellow-900">��Ÿ? � MTN Money</div>
                            <div class="text-lg font-black text-yellow-700 mt-2">${CORE.formatPrice(stats.byProvider.mtn)}</div>
                        </div>
                        <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                            <div class="font-black text-red-900">��Ÿ? � Airtel Money</div>
                            <div class="text-lg font-black text-red-700 mt-2">${CORE.formatPrice(stats.byProvider.airtel)}</div>
                        </div>
                        <div class="p-4 bg-orange-50 rounded-lg border border-orange-200">
                            <div class="font-black text-orange-900">��Ÿ? � Orange Money</div>
                            <div class="text-lg font-black text-orange-700 mt-2">${CORE.formatPrice(stats.byProvider.orange)}</div>
                        </div>
                    </div>

                    <!-- Revenus totaux -->
                    <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-200">
                        <div class="text-xs font-black text-emerald-600">REVENU TOTAL PAIEMENTS MOBILES</div>
                        <div class="text-3xl font-black text-emerald-700 mt-2">${CORE.formatPrice(stats.totalRevenue)}</div>
                        <div class="text-xs text-emerald-600 mt-2">Taux de r�ussite: ${stats.successRate}% �� ?� � Montant moyen: ${CORE.formatPrice(stats.averageAmount)}</div>
                    </div>

                    <!-- Liste paiements -->
                    <div class="max-h-96 overflow-y-auto space-y-2">
                        ${payments.length > 0 ? payments.slice(-20).reverse().map(p => `
                            <div class="p-3 rounded-lg border border-slate-200 bg-slate-50 hover:bg-slate-100">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="font-black text-slate-900">${p.clientName}</div>
                                        <div class="text-xs text-slate-600">��Ÿ? � ${p.provider} �� ?� � ${CORE.formatPrice(p.amount)}</div>
                                    </div>
                                    <span class="px-2 py-1 rounded-full text-xs font-black ${
                                        p.status === 'success' ? 'bg-emerald-100 text-emerald-700' :
                                        p.status === 'pending' ? 'bg-amber-100 text-amber-700' :
                                        'bg-red-100 text-red-700'
                                    }">
                                        ${p.status}
                                    </span>
                                </div>
                                <div class="text-xs text-slate-500 mt-1">${new Date(p.createdAt).toLocaleString('fr-FR')}</div>
                            </div>
                        `).join('') : `<div class="text-center text-slate-400">Aucun paiement</div>`}
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        }
    };

    // =========================================================
    // MODULE: OPTIMISATION ROUTAGE LIVREURS
    // =========================================================
    const RoutageModule = {
        // ===== CALCUL DE DISTANCE (Formule Haversine) =====
        calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Rayon Terre en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        },

        // ===== CLUSTERING D'ADRESSES (K-MEANS SIMPLE) =====
        clusterAddresses(orders, numberOfClusters = 3) {
            if (orders.length === 0) return [];
            if (orders.length <= numberOfClusters) {
                return orders.map((o, i) => ({ ...o, clusterId: i }));
            }

            // Extraire coordonn�es
            const points = orders.map(o => ({
                id: o.id,
                lat: o.deliveryLat || -4.263,
                lng: o.deliveryLng || 15.243,
                order: o
            }));

            // Initialiser centroides al�atoires
            let centroids = [];
            for (let i = 0; i < numberOfClusters; i++) {
                const randomPoint = points[Math.floor(Math.random() * points.length)];
                centroids.push({ lat: randomPoint.lat, lng: randomPoint.lng });
            }

            // K-Means it�ration (3 passes)
            for (let iter = 0; iter < 3; iter++) {
                // Assigner chaque point au centro��de le plus proche
                const clusters = Array(numberOfClusters).fill(null).map(() => []);
                for (const point of points) {
                    let minDist = Infinity;
                    let closestCluster = 0;
                    for (let i = 0; i < centroids.length; i++) {
                        const dist = this.calculateDistance(point.lat, point.lng, centroids[i].lat, centroids[i].lng);
                        if (dist < minDist) {
                            minDist = dist;
                            closestCluster = i;
                        }
                    }
                    clusters[closestCluster].push(point);
                }

                // Recalculer centroides
                for (let i = 0; i < centroids.length; i++) {
                    if (clusters[i].length > 0) {
                        const avgLat = clusters[i].reduce((s, p) => s + p.lat, 0) / clusters[i].length;
                        const avgLng = clusters[i].reduce((s, p) => s + p.lng, 0) / clusters[i].length;
                        centroids[i] = { lat: avgLat, lng: avgLng };
                    }
                }
            }

            // Assigner final avec clusterId
            const result = [];
            for (const point of points) {
                let minDist = Infinity;
                let closestCluster = 0;
                for (let i = 0; i < centroids.length; i++) {
                    const dist = this.calculateDistance(point.lat, point.lng, centroids[i].lat, centroids[i].lng);
                    if (dist < minDist) {
                        minDist = dist;
                        closestCluster = i;
                    }
                }
                result.push({ ...point.order, clusterId: closestCluster, clusterCenter: centroids[closestCluster] });
            }

            return result;
        },

        // ===== OPTIMISATION TSP (NEAREST NEIGHBOR) =====
        optimizeRoute(orders, startPoint = null) {
            if (orders.length === 0) return { route: [], totalDistance: 0, totalTime: 0 };
            if (orders.length === 1) {
                return { 
                    route: orders,
                    totalDistance: 0,
                    totalTime: 15 // 15 min pour 1 livraison
                };
            }

            // Point de d�part (centre-ville par d�faut)
            const start = startPoint || { lat: -4.263359, lng: 15.242885, name: 'D�p��t' };
            
            // Nearest neighbor algorithm
            let current = start;
            let remaining = [...orders];
            let route = [];
            let totalDistance = 0;
            let sequence = 0;

            while (remaining.length > 0) {
                let nearest = null;
                let nearestDist = Infinity;
                let nearestIdx = -1;

                for (let i = 0; i < remaining.length; i++) {
                    const order = remaining[i];
                    const dist = this.calculateDistance(
                        current.lat, current.lng,
                        order.deliveryLat || -4.263, order.deliveryLng || 15.243
                    );
                    if (dist < nearestDist) {
                        nearestDist = dist;
                        nearest = order;
                        nearestIdx = i;
                    }
                }

                if (nearest) {
                    totalDistance += nearestDist;
                    route.push({ ...nearest, sequence: sequence++, distanceFromPrevious: nearestDist });
                    current = { lat: nearest.deliveryLat, lng: nearest.deliveryLng };
                    remaining.splice(nearestIdx, 1);
                }
            }

            // Estimer temps total (2 min par km + 5 min par arr��t)
            const timePerKm = 2;
            const timePerStop = 5;
            const totalTime = Math.ceil((totalDistance * timePerKm) + (route.length * timePerStop));

            return { route, totalDistance, totalTime };
        },

        // ===== CALCUL CO�?�TS DE ROUTE =====
        calculateRouteCost(route, livreur = null) {
            const costPerKm = 500; // 500 FCFA par km
            const baseDeliveryFee = 1000; // Frais fixes par livraison
            const totalDistance = route.totalDistance || 0;
            const deliveryCount = (route.route || []).length;

            const costByDistance = totalDistance * costPerKm;
            const costByDelivery = deliveryCount * baseDeliveryFee;
            const totalCost = costByDistance + costByDelivery;

            // Commission si livreur
            const commission = livreur && livreur.commissionPercent 
                ? (totalCost * livreur.commissionPercent / 100)
                : 0;

            return {
                costPerKm,
                costByDistance,
                costByDelivery,
                totalCost,
                deliveryCount,
                commission,
                netCost: totalCost - commission
            };
        },

        // ===== CR�ATION ROUTE OPTIMIS�E =====
        createOptimizedRoute(livreurId, orders, date = new Date().toISOString().split('T')[0]) {
            const livreur = CORE.db.users.find(u => u.id === livreurId);
            if (!livreur || livreur.role !== 'livreur') return null;

            // �tape 1: Clustering
            const clusteredOrders = this.clusterAddresses(orders, Math.ceil(orders.length / 8));
            
            // �tape 2: Grouper par cluster
            const clusters = {};
            for (const order of clusteredOrders) {
                if (!clusters[order.clusterId]) clusters[order.clusterId] = [];
                clusters[order.clusterId].push(order);
            }

            // �tape 3: Optimiser chaque cluster
            const optimizedClusters = [];
            for (const clusterId in clusters) {
                const optimized = this.optimizeRoute(clusters[clusterId]);
                optimizedClusters.push({
                    clusterId: parseInt(clusterId),
                    ...optimized
                });
            }

            // �tape 4: Trier clusters par distance au d�p��t
            optimizedClusters.sort((a, b) => {
                const centerA = a.route[0]?.clusterCenter || { lat: -4.263, lng: 15.243 };
                const centerB = b.route[0]?.clusterCenter || { lat: -4.263, lng: 15.243 };
                const distA = this.calculateDistance(-4.263359, 15.242885, centerA.lat, centerA.lng);
                const distB = this.calculateDistance(-4.263359, 15.242885, centerB.lat, centerB.lng);
                return distA - distB;
            });

            // �tape 5: Fusionner en une seule route
            const finalRoute = [];
            let totalDistance = 0, totalTime = 0;
            for (const cluster of optimizedClusters) {
                finalRoute.push(...cluster.route);
                totalDistance += cluster.totalDistance;
                totalTime += cluster.totalTime;
            }

            // �tape 6: Calculer co��ts
            const costData = this.calculateRouteCost({ route: finalRoute, totalDistance, totalTime });

            // �tape 7: Cr�er objet route
            const route = {
                id: Utils.uid('ROUTE'),
                livreurId,
                livreurName: livreur.name,
                date,
                startTime: '08:00',
                endTime: null,
                status: 'planned',
                stops: finalRoute.map((order, idx) => ({
                    id: Utils.uid('STOP'),
                    routeId: null, // Sera assign� apr��s
                    orderId: order.id,
                    clientId: order.clientId,
                    clientName: order.clientName,
                    address: order.deliveryAddress,
                    lat: order.deliveryLat,
                    lng: order.deliveryLng,
                    sequence: idx,
                    status: 'pending',
                    arrivalTime: null,
                    departureTime: null,
                    notes: ''
                })),
                totalDistance,
                estimatedTime: totalTime,
                estimatedCost: costData.totalCost,
                actualTime: null,
                actualCost: null,
                completedAt: null,
                costBreakdown: costData,
                createdAt: new Date().toISOString()
            };

            // Mettre �� jour stopIds
            route.stops.forEach(s => s.routeId = route.id);

            // Sauvegarder
            CORE.db.deliveryRoutes.push(route);
            CORE.save();

            return route;
        },

        // ===== AFFICHAGE ROUTE SUR CARTE =====
        visualizeRoute(route) {
            if (!route || !route.stops) return '';

            const stops = route.stops || [];
            const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'];

            return `
                <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-md">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-black text-slate-900 text-lg">��Ÿ? ��� � � Route de ${route.livreurName}</h3>
                        <div class="text-xs font-black text-slate-600">
                            ��Ÿ?Š ${stops.length} arr��ts �� ?� � ��Ÿ? � ${route.totalDistance.toFixed(1)} km �� ?� � �� � ��� � � ${route.estimatedTime} min
                        </div>
                    </div>

                    <!-- Stats rapides -->
                    <div class="grid grid-cols-4 gap-3 mb-6">
                        <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="text-xs font-black text-blue-600">Distance</div>
                            <div class="text-xl font-black text-blue-700">${route.totalDistance.toFixed(1)} km</div>
                        </div>
                        <div class="p-3 bg-emerald-50 rounded-lg border border-emerald-200">
                            <div class="text-xs font-black text-emerald-600">Temps estim�</div>
                            <div class="text-xl font-black text-emerald-700">${route.estimatedTime} min</div>
                        </div>
                        <div class="p-3 bg-amber-50 rounded-lg border border-amber-200">
                            <div class="text-xs font-black text-amber-600">Co��t route</div>
                            <div class="text-xl font-black text-amber-700">${CORE.formatPrice(route.estimatedCost)}</div>
                        </div>
                        <div class="p-3 bg-purple-50 rounded-lg border border-purple-200">
                            <div class="text-xs font-black text-purple-600">Arr��ts</div>
                            <div class="text-xl font-black text-purple-700">${stops.length}</div>
                        </div>
                    </div>

                    <!-- Liste des arr��ts -->
                    <div class="space-y-2">
                        ${stops.map((stop, idx) => `
                            <div class="flex items-start gap-3 p-3 rounded-lg border border-slate-200 bg-slate-50 hover:bg-slate-100 transition">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-white border-2 font-black text-xs flex items-center justify-center" style="border-color: ${colors[idx % colors.length]}; color: ${colors[idx % colors.length]};">
                                    ${idx + 1}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-black text-slate-900">${stop.clientName || 'Client'}</div>
                                    <div class="text-xs text-slate-600">��Ÿ? � ${stop.address || 'Adresse non sp�cifi�e'}</div>
                                    ${idx < stops.length - 1 ? `
                                        <div class="text-xs text-slate-500 mt-1">
                                            ��Ÿš? ${(route.totalDistance / stops.length).toFixed(1)} km jusqu'�� l'arr��t suivant
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="text-xs font-black text-slate-600">
                                    <span class="px-2 py-1 rounded-full" style="background: ${colors[idx % colors.length]}; color: white;">
                                        ${stop.status === 'pending' ? '�� � �' : stop.status === 'delivered' ? '���??' : '?'} ${stop.status}
                                    </span>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Actions -->
                    <div class="mt-6 flex gap-2">
                        <button onclick="RoutageModule.startRoute(${route.id})" class="flex-1 px-4 py-2 bg-emerald-600 text-white font-black rounded-lg hover:bg-emerald-700">
                            ��Ÿš ?� Lancer route
                        </button>
                        <button onclick="RoutageModule.showRouteDetails(${route.id})" class="flex-1 px-4 py-2 bg-blue-600 text-white font-black rounded-lg hover:bg-blue-700">
                            ��Ÿ?� D�tails
                        </button>
                        <button onclick="RoutageModule.exportRoute(${route.id})" class="flex-1 px-4 py-2 bg-slate-600 text-white font-black rounded-lg hover:bg-slate-700">
                            ��Ÿ? � Export
                        </button>
                    </div>
                </div>
            `;
        },

        // ===== GESTION ROUTE =====
        startRoute(routeId) {
            const route = CORE.db.deliveryRoutes.find(r => r.id === routeId);
            if (!route) return;
            route.status = 'in_progress';
            route.startTime = new Date().toTimeString().split(' ')[0];
            CORE.save();
            UI.toast(`���?? Route lanc�e pour ${route.livreurName}`, 'success');
            App.rerender();
        },

        completeRoute(routeId, actualTime = null, actualCost = null) {
            const route = CORE.db.deliveryRoutes.find(r => r.id === routeId);
            if (!route) return;
            route.status = 'completed';
            route.actualTime = actualTime || route.estimatedTime;
            route.actualCost = actualCost || route.estimatedCost;
            route.completedAt = new Date().toISOString();
            CORE.save();
            UI.toast(`���?? Route compl�t�e en ${route.actualTime} min`, 'success');
        },

        getRouteById(routeId) {
            return CORE.db.deliveryRoutes.find(r => r.id === routeId);
        },

        getRoutesByLivreur(livreurId, date = null) {
            return CORE.db.deliveryRoutes.filter(r => {
                if (r.livreurId !== livreurId) return false;
                if (date && r.date !== date) return false;
                return true;
            });
        },

        showRouteDetails(routeId) {
            const route = this.getRouteById(routeId);
            if (!route) return;

            const costData = route.costBreakdown || this.calculateRouteCost({ route: route.stops, totalDistance: route.totalDistance });

            UI.modal(`��Ÿ?� D�tails Route - ${route.livreurName}`, `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="text-xs font-black text-slate-600">STATUT</div>
                            <div class="text-lg font-black text-slate-900 mt-2">
                                ${route.status === 'planned' ? '��Ÿ?� Planifi�e' : route.status === 'in_progress' ? '��Ÿšš En cours' : '���?� Compl�t�e'}
                            </div>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="text-xs font-black text-slate-600">DATE</div>
                            <div class="text-lg font-black text-slate-900 mt-2">${route.date}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-blue-50 rounded-2xl border border-blue-200">
                            <div class="text-xs font-black text-blue-600">DISTANCE</div>
                            <div class="text-lg font-black text-blue-700 mt-2">${route.totalDistance.toFixed(1)} km</div>
                        </div>
                        <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-200">
                            <div class="text-xs font-black text-emerald-600">TEMPS</div>
                            <div class="text-lg font-black text-emerald-700 mt-2">${route.estimatedTime} min</div>
                        </div>
                    </div>

                    <div class="p-4 bg-amber-50 rounded-2xl border border-amber-200">
                        <div class="text-xs font-black text-amber-600 mb-3">D�COMPOSITION CO�?�TS</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Co��t distance (${costData.costPerKm}/km):</span>
                                <span class="font-black">${CORE.formatPrice(costData.costByDistance)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Frais livraisons (${costData.deliveryCount}):</span>
                                <span class="font-black">${CORE.formatPrice(costData.costByDelivery)}</span>
                            </div>
                            <div class="border-t border-amber-300 pt-2 mt-2 flex justify-between font-black text-amber-700">
                                <span>Total route:</span>
                                <span>${CORE.formatPrice(costData.totalCost)}</span>
                            </div>
                        </div>
                    </div>

                    <div class="max-h-96 overflow-y-auto p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <div class="font-black text-slate-900 mb-3">Arr��ts (${route.stops.length})</div>
                        <div class="space-y-2">
                            ${route.stops.map((stop, idx) => `
                                <div class="p-2 bg-white rounded border border-slate-200 text-sm">
                                    <div class="font-black text-slate-900">${idx + 1}. ${stop.clientName}</div>
                                    <div class="text-xs text-slate-600">��Ÿ? � ${stop.address}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        exportRoute(routeId) {
            const route = this.getRouteById(routeId);
            if (!route) return;

            let csv = 'S�quence,Client,Adresse,Latitude,Longitude,Statut\n';
            for (const stop of route.stops) {
                csv += `${stop.sequence + 1},"${stop.clientName}","${stop.address}",${stop.lat},${stop.lng},"${stop.status}"\n`;
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `route-${route.livreurName}-${route.date}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            UI.toast('���?? Route export�e en CSV', 'success');
        }
    };

    // =========================================================
    // MODULE: ALERTES INTELLIGENTES CONFIGURABLES
    // =========================================================
    const AlertesModule = {
        // ===== GESTION DES PR�F�RENCES D'ALERTES =====
        getAlertPreferences(userId) {
            const prefs = (CORE.db.alertPreferences || []).find(p => p.userId === userId);
            if (prefs) return prefs;
            
            // Cr�er les pr�f�rences par d�faut pour ce utilisateur
            const user = CORE.db.users.find(u => u.id === userId);
            const defaultPrefs = {
                id: Utils.uid('ALERTPREF'),
                userId,
                userRole: user?.role || 'vendeur',
                alerts: {
                    stock_low: { enabled: true, level: 'attention', sendEmail: false, sendSms: false },
                    stock_critical: { enabled: true, level: 'critique', sendEmail: true, sendSms: false },
                    order_pending: { enabled: true, level: 'attention', sendEmail: false, sendSms: false },
                    inactive_livreur: { enabled: true, level: 'info', sendEmail: false, sendSms: false },
                    critical_incident: { enabled: true, level: 'critique', sendEmail: true, sendSms: true },
                    low_revenue: { enabled: true, level: 'info', sendEmail: false, sendSms: false }
                },
                emailAddress: user?.email || '',
                phoneNumber: user?.phone || '',
                createdAt: new Date().toISOString()
            };
            CORE.db.alertPreferences.push(defaultPrefs);
            return defaultPrefs;
        },

        updateAlertPreference(userId, alertType, enabled, level, sendEmail = false, sendSms = false) {
            const prefs = this.getAlertPreferences(userId);
            if (!prefs.alerts[alertType]) {
                prefs.alerts[alertType] = {};
            }
            prefs.alerts[alertType] = { enabled, level, sendEmail, sendSms };
            CORE.save();
            return prefs;
        },

        // ===== MODE SILENCE PROGRAMMABLE =====
        setSilenceSchedule(userId, name, startTime, endTime, daysOfWeek = []) {
            const schedule = {
                id: Utils.uid('SILENCE'),
                userId,
                name,
                startTime, // "22:00"
                endTime,   // "08:00"
                daysOfWeek: daysOfWeek.length > 0 ? daysOfWeek : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                active: true,
                exceptions: [],
                createdAt: new Date().toISOString()
            };
            CORE.db.silenceSchedules.push(schedule);
            CORE.save();
            return schedule;
        },

        getSilenceSchedules(userId) {
            return (CORE.db.silenceSchedules || []).filter(s => s.userId === userId && s.active);
        },

        isInSilenceWindow(userId) {
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            const dayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][now.getDay()];
            
            const schedules = this.getSilenceSchedules(userId);
            for (const schedule of schedules) {
                if (!schedule.daysOfWeek.includes(dayName)) continue;
                
                const [startH, startM] = schedule.startTime.split(':');
                const [endH, endM] = schedule.endTime.split(':');
                const startTs = parseInt(startH) * 60 + parseInt(startM);
                const endTs = parseInt(endH) * 60 + parseInt(endM);
                const currentTs = now.getHours() * 60 + now.getMinutes();
                
                if (startTs <= endTs) {
                    if (currentTs >= startTs && currentTs <= endTs) return true;
                } else { // Mode nuit (ex: 22:00 �� 08:00)
                    if (currentTs >= startTs || currentTs <= endTs) return true;
                }
            }
            return false;
        },

        // ===== G�N�RATION ET ENVOI D'ALERTES =====
        generateAlert(userId, type, level, title, message, details = {}) {
            const alert = {
                id: Utils.uid('ALERT'),
                timestamp: new Date().toISOString(),
                userId,
                userRole: CORE.db.users.find(u => u.id === userId)?.role || 'vendeur',
                type, // stock_low, order_pending, inactive_livreur, critical_incident, low_revenue
                level, // info, attention, critique
                title,
                message,
                details,
                triggered: true,
                sent: false,
                read: false,
                readAt: null,
                actionTaken: false,
                notes: ''
            };
            
            CORE.db.alertHistory.push(alert);
            CORE.save();
            return alert;
        },

        shouldNotifyUser(userId, alertType, level) {
            // V�rifier 1: Utilisateur a-t-il activ� ce type d'alerte?
            const prefs = this.getAlertPreferences(userId);
            if (!prefs.alerts[alertType]?.enabled) return false;
            
            // V�rifier 2: Est-on dans une fen��tre de silence?
            if (this.isInSilenceWindow(userId)) {
                // Ne pas envoyer les alertes "info", mais envoyer les "critique"
                if (level !== 'critique') return false;
            }
            
            return true;
        },

        sendAlertNotification(userId, alert) {
            if (!this.shouldNotifyUser(userId, alert.type, alert.level)) return false;
            
            const prefs = this.getAlertPreferences(userId);
            const alertConfig = prefs.alerts[alert.type];
            
            // Marquer comme envoy�e
            alert.sent = true;
            alert.sentAt = new Date().toISOString();
            
            // Envoyer Email si activ�
            if (alertConfig?.sendEmail && prefs.emailAddress) {
                console.log(`��Ÿ? � EMAIL: ${alert.title} ���? ${prefs.emailAddress}`);
                // Dans un vrai syst��me: ApiService.sendEmail(prefs.emailAddress, alert.title, alert.message)
            }
            
            // Envoyer SMS si activ�
            if (alertConfig?.sendSms && prefs.phoneNumber) {
                console.log(`��Ÿ? � SMS: ${alert.title} ���? ${prefs.phoneNumber}`);
                // Dans un vrai syst��me: ApiService.sendSms(prefs.phoneNumber, alert.message)
            }
            
            // Toast dans l'UI
            const emoji = { info: '��Ÿ� �', attention: '��ŸŸ �', critique: '��Ÿ� �' }[alert.level] || '��Ÿ� �';
            console.log(`${emoji} ${alert.title}: ${alert.message}`);
            
            CORE.save();
            return true;
        },

        // ===== V�RIFICATION DES R�?GLES D'ALERTES =====
        checkAlertRules(userRole) {
            const rules = (CORE.db.alertRules || []).filter(r => 
                r.enabled && (r.role === userRole || r.role === 'multi')
            );
            
            const alerts = [];
            for (const rule of rules) {
                const alert = this.evaluateRule(rule);
                if (alert) alerts.push(alert);
            }
            return alerts;
        },

        evaluateRule(rule) {
            const { type, condition, level, message } = rule;
            let triggered = false;
            let alertMessage = message;
            
            switch (type) {
                case 'stock_low':
                case 'stock_critical':
                    const lowStockProducts = (CORE.db.products || []).filter(p => {
                        const minStock = condition.value || 10;
                        return p.stock < minStock && p.active;
                    });
                    if (lowStockProducts.length > 0) {
                        triggered = true;
                        alertMessage = `${lowStockProducts.length} produit(s) en stock faible`;
                    }
                    break;
                    
                case 'pending_orders':
                    const pendingOrders = (CORE.db.orders || []).filter(o => 
                        o.status === 'pending' && 
                        (new Date() - new Date(o.createdAt)) > condition.time
                    );
                    if (pendingOrders.length > 0) {
                        triggered = true;
                        alertMessage = `${pendingOrders.length} commande(s) en attente depuis longtemps`;
                    }
                    break;
                    
                case 'inactive_livreur':
                    const inactiveLivreurs = (CORE.db.users || []).filter(u => 
                        u.role === 'livreur' && 
                        u.active &&
                        (!u.lastActivity || (new Date() - new Date(u.lastActivity)) > condition.value)
                    );
                    if (inactiveLivreurs.length > 0) {
                        triggered = true;
                        alertMessage = `${inactiveLivreurs.length} livreur(s) inactif(s)`;
                    }
                    break;
                    
                case 'critical_incident':
                    const incidents = (CORE.db.incidents || []).filter(i =>
                        i.severity === 'haute' && i.status === 'ouvert'
                    );
                    if (incidents.length > 0) {
                        triggered = true;
                        alertMessage = `${incidents.length} incident(s) critique(s) ouvert(s)`;
                    }
                    break;
                    
                case 'low_revenue':
                    // Calculer revenu 30 jours
                    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                    const recentOrders = (CORE.db.orders || []).filter(o => 
                        new Date(o.createdAt) >= thirtyDaysAgo
                    );
                    const revenue30d = recentOrders.reduce((sum, o) => sum + (o.total || 0), 0);
                    if (revenue30d < condition.value) {
                        triggered = true;
                        alertMessage = `Revenu 30j faible: ${CORE.formatPrice(revenue30d)}`;
                    }
                    break;
            }
            
            if (!triggered) return null;
            
            return {
                type,
                level,
                title: rule.message.split(':')[0] || type,
                message: alertMessage
            };
        },

        // ===== MONITORING CONTINU =====
        startAlertMonitoring() {
            if (this.monitoringInterval) return;
            
            this.monitoringInterval = setInterval(() => {
                const user = CORE.state.currentUser;
                if (!user) return;
                
                const alerts = this.checkAlertRules(user.role);
                for (const alert of alerts) {
                    const fullAlert = this.generateAlert(
                        user.id,
                        alert.type,
                        alert.level,
                        alert.title,
                        alert.message
                    );
                    this.sendAlertNotification(user.id, fullAlert);
                }
            }, 60000); // V�rifier toutes les minutes
        },

        stopAlertMonitoring() {
            if (this.monitoringInterval) {
                clearInterval(this.monitoringInterval);
                this.monitoringInterval = null;
            }
        },

        // ===== UTILITAIRES SUPPL�MENTAIRES =====
        updateContactInfo(userId, type, value) {
            const prefs = this.getAlertPreferences(userId);
            if (type === 'email') {
                prefs.emailAddress = value;
            } else if (type === 'phone') {
                prefs.phoneNumber = value;
            }
            CORE.save();
            UI.toast('���?? Coordonn�es mises �� jour', 'success');
        },

        deleteSilenceSchedule(scheduleId) {
            const idx = CORE.db.silenceSchedules.findIndex(s => s.id === scheduleId);
            if (idx !== -1) {
                CORE.db.silenceSchedules.splice(idx, 1);
                CORE.save();
                UI.toast('���?? Mode silence supprim�', 'success');
            }
        },

        showAddSilenceSchedule(userId) {
            UI.modal('��Ÿ � � Ajouter un mode silence', `
                <div class="space-y-4">
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <label class="block text-sm font-black text-slate-900 mb-2">Nom du mode</label>
                        <input type="text" id="silence_name" placeholder="Ex: Nuit, R�union, Jour off..." class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm font-black">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <label class="block text-sm font-black text-slate-900 mb-2">Heure d�but</label>
                            <input type="time" id="silence_start" value="22:00" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm font-black">
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <label class="block text-sm font-black text-slate-900 mb-2">Heure fin</label>
                            <input type="time" id="silence_end" value="08:00" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm font-black">
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <label class="block text-sm font-black text-slate-900 mb-3">Jours d'application</label>
                        <div class="grid grid-cols-4 gap-2">
                            ${['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(day => `
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" value="${day}" class="silence_days" ${['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].includes(day) ? 'checked' : ''}>
                                    <span class="text-xs font-black">${day}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Cr�er', onclick: `
                    const name = document.getElementById('silence_name').value || 'Mode silence';
                    const start = document.getElementById('silence_start').value;
                    const end = document.getElementById('silence_end').value;
                    const days = Array.from(document.querySelectorAll('.silence_days:checked')).map(el => el.value);
                    AlertesModule.setSilenceSchedule(${userId}, name, start, end, days.length > 0 ? days : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']);
                    UI.toast('���?? Mode silence cr��', 'success');
                    UI.closeModal();
                    App.rerender();
                `, class: 'px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        getAlertHistory(userId, limit = 20) {
            return (CORE.db.alertHistory || [])
                .filter(a => a.userId === userId)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, limit);
        },

        getUnreadAlerts(userId) {
            return (CORE.db.alertHistory || []).filter(a => a.userId === userId && !a.read);
        },

        markAlertAsRead(alertId) {
            const alert = (CORE.db.alertHistory || []).find(a => a.id === alertId);
            if (alert) {
                alert.read = true;
                alert.readAt = new Date().toISOString();
                CORE.save();
            }
        },

        showPOSModal() {
            if (!CORE.hasPermission('managePos')) {
                return UI.toast('Acc��s refus�', 'error');
            }
            // Afficher directement la vue de gestion des POS
            UI.modal('Gestion des Points de Vente', this.renderPOS(), [{label:'Fermer', onclick:'UI.closeModal()'}], 'max-w-6xl');
        },

        showTransferModal() {
            const currentUser = CORE.state.currentUser || {};
            const hasAssignedPos = currentUser.role === 'gestionnaire' && currentUser.pos;
            const forcedPosId = hasAssignedPos ? currentUser.pos : null;
            
            if (!forcedPosId) {
                UI.toast('Aucun POS assign�', 'error');
                return;
            }

            const pos = CORE.getPOS(forcedPosId);
            const products = (CORE.db.products || []).filter(p => this.productBelongsToPos(p, forcedPosId));
            
            if (products.length === 0) {
                UI.toast('Aucun produit disponible pour ce POS', 'warning');
                return;
            }

            // Analyse des produits critiques pour ce POS
            const posStock = {};
            products.forEach(p => {
                posStock[p.id] = CORE.getProductStock(p.id, forcedPosId) || 0;
            });

            // Suggestions bas�es sur les stocks bas
            const suggestions = [];
            products.forEach(p => {
                const minStock = p.minStock || 0;
                if (minStock <= 0) return;
                const stock = posStock[p.id] || 0;
                const target = Math.max(minStock * 2, minStock + 20);
                const deficit = target - stock;
                if (deficit <= 0) return;
                suggestions.push({
                    productId: p.id,
                    productName: p.name,
                    stock,
                    minStock,
                    suggestedQty: deficit,
                    severity: stock <= Math.max(1, minStock * 0.5) ? 'critical' : 'low'
                });
            });

            suggestions.sort((a, b) => {
                if (a.severity !== b.severity) return a.severity === 'critical' ? -1 : 1;
                return (a.stock / (a.minStock + 1)) - (b.stock / (b.minStock + 1));
            });

            const topSuggestions = suggestions.slice(0, 5);
            const defaultProduct = products[0];
            const defaultSuggestion = topSuggestions[0] || null;

            const html = `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="p-4 rounded-2xl bg-blue-50 border border-blue-200">
                            <div class="text-xs font-black text-blue-600 uppercase">Stock POS</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${products.reduce((sum, p) => sum + (posStock[p.id] || 0), 0)}</div>
                            <div class="text-[11px] text-blue-700">Unit�s �� ${pos.name}</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-200">
                            <div class="text-xs font-black text-emerald-600 uppercase">Valeur estim�e</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${CORE.formatPrice(products.reduce((sum, p) => sum + ((posStock[p.id] || 0) * (p.price || 0)), 0))}</div>
                            <div class="text-[11px] text-emerald-700">Stock valoris�</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-amber-50 border border-amber-200">
                            <div class="text-xs font-black text-amber-600 uppercase">Produits critiques</div>
                            <div class="text-2xl font-black text-amber-900 mt-1">${products.filter(p => (posStock[p.id] || 0) <= (p.minStock || 0)).length}</div>
                            <div class="text-[11px] text-amber-700">�?� surveiller</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                        <div class="space-y-4">
                            <div class="p-5 bg-white rounded-3xl border border-slate-200 space-y-4">
                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Produit �� transf�rer vers ${pos.name}</label>
                                    <select id="transfer_product" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-teal-500">
                                        ${products.map(p => `
                                            <option value="${p.id}" ${p.id === defaultProduct.id ? 'selected' : ''}>
                                                ${p.name} �� ?� � Stock actuel: ${posStock[p.id] || 0}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-3 text-center text-sm">
                                    <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                        <div class="text-xs font-bold text-slate-500 uppercase">Stock actuel</div>
                                        <div id="transfer_summary_stock" class="text-xl font-black text-slate-900">0</div>
                                    </div>
                                    <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                        <div class="text-xs font-bold text-slate-500 uppercase">Stock min.</div>
                                        <div id="transfer_summary_min" class="text-xl font-black text-slate-900">0</div>
                                    </div>
                                </div>

                                <div class="p-3 rounded-2xl bg-emerald-50 border border-emerald-200">
                                    <div class="flex items-center justify-between text-sm font-bold text-emerald-700">
                                        <span>Suggestion de r�appro</span>
                                        <span id="transfer_summary_suggested">0 unit�s</span>
                                    </div>
                                </div>

                                <div class="flex flex-wrap gap-2">
                                    <button data-transfer-set="suggested" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700 transition">Appliquer suggestion</button>
                                    <button data-transfer-set="min" class="px-3 py-2 rounded-xl bg-blue-600 text-white text-xs font-black hover:bg-blue-700 transition">Atteindre Min</button>
                                    <button data-transfer-set="+25" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300 transition">+25</button>
                                    <button data-transfer-set="+50" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300 transition">+50</button>
                                    <button data-transfer-set="clear" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-100 transition">R�initialiser</button>
                                </div>

                                <div class="grid grid-cols-2 gap-3 items-end">
                                    <div>
                                        <label class="block text-xs font-black text-slate-500 uppercase mb-2">Quantit� �� recevoir</label>
                                        <input id="transfer_qty" type="number" min="0" value="0" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-black text-lg text-center bg-white focus:ring-2 focus:ring-teal-500">
                                        <div id="transfer_warning" class="mt-2 text-xs font-bold text-red-600 hidden">��š ��� � � V�rifiez le stock disponible</div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-black text-slate-500 uppercase mb-2">R�f�rence</label>
                                        <input id="transfer_ref" type="text" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-slate-50" placeholder="Auto-g�n�r�" readonly>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Note interne (optionnelle)</label>
                                    <textarea id="transfer_note" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-white" rows="2" placeholder="Ex: R�assort saisonnier..."></textarea>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Num�ro de suivi (optionnel)</label>
                                    <input id="transfer_tracking" type="text" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-white" placeholder="Ex: TRANSFERT-2026-001">
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Arriv�e estim�e</label>
                                    <input id="transfer_eta" type="datetime-local" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-white">
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="p-5 bg-white rounded-3xl border border-slate-200">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="font-black text-slate-900 text-sm">��ŸŽ � Produits �� surveiller</div>
                                    <span class="text-xs text-slate-500 font-bold">${topSuggestions.length} alertes</span>
                                </div>
                                ${topSuggestions.length === 0 ? `
                                    <div class="p-4 rounded-2xl bg-slate-50 text-sm text-slate-500 text-center">
                                        Aucune alerte d�tect�e pour ce POS.
                                    </div>
                                ` : `
                                    <div class="space-y-2">
                                        ${topSuggestions.map(s => `
                                            <div class="p-3 rounded-2xl border ${s.severity === 'critical' ? 'border-red-200 bg-red-50' : 'border-amber-200 bg-amber-50'} flex items-center justify-between gap-3">
                                                <div>
                                                    <div class="font-black text-slate-900 text-sm">${s.productName}</div>
                                                    <div class="text-xs text-slate-600">Stock: ${s.stock}/${s.minStock}</div>
                                                    <div class="text-xs font-bold text-slate-500">Suggestion: ${s.suggestedQty} unit�s</div>
                                                </div>
                                                <button data-transfer-suggestion data-product-id="${s.productId}" data-suggested-qty="${s.suggestedQty}" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-xs font-black hover:bg-slate-800 transition whitespace-nowrap">Appliquer</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>

                            <div class="p-5 bg-white rounded-3xl border border-slate-200">
                                <div class="font-black text-slate-900 text-sm mb-3">��Ÿ?Š R�sum� du transfert</div>
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                        <span class="text-slate-600">Produit s�lectionn�</span>
                                        <span id="summary_product" class="font-black text-slate-900">-</span>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                        <span class="text-slate-600">Quantit�</span>
                                        <span id="summary_qty" class="font-black text-slate-900">0 unit�s</span>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                        <span class="text-slate-600">Valeur estim�e</span>
                                        <span id="summary_value" class="font-black text-slate-900">0 XAF</span>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-emerald-50 border border-emerald-200 rounded-xl">
                                        <span class="font-bold text-emerald-700">Stock apr��s transfert</span>
                                        <span id="summary_stock_after" class="font-black text-emerald-900">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            UI.modal(`��Ÿ�? Recevoir des articles - ${pos.name}`, html, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer transfert', onclick: 'GestionnaireModule.executeTransfer()', class: 'px-5 py-2.5 bg-teal-600 text-white font-black rounded-xl hover:bg-teal-700 transition' }
            ]);

            setTimeout(() => {
                const modalEl = document.querySelector('#modalContainer .slide-up');
                if (modalEl) {
                    modalEl.classList.remove('max-w-lg');
                    modalEl.classList.add('max-w-5xl');
                }

                const productSelect = document.getElementById('transfer_product');
                const qtyInput = document.getElementById('transfer_qty');
                const refInput = document.getElementById('transfer_ref');
                const summaryStock = document.getElementById('transfer_summary_stock');
                const summaryMin = document.getElementById('transfer_summary_min');
                const summarySuggested = document.getElementById('transfer_summary_suggested');
                const summaryProduct = document.getElementById('summary_product');
                const summaryQty = document.getElementById('summary_qty');
                const summaryValue = document.getElementById('summary_value');
                const summaryStockAfter = document.getElementById('summary_stock_after');
                const warning = document.getElementById('transfer_warning');

                const updateSummary = () => {
                    const productId = parseInt(productSelect.value, 10);
                    const product = CORE.getProduct(productId) || {};
                    const qty = parseInt(qtyInput.value || 0, 10);
                    const currentStock = posStock[productId] || 0;
                    const minStock = product.minStock || 0;
                    const suggestedQty = Math.max(0, Math.max(minStock * 2, minStock + 20) - currentStock);

                    summaryStock.textContent = currentStock;
                    summaryMin.textContent = minStock;
                    summarySuggested.textContent = `${suggestedQty} unit�s`;
                    summaryProduct.textContent = product.name || '-';
                    summaryQty.textContent = `${qty} unit�s`;
                    summaryValue.textContent = CORE.formatPrice(qty * (product.price || 0));
                    summaryStockAfter.textContent = `${currentStock + qty} unit�s`;

                    warning.classList.toggle('hidden', qty >= 0);
                };

                productSelect?.addEventListener('change', updateSummary);
                qtyInput?.addEventListener('input', updateSummary);

                // Boutons de suggestion
                document.querySelectorAll('[data-transfer-set]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = parseInt(productSelect.value, 10);
                        const product = CORE.getProduct(productId) || {};
                        const currentStock = posStock[productId] || 0;
                        const minStock = product.minStock || 0;
                        const action = btn.getAttribute('data-transfer-set');

                        if (action === 'suggested') {
                            const suggested = Math.max(minStock * 2, minStock + 20) - currentStock;
                            qtyInput.value = Math.max(0, suggested);
                        } else if (action === 'min') {
                            qtyInput.value = Math.max(0, minStock - currentStock);
                        } else if (action === 'clear') {
                            qtyInput.value = 0;
                        } else if (action.startsWith('+')) {
                            const add = parseInt(action.substring(1), 10);
                            qtyInput.value = parseInt(qtyInput.value || 0, 10) + add;
                        }
                        updateSummary();
                    });
                });

                // Boutons de suggestion rapide
                document.querySelectorAll('[data-transfer-suggestion]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const productId = btn.getAttribute('data-product-id');
                        const suggestedQty = btn.getAttribute('data-suggested-qty');
                        productSelect.value = productId;
                        qtyInput.value = suggestedQty;
                        updateSummary();
                    });
                });

                updateSummary();
            }, 100);
        },

        executeTransfer() {
            const currentUser = CORE.state.currentUser || {};
            const forcedPosId = currentUser.pos;
            const pos = CORE.getPOS(forcedPosId);

            const productId = parseInt(document.getElementById('transfer_product')?.value || 0, 10);
            const qty = Math.abs(parseInt(document.getElementById('transfer_qty')?.value || 0, 10));
            const note = document.getElementById('transfer_note')?.value || '';
            const tracking = document.getElementById('transfer_tracking')?.value || '';
            const eta = document.getElementById('transfer_eta')?.value || '';

            if (!productId || !qty) {
                UI.toast('S�lectionnez un produit et une quantit�', 'warning');
                return;
            }

            const product = CORE.getProduct(productId);
            if (!product) {
                UI.toast('Produit introuvable', 'error');
                return;
            }

            // Enregistrer le transfert entrant au POS
            CORE.recordStockMovement({
                productId: product.id,
                type: 'in',
                qty: qty,
                note: `Transfert re��u${note ? ': ' + note : ''}`,
                posId: forcedPosId,
                meta: {
                    source: 'gestionnaire_transfer',
                    direction: 'in',
                    fromOrigin: 'depot',
                    originName: 'D�p��t principal',
                    destinationName: pos.name,
                    toPosId: forcedPosId,
                    tracking: tracking,
                    eta: eta,
                    userId: currentUser.id
                }
            });

            CORE.save();
            this.invalidateCache(['products', 'stocks']);
            UI.closeModal();
            UI.toast(`���?� ${qty} unit�s de ${product.name} re��ues �� ${pos.name}`, 'success');
            App.rerender();
        },

        productBelongsToPos(product, posId) {
            if (!posId) return true;
            if (!product) return false;
            const numericPosId = Number(posId);
            if (!Number.isFinite(numericPosId)) return false;
            
            // Si produit est verrouill� �� un POS sp�cifique (cr�� par gestionnaire assign�)
            if (product.lockedToPosId && Number(product.lockedToPosId) !== numericPosId) {
                return false;
            }
            
            // Si le produit a un posId d�fini, il appartient EXCLUSIVEMENT �� ce POS
            // sauf s'il a �t� explicitement transf�r� vers un autre POS via posStocks
            if (product.posId !== null && product.posId !== undefined) {
                if (Number(product.posId) === numericPosId) return true;
                
                // V�rifier si le produit a �t� transf�r� vers ce POS (a du stock dans posStocks)
                const stockMap = product.posStocks || {};
                const entry = stockMap[String(numericPosId)] ?? stockMap[numericPosId] ?? null;
                if (!entry) return false;
                const stock = Number(entry.stock ?? entry.quantity ?? 0);
                if (Number.isFinite(stock) && stock > 0) return true;
                if (entry.assigned === true) return true;
                if (entry.lastMovement || entry.lastUpdated || entry.lastTransfer || entry.lastRestock) return true;
                return false;
            }
            
            // Pour les produits sans posId (produits globaux/main warehouse)
            if (product.isMainWarehouse) return false; // Les produits du d�p��t principal ne sont pas dans les POS
            
            // V�rifier posStocks pour les produits globaux
            const stockMap = product.posStocks || {};
            const entry = stockMap[String(numericPosId)] ?? stockMap[numericPosId] ?? null;
            if (!entry) return false;
            const stock = Number(entry.stock ?? entry.quantity ?? 0);
            if (Number.isFinite(stock) && stock > 0) return true;
            if (entry.assigned === true) return true;
            if (entry.lastMovement || entry.lastUpdated || entry.lastTransfer || entry.lastRestock) return true;
            if (Array.isArray(entry.variants) && entry.variants.length > 0) return true;
            if (entry.price !== undefined && entry.price !== null && entry.price !== product.price) return true;
            return false;
        },

        // ============ GESTION D�PENSES ET REVENUS ============
        showNewExpenseModal() {
            const expenseCategories = [
                { value: 'stock', label: '��Ÿ? � Achat de stock/produits' },
                { value: 'transport', label: '��Ÿšš Frais de transport' },
                { value: 'salaire', label: '��Ÿ? � Salaires' },
                { value: 'loyer', label: '��Ÿ � � Loyer/Local' },
                { value: 'electricite', label: '��š � �lectricit�/Eau' },
                { value: 'telephone', label: '��Ÿ? � T�l�phone/Internet' },
                { value: 'maintenance', label: '��Ÿ� � Maintenance/R�paration' },
                { value: 'hygieneEntretien', label: '��Ÿ � � Hygi��ne/Entretien' },
                { value: 'publicite', label: '��Ÿ? � Publicit�/Marketing' },
                { value: 'assurance', label: '��Ÿ� ��� � � Assurance' },
                { value: 'taxe', label: '��Ÿ? � Taxes/Imp��ts' },
                { value: 'banque', label: '��Ÿ � � Frais bancaires' },
                { value: 'deplacement', label: '��Ÿš? D�placement/Carburant' },
                { value: 'formation', label: '��Ÿ?š Formation/Cours' },
                { value: 'equipement', label: '��Ÿ� ��� � � �quipement/Mat�riel' },
                { value: 'autre', label: '��Ÿ?� Autre' }
            ];

            UI.modal('Nouvelle D�pense', `
                <div class="space-y-4">
                    <div class="p-4 bg-red-50 border border-red-200 rounded-xl">
                        <div class="flex items-center gap-2 text-red-700 font-bold">
                            <i data-lucide="alert-circle" class="w-5 h-5"></i>
                            Enregistrer une sortie d'argent
                        </div>
                        <div class="text-xs text-red-600 mt-1">Cette d�pense sera enregistr�e pour votre POS</div>
                    </div>
                    ${UI.input('ge_amount', 'Montant (XAF)', 'number', '', 'ex: 50000', true)}
                    ${UI.select('ge_category', 'Cat�gorie', expenseCategories, 'stock', true)}
                    ${UI.textarea('ge_note', 'Description / Justification', '', 'D�tails de la d�pense...', 3)}
                    ${UI.input('ge_ref', 'R�f�rence (optionnel)', 'text', '', 'N�? � facture, re��u...')}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer la d�pense', onclick: 'GestionnaireModule.saveExpense()', class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);
            setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 50);
        },

        saveExpense() {
            const amount = parseFloat(UI.val('ge_amount')) || 0;
            const category = UI.val('ge_category') || 'autre';
            const note = UI.val('ge_note').trim();
            const ref = UI.val('ge_ref').trim();

            if (amount <= 0) return UI.toast('Montant invalide', 'warning');

            const categoryLabels = {
                'stock': 'Achat de stock/produits', 'transport': 'Frais de transport', 'salaire': 'Salaires',
                'loyer': 'Loyer/Local', 'electricite': '�lectricit�/Eau', 'telephone': 'T�l�phone/Internet',
                'maintenance': 'Maintenance/R�paration', 'hygieneEntretien': 'Hygi��ne/Entretien',
                'publicite': 'Publicit�/Marketing', 'assurance': 'Assurance', 'taxe': 'Taxes/Imp��ts',
                'banque': 'Frais bancaires', 'deplacement': 'D�placement/Carburant', 'formation': 'Formation/Cours',
                'equipement': '�quipement/Mat�riel', 'autre': 'Autre'
            };

            CORE.db.financialTransactions = CORE.db.financialTransactions || [];
            CORE.db.financialTransactions.push({
                id: Date.now(),
                userId: CORE.state.currentUser?.id,
                userName: CORE.state.currentUser?.name || 'Gestionnaire',
                posId: CORE.state.currentUser?.pos,
                type: 'expense',
                amount,
                category: categoryLabels[category] || category,
                note,
                reference: ref,
                createdAt: new Date().toISOString()
            });
            CORE.save();
            UI.closeModal();
            UI.toast('D�pense enregistr�e avec succ��s', 'success');
            App.rerender();
        },

        showNewIncomeModal() {
            const incomeCategories = [
                { value: 'vente', label: '��Ÿ�? Vente directe' },
                { value: 'depot_caisse', label: '��Ÿ? � D�p��t en caisse' },
                { value: 'service', label: '��Ÿ� � Service rendu' },
                { value: 'remboursement', label: '��� ��� � � Remboursement re��u' },
                { value: 'depot_livreur', label: '��Ÿ? � D�p��t livreur' },
                { value: 'investissement', label: '��Ÿ? � Investissement/Capital' },
                { value: 'pret', label: '��Ÿ � � Pr��t re��u' },
                { value: 'autre', label: '��Ÿ?� Autre' }
            ];

            UI.modal('Nouveau Revenu / D�p��t', `
                <div class="space-y-4">
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                        <div class="flex items-center gap-2 text-emerald-700 font-bold">
                            <i data-lucide="trending-up" class="w-5 h-5"></i>
                            Enregistrer une entr�e d'argent
                        </div>
                        <div class="text-xs text-emerald-600 mt-1">Ce revenu sera enregistr� pour votre POS</div>
                    </div>
                    ${UI.input('gi_amount', 'Montant (XAF)', 'number', '', 'ex: 100000', true)}
                    ${UI.select('gi_category', 'Source / Cat�gorie', incomeCategories, 'depot_caisse', true)}
                    ${UI.textarea('gi_note', 'Description', '', 'D�tails du revenu...', 3)}
                    ${UI.input('gi_ref', 'R�f�rence (optionnel)', 'text', '', 'N�? � re��u, facture...')}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer le revenu', onclick: 'GestionnaireModule.saveNewIncome()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
            setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 50);
        },

        saveNewIncome() {
            const amount = parseFloat(UI.val('gi_amount')) || 0;
            const category = UI.val('gi_category') || 'autre';
            const note = UI.val('gi_note').trim();
            const ref = UI.val('gi_ref').trim();

            if (amount <= 0) return UI.toast('Montant invalide', 'warning');

            CORE.db.financialTransactions = CORE.db.financialTransactions || [];
            CORE.db.financialTransactions.push({
                id: Date.now(),
                userId: CORE.state.currentUser?.id,
                userName: CORE.state.currentUser?.name || 'Gestionnaire',
                posId: CORE.state.currentUser?.pos,
                type: 'income',
                amount,
                category,
                note,
                reference: ref,
                createdAt: new Date().toISOString()
            });
            CORE.save();
            UI.closeModal();
            UI.toast('Revenu enregistr� avec succ��s', 'success');
            App.rerender();
        },

        // =====================
        // COD - Encaissement des livraisons COD
        // =====================
        
        // Marquer un COD comme encaiss� (argent r�cup�r� du livreur)
        markCODCollected(orderId) {
            const order = CORE.db.orders.find(o => o.id === orderId);
            if (!order) return UI.toast('Commande non trouv�e', 'error');
            
            if (order.paymentStatus === 'paid') {
                return UI.toast('Cette commande COD a d�j�� �t� encaiss�e', 'warning');
            }
            
            // Marquer comme pay�
            const updated = CORE.update('orders', orderId, { 
                paymentStatus: 'paid', 
                codCollectedAt: new Date().toISOString(),
                codCollectedBy: CORE.state.currentUser?.id,
                codCollectedByName: CORE.state.currentUser?.name || 'Gestionnaire'
            });
            
            // Cr�er la transaction financi��re de vente
            CORE.ensureSaleTransaction(updated);
            
            // Log d'activit�
            CORE.logActivity('COD_COLLECTED', 'order', orderId, {
                entityName: order.reference,
                description: `COD encaiss�: ${order.reference} - ${CORE.formatPrice(order.total)}`,
                amount: order.total,
                posId: order.posId,
                status: 'success'
            });
            
            UI.toast(`���?� COD ${order.reference} encaiss� (${CORE.formatPrice(order.total)})`, 'success');
            App.rerender();
        },
        
        // Afficher tous les COD en attente
        showCODOutstandingModal() {
            const userPos = CORE.state.currentUser?.pos;
            
            const codOutstanding = CORE.db.orders.filter(o => 
                o.posId == userPos && 
                o.paymentMethod === 'cod' && 
                o.paymentStatus !== 'paid'
            ).filter(o => {
                const delivery = CORE.db.deliveries.find(d => d.orderId === o.id);
                return delivery && delivery.status === 'livree';
            }).sort((a, b) => {
                const da = CORE.db.deliveries.find(d => d.orderId === a.id);
                const db = CORE.db.deliveries.find(d => d.orderId === b.id);
                return new Date(db?.deliveredAt || 0) - new Date(da?.deliveredAt || 0);
            });
            
            const totalAmount = codOutstanding.reduce((sum, o) => sum + (o.total || 0), 0);
            
            let listHtml = codOutstanding.length === 0 
                ? '<div class="text-center py-8 text-slate-400">Aucun COD en attente d\'encaissement</div>'
                : codOutstanding.map(o => {
                    const delivery = CORE.db.deliveries.find(d => d.orderId === o.id);
                    let livreurName = '�� ?��';
                    if (delivery?.livreurId) {
                        if (String(delivery.livreurId).startsWith('idm_')) {
                            const dm = CORE.db.independentDeliveryMen.find(dm => dm.id === delivery.livreurId);
                            livreurName = dm ? dm.name + ' �� � �' : 'Livreur ind�p.';
                        } else {
                            livreurName = CORE.getUser(delivery.livreurId)?.name || 'Livreur';
                        }
                    }
                    const deliveredAt = delivery?.deliveredAt ? CORE.formatDate(delivery.deliveredAt) : '�� ?��';
                    
                    return `
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-200 hover:bg-slate-100 transition">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-black text-slate-900">${o.reference}</span>
                                    <span class="px-2 py-0.5 bg-amber-100 text-amber-700 text-xs font-bold rounded">COD</span>
                                </div>
                                <div class="text-sm text-slate-600">${o.clientName || 'Client'}</div>
                                <div class="text-xs text-slate-400 mt-1">
                                    <span class="font-bold">Livreur:</span> ${livreurName} �� ?� � 
                                    <span class="font-bold">Livr�:</span> ${deliveredAt}
                                </div>
                            </div>
                            <div class="text-right ml-4">
                                <div class="text-xl font-black text-amber-700 mb-2">${CORE.formatPrice(o.total)}</div>
                                <button onclick="GestionnaireModule.markCODCollected(${o.id})" class="px-4 py-2 bg-emerald-500 text-white text-sm font-black rounded-lg hover:bg-emerald-600 transition">
                                    ���?? Encaiss�
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            
            UI.modal('��Ÿ? � COD �� Encaisser', `
                <div class="space-y-4">
                    <div class="p-4 bg-gradient-to-r from-amber-500 to-orange-500 rounded-xl text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm font-bold opacity-80">Total �� r�cup�rer</div>
                                <div class="text-3xl font-black">${CORE.formatPrice(totalAmount)}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-4xl font-black">${codOutstanding.length}</div>
                                <div class="text-sm font-bold opacity-80">commande(s)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-sm text-slate-600 p-3 bg-blue-50 border border-blue-200 rounded-xl">
                        <i data-lucide="info" class="w-4 h-4 inline text-blue-600"></i>
                        Ces commandes ont �t� <b>livr�es</b>. L'argent est avec le livreur. Cliquez "Encaiss�" quand vous r�cup�rez l'argent.
                    </div>
                    
                    <div class="space-y-3 max-h-[50vh] overflow-y-auto">
                        ${listHtml}
                    </div>
                    
                    ${codOutstanding.length > 0 ? `
                        <button onclick="GestionnaireModule.markAllCODCollected()" class="w-full px-4 py-3 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition">
                            ���?? Tout marquer comme encaiss�
                        </button>
                    ` : ''}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            
            setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 50);
        },
        
        // Marquer tous les COD comme encaiss�s
        markAllCODCollected() {
            const userPos = CORE.state.currentUser?.pos;
            
            const codOutstanding = CORE.db.orders.filter(o => 
                o.posId == userPos && 
                o.paymentMethod === 'cod' && 
                o.paymentStatus !== 'paid'
            ).filter(o => {
                const delivery = CORE.db.deliveries.find(d => d.orderId === o.id);
                return delivery && delivery.status === 'livree';
            });
            
            if (codOutstanding.length === 0) return;
            
            if (!confirm(`Marquer ${codOutstanding.length} commande(s) COD comme encaiss�es ?`)) return;
            
            let totalCollected = 0;
            codOutstanding.forEach(o => {
                const updated = CORE.update('orders', o.id, { 
                    paymentStatus: 'paid', 
                    codCollectedAt: new Date().toISOString(),
                    codCollectedBy: CORE.state.currentUser?.id,
                    codCollectedByName: CORE.state.currentUser?.name || 'Gestionnaire'
                });
                CORE.ensureSaleTransaction(updated);
                totalCollected += o.total || 0;
            });
            
            CORE.logActivity('COD_BATCH_COLLECTED', 'orders', null, {
                entityName: `${codOutstanding.length} commandes COD`,
                description: `${codOutstanding.length} COD encaiss�s pour un total de ${CORE.formatPrice(totalCollected)}`,
                amount: totalCollected,
                count: codOutstanding.length,
                posId: userPos,
                status: 'success'
            });
            
            UI.closeModal();
            UI.toast(`���?� ${codOutstanding.length} COD encaiss�s (${CORE.formatPrice(totalCollected)})`, 'success');
            App.rerender();
        }
    };

    // =========================================================
    // MODULE: MANAGER
    // =========================================================
    const ManagerModule = {
        state: {
            currentView: 'dashboard',
            theme: 'light',
            accentColor: 'blue',
            preferences: { notificationsEnabled: true, soundEnabled: true, soundVolume: 0.8 },
            inventoryTab: 'products', // products | movements
            inventorySearch: '',
            inventoryPosId: '', // Filter by POS
            movementsType: 'all',
            movementsSearch: '',
            
            // Inventory pagination
            inventoryPage: 1,
            inventoryPerPage: 50,
            inventoryCategoryFilter: 'all',
            inventoryStatusFilter: 'all',
            inventorySortBy: 'name',
            
            // Main stock pagination
            mainStockPage: 1,
            mainStockPerPage: 50,

            // Finance
            financeTab: 'overview', // overview | transactions | cod | commissions
            financeFrom: '',
            financeTo: '',
            financeSearch: '',
            financeType: 'all', // all | income | expense
            financeCategory: 'all',
            financeMethod: 'all',
            financeCityId: '',
            financePosId: '',

            // Team (Manager)
            teamSearch: '',
            teamRole: 'all', // all | gestionnaire | vendeur | livreur
            teamPosId: 'all',
            teamPage: 1,
            teamPerPage: 20,
            teamViewMode: 'list',
            teamSortBy: 'name',
            teamSortOrder: 'asc'
        },

        init() {
            // R�initialiser la vue et les filtres par d�faut
            this.state.currentView = 'dashboard';
            this.state.financeTab = 'overview';
            this.state.inventoryTab = 'products';
            this.state.inventorySearch = '';
            this.state.inventoryPosId = '';
            this.state.movementsType = 'all';
            this.state.movementsSearch = '';
            this.state.financeFrom = '';
            this.state.financeTo = '';
            this.state.financeSearch = '';
            this.state.financeType = 'all';
            this.state.financeCategory = 'all';
            this.state.financeMethod = 'all';
            this.state.financeCityId = '';
            this.state.financePosId = '';
            this.state.teamSearch = '';
            this.state.teamRole = 'all';
            this.state.teamPosId = 'all';
            this.state.teamPage = 1;
            this.state.inventoryPage = 1;
            this.state.mainStockPage = 1;
            
            // Charger le th��me pr�f�r�
            this.loadThemePreference();
        },

        navigateTo(view) {
            if (!CORE.canAccessView(view)) {
                return UI.toast('Acc��s refus�', 'error');
            }
            this.state.currentView = view;
            App.rerender();
        },

        // Afficher les d�tails d'une livraison avec preuves (Manager)
        showDeliveryDetail(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return UI.toast('Livraison introuvable', 'error');
            const livreur = d.livreurId ? CORE.getUser(d.livreurId) : null;
            const pos = d.posId ? CORE.getPOS(d.posId) : null;
            const badge = d.status === 'livree' ? UI.badge('Livr�e','emerald') :
                          d.status === 'probleme' ? UI.badge('Probl��me','red') :
                          d.status === 'en_attente' ? UI.badge('�?� assigner','blue') :
                          d.status === 'annulee' ? UI.badge('Annul�e','slate') : UI.badge('En cours','amber');
            
            const hasProofPhotos = d.proofPhotos && d.proofPhotos.length > 0;
            const hasProofSignature = !!d.proofSignature;
            const hasProof = hasProofPhotos || hasProofSignature;

            UI.modal(`��Ÿ? � Livraison ${d.orderRef}`, `
                <div class="space-y-4 max-h-[75vh] overflow-y-auto">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Statut</div>
                            <div class="mt-1">${badge}</div>
                        </div>
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-right">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Montant</div>
                            <div class="mt-1 text-2xl font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Client</div>
                        <div class="mt-1 font-black text-slate-900">${d.clientName || '�� ?��'}</div>
                        <div class="text-xs text-slate-600">${d.clientPhone || ''}</div>
                        <div class="mt-2 text-xs text-slate-600"><b>Adresse:</b> ${d.address || '�� ?��'}</div>
                        ${d.deliveryTime ? `<div class="mt-1 text-xs text-slate-600"><b>Heure:</b> ${d.deliveryTime}</div>` : ''}
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Livreur</div>
                        <div class="mt-1 font-black">${livreur?.name || 'Non assign�'}</div>
                        <div class="text-xs text-slate-600">${livreur?.phone || ''}</div>
                    </div>

                    ${pos ? `
                    <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-2xl">
                        <div class="text-xs font-black text-indigo-500 uppercase tracking-wider">Point de vente</div>
                        <div class="mt-1 font-black text-indigo-900">${pos.name}</div>
                        <div class="text-xs text-indigo-600">${CORE.getCity(pos.cityId)?.name || ''}</div>
                    </div>
                    ` : ''}

                    ${hasProof ? `
                    <!-- PREUVES DE LIVRAISON -->
                    <div class="p-4 bg-gradient-to-r from-emerald-50 to-teal-50 border-2 border-emerald-300 rounded-2xl">
                        <div class="text-xs font-black text-emerald-700 uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i data-lucide="camera" class="w-4 h-4"></i>
                            ��Ÿ? � Preuves de livraison
                        </div>
                        
                        ${hasProofPhotos ? `
                        <div class="mb-3">
                            <div class="text-xs font-bold text-emerald-600 mb-2">Photos (${d.proofPhotos.length})</div>
                            <div class="grid grid-cols-3 gap-2">
                                ${d.proofPhotos.map((photo, idx) => `
                                    <div class="aspect-square rounded-xl overflow-hidden border-2 border-emerald-300 cursor-pointer hover:border-emerald-500 transition shadow-md" onclick="window.open('${photo.replace(/'/g, "\\'")}', '_blank')">
                                        <img src="${photo}" class="w-full h-full object-cover hover:scale-105 transition" alt="Preuve ${idx + 1}">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${hasProofSignature ? `
                        <div>
                            <div class="text-xs font-bold text-emerald-600 mb-2">���? ��� � � Signature client</div>
                            <div class="p-3 bg-white rounded-xl border-2 border-blue-200 cursor-pointer hover:border-blue-400 transition" onclick="window.open('${d.proofSignature.replace(/'/g, "\\'")}', '_blank')">
                                <img src="${d.proofSignature}" class="w-full max-h-24 object-contain" alt="Signature">
                            </div>
                        </div>
                        ` : ''}
                        
                        ${d.proofNote ? `
                        <div class="mt-3 p-3 bg-white rounded-xl border border-emerald-200">
                            <div class="text-xs font-bold text-slate-500 mb-1">Note du livreur</div>
                            <div class="text-sm text-slate-700">${d.proofNote}</div>
                        </div>
                        ` : ''}
                        
                        <div class="text-center text-xs text-emerald-600 mt-3">
                            Valid�e le ${d.proofTimestamp ? new Date(d.proofTimestamp).toLocaleString('fr-FR') : (d.deliveredAt ? new Date(d.deliveredAt).toLocaleString('fr-FR') : '�� ?��')}
                        </div>
                    </div>
                    ` : (d.status === 'livree' ? `
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-center">
                        <div class="text-slate-400 text-sm">��Ÿ? � Aucune preuve de livraison disponible</div>
                    </div>
                    ` : '')}

                    ${d.recallReason ? `<div class="p-4 bg-amber-50 border border-amber-100 rounded-2xl text-xs text-amber-800"><b>Rappel:</b> ${d.recallReason}</div>` : ''}
                    ${d.recalledAt ? `<div class="text-xs text-slate-500">Rappel�e: ${CORE.formatDate(d.recalledAt)}</div>` : ''}
                    <div class="text-xs text-slate-500">Cr��e: ${CORE.formatDate(d.createdAt)}</div>
                    ${d.deliveredAt ? `<div class="text-xs text-emerald-600">Livr�e: ${CORE.formatDate(d.deliveredAt)}</div>` : ''}
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        setTheme(theme) {
            this.state.theme = theme;
            const userId = CORE.user?.id || 'default';
            localStorage.setItem(`manager_theme_${userId}`, theme);
            
            // Appliquer le th��me directement (style WhatsApp comme Vendeur)
            const html = document.documentElement;
            const body = document.body;

            html.classList.remove('manager-dark', 'manager-light', 'manager-auto');
            if (body) body.classList.remove('manager-dark', 'manager-light', 'manager-auto');
            html.style.filter = 'none';

            if (theme === 'dark') {
                html.classList.add('manager-dark');
                if (body) body.classList.add('manager-dark');
                html.style.backgroundColor = '#111b21';
            } else if (theme === 'light') {
                html.classList.add('manager-light');
                if (body) body.classList.add('manager-light');
                html.style.backgroundColor = '#ffffff';
            } else if (theme === 'auto') {
                html.classList.add('manager-auto');
                if (body) body.classList.add('manager-auto');
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.backgroundColor = isDark ? '#111b21' : '#ffffff';
                if (isDark) {
                    html.classList.add('manager-dark');
                    if (body) body.classList.add('manager-dark');
                }
            }
            
            UI.toast('Th��me: ' + (theme === 'light' ? 'Clair' : theme === 'dark' ? 'Sombre' : 'Auto'), 'success');
            App.rerender();
        },

        applyTheme() {
            const html = document.documentElement;
            const body = document.body;
            const theme = this.state.theme;

            html.classList.remove('manager-dark', 'manager-light', 'manager-auto');
            if (body) body.classList.remove('manager-dark', 'manager-light', 'manager-auto');
            html.style.filter = 'none';

            if (theme === 'dark') {
                html.classList.add('manager-dark');
                if (body) body.classList.add('manager-dark');
                html.style.backgroundColor = '#111b21';
            } else if (theme === 'light') {
                html.classList.add('manager-light');
                if (body) body.classList.add('manager-light');
                html.style.backgroundColor = '#ffffff';
            } else if (theme === 'auto') {
                html.classList.add('manager-auto');
                if (body) body.classList.add('manager-auto');
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.backgroundColor = isDark ? '#111b21' : '#ffffff';
                if (isDark) {
                    html.classList.add('manager-dark');
                    if (body) body.classList.add('manager-dark');
                }
            }
        },

        loadThemePreference() {
            const userId = CORE.user?.id || 'default';
            const saved = localStorage.getItem(`manager_theme_${userId}`);
            if (saved) {
                this.state.theme = saved;
                this.applyTheme();
            }
        },

        getMetrics() {
            const posId = CORE.state.currentUser?.pos || 1;
            const orders = CORE.db.orders.filter(o => o.posId === posId);
            const revenue = orders.filter(o => o.status === 'delivered').reduce((a,o)=>a+(o.total||0),0);
            const pending = orders.filter(o => o.status === 'pending').length;
            
            // Calculer lowStock avec le stock r�el du POS
            const lowStock = CORE.db.products.filter(p => {
                if (p.isMainWarehouse) return false;
                const belongsToPos = p.posId == posId;
                const hasStockInPos = p.posStocks && p.posStocks[posId] && p.posStocks[posId].stock > 0;
                if (!belongsToPos && !hasStockInPos) return false;
                const stock = p.posStocks && p.posStocks[posId] ? p.posStocks[posId].stock : (belongsToPos ? (p.stock || 0) : 0);
                const minStock = p.minStock || 0;
                return stock <= minStock;
            }).length;
            
            return { revenue, ordersCount: orders.length, pending, lowStock };
        },

        getKPIs() {
            const posId = CORE.state.currentUser?.pos || 1;
            const orders = CORE.db.orders.filter(o => o.posId === posId);
            const completedOrders = orders.filter(o => o.status === 'delivered');
            const revenue = completedOrders.reduce((a,o)=>a+(o.total||0),0);
            const conversionRate = orders.length > 0 ? ((completedOrders.length / orders.length) * 100).toFixed(1) : 0;
            const avgBasket = completedOrders.length > 0 ? (revenue / completedOrders.length).toFixed(2) : 0;
            
            return {
                totalOrders: orders.length,
                completedOrders: completedOrders.length,
                revenue: revenue,
                conversionRate: conversionRate,
                avgBasket: avgBasket,
                avgDeliveryTime: 2.5 // jours
            };
        },

        getWeeklyComparison() {
            const posId = CORE.state.currentUser?.pos || 1;
            const now = new Date();
            const currentWeekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
            const previousWeekStart = new Date(currentWeekStart.getTime() - 7 * 24 * 60 * 60 * 1000);
            const previousWeekEnd = new Date(currentWeekStart.getTime() - 1);

            const currentOrders = CORE.db.orders.filter(o => {
                const d = new Date(o.createdAt);
                return o.posId === posId && d >= currentWeekStart && o.status === 'delivered';
            });

            const previousOrders = CORE.db.orders.filter(o => {
                const d = new Date(o.createdAt);
                return o.posId === posId && d >= previousWeekStart && d <= previousWeekEnd && o.status === 'delivered';
            });

            const currentRevenue = currentOrders.reduce((a,o)=>a+(o.total||0),0);
            const previousRevenue = previousOrders.reduce((a,o)=>a+(o.total||0),0);
            const revenueChange = previousRevenue > 0 ? (((currentRevenue - previousRevenue) / previousRevenue) * 100).toFixed(1) : 0;
            const ordersChange = previousOrders.length > 0 ? (((currentOrders.length - previousOrders.length) / previousOrders.length) * 100).toFixed(1) : 0;

            return {
                currentRevenue, previousRevenue, revenueChange,
                currentOrders: currentOrders.length, previousOrders: previousOrders.length, ordersChange
            };
        },

        getDailyTrends(days = 7) {
            const posId = CORE.state.currentUser?.pos || 1;
            const trends = [];
            const today = new Date();

            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth(), today.getDate() - i);
                const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const dayEnd = new Date(dayStart.getTime() + 24 * 60 * 60 * 1000);

                const dayOrders = CORE.db.orders.filter(o => {
                    const d = new Date(o.createdAt);
                    return o.posId === posId && d >= dayStart && d < dayEnd && o.status === 'delivered';
                });

                const revenue = dayOrders.reduce((a,o)=>a+(o.total||0),0);
                trends.push({
                    date: date.toLocaleDateString('fr-FR', {weekday: 'short', month: 'short', day: 'numeric'}),
                    revenue: revenue,
                    orders: dayOrders.length,
                    avgOrder: dayOrders.length > 0 ? (revenue / dayOrders.length).toFixed(0) : 0
                });
            }
            return trends;
        },

        getHourlyDistribution() {
            const posId = CORE.state.currentUser?.pos || 1;
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
            
            const hourlyData = Array(24).fill(0);
            const orders = (CORE.db.orders || []).filter(o => {
                const d = new Date(o.createdAt);
                return o.posId === posId && d >= startOfDay;
            });
            
            orders.forEach(o => {
                const hour = new Date(o.createdAt).getHours();
                hourlyData[hour]++;
            });
            
            return hourlyData;
        },

        getTopPerformers() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            // Vendeurs
            const vendeurs = (CORE.db.users || []).filter(u => u.active && u.role === 'vendeur');
            const vendeurPerf = vendeurs.map(v => {
                const orders = (CORE.db.orders || []).filter(o => 
                    o.vendeurId === v.id && 
                    new Date(o.createdAt) >= thirtyDaysAgo &&
                    o.status === 'delivered'
                );
                const revenue = orders.reduce((s, o) => s + (o.total || 0), 0);
                return { ...v, orders: orders.length, revenue };
            }).sort((a, b) => b.revenue - a.revenue);
            
            // Livreurs
            const livreurs = (CORE.db.users || []).filter(u => u.active && u.role === 'livreur');
            const livreurPerf = livreurs.map(l => {
                const deliveries = (CORE.db.deliveries || []).filter(d => 
                    d.livreurId === l.id && 
                    new Date(d.completedAt || d.createdAt) >= thirtyDaysAgo
                );
                const completed = deliveries.filter(d => d.status === 'livree').length;
                const failed = deliveries.filter(d => ['failed', 'returned'].includes(d.status)).length;
                const successRate = deliveries.length > 0 ? Math.round((completed / deliveries.length) * 100) : 0;
                return { ...l, deliveries: deliveries.length, completed, failed, successRate };
            }).sort((a, b) => b.completed - a.completed);
            
            return { vendeurs: vendeurPerf.slice(0, 5), livreurs: livreurPerf.slice(0, 5) };
        },

        getCategoryBreakdown() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            const posId = CORE.state.currentUser?.pos || 1;
            
            const orders = (CORE.db.orders || []).filter(o => 
                o.posId === posId && 
                new Date(o.createdAt) >= thirtyDaysAgo && 
                o.status === 'delivered'
            );
            
            const catMap = {};
            orders.forEach(o => {
                (o.items || []).forEach(item => {
                    const product = (CORE.db.products || []).find(p => p.id === item.productId);
                    const catId = product?.categoryId || 0;
                    const cat = (CORE.db.categories || []).find(c => c.id === catId);
                    const catName = cat?.name || 'Autre';
                    
                    if (!catMap[catName]) catMap[catName] = { qty: 0, revenue: 0 };
                    catMap[catName].qty += item.qty || 0;
                    catMap[catName].revenue += (item.qty || 0) * (item.price || 0);
                });
            });
            
            return Object.entries(catMap)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.revenue - a.revenue);
        },

        renderAnalyticsDashboard() {
            const kpis = this.getKPIs();
            const weekly = this.getWeeklyComparison();
            const trends7 = this.getDailyTrends(7);
            const trends30 = this.getDailyTrends(30);
            const hourly = this.getHourlyDistribution();
            const performers = this.getTopPerformers();
            const categories = this.getCategoryBreakdown();

            // Top produits (30 derniers jours)
            const days = 30;
            const today = new Date();
            const past = new Date(today.getFullYear(), today.getMonth(), today.getDate() - days);
            const recentDelivered = CORE.db.orders.filter(o => o.status === 'delivered' && new Date(o.createdAt) >= past);
            const prodMap = {};
            recentDelivered.forEach(o => {
                const items = o.items || [];
                items.forEach(it => {
                    const name = it.name || 'Produit';
                    prodMap[name] = prodMap[name] || { qty: 0, revenue: 0 };
                    prodMap[name].qty += (it.qty || 0);
                    prodMap[name].revenue += (it.qty || 0) * (it.price || 0);
                });
            });
            const topProducts = Object.entries(prodMap).map(([name, v]) => ({ name, qty: v.qty, revenue: v.revenue })).sort((a,b)=>b.revenue - a.revenue).slice(0,5);

            // Calculer lowStock avec le stock global (Manager voit tout)
            const lowStock = (CORE.db.products || []).filter(p => {
                const stock = p.stock || 0;
                const minStock = p.minStock || 0;
                return stock <= minStock;
            }).slice(0,5);

            // Sparkline avec zone remplie pour revenue 7j
            const rev7 = trends7.map(t => t.revenue);
            const maxRev7 = Math.max(...rev7, 1);
            const points7 = rev7.map((v,i)=>`${i*(100/(rev7.length-1))},${100 - Math.round((v/maxRev7)*100)}`).join(' ');
            const areaPoints7 = `0,100 ${points7} 100,100`;

            // Orders sparkline
            const ord7 = trends7.map(t => t.orders);
            const maxOrd7 = Math.max(...ord7,1);
            const pointsOrd7 = ord7.map((v,i)=>`${i*(100/(ord7.length-1))},${100 - Math.round((v/maxOrd7)*100)}`).join(' ');
            const areaPointsOrd7 = `0,100 ${pointsOrd7} 100,100`;

            // Barres horaires
            const maxHourly = Math.max(...hourly, 1);
            const peakHour = hourly.indexOf(maxHourly);

            // Couleurs cat�gories
            const catColors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];

            // Objectif mensuel (exemple bas� sur moyenne)
            const avgDailyRev = kpis.revenue / 30;
            const monthlyTarget = avgDailyRev * 30 * 1.1; // +10% objectif
            const progressPercent = Math.min(100, Math.round((kpis.revenue / monthlyTarget) * 100));

            return `
                <div class="max-w-7xl mx-auto space-y-6 fade-in p-6">
                    <!-- Header -->
                    <header class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">��Ÿ?Š Tableau de Bord Analytique</h2>
                            <p class="text-slate-500 font-medium">Analyse approfondie des performances �� ?� � ${new Date().toLocaleDateString('fr-FR')}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <select onchange="ManagerModule.analyticsPeriod = this.value; App.rerender();" class="px-4 py-2 border border-slate-200 rounded-xl font-bold text-sm bg-white">
                                <option value="7">7 derniers jours</option>
                                <option value="30" selected>30 derniers jours</option>
                                <option value="90">90 derniers jours</option>
                            </select>
                            <button onclick="App.rerender()" class="px-4 py-2 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </header>

                    <!-- Objectif Mensuel -->
                    <div class="bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-2xl p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <div class="text-white/80 font-bold text-sm">��ŸŽ � Objectif Mensuel</div>
                                <div class="text-3xl font-black">${CORE.formatPrice(kpis.revenue)} <span class="text-lg text-white/70">/ ${CORE.formatPrice(monthlyTarget)}</span></div>
                            </div>
                            <div class="text-right">
                                <div class="text-5xl font-black">${progressPercent}%</div>
                                <div class="text-white/70 text-sm">${progressPercent >= 100 ? '��ŸŽ� Objectif atteint!' : progressPercent >= 80 ? '��Ÿ� � Presque!' : 'En progression'}</div>
                            </div>
                        </div>
                        <div class="w-full h-4 bg-white/20 rounded-full overflow-hidden">
                            <div class="h-full bg-white rounded-full transition-all duration-1000" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>

                    <!-- KPIs Principaux -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm hover:shadow-md transition">
                            <div class="flex items-center justify-between">
                                <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="trending-up" class="w-6 h-6 text-emerald-600"></i>
                                </div>
                                <span class="px-2 py-1 text-xs font-bold rounded-lg ${weekly.revenueChange >= 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
                                    ${weekly.revenueChange >= 0 ? '���?' : '���?'} ${Math.abs(weekly.revenueChange)}%
                                </span>
                            </div>
                            <div class="mt-3">
                                <div class="text-2xl font-black text-slate-900">${CORE.formatPrice(kpis.revenue)}</div>
                                <div class="text-xs font-bold text-slate-500 uppercase">Chiffre d'affaires</div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm hover:shadow-md transition">
                            <div class="flex items-center justify-between">
                                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="shopping-cart" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <span class="px-2 py-1 text-xs font-bold rounded-lg ${weekly.ordersChange >= 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
                                    ${weekly.ordersChange >= 0 ? '���?' : '���?'} ${Math.abs(weekly.ordersChange)}%
                                </span>
                            </div>
                            <div class="mt-3">
                                <div class="text-2xl font-black text-slate-900">${kpis.totalOrders}</div>
                                <div class="text-xs font-bold text-slate-500 uppercase">Commandes</div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm hover:shadow-md transition">
                            <div class="flex items-center justify-between">
                                <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="receipt" class="w-6 h-6 text-amber-600"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="text-2xl font-black text-slate-900">${CORE.formatPrice(kpis.avgBasket)}</div>
                                <div class="text-xs font-bold text-slate-500 uppercase">Panier moyen</div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm hover:shadow-md transition">
                            <div class="flex items-center justify-between">
                                <div class="w-12 h-12 bg-violet-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="percent" class="w-6 h-6 text-violet-600"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="text-2xl font-black text-slate-900">${kpis.conversionRate}%</div>
                                <div class="text-xs font-bold text-slate-500 uppercase">Taux conversion</div>
                            </div>
                        </div>
                    </div>

                    <!-- Graphiques principaux -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Graphique Revenu 7j -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <div class="font-black text-slate-900">��Ÿ? � �volution du revenu</div>
                                    <div class="text-xs text-slate-500">7 derniers jours</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xl font-black text-emerald-600">${CORE.formatPrice(rev7.reduce((a,b)=>a+b,0))}</div>
                                    <div class="text-xs text-slate-400">Total p�riode</div>
                                </div>
                            </div>
                            <div class="relative">
                                <svg viewBox="0 0 100 60" class="w-full h-32">
                                    <defs>
                                        <linearGradient id="revGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style="stop-color:#10b981;stop-opacity:0.3"/>
                                            <stop offset="100%" style="stop-color:#10b981;stop-opacity:0"/>
                                        </linearGradient>
                                    </defs>
                                    <polygon fill="url(#revGradient)" points="${areaPoints7.split(' ').map(p => { const [x,y] = p.split(','); return `${x},${Math.min(60, y * 0.6)}`; }).join(' ')}"/>
                                    <polyline fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" points="${points7.split(' ').map(p => { const [x,y] = p.split(','); return `${x},${y * 0.6}`; }).join(' ')}"/>
                                    ${rev7.map((v, i) => `<circle cx="${i*(100/(rev7.length-1))}" cy="${(100 - Math.round((v/maxRev7)*100)) * 0.6}" r="3" fill="#10b981"/>`).join('')}
                                </svg>
                                <div class="flex justify-between text-[10px] text-slate-400 mt-2">
                                    ${trends7.map(t => `<span>${t.date.split(' ')[0]}</span>`).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Graphique Commandes 7j -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <div class="font-black text-slate-900">��Ÿ? � Volume de commandes</div>
                                    <div class="text-xs text-slate-500">7 derniers jours</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xl font-black text-blue-600">${ord7.reduce((a,b)=>a+b,0)}</div>
                                    <div class="text-xs text-slate-400">Total commandes</div>
                                </div>
                            </div>
                            <div class="relative">
                                <svg viewBox="0 0 100 60" class="w-full h-32">
                                    <defs>
                                        <linearGradient id="ordGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.3"/>
                                            <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0"/>
                                        </linearGradient>
                                    </defs>
                                    <polygon fill="url(#ordGradient)" points="${areaPointsOrd7.split(' ').map(p => { const [x,y] = p.split(','); return `${x},${Math.min(60, y * 0.6)}`; }).join(' ')}"/>
                                    <polyline fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" points="${pointsOrd7.split(' ').map(p => { const [x,y] = p.split(','); return `${x},${y * 0.6}`; }).join(' ')}"/>
                                    ${ord7.map((v, i) => `<circle cx="${i*(100/(ord7.length-1))}" cy="${(100 - Math.round((v/maxOrd7)*100)) * 0.6}" r="3" fill="#3b82f6"/>`).join('')}
                                </svg>
                                <div class="flex justify-between text-[10px] text-slate-400 mt-2">
                                    ${trends7.map(t => `<span>${t.date.split(' ')[0]}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Distribution horaire + Cat�gories -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Heures de pointe -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <div class="font-black text-slate-900">�� � � Heures de pointe</div>
                                    <div class="text-xs text-slate-500">Distribution des ventes par heure</div>
                                </div>
                                <div class="px-3 py-1 bg-amber-100 text-amber-700 rounded-lg text-xs font-bold">
                                    Peak: ${peakHour}h00
                                </div>
                            </div>
                            <div class="flex items-end gap-1 h-24">
                                ${hourly.slice(6, 22).map((count, i) => {
                                    const hour = i + 6;
                                    const height = maxHourly > 0 ? (count / maxHourly) * 100 : 0;
                                    const isPeak = hour === peakHour;
                                    return `
                                        <div class="flex-1 flex flex-col items-center gap-1">
                                            <div class="w-full ${isPeak ? 'bg-amber-500' : 'bg-slate-200'} rounded-t transition-all hover:bg-amber-400" style="height: ${Math.max(4, height)}%" title="${hour}h: ${count} commandes"></div>
                                            <span class="text-[8px] text-slate-400">${hour}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- R�partition par cat�gorie -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <div class="font-black text-slate-900">��Ÿ?Š Ventes par cat�gorie</div>
                                    <div class="text-xs text-slate-500">Top cat�gories (30j)</div>
                                </div>
                            </div>
                            <div class="space-y-3">
                                ${categories.slice(0, 5).map((cat, i) => {
                                    const maxCatRev = categories[0]?.revenue || 1;
                                    const width = Math.round((cat.revenue / maxCatRev) * 100);
                                    return `
                                        <div>
                                            <div class="flex items-center justify-between text-sm mb-1">
                                                <span class="font-bold text-slate-700">${cat.name}</span>
                                                <span class="font-black text-slate-900">${CORE.formatPrice(cat.revenue)}</span>
                                            </div>
                                            <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                                                <div class="h-full rounded-full" style="width: ${width}%; background: ${catColors[i % catColors.length]}"></div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                                ${categories.length === 0 ? '<div class="text-center text-slate-400 py-4">Aucune donn�e</div>' : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Performance �quipe -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Top Vendeurs -->
                        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-4 bg-gradient-to-r from-emerald-500 to-teal-600 text-white">
                                <div class="font-black">��Ÿ �� Top Vendeurs</div>
                                <div class="text-xs text-emerald-100">Classement par chiffre d'affaires (30j)</div>
                            </div>
                            <div class="p-4 space-y-3">
                                ${performers.vendeurs.length === 0 ? '<div class="text-center text-slate-400 py-4">Aucun vendeur</div>' : performers.vendeurs.map((v, i) => `
                                    <div class="flex items-center gap-3 p-3 ${i === 0 ? 'bg-amber-50 border border-amber-200' : 'bg-slate-50'} rounded-xl">
                                        <div class="w-8 h-8 rounded-full ${i === 0 ? 'bg-amber-500' : i === 1 ? 'bg-slate-400' : i === 2 ? 'bg-amber-700' : 'bg-slate-300'} flex items-center justify-center text-white font-black text-sm">
                                            ${i < 3 ? ['��Ÿ ��','��Ÿ ��?','��Ÿ ��'][i] : i + 1}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-slate-900 truncate">${v.name}</div>
                                            <div class="text-xs text-slate-500">${v.orders} commandes</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-emerald-600">${CORE.formatPrice(v.revenue)}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Top Livreurs -->
                        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                                <div class="font-black">��Ÿš � Top Livreurs</div>
                                <div class="text-xs text-blue-100">Classement par livraisons r�ussies (30j)</div>
                            </div>
                            <div class="p-4 space-y-3">
                                ${performers.livreurs.length === 0 ? '<div class="text-center text-slate-400 py-4">Aucun livreur</div>' : performers.livreurs.map((l, i) => `
                                    <div class="flex items-center gap-3 p-3 ${i === 0 ? 'bg-blue-50 border border-blue-200' : 'bg-slate-50'} rounded-xl">
                                        <div class="w-8 h-8 rounded-full ${i === 0 ? 'bg-blue-500' : i === 1 ? 'bg-slate-400' : i === 2 ? 'bg-blue-700' : 'bg-slate-300'} flex items-center justify-center text-white font-black text-sm">
                                            ${i < 3 ? ['��Ÿ ��','��Ÿ ��?','��Ÿ ��'][i] : i + 1}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-slate-900 truncate">${l.name}</div>
                                            <div class="text-xs text-slate-500">${l.deliveries} livraisons</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-blue-600">${l.completed}</div>
                                            <div class="text-xs ${l.successRate >= 90 ? 'text-emerald-500' : l.successRate >= 70 ? 'text-amber-500' : 'text-red-500'}">${l.successRate}% r�ussite</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Top produits + Stock bas -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div class="font-black text-slate-900">��Ÿ� � Top produits (30j)</div>
                                <div class="text-xs text-slate-400">Par revenu g�n�r�</div>
                            </div>
                            <div class="space-y-3">
                                ${topProducts.length === 0 ? '<div class="text-center text-slate-400 py-4">Aucune vente</div>' : topProducts.map((p, i) => `
                                    <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl">
                                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center text-white font-black text-sm">${i + 1}</div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-slate-900 truncate">${p.name}</div>
                                            <div class="text-xs text-slate-500">${p.qty} vendus</div>
                                        </div>
                                        <div class="font-black text-slate-900">${CORE.formatPrice(p.revenue)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div class="font-black text-slate-900">��š ��� � � Alertes stock</div>
                                <div class="px-2 py-1 bg-red-100 text-red-700 rounded-lg text-xs font-bold">${lowStock.length} produits</div>
                            </div>
                            <div class="space-y-3">
                                ${lowStock.length === 0 ? '<div class="text-center text-emerald-500 py-4">���?� Tous les stocks sont OK!</div>' : lowStock.map(p => `
                                    <div class="flex items-center justify-between p-3 bg-red-50 border border-red-200 rounded-xl">
                                        <div>
                                            <div class="font-bold text-red-900">${p.name}</div>
                                            <div class="text-xs text-red-600">Min: ${p.minStock}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-2xl font-black ${p.stock <= 0 ? 'text-red-600' : 'text-amber-600'}">${p.stock}</div>
                                            <div class="text-[10px] text-red-500">${p.stock <= 0 ? 'RUPTURE' : 'Faible'}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Comparaison semaine -->
                    <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl p-6 text-white">
                        <div class="font-black text-lg mb-4">��Ÿ?�? Comparaison Hebdomadaire</div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-white/10 rounded-xl p-4">
                                <div class="text-white/70 text-xs font-bold">Revenu cette semaine</div>
                                <div class="text-2xl font-black mt-1">${CORE.formatPrice(weekly.currentRevenue)}</div>
                            </div>
                            <div class="bg-white/10 rounded-xl p-4">
                                <div class="text-white/70 text-xs font-bold">Semaine pr�c�dente</div>
                                <div class="text-2xl font-black mt-1">${CORE.formatPrice(weekly.previousRevenue)}</div>
                            </div>
                            <div class="bg-white/10 rounded-xl p-4">
                                <div class="text-white/70 text-xs font-bold">�volution revenu</div>
                                <div class="text-2xl font-black mt-1 ${weekly.revenueChange >= 0 ? 'text-emerald-400' : 'text-red-400'}">${weekly.revenueChange >= 0 ? '+' : ''}${weekly.revenueChange}%</div>
                            </div>
                            <div class="bg-white/10 rounded-xl p-4">
                                <div class="text-white/70 text-xs font-bold">�volution commandes</div>
                                <div class="text-2xl font-black mt-1 ${weekly.ordersChange >= 0 ? 'text-emerald-400' : 'text-red-400'}">${weekly.ordersChange >= 0 ? '+' : ''}${weekly.ordersChange}%</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },


        renderDashboard() {
            // Dashboard MULTI-POS pour Manager
            const allPos = CORE.db.pointsOfSale || [];
            const selectedPosId = CORE.state.currentUser?.pos || null;
            
            // Calculer m�triques pour CHAQUE POS
            const posMetrics = allPos.map(pos => {
                const orders = CORE.db.orders.filter(o => o.posId === pos.id);
                const deliveredOrders = orders.filter(o => o.status === 'delivered');
                const revenue = deliveredOrders.reduce((a,o)=>a+(o.total||0),0);
                
                // Produits du POS: ceux qui lui appartiennent OU qui ont du stock via posStocks
                const products = CORE.db.products.filter(p => {
                    if (p.posId === pos.id) return true;
                    if (p.posStocks && p.posStocks[pos.id] && p.posStocks[pos.id].stock > 0) return true;
                    return false;
                });
                
                // Calculer lowStock avec le stock r�el du POS
                const lowStock = products.filter(p => {
                    const stock = p.posStocks && p.posStocks[pos.id] ? p.posStocks[pos.id].stock : (p.posId === pos.id ? (p.stock || 0) : 0);
                    const minStock = p.minStock || 0;
                    return stock <= minStock;
                }).length;
                
                const staff = CORE.db.users.filter(u => u.pos === pos.id && u.active);
                
                return {
                    pos,
                    orders: orders.length,
                    revenue,
                    lowStock,
                    staff: staff.length,
                    gestionnaire: staff.find(u => u.role === 'gestionnaire'),
                    vendeur: staff.find(u => u.role === 'vendeur'),
                    livreur: staff.find(u => u.role === 'livreur')
                };
            });
            
            // Totaux consolid�s
            const totalRevenue = posMetrics.reduce((a,m)=>a+m.revenue,0);
            const totalOrders = posMetrics.reduce((a,m)=>a+m.orders,0);
            const totalLowStock = posMetrics.reduce((a,m)=>a+m.lowStock,0);
            const avgBasket = totalOrders > 0 ? (totalRevenue / totalOrders) : 0;
            
            // Statistiques suppl�mentaires
            const totalProducts = CORE.db.products.filter(p => !p.isMainWarehouse).length;
            const deliveriesInProgress = CORE.db.deliveries?.filter(d => d.status === 'en_cours').length || 0;
            const deliveriesToAssign = CORE.db.deliveries?.filter(d => d.status === 'en_attente').length || 0;
            const pendingOrders = CORE.db.orders.filter(o => ['pending','confirmed'].includes(o.status)).length;
            
            // R�partition des commandes par statut
            const ordersByStatus = {
                delivered: CORE.db.orders.filter(o => o.status === 'delivered').length,
                pending: CORE.db.orders.filter(o => o.status === 'pending').length,
                confirmed: CORE.db.orders.filter(o => o.status === 'confirmed').length,
                delivering: CORE.db.orders.filter(o => o.status === 'delivering').length,
                cancelled: CORE.db.orders.filter(o => o.status === 'cancelled').length
            };
            const totalOrdersForChart = Object.values(ordersByStatus).reduce((a,b)=>a+b,0) || 1;
            
            // Tendances 7 derniers jours
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().slice(0, 10);
                const dayOrders = CORE.db.orders.filter(o => o.createdAt?.slice(0, 10) === dateStr && o.status === 'delivered');
                const dayRevenue = dayOrders.reduce((a, o) => a + (o.total || 0), 0);
                last7Days.push({ day: date.toLocaleDateString('fr-FR', { weekday: 'short' }).slice(0, 3), date: dateStr, revenue: dayRevenue, count: dayOrders.length });
            }
            const maxDayRevenue = Math.max(...last7Days.map(d => d.revenue), 1);
            
            // Alertes critiques
            const criticalAlerts = [];
            if (totalLowStock > 0) criticalAlerts.push({ color: 'red', icon: 'alert-triangle', msg: `${totalLowStock} produit(s) en stock critique`, action: "ManagerModule.navigateTo('inventory')" });
            if (pendingOrders > 5) criticalAlerts.push({ color: 'amber', icon: 'clock', msg: `${pendingOrders} commandes en attente`, action: "ManagerModule.navigateTo('orders')" });
            if (deliveriesToAssign > 0) criticalAlerts.push({ color: 'blue', icon: 'user-plus', msg: `${deliveriesToAssign} livraison(s) �� assigner`, action: "ManagerModule.navigateTo('deliveries')" });
            
            // Top 3 POS par CA
            const topPOS = [...posMetrics].sort((a,b) => b.revenue - a.revenue).slice(0, 3);

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <!-- Header avec date et actions -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                                    <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                                </div>
                                Tableau de Bord Manager
                            </h2>
                            <p class="text-slate-500 font-medium mt-2 flex items-center gap-2">
                                <i data-lucide="calendar" class="w-4 h-4"></i>
                                ${new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                <span class="text-slate-300">�� ?� �</span>
                                <span class="text-indigo-600 font-bold">${allPos.length} points de vente</span>
                            </p>
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                            <button onclick="App.rerender()" class="px-4 py-2.5 bg-white border border-slate-200 text-slate-700 font-bold rounded-xl hover:bg-slate-50 transition flex items-center gap-2 shadow-sm">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Actualiser
                            </button>
                            <button onclick="ManagerModule.navigateTo('mainStock')" class="px-4 py-2.5 bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-black rounded-xl hover:from-purple-600 hover:to-indigo-700 transition flex items-center gap-2 shadow-lg shadow-purple-500/30">
                                <i data-lucide="warehouse" class="w-4 h-4"></i> D�p��t Principal
                            </button>
                        </div>
                    </div>

                    <!-- Alertes critiques -->
                    ${criticalAlerts.length > 0 ? `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            ${criticalAlerts.map(alert => `
                                <button onclick="${alert.action}" class="p-4 rounded-2xl border-2 border-${alert.color}-300 bg-gradient-to-br from-${alert.color}-50 to-${alert.color}-100 flex items-center gap-3 hover:shadow-lg transition-all hover:scale-[1.02] text-left w-full group">
                                    <div class="w-12 h-12 bg-${alert.color}-200 rounded-xl flex items-center justify-center flex-shrink-0 shadow-sm group-hover:scale-110 transition">
                                        <i data-lucide="${alert.icon}" class="w-6 h-6 text-${alert.color}-700"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-black text-${alert.color}-900 text-sm">${alert.msg}</div>
                                        <div class="text-xs text-${alert.color}-700 flex items-center gap-1 mt-0.5">
                                            <i data-lucide="arrow-right" class="w-3 h-3"></i> Cliquer pour g�rer
                                        </div>
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- KPIs Principaux avec gradients -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-5 text-white shadow-lg shadow-emerald-500/30 relative overflow-hidden group hover:scale-[1.02] transition cursor-pointer" onclick="ManagerModule.navigateTo('orders')">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8 group-hover:scale-125 transition"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-up" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">CA Total</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(totalRevenue)}</div>
                                <div class="text-xs opacity-70 mt-2">Panier moyen: ${CORE.formatPrice(Math.round(avgBasket))}</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-5 text-white shadow-lg shadow-blue-500/30 relative overflow-hidden group hover:scale-[1.02] transition cursor-pointer" onclick="ManagerModule.navigateTo('orders')">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8 group-hover:scale-125 transition"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="shopping-cart" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Commandes</span>
                                </div>
                                <div class="text-3xl font-black">${totalOrders}</div>
                                <div class="text-xs opacity-70 mt-2">${ordersByStatus.delivered} livr�es �� ?� � ${pendingOrders} en cours</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-violet-600 rounded-2xl p-5 text-white shadow-lg shadow-purple-500/30 relative overflow-hidden group hover:scale-[1.02] transition cursor-pointer" onclick="ManagerModule.navigateTo('inventory')">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8 group-hover:scale-125 transition"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="package" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Produits</span>
                                </div>
                                <div class="text-3xl font-black">${totalProducts}</div>
                                <div class="text-xs opacity-70 mt-2">${allPos.length} points de vente</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br ${totalLowStock > 0 ? 'from-red-500 to-red-600 shadow-red-500/30' : 'from-slate-500 to-slate-600 shadow-slate-500/30'} rounded-2xl p-5 text-white shadow-lg relative overflow-hidden group hover:scale-[1.02] transition cursor-pointer" onclick="ManagerModule.navigateTo('inventory')">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8 group-hover:scale-125 transition"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="alert-triangle" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Alertes Stock</span>
                                </div>
                                <div class="text-3xl font-black">${totalLowStock}</div>
                                <div class="text-xs opacity-70 mt-2">${totalLowStock > 0 ? 'Produits critiques!' : 'Tout est OK'}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions Rapides et Tendances -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Actions Rapides -->
                        <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-5 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white">
                                <h3 class="font-black text-slate-900 flex items-center gap-2">
                                    <i data-lucide="zap" class="w-5 h-5 text-amber-500"></i>
                                    Actions Rapides
                                </h3>
                            </div>
                            <div class="p-4 space-y-2">
                                <button onclick="ManagerModule.navigateTo('inventory')" class="w-full p-4 rounded-2xl bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-100 hover:border-purple-300 transition flex items-center gap-3 group">
                                    <div class="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center text-white shadow-sm group-hover:scale-110 transition">
                                        <i data-lucide="package" class="w-5 h-5"></i>
                                    </div>
                                    <div class="flex-1 text-left">
                                        <div class="font-black text-purple-900">Inventaire POS</div>
                                        <div class="text-xs text-purple-600">G�rer les stocks par point de vente</div>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-5 h-5 text-purple-400 group-hover:translate-x-1 transition"></i>
                                </button>
                                <button onclick="ManagerModule.navigateTo('mainStock')" class="w-full p-4 rounded-2xl bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-100 hover:border-amber-300 transition flex items-center gap-3 group">
                                    <div class="w-10 h-10 bg-amber-500 rounded-xl flex items-center justify-center text-white shadow-sm group-hover:scale-110 transition">
                                        <i data-lucide="warehouse" class="w-5 h-5"></i>
                                    </div>
                                    <div class="flex-1 text-left">
                                        <div class="font-black text-amber-900">D�p��t Principal</div>
                                        <div class="text-xs text-amber-600">Stock central et transferts</div>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-5 h-5 text-amber-400 group-hover:translate-x-1 transition"></i>
                                </button>
                                <button onclick="ManagerModule.navigateTo('orders')" class="w-full p-4 rounded-2xl bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 hover:border-blue-300 transition flex items-center gap-3 group">
                                    <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center text-white shadow-sm group-hover:scale-110 transition">
                                        <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                                    </div>
                                    <div class="flex-1 text-left">
                                        <div class="font-black text-blue-900">Commandes</div>
                                        <div class="text-xs text-blue-600">${pendingOrders} en attente de traitement</div>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-5 h-5 text-blue-400 group-hover:translate-x-1 transition"></i>
                                </button>
                                <button onclick="ManagerModule.navigateTo('deliveries')" class="w-full p-4 rounded-2xl bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-100 hover:border-emerald-300 transition flex items-center gap-3 group">
                                    <div class="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center text-white shadow-sm group-hover:scale-110 transition">
                                        <i data-lucide="truck" class="w-5 h-5"></i>
                                    </div>
                                    <div class="flex-1 text-left">
                                        <div class="font-black text-emerald-900">Livraisons</div>
                                        <div class="text-xs text-emerald-600">${deliveriesInProgress} en cours �� ?� � ${deliveriesToAssign} �� assigner</div>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-5 h-5 text-emerald-400 group-hover:translate-x-1 transition"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Tendances CA 7 jours -->
                        <div class="lg:col-span-2 bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-gradient-to-r from-slate-50 to-white">
                                <div>
                                    <h3 class="font-black text-slate-900 flex items-center gap-2">
                                        <i data-lucide="bar-chart-3" class="w-5 h-5 text-indigo-500"></i>
                                        Tendance CA (7 jours)
                                    </h3>
                                    <div class="text-xs text-slate-500 mt-0.5">�volution du chiffre d'affaires quotidien</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-black text-slate-900">${CORE.formatPrice(last7Days.reduce((a,d) => a + d.revenue, 0))}</div>
                                    <div class="text-xs text-slate-500">Total 7 jours</div>
                                </div>
                            </div>
                            <div class="p-5 space-y-3">
                                ${last7Days.map((d, i) => {
                                    const percent = (d.revenue / maxDayRevenue) * 100;
                                    const isToday = i === last7Days.length - 1;
                                    return `
                                        <div class="flex items-center gap-3 ${isToday ? 'bg-indigo-50 -mx-2 px-2 py-2 rounded-xl' : ''}">
                                            <span class="text-xs font-black ${isToday ? 'text-indigo-700' : 'text-slate-600'} w-12 uppercase">${d.day}</span>
                                            <div class="flex-1 h-8 bg-slate-100 rounded-lg overflow-hidden relative">
                                                <div class="absolute inset-y-0 left-0 ${isToday ? 'bg-gradient-to-r from-indigo-500 to-purple-500' : 'bg-gradient-to-r from-slate-400 to-slate-500'} rounded-lg transition-all" style="width: ${percent}%"></div>
                                                <div class="absolute inset-0 flex items-center ${percent > 30 ? 'justify-start pl-3' : 'justify-end pr-3'}">
                                                    <span class="text-xs font-black ${percent > 50 ? 'text-white' : 'text-slate-600'}">${d.count} cmd</span>
                                                </div>
                                            </div>
                                            <span class="text-sm font-black ${isToday ? 'text-indigo-700' : 'text-slate-900'} w-28 text-right">${CORE.formatPrice(d.revenue)}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Graphique r�partition + Top POS -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- R�partition des commandes -->
                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-5 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white">
                                <h3 class="font-black text-slate-900 flex items-center gap-2">
                                    <i data-lucide="pie-chart" class="w-5 h-5 text-violet-500"></i>
                                    R�partition Commandes
                                </h3>
                            </div>
                            <div class="p-5">
                                <!-- Donut Chart -->
                                <div class="relative w-36 h-36 mx-auto mb-5">
                                    <svg viewBox="0 0 100 100" class="transform -rotate-90">
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#f1f5f9" stroke-width="12"/>
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#10b981" stroke-width="12" 
                                            stroke-dasharray="${(ordersByStatus.delivered / totalOrdersForChart) * 251.2} 251.2" stroke-linecap="round"/>
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#f59e0b" stroke-width="12" 
                                            stroke-dasharray="${(ordersByStatus.pending / totalOrdersForChart) * 251.2} 251.2" 
                                            stroke-dashoffset="${-(ordersByStatus.delivered / totalOrdersForChart) * 251.2}" stroke-linecap="round"/>
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#6366f1" stroke-width="12" 
                                            stroke-dasharray="${(ordersByStatus.confirmed / totalOrdersForChart) * 251.2} 251.2" 
                                            stroke-dashoffset="${-((ordersByStatus.delivered + ordersByStatus.pending) / totalOrdersForChart) * 251.2}" stroke-linecap="round"/>
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#ef4444" stroke-width="12" 
                                            stroke-dasharray="${(ordersByStatus.cancelled / totalOrdersForChart) * 251.2} 251.2" 
                                            stroke-dashoffset="${-((ordersByStatus.delivered + ordersByStatus.pending + ordersByStatus.confirmed) / totalOrdersForChart) * 251.2}" stroke-linecap="round"/>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center flex-col">
                                        <div class="text-2xl font-black text-slate-900">${totalOrders}</div>
                                        <div class="text-xs text-slate-500">Total</div>
                                    </div>
                                </div>
                                <div class="space-y-1.5 text-sm">
                                    <div class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50">
                                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-emerald-500"></div><span class="text-slate-700">Livr�es</span></div>
                                        <span class="font-black text-slate-900">${ordersByStatus.delivered}</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50">
                                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-amber-500"></div><span class="text-slate-700">En attente</span></div>
                                        <span class="font-black text-slate-900">${ordersByStatus.pending}</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50">
                                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-indigo-500"></div><span class="text-slate-700">Confirm�es</span></div>
                                        <span class="font-black text-slate-900">${ordersByStatus.confirmed}</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50">
                                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-500"></div><span class="text-slate-700">Annul�es</span></div>
                                        <span class="font-black text-slate-900">${ordersByStatus.cancelled}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Top 3 POS -->
                        <div class="lg:col-span-2 bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-gradient-to-r from-slate-50 to-white">
                                <h3 class="font-black text-slate-900 flex items-center gap-2">
                                    <i data-lucide="trophy" class="w-5 h-5 text-amber-500"></i>
                                    Top Points de Vente
                                </h3>
                                <div class="text-xs text-slate-500">${allPos.length} POS au total</div>
                            </div>
                            <div class="p-4 space-y-3">
                                ${topPOS.length === 0 ? `<div class="p-8 text-center text-slate-400">Aucun POS configur�</div>` : ''}
                                ${topPOS.map((m, i) => {
                                    const medals = ['��Ÿ ��', '��Ÿ ��?', '��Ÿ ��'];
                                    const bgColors = ['bg-gradient-to-r from-amber-50 to-yellow-50 border-amber-200', 'bg-gradient-to-r from-slate-50 to-gray-50 border-slate-200', 'bg-gradient-to-r from-orange-50 to-amber-50 border-orange-200'];
                                    return `
                                        <div class="p-4 rounded-2xl border ${bgColors[i]} flex items-center gap-4 hover:shadow-md transition group">
                                            <div class="text-3xl">${medals[i]}</div>
                                            <div class="flex-1">
                                                <div class="font-black text-slate-900 text-lg">${m.pos.name}</div>
                                                <div class="text-sm text-slate-500">${CORE.getCity(m.pos.cityId)?.name || 'N/A'} �� ?� � ${m.orders} commandes �� ?� � ${m.staff} staff</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-black text-xl text-emerald-600">${CORE.formatPrice(m.revenue)}</div>
                                                <div class="text-xs text-slate-500">${m.lowStock > 0 ? `<span class="text-red-600 font-bold">${m.lowStock} alertes</span>` : 'Stock OK'}</div>
                                            </div>
                                            <button onclick="ManagerModule.showPosDetailsModal(${m.pos.id})" class="p-2 rounded-xl bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition opacity-0 group-hover:opacity-100">
                                                <i data-lucide="external-link" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Cartes POS Comparatives -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-black text-slate-900 flex items-center gap-2">
                                <i data-lucide="store" class="w-5 h-5 text-indigo-500"></i>
                                Tous les Points de Vente
                            </h3>
                            <div class="text-sm text-slate-500">${allPos.length} locations actives</div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                            ${posMetrics.map((m, idx) => {
                                return `
                                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm hover:shadow-lg transition group">
                                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-4 text-white">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <h4 class="text-lg font-black">${m.pos.name}</h4>
                                                    <div class="text-xs text-indigo-200">${CORE.getCity(m.pos.cityId)?.name || 'N/A'}</div>
                                                </div>
                                                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                                    <i data-lucide="store" class="w-5 h-5"></i>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="p-4 space-y-4">
                                            <!-- Stats -->
                                            <div class="grid grid-cols-3 gap-2">
                                                <div class="p-2.5 rounded-xl bg-emerald-50 text-center">
                                                    <div class="text-lg font-black text-emerald-600">${m.revenue > 0 ? (m.revenue/1000).toFixed(0) : '0'}K</div>
                                                    <div class="text-[10px] font-bold text-emerald-700 uppercase">CA</div>
                                                </div>
                                                <div class="p-2.5 rounded-xl bg-blue-50 text-center">
                                                    <div class="text-lg font-black text-blue-600">${m.orders}</div>
                                                    <div class="text-[10px] font-bold text-blue-700 uppercase">Cmd</div>
                                                </div>
                                                <div class="p-2.5 rounded-xl ${m.lowStock > 0 ? 'bg-red-50' : 'bg-slate-50'} text-center">
                                                    <div class="text-lg font-black ${m.lowStock > 0 ? 'text-red-600' : 'text-slate-600'}">${m.lowStock}</div>
                                                    <div class="text-[10px] font-bold ${m.lowStock > 0 ? 'text-red-700' : 'text-slate-600'} uppercase">Alertes</div>
                                                </div>
                                            </div>

                                            <!-- Team -->
                                            <div class="flex items-center justify-between text-xs">
                                                <span class="text-slate-500">�quipe:</span>
                                                <div class="flex items-center gap-2">
                                                    <span class="${m.gestionnaire ? 'text-emerald-600' : 'text-slate-400'}">${m.gestionnaire ? '���??' : '�� ?��'} Gest.</span>
                                                    <span class="${m.vendeur ? 'text-emerald-600' : 'text-slate-400'}">${m.vendeur ? '���??' : '�� ?��'} Vend.</span>
                                                    <span class="${m.livreur ? 'text-emerald-600' : 'text-slate-400'}">${m.livreur ? '���??' : '�� ?��'} Livr.</span>
                                                </div>
                                            </div>

                                            <!-- Actions -->
                                            <div class="flex gap-2">
                                                <button onclick="ManagerModule.showPosDetailsModal(${m.pos.id})" class="flex-1 px-3 py-2 bg-indigo-600 text-white rounded-xl text-xs font-black hover:bg-indigo-700 transition flex items-center justify-center gap-1">
                                                    <i data-lucide="eye" class="w-3 h-3"></i> D�tails
                                                </button>
                                                <button onclick="ManagerModule.showStockTransferModal(${m.pos.id})" class="flex-1 px-3 py-2 bg-purple-600 text-white rounded-xl text-xs font-black hover:bg-purple-700 transition flex items-center justify-center gap-1">
                                                    <i data-lucide="arrow-right-left" class="w-3 h-3"></i> Transfert
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Produits Critiques Tous POS -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-gradient-to-r from-red-50 to-orange-50">
                            <h3 class="font-black text-red-900 flex items-center gap-2">
                                <i data-lucide="alert-triangle" class="w-5 h-5 text-red-500"></i>
                                Produits Critiques (Tous POS)
                            </h3>
                            <button onclick="ManagerModule.navigateTo('inventory')" class="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-xs font-black hover:bg-red-200 transition flex items-center gap-1">
                                Voir inventaire <i data-lucide="arrow-right" class="w-3 h-3"></i>
                            </button>
                        </div>
                        <div class="p-5">
                            ${CORE.db.products.filter(p => !p.isMainWarehouse && p.stock <= p.minStock).slice(0, 8).length === 0 ? 
                                `<div class="text-center py-8 text-slate-400 flex flex-col items-center gap-2">
                                    <i data-lucide="check-circle" class="w-12 h-12 text-emerald-300"></i>
                                    <span class="font-bold">Aucun produit critique</span>
                                    <span class="text-sm">Tous vos stocks sont �� niveau</span>
                                </div>` :
                                `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                                    ${CORE.db.products.filter(p => !p.isMainWarehouse && p.stock <= p.minStock).slice(0, 8).map(p => {
                                        const pos = CORE.getPOS(p.posId);
                                        const stockPercent = p.minStock > 0 ? Math.round((p.stock / p.minStock) * 100) : 0;
                                        const isCritical = stockPercent <= 25;
                                        return `
                                            <div class="p-4 rounded-2xl ${isCritical ? 'bg-red-50 border-2 border-red-200' : 'bg-amber-50 border border-amber-200'} group hover:shadow-md transition">
                                                <div class="flex items-start justify-between gap-2 mb-2">
                                                    <div class="font-black ${isCritical ? 'text-red-900' : 'text-amber-900'} text-sm leading-tight">${p.name}</div>
                                                    ${isCritical ? '<span class="px-1.5 py-0.5 bg-red-600 text-white text-[10px] font-black rounded">URGENT</span>' : ''}
                                                </div>
                                                <div class="text-xs ${isCritical ? 'text-red-700' : 'text-amber-700'} mb-2">${pos?.name || 'N/A'}</div>
                                                <div class="flex items-center gap-2 mb-3">
                                                    <div class="flex-1 h-2 bg-white rounded-full overflow-hidden">
                                                        <div class="h-full ${isCritical ? 'bg-red-500' : 'bg-amber-500'} rounded-full" style="width: ${stockPercent}%"></div>
                                                    </div>
                                                    <span class="text-xs font-bold ${isCritical ? 'text-red-700' : 'text-amber-700'}">${p.stock}/${p.minStock}</span>
                                                </div>
                                                <button onclick="ManagerModule.showRestockModal(${p.id})" class="w-full px-3 py-1.5 ${isCritical ? 'bg-red-600 hover:bg-red-700' : 'bg-amber-600 hover:bg-amber-700'} text-white rounded-lg text-xs font-black transition">R�approvisionner</button>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>`
                            }
                        </div>
                    </div>
                </div>`;
        },

        // =====================
        // STOCK CONTROL CENTER (Manager)
        // =====================
        downloadCSVFallback(filename, rows) {
            const escape = (v) => {
                const s = String(v ?? '');
                if (s.includes('"') || s.includes(',') || s.includes('\n')) return `"${s.replace(/"/g,'""')}"`;
                return s;
            };
            const csv = rows.map(r => r.map(escape).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        },
        exportInventoryCSV() {
            const rows = [
                ['id','name','category','price','stock','minStock','active','barcode','value'],
                ...CORE.getProductsExcludingMain().map(p => [
                    p.id,
                    p.name,
                    CORE.getCategory(p.categoryId)?.name || '',
                    p.price,
                    p.stock,
                    p.minStock,
                    p.active ? '1' : '0',
                    p.barcode || '',
                    Number(p.price||0) * Number(p.stock||0)
                ])
            ];
            // Reuse PDG downloader (fallback safe)
            (PDGModule?.downloadCSV || this.downloadCSVFallback)(`raya_manager_inventory_${Utils.todayKey()}.csv`, rows);
        },

        exportMainStockCSV() {
            const rows = [
                ['id','name','category','price','stock','minStock','active','barcode','value'],
                ...CORE.getMainWarehouseProducts().map(p => [
                    p.id,
                    p.name,
                    CORE.getCategory(p.categoryId)?.name || '',
                    p.price,
                    p.stock || 0,
                    p.minStock,
                    p.active ? '1' : '0',
                    p.barcode || '',
                    Number(p.price||0) * Number(p.stock||0)
                ])
            ];
            (PDGModule?.downloadCSV || this.downloadCSVFallback)(`raya_depot_principal_${Utils.todayKey()}.csv`, rows);
        },

        exportRestockingRecommendations() {
            const products = CORE.getProductsExcludingMain() || [];
            const lowStockProducts = products.filter(p => {
                const stock = p.stock || 0;
                const minStock = p.minStock || 0;
                return stock <= minStock;
            });
            
            const rows = [
                ['Produit', 'Stock Actuel', 'Stock Minimum', 'Stock Critique', '% du Minimum', '�?� Commander (�??2)', 'Co��t Unitaire', 'Co��t Total', 'Fournisseur', 'Cat�gorie', 'Urgence'],
                ...lowStockProducts.map(p => {
                    const stockPercent = p.minStock ? Math.round((p.stock / p.minStock) * 100) : 0;
                    const toOrder = Math.round((p.minStock || 0) * 2) - (p.stock || 0);
                    const itemCost = toOrder * (p.price || 0);
                    const isCritical = (p.stock || 0) <= (p.minStock * 0.5);
                    const supplier = CORE.db.suppliers?.find(s => s.id === p.supplierId);
                    const category = CORE.db.categories?.find(c => c.id === p.categoryId);
                    
                    return [
                        p.name,
                        p.stock || 0,
                        p.minStock || 0,
                        Math.round((p.minStock || 0) * 0.5),
                        stockPercent + '%',
                        toOrder,
                        p.price || 0,
                        itemCost,
                        supplier?.name || 'Non sp�cifi�',
                        category?.name || 'Non sp�cifi�e',
                        isCritical ? 'URGENT' : 'Normal'
                    ];
                }).sort((a, b) => {
                    // Trier par urgence puis par % du minimum
                    if (a[10] === 'URGENT' && b[10] !== 'URGENT') return -1;
                    if (a[10] !== 'URGENT' && b[10] === 'URGENT') return 1;
                    return parseInt(a[4]) - parseInt(b[4]);
                })
            ];
            
            (PDGModule?.downloadCSV || this.downloadCSVFallback)(`raya_recommendations_reappro_${Utils.todayKey()}.csv`, rows);
            UI.toast('Recommandations export�es', 'success');
        },

        exportMovementsCSV() {
            const movs = this.getMovementsFiltered();
            const rows = [
                ['id','productId','productName','type','qty','ref','note','userName','createdAt'],
                ...movs.map(m => [m.id, m.productId, m.productName, m.type, m.qty, m.ref || '', m.note || '', m.userName || '', m.createdAt])
            ];
            (PDGModule?.downloadCSV || this.downloadCSVFallback)(`raya_manager_stock_movements_${Utils.todayKey()}.csv`, rows);
        },

        getProductsFiltered(paginate = true) {
            const q = (document.getElementById('manager-inventory-search-input')?.value || this.state.inventorySearch || '').toLowerCase().trim();
            const currentUser = CORE.state.currentUser || {};
            const forcedPosId = currentUser.role === 'gestionnaire' ? currentUser.pos : null;
            const posId = forcedPosId ?? (this.state.inventoryPosId ? parseInt(this.state.inventoryPosId, 10) : null);
            const categoryFilter = this.state.inventoryCategoryFilter || 'all';
            const statusFilter = this.state.inventoryStatusFilter || 'all';
            const sortBy = this.state.inventorySortBy || 'name';
            const page = this.state.inventoryPage || 1;
            const perPage = this.state.inventoryPerPage || 50;
            
            let products = [...CORE.db.products];
            if (posId) {
                products = products.filter(p => this.productBelongsToPos(p, posId));
            }
            if (q) products = products.filter(p =>
                (p.name || '').toLowerCase().includes(q) ||
                String(p.barcode || '').toLowerCase().includes(q) ||
                String(p.id).includes(q)
            );
            // Category filter
            if (categoryFilter !== 'all') {
                products = products.filter(p => p.categoryId == categoryFilter);
            }
            // Status filter
            if (statusFilter !== 'all') {
                products = products.filter(p => {
                    const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                    const minStock = p.minStock || 0;
                    if (statusFilter === 'critical') return stock <= minStock * 0.5;
                    if (statusFilter === 'low') return stock <= minStock && stock > minStock * 0.5;
                    if (statusFilter === 'ok') return stock > minStock;
                    if (statusFilter === 'outofstock') return stock === 0;
                    return true;
                });
            }
            
            // Sort by selected criteria
            products.sort((a, b) => {
                const aStock = posId ? CORE.getProductStock(a.id, posId) : (a.stock || 0);
                const bStock = posId ? CORE.getProductStock(b.id, posId) : (b.stock || 0);
                switch (sortBy) {
                    case 'stock_asc': return aStock - bStock;
                    case 'stock_desc': return bStock - aStock;
                    case 'price_asc': return (a.price || 0) - (b.price || 0);
                    case 'price_desc': return (b.price || 0) - (a.price || 0);
                    case 'critical': return (aStock - (a.minStock || 0)) - (bStock - (b.minStock || 0));
                    case 'name_desc': return (b.name || '').localeCompare(a.name || '');
                    default: return (a.name || '').localeCompare(b.name || '');
                }
            });
            
            // Return all if not paginating
            if (!paginate) return products;
            
            // Paginate
            const totalFiltered = products.length;
            const totalPages = Math.ceil(totalFiltered / perPage);
            const currentPage = Math.min(page, totalPages || 1);
            const startIdx = (currentPage - 1) * perPage;
            return products.slice(startIdx, startIdx + perPage);
        },
        
        getProductsStats() {
            const currentUser = CORE.state.currentUser || {};
            const forcedPosId = currentUser.role === 'gestionnaire' ? currentUser.pos : null;
            const posId = forcedPosId ?? (this.state.inventoryPosId ? parseInt(this.state.inventoryPosId, 10) : null);
            const page = this.state.inventoryPage || 1;
            const perPage = this.state.inventoryPerPage || 50;
            const allFiltered = this.getProductsFiltered(false);
            const totalFiltered = allFiltered.length;
            const totalPages = Math.ceil(totalFiltered / perPage);
            const currentPage = Math.min(page, totalPages || 1);
            const startIdx = (currentPage - 1) * perPage;
            
            // Generate pagination buttons
            const paginationPages = [];
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationPages.push(i);
                } else if (paginationPages[paginationPages.length - 1] !== '...') {
                    paginationPages.push('...');
                }
            }
            
            return { totalFiltered, totalPages, currentPage, startIdx, perPage, paginationPages, posId };
        },

        getMovementsFiltered() {
            const q = (document.getElementById('manager-movements-search-input')?.value || '').toLowerCase().trim();
            const t = this.state.movementsType;
            const currentUser = CORE.state.currentUser || {};
            const forcedPosId = currentUser.role === 'gestionnaire' ? currentUser.pos : null;
            const posId = forcedPosId ?? (this.state.inventoryPosId ? parseInt(this.state.inventoryPosId, 10) : null);
            let movs = [...CORE.db.stockMovements];
            if (t !== 'all') movs = movs.filter(m => m.type === t);
            if (posId) movs = movs.filter(m => m.posId === posId);
            if (q) movs = movs.filter(m =>
                (m.productName || '').toLowerCase().includes(q) ||
                (m.ref || '').toLowerCase().includes(q) ||
                (m.userName || '').toLowerCase().includes(q)
            );
            return movs;
        },

        showNewProductModal(forcedPos = null) {
            const currentUser = CORE.state.currentUser || {};
            const categories = CORE.db.categories.map(c => ({value: c.id, label: c.name}));
            const posList = CORE.db.pointsOfSale.map(p => ({value: p.id, label: p.name}));
            
            // Si gestionnaire assign� �� un POS, forcer ce POS et le rendre non-modifiable
            const hasAssignedPos = currentUser.role === 'gestionnaire' && currentUser.pos;
            const assignedPos = hasAssignedPos ? CORE.getPOS(currentUser.pos) : null;
            
            // Charger les donn�es sauvegard�es s'il y en a
            const saved = window._savedProductFormData || {};
            
            UI.modal('Nouveau produit', `
                <div class="space-y-4 max-h-[700px] overflow-y-auto">
                    <div class="space-y-4">
                        ${UI.input('mp_name','Nom','text',saved.name || '','ex: Farine de manioc 1kg',true)}
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-black text-slate-900">Cat�gorie *</label>
                            <div class="flex gap-2">
                                ${UI.select('mp_cat','', categories, saved.categoryId || '', true)}
                                <button onclick="ManagerModule.showNewCategoryModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-black hover:bg-blue-700 transition whitespace-nowrap">+ Nouvelle</button>
                            </div>
                        </div>
                        
                            <div class="space-y-2">
                            <label class="block text-sm font-black text-slate-900">Point de Vente (POS) ${hasAssignedPos ? '(Verrouill�)' : '*'}</label>
                            ${hasAssignedPos ? `
                                <div class="px-4 py-2.5 bg-cyan-100 border-2 border-cyan-300 rounded-xl font-black text-cyan-900 flex items-center gap-2">
                                    <i data-lucide="lock" class="w-4 h-4"></i>
                                    ${assignedPos?.name || `POS ${currentUser.pos}`}
                                </div>
                                <input type="hidden" id="mp_pos" value="${currentUser.pos}">
                                <div class="text-xs text-cyan-600">Vous ��tes affect� �� ce POS uniquement. Les produits cr��s ici ne seront visibles que dans ce POS.</div>
                            ` : `
                                ${UI.select('mp_pos','', [{value:'main',label:'��Ÿ � � D�p��t Principal (stock central)'}, ...posList], (forcedPos === 'main' ? 'main' : (saved.posId || '')), true)}
                                <div class="text-xs text-slate-500">S�lectionnez le POS o�� ce produit sera disponible (ou 'D�p��t Principal')</div>
                            `}
                        </div>
                        
                        ${UI.input('mp_price','Prix','number',saved.price || '0','ex: 1500',true)}
                        ${UI.input('mp_stock','Stock initial','number',saved.stock || '0','ex: 100',true)}
                        ${UI.input('mp_min','Stock minimum','number',saved.minStock || '0','ex: 20',true)}
                        ${UI.input('mp_barcode','Code-barres','text',saved.barcode || '','facultatif',false)}
                        ${UI.select('mp_active','�tat',[{value:'1',label:'Actif'},{value:'0',label:'Inactif'}],saved.active || '1',true)}
                        
                        <div id="mp_preview" class="p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-emerald-200 rounded-xl hidden">
                            <div class="font-black text-emerald-900 mb-3">���?? Aper��u du produit:</div>
                            <div class="space-y-2">
                                <div class="p-3 bg-white rounded border border-emerald-200">
                                    <div class="text-xs text-slate-500 font-bold">Stock initial</div>
                                    <div class="font-black text-lg text-slate-900" id="mp_preview_stock">0</div>
                                </div>
                                <div class="p-3 bg-white rounded border border-emerald-200">
                                    <div class="text-xs text-slate-500 font-bold">Stock minimum</div>
                                    <div class="font-black text-lg text-slate-900" id="mp_preview_min">0</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-blue-50 border border-blue-300 rounded-2xl">
                            <div class="font-black text-blue-900 mb-2">��Ÿ? � Ajouter des images</div>
                            <div class="p-4 bg-blue-50 border-2 border-dashed border-blue-300 rounded-2xl text-center cursor-pointer hover:bg-blue-100 transition" onclick="document.getElementById('file_input_new_product').click()">>
                                <i data-lucide="upload-cloud" class="w-8 h-8 text-blue-600 mx-auto mb-2"></i>
                                <div class="font-black text-blue-900 text-sm">Cliquez pour uploader</div>
                                <div class="text-xs text-blue-600">ou glissez-d�posez les images</div>
                                <input id="file_input_new_product" type="file" accept="image/*" multiple style="display:none" onchange="ManagerModule.handleNewProductImages(event)">
                            </div>
                            <div id="mp_images_preview" class="mt-2 text-xs text-blue-600">${ManagerModule.newProductImages && ManagerModule.newProductImages.length > 0 ? ManagerModule.newProductImages.length + ' image(s) s�lectionn�e(s)' : 'Aucune image ajout�e'}</div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal(); ManagerModule.newProductImages = []; window._savedProductFormData = {};' },
                { label: 'Cr�er', onclick: 'ManagerModule.createProduct()', class: 'px-5 py-2.5 bg-sky-600 text-white font-black rounded-xl hover:bg-sky-700 transition' }
            ]);
            
            // Ajouter des �v�nements pour sauvegarder les donn�es
            setTimeout(() => {
                const inputs = document.querySelectorAll('#mp_name, #mp_price, #mp_stock, #mp_min, #mp_barcode, #mp_cat, #mp_active');
                
                const updatePreview = () => {
                    const stock = parseInt(UI.val('mp_stock') || '0', 10);
                    const minStock = parseInt(UI.val('mp_min') || '0', 10);
                    const preview = document.getElementById('mp_preview');
                    
                    if (stock > 0 || minStock > 0) {
                        preview.classList.remove('hidden');
                        document.getElementById('mp_preview_stock').textContent = stock;
                        document.getElementById('mp_preview_min').textContent = minStock;
                    } else {
                        preview.classList.add('hidden');
                    }
                };
                
                inputs.forEach(input => {
                    input.addEventListener('change', () => {
                        updatePreview();
                        window._savedProductFormData = {
                            name: document.getElementById('mp_name')?.value || '',
                            price: document.getElementById('mp_price')?.value || '0',
                            stock: document.getElementById('mp_stock')?.value || '0',
                            minStock: document.getElementById('mp_min')?.value || '0',
                            barcode: document.getElementById('mp_barcode')?.value || '',
                            categoryId: document.getElementById('mp_cat')?.value || '',
                            active: document.getElementById('mp_active')?.value || '1'
                        };
                    });
                    input.addEventListener('input', updatePreview);
                });
                
                updatePreview();
            }, 50);
        },

        showNewCategoryModal() {
            // IMPORTANT: Sauvegarder les donn�es du formulaire AVANT d'ouvrir le modal cat�gorie
            // Car UI.modal va remplacer le contenu et les champs ne seront plus accessibles
            window._savedProductFormData = {
                name: document.getElementById('mp_name')?.value || '',
                price: document.getElementById('mp_price')?.value || '0',
                stock: document.getElementById('mp_stock')?.value || '0',
                minStock: document.getElementById('mp_min')?.value || '0',
                barcode: document.getElementById('mp_barcode')?.value || '',
                categoryId: document.getElementById('mp_cat')?.value || '',
                posId: document.getElementById('mp_pos')?.value || '',
                active: document.getElementById('mp_active')?.value || '1'
            };
            
            UI.modal('Nouvelle cat�gorie', `
                <div class="space-y-4">
                    ${UI.input('nc_name','Nom de la cat�gorie','text','','ex: Fruits & L�gumes',true)}
                    ${UI.input('nc_icon','Ic��ne','text','','ex: apple, package, box, etc.',false)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'ManagerModule.cancelNewCategory()' },
                { label: 'Cr�er et retour', onclick: 'ManagerModule.createAndSelectCategory()', class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        cancelNewCategory() {
            UI.closeModal();
            setTimeout(() => ManagerModule.showNewProductModal(), 100);
        },

        createAndSelectCategory() {
            const name = UI.val('nc_name').trim();
            const icon = UI.val('nc_icon').trim() || 'package';
            if (!name) return UI.toast('Nom requis', 'warning');
            
            const newCat = CORE.create('categories', { name, icon });
            
            // Mettre �� jour pour s�lectionner la nouvelle cat�gorie
            window._savedProductFormData = window._savedProductFormData || {};
            window._savedProductFormData.categoryId = newCat.id;
            
            UI.toast(`Cat�gorie "${name}" cr��e`, 'success');
            UI.closeModal();
            
            // R�ouvrir le modal de produit
            setTimeout(() => {
                ManagerModule.showNewProductModal();
                
                // Forcer la restauration apr��s que le modal soit rendu
                setTimeout(() => {
                    const saved = window._savedProductFormData;
                    if (saved && document.getElementById('mp_name')) {
                        document.getElementById('mp_name').value = saved.name || '';
                        document.getElementById('mp_price').value = saved.price || '0';
                        document.getElementById('mp_stock').value = saved.stock || '0';
                        document.getElementById('mp_min').value = saved.minStock || '0';
                        document.getElementById('mp_barcode').value = saved.barcode || '';
                        if (saved.posId) document.getElementById('mp_pos').value = saved.posId;
                        if (saved.active) document.getElementById('mp_active').value = saved.active;
                        document.getElementById('mp_cat').value = newCat.id;
                    }
                }, 100);
            }, 100);
        },

        createProduct() {
            if (!CORE.hasPermission('products.create')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const currentUser = CORE.state.currentUser || {};
            const name = UI.val('mp_name').trim();
            const categoryId = parseInt(UI.val('mp_cat') || '0', 10);
            // FORCER le POS si gestionnaire assign� �� un POS
            const hasAssignedPos = currentUser.role === 'gestionnaire' && currentUser.pos;
            const rawPosVal = hasAssignedPos ? String(currentUser.pos) : String(UI.val('mp_pos') || '');
            const isMainWarehouse = rawPosVal === 'main';
            const posId = isMainWarehouse ? null : (hasAssignedPos ? currentUser.pos : parseInt(rawPosVal || '0', 10));
            const price = Number(UI.val('mp_price') || 0);
            const stock = Number(UI.val('mp_stock') || 0);
            const minStock = Number(UI.val('mp_min') || 0);
            const barcode = UI.val('mp_barcode').trim();
            const active = UI.val('mp_active') === '1';
            
            if (!name || !categoryId || (!posId && !isMainWarehouse)) return UI.toast('Nom, cat�gorie et POS requis', 'warning');
            if (price < 0 || stock < 0 || minStock < 0) return UI.toast('Valeurs invalides', 'warning');

            // Cr�er le produit avec posId strict
            const createdData = { 
                name, categoryId, price, stock, minStock, 
                image: null, barcode: barcode || null, active,
                posStocks: {},
                lockedToPosId: hasAssignedPos ? posId : null
            };
            if (isMainWarehouse) {
                createdData.isMainWarehouse = true;
                createdData.posId = null;
            } else {
                createdData.posId = posId;
            }

            const created = CORE.create('products', createdData);

            // Initialiser le stock pour ce POS si applicable
            if (!isMainWarehouse && posId) {
                created.posStocks[posId] = { stock, price };
            }
            
            CORE.recordStockMovement({ productId: created.id, type: 'in', qty: stock, note: 'Stock initial (cr�ation produit)', ref: `PRD-${created.id}`, posId: posId || null });

            // Upload images if any
            if (ManagerModule.newProductImages && ManagerModule.newProductImages.length > 0) {
                let imageCount = 0;
                ManagerModule.newProductImages.forEach((base64, idx) => {
                    const uploadedImg = CORE.uploadProductImage(created.id, base64, `Image_${idx+1}`);
                    if (uploadedImg) imageCount++;
                    
                    // Set the first image as the product's main image
                    if (idx === 0 && uploadedImg) {
                        created.image = uploadedImg.url;
                        CORE.save();
                    }
                });
                if (imageCount > 0) {
                    UI.toast(`${imageCount} image(s) upload�e(s)`, 'success');
                }
            }

            ManagerModule.newProductImages = [];
            UI.closeModal();
            UI.toast(isMainWarehouse ? 'Produit cr�� au D�p��t Principal' : `Produit cr�� au POS ${CORE.getPOS(posId)?.name || ''}`, 'success');
            
            // Re-render avec un petit d�lai pour assurer que tout est sauvegard�
            setTimeout(() => {
                App.rerender();
            }, 100);
        },

        newProductImages: [],
        newVariantImages: [],

        showEditProductModal(productId) {
            const p = CORE.getProduct(productId);
            if (!p) return;
            const variants = CORE.getProductVariants(productId);
            const images = CORE.getProductImages(productId);
            
            UI.modal(`Modifier: ${p.name}`, `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    ${UI.input('ep_name','Nom','text', p.name || '', '', true)}
                    ${UI.select('ep_cat','Cat�gorie', CORE.db.categories.map(c => ({value: c.id, label: c.name})), p.categoryId, true)}
                    ${UI.input('ep_price','Prix','number', p.price ?? 0, '', true)}
                    ${UI.input('ep_min','Stock minimum','number', p.minStock ?? 0, '', true)}
                    ${UI.input('ep_image','Image principale (URL)','text', p.image || '', '', false)}
                    ${UI.input('ep_barcode','Code-barres','text', p.barcode || '', '', false)}
                    ${UI.select('ep_active','�tat',[{value:'1',label:'Actif'},{value:'0',label:'Inactif'}], p.active ? '1':'0', true)}
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">Stock actuel: <b>${p.stock}</b></div>
                    
                    <div class="p-4 bg-blue-50 border border-blue-300 rounded-2xl">
                        <div class="font-black text-blue-900 mb-2">��Ÿ? � Galerie d'images (${images.length})</div>
                        ${images.length > 0 ? `
                            <div class="space-y-2 mb-3 max-h-48 overflow-y-auto">
                                ${images.map((img, idx) => `
                                    <div class="flex items-center gap-2 p-2 bg-white rounded border border-blue-200">
                                        <img src="${img.url}" alt="Image ${idx+1}" class="w-10 h-10 object-cover rounded">
                                        <div class="flex-1 text-xs">
                                            <div class="text-blue-900 font-bold">${img.filename || 'Image ' + (idx+1)}</div>
                                            ${img.isPrimary ? '<span class="text-[10px] bg-yellow-200 text-yellow-800 px-1 rounded font-black">���?� Principale</span>' : ''}
                                        </div>
                                        <div class="flex gap-1">
                                            ${!img.isPrimary ? `<button onclick="ManagerModule.setPrimaryProductImage('${img.id}', ${productId})" class="px-2 py-1 bg-yellow-500 text-white text-xs rounded hover:bg-yellow-600 transition font-black" title="D�finir comme principale">���?�</button>` : ''}
                                            <button onclick="ManagerModule.replaceProductImage('${img.id}', ${productId})" class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition font-black" title="Remplacer">��� �</button>
                                            <button onclick="ManagerModule.deleteProductImage('${img.id}', ${productId})" class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition font-black" title="Supprimer">���?�</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div class="text-xs text-blue-700 mb-3">Aucune image encore</div>'}
                        <button onclick="ManagerModule.showImageUploadModal(${productId})" class="w-full py-2 px-3 bg-blue-600 text-white rounded-lg font-black text-sm hover:bg-blue-700 transition">
                            + Ajouter/G�rer images
                        </button>
                    </div>
                    
                    ${variants.length > 0 ? `
                        <div class="p-4 bg-purple-50 border border-purple-200 rounded-2xl">
                            <div class="font-black text-purple-900 mb-2">Variantes (${variants.length})</div>
                            <div class="space-y-1 text-xs text-purple-800">
                                ${variants.map(v => `<div>�� ?� � ${v.variantName}: ${v.variantValue}</div>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Variantes', onclick: `ManagerModule.showVariantsModal(${p.id})`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' },
                { label: 'Enregistrer', onclick: `ManagerModule.saveProduct(${p.id})`, class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        showImageUploadModal(productId) {
            if (!CORE.hasPermission('products.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const product = CORE.getProduct(productId);
            if (!product) return UI.toast('Produit introuvable', 'error');
            
            UI.modal(`G�rer les images: ${product.name}`, `
                <div class="space-y-4">
                    <div id="manager_image_preview"></div>
                    
                    <div class="p-4 bg-blue-50 border-2 border-dashed border-blue-300 rounded-2xl text-center cursor-pointer hover:bg-blue-100 transition" onclick="document.getElementById('file_input_manager').click()">
                        <i data-lucide="upload-cloud" class="w-8 h-8 text-blue-600 mx-auto mb-2"></i>
                        <div class="font-black text-blue-900">Cliquez pour uploader une image</div>
                        <div class="text-xs text-blue-600">ou glissez-d�posez</div>
                        <input id="file_input_manager" type="file" accept="image/*" multiple style="display:none" onchange="ManagerModule.handleImageSelect(event, ${productId})">
                    </div>
                    
                    <div class="text-xs text-slate-600 bg-slate-50 p-3 rounded-lg">
                        Ou entrez une URL d'image:
                    </div>
                    <div class="flex gap-2">
                        <input id="image_url_manager" type="text" placeholder="https://..." class="flex-1 px-3 py-2 border border-slate-200 rounded-lg">
                        <button onclick="ManagerModule.addImageFromURL(${productId})" class="px-4 py-2 bg-green-600 text-white rounded-lg font-black hover:bg-green-700 transition">+ Ajouter</button>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        handleImageSelect(event, productId) {
            if (!CORE.hasPermission('products.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            // Collect images to display in preview
            const previewContainer = document.getElementById('manager_image_preview');
            if (!previewContainer) return;
            
            let uploadedCount = 0;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64 = e.target.result;
                    CORE.uploadProductImage(productId, base64, file.name);
                    uploadedCount++;
                    
                    // Update preview directly
                    if (previewContainer) {
                        previewContainer.innerHTML = `
                            <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-lg">
                                <div class="font-black text-emerald-700">���?? ${uploadedCount} image(s) upload�e(s)</div>
                                <div class="text-xs text-emerald-600 mt-1">Images ajout�es au produit</div>
                            </div>
                        `;
                    }
                    
                    UI.toast(`Image "${file.name}" upload�e`, 'success');
                };
                reader.readAsDataURL(file);
            });
        },

        addImageFromURL(productId) {
            if (!CORE.hasPermission('products.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const url = document.getElementById('image_url_manager')?.value?.trim();
            if (!url) return UI.toast('URL requise', 'warning');
            
            CORE.uploadProductImage(productId, url, 'Image from URL');
            document.getElementById('image_url_manager').value = '';
            
            const previewContainer = document.getElementById('manager_image_preview');
            if (previewContainer) {
                const images = CORE.getProductImages(productId);
                previewContainer.innerHTML = `
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-lg">
                        <div class="font-black text-emerald-700">���?? Image ajout�e (Total: ${images.length})</div>
                        <div class="text-xs text-emerald-600 mt-1">Images dans le produit</div>
                    </div>
                `;
            }
            UI.toast('Image ajout�e avec succ��s', 'success');
        },
        
        deleteProductImage(imageId, productId) {
            if (!CORE.hasPermission('products.delete')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            if (!confirm('�?Štes-vous s��r de vouloir supprimer cette image ?')) return;
            
            const idx = CORE.db.productImages.findIndex(img => img.id === imageId);
            if (idx !== -1) {
                const wasDeleted = CORE.db.productImages.splice(idx, 1);
                
                if (wasDeleted[0].isPrimary && CORE.db.productImages.length > 0) {
                    const sameProduct = CORE.db.productImages.filter(img => img.productId === productId);
                    if (sameProduct.length > 0) {
                        sameProduct[0].isPrimary = true;
                    }
                }
                
                CORE.save();
                UI.toast('Image supprim�e', 'success');
                ManagerModule.showEditProductModal(productId);
            }
        },
        
        setPrimaryProductImage(imageId, productId) {
            if (!CORE.hasPermission('products.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const image = CORE.db.productImages.find(img => img.id === imageId);
            if (!image) return UI.toast('Image introuvable', 'error');
            
            CORE.db.productImages.forEach(img => {
                if (img.productId === productId && img.isPrimary) {
                    img.isPrimary = false;
                }
            });
            
            image.isPrimary = true;
            
            const p = CORE.getProduct(productId);
            if (p) {
                CORE.update('products', productId, { image: image.url });
            }
            
            CORE.save();
            UI.toast('Image d�finie comme principale', 'success');
            ManagerModule.showEditProductModal(productId);
        },
        
        replaceProductImage(imageId, productId) {
            if (!CORE.hasPermission('products.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const base64 = event.target.result;
                    
                    const image = CORE.db.productImages.find(img => img.id === imageId);
                    if (image) {
                        image.url = base64;
                        image.filename = file.name;
                        image.filesize = Math.round((base64.length * 3) / 4);
                        image.uploadedAt = new Date().toISOString();
                        image.uploadedBy = CORE.state.currentUser?.id;
                        image.uploadedByName = CORE.state.currentUser?.name;
                        
                        if (image.isPrimary) {
                            const p = CORE.getProduct(productId);
                            if (p) {
                                CORE.update('products', productId, { image: base64 });
                            }
                        }
                        
                        CORE.save();
                        UI.toast('Image remplac�e avec succ��s', 'success');
                        ManagerModule.showEditProductModal(productId);
                    }
                };
                reader.readAsDataURL(file);
            };
            fileInput.click();
        },

        handleNewProductImages(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (!ManagerModule.newProductImages) ManagerModule.newProductImages = [];
                    ManagerModule.newProductImages.push(e.target.result);
                    
                    // Mettre �� jour le DOM du modal directement
                    const previewContainer = document.getElementById('mp_images_preview');
                    if (previewContainer) {
                        const html = ManagerModule.newProductImages.map((img, idx) => `
                            <div class="relative">
                                <img src="${img}" alt="Preview ${idx+1}" class="w-16 h-16 object-cover rounded-lg border border-blue-300">
                                <button onclick="ManagerModule.removeNewProductImage(${idx})" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition">�??</button>
                            </div>
                        `).join('');
                        
                        previewContainer.innerHTML = `
                            <div class="text-xs font-bold text-blue-900 mb-2">${ManagerModule.newProductImages.length} image(s) ajout�e(s)</div>
                            <div class="flex flex-wrap gap-2">${html}</div>
                        `;
                    }
                };
                reader.readAsDataURL(file);
            });
        },

        removeNewProductImage(idx) {
            if (ManagerModule.newProductImages) {
                ManagerModule.newProductImages.splice(idx, 1);
                
                // Mettre �� jour le DOM du modal directement
                const previewContainer = document.getElementById('mp_images_preview');
                if (previewContainer) {
                    if (ManagerModule.newProductImages.length > 0) {
                        const html = ManagerModule.newProductImages.map((img, i) => `
                            <div class="relative">
                                <img src="${img}" alt="Preview ${i+1}" class="w-16 h-16 object-cover rounded-lg border border-blue-300">
                                <button onclick="ManagerModule.removeNewProductImage(${i})" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition">�??</button>
                            </div>
                        `).join('');
                        
                        previewContainer.innerHTML = `
                            <div class="text-xs font-bold text-blue-900 mb-2">${ManagerModule.newProductImages.length} image(s) ajout�e(s)</div>
                            <div class="flex flex-wrap gap-2">${html}</div>
                        `;
                    } else {
                        previewContainer.innerHTML = '<div class="mt-2 text-xs text-blue-600">Aucune image ajout�e</div>';
                    }
                }
            }
        },

        saveProduct(productId) {
            if (!CORE.hasPermission('products.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const p = CORE.getProduct(productId);
            if (!p) return;
            const name = UI.val('ep_name').trim();
            const categoryId = parseInt(UI.val('ep_cat') || '0', 10);
            const price = Number(UI.val('ep_price') || 0);
            const minStock = Number(UI.val('ep_min') || 0);
            const image = UI.val('ep_image').trim();
            const barcode = UI.val('ep_barcode').trim();
            const active = UI.val('ep_active') === '1';
            if (!name || !categoryId) return UI.toast('Nom et cat�gorie requis', 'warning');
            if (price < 0 || minStock < 0) return UI.toast('Valeurs invalides', 'warning');

            // Mettre �� jour image principale si fournie
            const finalImage = image ? image : (p.image || null);
            
            CORE.update('products', p.id, { name, categoryId, price, minStock, image: finalImage, barcode: barcode || null, active });
            UI.closeModal();
            UI.toast('Produit mis �� jour avec succ��s', 'success');
            App.rerender();
        },

        showProductInfoModal(productId) {
            const p = CORE.getProduct(productId);
            if (!p) return;
            const category = CORE.getCategory(p.categoryId);
            const stock = p.stock || 0;
            const minStock = p.minStock || 0;
            const isLow = stock <= minStock;
            
            // Chercher l'image principale dans la galerie si pas d'image URL
            let displayImage = p.image;
            if (!displayImage) {
                const images = CORE.getProductImages(productId);
                const primaryImage = images.find(img => img.isPrimary);
                if (primaryImage) {
                    displayImage = primaryImage.url;
                } else if (images.length > 0) {
                    displayImage = images[0].url;
                }
            }
            
            UI.modal(p.name + ' - D�tails complets', `
                <div class="space-y-4 max-h-[600px] overflow-y-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            ${displayImage ? `<img src="${displayImage}" alt="${p.name}" class="w-full h-48 object-cover rounded-2xl border border-slate-200 mb-4">` : '<div class="w-full h-48 bg-slate-100 rounded-2xl border border-slate-200 flex items-center justify-center text-slate-400"><i data-lucide="image-off" class="w-12 h-12"></i></div>'}
                            <div class="space-y-2 text-sm">
                                <div><span class="font-black text-slate-700">Cat�gorie:</span> ${category?.name || '�� ?��'}</div>
                                <div><span class="font-black text-slate-700">Code-barres:</span> ${p.barcode || '�� ?��'}</div>
                                <div><span class="font-black text-slate-700">�tat:</span> ${p.active ? '<span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded text-xs font-black">Actif</span>' : '<span class="px-2 py-1 bg-slate-100 text-slate-700 rounded text-xs font-black">Inactif</span>'}</div>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                                <div class="text-xs font-black text-blue-600 uppercase">Prix</div>
                                <div class="text-2xl font-black text-blue-900 mt-1">${CORE.formatPrice(p.price)}</div>
                            </div>
                            <div class="p-4 bg-${isLow ? 'red' : 'emerald'}-50 border border-${isLow ? 'red' : 'emerald'}-200 rounded-2xl">
                                <div class="text-xs font-black text-${isLow ? 'red' : 'emerald'}-600 uppercase">Stock actuel</div>
                                <div class="text-2xl font-black text-${isLow ? 'red' : 'emerald'}-900 mt-1">${p.stock}</div>
                                ${isLow ? `<div class="text-xs text-red-700 mt-1">��š ��� � � Sous le minimum (${p.minStock})</div>` : `<div class="text-xs text-emerald-700 mt-1">���?? Au-dessus du minimum (${p.minStock})</div>`}
                            </div>
                        </div>
                    </div>
                    <div class="border-t border-slate-200 pt-4 grid grid-cols-3 gap-2 text-center text-xs">
                        <div>
                            <div class="text-slate-500">Cr��</div>
                            <div class="font-bold text-slate-900">${CORE.formatDate(p.createdAt).split(' ')[0]}</div>
                        </div>
                        <div>
                            <div class="text-slate-500">Valorisation</div>
                            <div class="font-bold text-slate-900">${CORE.formatPrice((p.price || 0) * (p.stock || 0))}</div>
                        </div>
                        <div>
                            <div class="text-slate-500">Min requis</div>
                            <div class="font-bold text-slate-900">${CORE.formatPrice((p.price || 0) * (p.minStock || 0))}</div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' },
                { label: '�diter', onclick: 'ManagerModule.showEditProductModal(' + p.id + ')', class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        showVariantsModal(productId) {
            const p = CORE.getProduct(productId);
            if (!p) return;
            const variants = CORE.getProductVariants(productId);
            UI.modal(`Variantes Avanc�es: ${p.name}`, `
                <div class="space-y-4">
                    <div class="space-y-2 max-h-[500px] overflow-y-auto">
                        ${variants.length === 0 ? `<div class="text-center text-slate-400 py-8">Aucune variante</div>` : ''}
                        ${variants.map(v => {
                            const attrs = v.attributes && v.attributes.length ? v.attributes : [];
                            const attrDisplay = attrs.map(a => `<span class="inline-block px-2 py-1 bg-blue-100 text-blue-700 rounded-lg text-xs">${a.name}: <strong>${a.value}</strong></span>`).join(' ');
                            return `
                            <div class="p-4 rounded-2xl border-2 border-slate-200 bg-gradient-to-r from-slate-50 to-blue-50 hover:border-blue-300 transition">
                                <div class="flex items-start justify-between gap-3 mb-2">
                                    <div class="flex-1">
                                        <div class="font-black text-slate-900">SKU: <code class="bg-slate-200 px-2 py-1 rounded text-xs">${v.sku || 'AUTO'}</code></div>
                                        <div class="text-sm text-slate-600 mt-1 space-x-1">${attrDisplay}</div>
                                    </div>
                                    <div class="text-right text-sm">
                                        <div class="font-bold text-emerald-600">${CORE.formatPrice(v.price || 0)}</div>
                                        <div class="text-slate-500">Stock: <strong class="${v.stock < 10 ? 'text-red-600' : 'text-emerald-600'}">${v.stock}</strong></div>
                                    </div>
                                </div>
                                ${v.weight ? `<div class="text-xs text-slate-500">Poids: ${v.weight}</div>` : ''}
                                ${v.temperature ? `<div class="text-xs text-slate-500">Temp�rature: ${v.temperature}</div>` : ''}
                                <div class="flex gap-2 mt-2">
                                    <button onclick="ManagerModule.editVariant(${v.id})" class="px-3 py-1.5 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-200 text-xs font-bold transition">�diter</button>
                                    <button onclick="ManagerModule.deleteVariant(${v.id})" class="px-3 py-1.5 rounded-lg bg-red-100 text-red-600 hover:bg-red-200 text-xs font-bold transition">Supprimer</button>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                    <div class="border-t border-slate-300 pt-4">
                        <button onclick="ManagerModule.showAddVariantForm(${productId})" class="w-full px-4 py-3 rounded-xl bg-emerald-600 text-white font-black hover:bg-emerald-700 transition">+ Nouvelle Variante</button>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showAddVariantForm(productId) {
            const p = CORE.getProduct(productId);
            if (!p) return;
            
            // Charger les donn�es sauvegard�es s'il y en a
            const saved = window._savedVariantFormData || {};
            
            // Si ce n'est pas la premi��re fois, garder les attributs
            if (!window.tempVariantAttrs) {
                window.tempVariantAttrs = saved.attributes || [];
            }
            if (!ManagerModule.newVariantImages) {
                ManagerModule.newVariantImages = saved.images || [];
            }
            
            UI.modal(`Ajouter Variante: ${p.name}`, `
                <div class="space-y-4 max-h-[700px] overflow-y-auto">
                    ${UI.input('var_sku_new','SKU','text',saved.sku || '','auto-g�n�r� si vide',false)}
                    <div class="space-y-3">
                        <div class="font-black text-slate-900">Attributs (${window.tempVariantAttrs.length})</div>
                        <div id="var_attrs_list_new" class="space-y-2">
                            ${window.tempVariantAttrs.map((a, i) => `
                                <div class="p-3 rounded-lg bg-blue-50 border border-blue-200 flex items-center justify-between">
                                    <div class="font-bold text-slate-900">${a.name}: <span class="text-blue-600">${a.value}</span></div>
                                    <button onclick="ManagerModule.removeAttributeFromVariant(${i})" class="text-red-600 hover:text-red-800">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="ManagerModule.showAddAttributeSelector(${productId})" class="text-sm px-3 py-2 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-200 transition">+ Ajouter Attribut</button>
                    </div>
                    <div class="border-t border-slate-200 pt-4 space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            ${UI.input('var_price_new','Prix (XAF)','number',saved.price || '0','requis',false)}
                            ${UI.input('var_stock_new','Stock','number',saved.stock || '0','requis',false)}
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            ${UI.input('var_weight_new','Poids (ex: 500g)','text',saved.weight || '','optionnel',false)}
                            ${UI.input('var_temp_new','Temp�rature (ex: 0-4�? �C)','text',saved.temperature || '','optionnel',false)}
                        </div>
                    </div>
                    
                    <div class="p-4 bg-green-50 border border-green-300 rounded-2xl">
                        <div class="font-black text-green-900 mb-2">��Ÿ? � Ajouter une image pour cette variante</div>
                        <div class="p-4 bg-green-50 border-2 border-dashed border-green-300 rounded-2xl text-center cursor-pointer hover:bg-green-100 transition" onclick="document.getElementById('file_input_variant').click()">
                            <i data-lucide="upload-cloud" class="w-8 h-8 text-green-600 mx-auto mb-2"></i>
                            <div class="font-black text-green-900 text-sm">Cliquez pour uploader</div>
                            <div class="text-xs text-green-600">ou glissez-d�posez l'image</div>
                            <input id="file_input_variant" type="file" accept="image/*" style="display:none" onchange="ManagerModule.handleVariantImage(event)">
                        </div>
                        <div id="mv_image_preview" class="mt-2 text-xs text-green-600">${ManagerModule.newVariantImages && ManagerModule.newVariantImages.length > 0 ? '���?? Image s�lectionn�e' : 'Aucune image s�lectionn�e'}</div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal(); ManagerModule.newVariantImages = []; window.tempVariantAttrs = []; window._savedVariantFormData = {};' },
                { label: 'Cr�er Variante', onclick: `ManagerModule.addVariantAdvanced(${productId})`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
            
            // Ajouter des �v�nements pour sauvegarder les donn�es
            setTimeout(() => {
                const inputs = document.querySelectorAll('#var_sku_new, #var_price_new, #var_stock_new, #var_weight_new, #var_temp_new');
                inputs.forEach(input => {
                    input.addEventListener('change', () => {
                        window._savedVariantFormData = {
                            sku: document.getElementById('var_sku_new')?.value || '',
                            price: document.getElementById('var_price_new')?.value || '0',
                            stock: document.getElementById('var_stock_new')?.value || '0',
                            weight: document.getElementById('var_weight_new')?.value || '',
                            temperature: document.getElementById('var_temp_new')?.value || '',
                            attributes: window.tempVariantAttrs || [],
                            images: ManagerModule.newVariantImages || []
                        };
                    });
                });
            }, 50);
        },

        handleVariantImage(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            const file = files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                ManagerModule.newVariantImages = [e.target.result];
                
                // Mettre �� jour le DOM du modal directement
                const previewContainer = document.getElementById('mv_image_preview');
                if (previewContainer) {
                    previewContainer.innerHTML = `
                        <div class="text-xs font-bold text-green-900 mb-2">Image s�lectionn�e</div>
                        <div class="relative inline-block">
                            <img src="${e.target.result}" alt="Preview" class="h-24 object-cover rounded-lg border border-green-300">
                            <button onclick="ManagerModule.removeVariantImage()" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition">�??</button>
                        </div>
                    `;
                }
            };
            reader.readAsDataURL(file);
        },

        removeVariantImage() {
            ManagerModule.newVariantImages = [];
            
            // Mettre �� jour le DOM du modal directement
            const previewContainer = document.getElementById('mv_image_preview');
            if (previewContainer) {
                previewContainer.innerHTML = '<div class="mt-2 text-xs text-green-600">Aucune image s�lectionn�e</div>';
            }
        },

        showAddAttributeSelector(productId) {
            window.tempVariantProductId = productId; // Store for later use
            
            // Sauvegarder les donn�es avant de changer de modal
            window._savedVariantFormData = {
                sku: document.getElementById('var_sku_new')?.value || '',
                price: document.getElementById('var_price_new')?.value || '0',
                stock: document.getElementById('var_stock_new')?.value || '0',
                weight: document.getElementById('var_weight_new')?.value || '',
                temperature: document.getElementById('var_temp_new')?.value || '',
                attributes: window.tempVariantAttrs || [],
                images: ManagerModule.newVariantImages || []
            };
            
            const attrTypes = CORE.db.productAttributeTypes || [];
            const existingAttrs = window.tempVariantAttrs || [];
            const availableAttrs = attrTypes.filter(at => !existingAttrs.find(ea => ea.name === at.label));
            
            let html = '<div class="space-y-2">';
            
            // Attributs pr�-d�finis
            availableAttrs.forEach(attr => {
                html += `
                    <div class="p-3 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-50 transition" onclick="ManagerModule.addAttributeToVariant(\'${attr.label}\', \'${attr.type}\')">
                        <div class="font-bold text-slate-900">${attr.label}</div>
                        <div class="text-xs text-slate-500">Type: ${attr.type}</div>
                    </div>
                `;
            });
            
            // Option pour attribut personnalis�
            html += `
                <div class="p-3 rounded-lg border border-blue-300 bg-blue-50 cursor-pointer hover:bg-blue-100 transition" onclick="ManagerModule.addCustomAttribute()">
                    <div class="font-bold text-blue-900">+ Attribut Personnalis�</div>
                    <div class="text-xs text-blue-600">Ajouter un attribut non r�pertori�</div>
                </div>
            `;
            
            html += '</div>';
            
            UI.modal('S�lectionner un Attribut', html, [
                { label: 'Retour', onclick: `ManagerModule.showAddVariantForm(${productId})` }
            ]);
        },

        addCustomAttribute() {
            // Sauvegarder les donn�es avant de changer de modal
            window._savedVariantFormData = {
                sku: document.getElementById('var_sku_new')?.value || '',
                price: document.getElementById('var_price_new')?.value || '0',
                stock: document.getElementById('var_stock_new')?.value || '0',
                weight: document.getElementById('var_weight_new')?.value || '',
                temperature: document.getElementById('var_temp_new')?.value || '',
                attributes: window.tempVariantAttrs || [],
                images: ManagerModule.newVariantImages || []
            };
            
            UI.modal('Ajouter un Attribut Personnalis�', `
                <div class="space-y-3">
                    <input id="custom_attr_name" type="text" placeholder="Nom de l'attribut (ex: Mat�riau, Marque, Degr� alcool)" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                    <input id="custom_attr_value" type="text" placeholder="Valeur (ex: Coton, Premium, 12%)" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Ajouter', onclick: 'ManagerModule.confirmCustomAttribute()', class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        confirmCustomAttribute() {
            const name = UI.val('custom_attr_name')?.trim();
            const value = UI.val('custom_attr_value')?.trim();
            
            if (!name || !value) {
                return UI.toast('Nom et valeur obligatoires', 'warning');
            }
            
            window.tempVariantAttrs = window.tempVariantAttrs || [];
            window.tempVariantAttrs.push({ name: name, value: value });
            
            // Afficher les attributs ajout�s
            const list = document.getElementById('var_attrs_list_new');
            if (list) {
                const attrHtml = window.tempVariantAttrs.map((a, i) => `
                    <div class="p-3 rounded-lg bg-blue-50 border border-blue-200 flex items-center justify-between">
                        <div class="font-bold text-slate-900">${a.name}: <span class="text-blue-600">${a.value}</span></div>
                        <button onclick="ManagerModule.removeAttributeFromVariant(${i})" class="text-red-600 hover:text-red-800">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                `).join('');
                list.innerHTML = attrHtml;
                lucide.createIcons();
            }
            
            // Retourner au modal de s�lection d'attribut au lieu de fermer compl��tement
            ManagerModule.showAddAttributeSelector(window.tempVariantProductId);
            UI.toast('Attribut personnalis� ajout�', 'success');
        },

        addAttributeToVariant(attrName, attrType) {
            let valueInput = '';
            let suggestions = '';
            
            // Suggestions pr�-remplies mais saisie libre
            if (attrName === 'Couleur') {
                suggestions = 'Ex: Rouge, Bleu, Vert, Jaune, Noir, Blanc, etc.';
            } else if (attrName === 'Taille') {
                suggestions = 'Ex: XS, S, M, L, XL, XXL, ou toute autre valeur';
            } else if (attrName === 'Temp�rature') {
                suggestions = 'Ex: Ambiant, Frais (0-4�? �C), Congel� (-18�? �C), ou toute autre valeur';
            } else {
                suggestions = 'Ex: valeur personnalis�e';
            }
            
            valueInput = `<input id="attr_val_${attrName}" type="text" placeholder="${suggestions}" class="px-3 py-2 rounded-lg border border-slate-200 w-full" />`;
            
            UI.modal(`Valeur pour ${attrName}`, valueInput, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Ajouter', onclick: `ManagerModule.confirmAttributeValue('${attrName}')`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        confirmAttributeValue(attrName) {
            const val = UI.val(`attr_val_${attrName}`);
            if (!val) return UI.toast('Valeur requise', 'warning');
            
            window.tempVariantAttrs = window.tempVariantAttrs || [];
            window.tempVariantAttrs.push({ name: attrName, value: val });
            
            // Afficher les attributs ajout�s
            const list = document.getElementById('var_attrs_list_new');
            if (list) {
                const attrHtml = window.tempVariantAttrs.map((a, i) => `
                    <div class="p-3 rounded-lg bg-blue-50 border border-blue-200 flex items-center justify-between">
                        <div class="font-bold text-slate-900">${a.name}: <span class="text-blue-600">${a.value}</span></div>
                        <button onclick="ManagerModule.removeAttributeFromVariant(${i})" class="text-red-600 hover:text-red-800">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                `).join('');
                list.innerHTML = attrHtml;
                lucide.createIcons();
            }
            
            // Retourner au modal de s�lection d'attribut au lieu de fermer compl��tement
            ManagerModule.showAddAttributeSelector(window.tempVariantProductId);
            UI.toast('Attribut ajout�', 'success');
        },

        removeAttributeFromVariant(index) {
            if (!window.tempVariantAttrs) return;
            window.tempVariantAttrs.splice(index, 1);
            
            // Sauvegarder les attributs restants
            window._savedVariantFormData = {
                sku: document.getElementById('var_sku_new')?.value || '',
                price: document.getElementById('var_price_new')?.value || '0',
                stock: document.getElementById('var_stock_new')?.value || '0',
                weight: document.getElementById('var_weight_new')?.value || '',
                temperature: document.getElementById('var_temp_new')?.value || '',
                attributes: window.tempVariantAttrs || [],
                images: ManagerModule.newVariantImages || []
            };
            
            const list = document.getElementById('var_attrs_list_new');
            if (list) {
                const attrHtml = window.tempVariantAttrs.map((a, i) => `
                    <div class="p-3 rounded-lg bg-blue-50 border border-blue-200 flex items-center justify-between">
                        <div class="font-bold text-slate-900">${a.name}: <span class="text-blue-600">${a.value}</span></div>
                        <button onclick="ManagerModule.removeAttributeFromVariant(${i})" class="text-red-600 hover:text-red-800">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                `).join('');
                list.innerHTML = attrHtml;
                lucide.createIcons();
            }
        },

        addVariantAdvanced(productId) {
            const price = Number(UI.val('var_price_new') || 0);
            const stock = Number(UI.val('var_stock_new') || 0);
            const sku = UI.val('var_sku_new').trim() || `SKU-${Date.now()}`;
            const weight = UI.val('var_weight_new').trim();
            const temperature = UI.val('var_temp_new').trim();
            const attributes = window.tempVariantAttrs || [];
            
            if (attributes.length === 0) return UI.toast('Au moins 1 attribut requis', 'warning');
            if (price <= 0) return UI.toast('Prix doit ��tre > 0', 'warning');
            if (stock < 0) return UI.toast('Stock invalide', 'warning');
            
            const variant = CORE.create('productVariants', {
                productId,
                attributes,
                sku,
                price,
                stock,
                weight: weight || null,
                temperature: temperature || null,
                image: null
            });
            
            // Upload image if any
            if (ManagerModule.newVariantImages && ManagerModule.newVariantImages.length > 0) {
                const base64 = ManagerModule.newVariantImages[0];
                const uploadedImg = CORE.uploadProductImage(productId, base64, `Variant_${sku}`);
                if (uploadedImg) {
                    variant.image = uploadedImg.url;
                    CORE.update('productVariants', variant.id, { image: uploadedImg.url });
                    UI.toast('Image de variante upload�e', 'success');
                }
            }
            
            window.tempVariantAttrs = [];
            ManagerModule.newVariantImages = [];
            UI.toast('Variante cr��e avec succ��s', 'success');
            ManagerModule.showVariantsModal(productId);
        },

        editVariant(variantId) {
            const variant = CORE.db.productVariants.find(v => v.id === variantId);
            if (!variant) return UI.toast('Variante introuvable', 'error');
            
            window.tempVariantAttrs = JSON.parse(JSON.stringify(variant.attributes || []));
            
            const p = CORE.getProduct(variant.productId);
            UI.modal(`�diter Variante: ${p?.name}`, `
                <div class="space-y-4">
                    ${UI.input('var_sku_edit','SKU','text',variant.sku || '','',false)}
                    <div class="space-y-3">
                        <div class="font-black text-slate-900">Attributs</div>
                        <div id="var_attrs_list_edit" class="space-y-2">
                            ${(variant.attributes || []).map((a, i) => `
                                <div class="p-3 rounded-lg bg-blue-50 border border-blue-200 flex items-center justify-between">
                                    <div class="font-bold text-slate-900">${a.name}: <span class="text-blue-600">${a.value}</span></div>
                                    <button onclick="ManagerModule.removeAttributeFromVariant(${i})" class="text-red-600 hover:text-red-800">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="border-t border-slate-200 pt-4 space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            ${UI.input('var_price_edit','Prix (XAF)','number',variant.price || '0','',false)}
                            ${UI.input('var_stock_edit','Stock','number',variant.stock || '0','',false)}
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            ${UI.input('var_weight_edit','Poids','text',variant.weight || '','',false)}
                            ${UI.input('var_temp_edit','Temp�rature','text',variant.temperature || '','',false)}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Sauvegarder', onclick: `ManagerModule.saveVariantEdit(${variantId})`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        saveVariantEdit(variantId) {
            const price = Number(UI.val('var_price_edit') || 0);
            const stock = Number(UI.val('var_stock_edit') || 0);
            const sku = UI.val('var_sku_edit').trim();
            const weight = UI.val('var_weight_edit').trim();
            const temperature = UI.val('var_temp_edit').trim();
            const attributes = window.tempVariantAttrs || [];
            
            if (price <= 0) return UI.toast('Prix invalide', 'warning');
            if (stock < 0) return UI.toast('Stock invalide', 'warning');
            
            CORE.update('productVariants', variantId, {
                attributes,
                sku: sku || `SKU-${variantId}`,
                price,
                stock,
                weight: weight || null,
                temperature: temperature || null
            });
            
            const variant = CORE.db.productVariants.find(v => v.id === variantId);
            window.tempVariantAttrs = [];
            UI.toast('Variante mise �� jour', 'success');
            ManagerModule.showVariantsModal(variant.productId);
        },

        deleteVariant(variantId) {
            if (!confirm('Supprimer cette variante ?')) return;
            const variant = CORE.db.productVariants.find(v => v.id === variantId);
            if (!variant) return;
            CORE.delete('productVariants', variantId);
            UI.toast('Variante supprim�e', 'success');
            ManagerModule.showVariantsModal(variant.productId);
        },

        showAdvancedStockModal(productId) {
            const p = CORE.getProduct(productId);
            if (!p) return;
            const posId = this.state.inventoryPosId ? parseInt(this.state.inventoryPosId, 10) : null;
            const currentStock = posId ? CORE.getProductStock(productId, posId) : (p.stock || 0);
            const variants = CORE.getProductVariants(productId);
            
            UI.modal(`Mouvement stock: ${p.name}`, `
                <div class="space-y-4">
                    ${posId ? `<div class="p-3 bg-blue-50 border border-blue-200 rounded-xl text-xs font-bold text-blue-900">POS s�lectionn�: Stock ind�pendant pour cette location</div>` : ''}
                    <div class="flex gap-2 mb-4">
                        <button onclick="document.getElementById('tab_main').style.display='block'; document.getElementById('tab_variants').style.display='none'; this.classList.add('bg-slate-900','text-white'); this.nextElementSibling.classList.remove('bg-slate-900','text-white')" class="flex-1 px-3 py-2 rounded-xl font-black bg-slate-900 text-white transition">Produit</button>
                        <button onclick="document.getElementById('tab_main').style.display='none'; document.getElementById('tab_variants').style.display='block'; this.classList.add('bg-slate-900','text-white'); this.previousElementSibling.classList.remove('bg-slate-900','text-white')" class="flex-1 px-3 py-2 rounded-xl font-black bg-slate-100 text-slate-700 hover:bg-slate-200 transition">Variantes (${variants.length})</button>
                    </div>

                    <div id="tab_main" style="display:block" class="space-y-4">
                        ${UI.select('ms_type','Type',[
                            {value:'in',label:'Entr�e (r�appro)'} ,
                            {value:'out',label:'Sortie'},
                            {value:'adjust',label:'Ajuster (fixer le stock)'}
                        ], 'in', true)}
                        ${UI.input('ms_qty','Quantit�','number','1','ex: 10',true)}
                        ${UI.input('ms_ref','R�f�rence','text','', 'ex: BL-2026-001', false)}
                        ${UI.textarea('ms_note','Note','','facultatif',3)}
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">Stock actuel: <b>${currentStock}</b> �� ?� � Min: <b>${p.minStock}</b></div>
                    </div>

                    <div id="tab_variants" style="display:none" class="space-y-3">
                        ${variants.length === 0 ? `
                            <div class="p-4 bg-slate-50 text-center rounded-xl text-slate-600 text-sm">
                                Aucune variante. <a href="javascript:GestionnaireModule.showManageVariantsModal(${productId})" class="text-blue-600 font-black">Cr�er une variante</a>
                            </div>
                        ` : `
                            ${variants.map((v, idx) => {
                                const status = CORE.getVariantStockStatus(v);
                                return `
                                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                        <div class="flex items-center justify-between mb-3">
                                            <div>
                                                <div class="text-xs text-slate-500">SKU: ${v.sku}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-sm font-black">${v.stock}</div>
                                                <div class="text-xs text-${status.color}-600 font-bold">${status.label}</div>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <input type="number" id="var_qty_${idx}" value="0" min="0" placeholder="Qt�" class="px-2 py-1 border border-slate-200 rounded text-sm font-medium">
                                            <select id="var_type_${idx}" class="px-2 py-1 border border-slate-200 rounded text-sm font-medium">
                                                <option value="set">D�finir stock</option>
                                                <option value="in">Ajouter</option>
                                                <option value="out">Retirer</option>
                                            </select>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        `}
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Appliquer', onclick: `ManagerModule.applyAdvancedStock(${productId})`, class: 'px-5 py-2.5 bg-sky-600 text-white font-black rounded-xl hover:bg-sky-700 transition' }
            ]);
        },

        applyAdvancedStock(productId) {
            const p = CORE.getProduct(productId);
            if (!p) return;
            const posId = this.state.inventoryPosId ? parseInt(this.state.inventoryPosId, 10) : null;
            const variants = CORE.getProductVariants(productId);
            
            // Appliquer �� la variante si tab_variants est visible
            const tabVariants = document.getElementById('tab_variants');
            if (tabVariants && tabVariants.style.display !== 'none' && variants.length > 0) {
                let anyApplied = false;
                variants.forEach((v, idx) => {
                    const qtyInput = document.getElementById(`var_qty_${idx}`);
                    const typeSelect = document.getElementById(`var_type_${idx}`);
                    
                    if (qtyInput && typeSelect) {
                        const qty = parseInt(qtyInput.value || '0', 10);
                        const type = typeSelect.value;
                        
                        if (qty > 0) {
                            let newStock = v.stock;
                            if (type === 'set') newStock = qty;
                            else if (type === 'in') newStock = v.stock + qty;
                            else if (type === 'out') newStock = Math.max(0, v.stock - qty);
                            
                            CORE.updateProductVariant(v.id, { stock: newStock });
                            anyApplied = true;
                        }
                    }
                });
                
                if (anyApplied) {
                    UI.closeModal();
                    UI.toast('Stock variantes mis �� jour', 'success');
                    App.rerender();
                    return;
                }
            }
            
            // Sinon appliquer au produit principal
            const type = UI.val('ms_type');
            const qtyRaw = UI.val('ms_qty');
            const qty = Math.abs(parseInt(qtyRaw || '0', 10));
            const ref = UI.val('ms_ref').trim();
            const note = UI.val('ms_note').trim();
            if (!qty && type !== 'adjust') return UI.toast('Quantit� invalide', 'warning');

            const currentStock = posId ? CORE.getProductStock(productId, posId) : (p.stock || 0);
            let next = currentStock;
            if (type === 'in') next = currentStock + qty;
            if (type === 'out') next = currentStock - qty;
            if (type === 'adjust') next = Number(qtyRaw || 0);
            if (next < 0) return UI.toast('Stock ne peut pas ��tre n�gatif', 'error');

            // Update per-POS stock if POS is selected
            if (posId) {
                CORE.setProductStock(productId, posId, next);
            } else {
                CORE.update('products', p.id, { stock: next });
            }
            
            CORE.recordStockMovement({ 
                productId: p.id, 
                type, 
                qty: type === 'adjust' ? next : qty, 
                ref: ref || null, 
                note: note || 'Mouvement stock (Manager)',
                posId: posId || null
            });
            UI.closeModal();
            UI.toast('Stock mis �� jour', 'success');
            App.rerender();
        },

        showMainProductModal(productId) {
            // Modal pour �diter un produit du d�p��t principal
            const product = CORE.getProduct(productId);
            if (!product) return;
            
            const categories = CORE.db.categories.map(c => ({ value: c.id, label: c.name }));
            
            const html = `
                <div class="space-y-4">
                    ${UI.input('mp_name', 'Nom du produit', 'text', product.name, '', true)}
                    ${UI.select('mp_category', 'Cat�gorie', categories, product.categoryId, true)}
                    ${UI.input('mp_price', 'Prix', 'number', product.price, '0', true)}
                    ${UI.input('mp_stock', 'Stock (D�p��t Principal)', 'number', product.stock || 0, '0', true)}
                    ${UI.input('mp_minstock', 'Stock Minimum', 'number', product.minStock || 0, '0', true)}
                    ${UI.input('mp_barcode', 'Code-barre', 'text', product.barcode || '', '', false)}
                </div>
            `;
            
            UI.modal(`��Ÿ? � �diter: ${product.name}`, html, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Sauvegarder', onclick: `ManagerModule.saveMainProductModal(${productId})`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        saveMainProductModal(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return;
            
            product.name = UI.val('mp_name');
            product.categoryId = parseInt(UI.val('mp_category'), 10);
            product.price = parseFloat(UI.val('mp_price')) || 0;
            product.stock = parseInt(UI.val('mp_stock'), 10) || 0;
            product.minStock = parseInt(UI.val('mp_minstock'), 10) || 0;
            product.barcode = UI.val('mp_barcode');
            
            CORE.save();
            UI.closeModal();
            UI.toast('Produit mis �� jour', 'success');
            App.rerender();
        },

        showNewCategoryQuickModal() {
            UI.modal('��ž� Cr�er une Cat�gorie', `
                <div class="space-y-4">
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                        Cr�ez rapidement une nouvelle cat�gorie de produits
                    </div>
                    ${UI.input('quick_cat_name', 'Nom de la cat�gorie', 'text', '', 'ex: �lectronique, V��tements', true)}
                    ${UI.textarea('quick_cat_desc', 'Description', 'Br��ve description (optionnel)', 100, false)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Cr�er', onclick: 'ManagerModule.createCategoryQuick()', class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        createCategoryQuick() {
            const name = UI.val('quick_cat_name')?.trim();
            const desc = UI.val('quick_cat_desc')?.trim() || '';
            
            if (!name) return UI.toast('Nom requis', 'warning');
            
            const newCategory = CORE.create('categories', {
                name: name,
                description: desc,
                active: true,
                createdAt: new Date().toISOString()
            });
            
            UI.closeModal();
            UI.toast(`���?� Cat�gorie "${name}" cr��e!`, 'success');
            
            // Actualiser le modal de r�appro
            setTimeout(() => {
                ManagerModule.showBulkRestockModal();
            }, 300);
        },

        showNewSupplierQuickModal() {
            UI.modal('��ž� Cr�er un Fournisseur', `
                <div class="space-y-4">
                    <div class="p-3 bg-green-50 border border-green-200 rounded-lg text-sm text-green-800">
                        Cr�ez rapidement un nouveau fournisseur/usine
                    </div>
                    ${UI.input('quick_supp_name', 'Nom du fournisseur', 'text', '', 'ex: Acme Corp, Usine XYZ', true)}
                    ${UI.input('quick_supp_contact', 'Contact', 'text', '', 'ex: email@fournisseur.com', false)}
                    ${UI.input('quick_supp_phone', 'T�l�phone', 'tel', '', 'ex: +212 6XX XXX XXX', false)}
                    ${UI.input('quick_supp_country', 'Pays', 'text', '', 'ex: Maroc, Chine', false)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Cr�er', onclick: 'ManagerModule.createSupplierQuick()', class: 'px-5 py-2.5 bg-green-600 text-white font-black rounded-xl hover:bg-green-700 transition' }
            ]);
        },

        createSupplierQuick() {
            const name = UI.val('quick_supp_name')?.trim();
            const contact = UI.val('quick_supp_contact')?.trim() || '';
            const phone = UI.val('quick_supp_phone')?.trim() || '';
            const country = UI.val('quick_supp_country')?.trim() || '';
            
            if (!name) return UI.toast('Nom requis', 'warning');
            
            const newSupplier = CORE.create('suppliers', {
                name: name,
                email: contact,
                phone: phone,
                country: country,
                active: true,
                createdAt: new Date().toISOString()
            });
            
            UI.closeModal();
            UI.toast(`���?� Fournisseur "${name}" cr��!`, 'success');
            
            // Actualiser le modal de r�appro
            setTimeout(() => {
                ManagerModule.showBulkRestockModal();
            }, 300);
        },

        showBulkRestockModal() {
            const products = CORE.db.products || [];
            const posId = this.state.inventoryPosId ? parseInt(this.state.inventoryPosId, 10) : null;
            const pos = posId ? CORE.getPOS(posId) : null;
            const categories = [...new Set(products.map(p => p.categoryId).filter(Boolean))];
            const suppliers = CORE.db.suppliers || [];
            
            // D�terminer les produits �� faible stock
            const lowStockProducts = products.filter(p => {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                return stock <= p.minStock && p.active !== false;
            }).sort((a, b) => {
                const ratioA = (a.stock || 0) / (a.minStock || 1);
                const ratioB = (b.stock || 0) / (b.minStock || 1);
                return ratioA - ratioB;
            });
            
            const criticalStockProducts = products.filter(p => {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                return stock <= (p.minStock * 0.5);
            });
            
            const outOfStockProducts = products.filter(p => {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                return stock === 0;
            });
            
            // Calculer les statistiques
            let totalToOrder = 0;
            let totalCost = 0;
            lowStockProducts.forEach(p => {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                const qty = Math.round((p.minStock || 0) * 2) - stock;
                totalToOrder += qty > 0 ? qty : 0;
                totalCost += qty > 0 ? qty * (p.price || 0) : 0;
            });
            
            // Statistiques par fournisseur
            const supplierStats = {};
            lowStockProducts.forEach(p => {
                const suppId = p.supplierId || 'none';
                if (!supplierStats[suppId]) {
                    const supplier = suppliers.find(s => s.id === suppId);
                    supplierStats[suppId] = { name: supplier?.name || 'Sans fournisseur', count: 0, qty: 0, cost: 0 };
                }
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                const qty = Math.max(0, Math.round((p.minStock || 0) * 2) - stock);
                supplierStats[suppId].count++;
                supplierStats[suppId].qty += qty;
                supplierStats[suppId].cost += qty * (p.price || 0);
            });
            
            // Statistiques par cat�gorie
            const categoryStats = {};
            lowStockProducts.forEach(p => {
                const catId = p.categoryId || 'none';
                if (!categoryStats[catId]) {
                    const cat = CORE.getCategory(catId);
                    categoryStats[catId] = { name: cat?.name || 'Non cat�goris�', count: 0 };
                }
                categoryStats[catId].count++;
            });
            
            // Initialiser la s�lection
            if (!window._bulkRestockSelection) {
                window._bulkRestockSelection = lowStockProducts.map(p => p.id);
            }
            
            const categoryOptions = categories.map(cId => {
                const cat = CORE.db.categories?.find(c => c.id === cId);
                const count = lowStockProducts.filter(p => p.categoryId === cId).length;
                return {value: cId, label: (cat?.name || 'Sans cat�gorie') + ` (${count})`};
            }).filter(o => o.label.includes('(') && !o.label.includes('(0)'));
            
            const supplierOptions = suppliers.map(s => {
                const count = lowStockProducts.filter(p => p.supplierId === s.id).length;
                return {value: s.id, label: s.name + ` (${count})`};
            }).filter(o => !o.label.includes('(0)'));
            
            const stockLevelOptions = [
                {value: 'all', label: `Tous les niveaux (${lowStockProducts.length})`},
                {value: 'critical', label: `��Ÿ� � Critique ��� �50% (${criticalStockProducts.length})`},
                {value: 'outofstock', label: `�� ��? Rupture totale (${outOfStockProducts.length})`}
            ];
            
            UI.modal('��Ÿ�? R�approvisionnement en Masse', `
                <div class="space-y-5 max-h-[85vh] overflow-y-auto">
                    <!-- En-t��te avec infos POS -->
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-5 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-xl font-black">��Ÿ? � R�appro Intelligente</div>
                                <div class="text-indigo-200 text-sm mt-1">${pos ? pos.name : 'Tous les points de vente'}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-black">${lowStockProducts.length}</div>
                                <div class="text-indigo-200 text-xs">produits en alerte</div>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs Principaux -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border border-blue-200">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                                    <i data-lucide="check-square" class="w-4 h-4 text-white"></i>
                                </div>
                                <span class="text-xs font-black text-blue-600 uppercase">S�lectionn�s</span>
                            </div>
                            <div id="bulk_selected_count" class="text-3xl font-black text-blue-900">${window._bulkRestockSelection.length}</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-xl border border-amber-200">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 bg-amber-500 rounded-lg flex items-center justify-center">
                                    <i data-lucide="package-plus" class="w-4 h-4 text-white"></i>
                                </div>
                                <span class="text-xs font-black text-amber-600 uppercase">�?� Commander</span>
                            </div>
                            <div id="bulk_order_display" class="text-3xl font-black text-amber-900">${totalToOrder}</div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-xl border border-emerald-200">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center">
                                    <i data-lucide="wallet" class="w-4 h-4 text-white"></i>
                                </div>
                                <span class="text-xs font-black text-emerald-600 uppercase">Budget Estim�</span>
                            </div>
                            <div id="bulk_cost_display" class="text-2xl font-black text-emerald-900">${CORE.formatPrice(totalCost)}</div>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-xl border border-red-200">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center">
                                    <i data-lucide="alert-octagon" class="w-4 h-4 text-white"></i>
                                </div>
                                <span class="text-xs font-black text-red-600 uppercase">Critiques</span>
                            </div>
                            <div class="text-3xl font-black text-red-900">${criticalStockProducts.length}</div>
                        </div>
                    </div>

                    <!-- R�partition par fournisseur -->
                    ${Object.keys(supplierStats).length > 0 ? `
                    <div class="bg-white rounded-xl border border-slate-200 p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="font-black text-slate-900 flex items-center gap-2">
                                <i data-lucide="truck" class="w-5 h-5 text-slate-600"></i>
                                R�partition par Fournisseur
                            </div>
                            <span class="text-xs text-slate-500">${Object.keys(supplierStats).length} fournisseur(s)</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            ${Object.entries(supplierStats).sort((a, b) => b[1].cost - a[1].cost).slice(0, 6).map(([id, stat]) => `
                                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition cursor-pointer" onclick="document.getElementById('bulk_supplier').value='${id !== 'none' ? id : ''}';document.getElementById('bulk_supplier').dispatchEvent(new Event('change'))">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center text-white text-xs font-black">${stat.count}</div>
                                        <div>
                                            <div class="font-bold text-slate-900 text-sm">${stat.name}</div>
                                            <div class="text-xs text-slate-500">${stat.qty} unit�s</div>
                                        </div>
                                    </div>
                                    <div class="font-black text-emerald-600 text-sm">${CORE.formatPrice(stat.cost)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Filtres avanc�s -->
                    <div class="bg-slate-50 rounded-xl border border-slate-200 p-4">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="filter" class="w-5 h-5 text-slate-600"></i>
                            <span class="font-black text-slate-900">Filtres & Recherche</span>
                        </div>
                        
                        <!-- Recherche -->
                        <div class="relative mb-4">
                            <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                            <input type="text" id="bulk_product_search" placeholder="Rechercher par nom, code, code-barres..." class="pl-10 pr-4 py-3 w-full rounded-xl border border-slate-200 font-medium bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        </div>
                        
                        <!-- Grille de filtres -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-black text-slate-600 uppercase mb-2 block">Cat�gorie</label>
                                <select id="bulk_category" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 text-sm font-bold bg-white">
                                    <option value="">��Ÿ? � Toutes les cat�gories</option>
                                    ${categoryOptions.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600 uppercase mb-2 block">Fournisseur</label>
                                <select id="bulk_supplier" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 text-sm font-bold bg-white">
                                    <option value="">��Ÿ � � Tous les fournisseurs</option>
                                    ${supplierOptions.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600 uppercase mb-2 block">Niveau Stock</label>
                                <select id="bulk_stock_level" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 text-sm font-bold bg-white">
                                    ${stockLevelOptions.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Param��tres de r�approvisionnement -->
                    <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-200 p-4">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="settings" class="w-5 h-5 text-amber-600"></i>
                            <span class="font-black text-slate-900">Param��tres de R�appro</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="text-xs font-black text-slate-600 uppercase mb-2 block">Multiplicateur Stock Min</label>
                                <div class="flex items-center gap-2">
                                    <button onclick="let i=document.getElementById('bulk_multiplier');i.value=Math.max(1,parseFloat(i.value)-0.5);i.dispatchEvent(new Event('input'))" class="w-10 h-10 bg-white border border-slate-200 rounded-xl font-black text-lg hover:bg-slate-50">-</button>
                                    <input type="number" id="bulk_multiplier" value="2" min="1" max="10" step="0.5" class="flex-1 px-4 py-2.5 rounded-xl border border-slate-200 font-black text-center text-lg bg-white" oninput="ManagerModule.updateBulkRestockPreview()">
                                    <button onclick="let i=document.getElementById('bulk_multiplier');i.value=Math.min(10,parseFloat(i.value)+0.5);i.dispatchEvent(new Event('input'))" class="w-10 h-10 bg-white border border-slate-200 rounded-xl font-black text-lg hover:bg-slate-50">+</button>
                                </div>
                                <div class="text-xs text-amber-600 mt-1 text-center">Stock cible = Min �?? <span id="mult_display">2</span></div>
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600 uppercase mb-2 block">R�f�rence Commande</label>
                                <input type="text" id="bulk_ref" placeholder="Auto-g�n�r� si vide" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-white">
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600 uppercase mb-2 block">Options</label>
                                <label class="flex items-center gap-3 p-3 bg-white rounded-xl border border-slate-200 cursor-pointer hover:bg-slate-50">
                                    <input type="checkbox" id="bulk_auto_purchase" checked class="w-5 h-5 rounded">
                                    <div>
                                        <div class="font-bold text-slate-900 text-sm">Auto-cr�er commandes</div>
                                        <div class="text-xs text-slate-500">G�n��re les bons de commande</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Liste des produits -->
                    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                            <div class="font-black text-slate-900 flex items-center gap-2">
                                <i data-lucide="list-checks" class="w-5 h-5"></i>
                                S�lection des Produits
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="ManagerModule.bulkSelectAll(true)" class="px-3 py-1.5 bg-emerald-100 text-emerald-700 rounded-lg text-xs font-black hover:bg-emerald-200 transition flex items-center gap-1">
                                    <i data-lucide="check-check" class="w-3 h-3"></i> Tout
                                </button>
                                <button onclick="ManagerModule.bulkSelectAll(false)" class="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-xs font-black hover:bg-red-200 transition flex items-center gap-1">
                                    <i data-lucide="x" class="w-3 h-3"></i> Aucun
                                </button>
                                <button onclick="ManagerModule.bulkSelectCritical()" class="px-3 py-1.5 bg-amber-100 text-amber-700 rounded-lg text-xs font-black hover:bg-amber-200 transition flex items-center gap-1">
                                    <i data-lucide="alert-triangle" class="w-3 h-3"></i> Critiques
                                </button>
                            </div>
                        </div>
                        
                        <div id="bulk_product_list" class="divide-y divide-slate-100 max-h-[400px] overflow-y-auto">
                            ${lowStockProducts.length === 0 ? `
                                <div class="p-8 text-center text-slate-400">
                                    <i data-lucide="package-check" class="w-16 h-16 mx-auto mb-4 opacity-30"></i>
                                    <div class="font-bold text-lg">Tous les stocks sont OK! ��ŸŽ�</div>
                                    <div class="text-sm">Aucun produit sous le seuil minimum</div>
                                </div>
                            ` : lowStockProducts.map(p => {
                                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                                const supplier = suppliers.find(s => s.id === p.supplierId);
                                const category = CORE.getCategory(p.categoryId);
                                const minStock = p.minStock || 0;
                                const nextStock = Math.round(minStock * 2);
                                const toOrder = Math.max(0, nextStock - stock);
                                const estimatedCost = toOrder * (p.price || 0);
                                const stockPercent = minStock > 0 ? Math.round((stock / minStock) * 100) : 0;
                                const isCritical = stockPercent <= 50;
                                const isOutOfStock = stock === 0;
                                
                                return `
                                    <div class="p-4 hover:bg-slate-50 transition group" data-product-item="${p.id}" data-product-name="${(p.name || '').toLowerCase()}" data-product-code="${(p.code || '').toLowerCase()}" data-product-barcode="${(p.barcode || '').toLowerCase()}" data-category="${p.categoryId || ''}" data-supplier="${p.supplierId || ''}" data-stock-percent="${stockPercent}">
                                        <div class="flex items-start gap-4">
                                            <div class="pt-1">
                                                <input type="checkbox" data-bulk-check data-product-id="${p.id}" data-order-qty="${toOrder}" data-order-cost="${estimatedCost}" data-is-critical="${isCritical}" ${window._bulkRestockSelection?.includes(p.id) ? 'checked' : ''} class="w-5 h-5 rounded-lg border-2 border-slate-300 checked:bg-indigo-600 checked:border-indigo-600 cursor-pointer">
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="font-black text-slate-900">${p.name}</span>
                                                    ${isOutOfStock ? '<span class="px-2 py-0.5 bg-red-600 text-white rounded text-xs font-black">RUPTURE</span>' : 
                                                      isCritical ? '<span class="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs font-black">CRITIQUE</span>' : 
                                                      '<span class="px-2 py-0.5 bg-amber-100 text-amber-700 rounded text-xs font-black">BAS</span>'}
                                                </div>
                                                <div class="flex flex-wrap gap-2 text-xs">
                                                    ${p.barcode ? `<span class="px-2 py-1 bg-slate-100 rounded text-slate-600">��Ÿ?Š ${p.barcode}</span>` : ''}
                                                    ${category ? `<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded font-bold">${category.name}</span>` : ''}
                                                    ${supplier ? `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded font-bold">��Ÿ � � ${supplier.name}</span>` : ''}
                                                </div>
                                            </div>
                                            <div class="text-right flex-shrink-0">
                                                <div class="flex items-center gap-3 mb-2">
                                                    <div class="text-center">
                                                        <div class="text-xs text-slate-500">Actuel</div>
                                                        <div class="text-xl font-black ${isCritical ? 'text-red-600' : 'text-amber-600'}">${stock}</div>
                                                    </div>
                                                    <div class="text-slate-300">���?</div>
                                                    <div class="text-center">
                                                        <div class="text-xs text-slate-500">Cible</div>
                                                        <div class="text-xl font-black text-emerald-600" data-target-stock="${nextStock}">${nextStock}</div>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <div class="w-24 h-2 bg-slate-200 rounded-full overflow-hidden">
                                                        <div class="h-full ${isCritical ? 'bg-red-500' : 'bg-amber-500'} rounded-full" style="width: ${Math.min(100, stockPercent)}%"></div>
                                                    </div>
                                                    <span class="text-xs font-black ${isCritical ? 'text-red-600' : 'text-amber-600'}">${stockPercent}%</span>
                                                </div>
                                            </div>
                                            <div class="flex-shrink-0 w-28 text-right">
                                                <div class="px-3 py-2 bg-emerald-100 rounded-xl">
                                                    <div class="text-xs text-emerald-600 font-bold">�?� commander</div>
                                                    <div class="text-lg font-black text-emerald-700" data-order-qty-display>+${toOrder}</div>
                                                </div>
                                                <div class="text-xs text-slate-500 mt-1">${CORE.formatPrice(estimatedCost)}</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        ${lowStockProducts.length > 20 ? `
                        <div class="p-3 bg-slate-50 border-t border-slate-100 text-center text-xs text-slate-500">
                            Affichage de ${Math.min(lowStockProducts.length, 50)} produits sur ${lowStockProducts.length}
                        </div>
                        ` : ''}
                    </div>

                    <!-- R�sum� final -->
                    <div class="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-2xl p-5 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-black text-lg">��Ÿ?� R�sum� de la Commande</div>
                                <div class="text-emerald-100 text-sm mt-1">V�rifiez avant de valider</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-emerald-200 uppercase">Co��t total estim�</div>
                                <div id="bulk_total_summary" class="text-3xl font-black">${CORE.formatPrice(totalCost)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal(); window._bulkRestockSelection = null;' },
                { label: '��Ÿš ?� Appliquer R�approvisionnement', onclick: 'ManagerModule.applyBulkRestock()', class: 'px-6 py-3 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-black rounded-xl hover:from-emerald-600 hover:to-teal-700 transition shadow-lg' }
            ]);
            
            // Ajouter les event listeners pour mettre �� jour la s�lection
            setTimeout(() => {
                // Mise �� jour du compteur et co��t total en temps r�el
                const updateStats = () => {
                    const mult = parseFloat(document.getElementById('bulk_multiplier')?.value || 2);
                    const selected = Array.from(document.querySelectorAll('[data-bulk-check]:checked'));
                    
                    let totalQty = 0;
                    let totalCost = 0;
                    
                    selected.forEach(c => {
                        const productId = parseInt(c.dataset.productId);
                        const product = products.find(p => p.id === productId);
                        if (product) {
                            const stock = posId ? CORE.getProductStock(product.id, posId) : (product.stock || 0);
                            const targetStock = Math.round((product.minStock || 0) * mult);
                            const qty = Math.max(0, targetStock - stock);
                            totalQty += qty;
                            totalCost += qty * (product.price || 0);
                        }
                    });
                    
                    const selectedCountEl = document.getElementById('bulk_selected_count');
                    if (selectedCountEl) selectedCountEl.textContent = selected.length;
                    
                    const orderDiv = document.getElementById('bulk_order_display');
                    if (orderDiv) orderDiv.textContent = totalQty;
                    
                    const costDiv = document.getElementById('bulk_cost_display');
                    if (costDiv) costDiv.textContent = CORE.formatPrice(totalCost);
                    
                    const summaryDiv = document.getElementById('bulk_total_summary');
                    if (summaryDiv) summaryDiv.textContent = CORE.formatPrice(totalCost);
                    
                    const multDisplay = document.getElementById('mult_display');
                    if (multDisplay) multDisplay.textContent = mult;
                    
                    // Sauvegarder la s�lection
                    window._bulkRestockSelection = selected.map(c => parseInt(c.dataset.productId));
                };
                
                // Event listener pour les checkboxes
                document.querySelectorAll('[data-bulk-check]').forEach(checkbox => {
                    checkbox.addEventListener('change', updateStats);
                });
                
                // Event listener pour le multiplicateur
                const multInput = document.getElementById('bulk_multiplier');
                if (multInput) {
                    multInput.addEventListener('input', () => {
                        const mult = parseFloat(multInput.value || 2);
                        // Mettre �� jour les quantit�s affich�es pour chaque produit
                        document.querySelectorAll('[data-product-item]').forEach(item => {
                            const productId = parseInt(item.dataset.productItem);
                            const product = products.find(p => p.id === productId);
                            if (product) {
                                const stock = posId ? CORE.getProductStock(product.id, posId) : (product.stock || 0);
                                const targetStock = Math.round((product.minStock || 0) * mult);
                                const qty = Math.max(0, targetStock - stock);
                                const cost = qty * (product.price || 0);
                                
                                const qtyDisplay = item.querySelector('[data-order-qty-display]');
                                if (qtyDisplay) qtyDisplay.textContent = '+' + qty;
                                
                                const targetDisplay = item.querySelector('[data-target-stock]');
                                if (targetDisplay) targetDisplay.textContent = targetStock;
                                
                                const checkbox = item.querySelector('[data-bulk-check]');
                                if (checkbox) {
                                    checkbox.dataset.orderQty = qty;
                                    checkbox.dataset.orderCost = cost;
                                }
                            }
                        });
                        updateStats();
                    });
                }
                
                // Recherche en temps r�el
                const searchInput = document.getElementById('bulk_product_search');
                const categorySelect = document.getElementById('bulk_category');
                const supplierSelect = document.getElementById('bulk_supplier');
                const stockLevelSelect = document.getElementById('bulk_stock_level');
                
                // Fonction pour appliquer tous les filtres
                const applyFilters = () => {
                    const query = (searchInput?.value || '').toLowerCase();
                    const catId = categorySelect?.value || '';
                    const suppId = supplierSelect?.value || '';
                    const stockLevel = stockLevelSelect?.value || 'all';
                    
                    document.querySelectorAll('[data-product-item]').forEach(item => {
                        const stockPercent = parseInt(item.dataset.stockPercent || 100);
                        const isOutOfStock = stockPercent === 0;
                        const isCritical = stockPercent <= 50;
                        
                        const matchesSearch = !query || 
                            (item.dataset.productName || '').includes(query) ||
                            (item.dataset.productCode || '').includes(query) ||
                            (item.dataset.productBarcode || '').includes(query);
                        
                        const matchesCategory = !catId || item.dataset.category === catId;
                        const matchesSupplier = !suppId || item.dataset.supplier === suppId;
                        
                        let matchesStockLevel = true;
                        if (stockLevel === 'critical') matchesStockLevel = isCritical;
                        else if (stockLevel === 'outofstock') matchesStockLevel = isOutOfStock;
                        
                        const show = matchesSearch && matchesCategory && matchesSupplier && matchesStockLevel;
                        item.style.display = show ? '' : 'none';
                    });
                };
                
                if (searchInput) searchInput.addEventListener('input', applyFilters);
                if (categorySelect) categorySelect.addEventListener('change', applyFilters);
                if (supplierSelect) supplierSelect.addEventListener('change', applyFilters);
                if (stockLevelSelect) stockLevelSelect.addEventListener('change', applyFilters);
                
                // Appel initial pour mettre �� jour les stats
                updateStats();
                lucide.createIcons();
            }, 50);
        },

        // Fonctions helper pour la s�lection en masse
        bulkSelectAll(selectAll) {
            document.querySelectorAll('[data-product-item]').forEach(item => {
                if (item.style.display !== 'none') {
                    const checkbox = item.querySelector('[data-bulk-check]');
                    if (checkbox) {
                        checkbox.checked = selectAll;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                }
            });
        },

        bulkSelectCritical() {
            document.querySelectorAll('[data-product-item]').forEach(item => {
                if (item.style.display !== 'none') {
                    const checkbox = item.querySelector('[data-bulk-check]');
                    const isCritical = checkbox?.dataset.isCritical === 'true';
                    if (checkbox) {
                        checkbox.checked = isCritical;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                }
            });
        },

        updateBulkRestockPreview() {
            const multInput = document.getElementById('bulk_multiplier');
            if (multInput) {
                multInput.dispatchEvent(new Event('input'));
            }
        },

        applyBulkRestock() {
            const mult = Utils.clamp(parseFloat(UI.val('bulk_multiplier') || '2'), 1, 50);
            const ref = UI.val('bulk_ref').trim() || `BULK-${Utils.uid('BL')}`;
            const autoPurchase = document.getElementById('bulk_auto_purchase')?.checked;
            const posId = this.state.inventoryPosId ? parseInt(this.state.inventoryPosId, 10) : null;
            
            // R�cup�rer les produits s�lectionn�s
            const selectedIds = Array.from(document.querySelectorAll('[data-bulk-check]:checked')).map(c => parseInt(c.dataset.productId));
            if (selectedIds.length === 0) return UI.toast('Aucun produit s�lectionn�', 'warning');
            
            const products = CORE.db.products || [];
            const targets = products.filter(p => selectedIds.includes(p.id));
            
            let totalQuantity = 0;
            let totalCost = 0;
            const orders = [];
            
            targets.forEach(p => {
                const currentStock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                const targetStock = Math.max(currentStock, Math.round(Number(p.minStock || 0) * mult));
                const delta = targetStock - currentStock;
                if (delta > 0) {
                    // Update per-POS stock if selected
                    if (posId) {
                        CORE.setProductStock(p.id, posId, targetStock);
                    } else {
                        CORE.update('products', p.id, { stock: targetStock });
                    }
                    
                    CORE.recordStockMovement({ 
                        productId: p.id, 
                        type: 'in', 
                        qty: delta, 
                        ref, 
                        note: `R�appro masse (�??${mult})`,
                        posId: posId || null
                    });
                    
                    totalQuantity += delta;
                    const itemCost = delta * (p.price || 0);
                    totalCost += itemCost;
                    
                    // Pr�parer les donn�es pour les commandes d'achat
                    if (autoPurchase && p.supplierId) {
                        orders.push({
                            productId: p.id,
                            supplierId: p.supplierId,
                            qty: delta,
                            unitPrice: p.price || 0,
                            totalCost: itemCost
                        });
                    }
                }
            });
            
            // Cr�er les commandes d'achat si demand�
            if (autoPurchase && orders.length > 0) {
                orders.forEach(order => {
                    const poRef = `PO-${Utils.uid('PO').substring(0,6)}`;
                    const po = CORE.create('purchaseOrders', {
                        reference: poRef,
                        supplierId: order.supplierId,
                        productId: order.productId,
                        qty: order.qty,
                        unitPrice: order.unitPrice,
                        transportPrice: 0,
                        totalCost: order.totalCost,
                        status: 'pending',
                        note: `Auto-g�n�r�e via r�appro masse (${ref})`,
                        createdAt: new Date().toISOString()
                    });
                    
                    // Cr�er l'enregistrement de d�pense
                    const supplier = CORE.db.suppliers?.find(s => s.id === order.supplierId);
                    const product = CORE.db.products?.find(p => p.id === order.productId);
                    CORE.create('expenses', {
                        reference: poRef,
                        type: 'purchase_order',
                        description: `R�appro masse - ${product?.name || 'Produit'} chez ${supplier?.name || 'Fournisseur'}`,
                        amount: order.totalCost,
                        supplier: supplier?.name || 'Non sp�cifi�',
                        category: 'r�approvisionnement',
                        status: 'pending',
                        purchaseOrderId: po.id,
                        createdAt: new Date().toISOString()
                    });
                });
            }
            
            UI.closeModal();
            window._bulkRestockSelection = null;
            UI.toast(`���?� ${targets.length} produits r�approvionn�s | ${totalQuantity} unit�s | ${CORE.formatPrice(totalCost)}`, 'success');
            App.rerender();
        },

        analyzeRestockingPatterns(posId = null) {
            const rawProducts = CORE.db.products || [];
            const rawMovements = CORE.db.stockMovements || [];
            const rawPurchaseOrders = CORE.db.purchaseOrders || [];

            const numericPosId = posId === null || posId === undefined ? null : Number(posId);
            const targetPosId = numericPosId === null || Number.isNaN(numericPosId) ? null : numericPosId;

            const products = rawProducts.filter(product => this.productBelongsToPos(product, targetPosId));

            const touchesPos = (movement) => {
                if (!targetPosId) return true;
                const basePos = Number(movement.posId);
                const fromPos = Number(movement.fromPosId);
                const toPos = Number(movement.toPosId);
                return basePos === targetPosId || fromPos === targetPosId || toPos === targetPosId;
            };

            const relevantMovements = rawMovements.filter(touchesPos);

            const purchaseOrders = rawPurchaseOrders.filter(po => {
                if (!targetPosId) return true;
                if (po.posId === undefined || po.posId === null) return false;
                return Number(po.posId) === targetPosId;
            });

            const getStock = (product) => targetPosId ? CORE.getProductStock(product.id, targetPosId) : Number(product.stock || 0);
            const getPrice = (product) => targetPosId ? CORE.getProductPrice(product.id, targetPosId) : Number(product.price || 0);
            const getMin = (product) => Number(product.minStock || 0);

            const totalStock = products.reduce((sum, p) => sum + getStock(p), 0);

            const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
            const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;

            const movementDate = (movement) => new Date(movement.createdAt || movement.timestamp || movement.loggedAt || movement.date || Date.now());
            const movementQty = (movement) => Number(movement.qty ?? movement.quantity ?? 0);

            const recentMovementsIn = relevantMovements
                .filter(m => m.type === 'in' && movementDate(m).getTime() >= sevenDaysAgo)
                .reduce((sum, m) => sum + movementQty(m), 0);

            const recentMovementsOut = relevantMovements
                .filter(m => m.type === 'out' && movementDate(m).getTime() >= sevenDaysAgo)
                .reduce((sum, m) => sum + movementQty(m), 0);

            const topMovingProducts = products
                .map(product => {
                    const windowMovements = relevantMovements.filter(m => m.productId === product.id && movementDate(m).getTime() >= thirtyDaysAgo);
                    const inQty = windowMovements.filter(m => m.type === 'in').reduce((sum, m) => sum + movementQty(m), 0);
                    const outQty = windowMovements.filter(m => m.type === 'out').reduce((sum, m) => sum + movementQty(m), 0);
                    const currentStock = getStock(product);
                    return {
                        product,
                        inQty,
                        outQty,
                        netFlow: outQty - inQty,
                        turns: currentStock > 0 ? outQty / currentStock : outQty,
                        currentStock
                    };
                })
                .sort((a, b) => (b.turns || 0) - (a.turns || 0))
                .slice(0, 10);

            const totalInventoryValue = products.reduce((sum, product) => sum + getStock(product) * getPrice(product), 0);

            const analysis = {
                totalProducts: products.length,
                lowStockProducts: products.filter(p => getStock(p) <= getMin(p)).length,
                criticalStockProducts: products.filter(p => getStock(p) <= (getMin(p) * 0.5)).length,
                overStockProducts: products.filter(p => getStock(p) > (getMin(p) * 3)).length,
                averageStockLevel: products.length > 0 ? Math.round(totalStock / products.length) : 0,
                totalInventoryValue,
                recentMovementsIn,
                recentMovementsOut,
                topMovingProducts,
                supplierStats: (CORE.db.suppliers || []).map(supplier => {
                    const supplierProducts = products.filter(p => p.supplierId === supplier.id);
                    const supplierOrders = purchaseOrders.filter(po => po.supplierId === supplier.id);
                    return {
                        supplier,
                        productsCount: supplierProducts.length,
                        pendingOrders: supplierOrders.filter(po => po.status !== 'received').length,
                        totalSpent: supplierOrders.reduce((sum, po) => sum + (po.totalCost || 0), 0)
                    };
                })
            };

            return analysis;
        },

        showStockTransferModal(sourcePosId) {
            const products = CORE.db.products || [];
            const posList = CORE.db.pointsOfSale || [];
            
            if (posList.length < 2) {
                return UI.toast('Vous devez avoir au moins 2 POS pour transf�rer du stock', 'warning');
            }

            // D�terminer le POS source (celui qui initie le transfert)
            let sourcePos = null;
            const currentUserPosId = CORE.state.currentUser?.pos;
            if (sourcePosId) {
                sourcePos = CORE.getPOS(sourcePosId) || null;
            }
            if (!sourcePos && currentUserPosId) {
                sourcePos = CORE.getPOS(currentUserPosId) || null;
            }
            if (!sourcePos) {
                sourcePos = posList[0];
            }

            // Calculer les stats globales
            const stockStats = {};
            posList.forEach(pos => {
                const posProducts = products.filter(p => CORE.getProductStock(p.id, pos.id) > 0);
                const totalStock = posProducts.reduce((sum, p) => sum + (CORE.getProductStock(p.id, pos.id) || 0), 0);
                const totalValue = posProducts.reduce((sum, p) => sum + ((CORE.getProductStock(p.id, pos.id) || 0) * (p.price || 0)), 0);
                const criticalCount = posProducts.filter(p => (CORE.getProductStock(p.id, pos.id) || 0) <= (p.minStock || 0)).length;
                stockStats[pos.id] = { totalStock, totalValue, criticalCount, productCount: posProducts.length };
            });

            // Suggestions intelligentes filtr�es pour ce POS source
            const suggestions = [];
            posList.forEach((destPos) => {
                if (sourcePos.id === destPos.id) return;
                products.forEach(p => {
                    const srcStock = CORE.getProductStock(p.id, sourcePos.id) || 0;
                    const dstStock = CORE.getProductStock(p.id, destPos.id) || 0;
                    const minStock = p.minStock || 0;
                    const destTarget = Math.max(minStock * 2, minStock + 20);
                    const destDeficit = Math.max(0, destTarget - dstStock);
                    
                    if (srcStock <= 0 || destDeficit <= 0) return;
                    
                    const suggestedQty = Math.min(srcStock, destDeficit);
                    suggestions.push({
                        productId: p.id,
                        productName: p.name,
                        sourcePosId: sourcePos.id,
                        sourcePosName: sourcePos.name,
                        destPosId: destPos.id,
                        destPosName: destPos.name,
                        sourceStock: srcStock,
                        destStock: dstStock,
                        minStock,
                        suggestedQty,
                        severity: dstStock <= Math.max(1, minStock * 0.5) ? 'critical' : 'low'
                    });
                });
            });

            suggestions.sort((a, b) => {
                if (a.severity !== b.severity) return a.severity === 'critical' ? -1 : 1;
                return b.suggestedQty - a.suggestedQty;
            });

            const topSuggestions = suggestions.slice(0, 5);
            const defaultSourcePos = sourcePos;
            const defaultDestPos = posList.find(p => p.id !== defaultSourcePos.id) || posList[0];
            const defaultProduct = products[0];
            const defaultSuggestion = topSuggestions[0] || null;

            const html = `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="p-4 rounded-2xl bg-blue-50 border border-blue-200">
                            <div class="text-xs font-black text-blue-600 uppercase">Stock total en POS</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${products.reduce((sum, p) => sum + (CORE.getProductStock(p.id, defaultSourcePos.id) || 0), 0).toLocaleString('fr-FR')}</div>
                            <div class="text-[11px] text-blue-700">Unit�s disponibles</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-200">
                            <div class="text-xs font-black text-emerald-600 uppercase">Valeur estim�e</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${CORE.formatPrice(products.reduce((sum, p) => sum + ((CORE.getProductStock(p.id, defaultSourcePos.id) || 0) * (p.price || 0)), 0))}</div>
                            <div class="text-[11px] text-emerald-700">Stock valoris�</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-amber-50 border border-amber-200">
                            <div class="text-xs font-black text-amber-600 uppercase">Opportunit�s</div>
                            <div class="text-2xl font-black text-amber-900 mt-1">${suggestions.length}</div>
                            <div class="text-[11px] text-amber-700">Transferts sugg�r�s</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                        <div class="space-y-4">
                            <div class="p-5 bg-white rounded-3xl border border-slate-200 space-y-4">
                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">POS Source (qui c��de)</label>
                                    <select id="tf_source_pos" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-blue-500">
                                        ${posList.map(pos => `
                                            <option value="${pos.id}" ${pos.id === defaultSourcePos.id ? 'selected' : ''}>
                                                ${pos.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Produit �� transf�rer</label>
                                    <select id="tf_product" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-blue-500">
                                        ${products.filter(p => (CORE.getProductStock(p.id, defaultSourcePos.id) || 0) > 0).map(p => `
                                            <option value="${p.id}" ${p.id === defaultProduct?.id ? 'selected' : ''}>
                                                ${p.name} �� ?� � Stock: ${CORE.getProductStock(p.id, defaultSourcePos.id) || 0}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">POS Destination (qui re��oit)</label>
                                    <select id="tf_dest_pos" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-blue-500">
                                        ${posList.filter(pos => pos.id !== defaultSourcePos.id).map(pos => `
                                            <option value="${pos.id}" ${pos.id === defaultDestPos.id ? 'selected' : ''}>
                                                ${pos.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-3 text-center text-sm">
                                    <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                        <div class="text-xs font-bold text-slate-500 uppercase">Stock source</div>
                                        <div id="tf_summary_source" class="text-xl font-black text-slate-900">0</div>
                                    </div>
                                    <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                        <div class="text-xs font-bold text-slate-500 uppercase">Stock dest.</div>
                                        <div id="tf_summary_dest" class="text-xl font-black text-slate-900">0</div>
                                    </div>
                                </div>

                                <div class="p-3 rounded-2xl bg-emerald-50 border border-emerald-200">
                                    <div class="flex items-center justify-between text-sm font-bold text-emerald-700">
                                        <span>Stock source apr��s transfert</span>
                                        <span id="tf_summary_after">0</span>
                                    </div>
                                </div>

                                <div class="flex flex-wrap gap-2">
                                    <button data-tf-set="suggested" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700 transition">Suggestion IA</button>
                                    <button data-tf-set="half" class="px-3 py-2 rounded-xl bg-blue-600 text-white text-xs font-black hover:bg-blue-700 transition">50%</button>
                                    <button data-tf-set="+25" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300 transition">+25</button>
                                    <button data-tf-set="+50" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300 transition">+50</button>
                                    <button data-tf-set="clear" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-100 transition">R�initialiser</button>
                                </div>

                                <div class="grid grid-cols-2 gap-3 items-end">
                                    <div>
                                        <label class="block text-xs font-black text-slate-500 uppercase mb-2">Quantit� �� transf�rer</label>
                                        <input id="tf_qty" type="number" min="0" value="0" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-black text-lg text-center bg-white focus:ring-2 focus:ring-purple-500">
                                        <div id="tf_warning" class="mt-2 text-xs font-bold text-red-600 hidden">��š ��� � � Stock insuffisant</div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-black text-slate-500 uppercase mb-2">R�f�rence</label>
                                        <input id="tf_ref" type="text" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-slate-50" placeholder="Auto-g�n�r�" readonly>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Motif du transfert</label>
                                    <textarea id="tf_reason" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-white" rows="2" placeholder="Ex: R��quilibrage stocks, r�appro..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="p-5 bg-white rounded-3xl border border-slate-200">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="font-black text-slate-900 text-sm">��ŸŽ � Transferts sugg�r�s</div>
                                    <span class="text-xs text-slate-500 font-bold">${topSuggestions.length} opportunit�s</span>
                                </div>
                                ${topSuggestions.length === 0 ? `
                                    <div class="p-4 rounded-2xl bg-slate-50 text-sm text-slate-500 text-center">
                                        Aucune opportunit� de transfert d�tect�e.
                                    </div>
                                ` : `
                                    <div class="space-y-2">
                                        ${topSuggestions.map(s => `
                                            <div class="p-3 rounded-2xl border ${s.severity === 'critical' ? 'border-red-200 bg-red-50' : 'border-amber-200 bg-amber-50'} flex items-center justify-between gap-3">
                                                <div>
                                                    <div class="font-black text-slate-900 text-sm">${s.productName}</div>
                                                    <div class="text-xs text-slate-600">${s.sourcePosName} ���? ${s.destPosName}</div>
                                                    <div class="text-xs font-bold text-slate-500">Suggestion: ${s.suggestedQty} unit�s</div>
                                                </div>
                                                <button data-tf-suggestion data-source-id="${s.sourcePosId}" data-dest-id="${s.destPosId}" data-product-id="${s.productId}" data-suggested-qty="${s.suggestedQty}" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-xs font-black hover:bg-slate-800 transition">Appliquer</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>

                            <div class="p-5 bg-white rounded-3xl border border-slate-200">
                                <div class="font-black text-slate-900 text-sm mb-3">��Ÿ?Š POS Destinations possibles</div>
                                <div class="space-y-2 text-sm">
                                    ${posList.filter(pos => pos.id !== defaultSourcePos.id).map(pos => {
                                        const stats = stockStats[pos.id] || {};
                                        return `
                                            <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                                <div class="flex items-center justify-between mb-1">
                                                    <span class="font-black text-slate-900">${pos.name}</span>
                                                    <span class="text-xs font-bold text-slate-600">${stats.totalStock || 0} unit�s</span>
                                                </div>
                                                <div class="text-xs text-slate-600">${stats.productCount} produits �� ?� � ${stats.criticalCount} critique(s)</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            UI.modal('��Ÿ�? Transf�rer Stock entre POS', html, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Transf�rer', onclick: 'ManagerModule.executeStockTransfer()', class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition' }
            ]);

            setTimeout(() => {
                const modalEl = document.querySelector('#modalContainer .slide-up');
                if (modalEl) {
                    modalEl.classList.remove('max-w-lg');
                    modalEl.classList.add('max-w-5xl');
                }

                const sourcePosSelect = document.getElementById('tf_source_pos');
                const destPosSelect = document.getElementById('tf_dest_pos');
                const productSelect = document.getElementById('tf_product');
                const qtyInput = document.getElementById('tf_qty');
                const refInput = document.getElementById('tf_ref');
                const summarySource = document.getElementById('tf_summary_source');
                const summaryDest = document.getElementById('tf_summary_dest');
                const summaryAfter = document.getElementById('tf_summary_after');
                const warning = document.getElementById('tf_warning');

                const updateSummary = () => {
                    const productId = parseInt(productSelect.value, 10);
                    const sourceId = parseInt(sourcePosSelect.value, 10);
                    const destId = parseInt(destPosSelect.value, 10);
                    const qty = parseInt(qtyInput.value || 0, 10);
                    
                    const sourceStock = CORE.getProductStock(productId, sourceId) || 0;
                    const destStock = CORE.getProductStock(productId, destId) || 0;
                    const newSourceStock = Math.max(0, sourceStock - qty);

                    summarySource.textContent = sourceStock;
                    summaryDest.textContent = destStock;
                    summaryAfter.textContent = `${newSourceStock} unit�s`;

                    warning.classList.toggle('hidden', qty <= sourceStock);
                };

                const updateDestPos = () => {
                    const sourceId = parseInt(sourcePosSelect.value, 10);
                    
                    // Rebuild destination options excluding selected source
                    const currentDestId = parseInt(destPosSelect.value, 10);
                    destPosSelect.innerHTML = '';
                    (CORE.db.pointsOfSale || []).filter(pos => pos.id !== sourceId).forEach(pos => {
                        const opt = document.createElement('option');
                        opt.value = pos.id;
                        opt.textContent = pos.name;
                        if (pos.id === currentDestId) opt.selected = true;
                        destPosSelect.appendChild(opt);
                    });
                    
                    // Rebuild product list for new source POS
                    const currentProductId = parseInt(productSelect.value, 10);
                    productSelect.innerHTML = '';
                    (CORE.db.products || []).filter(p => !p.isMainWarehouse && (CORE.getProductStock(p.id, sourceId) || 0) > 0).forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = `${p.name} �� ?� � Stock: ${CORE.getProductStock(p.id, sourceId) || 0}`;
                        if (p.id === currentProductId) opt.selected = true;
                        productSelect.appendChild(opt);
                    });
                    
                    updateSummary();
                };

                sourcePosSelect?.addEventListener('change', updateDestPos);
                destPosSelect?.addEventListener('change', updateSummary);
                productSelect?.addEventListener('change', updateSummary);
                qtyInput?.addEventListener('input', updateSummary);

                // Boutons d'action rapide
                document.querySelectorAll('[data-tf-set]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const action = btn.getAttribute('data-tf-set');
                        const sourceId = parseInt(sourcePosSelect.value, 10);
                        const productId = parseInt(productSelect.value, 10);
                        const sourceStock = CORE.getProductStock(productId, sourceId) || 0;

                        if (action === 'suggested') {
                            qtyInput.value = Math.floor(sourceStock * 0.5);
                        } else if (action === 'half') {
                            qtyInput.value = Math.floor(sourceStock / 2);
                        } else if (action === 'clear') {
                            qtyInput.value = 0;
                        } else if (action.startsWith('+')) {
                            const add = parseInt(action.substring(1), 10);
                            qtyInput.value = parseInt(qtyInput.value || 0, 10) + add;
                        }
                        updateSummary();
                    });
                });

                // Boutons de suggestion rapide
                document.querySelectorAll('[data-tf-suggestion]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const sourceId = btn.getAttribute('data-source-id');
                        const destId = btn.getAttribute('data-dest-id');
                        const productId = btn.getAttribute('data-product-id');
                        const suggestedQty = btn.getAttribute('data-suggested-qty');
                        
                        sourcePosSelect.value = sourceId;
                        destPosSelect.value = destId;
                        productSelect.value = productId;
                        qtyInput.value = suggestedQty;
                        updateSummary();
                    });
                });

                updateSummary();
            }, 100);
        },

        executeStockTransfer() {
            const productId = parseInt(UI.val('tf_product') || '0', 10);
            const sourcePosId = parseInt(UI.val('tf_source_pos') || '0', 10);
            const destPosId = parseInt(UI.val('tf_dest_pos') || '0', 10);
            const qty = parseInt(UI.val('tf_qty') || '0', 10);
            const reason = UI.val('tf_reason').trim();
            
            // Validations
            if (!productId) return UI.toast('S�lectionnez un produit', 'warning');
            if (!sourcePosId || !destPosId) return UI.toast('S�lectionnez les deux POS', 'warning');
            if (sourcePosId === destPosId) return UI.toast('Les POS source et destination doivent ��tre diff�rents', 'warning');
            if (qty <= 0) return UI.toast('La quantit� doit ��tre sup�rieure �� 0', 'warning');
            
            const product = CORE.getProduct(productId);
            const sourcePos = CORE.getPOS(sourcePosId);
            const destPos = CORE.getPOS(destPosId);
            
            if (!product || !sourcePos || !destPos) {
                return UI.toast('Donn�es invalides', 'error');
            }
            
            // V�rifier le stock source
            const sourceStock = CORE.getProductStock(productId, sourcePosId) || 0;
            if (sourceStock < qty) {
                return UI.toast(`Stock insuffisant (disponible: ${sourceStock})`, 'error');
            }
            
            // Effectuer le transfert
            const newSourceStock = sourceStock - qty;
            const destStock = (CORE.getProductStock(productId, destPosId) || 0);
            const newDestStock = destStock + qty;
            
            // Mettre �� jour les stocks
            CORE.setProductStock(productId, sourcePosId, newSourceStock);
            CORE.setProductStock(productId, destPosId, newDestStock);
            
            // Enregistrer les mouvements de stock
            const transferRef = `TRANSFER-${Utils.uid('TR').substring(0, 8)}`;
            const notePrefix = reason ? `${reason} - ` : '';
            
            // Mouvement sortie au POS source
            CORE.recordStockMovement({
                productId: productId,
                type: 'out',
                qty: qty,
                ref: transferRef,
                note: `${notePrefix}Transfert vers ${destPos.name}`,
                posId: sourcePosId
            });
            
            // Mouvement entr�e au POS destination
            CORE.recordStockMovement({
                productId: productId,
                type: 'in',
                qty: qty,
                ref: transferRef,
                note: `${notePrefix}Transfert depuis ${sourcePos.name}`,
                posId: destPosId
            });
            
            CORE.save();
            UI.closeModal();
            UI.toast(`���?? ${qty} ${product.name} transf�r�(s) de ${sourcePos.name} �� ${destPos.name}`, 'success');
            App.rerender();
        },

        // ===== SYST�?ME DE SUGGESTIONS INTELLIGENTES AVANC� =====
        
        // Afficher les d�tails du r�approvisionnement group� pour un POS
        showGroupedTransferDetails(posId) {
            const pos = CORE.getPOS(parseInt(posId));
            if (!pos) return UI.toast('POS introuvable', 'error');
            
            const products = (CORE.db.products || []).filter(p => p.active);
            const groupedData = [];
            let totalValue = 0, totalItems = 0;
            
            products.forEach(p => {
                const depotStock = p.stock || 0;
                if (depotStock <= 0) return;
                
                const minStock = p.minStock || 0;
                const posStock = CORE.getProductStock(p.id, parseInt(posId)) || 0;
                const velocity = this.calculateSalesVelocity(p.id, parseInt(posId));
                const stockout = this.predictStockout(posStock, velocity);
                
                if (stockout.risk === 'critical' || stockout.risk === 'high' || posStock <= minStock) {
                    const target = Math.max(minStock * 2, Math.ceil(velocity * 14));
                    const deficit = target - posStock;
                    if (deficit > 0) {
                        const suggestedQty = Math.min(depotStock, deficit);
                        const value = suggestedQty * (p.price || 0);
                        groupedData.push({
                            productId: p.id,
                            productName: p.name,
                            posStock,
                            minStock,
                            depotStock,
                            suggestedQty,
                            velocity: velocity.toFixed(1),
                            stockout,
                            value
                        });
                        totalValue += value;
                        totalItems += suggestedQty;
                    }
                }
            });
            
            if (groupedData.length === 0) {
                return UI.toast('Aucun produit �� transf�rer pour ce POS', 'info');
            }
            
            const html = `
                <div class="space-y-4">
                    <div class="p-4 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-xs opacity-80">R�approvisionnement group�</div>
                                <div class="text-xl font-black">${pos.name}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-black">${totalItems}</div>
                                <div class="text-xs opacity-80">unit�s �� ?� � ${CORE.formatPrice(totalValue)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="max-h-96 overflow-y-auto space-y-2">
                        ${groupedData.map(item => `
                            <div class="p-3 rounded-xl border ${item.stockout.risk === 'critical' ? 'border-red-300 bg-red-50' : item.stockout.risk === 'high' ? 'border-orange-300 bg-orange-50' : 'border-slate-200 bg-white'} flex items-center justify-between gap-3">
                                <div class="flex-1">
                                    <div class="font-black text-slate-900">${item.productName}</div>
                                    <div class="text-xs text-slate-600">
                                        Stock: ${item.posStock}/${item.minStock} �� ?� � 
                                        D�p��t: ${item.depotStock} �� ?� � 
                                        V�locit�: ${item.velocity}/j
                                    </div>
                                    <div class="text-[11px] font-bold ${item.stockout.risk === 'critical' ? 'text-red-600' : item.stockout.risk === 'high' ? 'text-orange-600' : 'text-slate-500'}">
                                        ${item.stockout.label}
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="px-3 py-2 bg-slate-900 text-white rounded-xl">
                                        <div class="text-lg font-black">${item.suggestedQty}</div>
                                        <div class="text-[10px] opacity-70">�� transf�rer</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-emerald-800">��Ÿ? � Conseil IA</span>
                            <span class="text-sm text-emerald-700">Couvre ~14 jours de ventes</span>
                        </div>
                    </div>
                </div>
            `;
            
            UI.modal(`��Ÿ? � D�tail R�appro. - ${pos.name}`, html, [
                { label: 'Fermer', onclick: 'UI.closeModal()' },
                { label: 'Transf�rer Tout', onclick: `ManagerModule.executeGroupedTransfer(${posId})`, class: 'px-5 py-2.5 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-black rounded-xl hover:from-purple-700 hover:to-indigo-700 transition' }
            ]);
        },
        
        // Ex�cuter un transfert group� pour un POS
        executeGroupedTransfer(posId) {
            const pos = CORE.getPOS(parseInt(posId));
            if (!pos) return UI.toast('POS introuvable', 'error');
            
            const products = (CORE.db.products || []).filter(p => p.active);
            let transferCount = 0;
            let totalQty = 0;
            
            products.forEach(p => {
                const depotStock = p.stock || 0;
                if (depotStock <= 0) return;
                
                const minStock = p.minStock || 0;
                const posStock = CORE.getProductStock(p.id, parseInt(posId)) || 0;
                const velocity = this.calculateSalesVelocity(p.id, parseInt(posId));
                const stockout = this.predictStockout(posStock, velocity);
                
                if (stockout.risk === 'critical' || stockout.risk === 'high' || posStock <= minStock) {
                    const target = Math.max(minStock * 2, Math.ceil(velocity * 14));
                    const deficit = target - posStock;
                    if (deficit > 0) {
                        const qty = Math.min(depotStock, deficit);
                        
                        // D�duire le stock du d�p��t principal
                        p.stock = depotStock - qty;
                        
                        // Cr�er le bon de transfert
                        const receipt = CORE.createTransferReceipt({
                            productId: p.id,
                            productName: p.name,
                            quantity: qty,
                            fromPosId: 'main_depot',
                            fromPosName: 'D�p��t principal',
                            toPosId: parseInt(posId),
                            toPosName: pos.name,
                            note: `R�appro. group� automatique - ${pos.name}`,
                            reference: `GRP-${Utils.uid('GT').slice(0, 6)}`,
                            meta: {
                                source: 'grouped_transfer',
                                velocity: velocity,
                                stockoutRisk: stockout.risk,
                                transferType: 'main_depot_transfer',
                                createdFrom: 'manager_grouped_transfer'
                            }
                        });
                        
                        if (receipt) {
                            // Enregistrer le mouvement de stock
                            CORE.recordStockMovement({
                                type: 'main_depot_transfer',
                                productId: p.id,
                                quantity: qty,
                                posId: null,
                                fromPosId: null,
                                toPosId: parseInt(posId),
                                notes: `R�appro. group� - ${pos.name}`,
                                reason: 'main_depot_transfer',
                                document: receipt.reference,
                                timestamp: new Date().toISOString(),
                                meta: {
                                    source: 'grouped_transfer',
                                    receiptId: receipt.id,
                                    direction: 'out',
                                    status: 'pending'
                                }
                            });
                            
                            transferCount++;
                            totalQty += qty;
                        }
                    }
                }
            });
            
            CORE.save();
            UI.closeModal();
            
            if (transferCount > 0) {
                UI.toast(`���?? ${transferCount} transfert(s) cr��(s) �� ?� � ${totalQty} unit�s vers ${pos.name}`, 'success');
                App.rerender();
            } else {
                UI.toast('Aucun transfert effectu�', 'warning');
            }
        },
        
        // 1. Calcul de la v�locit� des ventes (unit�s vendues par jour)
        calculateSalesVelocity(productId, posId, days = 14) {
            const sales = (CORE.db.sales || []).filter(s => {
                if (!s.posId || s.posId !== posId) return false;
                const saleDate = new Date(s.date || s.createdAt);
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - days);
                return saleDate >= cutoff;
            });
            
            let totalQty = 0;
            sales.forEach(sale => {
                (sale.items || []).forEach(item => {
                    if (item.productId === productId) {
                        totalQty += item.qty || item.quantity || 1;
                    }
                });
            });
            
            return totalQty / days; // Unit�s par jour
        },
        
        // 2. D�tection de tendance saisonni��re
        detectSeasonalTrend(productId, posId) {
            const now = new Date();
            const currentMonth = now.getMonth();
            const sales = CORE.db.sales || [];
            
            // Comparer les ventes du m��me mois l'ann�e derni��re
            const thisMonthSales = sales.filter(s => {
                const d = new Date(s.date || s.createdAt);
                return d.getMonth() === currentMonth && s.posId === posId;
            });
            
            let currentQty = 0, historicalQty = 0;
            const thisYear = now.getFullYear();
            
            thisMonthSales.forEach(sale => {
                const year = new Date(sale.date || sale.createdAt).getFullYear();
                (sale.items || []).forEach(item => {
                    if (item.productId === productId) {
                        const qty = item.qty || item.quantity || 1;
                        if (year === thisYear) currentQty += qty;
                        else historicalQty += qty;
                    }
                });
            });
            
            if (historicalQty === 0) return { trend: 'stable', factor: 1 };
            
            const growthFactor = currentQty / historicalQty;
            if (growthFactor > 1.3) return { trend: 'up', factor: growthFactor, icon: '��Ÿ?�?' };
            if (growthFactor < 0.7) return { trend: 'down', factor: growthFactor, icon: '��Ÿ?�' };
            return { trend: 'stable', factor: 1, icon: '��ž ��� � �' };
        },
        
        // 3. Calcul du score de priorit� combin�
        calculatePriorityScore(params) {
            const { posStock, minStock, velocity, daysUntilStockout, financialImpact, depotStock, suggestedQty } = params;
            
            // Score d'urgence (0-40 points)
            let urgencyScore = 0;
            if (posStock === 0) urgencyScore = 40;
            else if (posStock <= minStock * 0.25) urgencyScore = 35;
            else if (posStock <= minStock * 0.5) urgencyScore = 25;
            else if (posStock <= minStock) urgencyScore = 15;
            
            // Score de v�locit� (0-25 points)
            let velocityScore = Math.min(25, velocity * 5);
            
            // Score de rupture imminente (0-20 points)
            let stockoutScore = 0;
            if (daysUntilStockout <= 1) stockoutScore = 20;
            else if (daysUntilStockout <= 3) stockoutScore = 15;
            else if (daysUntilStockout <= 7) stockoutScore = 10;
            else if (daysUntilStockout <= 14) stockoutScore = 5;
            
            // Score d'impact financier (0-15 points)
            let financialScore = Math.min(15, financialImpact / 10000);
            
            return Math.round(urgencyScore + velocityScore + stockoutScore + financialScore);
        },
        
        // 4. Pr�diction de rupture de stock
        predictStockout(posStock, velocity) {
            if (velocity <= 0) return { days: Infinity, risk: 'low', label: 'Stable' };
            const daysUntilStockout = posStock / velocity;
            
            if (daysUntilStockout <= 1) return { days: daysUntilStockout, risk: 'critical', label: '��š ��� � � Rupture imminente!' };
            if (daysUntilStockout <= 3) return { days: daysUntilStockout, risk: 'high', label: '��Ÿ� � Critique (< 3j)' };
            if (daysUntilStockout <= 7) return { days: daysUntilStockout, risk: 'medium', label: '��ŸŸ � �?� surveiller (< 7j)' };
            if (daysUntilStockout <= 14) return { days: daysUntilStockout, risk: 'low', label: '��ŸŸ � Attention (< 14j)' };
            return { days: daysUntilStockout, risk: 'safe', label: '��ŸŸ � OK' };
        },
        
        // 5. G�n�ration de suggestions group�es par POS
        generateGroupedSuggestions(posList, products) {
            const grouped = {};
            
            posList.forEach(pos => {
                const posProducts = [];
                let totalValue = 0;
                let criticalCount = 0;
                
                products.forEach(p => {
                    const depotStock = p.stock || 0;
                    if (depotStock <= 0) return;
                    
                    const minStock = p.minStock || 0;
                    const posStock = CORE.getProductStock(p.id, pos.id) || 0;
                    const velocity = this.calculateSalesVelocity(p.id, pos.id);
                    const stockout = this.predictStockout(posStock, velocity);
                    
                    if (stockout.risk === 'critical' || stockout.risk === 'high' || posStock <= minStock) {
                        const target = Math.max(minStock * 2, Math.ceil(velocity * 14)); // 2 semaines de stock
                        const deficit = target - posStock;
                        if (deficit > 0) {
                            const suggestedQty = Math.min(depotStock, deficit);
                            posProducts.push({
                                productId: p.id,
                                productName: p.name,
                                suggestedQty,
                                velocity,
                                stockout
                            });
                            totalValue += suggestedQty * (p.price || 0);
                            if (stockout.risk === 'critical' || stockout.risk === 'high') criticalCount++;
                        }
                    }
                });
                
                if (posProducts.length > 0) {
                    grouped[pos.id] = {
                        posId: pos.id,
                        posName: pos.name,
                        products: posProducts,
                        totalValue,
                        criticalCount,
                        totalItems: posProducts.reduce((sum, p) => sum + p.suggestedQty, 0)
                    };
                }
            });
            
            return grouped;
        },
        
        // G�n��re la raison principale de la suggestion
        getSuggestionReason(stockout, velocity, posStock, minStock, seasonalTrend) {
            if (stockout.risk === 'critical') return '��Ÿš � Rupture imminente d�tect�e';
            if (stockout.risk === 'high') return '��š ��� � � Stock critique < 3 jours';
            if (velocity >= 5) return '��Ÿ� � Forte demande d�tect�e';
            if (seasonalTrend.trend === 'up') return '��Ÿ?�? Tendance saisonni��re haussi��re';
            if (posStock <= minStock * 0.5) return '��Ÿ?� Stock sous 50% du minimum';
            if (posStock <= minStock) return '��š � Sous le seuil minimum';
            return '��Ÿ?Š R�approvisionnement pr�ventif';
        },
        
        showMainTransferModal() {
            const products = (CORE.db.products || []).filter(p => p.active);
            if (products.length === 0) {
                UI.toast('Aucun produit actif au d�p��t principal', 'warning');
                return;
            }

            const posList = CORE.db.pointsOfSale || [];
            if (posList.length === 0) {
                UI.toast('Ajoutez un point de vente avant de r�aliser un transfert', 'warning');
                return;
            }

            ManagerModule._mainTransferMedia = [];

            const depotTotals = products.reduce((acc, p) => {
                acc.units += p.stock || 0;
                acc.value += (p.stock || 0) * (p.price || 0);
                return acc;
            }, { units: 0, value: 0 });

            const lowDepot = products.filter(p => (p.stock || 0) <= (p.minStock || 0)).length;

            // ===== G�N�RATION DES SUGGESTIONS INTELLIGENTES =====
            const suggestions = [];
            const groupedSuggestions = this.generateGroupedSuggestions(posList, products);
            
            posList.forEach(pos => {
                products.forEach(p => {
                    const depotStock = p.stock || 0;
                    if (depotStock <= 0) return;
                    const minStock = p.minStock || 0;
                    const posStock = CORE.getProductStock(p.id, pos.id) || 0;
                    
                    // Calculs avanc�s
                    const velocity = this.calculateSalesVelocity(p.id, pos.id);
                    const seasonalTrend = this.detectSeasonalTrend(p.id, pos.id);
                    const stockout = this.predictStockout(posStock, velocity);
                    
                    // Objectif intelligent bas� sur v�locit� + tendance saisonni��re
                    const velocityTarget = Math.ceil(velocity * 14 * seasonalTrend.factor); // 2 semaines ajust�es
                    const target = Math.max(minStock * 2, velocityTarget, minStock + 20);
                    const deficit = target - posStock;
                    
                    if (deficit <= 0) return;
                    
                    const suggestedQty = Math.min(depotStock, deficit);
                    const financialImpact = suggestedQty * (p.price || 0);
                    
                    // Score de priorit� combin�
                    const priorityScore = this.calculatePriorityScore({
                        posStock, minStock, velocity, 
                        daysUntilStockout: stockout.days,
                        financialImpact, depotStock, suggestedQty
                    });
                    
                    // D�terminer la s�v�rit� bas�e sur le score
                    let severity = 'low';
                    if (priorityScore >= 60 || stockout.risk === 'critical') severity = 'critical';
                    else if (priorityScore >= 40 || stockout.risk === 'high') severity = 'high';
                    else if (priorityScore >= 25 || stockout.risk === 'medium') severity = 'medium';
                    
                    suggestions.push({
                        productId: p.id,
                        productName: p.name,
                        posId: pos.id,
                        posName: pos.name,
                        posStock,
                        minStock,
                        depotStock,
                        suggestedQty,
                        severity,
                        // Donn�es enrichies
                        velocity: velocity.toFixed(1),
                        velocityLabel: velocity >= 5 ? '��Ÿ� � Forte' : velocity >= 2 ? '��Ÿ?Š Moyenne' : '��Ÿ?� Faible',
                        stockout,
                        daysUntilStockout: stockout.days === Infinity ? '���?ž' : Math.round(stockout.days),
                        seasonalTrend,
                        priorityScore,
                        financialImpact,
                        reason: this.getSuggestionReason(stockout, velocity, posStock, minStock, seasonalTrend)
                    });
                });
            });

            // Tri par score de priorit� d�croissant
            suggestions.sort((a, b) => b.priorityScore - a.priorityScore);

            const topSuggestions = suggestions.slice(0, 5);
            
            // Statistiques des suggestions
            const totalCritical = suggestions.filter(s => s.severity === 'critical').length;
            const totalHigh = suggestions.filter(s => s.severity === 'high').length;
            const avgVelocity = suggestions.length > 0 
                ? (suggestions.reduce((sum, s) => sum + parseFloat(s.velocity), 0) / suggestions.length).toFixed(1)
                : 0;
            const defaultSuggestion = topSuggestions[0] || null;
            const defaultProductId = defaultSuggestion ? defaultSuggestion.productId : products[0].id;
            const defaultPosId = defaultSuggestion ? defaultSuggestion.posId : posList[0].id;

            const recentTransfers = (CORE.db.stockMovements || [])
                .filter(m => m.meta?.source === 'manager_transfer')
                .sort((a, b) => new Date(b.timestamp || b.createdAt || 0) - new Date(a.timestamp || a.createdAt || 0))
                .slice(0, 5);

            const outboundTransfers = recentTransfers.filter(m => m.meta?.direction === 'out');
            const transferHistory = outboundTransfers.length > 0 ? outboundTransfers : recentTransfers;

            const html = `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="p-4 rounded-2xl bg-blue-50 border border-blue-200">
                            <div class="text-xs font-black text-blue-600 uppercase">Stock disponible</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${depotTotals.units.toLocaleString('fr-FR')}</div>
                            <div class="text-[11px] text-blue-700">Unit�s au d�p��t principal</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-200">
                            <div class="text-xs font-black text-emerald-600 uppercase">Valeur estim�e</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${CORE.formatPrice(depotTotals.value)}</div>
                            <div class="text-[11px] text-emerald-700">Stock valoris�</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-amber-50 border border-amber-200">
                            <div class="text-xs font-black text-amber-600 uppercase">Produits critiques</div>
                            <div class="text-2xl font-black text-amber-900 mt-1">${lowDepot}</div>
                            <div class="text-[11px] text-amber-700">�?� surveiller au d�p��t</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                        <div class="space-y-4">
                            <div class="p-5 bg-white rounded-3xl border border-slate-200 space-y-4">
                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Produit d�p��t</label>
                                    <select id="main_transfer_product" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-blue-500">
                                        ${products.map(p => `
                                            <option value="${p.id}" ${p.id === defaultProductId ? 'selected' : ''}>
                                                ${p.name} �� ?� � Stock: ${p.stock || 0}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Destination (POS)</label>
                                    <select id="main_transfer_pos" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-blue-500">
                                        ${posList.map(pos => `
                                            <option value="${pos.id}" ${pos.id === defaultPosId ? 'selected' : ''}>
                                                ${pos.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-3 text-center text-sm">
                                    <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                        <div class="text-xs font-bold text-slate-500 uppercase">Stock d�p��t</div>
                                        <div id="main_transfer_summary_depot" class="text-xl font-black text-slate-900">0</div>
                                    </div>
                                    <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                        <div class="text-xs font-bold text-slate-500 uppercase">Stock POS</div>
                                        <div id="main_transfer_summary_pos" class="text-xl font-black text-slate-900">0</div>
                                    </div>
                                    <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                        <div class="text-xs font-bold text-slate-500 uppercase">Stock min.</div>
                                        <div id="main_transfer_summary_min" class="text-xl font-black text-slate-900">0</div>
                                    </div>
                                    <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                        <div class="text-xs font-bold text-slate-500 uppercase">Suggestion</div>
                                        <div id="main_transfer_summary_recommended" data-recommended="0" class="text-xl font-black text-emerald-600">0</div>
                                    </div>
                                </div>

                                <div class="p-3 rounded-2xl bg-emerald-50 border border-emerald-200">
                                    <div class="flex items-center justify-between text-sm font-bold text-emerald-700">
                                        <span>Couverture apr��s transfert</span>
                                        <span id="main_transfer_summary_coverage">0%</span>
                                    </div>
                                    <div class="text-xs text-emerald-600 mt-1" id="main_transfer_summary_value">0 XAF</div>
                                </div>

                                <div class="flex flex-wrap gap-2">
                                    <button data-main-transfer-set="recommended" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700 transition">Suggestion IA</button>
                                    <button data-main-transfer-set="min" class="px-3 py-2 rounded-xl bg-blue-600 text-white text-xs font-black hover:bg-blue-700 transition">Atteindre Min</button>
                                    <button data-main-transfer-set="+25" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300 transition">+25</button>
                                    <button data-main-transfer-set="+50" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300 transition">+50</button>
                                    <button data-main-transfer-set="clear" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-100 transition">R�initialiser</button>
                                </div>

                                <div class="grid grid-cols-2 gap-3 items-end">
                                    <div>
                                        <label class="block text-xs font-black text-slate-500 uppercase mb-2">Quantit� �� transf�rer</label>
                                        <input id="main_transfer_qty" type="number" min="0" value="0" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-black text-lg text-center bg-white focus:ring-2 focus:ring-purple-500">
                                        <div id="main_transfer_warning" class="mt-2 text-xs font-bold text-red-600 hidden">��š ��� � � Stock d�p��t insuffisant</div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-black text-slate-500 uppercase mb-2">R�f�rence (auto)</label>
                                        <input id="main_transfer_ref" type="text" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-slate-50" placeholder="Auto-g�n�r� lors du transfert" readonly>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Note interne (optionnelle)</label>
                                    <textarea id="main_transfer_note" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-white" rows="2" placeholder="Ex: R�assort saisonnier, campagne promo..."></textarea>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Num�ro de suivi (optionnel)</label>
                                    <input id="main_transfer_tracking" type="text" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-white" placeholder="Ex: TRANSF-2026-0001">
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Arriv�e estim�e (optionnel)</label>
                                    <input id="main_transfer_eta" type="datetime-local" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-white">
                                </div>

                                <div class="space-y-2">
                                    <label class="block text-xs font-black text-slate-500 uppercase">Pi��ces jointes (photos / vid�os)</label>
                                    <div id="main_transfer_media_trigger" class="rounded-2xl border border-dashed border-slate-300 bg-slate-50 px-4 py-6 text-center cursor-pointer hover:border-purple-400 hover:bg-white transition">
                                        <div class="text-sm font-bold text-slate-600">Glisser-d�poser ou cliquer pour importer</div>
                                        <div class="text-[11px] text-slate-400">Formats: JPG, PNG, MP4 �� ?� � 6 fichiers max �� ?� � 10 Mo chacun</div>
                                    </div>
                                    <input id="main_transfer_media_input" type="file" class="hidden" accept="image/*,video/*" multiple>
                                    <div id="main_transfer_media_preview" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <!-- En-t��te des suggestions avec statistiques -->
                            <div class="p-4 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl text-white">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-black text-sm">��Ÿ � � Analyse Intelligente</div>
                                    <span class="px-2 py-1 bg-white/20 rounded-lg text-xs font-bold">${suggestions.length} suggestions</span>
                                </div>
                                <div class="grid grid-cols-3 gap-2 text-center mt-3">
                                    <div class="p-2 bg-white/10 rounded-xl">
                                        <div class="text-lg font-black">${totalCritical}</div>
                                        <div class="text-[10px] opacity-80">Critiques</div>
                                    </div>
                                    <div class="p-2 bg-white/10 rounded-xl">
                                        <div class="text-lg font-black">${totalHigh}</div>
                                        <div class="text-[10px] opacity-80">Urgents</div>
                                    </div>
                                    <div class="p-2 bg-white/10 rounded-xl">
                                        <div class="text-lg font-black">${avgVelocity}/j</div>
                                        <div class="text-[10px] opacity-80">V�locit� moy.</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-5 bg-white rounded-3xl border border-slate-200">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="font-black text-slate-900 text-sm">��ŸŽ � Top 5 Suggestions Prioritaires</div>
                                    <span class="text-xs text-slate-500 font-bold">Score IA</span>
                                </div>
                                ${topSuggestions.length === 0 ? `
                                    <div class="p-4 rounded-2xl bg-slate-50 text-sm text-slate-500 text-center">
                                        ���?� Aucune alerte critique d�tect�e. Tous les POS sont bien approvisionn�s.
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${topSuggestions.map((s, idx) => {
                                            const severityColors = {
                                                critical: 'border-red-300 bg-gradient-to-r from-red-50 to-red-100',
                                                high: 'border-orange-300 bg-gradient-to-r from-orange-50 to-amber-50',
                                                medium: 'border-yellow-300 bg-gradient-to-r from-yellow-50 to-amber-50',
                                                low: 'border-blue-200 bg-gradient-to-r from-blue-50 to-slate-50'
                                            };
                                            const severityBadge = {
                                                critical: '<span class="px-2 py-0.5 bg-red-600 text-white text-[10px] font-black rounded-full">CRITIQUE</span>',
                                                high: '<span class="px-2 py-0.5 bg-orange-500 text-white text-[10px] font-black rounded-full">URGENT</span>',
                                                medium: '<span class="px-2 py-0.5 bg-yellow-500 text-white text-[10px] font-black rounded-full">ATTENTION</span>',
                                                low: '<span class="px-2 py-0.5 bg-blue-500 text-white text-[10px] font-black rounded-full">PR�VENTIF</span>'
                                            };
                                            return `
                                            <div class="p-4 rounded-2xl border-2 ${severityColors[s.severity] || severityColors.low} hover:shadow-lg transition-all cursor-pointer" onclick="document.querySelector('[data-main-transfer-suggestion][data-product-id=&quot;${s.productId}&quot;][data-pos-id=&quot;${s.posId}&quot;]')?.click()">
                                                <div class="flex items-start justify-between gap-3">
                                                    <div class="flex-1">
                                                        <div class="flex items-center gap-2 mb-1">
                                                            <span class="text-lg font-black">#${idx + 1}</span>
                                                            <span class="font-black text-slate-900">${s.productName}</span>
                                                            ${severityBadge[s.severity] || ''}
                                                        </div>
                                                        <div class="text-xs text-slate-600 mb-2">��Ÿ? � ${s.posName}</div>
                                                        
                                                        <!-- M�triques avanc�es -->
                                                        <div class="grid grid-cols-2 gap-2 mb-2">
                                                            <div class="flex items-center gap-1 text-xs">
                                                                <span class="text-slate-500">��Ÿ? � Stock:</span>
                                                                <span class="font-black ${s.posStock <= s.minStock ? 'text-red-600' : 'text-slate-900'}">${s.posStock}/${s.minStock}</span>
                                                            </div>
                                                            <div class="flex items-center gap-1 text-xs">
                                                                <span class="text-slate-500">�� � ��� � � Rupture:</span>
                                                                <span class="font-black ${s.stockout.risk === 'critical' ? 'text-red-600' : s.stockout.risk === 'high' ? 'text-orange-600' : 'text-slate-900'}">${s.daysUntilStockout === '���?ž' ? 'N/A' : s.daysUntilStockout + 'j'}</span>
                                                            </div>
                                                            <div class="flex items-center gap-1 text-xs">
                                                                <span class="text-slate-500">��Ÿ?�? V�locit�:</span>
                                                                <span class="font-black">${s.velocity}/j ${s.velocityLabel}</span>
                                                            </div>
                                                            <div class="flex items-center gap-1 text-xs">
                                                                <span class="text-slate-500">��Ÿ?Š Tendance:</span>
                                                                <span class="font-black">${s.seasonalTrend.icon || '��ž ��� � �'} ${s.seasonalTrend.trend === 'up' ? 'Hausse' : s.seasonalTrend.trend === 'down' ? 'Baisse' : 'Stable'}</span>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Raison de la suggestion -->
                                                        <div class="px-2 py-1 bg-white/70 rounded-lg text-[11px] font-bold text-slate-700 inline-block">
                                                            ${s.reason}
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="text-right flex flex-col items-end gap-2">
                                                        <!-- Score de priorit� -->
                                                        <div class="w-12 h-12 rounded-full bg-gradient-to-br ${s.priorityScore >= 60 ? 'from-red-500 to-red-700' : s.priorityScore >= 40 ? 'from-orange-500 to-amber-600' : s.priorityScore >= 25 ? 'from-yellow-500 to-amber-500' : 'from-blue-500 to-indigo-600'} flex items-center justify-center shadow-lg">
                                                            <span class="text-white font-black text-sm">${s.priorityScore}</span>
                                                        </div>
                                                        <div class="text-[10px] text-slate-500 font-bold">Score</div>
                                                        
                                                        <!-- Quantit� sugg�r�e -->
                                                        <div class="mt-1 px-3 py-1.5 bg-slate-900 text-white rounded-lg">
                                                            <div class="text-xs font-bold opacity-70">Sugg�r�</div>
                                                            <div class="text-lg font-black">${s.suggestedQty}</div>
                                                        </div>
                                                        
                                                        <button data-main-transfer-suggestion data-product-id="${s.productId}" data-pos-id="${s.posId}" data-suggested-qty="${s.suggestedQty}" class="mt-1 px-4 py-2 rounded-xl bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-xs font-black hover:from-purple-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl">
                                                            ��š � Appliquer
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                        }).join('')}
                                    </div>
                                `}
                            </div>

                            <div class="p-5 bg-white rounded-3xl border border-slate-200">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="font-black text-slate-900 text-sm">��Ÿ? � R�appro. Group� par POS</div>
                                    <span class="text-xs text-slate-500 font-bold">${Object.keys(groupedSuggestions).length} POS</span>
                                </div>
                                ${Object.keys(groupedSuggestions).length === 0 ? `
                                    <div class="p-4 rounded-2xl bg-slate-50 text-sm text-slate-500 text-center">
                                        Aucun r�approvisionnement group� n�cessaire.
                                    </div>
                                ` : `
                                    <div class="space-y-2 max-h-48 overflow-y-auto">
                                        ${Object.values(groupedSuggestions).sort((a, b) => b.criticalCount - a.criticalCount).slice(0, 4).map(g => `
                                            <div class="p-3 rounded-2xl border ${g.criticalCount > 0 ? 'border-red-200 bg-gradient-to-r from-red-50 to-orange-50' : 'border-slate-200 bg-slate-50'} hover:shadow-md transition cursor-pointer" onclick="ManagerModule.showGroupedTransferDetails('${g.posId}')">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <div class="font-black text-slate-900">${g.posName}</div>
                                                        <div class="text-xs text-slate-600">${g.products.length} produits �� ?� � ${g.totalItems} unit�s</div>
                                                        ${g.criticalCount > 0 ? `<span class="text-[10px] font-black text-red-600">��š ��� � � ${g.criticalCount} critique(s)</span>` : ''}
                                                    </div>
                                                    <div class="text-right">
                                                        <div class="text-xs font-black text-slate-900">${CORE.formatPrice(g.totalValue)}</div>
                                                        <div class="text-[10px] text-slate-500">Valeur totale</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>

                            <div class="p-5 bg-white rounded-3xl border border-slate-200">
                                <div class="font-black text-slate-900 text-sm mb-3">��Ÿ�? Derniers transferts</div>
                                ${transferHistory.length === 0 ? `
                                    <div class="p-4 rounded-2xl bg-slate-50 text-sm text-slate-500 text-center">
                                        Aucun transfert enregistr� r�cemment.
                                    </div>
                                ` : `
                                    <div class="space-y-2 text-sm">
                                        ${transferHistory.map(t => {
                                            const destPos = CORE.getPOS(t.meta?.toPosId || t.toPosId || t.posId);
                                            const destination = destPos ? destPos.name : (t.meta?.destinationName || 'POS');
                                            const qty = t.qty || t.quantity || 0;
                                            const when = new Date(t.timestamp || t.createdAt || Date.now()).toLocaleString('fr-FR');
                                            return `
                                                <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200 flex items-center justify-between gap-3">
                                                    <div>
                                                        <div class="font-black text-slate-900">${t.productName || 'Produit'}</div>
                                                        <div class="text-xs text-slate-600">${qty} unit�s �� ?� � ${destination}</div>
                                                    </div>
                                                    <div class="text-[11px] text-slate-400 font-bold text-right">${when}</div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            UI.modal('��Ÿ�? Approvisionner un POS depuis le D�p��t Principal', html, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Transf�rer', onclick: 'ManagerModule.executeMainTransfer()', class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition' }
            ]);

            setTimeout(() => {
                const modalEl = document.querySelector('#modalContainer .slide-up');
                if (modalEl) {
                    modalEl.classList.remove('max-w-lg');
                    modalEl.classList.add('max-w-5xl');
                }

                const productSelect = document.getElementById('main_transfer_product');
                const posSelect = document.getElementById('main_transfer_pos');
                const qtyInput = document.getElementById('main_transfer_qty');
                const refInput = document.getElementById('main_transfer_ref');
                const summaryDepot = document.getElementById('main_transfer_summary_depot');
                const summaryPos = document.getElementById('main_transfer_summary_pos');
                const summaryMin = document.getElementById('main_transfer_summary_min');
                const summaryRecommended = document.getElementById('main_transfer_summary_recommended');
                const summaryCoverage = document.getElementById('main_transfer_summary_coverage');
                const summaryValue = document.getElementById('main_transfer_summary_value');
                const warning = document.getElementById('main_transfer_warning');
                    const mediaInput = document.getElementById('main_transfer_media_input');
                    const mediaTrigger = document.getElementById('main_transfer_media_trigger');
                    const mediaPreview = document.getElementById('main_transfer_media_preview');
                    const attachments = [];
                    ManagerModule._mainTransferMedia = attachments;

                    const MAX_MEDIA_FILES = 6;
                    const MAX_MEDIA_SIZE = 10 * 1024 * 1024;

                    const renderMediaPreview = () => {
                        if (!mediaPreview) return;
                        if (attachments.length === 0) {
                            mediaPreview.innerHTML = '<div class="px-4 py-3 rounded-xl bg-slate-100 text-xs font-bold text-slate-400 text-center">Aucun m�dia ajout�</div>';
                            return;
                        }

                        mediaPreview.innerHTML = attachments.map(att => `
                            <div class="relative group border border-slate-200 rounded-xl overflow-hidden">
                                ${att.type === 'video'
                                    ? `<video src="${att.dataUrl}" class="w-full h-24 object-cover" muted loop></video>`
                                    : `<img src="${att.dataUrl}" alt="${att.name}" class="w-full h-24 object-cover">`}
                                <button type="button" data-remove-media="${att.id}" class="absolute top-2 right-2 bg-white/80 backdrop-blur px-2 py-1 rounded-lg text-[11px] font-black text-slate-600 hover:bg-red-500 hover:text-white transition">Retirer</button>
                                <div class="px-3 py-2 bg-white text-[11px] font-bold text-slate-500 truncate">${att.name}</div>
                            </div>
                        `).join('');

                        mediaPreview.querySelectorAll('[data-remove-media]').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const id = btn.getAttribute('data-remove-media');
                                const index = attachments.findIndex(item => item.id === id);
                                if (index !== -1) {
                                    attachments.splice(index, 1);
                                    ManagerModule._mainTransferMedia = attachments;
                                    renderMediaPreview();
                                }
                            });
                        });
                    };

                    const addAttachment = (file) => {
                        if (!file) return;
                        const isMedia = file.type?.startsWith('image') || file.type?.startsWith('video');
                        if (!isMedia) {
                            UI.toast('Format non pris en charge', 'warning');
                            return;
                        }
                        if (file.size > MAX_MEDIA_SIZE) {
                            UI.toast('Fichier trop volumineux (10 Mo max)', 'warning');
                            return;
                        }
                        if (attachments.length >= MAX_MEDIA_FILES) {
                            UI.toast('Limite de 6 fichiers atteinte', 'warning');
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = () => {
                            const isVideo = (file.type || '').startsWith('video');
                            attachments.push({
                                id: Utils.uid('MEDIA'),
                                name: file.name,
                                type: isVideo ? 'video' : 'image',
                                mimeType: file.type || (isVideo ? 'video/mp4' : 'image/jpeg'),
                                size: file.size,
                                dataUrl: reader.result
                            });
                            ManagerModule._mainTransferMedia = attachments;
                            renderMediaPreview();
                        };
                        reader.readAsDataURL(file);
                    };

                    const handleFiles = (fileList) => {
                        if (!fileList) return;
                        Array.from(fileList).some(file => {
                            if (attachments.length >= MAX_MEDIA_FILES) return true;
                            addAttachment(file);
                            return false;
                        });
                    };

                    mediaTrigger?.addEventListener('click', () => mediaInput?.click());
                    mediaTrigger?.addEventListener('dragover', event => {
                        event.preventDefault();
                        mediaTrigger.classList.add('border-purple-400', 'bg-white');
                    });
                    mediaTrigger?.addEventListener('dragleave', () => {
                        mediaTrigger.classList.remove('border-purple-400', 'bg-white');
                    });
                    mediaTrigger?.addEventListener('drop', event => {
                        event.preventDefault();
                        mediaTrigger.classList.remove('border-purple-400', 'bg-white');
                        handleFiles(event.dataTransfer?.files || []);
                    });
                    mediaInput?.addEventListener('change', event => {
                        handleFiles(event.target?.files || []);
                        mediaInput.value = '';
                    });

                    renderMediaPreview();

                const formatNumber = (n) => Number(n || 0).toLocaleString('fr-FR');

                const updateSummary = (opts = {}) => {
                    const productId = parseInt(productSelect.value, 10) || defaultProductId;
                    const posId = parseInt(posSelect.value, 10) || defaultPosId;
                    const product = CORE.getProduct(productId) || {};
                    const depotStock = product.stock || 0;
                    const minStock = product.minStock || 0;
                    const posStock = CORE.getProductStock(productId, posId) || 0;
                    const target = Math.max(minStock * 2, minStock + 20);
                    const recommended = Math.max(0, target - posStock);
                    const currentQty = Math.max(0, Number(qtyInput.value || 0));
                    const safeQty = Math.min(currentQty, depotStock);

                    if (!opts.keepQty && (qtyInput.value === '' || qtyInput.dataset.autoFill === 'true')) {
                        qtyInput.value = Math.min(depotStock, recommended);
                        qtyInput.dataset.autoFill = 'true';
                    } else if (safeQty !== currentQty) {
                        qtyInput.value = safeQty;
                    }

                    const finalQty = Math.max(0, Number(qtyInput.value || 0));
                    const afterPosStock = posStock + finalQty;
                    const coverage = minStock > 0 ? Math.round((afterPosStock / minStock) * 100) : 0;
                    const transferValue = CORE.formatPrice(finalQty * (product.price || 0));

                    summaryDepot.textContent = formatNumber(depotStock);
                    summaryPos.textContent = formatNumber(posStock);
                    summaryMin.textContent = formatNumber(minStock);
                    summaryRecommended.textContent = formatNumber(recommended);
                    summaryRecommended.dataset.recommended = recommended;
                    summaryCoverage.textContent = `${coverage}%`;
                    summaryValue.textContent = transferValue;
                    warning.classList.toggle('hidden', finalQty <= depotStock);

                    if (!refInput.value) {
                        refInput.value = `MAIN-${Utils.uid('MT').slice(0, 6)}`;
                    }

                    return { productId, posId, depotStock, posStock, minStock, recommended };
                };

                qtyInput.dataset.autoFill = 'true';

                productSelect.addEventListener('change', () => {
                    qtyInput.dataset.autoFill = 'true';
                    updateSummary({ keepQty: false });
                });

                posSelect.addEventListener('change', () => {
                    qtyInput.dataset.autoFill = 'true';
                    updateSummary({ keepQty: false });
                });

                qtyInput.addEventListener('input', () => {
                    qtyInput.dataset.autoFill = 'false';
                    updateSummary({ keepQty: true });
                });

                document.querySelectorAll('[data-main-transfer-set]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const action = btn.dataset.mainTransferSet;
                        const { depotStock, posStock, minStock, recommended } = updateSummary({ keepQty: true });
                        let nextQty = Number(qtyInput.value || 0);

                        if (action === 'recommended') {
                            nextQty = Math.min(depotStock, recommended);
                        } else if (action === 'min') {
                            nextQty = Math.max(0, Math.min(depotStock, Math.max(0, minStock - posStock)));
                        } else if (action === 'clear') {
                            nextQty = 0;
                        } else {
                            const delta = Number(action.replace('+', '')) || 0;
                            nextQty = Math.max(0, Math.min(depotStock, nextQty + delta));
                        }

                        qtyInput.value = Math.round(nextQty);
                        qtyInput.dataset.autoFill = 'false';
                        updateSummary({ keepQty: true });
                    });
                });

                document.querySelectorAll('[data-main-transfer-suggestion]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const productId = btn.dataset.productId;
                        const posId = btn.dataset.posId;
                        const suggestedQty = Number(btn.dataset.suggestedQty || 0);
                        if (productId) productSelect.value = String(productId);
                        if (posId) posSelect.value = String(posId);
                        qtyInput.value = suggestedQty;
                        qtyInput.dataset.autoFill = 'false';
                        updateSummary({ keepQty: true });
                    });
                });

                updateSummary({ keepQty: false });
                lucide?.createIcons?.();
            }, 60);
        },

        executeMainTransfer() {
            const productSelect = document.getElementById('main_transfer_product');
            const posSelect = document.getElementById('main_transfer_pos');
            const qtyInput = document.getElementById('main_transfer_qty');
            const noteInput = document.getElementById('main_transfer_note');
            const trackingInput = document.getElementById('main_transfer_tracking');
            const etaInput = document.getElementById('main_transfer_eta');
            const refInput = document.getElementById('main_transfer_ref');
            const recommendedEl = document.getElementById('main_transfer_summary_recommended');

            const productId = parseInt(productSelect?.value || '', 10);
            const posId = parseInt(posSelect?.value || '', 10);
            const qty = Math.max(0, Number(qtyInput?.value || 0));
            const note = (noteInput?.value || '').trim();
            const reference = (refInput?.value || '').trim() || `MAIN-${Utils.uid('MT').slice(0, 6)}`;
            const trackingNumber = (trackingInput?.value || '').trim();
            const etaRaw = (etaInput?.value || '').trim();
            const recommended = Number(recommendedEl?.dataset?.recommended || 0);
            const media = Array.isArray(ManagerModule._mainTransferMedia)
                ? ManagerModule._mainTransferMedia.map(item => ({
                    id: item.id,
                    name: item.name,
                    type: item.type,
                    mimeType: item.mimeType,
                    size: item.size,
                    dataUrl: item.dataUrl
                }))
                : [];

            if (!productId || !posId) {
                UI.toast('S�lectionnez un produit et un POS', 'warning');
                return;
            }

            if (qty <= 0) {
                UI.toast('Quantit� invalide', 'warning');
                return;
            }

            const product = CORE.getProduct(productId);
            const pos = CORE.getPOS(posId);
            if (!product || !pos) {
                UI.toast('Produit ou POS introuvable', 'error');
                return;
            }

            const depotStock = product.stock || 0;
            if (qty > depotStock) {
                UI.toast('Stock d�p��t insuffisant', 'error');
                return;
            }

            // Mettre �� jour les stocks
            product.stock = depotStock - qty;

            if (!product.posStocks) product.posStocks = {};
            if (!product.posStocks[posId]) {
                product.posStocks[posId] = {
                    stock: 0,
                    lastUpdated: new Date().toISOString()
                };
            }

            const timestamp = new Date().toISOString();
            product.posStocks[posId].lastUpdated = timestamp;

            const cloneMedia = () => media.map(item => ({ ...item }));

            const movementMeta = {
                source: 'manager_transfer',
                direction: 'out',
                toPosId: posId,
                reference,
                recommended,
                destinationName: pos.name,
                attachments: cloneMedia()
            };

            if (trackingNumber) {
                movementMeta.trackingNumber = trackingNumber;
            }

            if (etaRaw) {
                const etaDate = new Date(etaRaw);
                if (!Number.isNaN(etaDate.getTime())) {
                    movementMeta.estimatedArrivalAt = etaDate.toISOString();
                }
            }

            const receipt = CORE.createTransferReceipt({
                reference,
                productId,
                productName: product.name,
                productSku: product.barcode || null,
                quantity: qty,
                fromPosId: 'main_depot',
                fromPosName: 'D�p��t principal',
                toPosId: posId,
                toPosName: pos.name,
                note,
                attachments: cloneMedia(),
                trackingNumber,
                estimatedArrivalAt: movementMeta.estimatedArrivalAt || null,
                recommended,
                meta: {
                    transferType: 'main_depot_transfer',
                    createdFrom: 'manager_main_transfer'
                }
            });

            const baseMovementMeta = {
                ...movementMeta,
                receiptId: receipt?.id || null,
                status: 'pending'
            };

            const outboundMovement = CORE.recordStockMovement({
                type: 'main_depot_transfer',
                productId,
                quantity: qty,
                posId: null,
                fromPosId: null,
                toPosId: posId,
                notes: note,
                reason: 'main_depot_transfer',
                document: reference,
                timestamp,
                meta: baseMovementMeta
            });

            if (outboundMovement) {
                outboundMovement.status = 'pending';
                outboundMovement.meta = baseMovementMeta;
                outboundMovement.timestamp = timestamp;
                outboundMovement.createdAt = timestamp;
            }

            const inboundMeta = {
                ...baseMovementMeta,
                direction: 'in',
                attachments: cloneMedia()
            };

            const inboundMovement = CORE.recordStockMovement({
                type: 'main_depot_transfer',
                productId,
                quantity: qty,
                posId,
                fromPosId: null,
                toPosId: posId,
                notes: note,
                reason: 'main_depot_transfer',
                document: reference,
                timestamp,
                meta: inboundMeta
            });

            if (inboundMovement) {
                inboundMovement.status = 'pending';
                inboundMovement.meta = inboundMeta;
                inboundMovement.timestamp = timestamp;
                inboundMovement.createdAt = timestamp;
            }

            if (receipt) {
                receipt.meta = {
                    ...(receipt.meta || {}),
                    movements: {
                        outboundId: outboundMovement?.id || null,
                        inboundId: inboundMovement?.id || null
                    }
                };
                receipt.updatedAt = timestamp;
            }

            CORE.save();
            UI.closeModal();
            UI.toast(`���?? ${qty} ${product.name} transf�r�(s) du d�p��t principal �� ${pos.name}`, 'success');
            ManagerModule._mainTransferMedia = [];
            App.rerender();
        },

        showStockDashboard() {
            const currentUser = CORE.state.currentUser || {};
            const currentView = this.state.currentView;
            // FILTRE POS STRICT: Si gestionnaire assign� �� un POS (ex: Centre-Ville), NE MONTRER QUE CE POS
            const hasAssignedPos = currentUser.role === 'gestionnaire' && currentUser.pos;
            const forcedPosId = hasAssignedPos ? currentUser.pos : null;
            // Ignorer inventoryPosId si gestionnaire a un POS assign� (emp��cher le changement de POS)
            const statePosCandidate = hasAssignedPos ? NaN : (this.state.inventoryPosId ? parseInt(this.state.inventoryPosId, 10) : NaN);
            const selectedPosId = Number.isFinite(statePosCandidate) ? statePosCandidate : null;
            const activePosId = forcedPosId ?? selectedPosId;
            const products = CORE.db.products || [];
            // Ne pas autoriser main-stock si gestionnaire a un POS assign�
            const isMainDepot = currentView === 'main-stock' && !hasAssignedPos;

            if (isMainDepot) {
                let totalQuantity = 0;
                let totalStockValue = 0;
                const lowStockProducts = [];
                const ruptures = [];
                const recommendations = [];

                products.forEach(p => {
                    const stock = p.stock || 0;
                    const price = p.price || 0;
                    totalQuantity += stock;
                    totalStockValue += stock * price;

                    if (stock === 0) {
                        ruptures.push({ productName: p.name });
                    }

                    if (stock <= (p.minStock || 0)) {
                        lowStockProducts.push({ product: p, stock });
                        const target = Math.round((p.minStock || 0) * 2);
                        const toOrder = Math.max(0, target - stock);
                        if (toOrder > 0) {
                            recommendations.push({
                                productName: p.name,
                                toOrder,
                                cost: toOrder * price
                            });
                        }
                    }
                });

                const topCritical = lowStockProducts
                    .sort((a, b) => {
                        const aMin = a.product.minStock || 1;
                        const bMin = b.product.minStock || 1;
                        return (a.stock / aMin) - (b.stock / bMin);
                    })
                    .slice(0, 12);

                const html = `
                    <div class="max-h-[85vh] overflow-y-auto space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                            <div class="p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl border border-blue-200">
                                <div class="text-xs font-black text-blue-600 uppercase">Total Articles</div>
                                <div class="text-3xl font-black text-blue-900 mt-2">${totalQuantity}</div>
                                <div class="text-xs text-blue-700 mt-1">en r�serve centrale</div>
                            </div>
                            <div class="p-4 bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-2xl border border-emerald-200">
                                <div class="text-xs font-black text-emerald-600 uppercase">Valeur Stock</div>
                                <div class="text-2xl font-black text-emerald-900 mt-2">${CORE.formatPrice(totalStockValue)}</div>
                                <div class="text-xs text-emerald-700 mt-1">d�p��t principal</div>
                            </div>
                            <div class="p-4 bg-gradient-to-br from-amber-50 to-amber-100 rounded-2xl border border-amber-200">
                                <div class="text-xs font-black text-amber-600 uppercase">Stock Bas</div>
                                <div class="text-3xl font-black text-amber-900 mt-2">${lowStockProducts.length}</div>
                                <div class="text-xs text-amber-700 mt-1">produits sous le minimum</div>
                            </div>
                            <div class="p-4 bg-gradient-to-br from-red-50 to-red-100 rounded-2xl border border-red-200">
                                <div class="text-xs font-black text-red-600 uppercase">Ruptures</div>
                                <div class="text-3xl font-black text-red-900 mt-2">${ruptures.length}</div>
                                <div class="text-xs text-red-700 mt-1">produits indisponibles</div>
                            </div>
                        </div>

                        ${topCritical.length > 0 ? `
                        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                            <div class="p-4 bg-slate-50 border-b border-slate-200">
                                <h3 class="font-black text-slate-900 text-lg">��Ÿš � Priorit�s du d�p��t principal</h3>
                                <p class="text-xs text-slate-500 mt-1">Produits �� r�approvisionner en priorit�</p>
                            </div>
                            <div class="overflow-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-600 uppercase">
                                        <tr>
                                            <th class="px-4 py-3 text-left">Produit</th>
                                            <th class="px-4 py-3 text-center">Stock</th>
                                            <th class="px-4 py-3 text-center">Min</th>
                                            <th class="px-4 py-3 text-center">Couverture</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        ${topCritical.map(item => {
                                            const min = item.product.minStock || 0;
                                            const coverage = min > 0 ? Math.round((item.stock / min) * 100) : 100;
                                            return `
                                                <tr class="hover:bg-slate-50">
                                                    <td class="px-4 py-3 font-black text-slate-900">${item.product.name}</td>
                                                    <td class="px-4 py-3 text-center font-bold text-slate-700">${item.stock}</td>
                                                    <td class="px-4 py-3 text-center font-bold text-slate-700">${min}</td>
                                                    <td class="px-4 py-3 text-center">
                                                        <span class="px-2 py-1 rounded text-xs font-bold ${coverage <= 50 ? 'bg-red-100 text-red-700' : coverage <= 80 ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}">${coverage}%</span>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : ''}

                        ${recommendations.length > 0 ? `
                        <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4">
                            <h3 class="font-black text-amber-900 text-lg mb-3">��Ÿ? � Recommandations d'approvisionnement interne</h3>
                            <div class="space-y-2">
                                ${recommendations.slice(0, 10).map(r => `
                                    <div class="flex items-start justify-between p-3 bg-white rounded-lg border border-amber-100">
                                        <div class="flex-1">
                                            <div class="font-black text-slate-900">${r.productName}</div>
                                            <div class="text-xs text-amber-700 mt-1">Commander ${r.toOrder} unit�s</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-amber-900">${CORE.formatPrice(r.cost)}</div>
                                            <div class="text-xs text-amber-600">co��t estim�</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${ruptures.length > 0 ? `
                        <div class="bg-red-50 border border-red-200 rounded-2xl p-4">
                            <h3 class="font-black text-red-900 text-lg mb-3">��š ��� � � Produits en rupture au d�p��t principal</h3>
                            <div class="space-y-2">
                                ${ruptures.slice(0, 12).map(r => `
                                    <div class="p-3 bg-white rounded-lg border border-red-100 font-black text-red-800">
                                        ${r.productName || 'Produit'}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;

                UI.modal('��Ÿ?�? Dashboard Stock - D�p��t Principal', html, [{ label: 'Fermer', onclick: 'UI.closeModal()' }], 'max-w-4xl');
                return;
            }

            if (!activePosId) {
                UI.toast('S�lectionnez un POS pour afficher son dashboard', 'info');
                return;
            }

            const pos = CORE.getPOS(activePosId);
            if (!pos) {
                UI.toast('POS introuvable', 'error');
                return;
            }

            const productsForPos = products.filter(p => this.productBelongsToPos(p, activePosId));

            let totalQuantity = 0;
            let totalStockValue = 0;
            const lowStockProducts = [];
            const ruptures = [];
            const recommendations = [];

            productsForPos.forEach(p => {
                const stock = CORE.getProductStock(p.id, activePosId) || 0;
                const price = CORE.getProductPrice(p.id, activePosId) || (p.price || 0);
                totalQuantity += stock;
                totalStockValue += stock * price;

                if (stock === 0) {
                    ruptures.push({ productName: p.name });
                }

                const min = p.minStock || 0;
                if (stock <= min) {
                    lowStockProducts.push({ product: p, stock, min });
                    const target = Math.round(min * 2);
                    const toOrder = Math.max(0, target - stock);
                    if (toOrder > 0) {
                        recommendations.push({
                            productName: p.name,
                            toOrder,
                            cost: toOrder * price
                        });
                    }
                }
            });

            const topCritical = lowStockProducts
                .sort((a, b) => {
                    const aRatio = a.min > 0 ? (a.stock / a.min) : 1;
                    const bRatio = b.min > 0 ? (b.stock / b.min) : 1;
                    return aRatio - bRatio;
                })
                .slice(0, 12);

            const html = `
                <div class="max-h-[85vh] overflow-y-auto space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div class="p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl border border-blue-200">
                            <div class="text-xs font-black text-blue-600 uppercase">Articles POS</div>
                            <div class="text-3xl font-black text-blue-900 mt-2">${totalQuantity}</div>
                            <div class="text-xs text-blue-700 mt-1">${pos.name}</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-2xl border border-emerald-200">
                            <div class="text-xs font-black text-emerald-600 uppercase">Valeur Stock</div>
                            <div class="text-2xl font-black text-emerald-900 mt-2">${CORE.formatPrice(totalStockValue)}</div>
                            <div class="text-xs text-emerald-700 mt-1">�valu�e au POS</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-amber-50 to-amber-100 rounded-2xl border border-amber-200">
                            <div class="text-xs font-black text-amber-600 uppercase">Stock Bas</div>
                            <div class="text-3xl font-black text-amber-900 mt-2">${lowStockProducts.length}</div>
                            <div class="text-xs text-amber-700 mt-1">produits �� surveiller</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-red-50 to-red-100 rounded-2xl border border-red-200">
                            <div class="text-xs font-black text-red-600 uppercase">Ruptures</div>
                            <div class="text-3xl font-black text-red-900 mt-2">${ruptures.length}</div>
                            <div class="text-xs text-red-700 mt-1">produits indisponibles</div>
                        </div>
                    </div>

                    ${topCritical.length > 0 ? `
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b border-slate-200">
                            <h3 class="font-black text-slate-900 text-lg">��Ÿš � Produits critiques pour ${pos.name}</h3>
                            <p class="text-xs text-slate-500 mt-1">Tri�s par couverture la plus faible</p>
                        </div>
                        <div class="overflow-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 text-xs font-black text-slate-600 uppercase">
                                    <tr>
                                        <th class="px-4 py-3 text-left">Produit</th>
                                        <th class="px-4 py-3 text-center">Stock</th>
                                        <th class="px-4 py-3 text-center">Min</th>
                                        <th class="px-4 py-3 text-center">Couverture</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${topCritical.map(item => {
                                        const coverage = item.min > 0 ? Math.round((item.stock / item.min) * 100) : 100;
                                        return `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-4 py-3 font-black text-slate-900">${item.product.name}</td>
                                                <td class="px-4 py-3 text-center font-bold ${item.stock === 0 ? 'text-red-600' : 'text-slate-700'}">${item.stock}</td>
                                                <td class="px-4 py-3 text-center font-bold text-slate-700">${item.min}</td>
                                                <td class="px-4 py-3 text-center">
                                                    <span class="px-2 py-1 rounded text-xs font-bold ${coverage <= 50 ? 'bg-red-100 text-red-700' : coverage <= 80 ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}">${coverage}%</span>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}

                    ${recommendations.length > 0 ? `
                    <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4">
                        <h3 class="font-black text-amber-900 text-lg mb-3">��Ÿ? � Recommandations d'approvisionnement pour ${pos.name}</h3>
                        <div class="space-y-2">
                            ${recommendations.slice(0, 10).map(r => `
                                <div class="flex items-start justify-between p-3 bg-white rounded-lg border border-amber-100">
                                    <div class="flex-1">
                                        <div class="font-black text-slate-900">${r.productName}</div>
                                        <div class="text-xs text-amber-700 mt-1">Commander ${r.toOrder} unit�s</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-black text-amber-900">${CORE.formatPrice(r.cost)}</div>
                                        <div class="text-xs text-amber-600">co��t estim�</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${ruptures.length > 0 ? `
                    <div class="bg-red-50 border border-red-200 rounded-2xl p-4">
                        <h3 class="font-black text-red-900 text-lg mb-3">�� ��? Ruptures d�tect�es �� ${pos.name}</h3>
                        <div class="space-y-2">
                            ${ruptures.slice(0, 12).map(r => `
                                <div class="p-3 bg-white rounded-lg border border-red-100 font-black text-red-800">
                                    ${r.productName || 'Produit'}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            UI.modal(`��Ÿ?�? Dashboard Stock - ${pos.name}`, html, [{ label: 'Fermer', onclick: 'UI.closeModal()' }], 'max-w-4xl');
        },

        showPosStatusIndicators() {
            const currentUser = CORE.state.currentUser || {};
            const currentView = this.state.currentView;
            // FILTRE POS STRICT: Si gestionnaire assign� �� un POS (ex: Centre-Ville), NE MONTRER QUE CE POS
            const hasAssignedPos = currentUser.role === 'gestionnaire' && currentUser.pos;
            const forcedPosId = hasAssignedPos ? currentUser.pos : null;
            // Ignorer inventoryPosId si gestionnaire a un POS assign� (emp��cher le changement de POS)
            const statePosCandidate = hasAssignedPos ? NaN : (this.state.inventoryPosId ? parseInt(this.state.inventoryPosId, 10) : NaN);
            const selectedPosId = Number.isFinite(statePosCandidate) ? statePosCandidate : null;
            const activePosId = forcedPosId ?? selectedPosId;
            const products = CORE.db.products || [];
            // Ne pas autoriser main-stock si gestionnaire a un POS assign�
            const isMainDepot = currentView === 'main-stock' && !hasAssignedPos;

            if (isMainDepot) {
                let totalStock = 0;
                let lowStockCount = 0;
                let ruptureCount = 0;
                const lowStockProducts = [];

                products.forEach(p => {
                    const stock = p.stock || 0;
                    totalStock += stock;

                    if (stock === 0) {
                        ruptureCount++;
                    } else if (stock <= (p.minStock || 0)) {
                        lowStockCount++;
                    }

                    if (stock <= (p.minStock || 0)) {
                        lowStockProducts.push({
                            name: p.name,
                            stock,
                            min: p.minStock || 0
                        });
                    }
                });

                const topLow = lowStockProducts
                    .sort((a, b) => {
                        const aRatio = a.min > 0 ? (a.stock / a.min) : 1;
                        const bRatio = b.min > 0 ? (b.stock / b.min) : 1;
                        return aRatio - bRatio;
                    })
                    .slice(0, 15);

                const html = `
                    <div class="max-h-[85vh] overflow-y-auto space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                                <div class="text-xs font-black text-emerald-600 uppercase">Articles en stock</div>
                                <div class="text-3xl font-black text-emerald-900 mt-2">${totalStock}</div>
                                <div class="text-xs text-emerald-700 mt-1">d�p��t principal</div>
                            </div>
                            <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                                <div class="text-xs font-black text-amber-600 uppercase">Stock bas</div>
                                <div class="text-3xl font-black text-amber-900 mt-2">${lowStockCount}</div>
                                <div class="text-xs text-amber-700 mt-1">produits �� surveiller</div>
                            </div>
                            <div class="p-4 bg-red-50 border border-red-200 rounded-2xl">
                                <div class="text-xs font-black text-red-600 uppercase">Ruptures</div>
                                <div class="text-3xl font-black text-red-900 mt-2">${ruptureCount}</div>
                                <div class="text-xs text-red-700 mt-1">produits indisponibles</div>
                            </div>
                        </div>

                        ${topLow.length > 0 ? `
                        <div class="bg-white border border-slate-200 rounded-2xl overflow-hidden">
                            <div class="p-4 bg-slate-50 border-b border-slate-200">
                                <h3 class="font-black text-slate-900 text-lg">��Ÿ�Ž Produits sensibles</h3>
                                <p class="text-xs text-slate-500 mt-1">Bas�s sur les seuils du d�p��t principal</p>
                            </div>
                            <div class="overflow-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-600 uppercase">
                                        <tr>
                                            <th class="px-4 py-3 text-left">Produit</th>
                                            <th class="px-4 py-3 text-center">Stock</th>
                                            <th class="px-4 py-3 text-center">Min</th>
                                            <th class="px-4 py-3 text-center">Couverture</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        ${topLow.map(item => {
                                            const coverage = item.min > 0 ? Math.round((item.stock / item.min) * 100) : 100;
                                            return `
                                                <tr class="hover:bg-slate-50">
                                                    <td class="px-4 py-3 font-black text-slate-900">${item.name}</td>
                                                    <td class="px-4 py-3 text-center font-bold ${item.stock === 0 ? 'text-red-600' : 'text-slate-700'}">${item.stock}</td>
                                                    <td class="px-4 py-3 text-center font-bold text-slate-700">${item.min}</td>
                                                    <td class="px-4 py-3 text-center">
                                                        <span class="px-2 py-1 rounded text-xs font-bold ${coverage <= 50 ? 'bg-red-100 text-red-700' : coverage <= 80 ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}">${coverage}%</span>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : ''}

                        ${ruptureCount === 0 ? `
                        <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-4 text-emerald-800 font-black">
                            ���?� Aucun produit en rupture dans le d�p��t principal.
                        </div>
                        ` : ''}
                    </div>
                `;

                UI.modal('��ŸŽ � Indicateurs - D�p��t Principal', html, [{ label: 'Fermer', onclick: 'UI.closeModal()' }], 'max-w-3xl');
                return;
            }

            if (!activePosId) {
                UI.toast('S�lectionnez un POS pour afficher ses indicateurs', 'info');
                return;
            }

            const pos = CORE.getPOS(activePosId);
            if (!pos) {
                UI.toast('POS introuvable', 'error');
                return;
            }

            let totalStock = 0;
            let lowStockCount = 0;
            let ruptureCount = 0;
            const lowStockProducts = [];
            const ruptureProducts = [];

            products.forEach(p => {
                const stock = CORE.getProductStock(p.id, activePosId) || 0;
                totalStock += stock;

                if (stock === 0) {
                    ruptureCount++;
                    ruptureProducts.push(p.name);
                } else if (stock <= (p.minStock || 0)) {
                    lowStockCount++;
                }

                if (stock <= (p.minStock || 0)) {
                    lowStockProducts.push({
                        name: p.name,
                        stock,
                        min: p.minStock || 0
                    });
                }
            });

            const topLow = lowStockProducts
                .sort((a, b) => {
                    const aRatio = a.min > 0 ? (a.stock / a.min) : 1;
                    const bRatio = b.min > 0 ? (b.stock / b.min) : 1;
                    return aRatio - bRatio;
                })
                .slice(0, 15);

            const html = `
                <div class="max-h-[85vh] overflow-y-auto space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                            <div class="text-xs font-black text-emerald-600 uppercase">Articles en stock</div>
                            <div class="text-3xl font-black text-emerald-900 mt-2">${totalStock}</div>
                            <div class="text-xs text-emerald-700 mt-1">${pos.name}</div>
                        </div>
                        <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                            <div class="text-xs font-black text-amber-600 uppercase">Stock bas</div>
                            <div class="text-3xl font-black text-amber-900 mt-2">${lowStockCount}</div>
                            <div class="text-xs text-amber-700 mt-1">produits �� surveiller</div>
                        </div>
                        <div class="p-4 bg-red-50 border border-red-200 rounded-2xl">
                            <div class="text-xs font-black text-red-600 uppercase">Ruptures</div>
                            <div class="text-3xl font-black text-red-900 mt-2">${ruptureCount}</div>
                            <div class="text-xs text-red-700 mt-1">articles indisponibles</div>
                        </div>
                    </div>

                    ${topLow.length > 0 ? `
                    <div class="bg-white border border-slate-200 rounded-2xl overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b border-slate-200">
                            <h3 class="font-black text-slate-900 text-lg">��Ÿ�Ž Produits critiques pour ${pos.name}</h3>
                            <p class="text-xs text-slate-500 mt-1">Bas�s sur les seuils du POS</p>
                        </div>
                        <div class="overflow-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 text-xs font-black text-slate-600 uppercase">
                                    <tr>
                                        <th class="px-4 py-3 text-left">Produit</th>
                                        <th class="px-4 py-3 text-center">Stock</th>
                                        <th class="px-4 py-3 text-center">Min</th>
                                        <th class="px-4 py-3 text-center">Couverture</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${topLow.map(item => {
                                        const coverage = item.min > 0 ? Math.round((item.stock / item.min) * 100) : 100;
                                        return `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-4 py-3 font-black text-slate-900">${item.name}</td>
                                                <td class="px-4 py-3 text-center font-bold ${item.stock === 0 ? 'text-red-600' : 'text-slate-700'}">${item.stock}</td>
                                                <td class="px-4 py-3 text-center font-bold text-slate-700">${item.min}</td>
                                                <td class="px-4 py-3 text-center">
                                                    <span class="px-2 py-1 rounded text-xs font-bold ${coverage <= 50 ? 'bg-red-100 text-red-700' : coverage <= 80 ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}">${coverage}%</span>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}

                    ${ruptureProducts.length > 0 ? `
                    <div class="bg-red-50 border border-red-200 rounded-2xl p-4">
                        <h3 class="font-black text-red-900 text-lg mb-3">�� ��? Produits en rupture</h3>
                        <div class="space-y-2">
                            ${ruptureProducts.map(name => `
                                <div class="p-3 bg-white rounded-lg border border-red-100 font-black text-red-800">
                                    ${name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : `
                    <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-4 text-emerald-800 font-black">
                        ���?� Aucun produit en rupture pour ${pos.name}.
                    </div>
                    `}
                </div>
            `;

            UI.modal(`��ŸŽ � Indicateurs POS - ${pos.name}`, html, [{ label: 'Fermer', onclick: 'UI.closeModal()' }], 'max-w-3xl');
        },

        showTransferHistory() {
            const currentUser = CORE.state.currentUser || {};
            // FILTRE POS STRICT: Si gestionnaire assign� �� un POS (ex: Centre-Ville), NE MONTRER QUE CE POS
            const hasAssignedPos = currentUser.role === 'gestionnaire' && currentUser.pos;
            const forcedPosId = hasAssignedPos ? currentUser.pos : null;
            
            const movements = CORE.db.stockMovements || [];
            const transfersRaw = movements.filter(m => {
                const hasBothPos = m.fromPosId !== null && m.fromPosId !== undefined && m.toPosId !== null && m.toPosId !== undefined;
                const managerDepotTransfer = m.meta?.source === 'manager_transfer' && m.toPosId !== null && m.toPosId !== undefined;
                const isRelevant = hasBothPos || managerDepotTransfer;
                
                // Appliquer le filtre POS strict si gestionnaire a un POS assign�
                if (forcedPosId && isRelevant) {
                    // Ne montrer que les transferts qui impliquent ce POS (entrant ou sortant)
                    return (m.fromPosId === forcedPosId || m.toPosId === forcedPosId);
                }
                return isRelevant;
            });

            if (transfersRaw.length === 0) {
                return UI.toast('Aucun transfert enregistr�', 'info');
            }

            const MAIN_DEPOT_KEY = 'main_depot';
            const MAIN_DEPOT_NAME = 'D�p��t principal';

            const transfers = transfersRaw.map(t => {
                const fromPosName = t.fromPosName
                    || t.meta?.originName
                    || (t.fromPosId ? (CORE.getPOS(t.fromPosId)?.name || `POS ${t.fromPosId}`) : (t.meta?.source === 'manager_transfer' ? MAIN_DEPOT_NAME : '�� ?��'));
                const toPosName = t.toPosName
                    || t.meta?.destinationName
                    || (t.toPosId ? (CORE.getPOS(t.toPosId)?.name || `POS ${t.toPosId}`) : '�� ?��');

                return {
                    ...t,
                    fromPosName,
                    toPosName
                };
            });

            // Trier par date d�croissante
            const sortedTransfers = [...transfers].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Statistiques globales
            const stats = {
                totalTransfers: transfers.length,
                totalQuantity: transfers.reduce((sum, t) => sum + (t.quantity || 0), 0),
                totalValue: transfers.reduce((sum, t) => sum + (t.totalValue || 0), 0),
                uniqueProducts: new Set(transfers.map(t => t.productId)).size,
                uniqueUsers: new Set(transfers.map(t => t.userId)).size
            };
            
            // Analyse par POS (transferts sortants)
            const posSources = {};
            const posDestinations = {};
            
            transfers.forEach(t => {
                // Transferts sortants
                const sourceKey = (t.fromPosId !== null && t.fromPosId !== undefined) ? t.fromPosId : MAIN_DEPOT_KEY;
                if (!posSources[sourceKey]) {
                    posSources[sourceKey] = { qty: 0, value: 0, count: 0, name: t.fromPosName || (sourceKey === MAIN_DEPOT_KEY ? MAIN_DEPOT_NAME : `POS ${sourceKey}`) };
                }
                posSources[sourceKey].qty += t.quantity || 0;
                posSources[sourceKey].value += t.totalValue || 0;
                posSources[sourceKey].count += 1;
                
                // Transferts entrants
                const destKey = (t.toPosId !== null && t.toPosId !== undefined) ? t.toPosId : MAIN_DEPOT_KEY;
                if (!posDestinations[destKey]) {
                    posDestinations[destKey] = { qty: 0, value: 0, count: 0, name: t.toPosName || (destKey === MAIN_DEPOT_KEY ? MAIN_DEPOT_NAME : `POS ${destKey}`) };
                }
                posDestinations[destKey].qty += t.quantity || 0;
                posDestinations[destKey].value += t.totalValue || 0;
                posDestinations[destKey].count += 1;
            });
            
            // Produits les plus transf�r�s
            const productTransfers = {};
            transfers.forEach(t => {
                if (!productTransfers[t.productId]) {
                    productTransfers[t.productId] = { name: t.productName, qty: 0, count: 0 };
                }
                productTransfers[t.productId].qty += t.quantity || 0;
                productTransfers[t.productId].count += 1;
            });
            
            const topProducts = Object.entries(productTransfers)
                .map(([id, data]) => ({ id, ...data }))
                .sort((a, b) => b.qty - a.qty)
                .slice(0, 5);
            
            const html = `
                <div class="max-h-[85vh] overflow-y-auto space-y-6">
                    <!-- KPIs Globaux -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                        <div class="p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl border border-blue-200">
                            <div class="text-xs font-black text-blue-600 uppercase">Total Transferts</div>
                            <div class="text-3xl font-black text-blue-900 mt-2">${stats.totalTransfers}</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl border border-purple-200">
                            <div class="text-xs font-black text-purple-600 uppercase">Articles Transf�r�s</div>
                            <div class="text-3xl font-black text-purple-900 mt-2">${stats.totalQuantity}</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-2xl border border-emerald-200">
                            <div class="text-xs font-black text-emerald-600 uppercase">Valeur Transf�r�e</div>
                            <div class="text-2xl font-black text-emerald-900 mt-2">${CORE.formatPrice(stats.totalValue)}</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-2xl border border-indigo-200">
                            <div class="text-xs font-black text-indigo-600 uppercase">Produits</div>
                            <div class="text-3xl font-black text-indigo-900 mt-2">${stats.uniqueProducts}</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-pink-50 to-pink-100 rounded-2xl border border-pink-200">
                            <div class="text-xs font-black text-pink-600 uppercase">Utilisateurs</div>
                            <div class="text-3xl font-black text-pink-900 mt-2">${stats.uniqueUsers}</div>
                        </div>
                    </div>
                    
                    <!-- Produits les plus transf�r�s -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5">
                        <h3 class="font-black text-slate-900 text-lg mb-4">��Ÿ �� Top 5 Produits Transf�r�s</h3>
                        <div class="space-y-2">
                            ${topProducts.map((p, i) => `
                                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl hover:bg-slate-100">
                                    <div class="flex items-center gap-3 flex-1">
                                        <div class="w-8 h-8 rounded-full ${
                                            i === 0 ? 'bg-yellow-100 text-yellow-700' :
                                            i === 1 ? 'bg-gray-100 text-gray-700' :
                                            i === 2 ? 'bg-orange-100 text-orange-700' :
                                            'bg-slate-200 text-slate-600'
                                        } flex items-center justify-center font-black text-sm">
                                            ${i === 0 ? '��Ÿ ��' : i === 1 ? '��Ÿ ��?' : i === 2 ? '��Ÿ ��' : i + 1}
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <div class="font-black text-slate-900">${p.name}</div>
                                            <div class="text-xs text-slate-500">${p.count} transfert(s)</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-black text-slate-900">${p.qty} unit�s</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Journal d�taill� des transferts -->
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                        <div class="p-5 bg-slate-50 border-b border-slate-200">
                            <h3 class="font-black text-slate-900 text-lg">��Ÿ?� Journal Complet des Transferts</h3>
                            <p class="text-xs text-slate-500 mt-1">${transfers.length} transfert(s) enregistr�(s)</p>
                        </div>
                        <div class="overflow-auto max-h-96">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 sticky top-0 text-xs font-black text-slate-600 uppercase">
                                    <tr>
                                        <th class="px-4 py-3 text-left">Date</th>
                                        <th class="px-4 py-3 text-left">Produit</th>
                                        <th class="px-4 py-3 text-center">Qtit�</th>
                                        <th class="px-4 py-3 text-left">De POS</th>
                                        <th class="px-4 py-3 text-left">Vers POS</th>
                                        <th class="px-4 py-3 text-left">Motif</th>
                                        <th class="px-4 py-3 text-left">Utilisateur</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${sortedTransfers.map(t => `
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-4 py-3 font-bold text-slate-700 whitespace-nowrap">
                                                ${new Date(t.timestamp).toLocaleDateString('fr-FR', { year: 'numeric', month: '2-digit', day: '2-digit' })}
                                                <br>
                                                <span class="text-xs text-slate-500">${new Date(t.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</span>
                                            </td>
                                            <td class="px-4 py-3">
                                                <div class="font-bold text-slate-900">${t.productName}</div>
                                                <div class="text-xs text-slate-500">${t.productSku}</div>
                                            </td>
                                            <td class="px-4 py-3 text-center font-black text-slate-900">${t.quantity}</td>
                                            <td class="px-4 py-3">
                                                <span class="px-2 py-1 bg-red-100 text-red-700 rounded font-bold text-xs">${t.fromPosName}</span>
                                            </td>
                                            <td class="px-4 py-3">
                                                <span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded font-bold text-xs">${t.toPosName}</span>
                                            </td>
                                            <td class="px-4 py-3 text-sm">${t.reason || t.notes || '�� ?��'}</td>
                                            <td class="px-4 py-3 text-sm font-bold text-slate-700">${t.userName}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Analyse par POS -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- POS Sources (transferts sortants) -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-5">
                            <h3 class="font-black text-slate-900 text-lg mb-4">��Ÿ? � Transferts Sortants par POS</h3>
                            <div class="space-y-3">
                                        ${Object.entries(posSources).map(([posId, data]) => {
                                    const pos = Number.isNaN(Number(posId)) ? null : CORE.getPOS(Number(posId));
                                    const displayName = data.name || pos?.name || (posId === MAIN_DEPOT_KEY ? MAIN_DEPOT_NAME : `POS ${posId}`);
                                    return `
                                        <div class="p-3 bg-gradient-to-r from-red-50 to-red-100 rounded-xl border border-red-200">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="font-black text-slate-900">${displayName}</div>
                                                <span class="px-2 py-1 bg-red-200 text-red-800 rounded font-bold text-xs">${data.count} transfert(s)</span>
                                            </div>
                                            <div class="grid grid-cols-2 gap-2 text-sm">
                                                <div class="p-2 bg-white rounded">
                                                    <div class="text-xs text-slate-500">Quantit�</div>
                                                    <div class="font-black text-slate-900">${data.qty}</div>
                                                </div>
                                                <div class="p-2 bg-white rounded">
                                                    <div class="text-xs text-slate-500">Valeur</div>
                                                    <div class="font-black text-slate-900">${CORE.formatPrice(data.value)}</div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- POS Destinations (transferts entrants) -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-5">
                            <h3 class="font-black text-slate-900 text-lg mb-4">��Ÿ? � Transferts Entrants par POS</h3>
                            <div class="space-y-3">
                                        ${Object.entries(posDestinations).map(([posId, data]) => {
                                    const pos = Number.isNaN(Number(posId)) ? null : CORE.getPOS(Number(posId));
                                    const displayName = data.name || pos?.name || (posId === MAIN_DEPOT_KEY ? MAIN_DEPOT_NAME : `POS ${posId}`);
                                    return `
                                        <div class="p-3 bg-gradient-to-r from-emerald-50 to-emerald-100 rounded-xl border border-emerald-200">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="font-black text-slate-900">${displayName}</div>
                                                <span class="px-2 py-1 bg-emerald-200 text-emerald-800 rounded font-bold text-xs">${data.count} transfert(s)</span>
                                            </div>
                                            <div class="grid grid-cols-2 gap-2 text-sm">
                                                <div class="p-2 bg-white rounded">
                                                    <div class="text-xs text-slate-500">Quantit�</div>
                                                    <div class="font-black text-slate-900">${data.qty}</div>
                                                </div>
                                                <div class="p-2 bg-white rounded">
                                                    <div class="text-xs text-slate-500">Valeur</div>
                                                    <div class="font-black text-slate-900">${CORE.formatPrice(data.value)}</div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            UI.modal('��Ÿ?� Historique des Transferts de Stock', html, [{ label: 'Fermer', onclick: 'UI.closeModal()' }], 'max-w-5xl');
        },

        showRestockingAnalysis() {
            const currentUser = CORE.state.currentUser || {};
            // FILTRE POS STRICT: Si gestionnaire assign� �� un POS (ex: Centre-Ville), NE MONTRER QUE CE POS
            const hasAssignedPos = currentUser.role === 'gestionnaire' && currentUser.pos;
            const forcedPosId = hasAssignedPos ? currentUser.pos : null;
            const currentView = this.state.currentView;
            // Ignorer inventoryPosId si gestionnaire a un POS assign�
            const rawStatePos = hasAssignedPos ? NaN : (this.state.inventoryPosId ? parseInt(this.state.inventoryPosId, 10) : NaN);
            const selectedPosId = Number.isFinite(rawStatePos) ? rawStatePos : null;
            // Ne pas autoriser main-stock si gestionnaire a un POS assign�
            const activePosId = hasAssignedPos ? forcedPosId : (currentView === 'main-stock' ? null : (forcedPosId ?? selectedPosId));
            const pos = activePosId ? CORE.getPOS(activePosId) : null;
            const contextLabel = pos ? pos.name : (currentView === 'main-stock' && !hasAssignedPos ? 'D�p��t principal' : 'Tous les POS');

            const analysis = this.analyzeRestockingPatterns(activePosId);
            
            let html = `
                <div class="max-h-[80vh] overflow-y-auto space-y-6">
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-bold text-slate-600">
                        Contexte d'analyse: <span class="text-slate-900">${contextLabel}</span>
                    </div>
                    <!-- Aper��u global -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="p-4 bg-blue-50 rounded-xl border border-blue-200 text-center">
                            <div class="text-xs font-black text-blue-600 uppercase">Total Produits</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${analysis.totalProducts}</div>
                        </div>
                        <div class="p-4 bg-amber-50 rounded-xl border border-amber-200 text-center">
                            <div class="text-xs font-black text-amber-600 uppercase">Stock Bas</div>
                            <div class="text-2xl font-black text-amber-900 mt-1">${analysis.lowStockProducts}</div>
                        </div>
                        <div class="p-4 bg-red-50 rounded-xl border border-red-200 text-center">
                            <div class="text-xs font-black text-red-600 uppercase">Critique</div>
                            <div class="text-2xl font-black text-red-900 mt-1">${analysis.criticalStockProducts}</div>
                        </div>
                        <div class="p-4 bg-emerald-50 rounded-xl border border-emerald-200 text-center">
                            <div class="text-xs font-black text-emerald-600 uppercase">Over-Stock</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${analysis.overStockProducts}</div>
                        </div>
                    </div>
                    
                    <!-- Statistiques cl�s -->
                    <div class="bg-gradient-to-r from-slate-50 to-slate-100 p-5 rounded-xl border border-slate-200 space-y-3">
                        <div class="font-black text-slate-900">��Ÿ?Š Statistiques Cl�s</div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-3 bg-white rounded-lg border border-slate-200">
                                <div class="text-xs text-slate-600 font-bold">Stock Moyen</div>
                                <div class="text-xl font-black text-slate-900 mt-1">${analysis.averageStockLevel} unit�s</div>
                            </div>
                            <div class="p-3 bg-white rounded-lg border border-slate-200">
                                <div class="text-xs text-slate-600 font-bold">Valeur Inventaire</div>
                                <div class="text-xl font-black text-slate-900 mt-1">${CORE.formatPrice(analysis.totalInventoryValue)}</div>
                            </div>
                            <div class="p-3 bg-white rounded-lg border border-slate-200">
                                <div class="text-xs text-slate-600 font-bold">Entr�es (7j)</div>
                                <div class="text-xl font-black text-emerald-600 mt-1">+${analysis.recentMovementsIn}</div>
                            </div>
                            <div class="p-3 bg-white rounded-lg border border-slate-200">
                                <div class="text-xs text-slate-600 font-bold">Sorties (7j)</div>
                                <div class="text-xl font-black text-red-600 mt-1">-${analysis.recentMovementsOut}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top produits en rotation -->
                    ${analysis.topMovingProducts.length > 0 ? `
                        <div class="bg-white border border-slate-200 rounded-xl p-5 space-y-3">
                            <div class="font-black text-slate-900">��Ÿ�? Top 10 Produits en Rotation (30j)</div>
                            <div class="space-y-2">
                                ${analysis.topMovingProducts.map((item, idx) => `
                                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center justify-between">
                                        <div class="flex-1">
                                            <div class="font-bold text-slate-900">${idx+1}. ${item.product.name}</div>
                                            <div class="text-xs text-slate-500 mt-1">
                                                <span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold mr-2">���? ${item.outQty} sorties</span>
                                                <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">���? ${item.inQty} entr�es</span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-amber-600">${item.turns.toFixed(2)} rotations</div>
                                            <div class="text-xs text-slate-500">Stock: ${item.currentStock}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Analyse fournisseurs -->
                    ${analysis.supplierStats.length > 0 ? `
                        <div class="bg-white border border-slate-200 rounded-xl p-5 space-y-3">
                            <div class="font-black text-slate-900">��Ÿ � � Analyse Fournisseurs</div>
                            <div class="space-y-2">
                                ${analysis.supplierStats.filter(s => s.productsCount > 0).map(stat => `
                                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="font-bold text-slate-900">${stat.supplier.name}</div>
                                                <div class="text-xs text-slate-500 mt-1">
                                                    <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded mr-2">��Ÿ? � ${stat.productsCount} produits</span>
                                                    <span class="px-2 py-1 bg-amber-100 text-amber-700 rounded">${stat.pendingOrders} en attente</span>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-black">${CORE.formatPrice(stat.totalSpent)}</div>
                                                <div class="text-xs text-slate-500">Total d�pens�</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            UI.modal('��Ÿ?Š Analyse Avanc�e du R�approvisionnement', html, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        productBelongsToPos(product, posId) {
            if (!posId) return true;
            if (!product) return false;
            const numericPosId = Number(posId);
            if (!Number.isFinite(numericPosId)) return false;
            
            // Si produit est verrouill� �� un POS sp�cifique (cr�� par gestionnaire assign�)
            if (product.lockedToPosId && Number(product.lockedToPosId) !== numericPosId) {
                return false;
            }
            
            // Si le produit a un posId d�fini, il appartient EXCLUSIVEMENT �� ce POS
            // sauf s'il a �t� explicitement transf�r� vers un autre POS via posStocks
            if (product.posId !== null && product.posId !== undefined) {
                if (Number(product.posId) === numericPosId) return true;
                
                // V�rifier si le produit a �t� transf�r� vers ce POS (a du stock dans posStocks)
                const stockMap = product.posStocks || {};
                const entry = stockMap[String(numericPosId)] ?? stockMap[numericPosId] ?? null;
                if (!entry) return false;
                const stock = Number(entry.stock ?? entry.quantity ?? 0);
                if (Number.isFinite(stock) && stock > 0) return true;
                if (entry.assigned === true) return true;
                if (entry.lastMovement || entry.lastUpdated || entry.lastTransfer || entry.lastRestock) return true;
                return false;
            }
            
            // Pour les produits sans posId (produits globaux/main warehouse)
            if (product.isMainWarehouse) return false; // Les produits du d�p��t principal ne sont pas dans les POS
            
            // V�rifier posStocks pour les produits globaux
            const stockMap = product.posStocks || {};
            const entry = stockMap[String(numericPosId)] ?? stockMap[numericPosId] ?? null;
            if (!entry) return false;
            const stock = Number(entry.stock ?? entry.quantity ?? 0);
            if (Number.isFinite(stock) && stock > 0) return true;
            if (entry.assigned === true) return true;
            if (entry.lastMovement || entry.lastUpdated || entry.lastTransfer || entry.lastRestock) return true;
            if (Array.isArray(entry.variants) && entry.variants.length > 0) return true;
            if (entry.price !== undefined && entry.price !== null && entry.price !== product.price) return true;
            return false;
        },

        renderInventory(options = {}) {
            const { forcePosId = null, hidePosSelector = false } = options;
            const tab = this.state.inventoryTab;
            const currentUser = CORE.state.currentUser || {};
            const resolvedForcedPosId = forcePosId !== null && forcePosId !== undefined
                ? forcePosId
                : (currentUser.role === 'gestionnaire' ? currentUser.pos : null);
            const forcedPosIdParsed = resolvedForcedPosId !== null && resolvedForcedPosId !== undefined
                ? parseInt(resolvedForcedPosId, 10)
                : null;
            const forcedPosId = Number.isNaN(forcedPosIdParsed) ? null : forcedPosIdParsed;
            if (forcedPosId) {
                this.state.inventoryPosId = String(forcedPosId);
            }
            const posId = forcedPosId ?? (this.state.inventoryPosId ? parseInt(this.state.inventoryPosId, 10) : null);
            const pos = posId ? CORE.getPOS(posId) : null;
            const allowPosSwitch = !forcedPosId && !hidePosSelector;
            const visiblePosList = allowPosSwitch ? (pos ? [pos] : CORE.db.pointsOfSale) : (pos ? [pos] : []);
            
            // Filter products by POS if selected
            const matchesSelectedPos = (product) => this.productBelongsToPos(product, posId);

            const filteredProducts = CORE.db.products.filter(matchesSelectedPos);
            
            const products = this.getProductsFiltered();
            const movs = this.getMovementsFiltered();
            
            // Calculate inventory value using per-POS stock if selected
            const invValue = filteredProducts.reduce((a,p)=> {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                const price = posId ? CORE.getProductPrice(p.id, posId) : (p.price || 0);
                return a + price * stock;
            }, 0);
            
            // Count low/critical stock items using per-POS values
            const lowCount = filteredProducts.filter(p => {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                return stock <= p.minStock;
            }).length;
            
            const criticalCount = filteredProducts.filter(p => {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                return stock <= (p.minStock * 0.5);
            }).length;
            
            // Calculs pour le dashboard de r�appro using per-POS stock
            const allProducts = filteredProducts || [];
            const lowStockProducts = allProducts.filter(p => {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                return stock <= p.minStock;
            });
            let totalToReorder = 0;
            let totalReorderCost = 0;
            let topCriticalProducts = [];
            
            lowStockProducts.forEach(p => {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                const qty = Math.round((p.minStock || 0) * 2) - stock;
                if (qty > 0) {
                    totalToReorder += qty;
                    totalReorderCost += qty * (p.price || 0);
                }
            });
            
            topCriticalProducts = lowStockProducts
                .sort((a, b) => {
                    const aStock = posId ? CORE.getProductStock(a.id, posId) : (a.stock || 0);
                    const bStock = posId ? CORE.getProductStock(b.id, posId) : (b.stock || 0);
                    return ((aStock || 0) / (a.minStock || 1)) - ((bStock || 0) / (b.minStock || 1));
                })
                .slice(0, 5);

            const posOptions = allowPosSwitch
                ? [{value:'',label:'Tous les POS'}, ...CORE.db.pointsOfSale.map(p=>({value:p.id,label:p.name}))]
                : (pos ? [{ value: pos.id, label: pos.name }] : []);

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">Stock Control Center</h2>
                            <p class="text-slate-500 font-medium">Gestion avanc�e r�partie par POS${pos ? `: ${pos.name}` : ' (tous)'}.</p>
                        </div>
                        <div class="flex flex-wrap gap-2 items-center">
                            ${allowPosSwitch ? `
                                <select onchange="ManagerModule.state.inventoryPosId=this.value;App.rerender()" class="px-4 py-2.5 bg-white border border-slate-200 rounded-xl font-bold">
                                    ${posOptions.map(p => `<option value="${p.value}" ${this.state.inventoryPosId === String(p.value) ? 'selected' : ''}>${p.label}</option>`).join('')}
                                </select>
                            ` : pos ? `
                                <div class="px-4 py-2.5 bg-slate-100 border border-slate-200 rounded-xl font-black text-sm text-slate-700">${pos.name}</div>
                            ` : ''}
                            <button onclick="ManagerModule.showNewProductModal()" class="px-4 py-2.5 bg-sky-600 text-white font-black rounded-xl hover:bg-sky-700 transition">Nouveau produit</button>
                            <button onclick="ManagerModule.showStockDashboard()" class="px-4 py-2.5 bg-indigo-600 text-white font-black rounded-xl hover:bg-indigo-700 transition">��Ÿ?�? Dashboard</button>
                            <button onclick="ManagerModule.showPosStatusIndicators()" class="px-4 py-2.5 bg-cyan-600 text-white font-black rounded-xl hover:bg-cyan-700 transition">��ŸŽ � Indicateurs</button>
                            <button onclick="ManagerModule.showTransferHistory()" class="px-4 py-2.5 bg-teal-600 text-white font-black rounded-xl hover:bg-teal-700 transition">��Ÿ?� Historique</button>
                            <button onclick="ManagerModule.showBulkRestockModal()" class="px-4 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition">R�appro masse</button>
                            <button onclick="ManagerModule.showStockTransferModal('${posId || ''}')" class="px-4 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition">��Ÿ�? Transf�rer</button>
                            <button onclick="ManagerModule.showRestockingAnalysis()" class="px-4 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition">��Ÿ?Š Analyse</button>
                            <button onclick="ManagerModule.exportRestockingRecommendations()" class="px-4 py-2.5 bg-amber-600 text-white font-black rounded-xl hover:bg-amber-700 transition">Recommandations</button>
                            <button onclick="${tab==='products' ? 'ManagerModule.exportInventoryCSV()' : 'ManagerModule.exportMovementsCSV()'}" class="px-4 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition">Exporter CSV</button>
                        </div>
                    </div>

                    <!-- Dashboard de R�approvisionnement -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-5 rounded-2xl border border-blue-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-black text-blue-600 uppercase">Stock Bas</div>
                                    <div class="text-3xl font-black text-blue-900 mt-2">${lowCount}</div>
                                </div>
                                <div class="text-5xl opacity-20">��Ÿ? �</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-red-100 p-5 rounded-2xl border border-red-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-black text-red-600 uppercase">Critique</div>
                                    <div class="text-3xl font-black text-red-900 mt-2">${criticalCount}</div>
                                </div>
                                <div class="text-5xl opacity-20">��š ��� � �</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-5 rounded-2xl border border-amber-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-black text-amber-600 uppercase">�?� Commander</div>
                                    <div class="text-3xl font-black text-amber-900 mt-2">${totalToReorder}</div>
                                </div>
                                <div class="text-5xl opacity-20">��Ÿ�?</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-5 rounded-2xl border border-emerald-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-black text-emerald-600 uppercase">Co��t R�appro</div>
                                    <div class="text-2xl font-black text-emerald-900 mt-2">${CORE.formatPrice(totalReorderCost)}</div>
                                </div>
                                <div class="text-5xl opacity-20">��Ÿ? �</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Produits critiques -->
                    ${topCriticalProducts.length > 0 ? `
                        <div class="bg-gradient-to-r from-red-50 to-amber-50 border border-red-200 rounded-2xl p-5">
                            <div class="font-black text-slate-900 mb-4">��š � Produits en Alerte Critique</div>
                            <div class="space-y-2">
                                ${topCriticalProducts.map(p => {
                                    const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                                    const stockPercent = p.minStock ? Math.round((stock / p.minStock) * 100) : 0;
                                    const toOrder = Math.round((p.minStock || 0) * 2) - stock;
                                    return `
                                        <div class="flex items-center justify-between bg-white p-3 rounded-lg">
                                            <div class="flex-1">
                                                <div class="font-bold text-slate-900">${p.name}</div>
                                                <div class="text-xs text-slate-500">Stock: ${stock} / Min: ${p.minStock || 0}</div>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <div class="text-right">
                                                    <div class="font-black text-red-600">${stockPercent}%</div>
                                                    <div class="text-xs text-slate-500">+${toOrder} unit�s</div>
                                                </div>
                                                <div class="w-12 h-12 rounded-full ${stockPercent <= 25 ? 'bg-red-100 text-red-600' : 'bg-amber-100 text-amber-600'} flex items-center justify-center font-black">${stockPercent}%</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-6 rounded-3xl border border-slate-200">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Valorisation stock</div>
                            <div class="mt-2 text-3xl font-black text-slate-900">${CORE.formatPrice(invValue)}</div>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Produits</div>
                            <div class="mt-2 text-3xl font-black text-slate-900">${filteredProducts.length}</div>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Alertes</div>
                            <div class="mt-2 text-3xl font-black text-red-600">${lowCount}</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-3">
                            <div class="flex items-center gap-2">
                                <button onclick="ManagerModule.state.inventoryTab='products';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='products'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Produits</button>
                                <button onclick="ManagerModule.state.inventoryTab='movements';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='movements'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Mouvements</button>
                            </div>

                            ${tab === 'products' ? `
                                <div class="flex flex-wrap gap-2 items-center">
                                    <div class="relative">
                                        <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                        <input id="manager-inventory-search-input" type="text" value="${this.state.inventorySearch}" onkeyup="ManagerModule.updateInventorySearch(this.value)" placeholder="Rechercher produit..." class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium w-[200px]" style="direction: ltr; text-align: left;" autocomplete="off">
                                    </div>
                                    <select onchange="ManagerModule.state.inventoryCategoryFilter=this.value;ManagerModule.state.inventoryPage=1;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                        <option value="all" ${this.state.inventoryCategoryFilter === 'all' ? 'selected' : ''}>Toutes cat�gories</option>
                                        ${(CORE.db.categories || []).map(c => `<option value="${c.id}" ${this.state.inventoryCategoryFilter == c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                    </select>
                                    <select onchange="ManagerModule.state.inventoryStatusFilter=this.value;ManagerModule.state.inventoryPage=1;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                        <option value="all" ${this.state.inventoryStatusFilter === 'all' ? 'selected' : ''}>Tous les stocks</option>
                                        <option value="ok" ${this.state.inventoryStatusFilter === 'ok' ? 'selected' : ''}>���?� Stock OK</option>
                                        <option value="low" ${this.state.inventoryStatusFilter === 'low' ? 'selected' : ''}>��š ��� � � Stock bas</option>
                                        <option value="critical" ${this.state.inventoryStatusFilter === 'critical' ? 'selected' : ''}>��Ÿ� � Critique</option>
                                        <option value="outofstock" ${this.state.inventoryStatusFilter === 'outofstock' ? 'selected' : ''}>�� ��? Rupture</option>
                                    </select>
                                    <select onchange="ManagerModule.state.inventorySortBy=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                        <option value="name" ${this.state.inventorySortBy === 'name' ? 'selected' : ''}>Nom A-Z</option>
                                        <option value="name_desc" ${this.state.inventorySortBy === 'name_desc' ? 'selected' : ''}>Nom Z-A</option>
                                        <option value="stock_asc" ${this.state.inventorySortBy === 'stock_asc' ? 'selected' : ''}>Stock ���?</option>
                                        <option value="stock_desc" ${this.state.inventorySortBy === 'stock_desc' ? 'selected' : ''}>Stock ���?</option>
                                        <option value="critical" ${this.state.inventorySortBy === 'critical' ? 'selected' : ''}>+ Critiques</option>
                                    </select>
                                </div>
                            ` : `
                                <div class="flex gap-2 flex-wrap">
                                    <div class="relative">
                                        <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                        <input id="manager-movements-search-input" type="text" value="${this.state.movementsSearch}" onkeyup="ManagerModule.updateMovementsSearch(this.value)" placeholder="Produit, ref, user..." class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium w-[260px] max-w-full" style="direction: ltr; text-align: left;" autocomplete="off">
                                    </div>
                                    <select onchange="ManagerModule.state.movementsType=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                        ${[
                                            {value:'all',label:'Tous'},
                                            {value:'in',label:'Entr�es'},
                                            {value:'out',label:'Sorties'},
                                            {value:'adjust',label:'Ajustements'}
                                        ].map(o => `<option value="${o.value}" ${o.value===this.state.movementsType?'selected':''}>${o.label}</option>`).join('')}
                                    </select>
                                </div>
                            `}
                        </div>

                        ${tab === 'products' ? `
                            <div class="overflow-auto">
                                <table class="w-full text-left min-w-[1050px]">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">Produit</th>
                                            <th class="px-6 py-4">Cat�gorie</th>
                                            <th class="px-6 py-4 text-right">Prix</th>
                                            <th class="px-6 py-4">Stock par POS</th>
                                            <th class="px-6 py-4 text-center">Stock</th>
                                            <th class="px-6 py-4 text-center">Min</th>
                                            <th class="px-6 py-4">�tat</th>
                                            <th class="px-6 py-4 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${products.length === 0 ? `<tr><td colspan="8" class="px-6 py-12 text-center text-slate-400 font-medium">Aucun produit</td></tr>` : ''}
                                        ${products.map(p => {
                                            const posId = this.state.inventoryPosId ? parseInt(this.state.inventoryPosId, 10) : null;
                                            const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                                            const price = posId ? CORE.getProductPrice(p.id, posId) : (p.price || 0);
                                            const isLow = stock <= p.minStock;
                                            
                                            // Stocks par POS
                                            const posStockDisplay = visiblePosList.map(visiblePos => {
                                                const posStock = CORE.getProductStock(p.id, visiblePos.id) || 0;
                                                const isCritical = posStock <= (p.minStock * 0.5);
                                                const isLowPos = posStock <= p.minStock && !isCritical;
                                                let badgeClass = 'bg-slate-100 text-slate-600';
                                                if (isCritical) badgeClass = 'bg-red-100 text-red-700 font-bold';
                                                else if (isLowPos) badgeClass = 'bg-amber-100 text-amber-700 font-bold';
                                                return `<span class="px-2 py-1 rounded text-xs font-bold ${badgeClass}">${visiblePos.name.substring(0,8)}: ${posStock}</span>`;
                                            }).join(' ');
                                            
                                            return `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-6 py-4">
                                                    <div class="font-black text-slate-900">${p.name}</div>
                                                    <div class="text-[10px] text-slate-400">#${p.barcode || p.id}</div>
                                                </td>
                                                <td class="px-6 py-4"><span class="px-3 py-1 bg-slate-100 rounded-lg text-xs font-bold text-slate-600">${CORE.getCategory(p.categoryId)?.name || '�� ?��'}</span></td>
                                                <td class="px-6 py-4 text-right font-black">${CORE.formatPrice(price)}</td>
                                                <td class="px-6 py-4">
                                                    <div class="flex flex-wrap gap-1">
                                                        ${posStockDisplay}
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 text-center font-black ${isLow ? 'text-red-600' : 'text-slate-900'}">${stock}</td>
                                                <td class="px-6 py-4 text-center font-black text-slate-700">${p.minStock}</td>
                                                <td class="px-6 py-4">${p.active ? UI.badge('Actif','emerald') : UI.badge('Inactif','slate')} ${isLow ? `<span class="ml-2">${UI.badge('Critique','red')}</span>` : ''}</td>
                                                <td class="px-6 py-4 text-right">
                                                    <div class="flex items-center justify-end gap-2">
                                                        <button onclick="ManagerModule.showProductInfoModal(${p.id})" class="px-3 py-2 rounded-xl bg-blue-600 text-white text-xs font-black hover:bg-blue-700" title="D�tails produit">Info</button>
                                                        <button onclick="ManagerModule.showAdvancedStockModal(${p.id})" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700">Stock</button>
                                                        <button onclick="ManagerModule.showEditProductModal(${p.id})" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-50">�diter</button>
                                                    </div>
                                                </td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                            ${(() => {
                                const stats = this.getProductsStats();
                                if (stats.totalPages <= 1) return stats.totalFiltered > 0 ? `<div class="p-4 text-center text-sm text-slate-500 border-t border-slate-100">${stats.totalFiltered} produit(s)</div>` : '';
                                return `
                                <div class="p-4 border-t border-slate-100 flex flex-wrap items-center justify-between gap-4">
                                    <div class="text-sm text-slate-600 font-medium">
                                        ${stats.totalFiltered === 0 ? 'Aucun produit' : `Affichage ${stats.startIdx + 1}-${Math.min(stats.startIdx + stats.perPage, stats.totalFiltered)} sur ${stats.totalFiltered}`}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-slate-500">Par page:</span>
                                        <select onchange="ManagerModule.state.inventoryPerPage=parseInt(this.value);ManagerModule.state.inventoryPage=1;App.rerender()" class="px-2 py-1 rounded-lg border border-slate-200 bg-white text-sm font-bold">
                                            <option value="25" ${stats.perPage === 25 ? 'selected' : ''}>25</option>
                                            <option value="50" ${stats.perPage === 50 ? 'selected' : ''}>50</option>
                                            <option value="100" ${stats.perPage === 100 ? 'selected' : ''}>100</option>
                                            <option value="200" ${stats.perPage === 200 ? 'selected' : ''}>200</option>
                                        </select>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button onclick="ManagerModule.state.inventoryPage=1;App.rerender()" class="px-3 py-2 rounded-lg ${stats.currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${stats.currentPage === 1 ? 'disabled' : ''}><i data-lucide="chevrons-left" class="w-4 h-4"></i></button>
                                        <button onclick="ManagerModule.state.inventoryPage=Math.max(1,ManagerModule.state.inventoryPage-1);App.rerender()" class="px-3 py-2 rounded-lg ${stats.currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${stats.currentPage === 1 ? 'disabled' : ''}><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                                        ${stats.paginationPages.map(p => p === '...' ? '<span class="px-2 text-slate-400">...</span>' : '<button onclick="ManagerModule.state.inventoryPage=' + p + ';App.rerender()" class="px-3 py-2 rounded-lg ' + (p === stats.currentPage ? 'bg-sky-600 text-white' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm">' + p + '</button>').join('')}
                                        <button onclick="ManagerModule.state.inventoryPage=Math.min(${stats.totalPages},ManagerModule.state.inventoryPage+1);App.rerender()" class="px-3 py-2 rounded-lg ${stats.currentPage === stats.totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${stats.currentPage === stats.totalPages ? 'disabled' : ''}><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                                        <button onclick="ManagerModule.state.inventoryPage=${stats.totalPages};App.rerender()" class="px-3 py-2 rounded-lg ${stats.currentPage === stats.totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${stats.currentPage === stats.totalPages ? 'disabled' : ''}><i data-lucide="chevrons-right" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                                `;
                            })()}
                        ` : `
                            <div class="overflow-auto">
                                <table class="w-full text-left min-w-[1050px]">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">Produit</th>
                                            <th class="px-6 py-4">Type</th>
                                            <th class="px-6 py-4 text-right">Qt�</th>
                                            <th class="px-6 py-4">R�f</th>
                                            <th class="px-6 py-4">Utilisateur</th>
                                            <th class="px-6 py-4 text-right">Date</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${movs.length === 0 ? `<tr><td colspan="6" class="px-6 py-12 text-center text-slate-400 font-medium">Aucun mouvement</td></tr>` : ''}
                                        ${movs.map(m => `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-6 py-4">
                                                    <div class="font-black text-slate-900">${m.productName || '�� ?��'}</div>
                                                    <div class="text-[10px] text-slate-400">#${m.productId || ''}</div>
                                                </td>
                                                <td class="px-6 py-4">${UI.badge(m.type, m.type==='out'?'red':m.type==='in'?'emerald':'blue')}</td>
                                                <td class="px-6 py-4 text-right font-black ${m.type==='out'?'text-red-600':'text-slate-900'}">${m.type==='out' ? '-' : '+'}${m.qty}</td>
                                                <td class="px-6 py-4 text-sm font-bold text-slate-700">${m.ref || '�� ?��'}</td>
                                                <td class="px-6 py-4 text-sm text-slate-600">${m.userName || 'System'}</td>
                                                <td class="px-6 py-4 text-right text-xs text-slate-500">${CORE.formatDate(m.createdAt)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>
                </div>
            `;
        },

        renderMainStockControlCenter() {
            // D�P�?�T PRINCIPAL - Stock master ind�pendant de tous les POS
            const searchQuery = (this.state.inventorySearch || '').toLowerCase().trim();
            const categoryFilter = this.state.mainStockCategoryFilter || 'all';
            const stockFilter = this.state.mainStockStatusFilter || 'all';
            const sortBy = this.state.mainStockSortBy || 'name';
            const sortDir = this.state.mainStockSortDir || 'asc';
            const page = this.state.mainStockPage || 1;
            const perPage = this.state.mainStockPerPage || 50;

            let mainWarehouseProducts = CORE.db.products.filter(p => {
                if (!p.isMainWarehouse || !p.active) return false;
                if (searchQuery && !(p.name || '').toLowerCase().includes(searchQuery) && !(p.barcode || '').toLowerCase().includes(searchQuery)) return false;
                if (categoryFilter !== 'all' && p.categoryId != categoryFilter) return false;
                
                const stock = p.stock || 0;
                const minStock = p.minStock || 0;
                if (stockFilter === 'critical' && stock > minStock * 0.5) return false;
                if (stockFilter === 'low' && (stock > minStock || stock <= minStock * 0.5)) return false;
                if (stockFilter === 'ok' && stock <= minStock) return false;
                if (stockFilter === 'outofstock' && stock > 0) return false;
                
                return true;
            });

            // Tri
            mainWarehouseProducts.sort((a, b) => {
                let valA, valB;
                switch (sortBy) {
                    case 'stock': valA = a.stock || 0; valB = b.stock || 0; break;
                    case 'value': valA = (a.stock || 0) * (a.price || 0); valB = (b.stock || 0) * (b.price || 0); break;
                    case 'price': valA = a.price || 0; valB = b.price || 0; break;
                    default: valA = (a.name || '').toLowerCase(); valB = (b.name || '').toLowerCase();
                }
                if (sortDir === 'desc') return valA > valB ? -1 : 1;
                return valA < valB ? -1 : 1;
            });
            
            // Pagination
            const totalFiltered = mainWarehouseProducts.length;
            const totalPages = Math.ceil(totalFiltered / perPage);
            const currentPage = Math.min(page, totalPages || 1);
            const startIdx = (currentPage - 1) * perPage;
            const paginatedProducts = mainWarehouseProducts.slice(startIdx, startIdx + perPage);
            
            // Generate pagination buttons
            const paginationPages = [];
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationPages.push(i);
                } else if (paginationPages[paginationPages.length - 1] !== '...') {
                    paginationPages.push('...');
                }
            }

            const allMainProducts = CORE.db.products.filter(p => p.isMainWarehouse && p.active);
            const mainStockMetrics = {
                totalProducts: allMainProducts.length,
                totalUnits: allMainProducts.reduce((sum, p) => sum + (p.stock || 0), 0),
                totalValue: allMainProducts.reduce((sum, p) => sum + (p.stock || 0) * (p.price || 0), 0),
                lowStockCount: allMainProducts.filter(p => (p.stock || 0) <= (p.minStock || 0) && (p.stock || 0) > (p.minStock || 0) * 0.5).length,
                criticalCount: allMainProducts.filter(p => (p.stock || 0) <= ((p.minStock || 0) * 0.5) && (p.stock || 0) > 0).length,
                outOfStockCount: allMainProducts.filter(p => (p.stock || 0) === 0).length,
                okCount: allMainProducts.filter(p => (p.stock || 0) > (p.minStock || 0)).length
            };

            // Mouvements r�cents (7 derniers jours)
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const recentMovements = (CORE.db.stockMovements || [])
                .filter(m => m.isMainWarehouse && new Date(m.createdAt) >= sevenDaysAgo)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 10);

            // Transferts en attente
            const pendingTransfers = (CORE.db.stockTransfers || []).filter(t => t.status === 'pending').length;

            // Cat�gories pour filtre
            const categories = CORE.db.categories || [];

            // Top produits par valeur
            const topByValue = [...allMainProducts].sort((a, b) => 
                ((b.stock || 0) * (b.price || 0)) - ((a.stock || 0) * (a.price || 0))
            ).slice(0, 5);

            // Alertes prioritaires
            const urgentAlerts = allMainProducts
                .filter(p => (p.stock || 0) === 0 || (p.stock || 0) <= (p.minStock || 0) * 0.5)
                .slice(0, 5);

            return `
                <div class="fade-in max-w-full mx-auto space-y-6 p-4 lg:p-6">
                    <!-- Header avec actions rapides -->
                    <div class="bg-gradient-to-r from-slate-800 via-slate-900 to-slate-800 rounded-3xl p-6 text-white shadow-xl">
                        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                            <div>
                                <h2 class="text-3xl font-black flex items-center gap-3">
                                    <span class="w-12 h-12 bg-white/10 rounded-2xl flex items-center justify-center">��Ÿ � �</span>
                                    Stock Control Center
                                </h2>
                                <p class="text-slate-300 mt-2 font-medium">D�p��t Principal �� ?� � Gestion centralis�e du stock master</p>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="ManagerModule.showNewProductModal('main')" class="px-4 py-2.5 bg-emerald-500 text-white font-bold rounded-xl hover:bg-emerald-600 transition flex items-center gap-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i> Nouveau
                                </button>
                                <button onclick="ManagerModule.showMainTransferModal()" class="px-4 py-2.5 bg-purple-500 text-white font-bold rounded-xl hover:bg-purple-600 transition flex items-center gap-2">
                                    <i data-lucide="arrow-right-left" class="w-4 h-4"></i> Transf�rer
                                </button>
                                <button onclick="ManagerModule.showBulkRestockModal()" class="px-4 py-2.5 bg-blue-500 text-white font-bold rounded-xl hover:bg-blue-600 transition flex items-center gap-2">
                                    <i data-lucide="package-plus" class="w-4 h-4"></i> R�appro
                                </button>
                                <div class="relative">
                                    <button onclick="this.nextElementSibling.classList.toggle('hidden')" class="px-4 py-2.5 bg-white/10 text-white font-bold rounded-xl hover:bg-white/20 transition flex items-center gap-2">
                                        <i data-lucide="more-horizontal" class="w-4 h-4"></i> Plus
                                    </button>
                                    <div class="hidden absolute right-0 top-full mt-2 bg-white rounded-xl shadow-2xl border border-slate-200 py-2 z-50 min-w-[200px]">
                                        <button onclick="ManagerModule.showStockDashboard(); this.parentElement.classList.add('hidden')" class="w-full px-4 py-2 text-left text-sm font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                            <i data-lucide="bar-chart-3" class="w-4 h-4"></i> Dashboard
                                        </button>
                                        <button onclick="ManagerModule.showRestockingAnalysis(); this.parentElement.classList.add('hidden')" class="w-full px-4 py-2 text-left text-sm font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                            <i data-lucide="brain" class="w-4 h-4"></i> Analyse IA
                                        </button>
                                        <button onclick="ManagerModule.showTransferHistory(); this.parentElement.classList.add('hidden')" class="w-full px-4 py-2 text-left text-sm font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                            <i data-lucide="history" class="w-4 h-4"></i> Historique
                                        </button>
                                        <button onclick="ManagerModule.showPosStatusIndicators(); this.parentElement.classList.add('hidden')" class="w-full px-4 py-2 text-left text-sm font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                            <i data-lucide="target" class="w-4 h-4"></i> Indicateurs POS
                                        </button>
                                        <hr class="my-2 border-slate-100">
                                        <button onclick="ManagerModule.exportRestockingRecommendations(); this.parentElement.classList.add('hidden')" class="w-full px-4 py-2 text-left text-sm font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                            <i data-lucide="file-text" class="w-4 h-4"></i> Recommandations
                                        </button>
                                        <button onclick="ManagerModule.exportMainStockCSV(); this.parentElement.classList.add('hidden')" class="w-full px-4 py-2 text-left text-sm font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                            <i data-lucide="download" class="w-4 h-4"></i> Exporter CSV
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                        <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm hover:shadow-md transition cursor-pointer" onclick="ManagerModule.state.mainStockStatusFilter='all';App.rerender()">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="box" class="w-5 h-5 text-blue-600"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-black text-slate-900">${mainStockMetrics.totalProducts}</div>
                                    <div class="text-xs font-bold text-slate-500">Produits</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm hover:shadow-md transition">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="layers" class="w-5 h-5 text-indigo-600"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-black text-slate-900">${mainStockMetrics.totalUnits.toLocaleString()}</div>
                                    <div class="text-xs font-bold text-slate-500">Unit�s</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm hover:shadow-md transition">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="banknote" class="w-5 h-5 text-emerald-600"></i>
                                </div>
                                <div>
                                    <div class="text-lg font-black text-slate-900">${CORE.formatPrice(mainStockMetrics.totalValue)}</div>
                                    <div class="text-xs font-bold text-slate-500">Valeur</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-emerald-200 p-4 shadow-sm hover:shadow-md transition cursor-pointer ${stockFilter === 'ok' ? 'ring-2 ring-emerald-500' : ''}" onclick="ManagerModule.state.mainStockStatusFilter='ok';App.rerender()">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="check-circle" class="w-5 h-5 text-emerald-600"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-black text-emerald-600">${mainStockMetrics.okCount}</div>
                                    <div class="text-xs font-bold text-slate-500">OK</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-amber-200 p-4 shadow-sm hover:shadow-md transition cursor-pointer ${stockFilter === 'low' ? 'ring-2 ring-amber-500' : ''}" onclick="ManagerModule.state.mainStockStatusFilter='low';App.rerender()">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-black text-amber-600">${mainStockMetrics.lowStockCount}</div>
                                    <div class="text-xs font-bold text-slate-500">Bas</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-orange-200 p-4 shadow-sm hover:shadow-md transition cursor-pointer ${stockFilter === 'critical' ? 'ring-2 ring-orange-500' : ''}" onclick="ManagerModule.state.mainStockStatusFilter='critical';App.rerender()">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="alert-octagon" class="w-5 h-5 text-orange-600"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-black text-orange-600">${mainStockMetrics.criticalCount}</div>
                                    <div class="text-xs font-bold text-slate-500">Critique</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-red-200 p-4 shadow-sm hover:shadow-md transition cursor-pointer ${stockFilter === 'outofstock' ? 'ring-2 ring-red-500' : ''}" onclick="ManagerModule.state.mainStockStatusFilter='outofstock';App.rerender()">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="x-circle" class="w-5 h-5 text-red-600"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-black text-red-600">${mainStockMetrics.outOfStockCount}</div>
                                    <div class="text-xs font-bold text-slate-500">Rupture</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grid principal: Alertes + Top Valeur + Mouvements -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Alertes Urgentes -->
                        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-4 bg-gradient-to-r from-red-500 to-orange-500 text-white">
                                <div class="font-black flex items-center gap-2">
                                    <i data-lucide="bell-ring" class="w-5 h-5"></i> Alertes Urgentes
                                </div>
                                <div class="text-xs text-red-100 mt-1">Produits n�cessitant une action imm�diate</div>
                            </div>
                            <div class="p-4 space-y-3 max-h-64 overflow-auto">
                                ${urgentAlerts.length === 0 ? `
                                    <div class="text-center py-6">
                                        <div class="text-4xl mb-2">���?�</div>
                                        <div class="text-sm font-bold text-emerald-600">Aucune alerte</div>
                                        <div class="text-xs text-slate-500">Tous les stocks sont corrects</div>
                                    </div>
                                ` : urgentAlerts.map(p => `
                                    <div class="flex items-center gap-3 p-3 ${(p.stock || 0) === 0 ? 'bg-red-50 border border-red-200' : 'bg-orange-50 border border-orange-200'} rounded-xl">
                                        <div class="w-10 h-10 rounded-xl ${(p.stock || 0) === 0 ? 'bg-red-500' : 'bg-orange-500'} flex items-center justify-center text-white font-black">
                                            ${(p.stock || 0) === 0 ? '!' : p.stock}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-slate-900 truncate">${p.name}</div>
                                            <div class="text-xs ${(p.stock || 0) === 0 ? 'text-red-600' : 'text-orange-600'} font-bold">
                                                ${(p.stock || 0) === 0 ? '��Ÿ� � RUPTURE' : '��š ��� � � Stock critique'}
                                            </div>
                                        </div>
                                        <button onclick="ManagerModule.quickRestock(${p.id})" class="px-3 py-1.5 bg-white border border-slate-200 rounded-lg text-xs font-bold hover:bg-slate-50">
                                            +Stock
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Top par Valeur -->
                        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-4 bg-gradient-to-r from-emerald-500 to-teal-500 text-white">
                                <div class="font-black flex items-center gap-2">
                                    <i data-lucide="trophy" class="w-5 h-5"></i> Top Valorisation
                                </div>
                                <div class="text-xs text-emerald-100 mt-1">Produits �� plus haute valeur en stock</div>
                            </div>
                            <div class="p-4 space-y-3">
                                ${topByValue.map((p, i) => {
                                    const value = (p.stock || 0) * (p.price || 0);
                                    return `
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-lg ${i === 0 ? 'bg-amber-500' : i === 1 ? 'bg-slate-400' : i === 2 ? 'bg-amber-700' : 'bg-slate-200'} flex items-center justify-center text-white font-black text-sm">
                                                ${i + 1}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="font-bold text-slate-900 truncate text-sm">${p.name}</div>
                                                <div class="text-xs text-slate-500">${p.stock || 0} unit�s</div>
                                            </div>
                                            <div class="font-black text-emerald-600 text-sm">${CORE.formatPrice(value)}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Mouvements R�cents -->
                        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-4 bg-gradient-to-r from-blue-500 to-indigo-500 text-white flex items-center justify-between">
                                <div>
                                    <div class="font-black flex items-center gap-2">
                                        <i data-lucide="activity" class="w-5 h-5"></i> Activit� R�cente
                                    </div>
                                    <div class="text-xs text-blue-100 mt-1">7 derniers jours</div>
                                </div>
                                ${pendingTransfers > 0 ? `
                                    <div class="px-3 py-1 bg-white/20 rounded-lg text-xs font-bold">
                                        ${pendingTransfers} transfert(s) en attente
                                    </div>
                                ` : ''}
                            </div>
                            <div class="p-4 space-y-2 max-h-64 overflow-auto">
                                ${recentMovements.length === 0 ? `
                                    <div class="text-center py-6 text-slate-400">
                                        <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                        <div class="text-sm">Aucun mouvement r�cent</div>
                                    </div>
                                ` : recentMovements.map(m => `
                                    <div class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded-lg">
                                        <div class="w-8 h-8 rounded-lg ${m.type === 'in' ? 'bg-emerald-100 text-emerald-600' : m.type === 'out' ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'} flex items-center justify-center">
                                            <i data-lucide="${m.type === 'in' ? 'arrow-down' : m.type === 'out' ? 'arrow-up' : 'arrow-right-left'}" class="w-4 h-4"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-slate-900 truncate text-sm">${m.productName || 'Produit'}</div>
                                            <div class="text-xs text-slate-500">${CORE.formatDate(m.createdAt)}</div>
                                        </div>
                                        <div class="font-black ${m.type === 'in' ? 'text-emerald-600' : 'text-red-600'} text-sm">
                                            ${m.type === 'in' ? '+' : '-'}${m.qty}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Tableau Stock avec filtres avanc�s -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                        <!-- Barre de filtres -->
                        <div class="p-4 border-b border-slate-100 bg-slate-50">
                            <div class="flex flex-col lg:flex-row lg:items-center gap-4">
                                <!-- Recherche -->
                                <div class="relative flex-1">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input id="main-stock-search" type="text" value="${this.state.inventorySearch || ''}" 
                                        onkeyup="ManagerModule.state.inventorySearch=this.value;ManagerModule.state.mainStockPage=1;App.rerender()" 
                                        placeholder="Rechercher par nom ou code-barres..." 
                                        class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium focus:ring-2 focus:ring-blue-500 outline-none" autocomplete="off">
                                </div>
                                
                                <!-- Filtre cat�gorie -->
                                <select onchange="ManagerModule.state.mainStockCategoryFilter=this.value;ManagerModule.state.mainStockPage=1;App.rerender()" 
                                    class="px-4 py-2.5 rounded-xl border border-slate-200 bg-white font-bold text-sm">
                                    <option value="all" ${categoryFilter === 'all' ? 'selected' : ''}>Toutes cat�gories</option>
                                    ${categories.map(c => `<option value="${c.id}" ${categoryFilter == c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                </select>

                                <!-- Filtre statut -->
                                <select onchange="ManagerModule.state.mainStockStatusFilter=this.value;ManagerModule.state.mainStockPage=1;App.rerender()" 
                                    class="px-4 py-2.5 rounded-xl border border-slate-200 bg-white font-bold text-sm">
                                    <option value="all" ${stockFilter === 'all' ? 'selected' : ''}>Tous les statuts</option>
                                    <option value="ok" ${stockFilter === 'ok' ? 'selected' : ''}>���?� Stock OK</option>
                                    <option value="low" ${stockFilter === 'low' ? 'selected' : ''}>��š ��� � � Stock bas</option>
                                    <option value="critical" ${stockFilter === 'critical' ? 'selected' : ''}>��Ÿ� � Critique</option>
                                    <option value="outofstock" ${stockFilter === 'outofstock' ? 'selected' : ''}>��Ÿ� � Rupture</option>
                                </select>

                                <!-- Tri -->
                                <select onchange="ManagerModule.state.mainStockSortBy=this.value;App.rerender()" 
                                    class="px-4 py-2.5 rounded-xl border border-slate-200 bg-white font-bold text-sm">
                                    <option value="name" ${sortBy === 'name' ? 'selected' : ''}>Trier par nom</option>
                                    <option value="stock" ${sortBy === 'stock' ? 'selected' : ''}>Trier par stock</option>
                                    <option value="value" ${sortBy === 'value' ? 'selected' : ''}>Trier par valeur</option>
                                    <option value="price" ${sortBy === 'price' ? 'selected' : ''}>Trier par prix</option>
                                </select>

                                <button onclick="ManagerModule.state.mainStockSortDir = ManagerModule.state.mainStockSortDir === 'asc' ? 'desc' : 'asc'; App.rerender()" 
                                    class="p-2.5 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 transition" title="Inverser le tri">
                                    <i data-lucide="${sortDir === 'asc' ? 'arrow-up' : 'arrow-down'}" class="w-4 h-4 text-slate-600"></i>
                                </button>

                                ${(searchQuery || categoryFilter !== 'all' || stockFilter !== 'all') ? `
                                    <button onclick="ManagerModule.state.inventorySearch='';ManagerModule.state.mainStockCategoryFilter='all';ManagerModule.state.mainStockStatusFilter='all';ManagerModule.state.mainStockPage=1;App.rerender()" 
                                        class="px-4 py-2.5 bg-slate-200 text-slate-700 font-bold rounded-xl hover:bg-slate-300 transition flex items-center gap-2">
                                        <i data-lucide="x" class="w-4 h-4"></i> R�initialiser
                                    </button>
                                ` : ''}
                            </div>

                            <div class="flex items-center justify-between mt-3">
                                <div class="text-sm font-bold text-slate-600">
                                    ${totalFiltered} produit(s) trouv�s sur ${mainStockMetrics.totalProducts}
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="ManagerModule.selectAllMainProducts()" class="text-xs font-bold text-blue-600 hover:underline">Tout s�lectionner</button>
                                    <span class="text-slate-300">|</span>
                                    <button onclick="ManagerModule.bulkUpdateSelectedProducts()" class="text-xs font-bold text-emerald-600 hover:underline">Modifier la s�lection</button>
                                </div>
                            </div>
                        </div>

                        <!-- Tableau -->
                        <div class="overflow-auto">
                            <table class="w-full text-left min-w-[1000px]">
                                <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3 w-10">
                                            <input type="checkbox" id="select-all-main" onchange="ManagerModule.toggleSelectAllMain(this.checked)" class="w-4 h-4 rounded border-slate-300">
                                        </th>
                                        <th class="px-4 py-3">Produit</th>
                                        <th class="px-4 py-3">Cat�gorie</th>
                                        <th class="px-4 py-3 text-right">Prix</th>
                                        <th class="px-4 py-3 text-center">Stock</th>
                                        <th class="px-4 py-3 text-center">Min</th>
                                        <th class="px-4 py-3 text-center">Jauge</th>
                                        <th class="px-4 py-3 text-right">Valeur</th>
                                        <th class="px-4 py-3 text-center">�tat</th>
                                        <th class="px-4 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${paginatedProducts.length === 0 ? `
                                        <tr>
                                            <td colspan="10" class="px-6 py-12 text-center">
                                                <div class="text-slate-400">
                                                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                                                    <div class="font-bold">Aucun produit trouv�</div>
                                                    <div class="text-sm mt-1">Modifiez vos filtres ou ajoutez de nouveaux produits</div>
                                                </div>
                                            </td>
                                        </tr>
                                    ` : ''}
                                    ${paginatedProducts.map(p => {
                                        const stock = p.stock || 0;
                                        const minStock = p.minStock || 1;
                                        const isLow = stock <= minStock && stock > minStock * 0.5;
                                        const isCritical = stock <= minStock * 0.5 && stock > 0;
                                        const isOut = stock === 0;
                                        const value = stock * (p.price || 0);
                                        const cat = CORE.getCategory(p.categoryId);
                                        const gaugePercent = Math.min(100, Math.round((stock / Math.max(minStock * 2, 1)) * 100));
                                        const gaugeColor = isOut ? 'bg-red-500' : isCritical ? 'bg-orange-500' : isLow ? 'bg-amber-500' : 'bg-emerald-500';
                                        
                                        return `
                                            <tr class="hover:bg-blue-50/50 transition group">
                                                <td class="px-4 py-3">
                                                    <input type="checkbox" data-product-id="${p.id}" class="main-product-checkbox w-4 h-4 rounded border-slate-300">
                                                </td>
                                                <td class="px-4 py-3">
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center text-lg">
                                                            ${p.image ? `<img src="${p.image}" class="w-10 h-10 rounded-xl object-cover">` : '��Ÿ? �'}
                                                        </div>
                                                        <div>
                                                            <div class="font-black text-slate-900">${p.name}</div>
                                                            <div class="text-xs text-slate-500">${p.barcode || 'Sans code-barres'}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="px-3 py-1 bg-slate-100 rounded-lg text-xs font-bold text-slate-600">${cat?.name || 'N/A'}</span>
                                                </td>
                                                <td class="px-4 py-3 text-right font-bold">${CORE.formatPrice(p.price || 0)}</td>
                                                <td class="px-4 py-3 text-center">
                                                    <div class="inline-flex items-center gap-1">
                                                        <button onclick="ManagerModule.adjustMainStock(${p.id}, -1)" class="w-6 h-6 rounded bg-slate-200 hover:bg-red-200 transition text-slate-600 font-bold">-</button>
                                                        <input type="number" value="${stock}" 
                                                            onchange="CORE.setProductStock(${p.id}, null, this.value); App.rerender()" 
                                                            class="w-16 text-center bg-white border border-slate-200 rounded px-2 py-1 font-black focus:ring-2 focus:ring-blue-500 outline-none" min="0">
                                                        <button onclick="ManagerModule.adjustMainStock(${p.id}, 1)" class="w-6 h-6 rounded bg-slate-200 hover:bg-emerald-200 transition text-slate-600 font-bold">+</button>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3 text-center text-sm text-slate-500">${minStock}</td>
                                                <td class="px-4 py-3">
                                                    <div class="w-24 mx-auto">
                                                        <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
                                                            <div class="h-full ${gaugeColor} transition-all" style="width: ${gaugePercent}%"></div>
                                                        </div>
                                                        <div class="text-[10px] text-center text-slate-400 mt-1">${gaugePercent}%</div>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3 text-right font-bold text-slate-700">${CORE.formatPrice(value)}</td>
                                                <td class="px-4 py-3 text-center">
                                                    ${isOut ? `<span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-black animate-pulse">��Ÿ� � Rupture</span>` 
                                                    : isCritical ? `<span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-black">��š ��� � � Critique</span>` 
                                                    : isLow ? `<span class="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-black">��Ÿ?� Bas</span>` 
                                                    : `<span class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-black">���?� OK</span>`}
                                                </td>
                                                <td class="px-4 py-3">
                                                    <div class="flex items-center justify-end gap-1 opacity-60 group-hover:opacity-100 transition">
                                                        <button onclick="ManagerModule.quickRestock(${p.id})" class="p-2 rounded-lg hover:bg-emerald-100 text-emerald-600 transition" title="R�approvisionner">
                                                            <i data-lucide="package-plus" class="w-4 h-4"></i>
                                                        </button>
                                                        <button onclick="ManagerModule.quickTransfer(${p.id})" class="p-2 rounded-lg hover:bg-purple-100 text-purple-600 transition" title="Transf�rer vers POS">
                                                            <i data-lucide="send" class="w-4 h-4"></i>
                                                        </button>
                                                        <button onclick="ManagerModule.showMainProductModal(${p.id})" class="p-2 rounded-lg hover:bg-blue-100 text-blue-600 transition" title="D�tails">
                                                            <i data-lucide="info" class="w-4 h-4"></i>
                                                        </button>
                                                        <button onclick="ManagerModule.showEditProductModal(${p.id})" class="p-2 rounded-lg hover:bg-slate-100 text-slate-600 transition" title="Modifier">
                                                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>

                        <!-- Footer avec pagination/stats -->
                        <div class="p-4 border-t border-slate-100 bg-slate-50">
                            <div class="flex flex-wrap items-center justify-between gap-4">
                                <div class="text-sm text-slate-600 font-medium">
                                    ${totalFiltered === 0 ? 'Aucun produit' : `Affichage ${startIdx + 1}-${Math.min(startIdx + perPage, totalFiltered)} sur ${totalFiltered} produit(s)`}
                                    <span class="text-slate-400 ml-2">�� ?� � Valeur: <span class="font-black text-slate-900">${CORE.formatPrice(paginatedProducts.reduce((s, p) => s + (p.stock || 0) * (p.price || 0), 0))}</span></span>
                                </div>
                                
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-slate-500">Par page:</span>
                                    <select onchange="ManagerModule.state.mainStockPerPage=parseInt(this.value);ManagerModule.state.mainStockPage=1;App.rerender()" class="px-2 py-1 rounded-lg border border-slate-200 bg-white text-sm font-bold">
                                        <option value="25" ${perPage === 25 ? 'selected' : ''}>25</option>
                                        <option value="50" ${perPage === 50 ? 'selected' : ''}>50</option>
                                        <option value="100" ${perPage === 100 ? 'selected' : ''}>100</option>
                                        <option value="200" ${perPage === 200 ? 'selected' : ''}>200</option>
                                    </select>
                                </div>
                                
                                ${totalPages > 1 ? `
                                <div class="flex items-center gap-2">
                                    <button onclick="ManagerModule.state.mainStockPage=1;App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === 1 ? 'disabled' : ''}><i data-lucide="chevrons-left" class="w-4 h-4"></i></button>
                                    <button onclick="ManagerModule.state.mainStockPage=Math.max(1,ManagerModule.state.mainStockPage-1);App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === 1 ? 'disabled' : ''}><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                                    ${paginationPages.map(p => p === '...' ? '<span class="px-2 text-slate-400">...</span>' : '<button onclick="ManagerModule.state.mainStockPage=' + p + ';App.rerender()" class="px-3 py-2 rounded-lg ' + (p === currentPage ? 'bg-slate-900 text-white' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm">' + p + '</button>').join('')}
                                    <button onclick="ManagerModule.state.mainStockPage=Math.min(${totalPages},ManagerModule.state.mainStockPage+1);App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === totalPages ? 'disabled' : ''}><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                                    <button onclick="ManagerModule.state.mainStockPage=${totalPages};App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === totalPages ? 'disabled' : ''}><i data-lucide="chevrons-right" class="w-4 h-4"></i></button>
                                </div>
                                ` : ''}
                                
                                <div class="flex items-center gap-2">
                                    <button onclick="ManagerModule.printMainStockReport()" class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-bold hover:bg-slate-50 flex items-center gap-2">
                                        <i data-lucide="printer" class="w-4 h-4"></i> Imprimer
                                    </button>
                                    <button onclick="ManagerModule.exportMainStockCSV()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm font-bold hover:bg-emerald-700 flex items-center gap-2">
                                        <i data-lucide="download" class="w-4 h-4"></i> Export CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        // Fonctions auxiliaires pour le Stock Control Center
        adjustMainStock(productId, delta) {
            const product = CORE.db.products.find(p => p.id === productId);
            if (!product) return;
            const newStock = Math.max(0, (product.stock || 0) + delta);
            CORE.setProductStock(productId, null, newStock);
            App.rerender();
        },

        quickRestock(productId) {
            const product = CORE.db.products.find(p => p.id === productId);
            if (!product) return;
            
            UI.modal(`R�approvisionner: ${product.name}`, `
                <div class="space-y-4">
                    <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-xl">
                        <div class="w-16 h-16 bg-slate-200 rounded-xl flex items-center justify-center text-2xl">��Ÿ? �</div>
                        <div>
                            <div class="font-black text-slate-900">${product.name}</div>
                            <div class="text-sm text-slate-500">Stock actuel: <span class="font-black ${(product.stock || 0) <= (product.minStock || 0) ? 'text-red-600' : 'text-emerald-600'}">${product.stock || 0}</span> | Min: ${product.minStock || 0}</div>
                        </div>
                    </div>
                    ${UI.input('restock_qty', 'Quantit� �� ajouter', 'number', '', 'Ex: 50', true)}
                    ${UI.input('restock_ref', 'R�f�rence/Bon de commande', 'text', '', 'Ex: BC-2024-001', false)}
                    ${UI.textarea('restock_note', 'Note', '', 'Optionnel', 2)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Ajouter au stock', onclick: `ManagerModule.executeQuickRestock(${productId})`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' }
            ]);
        },

        executeQuickRestock(productId) {
            const qty = parseInt(UI.val('restock_qty'), 10);
            if (!qty || qty <= 0) return UI.toast('Quantit� invalide', 'warning');
            
            const ref = UI.val('restock_ref').trim() || `RESTOCK-${Date.now()}`;
            const note = UI.val('restock_note').trim();
            
            const product = CORE.db.products.find(p => p.id === productId);
            if (!product) return;
            
            const newStock = (product.stock || 0) + qty;
            CORE.setProductStock(productId, null, newStock);
            
            // Enregistrer le mouvement
            CORE.db.stockMovements = CORE.db.stockMovements || [];
            CORE.db.stockMovements.push({
                id: Date.now(),
                productId,
                productName: product.name,
                type: 'in',
                qty,
                ref,
                note,
                isMainWarehouse: true,
                userName: CORE.state.currentUser?.name || 'System',
                createdAt: new Date().toISOString()
            });
            CORE.save();
            
            UI.closeModal();
            UI.toast(`+${qty} unit�s ajout�es �� ${product.name}`, 'success');
            App.rerender();
        },

        quickTransfer(productId) {
            const product = CORE.db.products.find(p => p.id === productId);
            if (!product) return;
            
            const posList = CORE.db.pointsOfSale || [];
            
            UI.modal(`Transf�rer: ${product.name}`, `
                <div class="space-y-4">
                    <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-xl">
                        <div class="w-16 h-16 bg-slate-200 rounded-xl flex items-center justify-center text-2xl">��Ÿ? �</div>
                        <div>
                            <div class="font-black text-slate-900">${product.name}</div>
                            <div class="text-sm text-slate-500">Stock d�p��t: <span class="font-black text-blue-600">${product.stock || 0}</span></div>
                        </div>
                    </div>
                    ${UI.select('transfer_pos', 'Point de vente destination', posList.map(p => ({value: p.id, label: p.name})), '', true)}
                    ${UI.input('transfer_qty', 'Quantit� �� transf�rer', 'number', '', 'Ex: 20', true)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Transf�rer', onclick: `ManagerModule.executeQuickTransfer(${productId})`, class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700' }
            ]);
        },

        executeQuickTransfer(productId) {
            const posId = parseInt(UI.val('transfer_pos'), 10);
            const qty = parseInt(UI.val('transfer_qty'), 10);
            
            if (!posId) return UI.toast('S�lectionnez un point de vente', 'warning');
            if (!qty || qty <= 0) return UI.toast('Quantit� invalide', 'warning');
            
            const product = CORE.db.products.find(p => p.id === productId);
            if (!product) return;
            
            if ((product.stock || 0) < qty) return UI.toast('Stock insuffisant au d�p��t', 'error');
            
            // R�duire stock d�p��t
            const newMainStock = (product.stock || 0) - qty;
            CORE.setProductStock(productId, null, newMainStock);
            
            // Ajouter stock POS
            const posStock = (product.posStock || {})[posId] || 0;
            product.posStock = product.posStock || {};
            product.posStock[posId] = posStock + qty;
            
            // Enregistrer le transfert
            CORE.db.stockTransfers = CORE.db.stockTransfers || [];
            CORE.db.stockTransfers.push({
                id: Date.now(),
                productId,
                productName: product.name,
                fromWarehouse: true,
                toPosId: posId,
                qty,
                status: 'completed',
                createdBy: CORE.state.currentUser?.name || 'System',
                createdAt: new Date().toISOString()
            });
            CORE.save();
            
            const pos = CORE.getPOS(posId);
            UI.closeModal();
            UI.toast(`${qty} unit�s transf�r�es vers ${pos?.name || 'POS'}`, 'success');
            App.rerender();
        },

        toggleSelectAllMain(checked) {
            document.querySelectorAll('.main-product-checkbox').forEach(cb => cb.checked = checked);
        },

        selectAllMainProducts() {
            document.querySelectorAll('.main-product-checkbox').forEach(cb => cb.checked = true);
            const selectAll = document.getElementById('select-all-main');
            if (selectAll) selectAll.checked = true;
        },

        bulkUpdateSelectedProducts() {
            const selected = Array.from(document.querySelectorAll('.main-product-checkbox:checked')).map(cb => parseInt(cb.dataset.productId, 10));
            if (selected.length === 0) return UI.toast('Aucun produit s�lectionn�', 'warning');
            
            UI.modal(`Modifier ${selected.length} produit(s)`, `
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl">
                        <div class="font-bold text-blue-800">${selected.length} produit(s) s�lectionn�(s)</div>
                        <div class="text-sm text-blue-600">Les modifications s'appliqueront �� tous</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        ${UI.input('bulk_add_stock', 'Ajouter au stock', 'number', '', '+10', false)}
                        ${UI.input('bulk_set_min', 'Nouveau stock min', 'number', '', 'Ex: 5', false)}
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Appliquer', onclick: `ManagerModule.executeBulkUpdate([${selected.join(',')}])`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700' }
            ]);
        },

        executeBulkUpdate(productIds) {
            const addStock = parseInt(UI.val('bulk_add_stock'), 10) || 0;
            const newMin = UI.val('bulk_set_min').trim() ? parseInt(UI.val('bulk_set_min'), 10) : null;
            
            let updated = 0;
            productIds.forEach(id => {
                const product = CORE.db.products.find(p => p.id === id);
                if (product) {
                    if (addStock !== 0) {
                        product.stock = Math.max(0, (product.stock || 0) + addStock);
                    }
                    if (newMin !== null) {
                        product.minStock = newMin;
                    }
                    updated++;
                }
            });
            
            CORE.save();
            UI.closeModal();
            UI.toast(`${updated} produit(s) mis �� jour`, 'success');
            App.rerender();
        },

        printMainStockReport() {
            const products = CORE.db.products.filter(p => p.isMainWarehouse && p.active);
            const totalValue = products.reduce((s, p) => s + (p.stock || 0) * (p.price || 0), 0);
            
            const printContent = `
                <html>
                <head>
                    <title>Rapport Stock D�p��t Principal</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #1e293b; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; }
                        th { background: #f1f5f9; font-weight: bold; }
                        .low { background: #fef3c7; }
                        .critical { background: #fee2e2; }
                        .total { font-weight: bold; background: #f1f5f9; }
                    </style>
                </head>
                <body>
                    <h1>��Ÿ � � Rapport Stock - D�p��t Principal</h1>
                    <p>Date: ${new Date().toLocaleDateString('fr-FR')} | ${products.length} produits | Valeur totale: ${CORE.formatPrice(totalValue)}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Produit</th>
                                <th>Code</th>
                                <th>Stock</th>
                                <th>Min</th>
                                <th>Prix</th>
                                <th>Valeur</th>
                                <th>�tat</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${products.map(p => {
                                const isLow = (p.stock || 0) <= (p.minStock || 0);
                                const isCritical = (p.stock || 0) <= (p.minStock || 0) * 0.5;
                                return `
                                    <tr class="${isCritical ? 'critical' : isLow ? 'low' : ''}">
                                        <td>${p.name}</td>
                                        <td>${p.barcode || '-'}</td>
                                        <td>${p.stock || 0}</td>
                                        <td>${p.minStock || 0}</td>
                                        <td>${CORE.formatPrice(p.price || 0)}</td>
                                        <td>${CORE.formatPrice((p.stock || 0) * (p.price || 0))}</td>
                                        <td>${isCritical ? '��Ÿ� � Critique' : isLow ? '��š ��� � � Bas' : '���?� OK'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        },

        renderPOS() {
            const grouped = CORE.db.pointsOfSale.map(p => ({
                ...p,
                city: CORE.getCity(p.cityId)?.name,
                orders: CORE.db.orders.filter(o => o.posId === p.id).length
            }));
            return `
                <div class="fade-in max-w-6xl mx-auto space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">Points de vente</h2>
                            <p class="text-slate-500 font-medium">Visibilit� par site.</p>
                        </div>
                        <button onclick="ManagerModule.showAddPOSModal()" class="px-6 py-3 bg-sky-600 text-white font-black rounded-xl hover:bg-sky-700 transition flex items-center gap-2">
                            <i data-lucide="plus" class="w-5 h-5"></i> Nouveau POS
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${grouped.map(p => `
                            <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-6 card-hover relative">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">${p.city}</div>
                                        <div class="text-xl font-black text-slate-900 mt-1">${p.name}</div>
                                        <div class="mt-2 text-sm text-slate-500 font-medium">Employ�s: <span class="font-black">${p.employees}</span> �� ?� � Commandes: <span class="font-black">${p.orders}</span></div>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <div class="w-12 h-12 bg-sky-50 text-sky-600 rounded-2xl flex items-center justify-center"><i data-lucide="store" class="w-6 h-6"></i></div>
                                        <button onclick="ManagerModule.state.inventoryPosId='${p.id}'; ManagerModule.state.inventoryTab='products'; ManagerModule.navigateTo('inventory'); UI.closeModal();" class="p-2.5 rounded-xl hover:bg-emerald-50 transition text-emerald-600 hover:text-emerald-700" title="Stock de ce POS">
                                            <i data-lucide="package" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="ManagerModule.showEditPOSModal(${p.id})" class="p-2.5 rounded-xl hover:bg-slate-100 transition text-slate-600 hover:text-slate-900" title="�diter">
                                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="ManagerModule.deletePOS(${p.id})" class="p-2.5 rounded-xl hover:bg-red-50 transition text-red-600 hover:bg-red-100" title="Supprimer">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        },

        showAddPOSModal() {
            const cities = CORE.db.cities.map(c => ({value: c.id, label: c.name}));
            // add an explicit option to create a new city inline
            cities.push({ value: 'new', label: '��ž� Ajouter une nouvelle ville...' });
            UI.modal('Nouveau Point de Vente', `
                <div class="space-y-4">
                    ${UI.input('pos_name', 'Nom du POS', 'text', '', 'ex: Brazzaville Centre', true)}
                    
                    <!-- S�lection ville avec option manuelle -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Ville <span class="text-red-500">*</span></label>
                        <div class="flex gap-2">
                            <select id="pos_city" class="flex-1 px-4 py-3 rounded-xl border border-slate-200 font-medium focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="">-- S�lectionner une ville --</option>
                                ${cities.map(c => `<option value="${c.value}">${c.label}</option>`).join('')}
                            </select>
                            <button type="button" onclick="ManagerModule.toggleNewCityInput()" class="px-4 py-3 bg-emerald-100 text-emerald-700 font-bold rounded-xl hover:bg-emerald-200 transition" title="Saisir manuellement">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Champ de saisie manuelle ville -->
                    <div id="pos_city_new_wrap" class="hidden">
                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-sm font-bold text-emerald-700">��Ÿ�� Nouvelle ville</label>
                                <button type="button" onclick="ManagerModule.cancelNewCity()" class="text-xs text-red-600 hover:underline">Annuler</button>
                            </div>
                            <input type="text" id="pos_city_new" placeholder="Saisir le nom de la nouvelle ville..." class="w-full px-4 py-3 rounded-xl border border-emerald-300 font-medium focus:ring-2 focus:ring-emerald-500 outline-none bg-white">
                            <div class="text-xs text-emerald-600 mt-2">��Ÿ? � Cette ville sera ajout�e automatiquement �� la liste</div>
                        </div>
                    </div>
                    
                    ${UI.input('pos_employees', 'Nombre d\'employ�s', 'number', '1', 'ex: 5', true)}
                    ${UI.input('pos_phone', 'T�l�phone', 'tel', '', '+242 ...', false)}
                    ${UI.textarea('pos_address', 'Adresse', '', 'ex: 123 Rue Principale', 2)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Cr�er', onclick: 'ManagerModule.savePOS()', class: 'px-5 py-2.5 bg-sky-600 text-white font-black rounded-xl hover:bg-sky-700 transition' }
            ]);

            // bind change handler to toggle new-city input
            setTimeout(() => {
                const sel = document.getElementById('pos_city');
                if (!sel) return;
                sel.addEventListener('change', e => ManagerModule._onPOSCityChange(e.target.value));
                ManagerModule._onPOSCityChange(sel.value);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }, 60);
        },

        toggleNewCityInput() {
            const wrap = document.getElementById('pos_city_new_wrap');
            const select = document.getElementById('pos_city');
            const input = document.getElementById('pos_city_new');
            
            if (wrap.classList.contains('hidden')) {
                wrap.classList.remove('hidden');
                select.value = 'new';
                select.disabled = true;
                if (input) input.focus();
            } else {
                wrap.classList.add('hidden');
                select.disabled = false;
                select.value = '';
                if (input) input.value = '';
            }
        },

        cancelNewCity() {
            const wrap = document.getElementById('pos_city_new_wrap');
            const select = document.getElementById('pos_city');
            const input = document.getElementById('pos_city_new');
            
            wrap.classList.add('hidden');
            select.disabled = false;
            select.value = '';
            if (input) input.value = '';
        },

        showEditPOSModal(posId) {
            const pos = CORE.getPOS(posId);
            if (!pos) return UI.toast('POS non trouv�', 'error');
            const cities = CORE.db.cities.map(c => ({value: c.id, label: c.name}));
            cities.push({ value: 'new', label: '��ž� Ajouter une nouvelle ville...' });
            UI.modal(`Modifier: ${pos.name}`, `
                <div class="space-y-4">
                    ${UI.input('pos_name', 'Nom du POS', 'text', pos.name, '', true)}
                    
                    <!-- S�lection ville avec option manuelle -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Ville <span class="text-red-500">*</span></label>
                        <div class="flex gap-2">
                            <select id="pos_city" class="flex-1 px-4 py-3 rounded-xl border border-slate-200 font-medium focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="">-- S�lectionner une ville --</option>
                                ${cities.map(c => `<option value="${c.value}" ${c.value == pos.cityId ? 'selected' : ''}>${c.label}</option>`).join('')}
                            </select>
                            <button type="button" onclick="ManagerModule.toggleNewCityInput()" class="px-4 py-3 bg-emerald-100 text-emerald-700 font-bold rounded-xl hover:bg-emerald-200 transition" title="Saisir manuellement">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Champ de saisie manuelle ville -->
                    <div id="pos_city_new_wrap" class="hidden">
                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-sm font-bold text-emerald-700">��Ÿ�� Nouvelle ville</label>
                                <button type="button" onclick="ManagerModule.cancelNewCity()" class="text-xs text-red-600 hover:underline">Annuler</button>
                            </div>
                            <input type="text" id="pos_city_new" placeholder="Saisir le nom de la nouvelle ville..." class="w-full px-4 py-3 rounded-xl border border-emerald-300 font-medium focus:ring-2 focus:ring-emerald-500 outline-none bg-white">
                            <div class="text-xs text-emerald-600 mt-2">��Ÿ? � Cette ville sera ajout�e automatiquement �� la liste</div>
                        </div>
                    </div>
                    
                    ${UI.input('pos_employees', 'Nombre d\'employ�s', 'number', pos.employees || '1', '', true)}
                    ${UI.input('pos_phone', 'T�l�phone', 'tel', pos.phone || '', '', false)}
                    ${UI.textarea('pos_address', 'Adresse', pos.address || '', '', 2)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: `ManagerModule.updatePOS(${posId})`, class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);

            setTimeout(() => {
                const sel = document.getElementById('pos_city');
                if (!sel) return;
                sel.addEventListener('change', e => ManagerModule._onPOSCityChange(e.target.value));
                ManagerModule._onPOSCityChange(sel.value);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }, 60);
        },

        _onPOSCityChange(rawVal) {
            const wrap = document.getElementById('pos_city_new_wrap');
            const input = document.getElementById('pos_city_new');
            if (!wrap || !input) return;
            if (String(rawVal) === 'new') {
                wrap.classList.remove('hidden');
                input.required = true;
            } else {
                wrap.classList.add('hidden');
                input.required = false;
            }
        },

        savePOS() {
            const name = UI.val('pos_name').trim();
            const rawCityVal = UI.val('pos_city');
            let cityId = null;
            const employees = parseInt(UI.val('pos_employees'), 10) || 1;
            const phone = UI.val('pos_phone').trim() || null;
            const address = UI.val('pos_address').trim() || null;

            if (!name) return UI.toast('Le nom du POS est requis', 'warning');

            // handle inline new-city creation
            if (String(rawCityVal) === 'new') {
                const newCityName = UI.val('pos_city_new').trim();
                if (!newCityName) return UI.toast('Veuillez saisir le nom de la nouvelle ville', 'warning');
                CORE.db.cities = CORE.db.cities || [];
                const newCity = { id: Date.now(), name: newCityName };
                CORE.db.cities.push(newCity);
                CORE.save();
                cityId = newCity.id;
            } else {
                cityId = parseInt(rawCityVal, 10);
            }

            if (!cityId) return UI.toast('Veuillez s�lectionner une ville', 'warning');

            // Cr�er une demande d'approbation au lieu de cr�er directement
            CORE.db.posCreationRequests = CORE.db.posCreationRequests || [];
            const request = {
                id: Date.now(),
                type: 'creation',
                posData: {
                    name,
                    cityId,
                    employees,
                    phone,
                    address
                },
                requestedBy: CORE.state.currentUser?.name || 'Utilisateur',
                requestedById: CORE.state.currentUser?.id,
                createdAt: new Date().toISOString(),
                status: 'pending',
                approvedBy: null,
                approvalDate: null,
                rejectionReason: null
            };
            CORE.db.posCreationRequests.push(request);
            CORE.save();
            UI.closeModal();
            UI.toast('Demande de cr�ation de POS envoy�e au PDG pour approbation', 'info');
            CORE.notify('info', `Demande de cr�ation POS: ${name}`, { requestId: request.id });
            App.rerender();
        },

        updatePOS(posId) {
            const name = UI.val('pos_name').trim();
            const rawCityVal = UI.val('pos_city');
            let cityId = null;
            const employees = parseInt(UI.val('pos_employees'), 10) || 1;
            const phone = UI.val('pos_phone').trim() || null;
            const address = UI.val('pos_address').trim() || null;

            if (!name) return UI.toast('Le nom du POS est requis', 'warning');

            // handle inline new-city creation during update
            if (String(rawCityVal) === 'new') {
                const newCityName = UI.val('pos_city_new').trim();
                if (!newCityName) return UI.toast('Veuillez saisir le nom de la nouvelle ville', 'warning');
                CORE.db.cities = CORE.db.cities || [];
                const newCity = { id: Date.now(), name: newCityName };
                CORE.db.cities.push(newCity);
                CORE.save();
                cityId = newCity.id;
            } else {
                cityId = parseInt(rawCityVal, 10);
            }

            if (!cityId) return UI.toast('Veuillez s�lectionner une ville', 'warning');

            CORE.update('pointsOfSale', posId, {
                name,
                cityId,
                employees,
                phone,
                address
            });

            UI.closeModal();
            UI.toast('Point de vente mis �� jour', 'success');
            App.rerender();
        },

        deletePOS(posId) {
            const pos = CORE.getPOS(posId);
            if (!pos) return UI.toast('POS non trouv�', 'error');

            // V�rifier si des commandes sont li�es �� ce POS
            const linkedOrders = CORE.db.orders.filter(o => o.posId === posId);
            if (linkedOrders.length > 0) {
                return UI.toast(`Impossible de supprimer: ${linkedOrders.length} commande(s) associ�e(s)`, 'warning');
            }

            const linkedUsers = CORE.db.users.filter(u => u.pos === posId);
            if (linkedUsers.length > 0) {
                return UI.toast(`Impossible de supprimer: ${linkedUsers.length} utilisateur(s) assign�(s)`, 'warning');
            }

            UI.confirm({
                title: 'Demander la suppression du POS',
                message: `Vous ��tes sur le point de demander la suppression de "${pos.name}". Le PDG doit approuver cette demande.`,
                confirmLabel: 'Demander suppression',
                confirmClass: 'bg-amber-600 hover:bg-amber-700 text-white',
                onConfirm: function() {
                    // Cr�er une demande de suppression de POS
                    CORE.db.posCreationRequests = CORE.db.posCreationRequests || [];
                    const request = {
                        id: Date.now(),
                        type: 'deletion',
                        posId: posId,
                        posName: pos.name,
                        requestedBy: CORE.state.currentUser?.name || 'Utilisateur',
                        requestedById: CORE.state.currentUser?.id,
                        createdAt: new Date().toISOString(),
                        status: 'pending',
                        approvedBy: null,
                        approvalDate: null,
                        rejectionReason: null
                    };
                    CORE.db.posCreationRequests.push(request);
                    CORE.save();
                    UI.closeModal();
                    UI.toast(`Demande de suppression envoy�e au PDG pour approbation`, 'info');
                    CORE.notify('info', `Demande de suppression POS: ${pos.name}`, { posId });
                    App.rerender();
                }
            });
        },

        // =====================
        // FINANCES (Manager)
        // =====================
        getFinanceScope() {
            // Manager scope: by default, current user's city/POS (if defined)
            const defaultCityId = CORE.state.currentUser?.city || '';
            const defaultPosId = CORE.state.currentUser?.pos || '';
            const cityId = this.state.financeCityId !== '' ? parseInt(this.state.financeCityId, 10) : defaultCityId;
            const posId = this.state.financePosId !== '' ? parseInt(this.state.financePosId, 10) : defaultPosId;
            return { cityId: cityId || null, posId: posId || null };
        },

        getFinanceDateRange() {
            const from = (this.state.financeFrom || '').trim();
            const to = (this.state.financeTo || '').trim();
            const fromDate = from ? new Date(from + 'T00:00:00') : null;
            const toDate = to ? new Date(to + 'T23:59:59') : null;
            return { fromDate, toDate };
        },

        getTransactionsFiltered() {
            const q = (document.getElementById('manager-finance-search-input')?.value || '').toLowerCase().trim();
            const type = this.state.financeType;
            const category = this.state.financeCategory;
            const method = this.state.financeMethod;
            const { cityId, posId } = this.getFinanceScope();
            const { fromDate, toDate } = this.getFinanceDateRange();

            let txs = [...(CORE.db.financialTransactions || [])];

            // Scope
            if (cityId) txs = txs.filter(t => String(t.cityId || '') === String(cityId));
            if (posId) txs = txs.filter(t => String(t.posId || '') === String(posId));

            // Date
            if (fromDate) txs = txs.filter(t => new Date(t.createdAt) >= fromDate);
            if (toDate) txs = txs.filter(t => new Date(t.createdAt) <= toDate);

            // Filters
            if (type !== 'all') txs = txs.filter(t => t.type === type);
            if (category !== 'all') txs = txs.filter(t => t.category === category);
            if (method !== 'all') txs = txs.filter(t => t.method === method);

            if (q) {
                txs = txs.filter(t =>
                    (t.ref || '').toLowerCase().includes(q) ||
                    (t.note || '').toLowerCase().includes(q) ||
                    (t.userName || '').toLowerCase().includes(q) ||
                    String(t.amount || '').includes(q)
                );
            }

            return txs.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
        },

        getCODOutstanding() {
            // COD not yet paid in scope
            const { cityId, posId } = this.getFinanceScope();
            let orders = CORE.db.orders.filter(o => o.paymentMethod === 'cod' && o.paymentStatus !== 'paid');
            if (cityId) orders = orders.filter(o => String(o.cityId || '') === String(cityId));
            if (posId) orders = orders.filter(o => String(o.posId || '') === String(posId));
            const amount = orders.reduce((a,o)=>a + Number(o.total||0), 0);
            return { count: orders.length, amount, orders };
        },

        getCommissionsDue() {
            const { cityId, posId } = this.getFinanceScope();
            let txs = (CORE.db.financialTransactions || []).filter(t => t.category === 'commission');
            if (cityId) txs = txs.filter(t => String(t.cityId || '') === String(cityId));
            if (posId) txs = txs.filter(t => String(t.posId || '') === String(posId));
            const due = txs.filter(t => !t.settled);
            const amount = due.reduce((a,t)=>a + Number(t.amount||0), 0);
            return { dueCount: due.length, dueAmount: amount, due };
        },

        getFinanceSummary() {
            const txs = this.getTransactionsFiltered();
            const income = txs.filter(t => t.type === 'income').reduce((a,t)=>a+Number(t.amount||0),0);
            const expense = txs.filter(t => t.type === 'expense').reduce((a,t)=>a+Number(t.amount||0),0);
            const net = income - expense;

            const byMethod = (m) => txs.filter(t => t.type === 'income' && t.category === 'sale' && t.method === m).reduce((a,t)=>a+Number(t.amount||0),0);
            const cash = byMethod('cash');
            const mobile = byMethod('mobile');
            const cod = byMethod('cod');

            const codOutstanding = this.getCODOutstanding();
            const commissions = this.getCommissionsDue();
            return { income, expense, net, cash, mobile, cod, codOutstanding, commissions };
        },

        exportFinanceCSV() {
            const txs = this.getTransactionsFiltered();
            const rows = [
                ['id','type','category','amount','method','ref','note','orderId','deliveryId','posId','cityId','settled','createdAt','userName'],
                ...txs.map(t => [
                    t.id,
                    t.type,
                    t.category,
                    t.amount,
                    t.method || '',
                    t.ref || '',
                    t.note || '',
                    t.orderId || '',
                    t.deliveryId || '',
                    t.posId || '',
                    t.cityId || '',
                    t.settled ? '1' : '0',
                    t.createdAt,
                    t.userName || ''
                ])
            ];
            (PDGModule?.downloadCSV || this.downloadCSVFallback)(`raya_finance_manager_${Utils.todayKey()}.csv`, rows);
        },

        showNewExpenseModal() {
            const expenseCategories = [
                { value: 'stock', label: '��Ÿ? � Achat de stock/produits' },
                { value: 'transport', label: '��Ÿšš Frais de transport' },
                { value: 'salaire', label: '��Ÿ? � Salaires' },
                { value: 'loyer', label: '��Ÿ � � Loyer/Local' },
                { value: 'electricite', label: '��š � �lectricit�/Eau' },
                { value: 'telephone', label: '��Ÿ? � T�l�phone/Internet' },
                { value: 'maintenance', label: '��Ÿ� � Maintenance/R�paration' },
                { value: 'hygieneEntretien', label: '��Ÿ � � Hygi��ne/Entretien' },
                { value: 'publicite', label: '��Ÿ? � Publicit�/Marketing' },
                { value: 'assurance', label: '��Ÿ� ��� � � Assurance' },
                { value: 'taxe', label: '��Ÿ? � Taxes/Imp��ts' },
                { value: 'banque', label: '��Ÿ � � Frais bancaires' },
                { value: 'deplacement', label: '��Ÿš? D�placement/Carburant' },
                { value: 'formation', label: '��Ÿ?š Formation/Cours' },
                { value: 'equipement', label: '��Ÿ� ��� � � �quipement/Mat�riel' },
                { value: 'autre', label: '��Ÿ?� Autre' }
            ];
            
            UI.modal('Nouvelle d�pense', `
                <div class="space-y-4">
                    ${UI.input('fx_amount','Montant','number','0','ex: 25000',true)}
                    ${UI.select('fx_category', 'Motif / Cat�gorie', expenseCategories, 'stock', true)}
                    ${UI.select('fx_method','M�thode',[
                        {value:'cash',label:'Cash'},
                        {value:'mobile',label:'Mobile Money'},
                        {value:'internal',label:'Interne'}
                    ], 'cash', true)}
                    ${UI.input('fx_ref','R�f�rence','text','', 'ex: FACT-2026-001', false)}
                    ${UI.textarea('fx_note','D�tails additionnels','', 'ex: pr�cisions suppl�mentaires...', 3)}
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">Conseil: utilisez une r�f�rence pour retrouver facilement la d�pense.</div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'ManagerModule.saveNewExpense()', class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        saveNewExpense() {
            const amount = Number(UI.val('fx_amount') || 0);
            const category = UI.val('fx_category') || 'autre';
            const method = UI.val('fx_method') || 'cash';
            const ref = UI.val('fx_ref').trim() || null;
            const note = UI.val('fx_note').trim();
            
            const categoryLabels = {
                'stock': 'Achat de stock/produits',
                'transport': 'Frais de transport',
                'salaire': 'Salaires',
                'loyer': 'Loyer/Local',
                'electricite': '�lectricit�/Eau',
                'telephone': 'T�l�phone/Internet',
                'maintenance': 'Maintenance/R�paration',
                'hygieneEntretien': 'Hygi��ne/Entretien',
                'publicite': 'Publicit�/Marketing',
                'assurance': 'Assurance',
                'taxe': 'Taxes/Imp��ts',
                'banque': 'Frais bancaires',
                'deplacement': 'D�placement/Carburant',
                'formation': 'Formation/Cours',
                'equipement': '�quipement/Mat�riel',
                'autre': 'Autre'
            };
            
            const categoryLabel = categoryLabels[category] || category;
            const fullNote = `[${categoryLabel}]${note ? ' ' + note : ''}`;
            
            if (!amount || amount <= 0) return UI.toast('Montant invalide', 'warning');
            if (!category) return UI.toast('Veuillez s�lectionner une cat�gorie', 'warning');

            const { cityId, posId } = this.getFinanceScope();
            CORE.recordFinancialTransaction({
                type: 'expense',
                category: 'expense',
                amount,
                method,
                ref,
                note: fullNote,
                cityId,
                posId,
                settled: true
            });
            UI.closeModal();
            UI.toast('D�pense enregistr�e', 'success');
            App.rerender();
        },

        showNewIncomeModal() {
            const incomeCategories = [
                { id: 'vente_directe', icon: '��Ÿ�?', label: 'Vente directe', desc: 'Vente comptoir/magasin' },
                { id: 'vente_en_gros', icon: '��Ÿ? �', label: 'Vente en gros', desc: 'Vente B2B/grossiste' },
                { id: 'service', icon: '��Ÿ� �', label: 'Prestation de service', desc: 'Services rendus' },
                { id: 'livraison', icon: '��Ÿšš', label: 'Frais de livraison', desc: 'Revenus livraisons' },
                { id: 'commission', icon: '��Ÿ?Ž', label: 'Commission re��ue', desc: 'Commissions gagn�es' },
                { id: 'remboursement', icon: '��� ��� � �', label: 'Remboursement re��u', desc: 'Retour fournisseur' },
                { id: 'location', icon: '��Ÿ � �', label: 'Location/Sous-location', desc: 'Revenus locatifs' },
                { id: 'partenariat', icon: '��Ÿ � �', label: 'Partenariat', desc: 'Revenus partenaires' },
                { id: 'interet', icon: '��Ÿ?�?', label: 'Int�r��ts/Dividendes', desc: 'Revenus financiers' },
                { id: 'autre', icon: '��Ÿ?�', label: 'Autre revenu', desc: 'Autres entr�es' }
            ];

            const categoryGrid = incomeCategories.map(cat => `
                <div onclick="document.querySelectorAll('.income-cat-card').forEach(c=>c.classList.remove('ring-2','ring-emerald-500','bg-emerald-50'));this.classList.add('ring-2','ring-emerald-500','bg-emerald-50');document.getElementById('mgr_income_category').value='${cat.id}'"
                     class="income-cat-card cursor-pointer p-3 border border-slate-200 rounded-xl hover:border-emerald-300 hover:bg-emerald-50/50 transition-all group">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">${cat.icon}</span>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-slate-800 text-sm group-hover:text-emerald-700">${cat.label}</div>
                            <div class="text-xs text-slate-500">${cat.desc}</div>
                        </div>
                    </div>
                </div>
            `).join('');

            UI.modal(`
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    </div>
                    <span class="text-xl font-black text-slate-900">Nouveau Revenu</span>
                </div>
            `, `
                <div class="space-y-5">
                    <input type="hidden" id="mgr_income_category" value="">
                    
                    <!-- Cat�gories -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-3">Cat�gorie de revenu</label>
                        <div class="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto pr-1">${categoryGrid}</div>
                    </div>

                    <!-- Montant -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Montant *</label>
                            <div class="relative">
                                <input type="number" id="mgr_income_amount" placeholder="0" min="0" step="100"
                                       class="w-full px-4 py-3 pl-12 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 font-bold text-lg">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">F</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">M�thode de paiement</label>
                            <select id="mgr_income_method" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 font-medium">
                                <option value="cash">��Ÿ? � Esp��ces</option>
                                <option value="mobile">��Ÿ? � Mobile Money</option>
                                <option value="bank">��Ÿ � � Virement bancaire</option>
                                <option value="cheque">��Ÿ? � Ch��que</option>
                                <option value="card">��Ÿ? � Carte bancaire</option>
                            </select>
                        </div>
                    </div>

                    <!-- R�f�rence et Note -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">R�f�rence</label>
                            <input type="text" id="mgr_income_ref" placeholder="ex: FACT-001"
                                   class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Note</label>
                            <input type="text" id="mgr_income_note" placeholder="Description optionnelle"
                                   class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                    </div>

                    <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-xl text-xs text-emerald-700 flex items-start gap-2">
                        <i data-lucide="info" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                        <span>S�lectionnez une cat�gorie et entrez le montant du revenu. La r�f�rence facilite le suivi.</span>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer le revenu', onclick: 'ManagerModule.saveNewIncome()', class: 'px-5 py-2.5 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-black rounded-xl hover:from-emerald-600 hover:to-emerald-700 transition shadow-lg' }
            ]);
            setTimeout(() => lucide.createIcons(), 100);
        },

        saveNewIncome() {
            const category = document.getElementById('mgr_income_category')?.value;
            const amount = Number(document.getElementById('mgr_income_amount')?.value || 0);
            const method = document.getElementById('mgr_income_method')?.value || 'cash';
            const ref = document.getElementById('mgr_income_ref')?.value?.trim() || null;
            const note = document.getElementById('mgr_income_note')?.value?.trim() || '';

            if (!category) return UI.toast('Veuillez s�lectionner une cat�gorie', 'warning');
            if (!amount || amount <= 0) return UI.toast('Montant invalide', 'warning');

            const categoryLabels = {
                'vente_directe': 'Vente directe',
                'vente_en_gros': 'Vente en gros',
                'service': 'Prestation de service',
                'livraison': 'Frais de livraison',
                'commission': 'Commission re��ue',
                'remboursement': 'Remboursement re��u',
                'location': 'Location/Sous-location',
                'partenariat': 'Partenariat',
                'interet': 'Int�r��ts/Dividendes',
                'autre': 'Autre revenu'
            };

            const categoryLabel = categoryLabels[category] || category;
            const fullNote = `[${categoryLabel}]${note ? ' ' + note : ''}`;

            const { cityId, posId } = this.getFinanceScope();
            CORE.recordFinancialTransaction({
                type: 'income',
                category: category,
                amount,
                method,
                ref,
                note: fullNote,
                cityId,
                posId,
                settled: true
            });

            UI.closeModal();
            UI.toast(`Revenu de ${CORE.formatPrice(amount)} enregistr� (${categoryLabel})`, 'success');
            App.rerender();
        },

        markCODCollected(orderId) {
            const o = CORE.db.orders.find(x => x.id === orderId);
            if (!o) return;
            if (o.paymentMethod !== 'cod') return UI.toast('Ce n�� ?� ?�est pas une commande COD', 'warning');

            const updated = CORE.update('orders', o.id, { paymentStatus: 'paid' });
            CORE.ensureSaleTransaction(updated);
            UI.toast('COD marqu� comme encaiss�', 'success');
            App.rerender();
        },

        markTransactionSettled(txId) {
            const tx = (CORE.db.financialTransactions || []).find(t => t.id === txId);
            if (!tx) return;
            if (tx.settled) return UI.toast('D�j�� r�gl�', 'info');
            CORE.update('financialTransactions', tx.id, { settled: true, settledAt: new Date().toISOString() });
            UI.toast('Transaction r�gl�e', 'success');
            App.rerender();
        },

        renderFinance() {
            const tab = this.state.financeTab;
            const summary = this.getFinanceSummary();
            const txs = this.getTransactionsFiltered();
            const cod = this.getCODOutstanding();
            const commissions = this.getCommissionsDue();

            const scope = this.getFinanceScope();
            const cityOptions = [{value:'',label:'Toutes villes'}, ...CORE.db.cities.map(c=>({value:c.id,label:c.name}))];
            const posOptions = [{value:'',label:'Tous POS'}, ...CORE.db.pointsOfSale.map(p=>({value:p.id,label:p.name}))];

            const categories = [
                { value:'all', label:'Toutes cat�gories' },
                { value:'sale', label:'Ventes' },
                { value:'expense', label:'D�penses' },
                { value:'commission', label:'Commissions' }
            ];

            const methods = [
                { value:'all', label:'Toutes m�thodes' },
                { value:'cash', label:'Cash' },
                { value:'mobile', label:'Mobile Money' },
                { value:'cod', label:'Paiement �� la livraison' },
                { value:'internal', label:'Interne' }
            ];

            // Top d�penses par cat�gorie
            const expenseByCategory = {};
            txs.filter(t => t.type === 'expense').forEach(t => {
                const cat = t.category || 'autre';
                expenseByCategory[cat] = (expenseByCategory[cat] || 0) + (t.amount || 0);
            });
            const topExpenseCategories = Object.entries(expenseByCategory).sort((a, b) => b[1] - a[1]).slice(0, 5);

            // R�partition par m�thode de paiement
            const paymentMethods = {
                cash: summary.cash || 0,
                mobile: summary.mobile || 0,
                cod: summary.cod || 0,
                card: summary.card || 0
            };
            const totalPayments = Object.values(paymentMethods).reduce((a, b) => a + b, 0) || 1;

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <!-- Header avec gradient et navigation -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                                    <i data-lucide="wallet" class="w-6 h-6"></i>
                                </div>
                                Finance Control Center
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Encaissements, COD, commissions, d�penses et journal</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="ManagerModule.showNewIncomeModal()" class="px-4 py-2.5 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-black rounded-xl hover:from-emerald-600 hover:to-emerald-700 transition shadow-lg shadow-emerald-500/30 flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> Nouveau revenu
                            </button>
                            <button onclick="ManagerModule.showNewExpenseModal()" class="px-4 py-2.5 bg-red-500 text-white font-black rounded-xl hover:bg-red-600 transition flex items-center gap-2">
                                <i data-lucide="minus-circle" class="w-4 h-4"></i> Nouvelle d�pense
                            </button>
                            <button onclick="CORE.rebuildFinancialTransactions(); App.rerender()" class="px-4 py-2.5 bg-amber-500 text-white font-black rounded-xl hover:bg-amber-600 transition flex items-center gap-2" title="R�g�n�rer les transactions">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Actualiser
                            </button>
                            <button onclick="ManagerModule.exportFinanceCSV()" class="px-4 py-2.5 bg-white border border-slate-200 text-slate-700 font-black rounded-xl hover:bg-slate-50 transition flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> Exporter
                            </button>
                        </div>
                    </div>

                    <!-- KPIs Principaux avec gradients -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-5 text-white shadow-lg shadow-emerald-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-up" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Encaissements</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(summary.income)}</div>
                                <div class="text-xs opacity-70 mt-2">Cash ${CORE.formatPrice(summary.cash)} �� ?� � Mobile ${CORE.formatPrice(summary.mobile)}</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl p-5 text-white shadow-lg shadow-red-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-down" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">D�penses</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(summary.expense)}</div>
                                <div class="text-xs opacity-70 mt-2">Inclut commissions & charges</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-5 text-white shadow-lg shadow-blue-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="bar-chart-3" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">B�n�fice Net</span>
                                </div>
                                <div class="text-3xl font-black">${summary.net >= 0 ? '+' : ''}${CORE.formatPrice(summary.net)}</div>
                                <div class="text-xs opacity-70 mt-2">Encaissements ���?? d�penses</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-5 text-white shadow-lg shadow-amber-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="truck" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">COD �� encaisser</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(cod.amount)}</div>
                                <div class="text-xs opacity-70 mt-2">${cod.count} commande(s) en attente</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <div class="flex flex-wrap gap-2">
                                <button onclick="ManagerModule.state.financeTab='overview';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='overview'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Vue</button>
                                <button onclick="ManagerModule.state.financeTab='transactions';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='transactions'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Journal</button>
                                <button onclick="ManagerModule.state.financeTab='cod';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='cod'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">COD</button>
                                <button onclick="ManagerModule.state.financeTab='commissions';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='commissions'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Commissions</button>
                            </div>

                            <div class="flex flex-wrap gap-2">
                                <select onchange="ManagerModule.state.financeCityId=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${cityOptions.map(o => `<option value="${o.value}" ${String(o.value)===String(this.state.financeCityId)?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                                <select onchange="ManagerModule.state.financePosId=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${posOptions.map(o => `<option value="${o.value}" ${String(o.value)===String(this.state.financePosId)?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                                <input type="date" value="${this.state.financeFrom ? this.formatDateForInput(this.state.financeFrom) : ''}" onchange="ManagerModule.state.financeFrom=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                                <input type="date" value="${this.state.financeTo ? this.formatDateForInput(this.state.financeTo) : ''}" onchange="ManagerModule.state.financeTo=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                            </div>
                        </div>

                        ${tab === 'overview' ? `
                            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <!-- Colonne gauche: Commissions + R�partition paiements -->
                                <div class="lg:col-span-2 space-y-6">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="bg-slate-50 border border-slate-200 rounded-3xl p-5">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Commissions �� payer</div>
                                                    <div class="mt-2 text-2xl font-black text-red-600">${CORE.formatPrice(commissions.dueAmount)}</div>
                                                    <div class="text-xs text-slate-500">${commissions.dueCount} course(s)</div>
                                                </div>
                                                <div class="w-12 h-12 bg-red-100 rounded-2xl flex items-center justify-center text-red-600"><i data-lucide="hand-coins" class="w-6 h-6"></i></div>
                                            </div>
                                        </div>
                                        <div class="bg-slate-50 border border-slate-200 rounded-3xl p-5">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Transactions</div>
                                                    <div class="mt-2 text-2xl font-black text-slate-900">${txs.length}</div>
                                                    <div class="text-xs text-slate-500">P�rim��tre: ${scope.cityId ? CORE.getCity(scope.cityId)?.name : 'Global'}</div>
                                                </div>
                                                <div class="w-12 h-12 bg-slate-200 rounded-2xl flex items-center justify-center text-slate-700"><i data-lucide="list" class="w-6 h-6"></i></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- R�partition par m�thode de paiement -->
                                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                        <h3 class="text-lg font-black text-slate-900 flex items-center gap-2 mb-6">
                                            <i data-lucide="credit-card" class="w-5 h-5 text-blue-500"></i>
                                            R�partition par M�thode de Paiement
                                        </h3>
                                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                            <div class="text-center p-4 bg-slate-50 rounded-xl">
                                                <div class="w-12 h-12 bg-slate-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                                    <i data-lucide="banknote" class="w-6 h-6 text-slate-600"></i>
                                                </div>
                                                <div class="text-lg font-black text-slate-900">${CORE.formatPrice(paymentMethods.cash)}</div>
                                                <div class="text-xs text-slate-500 font-bold">Cash</div>
                                                <div class="text-[10px] text-slate-400">${Math.round((paymentMethods.cash / totalPayments) * 100)}%</div>
                                            </div>
                                            <div class="text-center p-4 bg-blue-50 rounded-xl">
                                                <div class="w-12 h-12 bg-blue-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                                    <i data-lucide="smartphone" class="w-6 h-6 text-blue-600"></i>
                                                </div>
                                                <div class="text-lg font-black text-blue-900">${CORE.formatPrice(paymentMethods.mobile)}</div>
                                                <div class="text-xs text-blue-700 font-bold">Mobile Money</div>
                                                <div class="text-[10px] text-blue-500">${Math.round((paymentMethods.mobile / totalPayments) * 100)}%</div>
                                            </div>
                                            <div class="text-center p-4 bg-amber-50 rounded-xl">
                                                <div class="w-12 h-12 bg-amber-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                                    <i data-lucide="truck" class="w-6 h-6 text-amber-600"></i>
                                                </div>
                                                <div class="text-lg font-black text-amber-900">${CORE.formatPrice(paymentMethods.cod)}</div>
                                                <div class="text-xs text-amber-700 font-bold">COD</div>
                                                <div class="text-[10px] text-amber-500">${Math.round((paymentMethods.cod / totalPayments) * 100)}%</div>
                                            </div>
                                            <div class="text-center p-4 bg-indigo-50 rounded-xl">
                                                <div class="w-12 h-12 bg-indigo-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                                    <i data-lucide="credit-card" class="w-6 h-6 text-indigo-600"></i>
                                                </div>
                                                <div class="text-lg font-black text-indigo-900">${CORE.formatPrice(paymentMethods.card || 0)}</div>
                                                <div class="text-xs text-indigo-700 font-bold">Carte</div>
                                                <div class="text-[10px] text-indigo-500">${Math.round(((paymentMethods.card || 0) / totalPayments) * 100)}%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Colonne droite: Actions rapides + Top d�penses -->
                                <div class="space-y-6">
                                    <!-- Actions rapides -->
                                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 text-white">
                                        <h3 class="text-lg font-black mb-4 flex items-center gap-2">
                                            <i data-lucide="zap" class="w-5 h-5 text-amber-400"></i>
                                            Actions Rapides
                                        </h3>
                                        <div class="space-y-3">
                                            <button onclick="ManagerModule.showNewExpenseModal()" class="w-full px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                                <i data-lucide="minus-circle" class="w-5 h-5"></i>
                                                Enregistrer une d�pense
                                            </button>
                                            <button onclick="ManagerModule.state.financeTab='cod';App.rerender()" class="w-full px-4 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                                <i data-lucide="truck" class="w-5 h-5"></i>
                                                G�rer COD en attente
                                            </button>
                                            <button onclick="ManagerModule.state.financeTab='commissions';App.rerender()" class="w-full px-4 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                                <i data-lucide="hand-coins" class="w-5 h-5"></i>
                                                Payer commissions
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Top d�penses par cat�gorie -->
                                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                        <h3 class="text-lg font-black text-slate-900 flex items-center gap-2 mb-4">
                                            <i data-lucide="pie-chart" class="w-5 h-5 text-red-500"></i>
                                            Top D�penses
                                        </h3>
                                        ${topExpenseCategories.length === 0 ? '<div class="text-center py-4 text-slate-400 text-sm">Aucune d�pense enregistr�e</div>' : 
                                            '<div class="space-y-3">' + topExpenseCategories.map(([cat, amount], i) => {
                                                const colors = ['bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-yellow-500', 'bg-lime-500'];
                                                const maxAmount = topExpenseCategories[0][1] || 1;
                                                return '<div class="flex items-center gap-3"><div class="w-8 h-8 ' + colors[i] + ' rounded-lg flex items-center justify-center text-white text-xs font-black">' + (i + 1) + '</div><div class="flex-1"><div class="flex justify-between mb-1"><span class="text-sm font-bold text-slate-700 capitalize">' + cat + '</span><span class="text-sm font-black text-red-600">' + CORE.formatPrice(amount) + '</span></div><div class="h-2 bg-slate-100 rounded-full overflow-hidden"><div class="' + colors[i] + ' h-full rounded-full" style="width: ' + ((amount / maxAmount) * 100) + '%"></div></div></div></div>';
                                            }).join('') + '</div>'
                                        }
                                        <button onclick="ManagerModule.state.financeTab='transactions';ManagerModule.state.financeType='expense';App.rerender()" class="w-full mt-4 px-4 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-200 transition">
                                            Voir toutes les d�penses ���?
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${tab === 'transactions' ? `
                            <div class="p-4 border-t border-slate-100 flex flex-wrap gap-2 items-center">
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input id="manager-finance-search-input" type="text" value="${this.state.financeSearch}" onkeyup="ManagerModule.updateFinanceSearch(this.value)" placeholder="Recherche (ref, note, montant...)" class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium w-[280px] max-w-full" style="direction: ltr; text-align: left;" autocomplete="off">
                                </div>
                                <select onchange="ManagerModule.state.financeType=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${[
                                        {value:'all',label:'Tous types'},
                                        {value:'income',label:'Encaissements'},
                                        {value:'expense',label:'D�penses'}
                                    ].map(o=>`<option value="${o.value}" ${o.value===this.state.financeType?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                                <select onchange="ManagerModule.state.financeCategory=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${categories.map(o=>`<option value="${o.value}" ${o.value===this.state.financeCategory?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                                <select onchange="ManagerModule.state.financeMethod=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${methods.map(o=>`<option value="${o.value}" ${o.value===this.state.financeMethod?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                            </div>

                            <div class="overflow-auto">
                                <table class="w-full text-left min-w-[1100px]">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">Type</th>
                                            <th class="px-6 py-4">Cat�gorie</th>
                                            <th class="px-6 py-4 text-right">Montant</th>
                                            <th class="px-6 py-4">M�thode</th>
                                            <th class="px-6 py-4">R�f�rence / Note</th>
                                            <th class="px-6 py-4">Statut</th>
                                            <th class="px-6 py-4 text-right">Date</th>
                                            <th class="px-6 py-4 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${txs.length===0 ? `<tr><td colspan="8" class="px-6 py-12 text-center text-slate-400 font-medium">Aucune transaction</td></tr>` : ''}
                                        ${txs.map(t => {
                                            const amount = CORE.formatPrice(t.amount);
                                            const sign = t.type==='income' ? '+' : '-';
                                            const color = t.type==='income' ? 'text-emerald-600' : 'text-red-600';
                                            const statusBadge = t.settled ? UI.badge('R�gl�','emerald') : UI.badge('�?� r�gler','amber');
                                            return `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-6 py-4 font-black text-slate-900">${t.type}</td>
                                                <td class="px-6 py-4">${UI.badge(t.category, t.category==='sale'?'emerald':t.category==='commission'?'amber':t.category==='expense'?'red':'slate')}</td>
                                                <td class="px-6 py-4 text-right font-black ${color}">${sign} ${amount}</td>
                                                <td class="px-6 py-4 font-bold">${CORE.paymentMethodLabel(t.method)}</td>
                                                <td class="px-6 py-4">
                                                    <div class="font-black text-slate-900">${t.ref || '�� ?��'}</div>
                                                    <div class="text-xs text-slate-500">${t.note || ''}</div>
                                                </td>
                                                <td class="px-6 py-4">${statusBadge}</td>
                                                <td class="px-6 py-4 text-right text-xs text-slate-500">${CORE.formatDate(t.createdAt)}</td>
                                                <td class="px-6 py-4 text-right">
                                                    ${(!t.settled && t.category==='commission') ? `<button onclick="ManagerModule.markTransactionSettled(${t.id})" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-black hover:bg-slate-800">Marquer pay�</button>` : '<span class="text-xs text-slate-400">�� ?��</span>'}
                                                </td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                        ${tab === 'cod' ? `
                            <div class="p-4">
                                <div class="p-4 bg-amber-50 border border-amber-100 rounded-2xl text-sm text-amber-800">
                                    <b>COD �� encaisser:</b> commandes en paiement �� la livraison dont le paiement n�� ?� ?�est pas encore marqu� "Pay�".
                                </div>
                            </div>
                            <div class="overflow-auto">
                                <table class="w-full text-left min-w-[980px]">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">R�f</th>
                                            <th class="px-6 py-4">Client</th>
                                            <th class="px-6 py-4">Statut cmd</th>
                                            <th class="px-6 py-4">Statut paiement</th>
                                            <th class="px-6 py-4 text-right">Montant</th>
                                            <th class="px-6 py-4 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${cod.orders.length===0 ? `<tr><td colspan="6" class="px-6 py-12 text-center text-slate-400 font-medium">Aucun COD en attente</td></tr>` : ''}
                                        ${cod.orders.map(o => `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-6 py-4 font-black text-slate-900">${o.reference}</td>
                                                <td class="px-6 py-4">
                                                    <div class="font-bold">${o.clientName || '�� ?��'}</div>
                                                    <div class="text-xs text-slate-500">${o.clientPhone || ''}</div>
                                                </td>
                                                <td class="px-6 py-4">${UI.badge(o.status, o.status==='delivered'?'emerald':o.status==='delivering'?'amber':'slate')}</td>
                                                <td class="px-6 py-4">${UI.badge(CORE.paymentStatusLabel(o.paymentStatus), o.paymentStatus==='paid'?'emerald':'amber')}</td>
                                                <td class="px-6 py-4 text-right font-black text-amber-700">${CORE.formatPrice(o.total)}</td>
                                                <td class="px-6 py-4 text-right">
                                                    <button onclick="ManagerModule.markCODCollected(${o.id})" class="px-3 py-2 rounded-xl bg-amber-500 text-white text-xs font-black hover:bg-amber-600">Marquer encaiss�</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                        ${tab === 'commissions' ? `
                            <div class="p-4">
                                <div class="p-4 bg-red-50 border border-red-100 rounded-2xl text-sm text-red-800">
                                    <b>Commissions:</b> d�penses de type "commission" (souvent �� r�gler au livreur).
                                </div>
                            </div>
                            <div class="overflow-auto">
                                <table class="w-full text-left min-w-[980px]">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">R�f</th>
                                            <th class="px-6 py-4">Livreur</th>
                                            <th class="px-6 py-4">Statut</th>
                                            <th class="px-6 py-4 text-right">Montant</th>
                                            <th class="px-6 py-4 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${commissions.due.length===0 ? `<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400 font-medium">Aucune commission �� payer</td></tr>` : ''}
                                        ${commissions.due.map(t => {
                                            const del = t.deliveryId ? CORE.db.deliveries.find(d => d.id === t.deliveryId) : null;
                                            const livreur = del?.livreurId ? CORE.getUser(del.livreurId) : null;
                                            return `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-6 py-4 font-black text-slate-900">${t.ref || '�� ?��'}</td>
                                                <td class="px-6 py-4 font-bold">${livreur?.name || '�� ?��'}</td>
                                                <td class="px-6 py-4">${UI.badge('�?� payer','amber')}</td>
                                                <td class="px-6 py-4 text-right font-black text-red-600">${CORE.formatPrice(t.amount)}</td>
                                                <td class="px-6 py-4 text-right"><button onclick="ManagerModule.markTransactionSettled(${t.id})" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-black hover:bg-slate-800">Marquer pay�</button></td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                    </div>
                </div>
            `;
        },

        // =====================
        // TEAM / RH (Manager)
        // =====================
        getTeamFiltered(paginate = true) {
            const q = (this.state.teamSearch || '').toLowerCase().trim();
            const role = this.state.teamRole || 'all';
            const posId = this.state.teamPosId || 'all';
            const sortBy = this.state.teamSortBy || 'name';
            const sortOrder = this.state.teamSortOrder || 'asc';
            
            let users = CORE.db.users.filter(u => ['gestionnaire','vendeur','livreur'].includes(u.role));
            
            // Filtre par r��le
            if (role !== 'all') users = users.filter(u => u.role === role);
            
            // Filtre par POS
            if (posId !== 'all') users = users.filter(u => String(u.pos || u.posId) === String(posId));
            
            // Filtre par recherche
            if (q) users = users.filter(u =>
                (u.name || '').toLowerCase().includes(q) ||
                (u.phone || '').toLowerCase().includes(q) ||
                (u.username || '').toLowerCase().includes(q) ||
                String(u.id).includes(q)
            );
            
            // Tri
            users.sort((a, b) => {
                let cmp = 0;
                if (sortBy === 'name') cmp = (a.name || '').localeCompare(b.name || '');
                else if (sortBy === 'role') cmp = (a.role || '').localeCompare(b.role || '');
                else if (sortBy === 'pos') {
                    const posA = CORE.db.pointsOfSale.find(p => p.id === (a.pos || a.posId))?.name || '';
                    const posB = CORE.db.pointsOfSale.find(p => p.id === (b.pos || b.posId))?.name || '';
                    cmp = posA.localeCompare(posB);
                }
                return sortOrder === 'desc' ? -cmp : cmp;
            });
            
            if (!paginate) return users;
            
            // Pagination
            const page = this.state.teamPage || 1;
            const perPage = this.state.teamPerPage || 20;
            const start = (page - 1) * perPage;
            return users.slice(start, start + perPage);
        },

        getTeamStats() {
            const allUsers = this.getTeamFiltered(false);
            const totalFiltered = allUsers.length;
            const totalUsers = CORE.db.users.filter(u => ['gestionnaire','vendeur','livreur'].includes(u.role)).length;
            const page = this.state.teamPage || 1;
            const perPage = this.state.teamPerPage || 20;
            const totalPages = Math.ceil(totalFiltered / perPage) || 1;
            
            // Stats par POS
            const posList = CORE.db.pointsOfSale || [];
            const usersByPos = {};
            CORE.db.users.filter(u => ['gestionnaire','vendeur','livreur'].includes(u.role)).forEach(u => {
                const pid = u.pos || u.posId || 0;
                usersByPos[pid] = (usersByPos[pid] || 0) + 1;
            });
            
            // Stats par r��le
            const usersByRole = {};
            CORE.db.users.filter(u => ['gestionnaire','vendeur','livreur'].includes(u.role)).forEach(u => {
                usersByRole[u.role] = (usersByRole[u.role] || 0) + 1;
            });
            
            return { totalFiltered, totalUsers, page, perPage, totalPages, usersByPos, usersByRole, posList };
        },

        getTeamGroupedByPos() {
            const users = this.getTeamFiltered(false);
            const posList = CORE.db.pointsOfSale || [];
            const grouped = {};
            
            posList.forEach(pos => {
                grouped[pos.id] = { pos, users: [] };
            });
            grouped[0] = { pos: { id: 0, name: 'Non assign�' }, users: [] };
            
            users.forEach(u => {
                const pid = u.pos || u.posId || 0;
                if (!grouped[pid]) {
                    grouped[pid] = { pos: { id: pid, name: 'POS #' + pid }, users: [] };
                }
                grouped[pid].users.push(u);
            });
            
            return Object.values(grouped).filter(g => g.users.length > 0).sort((a, b) => (a.pos.name || '').localeCompare(b.pos.name || ''));
        },

        updateTeamSearch(value) {
            this.state.teamSearch = value;
            this.state.teamPage = 1;
            if (this.teamSearchTimer) clearTimeout(this.teamSearchTimer);
            this.teamSearchTimer = setTimeout(() => {
                const input = document.getElementById('manager-team-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('manager-team-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 400);
        },

        updateInventorySearch(value) {
            this.state.inventorySearch = value;
            this.state.inventoryPage = 1; // Reset to page 1 on search
            if (this.inventorySearchTimer) clearTimeout(this.inventorySearchTimer);
            this.inventorySearchTimer = setTimeout(() => {
                const input = document.getElementById('manager-inventory-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('manager-inventory-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateMovementsSearch(value) {
            this.state.movementsSearch = value;
            if (this.movementsSearchTimer) clearTimeout(this.movementsSearchTimer);
            this.movementsSearchTimer = setTimeout(() => {
                const input = document.getElementById('manager-movements-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('manager-movements-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateFinanceSearch(value) {
            this.state.financeSearch = value;
            if (this.financeSearchTimer) clearTimeout(this.financeSearchTimer);
            this.financeSearchTimer = setTimeout(() => {
                const input = document.getElementById('manager-finance-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('manager-finance-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateTeamSearch(value) {
            this.state.teamSearch = value;
            if (this.teamSearchTimer) clearTimeout(this.teamSearchTimer);
            this.teamSearchTimer = setTimeout(() => {
                const input = document.getElementById('manager-team-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('manager-team-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        roleLabel(role) {
            const map = { gestionnaire: 'Gestionnaire', vendeur: 'Vendeur', livreur: 'Livreur' };
            return map[role] || role;
        },

        exportTeamList() {
            const allUsers = this.getTeamFiltered(false);
            const posList = CORE.db.pointsOfSale || [];
            
            let csvContent = 'sep=,\n';
            csvContent += 'ID,Nom,Username,Role,Telephone,Point de Vente,Statut,Date Creation\n';
            
            allUsers.forEach(u => {
                const pos = posList.find(p => p.id === (u.pos || u.posId));
                csvContent += `${u.id},"${u.name || ''}","${u.username || ''}","${u.role || ''}","${u.phone || ''}","${pos?.name || 'Non assigne'}","${u.active !== false ? 'Actif' : 'Inactif'}","${u.createdAt || '�� ?��'}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'equipe_manager_' + new Date().getTime() + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('Liste exportee (' + allUsers.length + ' membres)', 'success');
        },

        // ========== DASHBOARD MULTI-POS - FONCTIONS SUPPORT ==========
        
        showPosDetailsModal(posId) {
            const pos = CORE.getPOS(posId);
            if (!pos) return UI.toast('POS non trouv�', 'error');
            
            const staff = CORE.db.users.filter(u => u.pos === posId && u.active);
            const orders = CORE.db.orders.filter(o => o.posId === posId);
            const revenue = orders.filter(o => o.status === 'delivered').reduce((a,o)=>a+(o.total||0),0);
            
            // Produits du POS: ceux qui lui appartiennent OU qui ont du stock via posStocks
            const products = CORE.db.products.filter(p => {
                if (p.posId === posId) return true;
                if (p.posStocks && p.posStocks[posId] && p.posStocks[posId].stock > 0) return true;
                return false;
            });
            
            // Calculer lowStock avec le stock r�el du POS
            const lowStock = products.filter(p => {
                const stock = p.posStocks && p.posStocks[posId] ? p.posStocks[posId].stock : (p.posId === posId ? (p.stock || 0) : 0);
                const minStock = p.minStock || 0;
                return stock <= minStock;
            }).length;
            
            UI.modal(`��Ÿ? � D�tails: ${pos.name}`, `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-200">
                            <div class="text-xs font-bold text-emerald-700 uppercase">Chiffre d'affaires</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${CORE.formatPrice(revenue)}</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-blue-50 border border-blue-200">
                            <div class="text-xs font-bold text-blue-700 uppercase">Commandes</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${orders.length}</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-purple-50 border border-purple-200">
                            <div class="text-xs font-bold text-purple-700 uppercase">Produits</div>
                            <div class="text-2xl font-black text-purple-900 mt-1">${products.length}</div>
                        </div>
                        <div class="p-4 rounded-2xl ${lowStock > 0 ? 'bg-red-50 border border-red-200' : 'bg-slate-50 border border-slate-200'}">
                            <div class="text-xs font-bold ${lowStock > 0 ? 'text-red-700' : 'text-slate-700'} uppercase">Critiques</div>
                            <div class="text-2xl font-black ${lowStock > 0 ? 'text-red-900' : 'text-slate-900'} mt-1">${lowStock}</div>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h4 class="font-black text-slate-900 mb-3">��Ÿ? � �quipe</h4>
                        <div class="space-y-2">
                            ${staff.map(u => `
                                <div class="p-3 rounded-xl border border-slate-200 flex items-center justify-between">
                                    <div>
                                        <div class="font-bold text-slate-900">${u.name}</div>
                                        <div class="text-xs text-slate-500 capitalize">${this.roleLabel(u.role)}</div>
                                    </div>
                                    <span class="px-2 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-700">���?? Actif</span>
                                </div>
                            `).join('')}
                            ${staff.length === 0 ? '<div class="text-slate-500 italic text-sm">Aucun personnel assign�</div>' : ''}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' },
                { label: 'G�rer Stock', onclick: `ManagerModule.showStockTransferModal(${posId})`, class: 'px-4 py-2 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700' }
            ]);
        },



        showRestockModal(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return UI.toast('Produit non trouv�', 'error');
            
            UI.modal(`��Ÿ? � Restock: ${product.name}`, `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-3 rounded-xl bg-slate-50 text-center">
                            <div class="text-xs text-slate-600 font-bold">Stock actuel</div>
                            <div class="text-2xl font-black text-slate-900">${product.stock}</div>
                        </div>
                        <div class="p-3 rounded-xl bg-slate-50 text-center">
                            <div class="text-xs text-slate-600 font-bold">Minimum</div>
                            <div class="text-2xl font-black text-slate-900">${product.minStock}</div>
                        </div>
                    </div>
                    
                    <label class="block text-sm font-black text-slate-900">Nouvelle quantit�</label>
                    <input type="number" id="restock_qty" value="${product.stock}" min="0" class="w-full px-4 py-2 border border-slate-200 rounded-xl bg-white font-bold">
                    
                    <label class="block text-sm font-black text-slate-900 mt-3">Motif</label>
                    <textarea id="restock_reason" placeholder="Ex: Achat fournisseur, correction, etc." class="w-full px-4 py-2 border border-slate-200 rounded-xl bg-white font-bold" rows="2"></textarea>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Mettre �� jour', onclick: `ManagerModule.updateStockQty(${productId})`, class: 'px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' }
            ]);
        },

        updateStockQty(productId) {
            if (!CORE.hasPermission('stock.edit')) {
                UI.toast('Acc��s refus�', 'error');
                return;
            }
            const newQty = parseInt(UI.val('restock_qty') || '0', 10);
            const reason = UI.val('restock_reason').trim();
            const product = CORE.getProduct(productId);
            
            if (!product) return UI.toast('Produit non trouv�', 'error');
            if (newQty < 0) return UI.toast('Quantit� invalide', 'warning');
            
            const posId = this.state.inventoryPosId ? parseInt(this.state.inventoryPosId, 10) : null;
            const currentStock = posId ? CORE.getProductStock(productId, posId) : (product.stock || 0);
            const diff = newQty - currentStock;
            const moveType = diff > 0 ? 'in' : 'out';
            
            // Update per-POS stock if POS is selected, otherwise update global stock
            if (posId) {
                CORE.setProductStock(productId, posId, newQty);
            } else {
                product.stock = newQty;
            }
            
            CORE.recordStockMovement({
                productId,
                type: moveType,
                qty: Math.abs(diff),
                note: reason || `Ajustement stock ${moveType === 'in' ? 'positif' : 'n�gatif'}`,
                ref: `ADJUST-${productId}`,
                posId: posId || null
            });
            
            CORE.save();
            UI.closeModal();
            UI.toast('���?? Stock mis �� jour', 'success');
            App.rerender();
        },

        showNewUserModal() {
            UI.modal('Cr�er un compte', `
                <div class="space-y-4">
                    ${UI.input('mu_name','Nom complet','text','','Ex: Aline Mavoungou',true)}
                    ${UI.select('mu_role','R��le',[
                        {value:'gestionnaire',label:'Gestionnaire'},
                        {value:'vendeur',label:'Vendeur'},
                        {value:'livreur',label:'Livreur'}
                    ], 'vendeur', true)}
                    ${UI.input('mu_phone','T�l�phone','tel','', '+242 ...', false)}
                    ${UI.input('mu_avatar','Avatar (2 lettres)','text','', 'Ex: AM', false)}
                    <div class="grid grid-cols-2 gap-3">
                        ${UI.select('mu_city','Ville', CORE.db.cities.map(c=>({value:c.id,label:c.name})), CORE.state.currentUser?.city || 1)}
                        ${UI.select('mu_pos','Point de vente', CORE.db.pointsOfSale.map(p=>({value:p.id,label:p.name})), CORE.state.currentUser?.pos || 1)}
                    </div>
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">
                        Notes: la ville/POS sont utiles pour les vendeurs/gestionnaires. Pour les livreurs, c'est optionnel.
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Cr�er', onclick: 'ManagerModule.createUser()', class: 'px-5 py-2.5 bg-sky-600 text-white font-black rounded-xl hover:bg-sky-700 transition' }
            ]);
        },

        createUser() {
            const name = UI.val('mu_name').trim();
            const role = UI.val('mu_role');
            const phone = UI.val('mu_phone').trim();
            const avatarRaw = UI.val('mu_avatar').trim();
            const city = parseInt(UI.val('mu_city') || '0', 10) || null;
            const pos = parseInt(UI.val('mu_pos') || '0', 10) || null;

            if (!name || !role) return UI.toast('Nom et r��le requis', 'warning');
            if (!['gestionnaire','vendeur','livreur'].includes(role)) return UI.toast('R��le invalide', 'error');

            const avatar = (avatarRaw || name.split(' ').map(x=>x[0]).slice(0,2).join('')).toUpperCase().slice(0,2);

            const created = CORE.create('users', {
                name,
                role,
                avatar,
                phone: phone || null,
                active: true,
                city: city || null,
                pos: pos || null,
                // champs livreur
                vehicle: role === 'livreur' ? 'moto' : null,
                rating: role === 'livreur' ? 5.0 : null,
                deliveryCount: role === 'livreur' ? 0 : null
            });

            CORE.notify('info', `Nouveau compte cr��: ${created.name} (${created.role})`, { userId: created.id });
            UI.closeModal();
            UI.toast('Compte cr��', 'success');
            App.rerender();
        },

        showEditUserModal(userId) {
            const u = CORE.getUser(userId);
            if (!u) return;
            if (!['gestionnaire','vendeur','livreur'].includes(u.role)) return UI.toast('Ce compte n�� ?� ?�est pas g�r� ici', 'warning');

            UI.modal(`Modifier: ${u.name}`, `
                <div class="space-y-4">
                    ${UI.input('eu_name','Nom complet','text', u.name || '', '', true)}
                    ${UI.select('eu_role','R��le',[
                        {value:'gestionnaire',label:'Gestionnaire'},
                        {value:'vendeur',label:'Vendeur'},
                        {value:'livreur',label:'Livreur'}
                    ], u.role, true)}
                    ${UI.input('eu_phone','T�l�phone','tel', u.phone || '', '+242 ...', false)}
                    ${UI.input('eu_avatar','Avatar (2 lettres)','text', u.avatar || '', '', false)}

                    <div class="grid grid-cols-2 gap-3">
                        ${UI.select('eu_city','Ville', CORE.db.cities.map(c=>({value:c.id,label:c.name})), u.city || '')}
                        ${UI.select('eu_pos','Point de vente', CORE.db.pointsOfSale.map(p=>({value:p.id,label:p.name})), u.pos || '')}
                    </div>

                    ${u.role === 'livreur' ? `
                        <div class="grid grid-cols-2 gap-3">
                            ${UI.select('eu_vehicle','V�hicule',[{value:'moto',label:'Moto'},{value:'voiture',label:'Voiture'},{value:'velo',label:'V�lo'},{value:'',label:'�� ?��'}], u.vehicle || '')}
                            ${UI.input('eu_rating','Note (0-5)','number', u.rating ?? '', 'ex: 4.8')}
                        </div>
                    ` : ''}

                    ${UI.select('eu_active','Statut',[{value:'1',label:'Actif'},{value:'0',label:'Inactif'}], u.active ? '1':'0', true)}

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">
                        Astuce: d�sactiver un compte emp��che la connexion sur l'�cran de login (vous verrez toujours le compte ici).
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: `ManagerModule.saveUser(${u.id})`, class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        saveUser(userId) {
            const u = CORE.getUser(userId);
            if (!u) return;

            const name = UI.val('eu_name').trim();
            const role = UI.val('eu_role');
            const phone = UI.val('eu_phone').trim();
            const avatarRaw = UI.val('eu_avatar').trim();
            const city = parseInt(UI.val('eu_city') || '0', 10) || null;
            const pos = parseInt(UI.val('eu_pos') || '0', 10) || null;
            const active = UI.val('eu_active') === '1';

            if (!name || !role) return UI.toast('Nom et r��le requis', 'warning');
            if (!['gestionnaire','vendeur','livreur'].includes(role)) return UI.toast('R��le invalide', 'error');

            const avatar = (avatarRaw || name.split(' ').map(x=>x[0]).slice(0,2).join('')).toUpperCase().slice(0,2);

            const updates = {
                name,
                role,
                phone: phone || null,
                avatar,
                city: city || null,
                pos: pos || null,
                active
            };

            if (role === 'livreur') {
                const vehicle = UI.val('eu_vehicle')?.trim() || null;
                const ratingRaw = UI.val('eu_rating');
                const rating = ratingRaw === '' ? null : Utils.clamp(parseFloat(ratingRaw), 0, 5);
                updates.vehicle = vehicle;
                updates.rating = rating;
                if (u.deliveryCount == null) updates.deliveryCount = 0;
            } else {
                // Nettoyage si on change de r��le
                updates.vehicle = null;
                updates.rating = null;
                updates.deliveryCount = null;
            }

            CORE.update('users', u.id, updates);
            CORE.notify('info', `Compte modifi�: ${name} (${role})`, { userId: u.id });
            UI.closeModal();
            UI.toast('Compte mis �� jour', 'success');
            App.rerender();
        },

        toggleUserActive(userId) {
            const u = CORE.getUser(userId);
            if (!u) return;
            if (!['gestionnaire','vendeur','livreur'].includes(u.role)) return;
            CORE.update('users', u.id, { active: !u.active });
            UI.toast(!u.active ? 'Compte d�sactiv�' : 'Compte activ�', 'info');
            App.rerender();
        },

        renderTeam() {
            const users = this.getTeamFiltered();
            const roleOptions = [
                { value: 'all', label: 'Tous' },
                { value: 'gestionnaire', label: 'Gestionnaires' },
                { value: 'vendeur', label: 'Vendeurs' },
                { value: 'livreur', label: 'Livreurs' }
            ];

            const countBy = (r) => CORE.db.users.filter(u => u.role === r).length;

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">Comptes & RH</h2>
                            <p class="text-slate-500 font-medium">G�rez les gestionnaires, vendeurs et livreurs.</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="ManagerModule.showNewUserModal()" class="px-4 py-2.5 bg-sky-600 text-white font-black rounded-xl hover:bg-sky-700 transition">Nouveau compte</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-6 rounded-3xl border border-slate-200">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Gestionnaires</div>
                            <div class="mt-2 text-3xl font-black text-slate-900">${countBy('gestionnaire')}</div>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Vendeurs</div>
                            <div class="mt-2 text-3xl font-black text-slate-900">${countBy('vendeur')}</div>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Livreurs</div>
                            <div class="mt-2 text-3xl font-black text-slate-900">${countBy('livreur')}</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-3">
                            <div class="flex items-center gap-2">
                                <select onchange="ManagerModule.state.teamRole=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${roleOptions.map(o => `<option value="${o.value}" ${o.value===this.state.teamRole?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                            </div>
                            <div class="relative">
                                <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                <input id="manager-team-search-input" type="text" value="${this.state.teamSearch}" onkeyup="ManagerModule.updateTeamSearch(this.value)" placeholder="Nom, t�l�phone, id..." class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium w-[320px] max-w-full" style="direction: ltr; text-align: left;" autocomplete="off">
                            </div>
                        </div>

                        <div class="overflow-auto">
                            <table class="w-full text-left min-w-[1050px]">
                                <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4">Utilisateur</th>
                                        <th class="px-6 py-4">R��le</th>
                                        <th class="px-6 py-4">Ville / POS</th>
                                        <th class="px-6 py-4">T�l�phone</th>
                                        <th class="px-6 py-4">Statut</th>
                                        <th class="px-6 py-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${users.length === 0 ? `<tr><td colspan="6" class="px-6 py-12 text-center text-slate-400 font-medium">Aucun compte</td></tr>` : ''}
                                    ${users.map(u => {
                                        const roleColor = u.role==='livreur'?'gradient-livreur':u.role==='vendeur'?'gradient-vendeur':'gradient-gestionnaire';
                                        const city = u.city ? CORE.getCity(u.city)?.name : '�� ?��';
                                        const pos = u.pos ? CORE.getPOS(u.pos)?.name : '�� ?��';
                                        return `
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-6 py-4">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-10 h-10 rounded-2xl ${roleColor} text-white flex items-center justify-center font-black">${u.avatar || (u.name||'?').slice(0,2).toUpperCase()}</div>
                                                    <div>
                                                        <div class="font-black text-slate-900">${u.name}</div>
                                                        <div class="text-[10px] text-slate-400">#${u.id}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 font-black text-slate-900">${this.roleLabel(u.role)}</td>
                                            <td class="px-6 py-4 text-sm text-slate-600">${city} �� ?� � ${pos}</td>
                                            <td class="px-6 py-4 text-sm font-bold text-slate-700">${u.phone || '�� ?��'}</td>
                                            <td class="px-6 py-4">${u.active ? UI.badge('Actif','emerald') : UI.badge('Inactif','slate')}</td>
                                            <td class="px-6 py-4 text-right">
                                                <div class="flex items-center justify-end gap-2">
                                                    <button onclick="ManagerModule.showEditUserModal(${u.id})" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-50">�diter</button>
                                                    <button onclick="ManagerModule.toggleUserActive(${u.id})" class="px-3 py-2 rounded-xl ${u.active ? 'bg-slate-100 text-slate-700 hover:bg-slate-200' : 'bg-emerald-600 text-white hover:bg-emerald-700'} text-xs font-black transition">${u.active ? 'D�sactiver' : 'Activer'}</button>
                                                </div>
                                            </td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        },

        renderTeam() {
            const users = this.getTeamFiltered();
            const stats = this.getTeamStats();
            const viewMode = this.state.teamViewMode || 'list';
            const posList = CORE.db.pointsOfSale || [];
            const canManageUsers = CORE.getSystemSetting('manager_manage_users', false);
            
            const roles = [
                { value: 'all', label: 'Tous les r��les' },
                { value: 'gestionnaire', label: 'Gestionnaires' },
                { value: 'vendeur', label: 'Vendeurs' },
                { value: 'livreur', label: 'Livreurs' }
            ];

            const sortOptions = [
                { value: 'name', label: 'Nom' },
                { value: 'role', label: 'R��le' },
                { value: 'pos', label: 'Point de vente' }
            ];

            const perPageOptions = [10, 20, 50, 100];

            // Rendu de la pagination
            const renderPagination = () => {
                if (stats.totalPages <= 1) return '';
                const pages = [];
                const maxVisible = 5;
                let start = Math.max(1, stats.page - Math.floor(maxVisible / 2));
                let end = Math.min(stats.totalPages, start + maxVisible - 1);
                if (end - start < maxVisible - 1) start = Math.max(1, end - maxVisible + 1);
                
                for (let i = start; i <= end; i++) {
                    pages.push(i);
                }
                
                return '<div class="flex items-center justify-center gap-2 mt-6">' +
                    '<button onclick="ManagerModule.state.teamPage = 1; App.rerender()" class="px-3 py-2 rounded-xl ' + (stats.page === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm transition" ' + (stats.page === 1 ? 'disabled' : '') + '><i data-lucide="chevrons-left" class="w-4 h-4"></i></button>' +
                    '<button onclick="ManagerModule.state.teamPage = Math.max(1, ManagerModule.state.teamPage - 1); App.rerender()" class="px-3 py-2 rounded-xl ' + (stats.page === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm transition" ' + (stats.page === 1 ? 'disabled' : '') + '><i data-lucide="chevron-left" class="w-4 h-4"></i></button>' +
                    pages.map(p => '<button onclick="ManagerModule.state.teamPage = ' + p + '; App.rerender()" class="px-3 py-2 rounded-xl ' + (p === stats.page ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm transition">' + p + '</button>').join('') +
                    '<button onclick="ManagerModule.state.teamPage = Math.min(' + stats.totalPages + ', ManagerModule.state.teamPage + 1); App.rerender()" class="px-3 py-2 rounded-xl ' + (stats.page === stats.totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm transition" ' + (stats.page === stats.totalPages ? 'disabled' : '') + '><i data-lucide="chevron-right" class="w-4 h-4"></i></button>' +
                    '<button onclick="ManagerModule.state.teamPage = ' + stats.totalPages + '; App.rerender()" class="px-3 py-2 rounded-xl ' + (stats.page === stats.totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm transition" ' + (stats.page === stats.totalPages ? 'disabled' : '') + '><i data-lucide="chevrons-right" class="w-4 h-4"></i></button>' +
                '</div>';
            };

            // Rendu d'un utilisateur en carte
            const renderUserCard = (u) => {
                const roleColors = { gestionnaire: 'from-cyan-500 to-cyan-600', vendeur: 'from-emerald-500 to-emerald-600', livreur: 'from-amber-500 to-amber-600' };
                const roleColor = roleColors[u.role] || 'from-slate-500 to-slate-600';
                const pos = posList.find(p => p.id === (u.pos || u.posId));
                const hasImage = u.profileImage && u.profileImage.trim();
                
                return '<div class="group p-4 rounded-2xl bg-white border border-slate-200 hover:border-blue-300 hover:shadow-lg hover:shadow-blue-500/10 transition-all cursor-pointer" onclick="ManagerModule.showUserDetailsModal(' + u.id + ')">' +
                    '<div class="flex items-start gap-4">' +
                        (hasImage ? 
                            '<img src="' + u.profileImage + '" class="w-14 h-14 rounded-2xl object-cover shadow-lg ring-2 ring-white">' :
                            '<div class="w-14 h-14 bg-gradient-to-br ' + roleColor + ' rounded-2xl flex items-center justify-center text-white font-black text-lg shadow-lg">' + (u.avatar || (u.name||'?').slice(0,2).toUpperCase()) + '</div>'
                        ) +
                        '<div class="min-w-0 flex-1">' +
                            '<div class="flex items-center justify-between gap-2">' +
                                '<div class="font-black text-slate-900 truncate group-hover:text-blue-600 transition">' + u.name + '</div>' +
                                (u.active !== false ? 
                                    '<span class="px-2 py-0.5 rounded-full text-[10px] font-black bg-emerald-100 text-emerald-700">Actif</span>' : 
                                    '<span class="px-2 py-0.5 rounded-full text-[10px] font-black bg-slate-100 text-slate-500">Inactif</span>'
                                ) +
                            '</div>' +
                            '<div class="flex flex-wrap items-center gap-2 mt-1.5">' +
                                '<span class="text-[10px] text-white font-black uppercase tracking-wider bg-gradient-to-r ' + roleColor + ' px-2 py-0.5 rounded-lg shadow-sm">' + u.role + '</span>' +
                                (pos ? '<span class="text-[10px] text-blue-700 font-bold bg-blue-50 px-2 py-0.5 rounded-lg"><i data-lucide="store" class="w-3 h-3 inline -mt-0.5"></i> ' + pos.name + '</span>' : '') +
                            '</div>' +
                            (u.phone ? '<div class="mt-2 text-xs text-slate-500 flex items-center gap-1.5"><i data-lucide="phone" class="w-3.5 h-3.5"></i> ' + u.phone + '</div>' : '') +
                        '</div>' +
                    '</div>' +
                    '<div class="flex items-center gap-2 mt-3 pt-3 border-t border-slate-100">' +
                        '<button onclick="event.stopPropagation(); ManagerModule.showEditUserModal(' + u.id + ')" class="flex-1 px-3 py-2 bg-slate-100 hover:bg-blue-100 hover:text-blue-700 text-slate-700 text-xs font-bold rounded-xl transition flex items-center justify-center gap-1"><i data-lucide="edit-3" class="w-3.5 h-3.5"></i> Modifier</button>' +
                        '<button onclick="event.stopPropagation(); ManagerModule.toggleUserActive(' + u.id + ')" class="px-3 py-2 ' + (u.active ? 'bg-red-100 hover:bg-red-200 text-red-700' : 'bg-emerald-100 hover:bg-emerald-200 text-emerald-700') + ' text-xs font-bold rounded-xl transition"><i data-lucide="' + (u.active ? 'user-x' : 'user-check') + '" class="w-3.5 h-3.5"></i></button>' +
                    '</div>' +
                '</div>';
            };

            // Vue group�e par POS
            const renderGroupedView = () => {
                const grouped = this.getTeamGroupedByPos();
                return grouped.map(g => 
                    '<div class="mb-8">' +
                        '<div class="flex items-center gap-3 mb-4 px-1">' +
                            '<div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/30"><i data-lucide="store" class="w-6 h-6 text-white"></i></div>' +
                            '<div>' +
                                '<div class="font-black text-lg text-slate-900">' + g.pos.name + '</div>' +
                                '<div class="text-sm text-slate-500 font-medium">' + g.users.length + ' membre' + (g.users.length > 1 ? 's' : '') + '</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">' +
                            g.users.map(u => renderUserCard(u)).join('') +
                        '</div>' +
                    '</div>'
                ).join('') || '<div class="text-center py-12 text-slate-400">Aucun membre trouv�</div>';
            };

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <!-- Header avec gradient -->
                    <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                                    <i data-lucide="users" class="w-6 h-6"></i>
                                </div>
                                Gestion de l'�quipe
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">${stats.totalUsers} collaborateurs �� ?� � ${posList.length} points de vente</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="ManagerModule.showAddUserModal()" class="px-4 py-2.5 ${canManageUsers ? 'bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 shadow-lg shadow-emerald-500/30' : 'bg-slate-400 cursor-not-allowed'} text-white rounded-xl font-black transition flex items-center gap-2" ${!canManageUsers ? 'disabled title="Permission requise"' : ''}>
                                <i data-lucide="user-plus" class="w-4 h-4"></i> Ajouter
                            </button>
                            <button onclick="ManagerModule.showUsersManagementModal()" class="px-4 py-2.5 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl font-black hover:from-blue-600 hover:to-indigo-700 transition shadow-lg shadow-blue-500/30 flex items-center gap-2">
                                <i data-lucide="settings" class="w-4 h-4"></i> G�rer
                            </button>
                            <button onclick="ManagerModule.exportTeamList()" class="px-4 py-2.5 bg-white border border-slate-200 text-slate-700 rounded-xl font-black hover:bg-slate-50 transition flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> Export
                            </button>
                        </div>
                    </div>

                    <!-- Statistiques par r��le avec gradients -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-5 text-white shadow-lg relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-6 -mt-6"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="users" class="w-5 h-5 opacity-70"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-70">Total</span>
                                </div>
                                <div class="text-3xl font-black">${stats.totalUsers}</div>
                                <div class="text-xs opacity-60 mt-1">${stats.totalFiltered} affich�s</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-2xl p-5 text-white shadow-lg shadow-cyan-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-6 -mt-6"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="briefcase" class="w-5 h-5 opacity-70"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-70">Gestionnaires</span>
                                </div>
                                <div class="text-3xl font-black">${stats.usersByRole['gestionnaire'] || 0}</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-5 text-white shadow-lg shadow-emerald-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-6 -mt-6"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="shopping-bag" class="w-5 h-5 opacity-70"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-70">Vendeurs</span>
                                </div>
                                <div class="text-3xl font-black">${stats.usersByRole['vendeur'] || 0}</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-5 text-white shadow-lg shadow-amber-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-6 -mt-6"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="truck" class="w-5 h-5 opacity-70"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-70">Livreurs</span>
                                </div>
                                <div class="text-3xl font-black">${stats.usersByRole['livreur'] || 0}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Conteneur principal avec filtres -->
                    <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                        <!-- Barre de filtres -->
                        <div class="p-5 border-b border-slate-100 space-y-4">
                            <!-- Ligne 1: Recherche et filtres -->
                            <div class="flex flex-wrap gap-3">
                                <div class="relative flex-1 min-w-[220px]">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-4 top-1/2 -translate-y-1/2"></i>
                                    <input id="manager-team-search-input" type="text" value="${this.state.teamSearch || ''}" onkeyup="ManagerModule.updateTeamSearch(this.value)" placeholder="Rechercher par nom, t�l�phone, ID..." class="w-full pl-11 pr-4 py-3 rounded-xl border border-slate-200 bg-white font-medium focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" autocomplete="off">
                                </div>
                                <select onchange="ManagerModule.state.teamRole=this.value; ManagerModule.state.teamPage=1; App.rerender()" class="px-4 py-3 rounded-xl border border-slate-200 bg-white font-bold min-w-[150px] focus:ring-2 focus:ring-blue-500">
                                    ${roles.map(r => `<option value="${r.value}" ${r.value===(this.state.teamRole||'all')?'selected':''}>${r.label}</option>`).join('')}
                                </select>
                                <select onchange="ManagerModule.state.teamPosId=this.value; ManagerModule.state.teamPage=1; App.rerender()" class="px-4 py-3 rounded-xl border border-slate-200 bg-white font-bold min-w-[170px] focus:ring-2 focus:ring-blue-500">
                                    <option value="all" ${(this.state.teamPosId||'all') === 'all' ? 'selected' : ''}>Tous les POS</option>
                                    ${posList.map(p => `<option value="${p.id}" ${String(this.state.teamPosId) === String(p.id) ? 'selected' : ''}>${p.name}</option>`).join('')}
                                </select>
                            </div>
                            
                            <!-- Ligne 2: Vue et tri -->
                            <div class="flex flex-wrap items-center justify-between gap-3">
                                <div class="flex items-center gap-3">
                                    <!-- Toggle vue liste/group�e -->
                                    <div class="flex bg-slate-100 rounded-xl p-1">
                                        <button onclick="ManagerModule.state.teamViewMode='list'; App.rerender()" class="px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 ${viewMode === 'list' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                                            <i data-lucide="layout-list" class="w-4 h-4"></i> Liste
                                        </button>
                                        <button onclick="ManagerModule.state.teamViewMode='grouped'; App.rerender()" class="px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 ${viewMode === 'grouped' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                                            <i data-lucide="layout-grid" class="w-4 h-4"></i> Par POS
                                        </button>
                                    </div>
                                    
                                    <!-- Tri -->
                                    <select onchange="ManagerModule.state.teamSortBy=this.value; App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-bold">
                                        ${sortOptions.map(s => `<option value="${s.value}" ${s.value === (this.state.teamSortBy || 'name') ? 'selected' : ''}>Trier: ${s.label}</option>`).join('')}
                                    </select>
                                    <button onclick="ManagerModule.state.teamSortOrder = ManagerModule.state.teamSortOrder === 'asc' ? 'desc' : 'asc'; App.rerender()" class="p-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 transition" title="Inverser l'ordre">
                                        <i data-lucide="${(this.state.teamSortOrder || 'asc') === 'asc' ? 'arrow-up-narrow-wide' : 'arrow-down-wide-narrow'}" class="w-4 h-4 text-slate-600"></i>
                                    </button>
                                </div>
                                
                                <div class="flex items-center gap-3 text-sm">
                                    <span class="text-slate-600 font-bold">${stats.totalFiltered} r�sultat${stats.totalFiltered > 1 ? 's' : ''}</span>
                                    <span class="text-slate-300">|</span>
                                    <select onchange="ManagerModule.state.teamPerPage=parseInt(this.value); ManagerModule.state.teamPage=1; App.rerender()" class="px-2 py-1.5 rounded-lg border border-slate-200 bg-white text-sm font-bold">
                                        ${perPageOptions.map(n => `<option value="${n}" ${n === (stats.perPage || 20) ? 'selected' : ''}>${n} / page</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Contenu de la liste -->
                        <div class="p-5">
                            ${viewMode === 'grouped' ? renderGroupedView() : `
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    ${users.length === 0 ? '<div class="p-12 text-center text-slate-400 font-medium md:col-span-2 lg:col-span-3"><i data-lucide="users" class="w-12 h-12 mx-auto mb-3 opacity-30"></i><p>Aucun membre trouv�</p></div>' : ''}
                                    ${users.map(u => renderUserCard(u)).join('')}
                                </div>
                                ${renderPagination()}
                            `}
                        </div>
                    </div>
                </div>
            `;
        },

        renderCommandes() {
            const suppliers = CORE.db.suppliers || [];
            const purchaseOrders = CORE.db.purchaseOrders || [];
            const products = CORE.db.products || [];
            
            const stats = {
                total: purchaseOrders.length,
                pending: purchaseOrders.filter(o => ['pending','confirmed'].includes(o.status)).length,
                received: purchaseOrders.filter(o => o.status === 'received').length,
                totalCost: purchaseOrders.reduce((a,o) => a + (o.totalCost||0), 0)
            };

            let html = '<div class="max-w-7xl mx-auto space-y-6 fade-in"><h2 class="text-3xl font-black text-slate-900">��Ÿ? � Gestion des Commandes de R�approvisionnement</h2>';
            html += '<button onclick="ManagerModule.showNewPurchaseOrderModal()" class="px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700">+ Nouvelle commande</button>';
            
            html += '<div class="grid grid-cols-1 md:grid-cols-4 gap-4">';
            html += '<div class="bg-white p-4 rounded-2xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase">Total</div><div class="mt-2 text-2xl font-black">' + stats.total + '</div></div>';
            html += '<div class="bg-white p-4 rounded-2xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase">En attente</div><div class="mt-2 text-2xl font-black text-amber-600">' + stats.pending + '</div></div>';
            html += '<div class="bg-white p-4 rounded-2xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase">Livr�es</div><div class="mt-2 text-2xl font-black text-emerald-600">' + stats.received + '</div></div>';
            html += '<div class="bg-white p-4 rounded-2xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase">Total d�pens�</div><div class="mt-2 text-2xl font-black">' + CORE.formatPrice(stats.totalCost) + '</div></div>';
            html += '</div>';

            html += '<div class="bg-white border border-slate-200 rounded-3xl overflow-hidden"><table class="w-full"><thead class="bg-slate-100"><tr><th class="px-4 py-3 text-left font-black">Ref</th><th class="px-4 py-3 text-left font-black">Fournisseur</th><th class="px-4 py-3 text-left font-black">Produit</th><th class="px-4 py-3 text-left font-black">Montant</th><th class="px-4 py-3 text-left font-black">Statut</th><th class="px-4 py-3 text-left font-black">Date</th><th class="px-4 py-3 text-left font-black">Actions</th></tr></thead><tbody>';
            
            const recent = purchaseOrders.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 20);
            recent.forEach(o => {
                const supplier = suppliers.find(s => s.id === o.supplierId);
                const product = products.find(p => p.id === o.productId);
                html += '<tr class="border-t border-slate-200 hover:bg-slate-50"><td class="px-4 py-3 font-bold">' + (o.reference || o.id) + '</td>';
                html += '<td class="px-4 py-3 font-bold">' + (supplier?.name || '�� ?��') + '</td>';
                html += '<td class="px-4 py-3">' + (product?.name || '�� ?��') + ' (�??' + o.qty + ')</td>';
                html += '<td class="px-4 py-3 font-black">' + CORE.formatPrice(o.totalCost || 0) + '</td>';
                html += '<td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-bold ' + (o.status === 'received' ? 'bg-emerald-100 text-emerald-700' : o.status === 'confirmed' ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700') + '">' + (o.status === 'pending' ? 'Attente' : o.status === 'confirmed' ? 'Confirm�e' : 'Livr�e') + '</span></td>';
                html += '<td class="px-4 py-3 text-xs text-slate-500">' + CORE.formatDate(o.createdAt) + '</td>';
                html += '<td class="px-4 py-3"><button onclick="ManagerModule.validatePurchaseOrderArrival(' + o.id + ')" class="' + (o.status === 'received' ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-emerald-500 text-white hover:bg-emerald-600') + ' px-3 py-1 rounded text-xs font-bold">' + (o.status === 'received' ? '���?? Re��u' : 'Valider arriv�e') + '</button></td></tr>';
            });
            
            html += '</tbody></table></div></div>';
            return html;
        },

        showNewPurchaseOrderModal(savedData = null) {
            const suppliers = CORE.db.suppliers || [];
            const products = CORE.db.products || [];
            
            const supplierOptions = suppliers.map(s => ({value: s.id, label: s.name}));
            const productOptions = products.map(p => ({value: p.id, label: p.name + ' (Stock: ' + (p.stock||0) + ')'}));
            const transportModes = [{value: 'routier', label: 'Routier'}, {value: 'aerien', label: 'A�rien'}, {value: 'maritime', label: 'Maritime'}, {value: 'ferroviaire', label: 'Ferroviaire'}];
            
            // Utiliser les donn�es sauvegard�es si pr�sentes
            const d = savedData || {};
            
            UI.modal('Nouvelle commande de r�approvisionnement', `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <!-- Fournisseur/Usine avec bouton + Nouveau -->
                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">Fournisseur/Usine *</label>
                        <div class="flex gap-2">
                            <select id="po_supplier" class="flex-1 px-4 py-2.5 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-emerald-500">
                                <option value="">-- S�lectionner --</option>
                                ${supplierOptions.map(s => '<option value="' + s.value + '"' + (String(s.value) === String(d.supplierId || '') ? ' selected' : '') + '>' + s.label + '</option>').join('')}
                            </select>
                            <button onclick="ManagerModule.showNewSupplierForPO()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition whitespace-nowrap">+ Nouveau</button>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">Produit existant</label>
                        <select id="po_product" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                            <option value="">-- S�lectionner un produit --</option>
                            ${productOptions.map(p => '<option value="' + p.value + '"' + (String(p.value) === String(d.productId || '') ? ' selected' : '') + '>' + p.label + '</option>').join('')}
                        </select>
                    </div>
                    
                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">OU Cr�er un nouveau produit</label>
                        <input type="text" id="po_newProductName" value="${d.newProductName || ''}" placeholder="Nom du produit" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white">
                        <input type="text" id="po_newProductCode" value="${d.newProductCode || ''}" placeholder="Code produit" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white">
                        <textarea id="po_newProductDesc" placeholder="Description du produit" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white" rows="2">${d.newProductDesc || ''}</textarea>
                    </div>
                    
                    ${UI.input('po_qty', 'Quantit�', 'number', d.qty || '10', 'ex: 50', true)}
                    ${UI.input('po_kilos', 'Kilos', 'number', d.kilos || '0', 'ex: 100', false)}
                    ${UI.input('po_cbm', 'CBM (m�? �)', 'number', d.cbm || '0', 'ex: 2.5', false)}
                    ${UI.input('po_unitPrice', 'Prix unitaire', 'number', d.unitPrice || '0', 'ex: 1500', true)}
                    ${UI.input('po_transportPrice', 'Prix de transport', 'number', d.transportPrice || '0', 'ex: 5000', false)}
                    ${UI.input('po_totalPrice', 'Total �� payer au fournisseur', 'number', d.totalPrice || '0', 'ex: 10500 (optionnel)', false)}
                    ${UI.select('po_transportMode', 'Mode de transport', transportModes, d.transportMode || '')}
                    ${UI.input('po_transportAgency', 'Agence de transport', 'text', d.transportAgency || '', 'ex: DHL, FedEx, UPS', false)}
                    ${UI.input('po_trackingNumber', 'Num�ro de suivi du colis', 'text', d.trackingNumber || '', 'ex: TRK123456789', false)}
                    ${UI.input('po_deliveryDate', 'Date de livraison pr�vue', 'date', d.deliveryDate || '', '', false)}
                    ${UI.input('po_reminderDays', 'P�riode de rappel (jours avant arriv�e)', 'number', d.reminderDays || '3', 'ex: 3, 5, 7', false)}
                    
                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">Image du colis</label>
                        <input type="file" id="po_image" accept="image/*" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">Vid�o</label>
                        <input type="file" id="po_video" accept="video/*" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white">
                    </div>
                    ${UI.textarea('po_note', 'Notes', d.note || 'Ex: Urgent, qualit� premium', 300, false)}
                </div>
            `, [
                {label: 'Annuler', onclick: 'UI.closeModal()'},
                {label: 'Cr�er', onclick: 'ManagerModule.createPurchaseOrder()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700'}
            ]);
        },

        showNewSupplierForPO() {
            // Sauvegarder les donn�es du formulaire
            window._pendingPOFormData = {
                module: 'manager',
                supplierId: UI.val('po_supplier') || '',
                productId: UI.val('po_product') || '',
                newProductName: document.getElementById('po_newProductName')?.value || '',
                newProductCode: document.getElementById('po_newProductCode')?.value || '',
                newProductDesc: document.getElementById('po_newProductDesc')?.value || '',
                qty: UI.val('po_qty') || '10',
                kilos: UI.val('po_kilos') || '0',
                cbm: UI.val('po_cbm') || '0',
                unitPrice: UI.val('po_unitPrice') || '0',
                transportPrice: UI.val('po_transportPrice') || '0',
                totalPrice: UI.val('po_totalPrice') || '0',
                transportMode: UI.val('po_transportMode') || '',
                transportAgency: UI.val('po_transportAgency') || '',
                trackingNumber: UI.val('po_trackingNumber') || '',
                deliveryDate: UI.val('po_deliveryDate') || '',
                reminderDays: UI.val('po_reminderDays') || '3',
                note: UI.val('po_note') || ''
            };
            
            UI.modal('��ž� Nouveau Fournisseur/Usine', `
                <div class="space-y-4">
                    <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-xl text-sm text-emerald-800">
                        Cr�ez un nouveau fournisseur ou usine pour vos commandes de r�approvisionnement
                    </div>
                    ${UI.input('new_supplier_name', 'Nom du fournisseur/usine *', 'text', '', 'ex: Usine Textile Guangzhou', true)}
                    ${UI.input('new_supplier_contact', 'Email de contact', 'email', '', 'ex: contact@fournisseur.com', false)}
                    ${UI.input('new_supplier_phone', 'T�l�phone', 'tel', '', 'ex: +86 123 456 7890', false)}
                    ${UI.input('new_supplier_country', 'Pays', 'text', '', 'ex: Chine, Maroc, Turquie', false)}
                    ${UI.input('new_supplier_address', 'Adresse', 'text', '', 'ex: Zone industrielle...', false)}
                    ${UI.textarea('new_supplier_notes', 'Notes', '', 2, false)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'ManagerModule.restorePOModal()' },
                { label: 'Cr�er le fournisseur', onclick: 'ManagerModule.saveNewSupplierForPO()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        saveNewSupplierForPO() {
            const name = UI.val('new_supplier_name')?.trim();
            if (!name) return UI.toast('Le nom du fournisseur est requis', 'warning');
            
            // V�rifier si existe d�j��
            const exists = (CORE.db.suppliers || []).some(s => s.name.toLowerCase() === name.toLowerCase());
            if (exists) return UI.toast('Ce fournisseur existe d�j��', 'warning');
            
            const newSupplier = CORE.create('suppliers', {
                name: name,
                email: UI.val('new_supplier_contact')?.trim() || '',
                phone: UI.val('new_supplier_phone')?.trim() || '',
                country: UI.val('new_supplier_country')?.trim() || '',
                address: UI.val('new_supplier_address')?.trim() || '',
                notes: UI.val('new_supplier_notes')?.trim() || '',
                active: true,
                createdAt: new Date().toISOString()
            });
            
            UI.toast(`���?� Fournisseur "${name}" cr��!`, 'success');
            
            // Restaurer le modal avec le nouveau fournisseur s�lectionn�
            const savedData = window._pendingPOFormData || {};
            savedData.supplierId = newSupplier.id;
            window._pendingPOFormData = null;
            
            this.showNewPurchaseOrderModal(savedData);
        },

        restorePOModal() {
            const savedData = window._pendingPOFormData || {};
            window._pendingPOFormData = null;
            
            if (savedData.module === 'pdg') {
                PDGModule.showNewPurchaseOrderModal(savedData);
            } else {
                this.showNewPurchaseOrderModal(savedData);
            }
        },

        createPurchaseOrder() {
            const supplierId = UI.val('po_supplier');
            let productId = UI.val('po_product');
            const newProductName = document.getElementById('po_newProductName')?.value || '';
            const newProductCode = document.getElementById('po_newProductCode')?.value || '';
            const newProductDesc = document.getElementById('po_newProductDesc')?.value || '';
            const qty = parseInt(UI.val('po_qty')) || 0;
            const kilos = parseFloat(UI.val('po_kilos')) || 0;
            const cbm = parseFloat(UI.val('po_cbm')) || 0;
            const unitPrice = parseFloat(UI.val('po_unitPrice')) || 0;
            const transportPrice = parseFloat(UI.val('po_transportPrice')) || 0;
            const customTotalPrice = parseFloat(UI.val('po_totalPrice')) || 0;
            const reminderDays = parseInt(UI.val('po_reminderDays')) || 0;
            
            if (!supplierId) return UI.toast('Fournisseur requis', 'error');
            if (!productId && !newProductName) return UI.toast('S�lectionnez un produit ou cr�ez un nouveau', 'error');
            if (qty <= 0) return UI.toast('Quantit� invalide', 'error');
            
            // Cr�er le nouveau produit si n�cessaire
            if (newProductName && !productId) {
                const newProduct = CORE.create('products', {
                    name: newProductName,
                    code: newProductCode || 'PROD-' + Utils.uid().substring(0,6),
                    description: newProductDesc,
                    stock: qty,
                    price: unitPrice,
                    active: true,
                    createdAt: new Date().toISOString()
                });
                productId = newProduct.id;
            }
            
            // Calculer le total : utiliser customTotalPrice si fourni, sinon calculer automatiquement
            const totalCost = customTotalPrice > 0 ? customTotalPrice : (qty * unitPrice) + transportPrice;
            
            const imageFile = document.getElementById('po_image')?.files?.[0];
            const videoFile = document.getElementById('po_video')?.files?.[0];
            let imageBase64 = null;
            let videoBase64 = null;
            
            const createOrder = () => {
                const reference = 'PO-' + Utils.uid('PO').substring(0,6);
                const po = CORE.create('purchaseOrders', {
                    reference,
                    supplierId: parseInt(supplierId),
                    productId: parseInt(productId),
                    qty,
                    kilos,
                    cbm,
                    unitPrice,
                    transportPrice,
                    transportMode: UI.val('po_transportMode') || null,
                    transportAgency: UI.val('po_transportAgency') || null,
                    totalCost,
                    status: 'pending',
                    trackingNumber: UI.val('po_trackingNumber') || null,
                    deliveryDate: UI.val('po_deliveryDate') || null,
                    reminderDays,
                    image: imageBase64,
                    video: videoBase64,
                    note: UI.val('po_note') || '',
                    createdAt: new Date().toISOString()
                });
                
                // Enregistrer la d�pense automatiquement
                const supplier = CORE.db.suppliers?.find(s => s.id === parseInt(supplierId));
                const product = CORE.db.products?.find(p => p.id === parseInt(productId));
                CORE.create('expenses', {
                    reference: reference,
                    type: 'purchase_order',
                    description: `Commande ${reference} - ${product?.name || 'Produit'} chez ${supplier?.name || 'Fournisseur'}`,
                    amount: totalCost,
                    supplier: supplier?.name || 'Non sp�cifi�',
                    category: 'r�approvisionnement',
                    status: 'pending',
                    purchaseOrderId: po.id,
                    createdAt: new Date().toISOString()
                });
                
                UI.closeModal();
                UI.toast('Commande cr��e: ' + reference, 'success');
                CORE.notify('success', `Nouvelle commande cr��e: ${reference} chez ${supplier?.name || 'Fournisseur'} - ${CORE.formatPrice(totalCost)}`, { purchaseOrderId: po.id });
                App.rerender();
            };
            
            let pendingFiles = 0;
            if (imageFile) pendingFiles++;
            if (videoFile) pendingFiles++;
            
            if (pendingFiles === 0) {
                createOrder();
                return;
            }
            
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageBase64 = e.target.result;
                    pendingFiles--;
                    if (pendingFiles === 0) createOrder();
                };
                reader.readAsDataURL(imageFile);
            }
            
            if (videoFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    videoBase64 = e.target.result;
                    pendingFiles--;
                    if (pendingFiles === 0) createOrder();
                };
                reader.readAsDataURL(videoFile);
            }
        },

        renderToolbox() {
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const posId = CORE.state.currentUser?.pos;
            
            // === DONN�ES EN TEMPS R�EL ===
            const todayOrders = (CORE.db.orders || []).filter(o => {
                const d = new Date(o.createdAt);
                return o.posId === posId && d >= startOfDay;
            });
            const pendingOrders = todayOrders.filter(o => ['pending', 'confirmed'].includes(o.status));
            const todayRevenue = todayOrders.filter(o => o.status === 'completed').reduce((s, o) => s + (o.totalAmount || 0), 0);
            
            const allDeliveries = CORE.db.deliveries || [];
            const pendingDeliveries = allDeliveries.filter(d => d.status === 'pending');
            const inProgressDeliveries = allDeliveries.filter(d => ['assigned', 'en_route', 'picked_up'].includes(d.status));
            const lateDeliveries = allDeliveries.filter(d => {
                if (!['assigned', 'en_route'].includes(d.status)) return false;
                const assigned = new Date(d.assignedAt || d.createdAt);
                return (now - assigned) > 45 * 60 * 1000; // > 45 min
            });
            
            const livreurs = (CORE.db.users || []).filter(u => u.active && u.role === 'livreur');
            const vendeurs = (CORE.db.users || []).filter(u => u.active && u.role === 'vendeur');
            const busyLivreurs = livreurs.filter(l => inProgressDeliveries.some(d => d.livreurId === l.id));
            const freeLivreurs = livreurs.filter(l => !inProgressDeliveries.some(d => d.livreurId === l.id));
            
            const lowStockProducts = (CORE.db.products || []).filter(p => {
                const posStock = (p.stockByPos || {})[posId] || p.stock || 0;
                return posStock <= (p.minStock || 5) && posStock > 0;
            });
            const outOfStock = (CORE.db.products || []).filter(p => {
                const posStock = (p.stockByPos || {})[posId] || p.stock || 0;
                return posStock <= 0;
            });
            
            const openIncidents = (CORE.db.incidents || []).filter(i => !i.resolved && i.posId === posId);
            const urgentIncidents = openIncidents.filter(i => i.priority === 'high' || i.priority === 'critical');
            
            const pendingTransfers = (CORE.db.transferReceipts || []).filter(t => t.status === 'pending' && t.toPosId === posId);
            
            // === ALERTES PRIORITAIRES ===
            const alerts = [];
            if (lateDeliveries.length > 0) alerts.push({ type: 'critical', icon: '��Ÿš �', text: `${lateDeliveries.length} livraison(s) en retard (>45min)`, action: 'ManagerModule.showLateDeliveriesModal()' });
            if (urgentIncidents.length > 0) alerts.push({ type: 'critical', icon: '��š ��� � �', text: `${urgentIncidents.length} incident(s) urgent(s) non r�solu(s)`, action: 'ManagerModule.showUrgentIncidentsModal()' });
            if (outOfStock.length > 0) alerts.push({ type: 'warning', icon: '��Ÿ? �', text: `${outOfStock.length} produit(s) en rupture de stock`, action: 'ManagerModule.showOutOfStockModal()' });
            if (pendingDeliveries.length > 5) alerts.push({ type: 'warning', icon: '�� � �', text: `${pendingDeliveries.length} livraisons en attente d'assignation`, action: 'ManagerModule.showQuickAssignModal()' });
            if (freeLivreurs.length === 0 && pendingDeliveries.length > 0) alerts.push({ type: 'warning', icon: '��Ÿ? �', text: 'Tous les livreurs sont occup�s!', action: null });
            if (pendingTransfers.length > 0) alerts.push({ type: 'info', icon: '��Ÿ? �', text: `${pendingTransfers.length} transfert(s) de stock �� r�ceptionner`, action: 'ManagerModule.showPendingTransfersModal()' });
            
            // === T�??CHES DU JOUR ===
            const tasks = this.getDailyTasks();
            
            // === PERFORMANCE LIVREURS ===
            const livreurPerf = livreurs.map(l => {
                const hisDeliveries = allDeliveries.filter(d => d.livreurId === l.id);
                const todayDel = hisDeliveries.filter(d => new Date(d.completedAt || d.createdAt) >= startOfDay);
                const completed = todayDel.filter(d => d.status === 'livree').length;
                const failed = todayDel.filter(d => ['failed', 'returned'].includes(d.status)).length;
                const inProgress = inProgressDeliveries.filter(d => d.livreurId === l.id).length;
                const avgTime = this.calculateAvgDeliveryTime(l.id);
                return { ...l, completed, failed, inProgress, avgTime, score: completed * 10 - failed * 5 };
            }).sort((a, b) => b.score - a.score);
            
            // === SUGGESTIONS INTELLIGENTES ===
            const suggestions = this.generateSmartSuggestions({ pendingDeliveries, freeLivreurs, lowStockProducts, lateDeliveries, todayOrders, livreurPerf });
            
            return `
                <div class="max-w-7xl mx-auto space-y-6 fade-in p-6">
                    <!-- Header -->
                    <header class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">��ŸŽ � Centre de Commande</h2>
                            <p class="text-slate-500 font-medium">Pilotez votre journ�e efficacement �� ?� � ${now.toLocaleDateString('fr-FR')} ${now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</p>
                        </div>
                        <button onclick="App.rerender()" class="px-4 py-2 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition flex items-center gap-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i> Actualiser
                        </button>
                    </header>

                    <!-- KPIs temps r�el -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-4 text-white">
                            <div class="text-blue-200 text-xs font-bold">Commandes</div>
                            <div class="text-3xl font-black">${todayOrders.length}</div>
                            <div class="text-xs text-blue-200">${pendingOrders.length} en attente</div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-4 text-white">
                            <div class="text-emerald-200 text-xs font-bold">Revenu jour</div>
                            <div class="text-2xl font-black">${CORE.formatPrice(todayRevenue)}</div>
                            <div class="text-xs text-emerald-200">confirm�</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl p-4 text-white">
                            <div class="text-amber-200 text-xs font-bold">Livraisons</div>
                            <div class="text-3xl font-black">${inProgressDeliveries.length}</div>
                            <div class="text-xs text-amber-200">${pendingDeliveries.length} �� assigner</div>
                        </div>
                        <div class="bg-gradient-to-br from-violet-500 to-purple-600 rounded-2xl p-4 text-white">
                            <div class="text-violet-200 text-xs font-bold">Livreurs</div>
                            <div class="text-3xl font-black">${freeLivreurs.length}/${livreurs.length}</div>
                            <div class="text-xs text-violet-200">disponibles</div>
                        </div>
                        <div class="bg-gradient-to-br ${lowStockProducts.length > 5 ? 'from-red-500 to-red-600' : 'from-slate-500 to-slate-600'} rounded-2xl p-4 text-white">
                            <div class="text-slate-200 text-xs font-bold">Stock faible</div>
                            <div class="text-3xl font-black">${lowStockProducts.length}</div>
                            <div class="text-xs text-slate-200">${outOfStock.length} ruptures</div>
                        </div>
                        <div class="bg-gradient-to-br ${openIncidents.length > 0 ? 'from-rose-500 to-pink-600' : 'from-teal-500 to-teal-600'} rounded-2xl p-4 text-white">
                            <div class="text-rose-200 text-xs font-bold">Incidents</div>
                            <div class="text-3xl font-black">${openIncidents.length}</div>
                            <div class="text-xs text-rose-200">${urgentIncidents.length} urgents</div>
                        </div>
                    </div>

                    ${alerts.length > 0 ? `
                    <!-- Alertes prioritaires -->
                    <div class="bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-200 rounded-2xl p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center animate-pulse">
                                <i data-lucide="alert-triangle" class="w-4 h-4 text-white"></i>
                            </div>
                            <h3 class="font-black text-red-900">��Ÿš � Alertes prioritaires (${alerts.length})</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            ${alerts.map(a => `
                                <div class="flex items-center justify-between p-3 ${a.type === 'critical' ? 'bg-red-100 border-red-300' : a.type === 'warning' ? 'bg-amber-100 border-amber-300' : 'bg-blue-100 border-blue-300'} border rounded-xl">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xl">${a.icon}</span>
                                        <span class="font-bold text-sm ${a.type === 'critical' ? 'text-red-800' : a.type === 'warning' ? 'text-amber-800' : 'text-blue-800'}">${a.text}</span>
                                    </div>
                                    ${a.action ? `<button onclick="${a.action}" class="px-3 py-1 ${a.type === 'critical' ? 'bg-red-600' : a.type === 'warning' ? 'bg-amber-600' : 'bg-blue-600'} text-white text-xs font-black rounded-lg">Traiter</button>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : `
                    <div class="bg-gradient-to-r from-emerald-50 to-teal-50 border-2 border-emerald-200 rounded-2xl p-4 flex items-center gap-3">
                        <div class="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center">
                            <i data-lucide="check-circle" class="w-5 h-5 text-white"></i>
                        </div>
                        <div>
                            <div class="font-black text-emerald-900">���? � Tout va bien!</div>
                            <div class="text-sm text-emerald-700">Aucune alerte prioritaire pour le moment</div>
                        </div>
                    </div>
                    `}

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Colonne 1: T��ches du jour -->
                        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-4 bg-gradient-to-r from-indigo-500 to-purple-600 text-white">
                                <div class="flex items-center justify-between">
                                    <div class="font-black">��Ÿ?� T��ches du jour</div>
                                    <div class="text-xs bg-white/20 px-2 py-1 rounded-lg">${tasks.filter(t => t.done).length}/${tasks.length}</div>
                                </div>
                            </div>
                            <div class="p-4 space-y-2 max-h-80 overflow-y-auto">
                                ${tasks.map((task, i) => `
                                    <div class="flex items-center gap-3 p-3 ${task.done ? 'bg-emerald-50 border-emerald-200' : 'bg-slate-50 border-slate-200'} border rounded-xl cursor-pointer hover:shadow-sm transition" onclick="ManagerModule.toggleTask(${i})">
                                        <div class="w-6 h-6 rounded-full ${task.done ? 'bg-emerald-500' : 'border-2 border-slate-300'} flex items-center justify-center">
                                            ${task.done ? '<i data-lucide="check" class="w-4 h-4 text-white"></i>' : ''}
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-bold text-sm ${task.done ? 'text-emerald-700 line-through' : 'text-slate-900'}">${task.text}</div>
                                            ${task.hint ? `<div class="text-xs text-slate-500">${task.hint}</div>` : ''}
                                        </div>
                                        ${task.action ? `<button onclick="event.stopPropagation(); ${task.action}" class="px-2 py-1 bg-indigo-600 text-white text-xs font-bold rounded-lg">Go</button>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            <div class="p-3 border-t border-slate-100">
                                <button onclick="ManagerModule.addCustomTask()" class="w-full py-2 border-2 border-dashed border-slate-300 text-slate-500 font-bold rounded-xl hover:border-indigo-400 hover:text-indigo-600 transition">
                                    + Ajouter une t��che
                                </button>
                            </div>
                        </div>

                        <!-- Colonne 2: Performance �quipe -->
                        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-4 bg-gradient-to-r from-emerald-500 to-teal-600 text-white">
                                <div class="flex items-center justify-between">
                                    <div class="font-black">��Ÿ �� Performance livreurs</div>
                                    <div class="text-xs bg-white/20 px-2 py-1 rounded-lg">Aujourd'hui</div>
                                </div>
                            </div>
                            <div class="p-4 space-y-2 max-h-80 overflow-y-auto">
                                ${livreurPerf.length === 0 ? `
                                    <div class="text-center py-6 text-slate-400">
                                        <i data-lucide="users" class="w-10 h-10 mx-auto mb-2 opacity-50"></i>
                                        <div class="text-sm">Aucun livreur actif</div>
                                    </div>
                                ` : livreurPerf.map((l, i) => `
                                    <div class="flex items-center gap-3 p-3 ${l.inProgress > 0 ? 'bg-amber-50 border-amber-200' : 'bg-slate-50 border-slate-200'} border rounded-xl">
                                        <div class="w-8 h-8 rounded-full ${i === 0 ? 'bg-yellow-400' : i === 1 ? 'bg-slate-300' : i === 2 ? 'bg-amber-600' : 'bg-slate-200'} flex items-center justify-center font-black text-sm ${i < 3 ? 'text-white' : 'text-slate-600'}">
                                            ${i < 3 ? ['��Ÿ ��','��Ÿ ��?','��Ÿ ��'][i] : i + 1}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-sm text-slate-900 truncate">${l.name}</div>
                                            <div class="text-xs text-slate-500">${l.inProgress > 0 ? `��Ÿš � ${l.inProgress} en cours` : '���?� Disponible'}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-emerald-600">${l.completed}</div>
                                            <div class="text-[10px] text-slate-400">livr�es</div>
                                        </div>
                                        ${l.failed > 0 ? `<div class="text-right"><div class="font-black text-red-500">${l.failed}</div><div class="text-[10px] text-slate-400">�checs</div></div>` : ''}
                                        ${l.avgTime ? `<div class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-lg">${l.avgTime}min</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Colonne 3: Suggestions intelligentes -->
                        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white">
                                <div class="flex items-center justify-between">
                                    <div class="font-black">��Ÿ? � Suggestions IA</div>
                                    <div class="text-xs bg-white/20 px-2 py-1 rounded-lg">${suggestions.length} actions</div>
                                </div>
                            </div>
                            <div class="p-4 space-y-2 max-h-80 overflow-y-auto">
                                ${suggestions.length === 0 ? `
                                    <div class="text-center py-6 text-slate-400">
                                        <div class="text-4xl mb-2">��ŸŽ�</div>
                                        <div class="text-sm">Tout est optimal!</div>
                                    </div>
                                ` : suggestions.map(s => `
                                    <div class="p-3 ${s.priority === 'high' ? 'bg-red-50 border-red-200' : s.priority === 'medium' ? 'bg-amber-50 border-amber-200' : 'bg-blue-50 border-blue-200'} border rounded-xl">
                                        <div class="flex items-start gap-2">
                                            <span class="text-lg">${s.icon}</span>
                                            <div class="flex-1">
                                                <div class="font-bold text-sm text-slate-900">${s.title}</div>
                                                <div class="text-xs text-slate-600 mt-1">${s.description}</div>
                                                ${s.action ? `<button onclick="${s.action}" class="mt-2 px-3 py-1 bg-slate-900 text-white text-xs font-bold rounded-lg hover:bg-slate-800">${s.actionLabel || 'Appliquer'}</button>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Actions rapides -->
                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4">
                        <h3 class="font-black text-slate-900 mb-4">��š � Actions rapides</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                            <button onclick="ManagerModule.showQuickAssignModal()" class="p-4 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-xl transition text-center group">
                                <div class="w-10 h-10 bg-blue-500 rounded-xl mx-auto mb-2 flex items-center justify-center group-hover:scale-110 transition">
                                    <i data-lucide="user-plus" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="font-bold text-sm text-slate-900">Assigner</div>
                                <div class="text-xs text-blue-600">${pendingDeliveries.length} en attente</div>
                            </button>
                            <button onclick="ManagerModule.showQuickRecallModal()" class="p-4 bg-amber-50 hover:bg-amber-100 border border-amber-200 rounded-xl transition text-center group">
                                <div class="w-10 h-10 bg-amber-500 rounded-xl mx-auto mb-2 flex items-center justify-center group-hover:scale-110 transition">
                                    <i data-lucide="rotate-ccw" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="font-bold text-sm text-slate-900">Rappeler</div>
                                <div class="text-xs text-amber-600">${inProgressDeliveries.length} en cours</div>
                            </button>
                            <button onclick="ManagerModule.showLowStockModal()" class="p-4 bg-red-50 hover:bg-red-100 border border-red-200 rounded-xl transition text-center group">
                                <div class="w-10 h-10 bg-red-500 rounded-xl mx-auto mb-2 flex items-center justify-center group-hover:scale-110 transition">
                                    <i data-lucide="package-x" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="font-bold text-sm text-slate-900">Stock</div>
                                <div class="text-xs text-red-600">${lowStockProducts.length + outOfStock.length} alertes</div>
                            </button>
                            <button onclick="ManagerModule.showTeamStatusModal()" class="p-4 bg-purple-50 hover:bg-purple-100 border border-purple-200 rounded-xl transition text-center group">
                                <div class="w-10 h-10 bg-purple-500 rounded-xl mx-auto mb-2 flex items-center justify-center group-hover:scale-110 transition">
                                    <i data-lucide="users" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="font-bold text-sm text-slate-900">�quipe</div>
                                <div class="text-xs text-purple-600">${livreurs.length + vendeurs.length} actifs</div>
                            </button>
                            <button onclick="ManagerModule.showDailySummaryModal()" class="p-4 bg-teal-50 hover:bg-teal-100 border border-teal-200 rounded-xl transition text-center group">
                                <div class="w-10 h-10 bg-teal-500 rounded-xl mx-auto mb-2 flex items-center justify-center group-hover:scale-110 transition">
                                    <i data-lucide="bar-chart-3" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="font-bold text-sm text-slate-900">Bilan</div>
                                <div class="text-xs text-teal-600">R�sum� jour</div>
                            </button>
                            <button onclick="ManagerModule.showQuickContactModal()" class="p-4 bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 rounded-xl transition text-center group">
                                <div class="w-10 h-10 bg-emerald-500 rounded-xl mx-auto mb-2 flex items-center justify-center group-hover:scale-110 transition">
                                    <i data-lucide="phone" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="font-bold text-sm text-slate-900">Contacter</div>
                                <div class="text-xs text-emerald-600">Appel rapide</div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        },

        // === FONCTIONS UTILITAIRES CENTRE DE COMMANDE ===
        getDailyTasks() {
            const stored = localStorage.getItem('manager_daily_tasks_' + new Date().toDateString());
            let tasks = stored ? JSON.parse(stored) : null;
            
            if (!tasks) {
                const posId = CORE.state.currentUser?.pos;
                const pendingDeliveries = (CORE.db.deliveries || []).filter(d => d.status === 'pending').length;
                const lowStock = (CORE.db.products || []).filter(p => ((p.stockByPos || {})[posId] || p.stock || 0) <= (p.minStock || 5)).length;
                
                tasks = [
                    { text: 'V�rifier les commandes en attente', hint: `${pendingDeliveries} livraisons �� assigner`, done: false, action: "ManagerModule.showQuickAssignModal()" },
                    { text: 'Contr��ler les stocks bas', hint: `${lowStock} produits en alerte`, done: false, action: "ManagerModule.showLowStockModal()" },
                    { text: 'V�rifier la disponibilit� livreurs', hint: 'Qui est disponible?', done: false, action: "ManagerModule.showTeamStatusModal()" },
                    { text: 'R�pondre aux incidents ouverts', done: false },
                    { text: 'Faire le point �quipe (10h)', done: false },
                    { text: 'V�rifier caisse/paiements', done: false, action: "ManagerModule.setCurrentView('payments')" },
                    { text: 'Bilan mi-journ�e (14h)', done: false, action: "ManagerModule.showDailySummaryModal()" },
                    { text: 'Cl��ture journ�e', done: false }
                ];
            }
            return tasks;
        },

        toggleTask(index) {
            const tasks = this.getDailyTasks();
            if (tasks[index]) {
                tasks[index].done = !tasks[index].done;
                localStorage.setItem('manager_daily_tasks_' + new Date().toDateString(), JSON.stringify(tasks));
                App.rerender();
            }
        },

        addCustomTask() {
            UI.modal('��ž� Ajouter une t��che', `
                <input id="custom_task" type="text" placeholder="Description de la t��che..." class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium">
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Ajouter', onclick: 'ManagerModule.saveCustomTask()', class: 'bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-black hover:bg-indigo-700' }
            ]);
        },

        saveCustomTask() {
            const text = UI.val('custom_task');
            if (!text) return UI.toast('Entrez une t��che', 'warning');
            
            const tasks = this.getDailyTasks();
            tasks.push({ text, done: false, custom: true });
            localStorage.setItem('manager_daily_tasks_' + new Date().toDateString(), JSON.stringify(tasks));
            UI.closeModal();
            UI.toast('T��che ajout�e', 'success');
            App.rerender();
        },

        calculateAvgDeliveryTime(livreurId) {
            const completed = (CORE.db.deliveries || []).filter(d => 
                d.livreurId === livreurId && 
                d.status === 'livree' && 
                d.assignedAt && 
                d.completedAt
            ).slice(-10);
            
            if (completed.length === 0) return null;
            
            const avgMs = completed.reduce((sum, d) => {
                return sum + (new Date(d.completedAt) - new Date(d.assignedAt));
            }, 0) / completed.length;
            
            return Math.round(avgMs / 60000);
        },

        generateSmartSuggestions({ pendingDeliveries, freeLivreurs, lowStockProducts, lateDeliveries, todayOrders, livreurPerf }) {
            const suggestions = [];
            
            // Suggestion: Assigner les livraisons en attente aux livreurs libres
            if (pendingDeliveries.length > 0 && freeLivreurs.length > 0) {
                const bestLivreur = livreurPerf.find(l => !l.inProgress);
                suggestions.push({
                    icon: '��ŸŽ �',
                    title: 'Optimiser les assignations',
                    description: `${pendingDeliveries.length} livraison(s) peuvent ��tre assign�es �� ${freeLivreurs.length} livreur(s) disponible(s). ${bestLivreur ? `Recommand�: ${bestLivreur.name}` : ''}`,
                    priority: 'high',
                    action: 'ManagerModule.showQuickAssignModal()',
                    actionLabel: 'Assigner'
                });
            }
            
            // Suggestion: R�assigner les livraisons en retard
            if (lateDeliveries.length > 0) {
                suggestions.push({
                    icon: '��š �',
                    title: 'R�assigner livraisons en retard',
                    description: `${lateDeliveries.length} livraison(s) sont en retard. Envisagez de les r�assigner �� un livreur plus proche.`,
                    priority: 'high',
                    action: 'ManagerModule.showLateDeliveriesModal()',
                    actionLabel: 'Voir'
                });
            }
            
            // Suggestion: R�approvisionner le stock
            if (lowStockProducts.length > 3) {
                suggestions.push({
                    icon: '��Ÿ? �',
                    title: 'Commander du stock',
                    description: `${lowStockProducts.length} produits sont en stock faible. Passez une commande fournisseur.`,
                    priority: 'medium',
                    action: 'ManagerModule.showLowStockModal()',
                    actionLabel: 'Voir produits'
                });
            }
            
            // Suggestion: Heure de pointe
            const hour = new Date().getHours();
            if (hour >= 11 && hour <= 13 && pendingDeliveries.length > 3) {
                suggestions.push({
                    icon: '��Ÿ� �',
                    title: 'Rush du midi d�tect�!',
                    description: 'P�riode de forte activit�. Assurez-vous que tous les livreurs sont mobilis�s.',
                    priority: 'medium'
                });
            }
            
            // Suggestion: Performance livreur
            const underperformer = livreurPerf.find(l => l.failed > 2);
            if (underperformer) {
                suggestions.push({
                    icon: '��Ÿ? �',
                    title: `V�rifier ${underperformer.name}`,
                    description: `${underperformer.failed} �checs aujourd'hui. Un suivi pourrait ��tre n�cessaire.`,
                    priority: 'low'
                });
            }
            
            // Suggestion: Bonne performance
            if (todayOrders.length > 20 && livreurPerf.every(l => l.failed === 0)) {
                suggestions.push({
                    icon: '��Ÿ�?Ÿ',
                    title: 'Excellente journ�e!',
                    description: `${todayOrders.length} commandes trait�es sans �chec. F�licitez votre �quipe!`,
                    priority: 'low'
                });
            }
            
            return suggestions;
        },

        showLateDeliveriesModal() {
            const now = new Date();
            const lateDeliveries = (CORE.db.deliveries || []).filter(d => {
                if (!['assigned', 'en_route'].includes(d.status)) return false;
                const assigned = new Date(d.assignedAt || d.createdAt);
                return (now - assigned) > 45 * 60 * 1000;
            });
            
            UI.modal('��Ÿš � Livraisons en retard', `
                <div class="space-y-3 max-h-96 overflow-y-auto">
                    ${lateDeliveries.map(d => {
                        const delay = Math.round((now - new Date(d.assignedAt || d.createdAt)) / 60000);
                        return `
                        <div class="p-4 bg-red-50 border border-red-200 rounded-xl">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-black text-red-900">${d.orderRef}</div>
                                    <div class="text-sm text-red-700">Livreur: ${d.livreurName || 'N/A'}</div>
                                    <div class="text-sm text-red-600">Client: ${d.customerName || 'N/A'}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-black text-red-600">${delay}min</div>
                                    <div class="text-xs text-red-500">de retard</div>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button onclick="ManagerModule.callUser(${d.livreurId})" class="flex-1 py-2 bg-amber-500 text-white font-bold rounded-lg text-sm">��Ÿ?ž Appeler</button>
                                <button onclick="ManagerModule.reassignDelivery(${d.id})" class="flex-1 py-2 bg-red-600 text-white font-bold rounded-lg text-sm">��Ÿ�? R�assigner</button>
                            </div>
                        </div>
                        `;
                    }).join('')}
                    ${lateDeliveries.length === 0 ? '<div class="text-center py-6 text-slate-400">Aucune livraison en retard ��ŸŽ�</div>' : ''}
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showUrgentIncidentsModal() {
            const posId = CORE.state.currentUser?.pos;
            const urgentIncidents = (CORE.db.incidents || []).filter(i => 
                !i.resolved && i.posId === posId && (i.priority === 'high' || i.priority === 'critical')
            );
            
            UI.modal('��š ��� � � Incidents urgents', `
                <div class="space-y-3 max-h-96 overflow-y-auto">
                    ${urgentIncidents.map(i => `
                        <div class="p-4 bg-amber-50 border border-amber-200 rounded-xl">
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-black text-amber-900">${i.title || i.type}</div>
                                <span class="px-2 py-1 ${i.priority === 'critical' ? 'bg-red-500' : 'bg-amber-500'} text-white text-xs font-bold rounded-lg">${i.priority}</span>
                            </div>
                            <div class="text-sm text-amber-700">${i.description || ''}</div>
                            <div class="text-xs text-amber-600 mt-2">Cr��: ${new Date(i.createdAt).toLocaleString('fr-FR')}</div>
                        </div>
                    `).join('')}
                    ${urgentIncidents.length === 0 ? '<div class="text-center py-6 text-slate-400">Aucun incident urgent ��ŸŽ�</div>' : ''}
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showOutOfStockModal() {
            const posId = CORE.state.currentUser?.pos;
            const outOfStock = (CORE.db.products || []).filter(p => {
                const posStock = (p.stockByPos || {})[posId] || p.stock || 0;
                return posStock <= 0;
            });
            
            UI.modal('��Ÿ? � Ruptures de stock', `
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    ${outOfStock.map(p => `
                        <div class="flex items-center justify-between p-3 bg-red-50 border border-red-200 rounded-xl">
                            <div>
                                <div class="font-bold text-red-900">${p.name}</div>
                                <div class="text-xs text-red-600">${p.category || 'Sans cat�gorie'}</div>
                            </div>
                            <span class="px-3 py-1 bg-red-600 text-white text-xs font-black rounded-lg">RUPTURE</span>
                        </div>
                    `).join('')}
                    ${outOfStock.length === 0 ? '<div class="text-center py-6 text-slate-400">Aucune rupture de stock ��ŸŽ�</div>' : ''}
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showLowStockModal() {
            const posId = CORE.state.currentUser?.pos;
            const products = (CORE.db.products || []).filter(p => {
                const posStock = (p.stockByPos || {})[posId] || p.stock || 0;
                return posStock <= (p.minStock || 5);
            }).sort((a, b) => {
                const stockA = (a.stockByPos || {})[posId] || a.stock || 0;
                const stockB = (b.stockByPos || {})[posId] || b.stock || 0;
                return stockA - stockB;
            });
            
            UI.modal('��Ÿ? � Alertes stock', `
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    ${products.map(p => {
                        const stock = (p.stockByPos || {})[posId] || p.stock || 0;
                        const isOut = stock <= 0;
                        return `
                        <div class="flex items-center justify-between p-3 ${isOut ? 'bg-red-50 border-red-200' : 'bg-amber-50 border-amber-200'} border rounded-xl">
                            <div>
                                <div class="font-bold ${isOut ? 'text-red-900' : 'text-amber-900'}">${p.name}</div>
                                <div class="text-xs ${isOut ? 'text-red-600' : 'text-amber-600'}">${p.category || 'Sans cat�gorie'}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-black text-lg ${isOut ? 'text-red-600' : 'text-amber-600'}">${stock}</div>
                                <div class="text-xs text-slate-500">min: ${p.minStock || 5}</div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                    ${products.length === 0 ? '<div class="text-center py-6 text-slate-400">Stock optimal! ��ŸŽ�</div>' : ''}
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showTeamStatusModal() {
            const livreurs = (CORE.db.users || []).filter(u => u.active && u.role === 'livreur');
            const vendeurs = (CORE.db.users || []).filter(u => u.active && u.role === 'vendeur');
            const inProgress = (CORE.db.deliveries || []).filter(d => ['assigned', 'en_route', 'picked_up'].includes(d.status));
            
            UI.modal('��Ÿ? � Statut �quipe', `
                <div class="space-y-4">
                    <div>
                        <div class="text-xs font-black text-slate-600 uppercase mb-2">��Ÿš � Livreurs (${livreurs.length})</div>
                        <div class="space-y-2">
                            ${livreurs.map(l => {
                                const busy = inProgress.filter(d => d.livreurId === l.id);
                                return `
                                <div class="flex items-center justify-between p-3 ${busy.length > 0 ? 'bg-amber-50 border-amber-200' : 'bg-emerald-50 border-emerald-200'} border rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full ${busy.length > 0 ? 'bg-amber-500' : 'bg-emerald-500'} flex items-center justify-center text-white font-bold">
                                            ${l.name.slice(0, 2).toUpperCase()}
                                        </div>
                                        <div>
                                            <div class="font-bold text-slate-900">${l.name}</div>
                                            <div class="text-xs ${busy.length > 0 ? 'text-amber-600' : 'text-emerald-600'}">
                                                ${busy.length > 0 ? `��Ÿš � ${busy.length} livraison(s) en cours` : '���?� Disponible'}
                                            </div>
                                        </div>
                                    </div>
                                    <button onclick="ManagerModule.callUser(${l.id})" class="px-3 py-1 bg-slate-900 text-white text-xs font-bold rounded-lg">��Ÿ?ž</button>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    <div>
                        <div class="text-xs font-black text-slate-600 uppercase mb-2">��Ÿ�? Vendeurs (${vendeurs.length})</div>
                        <div class="space-y-2">
                            ${vendeurs.map(v => `
                                <div class="flex items-center justify-between p-3 bg-blue-50 border border-blue-200 rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">
                                            ${v.name.slice(0, 2).toUpperCase()}
                                        </div>
                                        <div class="font-bold text-slate-900">${v.name}</div>
                                    </div>
                                    <button onclick="ManagerModule.callUser(${v.id})" class="px-3 py-1 bg-slate-900 text-white text-xs font-bold rounded-lg">��Ÿ?ž</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showDailySummaryModal() {
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const posId = CORE.state.currentUser?.pos;
            
            const todayOrders = (CORE.db.orders || []).filter(o => {
                const d = new Date(o.createdAt);
                return o.posId === posId && d >= startOfDay;
            });
            const completedOrders = todayOrders.filter(o => o.status === 'completed');
            const revenue = completedOrders.reduce((s, o) => s + (o.totalAmount || 0), 0);
            
            const todayDeliveries = (CORE.db.deliveries || []).filter(d => {
                const dt = new Date(d.completedAt || d.createdAt);
                return dt >= startOfDay;
            });
            const delivered = todayDeliveries.filter(d => d.status === 'livree').length;
            const failed = todayDeliveries.filter(d => ['failed', 'returned'].includes(d.status)).length;
            
            const successRate = todayDeliveries.length > 0 ? Math.round((delivered / todayDeliveries.length) * 100) : 0;
            
            UI.modal('��Ÿ?Š Bilan de la journ�e', `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl text-center">
                            <div class="text-3xl font-black text-blue-600">${todayOrders.length}</div>
                            <div class="text-xs text-blue-700 font-bold">Commandes</div>
                        </div>
                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl text-center">
                            <div class="text-2xl font-black text-emerald-600">${CORE.formatPrice(revenue)}</div>
                            <div class="text-xs text-emerald-700 font-bold">Revenu</div>
                        </div>
                        <div class="p-4 bg-teal-50 border border-teal-200 rounded-xl text-center">
                            <div class="text-3xl font-black text-teal-600">${delivered}</div>
                            <div class="text-xs text-teal-700 font-bold">Livr�es</div>
                        </div>
                        <div class="p-4 ${failed > 0 ? 'bg-red-50 border-red-200' : 'bg-slate-50 border-slate-200'} border rounded-xl text-center">
                            <div class="text-3xl font-black ${failed > 0 ? 'text-red-600' : 'text-slate-400'}">${failed}</div>
                            <div class="text-xs ${failed > 0 ? 'text-red-700' : 'text-slate-500'} font-bold">�checs</div>
                        </div>
                    </div>
                    <div class="p-4 bg-gradient-to-r from-violet-50 to-purple-50 border border-violet-200 rounded-xl">
                        <div class="text-center">
                            <div class="text-4xl font-black text-violet-600">${successRate}%</div>
                            <div class="text-sm text-violet-700 font-bold">Taux de r�ussite livraison</div>
                            <div class="w-full h-3 bg-violet-200 rounded-full mt-3 overflow-hidden">
                                <div class="h-full bg-violet-600 rounded-full" style="width: ${successRate}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showQuickContactModal() {
            const users = (CORE.db.users || []).filter(u => u.active && u.phone);
            
            UI.modal('��Ÿ?ž Contact rapide', `
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    <input type="text" id="contact_search" placeholder="Rechercher..." class="w-full px-4 py-2 border border-slate-200 rounded-xl mb-3" oninput="ManagerModule.filterContacts(this.value)">
                    <div id="contacts_list" class="space-y-2">
                        ${users.map(u => `
                            <div class="contact-item flex items-center justify-between p-3 bg-slate-50 border border-slate-200 rounded-xl hover:bg-slate-100 transition" data-name="${u.name.toLowerCase()}">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-slate-300 flex items-center justify-center text-slate-700 font-bold">
                                        ${u.name.slice(0, 2).toUpperCase()}
                                    </div>
                                    <div>
                                        <div class="font-bold text-slate-900">${u.name}</div>
                                        <div class="text-xs text-slate-500">${u.role} �� ?� � ${u.phone}</div>
                                    </div>
                                </div>
                                <button onclick="ManagerModule.callUser(${u.id}); UI.closeModal();" class="px-4 py-2 bg-emerald-600 text-white text-sm font-bold rounded-lg hover:bg-emerald-700">
                                    ��Ÿ?ž Appeler
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        filterContacts(query) {
            const items = document.querySelectorAll('.contact-item');
            items.forEach(item => {
                const name = item.dataset.name || '';
                item.style.display = name.includes(query.toLowerCase()) ? '' : 'none';
            });
        },

        showPendingTransfersModal() {
            const posId = CORE.state.currentUser?.pos;
            const transfers = (CORE.db.transferReceipts || []).filter(t => t.status === 'pending' && t.toPosId === posId);
            
            UI.modal('��Ÿ? � Transferts �� r�ceptionner', `
                <div class="space-y-3 max-h-96 overflow-y-auto">
                    ${transfers.map(t => `
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="font-black text-blue-900">${t.id}</div>
                                    <div class="text-sm text-blue-700">De: ${CORE.getPOS(t.fromPosId)?.name || 'D�p��t'}</div>
                                </div>
                                <div class="text-xs text-blue-600">${new Date(t.createdAt).toLocaleDateString('fr-FR')}</div>
                            </div>
                            <div class="text-sm text-blue-800">${(t.items || []).length} produit(s)</div>
                        </div>
                    `).join('')}
                    ${transfers.length === 0 ? '<div class="text-center py-6 text-slate-400">Aucun transfert en attente</div>' : ''}
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        reassignDelivery(deliveryId) {
            const livreurs = (CORE.db.users || []).filter(u => u.active && u.role === 'livreur');
            const delivery = (CORE.db.deliveries || []).find(d => d.id === deliveryId);
            
            UI.modal('��Ÿ�? R�assigner la livraison', `
                <div class="space-y-4">
                    <div class="p-3 bg-amber-50 border border-amber-200 rounded-xl">
                        <div class="font-bold text-amber-900">${delivery?.orderRef || 'N/A'}</div>
                        <div class="text-sm text-amber-700">Actuellement: ${delivery?.livreurName || 'N/A'}</div>
                    </div>
                    <select id="new_livreur" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium">
                        <option value="">�� ?�� Choisir nouveau livreur �� ?��</option>
                        ${livreurs.filter(l => l.id !== delivery?.livreurId).map(l => `<option value="${l.id}">${l.name}</option>`).join('')}
                    </select>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'R�assigner', onclick: `ManagerModule.executeReassign(${deliveryId})`, class: 'bg-amber-600 text-white px-5 py-2.5 rounded-xl font-black hover:bg-amber-700' }
            ]);
        },

        executeReassign(deliveryId) {
            const newLivreurId = parseInt(UI.val('new_livreur'));
            if (!newLivreurId) return UI.toast('S�lectionnez un livreur', 'warning');
            
            CORE.quickAssignDelivery(deliveryId, newLivreurId);
            UI.closeModal();
            UI.toast('Livraison r�assign�e', 'success');
            App.rerender();
        },

        showQuickAssignModal() {
            const users = CORE.db.users.filter(u => u.active && u.role === 'livreur');
            const deliveries = CORE.db.deliveries.filter(d => d.status === 'pending').slice(0, 10);

            UI.modal('��Ÿ? � Assigner une livraison', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">S�lectionner livraison</label>
                        <select id="quick_delivery" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                            <option value="">�� ?�� Choisir �� ?��</option>
                            ${deliveries.map(d => `<option value="${d.id}">${d.orderRef} �� ?� � ${d.customername || 'Client'}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Assign� ��</label>
                        <select id="quick_livreur" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                            <option value="">�� ?�� Choisir �� ?��</option>
                            ${users.map(u => `<option value="${u.id}">${u.name} �� ?� � ${u.phone || 'N/A'}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Assigner', onclick: 'ManagerModule.executeQuickAssign()', class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        executeQuickAssign() {
            const deliveryId = parseInt(UI.val('quick_delivery'));
            const userId = parseInt(UI.val('quick_livreur'));

            if (!deliveryId || !userId) {
                return UI.toast('S�lectionnez livraison et livreur', 'warning');
            }

            CORE.quickAssignDelivery(deliveryId, userId);
            UI.closeModal();
            UI.toast('Livraison assign�e avec succ��s', 'success');
            App.rerender();
        },

        showQuickRecallModal() {
            const deliveries = CORE.db.deliveries.filter(d => d.status === 'assigned').slice(0, 10);

            UI.modal('��Ÿ?ž Rappeler une livraison', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">S�lectionner livraison</label>
                        <select id="recall_delivery" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                            <option value="">�� ?�� Choisir �� ?��</option>
                            ${deliveries.map(d => `<option value="${d.id}">${d.orderRef} �� ?� � Assign�e �� ${d.livreurName}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Raison du rappel</label>
                        <textarea id="recall_reason" placeholder="D�crivez la raison du rappel..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm" rows="3"></textarea>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Rappeler', onclick: 'ManagerModule.executeQuickRecall()', class: 'px-5 py-2.5 bg-amber-600 text-white font-black rounded-xl hover:bg-amber-700 transition' }
            ]);
        },

        executeQuickRecall() {
            const deliveryId = parseInt(UI.val('recall_delivery'));
            const reason = UI.val('recall_reason');

            if (!deliveryId) {
                return UI.toast('S�lectionnez une livraison', 'warning');
            }

            CORE.quickRecallDelivery(deliveryId, reason);
            UI.closeModal();
            UI.toast('Livraison rappel�e', 'success');
            App.rerender();
        },

        showNotifyTeamModal() {
            const users = CORE.db.users.filter(u => u.active && (u.role === 'livreur' || u.role === 'vendeur'));

            UI.modal('��Ÿ? � Notifier l\'�quipe', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Type de notification</label>
                        <select id="notif_type" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                            <option value="info">��? ��� � � Information</option>
                            <option value="warning">��š ��� � � Avertissement</option>
                            <option value="alert">��Ÿš � Alerte urgente</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Titre</label>
                        <input id="notif_title" type="text" placeholder="Ex: Nouvelle promotion..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Message</label>
                        <textarea id="notif_message" placeholder="Contenu du message..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm" rows="4"></textarea>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100">
                        <input type="checkbox" id="notif_all" checked>
                        <label for="notif_all" class="text-sm font-black text-slate-700 cursor-pointer">Envoyer �� toute l'�quipe</label>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Envoyer', onclick: 'ManagerModule.executeSendNotification()', class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition' }
            ]);
        },

        executeSendNotification() {
            const type = UI.val('notif_type');
            const title = UI.val('notif_title');
            const message = UI.val('notif_message');

            if (!title || !message) {
                return UI.toast('Titre et message requis', 'warning');
            }

            const users = CORE.db.users.filter(u => u.active && (u.role === 'livreur' || u.role === 'vendeur'));
            users.forEach(u => {
                CORE.notifyUser(u.id, title, message, type);
            });

            UI.closeModal();
            UI.toast(`Notification envoy�e �� ${users.length} utilisateurs`, 'success');
            App.rerender();
        },

        showTaxesReportModal() {
            const users = CORE.db.users.filter(u => u.active && (u.role === 'vendeur' || u.role === 'livreur'));

            UI.modal('��Ÿ?Š Rapport Taxes', `
                <div class="space-y-4">
                    <div class="text-xs text-slate-600 font-bold bg-slate-50 p-3 rounded-xl">
                        S�lectionnez un utilisateur pour voir son rapport fiscal d�taill�
                    </div>
                    <select id="taxes_user" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                        <option value="">�� ?�� Choisir utilisateur �� ?��</option>
                        ${users.map(u => `<option value="${u.id}">${u.name} (${u.role})</option>`).join('')}
                    </select>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'G�n�rer rapport', onclick: 'ManagerModule.generateTaxesReport()', class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);
        },

        generateTaxesReport() {
            const userId = parseInt(UI.val('taxes_user'));
            if (!userId) return UI.toast('S�lectionnez un utilisateur', 'warning');

            const report = CORE.openTaxesReport(userId);
            if (!report) return UI.toast('Rapport non disponible', 'error');

            const headers = ['ID', 'Date', 'Type', 'Montant', 'Note'];
            const rows = report.transactions.map(t => [
                t.id,
                new Date(t.createdAt).toLocaleString('fr-FR'),
                t.type,
                `${t.amount} FCFA`,
                t.note || '�� ?��'
            ]);

            let csv = headers.join(',') + '\\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(',') + '\\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `taxes_${report.userName}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            UI.closeModal();
            UI.toast('Rapport taxes g�n�r� et t�l�charg�', 'success');
        },

        showEditTemplatesModal() {
            const templates = CORE.getMessageTemplates();
            const categorized = {
                'delivery': templates.filter(t => t.category === 'delivery'),
                'reminder': templates.filter(t => t.category === 'reminder'),
                'alert': templates.filter(t => t.category === 'alert'),
                'resolution': templates.filter(t => t.category === 'resolution')
            };

            UI.modal('���? ��� � � G�rer mod��les de messages', `
                <div class="space-y-6">
                    ${Object.entries(categorized).map(([cat, tmpls]) => `
                        <div>
                            <div class="text-sm font-black text-slate-600 uppercase mb-3">${cat === 'delivery' ? '��Ÿ? � Livraisons' : cat === 'reminder' ? '�� � � Rappels' : cat === 'alert' ? '��š ��� � � Alertes' : '���?� R�solutions'}</div>
                            <div class="space-y-2">
                                ${tmpls.map(t => `
                                    <div class="p-3 bg-slate-50 rounded-xl border border-slate-100 group hover:bg-slate-100 transition">
                                        <div class="flex items-start justify-between">
                                            <div>
                                                <div class="font-bold text-slate-900">${t.name}</div>
                                                <div class="text-xs text-slate-600 mt-1">${t.content}</div>
                                            </div>
                                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                                                <button onclick="ManagerModule.editTemplate('${t.id}')" class="px-2 py-1 bg-blue-600 text-white text-xs font-bold rounded">�diter</button>
                                                <button onclick="ManagerModule.deleteTemplate('${t.id}')" class="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded">Supprimer</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                    <button onclick="ManagerModule.showNewTemplateModal()" class="w-full py-3 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition">
                        ��ž� Ajouter mod��le
                    </button>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showSendMessageModal(templateId) {
            const template = CORE.db.messageTemplates.find(t => t.id === templateId);
            const users = CORE.db.users.filter(u => u.active && u.phone);

            UI.modal(`��Ÿ? � Envoyer: ${template?.name}`, `
                <div class="space-y-4">
                    <div class="p-3 bg-slate-50 rounded-xl border border-slate-100">
                        <div class="text-xs font-black text-slate-600 uppercase mb-2">Aper��u du message</div>
                        <div class="text-sm text-slate-700">${template?.content}</div>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Destinataire</label>
                        <select id="msg_recipient" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                            <option value="">�� ?�� Choisir �� ?��</option>
                            ${users.map(u => `<option value="${u.id}">${u.name} (${u.phone})</option>`).join('')}
                        </select>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Envoyer', onclick: `ManagerModule.executeSendMessage('${templateId}')`, class: 'px-5 py-2.5 bg-green-600 text-white font-black rounded-xl hover:bg-green-700 transition' }
            ]);
        },

        executeSendMessage(templateId) {
            const recipientId = parseInt(UI.val('msg_recipient'));
            if (!recipientId) return UI.toast('S�lectionnez un destinataire', 'warning');

            CORE.sendMessage(recipientId, templateId, {});
            UI.closeModal();
            UI.toast('Message envoy�', 'success');
            App.rerender();
        },

        callUser(userId) {
            const user = CORE.getUser(userId);
            if (!user || !user.phone) {
                return UI.toast('Num�ro non disponible', 'error');
            }

            CORE.initiateCall(userId, 'Appel depuis la Bo��te �� Outils');
            UI.toast(`Appel �� ${user.name} via ${user.phone}`, 'success');
        },

        showNewTemplateModal() {
            UI.modal('��ž� Ajouter mod��le de message', `
                <div class="space-y-4">
                    <input id="new_tpl_name" type="text" placeholder="Nom du mod��le..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                    <select id="new_tpl_type" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                        <option value="sms">SMS</option>
                        <option value="whatsapp">WhatsApp</option>
                    </select>
                    <select id="new_tpl_cat" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                        <option value="delivery">Livraison</option>
                        <option value="reminder">Rappel</option>
                        <option value="alert">Alerte</option>
                        <option value="resolution">R�solution</option>
                    </select>
                    <textarea id="new_tpl_content" placeholder="Contenu (utilisez {{variable}} pour les variables)..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm" rows="4"></textarea>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Cr�er', onclick: 'ManagerModule.createNewTemplate()', class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        createNewTemplate() {
            const name = UI.val('new_tpl_name');
            const type = UI.val('new_tpl_type');
            const category = UI.val('new_tpl_cat');
            const content = UI.val('new_tpl_content');

            if (!name || !type || !category || !content) {
                return UI.toast('Tous les champs sont requis', 'warning');
            }

            CORE.saveMessageTemplate({ name, type, category, content, variables: [] });
            UI.closeModal();
            UI.toast('Mod��le cr��', 'success');
            App.rerender();
        },

        editTemplate(templateId) {
            UI.toast('�dition en construction', 'info');
        },

        deleteTemplate(templateId) {
            if (!confirm('Supprimer ce mod��le?')) return;
            CORE.db.messageTemplates = CORE.db.messageTemplates.filter(t => t.id !== templateId);
            CORE.save();
            UI.toast('Mod��le supprim�', 'success');
            App.rerender();
        },

        showSettingsModal() {
            const user = CORE.state.currentUser;
            const cities = CORE.db.cities || [];
            const pos = CORE.db.pointsOfSale || [];
            
            UI.modal('��š ?��� � � Param��tres Manager', `
                <div class="space-y-4">
                    <!-- Header gradient -->
                    <div class="relative -mx-6 -mt-4 px-6 py-6 bg-gradient-to-br from-blue-600 via-sky-600 to-cyan-700 overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
                        <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full translate-y-1/2 -translate-x-1/2"></div>
                        <div class="relative flex items-center gap-4">
                            <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center shadow-xl">
                                <i data-lucide="settings" class="w-7 h-7 text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-black text-white">Centre de Contr��le</h2>
                                <p class="text-sky-200 text-sm">Personnalisez votre exp�rience</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabs de navigation -->
                    <div class="flex border-b border-slate-200 -mx-6 px-4 gap-1">
                        <button onclick="ManagerModule.switchSettingsTab('general')" id="mgr-tab-general" class="flex-1 px-4 py-3 text-xs font-bold text-sky-600 border-b-2 border-sky-500 bg-sky-50/50 flex items-center justify-center gap-2 rounded-t-lg">
                            <i data-lucide="sliders" class="w-4 h-4"></i>
                            G�n�ral
                        </button>
                        <button onclick="ManagerModule.switchSettingsTab('appearance')" id="mgr-tab-appearance" class="flex-1 px-4 py-3 text-xs font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 flex items-center justify-center gap-2 transition rounded-t-lg">
                            <i data-lucide="palette" class="w-4 h-4"></i>
                            Apparence
                        </button>
                        <button onclick="ManagerModule.switchSettingsTab('profile')" id="mgr-tab-profile" class="flex-1 px-4 py-3 text-xs font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 flex items-center justify-center gap-2 transition rounded-t-lg">
                            <i data-lucide="user" class="w-4 h-4"></i>
                            Profil
                        </button>
                    </div>
                    
                    <!-- Contenu des tabs -->
                    <div class="max-h-[55vh] overflow-y-auto pr-1">
                        
                        <!-- Tab: G�n�ral -->
                        <div id="mgr-content-general" class="space-y-5">
                            <!-- Imprimante -->
                            <div class="p-4 rounded-2xl bg-gradient-to-r from-slate-50 to-gray-50 border border-slate-200">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-11 h-11 bg-gradient-to-br from-slate-600 to-gray-700 rounded-xl flex items-center justify-center shadow-lg">
                                            <i data-lucide="printer" class="w-5 h-5 text-white"></i>
                                        </div>
                                        <div>
                                            <div class="font-black text-slate-800">Imprimante</div>
                                            <div class="text-xs text-slate-500">Non connect�e</div>
                                        </div>
                                    </div>
                                    <button onclick="UI.toast('Recherche imprimante...', 'info')" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-xl text-xs font-black hover:bg-slate-300 transition">
                                        Configurer
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Notifications -->
                            <div class="p-4 rounded-2xl bg-gradient-to-r from-rose-50 to-pink-50 border border-rose-200">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-11 h-11 bg-gradient-to-br from-rose-500 to-pink-600 rounded-xl flex items-center justify-center shadow-lg shadow-rose-200">
                                            <i data-lucide="bell" class="w-5 h-5 text-white"></i>
                                        </div>
                                        <div>
                                            <div class="font-black text-slate-800">Notifications</div>
                                            <div class="text-xs text-slate-500">Alertes en temps r�el</div>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" checked class="sr-only peer">
                                        <div class="w-14 h-7 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all after:shadow-md peer-checked:bg-sky-500"></div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Version -->
                            <div class="p-4 rounded-2xl bg-gradient-to-r from-blue-900 to-sky-900 text-white">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-11 h-11 bg-white/10 rounded-xl flex items-center justify-center text-xl font-black">${CORE.getCompanyName().charAt(0)}</div>
                                        <div>
                                            <div class="font-black">${CORE.getCompanyName()}</div>
                                            <div class="text-xs text-sky-300">Version ${CORE.config.version}</div>
                                        </div>
                                    </div>
                                    <span class="px-3 py-1 bg-emerald-500/20 text-emerald-400 rounded-full text-xs font-bold">�?� jour</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab: Apparence -->
                        <div id="mgr-content-appearance" class="space-y-5 hidden">
                            <!-- Th��me -->
                            <div>
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-11 h-11 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center shadow-lg shadow-purple-200">
                                        <i data-lucide="sun-moon" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-black text-slate-800">Th��me</h3>
                                        <p class="text-xs text-slate-500">Personnalisez l'apparence</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-3">
                                    <button onclick="ManagerModule.setTheme('light')" class="group p-4 rounded-2xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${this.state.theme === 'light' ? 'border-sky-400 shadow-xl shadow-sky-100 scale-105' : 'border-slate-200 hover:border-slate-300 hover:shadow-lg'}">
                                        <div class="w-14 h-14 bg-gradient-to-br from-amber-400 to-orange-500 rounded-xl flex items-center justify-center text-2xl shadow-lg ${this.state.theme === 'light' ? 'ring-4 ring-sky-200' : ''}">���? ?��� � �</div>
                                        <div class="text-center">
                                            <div class="font-black text-sm text-slate-800">Clair</div>
                                            <div class="text-[10px] text-slate-500">Interface lumineuse</div>
                                        </div>
                                        ${this.state.theme === 'light' ? '<div class="w-6 h-6 bg-sky-500 rounded-full flex items-center justify-center"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>' : ''}
                                    </button>
                                    <button onclick="ManagerModule.setTheme('dark')" class="group p-4 rounded-2xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${this.state.theme === 'dark' ? 'border-sky-400 shadow-xl shadow-sky-100 scale-105' : 'border-slate-200 hover:border-slate-300 hover:shadow-lg'}">
                                        <div class="w-14 h-14 bg-gradient-to-br from-slate-700 to-slate-900 rounded-xl flex items-center justify-center text-2xl shadow-lg ${this.state.theme === 'dark' ? 'ring-4 ring-sky-200' : ''}">��Ÿ�? ?�</div>
                                        <div class="text-center">
                                            <div class="font-black text-sm text-slate-800">Sombre</div>
                                            <div class="text-[10px] text-slate-500">Mode nuit</div>
                                        </div>
                                        ${this.state.theme === 'dark' ? '<div class="w-6 h-6 bg-sky-500 rounded-full flex items-center justify-center"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>' : ''}
                                    </button>
                                    <button onclick="ManagerModule.setTheme('auto')" class="group p-4 rounded-2xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${this.state.theme === 'auto' ? 'border-sky-400 shadow-xl shadow-sky-100 scale-105' : 'border-slate-200 hover:border-slate-300 hover:shadow-lg'}">
                                        <div class="w-14 h-14 bg-gradient-to-br from-sky-500 to-blue-600 rounded-xl flex items-center justify-center text-2xl shadow-lg ${this.state.theme === 'auto' ? 'ring-4 ring-sky-200' : ''}">��Ÿ�?</div>
                                        <div class="text-center">
                                            <div class="font-black text-sm text-slate-800">Auto</div>
                                            <div class="text-[10px] text-slate-500">Suit le syst��me</div>
                                        </div>
                                        ${this.state.theme === 'auto' ? '<div class="w-6 h-6 bg-sky-500 rounded-full flex items-center justify-center"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>' : ''}
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Couleur d'accent -->
                            <div class="p-4 rounded-2xl bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-11 h-11 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-200">
                                        <i data-lucide="paintbrush" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-black text-slate-800">Couleur d'accent</h4>
                                        <p class="text-xs text-slate-500">Choisissez votre couleur pr�f�r�e</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-6 gap-2">
                                    <button onclick="ManagerModule.setAccentColor('blue')" class="w-10 h-10 rounded-xl transition-all hover:scale-110 ${this.state.accentColor === 'blue' ? 'ring-4 ring-offset-2 ring-slate-400' : ''}" style="background: #3b82f6"></button>
                                    <button onclick="ManagerModule.setAccentColor('sky')" class="w-10 h-10 rounded-xl transition-all hover:scale-110 ${this.state.accentColor === 'sky' ? 'ring-4 ring-offset-2 ring-slate-400' : ''}" style="background: #0ea5e9"></button>
                                    <button onclick="ManagerModule.setAccentColor('teal')" class="w-10 h-10 rounded-xl transition-all hover:scale-110 ${this.state.accentColor === 'teal' ? 'ring-4 ring-offset-2 ring-slate-400' : ''}" style="background: #14b8a6"></button>
                                    <button onclick="ManagerModule.setAccentColor('emerald')" class="w-10 h-10 rounded-xl transition-all hover:scale-110 ${this.state.accentColor === 'emerald' ? 'ring-4 ring-offset-2 ring-slate-400' : ''}" style="background: #10b981"></button>
                                    <button onclick="ManagerModule.setAccentColor('violet')" class="w-10 h-10 rounded-xl transition-all hover:scale-110 ${this.state.accentColor === 'violet' ? 'ring-4 ring-offset-2 ring-slate-400' : ''}" style="background: #8b5cf6"></button>
                                    <button onclick="ManagerModule.setAccentColor('rose')" class="w-10 h-10 rounded-xl transition-all hover:scale-110 ${this.state.accentColor === 'rose' ? 'ring-4 ring-offset-2 ring-slate-400' : ''}" style="background: #f43f5e"></button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab: Profil -->
                        <div id="mgr-content-profile" class="space-y-4 hidden">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-11 h-11 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-200">
                                    <i data-lucide="user-circle" class="w-5 h-5 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-slate-800">Mes Informations</h3>
                                    <p class="text-xs text-slate-500">Modifiez vos donn�es personnelles</p>
                                </div>
                            </div>
                            
                            <div class="space-y-4 p-4 rounded-2xl bg-gradient-to-br from-cyan-50 to-blue-50 border border-cyan-200">
                                <div>
                                    <label class="block text-xs font-black text-slate-600 uppercase mb-2">��Ÿ?ž T�l�phone</label>
                                    <input type="tel" id="mgr-edit-phone" value="${user?.phone || ''}" placeholder="Ex: +242 06 500 0002" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none bg-white">
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-slate-600 uppercase mb-2">��Ÿš? V�hicule</label>
                                    <select id="mgr-edit-vehicle" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none bg-white">
                                        <option value="moto" ${user?.vehicle === 'moto' ? 'selected' : ''}>��Ÿ � ��� � � Moto</option>
                                        <option value="voiture" ${user?.vehicle === 'voiture' ? 'selected' : ''}>��Ÿš? Voiture</option>
                                        <option value="camion" ${user?.vehicle === 'camion' ? 'selected' : ''}>��Ÿšš Camion</option>
                                        <option value="velo" ${user?.vehicle === 'velo' ? 'selected' : ''}>��Ÿš � V�lo</option>
                                        <option value="autre" ${user?.vehicle === 'autre' ? 'selected' : ''}>��Ÿ? � Autre</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-slate-600 uppercase mb-2">��Ÿ � ?��� � � Ville</label>
                                    <select id="mgr-edit-city" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none bg-white">
                                        ${cities.map(c => `<option value="${c.id}" ${user?.city === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-slate-600 uppercase mb-2">��Ÿ � � Point de Vente</label>
                                    <select id="mgr-edit-pos" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none bg-white">
                                        ${pos.map(p => `<option value="${p.id}" ${user?.pos === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-slate-600 uppercase mb-2">��Ÿ? � Bio/Description</label>
                                    <textarea id="mgr-edit-bio" placeholder="D�crivez votre r��le..." class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none h-24 bg-white">${user?.bio || ''}</textarea>
                                </div>
                                
                                <button onclick="ManagerModule.saveMyInfoFromSettings()" class="w-full py-3 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-black rounded-xl hover:shadow-lg hover:shadow-cyan-200 transition-all flex items-center justify-center gap-2">
                                    <i data-lucide="save" class="w-4 h-4"></i>
                                    Enregistrer les modifications
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer actions -->
                    <div class="pt-4 border-t border-slate-200 flex justify-between items-center">
                        <button onclick="App.logout()" class="px-4 py-2.5 bg-red-50 text-red-600 rounded-xl font-bold text-sm hover:bg-red-100 transition flex items-center gap-2">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            D�connexion
                        </button>
                        <button onclick="UI.closeModal(); UI.toast('���?? Param��tres enregistr�s', 'success')" class="px-6 py-2.5 bg-gradient-to-r from-sky-500 to-blue-600 text-white rounded-xl font-bold text-sm hover:shadow-lg hover:shadow-sky-200 transition-all flex items-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            Fermer
                        </button>
                    </div>
                </div>
            `, [], { maxWidth: 'max-w-xl' });
            
            setTimeout(() => lucide.createIcons(), 50);
        },
        
        switchSettingsTab(tabName) {
            // Hide all content
            ['general', 'appearance', 'profile'].forEach(tab => {
                const content = document.getElementById('mgr-content-' + tab);
                const tabBtn = document.getElementById('mgr-tab-' + tab);
                if (content) content.classList.add('hidden');
                if (tabBtn) {
                    tabBtn.className = 'flex-1 px-4 py-3 text-xs font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 flex items-center justify-center gap-2 transition rounded-t-lg';
                }
            });
            
            // Show selected
            const selectedContent = document.getElementById('mgr-content-' + tabName);
            const selectedTab = document.getElementById('mgr-tab-' + tabName);
            if (selectedContent) selectedContent.classList.remove('hidden');
            if (selectedTab) {
                selectedTab.className = 'flex-1 px-4 py-3 text-xs font-bold text-sky-600 border-b-2 border-sky-500 bg-sky-50/50 flex items-center justify-center gap-2 rounded-t-lg';
            }
            
            setTimeout(() => lucide.createIcons(), 50);
        },
        
        saveMyInfoFromSettings() {
            const user = CORE.state.currentUser;
            const phone = document.getElementById('mgr-edit-phone')?.value?.trim() || '';
            const vehicle = document.getElementById('mgr-edit-vehicle')?.value || 'voiture';
            const city = parseInt(document.getElementById('mgr-edit-city')?.value) || 1;
            const pos = parseInt(document.getElementById('mgr-edit-pos')?.value) || 1;
            const bio = document.getElementById('mgr-edit-bio')?.value?.trim() || '';

            if (!phone) return UI.toast('Le t�l�phone est requis', 'warning');

            user.phone = phone;
            user.vehicle = vehicle;
            user.city = city;
            user.pos = pos;
            user.bio = bio;

            CORE.save();
            UI.toast('���?? Vos informations ont �t� mises �� jour', 'success');
            App.rerender();
        },
        
        setAccentColor(color) {
            this.state.accentColor = color;
            localStorage.setItem('manager_accent_color', color);
            UI.toast('Couleur d\'accent mise �� jour', 'success');
            this.showSettingsModal();
        },

        showEditMyInfoModal() {
            const user = CORE.state.currentUser;
            const cities = CORE.db.cities || [];
            const pos = CORE.db.pointsOfSale || [];

            UI.modal('�diter Mes Informations', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">T�l�phone</label>
                        <input type="tel" id="edit-phone" value="${user.phone || ''}" placeholder="Ex: +242 06 500 0002" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">V�hicule</label>
                        <select id="edit-vehicle" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                            <option value="moto" ${user.vehicle === 'moto' ? 'selected' : ''}>Moto</option>
                            <option value="voiture" ${user.vehicle === 'voiture' ? 'selected' : ''}>Voiture</option>
                            <option value="camion" ${user.vehicle === 'camion' ? 'selected' : ''}>Camion</option>
                            <option value="velo" ${user.vehicle === 'velo' ? 'selected' : ''}>V�lo</option>
                            <option value="autre" ${user.vehicle === 'autre' ? 'selected' : ''}>Autre</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Ville</label>
                        <select id="edit-city" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                            ${cities.map(c => `<option value="${c.id}" ${user.city === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Point de Vente</label>
                        <select id="edit-pos" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                            ${pos.map(p => `<option value="${p.id}" ${user.pos === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Bio/Description</label>
                        <textarea id="edit-bio" placeholder="D�crivez votre r��le..." class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none h-24">${user.bio || ''}</textarea>
                    </div>
                </div>
            `, [
                { label: 'Enregistrer', onclick: 'ManagerModule.saveMyInfo()', class: 'px-5 py-2.5 bg-cyan-600 text-white font-black rounded-xl hover:bg-cyan-700' },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        saveMyInfo() {
            const user = CORE.state.currentUser;
            const phone = document.getElementById('edit-phone')?.value?.trim() || '';
            const vehicle = document.getElementById('edit-vehicle')?.value || 'voiture';
            const city = parseInt(document.getElementById('edit-city')?.value) || 1;
            const pos = parseInt(document.getElementById('edit-pos')?.value) || 1;
            const bio = document.getElementById('edit-bio')?.value?.trim() || '';

            if (!phone) return UI.toast('Le t�l�phone est requis', 'warning');
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');

            user.phone = phone;
            user.vehicle = vehicle;
            user.city = city;
            user.pos = pos;
            user.bio = bio;

            CORE.save();
            UI.toast('Vos informations ont �t� mises �� jour', 'success');
            UI.closeModal();
            ManagerModule.showSettingsModal();
            App.rerender();
        },

        render() {
            this.state.theme = this.state.theme;
            const view = this.state.currentView;
            this.loadThemePreference(); // Charger le th��me pr�f�r�
            const content = view === 'dashboard' ? this.renderDashboard() :
                            view === 'analytics' ? this.renderAnalyticsDashboard() :
                            view === 'pos' ? this.renderPOS() :
                            view === 'inventory' ? this.renderInventory() :
                            view === 'main-stock' ? this.renderMainStockControlCenter() :
                            view === 'finance' ? this.renderFinance() :
                            view === 'team' ? this.renderTeam() :
                            view === 'commandes' ? this.renderCommandes() :
                            view === 'orders-global' ? PDGModule.renderOrders() :
                            view === 'isolation' ? this.renderIsolationPanel() :
                            view === 'toolbox' ? this.renderToolbox() :
                            this.renderDashboard();

            return `
                <div class="flex h-screen bg-slate-50 overflow-hidden">
                    <aside class="w-72 bg-gradient-to-b from-blue-950 via-slate-900 to-slate-950 text-white flex flex-col no-print relative overflow-hidden">
                        <!-- Effets de fond -->
                        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_left,rgba(59,130,246,0.15),transparent_50%)] pointer-events-none"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_bottom_right,rgba(99,102,241,0.1),transparent_50%)] pointer-events-none"></div>
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 via-indigo-500 to-purple-500"></div>
                        
                        <!-- Header -->
                        <div class="p-6 flex-shrink-0 relative">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-500 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/30 ring-2 ring-white/10">
                                    <i data-lucide="crown" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <h1 class="font-black text-xl tracking-tight">${CORE.getCompanyName()}<span class="text-blue-400">.manager</span></h1>
                                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">${CORE.state.currentUser.name}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Navigation -->
                        <nav class="flex-1 px-4 py-2 space-y-1 overflow-y-auto">
                            ${this.renderNav('dashboard','layout-grid','Dashboard')}
                            ${this.renderNav('analytics','bar-chart-3','Analytique')}
                            ${this.renderNav('pos','store','Points de vente')}
                            ${this.renderNav('inventory','box','Stocks (Pro)')}
                            ${this.renderNav('main-stock','warehouse','��Ÿ � � Stock D�p��t Principal')}
                            ${this.renderNav('commandes','shopping-cart','Commandes')}
                            ${this.renderNav('orders-global','shopping-bag','Commandes (Ventes)')}
                            ${this.renderNav('finance','wallet','Finances')}
                            ${this.renderNav('team','users','�quipe')}
                            ${this.renderNav('toolbox','command','Centre Commande')}
                        </nav>
                        
                        <!-- Footer -->
                        ${CORE.canAccessView('settings') ? `
                        <div class="p-4 border-t border-white/5 relative">
                            <button onclick="ManagerModule.showSettingsModal()" class="w-full flex items-center gap-3 px-4 py-3 bg-white/5 hover:bg-white/10 rounded-xl transition-all duration-200 group">
                                <i data-lucide="settings" class="w-5 h-5 text-slate-400 group-hover:text-blue-400 group-hover:rotate-90 transition-all duration-300"></i>
                                <span class="text-sm font-bold text-slate-300 group-hover:text-white">Param��tres</span>
                            </button>
                        </div>
                        ` : ''}
                    </aside>

                    <main class="flex-1 overflow-auto p-8">${content}</main>
                </div>`;
        },

        renderNav(view, icon, label) {
            if (!CORE.canAccessView(view)) return '';
            const active = this.state.currentView === view;
            return `
                <button onclick="ManagerModule.navigateTo('${view}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group ${active ? 'bg-gradient-to-r from-blue-500/20 to-indigo-500/10 text-blue-400 border-l-2 border-blue-400' : 'text-slate-400 hover:bg-white/5 hover:text-white'}">
                    <div class="w-9 h-9 rounded-xl ${active ? 'bg-blue-500/20' : 'bg-white/5 group-hover:bg-white/10'} flex items-center justify-center transition-all duration-200">
                        <i data-lucide="${icon}" class="w-5 h-5 ${active ? 'drop-shadow-[0_0_8px_rgba(59,130,246,0.5)]' : ''}"></i>
                    </div>
                    <span class="font-bold text-sm">${label}</span>
                    ${active ? '<div class="ml-auto w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>' : ''}
                </button>`;
        },

        validatePurchaseOrderArrival(orderId) {
            const order = CORE.db.purchaseOrders?.find(o => o.id === orderId);
            if (!order) {
                UI.toast('Commande introuvable', 'error');
                return;
            }
            if (order.status === 'received') {
                UI.toast('Commande d�j�� re��ue', 'info');
                return;
            }
            
            // Afficher modal pour saisir le montant r�ellement d�pens� du transport
            UI.modal('Montant du transport r�ellement d�pens�', 
                '<div class="space-y-4">' +
                UI.input('va_transportAmount', 'Montant du transport', 'number', order.transportPrice || 0, 'ex: 5000', true) +
                '</div>',
                [
                    {label: 'Annuler', onclick: 'UI.closeModal()'},
                    {label: 'Confirmer arriv�e', onclick: 'ManagerModule.confirmArrivalWithTransport(' + orderId + ')', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700'}
                ]
            );
        },

        confirmArrivalWithTransport(orderId) {
            const order = CORE.db.purchaseOrders?.find(o => o.id === orderId);
            if (!order) {
                UI.toast('Commande introuvable', 'error');
                return;
            }
            
            const transportAmount = parseFloat(UI.val('va_transportAmount')) || 0;
            if (transportAmount < 0) {
                UI.toast('Montant invalide', 'warning');
                return;
            }
            
            // Marquer la commande comme re��ue
            order.status = 'received';
            order.actualTransportCost = transportAmount;
            CORE.update('purchaseOrders', order.id, order);
            
            // Mettre �� jour la d�pense principale
            const expense = CORE.db.expenses?.find(e => e.purchaseOrderId === orderId && e.type === 'purchase_order');
            if (expense) {
                expense.status = 'completed';
                CORE.update('expenses', expense.id, expense);
            }
            
            // Cr�er une d�pense pour le transport si un montant a �t� saisi
            if (transportAmount > 0) {
                const supplier = CORE.db.suppliers?.find(s => s.id === order.supplierId);
                CORE.create('expenses', {
                    reference: order.reference + '-TRANSPORT',
                    type: 'transport',
                    description: `Frais de transport r�els - ${order.reference} de ${supplier?.name || 'Fournisseur'}`,
                    amount: transportAmount,
                    supplier: supplier?.name || 'Non sp�cifi�',
                    category: 'transport',
                    status: 'completed',
                    purchaseOrderId: orderId,
                    createdAt: new Date().toISOString()
                });
            }
            
            // Notification d'arriv�e valid�e
            const supplier = CORE.db.suppliers?.find(s => s.id === order.supplierId);
            const product = CORE.db.products?.find(p => p.id === order.productId);
            CORE.notify('success', `Colis re��u: ${order.reference} (${product?.name || 'Produit'}) - Transport r�el: ${CORE.formatPrice(transportAmount)}`, { purchaseOrderId: orderId });
            
            UI.closeModal();
            UI.toast('���?? Arriv�e du colis valid�e avec frais de transport: ' + CORE.formatPrice(transportAmount), 'success');
            this.navigateTo('commandes');
        },

        renderIsolationPanel() {
            const report = CORE.validatePOSIsolation();
            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-8 rounded-2xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-black mb-2">��Ÿ� � Isolation & S�curit�</h1>
                                <p class="text-white/80">V�rification que chaque POS est COMPL�?TEMENT isol�</p>
                            </div>
                            <div class="text-5xl">${report.isolationStatus === 'FULLY_ISOLATED' ? '���?�' : '��š ��� � �'}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Points de Vente</div>
                            <div class="text-3xl font-black text-slate-900">${report.posCount}</div>
                        </div>
                        <div class="bg-${report.isolationStatus === 'FULLY_ISOLATED' ? 'emerald' : 'amber'}-50 p-6 rounded-2xl border border-${report.isolationStatus === 'FULLY_ISOLATED' ? 'emerald' : 'amber'}-200">
                            <div class="text-xs font-black text-${report.isolationStatus === 'FULLY_ISOLATED' ? 'emerald' : 'amber'}-600 uppercase mb-1">�tat Isolation</div>
                            <div class="text-xl font-black text-${report.isolationStatus === 'FULLY_ISOLATED' ? 'emerald' : 'amber'}-900">${report.isolationStatus === 'FULLY_ISOLATED' ? 'ISOL�' : '�?� CORRIGER'}</div>
                        </div>
                        <div class="bg-${report.issueCount === 0 ? 'emerald' : 'red'}-50 p-6 rounded-2xl border border-${report.issueCount === 0 ? 'emerald' : 'red'}-200">
                            <div class="text-xs font-black text-${report.issueCount === 0 ? 'emerald' : 'red'}-600 uppercase mb-1">Probl��mes</div>
                            <div class="text-3xl font-black text-${report.issueCount === 0 ? 'emerald' : 'red'}-900">${report.issueCount}</div>
                        </div>
                    </div>

                    <div class="bg-white border border-slate-200 rounded-2xl p-6">
                        <h2 class="text-lg font-black text-slate-900 mb-4">��Ÿ?Š Rapport D�taill�</h2>
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            ${report.issues.map(issue => `
                                <div class="flex items-start gap-3 text-sm">
                                    <span class="font-black text-lg mt-0.5">${issue.includes('���?�') ? '���?�' : issue.includes('�� ��?') ? '�� ��?' : '��š ��� � �'}</span>
                                    <span class="text-slate-700">${issue}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-white border border-slate-200 rounded-2xl p-6">
                        <h2 class="text-lg font-black text-slate-900 mb-4">��Ÿ?�? Donn�es par POS</h2>
                        <div class="space-y-4">
                            ${Object.entries(report.summary).map(([key, data]) => `
                                <div class="p-4 bg-gradient-to-r from-slate-50 to-slate-100 rounded-xl border border-slate-200">
                                    <div class="font-black text-slate-900 mb-2">${data.name}</div>
                                    <div class="grid grid-cols-3 md:grid-cols-6 gap-2 text-xs">
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Clients</div>
                                            <div class="font-black text-lg text-slate-900">${data.clients}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Commandes</div>
                                            <div class="font-black text-lg text-slate-900">${data.orders}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Livraisons</div>
                                            <div class="font-black text-lg text-slate-900">${data.deliveries}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Transactions</div>
                                            <div class="font-black text-lg text-slate-900">${data.transactions}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Notif</div>
                                            <div class="font-black text-lg text-slate-900">${data.notifications}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Mvmts</div>
                                            <div class="font-black text-lg text-slate-900">${data.stockMovements}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-indigo-50 border-2 border-indigo-200 rounded-2xl p-6">
                        <div class="font-black text-indigo-900 mb-4">��š ?��� � � Actions</div>
                        <div class="space-y-2">
                            <button onclick="ManagerModule.performIsolationValidation()" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-xl font-black hover:bg-indigo-700 transition">
                                ��Ÿ� � Valider Isolation Compl��te
                            </button>
                            <button onclick="if(confirm('Cela va forcer le respect complet de l\'isolation. Continuer ?')) { ManagerModule.performForcedIsolation(); }" class="w-full px-4 py-3 bg-orange-600 text-white rounded-xl font-black hover:bg-orange-700 transition">
                                ��Ÿ�? Forcer Isolation (DANGER!)
                            </button>
                        </div>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4 text-xs text-blue-800">
                        <div class="font-black mb-2">��? ��� � � �?� propos de l'isolation</div>
                        <p>Chaque Point de Vente doit ��tre COMPL�?TEMENT ISOL�. Aucun client, commande, livraison ou notification ne doit ��tre partag� entre les POS. Cette page v�rifie que chaque POS dispose d'une structure de donn�es ind�pendante.</p>
                    </div>
                </div>
            `;
        },

        performIsolationValidation() {
            const report = CORE.validatePOSIsolation();
            const isFull = report.isolationStatus === 'FULLY_ISOLATED';

            UI.modal('Rapport d\'Isolation', `
                <div class="space-y-4">
                    <div class="p-4 rounded-xl ${isFull ? 'bg-emerald-50 border border-emerald-200' : 'bg-amber-50 border border-amber-200'}">
                        <div class="font-black ${isFull ? 'text-emerald-900' : 'text-amber-900'}">
                            ${isFull ? '���?� Isolation Compl��te Confirm�e!' : '��š ��� � � Isolation Incompl��te'}
                        </div>
                        <div class="text-sm ${isFull ? 'text-emerald-800' : 'text-amber-800'} mt-2">
                            ${isFull ? 'Tous les POS sont correctement isol�s.' : `${report.issueCount} probl��me(s) d�tect�(s).`}
                        </div>
                    </div>
                    <div class="text-xs text-slate-600 max-h-48 overflow-y-auto space-y-2">
                        ${report.issues.map(i => `<div>${i}</div>`).join('')}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        performForcedIsolation() {
            const report = CORE.enforceISOLATION();
            UI.toast('��Ÿ�? Isolation forc�e appliqu�e!', 'success');
            UI.modal('Isolation Forc�e Appliqu�e', `
                <div class="space-y-4">
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                        <div class="font-black text-emerald-900">���?� Isolation Compl��te Appliqu�e!</div>
                        <div class="text-sm text-emerald-800 mt-2">Tous les POS ont �t� forc�s �� l'isolation compl��te.</div>
                    </div>
                    <div class="text-xs text-slate-600">
                        <div class="font-black mb-2">R�sum�:</div>
                        <div>Timestamp: ${report.timestamp}</div>
                        <div>POS: ${report.posCount}</div>
                        <div>�tat: ${report.isolationStatus}</div>
                    </div>
                </div>
            `, [
                { label: 'OK', onclick: 'UI.closeModal(); ManagerModule.navigateTo("isolation");' }
            ]);
            setTimeout(() => App.rerender(), 500);
        },

        showChangePersonalPasswordModal() {
            UI.modal('��Ÿ�? Changer votre mot de passe', `
                <div class="space-y-4">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl flex items-center gap-3">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-amber-600 flex-shrink-0"></i>
                        <div class="text-sm text-amber-800 font-medium">Utilisez un mot de passe fort (min 6 caract��res)</div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Ancien mot de passe</label>
                        <input type="password" id="old_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Entrez votre ancien mot de passe">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Nouveau mot de passe</label>
                        <input type="password" id="new_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Entrez un nouveau mot de passe">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Confirmation du nouveau mot de passe</label>
                        <input type="password" id="confirm_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Confirmez le nouveau mot de passe">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Changer le mot de passe', onclick: 'GestionnaireModule.savePersonalPasswordChange()', class: 'px-5 py-2.5 bg-amber-600 text-white font-black rounded-xl hover:bg-amber-700' }
            ]);
        },

        async savePersonalPasswordChange() {
            const oldPwd = UI.val('old_pwd');
            const newPwd = UI.val('new_pwd');
            const confirmPwd = UI.val('confirm_pwd');
            const user = CORE.state.currentUser;
            
            if (!oldPwd || !newPwd || !confirmPwd) {
                UI.toast('Tous les champs sont obligatoires', 'error');
                return;
            }
            
            if (newPwd.length < 6) {
                UI.toast('Le nouveau mot de passe doit contenir au moins 6 caract��res', 'error');
                return;
            }
            
            if (newPwd !== confirmPwd) {
                UI.toast('Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            const oldPwdHash = await Utils.md5(oldPwd);
            if (oldPwdHash !== user.passwordHash) {
                UI.toast('Ancien mot de passe incorrect', 'error');
                return;
            }
            
            const newPwdHash = await Utils.md5(newPwd);
            user.passwordHash = newPwdHash;
            
            const userIndex = CORE.db.users.findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
                CORE.db.users[userIndex] = user;
                CORE.save();
                UI.closeModal();
                UI.toast('���?? Mot de passe chang� avec succ��s', 'success');
                App.rerender();
            } else {
                UI.toast('Erreur lors de la mise �� jour de l\'utilisateur', 'error');
            }
        }
    }


    // =========================================================
    // MODULE: PDG (Command Center)
    // =========================================================
    const PDGModule = {
        state: {
            currentView: 'overview',
            theme: 'light',
            notificationsEnabled: true,
            preferences: { notificationsEnabled: true, soundEnabled: true, soundVolume: 0.8 },
            ordersSearch: '',
            ordersStatus: 'all',
            deliveriesSearch: '',
            deliveriesStatus: 'all',
            stockSearch: '',
            teamSearch: '',
            teamRole: 'all',
            activityTab: 'notifications',
            inventoryPosId: '',

            // Finance (PDG)
            financeTab: 'overview',
            financeFrom: '',
            financeTo: '',
            financeSearch: '',
            financeType: 'all',
            financeCategory: 'all',
            financeMethod: 'all',
            financeCityId: '',
            financePosId: '',

            // Audit Trail
            auditFilterUser: '',
            auditFilterAction: '',
            auditFilterEntity: '',
            auditSortOrder: 'desc',

            // Team (�quipe)
            teamPage: 1,
            teamPerPage: 20,
            teamPosId: 'all',
            teamViewMode: 'list', // 'list' ou 'grouped'
            teamSortBy: 'name', // 'name', 'role', 'pos'
            teamSortOrder: 'asc',

            // Stock (Produits)
            stockPage: 1,
            stockPerPage: 50,
            stockPosId: 'all',
            stockCategoryId: 'all',
            stockStatus: 'all', // 'all', 'low', 'ok', 'out'
            stockSortBy: 'name', // 'name', 'stock', 'price', 'value', 'category'
            stockSortOrder: 'asc',
            stockViewMode: 'table' // 'table' ou 'cards'
        },

        init() {
            // R�initialiser la vue et les filtres par d�faut
            this.state.currentView = 'overview';
            this.state.financeTab = 'overview';
            this.state.activityTab = 'notifications';
            this.state.ordersSearch = '';
            this.state.ordersStatus = 'all';
            this.state.deliveriesSearch = '';
            this.state.deliveriesStatus = 'all';
            this.state.stockSearch = '';
            this.state.teamSearch = '';
            this.state.teamRole = 'all';
            this.state.financeFrom = '';
            this.state.financeTo = '';
            this.state.financeSearch = '';
            this.state.financeType = 'all';
            this.state.financeCategory = 'all';
            this.state.financeMethod = 'all';
            this.state.financeCityId = '';
            this.state.financePosId = '';
            this.state.auditFilterUser = '';
            this.state.auditFilterAction = '';
            this.state.auditFilterEntity = '';
            this.state.teamPage = 1;
            this.state.stockPage = 1;
            this.state.teamPosId = 'all';
            this.state.inventoryPosId = '';
            this.state.stockPosId = 'all';
            
            // Charger le th��me pr�f�r�
            this.loadThemePreference();
        },

        navigateTo(view) {
            this.state.currentView = view;
            App.rerender();
        },

        setTheme(theme) {
            this.state.theme = theme;
            const userId = CORE.user?.id || 'default';
            localStorage.setItem(`pdg_theme_${userId}`, theme);
            
            // Appliquer le th��me directement (style WhatsApp comme Vendeur)
            const html = document.documentElement;
            const body = document.body;

            html.classList.remove('pdg-dark', 'pdg-light', 'pdg-auto');
            if (body) body.classList.remove('pdg-dark', 'pdg-light', 'pdg-auto');
            html.style.filter = 'none';

            if (theme === 'dark') {
                html.classList.add('pdg-dark');
                if (body) body.classList.add('pdg-dark');
                html.style.backgroundColor = '#111b21';
            } else if (theme === 'light') {
                html.classList.add('pdg-light');
                if (body) body.classList.add('pdg-light');
                html.style.backgroundColor = '#ffffff';
            } else if (theme === 'auto') {
                html.classList.add('pdg-auto');
                if (body) body.classList.add('pdg-auto');
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.backgroundColor = isDark ? '#111b21' : '#ffffff';
                if (isDark) {
                    html.classList.add('pdg-dark');
                    if (body) body.classList.add('pdg-dark');
                }
            }
            
            UI.toast('Th��me: ' + (theme === 'light' ? 'Clair' : theme === 'dark' ? 'Sombre' : 'Auto'), 'success');
            App.rerender();
        },
        
        setLanguage(code) {
            const userId = CORE.state.currentUser?.id;
            CORE.setUserLanguage(userId, code);
            I18n.setLanguage(code);
            UI.closeModal();
            UI.toast(`���?? Langue: ${code.toUpperCase()}`, 'success');
            App.rerender();
        },
        
        saveCompanyName() {
            const name = UI.val('pdg_company_name');
            if (!name || !name.trim()) {
                return UI.toast('Le nom de l\'entreprise ne peut pas ��tre vide', 'warning');
            }
            
            if (CORE.setCompanyName(name)) {
                UI.toast(`���?? Nom de l'entreprise mis �� jour: ${name.trim()}`, 'success');
                UI.closeModal();
                App.rerender();
            } else {
                UI.toast('Erreur lors de la mise �� jour', 'error');
            }
        },

        applyTheme() {
            const html = document.documentElement;
            const body = document.body;
            const theme = this.state.theme;

            html.classList.remove('pdg-dark', 'pdg-light', 'pdg-auto');
            if (body) body.classList.remove('pdg-dark', 'pdg-light', 'pdg-auto');
            html.style.filter = 'none';

            if (theme === 'dark') {
                html.classList.add('pdg-dark');
                if (body) body.classList.add('pdg-dark');
                html.style.backgroundColor = '#111b21';
            } else if (theme === 'light') {
                html.classList.add('pdg-light');
                if (body) body.classList.add('pdg-light');
                html.style.backgroundColor = '#ffffff';
            } else if (theme === 'auto') {
                html.classList.add('pdg-auto');
                if (body) body.classList.add('pdg-auto');
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.backgroundColor = isDark ? '#111b21' : '#ffffff';
                if (isDark) {
                    html.classList.add('pdg-dark');
                    if (body) body.classList.add('pdg-dark');
                }
            }
        },

        loadThemePreference() {
            const userId = CORE.user?.id || 'default';
            const saved = localStorage.getItem(`pdg_theme_${userId}`);
            if (saved) {
                this.state.theme = saved;
                this.applyTheme();
            }
        },

        // =====================
        // APPROBATIONS (PDG)
        // =====================
        getPendingPOSRequests() {
            return (CORE.db.posCreationRequests || []).filter(r => r.status === 'pending').sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
        },

        approvePOSRequest(requestId) {
            const requests = CORE.db.posCreationRequests || [];
            const request = requests.find(r => r.id === requestId);
            if (!request) return UI.toast('Demande non trouv�e', 'error');

            if (request.type === 'creation') {
                // Approuver la cr�ation
                const newPOS = CORE.create('pointsOfSale', request.posData);
                
                // ===== ISOLATION COMPL�?TE: INITIALISER LES DONN�ES ISOL�ES =====
                // Auto-initialise la structure isol�e pour ce nouveau POS
                CORE.initializePOSData(newPOS.id);
                
                request.status = 'approved';
                request.approvedBy = CORE.state.currentUser?.name || 'PDG';
                request.approvalDate = new Date().toISOString();
                CORE.save();
                CORE.notify('success', `Cr�ation de "${request.posData.name}" approuv�e`, { requestId });
                UI.toast(`POS "${request.posData.name}" cr�� avec approbation ���?� Donn�es isol�es initialis�es`, 'success');
            } else if (request.type === 'deletion') {
                // Approuver la suppression
                const posId = request.posId;
                CORE.delete('pointsOfSale', posId);
                
                // ===== ISOLATION COMPL�?TE: SUPPRIMER LES DONN�ES ISOL�ES =====
                // Supprime les donn�es isol�es du POS supprim�
                if (CORE.db.posDataByLocation && CORE.db.posDataByLocation[posId]) {
                    delete CORE.db.posDataByLocation[posId];
                }
                
                request.status = 'approved';
                request.approvedBy = CORE.state.currentUser?.name || 'PDG';
                request.approvalDate = new Date().toISOString();
                CORE.save();
                CORE.notify('success', `Suppression de "${request.posName}" approuv�e`, { posId: posId });
                UI.toast(`POS "${request.posName}" supprim� avec approbation ���?� Donn�es isol�es supprim�es`, 'success');
            }
            App.rerender();
        },

        rejectPOSRequest(requestId) {
            const reason = prompt('Motif du rejet:');
            if (!reason) return;

            const requests = CORE.db.posCreationRequests || [];
            const request = requests.find(r => r.id === requestId);
            if (!request) return UI.toast('Demande non trouv�e', 'error');

            request.status = 'rejected';
            request.approvedBy = CORE.state.currentUser?.name || 'PDG';
            request.approvalDate = new Date().toISOString();
            request.rejectionReason = reason;

            CORE.save();
            const label = request.type === 'creation' ? `Cr�ation de "${request.posData.name}"` : `Suppression de "${request.posName}"`;
            CORE.notify('warning', `Demande rejet�e: ${label}`, { requestId });
            UI.toast('Demande rejet�e', 'info');
            App.rerender();
        },

        renderApprovalsModal() {
            const pending = this.getPendingPOSRequests();
            return `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    ${pending.length === 0 ? `<div class="p-8 text-center text-slate-400 font-medium">Aucune demande en attente</div>` : ''}
                    ${pending.map(req => {
                        const isCreation = req.type === 'creation';
                        const title = isCreation ? `Cr�ation de: <span class="text-emerald-600">${req.posData.name}</span>` : `Suppression de: <span class="text-amber-600">${req.posName}</span>`;
                        const borderColor = isCreation ? 'border-emerald-200 bg-emerald-50' : 'border-amber-200 bg-amber-50';
                        const textColor = isCreation ? 'text-emerald-900' : 'text-amber-900';
                        return `
                        <div class="p-4 rounded-2xl border ${borderColor}">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1">
                                    <div class="font-black ${textColor}">${title}</div>
                                    ${isCreation ? `
                                        <div class="text-xs text-slate-600 mt-1">
                                            Ville: <span class="font-bold">${CORE.getCity(req.posData.cityId)?.name || 'N/A'}</span><br>
                                            Employ�s: <span class="font-bold">${req.posData.employees}</span><br>
                                            Demand� par: <span class="font-bold">${req.requestedBy}</span><br>
                                            Le: <span class="font-bold">${CORE.formatDate(req.createdAt)}</span>
                                        </div>
                                    ` : `
                                        <div class="text-xs text-slate-600 mt-1">
                                            Demand� par: <span class="font-bold">${req.requestedBy}</span><br>
                                            Le: <span class="font-bold">${CORE.formatDate(req.createdAt)}</span>
                                        </div>
                                    `}
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="PDGModule.rejectPOSRequest(${req.id})" class="px-3 py-2 bg-red-600 text-white rounded-lg text-xs font-black hover:bg-red-700">Rejeter</button>
                                    <button onclick="PDGModule.approvePOSRequest(${req.id})" class="px-3 py-2 bg-emerald-600 text-white rounded-lg text-xs font-black hover:bg-emerald-700">Approuver</button>
                                </div>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        },

        // Garder les anciennes m�thodes pour compatibilit�
        getPendingDeleteRequests() {
            return this.getPendingPOSRequests().filter(r => r.type === 'deletion');
        },

        approvePOSDeleteRequest(requestId) {
            return this.approvePOSRequest(requestId);
        },

        rejectPOSDeleteRequest(requestId) {
            return this.rejectPOSRequest(requestId);
        },

        // =====================
        // GESTION DES POS (PDG)
        // =====================
        renderPOS() {
            const grouped = CORE.db.pointsOfSale.map(p => ({
                ...p,
                city: CORE.getCity(p.cityId)?.name,
                orders: CORE.db.orders.filter(o => o.posId === p.id).length
            }));
            return `
                <div class="fade-in max-w-6xl mx-auto space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">Points de vente</h2>
                            <p class="text-slate-500 font-medium">Gestion compl��te des POS.</p>
                        </div>
                        <button onclick="PDGModule.showAddPOSModal()" class="px-6 py-3 bg-indigo-600 text-white font-black rounded-xl hover:bg-indigo-700 transition flex items-center gap-2">
                            <i data-lucide="plus" class="w-5 h-5"></i> Nouveau POS
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${grouped.map(p => `
                            <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-6 card-hover relative">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">${p.city}</div>
                                        <div class="text-xl font-black text-slate-900 mt-1">${p.name}</div>
                                        <div class="mt-2 text-sm text-slate-500 font-medium">Employ�s: <span class="font-black">${p.employees}</span> �� ?� � Commandes: <span class="font-black">${p.orders}</span></div>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center"><i data-lucide="store" class="w-6 h-6"></i></div>
                                        <button onclick="PDGModule.openPosInventory(${p.id})" class="p-2.5 rounded-xl hover:bg-emerald-50 transition text-emerald-600 hover:text-emerald-700" title="Stock de ce POS">
                                            <i data-lucide="package" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="PDGModule.showEditPOSModal(${p.id})" class="p-2.5 rounded-xl hover:bg-slate-100 transition text-slate-600 hover:text-slate-900" title="�diter">
                                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="PDGModule.deletePOS(${p.id})" class="p-2.5 rounded-xl hover:bg-red-50 transition text-red-600 hover:bg-red-100" title="Supprimer">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        },

        openPosInventory(posId) {
            const pos = CORE.getPOS(posId);
            if (!pos) {
                UI.toast('POS non trouv�', 'error');
                return;
            }

            this.state.inventoryPosId = String(posId);
            ManagerModule.state.inventoryPosId = String(posId);
            ManagerModule.state.inventoryTab = 'products';
            ManagerModule.state.inventorySearch = '';
            ManagerModule.state.movementsSearch = '';
            ManagerModule.state.movementsType = 'all';

            this.state.currentView = 'inventory';
            App.rerender();
        },

        showAddPOSModal() {
            const cities = CORE.db.cities.map(c => ({value: c.id, label: c.name}));
            UI.modal('Nouveau Point de Vente', `
                <div class="space-y-4">
                    ${UI.input('pos_name', 'Nom du POS', 'text', '', 'ex: Brazzaville Centre', true)}
                    
                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-900">Ville *</label>
                        <div class="flex gap-2">
                            <select id="pos_city" class="flex-1 px-4 py-2.5 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- S�lectionner une ville --</option>
                                ${cities.map(c => `<option value="${c.value}" ${String(c.value) === String(CORE.state.currentUser?.city || '') ? 'selected' : ''}>${c.label}</option>`).join('')}
                            </select>
                            <button onclick="PDGModule.showNewCityModal('add')" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition whitespace-nowrap">+ Nouvelle</button>
                        </div>
                    </div>
                    
                    ${UI.input('pos_employees', 'Nombre d\'employ�s', 'number', '1', 'ex: 5', true)}
                    ${UI.input('pos_phone', 'T�l�phone', 'tel', '', '+242 ...', false)}
                    ${UI.textarea('pos_address', 'Adresse', '', 'ex: 123 Rue Principale', 2)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Cr�er', onclick: 'PDGModule.savePOS()', class: 'px-5 py-2.5 bg-indigo-600 text-white font-black rounded-xl hover:bg-indigo-700 transition' }
            ]);
        },

        showEditPOSModal(posId) {
            const pos = CORE.getPOS(posId);
            if (!pos) return UI.toast('POS non trouv�', 'error');
            const cities = CORE.db.cities.map(c => ({value: c.id, label: c.name}));
            UI.modal(`Modifier: ${pos.name}`, `
                <div class="space-y-4">
                    ${UI.input('pos_name', 'Nom du POS', 'text', pos.name, '', true)}
                    
                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-900">Ville *</label>
                        <div class="flex gap-2">
                            <select id="pos_city" class="flex-1 px-4 py-2.5 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- S�lectionner une ville --</option>
                                ${cities.map(c => `<option value="${c.value}" ${String(c.value) === String(pos.cityId || '') ? 'selected' : ''}>${c.label}</option>`).join('')}
                            </select>
                            <button onclick="PDGModule.showNewCityModal('edit', ${posId})" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition whitespace-nowrap">+ Nouvelle</button>
                        </div>
                    </div>
                    
                    ${UI.input('pos_employees', 'Nombre d\'employ�s', 'number', pos.employees || '1', '', true)}
                    ${UI.input('pos_phone', 'T�l�phone', 'tel', pos.phone || '', '', false)}
                    ${UI.textarea('pos_address', 'Adresse', pos.address || '', '', 2)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: `PDGModule.updatePOS(${posId})`, class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        savePOS() {
            const name = UI.val('pos_name').trim();
            const cityId = parseInt(UI.val('pos_city'), 10);
            const employees = parseInt(UI.val('pos_employees'), 10) || 1;
            const phone = UI.val('pos_phone').trim() || null;
            const address = UI.val('pos_address').trim() || null;

            if (!name) return UI.toast('Le nom du POS est requis', 'warning');
            if (!cityId) return UI.toast('Veuillez s�lectionner une ville', 'warning');

            CORE.create('pointsOfSale', {
                name,
                cityId,
                employees,
                phone,
                address
            });

            UI.closeModal();
            UI.toast('Point de vente cr�� avec succ��s', 'success');
            App.rerender();
        },

        updatePOS(posId) {
            const name = UI.val('pos_name').trim();
            const cityId = parseInt(UI.val('pos_city'), 10);
            const employees = parseInt(UI.val('pos_employees'), 10) || 1;
            const phone = UI.val('pos_phone').trim() || null;
            const address = UI.val('pos_address').trim() || null;

            if (!name) return UI.toast('Le nom du POS est requis', 'warning');
            if (!cityId) return UI.toast('Veuillez s�lectionner une ville', 'warning');

            CORE.update('pointsOfSale', posId, {
                name,
                cityId,
                employees,
                phone,
                address
            });

            UI.closeModal();
            UI.toast('Point de vente mis �� jour', 'success');
            App.rerender();
        },

        deletePOS(posId) {
            const pos = CORE.getPOS(posId);
            if (!pos) return UI.toast('POS non trouv�', 'error');

            // V�rifier si des commandes sont li�es �� ce POS
            const linkedOrders = CORE.db.orders.filter(o => o.posId === posId);
            if (linkedOrders.length > 0) {
                return UI.toast(`Impossible de supprimer: ${linkedOrders.length} commande(s) associ�e(s)`, 'warning');
            }

            const linkedUsers = CORE.db.users.filter(u => u.pos === posId);
            if (linkedUsers.length > 0) {
                return UI.toast(`Impossible de supprimer: ${linkedUsers.length} utilisateur(s) assign�(s)`, 'warning');
            }

            UI.confirm({
                title: 'Supprimer le POS',
                message: `�?Štes-vous s��r de vouloir supprimer d�finitivement "${pos.name}" ?`,
                confirmLabel: 'Supprimer',
                confirmClass: 'bg-red-600 hover:bg-red-700 text-white',
                onConfirm: function() {
                    CORE.delete('pointsOfSale', posId);
                    UI.closeModal();
                    UI.toast(`POS "${pos.name}" supprim� avec succ��s`, 'success');
                    CORE.notify('info', `POS supprim�: ${pos.name}`, { posId });
                    App.rerender();
                }
            });
        },

        showNewCityModal(context = 'add', posId = null) {
            // Sauvegarder les donn�es du formulaire POS en cours
            window._pendingPOSFormData = {
                context: context,
                posId: posId,
                name: UI.val('pos_name') || '',
                employees: UI.val('pos_employees') || '1',
                phone: UI.val('pos_phone') || '',
                address: UI.val('pos_address') || ''
            };
            
            UI.modal('Nouvelle Ville', `
                <div class="space-y-4">
                    <p class="text-sm text-slate-500">Ajoutez une nouvelle ville �� la liste des villes disponibles.</p>
                    ${UI.input('new_city_name', 'Nom de la ville', 'text', '', 'ex: Pointe-Noire, Dolisie...', true)}
                    ${UI.input('new_city_country', 'Pays', 'text', 'Congo', 'ex: Congo', false)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'PDGModule.restorePOSModal()' },
                { label: 'Cr�er la ville', onclick: 'PDGModule.saveNewCity()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        saveNewCity() {
            const cityName = UI.val('new_city_name').trim();
            const country = UI.val('new_city_country').trim() || 'Congo';
            
            if (!cityName) {
                return UI.toast('Le nom de la ville est requis', 'warning');
            }
            
            // V�rifier si la ville existe d�j��
            const exists = CORE.db.cities.some(c => c.name.toLowerCase() === cityName.toLowerCase());
            if (exists) {
                return UI.toast('Cette ville existe d�j��', 'warning');
            }
            
            // Cr�er la nouvelle ville
            const newCity = CORE.create('cities', {
                name: cityName,
                country: country
            });
            
            UI.toast(`Ville "${cityName}" cr��e avec succ��s`, 'success');
            
            // Restaurer le modal POS avec la nouvelle ville s�lectionn�e
            this.restorePOSModal(newCity.id);
        },

        restorePOSModal(newCityId = null) {
            const data = window._pendingPOSFormData || {};
            const cities = CORE.db.cities.map(c => ({value: c.id, label: c.name}));
            const selectedCity = newCityId || '';
            
            if (data.context === 'edit' && data.posId) {
                // Restaurer le modal d'�dition
                const pos = CORE.getPOS(data.posId);
                UI.modal(`Modifier: ${pos?.name || 'POS'}`, `
                    <div class="space-y-4">
                        ${UI.input('pos_name', 'Nom du POS', 'text', data.name || pos?.name || '', '', true)}
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-black text-slate-900">Ville *</label>
                            <div class="flex gap-2">
                                <select id="pos_city" class="flex-1 px-4 py-2.5 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">-- S�lectionner une ville --</option>
                                    ${cities.map(c => `<option value="${c.value}" ${String(c.value) === String(selectedCity || pos?.cityId || '') ? 'selected' : ''}>${c.label}</option>`).join('')}
                                </select>
                                <button onclick="PDGModule.showNewCityModal('edit', ${data.posId})" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition whitespace-nowrap">+ Nouvelle</button>
                            </div>
                        </div>
                        
                        ${UI.input('pos_employees', 'Nombre d\'employ�s', 'number', data.employees || pos?.employees || '1', '', true)}
                        ${UI.input('pos_phone', 'T�l�phone', 'tel', data.phone || pos?.phone || '', '', false)}
                        ${UI.textarea('pos_address', 'Adresse', data.address || pos?.address || '', '', 2)}
                    </div>
                `, [
                    { label: 'Annuler', onclick: 'UI.closeModal()' },
                    { label: 'Enregistrer', onclick: `PDGModule.updatePOS(${data.posId})`, class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
                ]);
            } else {
                // Restaurer le modal de cr�ation
                UI.modal('Nouveau Point de Vente', `
                    <div class="space-y-4">
                        ${UI.input('pos_name', 'Nom du POS', 'text', data.name || '', 'ex: Brazzaville Centre', true)}
                        
                        <div class="space-y-2">
                            <label class="block text-sm font-black text-slate-900">Ville *</label>
                            <div class="flex gap-2">
                                <select id="pos_city" class="flex-1 px-4 py-2.5 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">-- S�lectionner une ville --</option>
                                    ${cities.map(c => `<option value="${c.value}" ${String(c.value) === String(selectedCity) ? 'selected' : ''}>${c.label}</option>`).join('')}
                                </select>
                                <button onclick="PDGModule.showNewCityModal('add')" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition whitespace-nowrap">+ Nouvelle</button>
                            </div>
                        </div>
                        
                        ${UI.input('pos_employees', 'Nombre d\'employ�s', 'number', data.employees || '1', 'ex: 5', true)}
                        ${UI.input('pos_phone', 'T�l�phone', 'tel', data.phone || '', '+242 ...', false)}
                        ${UI.textarea('pos_address', 'Adresse', data.address || '', 'ex: 123 Rue Principale', 2)}
                    </div>
                `, [
                    { label: 'Annuler', onclick: 'UI.closeModal()' },
                    { label: 'Cr�er', onclick: 'PDGModule.savePOS()', class: 'px-5 py-2.5 bg-indigo-600 text-white font-black rounded-xl hover:bg-indigo-700 transition' }
                ]);
            }
            
            window._pendingPOSFormData = null;
        },

        mapToServerCustomer(c) {
            const nameParts = (c.name || '').split(' ');
            const firstName = c.firstName || nameParts[0] || 'Client';
            const lastName = c.lastName || nameParts.slice(1).join(' ') || 'Inconnu';
            return {
                firstName: firstName,
                lastName: lastName,
                phone: c.phone,
                email: c.email
            };
        },

        // ---------- Server Stats ----------
        serverStats: null,
        serverStatsTime: 0,

        async fetchServerStats() {
            const now = Date.now();
            if (this.serverStats && (now - this.serverStatsTime) < 60000) return this.serverStats;
            if (!API.getToken()) return null;
            try {
                const products = await API.getProducts().catch(() => []);
                const orders = await API.getOrders().catch(() => []);
                const customers = await API.getCustomers().catch(() => []);
                const totalRevenue = orders.reduce((a, o) => a + (Number(o.total) || 0), 0);
                const pendingOrders = orders.filter(o => o.status !== 'delivered' && o.status !== 'cancelled').length;
                this.serverStats = { products: products.length, orders: orders.length, customers: customers.length, totalRevenue, pendingOrders };
                this.serverStatsTime = now;
                return this.serverStats;
            } catch (e) { return null; }
        },

        async refreshServerStats() {
            const card = document.getElementById('serverStatsCard');
            if (!card) return;
            
            // Show loading
            const productsEl = document.getElementById('serverStatProducts');
            const ordersEl = document.getElementById('serverStatOrders');
            const customersEl = document.getElementById('serverStatCustomers');
            const revenueEl = document.getElementById('serverStatRevenue');
            const lastUpdateEl = document.getElementById('serverStatsLastUpdate');
            
            if (productsEl) productsEl.textContent = '...';
            if (ordersEl) ordersEl.textContent = '...';
            if (customersEl) customersEl.textContent = '...';
            if (revenueEl) revenueEl.textContent = '...';
            if (lastUpdateEl) lastUpdateEl.textContent = 'Chargement...';
            
            // Fetch stats
            const stats = await this.fetchServerStats();
            
            if (stats) {
                if (productsEl) productsEl.textContent = stats.products || 0;
                if (ordersEl) ordersEl.textContent = stats.orders || 0;
                if (customersEl) customersEl.textContent = stats.customers || 0;
                if (revenueEl) revenueEl.textContent = CORE.formatPrice(stats.totalRevenue || 0);
                if (lastUpdateEl) lastUpdateEl.textContent = 'Mis a jour: ' + new Date().toLocaleTimeString('fr-FR');
            } else {
                if (productsEl) productsEl.textContent = '-';
                if (ordersEl) ordersEl.textContent = '-';
                if (customersEl) customersEl.textContent = '-';
                if (revenueEl) revenueEl.textContent = '-';
                if (lastUpdateEl) lastUpdateEl.textContent = 'Non connecte au backend';
            }
        },

        getGlobalRevenue() {
            return CORE.db.orders.filter(o => o.status === 'delivered').reduce((a,o)=>a+(o.total||0),0);
        },

        getInventoryValue() {
            return CORE.db.products.reduce((a,p)=>a + (Number(p.price||0) * Number(p.stock||0)), 0);
        },

        getKpis() {
            const orders = CORE.db.orders;
            const deliveredRevenue = this.getGlobalRevenue();
            const pendingOrders = orders.filter(o => ['pending','confirmed','delivering'].includes(o.status)).length;
            const cancelledOrders = orders.filter(o => o.status === 'cancelled').length;
            const deliveriesInProgress = CORE.db.deliveries.filter(d => d.status === 'en_cours').length;
            const deliveriesToAssign = CORE.db.deliveries.filter(d => d.status === 'en_attente').length;
            // Calculer stockAlerts correctement (exclure le d�p��t principal, g�rer minStock = 0)
            const stockAlerts = CORE.db.products.filter(p => {
                if (p.isMainWarehouse) return false;
                const stock = p.stock || 0;
                const minStock = p.minStock || 0;
                return stock <= minStock;
            }).length;
            const inventoryValue = this.getInventoryValue();
            return {
                deliveredRevenue,
                ordersTotal: orders.length,
                pendingOrders,
                cancelledOrders,
                deliveriesInProgress,
                deliveriesToAssign,
                stockAlerts,
                inventoryValue
            };
        },

        cityStats() {
            return CORE.db.cities.map(c => {
                const posIds = CORE.db.pointsOfSale.filter(p => p.cityId === c.id).map(p => p.id);
                const orders = CORE.db.orders.filter(o => posIds.includes(o.posId));
                const revenue = orders.filter(o => o.status === 'delivered').reduce((a,o)=>a+(o.total||0),0);
                const deliveries = CORE.db.deliveries.filter(d => {
                    const o = CORE.db.orders.find(x => x.id === d.orderId);
                    return o && posIds.includes(o.posId);
                });
                return {
                    city: c,
                    posCount: posIds.length,
                    ordersCount: orders.length,
                    revenue,
                    deliveriesInProgress: deliveries.filter(d => d.status === 'en_cours').length
                };
            }).sort((a,b)=>b.revenue - a.revenue);
        },

        // ---------- Export
        downloadCSV(filename, rows) {
            const escape = (v) => {
                const s = String(v ?? '');
                if (s.includes('"') || s.includes(',') || s.includes('\n')) return `"${s.replace(/"/g,'""')}"`;
                return s;
            };
            const csv = rows.map(r => r.map(escape).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        },

        exportOrdersCSV() {
            const orders = this.getOrdersFiltered();
            const rows = [
                ['id','reference','status','total','paymentMethod','paymentStatus','pos','city','seller','createdAt'],
                ...orders.map(o => [
                    o.id,
                    o.reference,
                    o.status,
                    o.total,
                    o.paymentMethod,
                    o.paymentStatus,
                    CORE.getPOS(o.posId)?.name || '',
                    CORE.getCity(o.cityId)?.name || '',
                    CORE.getUser(o.sellerId)?.name || '',
                    o.createdAt
                ])
            ];
            this.downloadCSV(`raya_orders_${Utils.todayKey()}.csv`, rows);
        },

        exportDeliveriesCSV() {
            const deliveries = this.getDeliveriesFiltered();
            const rows = [
                ['id','orderRef','status','amount','livreur','client','phone','address','createdAt','recalledAt'],
                ...deliveries.map(d => [
                    d.id,
                    d.orderRef,
                    d.status,
                    d.amount,
                    CORE.getUser(d.livreurId)?.name || '',
                    d.clientName,
                    d.clientPhone,
                    d.address,
                    d.createdAt,
                    d.recalledAt || ''
                ])
            ];
            this.downloadCSV(`raya_deliveries_${Utils.todayKey()}.csv`, rows);
        },

        exportStockCSV() {
            const products = this.getStockFiltered();
            const rows = [
                ['id','name','category','price','stock','minStock','value'],
                ...products.map(p => [
                    p.id,
                    p.name,
                    CORE.getCategory(p.categoryId)?.name || '',
                    p.price,
                    p.stock,
                    p.minStock,
                    Number(p.price||0) * Number(p.stock||0)
                ])
            ];
            this.downloadCSV(`raya_stock_${Utils.todayKey()}.csv`, rows);
        },

        // ---------- Filters
        getOrdersFiltered() {
            const q = (document.getElementById('pdg-orders-search-input')?.value || '').toLowerCase().trim();
            const st = this.state.ordersStatus;
            let orders = [...CORE.db.orders].sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
            if (st !== 'all') orders = orders.filter(o => o.status === st);
            if (q) {
                orders = orders.filter(o =>
                    (o.reference || '').toLowerCase().includes(q) ||
                    (o.clientName || '').toLowerCase().includes(q) ||
                    (CORE.getPOS(o.posId)?.name || '').toLowerCase().includes(q)
                );
            }
            return orders;
        },

        getDeliveriesFiltered() {
            const q = (document.getElementById('pdg-deliveries-search-input')?.value || '').toLowerCase().trim();
            const st = this.state.deliveriesStatus;
            let deliveries = [...CORE.db.deliveries].sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
            if (st !== 'all') deliveries = deliveries.filter(d => d.status === st);
            if (q) {
                deliveries = deliveries.filter(d =>
                    (d.orderRef || '').toLowerCase().includes(q) ||
                    (d.clientName || '').toLowerCase().includes(q) ||
                    (CORE.getUser(d.livreurId)?.name || '').toLowerCase().includes(q)
                );
            }
            return deliveries;
        },

        getStockFiltered(paginate = true) {
            const q = (document.getElementById('pdg-stock-search-input')?.value || '').toLowerCase().trim();
            const posId = this.state.stockPosId;
            const categoryId = this.state.stockCategoryId;
            const status = this.state.stockStatus || 'all';
            const sortBy = this.state.stockSortBy || 'name';
            const sortOrder = this.state.stockSortOrder || 'asc';
            
            let products = [...CORE.db.products];
            
            // Filtre par POS
            if (posId && posId !== 'all') {
                const posIdNum = parseInt(posId);
                products = products.filter(p => p.posId === posIdNum || p.pos === posIdNum);
            }
            
            // Filtre par cat�gorie
            if (categoryId && categoryId !== 'all') {
                const catIdNum = parseInt(categoryId);
                products = products.filter(p => p.categoryId === catIdNum);
            }
            
            // Filtre par statut stock
            if (status === 'low') {
                products = products.filter(p => p.stock > 0 && p.stock <= p.minStock);
            } else if (status === 'out') {
                products = products.filter(p => p.stock <= 0);
            } else if (status === 'ok') {
                products = products.filter(p => p.stock > p.minStock);
            }
            
            // Filtre par recherche
            if (q) {
                products = products.filter(p => 
                    (p.name || '').toLowerCase().includes(q) || 
                    (p.barcode || '').toLowerCase().includes(q) ||
                    (p.sku || '').toLowerCase().includes(q) ||
                    String(p.id).includes(q)
                );
            }
            
            // Tri
            products.sort((a, b) => {
                let valA, valB;
                if (sortBy === 'name') {
                    valA = (a.name || '').toLowerCase();
                    valB = (b.name || '').toLowerCase();
                } else if (sortBy === 'stock') {
                    valA = a.stock || 0;
                    valB = b.stock || 0;
                } else if (sortBy === 'price') {
                    valA = a.price || 0;
                    valB = b.price || 0;
                } else if (sortBy === 'value') {
                    valA = (a.price || 0) * (a.stock || 0);
                    valB = (b.price || 0) * (b.stock || 0);
                } else if (sortBy === 'category') {
                    valA = CORE.getCategory(a.categoryId)?.name || '';
                    valB = CORE.getCategory(b.categoryId)?.name || '';
                } else if (sortBy === 'alert') {
                    valA = (a.stock || 0) - (a.minStock || 0);
                    valB = (b.stock || 0) - (b.minStock || 0);
                }
                if (typeof valA === 'string') {
                    if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                } else {
                    return sortOrder === 'asc' ? valA - valB : valB - valA;
                }
                return 0;
            });
            
            // Retourner tous les produits si pas de pagination (pour statistiques)
            if (!paginate) return products;
            
            // Pagination
            const page = this.state.stockPage || 1;
            const perPage = this.state.stockPerPage || 50;
            const start = (page - 1) * perPage;
            return products.slice(start, start + perPage);
        },

        getStockStats() {
            const allProducts = this.getStockFiltered(false);
            const totalFiltered = allProducts.length;
            const totalProducts = CORE.db.products.length;
            const page = this.state.stockPage || 1;
            const perPage = this.state.stockPerPage || 50;
            const totalPages = Math.ceil(totalFiltered / perPage);
            
            // Valorisation
            const totalValue = allProducts.reduce((sum, p) => sum + ((p.price || 0) * (p.stock || 0)), 0);
            const totalStock = allProducts.reduce((sum, p) => sum + (p.stock || 0), 0);
            
            // Stats par statut
            const lowStock = allProducts.filter(p => p.stock > 0 && p.stock <= p.minStock).length;
            const outOfStock = allProducts.filter(p => p.stock <= 0).length;
            const okStock = allProducts.filter(p => p.stock > p.minStock).length;
            
            // Stats par cat�gorie
            const categories = CORE.db.categories || [];
            const productsByCategory = {};
            allProducts.forEach(p => {
                const catId = p.categoryId || 0;
                productsByCategory[catId] = (productsByCategory[catId] || 0) + 1;
            });
            
            // Stats par POS
            const posList = CORE.db.pointsOfSale || [];
            const productsByPos = {};
            CORE.db.products.forEach(p => {
                const pid = p.posId || p.pos || 0;
                productsByPos[pid] = (productsByPos[pid] || 0) + 1;
            });
            
            return { 
                totalFiltered, totalProducts, page, perPage, totalPages, 
                totalValue, totalStock, lowStock, outOfStock, okStock,
                productsByCategory, productsByPos, categories, posList 
            };
        },

        updateStockSearch(value) {
            this.state.stockSearch = value;
            this.state.stockPage = 1;
            if (this.stockSearchTimer) clearTimeout(this.stockSearchTimer);
            this.stockSearchTimer = setTimeout(() => {
                const input = document.getElementById('pdg-stock-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('pdg-stock-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 400);
        },

        getTeamFiltered(paginate = true) {
            const q = (document.getElementById('pdg-team-search-input')?.value || '').toLowerCase().trim();
            const role = this.state.teamRole;
            const posId = this.state.teamPosId;
            const sortBy = this.state.teamSortBy || 'name';
            const sortOrder = this.state.teamSortOrder || 'asc';
            
            let users = [...CORE.db.users];
            
            // Filtre par r��le
            if (role !== 'all') users = users.filter(u => u.role === role);
            
            // Filtre par POS
            if (posId && posId !== 'all') {
                const posIdNum = parseInt(posId);
                users = users.filter(u => u.pos === posIdNum || u.posId === posIdNum);
            }
            
            // Filtre par recherche
            if (q) users = users.filter(u => 
                (u.name || '').toLowerCase().includes(q) || 
                (u.phone || '').toLowerCase().includes(q) ||
                (u.username || '').toLowerCase().includes(q)
            );
            
            // Tri
            users.sort((a, b) => {
                let valA, valB;
                if (sortBy === 'name') {
                    valA = (a.name || '').toLowerCase();
                    valB = (b.name || '').toLowerCase();
                } else if (sortBy === 'role') {
                    valA = a.role || '';
                    valB = b.role || '';
                } else if (sortBy === 'pos') {
                    valA = a.pos || a.posId || 0;
                    valB = b.pos || b.posId || 0;
                }
                if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Retourner tous les utilisateurs si pas de pagination (pour statistiques)
            if (!paginate) return users;
            
            // Pagination
            const page = this.state.teamPage || 1;
            const perPage = this.state.teamPerPage || 20;
            const start = (page - 1) * perPage;
            return users.slice(start, start + perPage);
        },

        getTeamStats() {
            const allUsers = this.getTeamFiltered(false);
            const totalFiltered = allUsers.length;
            const totalUsers = CORE.db.users.length;
            const page = this.state.teamPage || 1;
            const perPage = this.state.teamPerPage || 20;
            const totalPages = Math.ceil(totalFiltered / perPage);
            
            // Stats par POS
            const posList = CORE.db.pointsOfSale || [];
            const usersByPos = {};
            CORE.db.users.forEach(u => {
                const pid = u.pos || u.posId || 0;
                usersByPos[pid] = (usersByPos[pid] || 0) + 1;
            });
            
            // Stats par r��le
            const usersByRole = {};
            CORE.db.users.forEach(u => {
                usersByRole[u.role] = (usersByRole[u.role] || 0) + 1;
            });
            
            return { totalFiltered, totalUsers, page, perPage, totalPages, usersByPos, usersByRole, posList };
        },

        getTeamGroupedByPos() {
            const users = this.getTeamFiltered(false);
            const posList = CORE.db.pointsOfSale || [];
            const grouped = {};
            
            // Initialiser les groupes
            posList.forEach(pos => {
                grouped[pos.id] = { pos, users: [] };
            });
            grouped[0] = { pos: { id: 0, name: 'Non assign�' }, users: [] };
            
            // Grouper les utilisateurs
            users.forEach(u => {
                const pid = u.pos || u.posId || 0;
                if (!grouped[pid]) {
                    grouped[pid] = { pos: { id: pid, name: 'POS #' + pid }, users: [] };
                }
                grouped[pid].users.push(u);
            });
            
            // Filtrer les groupes vides et trier
            return Object.values(grouped).filter(g => g.users.length > 0).sort((a, b) => (a.pos.name || '').localeCompare(b.pos.name || ''));
        },

        updateFinanceSearch(value) {
            this.state.financeSearch = value;
            if (this.financeSearchTimer) clearTimeout(this.financeSearchTimer);
            this.financeSearchTimer = setTimeout(() => {
                const input = document.getElementById('pdg-finance-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('pdg-finance-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateOrdersSearch(value) {
            this.state.ordersSearch = value;
            if (this.ordersSearchTimer) clearTimeout(this.ordersSearchTimer);
            this.ordersSearchTimer = setTimeout(() => {
                const input = document.getElementById('pdg-orders-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('pdg-orders-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateDeliveriesSearch(value) {
            this.state.deliveriesSearch = value;
            if (this.deliveriesSearchTimer) clearTimeout(this.deliveriesSearchTimer);
            this.deliveriesSearchTimer = setTimeout(() => {
                const input = document.getElementById('pdg-deliveries-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('pdg-deliveries-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateStockSearch(value) {
            this.state.stockSearch = value;
            if (this.stockSearchTimer) clearTimeout(this.stockSearchTimer);
            this.stockSearchTimer = setTimeout(() => {
                const input = document.getElementById('pdg-stock-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('pdg-stock-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateTeamSearch(value) {
            this.state.teamSearch = value;
            this.state.teamPage = 1; // R�initialiser la pagination lors de la recherche
            if (this.teamSearchTimer) clearTimeout(this.teamSearchTimer);
            this.teamSearchTimer = setTimeout(() => {
                const input = document.getElementById('pdg-team-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('pdg-team-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        showUserDetail(userId) {
            // Redirige vers la modal de d�tails utilisateur existante
            this.showUserDetailsModal(userId);
        },

        exportTeamList() {
            const allUsers = this.getTeamFiltered(false);
            const posList = CORE.db.pointsOfSale || [];
            
            let csvContent = 'sep=,\n';
            csvContent += 'ID,Nom,Username,R��le,T�l�phone,Point de Vente,Statut,Date Cr�ation\n';
            
            allUsers.forEach(u => {
                const pos = posList.find(p => p.id === (u.pos || u.posId));
                csvContent += `${u.id},"${u.name || ''}","${u.username || ''}","${u.role || ''}","${u.phone || ''}","${pos?.name || 'Non assign�'}","${u.active !== false ? 'Actif' : 'Inactif'}","${u.createdAt || '�� ?��'}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'equipe_' + new Date().getTime() + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('Liste de l\'�quipe export�e (' + allUsers.length + ' membres)', 'success');
        },

        showProductDetail(productId) {
            const p = CORE.db.products.find(x => x.id === productId);
            if (!p) return UI.toast('Produit introuvable', 'error');
            
            const category = CORE.getCategory(p.categoryId);
            const posList = CORE.db.pointsOfSale || [];
            const pos = posList.find(pos => pos.id === (p.posId || p.pos));
            const isLow = p.stock > 0 && p.stock <= p.minStock;
            const isOut = p.stock <= 0;
            const value = (p.price || 0) * (p.stock || 0);
            
            // Historique des mouvements de stock pour ce produit
            const movements = (CORE.db.stockMovements || [])
                .filter(m => m.productId === productId)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 10);
            
            UI.modal(`��Ÿ? � ${p.name}`, `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <!-- Infos principales -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="p-4 bg-slate-50 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase">Stock actuel</div>
                            <div class="text-2xl font-black ${isOut ? 'text-red-600' : isLow ? 'text-amber-600' : 'text-emerald-600'}">${p.stock}</div>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase">Seuil min</div>
                            <div class="text-2xl font-black text-slate-900">${p.minStock || 0}</div>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase">Prix</div>
                            <div class="text-2xl font-black text-slate-900">${CORE.formatPrice(p.price)}</div>
                        </div>
                        <div class="p-4 bg-emerald-50 rounded-2xl">
                            <div class="text-xs font-black text-emerald-600 uppercase">Valeur stock</div>
                            <div class="text-2xl font-black text-emerald-700">${CORE.formatPrice(value)}</div>
                        </div>
                    </div>
                    
                    <!-- D�tails -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-3 bg-slate-50 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase">Cat�gorie</div>
                            <div class="font-bold text-slate-900">${category?.name || '�� ?��'}</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase">Point de vente</div>
                            <div class="font-bold text-slate-900">${pos?.name || 'D�p��t principal'}</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase">Code-barres</div>
                            <div class="font-bold text-slate-900">${p.barcode || '�� ?��'}</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase">SKU</div>
                            <div class="font-bold text-slate-900">${p.sku || '�� ?��'}</div>
                        </div>
                    </div>
                    
                    ${p.description ? `
                        <div class="p-3 bg-slate-50 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Description</div>
                            <div class="text-sm text-slate-700">${p.description}</div>
                        </div>
                    ` : ''}
                    
                    <!-- Statut -->
                    <div class="p-4 ${isOut ? 'bg-red-50 border-red-200' : isLow ? 'bg-amber-50 border-amber-200' : 'bg-emerald-50 border-emerald-200'} border rounded-2xl flex items-center justify-between">
                        <div>
                            <div class="text-xs font-black ${isOut ? 'text-red-600' : isLow ? 'text-amber-600' : 'text-emerald-600'} uppercase">�tat du stock</div>
                            <div class="font-black ${isOut ? 'text-red-700' : isLow ? 'text-amber-700' : 'text-emerald-700'}">${isOut ? 'Rupture de stock' : isLow ? 'Stock bas - R�approvisionnement n�cessaire' : 'Stock suffisant'}</div>
                        </div>
                        ${isOut ? UI.badge('RUPTURE','red') : isLow ? UI.badge('BAS','amber') : UI.badge('OK','emerald')}
                    </div>
                    
                    <!-- Derniers mouvements -->
                    ${movements.length > 0 ? `
                        <div class="border border-slate-200 rounded-2xl overflow-hidden">
                            <div class="p-3 bg-slate-100 border-b border-slate-200">
                                <div class="font-black text-slate-700">��Ÿ?Š Derniers mouvements (${movements.length})</div>
                            </div>
                            <div class="divide-y divide-slate-100 max-h-[200px] overflow-y-auto">
                                ${movements.map(m => `
                                    <div class="p-3 flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-slate-900">${m.type === 'in' ? '��Ÿ? � Entr�e' : m.type === 'out' ? '��Ÿ? � Sortie' : '��Ÿ�? Ajustement'}</div>
                                            <div class="text-xs text-slate-500">${m.note || '�� ?��'} �� ?� � ${CORE.formatDate(m.createdAt)}</div>
                                        </div>
                                        <div class="font-black ${m.type === 'out' ? 'text-red-600' : 'text-emerald-600'}">${m.type === 'out' ? '-' : '+'}${m.qty}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        // ---------- Details modals
        showOrderDetail(orderId) {
            const o = CORE.db.orders.find(x => x.id === orderId);
            if (!o) return;
            UI.modal(`Commande ${o.reference}`, `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Statut</div>
                            <div class="mt-1">${UI.badge(o.status, o.status==='delivered'?'emerald':o.status==='pending'?'amber':o.status==='cancelled'?'red':'slate')}</div>
                        </div>
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-right">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Total</div>
                            <div class="mt-1 text-2xl font-black text-emerald-600">${CORE.formatPrice(o.total)}</div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Client</div>
                        <div class="mt-1 font-black text-slate-900">${o.clientName || '�� ?��'}</div>
                        <div class="text-xs text-slate-600">${o.clientPhone || ''}</div>
                        <div class="mt-2 text-xs text-slate-600"><b>Adresse:</b> ${o.clientAddress || '�� ?��'}</div>
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-2">Articles</div>
                        <div class="space-y-2">
                            ${(o.items || []).map(it => `
                                <div class="flex justify-between text-sm">
                                    <div class="font-bold text-slate-800">${it.qty}�?? ${it.name}</div>
                                    <div class="font-black">${CORE.formatPrice(it.qty * it.price)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-2">Paiement</div>
                        <div class="flex items-center justify-between">
                            <div class="text-sm font-bold">M�thode</div>
                            <div class="text-sm font-black">${CORE.paymentMethodLabel(o.paymentMethod)}</div>
                        </div>
                        <div class="flex items-center justify-between mt-2">
                            <div class="text-sm font-bold">Statut</div>
                            <div>${UI.badge(CORE.paymentStatusLabel(o.paymentStatus), o.paymentStatus==='paid'?'emerald':'amber')}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Point de vente</div>
                            <div class="mt-1 font-black">${CORE.getPOS(o.posId)?.name || '�� ?��'}</div>
                            <div class="text-xs text-slate-600">Ville: ${CORE.getCity(o.cityId)?.name || '�� ?��'}</div>
                        </div>
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Vendeur</div>
                            <div class="mt-1 font-black">${CORE.getUser(o.sellerId)?.name || '�� ?��'}</div>
                            <div class="text-xs text-slate-600">Cr��e: ${CORE.formatDate(o.createdAt)}</div>
                        </div>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showDeliveryDetail(deliveryId) {
            const d = CORE.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return;
            const livreur = d.livreurId ? CORE.getUser(d.livreurId) : null;
            const pos = d.posId ? CORE.getPOS(d.posId) : null;
            const badge = d.status === 'livree' ? UI.badge('Livr�e','emerald') :
                          d.status === 'probleme' ? UI.badge('Probl��me','red') :
                          d.status === 'en_attente' ? UI.badge('�?� assigner','blue') :
                          d.status === 'annulee' ? UI.badge('Annul�e','slate') : UI.badge('En cours','amber');
            
            const hasProofPhotos = d.proofPhotos && d.proofPhotos.length > 0;
            const hasProofSignature = !!d.proofSignature;
            const hasProof = hasProofPhotos || hasProofSignature;

            UI.modal(`��Ÿ? � Livraison ${d.orderRef}`, `
                <div class="space-y-4 max-h-[75vh] overflow-y-auto">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Statut</div>
                            <div class="mt-1">${badge}</div>
                        </div>
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-right">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Montant</div>
                            <div class="mt-1 text-2xl font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Client</div>
                        <div class="mt-1 font-black text-slate-900">${d.clientName || '�� ?��'}</div>
                        <div class="text-xs text-slate-600">${d.clientPhone || ''}</div>
                        <div class="mt-2 text-xs text-slate-600"><b>Adresse:</b> ${d.address || '�� ?��'}</div>
                        ${d.deliveryTime ? `<div class="mt-1 text-xs text-slate-600"><b>Heure:</b> ${d.deliveryTime}</div>` : ''}
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Livreur</div>
                        <div class="mt-1 font-black">${livreur?.name || '�� ?��'}</div>
                        <div class="text-xs text-slate-600">${livreur?.phone || ''}</div>
                    </div>

                    ${pos ? `
                    <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-2xl">
                        <div class="text-xs font-black text-indigo-500 uppercase tracking-wider">Point de vente</div>
                        <div class="mt-1 font-black text-indigo-900">${pos.name}</div>
                        <div class="text-xs text-indigo-600">${CORE.getCity(pos.cityId)?.name || ''}</div>
                    </div>
                    ` : ''}

                    ${hasProof ? `
                    <!-- PREUVES DE LIVRAISON -->
                    <div class="p-4 bg-gradient-to-r from-emerald-50 to-teal-50 border-2 border-emerald-300 rounded-2xl">
                        <div class="text-xs font-black text-emerald-700 uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i data-lucide="camera" class="w-4 h-4"></i>
                            ��Ÿ? � Preuves de livraison
                        </div>
                        
                        ${hasProofPhotos ? `
                        <div class="mb-3">
                            <div class="text-xs font-bold text-emerald-600 mb-2">Photos (${d.proofPhotos.length})</div>
                            <div class="grid grid-cols-3 gap-2">
                                ${d.proofPhotos.map((photo, idx) => `
                                    <div class="aspect-square rounded-xl overflow-hidden border-2 border-emerald-300 cursor-pointer hover:border-emerald-500 transition shadow-md" onclick="window.open('${photo.replace(/'/g, "\\'")}', '_blank')">
                                        <img src="${photo}" class="w-full h-full object-cover hover:scale-105 transition" alt="Preuve ${idx + 1}">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${hasProofSignature ? `
                        <div>
                            <div class="text-xs font-bold text-emerald-600 mb-2">���? ��� � � Signature client</div>
                            <div class="p-3 bg-white rounded-xl border-2 border-blue-200 cursor-pointer hover:border-blue-400 transition" onclick="window.open('${d.proofSignature.replace(/'/g, "\\'")}', '_blank')">
                                <img src="${d.proofSignature}" class="w-full max-h-24 object-contain" alt="Signature">
                            </div>
                        </div>
                        ` : ''}
                        
                        ${d.proofNote ? `
                        <div class="mt-3 p-3 bg-white rounded-xl border border-emerald-200">
                            <div class="text-xs font-bold text-slate-500 mb-1">Note du livreur</div>
                            <div class="text-sm text-slate-700">${d.proofNote}</div>
                        </div>
                        ` : ''}
                        
                        <div class="text-center text-xs text-emerald-600 mt-3">
                            Valid�e le ${d.proofTimestamp ? new Date(d.proofTimestamp).toLocaleString('fr-FR') : (d.deliveredAt ? new Date(d.deliveredAt).toLocaleString('fr-FR') : '�� ?��')}
                        </div>
                    </div>
                    ` : (d.status === 'livree' ? `
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-center">
                        <div class="text-slate-400 text-sm">��Ÿ? � Aucune preuve de livraison disponible</div>
                    </div>
                    ` : '')}

                    ${d.recallReason ? `<div class="p-4 bg-amber-50 border border-amber-100 rounded-2xl text-xs text-amber-800"><b>Rappel:</b> ${d.recallReason}</div>` : ''}
                    ${d.recalledAt ? `<div class="text-xs text-slate-500">Rappel�e: ${CORE.formatDate(d.recalledAt)}</div>` : ''}
                    <div class="text-xs text-slate-500">Cr��e: ${CORE.formatDate(d.createdAt)}</div>
                    ${d.deliveredAt ? `<div class="text-xs text-emerald-600">Livr�e: ${CORE.formatDate(d.deliveredAt)}</div>` : ''}
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        // =====================
        // FINANCES (PDG)
        // =====================
        getFinanceScope() {
            const cityId = this.state.financeCityId !== '' ? parseInt(this.state.financeCityId, 10) : null;
            const posId = this.state.financePosId !== '' ? parseInt(this.state.financePosId, 10) : null;
            return { cityId: cityId || null, posId: posId || null };
        },

        getFinanceDateRange() {
            const from = (this.state.financeFrom || '').trim();
            const to = (this.state.financeTo || '').trim();
            const fromDate = from ? new Date(from + 'T00:00:00') : null;
            const toDate = to ? new Date(to + 'T23:59:59') : null;
            return { fromDate, toDate };
        },

        getTransactionsFiltered() {
            const q = (document.getElementById('pdg-finance-search-input')?.value || '').toLowerCase().trim();
            const type = this.state.financeType;
            const category = this.state.financeCategory;
            const method = this.state.financeMethod;
            const { cityId, posId } = this.getFinanceScope();
            const { fromDate, toDate } = this.getFinanceDateRange();

            let txs = [...(CORE.db.financialTransactions || [])];

            if (cityId) txs = txs.filter(t => String(t.cityId || '') === String(cityId));
            if (posId) txs = txs.filter(t => String(t.posId || '') === String(posId));

            if (fromDate) txs = txs.filter(t => new Date(t.createdAt) >= fromDate);
            if (toDate) txs = txs.filter(t => new Date(t.createdAt) <= toDate);

            if (type !== 'all') txs = txs.filter(t => t.type === type);
            if (category !== 'all') txs = txs.filter(t => t.category === category);
            if (method !== 'all') txs = txs.filter(t => t.method === method);

            if (q) {
                txs = txs.filter(t =>
                    (t.ref || '').toLowerCase().includes(q) ||
                    (t.note || '').toLowerCase().includes(q) ||
                    (t.userName || '').toLowerCase().includes(q) ||
                    String(t.amount || '').includes(q)
                );
            }

            return txs.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
        },

        getCODOutstanding() {
            const { cityId, posId } = this.getFinanceScope();
            let orders = CORE.db.orders.filter(o => o.paymentMethod === 'cod' && o.paymentStatus !== 'paid');
            if (cityId) orders = orders.filter(o => String(o.cityId || '') === String(cityId));
            if (posId) orders = orders.filter(o => String(o.posId || '') === String(posId));
            const amount = orders.reduce((a,o)=>a + Number(o.total||0), 0);
            return { count: orders.length, amount, orders };
        },

        getCommissionsDue() {
            const { cityId, posId } = this.getFinanceScope();
            let txs = (CORE.db.financialTransactions || []).filter(t => t.category === 'commission');
            if (cityId) txs = txs.filter(t => String(t.cityId || '') === String(cityId));
            if (posId) txs = txs.filter(t => String(t.posId || '') === String(posId));
            const due = txs.filter(t => !t.settled);
            const amount = due.reduce((a,t)=>a + Number(t.amount||0), 0);
            return { dueCount: due.length, dueAmount: amount, due };
        },

        getFinanceSummary() {
            const txs = this.getTransactionsFiltered();
            const income = txs.filter(t => t.type === 'income').reduce((a,t)=>a+Number(t.amount||0),0);
            const expense = txs.filter(t => t.type === 'expense').reduce((a,t)=>a+Number(t.amount||0),0);
            const net = income - expense;

            const byMethod = (m) => txs.filter(t => t.type === 'income' && t.category === 'sale' && t.method === m).reduce((a,t)=>a+Number(t.amount||0),0);
            const cash = byMethod('cash');
            const mobile = byMethod('mobile');
            const cod = byMethod('cod');

            const codOutstanding = this.getCODOutstanding();
            const commissions = this.getCommissionsDue();
            return { income, expense, net, cash, mobile, cod, codOutstanding, commissions };
        },

        exportFinanceCSV() {
            const txs = this.getTransactionsFiltered();
            const rows = [
                ['id','type','category','amount','method','ref','note','orderId','deliveryId','posId','cityId','settled','createdAt','userName'],
                ...txs.map(t => [
                    t.id,
                    t.type,
                    t.category,
                    t.amount,
                    t.method || '',
                    t.ref || '',
                    t.note || '',
                    t.orderId || '',
                    t.deliveryId || '',
                    t.posId || '',
                    t.cityId || '',
                    t.settled ? '1' : '0',
                    t.createdAt,
                    t.userName || ''
                ])
            ];
            this.downloadCSV(`raya_finance_pdg_${Utils.todayKey()}.csv`, rows);
        },

        showNewExpenseModal() {
            const expenseCategories = [
                { value: 'stock', label: '��Ÿ? � Achat de stock/produits' },
                { value: 'transport', label: '��Ÿšš Frais de transport' },
                { value: 'salaire', label: '��Ÿ? � Salaires' },
                { value: 'loyer', label: '��Ÿ � � Loyer/Local' },
                { value: 'electricite', label: '��š � �lectricit�/Eau' },
                { value: 'telephone', label: '��Ÿ? � T�l�phone/Internet' },
                { value: 'maintenance', label: '��Ÿ� � Maintenance/R�paration' },
                { value: 'hygieneEntretien', label: '��Ÿ � � Hygi��ne/Entretien' },
                { value: 'publicite', label: '��Ÿ? � Publicit�/Marketing' },
                { value: 'assurance', label: '��Ÿ� ��� � � Assurance' },
                { value: 'taxe', label: '��Ÿ? � Taxes/Imp��ts' },
                { value: 'banque', label: '��Ÿ � � Frais bancaires' },
                { value: 'deplacement', label: '��Ÿš? D�placement/Carburant' },
                { value: 'formation', label: '��Ÿ?š Formation/Cours' },
                { value: 'equipement', label: '��Ÿ� ��� � � �quipement/Mat�riel' },
                { value: 'autre', label: '��Ÿ?� Autre' }
            ];
            
            UI.modal('Nouvelle d�pense (Global)', `
                <div class="space-y-4">
                    ${UI.input('pfx_amount','Montant','number','0','ex: 25000',true)}
                    ${UI.select('pfx_category', 'Motif / Cat�gorie', expenseCategories, 'stock', true)}
                    ${UI.select('pfx_method','M�thode',[
                        {value:'cash',label:'Cash'},
                        {value:'mobile',label:'Mobile Money'},
                        {value:'internal',label:'Interne'}
                    ], 'cash', true)}
                    ${UI.select('pfx_city','Ville', [{value:'',label:'�� ?��'}].concat(CORE.db.cities.map(c=>({value:c.id,label:c.name}))), this.state.financeCityId || '')}
                    ${UI.select('pfx_pos','POS', [{value:'',label:'�� ?��'}].concat(CORE.db.pointsOfSale.map(p=>({value:p.id,label:p.name}))), this.state.financePosId || '')}
                    ${UI.input('pfx_ref','R�f�rence','text','', 'ex: FACT-2026-001', false)}
                    ${UI.textarea('pfx_note','D�tails additionnels','', 'ex: pr�cisions suppl�mentaires...', 3)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'PDGModule.saveNewExpense()', class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        saveNewExpense() {
            const amount = Number(UI.val('pfx_amount') || 0);
            const category = UI.val('pfx_category') || 'autre';
            const method = UI.val('pfx_method') || 'cash';
            const ref = UI.val('pfx_ref').trim() || null;
            const note = UI.val('pfx_note').trim();
            
            const categoryLabels = {
                'stock': 'Achat de stock/produits',
                'transport': 'Frais de transport',
                'salaire': 'Salaires',
                'loyer': 'Loyer/Local',
                'electricite': '�lectricit�/Eau',
                'telephone': 'T�l�phone/Internet',
                'maintenance': 'Maintenance/R�paration',
                'hygieneEntretien': 'Hygi��ne/Entretien',
                'publicite': 'Publicit�/Marketing',
                'assurance': 'Assurance',
                'taxe': 'Taxes/Imp��ts',
                'banque': 'Frais bancaires',
                'deplacement': 'D�placement/Carburant',
                'formation': 'Formation/Cours',
                'equipement': '�quipement/Mat�riel',
                'autre': 'Autre',
                'income_vente': 'Vente directe',
                'income_depot': 'D�p��t en caisse'
            };
            
            const categoryLabel = categoryLabels[category] || category;
            const fullNote = `[${categoryLabel}]${note ? ' ' + note : ''}`;
            
            const cityId = parseInt(UI.val('pfx_city') || '0', 10) || null;
            const posId = parseInt(UI.val('pfx_pos') || '0', 10) || null;
            if (!amount || amount <= 0) return UI.toast('Montant invalide', 'warning');
            if (!category) return UI.toast('Veuillez s�lectionner une cat�gorie', 'warning');

            CORE.recordFinancialTransaction({
                type: 'expense',
                category: 'expense',
                amount,
                method,
                ref,
                note: fullNote,
                cityId,
                posId,
                settled: true
            });
            UI.closeModal();
            UI.toast('D�pense enregistr�e', 'success');
            App.rerender();
        },

        showNewIncomeModal() {
            const incomeCategories = [
                { value: 'vente', label: '��Ÿ�? Vente directe', desc: 'Vente r�alis�e en magasin' },
                { value: 'depot_caisse', label: '��Ÿ? � D�p��t en caisse', desc: 'Ajout de fonds �� la caisse' },
                { value: 'service', label: '��Ÿ� � Service rendu', desc: 'Prestation de service factur�e' },
                { value: 'remboursement_fournisseur', label: '��� ��� � � Remboursement fournisseur', desc: 'Retour ou avoir fournisseur' },
                { value: 'investissement', label: '��Ÿ? � Investissement/Capital', desc: 'Apport de capital ou financement' },
                { value: 'pret_recu', label: '��Ÿ � � Pr��t re��u', desc: 'Pr��t bancaire ou personnel' },
                { value: 'depot_livreur', label: '��Ÿ? � D�p��t livreur', desc: 'Remise esp��ces par livreur' },
                { value: 'commission_recue', label: '��Ÿ? � Commission re��ue', desc: 'Commission sur vente ou parrainage' },
                { value: 'location', label: '��Ÿ � � Revenus location', desc: 'Loyer ou sous-location' },
                { value: 'autre_revenu', label: '��Ÿ?� Autre revenu', desc: 'Autre source de revenu' }
            ];
            
            const paymentMethods = [
                { value: 'cash', label: '��Ÿ? � Esp��ces' },
                { value: 'mobile', label: '��Ÿ? � Mobile Money' },
                { value: 'bank', label: '��Ÿ � � Virement bancaire' },
                { value: 'cheque', label: '��Ÿ? � Ch��que' },
                { value: 'card', label: '��Ÿ? � Carte bancaire' }
            ];
            
            const posOptions = CORE.db.pointsOfSale.map(p => ({value: p.id, label: p.name}));
            const cityOptions = CORE.db.cities.map(c => ({value: c.id, label: c.name}));
            
            UI.modal('Nouveau Revenu', `
                <div class="space-y-5">
                    <!-- Header avec indication visuelle -->
                    <div class="p-4 bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200 rounded-2xl">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center text-white shadow-lg shadow-emerald-500/30">
                                <i data-lucide="trending-up" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <div class="font-black text-emerald-800">Enregistrer une entr�e d'argent</div>
                                <div class="text-xs text-emerald-600">Ce revenu sera comptabilis� dans le journal financier</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Montant (champ principal) -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Montant <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input type="number" id="incomeAmount" class="w-full px-4 py-3 pr-20 text-xl font-black border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/20 transition" min="0" step="0.01" placeholder="0.00">
                            <div class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold">${CORE.db.settings?.currency || 'MAD'}</div>
                        </div>
                    </div>
                    
                    <!-- Cat�gorie avec cartes cliquables -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Cat�gorie <span class="text-red-500">*</span></label>
                        <div class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto pr-1" id="incomeCategoryGrid">
                            ${incomeCategories.map((c, i) => `
                                <div onclick="document.querySelectorAll('#incomeCategoryGrid > div').forEach(d => d.classList.remove('ring-2','ring-emerald-500','bg-emerald-50')); this.classList.add('ring-2','ring-emerald-500','bg-emerald-50'); document.getElementById('incomeCategoryValue').value='${c.value}';" 
                                     class="p-3 border-2 border-slate-200 rounded-xl cursor-pointer hover:border-emerald-300 hover:bg-emerald-50/50 transition ${i === 0 ? 'ring-2 ring-emerald-500 bg-emerald-50' : ''}">
                                    <div class="font-bold text-sm">${c.label}</div>
                                    <div class="text-xs text-slate-500 mt-0.5">${c.desc}</div>
                                </div>
                            `).join('')}
                        </div>
                        <input type="hidden" id="incomeCategoryValue" value="vente">
                    </div>
                    
                    <!-- Point de vente et M�thode -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Point de vente <span class="text-red-500">*</span></label>
                            <select id="incomePosId" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/20 transition font-medium">
                                ${posOptions.map(p => `<option value="${p.value}">${p.label}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">M�thode de paiement</label>
                            <select id="incomeMethod" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/20 transition font-medium">
                                ${paymentMethods.map(m => `<option value="${m.value}">${m.label}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Description et R�f�rence -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Description</label>
                        <textarea id="incomeDescription" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/20 transition font-medium resize-none" rows="2" placeholder="D�tails du revenu (optionnel)..."></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">R�f�rence</label>
                        <input type="text" id="incomeReference" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/20 transition font-medium" placeholder="N�? � re��u, facture, bordereau... (optionnel)">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()', class: 'px-5 py-2.5 border border-slate-300 text-slate-700 font-bold rounded-xl hover:bg-slate-50 transition' },
                { label: '��Ÿ? � Enregistrer le revenu', onclick: 'PDGModule.saveNewIncome()', class: 'px-6 py-2.5 bg-gradient-to-r from-emerald-500 to-green-600 text-white font-black rounded-xl hover:from-emerald-600 hover:to-green-700 shadow-lg shadow-emerald-500/30 transition' }
            ]);
            setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 50);
        },

        saveNewIncome() {
            const posId = document.getElementById('incomePosId')?.value;
            const category = document.getElementById('incomeCategoryValue')?.value || 'vente';
            const amount = parseFloat(document.getElementById('incomeAmount')?.value) || 0;
            const description = document.getElementById('incomeDescription')?.value?.trim() || '';
            const method = document.getElementById('incomeMethod')?.value || 'cash';
            const reference = document.getElementById('incomeReference')?.value?.trim() || '';

            if (!posId) return UI.toast('S�lectionnez un point de vente', 'warning');
            if (amount <= 0) return UI.toast('Montant invalide', 'warning');

            const categoryLabels = {
                'vente': 'Vente directe',
                'depot_caisse': 'D�p��t en caisse',
                'service': 'Service rendu',
                'remboursement_fournisseur': 'Remboursement fournisseur',
                'investissement': 'Investissement/Capital',
                'pret_recu': 'Pr��t re��u',
                'depot_livreur': 'D�p��t livreur',
                'commission_recue': 'Commission re��ue',
                'location': 'Revenus location',
                'autre_revenu': 'Autre revenu'
            };

            const tx = {
                id: CORE.generateId(),
                type: 'income',
                category: category,
                amount: amount,
                method: method,
                description: description || categoryLabels[category] || category,
                note: `[${categoryLabels[category] || category}]${description ? ' ' + description : ''}`,
                reference: reference,
                posId: posId,
                date: new Date().toISOString(),
                createdAt: new Date().toISOString(),
                createdBy: App.currentUser?.id,
                userName: App.currentUser?.name || 'PDG'
            };

            CORE.db.financialTransactions = CORE.db.financialTransactions || [];
            CORE.db.financialTransactions.push(tx);
            CORE.save();
            UI.closeModal();
            UI.toast('���?� Revenu de ' + CORE.formatPrice(amount) + ' enregistr�', 'success');
            App.rerender();
        },

        markCODCollected(orderId) {
            const o = CORE.db.orders.find(x => x.id === orderId);
            if (!o) return;
            if (o.paymentMethod !== 'cod') return UI.toast('Ce n�� ?� ?�est pas une commande COD', 'warning');
            const updated = CORE.update('orders', o.id, { paymentStatus: 'paid' });
            CORE.ensureSaleTransaction(updated);
            UI.toast('COD marqu� comme encaiss�', 'success');
            App.rerender();
        },

        markTransactionSettled(txId) {
            const tx = (CORE.db.financialTransactions || []).find(t => t.id === txId);
            if (!tx) return;
            if (tx.settled) return UI.toast('D�j�� r�gl�', 'info');
            CORE.update('financialTransactions', tx.id, { settled: true, settledAt: new Date().toISOString() });
            UI.toast('Transaction r�gl�e', 'success');
            App.rerender();
        },

        renderFinance() {
            const tab = this.state.financeTab;
            const summary = this.getFinanceSummary();
            const txs = this.getTransactionsFiltered();
            const cod = this.getCODOutstanding();
            const commissions = this.getCommissionsDue();
            const scope = this.getFinanceScope();

            const cityOptions = [{value:'',label:'Toutes villes'}, ...CORE.db.cities.map(c=>({value:c.id,label:c.name}))];
            const posOptions = [{value:'',label:'Tous POS'}, ...CORE.db.pointsOfSale.map(p=>({value:p.id,label:p.name}))];
            
            const categories = [
                { value:'all', label:'Toutes cat�gories' },
                { value:'sale', label:'Ventes' },
                { value:'expense', label:'D�penses' },
                { value:'commission', label:'Commissions' }
            ];
            const methods = [
                { value:'all', label:'Toutes m�thodes' },
                { value:'cash', label:'Cash' },
                { value:'mobile', label:'Mobile Money' },
                { value:'cod', label:'Paiement �� la livraison' },
                { value:'internal', label:'Interne' }
            ];

            // Calculer les donn�es pour le graphique cash-flow
            const cashFlowData = this.getCashFlowLast7Days ? this.getCashFlowLast7Days() : [];
            
            // Top d�penses par cat�gorie
            const expenseByCategory = {};
            txs.filter(t => t.type === 'expense').forEach(t => {
                const cat = t.category || 'autre';
                expenseByCategory[cat] = (expenseByCategory[cat] || 0) + (t.amount || 0);
            });
            const topExpenseCategories = Object.entries(expenseByCategory).sort((a, b) => b[1] - a[1]).slice(0, 5);

            // R�partition par m�thode de paiement
            const paymentMethods = {
                cash: summary.cash || 0,
                mobile: summary.mobile || 0,
                cod: summary.cod || 0,
                card: summary.card || 0
            };
            const totalPayments = Object.values(paymentMethods).reduce((a, b) => a + b, 0) || 1;

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <!-- Header avec gradient et navigation -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                                    <i data-lucide="wallet" class="w-6 h-6"></i>
                                </div>
                                Finance Command Center
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Vue globale: encaissements, COD, commissions, d�penses & journal</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="PDGModule.showNewExpenseModal()" class="px-4 py-2.5 bg-red-500 text-white font-black rounded-xl hover:bg-red-600 transition flex items-center gap-2">
                                <i data-lucide="minus-circle" class="w-4 h-4"></i> Nouvelle d�pense
                            </button>
                            <button onclick="PDGModule.showNewIncomeModal()" class="px-4 py-2.5 bg-emerald-500 text-white font-black rounded-xl hover:bg-emerald-600 transition flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> Nouveau revenu
                            </button>
                            <button onclick="CORE.rebuildFinancialTransactions(); App.rerender()" class="px-4 py-2.5 bg-amber-500 text-white font-black rounded-xl hover:bg-amber-600 transition flex items-center gap-2" title="R�g�n�rer les transactions">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Actualiser
                            </button>
                            <button onclick="PDGModule.exportFinanceCSV()" class="px-4 py-2.5 bg-white border border-slate-200 text-slate-700 font-black rounded-xl hover:bg-slate-50 transition flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> Exporter
                            </button>
                        </div>
                    </div>

                    <!-- KPIs Principaux avec gradients -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-5 text-white shadow-lg shadow-emerald-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-up" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Encaissements</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(summary.income)}</div>
                                <div class="text-xs opacity-70 mt-2">Cash ${CORE.formatPrice(summary.cash)} �� ?� � Mobile ${CORE.formatPrice(summary.mobile)}</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl p-5 text-white shadow-lg shadow-red-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-down" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">D�penses</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(summary.expense)}</div>
                                <div class="text-xs opacity-70 mt-2">Inclut commissions & charges</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-5 text-white shadow-lg shadow-blue-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="bar-chart-3" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">B�n�fice Net</span>
                                </div>
                                <div class="text-3xl font-black">${summary.net >= 0 ? '+' : ''}${CORE.formatPrice(summary.net)}</div>
                                <div class="text-xs opacity-70 mt-2">Encaissements ���?? d�penses</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-5 text-white shadow-lg shadow-amber-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="truck" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">COD �� encaisser</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(cod.amount)}</div>
                                <div class="text-xs opacity-70 mt-2">${cod.count} commande(s) en attente</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <div class="flex flex-wrap gap-2">
                                <button onclick="PDGModule.state.financeTab='overview';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='overview'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Vue</button>
                                <button onclick="PDGModule.state.financeTab='transactions';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='transactions'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Journal</button>
                                <button onclick="PDGModule.state.financeTab='cod';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='cod'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">COD</button>
                                <button onclick="PDGModule.state.financeTab='commissions';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='commissions'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Commissions</button>
                            </div>

                            <div class="flex flex-wrap gap-2">
                                <select onchange="PDGModule.state.financeCityId=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${cityOptions.map(o => `<option value="${o.value}" ${String(o.value)===String(this.state.financeCityId)?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                                <select onchange="PDGModule.state.financePosId=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${posOptions.map(o => `<option value="${o.value}" ${String(o.value)===String(this.state.financePosId)?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                                <input type="date" value="${this.state.financeFrom ? this.formatDateForInput(this.state.financeFrom) : ''}" onchange="PDGModule.state.financeFrom=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                                <input type="date" value="${this.state.financeTo ? this.formatDateForInput(this.state.financeTo) : ''}" onchange="PDGModule.state.financeTo=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                            </div>
                        </div>

                        ${tab === 'overview' ? `
                            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <!-- Colonne gauche: Commissions + R�partition paiements -->
                                <div class="lg:col-span-2 space-y-6">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="bg-slate-50 border border-slate-200 rounded-3xl p-5">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Commissions �� payer</div>
                                                    <div class="mt-2 text-2xl font-black text-red-600">${CORE.formatPrice(commissions.dueAmount)}</div>
                                                    <div class="text-xs text-slate-500">${commissions.dueCount} course(s)</div>
                                                </div>
                                                <div class="w-12 h-12 bg-red-100 rounded-2xl flex items-center justify-center text-red-600"><i data-lucide="hand-coins" class="w-6 h-6"></i></div>
                                            </div>
                                        </div>
                                        <div class="bg-slate-50 border border-slate-200 rounded-3xl p-5">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Transactions</div>
                                                    <div class="mt-2 text-2xl font-black text-slate-900">${txs.length}</div>
                                                    <div class="text-xs text-slate-500">P�rim��tre: ${scope.cityId ? CORE.getCity(scope.cityId)?.name : 'Global'}</div>
                                                </div>
                                                <div class="w-12 h-12 bg-slate-200 rounded-2xl flex items-center justify-center text-slate-700"><i data-lucide="list" class="w-6 h-6"></i></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- R�partition par m�thode de paiement -->
                                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                        <h3 class="text-lg font-black text-slate-900 flex items-center gap-2 mb-6">
                                            <i data-lucide="credit-card" class="w-5 h-5 text-blue-500"></i>
                                            R�partition par M�thode de Paiement
                                        </h3>
                                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                            <div class="text-center p-4 bg-slate-50 rounded-xl">
                                                <div class="w-12 h-12 bg-slate-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                                    <i data-lucide="banknote" class="w-6 h-6 text-slate-600"></i>
                                                </div>
                                                <div class="text-lg font-black text-slate-900">${CORE.formatPrice(paymentMethods.cash)}</div>
                                                <div class="text-xs text-slate-500 font-bold">Cash</div>
                                                <div class="text-[10px] text-slate-400">${Math.round((paymentMethods.cash / totalPayments) * 100)}%</div>
                                            </div>
                                            <div class="text-center p-4 bg-blue-50 rounded-xl">
                                                <div class="w-12 h-12 bg-blue-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                                    <i data-lucide="smartphone" class="w-6 h-6 text-blue-600"></i>
                                                </div>
                                                <div class="text-lg font-black text-blue-900">${CORE.formatPrice(paymentMethods.mobile)}</div>
                                                <div class="text-xs text-blue-700 font-bold">Mobile Money</div>
                                                <div class="text-[10px] text-blue-500">${Math.round((paymentMethods.mobile / totalPayments) * 100)}%</div>
                                            </div>
                                            <div class="text-center p-4 bg-amber-50 rounded-xl">
                                                <div class="w-12 h-12 bg-amber-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                                    <i data-lucide="truck" class="w-6 h-6 text-amber-600"></i>
                                                </div>
                                                <div class="text-lg font-black text-amber-900">${CORE.formatPrice(paymentMethods.cod)}</div>
                                                <div class="text-xs text-amber-700 font-bold">COD</div>
                                                <div class="text-[10px] text-amber-500">${Math.round((paymentMethods.cod / totalPayments) * 100)}%</div>
                                            </div>
                                            <div class="text-center p-4 bg-indigo-50 rounded-xl">
                                                <div class="w-12 h-12 bg-indigo-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                                    <i data-lucide="credit-card" class="w-6 h-6 text-indigo-600"></i>
                                                </div>
                                                <div class="text-lg font-black text-indigo-900">${CORE.formatPrice(paymentMethods.card || 0)}</div>
                                                <div class="text-xs text-indigo-700 font-bold">Carte</div>
                                                <div class="text-[10px] text-indigo-500">${Math.round(((paymentMethods.card || 0) / totalPayments) * 100)}%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Colonne droite: Actions rapides + Top d�penses -->
                                <div class="space-y-6">
                                    <!-- Actions rapides -->
                                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 text-white">
                                        <h3 class="text-lg font-black mb-4 flex items-center gap-2">
                                            <i data-lucide="zap" class="w-5 h-5 text-amber-400"></i>
                                            Actions Rapides
                                        </h3>
                                        <div class="space-y-3">
                                            <button onclick="PDGModule.showNewExpenseModal()" class="w-full px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                                <i data-lucide="minus-circle" class="w-5 h-5"></i>
                                                Enregistrer une d�pense
                                            </button>
                                            <button onclick="PDGModule.state.financeTab='cod';App.rerender()" class="w-full px-4 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                                <i data-lucide="truck" class="w-5 h-5"></i>
                                                G�rer COD en attente
                                            </button>
                                            <button onclick="PDGModule.state.financeTab='commissions';App.rerender()" class="w-full px-4 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                                <i data-lucide="hand-coins" class="w-5 h-5"></i>
                                                Payer commissions
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Top d�penses par cat�gorie -->
                                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                        <h3 class="text-lg font-black text-slate-900 flex items-center gap-2 mb-4">
                                            <i data-lucide="pie-chart" class="w-5 h-5 text-red-500"></i>
                                            Top D�penses
                                        </h3>
                                        ${topExpenseCategories.length === 0 ? '<div class="text-center py-4 text-slate-400 text-sm">Aucune d�pense enregistr�e</div>' : 
                                            '<div class="space-y-3">' + topExpenseCategories.map(([cat, amount], i) => {
                                                const colors = ['bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-yellow-500', 'bg-lime-500'];
                                                const maxAmount = topExpenseCategories[0][1] || 1;
                                                return '<div class="flex items-center gap-3"><div class="w-8 h-8 ' + colors[i] + ' rounded-lg flex items-center justify-center text-white text-xs font-black">' + (i + 1) + '</div><div class="flex-1"><div class="flex justify-between mb-1"><span class="text-sm font-bold text-slate-700 capitalize">' + cat + '</span><span class="text-sm font-black text-red-600">' + CORE.formatPrice(amount) + '</span></div><div class="h-2 bg-slate-100 rounded-full overflow-hidden"><div class="' + colors[i] + ' h-full rounded-full" style="width: ' + ((amount / maxAmount) * 100) + '%"></div></div></div></div>';
                                            }).join('') + '</div>'
                                        }
                                        <button onclick="PDGModule.state.financeTab='transactions';PDGModule.state.financeType='expense';App.rerender()" class="w-full mt-4 px-4 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-200 transition">
                                            Voir toutes les d�penses ���?
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${tab === 'transactions' ? `
                            <div class="p-4 border-t border-slate-100 flex flex-wrap gap-2 items-center">
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input id="pdg-finance-search-input" type="text" value="${this.state.financeSearch}" onkeyup="PDGModule.updateFinanceSearch(this.value)" placeholder="Recherche (ref, note, montant...)" class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium w-[280px] max-w-full" style="direction: ltr; text-align: left;" autocomplete="off">
                                </div>
                                <select onchange="PDGModule.state.financeType=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${[
                                        {value:'all',label:'Tous types'},
                                        {value:'income',label:'Encaissements'},
                                        {value:'expense',label:'D�penses'}
                                    ].map(o=>`<option value="${o.value}" ${o.value===this.state.financeType?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                                <select onchange="PDGModule.state.financeCategory=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${categories.map(o=>`<option value="${o.value}" ${o.value===this.state.financeCategory?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                                <select onchange="PDGModule.state.financeMethod=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${methods.map(o=>`<option value="${o.value}" ${o.value===this.state.financeMethod?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                            </div>

                            <div class="overflow-auto">
                                <table class="w-full text-left min-w-[1100px]">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">Type</th>
                                            <th class="px-6 py-4">Cat�gorie</th>
                                            <th class="px-6 py-4 text-right">Montant</th>
                                            <th class="px-6 py-4">M�thode</th>
                                            <th class="px-6 py-4">R�f�rence / Note</th>
                                            <th class="px-6 py-4">Statut</th>
                                            <th class="px-6 py-4 text-right">Date</th>
                                            <th class="px-6 py-4 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${txs.length===0 ? `<tr><td colspan="8" class="px-6 py-12 text-center text-slate-400 font-medium">Aucune transaction</td></tr>` : ''}
                                        ${txs.map(t => {
                                            const amount = CORE.formatPrice(t.amount);
                                            const sign = t.type==='income' ? '+' : '-';
                                            const color = t.type==='income' ? 'text-emerald-600' : 'text-red-600';
                                            const statusBadge = t.settled ? UI.badge('R�gl�','emerald') : UI.badge('�?� r�gler','amber');
                                            return `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-6 py-4 font-black text-slate-900">${t.type}</td>
                                                <td class="px-6 py-4">${UI.badge(t.category, t.category==='sale'?'emerald':t.category==='commission'?'amber':t.category==='expense'?'red':'slate')}</td>
                                                <td class="px-6 py-4 text-right font-black ${color}">${sign} ${amount}</td>
                                                <td class="px-6 py-4 font-bold">${CORE.paymentMethodLabel(t.method)}</td>
                                                <td class="px-6 py-4">
                                                    <div class="font-black text-slate-900">${t.ref || '�� ?��'}</div>
                                                    <div class="text-xs text-slate-500">${t.note || ''}</div>
                                                </td>
                                                <td class="px-6 py-4">${statusBadge}</td>
                                                <td class="px-6 py-4 text-right text-xs text-slate-500">${CORE.formatDate(t.createdAt)}</td>
                                                <td class="px-6 py-4 text-right">
                                                    ${(!t.settled && t.category==='commission') ? `<button onclick="PDGModule.markTransactionSettled(${t.id})" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-black hover:bg-slate-800">Marquer pay�</button>` : '<span class="text-xs text-slate-400">�� ?��</span>'}
                                                </td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                        ${tab === 'cod' ? `
                            <div class="p-4">
                                <div class="p-4 bg-amber-50 border border-amber-100 rounded-2xl text-sm text-amber-800">
                                    <b>COD �� encaisser:</b> commandes en paiement �� la livraison dont le paiement n�� ?� ?�est pas encore marqu� "Pay�".
                                </div>
                            </div>
                            <div class="overflow-auto">
                                <table class="w-full text-left min-w-[980px]">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">R�f</th>
                                            <th class="px-6 py-4">Client</th>
                                            <th class="px-6 py-4">POS</th>
                                            <th class="px-6 py-4">Statut cmd</th>
                                            <th class="px-6 py-4">Statut paiement</th>
                                            <th class="px-6 py-4 text-right">Montant</th>
                                            <th class="px-6 py-4 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${cod.orders.length===0 ? `<tr><td colspan="7" class="px-6 py-12 text-center text-slate-400 font-medium">Aucun COD en attente</td></tr>` : ''}
                                        ${cod.orders.map(o => `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-6 py-4 font-black text-slate-900">${o.reference}</td>
                                                <td class="px-6 py-4">
                                                    <div class="font-bold">${o.clientName || '�� ?��'}</div>
                                                    <div class="text-xs text-slate-500">${o.clientPhone || ''}</div>
                                                </td>
                                                <td class="px-6 py-4 font-bold">${CORE.getPOS(o.posId)?.name || '�� ?��'}</td>
                                                <td class="px-6 py-4">${UI.badge(o.status, o.status==='delivered'?'emerald':o.status==='delivering'?'amber':'slate')}</td>
                                                <td class="px-6 py-4">${UI.badge(CORE.paymentStatusLabel(o.paymentStatus), o.paymentStatus==='paid'?'emerald':'amber')}</td>
                                                <td class="px-6 py-4 text-right font-black text-amber-700">${CORE.formatPrice(o.total)}</td>
                                                <td class="px-6 py-4 text-right">
                                                    <button onclick="PDGModule.markCODCollected(${o.id})" class="px-3 py-2 rounded-xl bg-amber-500 text-white text-xs font-black hover:bg-amber-600">Marquer encaiss�</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                        ${tab === 'commissions' ? `
                            <div class="p-4">
                                <div class="p-4 bg-red-50 border border-red-100 rounded-2xl text-sm text-red-800">
                                    <b>Commissions:</b> d�penses de type "commission" (souvent �� r�gler au livreur).
                                </div>
                            </div>
                            <div class="overflow-auto">
                                <table class="w-full text-left min-w-[980px]">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">R�f</th>
                                            <th class="px-6 py-4">Livreur</th>
                                            <th class="px-6 py-4">Statut</th>
                                            <th class="px-6 py-4 text-right">Montant</th>
                                            <th class="px-6 py-4 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${commissions.due.length===0 ? `<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400 font-medium">Aucune commission �� payer</td></tr>` : ''}
                                        ${commissions.due.map(t => {
                                            const del = t.deliveryId ? CORE.db.deliveries.find(d => d.id === t.deliveryId) : null;
                                            const livreur = del?.livreurId ? CORE.getUser(del.livreurId) : null;
                                            return `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-6 py-4 font-black text-slate-900">${t.ref || '�� ?��'}</td>
                                                <td class="px-6 py-4 font-bold">${livreur?.name || '�� ?��'}</td>
                                                <td class="px-6 py-4">${UI.badge('�?� payer','amber')}</td>
                                                <td class="px-6 py-4 text-right font-black text-red-600">${CORE.formatPrice(t.amount)}</td>
                                                <td class="px-6 py-4 text-right"><button onclick="PDGModule.markTransactionSettled(${t.id})" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-black hover:bg-slate-800">Marquer pay�</button></td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                    </div>
                </div>
            `;
        },

        // ---------- Views
        renderKpiCard(label, value, icon, accent = 'text-indigo-600', bg = 'bg-indigo-50', trend = null, trendValue = null) {
            return `
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm card-hover relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-32 h-32 ${bg} rounded-full -mr-16 -mt-16 opacity-50 group-hover:opacity-75 transition-opacity"></div>
                    <div class="relative">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-14 h-14 ${bg} ${accent} rounded-2xl flex items-center justify-center shadow-sm">
                                <i data-lucide="${icon}" class="w-7 h-7"></i>
                            </div>
                            ${trend ? `
                                <div class="px-2.5 py-1 rounded-lg ${trend === 'up' ? 'bg-emerald-100 text-emerald-700' : trend === 'down' ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-600'} text-xs font-black flex items-center gap-1">
                                    <i data-lucide="trending-${trend === 'up' ? 'up' : trend === 'down' ? 'down' : 'right'}" class="w-3 h-3"></i>
                                    ${trendValue || ''}
                                </div>
                            ` : ''}
                        </div>
                        <div class="text-3xl font-black text-slate-900 mb-1">${value}</div>
                        <div class="text-sm text-slate-500 font-bold uppercase tracking-wider">${label}</div>
                    </div>
                </div>`;
        },

        // Nouveau: Calculer les tendances r�elles bas�es sur les donn�es
        calculateTrends() {
            const today = new Date();
            const todayStr = today.toDateString();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toDateString();
            
            // CA aujourd'hui vs hier
            const todayOrders = CORE.db.orders.filter(o => o.status === 'delivered' && o.createdAt && new Date(o.createdAt).toDateString() === todayStr);
            const yesterdayOrders = CORE.db.orders.filter(o => o.status === 'delivered' && o.createdAt && new Date(o.createdAt).toDateString() === yesterdayStr);
            const todayRevenue = todayOrders.reduce((a, o) => a + (o.total || 0), 0);
            const yesterdayRevenue = yesterdayOrders.reduce((a, o) => a + (o.total || 0), 0);
            
            // Commandes aujourd'hui vs hier
            const todayOrdersCount = CORE.db.orders.filter(o => o.createdAt && new Date(o.createdAt).toDateString() === todayStr).length;
            const yesterdayOrdersCount = CORE.db.orders.filter(o => o.createdAt && new Date(o.createdAt).toDateString() === yesterdayStr).length;
            
            // Calcul des 7 derniers jours de CA
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const dayOrders = CORE.db.orders.filter(o => o.status === 'delivered' && o.createdAt && new Date(o.createdAt).toDateString() === d.toDateString());
                last7Days.push({
                    date: d,
                    day: ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'][d.getDay()],
                    revenue: dayOrders.reduce((a, o) => a + (o.total || 0), 0),
                    count: dayOrders.length
                });
            }
            
            const calculateChange = (current, previous) => {
                if (previous === 0) return current > 0 ? { trend: 'up', value: '+100%' } : { trend: 'neutral', value: '0%' };
                const change = ((current - previous) / previous * 100).toFixed(1);
                return {
                    trend: change > 0 ? 'up' : change < 0 ? 'down' : 'neutral',
                    value: `${change > 0 ? '+' : ''}${change}%`
                };
            };
            
            return {
                revenue: calculateChange(todayRevenue, yesterdayRevenue),
                orders: calculateChange(todayOrdersCount, yesterdayOrdersCount),
                todayRevenue,
                todayOrdersCount,
                last7Days,
                avgDaily: last7Days.reduce((a, d) => a + d.revenue, 0) / 7
            };
        },

        // Nouveau: Sant� du syst��me
        getSystemHealth() {
            const metrics = [];
            const products = CORE.db.products || [];
            const orders = CORE.db.orders || [];
            const users = CORE.db.users || [];
            const deliveries = CORE.db.deliveries || [];
            
            // Stock sant� (exclure le d�p��t principal)
            const activeProducts = products.filter(p => !p.isMainWarehouse);
            const lowStock = activeProducts.filter(p => {
                const stock = p.stock || 0;
                const minStock = p.minStock || 0;
                return stock <= minStock;
            }).length;
            const outOfStock = activeProducts.filter(p => (p.stock || 0) === 0).length;
            const stockHealth = activeProducts.length > 0 ? Math.round(((activeProducts.length - lowStock) / activeProducts.length) * 100) : 100;
            metrics.push({ label: 'Stock', value: stockHealth, color: stockHealth > 80 ? 'emerald' : stockHealth > 50 ? 'amber' : 'red', icon: 'package', detail: `${lowStock} alertes, ${outOfStock} ruptures` });
            
            // Livraisons sant�
            const problematicDeliveries = deliveries.filter(d => d.status === 'probleme').length;
            const pendingDeliveries = deliveries.filter(d => d.status === 'en_attente').length;
            const totalActiveDeliveries = deliveries.filter(d => !['livree', 'annulee'].includes(d.status)).length;
            const deliveryHealth = totalActiveDeliveries > 0 ? Math.round(((totalActiveDeliveries - problematicDeliveries) / totalActiveDeliveries) * 100) : 100;
            metrics.push({ label: 'Livraisons', value: deliveryHealth, color: deliveryHealth > 80 ? 'emerald' : deliveryHealth > 50 ? 'amber' : 'red', icon: 'truck', detail: `${pendingDeliveries} en attente, ${problematicDeliveries} probl��mes` });
            
            // Utilisateurs actifs
            const activeUsers = users.filter(u => u.active).length;
            const userHealth = users.length > 0 ? Math.round((activeUsers / users.length) * 100) : 100;
            metrics.push({ label: '�quipe', value: userHealth, color: userHealth > 80 ? 'emerald' : userHealth > 50 ? 'amber' : 'red', icon: 'users', detail: `${activeUsers}/${users.length} actifs` });
            
            // Taux de conversion commandes livr�es
            const deliveredOrders = orders.filter(o => o.status === 'delivered').length;
            const conversionRate = orders.length > 0 ? Math.round((deliveredOrders / orders.length) * 100) : 100;
            metrics.push({ label: 'Conversion', value: conversionRate, color: conversionRate > 70 ? 'emerald' : conversionRate > 40 ? 'amber' : 'red', icon: 'target', detail: `${deliveredOrders}/${orders.length} livr�es` });
            
            const avgHealth = Math.round(metrics.reduce((a, m) => a + m.value, 0) / metrics.length);
            
            return { metrics, avgHealth };
        },

        renderOverview() {
            const k = this.getKpis();
            const cityStats = this.cityStats();
            const pendingDeleteRequests = this.getPendingPOSRequests();
            const trends = this.calculateTrends();
            const systemHealth = this.getSystemHealth();

            // Alertes urgentes
            const criticalAlerts = [];
            if (k.stockAlerts > 0) criticalAlerts.push({ type: 'stock', count: k.stockAlerts, color: 'red', icon: 'alert-circle', msg: `${k.stockAlerts} article(s) en stock critique`, action: "PDGModule.navigateTo('stock')" });
            if (k.pendingOrders > 0) criticalAlerts.push({ type: 'orders', count: k.pendingOrders, color: 'amber', icon: 'clock', msg: `${k.pendingOrders} commandes en attente`, action: "PDGModule.navigateTo('orders')" });
            if (k.deliveriesToAssign > 0) criticalAlerts.push({ type: 'deliveries', count: k.deliveriesToAssign, color: 'blue', icon: 'user-plus', msg: `${k.deliveriesToAssign} livraisons �� assigner`, action: "PDGModule.navigateTo('deliveries')" });
            const inactiveUsers = (CORE.db.users || []).filter(u => !u.active).length;
            if (inactiveUsers > 0) criticalAlerts.push({ type: 'users', count: inactiveUsers, color: 'slate', icon: 'user-x', msg: `${inactiveUsers} utilisateur(s) inactif(s)`, action: "PDGModule.navigateTo('team')" });

            const topPOS = CORE.db.pointsOfSale.map(p => {
                const orders = CORE.db.orders.filter(o => o.posId === p.id);
                const delivered = orders.filter(o => o.status === 'delivered');
                const revenue = delivered.reduce((a,o)=>a+(o.total||0),0);
                const avgTicket = delivered.length > 0 ? revenue / delivered.length : 0;
                return { pos: p, revenue, orders: orders.length, delivered: delivered.length, avgTicket };
            }).sort((a,b)=>b.revenue-a.revenue).slice(0,5);

            const lastOrders = [...CORE.db.orders].sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).slice(0,5);
            const lastDeliveries = [...CORE.db.deliveries].sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).slice(0,5);
            
            // Statistiques utilisateurs
            const activeUsers = (CORE.db.users || []).filter(u => u.active).length;
            const totalUsers = (CORE.db.users || []).length;
            
            // R�partition des commandes par statut
            const ordersByStatus = {
                delivered: CORE.db.orders.filter(o => o.status === 'delivered').length,
                pending: CORE.db.orders.filter(o => o.status === 'pending').length,
                confirmed: CORE.db.orders.filter(o => o.status === 'confirmed').length,
                cancelled: CORE.db.orders.filter(o => o.status === 'cancelled').length
            };
            const totalOrdersForChart = Object.values(ordersByStatus).reduce((a,b)=>a+b,0) || 1;

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <!-- HEADER AVEC DATE ET REFRESH -->
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h1 class="text-3xl font-black text-slate-900">Tableau de Bord PDG</h1>
                            <p class="text-slate-500 font-medium mt-1">
                                <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>
                                ${new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                            </p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="App.rerender()" class="px-4 py-2.5 bg-slate-100 text-slate-700 rounded-xl font-bold hover:bg-slate-200 transition flex items-center gap-2">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Actualiser
                            </button>
                            <button onclick="PDGModule.showSettingsModal()" class="px-4 py-2.5 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition flex items-center gap-2">
                                <i data-lucide="settings" class="w-4 h-4"></i> Param��tres
                            </button>
                        </div>
                    </div>

                    ${pendingDeleteRequests.length > 0 ? `
                        <div class="p-5 rounded-3xl border-2 border-amber-300 bg-gradient-to-r from-amber-50 to-orange-50 shadow-sm">
                            <div class="flex items-center justify-between flex-wrap gap-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-14 h-14 bg-amber-100 rounded-2xl flex items-center justify-center text-amber-600 shadow-sm">
                                        <i data-lucide="bell-ring" class="w-7 h-7"></i>
                                    </div>
                                    <div>
                                        <div class="font-black text-amber-900 text-lg">��Ÿ�� Demandes d'approbation en attente</div>
                                        <div class="text-sm text-amber-800">${pendingDeleteRequests.length} demande(s) de POS (cr�ation/suppression) requi��rent votre attention</div>
                                    </div>
                                </div>
                                <button onclick="UI.modal('Demandes de POS', PDGModule.renderApprovalsModal(), [{label:'Fermer', onclick:'UI.closeModal()'}])" class="px-5 py-3 bg-amber-600 text-white font-black rounded-xl hover:bg-amber-700 transition shadow-sm flex items-center gap-2">
                                    <i data-lucide="eye" class="w-4 h-4"></i> Voir demandes
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    <!-- ALERTES CRITIQUES -->
                    ${criticalAlerts.length > 0 ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            ${criticalAlerts.map(alert => `
                                <button onclick="${alert.action}" class="p-4 rounded-2xl border-2 border-${alert.color}-300 bg-gradient-to-br from-${alert.color}-50 to-${alert.color}-100 flex items-center gap-3 hover:shadow-md transition-all hover:scale-[1.02] text-left w-full">
                                    <div class="w-12 h-12 bg-${alert.color}-200 rounded-xl flex items-center justify-center flex-shrink-0 shadow-sm">
                                        <i data-lucide="${alert.icon}" class="w-6 h-6 text-${alert.color}-700"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-black text-${alert.color}-900 text-sm truncate">${alert.msg}</div>
                                        <div class="text-xs text-${alert.color}-700 flex items-center gap-1 mt-0.5">
                                            <i data-lucide="arrow-right" class="w-3 h-3"></i> Cliquer pour voir
                                        </div>
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- KPIs PRINCIPAUX -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        ${this.renderKpiCard('Chiffre d\'affaires', CORE.formatPrice(k.deliveredRevenue), 'wallet', 'text-emerald-600', 'bg-emerald-50', trends.revenue.trend, trends.revenue.value)}
                        ${this.renderKpiCard('Commandes totales', k.ordersTotal, 'shopping-cart', 'text-indigo-600', 'bg-indigo-50', trends.orders.trend, trends.orders.value)}
                        ${this.renderKpiCard('Valeur stock', CORE.formatPrice(k.inventoryValue), 'package', 'text-amber-600', 'bg-amber-50')}
                        ${this.renderKpiCard('Points de vente', CORE.db.pointsOfSale?.length || 0, 'store', 'text-violet-600', 'bg-violet-50')}
                    </div>

                    
                    <!-- STATISTIQUES BACKEND / CLOUD -->
                    <div id="serverStatsCard" class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl p-6 text-white shadow-xl">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                            <div>
                                <h3 class="text-xl font-black flex items-center gap-2">
                                    <i data-lucide="cloud" class="w-6 h-6 text-cyan-300"></i>
                                    Donnees Backend (Cloud)
                                </h3>
                                <p class="text-blue-200 text-sm">Donnees synchronisees avec le serveur central</p>
                            </div>
                            <button onclick="PDGModule.refreshServerStats()" class="px-4 py-2 bg-white/20 rounded-xl font-bold hover:bg-white/30 transition flex items-center gap-2">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Actualiser
                            </button>
                        </div>
                        <div id="serverStatsContent" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-white/10 backdrop-blur rounded-2xl p-4 text-center">
                                <div class="text-3xl font-black" id="serverStatProducts">...</div>
                                <div class="text-xs text-blue-200 uppercase tracking-wider mt-1">Produits</div>
                            </div>
                            <div class="bg-white/10 backdrop-blur rounded-2xl p-4 text-center">
                                <div class="text-3xl font-black" id="serverStatOrders">...</div>
                                <div class="text-xs text-blue-200 uppercase tracking-wider mt-1">Commandes</div>
                            </div>
                            <div class="bg-white/10 backdrop-blur rounded-2xl p-4 text-center">
                                <div class="text-3xl font-black" id="serverStatCustomers">...</div>
                                <div class="text-xs text-blue-200 uppercase tracking-wider mt-1">Clients</div>
                            </div>
                            <div class="bg-white/10 backdrop-blur rounded-2xl p-4 text-center">
                                <div class="text-3xl font-black" id="serverStatRevenue">...</div>
                                <div class="text-xs text-blue-200 uppercase tracking-wider mt-1">CA Serveur</div>
                            </div>
                        </div>
                        <p class="text-xs text-blue-300 mt-4 text-center" id="serverStatsLastUpdate">Chargement...</p>
                    </div>

                    <!-- SANT� DU SYST�?ME -->
                    <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-3xl p-6 text-white shadow-xl">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                            <div>
                                <h3 class="text-xl font-black flex items-center gap-2">
                                    <i data-lucide="activity" class="w-6 h-6 text-emerald-400"></i>
                                    Sant� du Syst��me
                                </h3>
                                <p class="text-slate-400 text-sm">Vue d'ensemble de la performance op�rationnelle</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="text-right">
                                    <div class="text-4xl font-black ${systemHealth.avgHealth > 80 ? 'text-emerald-400' : systemHealth.avgHealth > 50 ? 'text-amber-400' : 'text-red-400'}">${systemHealth.avgHealth}%</div>
                                    <div class="text-xs text-slate-400 uppercase tracking-wider">Score Global</div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            ${systemHealth.metrics.map(m => `
                                <div class="bg-slate-800/50 backdrop-blur rounded-2xl p-4 border border-slate-700">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-10 h-10 bg-${m.color}-500/20 rounded-xl flex items-center justify-center">
                                            <i data-lucide="${m.icon}" class="w-5 h-5 text-${m.color}-400"></i>
                                        </div>
                                        <div class="font-black text-white">${m.label}</div>
                                    </div>
                                    <div class="relative h-2 bg-slate-700 rounded-full overflow-hidden mb-2">
                                        <div class="absolute inset-y-0 left-0 bg-gradient-to-r from-${m.color}-500 to-${m.color}-400 rounded-full transition-all" style="width: ${m.value}%"></div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs text-slate-400">${m.detail}</span>
                                        <span class="text-sm font-black text-${m.color}-400">${m.value}%</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- ACTIONS RAPIDES -->
                    <section class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-black text-slate-900 flex items-center gap-2">
                                <i data-lucide="zap" class="w-5 h-5 text-amber-500"></i> Actions rapides
                            </h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Gestion POS -->
                            <button onclick="PDGModule.navigateTo('pos')" class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all hover:scale-[1.02] text-left text-white group">
                                <div class="w-12 h-12 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                    <i data-lucide="store" class="w-6 h-6"></i>
                                </div>
                                <div class="font-black text-lg">Gestion POS</div>
                                <div class="text-indigo-200 text-sm mt-1">G�rer les points de vente</div>
                                <div class="mt-4 flex items-end justify-between">
                                    <div class="text-3xl font-black">${CORE.db.pointsOfSale?.length || 0}</div>
                                    <i data-lucide="arrow-right" class="w-5 h-5 opacity-50 group-hover:opacity-100 group-hover:translate-x-1 transition-all"></i>
                                </div>
                            </button>

                            <!-- Finances -->
                            <button onclick="PDGModule.navigateTo('finance')" class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all hover:scale-[1.02] text-left text-white group">
                                <div class="w-12 h-12 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                    <i data-lucide="wallet" class="w-6 h-6"></i>
                                </div>
                                <div class="font-black text-lg">Finances</div>
                                <div class="text-emerald-200 text-sm mt-1">Vue financi��re compl��te</div>
                                <div class="mt-4 flex items-end justify-between">
                                    <div class="text-2xl font-black">${CORE.formatPrice(k.deliveredRevenue)}</div>
                                    <i data-lucide="arrow-right" class="w-5 h-5 opacity-50 group-hover:opacity-100 group-hover:translate-x-1 transition-all"></i>
                                </div>
                            </button>

                            <!-- �quipe -->
                            <button onclick="PDGModule.navigateTo('team')" class="bg-gradient-to-br from-violet-500 to-violet-600 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all hover:scale-[1.02] text-left text-white group">
                                <div class="w-12 h-12 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                    <i data-lucide="users" class="w-6 h-6"></i>
                                </div>
                                <div class="font-black text-lg">�quipe</div>
                                <div class="text-violet-200 text-sm mt-1">G�rer les utilisateurs</div>
                                <div class="mt-4 flex items-end justify-between">
                                    <div class="text-3xl font-black">${activeUsers}<span class="text-lg text-violet-200">/${totalUsers}</span></div>
                                    <i data-lucide="arrow-right" class="w-5 h-5 opacity-50 group-hover:opacity-100 group-hover:translate-x-1 transition-all"></i>
                                </div>
                            </button>

                            <!-- Stock -->
                            <button onclick="PDGModule.navigateTo('stock')" class="bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all hover:scale-[1.02] text-left text-white group">
                                <div class="w-12 h-12 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                    <i data-lucide="package" class="w-6 h-6"></i>
                                </div>
                                <div class="font-black text-lg">Stock Global</div>
                                <div class="text-amber-200 text-sm mt-1">Inventaire et alertes</div>
                                <div class="mt-4 flex items-end justify-between">
                                    <div class="text-3xl font-black">${k.stockAlerts} <span class="text-lg text-amber-200">alertes</span></div>
                                    <i data-lucide="arrow-right" class="w-5 h-5 opacity-50 group-hover:opacity-100 group-hover:translate-x-1 transition-all"></i>
                                </div>
                            </button>
                        </div>
                    </section>

                    <!-- GRAPHIQUES ET STATS -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Graphique CA 7 jours -->
                        <div class="lg:col-span-2 bg-white rounded-3xl border border-slate-200 p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h3 class="font-black text-slate-900 text-lg">��Ÿ?Š Tendance CA (7 derniers jours)</h3>
                                    <div class="text-sm text-slate-500">�volution du chiffre d'affaires quotidien</div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="px-3 py-1.5 rounded-full ${trends.revenue.trend === 'up' ? 'bg-emerald-50 text-emerald-700' : trends.revenue.trend === 'down' ? 'bg-red-50 text-red-700' : 'bg-slate-50 text-slate-600'} text-xs font-black flex items-center gap-1">
                                        <i data-lucide="trending-${trends.revenue.trend === 'up' ? 'up' : trends.revenue.trend === 'down' ? 'down' : 'right'}" class="w-4 h-4"></i>
                                        ${trends.revenue.value}
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-3">
                                ${trends.last7Days.map((d, i) => {
                                    const maxVal = Math.max(...trends.last7Days.map(x => x.revenue), 1);
                                    const percent = (d.revenue / maxVal) * 100;
                                    const isToday = i === trends.last7Days.length - 1;
                                    return `
                                        <div class="flex items-center gap-3 ${isToday ? 'bg-indigo-50 -mx-2 px-2 py-2 rounded-xl' : ''}">
                                            <span class="text-xs font-black ${isToday ? 'text-indigo-700' : 'text-slate-600'} w-10">${d.day}</span>
                                            <div class="flex-1 h-8 bg-slate-100 rounded-lg overflow-hidden relative">
                                                <div class="absolute inset-y-0 left-0 bg-gradient-to-r ${isToday ? 'from-indigo-500 to-indigo-600' : 'from-slate-400 to-slate-500'} rounded-lg transition-all duration-500" style="width: ${percent}%"></div>
                                                <div class="absolute inset-0 flex items-center justify-end pr-3">
                                                    <span class="text-xs font-black ${percent > 50 ? 'text-white' : 'text-slate-700'}">${d.count} cmd</span>
                                                </div>
                                            </div>
                                            <span class="text-sm font-black ${isToday ? 'text-indigo-700' : 'text-slate-900'} w-24 text-right">${CORE.formatPrice(d.revenue)}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-100 flex items-center justify-between">
                                <div class="text-sm text-slate-500">Moyenne journali��re</div>
                                <div class="font-black text-slate-900">${CORE.formatPrice(Math.round(trends.avgDaily))}</div>
                            </div>
                        </div>

                        <!-- R�partition des commandes -->
                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-6 border-b border-slate-100">
                                <h3 class="font-black text-slate-900">��Ÿ? � R�partition commandes</h3>
                                <div class="text-sm text-slate-500">Par statut</div>
                            </div>
                            <div class="p-6">
                                <!-- Donut Chart Visual -->
                                <div class="relative w-40 h-40 mx-auto mb-6">
                                    <svg viewBox="0 0 100 100" class="transform -rotate-90">
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#f1f5f9" stroke-width="12"/>
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#10b981" stroke-width="12" 
                                            stroke-dasharray="${(ordersByStatus.delivered / totalOrdersForChart) * 251.2} 251.2" stroke-linecap="round"/>
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#f59e0b" stroke-width="12" 
                                            stroke-dasharray="${(ordersByStatus.pending / totalOrdersForChart) * 251.2} 251.2" 
                                            stroke-dashoffset="${-(ordersByStatus.delivered / totalOrdersForChart) * 251.2}" stroke-linecap="round"/>
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#6366f1" stroke-width="12" 
                                            stroke-dasharray="${(ordersByStatus.confirmed / totalOrdersForChart) * 251.2} 251.2" 
                                            stroke-dashoffset="${-((ordersByStatus.delivered + ordersByStatus.pending) / totalOrdersForChart) * 251.2}" stroke-linecap="round"/>
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#ef4444" stroke-width="12" 
                                            stroke-dasharray="${(ordersByStatus.cancelled / totalOrdersForChart) * 251.2} 251.2" 
                                            stroke-dashoffset="${-((ordersByStatus.delivered + ordersByStatus.pending + ordersByStatus.confirmed) / totalOrdersForChart) * 251.2}" stroke-linecap="round"/>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center flex-col">
                                        <div class="text-2xl font-black text-slate-900">${k.ordersTotal}</div>
                                        <div class="text-xs text-slate-500">Total</div>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between p-2 rounded-xl hover:bg-slate-50">
                                        <div class="flex items-center gap-2">
                                            <div class="w-3 h-3 rounded-full bg-emerald-500"></div>
                                            <span class="text-sm font-medium text-slate-700">Livr�es</span>
                                        </div>
                                        <span class="font-black text-slate-900">${ordersByStatus.delivered}</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 rounded-xl hover:bg-slate-50">
                                        <div class="flex items-center gap-2">
                                            <div class="w-3 h-3 rounded-full bg-amber-500"></div>
                                            <span class="text-sm font-medium text-slate-700">En attente</span>
                                        </div>
                                        <span class="font-black text-slate-900">${ordersByStatus.pending}</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 rounded-xl hover:bg-slate-50">
                                        <div class="flex items-center gap-2">
                                            <div class="w-3 h-3 rounded-full bg-indigo-500"></div>
                                            <span class="text-sm font-medium text-slate-700">Confirm�es</span>
                                        </div>
                                        <span class="font-black text-slate-900">${ordersByStatus.confirmed}</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 rounded-xl hover:bg-slate-50">
                                        <div class="flex items-center gap-2">
                                            <div class="w-3 h-3 rounded-full bg-red-500"></div>
                                            <span class="text-sm font-medium text-slate-700">Annul�es</span>
                                        </div>
                                        <span class="font-black text-slate-900">${ordersByStatus.cancelled}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PERFORMANCE PAR VILLE & TOP POS -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                                <div>
                                    <h3 class="font-black text-slate-900">��Ÿ � ?��� � � Performance par ville</h3>
                                    <p class="text-sm text-slate-500">Classement par chiffre d'affaires</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="PDGModule.navigateTo('finance')" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-xs font-black hover:bg-slate-200 transition">Finances</button>
                                    <button onclick="PDGModule.navigateTo('orders')" class="px-3 py-1.5 rounded-lg bg-indigo-100 text-indigo-700 text-xs font-black hover:bg-indigo-200 transition">Commandes</button>
                                </div>
                            </div>
                            <div class="p-4 space-y-2">
                                ${cityStats.length === 0 ? `<div class="p-8 text-center text-slate-400">Aucune ville configur�e</div>` : ''}
                                ${cityStats.map((s, i) => {
                                    const maxRevenue = Math.max(...cityStats.map(x => x.revenue), 1);
                                    const percent = (s.revenue / maxRevenue) * 100;
                                    return `
                                    <div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 transition flex items-center gap-4 group">
                                        <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl flex items-center justify-center font-black text-white text-lg shadow-sm">${i + 1}</div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2">
                                                <div class="font-black text-slate-900">${s.city.name}</div>
                                                <span class="text-xs text-slate-400">${s.posCount} POS</span>
                                            </div>
                                            <div class="mt-1.5 h-2 bg-slate-100 rounded-full overflow-hidden">
                                                <div class="h-full bg-gradient-to-r from-indigo-500 to-indigo-400 rounded-full transition-all" style="width: ${percent}%"></div>
                                            </div>
                                            <div class="text-xs text-slate-500 mt-1">${s.ordersCount} commandes �� ?� � ${s.deliveriesInProgress} livraisons en cours</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-lg text-slate-900">${CORE.formatPrice(s.revenue)}</div>
                                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">CA Total</div>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                                <div>
                                    <h3 class="font-black text-slate-900">��Ÿ �� Top 5 POS</h3>
                                    <p class="text-sm text-slate-500">Meilleurs points de vente</p>
                                </div>
                            </div>
                            <div class="p-4 space-y-2">
                                ${topPOS.length === 0 ? `<div class="p-8 text-center text-slate-400">Aucun POS</div>` : ''}
                                ${topPOS.map((x, i) => `
                                    <button onclick="PDGModule.openPosInventory(${x.pos.id})" class="w-full text-left p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 transition group">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 ${i === 0 ? 'bg-amber-100 text-amber-700' : i === 1 ? 'bg-slate-200 text-slate-700' : i === 2 ? 'bg-orange-100 text-orange-700' : 'bg-slate-100 text-slate-600'} rounded-lg flex items-center justify-center font-black text-sm">
                                                ${i + 1}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="font-black text-slate-900 truncate">${x.pos.name}</div>
                                                <div class="text-xs text-slate-500">${CORE.getCity(x.pos.cityId)?.name || ''} �� ?� � ${x.delivered}/${x.orders} livr�es</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-black text-emerald-600">${CORE.formatPrice(x.revenue)}</div>
                                                <div class="text-[10px] text-slate-400">Moy: ${CORE.formatPrice(Math.round(x.avgTicket))}</div>
                                            </div>
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- DERNI�?RES ACTIVIT�S -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
                                        <i data-lucide="shopping-cart" class="w-5 h-5 text-indigo-600"></i>
                                    </div>
                                    <h3 class="font-black text-slate-900">Derni��res commandes</h3>
                                </div>
                                <button onclick="PDGModule.navigateTo('orders')" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-xs font-black hover:bg-slate-200 transition flex items-center gap-1">
                                    Tout voir <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                </button>
                            </div>
                            <div class="divide-y divide-slate-50">
                                ${lastOrders.length === 0 ? `<div class="p-8 text-center text-slate-400">Aucune commande</div>` : ''}
                                ${lastOrders.map(o => `
                                    <button onclick="PDGModule.showOrderDetail(${o.id})" class="w-full text-left p-4 hover:bg-slate-50 flex items-center justify-between transition">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center">
                                                <i data-lucide="receipt" class="w-5 h-5 text-slate-600"></i>
                                            </div>
                                            <div>
                                                <div class="font-black text-slate-900">${o.reference}</div>
                                                <div class="text-xs text-slate-500">${CORE.getPOS(o.posId)?.name || '�� ?��'} �� ?� � ${CORE.formatDate(o.createdAt)}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black">${CORE.formatPrice(o.total)}</div>
                                            ${UI.badge(o.status, o.status==='delivered'?'emerald':o.status==='pending'?'amber':o.status==='cancelled'?'red':'slate')}
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
                                        <i data-lucide="truck" class="w-5 h-5 text-amber-600"></i>
                                    </div>
                                    <h3 class="font-black text-slate-900">Derni��res livraisons</h3>
                                </div>
                                <button onclick="PDGModule.navigateTo('deliveries')" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-xs font-black hover:bg-slate-200 transition flex items-center gap-1">
                                    Tout voir <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                </button>
                            </div>
                            <div class="divide-y divide-slate-50">
                                ${lastDeliveries.length === 0 ? `<div class="p-8 text-center text-slate-400">Aucune livraison</div>` : ''}
                                ${lastDeliveries.map(d => {
                                    const badge = d.status === 'livree' ? UI.badge('Livr�e','emerald') : d.status === 'en_attente' ? UI.badge('�?� assigner','blue') : d.status === 'probleme' ? UI.badge('Probl��me','red') : UI.badge('En cours','amber');
                                    return `
                                    <button onclick="PDGModule.showDeliveryDetail(${d.id})" class="w-full text-left p-4 hover:bg-slate-50 flex items-center justify-between transition">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center">
                                                <i data-lucide="package" class="w-5 h-5 text-slate-600"></i>
                                            </div>
                                            <div>
                                                <div class="font-black text-slate-900">${d.orderRef}</div>
                                                <div class="text-xs text-slate-500">${d.clientName} �� ?� � ${CORE.getUser(d.livreurId)?.name || 'Non assign�'}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black">${CORE.formatPrice(d.amount)}</div>
                                            ${badge}
                                        </div>
                                    </button>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        renderOrders() {
            const orders = this.getOrdersFiltered();
            const statuses = [
                { value: 'all', label: 'Tous statuts' },
                { value: 'pending', label: 'Pending' },
                { value: 'delivered', label: 'Delivered' },
                { value: 'cancelled', label: 'Cancelled' }
            ];

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">Commandes (Global)</h2>
                            <p class="text-slate-500 font-medium">Recherche, filtre, export et d�tails.</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="PDGModule.exportOrdersCSV()" class="px-4 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition">Exporter CSV</button>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex flex-col md:flex-row md:items-center gap-3 justify-between">
                            <div class="text-sm font-black text-slate-700">${orders.length} r�sultat(s)</div>
                            <div class="flex gap-3">
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input id="pdg-orders-search-input" type="text" value="${this.state.ordersSearch}" onkeyup="PDGModule.updateOrdersSearch(this.value)" placeholder="Ref, client, POS..." class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium" style="direction: ltr; text-align: left;" autocomplete="off">
                                </div>
                                <select onchange="PDGModule.state.ordersStatus=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${statuses.map(s => `<option value="${s.value}" ${s.value===this.state.ordersStatus?'selected':''}>${s.label}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="overflow-auto">
                            <table class="w-full text-left min-w-[980px]">
                                <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4">R�f�rence</th>
                                        <th class="px-6 py-4">Client</th>
                                        <th class="px-6 py-4">POS</th>
                                        <th class="px-6 py-4">Ville</th>
                                        <th class="px-6 py-4">Paiement</th>
                                        <th class="px-6 py-4 text-right">Total</th>
                                        <th class="px-6 py-4">Statut</th>
                                        <th class="px-6 py-4">Cr��e</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${orders.length === 0 ? `<tr><td colspan="8" class="px-6 py-10 text-center text-slate-400">Aucune commande</td></tr>` : ''}
                                    ${orders.map(o => `
                                        <tr class="hover:bg-slate-50 cursor-pointer" onclick="PDGModule.showOrderDetail(${o.id})">
                                            <td class="px-6 py-4 font-black text-slate-900">${o.reference}</td>
                                            <td class="px-6 py-4">
                                                <div class="font-bold text-slate-900">${o.clientName || '�� ?��'}</div>
                                                <div class="text-xs text-slate-500">${o.clientPhone || ''}</div>
                                            </td>
                                            <td class="px-6 py-4 font-bold">${CORE.getPOS(o.posId)?.name || '�� ?��'}</td>
                                            <td class="px-6 py-4 text-slate-600">${CORE.getCity(o.cityId)?.name || '�� ?��'}</td>
                                            <td class="px-6 py-4">
                                                <div class="text-sm font-black">${CORE.paymentMethodLabel(o.paymentMethod)}</div>
                                                <div class="text-xs">${UI.badge(CORE.paymentStatusLabel(o.paymentStatus), o.paymentStatus==='paid'?'emerald':'amber')}</div>
                                            </td>
                                            <td class="px-6 py-4 text-right font-black">${CORE.formatPrice(o.total)}</td>
                                            <td class="px-6 py-4">${UI.badge(o.status, o.status==='delivered'?'emerald':o.status==='pending'?'amber':o.status==='cancelled'?'red':'slate')}</td>
                                            <td class="px-6 py-4 text-xs text-slate-500">${CORE.formatDate(o.createdAt)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        },

        renderDeliveries() {
            const deliveries = this.getDeliveriesFiltered();
            const statuses = [
                { value: 'all', label: 'Tous statuts' },
                { value: 'en_cours', label: 'En cours' },
                { value: 'en_attente', label: '�?� assigner' },
                { value: 'livree', label: 'Livr�e' },
                { value: 'probleme', label: 'Probl��me' },
                { value: 'annulee', label: 'Annul�e' }
            ];

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">Livraisons (Global)</h2>
                            <p class="text-slate-500 font-medium">Suivi, statuts, rappels, export.</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="PDGModule.exportDeliveriesCSV()" class="px-4 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition">Exporter CSV</button>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex flex-col md:flex-row md:items-center gap-3 justify-between">
                            <div class="text-sm font-black text-slate-700">${deliveries.length} r�sultat(s)</div>
                            <div class="flex gap-3">
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input id="pdg-deliveries-search-input" type="text" value="${this.state.deliveriesSearch}" onkeyup="PDGModule.updateDeliveriesSearch(this.value)" placeholder="Ref, client, livreur..." class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium" style="direction: ltr; text-align: left;" autocomplete="off">
                                </div>
                                <select onchange="PDGModule.state.deliveriesStatus=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${statuses.map(s => `<option value="${s.value}" ${s.value===this.state.deliveriesStatus?'selected':''}>${s.label}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="overflow-auto">
                            <table class="w-full text-left min-w-[980px]">
                                <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4">Commande</th>
                                        <th class="px-6 py-4">Client</th>
                                        <th class="px-6 py-4">Livreur</th>
                                        <th class="px-6 py-4">Statut</th>
                                        <th class="px-6 py-4 text-right">Montant</th>
                                        <th class="px-6 py-4">Cr��e</th>
                                        <th class="px-6 py-4">Rappel</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${deliveries.length === 0 ? `<tr><td colspan="7" class="px-6 py-10 text-center text-slate-400">Aucune livraison</td></tr>` : ''}
                                    ${deliveries.map(d => {
                                        const badge = d.status === 'livree' ? UI.badge('Livr�e','emerald') : d.status === 'en_attente' ? UI.badge('�?� assigner','blue') : d.status === 'probleme' ? UI.badge('Probl��me','red') : d.status === 'annulee' ? UI.badge('Annul�e','slate') : UI.badge('En cours','amber');
                                        return `
                                        <tr class="hover:bg-slate-50 cursor-pointer" onclick="PDGModule.showDeliveryDetail(${d.id})">
                                            <td class="px-6 py-4 font-black text-slate-900">${d.orderRef}</td>
                                            <td class="px-6 py-4">
                                                <div class="font-bold">${d.clientName || '�� ?��'}</div>
                                                <div class="text-xs text-slate-500">${d.address || ''}</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="font-bold">${CORE.getUser(d.livreurId)?.name || '�� ?��'}</div>
                                                <div class="text-xs text-slate-500">${CORE.getUser(d.livreurId)?.phone || ''}</div>
                                            </td>
                                            <td class="px-6 py-4">${badge}</td>
                                            <td class="px-6 py-4 text-right font-black">${CORE.formatPrice(d.amount)}</td>
                                            <td class="px-6 py-4 text-xs text-slate-500">${CORE.formatDate(d.createdAt)}</td>
                                            <td class="px-6 py-4 text-xs text-slate-500">${d.recalledAt ? CORE.formatDate(d.recalledAt) : '�� ?��'}</td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        },

        renderStock() {
            const products = this.getStockFiltered();
            const stats = this.getStockStats();
            const viewMode = this.state.stockViewMode || 'table';
            const posList = CORE.db.pointsOfSale || [];
            const categories = CORE.db.categories || [];

            const statusOptions = [
                { value: 'all', label: 'Tous les statuts' },
                { value: 'ok', label: '���?� Stock OK' },
                { value: 'low', label: '��š ��� � � Stock bas' },
                { value: 'out', label: '�� ��? Rupture' }
            ];

            const sortOptions = [
                { value: 'name', label: 'Nom' },
                { value: 'stock', label: 'Quantit�' },
                { value: 'price', label: 'Prix' },
                { value: 'value', label: 'Valeur' },
                { value: 'category', label: 'Cat�gorie' },
                { value: 'alert', label: 'Niveau alerte' }
            ];

            const perPageOptions = [25, 50, 100, 200];

            // Rendu de la pagination
            const renderPagination = () => {
                if (stats.totalPages <= 1) return '';
                const pages = [];
                const maxVisible = 7;
                let start = Math.max(1, stats.page - Math.floor(maxVisible / 2));
                let end = Math.min(stats.totalPages, start + maxVisible - 1);
                if (end - start < maxVisible - 1) start = Math.max(1, end - maxVisible + 1);
                
                for (let i = start; i <= end; i++) pages.push(i);
                
                return `<div class="flex items-center justify-center gap-2 p-4 border-t border-slate-100">
                    <button onclick="PDGModule.state.stockPage = 1; App.rerender()" class="px-3 py-2 rounded-lg ${stats.page === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${stats.page === 1 ? 'disabled' : ''}><i data-lucide="chevrons-left" class="w-4 h-4"></i></button>
                    <button onclick="PDGModule.state.stockPage = Math.max(1, PDGModule.state.stockPage - 1); App.rerender()" class="px-3 py-2 rounded-lg ${stats.page === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${stats.page === 1 ? 'disabled' : ''}><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    ${pages.map(p => `<button onclick="PDGModule.state.stockPage = ${p}; App.rerender()" class="px-3 py-2 rounded-lg ${p === stats.page ? 'bg-indigo-600 text-white' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm">${p}</button>`).join('')}
                    <button onclick="PDGModule.state.stockPage = Math.min(${stats.totalPages}, PDGModule.state.stockPage + 1); App.rerender()" class="px-3 py-2 rounded-lg ${stats.page === stats.totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${stats.page === stats.totalPages ? 'disabled' : ''}><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <button onclick="PDGModule.state.stockPage = ${stats.totalPages}; App.rerender()" class="px-3 py-2 rounded-lg ${stats.page === stats.totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${stats.page === stats.totalPages ? 'disabled' : ''}><i data-lucide="chevrons-right" class="w-4 h-4"></i></button>
                    <span class="ml-4 text-sm text-slate-500">Page ${stats.page} / ${stats.totalPages}</span>
                </div>`;
            };

            // Rendu d'une ligne de table de produit
            const renderProductRow = (p) => {
                const isLow = p.stock > 0 && p.stock <= p.minStock;
                const isOut = p.stock <= 0;
                const value = Number(p.price||0) * Number(p.stock||0);
                const pos = posList.find(pos => pos.id === (p.posId || p.pos));
                const statusBadge = isOut ? UI.badge('Rupture','red') : isLow ? UI.badge('Bas','amber') : UI.badge('OK','emerald');
                
                return `<tr class="hover:bg-slate-50 cursor-pointer" onclick="PDGModule.showProductDetail(${p.id})">
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-slate-100 flex items-center justify-center text-slate-600 font-bold text-xs">${(p.name || '?').slice(0,2).toUpperCase()}</div>
                            <div>
                                <div class="font-black text-slate-900">${p.name}</div>
                                <div class="text-[10px] text-slate-400">#${p.barcode || p.sku || p.id}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3"><span class="px-2 py-1 bg-slate-100 rounded-lg text-xs font-bold text-slate-600">${CORE.getCategory(p.categoryId)?.name || '�� ?��'}</span></td>
                    <td class="px-4 py-3"><span class="text-[10px] text-indigo-600 font-bold bg-indigo-50 px-2 py-1 rounded">${pos?.name || 'Global'}</span></td>
                    <td class="px-4 py-3 text-right font-black">${CORE.formatPrice(p.price)}</td>
                    <td class="px-4 py-3 text-center font-black ${isOut ? 'text-red-600' : isLow ? 'text-amber-600' : 'text-slate-900'}">${p.stock}</td>
                    <td class="px-4 py-3 text-center text-slate-500">${p.minStock}</td>
                    <td class="px-4 py-3 text-right font-black">${CORE.formatPrice(value)}</td>
                    <td class="px-4 py-3">${statusBadge}</td>
                </tr>`;
            };

            // Rendu d'une carte de produit (vue cards)
            const renderProductCard = (p) => {
                const isLow = p.stock > 0 && p.stock <= p.minStock;
                const isOut = p.stock <= 0;
                const value = Number(p.price||0) * Number(p.stock||0);
                const pos = posList.find(pos => pos.id === (p.posId || p.pos));
                const borderColor = isOut ? 'border-red-200 bg-red-50/30' : isLow ? 'border-amber-200 bg-amber-50/30' : 'border-slate-100';
                
                return `<div class="p-4 rounded-2xl border ${borderColor} hover:shadow-md transition cursor-pointer" onclick="PDGModule.showProductDetail(${p.id})">
                    <div class="flex items-start justify-between gap-2 mb-3">
                        <div class="font-black text-slate-900 truncate">${p.name}</div>
                        ${isOut ? UI.badge('Rupture','red') : isLow ? UI.badge('Bas','amber') : UI.badge('OK','emerald')}
                    </div>
                    <div class="text-xs text-slate-500 mb-2">${CORE.getCategory(p.categoryId)?.name || '�� ?��'} ${pos ? '�� ?� � ' + pos.name : ''}</div>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="p-2 bg-white rounded-xl">
                            <div class="text-[10px] text-slate-400 uppercase">Stock</div>
                            <div class="font-black ${isOut ? 'text-red-600' : isLow ? 'text-amber-600' : 'text-slate-900'}">${p.stock}</div>
                        </div>
                        <div class="p-2 bg-white rounded-xl">
                            <div class="text-[10px] text-slate-400 uppercase">Prix</div>
                            <div class="font-black text-slate-900">${CORE.formatPrice(p.price)}</div>
                        </div>
                        <div class="p-2 bg-white rounded-xl">
                            <div class="text-[10px] text-slate-400 uppercase">Valeur</div>
                            <div class="font-black text-emerald-600">${CORE.formatPrice(value)}</div>
                        </div>
                    </div>
                </div>`;
            };

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">��Ÿ? � Stock Global</h2>
                            <p class="text-slate-500 font-medium">${stats.totalProducts} produits au total �� ?� � ${posList.length} points de vente</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="PDGModule.showAddProductModal && PDGModule.showAddProductModal()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Nouveau produit
                            </button>
                            <button onclick="PDGModule.exportStockCSV()" class="px-4 py-2 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> Export CSV
                            </button>
                        </div>
                    </div>

                    <!-- Statistiques rapides -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        <div class="p-4 bg-white rounded-2xl border border-slate-200">
                            <div class="text-slate-500 text-xs font-black uppercase">Valorisation</div>
                            <div class="text-xl font-black text-slate-900 mt-1">${CORE.formatPrice(stats.totalValue)}</div>
                        </div>
                        <div class="p-4 bg-white rounded-2xl border border-slate-200">
                            <div class="text-slate-500 text-xs font-black uppercase">Total Stock</div>
                            <div class="text-xl font-black text-slate-900 mt-1">${stats.totalStock.toLocaleString()}</div>
                        </div>
                        <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                            <div class="text-emerald-600 text-xs font-black uppercase">Stock OK</div>
                            <div class="text-xl font-black text-emerald-700 mt-1">${stats.okStock}</div>
                        </div>
                        <div class="p-4 bg-amber-50 rounded-2xl border border-amber-100">
                            <div class="text-amber-600 text-xs font-black uppercase">Stock bas</div>
                            <div class="text-xl font-black text-amber-700 mt-1">${stats.lowStock}</div>
                        </div>
                        <div class="p-4 bg-red-50 rounded-2xl border border-red-100">
                            <div class="text-red-600 text-xs font-black uppercase">Ruptures</div>
                            <div class="text-xl font-black text-red-700 mt-1">${stats.outOfStock}</div>
                        </div>
                        <div class="p-4 bg-indigo-50 rounded-2xl border border-indigo-100">
                            <div class="text-indigo-600 text-xs font-black uppercase">Cat�gories</div>
                            <div class="text-xl font-black text-indigo-700 mt-1">${categories.length}</div>
                        </div>
                    </div>

                    <!-- Filtres avanc�s -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 space-y-4">
                            <!-- Ligne 1: Recherche et filtres principaux -->
                            <div class="flex flex-wrap gap-3">
                                <div class="relative flex-1 min-w-[200px]">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input id="pdg-stock-search-input" type="text" value="${this.state.stockSearch || ''}" onkeyup="PDGModule.updateStockSearch(this.value)" placeholder="Rechercher par nom, code-barres, SKU..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium" autocomplete="off">
                                </div>
                                <select onchange="PDGModule.state.stockPosId=this.value; PDGModule.state.stockPage=1; App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold min-w-[150px]">
                                    <option value="all" ${this.state.stockPosId === 'all' ? 'selected' : ''}>Tous les POS</option>
                                    <option value="0" ${this.state.stockPosId === '0' ? 'selected' : ''}>��Ÿ � � D�p��t principal</option>
                                    ${posList.map(p => `<option value="${p.id}" ${String(this.state.stockPosId) === String(p.id) ? 'selected' : ''}>${p.name}</option>`).join('')}
                                </select>
                                <select onchange="PDGModule.state.stockCategoryId=this.value; PDGModule.state.stockPage=1; App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold min-w-[150px]">
                                    <option value="all" ${this.state.stockCategoryId === 'all' ? 'selected' : ''}>Toutes cat�gories</option>
                                    ${categories.map(c => `<option value="${c.id}" ${String(this.state.stockCategoryId) === String(c.id) ? 'selected' : ''}>${c.name}</option>`).join('')}
                                </select>
                                <select onchange="PDGModule.state.stockStatus=this.value; PDGModule.state.stockPage=1; App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold min-w-[150px]">
                                    ${statusOptions.map(s => `<option value="${s.value}" ${s.value === (this.state.stockStatus || 'all') ? 'selected' : ''}>${s.label}</option>`).join('')}
                                </select>
                            </div>
                            
                            <!-- Ligne 2: Options de vue et tri -->
                            <div class="flex flex-wrap items-center justify-between gap-3">
                                <div class="flex items-center gap-3">
                                    <!-- Toggle vue table/cards -->
                                    <div class="flex bg-slate-100 rounded-xl p-1">
                                        <button onclick="PDGModule.state.stockViewMode='table'; App.rerender()" class="px-3 py-1.5 rounded-lg text-sm font-bold transition ${viewMode === 'table' ? 'bg-white text-slate-900 shadow' : 'text-slate-500 hover:text-slate-700'}">
                                            <i data-lucide="table" class="w-4 h-4 inline-block"></i> Table
                                        </button>
                                        <button onclick="PDGModule.state.stockViewMode='cards'; App.rerender()" class="px-3 py-1.5 rounded-lg text-sm font-bold transition ${viewMode === 'cards' ? 'bg-white text-slate-900 shadow' : 'text-slate-500 hover:text-slate-700'}">
                                            <i data-lucide="layout-grid" class="w-4 h-4 inline-block"></i> Cartes
                                        </button>
                                    </div>
                                    
                                    <!-- Tri -->
                                    <select onchange="PDGModule.state.stockSortBy=this.value; App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-bold">
                                        ${sortOptions.map(s => `<option value="${s.value}" ${s.value === (this.state.stockSortBy || 'name') ? 'selected' : ''}>Trier: ${s.label}</option>`).join('')}
                                    </select>
                                    <button onclick="PDGModule.state.stockSortOrder = PDGModule.state.stockSortOrder === 'asc' ? 'desc' : 'asc'; App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 transition" title="Inverser l'ordre">
                                        <i data-lucide="${(this.state.stockSortOrder || 'asc') === 'asc' ? 'arrow-up' : 'arrow-down'}" class="w-4 h-4 text-slate-600"></i>
                                    </button>
                                </div>
                                
                                <div class="flex items-center gap-3 text-sm text-slate-600">
                                    <span class="font-bold">${stats.totalFiltered} produit(s)</span>
                                    <span>�� ?� �</span>
                                    <select onchange="PDGModule.state.stockPerPage=parseInt(this.value); PDGModule.state.stockPage=1; App.rerender()" class="px-2 py-1 rounded-lg border border-slate-200 bg-white text-sm font-bold">
                                        ${perPageOptions.map(n => `<option value="${n}" ${n === stats.perPage ? 'selected' : ''}>${n} par page</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Contenu -->
                        ${viewMode === 'cards' ? `
                            <div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                                ${products.length === 0 ? '<div class="col-span-full p-10 text-center text-slate-400">Aucun produit trouv�</div>' : ''}
                                ${products.map(p => renderProductCard(p)).join('')}
                            </div>
                        ` : `
                            <div class="overflow-auto">
                                <table class="w-full text-left min-w-[1100px]">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        <tr>
                                            <th class="px-4 py-4">Produit</th>
                                            <th class="px-4 py-4">Cat�gorie</th>
                                            <th class="px-4 py-4">POS</th>
                                            <th class="px-4 py-4 text-right">Prix</th>
                                            <th class="px-4 py-4 text-center">Stock</th>
                                            <th class="px-4 py-4 text-center">Min</th>
                                            <th class="px-4 py-4 text-right">Valeur</th>
                                            <th class="px-4 py-4">�tat</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${products.length === 0 ? '<tr><td colspan="8" class="px-6 py-10 text-center text-slate-400">Aucun produit trouv�</td></tr>' : ''}
                                        ${products.map(p => renderProductRow(p)).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                        
                        ${renderPagination()}
                    </div>
                </div>
            `;
        },

        renderTeam() {
            const users = this.getTeamFiltered();
            const stats = this.getTeamStats();
            const viewMode = this.state.teamViewMode || 'list';
            const posList = CORE.db.pointsOfSale || [];
            
            const roles = [
                { value: 'all', label: 'Tous r��les' },
                { value: 'pdg', label: 'PDG' },
                { value: 'manager', label: 'Manager' },
                { value: 'gestionnaire', label: 'Gestionnaire' },
                { value: 'vendeur', label: 'Vendeur' },
                { value: 'livreur', label: 'Livreur' }
            ];

            const sortOptions = [
                { value: 'name', label: 'Nom' },
                { value: 'role', label: 'R��le' },
                { value: 'pos', label: 'Point de vente' }
            ];

            const perPageOptions = [10, 20, 50, 100];

            // Rendu de la pagination
            const renderPagination = () => {
                if (stats.totalPages <= 1) return '';
                const pages = [];
                const maxVisible = 5;
                let start = Math.max(1, stats.page - Math.floor(maxVisible / 2));
                let end = Math.min(stats.totalPages, start + maxVisible - 1);
                if (end - start < maxVisible - 1) start = Math.max(1, end - maxVisible + 1);
                
                for (let i = start; i <= end; i++) {
                    pages.push(i);
                }
                
                return '<div class="flex items-center justify-center gap-2 mt-4">' +
                    '<button onclick="PDGModule.state.teamPage = 1; App.rerender()" class="px-3 py-2 rounded-lg ' + (stats.page === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm" ' + (stats.page === 1 ? 'disabled' : '') + '><i data-lucide="chevrons-left" class="w-4 h-4"></i></button>' +
                    '<button onclick="PDGModule.state.teamPage = Math.max(1, PDGModule.state.teamPage - 1); App.rerender()" class="px-3 py-2 rounded-lg ' + (stats.page === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm" ' + (stats.page === 1 ? 'disabled' : '') + '><i data-lucide="chevron-left" class="w-4 h-4"></i></button>' +
                    pages.map(p => '<button onclick="PDGModule.state.teamPage = ' + p + '; App.rerender()" class="px-3 py-2 rounded-lg ' + (p === stats.page ? 'bg-indigo-600 text-white' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm">' + p + '</button>').join('') +
                    '<button onclick="PDGModule.state.teamPage = Math.min(' + stats.totalPages + ', PDGModule.state.teamPage + 1); App.rerender()" class="px-3 py-2 rounded-lg ' + (stats.page === stats.totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm" ' + (stats.page === stats.totalPages ? 'disabled' : '') + '><i data-lucide="chevron-right" class="w-4 h-4"></i></button>' +
                    '<button onclick="PDGModule.state.teamPage = ' + stats.totalPages + '; App.rerender()" class="px-3 py-2 rounded-lg ' + (stats.page === stats.totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm" ' + (stats.page === stats.totalPages ? 'disabled' : '') + '><i data-lucide="chevrons-right" class="w-4 h-4"></i></button>' +
                '</div>';
            };

            // Rendu d'un utilisateur
            const renderUserCard = (u) => {
                const roleColor = u.role === 'pdg' ? 'gradient-pdg' : u.role === 'manager' ? 'gradient-manager' : u.role === 'gestionnaire' ? 'gradient-gestionnaire' : u.role === 'vendeur' ? 'gradient-vendeur' : 'gradient-livreur';
                const pos = posList.find(p => p.id === (u.pos || u.posId));
                return '<div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 hover:border-slate-200 transition flex items-start gap-3 cursor-pointer" onclick="PDGModule.showUserDetail(' + u.id + ')">' +
                    '<div class="w-12 h-12 ' + roleColor + ' rounded-2xl flex items-center justify-center text-white font-black shadow-lg">' + (u.avatar || (u.name||'?').slice(0,2).toUpperCase()) + '</div>' +
                    '<div class="min-w-0 flex-1">' +
                        '<div class="flex items-center justify-between gap-2">' +
                            '<div class="font-black text-slate-900 truncate">' + u.name + '</div>' +
                            (u.active !== false ? UI.badge('Actif','emerald') : UI.badge('Inactif','slate')) +
                        '</div>' +
                        '<div class="flex items-center gap-2 mt-1">' +
                            '<span class="text-[10px] text-slate-500 font-bold uppercase tracking-wider bg-slate-100 px-2 py-0.5 rounded">' + u.role + '</span>' +
                            (pos ? '<span class="text-[10px] text-indigo-600 font-bold bg-indigo-50 px-2 py-0.5 rounded">' + pos.name + '</span>' : '') +
                        '</div>' +
                        (u.phone ? '<div class="mt-2 text-xs text-slate-600 flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ' + u.phone + '</div>' : '') +
                    '</div>' +
                '</div>';
            };

            // Vue group�e par POS
            const renderGroupedView = () => {
                const grouped = this.getTeamGroupedByPos();
                return grouped.map(g => 
                    '<div class="mb-6">' +
                        '<div class="flex items-center gap-3 mb-3 px-2">' +
                            '<div class="w-10 h-10 rounded-xl bg-indigo-100 flex items-center justify-center"><i data-lucide="store" class="w-5 h-5 text-indigo-600"></i></div>' +
                            '<div>' +
                                '<div class="font-black text-slate-900">' + g.pos.name + '</div>' +
                                '<div class="text-xs text-slate-500">' + g.users.length + ' membre(s)</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">' +
                            g.users.map(u => renderUserCard(u)).join('') +
                        '</div>' +
                    '</div>'
                ).join('');
            };

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">��Ÿ? � �quipe Globale</h2>
                            <p class="text-slate-500 font-medium">${stats.totalUsers} utilisateurs au total �� ?� � ${posList.length} points de vente</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="PDGModule.showInviteEmployeeModal()" class="px-4 py-2 bg-teal-600 text-white rounded-xl font-black hover:bg-teal-700 transition flex items-center gap-2">
                                <i data-lucide="mail-plus" class="w-4 h-4"></i> Inviter
                            </button>
                            <button onclick="PDGModule.showAddUserModal()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition flex items-center gap-2">
                                <i data-lucide="user-plus" class="w-4 h-4"></i> Ajouter
                            </button>
                            <button onclick="PDGModule.showUsersManagementModal()" class="px-4 py-2 bg-blue-600 text-white rounded-xl font-black hover:bg-blue-700 transition flex items-center gap-2">
                                <i data-lucide="settings" class="w-4 h-4"></i> G�rer
                            </button>
                            <button onclick="PDGModule.exportTeamList()" class="px-4 py-2 bg-slate-600 text-white rounded-xl font-black hover:bg-slate-700 transition flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> Export
                            </button>
                        </div>
                    </div>

                    <!-- Statistiques rapides par r��le -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                        ${Object.entries(stats.usersByRole).map(([role, count]) => {
                            const colors = { pdg: 'purple', manager: 'blue', gestionnaire: 'cyan', vendeur: 'emerald', livreur: 'amber' };
                            const color = colors[role] || 'slate';
                            return '<div class="p-4 bg-' + color + '-50 rounded-2xl border border-' + color + '-100">' +
                                '<div class="text-' + color + '-600 text-xs font-black uppercase tracking-wider">' + role + '</div>' +
                                '<div class="text-2xl font-black text-' + color + '-700 mt-1">' + count + '</div>' +
                            '</div>';
                        }).join('')}
                    </div>

                    <!-- Filtres avanc�s -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 space-y-4">
                            <!-- Ligne 1: Recherche et filtres principaux -->
                            <div class="flex flex-wrap gap-3">
                                <div class="relative flex-1 min-w-[200px]">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input id="pdg-team-search-input" type="text" value="${PDGModule.state.teamSearch || ''}" onkeyup="PDGModule.updateTeamSearch(this.value)" placeholder="Rechercher par nom, t�l�phone..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium" autocomplete="off">
                                </div>
                                <select onchange="PDGModule.state.teamRole=this.value; PDGModule.state.teamPage=1; App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold min-w-[140px]">
                                    ${roles.map(r => `<option value="${r.value}" ${r.value===PDGModule.state.teamRole?'selected':''}>${r.label}</option>`).join('')}
                                </select>
                                <select onchange="PDGModule.state.teamPosId=this.value; PDGModule.state.teamPage=1; App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold min-w-[160px]">
                                    <option value="all" ${PDGModule.state.teamPosId === 'all' ? 'selected' : ''}>Tous les POS</option>
                                    ${posList.map(p => `<option value="${p.id}" ${String(PDGModule.state.teamPosId) === String(p.id) ? 'selected' : ''}>${p.name}</option>`).join('')}
                                </select>
                            </div>
                            
                            <!-- Ligne 2: Options de vue et tri -->
                            <div class="flex flex-wrap items-center justify-between gap-3">
                                <div class="flex items-center gap-3">
                                    <!-- Toggle vue liste/group�e -->
                                    <div class="flex bg-slate-100 rounded-xl p-1">
                                        <button onclick="PDGModule.state.teamViewMode='list'; App.rerender()" class="px-3 py-1.5 rounded-lg text-sm font-bold transition ${viewMode === 'list' ? 'bg-white text-slate-900 shadow' : 'text-slate-500 hover:text-slate-700'}">
                                            <i data-lucide="list" class="w-4 h-4 inline-block"></i> Liste
                                        </button>
                                        <button onclick="PDGModule.state.teamViewMode='grouped'; App.rerender()" class="px-3 py-1.5 rounded-lg text-sm font-bold transition ${viewMode === 'grouped' ? 'bg-white text-slate-900 shadow' : 'text-slate-500 hover:text-slate-700'}">
                                            <i data-lucide="layout-grid" class="w-4 h-4 inline-block"></i> Par POS
                                        </button>
                                    </div>
                                    
                                    <!-- Tri -->
                                    <select onchange="PDGModule.state.teamSortBy=this.value; App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-bold">
                                        ${sortOptions.map(s => `<option value="${s.value}" ${s.value === (PDGModule.state.teamSortBy || 'name') ? 'selected' : ''}>Trier: ${s.label}</option>`).join('')}
                                    </select>
                                    <button onclick="PDGModule.state.teamSortOrder = PDGModule.state.teamSortOrder === 'asc' ? 'desc' : 'asc'; App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 transition" title="Inverser l'ordre">
                                        <i data-lucide="${(PDGModule.state.teamSortOrder || 'asc') === 'asc' ? 'arrow-up' : 'arrow-down'}" class="w-4 h-4 text-slate-600"></i>
                                    </button>
                                </div>
                                
                                <div class="flex items-center gap-3 text-sm text-slate-600">
                                    <span class="font-bold">${stats.totalFiltered} r�sultat(s)</span>
                                    <span>�� ?� �</span>
                                    <select onchange="PDGModule.state.teamPerPage=parseInt(this.value); PDGModule.state.teamPage=1; App.rerender()" class="px-2 py-1 rounded-lg border border-slate-200 bg-white text-sm font-bold">
                                        ${perPageOptions.map(n => `<option value="${n}" ${n === stats.perPage ? 'selected' : ''}>${n} par page</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Contenu -->
                        <div class="p-4">
                            ${viewMode === 'grouped' ? renderGroupedView() : `
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                    ${users.length === 0 ? '<div class="p-10 text-center text-slate-400 font-medium md:col-span-2 lg:col-span-3">Aucun membre trouv�</div>' : ''}
                                    ${users.map(u => renderUserCard(u)).join('')}
                                </div>
                                ${renderPagination()}
                            `}
                        </div>
                    </div>
                </div>
            `;
        },

        renderCommandes() {
            const suppliers = CORE.db.suppliers || [];
            const purchaseOrders = CORE.db.purchaseOrders || [];
            const products = CORE.db.products || [];
            
            const stats = {
                total: purchaseOrders.length,
                pending: purchaseOrders.filter(o => ['pending','confirmed'].includes(o.status)).length,
                received: purchaseOrders.filter(o => o.status === 'received').length,
                totalCost: purchaseOrders.reduce((a,o) => a + (o.totalCost||0), 0)
            };

            let html = '<div class="max-w-7xl mx-auto space-y-6 fade-in"><h2 class="text-3xl font-black text-slate-900">��Ÿ? � Gestion Globale des Commandes de R�approvisionnement</h2>';
            html += '<button onclick="PDGModule.showNewPurchaseOrderModal()" class="px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700">+ Nouvelle commande</button>';
            
            html += '<div class="grid grid-cols-1 md:grid-cols-4 gap-4">';
            html += '<div class="bg-white p-4 rounded-2xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase">Total</div><div class="mt-2 text-2xl font-black">' + stats.total + '</div></div>';
            html += '<div class="bg-white p-4 rounded-2xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase">En attente</div><div class="mt-2 text-2xl font-black text-amber-600">' + stats.pending + '</div></div>';
            html += '<div class="bg-white p-4 rounded-2xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase">Livr�es</div><div class="mt-2 text-2xl font-black text-emerald-600">' + stats.received + '</div></div>';
            html += '<div class="bg-white p-4 rounded-2xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase">Total d�pens�</div><div class="mt-2 text-2xl font-black">' + CORE.formatPrice(stats.totalCost) + '</div></div>';
            html += '</div>';

            html += '<div class="bg-white border border-slate-200 rounded-3xl overflow-hidden"><table class="w-full"><thead class="bg-slate-100"><tr><th class="px-4 py-3 text-left font-black">Ref</th><th class="px-4 py-3 text-left font-black">Fournisseur</th><th class="px-4 py-3 text-left font-black">Produit</th><th class="px-4 py-3 text-left font-black">Quantit�</th><th class="px-4 py-3 text-left font-black">Montant</th><th class="px-4 py-3 text-left font-black">Statut</th><th class="px-4 py-3 text-left font-black">Date</th><th class="px-4 py-3 text-left font-black">Actions</th></tr></thead><tbody>';
            
            const recent = purchaseOrders.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 30);
            recent.forEach(o => {
                const supplier = suppliers.find(s => s.id === o.supplierId);
                const product = products.find(p => p.id === o.productId);
                html += '<tr class="border-t border-slate-200 hover:bg-slate-50"><td class="px-4 py-3 font-bold">' + (o.reference || o.id) + '</td>';
                html += '<td class="px-4 py-3 font-bold">' + (supplier?.name || '�� ?��') + '</td>';
                html += '<td class="px-4 py-3">' + (product?.name || '�� ?��') + '</td>';
                html += '<td class="px-4 py-3 text-center font-bold">' + o.qty + '</td>';
                html += '<td class="px-4 py-3 font-black">' + CORE.formatPrice(o.totalCost || 0) + '</td>';
                html += '<td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-bold ' + (o.status === 'received' ? 'bg-emerald-100 text-emerald-700' : o.status === 'confirmed' ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700') + '">' + (o.status === 'pending' ? 'Attente' : o.status === 'confirmed' ? 'Confirm�e' : 'Livr�e') + '</span></td>';
                html += '<td class="px-4 py-3 text-xs text-slate-500">' + CORE.formatDate(o.createdAt) + '</td>';
                html += '<td class="px-4 py-3"><button onclick="PDGModule.validatePurchaseOrderArrival(' + o.id + ')" class="' + (o.status === 'received' ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-emerald-500 text-white hover:bg-emerald-600') + ' px-3 py-1 rounded text-xs font-bold">' + (o.status === 'received' ? '���?? Re��u' : 'Valider arriv�e') + '</button></td></tr>';
            });
            
            html += '</tbody></table></div></div>';
            return html;
        },

        showNewPurchaseOrderModal(savedData = null) {
            const suppliers = CORE.db.suppliers || [];
            const products = CORE.db.products || [];
            
            const supplierOptions = suppliers.map(s => ({value: s.id, label: s.name}));
            const productOptions = products.map(p => ({value: p.id, label: p.name + ' (Stock: ' + (p.stock||0) + ')'}));
            const transportModes = [{value: 'routier', label: 'Routier'}, {value: 'aerien', label: 'A�rien'}, {value: 'maritime', label: 'Maritime'}, {value: 'ferroviaire', label: 'Ferroviaire'}];
            
            // Utiliser les donn�es sauvegard�es si pr�sentes
            const d = savedData || {};
            
            UI.modal('Nouvelle commande de r�approvisionnement', `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <!-- Fournisseur/Usine avec bouton + Nouveau -->
                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">Fournisseur/Usine *</label>
                        <div class="flex gap-2">
                            <select id="po_supplier" class="flex-1 px-4 py-2.5 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-emerald-500">
                                <option value="">-- S�lectionner --</option>
                                ${supplierOptions.map(s => '<option value="' + s.value + '"' + (String(s.value) === String(d.supplierId || '') ? ' selected' : '') + '>' + s.label + '</option>').join('')}
                            </select>
                            <button onclick="PDGModule.showNewSupplierForPO()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition whitespace-nowrap">+ Nouveau</button>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">Produit existant</label>
                        <select id="po_product" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                            <option value="">-- S�lectionner un produit --</option>
                            ${productOptions.map(p => '<option value="' + p.value + '"' + (String(p.value) === String(d.productId || '') ? ' selected' : '') + '>' + p.label + '</option>').join('')}
                        </select>
                    </div>
                    
                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">OU Cr�er un nouveau produit</label>
                        <input type="text" id="po_newProductName" value="${d.newProductName || ''}" placeholder="Nom du produit" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white">
                        <input type="text" id="po_newProductCode" value="${d.newProductCode || ''}" placeholder="Code produit" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white">
                        <textarea id="po_newProductDesc" placeholder="Description du produit" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white" rows="2">${d.newProductDesc || ''}</textarea>
                    </div>
                    
                    ${UI.input('po_qty', 'Quantit�', 'number', d.qty || '10', 'ex: 50', true)}
                    ${UI.input('po_kilos', 'Kilos', 'number', d.kilos || '0', 'ex: 100', false)}
                    ${UI.input('po_cbm', 'CBM (m�? �)', 'number', d.cbm || '0', 'ex: 2.5', false)}
                    ${UI.input('po_unitPrice', 'Prix unitaire', 'number', d.unitPrice || '0', 'ex: 1500', true)}
                    ${UI.input('po_transportPrice', 'Prix de transport', 'number', d.transportPrice || '0', 'ex: 5000', false)}
                    ${UI.input('po_totalPrice', 'Total �� payer au fournisseur', 'number', d.totalPrice || '0', 'ex: 10500 (optionnel)', false)}
                    ${UI.select('po_transportMode', 'Mode de transport', transportModes, d.transportMode || '')}
                    ${UI.input('po_transportAgency', 'Agence de transport', 'text', d.transportAgency || '', 'ex: DHL, FedEx, UPS', false)}
                    ${UI.input('po_trackingNumber', 'Num�ro de suivi du colis', 'text', d.trackingNumber || '', 'ex: TRK123456789', false)}
                    ${UI.input('po_deliveryDate', 'Date de livraison pr�vue', 'date', d.deliveryDate || '', '', false)}
                    ${UI.input('po_reminderDays', 'P�riode de rappel (jours avant arriv�e)', 'number', d.reminderDays || '3', 'ex: 3, 5, 7', false)}
                    
                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">Image du colis</label>
                        <input type="file" id="po_image" accept="image/*" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">Vid�o</label>
                        <input type="file" id="po_video" accept="video/*" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white">
                    </div>
                    ${UI.textarea('po_note', 'Notes', d.note || 'Ex: Urgent, qualit� premium', 300, false)}
                </div>
            `, [
                {label: 'Annuler', onclick: 'UI.closeModal()'},
                {label: 'Cr�er', onclick: 'PDGModule.createPurchaseOrder()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700'}
            ]);
        },

        showNewSupplierForPO() {
            // Sauvegarder les donn�es du formulaire
            window._pendingPOFormData = {
                module: 'pdg',
                supplierId: UI.val('po_supplier') || '',
                productId: UI.val('po_product') || '',
                newProductName: document.getElementById('po_newProductName')?.value || '',
                newProductCode: document.getElementById('po_newProductCode')?.value || '',
                newProductDesc: document.getElementById('po_newProductDesc')?.value || '',
                qty: UI.val('po_qty') || '10',
                kilos: UI.val('po_kilos') || '0',
                cbm: UI.val('po_cbm') || '0',
                unitPrice: UI.val('po_unitPrice') || '0',
                transportPrice: UI.val('po_transportPrice') || '0',
                totalPrice: UI.val('po_totalPrice') || '0',
                transportMode: UI.val('po_transportMode') || '',
                transportAgency: UI.val('po_transportAgency') || '',
                trackingNumber: UI.val('po_trackingNumber') || '',
                deliveryDate: UI.val('po_deliveryDate') || '',
                reminderDays: UI.val('po_reminderDays') || '3',
                note: UI.val('po_note') || ''
            };
            
            UI.modal('��ž� Nouveau Fournisseur/Usine', `
                <div class="space-y-4">
                    <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-xl text-sm text-emerald-800">
                        Cr�ez un nouveau fournisseur ou usine pour vos commandes de r�approvisionnement
                    </div>
                    ${UI.input('new_supplier_name', 'Nom du fournisseur/usine *', 'text', '', 'ex: Usine Textile Guangzhou', true)}
                    ${UI.input('new_supplier_contact', 'Email de contact', 'email', '', 'ex: contact@fournisseur.com', false)}
                    ${UI.input('new_supplier_phone', 'T�l�phone', 'tel', '', 'ex: +86 123 456 7890', false)}
                    ${UI.input('new_supplier_country', 'Pays', 'text', '', 'ex: Chine, Maroc, Turquie', false)}
                    ${UI.input('new_supplier_address', 'Adresse', 'text', '', 'ex: Zone industrielle...', false)}
                    ${UI.textarea('new_supplier_notes', 'Notes', '', 2, false)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'PDGModule.restorePOModal()' },
                { label: 'Cr�er le fournisseur', onclick: 'PDGModule.saveNewSupplierForPO()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        saveNewSupplierForPO() {
            const name = UI.val('new_supplier_name')?.trim();
            if (!name) return UI.toast('Le nom du fournisseur est requis', 'warning');
            
            // V�rifier si existe d�j��
            const exists = (CORE.db.suppliers || []).some(s => s.name.toLowerCase() === name.toLowerCase());
            if (exists) return UI.toast('Ce fournisseur existe d�j��', 'warning');
            
            const newSupplier = CORE.create('suppliers', {
                name: name,
                email: UI.val('new_supplier_contact')?.trim() || '',
                phone: UI.val('new_supplier_phone')?.trim() || '',
                country: UI.val('new_supplier_country')?.trim() || '',
                address: UI.val('new_supplier_address')?.trim() || '',
                notes: UI.val('new_supplier_notes')?.trim() || '',
                active: true,
                createdAt: new Date().toISOString()
            });
            
            UI.toast(`���?� Fournisseur "${name}" cr��!`, 'success');
            
            // Restaurer le modal avec le nouveau fournisseur s�lectionn�
            const savedData = window._pendingPOFormData || {};
            savedData.supplierId = newSupplier.id;
            window._pendingPOFormData = null;
            
            this.showNewPurchaseOrderModal(savedData);
        },

        restorePOModal() {
            const savedData = window._pendingPOFormData || {};
            window._pendingPOFormData = null;
            this.showNewPurchaseOrderModal(savedData);
        },

        createPurchaseOrder() {
            const supplierId = UI.val('po_supplier');
            let productId = UI.val('po_product');
            const newProductName = document.getElementById('po_newProductName')?.value || '';
            const newProductCode = document.getElementById('po_newProductCode')?.value || '';
            const newProductDesc = document.getElementById('po_newProductDesc')?.value || '';
            const qty = parseInt(UI.val('po_qty')) || 0;
            const kilos = parseFloat(UI.val('po_kilos')) || 0;
            const cbm = parseFloat(UI.val('po_cbm')) || 0;
            const unitPrice = parseFloat(UI.val('po_unitPrice')) || 0;
            const transportPrice = parseFloat(UI.val('po_transportPrice')) || 0;
            const customTotalPrice = parseFloat(UI.val('po_totalPrice')) || 0;
            const reminderDays = parseInt(UI.val('po_reminderDays')) || 0;
            
            if (!supplierId) return UI.toast('Fournisseur requis', 'error');
            if (!productId && !newProductName) return UI.toast('S�lectionnez un produit ou cr�ez un nouveau', 'error');
            if (qty <= 0) return UI.toast('Quantit� invalide', 'error');
            
            // Cr�er le nouveau produit si n�cessaire
            if (newProductName && !productId) {
                const newProduct = CORE.create('products', {
                    name: newProductName,
                    code: newProductCode || 'PROD-' + Utils.uid().substring(0,6),
                    description: newProductDesc,
                    stock: qty,
                    price: unitPrice,
                    active: true,
                    createdAt: new Date().toISOString()
                });
                productId = newProduct.id;
            }
            
            // Calculer le total : utiliser customTotalPrice si fourni, sinon calculer automatiquement
            const totalCost = customTotalPrice > 0 ? customTotalPrice : (qty * unitPrice) + transportPrice;
            
            const imageFile = document.getElementById('po_image')?.files?.[0];
            const videoFile = document.getElementById('po_video')?.files?.[0];
            let imageBase64 = null;
            let videoBase64 = null;
            
            const createOrder = () => {
                const reference = 'PO-' + Utils.uid('PO').substring(0,6);
                const po = CORE.create('purchaseOrders', {
                    reference,
                    supplierId: parseInt(supplierId),
                    productId: parseInt(productId),
                    qty,
                    kilos,
                    cbm,
                    unitPrice,
                    transportPrice,
                    transportMode: UI.val('po_transportMode') || null,
                    transportAgency: UI.val('po_transportAgency') || null,
                    totalCost,
                    status: 'pending',
                    trackingNumber: UI.val('po_trackingNumber') || null,
                    deliveryDate: UI.val('po_deliveryDate') || null,
                    reminderDays,
                    image: imageBase64,
                    video: videoBase64,
                    note: UI.val('po_note') || '',
                    createdAt: new Date().toISOString()
                });
                
                // Enregistrer la d�pense automatiquement
                const supplier = CORE.db.suppliers?.find(s => s.id === parseInt(supplierId));
                const product = CORE.db.products?.find(p => p.id === parseInt(productId));
                CORE.create('expenses', {
                    reference: reference,
                    type: 'purchase_order',
                    description: `Commande ${reference} - ${product?.name || 'Produit'} chez ${supplier?.name || 'Fournisseur'}`,
                    amount: totalCost,
                    supplier: supplier?.name || 'Non sp�cifi�',
                    category: 'r�approvisionnement',
                    status: 'pending',
                    purchaseOrderId: po.id,
                    createdAt: new Date().toISOString()
                });
                
                UI.closeModal();
                UI.toast('Commande cr��e: ' + reference, 'success');
                CORE.notify('success', `Nouvelle commande cr��e: ${reference} chez ${supplier?.name || 'Fournisseur'} - ${CORE.formatPrice(totalCost)}`, { purchaseOrderId: po.id });
                App.rerender();
            };
            
            let pendingFiles = 0;
            if (imageFile) pendingFiles++;
            if (videoFile) pendingFiles++;
            
            if (pendingFiles === 0) {
                createOrder();
                return;
            }
            
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageBase64 = e.target.result;
                    pendingFiles--;
                    if (pendingFiles === 0) createOrder();
                };
                reader.readAsDataURL(imageFile);
            }
            
            if (videoFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    videoBase64 = e.target.result;
                    pendingFiles--;
                    if (pendingFiles === 0) createOrder();
                };
                reader.readAsDataURL(videoFile);
            }
        },

        renderActivity() {
            const tab = this.state.activityTab;
            const notifications = CORE.db.notifications.slice(0, 50);
            const movements = CORE.db.stockMovements.slice(0, 50);

            const tabs = [
                { value: 'notifications', label: `Notifications (${CORE.db.notifications.length})` },
                { value: 'stock', label: `Mouvements stock (${CORE.db.stockMovements.length})` }
            ];

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div>
                        <h2 class="text-2xl font-black text-slate-900">Activit�</h2>
                        <p class="text-slate-500 font-medium">Journal d'�v�nements (demo) : notifications et mouvements de stock.</p>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 flex items-center gap-2">
                            ${tabs.map(t => `
                                <button onclick="PDGModule.state.activityTab=\'${t.value}\';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab===t.value ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">${t.label}</button>
                            `).join('')}
                        </div>

                        <div class="p-4">
                            ${tab === 'notifications' ? `
                                <div class="space-y-2">
                                    ${notifications.length === 0 ? `<div class="p-10 text-center text-slate-400">Aucune notification</div>` : ''}
                                    ${notifications.map(n => {
                                        const badge = n.type === 'error' ? UI.badge('Erreur','red') : n.type === 'warning' ? UI.badge('Alerte','amber') : n.type === 'info' ? UI.badge('Info','blue') : UI.badge('OK','emerald');
                                        return `
                                        <div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50">
                                            <div class="flex items-start justify-between gap-3">
                                                <div>
                                                    <div class="font-black text-slate-900">${n.message}</div>
                                                    <div class="text-xs text-slate-500">${CORE.formatDate(n.createdAt)}</div>
                                                </div>
                                                ${badge}
                                            </div>
                                        </div>`;
                                    }).join('')}
                                </div>
                            ` : `
                                <div class="space-y-2">
                                    ${movements.length === 0 ? `<div class="p-10 text-center text-slate-400">Aucun mouvement</div>` : ''}
                                    ${movements.map(m => `
                                        <div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50">
                                            <div class="flex items-start justify-between gap-3">
                                                <div>
                                                    <div class="font-black text-slate-900">${m.productName || '�� ?��'}</div>
                                                    <div class="text-xs text-slate-500">${m.userName || 'System'} �� ?� � ${CORE.formatDate(m.createdAt)}</div>
                                                    ${m.note ? `<div class="mt-1 text-xs text-slate-600">${m.note}</div>` : ''}
                                                </div>
                                                <div class="text-right">
                                                    ${UI.badge(m.type, m.type==='out'?'red':m.type==='in'?'emerald':'blue')}
                                                    <div class="mt-2 font-black ${m.type==='out'?'text-red-600':'text-slate-900'}">${m.type==='out' ? '-' : '+'}${m.qty}</div>
                                                    ${m.ref ? `<div class="text-[10px] text-slate-400">${m.ref}</div>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        },

        renderAuditTrail() {
            const filterUser = this.state.auditFilterUser || '';
            const filterAction = this.state.auditFilterAction || '';
            const filterEntity = this.state.auditFilterEntity || '';
            const sortOrder = this.state.auditSortOrder || 'desc';

            // Filtrer les logs d'audit
            let logs = CORE.db.auditLogs || [];
            if (filterUser) logs = logs.filter(l => l.userId.toString() === filterUser);
            if (filterAction) logs = logs.filter(l => l.action === filterAction);
            if (filterEntity) logs = logs.filter(l => l.entity === filterEntity);
            
            // Trier
            if (sortOrder === 'asc') {
                logs = logs.reverse();
            }

            // Statistiques
            const totalActions = CORE.db.auditLogs?.length || 0;
            const userCount = [...new Set(CORE.db.auditLogs?.map(l => l.userId) || [])].length;
            const today = new Date().toDateString();
            const actionsToday = CORE.db.auditLogs?.filter(l => new Date(l.timestamp).toDateString() === today).length || 0;

            // Actions uniques
            const uniqueActions = [...new Set(CORE.db.auditLogs?.map(l => l.action) || [])];
            const uniqueEntities = [...new Set(CORE.db.auditLogs?.map(l => l.entity) || [])];
            const uniqueUsers = CORE.db.users || [];

            // Ic��nes pour les actions
            const getActionIcon = (action) => {
                const icons = {
                    'create': 'plus-circle',
                    'update': 'edit-2',
                    'delete': 'trash-2',
                    'approve': 'check-circle',
                    'reject': 'x-circle',
                    'assign': 'user-plus',
                    'complete': 'check-square',
                    'cancel': 'x-square'
                };
                return icons[action] || 'activity';
            };

            const getActionColor = (action) => {
                const colors = {
                    'create': 'emerald',
                    'update': 'blue',
                    'delete': 'red',
                    'approve': 'emerald',
                    'reject': 'red',
                    'assign': 'amber',
                    'complete': 'emerald',
                    'cancel': 'slate'
                };
                return colors[action] || 'slate';
            };

            const getStatusIcon = (status) => {
                const icons = {
                    'success': 'check',
                    'error': 'x',
                    'pending': 'clock',
                    'warning': 'alert-circle',
                    'cancelled': 'ban'
                };
                return icons[status] || 'info';
            };

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">��Ÿ� � Audit Trail Complet</h2>
                            <p class="text-slate-500 font-medium">Historique d�taill� de toutes les actions des utilisateurs</p>
                        </div>
                        <button onclick="PDGModule.exportAuditLog()" class="px-4 py-2 rounded-xl bg-indigo-50 text-indigo-600 font-black hover:bg-indigo-100 transition flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i> Exporter
                        </button>
                    </div>

                    <!-- Statistiques -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-slate-700 text-xs font-black uppercase tracking-wider mb-2">Total Actions</div>
                            <div class="text-3xl font-black text-slate-900">${totalActions}</div>
                            <div class="text-xs text-slate-500 mt-2">Depuis le d�but</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-indigo-700 text-xs font-black uppercase tracking-wider mb-2">Actions Aujourd'hui</div>
                            <div class="text-3xl font-black text-indigo-600">${actionsToday}</div>
                            <div class="text-xs text-indigo-500 mt-2">Derniers 24h</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-emerald-700 text-xs font-black uppercase tracking-wider mb-2">Utilisateurs Actifs</div>
                            <div class="text-3xl font-black text-emerald-600">${userCount}</div>
                            <div class="text-xs text-emerald-500 mt-2">Ayant effectu� des actions</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-amber-700 text-xs font-black uppercase tracking-wider mb-2">Types d'Actions</div>
                            <div class="text-3xl font-black text-amber-600">${uniqueActions.length}</div>
                            <div class="text-xs text-amber-500 mt-2">${uniqueActions.join(', ')}</div>
                        </div>
                    </div>

                    <!-- Filtres -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Utilisateur</label>
                                <select onchange="PDGModule.state.auditFilterUser = this.value; App.rerender()" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                                    <option value="">Tous les utilisateurs</option>
                                    ${uniqueUsers.map(u => `<option value="${u.id}" ${filterUser === u.id.toString() ? 'selected' : ''}>${u.name} (${u.role})</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Action</label>
                                <select onchange="PDGModule.state.auditFilterAction = this.value; App.rerender()" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                                    <option value="">Toutes les actions</option>
                                    ${uniqueActions.map(a => `<option value="${a}" ${filterAction === a ? 'selected' : ''}>${a.charAt(0).toUpperCase() + a.slice(1)}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Entit�</label>
                                <select onchange="PDGModule.state.auditFilterEntity = this.value; App.rerender()" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                                    <option value="">Toutes les entit�s</option>
                                    ${uniqueEntities.map(e => `<option value="${e}" ${filterEntity === e ? 'selected' : ''}>${e.charAt(0).toUpperCase() + e.slice(1)}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Ordre</label>
                                <select onchange="PDGModule.state.auditSortOrder = this.value; App.rerender()" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                                    <option value="desc" ${sortOrder === 'desc' ? 'selected' : ''}>Plus r�cent d'abord</option>
                                    <option value="asc" ${sortOrder === 'asc' ? 'selected' : ''}>Plus ancien d'abord</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="PDGModule.state.auditFilterUser = ''; PDGModule.state.auditFilterAction = ''; PDGModule.state.auditFilterEntity = ''; PDGModule.state.auditSortOrder = 'desc'; App.rerender()" class="text-xs font-black text-slate-600 hover:text-slate-900">R�initialiser les filtres</button>
                    </div>

                    <!-- Historique -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100">
                            <h3 class="font-black text-slate-900">Journal d'Audit (${logs.length} r�sultats)</h3>
                        </div>
                        <div class="divide-y divide-slate-100 max-h-[600px] overflow-y-auto">
                            ${logs.length === 0 ? `
                                <div class="p-8 text-center text-slate-400">
                                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-30"></i>
                                    <div>Aucune action trouv�e</div>
                                </div>
                            ` : logs.map(log => `
                                <div class="p-4 hover:bg-slate-50 transition cursor-pointer" onclick="PDGModule.showAuditLogDetail(${log.id})">
                                    <div class="flex items-start gap-4">
                                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center flex-shrink-0 bg-${getActionColor(log.action)}-50">
                                            <i data-lucide="${getActionIcon(log.action)}" class="w-6 h-6 text-${getActionColor(log.action)}-600"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="font-black text-slate-900">${log.action.toUpperCase()}</span>
                                                <span class="text-xs font-black text-slate-600 uppercase">${log.entity}</span>
                                                ${log.entityName ? `<span class="text-xs font-black text-slate-700">"${log.entityName}"</span>` : ''}
                                            </div>
                                            <div class="text-xs text-slate-500 space-y-1">
                                                <div><strong>${log.userName}</strong> (${log.userRole}) - ${new Date(log.timestamp).toLocaleString('fr-FR')}</div>
                                                ${log.details?.description ? `<div>${log.details.description}</div>` : ''}
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2 flex-shrink-0">
                                            ${UI.badge(log.status === 'success' ? 'OK' : log.status.toUpperCase(), log.status === 'success' ? 'emerald' : log.status === 'error' ? 'red' : log.status === 'pending' ? 'amber' : 'slate')}
                                            <span class="text-[10px] text-slate-400">${log.id}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        },

        // ===== MODAL SYNCHRONISATION =====
        showSyncModal() {
            const lastSync = SyncManager?.lastSync || localStorage.getItem('raya_last_sync') || 'Jamais';
            const serverProducts = CORE.db.serverProducts?.length || 0;
            const serverCategories = CORE.db.serverCategories?.length || 0;
            const serverOrders = CORE.db.serverOrders?.length || 0;
            const serverClients = CORE.db.serverClients?.length || 0;
            const localProducts = CORE.db.products?.length || 0;
            const localOrders = CORE.db.orders?.length || 0;
            const localClients = CORE.db.clients?.length || 0;
            const queueLength = SyncManager?.syncQueue?.length || 0;
            
            UI.modal({
                title: 'Synchronisation Backend',
                icon: 'cloud-cog',
                size: 'lg',
                content: `
                    <div class="space-y-4">
                        <div class="p-4 bg-slate-50 rounded-xl">
                            <h3 class="font-black text-slate-800 mb-2">�tat de la connexion</h3>
                            <div class="flex items-center gap-2 text-sm">
                                <span class="w-2 h-2 rounded-full ${CORE.state.isOnline ? 'bg-emerald-500' : 'bg-red-500'}"></span>
                                ${CORE.state.isOnline ? 'En ligne' : 'Hors ligne'}
                            </div>
                            <div class="text-xs text-slate-500 mt-1">Derni�re sync: ${lastSync !== 'Jamais' ? new Date(lastSync).toLocaleString('fr-FR') : lastSync}</div>
                            ${queueLength > 0 ? '<div class="text-xs text-orange-600 mt-1"> '+queueLength+' op�ration(s) en attente</div>' : ''}
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-3 bg-blue-50 rounded-lg text-center">
                                <div class="text-2xl font-black text-blue-600">${serverProducts}</div>
                                <div class="text-xs text-blue-800">Produits serveur</div>
                            </div>
                            <div class="p-3 bg-emerald-50 rounded-lg text-center">
                                <div class="text-2xl font-black text-emerald-600">${localProducts}</div>
                                <div class="text-xs text-emerald-800">Produits local</div>
                            </div>
                            <div class="p-3 bg-purple-50 rounded-lg text-center">
                                <div class="text-2xl font-black text-purple-600">${serverOrders}</div>
                                <div class="text-xs text-purple-800">Commandes serveur</div>
                            </div>
                            <div class="p-3 bg-orange-50 rounded-lg text-center">
                                <div class="text-2xl font-black text-orange-600">${serverClients}</div>
                                <div class="text-xs text-orange-800">Clients serveur</div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="PDGModule.syncFromServer()" class="flex-1 p-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                <i data-lucide="download-cloud" class="w-4 h-4"></i> T�l�charger du serveur
                            </button>
                            <button onclick="PDGModule.syncToServer()" class="flex-1 p-3 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700 transition flex items-center justify-center gap-2">
                                <i data-lucide="upload-cloud" class="w-4 h-4"></i> Envoyer au serveur
                            </button>
                        </div>
                        
                        <div class="text-xs text-slate-500 text-center">
                            Backend: ${API.baseUrl}
                        </div>
                    </div>
                `,
                buttons: [
                    { label: 'Fermer', onclick: 'UI.closeModal()', class: 'bg-slate-200 hover:bg-slate-300 text-slate-700' }
                ]
            });
            setTimeout(() => lucide.createIcons(), 50);
        },
        
        async syncFromServer() {
            UI.closeModal();
            UI.toast('T�l�chargement des donn�es...', 'info');
            try {
                const result = await CORE.loadFromServer();
                if (result.success) {
                    UI.toast('Donn�es t�l�charg�es: ' + JSON.stringify(result.counts), 'success');
                    this.rerender();
                } else {
                    UI.toast('Erreur: ' + (result.error || result.message), 'error');
                }
            } catch (e) {
                UI.toast('Erreur: ' + e.message, 'error');
            }
        },
        
        async syncToServer() {
            UI.closeModal();
            UI.toast('Envoi des donn�es...', 'info');
            try {
                // Envoyer les produits locaux qui n'ont pas de serverId
                const unsyncedProducts = (CORE.db.products || []).filter(p => !p.serverId);
                let count = 0;
                for (const product of unsyncedProducts) {
                    try {
                        const result = await CORE.syncToBackend('create', 'products', product);
                        if (result && result.id) {
                            product.serverId = result.id;
                            count++;
                        }
                    } catch (e) {
                        console.warn('Sync product failed:', product.name, e);
                    }
                }
                CORE.save();
                UI.toast(count + ' produit(s) envoy�(s) au serveur', 'success');
            } catch (e) {
                UI.toast('Erreur: ' + e.message, 'error');
            }
        },

        showAuditLogDetail(logId) {
            const log = CORE.db.auditLogs?.find(l => l.id === logId);
            if (!log) return UI.toast('Log introuvable', 'error');

            UI.modal('D�tail de l\'Action d\'Audit', `
                <div class="space-y-4 max-h-[60vh] overflow-y-auto">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 bg-slate-50 rounded-2xl border border-slate-100">
                            <div class="text-xs font-black text-slate-600 uppercase">Utilisateur</div>
                            <div class="font-black text-slate-900">${log.userName}</div>
                            <div class="text-xs text-slate-500">${log.userRole}</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-2xl border border-slate-100">
                            <div class="text-xs font-black text-slate-600 uppercase">Action</div>
                            <div class="font-black text-slate-900">${log.action}</div>
                            <div class="text-xs text-slate-500">${log.entity}</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-2xl border border-slate-100">
                            <div class="text-xs font-black text-slate-600 uppercase">Horodatage</div>
                            <div class="font-black text-slate-900">${new Date(log.timestamp).toLocaleString('fr-FR')}</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-2xl border border-slate-100">
                            <div class="text-xs font-black text-slate-600 uppercase">Statut</div>
                            <div class="font-black text-slate-900">${log.status}</div>
                        </div>
                    </div>
                    
                    ${log.entityName ? `
                        <div class="p-3 bg-blue-50 rounded-2xl border border-blue-100">
                            <div class="text-xs font-black text-blue-600 uppercase">Entit�</div>
                            <div class="font-black text-blue-900">${log.entityName} (ID: ${log.entityId})</div>
                        </div>
                    ` : ''}

                    ${Object.keys(log.details || {}).length > 0 ? `
                        <div class="p-4 bg-amber-50 rounded-2xl border border-amber-100">
                            <div class="text-xs font-black text-amber-600 uppercase mb-2">D�tails</div>
                            <div class="space-y-1 text-sm">
                                ${Object.entries(log.details).map(([k, v]) => `
                                    <div class="flex justify-between">
                                        <span class="font-black">${k}:</span>
                                        <span class="text-amber-900">${typeof v === 'object' ? JSON.stringify(v) : v}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${log.before ? `
                        <div class="p-4 bg-red-50 rounded-2xl border border-red-100">
                            <div class="text-xs font-black text-red-600 uppercase mb-2">Avant</div>
                            <pre class="text-[10px] overflow-x-auto text-red-900">${JSON.stringify(JSON.parse(log.before), null, 2)}</pre>
                        </div>
                    ` : ''}

                    ${log.after ? `
                        <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                            <div class="text-xs font-black text-emerald-600 uppercase mb-2">Apr��s</div>
                            <pre class="text-[10px] overflow-x-auto text-emerald-900">${JSON.stringify(JSON.parse(log.after), null, 2)}</pre>
                        </div>
                    ` : ''}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        exportAuditLog() {
            const logs = CORE.db.auditLogs || [];
            let csvContent = 'sep=,\n';
            csvContent += 'ID,Horodatage,Utilisateur,R��le,Action,Entit�,Entit� ID,Entit� Nom,Statut\n';
            
            logs.forEach(log => {
                csvContent += `${log.id},"${new Date(log.timestamp).toLocaleString('fr-FR')}","${log.userName}","${log.userRole}","${log.action}","${log.entity}",${log.entityId},"${log.entityName || '�� ?��'}","${log.status}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'audit_log_' + new Date().getTime() + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('Journal d\'audit export� avec succ��s', 'success');
        },

        renderAdvancedReports() {
            const reportType = this.state.reportType || 'sales';
            const periodType = this.state.periodType || 'month';
            const selectedPeriod = this.state.selectedPeriod || new Date().toISOString().split('T')[0];
            const comparePeriod = this.state.comparePeriod || null;

            // Calculer les dates selon la p�riode
            const getDateRange = (dateStr, type) => {
                const d = new Date(dateStr);
                if (type === 'day') {
                    return { from: dateStr, to: dateStr };
                } else if (type === 'week') {
                    const start = new Date(d);
                    start.setDate(d.getDate() - d.getDay());
                    const end = new Date(start);
                    end.setDate(start.getDate() + 6);
                    return { from: start.toISOString().split('T')[0], to: end.toISOString().split('T')[0] };
                } else if (type === 'month') {
                    return { from: d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-01', to: new Date(d.getFullYear(), d.getMonth() + 1, 0).toISOString().split('T')[0] };
                } else if (type === 'year') {
                    return { from: d.getFullYear() + '-01-01', to: d.getFullYear() + '-12-31' };
                }
            };

            const currentRange = getDateRange(selectedPeriod, periodType);
            let previousRange = null;
            if (comparePeriod) {
                previousRange = getDateRange(comparePeriod, periodType);
            }

            // Fonction pour filtrer les donn�es par p�riode
            const getDataInRange = (data, from, to) => {
                return data.filter(item => {
                    const date = new Date(item.createdAt || item.date).toISOString().split('T')[0];
                    return date >= from && date <= to;
                });
            };

            const currentOrders = getDataInRange(CORE.db.orders, currentRange.from, currentRange.to);
            const currentDeliveries = getDataInRange(CORE.db.deliveries, currentRange.from, currentRange.to);
            const previousOrders = previousRange ? getDataInRange(CORE.db.orders, previousRange.from, previousRange.to) : [];
            const previousDeliveries = previousRange ? getDataInRange(CORE.db.deliveries, previousRange.from, previousRange.to) : [];

            // Calculs des KPIs
            const calcKpis = (orders, deliveries) => {
                const totalOrders = orders.length;
                const totalRevenue = orders.filter(o => o.status === 'delivered').reduce((a, o) => a + (o.total || 0), 0);
                const deliveredCount = deliveries.filter(d => d.status === 'livree').length;
                const deliveryRate = deliveries.length > 0 ? (deliveredCount / deliveries.length * 100).toFixed(1) : 0;
                const avgOrderValue = totalOrders > 0 ? (totalRevenue / totalOrders).toFixed(2) : 0;
                const totalItems = orders.reduce((a, o) => a + (o.items?.length || 0), 0);
                return { totalOrders, totalRevenue, deliveredCount, deliveryRate, avgOrderValue, totalItems };
            };

            const currentKpis = calcKpis(currentOrders, currentDeliveries);
            const previousKpis = comparePeriod ? calcKpis(previousOrders, previousDeliveries) : null;

            // Comparaison
            const getComparison = (current, previous) => {
                if (!previous || previous === 0) return { value: 0, trend: 'equal' };
                const diff = ((current - previous) / previous * 100).toFixed(1);
                return { value: diff, trend: diff > 0 ? 'up' : diff < 0 ? 'down' : 'equal' };
            };

            const comparisons = previousKpis ? {
                revenue: getComparison(currentKpis.totalRevenue, previousKpis.totalRevenue),
                orders: getComparison(currentKpis.totalOrders, previousKpis.totalOrders),
                delivery: getComparison(parseFloat(currentKpis.deliveryRate), parseFloat(previousKpis.deliveryRate)),
                avg: getComparison(parseFloat(currentKpis.avgOrderValue), parseFloat(previousKpis.avgOrderValue))
            } : null;

            // Top villes
            const topCities = CORE.db.cities.map(city => {
                const cityOrders = currentOrders.filter(o => {
                    const pos = CORE.getPOS(o.posId);
                    return pos && pos.cityId === city.id;
                });
                const revenue = cityOrders.filter(o => o.status === 'delivered').reduce((a, o) => a + (o.total || 0), 0);
                return { city, orders: cityOrders.length, revenue };
            }).sort((a, b) => b.revenue - a.revenue).slice(0, 5);

            // Top POS
            const topPos = CORE.db.pointsOfSale.map(pos => {
                const posOrders = currentOrders.filter(o => o.posId === pos.id);
                const revenue = posOrders.filter(o => o.status === 'delivered').reduce((a, o) => a + (o.total || 0), 0);
                return { pos, orders: posOrders.length, revenue };
            }).sort((a, b) => b.revenue - a.revenue).slice(0, 10);

            // Statut des livraisons
            const deliveryStats = {
                livree: currentDeliveries.filter(d => d.status === 'livree').length,
                en_cours: currentDeliveries.filter(d => d.status === 'en_cours').length,
                en_attente: currentDeliveries.filter(d => d.status === 'en_attente').length,
                probleme: currentDeliveries.filter(d => d.status === 'probleme').length
            };

            // Top produits
            const productSales = {};
            currentOrders.forEach(order => {
                (order.items || []).forEach(item => {
                    if (!productSales[item.productId]) {
                        productSales[item.productId] = { qty: 0, revenue: 0, product: CORE.getProduct(item.productId) };
                    }
                    productSales[item.productId].qty += item.quantity || 1;
                    productSales[item.productId].revenue += (item.price || 0) * (item.quantity || 1);
                });
            });
            const topProducts = Object.values(productSales).sort((a, b) => b.revenue - a.revenue).slice(0, 10);

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">��Ÿ?Š Rapports Analytiques Avanc�s</h2>
                            <p class="text-slate-500 font-medium">Analysez vos performances avec des filtres personnalis�s</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="PDGModule.exportReportPDF()" class="px-4 py-2 rounded-xl bg-red-50 text-red-600 font-black hover:bg-red-100 transition flex items-center gap-2">
                                <i data-lucide="file-pdf" class="w-4 h-4"></i> PDF
                            </button>
                            <button onclick="PDGModule.exportReportExcel()" class="px-4 py-2 rounded-xl bg-emerald-50 text-emerald-600 font-black hover:bg-emerald-100 transition flex items-center gap-2">
                                <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Excel
                            </button>
                        </div>
                    </div>

                    <!-- Filtres et Options de Rapport -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Type de Rapport</label>
                                <select onchange="PDGModule.state.reportType = this.value; App.rerender()" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                                    <option value="sales" ${reportType === 'sales' ? 'selected' : ''}>Ventes</option>
                                    <option value="deliveries" ${reportType === 'deliveries' ? 'selected' : ''}>Livraisons</option>
                                    <option value="inventory" ${reportType === 'inventory' ? 'selected' : ''}>Inventaire</option>
                                    <option value="summary" ${reportType === 'summary' ? 'selected' : ''}>R�sum� G�n�ral</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">P�riode</label>
                                <select onchange="PDGModule.state.periodType = this.value; App.rerender()" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                                    <option value="day" ${periodType === 'day' ? 'selected' : ''}>Jour</option>
                                    <option value="week" ${periodType === 'week' ? 'selected' : ''}>Semaine</option>
                                    <option value="month" ${periodType === 'month' ? 'selected' : ''}>Mois</option>
                                    <option value="year" ${periodType === 'year' ? 'selected' : ''}>Ann�e</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">${periodType === 'day' ? 'Date' : periodType === 'week' ? 'D�but semaine' : periodType === 'month' ? 'Mois' : 'Ann�e'}</label>
                                <input type="${periodType === 'month' ? 'month' : periodType === 'year' ? 'number' : 'date'}" value="${periodType === 'month' ? selectedPeriod.substring(0, 7) : periodType === 'year' ? selectedPeriod.substring(0, 4) : selectedPeriod}" onchange="PDGModule.state.selectedPeriod = this.value; App.rerender()" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Comparer avec</label>
                                <button onclick="PDGModule.showComparisonPeriodModal()" class="w-full px-3 py-2 border border-slate-200 rounded-xl text-left text-slate-700 font-black hover:bg-slate-50">
                                    ${comparePeriod ? comparePeriod : 'S�lectionner...'}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs Principaux avec Comparaison -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-3xl border border-indigo-200 p-6">
                            <div class="text-indigo-700 text-xs font-black uppercase tracking-wider mb-2">Revenu Total</div>
                            <div class="text-3xl font-black text-indigo-600">${CORE.formatPrice(currentKpis.totalRevenue)}</div>
                            ${comparisons ? `<div class="text-xs mt-2 ${comparisons.revenue.value >= 0 ? 'text-emerald-600' : 'text-red-600'}"><i data-lucide="trending-${comparisons.revenue.trend}" class="w-3 h-3 inline mr-1"></i>${comparisons.revenue.value > 0 ? '+' : ''}${comparisons.revenue.value}%</div>` : ''}
                        </div>
                        <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-3xl border border-slate-200 p-6">
                            <div class="text-slate-700 text-xs font-black uppercase tracking-wider mb-2">Commandes</div>
                            <div class="text-3xl font-black text-slate-600">${currentKpis.totalOrders}</div>
                            ${comparisons ? `<div class="text-xs mt-2 ${comparisons.orders.value >= 0 ? 'text-emerald-600' : 'text-red-600'}"><i data-lucide="trending-${comparisons.orders.trend}" class="w-3 h-3 inline mr-1"></i>${comparisons.orders.value > 0 ? '+' : ''}${comparisons.orders.value}%</div>` : ''}
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-3xl border border-emerald-200 p-6">
                            <div class="text-emerald-700 text-xs font-black uppercase tracking-wider mb-2">Taux de Livraison</div>
                            <div class="text-3xl font-black text-emerald-600">${currentKpis.deliveryRate}%</div>
                            ${comparisons ? `<div class="text-xs mt-2 ${comparisons.delivery.value >= 0 ? 'text-emerald-600' : 'text-red-600'}"><i data-lucide="trending-${comparisons.delivery.trend}" class="w-3 h-3 inline mr-1"></i>${comparisons.delivery.value > 0 ? '+' : ''}${comparisons.delivery.value}%</div>` : ''}
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-3xl border border-purple-200 p-6">
                            <div class="text-purple-700 text-xs font-black uppercase tracking-wider mb-2">Panier Moyen</div>
                            <div class="text-3xl font-black text-purple-600">${CORE.formatPrice(currentKpis.avgOrderValue)}</div>
                            ${comparisons ? `<div class="text-xs mt-2 ${comparisons.avg.value >= 0 ? 'text-emerald-600' : 'text-red-600'}"><i data-lucide="trending-${comparisons.avg.trend}" class="w-3 h-3 inline mr-1"></i>${comparisons.avg.value > 0 ? '+' : ''}${comparisons.avg.value}%</div>` : ''}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Top Villes -->
                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                            <div class="p-6 border-b border-slate-100">
                                <h3 class="font-black text-slate-900 flex items-center gap-2">
                                    <i data-lucide="map-pin" class="w-5 h-5 text-indigo-600"></i>
                                    Top Villes par CA
                                </h3>
                            </div>
                            <div class="p-4 space-y-2">
                                ${topCities.map((item, i) => `
                                    <div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 flex items-center justify-between">
                                        <div class="flex items-center gap-3 flex-1">
                                            <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center font-black text-indigo-600 text-sm">${i + 1}</div>
                                            <div class="min-w-0">
                                                <div class="font-black text-slate-900">${item.city.name}</div>
                                                <div class="text-xs text-slate-500">${item.orders} commandes</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-slate-900">${CORE.formatPrice(item.revenue)}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Statut Livraisons -->
                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                            <div class="p-6 border-b border-slate-100">
                                <h3 class="font-black text-slate-900 flex items-center gap-2">
                                    <i data-lucide="truck" class="w-5 h-5 text-emerald-600"></i>
                                    Statut des Livraisons
                                </h3>
                            </div>
                            <div class="p-6 space-y-4">
                                ${[
                                    { status: 'livree', label: 'Livr�es', color: 'emerald', icon: 'check-circle' },
                                    { status: 'en_cours', label: 'En cours', color: 'amber', icon: 'activity' },
                                    { status: 'en_attente', label: 'En attente', color: 'blue', icon: 'clock' },
                                    { status: 'probleme', label: 'Probl��mes', color: 'red', icon: 'alert-circle' }
                                ].map(item => `
                                    <div>
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-2 text-sm font-black text-slate-900">
                                                <i data-lucide="${item.icon}" class="w-4 h-4 text-${item.color}-600"></i>
                                                ${item.label}
                                            </div>
                                            <span class="text-sm font-black text-${item.color}-600">${deliveryStats[item.status]}</span>
                                        </div>
                                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-${item.color}-500" data-percent="${currentDeliveries.length > 0 ? (deliveryStats[item.status] / currentDeliveries.length * 100) : 0}"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Top POS et Produits -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                            <div class="p-6 border-b border-slate-100">
                                <h3 class="font-black text-slate-900 flex items-center gap-2">
                                    <i data-lucide="shopping-bag" class="w-5 h-5 text-slate-600"></i>
                                    Top 10 POS par CA
                                </h3>
                            </div>
                            <div class="p-4 space-y-2 max-h-96 overflow-y-auto">
                                ${topPos.map((item, i) => `
                                    <div class="p-3 rounded-2xl border border-slate-100 hover:bg-slate-50 flex items-center justify-between">
                                        <div class="flex items-center gap-3 flex-1">
                                            <div class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center font-black text-slate-600 text-xs">${i + 1}</div>
                                            <div class="min-w-0">
                                                <div class="font-black text-slate-900 text-sm">${item.pos.name}</div>
                                                <div class="text-xs text-slate-500">${item.orders} cmd</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-sm">${CORE.formatPrice(item.revenue)}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                            <div class="p-6 border-b border-slate-100">
                                <h3 class="font-black text-slate-900 flex items-center gap-2">
                                    <i data-lucide="package" class="w-5 h-5 text-purple-600"></i>
                                    Top 10 Produits
                                </h3>
                            </div>
                            <div class="p-4 space-y-2 max-h-96 overflow-y-auto">
                                ${topProducts.map((item, i) => `
                                    <div class="p-3 rounded-2xl border border-slate-100 hover:bg-slate-50">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="flex items-center gap-2 flex-1">
                                                <div class="w-6 h-6 rounded-full bg-purple-100 flex items-center justify-center font-black text-purple-600 text-xs">${i + 1}</div>
                                                <div class="font-black text-slate-900 text-sm truncate">${item.product?.name || 'Inconnu'}</div>
                                            </div>
                                            <div class="text-right ml-2">
                                                <div class="font-black text-sm">${CORE.formatPrice(item.revenue)}</div>
                                                <div class="text-[10px] text-slate-500">${item.qty} u.</div>
                                            </div>
                                        </div>
                                        <div class="h-1 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-purple-500" data-width="${topProducts.length > 0 ? (item.revenue / Math.max(...topProducts.map(p => p.revenue)) * 100) : 0}"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        showComparisonPeriodModal() {
            UI.modal('S�lectionner la p�riode de comparaison', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">P�riode</label>
                        <select id="comparisonPeriodType" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                            <option value="day">Jour</option>
                            <option value="week">Semaine</option>
                            <option value="month" selected>Mois</option>
                            <option value="year">Ann�e</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Date</label>
                        <input type="date" id="comparisonDate" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                    </div>
                </div>
            `, [
                { label: 'Confirmer', onclick: 'PDGModule.setComparisonPeriod()' },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        setComparisonPeriod() {
            const date = document.getElementById('comparisonDate').value;
            if (!date) {
                UI.toast('S�lectionnez une date', 'error');
                return;
            }
            this.state.comparePeriod = date;
            UI.closeModal();
            App.rerender();
        },

        exportReportPDF() {
            const element = document.querySelector('[class*="fade-in"]');
            if (!element) {
                UI.toast('Aucun rapport �� exporter', 'error');
                return;
            }
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Rapport Analytique</title><style>body{font-family:Arial;margin:20px;}h2{color:#333;}table{width:100%;border-collapse:collapse;}td,th{border:1px solid #ddd;padding:8px;text-align:left;}</style></head><body>');
            printWindow.document.write('<h2>��Ÿ?Š Rapport Analytique Avanc�</h2>');
            printWindow.document.write('<p>G�n�r� le: ' + new Date().toLocaleString('fr-FR') + '</p>');
            printWindow.document.write(element.innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
            UI.toast('Rapport pr��t pour impression PDF', 'success');
        },

        exportReportExcel() {
            const reportType = this.state.reportType || 'sales';
            const periodType = this.state.periodType || 'month';
            const selectedPeriod = this.state.selectedPeriod || new Date().toISOString().split('T')[0];
            
            let csvContent = 'sep=,\n';
            csvContent += 'Rapport Analytique,' + reportType.toUpperCase() + '\n';
            csvContent += 'P�riode,' + periodType + ' - ' + selectedPeriod + '\n';
            csvContent += 'Date d\'export,' + new Date().toLocaleString('fr-FR') + '\n\n';

            if (reportType === 'sales') {
                csvContent += 'Commande,Montant,Statut,Date\n';
                CORE.db.orders.forEach(o => {
                    csvContent += '"' + o.reference + '",' + o.total + ',' + o.status + ',' + CORE.formatDate(o.createdAt) + '\n';
                });
            } else if (reportType === 'deliveries') {
                csvContent += 'Livraison,Client,Montant,Statut,Date\n';
                CORE.db.deliveries.forEach(d => {
                    csvContent += d.id + ',"' + d.clientName + '",' + (d.amount || 0) + ',' + d.status + ',' + CORE.formatDate(d.createdAt) + '\n';
                });
            } else if (reportType === 'inventory') {
                csvContent += 'Produit,Quantit�,Stock Critique,Prix\n';
                CORE.db.products.forEach(p => {
                    csvContent += '"' + p.name + '",' + (p.quantity || 0) + ',' + (p.minStock || 0) + ',' + p.price + '\n';
                });
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'rapport_' + reportType + '_' + new Date().getTime() + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('Rapport Excel g�n�r� avec succ��s', 'success');
        },

        renderContent() {
            const v = this.state.currentView;
            if (v === 'overview') {
                // Auto-load server stats when viewing overview
                setTimeout(() => this.refreshServerStats(), 100);
                return this.renderOverview();
            }
            if (v === 'orders') return this.renderOrders();
            if (v === 'orders-global') return PDGModule.renderOrders();
            if (v === 'deliveries') return this.renderDeliveries();
            if (v === 'inventory') return ManagerModule.renderInventory();
            if (v === 'main-stock') return ManagerModule.renderMainStockControlCenter();
            if (v === 'stock') return this.renderStock();
            if (v === 'pos') return this.renderPOS();
            if (v === 'finance') return this.renderFinance();
            if (v === 'team') return this.renderTeam();
            if (v === 'activity') return this.renderActivity();
            if (v === 'commandes') return this.renderCommandes();
            if (v === 'reports') return this.renderAdvancedReports();
            if (v === 'audit') return this.renderAuditTrail();
            return this.renderOverview();
        },

        /**
         * ISOLATION COMPL�?TE: Panel de v�rification et d'enforcement de l'isolation
         */
        renderIsolationPanel() {
            const report = CORE.validatePOSIsolation();
            return `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-8 rounded-2xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-black mb-2">��Ÿ� � Isolation & S�curit�</h1>
                                <p class="text-white/80">V�rification que chaque POS est COMPL�?TEMENT isol�</p>
                            </div>
                            <div class="text-5xl">${report.isolationStatus === 'FULLY_ISOLATED' ? '���?�' : '��š ��� � �'}</div>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Points de Vente</div>
                            <div class="text-3xl font-black text-slate-900">${report.posCount}</div>
                        </div>
                        <div class="bg-${report.isolationStatus === 'FULLY_ISOLATED' ? 'emerald' : 'amber'}-50 p-6 rounded-2xl border border-${report.isolationStatus === 'FULLY_ISOLATED' ? 'emerald' : 'amber'}-200">
                            <div class="text-xs font-black text-${report.isolationStatus === 'FULLY_ISOLATED' ? 'emerald' : 'amber'}-600 uppercase mb-1">�tat Isolation</div>
                            <div class="text-xl font-black text-${report.isolationStatus === 'FULLY_ISOLATED' ? 'emerald' : 'amber'}-900">${report.isolationStatus === 'FULLY_ISOLATED' ? 'ISOL�' : '�?� CORRIGER'}</div>
                        </div>
                        <div class="bg-${report.issueCount === 0 ? 'emerald' : 'red'}-50 p-6 rounded-2xl border border-${report.issueCount === 0 ? 'emerald' : 'red'}-200">
                            <div class="text-xs font-black text-${report.issueCount === 0 ? 'emerald' : 'red'}-600 uppercase mb-1">Probl��mes</div>
                            <div class="text-3xl font-black text-${report.issueCount === 0 ? 'emerald' : 'red'}-900">${report.issueCount}</div>
                        </div>
                    </div>

                    <!-- Rapport D�taill� -->
                    <div class="bg-white border border-slate-200 rounded-2xl p-6">
                        <h2 class="text-lg font-black text-slate-900 mb-4">��Ÿ?Š Rapport D�taill�</h2>
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            ${report.issues.map(issue => `
                                <div class="flex items-start gap-3 text-sm">
                                    <span class="font-black text-lg mt-0.5">${issue.includes('���?�') ? '���?�' : issue.includes('�� ��?') ? '�� ��?' : '��š ��� � �'}</span>
                                    <span class="text-slate-700">${issue}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Donn�es par POS -->
                    <div class="bg-white border border-slate-200 rounded-2xl p-6">
                        <h2 class="text-lg font-black text-slate-900 mb-4">��Ÿ?�? Donn�es par POS</h2>
                        <div class="space-y-4">
                            ${Object.entries(report.summary).map(([key, data]) => `
                                <div class="p-4 bg-gradient-to-r from-slate-50 to-slate-100 rounded-xl border border-slate-200">
                                    <div class="font-black text-slate-900 mb-2">${data.name}</div>
                                    <div class="grid grid-cols-3 md:grid-cols-6 gap-2 text-xs">
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Clients</div>
                                            <div class="font-black text-lg text-slate-900">${data.clients}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Commandes</div>
                                            <div class="font-black text-lg text-slate-900">${data.orders}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Livraisons</div>
                                            <div class="font-black text-lg text-slate-900">${data.deliveries}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Transactions</div>
                                            <div class="font-black text-lg text-slate-900">${data.transactions}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Notif</div>
                                            <div class="font-black text-lg text-slate-900">${data.notifications}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Mvmts</div>
                                            <div class="font-black text-lg text-slate-900">${data.stockMovements}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="bg-indigo-50 border-2 border-indigo-200 rounded-2xl p-6">
                        <div class="font-black text-indigo-900 mb-4">��š ?��� � � Actions</div>
                        <div class="space-y-2">
                            <button onclick="PDGModule.performIsolationValidation()" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-xl font-black hover:bg-indigo-700 transition">
                                ��Ÿ� � Valider Isolation Compl��te
                            </button>
                            <button onclick="if(confirm('Cela va forcer le respect complet de l\'isolation. Continuer ?')) { PDGModule.performForcedIsolation(); }" class="w-full px-4 py-3 bg-orange-600 text-white rounded-xl font-black hover:bg-orange-700 transition">
                                ��Ÿ�? Forcer Isolation (DANGER!)
                            </button>
                        </div>
                    </div>

                    <!-- Info -->
                    <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4 text-xs text-blue-800">
                        <div class="font-black mb-2">��? ��� � � �?� propos de l'isolation</div>
                        <p>Chaque Point de Vente doit ��tre COMPL�?TEMENT ISOL�. Aucun client, commande, livraison ou notification ne doit ��tre partag� entre les POS. Cette page v�rifie que chaque POS dispose d'une structure de donn�es ind�pendante.</p>
                    </div>
                </div>
            `;
        },

        /**
         * ISOLATION: Valide et affiche un rapport d'isolation
         */
        performIsolationValidation() {
            const report = CORE.validatePOSIsolation();
            const isFull = report.isolationStatus === 'FULLY_ISOLATED';
            
            UI.modal('Rapport d\'Isolation', `
                <div class="space-y-4">
                    <div class="p-4 rounded-xl ${isFull ? 'bg-emerald-50 border border-emerald-200' : 'bg-amber-50 border border-amber-200'}">
                        <div class="font-black ${isFull ? 'text-emerald-900' : 'text-amber-900'}">
                            ${isFull ? '���?� Isolation Compl��te Confirm�e!' : '��š ��� � � Isolation Incompl��te'}
                        </div>
                        <div class="text-sm ${isFull ? 'text-emerald-800' : 'text-amber-800'} mt-2">
                            ${isFull ? 'Tous les POS sont correctement isol�s.' : `${report.issueCount} probl��me(s) d�tect�(s).`}
                        </div>
                    </div>
                    <div class="text-xs text-slate-600 max-h-48 overflow-y-auto space-y-2">
                        ${report.issues.map(i => `<div>${i}</div>`).join('')}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        /**
         * ISOLATION: Force l'application compl��te de l'isolation
         */
        performForcedIsolation() {
            const report = CORE.enforceISOLATION();
            UI.toast('��Ÿ�? Isolation forc�e appliqu�e!', 'success');
            UI.modal('Isolation Forc�e Appliqu�e', `
                <div class="space-y-4">
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                        <div class="font-black text-emerald-900">���?� Isolation Compl��te Appliqu�e!</div>
                        <div class="text-sm text-emerald-800 mt-2">Tous les POS ont �t� forc�s �� l'isolation compl��te.</div>
                    </div>
                    <div class="text-xs text-slate-600">
                        <div class="font-black mb-2">R�sum�:</div>
                        <div>Timestamp: ${report.timestamp}</div>
                        <div>POS: ${report.posCount}</div>
                        <div>�tat: ${report.isolationStatus}</div>
                    </div>
                </div>
            `, [
                { label: 'OK', onclick: 'UI.closeModal(); PDGModule.navigateTo("isolation");' }
            ]);
            setTimeout(() => App.rerender(), 500);
        },

        renderNavItem(view, icon, label) {
            if (!CORE.canAccessView(view)) return '';
            const active = this.state.currentView === view;
            return `
                <button onclick="PDGModule.navigateTo('${view}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group ${active ? 'bg-gradient-to-r from-violet-500/20 to-purple-500/10 text-purple-300 border-l-2 border-purple-400' : 'text-slate-400 hover:bg-white/5 hover:text-white'}">
                    <div class="w-9 h-9 rounded-xl ${active ? 'bg-purple-500/20' : 'bg-white/5 group-hover:bg-white/10'} flex items-center justify-center transition-all duration-200">
                        <i data-lucide="${icon}" class="w-5 h-5 ${active ? 'drop-shadow-[0_0_8px_rgba(139,92,246,0.5)]' : ''}"></i>
                    </div>
                    <span class="font-bold text-sm">${label}</span>
                    ${active ? '<div class="ml-auto w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div>' : ''}
                </button>`;
        },

        showRolesManagementModal() {
            const roles = CORE.db.roles || [];
            const customRoles = roles.filter(r => r.isCustom);
            const defaultRoles = roles.filter(r => !r.isCustom);

            UI.modal('Gestion des R��les', `
                <div class="space-y-6 max-h-[70vh] overflow-y-auto">
                    <!-- Cr�er un nouveau r��le -->
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                        <div class="font-black text-emerald-900 mb-3">��ž� Cr�er un R��le Personnalis�</div>
                        <div class="space-y-3">
                            <input type="text" id="newRoleName" placeholder="Nom du r��le" class="w-full px-3 py-2 border border-emerald-300 rounded-xl">
                            <textarea id="newRoleDesc" placeholder="Description" class="w-full px-3 py-2 border border-emerald-300 rounded-xl" rows="2"></textarea>
                            <button onclick="PDGModule.createNewCustomRole()" class="w-full px-3 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700">Cr�er le r��le</button>
                        </div>
                    </div>

                    <!-- R��les par d�faut -->
                    <div>
                        <div class="text-xs font-black text-slate-600 uppercase mb-2">R��les par D�faut (${defaultRoles.length})</div>
                        ${defaultRoles.map(role => `
                            <div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 mb-2">
                                <div class="flex items-start justify-between mb-2">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="${role.icon}" class="w-5 h-5 text-${role.color}-600"></i>
                                            <span class="font-black text-slate-900">${role.name}</span>
                                        </div>
                                        <div class="text-xs text-slate-500">${role.description}</div>
                                    </div>
                                </div>
                                <div class="text-xs font-black text-slate-600 mb-2">Permissions: ${role.permissions?.length || 0}</div>
                                <button onclick="PDGModule.showRoleDetailsModal('${role.id}')" class="text-xs font-black text-indigo-600 hover:text-indigo-700">Voir d�tails</button>
                            </div>
                        `).join('')}
                    </div>

                    <!-- R��les personnalis�s -->
                    ${customRoles.length > 0 ? `
                        <div>
                            <div class="text-xs font-black text-slate-600 uppercase mb-2">R��les Personnalis�s (${customRoles.length})</div>
                            ${customRoles.map(role => `
                                <div class="p-4 rounded-2xl border-2 border-purple-200 bg-purple-50 mb-2">
                                    <div class="flex items-start justify-between mb-2">
                                        <div>
                                            <div class="flex items-center gap-2">
                                                <i data-lucide="${role.icon}" class="w-5 h-5 text-purple-600"></i>
                                                <span class="font-black text-slate-900">${role.name}</span>
                                            </div>
                                            <div class="text-xs text-slate-500">${role.description}</div>
                                        </div>
                                        <i data-lucide="star" class="w-4 h-4 text-purple-600"></i>
                                    </div>
                                    <div class="text-xs font-black text-slate-600 mb-2">Permissions: ${role.permissions?.length || 0}</div>
                                    <div class="flex gap-2">
                                        <button onclick="PDGModule.showRoleDetailsModal('${role.id}')" class="text-xs font-black text-indigo-600 hover:text-indigo-700">Modifier</button>
                                        <button onclick="if(confirm('Supprimer ce r��le ?')) { CORE.deleteCustomRole('${role.id}'); PDGModule.showRolesManagementModal(); }" class="text-xs font-black text-red-600 hover:text-red-700">Supprimer</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showInviteEmployeeModal() {
            const roles = ['MANAGER', 'GESTIONNAIRE', 'VENDEUR', 'LIVREUR'];
            const tenantCode = CORE.db.systemConfig?.tenantCode || 'N/A';

            UI.modal('Inviter un Employ&eacute;', `
                <div class="space-y-6">
                    <!-- Code entreprise existant -->
                    <div class="p-4 bg-gradient-to-r from-slate-50 to-slate-100 rounded-xl border border-slate-200">
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Code Entreprise (partager directement)</div>
                        <div class="flex items-center gap-3">
                            <code class="flex-1 px-4 py-3 bg-white rounded-lg font-mono text-lg font-black text-slate-800 border border-slate-200">${tenantCode}</code>
                            <button onclick="navigator.clipboard.writeText('${tenantCode}'); UI.toast('Code copi&eacute; !', 'success')" class="p-3 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition">
                                <i data-lucide="copy" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Les employ&eacute;s peuvent utiliser ce code lors de l'inscription pour rejoindre votre entreprise.</p>
                    </div>

                    <div class="border-t border-slate-200 pt-4">
                        <div class="text-sm font-black text-slate-700 mb-4">Ou cr&eacute;er une invitation personnalis&eacute;e :</div>

                        <!-- Role -->
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">R&ocirc;le attribu&eacute;</label>
                            <select id="invite-role" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                                ${roles.map(r => `<option value="${r}">${r}</option>`).join('')}
                            </select>
                        </div>

                        <!-- Email optionnel -->
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">Email (optionnel)</label>
                            <input type="email" id="invite-email" placeholder="employe@email.com" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500">
                        </div>

                        <!-- Nombre d utilisations -->
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">Nombre max d'utilisations</label>
                            <select id="invite-uses" class="w-full px-4 py-3 rounded-xl border border-slate-200">
                                <option value="1">1 (invitation unique)</option>
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="50">50</option>
                                <option value="100">100 (recrutement en masse)</option>
                            </select>
                        </div>

                        <!-- Validit� -->
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">Validit&eacute;</label>
                            <select id="invite-days" class="w-full px-4 py-3 rounded-xl border border-slate-200">
                                <option value="1">1 jour</option>
                                <option value="7" selected>7 jours</option>
                                <option value="30">30 jours</option>
                                <option value="90">90 jours</option>
                            </select>
                        </div>
                    </div>

                    <!-- R�sultat invitation -->
                    <div id="invite-result" class="hidden p-4 bg-emerald-50 rounded-xl border border-emerald-200">
                        <div class="text-sm font-black text-emerald-700 mb-2">Code d'invitation g&eacute;n&eacute;r&eacute; !</div>
                        <div class="flex items-center gap-3">
                            <code id="invite-code" class="flex-1 px-4 py-3 bg-white rounded-lg font-mono text-xl font-black text-emerald-800 border border-emerald-200 text-center"></code>
                            <button onclick="navigator.clipboard.writeText(document.getElementById('invite-code').textContent); UI.toast('Code copi&eacute; !', 'success')" class="p-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
                                <i data-lucide="copy" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' },
                { label: 'G&eacute;n&eacute;rer le code', onclick: 'PDGModule.generateInvitationCode()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
            lucide.createIcons();
        },

        async generateInvitationCode() {
            const role = document.getElementById('invite-role')?.value || 'VENDEUR';
            const email = document.getElementById('invite-email')?.value || null;
            const maxUses = parseInt(document.getElementById('invite-uses')?.value) || 10;
            const expiresInDays = parseInt(document.getElementById('invite-days')?.value) || 7;

            if (CORE.state.isOnline) {
                try {
                    const result = await API.createBulkInvitation(role, maxUses, expiresInDays);
                    const code = result.invitationCode;
                    document.getElementById('invite-result').classList.remove('hidden');
                    document.getElementById('invite-code').textContent = code;
                    UI.toast('Invitation cr&eacute;&eacute;e avec succ&egrave;s !', 'success');
                    lucide.createIcons();
                    return;
                } catch (e) {
                    console.warn('API invitation failed:', e.message);
                }
            }

            // Mode local fallback
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 8; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));

            // Stocker localement
            CORE.db.invitations = CORE.db.invitations || [];
            CORE.db.invitations.push({
                code,
                role,
                maxUses,
                currentUses: 0,
                expiresAt: new Date(Date.now() + expiresInDays * 24 * 60 * 60 * 1000).toISOString(),
                createdAt: new Date().toISOString()
            });
            CORE.save();

            document.getElementById('invite-result').classList.remove('hidden');
            document.getElementById('invite-code').textContent = code;
            UI.toast('Code g&eacute;n&eacute;r&eacute; (mode local)', 'success');
            lucide.createIcons();
        },

        showRoleDetailsModal(roleId) {
            const role = CORE.db.roles?.find(r => r.id === roleId);
            if (!role) return UI.toast('R��le introuvable', 'error');

            const allPermissions = CORE.db.permissions || [];
            const categories = [...new Set(allPermissions.map(p => p.category))];

            UI.modal('D�tails - ' + role.name, `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <div class="text-xs font-black text-slate-600">Nom</div>
                                <div class="font-black text-slate-900">${role.name}</div>
                            </div>
                            <div>
                                <div class="text-xs font-black text-slate-600">Type</div>
                                <div class="font-black text-slate-900">${role.isCustom ? '�� � � Personnalis�' : '��Ÿ� � D�faut'}</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="text-xs font-black text-slate-600 uppercase mb-3">Permissions</div>
                        <div class="space-y-4">
                            ${categories.map(cat => `
                                <div class="p-4 rounded-2xl border border-slate-200">
                                    <div class="font-black text-slate-900 mb-3">${cat.charAt(0).toUpperCase() + cat.slice(1)}</div>
                                    <div class="space-y-2">
                                        ${allPermissions.filter(p => p.category === cat).map(perm => {
                                            const hasPermission = role.permissions?.includes(perm.id) || role.permissions?.includes('all');
                                            return `
                                                <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50">
                                                    <input type="checkbox" ${hasPermission ? 'checked' : ''} ${role.id === 'pdg' ? 'disabled' : ''} onchange="PDGModule.togglePermissionForRole('${roleId}', '${perm.id}', this.checked)" class="w-4 h-4 rounded">
                                                    <div class="flex-1 min-w-0">
                                                        <div class="text-sm font-black text-slate-900">${perm.label}</div>
                                                    </div>
                                                </label>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        togglePermissionForRole(roleId, permissionId, hasPermission) {
            const role = CORE.db.roles?.find(r => r.id === roleId);
            if (!role || role.id === 'pdg') return UI.toast('Impossible de modifier ce r��le', 'error');

            if (hasPermission) {
                if (!role.permissions.includes(permissionId)) {
                    role.permissions.push(permissionId);
                }
            } else {
                role.permissions = role.permissions.filter(p => p !== permissionId);
            }

            CORE.save();
            CORE.logAudit('update', 'role', roleId, role.name, 
                { permission: permissionId, action: hasPermission ? 'ajout�e' : 'retir�e' },
                null,
                { permissions: role.permissions }
            );
            UI.toast(`Permission ${hasPermission ? 'ajout�e' : 'retir�e'}`, 'info');
        },

        createNewCustomRole() {
            const name = document.getElementById('newRoleName').value;
            const desc = document.getElementById('newRoleDesc').value;

            if (!name.trim()) {
                UI.toast('Veuillez entrer un nom', 'error');
                return;
            }

            const customRole = CORE.createCustomRole(name, desc || 'R��le personnalis�', [], 'purple', 'shield');
            if (customRole) {
                UI.toast(`R��le "${name}" cr�� avec succ��s`, 'success');
                PDGModule.showRoleDetailsModal(customRole.id);
            }
        },

        showPermissionsManagerModal() {
            const managerRole = CORE.db.roles?.find(r => r.id === 'manager');
            if (!managerRole) return UI.toast('R��le Manager non trouv�', 'error');

            const allPermissions = CORE.db.permissions || [];
            const categories = [...new Set(allPermissions.map(p => p.category))];

            UI.modal('Permissions Manager - Modification en Temps R�el', `
                <div class="space-y-6 max-h-[70vh] overflow-y-auto">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="font-black text-blue-900 mb-2">��? ��� � � Modifications en temps r�el</div>
                        <div class="text-xs text-blue-700">Les permissions du Manager seront mises �� jour imm�diatement et enregistr�es dans l'audit.</div>
                    </div>

                    <div>
                        <div class="text-xs font-black text-slate-600 uppercase mb-3">Permissions du Manager</div>
                        <div class="space-y-4">
                            ${categories.map(cat => {
                                const permsInCat = allPermissions.filter(p => p.category === cat);
                                return `
                                    <div class="p-4 rounded-2xl border border-slate-200">
                                        <div class="font-black text-slate-900 mb-3 flex items-center gap-2">
                                            <div class="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center text-sm">${permsInCat.length}</div>
                                            ${cat.charAt(0).toUpperCase() + cat.slice(1)}
                                        </div>
                                        <div class="space-y-2">
                                            ${permsInCat.map(perm => {
                                                const hasPermission = managerRole.permissions?.includes(perm.id);
                                                return `
                                                    <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50">
                                                        <input type="checkbox" ${hasPermission ? 'checked' : ''} onchange="PDGModule.updateManagerPermissionRealtime('${perm.id}', this.checked)" class="w-4 h-4 rounded">
                                                        <div class="flex-1 min-w-0">
                                                            <div class="text-sm font-black text-slate-900">${perm.label}</div>
                                                            <div class="text-[10px] text-slate-500">${perm.entity} - ${perm.action}</div>
                                                        </div>
                                                        <i data-lucide="${perm.icon}" class="w-4 h-4 text-slate-400 flex-shrink-0"></i>
                                                    </label>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                        <div class="font-black text-amber-900 mb-2">��š ��� � � Actions rapides</div>
                        <div class="flex gap-2">
                            <button onclick="PDGModule.grantAllManagerPermissions()" class="flex-1 px-3 py-2 bg-emerald-600 text-white rounded-lg text-xs font-black hover:bg-emerald-700">Accorder tout</button>
                            <button onclick="PDGModule.revokeAllManagerPermissions()" class="flex-1 px-3 py-2 bg-red-600 text-white rounded-lg text-xs font-black hover:bg-red-700">R�voquer tout</button>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        updateManagerPermissionRealtime(permissionId, granted) {
            const managerRole = CORE.db.roles?.find(r => r.id === 'manager');
            if (!managerRole) return;

            if (granted) {
                if (!managerRole.permissions.includes(permissionId)) {
                    managerRole.permissions.push(permissionId);
                }
            } else {
                managerRole.permissions = managerRole.permissions.filter(p => p !== permissionId);
            }

            CORE.save();
            CORE.logAudit('update', 'role_permission', 'manager', 'Manager',
                { permission: permissionId, granted: granted },
                null,
                null
            );

            UI.toast(`Permission Manager ${granted ? 'ajout�e' : 'retir�e'}: ${permissionId}`, 'info');
        },

        grantAllManagerPermissions() {
            const managerRole = CORE.db.roles?.find(r => r.id === 'manager');
            if (!managerRole) return;

            const allPermissions = CORE.db.permissions?.map(p => p.id) || [];
            managerRole.permissions = [...new Set([...managerRole.permissions, ...allPermissions])];

            CORE.save();
            CORE.logAudit('update', 'role', 'manager', 'Manager',
                { action: 'Tous les permissions accord�es' },
                null,
                { permissions: managerRole.permissions }
            );

            UI.toast('���?? Toutes les permissions accord�es au Manager', 'success');
            PDGModule.showPermissionsManagerModal();
        },

        showAlertThresholdsModal() {
            const thresholds = CORE.db.alertThresholds || [];
            
            UI.modal('Configuration des Seuils d\'Alerte', `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-2xl">
                        <div class="font-black text-indigo-900 mb-2">��š ?��� � � Seuils de d�clenchement</div>
                        <div class="text-xs text-indigo-700">Configurez les seuils qui d�clenchent les alertes automatiques dans le syst��me.</div>
                    </div>

                    ${thresholds.map(threshold => `
                        <div class="p-4 border-2 rounded-2xl ${threshold.enabled ? 'border-emerald-300 bg-emerald-50' : 'border-slate-200 bg-slate-50'}">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <div class="font-black text-slate-900">${threshold.name}</div>
                                    <div class="text-xs text-slate-600 mt-1">${threshold.description}</div>
                                </div>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" ${threshold.enabled ? 'checked' : ''} onchange="CORE.toggleAlertThreshold('${threshold.id}', this.checked); PDGModule.showAlertThresholdsModal();" class="w-4 h-4 rounded">
                                    <span class="text-xs font-black">${threshold.enabled ? '���?? Actif' : 'Inactif'}</span>
                                </label>
                            </div>
                            
                            ${threshold.threshold !== undefined ? `
                                <div class="flex items-center gap-3 p-3 bg-white rounded-xl border border-slate-200">
                                    <label class="flex-1">
                                        <div class="text-xs font-black text-slate-600 mb-1">Seuil: ${threshold.threshold}${threshold.id.includes('rate') ? '%' : ''}</div>
                                        <input type="number" value="${Math.max(1, parseInt(threshold.threshold) || 1)}" min="1" max="1000" 
                                            onchange="CORE.updateAlertThreshold('${threshold.id}', parseInt(this.value)); CORE.save();"
                                            class="w-full px-2 py-1 border border-slate-300 rounded-lg text-xs font-black text-slate-900" />
                                    </label>
                                </div>
                            ` : ''}

                            <div class="flex items-center gap-2 mt-3">
                                <span class="text-[10px] font-black px-2 py-1 rounded-full ${
                                    threshold.severity === 'critical' ? 'bg-red-200 text-red-800' :
                                    threshold.severity === 'high' ? 'bg-orange-200 text-orange-800' :
                                    threshold.severity === 'medium' ? 'bg-amber-200 text-amber-800' :
                                    'bg-blue-200 text-blue-800'
                                }">
                                    S�v�rit�: ${threshold.severity.toUpperCase()}
                                </span>
                            </div>
                        </div>
                    `).join('')}

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="font-black text-slate-900 text-sm mb-3">��Ÿ?Š Notifications Active</div>
                        <div class="text-sm text-slate-700">
                            <strong>${CORE.getUnreadNotificationCount()}</strong> notifications non lues
                        </div>
                        <div class="mt-3">
                            <button onclick="PDGModule.showNotificationHistoryModal()" class="w-full px-3 py-2 bg-slate-900 text-white rounded-lg text-xs font-black hover:bg-slate-800 transition">
                                ��Ÿ?�? Voir l'historique
                            </button>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        getNotificationFilters() {
            if (!this.state.notificationFilters) {
                this.state.notificationFilters = NotificationUtils.defaultFilters();
            }
            return NotificationUtils.ensureFilters(this.state.notificationFilters);
        },

        updateNotificationFilter(key, value) {
            const current = this.getNotificationFilters();
            this.state.notificationFilters = { ...current, [key]: value };
            this.refreshNotificationHistoryModal();
        },

        toggleUnreadFilter() {
            const current = this.getNotificationFilters();
            this.state.notificationFilters = { ...current, showUnread: !current.showUnread };
            this.refreshNotificationHistoryModal();
        },

        resetNotificationFilters() {
            this.state.notificationFilters = NotificationUtils.defaultFilters();
            this.refreshNotificationHistoryModal();
        },

        markAllNotificationsRead() {
            (CORE.db.notifications || []).forEach(n => {
                n.read = true;
                n.readAt = new Date().toISOString();
            });
            CORE.save();
            this.refreshNotificationHistoryModal();
            App.rerender();
        },

        toggleNotificationRead(id) {
            const notif = (CORE.db.notifications || []).find(n => n.id === id);
            if (!notif) return;
            const next = !notif.read;
            notif.read = next;
            notif.readAt = next ? new Date().toISOString() : null;
            CORE.save();
            this.refreshNotificationHistoryModal();
            App.rerender();
        },

        removeNotification(id) {
            const before = (CORE.db.notifications || []).length;
            CORE.db.notifications = (CORE.db.notifications || []).filter(n => n.id !== id);
            if (CORE.db.notifications.length !== before) {
                CORE.save();
                UI.toast('Notification archiv�e', 'success');
                this.refreshNotificationHistoryModal();
                App.rerender();
            }
        },

        refreshNotificationHistoryModal() {
            const container = document.querySelector('#modalContainer .modal-content');
            if (!container) return;
            UI.updateModalContent(this.renderNotificationHistoryContent());
        },

        renderNotificationHistoryContent() {
            const filters = this.getNotificationFilters();
            const allHistory = CORE.getNotificationHistory(300);
            const filtered = NotificationUtils.applyFilters(allHistory, filters);
            const grouped = NotificationUtils.groupByDate(filtered);
            const counts = NotificationUtils.countBySeverity(allHistory);
            const typeOptions = NotificationUtils.getTypeOptions(allHistory);
            const unreadCount = CORE.getUnreadNotificationCount();

            const severityOptions = [
                { key: 'all', label: 'Toutes', chip: 'bg-slate-200 text-slate-700' },
                { key: 'critical', label: 'Critiques' },
                { key: 'high', label: 'Prioritaires' },
                { key: 'medium', label: 'Mod�r�es' },
                { key: 'low', label: 'Faibles' },
                { key: 'info', label: 'Info' }
            ];

            const periodOptions = [
                { key: '24h', label: '24h' },
                { key: '7d', label: '7j' },
                { key: '30d', label: '30j' },
                { key: 'all', label: 'Tout' }
            ];

            return `
                <div class="space-y-5">
                    <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4 space-y-4">
                        <div class="flex flex-wrap items-center justify-between gap-3">
                            <div>
                                <div class="text-sm font-black text-slate-900">${filtered.length} �l�ment${filtered.length > 1 ? 's' : ''} affich�${filtered.length > 1 ? 's' : ''}</div>
                                <div class="text-xs text-slate-500">${allHistory.length} notifications totales �� ?� � ${unreadCount} non lues</div>
                            </div>
                            <div class="flex flex-wrap gap-2 text-xs font-black">
                                <button class="px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-100 transition" onclick="PDGModule.resetNotificationFilters()">R�initialiser</button>
                                <button class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition" onclick="PDGModule.markAllNotificationsRead()">Tout marquer lu</button>
                            </div>
                        </div>

                        <div class="grid gap-3">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div class="relative flex gap-2">
                                    <input type="search" id="pdg-notif-search" value="${NotificationUtils.escape(filters.search)}" onkeypress="if(event.key==='Enter'){PDGModule.updateNotificationFilter('search', this.value)}" placeholder="Rechercher par titre, message ou type" class="flex-1 px-4 py-2.5 rounded-xl border border-slate-200 bg-white text-sm focus:ring-2 focus:ring-emerald-500 focus:border-transparent" />
                                    <button onclick="PDGModule.updateNotificationFilter('search', document.getElementById('pdg-notif-search').value)" class="px-3 py-2 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition"><i data-lucide="search" class="w-4 h-4"></i></button>
                                </div>
                                <div class="flex items-center gap-2">
                                    ${periodOptions.map(option => `
                                        <button class="px-3 py-2 rounded-lg text-xs font-black border ${filters.period === option.key ? 'bg-slate-900 text-white border-slate-900' : 'bg-white border-slate-200 hover:bg-slate-100'}" onclick="PDGModule.updateNotificationFilter('period', '${option.key}')">${option.label}</button>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="flex flex-wrap items-center gap-2">
                                ${severityOptions.map(option => {
                                    const meta = option.key !== 'all' ? NotificationUtils.getSeverityMeta(option.key) : null;
                                    const isActive = filters.severity === option.key;
                                    const base = option.key === 'all' ? option.chip : meta?.chip;
                                    return `<button class="px-3 py-1.5 rounded-full text-[11px] font-black border ${isActive ? (option.key === 'all' ? 'border-slate-900 bg-slate-900 text-white' : 'border-transparent ' + base) : 'border-slate-200 bg-white text-slate-600'}" onclick=\"PDGModule.updateNotificationFilter('severity','${option.key}')\">${option.label} (${counts[option.key] ?? 0})</button>`;
                                }).join('')}
                                <button class="px-3 py-1.5 rounded-full text-[11px] font-black border ${filters.showUnread ? 'bg-amber-500 border-transparent text-white' : 'bg-white border-slate-200 text-slate-600'}" onclick="PDGModule.toggleUnreadFilter()">${filters.showUnread ? 'Non lues uniquement' : 'Inclure non lues'}</button>
                            </div>

                            ${typeOptions.length > 0 ? `
                                <div>
                                    <label class="text-[11px] uppercase font-black text-slate-500 tracking-wide mb-1 block">Type</label>
                                    <select class="w-full md:w-auto px-3 py-2 border border-slate-200 rounded-lg text-sm font-black bg-white" onchange="PDGModule.updateNotificationFilter('type', this.value)">
                                        <option value="all" ${filters.type === 'all' ? 'selected' : ''}>Tous les types</option>
                                        ${typeOptions.map(type => `<option value="${NotificationUtils.escape(type)}" ${filters.type.toLowerCase() === type.toLowerCase() ? 'selected' : ''}>${NotificationUtils.escape(NotificationUtils.getTypeLabel(type))}</option>`).join('')}
                                    </select>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    ${filtered.length === 0 ? `
                        <div class="p-10 text-center border border-dashed border-slate-200 rounded-2xl bg-white">
                            <div class="text-4xl mb-2">��ŸŽ�</div>
                            <div class="font-black text-slate-700">Aucune notification �� afficher</div>
                            <div class="text-xs text-slate-500 mt-1">Modifiez vos filtres pour �largir la recherche.</div>
                        </div>
                    ` : `
                        <div class="space-y-6">
                            ${grouped.map(group => `
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between text-xs font-black text-slate-500 uppercase tracking-wide">
                                        <span>${group.label}</span>
                                        <span>${group.items.length} notification${group.items.length > 1 ? 's' : ''}</span>
                                    </div>
                                    <div class="space-y-3">
                                        ${group.items.map(item => {
                                            const meta = NotificationUtils.getSeverityMeta(item.severity);
                                            const ts = NotificationUtils.getTimestamp(item);
                                            const relative = NotificationUtils.formatRelative(ts);
                                            const readClass = item.read ? 'opacity-85' : 'ring-2 ring-offset-2 ring-slate-300';
                                            return `
                                                <div class="p-4 rounded-2xl transition ${meta.panel} ${readClass}">
                                                    <div class="flex flex-col gap-3">
                                                        <div class="flex items-start gap-3">
                                                            <span class="w-2 h-2 mt-1 rounded-full ${meta.dot}"></span>
                                                            <div class="flex-1">
                                                                <div class="flex flex-wrap items-start gap-2 justify-between">
                                                                    <div>
                                                                        <div class="text-sm font-black text-slate-900">${NotificationUtils.escape(item.title)}</div>
                                                                        ${item.message ? `<div class="text-xs text-slate-600 mt-1">${NotificationUtils.escape(item.message)}</div>` : ''}
                                                                    </div>
                                                                    <div class="flex flex-wrap gap-2">
                                                                        <button class="text-[10px] font-black px-2 py-1 rounded-full border border-transparent ${item.read ? 'bg-white text-slate-500 border-slate-200' : 'bg-slate-900 text-white'}" onclick="PDGModule.toggleNotificationRead(${item.id})">${item.read ? 'Marquer non lu' : 'Marquer lu'}</button>
                                                                        <button class="text-[10px] font-black px-2 py-1 rounded-full border border-transparent bg-white text-slate-500 border-slate-200 hover:bg-slate-100" onclick="PDGModule.removeNotification(${item.id})">Archiver</button>
                                                                    </div>
                                                                </div>
                                                                <div class="flex flex-wrap items-center gap-2 mt-3 text-[10px] font-black text-slate-500">
                                                                    <span class="px-2 py-1 rounded-full ${meta.badge}">${meta.label}</span>
                                                                    <span class="px-2 py-1 rounded-full bg-slate-200 text-slate-700">${NotificationUtils.escape(NotificationUtils.getTypeLabel(item.type))}</span>
                                                                    ${item.relatedTo ? `<span class="px-2 py-1 rounded-full bg-slate-100 text-slate-500 border border-slate-200">${NotificationUtils.escape(NotificationUtils.getTypeLabel(item.relatedTo))}${item.relatedId ? ' #' + NotificationUtils.escape(item.relatedId) : ''}</span>` : ''}
                                                                    <span>${relative}</span>
                                                                    ${ts ? `<span class="text-slate-400">${CORE.formatDate(ts)}</span>` : ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        },

        showNotificationHistoryModal() {
            UI.modal('Historique des Notifications', this.renderNotificationHistoryContent(), [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showBudgetManagementModal() {
            const budgets = CORE.db.budgets || [];
            const categories = ['salaires', 'operationnel', 'marketing', 'logistics', 'maintenance', 'other'];
            const categoryLabels = {
                'salaires': '��Ÿ? � Salaires',
                'operationnel': '��š ?��� � � Op�rationnel',
                'marketing': '��Ÿ? � Marketing',
                'logistics': '��Ÿšš Logistique',
                'maintenance': '��Ÿ� � Maintenance',
                'other': '��Ÿ?� Autre'
            };

            UI.modal('Gestion des Budgets', `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                        <div class="font-black text-emerald-900 mb-3">��ž� Cr�er un Nouveau Budget</div>
                        <div class="space-y-3">
                            <input type="text" id="budgetName" placeholder="Nom du budget (ex: Salaires Q1)" class="w-full px-3 py-2 border border-emerald-300 rounded-xl">
                            <select id="budgetCategory" class="w-full px-3 py-2 border border-emerald-300 rounded-xl font-black">
                                <option value="">S�lectionner une cat�gorie</option>
                                ${categories.map(cat => `<option value="${cat}">${categoryLabels[cat]}</option>`).join('')}
                            </select>
                            <input type="number" id="budgetAmount" placeholder="Montant (XAF)" min="0" class="w-full px-3 py-2 border border-emerald-300 rounded-xl">
                            <input type="date" id="budgetStartDate" class="w-full px-3 py-2 border border-emerald-300 rounded-xl">
                            <input type="date" id="budgetEndDate" class="w-full px-3 py-2 border border-emerald-300 rounded-xl">
                            <textarea id="budgetNotes" placeholder="Notes (optionnel)" class="w-full px-3 py-2 border border-emerald-300 rounded-xl h-16"></textarea>
                            <button onclick="PDGModule.createNewBudget()" class="w-full px-3 py-2 bg-emerald-600 text-white rounded-lg text-xs font-black hover:bg-emerald-700">Cr�er le budget</button>
                        </div>
                    </div>

                    <div class="h-px bg-slate-200"></div>

                    <div>
                        <div class="text-xs font-black text-slate-600 uppercase mb-3">��Ÿ?Š Budgets Actifs (${budgets.length})</div>
                        ${budgets.length === 0 ? `
                            <div class="p-8 text-center rounded-2xl border-2 border-dashed border-slate-200 bg-slate-50">
                                <div class="text-2xl mb-2">��Ÿ?�</div>
                                <div class="font-black text-slate-600">Aucun budget</div>
                                <div class="text-xs text-slate-500 mt-1">Cr�ez votre premier budget ci-dessus</div>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${budgets.map(budget => {
                                    const status = CORE.getBudgetStatus(budget.id);
                                    const isOver = status.status === 'over';
                                    const isWarning = status.status === 'warning';
                                    return `
                                        <div class="p-4 rounded-2xl border-l-4 ${
                                            isOver ? 'border-l-red-600 bg-red-50 border border-red-200' :
                                            isWarning ? 'border-l-amber-600 bg-amber-50 border border-amber-200' :
                                            'border-l-emerald-600 bg-emerald-50 border border-emerald-200'
                                        }">
                                            <div class="flex items-start justify-between mb-2">
                                                <div>
                                                    <div class="font-black text-slate-900">${budget.name}</div>
                                                    <div class="text-xs text-slate-600 mt-1">${categoryLabels[budget.category]}</div>
                                                </div>
                                                <button onclick="if(confirm('Supprimer ce budget ?')) { CORE.db.budgets = CORE.db.budgets.filter(b => b.id !== ${budget.id}); CORE.save(); PDGModule.showBudgetManagementModal(); }" class="text-xs font-black text-red-600 hover:text-red-700">���?�</button>
                                            </div>
                                            <div class="space-y-2">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-sm font-black text-slate-900">${status.spent.toFixed(2)} XAF / ${budget.amount.toFixed(2)} XAF</span>
                                                    <span class="text-xs font-black px-2 py-1 rounded-full ${
                                                        isOver ? 'bg-red-300 text-red-900' :
                                                        isWarning ? 'bg-amber-300 text-amber-900' :
                                                        'bg-emerald-300 text-emerald-900'
                                                    }">${status.percentageUsed}%</span>
                                                </div>
                                                <div class="w-full h-2 bg-slate-300 rounded-full overflow-hidden">
                                                    <div class="h-full ${
                                                        isOver ? 'bg-red-600' :
                                                        isWarning ? 'bg-amber-600' :
                                                        'bg-emerald-600'
                                                    }" data-width="${Math.min(status.percentageUsed, 100)}"></div>
                                                </div>
                                                <div class="text-[10px] text-slate-600">
                                                    Restant: <strong>${Math.max(0, status.remaining).toFixed(2)} XAF</strong>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        createNewBudget() {
            const name = document.getElementById('budgetName').value.trim();
            const category = document.getElementById('budgetCategory').value;
            const amount = parseFloat(document.getElementById('budgetAmount').value);
            const startDate = document.getElementById('budgetStartDate').value;
            const endDate = document.getElementById('budgetEndDate').value;
            const notes = document.getElementById('budgetNotes').value.trim();

            if (!name || !category || !amount || !startDate || !endDate) {
                return UI.toast('Veuillez remplir tous les champs requis', 'warning');
            }

            if (new Date(startDate) >= new Date(endDate)) {
                return UI.toast('La date de fin doit ��tre apr��s la date de d�but', 'warning');
            }

            CORE.createBudget(name, category, amount, startDate, endDate, notes);
            UI.toast(`Budget "${name}" cr�� avec succ��s`, 'success');
            PDGModule.showBudgetManagementModal();
        },

        showFinancialDashboardModal() {
            const health = CORE.getFinancialHealth();
            const budgetComparison = health.budgetComparison;
            const metrics = health.metrics;

            const healthColor = health.status === 'excellent' ? 'emerald' : 
                               health.status === 'bon' ? 'blue' :
                               health.status === 'moyen' ? 'amber' : 'red';

            UI.modal('Tableau de Bord Financier', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <!-- Health Score -->
                    <div class="p-6 rounded-2xl bg-gradient-to-r from-${healthColor}-50 to-${healthColor}-100 border border-${healthColor}-200">
                        <div class="text-center">
                            <div class="text-5xl font-black text-${healthColor}-900 mb-2">${health.healthScore}%</div>
                            <div class="font-black text-${healthColor}-900">Sant� Financi��re: ${health.status.toUpperCase()}</div>
                            <div class="text-xs text-${healthColor}-700 mt-1">
                                ${health.status === 'excellent' ? '��ŸŽ� Excellent �tat financier' :
                                  health.status === 'bon' ? '���?? �tat financier satisfaisant' :
                                  health.status === 'moyen' ? '��š ��� � � �tat financier �� surveiller' :
                                  '��Ÿš � �tat financier critique'}
                            </div>
                        </div>
                    </div>

                    <!-- Revenue vs Costs -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-200">
                            <div class="text-[10px] font-black text-emerald-700 uppercase">Revenu Total</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${metrics.totalRevenue.toFixed(0)}</div>
                            <div class="text-xs text-emerald-600 mt-1">${metrics.ordersCount} commandes</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-red-50 border border-red-200">
                            <div class="text-[10px] font-black text-red-700 uppercase">Co��ts Totaux</div>
                            <div class="text-2xl font-black text-red-900 mt-1">${metrics.totalCosts.toFixed(0)}</div>
                            <div class="text-xs text-red-600 mt-1">Tous types confondus</div>
                        </div>
                    </div>

                    <!-- Profitability Metrics -->
                    <div class="grid grid-cols-3 gap-3">
                        <div class="p-3 rounded-2xl bg-blue-50 border border-blue-200 text-center">
                            <div class="text-[10px] font-black text-blue-700">B�n�fice Brut</div>
                            <div class="text-xl font-black text-blue-900 mt-1">${metrics.grossProfit.toFixed(0)}</div>
                        </div>
                        <div class="p-3 rounded-2xl bg-indigo-50 border border-indigo-200 text-center">
                            <div class="text-[10px] font-black text-indigo-700">B�n�fice Net</div>
                            <div class="text-xl font-black text-indigo-900 mt-1">${metrics.netProfit.toFixed(0)}</div>
                        </div>
                        <div class="p-3 rounded-2xl bg-purple-50 border border-purple-200 text-center">
                            <div class="text-[10px] font-black text-purple-700">ROI</div>
                            <div class="text-xl font-black text-purple-900 mt-1">${metrics.roi}%</div>
                        </div>
                    </div>

                    <!-- Profit Margin -->
                    <div class="p-4 rounded-2xl bg-cyan-50 border border-cyan-200">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-black text-cyan-900">Marge B�n�ficiaire</div>
                            <div class="text-2xl font-black text-cyan-900">${metrics.profitMargin}%</div>
                        </div>
                        <div class="w-full h-3 bg-cyan-300 rounded-full overflow-hidden">
                            <div class="h-full bg-cyan-700" data-width="${Math.min(metrics.profitMargin, 100)}"></div>
                        </div>
                        <div class="text-[10px] text-cyan-700 mt-2">Cible: 30%</div>
                    </div>

                    <!-- Cost Breakdown -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-3">��Ÿ?Š R�partition des Co��ts</div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-red-600"></div>
                                    <span class="text-sm text-slate-700">Co��t des Produits</span>
                                </div>
                                <span class="font-black text-slate-900">${metrics.productCosts.toFixed(0)} XAF (${((metrics.productCosts / metrics.totalCosts) * 100).toFixed(1)}%)</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-orange-600"></div>
                                    <span class="text-sm text-slate-700">Co��t de Livraison</span>
                                </div>
                                <span class="font-black text-slate-900">${metrics.deliveryCosts.toFixed(0)} XAF (${((metrics.deliveryCosts / metrics.totalCosts) * 100).toFixed(1)}%)</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-amber-600"></div>
                                    <span class="text-sm text-slate-700">D�penses Op�rationnelles</span>
                                </div>
                                <span class="font-black text-slate-900">${metrics.operatingExpenses.toFixed(0)} XAF (${((metrics.operatingExpenses / metrics.totalCosts) * 100).toFixed(1)}%)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Budget vs Reality -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-3">��Ÿ? � Budget vs R�alit�</div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-slate-700">Budget Total</span>
                                <span class="font-black text-slate-900">${budgetComparison.totalBudgeted.toFixed(0)} XAF</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-slate-700">D�penses R�elles</span>
                                <span class="font-black text-slate-900">${budgetComparison.totalSpent.toFixed(0)} XAF</span>
                            </div>
                            <div class="h-px bg-slate-300"></div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-black text-slate-900">% d'Utilisation</span>
                                <span class="font-black text-slate-900">${budgetComparison.overallPercentage}%</span>
                            </div>
                            <div class="w-full h-3 bg-slate-300 rounded-full overflow-hidden">
                                <div class="h-full bg-slate-900" data-width="${Math.min(budgetComparison.overallPercentage, 100)}"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Key Indicators -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-3">��Ÿ?�? Indicateurs Cl�s</div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="p-2 rounded-lg bg-white border border-slate-200">
                                <div class="text-slate-600">Panier Moyen</div>
                                <div class="font-black text-slate-900">${(metrics.totalRevenue / Math.max(metrics.ordersCount, 1)).toFixed(0)} XAF</div>
                            </div>
                            <div class="p-2 rounded-lg bg-white border border-slate-200">
                                <div class="text-slate-600">Co��t/Revenu</div>
                                <div class="font-black text-slate-900">${((metrics.totalCosts / metrics.totalRevenue) * 100).toFixed(1)}%</div>
                            </div>
                            <div class="p-2 rounded-lg bg-white border border-slate-200">
                                <div class="text-slate-600">Livraisons</div>
                                <div class="font-black text-slate-900">${metrics.deliveriesCount}</div>
                            </div>
                            <div class="p-2 rounded-lg bg-white border border-slate-200">
                                <div class="text-slate-600">Co��t/Livraison</div>
                                <div class="font-black text-slate-900">${(metrics.deliveryCosts / Math.max(metrics.deliveriesCount, 1)).toFixed(0)} XAF</div>
                            </div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'G�rer Budgets', onclick: 'UI.closeModal(); PDGModule.showBudgetManagementModal();' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showProfitabilityAnalysisModal() {
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const startOfLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const endOfLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);

            const currentMetrics = CORE.calculateFinancialMetrics(startOfMonth.toISOString(), endOfMonth.toISOString());
            const lastMetrics = CORE.calculateFinancialMetrics(startOfLastMonth.toISOString(), endOfLastMonth.toISOString());

            // Calculate trends
            const revenueTrend = lastMetrics.totalRevenue > 0 ? 
                (((currentMetrics.totalRevenue - lastMetrics.totalRevenue) / lastMetrics.totalRevenue) * 100).toFixed(1) : 0;
            const profitTrend = lastMetrics.netProfit > 0 ? 
                (((currentMetrics.netProfit - lastMetrics.netProfit) / lastMetrics.netProfit) * 100).toFixed(1) : 0;
            const marginTrend = (currentMetrics.profitMargin - lastMetrics.profitMargin).toFixed(1);

            UI.modal('Analyse de Rentabilit�', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <!-- Comparison Cards -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 rounded-2xl bg-gradient-to-br from-emerald-50 to-emerald-100 border border-emerald-200">
                            <div class="text-[10px] font-black text-emerald-700 uppercase mb-1">Revenu Ce Mois</div>
                            <div class="text-2xl font-black text-emerald-900">${currentMetrics.totalRevenue.toFixed(0)}</div>
                            <div class="text-xs text-emerald-700 mt-2">
                                <span class="font-black">${revenueTrend > 0 ? '���?' : '���?'} ${Math.abs(revenueTrend)}%</span> vs mois dernier
                            </div>
                        </div>
                        <div class="p-4 rounded-2xl bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200">
                            <div class="text-[10px] font-black text-blue-700 uppercase mb-1">B�n�fice Net Ce Mois</div>
                            <div class="text-2xl font-black text-blue-900">${currentMetrics.netProfit.toFixed(0)}</div>
                            <div class="text-xs text-blue-700 mt-2">
                                <span class="font-black">${profitTrend > 0 ? '���?' : '���?'} ${Math.abs(profitTrend)}%</span> vs mois dernier
                            </div>
                        </div>
                    </div>

                    <!-- Margin Analysis -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-4">��Ÿ?Š Analyse des Marges</div>
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-slate-700">Marge Brute (Ce Mois)</span>
                                    <span class="font-black text-slate-900">${((currentMetrics.grossProfit / currentMetrics.totalRevenue) * 100).toFixed(1)}%</span>
                                </div>
                                <div class="w-full h-2 bg-slate-300 rounded-full overflow-hidden">
                                    <div class="h-full bg-emerald-600" data-width="${((currentMetrics.grossProfit / currentMetrics.totalRevenue) * 100).toFixed(1)}"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-slate-700">Marge Nette (Ce Mois)</span>
                                    <span class="font-black text-slate-900">${currentMetrics.profitMargin}%</span>
                                </div>
                                <div class="w-full h-2 bg-slate-300 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-600" data-width="${currentMetrics.profitMargin}"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-slate-700">�volution Marge (vs mois dernier)</span>
                                    <span class="font-black text-slate-900">${marginTrend > 0 ? '+' : ''}${marginTrend}%</span>
                                </div>
                                <div class="text-xs text-slate-600">Marge actuelle: ${currentMetrics.profitMargin}% | Mois dernier: ${lastMetrics.profitMargin}%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Breakdown -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-3 rounded-2xl bg-red-50 border border-red-200">
                            <div class="text-[10px] font-black text-red-700 uppercase">Co��t Produits</div>
                            <div class="text-lg font-black text-red-900 mt-1">${currentMetrics.productCosts.toFixed(0)}</div>
                            <div class="text-[10px] text-red-600 mt-1">${((currentMetrics.productCosts / currentMetrics.totalRevenue) * 100).toFixed(1)}% du revenu</div>
                        </div>
                        <div class="p-3 rounded-2xl bg-orange-50 border border-orange-200">
                            <div class="text-[10px] font-black text-orange-700 uppercase">Co��t Livraison</div>
                            <div class="text-lg font-black text-orange-900 mt-1">${currentMetrics.deliveryCosts.toFixed(0)}</div>
                            <div class="text-[10px] text-orange-600 mt-1">${((currentMetrics.deliveryCosts / currentMetrics.totalRevenue) * 100).toFixed(1)}% du revenu</div>
                        </div>
                        <div class="p-3 rounded-2xl bg-amber-50 border border-amber-200">
                            <div class="text-[10px] font-black text-amber-700 uppercase">D�penses Op�rationnelles</div>
                            <div class="text-lg font-black text-amber-900 mt-1">${currentMetrics.operatingExpenses.toFixed(0)}</div>
                            <div class="text-[10px] text-amber-600 mt-1">${((currentMetrics.operatingExpenses / currentMetrics.totalRevenue) * 100).toFixed(1)}% du revenu</div>
                        </div>
                        <div class="p-3 rounded-2xl bg-purple-50 border border-purple-200">
                            <div class="text-[10px] font-black text-purple-700 uppercase">ROI</div>
                            <div class="text-lg font-black text-purple-900 mt-1">${currentMetrics.roi}%</div>
                            <div class="text-[10px] text-purple-600 mt-1">Retour sur investissement</div>
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div class="p-4 rounded-2xl border border-indigo-200 bg-indigo-50">
                        <div class="font-black text-indigo-900 mb-3">��Ÿ? � Recommandations</div>
                        <div class="space-y-2 text-sm text-indigo-800">
                            ${currentMetrics.productCosts / currentMetrics.totalRevenue > 0.6 ? 
                                '<div>��ŸŽ � R�duire le co��t des produits (actuellement > 60% du revenu)</div>' : ''}
                            ${currentMetrics.deliveryCosts / currentMetrics.totalRevenue > 0.2 ? 
                                '<div>��Ÿšš Optimiser les co��ts de livraison (actuellement > 20% du revenu)</div>' : ''}
                            ${currentMetrics.profitMargin < 20 ? 
                                '<div>��Ÿ?�? Augmenter les prix ou r�duire les co��ts (marge < 20%)</div>' : ''}
                            ${currentMetrics.profitMargin > 30 ? 
                                '<div>���?� Excellent ! Marge b�n�ficiaire sup�rieure �� 30%</div>' : ''}
                            ${revenueTrend < -10 ? 
                                '<div>��š ��� � � Attention: Revenu en baisse par rapport au mois dernier</div>' : ''}
                            ${profitTrend < -15 ? 
                                '<div>��Ÿš � Pr�occupation: B�n�fice net en baisse importante</div>' : ''}
                        </div>
                    </div>

                    <!-- Comparison Table -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-3">��Ÿ?� Comparaison Mensuelle</div>
                        <table class="w-full text-xs">
                            <thead>
                                <tr class="border-b border-slate-300">
                                    <th class="text-left py-2 font-black text-slate-700">M�trique</th>
                                    <th class="text-right py-2 font-black text-slate-700">Ce Mois</th>
                                    <th class="text-right py-2 font-black text-slate-700">Mois Dernier</th>
                                    <th class="text-right py-2 font-black text-slate-700">Variation</th>
                                </tr>
                            </thead>
                            <tbody class="space-y-2">
                                <tr class="border-b border-slate-200">
                                    <td class="py-2 text-slate-700">Revenu Total</td>
                                    <td class="text-right font-black text-slate-900">${currentMetrics.totalRevenue.toFixed(0)}</td>
                                    <td class="text-right font-black text-slate-900">${lastMetrics.totalRevenue.toFixed(0)}</td>
                                    <td class="text-right font-black ${revenueTrend > 0 ? 'text-emerald-600' : 'text-red-600'}">${revenueTrend > 0 ? '+' : ''}${revenueTrend}%</td>
                                </tr>
                                <tr class="border-b border-slate-200">
                                    <td class="py-2 text-slate-700">Co��ts Totaux</td>
                                    <td class="text-right font-black text-slate-900">${currentMetrics.totalCosts.toFixed(0)}</td>
                                    <td class="text-right font-black text-slate-900">${lastMetrics.totalCosts.toFixed(0)}</td>
                                    <td class="text-right font-black text-slate-900">${((((currentMetrics.totalCosts - lastMetrics.totalCosts) / lastMetrics.totalCosts) * 100).toFixed(1))}%</td>
                                </tr>
                                <tr class="border-b border-slate-200">
                                    <td class="py-2 text-slate-700">B�n�fice Net</td>
                                    <td class="text-right font-black text-slate-900">${currentMetrics.netProfit.toFixed(0)}</td>
                                    <td class="text-right font-black text-slate-900">${lastMetrics.netProfit.toFixed(0)}</td>
                                    <td class="text-right font-black ${profitTrend > 0 ? 'text-emerald-600' : 'text-red-600'}">${profitTrend > 0 ? '+' : ''}${profitTrend}%</td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-slate-700">Marge Nette</td>
                                    <td class="text-right font-black text-slate-900">${currentMetrics.profitMargin}%</td>
                                    <td class="text-right font-black text-slate-900">${lastMetrics.profitMargin}%</td>
                                    <td class="text-right font-black ${marginTrend > 0 ? 'text-emerald-600' : 'text-red-600'}">${marginTrend > 0 ? '+' : ''}${marginTrend}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `, [
                { label: 'Tableau de Bord', onclick: 'UI.closeModal(); PDGModule.showFinancialDashboardModal();' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showAdvancedSystemModal() {
            const config = CORE.getSystemConfig();
            const diagnostics = CORE.getDiagnostics();
            const backups = CORE.getBackups();
            const logs = CORE.getSystemLogs(50);

            UI.modal('Param��tres Syst��me Avanc�s', `
                <div class="space-y-4 max-h-[85vh] overflow-y-auto">
                    <!-- System Information -->
                    <div class="grid grid-cols-3 gap-3">
                        <div class="p-3 rounded-2xl bg-blue-50 border border-blue-200 text-center">
                            <div class="text-[10px] font-black text-blue-700 uppercase">Version</div>
                            <div class="text-lg font-black text-blue-900 mt-1">${config.appVersion}</div>
                        </div>
                        <div class="p-3 rounded-2xl bg-purple-50 border border-purple-200 text-center">
                            <div class="text-[10px] font-black text-purple-700 uppercase">BD Size</div>
                            <div class="text-lg font-black text-purple-900 mt-1">${diagnostics.databaseSize} MB</div>
                        </div>
                        <div class="p-3 rounded-2xl bg-emerald-50 border border-emerald-200 text-center">
                            <div class="text-[10px] font-black text-emerald-700 uppercase">Utilisateurs</div>
                            <div class="text-lg font-black text-emerald-900 mt-1">${diagnostics.activeUsers}/${diagnostics.totalUsers}</div>
                        </div>
                    </div>

                    <!-- Configuration -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-3">��š ?��� � � Configuration G�n�rale</div>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-2 hover:bg-white rounded-lg">
                                <span class="text-sm text-slate-700">Maintenance Mode</span>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" ${config.maintenanceMode ? 'checked' : ''} onchange="CORE.updateSystemConfig('maintenanceMode', this.checked); PDGModule.showAdvancedSystemModal();" class="w-4 h-4 rounded">
                                </label>
                            </div>
                            <div class="flex items-center justify-between p-2 hover:bg-white rounded-lg">
                                <span class="text-sm text-slate-700">Sauvegarde Automatique</span>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" ${config.backupAutomatic ? 'checked' : ''} onchange="CORE.updateSystemConfig('backupAutomatic', this.checked); PDGModule.showAdvancedSystemModal();" class="w-4 h-4 rounded">
                                </label>
                            </div>
                            <div class="flex items-center justify-between p-2 hover:bg-white rounded-lg">
                                <span class="text-sm text-slate-700">API Logs</span>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" ${config.enableApiLogs ? 'checked' : ''} onchange="CORE.updateSystemConfig('enableApiLogs', this.checked); PDGModule.showAdvancedSystemModal();" class="w-4 h-4 rounded">
                                </label>
                            </div>
                            <div class="flex items-center justify-between p-2 hover:bg-white rounded-lg">
                                <span class="text-sm text-slate-700">Deux Facteurs Auth</span>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" ${config.enableTwoFactor ? 'checked' : ''} onchange="CORE.updateSystemConfig('enableTwoFactor', this.checked); PDGModule.showAdvancedSystemModal();" class="w-4 h-4 rounded">
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Backups Management -->
                    <div class="p-4 rounded-2xl border border-emerald-200 bg-emerald-50">
                        <div class="font-black text-emerald-900 mb-3">��Ÿ? � Sauvegardes (${backups.length})</div>
                        <div class="space-y-3">
                            <button onclick="CORE.createBackup('Sauvegarde manuelle'); PDGModule.showAdvancedSystemModal();" class="w-full px-3 py-2 bg-emerald-600 text-white rounded-lg text-xs font-black hover:bg-emerald-700">
                                + Cr�er une sauvegarde
                            </button>
                            ${backups.length === 0 ? `
                                <div class="p-4 text-center text-slate-600 text-sm">Aucune sauvegarde</div>
                            ` : `
                                <div class="space-y-2 max-h-[200px] overflow-y-auto">
                                    ${backups.slice(0, 10).map(backup => `
                                        <div class="p-3 bg-white rounded-lg border border-emerald-100 flex items-center justify-between">
                                            <div>
                                                <div class="font-black text-sm text-slate-900">${backup.name}</div>
                                                <div class="text-xs text-slate-600">${new Date(backup.date).toLocaleString('fr-FR')} �� ?� � ${backup.size} MB</div>
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="if(confirm('Restaurer cette sauvegarde ?')) { const res = CORE.restoreBackup(${backup.id}); UI.toast(res.message, res.success ? 'success' : 'error'); PDGModule.showAdvancedSystemModal(); }" class="px-2 py-1 bg-blue-600 text-white text-xs rounded font-black hover:bg-blue-700">Restaurer</button>
                                                <button onclick="if(confirm('Supprimer cette sauvegarde ?')) { CORE.deleteBackup(${backup.id}); PDGModule.showAdvancedSystemModal(); }" class="px-2 py-1 bg-red-600 text-white text-xs rounded font-black hover:bg-red-700">Supprimer</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>

                    <!-- Diagnostics -->
                    <div class="p-4 rounded-2xl border border-blue-200 bg-blue-50">
                        <div class="font-black text-blue-900 mb-3">��Ÿ?Š Diagnostics</div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="p-2 bg-white rounded-lg">
                                <div class="text-blue-600">Commandes Total</div>
                                <div class="font-black text-blue-900">${diagnostics.totalOrders}</div>
                            </div>
                            <div class="p-2 bg-white rounded-lg">
                                <div class="text-blue-600">Livraisons</div>
                                <div class="font-black text-blue-900">${diagnostics.totalDeliveries}</div>
                            </div>
                            <div class="p-2 bg-white rounded-lg">
                                <div class="text-blue-600">Produits</div>
                                <div class="font-black text-blue-900">${diagnostics.totalProducts}</div>
                            </div>
                            <div class="p-2 bg-white rounded-lg">
                                <div class="text-blue-600">Logs Syst</div>
                                <div class="font-black text-blue-900">${diagnostics.logsCount}</div>
                            </div>
                        </div>
                    </div>

                    <!-- System Logs -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-3">��Ÿ?� Logs Syst��me (${logs.length})</div>
                        <div class="space-y-2 max-h-[300px] overflow-y-auto">
                            ${logs.length === 0 ? `
                                <div class="p-4 text-center text-slate-600 text-sm">Aucun log</div>
                            ` : `
                                ${logs.map(log => `
                                    <div class="p-2 rounded-lg border-l-4 ${
                                        log.level === 'critical' ? 'border-l-red-600 bg-red-50' :
                                        log.level === 'error' ? 'border-l-orange-600 bg-orange-50' :
                                        log.level === 'warning' ? 'border-l-amber-600 bg-amber-50' :
                                        'border-l-blue-600 bg-blue-50'
                                    }">
                                        <div class="flex items-start justify-between">
                                            <div class="flex-1">
                                                <div class="text-xs font-black text-slate-900">${log.message}</div>
                                                <div class="text-[10px] text-slate-600 mt-0.5">${new Date(log.timestamp).toLocaleString('fr-FR')}</div>
                                            </div>
                                            <span class="text-[10px] font-black px-2 py-0.5 rounded ${
                                                log.level === 'critical' ? 'bg-red-300 text-red-900' :
                                                log.level === 'error' ? 'bg-orange-300 text-orange-900' :
                                                log.level === 'warning' ? 'bg-amber-300 text-amber-900' :
                                                'bg-blue-300 text-blue-900'
                                            }">${log.level}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            `}
                        </div>
                    </div>

                    <!-- Maintenance Actions -->
                    <div class="p-4 rounded-2xl border border-purple-200 bg-purple-50">
                        <div class="font-black text-purple-900 mb-3">��Ÿ� � Maintenance</div>
                        <div class="space-y-2">
                            <button onclick="CORE.cleanupSystem(); UI.toast('Nettoyage syst��me ex�cut�', 'success'); PDGModule.showAdvancedSystemModal();" class="w-full px-3 py-2 bg-purple-600 text-white rounded-lg text-xs font-black hover:bg-purple-700">
                                ��Ÿ � � Nettoyer les donn�es anciennes
                            </button>
                            <button onclick="CORE.logSystemEvent('manual_check', 'V�rification syst��me manuelle', 'info'); const diag = CORE.getDiagnostics(); UI.toast('BD: ' + diag.databaseSize + 'MB | Logs: ' + diag.logsCount, 'success');" class="w-full px-3 py-2 bg-purple-600 text-white rounded-lg text-xs font-black hover:bg-purple-700">
                                ���?? V�rifier l'int�grit� syst��me
                            </button>
                            <button onclick="const data = CORE.exportSystemData(); console.log(data); UI.toast('Donn�es export�es (voir console)', 'success');" class="w-full px-3 py-2 bg-purple-600 text-white rounded-lg text-xs font-black hover:bg-purple-700">
                                �� ���� � � Exporter les donn�es
                            </button>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showSystemDashboardModal() {
            const diagnostics = CORE.getDiagnostics();
            const config = CORE.getSystemConfig();
            const logs = CORE.getSystemLogs(10);
            const backups = CORE.getBackups().slice(0, 5);
            
            // Calculate system health
            let healthScore = 100;
            if (diagnostics.databaseSize > 500) healthScore -= 10;
            if (diagnostics.logsCount > 5000) healthScore -= 10;
            if (logs.some(l => l.level === 'error' || l.level === 'critical')) healthScore -= 20;

            const healthStatus = healthScore >= 80 ? 'Excellent' : (healthScore >= 60 ? 'Bon' : '�?� surveiller');
            const healthColor = healthScore >= 80 ? 'emerald' : (healthScore >= 60 ? 'blue' : 'amber');

            UI.modal('Tableau de Bord Syst��me', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <!-- Health Score -->
                    <div class="p-6 rounded-2xl bg-gradient-to-r from-${healthColor}-50 to-${healthColor}-100 border border-${healthColor}-200 text-center">
                        <div class="text-4xl font-black text-${healthColor}-900 mb-2">${healthScore}%</div>
                        <div class="font-black text-${healthColor}-900">Sant� Syst��me: ${healthStatus}</div>
                    </div>

                    <!-- Key Metrics -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-200">
                            <div class="text-[10px] font-black text-emerald-700 uppercase">BD Taille</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${diagnostics.databaseSize}</div>
                            <div class="text-xs text-emerald-600 mt-1">MB</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-blue-50 border border-blue-200">
                            <div class="text-[10px] font-black text-blue-700 uppercase">Utilisateurs Actifs</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${diagnostics.activeUsers}</div>
                            <div class="text-xs text-blue-600 mt-1">sur ${diagnostics.totalUsers}</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-purple-50 border border-purple-200">
                            <div class="text-[10px] font-black text-purple-700 uppercase">Sauvegardes</div>
                            <div class="text-2xl font-black text-purple-900 mt-1">${diagnostics.backupsCount}</div>
                            <div class="text-xs text-purple-600 mt-1">cr��es</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-indigo-50 border border-indigo-200">
                            <div class="text-[10px] font-black text-indigo-700 uppercase">Logs Syst</div>
                            <div class="text-2xl font-black text-indigo-900 mt-1">${diagnostics.logsCount}</div>
                            <div class="text-xs text-indigo-600 mt-1">enregistrements</div>
                        </div>
                    </div>

                    <!-- Data Statistics -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-3">��Ÿ?�? Statistiques</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-700">Total Commandes</span>
                                <span class="font-black text-slate-900">${diagnostics.totalOrders}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-700">Total Livraisons</span>
                                <span class="font-black text-slate-900">${diagnostics.totalDeliveries}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-700">Total Produits</span>
                                <span class="font-black text-slate-900">${diagnostics.totalProducts}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-700">Logs d'Audit</span>
                                <span class="font-black text-slate-900">${diagnostics.auditLogsCount}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Events -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-3">��Ÿ�� Derniers �v�nements</div>
                        <div class="space-y-2 max-h-[200px] overflow-y-auto">
                            ${logs.length === 0 ? `
                                <div class="p-4 text-center text-slate-600 text-sm">Aucun �v�nement</div>
                            ` : `
                                ${logs.map(log => `
                                    <div class="text-xs p-2 rounded-lg border-l-2 ${
                                        log.level === 'error' ? 'border-l-red-600 bg-red-50' :
                                        log.level === 'warning' ? 'border-l-amber-600 bg-amber-50' :
                                        'border-l-blue-600 bg-blue-50'
                                    }">
                                        <div class="font-black text-slate-900">${log.message}</div>
                                        <div class="text-[10px] text-slate-600">${new Date(log.timestamp).toLocaleTimeString('fr-FR')}</div>
                                    </div>
                                `).join('')}
                            `}
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <button onclick="UI.closeModal(); PDGModule.showAdvancedSystemModal();" class="w-full px-3 py-2 bg-slate-900 text-white rounded-lg text-xs font-black hover:bg-slate-800">
                            ��š ?��� � � Param��tres Avanc�s
                        </button>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showSuspensionManagementModal() {
            const suspendedUsers = CORE.getSuspendedUsers();
            const activeSuspensions = CORE.getActiveSuspensions();

            let content = '<div class="space-y-4 max-h-[80vh] overflow-y-auto">';
            content += '<div class="grid grid-cols-3 gap-3">';
            content += '<div class="p-3 rounded-2xl bg-orange-50 border border-orange-200 text-center">';
            content += '<div class="text-[10px] font-black text-orange-700 uppercase">Suspensions Actives</div>';
            content += '<div class="text-2xl font-black text-orange-900 mt-1">' + activeSuspensions.length + '</div>';
            content += '</div>';
            content += '<div class="p-3 rounded-2xl bg-red-50 border border-red-200 text-center">';
            content += '<div class="text-[10px] font-black text-red-700 uppercase">Utilisateurs Suspendus</div>';
            content += '<div class="text-2xl font-black text-red-900 mt-1">' + suspendedUsers.length + '</div>';
            content += '</div>';
            content += '<div class="p-3 rounded-2xl bg-purple-50 border border-purple-200 text-center">';
            content += '<div class="text-[10px] font-black text-purple-700 uppercase">Utilisateurs Totaux</div>';
            content += '<div class="text-2xl font-black text-purple-900 mt-1">' + CORE.db.users.length + '</div>';
            content += '</div>';
            content += '</div>';
            content += '</div>';

            UI.modal('Gestion des Suspensions', content, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showSuspensionHistoryModal() {
            const history = CORE.getSuspensionHistory(null, 100);
            UI.modal('Historique Global des Suspensions', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="font-black text-blue-900 mb-2">��Ÿ?� Historique Complet</div>
                        <div class="text-xs text-blue-700">${history.length} �v�nements enregistr�s</div>
                    </div>

                    ${history.length === 0 ? `
                        <div class="p-8 text-center rounded-2xl border-2 border-dashed border-slate-200 bg-slate-50">
                            <div class="text-2xl mb-2">��Ÿ?�</div>
                            <div class="font-black text-slate-600">Aucun historique</div>
                            <div class="text-xs text-slate-500 mt-1">Aucune suspension enregistr�e</div>
                        </div>
                    ` : `
                        <div class="space-y-2">
                            ${history.map(entry => {
                                const isSuspended = entry.action === 'suspended';
                                return `
                                    <div class="p-3 rounded-lg border-l-4 ${
                                        isSuspended ? 'border-l-orange-600 bg-orange-50 border border-orange-200' :
                                        'border-l-emerald-600 bg-emerald-50 border border-emerald-200'
                                    }">
                                        <div class="flex items-start justify-between mb-1">
                                            <div>
                                                <div class="text-sm font-black text-slate-900">
                                                    ${isSuspended ? '��Ÿ�?' : '���??'} ${entry.suspension?.userName || 'Utilisateur'}
                                                </div>
                                                <div class="text-xs text-slate-600 mt-0.5">
                                                    ${isSuspended ? 'Suspendu' : 'R�activ�'} le ${new Date(entry.timestamp).toLocaleDateString('fr-FR')} �� ${new Date(entry.timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}
                                                </div>
                                            </div>
                                            <span class="text-[10px] font-black px-2 py-1 rounded-full ${
                                                isSuspended ? 'bg-orange-300 text-orange-900' : 'bg-emerald-300 text-emerald-900'
                                            }">${isSuspended ? 'SUSPENSION' : 'R�ACTIVATION'}</span>
                                        </div>
                                        <div class="text-xs text-slate-600 mt-1">
                                            <strong>Par:</strong> ${entry.performedByName || 'Syst��me'}
                                        </div>
                                        ${isSuspended && entry.suspension?.reason ? `
                                            <div class="text-xs text-slate-700 mt-1 p-2 bg-white rounded border border-slate-200">
                                                <strong>Raison:</strong> ${entry.suspension.reason}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `, [
                { label: 'Gestion Suspensions', onclick: 'UI.closeModal(); PDGModule.showSuspensionManagementModal();' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showUserSuspensionHistoryModal(userId) {
            const user = CORE.getUser(userId);
            const userHistory = CORE.getSuspensionHistory(userId, 50);

            UI.modal(`Historique de Suspension - ${user?.name}`, `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <div class="text-[10px] font-black text-slate-600 uppercase">Nom</div>
                                <div class="font-black text-slate-900">${user?.name}</div>
                            </div>
                            <div>
                                <div class="text-[10px] font-black text-slate-600 uppercase">Identifiant</div>
                                <div class="font-black text-slate-900">${user?.username}</div>
                            </div>
                            <div>
                                <div class="text-[10px] font-black text-slate-600 uppercase">R��le</div>
                                <div class="font-black text-slate-900">${user?.role}</div>
                            </div>
                            <div>
                                <div class="text-[10px] font-black text-slate-600 uppercase">Statut</div>
                                <div class="font-black ${user?.suspended ? 'text-red-900' : 'text-emerald-900'}">
                                    ${user?.suspended ? '��Ÿ�? Suspendu' : '���?? Actif'}
                                </div>
                            </div>
                        </div>
                    </div>

                    ${userHistory.length === 0 ? `
                        <div class="p-8 text-center rounded-2xl border-2 border-dashed border-slate-200 bg-slate-50">
                            <div class="text-2xl mb-2">���??</div>
                            <div class="font-black text-slate-600">Aucun historique</div>
                            <div class="text-xs text-slate-500 mt-1">Cet utilisateur n'a pas d'historique de suspension</div>
                        </div>
                    ` : `
                        <div class="space-y-3">
                            <div class="text-xs font-black text-slate-600 uppercase">�v�nements (${userHistory.length})</div>
                            ${userHistory.map(entry => {
                                const isSuspended = entry.action === 'suspended';
                                return `
                                    <div class="p-3 rounded-2xl border-l-4 ${
                                        isSuspended ? 'border-l-orange-600 bg-orange-50 border border-orange-200' :
                                        'border-l-emerald-600 bg-emerald-50 border border-emerald-200'
                                    }">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="font-black text-slate-900">
                                                ${isSuspended ? '��Ÿ�? Suspension' : '���?? R�activation'}
                                            </div>
                                            <span class="text-[10px] font-black px-2 py-1 rounded-full ${
                                                isSuspended ? 'bg-orange-300 text-orange-900' : 'bg-emerald-300 text-emerald-900'
                                            }">${new Date(entry.timestamp).toLocaleDateString('fr-FR')}</span>
                                        </div>
                                        <div class="text-xs text-slate-600 space-y-1">
                                            <div>
                                                <strong>Heure:</strong> ${new Date(entry.timestamp).toLocaleTimeString('fr-FR')}
                                            </div>
                                            <div>
                                                <strong>Par:</strong> ${entry.performedByName || 'Syst��me'}
                                            </div>
                                            ${isSuspended && entry.suspension?.reason ? `
                                                <div class="mt-2 p-2 bg-white rounded border border-slate-200">
                                                    <strong>Raison:</strong> ${entry.suspension.reason}
                                                </div>
                                            ` : ''}
                                            ${isSuspended && entry.suspension?.duration ? `
                                                <div>
                                                    <strong>Dur�e:</strong> ${entry.suspension.duration} jours
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `, [
                { label: 'Retour', onclick: 'UI.closeModal(); PDGModule.showSuspensionManagementModal();' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showSuspendUserModal(userId) {
            const user = CORE.getUser(userId);
            if (!user) {
                UI.toast('Utilisateur non trouv�', 'error');
                return;
            }

            let selectedDuration = 7;
            let customDuration = '';

            UI.modal(`Suspendre l'Utilisateur - ${user.name}`, `
                <div class="space-y-4">
                    <!-- Informations utilisateur -->
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <div class="text-[10px] font-black text-slate-600 uppercase">Nom</div>
                                <div class="font-black text-slate-900">${user.name}</div>
                            </div>
                            <div>
                                <div class="text-[10px] font-black text-slate-600 uppercase">Identifiant</div>
                                <div class="font-black text-slate-900">${user.username}</div>
                            </div>
                            <div>
                                <div class="text-[10px] font-black text-slate-600 uppercase">R��le</div>
                                <div class="font-black text-slate-900">${user.role}</div>
                            </div>
                            <div>
                                <div class="text-[10px] font-black text-slate-600 uppercase">Email</div>
                                <div class="font-black text-slate-900">${user.email || '-'}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Avertissement -->
                    <div class="p-4 bg-orange-50 border-2 border-orange-300 rounded-2xl flex gap-3">
                        <div class="text-orange-600 text-xl flex-shrink-0">��š ��� � �</div>
                        <div>
                            <div class="font-black text-orange-900">Suspension temporaire</div>
                            <div class="text-xs text-orange-700 mt-1">
                                L'utilisateur sera suspendu et ne pourra pas acc�der �� son compte pendant la dur�e sp�cifi�e. 
                                Il peut ��tre r�activ� �� tout moment.
                            </div>
                        </div>
                    </div>

                    <!-- Raison de suspension -->
                    <div>
                        <label class="block text-xs font-black text-slate-700 mb-2">
                            ��Ÿ?� Raison de la suspension <span class="text-red-600">*</span>
                        </label>
                        <textarea 
                            id="suspensionReason"
                            placeholder="Entrez la raison de la suspension..."
                            class="w-full p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                            rows="3"
                        ></textarea>
                    </div>

                    <!-- Dur�e de suspension -->
                    <div>
                        <label class="block text-xs font-black text-slate-700 mb-2">
                            �� � ��� � � Dur�e de suspension
                        </label>
                        <div class="space-y-3">
                            <!-- Options pr�d�finies -->
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="
                                    document.getElementById('customDurationDiv').style.display = 'none';
                                    document.getElementById('suspensionDurationSelect').value = '1';
                                    Array.from(document.querySelectorAll('.duration-btn')).forEach(btn => btn.classList.remove('ring-2', 'ring-orange-500'));
                                    event.target.closest('button').classList.add('ring-2', 'ring-orange-500');
                                " class="duration-btn p-3 rounded-xl border-2 border-slate-200 hover:border-slate-300 font-black text-sm transition">
                                    1 jour
                                </button>
                                <button onclick="
                                    document.getElementById('customDurationDiv').style.display = 'none';
                                    document.getElementById('suspensionDurationSelect').value = '3';
                                    Array.from(document.querySelectorAll('.duration-btn')).forEach(btn => btn.classList.remove('ring-2', 'ring-orange-500'));
                                    event.target.closest('button').classList.add('ring-2', 'ring-orange-500');
                                " class="duration-btn p-3 rounded-xl border-2 border-slate-200 hover:border-slate-300 font-black text-sm transition">
                                    3 jours
                                </button>
                                <button onclick="
                                    document.getElementById('customDurationDiv').style.display = 'none';
                                    document.getElementById('suspensionDurationSelect').value = '7';
                                    Array.from(document.querySelectorAll('.duration-btn')).forEach(btn => btn.classList.remove('ring-2', 'ring-orange-500'));
                                    event.target.closest('button').classList.add('ring-2', 'ring-orange-500');
                                " class="duration-btn p-3 rounded-xl border-2 border-slate-200 hover:border-slate-300 font-black text-sm transition ring-2 ring-orange-500">
                                    7 jours
                                </button>
                                <button onclick="
                                    document.getElementById('customDurationDiv').style.display = 'none';
                                    document.getElementById('suspensionDurationSelect').value = '14';
                                    Array.from(document.querySelectorAll('.duration-btn')).forEach(btn => btn.classList.remove('ring-2', 'ring-orange-500'));
                                    event.target.closest('button').classList.add('ring-2', 'ring-orange-500');
                                " class="duration-btn p-3 rounded-xl border-2 border-slate-200 hover:border-slate-300 font-black text-sm transition">
                                    14 jours
                                </button>
                                <button onclick="
                                    document.getElementById('customDurationDiv').style.display = 'none';
                                    document.getElementById('suspensionDurationSelect').value = '30';
                                    Array.from(document.querySelectorAll('.duration-btn')).forEach(btn => btn.classList.remove('ring-2', 'ring-orange-500'));
                                    event.target.closest('button').classList.add('ring-2', 'ring-orange-500');
                                " class="duration-btn p-3 rounded-xl border-2 border-slate-200 hover:border-slate-300 font-black text-sm transition">
                                    30 jours
                                </button>
                                <button onclick="
                                    document.getElementById('customDurationDiv').style.display = 'block';
                                    Array.from(document.querySelectorAll('.duration-btn')).forEach(btn => btn.classList.remove('ring-2', 'ring-orange-500'));
                                    event.target.closest('button').classList.add('ring-2', 'ring-orange-500');
                                " class="duration-btn p-3 rounded-xl border-2 border-slate-200 hover:border-slate-300 font-black text-sm transition">
                                    Personnalis�
                                </button>
                            </div>

                            <!-- S�lecteur cach� -->
                            <select id="suspensionDurationSelect" style="display: none;">
                                <option value="1">1 jour</option>
                                <option value="3">3 jours</option>
                                <option value="7" selected>7 jours</option>
                                <option value="14">14 jours</option>
                                <option value="30">30 jours</option>
                            </select>

                            <!-- Entr�e personnalis�e -->
                            <div id="customDurationDiv" style="display: none;">
                                <div class="flex gap-2">
                                    <input 
                                        type="number" 
                                        id="customDurationInput"
                                        placeholder="Nombre de jours"
                                        class="flex-1 p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                        min="1"
                                        max="365"
                                    >
                                    <span class="flex items-center font-black text-slate-600">jours</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aper��u -->
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-2xl text-xs text-blue-800 font-black">
                        <div>��Ÿ?� Date de reprise pr�vue:</div>
                        <div id="expectedResumeDate" class="text-lg text-blue-900 mt-1">
                            ${new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString('fr-FR')}
                        </div>
                    </div>
                </div>
            `, [
                { 
                    label: 'Suspendre', 
                    onclick: 'PDGModule.confirmSuspendUser(' + userId + ')'
                },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        confirmSuspendUser(userId) {
            const reason = document.getElementById('suspensionReason').value.trim();
            if (!reason) {
                UI.toast('Veuillez entrer une raison de suspension', 'warning');
                return;
            }
            let duration = parseInt(document.getElementById('suspensionDurationSelect').value) || 7;
            if (document.getElementById('customDurationDiv').style.display !== 'none') {
                const customVal = parseInt(document.getElementById('customDurationInput').value);
                if (customVal && customVal > 0) {
                    duration = customVal;
                }
            }
            CORE.suspendUser(userId, reason, duration);
            UI.closeModal();
            UI.toast('���?? Utilisateur suspendu avec succ��s', 'success');
            setTimeout(() => PDGModule.showSuspensionManagementModal(), 500);
        },

        showImportExportModal() {
            UI.modal('Import/Export de Donn�es', `
                <div class="space-y-4">
                    <!-- Section Import -->
                    <div class="border border-blue-200 rounded-2xl overflow-hidden">
                        <div class="p-4 bg-blue-50 border-b border-blue-200 font-black text-blue-900 flex items-center gap-2">
                            <i data-lucide="upload" class="w-5 h-5"></i>
                            <span>Import de Donn�es</span>
                        </div>
                        <div class="p-4 space-y-3">
                            <button onclick="PDGModule.showImportUsersModal()" class="w-full p-3 rounded-2xl bg-blue-50 border border-blue-200 hover:bg-blue-100 transition flex items-center gap-3">
                                <i data-lucide="users" class="w-5 h-5 text-blue-600"></i>
                                <div class="text-left flex-1">
                                    <div class="text-xs font-black text-blue-700">Importer Utilisateurs (CSV)</div>
                                    <div class="text-[10px] text-blue-600">Ajouter des utilisateurs en masse</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-blue-400"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Section Export -->
                    <div class="border border-emerald-200 rounded-2xl overflow-hidden">
                        <div class="p-4 bg-emerald-50 border-b border-emerald-200 font-black text-emerald-900 flex items-center gap-2">
                            <i data-lucide="download" class="w-5 h-5"></i>
                            <span>Export de Donn�es</span>
                        </div>
                        <div class="p-4 space-y-3">
                            <button onclick="PDGModule.exportUserData()" class="w-full p-3 rounded-2xl bg-emerald-50 border border-emerald-200 hover:bg-emerald-100 transition flex items-center gap-3">
                                <i data-lucide="users" class="w-5 h-5 text-emerald-600"></i>
                                <div class="text-left flex-1">
                                    <div class="text-xs font-black text-emerald-700">Exporter Utilisateurs (CSV)</div>
                                    <div class="text-[10px] text-emerald-600">${CORE.db.users.length} utilisateur(s)</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-emerald-400"></i>
                            </button>
                            <button onclick="PDGModule.exportOrderData()" class="w-full p-3 rounded-2xl bg-emerald-50 border border-emerald-200 hover:bg-emerald-100 transition flex items-center gap-3">
                                <i data-lucide="shopping-cart" class="w-5 h-5 text-emerald-600"></i>
                                <div class="text-left flex-1">
                                    <div class="text-xs font-black text-emerald-700">Exporter Commandes (CSV)</div>
                                    <div class="text-[10px] text-emerald-600">${(CORE.db.orders || []).length} commande(s)</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-emerald-400"></i>
                            </button>
                            <button onclick="PDGModule.exportAuditData()" class="w-full p-3 rounded-2xl bg-emerald-50 border border-emerald-200 hover:bg-emerald-100 transition flex items-center gap-3">
                                <i data-lucide="shield-check" class="w-5 h-5 text-emerald-600"></i>
                                <div class="text-left flex-1">
                                    <div class="text-xs font-black text-emerald-700">Exporter Audit (CSV)</div>
                                    <div class="text-[10px] text-emerald-600">${(CORE.db.auditTrail || []).length} entr�e(s)</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-emerald-400"></i>
                            </button>
                            <button onclick="PDGModule.exportAllDataJSON()" class="w-full p-3 rounded-2xl bg-purple-50 border border-purple-200 hover:bg-purple-100 transition flex items-center gap-3">
                                <i data-lucide="package" class="w-5 h-5 text-purple-600"></i>
                                <div class="text-left flex-1">
                                    <div class="text-xs font-black text-purple-700">Exporter Compl��te (JSON)</div>
                                    <div class="text-[10px] text-purple-600">Sauvegarde compl��te de toutes les donn�es</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-purple-400"></i>
                            </button>
                            <button onclick="PDGModule.exportSaasMigrationJSON()" class="w-full p-3 rounded-2xl bg-indigo-50 border border-indigo-200 hover:bg-indigo-100 transition flex items-center gap-3">
                                <i data-lucide="cloud-upload" class="w-5 h-5 text-indigo-600"></i>
                                <div class="text-left flex-1">
                                    <div class="text-xs font-black text-indigo-700">Exporter Migration SaaS (JSON)</div>
                                    <div class="text-[10px] text-indigo-600">Format compatible import PostgreSQL</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-indigo-400"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Historique -->
                    <div class="border border-slate-200 rounded-2xl overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b border-slate-200 font-black text-slate-900 flex items-center gap-2">
                            <i data-lucide="history" class="w-5 h-5"></i>
                            <span>Historique Import/Export</span>
                        </div>
                        <div class="p-4">
                            <button onclick="PDGModule.showImportExportHistoryModal()" class="w-full p-3 rounded-2xl bg-slate-50 border border-slate-200 hover:bg-slate-100 transition flex items-center gap-3">
                                <i data-lucide="list" class="w-5 h-5 text-slate-600"></i>
                                <div class="text-left flex-1">
                                    <div class="text-xs font-black text-slate-700">Voir l'historique</div>
                                    <div class="text-[10px] text-slate-600">${(CORE.db.importExportHistory || []).length} op�ration(s)</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showImportUsersModal() {
            UI.modal('Importer Utilisateurs (CSV)', `
                <div class="space-y-4">
                    <!-- Instructions -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="font-black text-blue-900 mb-2">��Ÿ?� Format requis</div>
                        <div class="text-xs text-blue-700 space-y-1">
                            <div>Colonnes obligatoires: <strong>name, username, email, password, role</strong></div>
                            <div>R��les disponibles: <strong>pdg, manager, gestionnaire, vendeur, livreur</strong></div>
                            <div>Format: CSV (s�par� par des virgules)</div>
                        </div>
                    </div>

                    <!-- Exemple -->
                    <details class="p-4 bg-slate-50 border border-slate-200 rounded-2xl cursor-pointer">
                        <summary class="font-black text-slate-900">Exemple de format</summary>
                        <div class="mt-3 p-3 bg-white border border-slate-300 rounded text-xs font-mono text-slate-600 overflow-x-auto">
name,username,email,password,role,deliveryCenter
Jean Dupont,jdupont,jean@example.com,pass123,vendeur,
Marie Martin,mmartin,marie@example.com,pass456,gestionnaire,Centre-1
                        </div>
                    </details>

                    <!-- Zone de textarea -->
                    <div>
                        <label class="block text-xs font-black text-slate-700 mb-2">Donn�es CSV</label>
                        <textarea 
                            id="csvInput"
                            placeholder="Collez vos donn�es CSV ici..."
                            class="w-full p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            rows="8"
                        ></textarea>
                    </div>

                    <!-- R�sultat du test -->
                    <div id="dryRunResult"></div>
                </div>
            `, [
                { 
                    label: 'Test (Dry Run)', 
                    onclick: 'PDGModule.runDryRun()'
                },
                { 
                    label: 'Importer', 
                    onclick: 'PDGModule.runImport()'
                },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        runDryRun() {
            const csvInput = document.getElementById('csvInput').value.trim();
            if (!csvInput) {
                UI.toast('Veuillez entrer des donn�es CSV', 'warning');
                return;
            }
            
            const result = CORE.importUsersFromCSV(csvInput, true);
            const resultDiv = document.getElementById('dryRunResult');
            
            if (result.success) {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                        <div class="font-black text-emerald-900">���?? Test r�ussi</div>
                        <div class="text-xs text-emerald-700 mt-2">
                            <div>Lignes �� importer: ${result.successCount}</div>
                            <div>Vous pouvez proc�der �� l'import</div>
                        </div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-2xl">
                        <div class="font-black text-red-900">���?? Test �chou�</div>
                        <div class="text-xs text-red-700 mt-2">${result.message}</div>
                        <div class="mt-2 text-xs text-red-600">${result.errors?.slice(0, 3).join('<br>')}</div>
                    </div>
                `;
            }
        },

        runImport() {
            const csvInput = document.getElementById('csvInput').value.trim();
            if (!csvInput) {
                UI.toast('Veuillez entrer des donn�es CSV', 'warning');
                return;
            }

            if (!confirm('�?Štes-vous s��r ? Cette action importera les utilisateurs.')) return;
            
            const result = CORE.importUsersFromCSV(csvInput, false);
            UI.closeModal();
            
            if (result.success) {
                UI.toast(`���?? ${result.successCount} utilisateur(s) import�(s)`, 'success');
            } else {
                UI.toast(`��š � Import partiel: ${result.message}`, 'warning');
            }
            
            setTimeout(() => PDGModule.showImportExportModal(), 500);
        },

        exportUserData() {
            const csv = CORE.exportUsersToCSV();
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `users_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('���?? Utilisateurs export�s avec succ��s', 'success');
        },

        exportOrderData() {
            const csv = CORE.exportOrdersToCSV();
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `orders_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('���?? Commandes export�es avec succ��s', 'success');
        },

        exportAuditData() {
            const csv = CORE.exportAuditToCSV();
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `audit_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('���?? Audit export� avec succ��s', 'success');
        },

        exportAllDataJSON() {
            const json = CORE.exportDataAsJSON('all');
            const blob = new Blob([json], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `backup_complete_${new Date().getTime()}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('���?? Sauvegarde compl��te cr��e avec succ��s', 'success');
        },

        exportSaasMigrationJSON() {
            const json = CORE.exportSaasMigrationData();
            const blob = new Blob([json], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `saas_migration_${new Date().getTime()}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('���?? Export SaaS (JSON) g�n�r�', 'success');
        },

        showImportExportHistoryModal() {
            const history = CORE.getImportExportHistory(100);
            
            UI.modal('Historique Import/Export', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    ${history.length === 0 ? `
                        <div class="p-8 text-center rounded-2xl border-2 border-dashed border-slate-200 bg-slate-50">
                            <div class="text-2xl mb-2">��Ÿ??</div>
                            <div class="font-black text-slate-600">Aucun historique</div>
                            <div class="text-xs text-slate-500 mt-1">Aucune op�ration d'import/export enregistr�e</div>
                        </div>
                    ` : history.map(entry => {
                        const isImport = entry.type === 'import';
                        const isSuccess = entry.status === 'success';
                        const icon = isImport ? '��Ÿ? �' : '��Ÿ? �';
                        const label = isImport ? 'Import' : 'Export';
                        const borderClass = isImport ? 'border-l-blue-600 bg-blue-50 border border-blue-200' : 'border-l-emerald-600 bg-emerald-50 border border-emerald-200';
                        const statusClass = isSuccess ? 'bg-emerald-300 text-emerald-900' : 'bg-red-300 text-red-900';
                        const statusText = isSuccess ? '���?? Succ��s' : '���?? Erreur';
                        const date = new Date(entry.timestamp).toLocaleDateString('fr-FR');
                        const time = new Date(entry.timestamp).toLocaleTimeString('fr-FR');
                        
                        return `
                            <div class="p-4 rounded-2xl border-l-4 ${borderClass}">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg">${icon}</span>
                                        <div class="font-black text-slate-900">${label} - ${entry.entity}</div>
                                    </div>
                                    <span class="text-[10px] font-black px-2 py-1 rounded-full ${statusClass}">${statusText}</span>
                                </div>
                                <div class="text-xs text-slate-600 space-y-1">
                                    <div><strong>Date:</strong> ${date}</div>
                                    <div><strong>Heure:</strong> ${time}</div>
                                    <div><strong>Par:</strong> ${entry.performedByName || 'Syst��me'}</div>
                                    <div><strong>Fichier:</strong> ${entry.fileName}</div>
                                    <div><strong>Lignes:</strong> ${entry.rowsProcessed}</div>
                                    ${entry.details?.successCount ? `<div><strong>R�ussi:</strong> ${entry.details.successCount}</div>` : ''}
                                    ${entry.details?.errorCount ? `<div><strong>Erreurs:</strong> ${entry.details.errorCount}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        revokeAllManagerPermissions() {
            if (!confirm('�?Štes-vous s��r ? Cela r�duira les permissions du Manager.')) return;

            const managerRole = CORE.db.roles?.find(r => r.id === 'manager');
            if (!managerRole) return;

            const oldPerms = [...managerRole.permissions];
            managerRole.permissions = [];

            CORE.save();
            CORE.logAudit('update', 'role', 'manager', 'Manager',
                { action: 'Toutes les permissions r�voqu�es' },
                { permissions: oldPerms },
                { permissions: [] }
            );

            UI.toast('���?? Toutes les permissions du Manager ont �t� r�voqu�es', 'warning');
            PDGModule.showPermissionsManagerModal();
        },

        showSettingsModal() {
            const pendingApprovals = (CORE.db.userAdditionRequests || []).filter(r => r.status === 'pending').length;
            const alertsCount = (CORE.db.alertThresholds || []).filter(t => t.enabled).length;
            const unreadNotifs = CORE.getUnreadNotificationCount();
            
            UI.modal('��š ?��� � � Param��tres PDG', `
                <div class="space-y-4">
                    <!-- Header gradient -->
                    <div class="relative -mx-6 -mt-4 px-6 py-6 bg-gradient-to-br from-slate-800 via-slate-900 to-zinc-900 overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-amber-500/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
                        <div class="absolute bottom-0 left-0 w-24 h-24 bg-amber-400/5 rounded-full translate-y-1/2 -translate-x-1/2"></div>
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-amber-400 via-amber-500 to-amber-600"></div>
                        <div class="relative flex items-center gap-4">
                            <div class="w-14 h-14 bg-gradient-to-br from-amber-400 to-amber-600 rounded-2xl flex items-center justify-center shadow-xl shadow-amber-500/30">
                                <i data-lucide="crown" class="w-7 h-7 text-slate-900"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-black text-white">Centre de Contr��le <span class="text-amber-400">PDG</span></h2>
                                <p class="text-slate-400 text-sm">Configuration compl��te du syst��me</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabs de navigation -->
                    <div class="flex flex-wrap border-b border-slate-200 -mx-6 px-4 gap-1">
                        <button onclick="PDGModule.switchSettingsTab('general')" id="pdg-tab-general" class="flex-1 min-w-[80px] px-3 py-3 text-xs font-bold text-amber-700 border-b-2 border-amber-500 bg-amber-50/50 flex items-center justify-center gap-1.5 rounded-t-lg">
                            <i data-lucide="sliders" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">G�n�ral</span>
                        </button>
                        <button onclick="PDGModule.switchSettingsTab('users')" id="pdg-tab-users" class="flex-1 min-w-[80px] px-3 py-3 text-xs font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 flex items-center justify-center gap-1.5 transition rounded-t-lg">
                            <i data-lucide="users" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">Utilisateurs</span>
                            ${pendingApprovals > 0 ? '<span class="w-5 h-5 bg-amber-500 text-white text-[10px] font-black rounded-full flex items-center justify-center">' + pendingApprovals + '</span>' : ''}
                        </button>
                        <button onclick="PDGModule.switchSettingsTab('finance')" id="pdg-tab-finance" class="flex-1 min-w-[80px] px-3 py-3 text-xs font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 flex items-center justify-center gap-1.5 transition rounded-t-lg">
                            <i data-lucide="wallet" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">Finances</span>
                        </button>
                        <button onclick="PDGModule.switchSettingsTab('system')" id="pdg-tab-system" class="flex-1 min-w-[80px] px-3 py-3 text-xs font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 flex items-center justify-center gap-1.5 transition rounded-t-lg">
                            <i data-lucide="cpu" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">Syst��me</span>
                        </button>
                        <button onclick="PDGModule.switchSettingsTab('security')" id="pdg-tab-security" class="flex-1 min-w-[80px] px-3 py-3 text-xs font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 flex items-center justify-center gap-1.5 transition rounded-t-lg">
                            <i data-lucide="shield" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">S�curit�</span>
                        </button>
                    </div>
                    
                    <!-- Contenu des tabs -->
                    <div class="max-h-[55vh] overflow-y-auto pr-1">
                        
                        <!-- Tab: G�n�ral -->
                        <div id="pdg-content-general" class="space-y-5">
                            <!-- Identit� Entreprise -->
                            <div>
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-11 h-11 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg shadow-amber-300 ring-2 ring-amber-400/30">
                                        <i data-lucide="building-2" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-black text-slate-800">Identit� Entreprise</h3>
                                        <p class="text-xs text-slate-500">Nom affich� partout dans l'application</p>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-600 mb-2">Nom de l'entreprise</label>
                                        <div class="flex gap-2">
                                            <input type="text" id="pdg_company_name" value="${CORE.getCompanyName()}" 
                                                placeholder="Ex: Ma Boutique, RAYA Store..." 
                                                class="flex-1 px-4 py-3 border-2 border-amber-200 rounded-xl text-lg font-black text-slate-800 focus:ring-2 focus:ring-amber-300 focus:border-amber-400 transition">
                                            <button onclick="PDGModule.saveCompanyName()" class="px-4 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-black rounded-xl hover:shadow-lg hover:shadow-amber-200 transition flex items-center gap-2">
                                                <i data-lucide="save" class="w-4 h-4"></i>
                                                Enregistrer
                                            </button>
                                        </div>
                                        <div class="text-[10px] text-slate-400 mt-1">Ce nom appara��tra sur les tickets, factures, et dans toute l'interface</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Th��me -->
                            <div>
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-11 h-11 bg-gradient-to-br from-slate-700 to-slate-900 rounded-xl flex items-center justify-center shadow-lg shadow-slate-300 ring-2 ring-amber-400/30">
                                        <i data-lucide="palette" class="w-5 h-5 text-amber-400"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-black text-slate-800">Apparence</h3>
                                        <p class="text-xs text-slate-500">Personnalisez votre interface</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-3">
                                    <button onclick="PDGModule.setTheme('light')" class="group p-4 rounded-2xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${this.state.theme === 'light' ? 'border-amber-400 shadow-xl shadow-amber-100 scale-105' : 'border-slate-200 hover:border-slate-300 hover:shadow-lg'}">
                                        <div class="w-14 h-14 bg-gradient-to-br from-amber-400 to-orange-500 rounded-xl flex items-center justify-center text-2xl shadow-lg ${this.state.theme === 'light' ? 'ring-4 ring-amber-200' : ''}">���? ?��� � �</div>
                                        <div class="text-center">
                                            <div class="font-black text-sm text-slate-800">Clair</div>
                                            <div class="text-[10px] text-slate-500">Interface lumineuse</div>
                                        </div>
                                        ${this.state.theme === 'light' ? '<div class="w-6 h-6 bg-amber-500 rounded-full flex items-center justify-center"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>' : ''}
                                    </button>
                                    <button onclick="PDGModule.setTheme('dark')" class="group p-4 rounded-2xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${this.state.theme === 'dark' ? 'border-amber-400 shadow-xl shadow-amber-100 scale-105' : 'border-slate-200 hover:border-slate-300 hover:shadow-lg'}">
                                        <div class="w-14 h-14 bg-gradient-to-br from-slate-700 to-slate-900 rounded-xl flex items-center justify-center text-2xl shadow-lg ${this.state.theme === 'dark' ? 'ring-4 ring-amber-200' : ''}">��Ÿ�? ?�</div>
                                        <div class="text-center">
                                            <div class="font-black text-sm text-slate-800">Sombre</div>
                                            <div class="text-[10px] text-slate-500">Mode nuit</div>
                                        </div>
                                        ${this.state.theme === 'dark' ? '<div class="w-6 h-6 bg-amber-500 rounded-full flex items-center justify-center"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>' : ''}
                                    </button>
                                    <button onclick="PDGModule.setTheme('auto')" class="group p-4 rounded-2xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${this.state.theme === 'auto' ? 'border-amber-400 shadow-xl shadow-amber-100 scale-105' : 'border-slate-200 hover:border-slate-300 hover:shadow-lg'}">
                                        <div class="w-14 h-14 bg-gradient-to-br from-slate-600 to-zinc-800 rounded-xl flex items-center justify-center text-2xl shadow-lg ${this.state.theme === 'auto' ? 'ring-4 ring-amber-200' : ''}">��Ÿ�?</div>
                                        <div class="text-center">
                                            <div class="font-black text-sm text-slate-800">Auto</div>
                                            <div class="text-[10px] text-slate-500">Suit le syst��me</div>
                                        </div>
                                        ${this.state.theme === 'auto' ? '<div class="w-6 h-6 bg-amber-500 rounded-full flex items-center justify-center"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>' : ''}
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Langue -->
                            <div>
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-11 h-11 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl flex items-center justify-center shadow-lg shadow-blue-300 ring-2 ring-blue-400/30">
                                        <i data-lucide="globe" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-black text-slate-800">${t('settings.language')}</h3>
                                        <p class="text-xs text-slate-500">Interface multilingue</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-9 gap-2">
                                    ${[
                                        { code: 'fr', flag: '��Ÿ� ���Ÿ� �' },
                                        { code: 'en', flag: '��Ÿ� ���Ÿ� �' },
                                        { code: 'es', flag: '��Ÿ� ���Ÿ� �' },
                                        { code: 'pt', flag: '��Ÿ� ���Ÿ� �' },
                                        { code: 'de', flag: '��Ÿ� ���Ÿ� �' },
                                        { code: 'it', flag: '��Ÿ� ���Ÿ� �' },
                                        { code: 'ar', flag: '��Ÿ� ���Ÿ� �' },
                                        { code: 'zh', flag: '��Ÿ� ���Ÿ� �' },
                                        { code: 'ru', flag: '��Ÿ� ���Ÿ� �' }
                                    ].map(lang => `
                                        <button onclick="PDGModule.setLanguage('${lang.code}')" class="p-2 rounded-xl border-2 transition-all text-2xl hover:scale-110 ${(I18n.current || 'fr') === lang.code ? 'border-amber-500 bg-amber-50 shadow-lg scale-110 ring-2 ring-amber-300' : 'border-slate-200 hover:border-amber-300 bg-white'}">
                                            ${lang.flag}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Notifications -->
                            <div class="p-4 rounded-2xl bg-gradient-to-r from-slate-100 to-zinc-100 border border-slate-300">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-11 h-11 bg-gradient-to-br from-slate-700 to-slate-900 rounded-xl flex items-center justify-center shadow-lg">
                                            <i data-lucide="bell" class="w-5 h-5 text-amber-400"></i>
                                        </div>
                                        <div>
                                            <div class="font-black text-slate-800">Notifications Push</div>
                                            <div class="text-xs text-slate-500">Alertes en temps r�el</div>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" ${this.state.notificationsEnabled ? 'checked' : ''} onchange="PDGModule.toggleNotifications()" class="sr-only peer">
                                        <div class="w-14 h-7 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all after:shadow-md peer-checked:bg-amber-500"></div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Imprimante -->
                            <div class="p-4 rounded-2xl bg-gradient-to-r from-slate-50 to-slate-100 border border-slate-200">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-11 h-11 bg-gradient-to-br from-slate-600 to-slate-800 rounded-xl flex items-center justify-center shadow-lg">
                                            <i data-lucide="printer" class="w-5 h-5 text-white"></i>
                                        </div>
                                        <div>
                                            <div class="font-black text-slate-800">Imprimante</div>
                                            <div class="text-xs text-slate-500">Non connect�e</div>
                                        </div>
                                    </div>
                                    <button onclick="UI.toast('Recherche imprimante...', 'info')" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-xl text-xs font-black hover:bg-slate-300 transition">
                                        Configurer
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Version -->
                            <div class="p-4 rounded-2xl bg-gradient-to-r from-slate-800 to-zinc-900 text-white">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-11 h-11 bg-gradient-to-br from-amber-400 to-amber-600 rounded-xl flex items-center justify-center text-xl font-black text-slate-900 shadow-lg shadow-amber-500/30">${(CORE.getCompanyName() || 'R').charAt(0).toUpperCase()}</div>
                                        <div>
                                            <div class="font-black">${CORE.getCompanyName()} <span class="text-amber-400">OS</span></div>
                                            <div class="text-xs text-slate-400">Version ${CORE.config.version}</div>
                                        </div>
                                    </div>
                                    <span class="px-3 py-1 bg-amber-500/20 text-amber-400 rounded-full text-xs font-bold">�?� jour</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab: Utilisateurs -->
                        <div id="pdg-content-users" class="space-y-4 hidden">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-11 h-11 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-200">
                                    <i data-lucide="users" class="w-5 h-5 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-slate-800">Gestion des Utilisateurs</h3>
                                    <p class="text-xs text-slate-500">Contr��lez les acc��s et permissions</p>
                                </div>
                            </div>
                            
                            <button onclick="PDGModule.showUsersManagementModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="user-cog" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-blue-800">G�rer les Utilisateurs</div>
                                    <div class="text-xs text-blue-600">Modifier identifiants et mots de passe</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-blue-400"></i>
                            </button>
                            
                            <button onclick="PDGModule.showUserApprovalModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4 ${pendingApprovals > 0 ? 'ring-2 ring-amber-400 ring-offset-2' : ''}">
                                <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg relative">
                                    <i data-lucide="user-check" class="w-6 h-6 text-white"></i>
                                    ${pendingApprovals > 0 ? '<span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] font-black rounded-full flex items-center justify-center animate-pulse">' + pendingApprovals + '</span>' : ''}
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-amber-800">Approbation d'Utilisateurs</div>
                                    <div class="text-xs text-amber-600">${pendingApprovals > 0 ? pendingApprovals + ' demandes en attente' : 'Aucune demande en attente'}</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-amber-400"></i>
                            </button>
                            
                            <button onclick="PDGModule.showInviteEmployeeModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="user-plus" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-emerald-800">Inviter un Employ&eacute;</div>
                                    <div class="text-xs text-emerald-600">G&eacute;n&eacute;rer un code ou lien d'invitation</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-emerald-400"></i>
                            </button>

                            <button onclick="PDGModule.showRolesManagementModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-violet-50 to-purple-50 border border-violet-200 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="shield" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-violet-800">G�rer les R��les</div>
                                    <div class="text-xs text-violet-600">${(CORE.db.roles || []).length} r��les �� ?� � ${(CORE.db.roles || []).filter(r => r.isCustom).length} personnalis�s</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-violet-400"></i>
                            </button>
                            
                            <button onclick="PDGModule.showPermissionsManagerModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-indigo-50 to-blue-50 border border-indigo-200 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="lock" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-indigo-800">Permissions Manager</div>
                                    <div class="text-xs text-indigo-600">Modifier les permissions en temps r�el</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-indigo-400"></i>
                            </button>
                        </div>
                        
                        <!-- Tab: Finances -->
                        <div id="pdg-content-finance" class="space-y-4 hidden">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-11 h-11 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-200">
                                    <i data-lucide="wallet" class="w-5 h-5 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-slate-800">Finances & Budget</h3>
                                    <p class="text-xs text-slate-500">Vue consolid�e des finances</p>
                                </div>
                            </div>
                            
                            <button onclick="PDGModule.showFinancialDashboardModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="chart-line" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-emerald-800">Tableau de Bord Financier</div>
                                    <div class="text-xs text-emerald-600">Analytics et rapports financiers</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-emerald-400"></i>
                            </button>
                            
                            <button onclick="PDGModule.showProfitabilityAnalysisModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-teal-50 to-cyan-50 border border-teal-200 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="trending-up" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-teal-800">Analyse de Rentabilit�</div>
                                    <div class="text-xs text-teal-600">Bilan financier et marges</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-teal-400"></i>
                            </button>
                            
                            <button onclick="PDGModule.showBudgetManagementModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="target" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-green-800">Gestion des Budgets</div>
                                    <div class="text-xs text-green-600">${(CORE.db.budgets || []).length} budgets cr��s</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-green-400"></i>
                            </button>
                        </div>
                        
                        <!-- Tab: Syst��me -->
                        <div id="pdg-content-system" class="space-y-4 hidden">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-11 h-11 bg-gradient-to-br from-slate-600 to-slate-800 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="cpu" class="w-5 h-5 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-slate-800">Syst��me & Maintenance</h3>
                                    <p class="text-xs text-slate-500">Configuration avanc�e</p>
                                </div>
                            </div>
                            
                            <button onclick="PDGModule.showSystemDashboardModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-slate-100 to-gray-100 border border-slate-300 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-slate-600 to-gray-700 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="activity" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-slate-800">Tableau de Bord Syst��me</div>
                                    <div class="text-xs text-slate-600">Sant� et diagnostics</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i>
                            </button>
                            
                            <button onclick="PDGModule.showAdvancedSystemModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-gray-100 to-slate-100 border border-gray-300 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-gray-600 to-slate-700 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="settings" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-slate-800">Param��tres Avanc�s</div>
                                    <div class="text-xs text-slate-600">${(CORE.db.backups || []).length} sauvegardes �� ?� � ${(CORE.db.systemLogs || []).length} logs</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i>
                            </button>
                            
                            <button onclick="PDGModule.showImportExportModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-indigo-100 to-blue-100 border border-indigo-300 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-600 to-blue-700 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="database" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-indigo-800">Import/Export de Donn�es</div>
                                    <div class="text-xs text-indigo-600">${(CORE.db.importExportHistory || []).length} op�rations enregistr�es</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-indigo-400"></i>
                            </button>
                            
                            <!-- Alertes -->
                            <div class="p-4 rounded-2xl bg-gradient-to-r from-rose-100 to-red-100 border border-rose-300">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-11 h-11 bg-gradient-to-br from-rose-500 to-red-600 rounded-xl flex items-center justify-center shadow-lg">
                                        <i data-lucide="bell-ring" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-black text-rose-800">Alertes & Seuils</h4>
                                        <p class="text-xs text-rose-600">${alertsCount} seuils actifs �� ?� � ${unreadNotifs} non lues</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="PDGModule.showAlertThresholdsModal()" class="p-3 bg-white rounded-xl border border-rose-200 text-rose-700 font-bold text-xs hover:bg-rose-50 transition flex items-center justify-center gap-2">
                                        <i data-lucide="sliders-vertical" class="w-4 h-4"></i>
                                        Configurer Seuils
                                    </button>
                                    <button onclick="PDGModule.showNotificationHistoryModal()" class="p-3 bg-white rounded-xl border border-rose-200 text-rose-700 font-bold text-xs hover:bg-rose-50 transition flex items-center justify-center gap-2">
                                        <i data-lucide="history" class="w-4 h-4"></i>
                                        Historique
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab: S�curit� -->
                        <div id="pdg-content-security" class="space-y-4 hidden">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-11 h-11 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-200">
                                    <i data-lucide="shield-check" class="w-5 h-5 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-slate-800">S�curit� & Permissions</h3>
                                    <p class="text-xs text-slate-500">Contr��le des acc��s Manager</p>
                                </div>
                            </div>
                            
                            <!-- Permissions Manager -->
                            <div class="space-y-3">
                                <div class="p-4 rounded-2xl bg-gradient-to-r from-purple-50 to-violet-50 border border-purple-200">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-violet-600 rounded-lg flex items-center justify-center">
                                                <i data-lucide="eye" class="w-5 h-5 text-white"></i>
                                            </div>
                                            <div>
                                                <div class="font-black text-slate-800 text-sm">Manager voit vos donn�es</div>
                                                <div class="text-xs text-slate-500">Acc��s �� vos identifiants</div>
                                            </div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" ${CORE.getSystemSetting('pdg_manager_access', false) ? 'checked' : ''} onchange="PDGModule.toggleManagerAccess()" class="sr-only peer">
                                            <div class="w-14 h-7 bg-slate-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all after:shadow-md peer-checked:bg-purple-500"></div>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="p-4 rounded-2xl bg-gradient-to-r from-indigo-50 to-blue-50 border border-indigo-200">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-blue-600 rounded-lg flex items-center justify-center">
                                                <i data-lucide="user-plus" class="w-5 h-5 text-white"></i>
                                            </div>
                                            <div>
                                                <div class="font-black text-slate-800 text-sm">Manager g��re utilisateurs</div>
                                                <div class="text-xs text-slate-500">Cr�er/supprimer des comptes</div>
                                            </div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" ${CORE.getSystemSetting('manager_manage_users', false) ? 'checked' : ''} onchange="PDGModule.toggleManagerUserManagement()" class="sr-only peer">
                                            <div class="w-14 h-7 bg-slate-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all after:shadow-md peer-checked:bg-indigo-500"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Mot de passe -->
                            <button onclick="PDGModule.showChangePersonalPasswordModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-cyan-50 to-teal-50 border border-cyan-200 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="key" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-cyan-800">Changer votre mot de passe</div>
                                    <div class="text-xs text-cyan-600">Modifiez votre mot de passe personnel</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-cyan-400"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Footer actions -->
                    <div class="pt-4 border-t border-slate-200 flex justify-between items-center">
                        <button onclick="App.logout()" class="px-4 py-2.5 bg-red-50 text-red-600 rounded-xl font-bold text-sm hover:bg-red-100 transition flex items-center gap-2">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            D�connexion
                        </button>
                        <button onclick="UI.closeModal(); UI.toast('���?? Param��tres enregistr�s', 'success')" class="px-6 py-2.5 bg-gradient-to-r from-slate-800 to-zinc-900 text-white rounded-xl font-bold text-sm hover:shadow-lg hover:shadow-amber-200 transition-all flex items-center gap-2 ring-2 ring-amber-400/50">
                            <i data-lucide="save" class="w-4 h-4 text-amber-400"></i>
                            Fermer
                        </button>
                    </div>
                </div>
            `, [], { maxWidth: 'max-w-2xl' });
            
            setTimeout(() => lucide.createIcons(), 50);
        },
        
        switchSettingsTab(tabName) {
            // Hide all content
            ['general', 'users', 'finance', 'system', 'security'].forEach(tab => {
                const content = document.getElementById('pdg-content-' + tab);
                const tabBtn = document.getElementById('pdg-tab-' + tab);
                if (content) content.classList.add('hidden');
                if (tabBtn) {
                    tabBtn.className = 'flex-1 min-w-[80px] px-3 py-3 text-xs font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 flex items-center justify-center gap-1.5 transition rounded-t-lg';
                }
            });
            
            // Show selected
            const selectedContent = document.getElementById('pdg-content-' + tabName);
            const selectedTab = document.getElementById('pdg-tab-' + tabName);
            if (selectedContent) selectedContent.classList.remove('hidden');
            if (selectedTab) {
                selectedTab.className = 'flex-1 min-w-[80px] px-3 py-3 text-xs font-bold text-amber-700 border-b-2 border-amber-500 bg-amber-50/50 flex items-center justify-center gap-1.5 rounded-t-lg';
            }
            
            setTimeout(() => lucide.createIcons(), 50);
        },

        toggleManagerAccess() {
            const current = CORE.getSystemSetting('pdg_manager_access', false);
            CORE.setSystemSetting('pdg_manager_access', !current);
            UI.toast(!current ? 'Manager peut maintenant voir vos donn�es' : 'Manager ne peut plus voir vos donn�es', 'info');
            PDGModule.showSettingsModal();
            App.rerender();
        },

        toggleManagerUserManagement() {
            const current = CORE.getSystemSetting('manager_manage_users', false);
            CORE.setSystemSetting('manager_manage_users', !current);
            UI.toast(!current ? 'Manager peut maintenant ajouter/retirer des utilisateurs' : 'Manager ne peut plus ajouter/retirer des utilisateurs', 'info');
            PDGModule.showSettingsModal();
            App.rerender();
        },

        async showUserApprovalModal() {
            const requests = (CORE.db.userAdditionRequests || []).filter(r => r.status === 'pending');
            let joinRequests = (CORE.db.joinRequests || []).filter(r => r.status === 'pending');

            if (CORE.state.isOnline) {
                try {
                    const apiJoin = await API.listJoinRequests();
                    if (Array.isArray(apiJoin)) {
                        joinRequests = apiJoin.map(r => ({
                            id: r.id || r.requestId,
                            contact: r.contact || r.email,
                            code: r.code || r.companyId,
                            userId: r.userId,
                            createdAt: r.createdAt || new Date().toISOString(),
                            status: r.status || 'pending'
                        })).filter(r => r.status === 'pending');
                    }
                } catch (e) {
                    console.warn('API list join requests failed:', e.message);
                }
            }
            
            if (requests.length === 0 && joinRequests.length === 0) {
                UI.toast('Aucune demande en attente', 'info');
                return;
            }

            UI.modal('Approbation des Demandes d\'Utilisateurs', `
                <div class="space-y-6 max-h-[60vh] overflow-y-auto">
                    ${joinRequests.length > 0 ? `
                        <div>
                            <div class="text-xs font-black text-slate-600 uppercase tracking-wider mb-3">Demandes d'adhesion</div>
                            <div class="space-y-4">
                                ${joinRequests.map(req => {
                                    const user = CORE.db.users.find(u => u.id === req.userId);
                                    const company = (CORE.db.companies || []).find(c => c.id === req.code || c.name === req.code);
                                    return `
                                        <div class="p-4 rounded-2xl border border-slate-200 bg-white">
                                            <div class="flex items-start justify-between mb-3">
                                                <div>
                                                    <div class="font-black text-slate-900">${user?.name || 'Utilisateur'}</div>
                                                    <div class="text-xs text-slate-600 space-y-1 mt-1">
                                                        <div>Contact: <span class="font-mono text-emerald-600">${req.contact}</span></div>
                                                        <div>Entreprise: <span class="font-bold">${company?.name || req.code}</span></div>
                                                        <div>Date: <span class="text-xs">${new Date(req.createdAt).toLocaleString('fr-FR')}</span></div>
                                                    </div>
                                                </div>
                                                <span class="px-3 py-1 rounded-full text-xs font-black bg-amber-100 text-amber-700">
                                                    �� � � En attente
                                                </span>
                                            </div>
                                            <div class="flex gap-2 pt-3 border-t border-slate-200">
                                                <button onclick="PDGModule.approveJoinRequest('${req.id}')" class="flex-1 px-3 py-2 bg-emerald-600 text-white rounded-lg text-xs font-black hover:bg-emerald-700 transition">
                                                    ���?? Approuver
                                                </button>
                                                <button onclick="PDGModule.rejectJoinRequest('${req.id}')" class="flex-1 px-3 py-2 bg-red-600 text-white rounded-lg text-xs font-black hover:bg-red-700 transition">
                                                    ���?? Refuser
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${requests.length > 0 ? `
                        <div>
                            <div class="text-xs font-black text-slate-600 uppercase tracking-wider mb-3">Demandes internes</div>
                            <div class="space-y-4">
                                ${requests.map(req => `
                                    <div class="p-4 rounded-2xl border border-slate-200 bg-white">
                                        <div class="flex items-start justify-between mb-3">
                                            <div>
                                                <div class="font-black text-slate-900">${req.name}</div>
                                                <div class="text-xs text-slate-600 space-y-1 mt-1">
                                                    <div>Identifiant: <span class="font-mono text-emerald-600">${req.username}</span></div>
                                                    <div>R��le: <span class="font-bold">${req.role}</span></div>
                                                    <div>Demand� par: <span class="font-bold">${req.requestedByName}</span></div>
                                                    <div>Date: <span class="text-xs">${new Date(req.requestedAt).toLocaleString('fr-FR')}</span></div>
                                                </div>
                                            </div>
                                            <span class="px-3 py-1 rounded-full text-xs font-black bg-amber-100 text-amber-700">
                                                �� � � En attente
                                            </span>
                                        </div>
                                        <div class="flex gap-2 pt-3 border-t border-slate-200">
                                            <button onclick="PDGModule.approveUserRequest(${req.id})" class="flex-1 px-3 py-2 bg-emerald-600 text-white rounded-lg text-xs font-black hover:bg-emerald-700 transition">
                                                ���?? Approuver
                                            </button>
                                            <button onclick="PDGModule.rejectUserRequest(${req.id})" class="flex-1 px-3 py-2 bg-red-600 text-white rounded-lg text-xs font-black hover:bg-red-700 transition">
                                                ���?? Ne pas Autoriser
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        approveUserRequest(requestId) {
            if (!CORE.hasPermission('users.create')) {
                return UI.toast('Acc��s refus�', 'error');
            }
            const request = CORE.db.userAdditionRequests?.find(r => r.id === requestId);
            if (!request) return UI.toast('Demande introuvable', 'error');

            // Cr�er l'utilisateur
            const newUser = {
                id: Math.max(...CORE.db.users.map(u => u.id), 0) + 1,
                name: request.name,
                username: request.username,
                password: request.password,
                passwordHash: request.passwordHash,
                role: request.role,
                avatar: request.avatar,
                active: true,
                pendingApproval: false,
                companyId: request.companyId || CORE.state.currentUser?.companyId || null,
                joinedDate: new Date().toISOString()
            };

            const currentUser = CORE.state.currentUser;
            request.status = 'approved';
            request.approvedBy = currentUser.id;
            request.approvedByName = currentUser.name;
            request.approvedAt = new Date().toISOString();

            CORE.db.users.push(newUser);
            
            // Audit Log
            CORE.logAudit(
                'approve',
                'userAdditionRequest',
                requestId,
                `Approbation utilisateur: ${request.name}`,
                { requestedBy: request.requestedByName, role: request.role, reason: 'Approuv� par PDG' },
                null,
                newUser
            );
            
            CORE.save();
            UI.toast(`${request.name} a �t� approuv� et cr�� avec succ��s`, 'success');
            PDGModule.showUserApprovalModal();
            App.rerender();
        },

        rejectUserRequest(requestId) {
            if (!CORE.hasPermission('users.edit')) {
                return UI.toast('Acc��s refus�', 'error');
            }
            const reason = prompt('Raison du rejet:');
            if (reason === null) return; // Annul�

            const request = CORE.db.userAdditionRequests?.find(r => r.id === requestId);
            if (!request) return UI.toast('Demande introuvable', 'error');

            const currentUser = CORE.state.currentUser;
            request.status = 'rejected';
            request.rejectionReason = reason || 'Aucune raison fournie';
            request.approvedBy = currentUser.id;
            request.approvedByName = currentUser.name;
            request.approvedAt = new Date().toISOString();

            // Audit Log
            CORE.logAudit(
                'reject',
                'userAdditionRequest',
                requestId,
                `Rejet utilisateur: ${request.name}`,
                { requestedBy: request.requestedByName, role: request.role, rejectionReason: reason || 'Aucune raison fournie' },
                null,
                null,
                'success'
            );

            CORE.save();
            UI.toast(`Demande de ${request.name} rejet�e`, 'info');
            PDGModule.showUserApprovalModal();
            App.rerender();
        },

        async approveJoinRequest(requestId) {
            if (!CORE.hasPermission('invitations.manage')) {
                return UI.toast('Acc��s refus�', 'error');
            }
            if (CORE.state.isOnline) {
                try {
                    await API.approveJoinRequest(requestId);
                    UI.toast('Demande approuv�e (API)', 'success');
                    PDGModule.showUserApprovalModal();
                    App.rerender();
                    return;
                } catch (e) {
                    console.warn('API approve failed, fallback local:', e.message);
                }
            }

            const request = CORE.db.joinRequests?.find(r => r.id === requestId);
            if (!request) return UI.toast('Demande introuvable', 'error');

            const user = CORE.db.users.find(u => u.id === request.userId);
            if (!user) return UI.toast('Utilisateur introuvable', 'error');

            const company = (CORE.db.companies || []).find(c => c.id === request.code || c.name === request.code);
            if (company && !user.companyId) user.companyId = company.id;

            user.active = true;
            user.pendingApproval = false;
            request.status = 'approved';

            CORE.save();
            UI.toast('Demande approuv�e', 'success');
            PDGModule.showUserApprovalModal();
            App.rerender();
        },

        async rejectJoinRequest(requestId) {
            if (!CORE.hasPermission('invitations.manage')) {
                return UI.toast('Acc��s refus�', 'error');
            }
            if (CORE.state.isOnline) {
                try {
                    await API.rejectJoinRequest(requestId);
                    UI.toast('Demande refus�e (API)', 'info');
                    PDGModule.showUserApprovalModal();
                    App.rerender();
                    return;
                } catch (e) {
                    console.warn('API reject failed, fallback local:', e.message);
                }
            }

            const request = CORE.db.joinRequests?.find(r => r.id === requestId);
            if (!request) return UI.toast('Demande introuvable', 'error');

            const user = CORE.db.users.find(u => u.id === request.userId);
            if (user) {
                user.active = false;
                user.pendingApproval = false;
            }

            request.status = 'rejected';
            CORE.save();
            UI.toast('Demande refus�e', 'info');
            PDGModule.showUserApprovalModal();
            App.rerender();
        },

        toggleNotifications() {
            this.state.notificationsEnabled = !this.state.notificationsEnabled;
            UI.toast(this.state.notificationsEnabled ? '���?? Notifications activ�es' : '���?? Notifications d�sactiv�es', 'info');
            PDGModule.showSettingsModal();
            App.rerender();
        },

        validatePurchaseOrderArrival(orderId) {
            const order = CORE.db.purchaseOrders?.find(o => o.id === orderId);
            if (!order) {
                UI.toast('Commande introuvable', 'error');
                return;
            }
            if (order.status === 'received') {
                UI.toast('Commande d�j�� re��ue', 'info');
                return;
            }
            
            // Afficher modal pour saisir le montant r�ellement d�pens� du transport
            UI.modal('Montant du transport r�ellement d�pens�', 
                '<div class="space-y-4">' +
                UI.input('va_transportAmount', 'Montant du transport', 'number', order.transportPrice || 0, 'ex: 5000', true) +
                '</div>',
                [
                    {label: 'Annuler', onclick: 'UI.closeModal()'},
                    {label: 'Confirmer arriv�e', onclick: 'PDGModule.confirmArrivalWithTransport(' + orderId + ')', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700'}
                ]
            );
        },

        confirmArrivalWithTransport(orderId) {
            const order = CORE.db.purchaseOrders?.find(o => o.id === orderId);
            if (!order) {
                UI.toast('Commande introuvable', 'error');
                return;
            }
            
            const transportAmount = parseFloat(UI.val('va_transportAmount')) || 0;
            if (transportAmount < 0) {
                UI.toast('Montant invalide', 'warning');
                return;
            }
            
            // Marquer la commande comme re��ue
            order.status = 'received';
            order.actualTransportCost = transportAmount;
            CORE.update('purchaseOrders', order.id, order);
            
            // Mettre �� jour la d�pense principale
            const expense = CORE.db.expenses?.find(e => e.purchaseOrderId === orderId && e.type === 'purchase_order');
            if (expense) {
                expense.status = 'completed';
                CORE.update('expenses', expense.id, expense);
            }
            
            // Cr�er une d�pense pour le transport si un montant a �t� saisi
            if (transportAmount > 0) {
                const supplier = CORE.db.suppliers?.find(s => s.id === order.supplierId);
                CORE.create('expenses', {
                    reference: order.reference + '-TRANSPORT',
                    type: 'transport',
                    description: `Frais de transport r�els - ${order.reference} de ${supplier?.name || 'Fournisseur'}`,
                    amount: transportAmount,
                    supplier: supplier?.name || 'Non sp�cifi�',
                    category: 'transport',
                    status: 'completed',
                    purchaseOrderId: orderId,
                    createdAt: new Date().toISOString()
                });
            }
            
            // Notification d'arriv�e valid�e
            const supplier = CORE.db.suppliers?.find(s => s.id === order.supplierId);
            const product = CORE.db.products?.find(p => p.id === order.productId);
            CORE.notify('success', `Colis re��u: ${order.reference} (${product?.name || 'Produit'}) - Transport r�el: ${CORE.formatPrice(transportAmount)}`, { purchaseOrderId: orderId });
            
            UI.closeModal();
            UI.toast('���?? Arriv�e du colis valid�e avec frais de transport: ' + CORE.formatPrice(transportAmount), 'success');
            this.navigateTo('commandes');
        },

        render() {
            const k = this.getKpis();
            this.loadThemePreference(); // Charger le th��me pr�f�r�
            CORE.checkStockLevels(); // V�rifier les niveaux de stock et d�clencher les alertes
            return `
                <div class="flex h-screen bg-slate-50 overflow-hidden">
                    <aside class="w-80 bg-gradient-to-b from-indigo-950 via-purple-950 to-slate-950 text-white flex flex-col no-print relative overflow-hidden">
                        <!-- Effets de fond premium -->
                        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top,rgba(139,92,246,0.2),transparent_50%)] pointer-events-none"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_bottom_left,rgba(236,72,153,0.1),transparent_50%)] pointer-events-none"></div>
                        <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-violet-500 via-purple-500 to-pink-500"></div>
                        
                        <!-- Header Premium -->
                        <div class="p-6 flex-shrink-0 relative">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 bg-gradient-to-br from-violet-500 via-purple-500 to-pink-500 rounded-2xl flex items-center justify-center shadow-xl shadow-purple-500/40 ring-2 ring-white/20 relative">
                                    <span class="text-white font-black text-2xl">${(CORE.getCompanyName() || 'R').charAt(0).toUpperCase()}</span>
                                    <div class="absolute -top-1 -right-1 w-4 h-4 bg-gradient-to-r from-amber-400 to-yellow-500 rounded-full flex items-center justify-center shadow-lg">
                                        <i data-lucide="crown" class="w-2.5 h-2.5 text-amber-900"></i>
                                    </div>
                                </div>
                                <div>
                                    <h1 class="font-black text-2xl tracking-tight">${CORE.getCompanyName()}<span class="bg-gradient-to-r from-violet-400 to-pink-400 bg-clip-text text-transparent">.pdg</span></h1>
                                    <p class="text-[10px] text-purple-300/70 font-bold uppercase tracking-widest">Command Center</p>
                                </div>
                            </div>

                            <!-- Stats cards -->
                            <div class="mt-6 grid grid-cols-2 gap-3">
                                <div class="p-4 rounded-2xl bg-gradient-to-br from-white/10 to-white/5 border border-white/10 backdrop-blur-sm hover:from-white/15 hover:to-white/10 transition-all duration-300 group">
                                    <div class="text-[10px] text-purple-300/70 font-black uppercase tracking-wider">En cours</div>
                                    <div class="text-2xl font-black bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent">${k.deliveriesInProgress}</div>
                                </div>
                                <div class="p-4 rounded-2xl bg-gradient-to-br from-white/10 to-white/5 border border-white/10 backdrop-blur-sm hover:from-white/15 hover:to-white/10 transition-all duration-300 group">
                                    <div class="text-[10px] text-purple-300/70 font-black uppercase tracking-wider">�?� assigner</div>
                                    <div class="text-2xl font-black bg-gradient-to-r from-amber-400 to-orange-400 bg-clip-text text-transparent">${k.deliveriesToAssign}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation -->
                        <nav class="flex-1 px-4 py-2 space-y-1 overflow-y-auto scrollbar-thin scrollbar-thumb-purple-500/30 scrollbar-track-transparent">
                            ${this.renderNavItem('overview','layout-dashboard','Aper��u')}
                            ${this.renderNavItem('orders','receipt','Commandes')}
                            ${this.renderNavItem('orders-global','shopping-bag','Commandes (Ventes)')}
                            ${this.renderNavItem('commandes','shopping-cart','Gestion r�appro')}
                            ${this.renderNavItem('main-stock','warehouse','��Ÿ � � Stock D�p��t Principal')}
                            ${this.renderNavItem('deliveries','truck','Livraisons')}
                            ${this.renderNavItem('stock','box','Stock')}
                            ${this.renderNavItem('pos','store','Points de vente')}
                            ${this.renderNavItem('finance','wallet','Finances')}
                            ${this.renderNavItem('reports','bar-chart-3','Rapports')}
                            ${this.renderNavItem('audit','shield-alert','Audit Trail')}
                            ${this.renderNavItem('team','users','�quipe')}
                            <button onclick="PDGModule.showNotificationHistoryModal()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 text-slate-400 hover:bg-white/10 hover:text-white relative group">
                                <div class="w-9 h-9 rounded-xl bg-white/5 group-hover:bg-white/10 flex items-center justify-center transition-all duration-200">
                                    <i data-lucide="bell" class="w-5 h-5"></i>
                                </div>
                                <span class="font-bold text-sm">Notifications</span>
                                ${CORE.getUnreadNotificationCount() > 0 ? `<span class="ml-auto px-2.5 py-1 bg-gradient-to-r from-red-500 to-pink-500 text-white text-xs font-black rounded-full shadow-lg shadow-red-500/30 animate-pulse">${CORE.getUnreadNotificationCount()}</span>` : ''}
                            </button>
                        </nav>

                        <!-- Footer -->
                        <div class="p-4 border-t border-white/5 relative">
                            <button onclick="PDGModule.showSettingsModal()" class="w-full flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-white/5 to-white/10 hover:from-white/10 hover:to-white/15 rounded-xl transition-all duration-200 group">
                                <i data-lucide="settings" class="w-5 h-5 text-slate-400 group-hover:text-purple-400 group-hover:rotate-90 transition-all duration-300"></i>
                                <span class="text-sm font-bold text-slate-300 group-hover:text-white">Param��tres</span>
                            </button>
                        </div>
                    </aside>

                    <main class="flex-1 overflow-auto">
                        <header class="bg-white border-b border-slate-200 px-8 py-5 sticky top-0 z-20">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                <div>
                                    <h2 class="text-xl font-black text-slate-900">Pilotage global</h2>
                                    <p class="text-sm text-slate-500">PDG: ${CORE.state.currentUser?.name} �� ?� � ${CORE.state.isOnline ? 'En ligne' : 'Hors ligne'}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="PDGModule.showSyncModal()" class="px-3 py-1.5 rounded-full bg-emerald-100 hover:bg-emerald-200 text-xs font-black text-emerald-700 flex items-center gap-1 transition" title="Synchroniser avec le serveur">
                                        <i data-lucide="cloud-cog" class="w-3 h-3"></i> 
                                        <span>Sync</span>
                                        <span class="w-2 h-2 rounded-full ${CORE.state.isOnline && API.getToken() ? "bg-emerald-500" : "bg-orange-500"}"></span>
                                    </button>
                                    <div class="px-3 py-1.5 rounded-full bg-slate-100 text-xs font-black text-slate-600">CA: ${CORE.formatPrice(this.getGlobalRevenue())}</div>
                                    <div class="px-3 py-1.5 rounded-full bg-slate-100 text-xs font-black text-slate-600">Stock: ${CORE.formatPrice(this.getInventoryValue())}</div>
                                </div>
                            </div>
                        </header>

                        <div class="p-8">${this.renderContent()}</div>
                    </main>
                </div>
            `;
        },

        // =====================
        // GESTION DES UTILISATEURS (PDG)
        // =====================
        showUsersManagementModal() {
            const users = CORE.db.users || [];
            UI.modal('Gestion des Utilisateurs', `
                <div class="mb-4">
                    <button onclick="PDGModule.showAddUserModal()" class="w-full px-4 py-3 bg-emerald-600 text-white rounded-xl text-sm font-black hover:bg-emerald-700 transition">
                        + Ajouter un utilisateur
                    </button>
                </div>
                <div class="space-y-4 max-h-[50vh] overflow-y-auto">
                    ${users.map(u => `
                        <div class="p-4 rounded-2xl border border-slate-200 bg-white">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex items-center gap-3 flex-1">
                                    ${u.profileImage ? `<img src="${u.profileImage}" class="w-12 h-12 rounded-xl object-cover" onerror="this.style.display='none'">` : `<div class="w-12 h-12 gradient-${u.role} rounded-xl flex items-center justify-center text-white font-black text-sm">${u.avatar}</div>`}
                                    <div class="flex-1">
                                        <div class="font-black text-slate-900">${u.name}</div>
                                        <div class="text-xs text-slate-500 space-y-1">
                                            <div>Role: <span class="font-bold text-slate-700">${u.role}</span></div>
                                            <div>Identifiant: <span class="font-mono text-emerald-600">${u.username || 'N/A'}</span></div>
                                            <div>Mot de passe: <span class="font-mono text-cyan-600">${u.password || 'N/A'}</span></div>
                                            <div>Statut: <span class="font-bold ${u.active ? 'text-emerald-600' : 'text-red-600'}">${u.active ? 'Actif' : 'Inactif'}</span></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <button onclick="PDGModule.showUserDetailsModal(${u.id})" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-xs font-black hover:bg-indigo-700 transition">
                                        ��Ÿ?� D�tails
                                    </button>
                                    <button onclick="PDGModule.showEditUserModal(${u.id})" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-black hover:bg-blue-700 transition">
                                        Modifier
                                    </button>
                                    <button onclick="PDGModule.toggleUserActive(${u.id})" class="px-3 py-2 ${u.active ? 'bg-red-600 hover:bg-red-700' : 'bg-emerald-600 hover:bg-emerald-700'} text-white rounded-lg text-xs font-black transition">
                                        ${u.active ? 'D�sactiver' : 'Activer'}
                                    </button>
                                    ${!u.suspended ? `
                                        <button onclick="PDGModule.showSuspendUserModal(${u.id})" class="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-black hover:bg-orange-700 transition">
                                            ��Ÿ�? Suspendre
                                        </button>
                                    ` : `
                                        <button onclick="const res = CORE.resumeUser(${u.id}); UI.toast(res.message, res.success ? 'success' : 'error'); PDGModule.showUsersManagementModal();" class="px-3 py-2 bg-emerald-600 text-white rounded-lg text-xs font-black hover:bg-emerald-700 transition">
                                            ���?? R�activer
                                        </button>
                                    `}
                                    <button onclick="PDGModule.showChangePasswordModal(${u.id})" class="px-3 py-2 bg-amber-600 text-white rounded-lg text-xs font-black hover:bg-amber-700 transition">
                                        Mot de passe
                                    </button>
                                    <button onclick="PDGModule.deleteUser(${u.id})" class="px-3 py-2 bg-red-500 text-white rounded-lg text-xs font-black hover:bg-red-600 transition">
                                        ��Ÿ??�� � � Supprimer
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showUserDetailsModal(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');

            const roleColors = {
                'pdg': 'text-purple-700 bg-purple-50',
                'manager': 'text-blue-700 bg-blue-50',
                'gestionnaire': 'text-slate-700 bg-slate-50',
                'vendeur': 'text-emerald-700 bg-emerald-50',
                'livreur': 'text-orange-700 bg-orange-50'
            };

            const roleColor = roleColors[user.role] || 'text-slate-700 bg-slate-50';

            UI.modal(`D�tails: ${user.name}`, `
                <div class="space-y-4 max-h-[60vh] overflow-y-auto">
                    <div class="flex items-start gap-4 pb-4 border-b border-slate-200">
                        <div>
                            ${user.profileImage && typeof user.profileImage === 'string' && user.profileImage.trim() && (user.profileImage.startsWith('data:') || user.profileImage.startsWith('http')) ? `<img src="${user.profileImage}" class="w-20 h-20 rounded-xl object-cover" onerror="this.style.display='none'">` : ''}<div class="${user.profileImage && typeof user.profileImage === 'string' && user.profileImage.trim() && (user.profileImage.startsWith('data:') || user.profileImage.startsWith('http')) ? 'hidden' : 'w-20 h-20'} gradient-${user.role} rounded-xl flex items-center justify-center text-white font-black text-2xl">${user.avatar}</div>
                        </div>
                        <div class="flex-1">
                            <div class="font-black text-lg text-slate-900">${user.name}</div>
                            <div class="text-xs font-bold ${roleColor} px-3 py-1 rounded-full inline-block mt-2">${user.role.toUpperCase()}</div>
                            <div class="text-xs text-slate-600 mt-2">ID: ${user.id}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 rounded-lg bg-slate-50">
                            <div class="text-xs font-black text-slate-600 uppercase">Identifiant</div>
                            <div class="text-sm font-mono text-slate-900 mt-1">${user.username || 'N/A'}</div>
                        </div>
                        <div class="p-3 rounded-lg bg-slate-50">
                            <div class="text-xs font-black text-slate-600 uppercase">Mot de passe</div>
                            <div class="text-sm font-mono text-slate-900 mt-1">${user.password || 'N/A'}</div>
                        </div>
                    </div>

                    <div class="p-3 rounded-lg bg-emerald-50 border border-emerald-200">
                        <div class="text-xs font-black text-emerald-700 uppercase">Statut</div>
                        <div class="text-sm font-bold text-emerald-900 mt-1">${user.active ? '���?? Actif' : '���?? Inactif'}</div>
                    </div>

                    ${user.city ? `<div class="p-3 rounded-lg bg-cyan-50 border border-cyan-200">
                        <div class="text-xs font-black text-cyan-700 uppercase">Ville</div>
                        <div class="text-sm text-cyan-900 mt-1">${(() => {
                            const city = CORE.db.cities?.find(c => c.id === user.city);
                            return city ? city.name : 'N/A';
                        })()}</div>
                    </div>` : ''}

                    ${user.pos ? `<div class="p-3 rounded-lg bg-lime-50 border border-lime-200">
                        <div class="text-xs font-black text-lime-700 uppercase">Point de Vente</div>
                        <div class="text-sm text-lime-900 mt-1">${(() => {
                            const pos = CORE.db.pointsOfSale?.find(p => p.id === user.pos);
                            return pos ? pos.name : 'N/A';
                        })()}</div>
                    </div>` : ''}

                    ${user.bio ? `<div class="p-3 rounded-lg bg-blue-50 border border-blue-200">
                        <div class="text-xs font-black text-blue-700 uppercase">Bio</div>
                        <div class="text-sm text-blue-900 mt-1">${user.bio}</div>
                    </div>` : ''}

                    ${user.specialties ? `<div class="p-3 rounded-lg bg-indigo-50 border border-indigo-200">
                        <div class="text-xs font-black text-indigo-700 uppercase">Sp�cialit�s</div>
                        <div class="text-sm text-indigo-900 mt-1">${user.specialties.join(', ')}</div>
                    </div>` : ''}

                    ${user.rating || user.totalSales || user.salesCount ? `<div class="grid grid-cols-3 gap-3">
                        ${user.rating ? `<div class="p-3 rounded-lg bg-yellow-50">
                            <div class="text-xs font-black text-yellow-700 uppercase">Note</div>
                            <div class="text-lg font-black text-yellow-900 mt-1">�� � � ${user.rating}</div>
                        </div>` : ''}
                        ${user.totalSales ? `<div class="p-3 rounded-lg bg-purple-50">
                            <div class="text-xs font-black text-purple-700 uppercase">Ventes</div>
                            <div class="text-sm text-purple-900 mt-1">${CORE.formatPrice(user.totalSales)}</div>
                        </div>` : ''}
                        ${user.salesCount ? `<div class="p-3 rounded-lg bg-pink-50">
                            <div class="text-xs font-black text-pink-700 uppercase">Nb Ventes</div>
                            <div class="text-lg font-black text-pink-900 mt-1">${user.salesCount}</div>
                        </div>` : ''}
                    </div>` : ''}

                    ${user.badge ? `<div class="p-3 rounded-lg bg-yellow-50 border border-yellow-200">
                        <div class="text-xs font-black text-yellow-700 uppercase">Badge</div>
                        <div class="text-sm text-yellow-900 mt-1">${(() => {
                            const badge = CORE.db.vendorBadges?.find(b => b.id === user.badge);
                            return badge ? badge.label : user.badge;
                        })()}</div>
                    </div>` : ''}

                    ${user.deliveryCount ? `<div class="p-3 rounded-lg bg-orange-50 border border-orange-200">
                        <div class="text-xs font-black text-orange-700 uppercase">Livraisons effectu�es</div>
                        <div class="text-sm font-black text-orange-900 mt-1">${user.deliveryCount}</div>
                    </div>` : ''}

                    ${user.phone ? `<div class="p-3 rounded-lg bg-teal-50 border border-teal-200">
                        <div class="text-xs font-black text-teal-700 uppercase">T�l�phone</div>
                        <div class="text-sm text-teal-900 mt-1">${user.phone}</div>
                    </div>` : ''}

                    ${user.vehicle ? `<div class="p-3 rounded-lg bg-red-50 border border-red-200">
                        <div class="text-xs font-black text-red-700 uppercase">V�hicule</div>
                        <div class="text-sm text-red-900 mt-1">${user.vehicle}</div>
                    </div>` : ''}

                    ${user.joinedDate ? `<div class="p-3 rounded-lg bg-gray-50 border border-gray-200">
                        <div class="text-xs font-black text-gray-700 uppercase">Date d'adh�sion</div>
                        <div class="text-sm text-gray-900 mt-1">${user.joinedDate}</div>
                    </div>` : ''}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showEditUserModal(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');

            UI.modal(`Modifier: ${user.name}`, `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Identifiant</label>
                        <input type="text" id="edit-username" value="${user.username || ''}" placeholder="Identifiant" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">R��le</label>
                        <select id="edit-role" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="pdg" ${user.role === 'pdg' ? 'selected' : ''}>PDG</option>
                            <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Manager</option>
                            <option value="gestionnaire" ${user.role === 'gestionnaire' ? 'selected' : ''}>Gestionnaire</option>
                            <option value="vendeur" ${user.role === 'vendeur' ? 'selected' : ''}>Vendeur</option>
                            <option value="livreur" ${user.role === 'livreur' ? 'selected' : ''}>Livreur</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 p-4 bg-red-50 border border-red-200 rounded-2xl">
                    <div class="text-xs font-black text-red-700 mb-3">��Ÿ� � R�initialiser le mot de passe</div>
                    <button class="w-full px-4 py-2 bg-red-600 text-white rounded-lg text-xs font-black hover:bg-red-700 transition" data-user-id="${userId}" data-action="resetPassword">
                        R�initialiser le mot de passe
                    </button>
                </div>
            `, [
                { label: 'Enregistrer', onclick: `PDGModule.saveEditUser(${userId})` },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);

            // Bind actions inside modal content (avoid inline onclick template issues)
            setTimeout(() => {
                const resetBtn = document.querySelector(`#modalContainer [data-action="resetPassword"][data-user-id="${userId}"]`);
                if (resetBtn) resetBtn.onclick = () => PDGModule.resetUserPassword(userId);
            }, 0);
        },

        saveEditUser(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');

            const newUsername = document.getElementById('edit-username')?.value?.trim();
            const newRole = document.getElementById('edit-role')?.value;

            if (!newUsername) return UI.toast('L\'identifiant est requis', 'warning');

            // V�rifier que l'identifiant n'existe pas ailleurs
            const exists = CORE.db.users.some(u => u.id !== userId && u.username === newUsername);
            if (exists) return UI.toast('Cet identifiant existe d�j��', 'error');

            user.username = newUsername;
            user.role = newRole || user.role;

            CORE.save();
            UI.toast('Utilisateur modifi� avec succ��s', 'success');
            UI.closeModal();
            this.showUsersManagementModal();
        },

        resetUserPassword(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');

            // R�initialiser �� un mot de passe par d�faut : "123456"
            Utils.md5('123456').then(hash => {
                user.password = '123456';
                user.passwordHash = hash;
                CORE.save();
                UI.toast(`���?? Mot de passe de ${user.name} r�initialis� �� "123456"`, 'success');
                UI.closeModal();
                this.showUsersManagementModal();
            });
        },

        showChangePasswordModal(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');

            UI.modal(`Changer le mot de passe: ${user.name}`, `
                <div class="space-y-4 bg-blue-50 border border-blue-200 rounded-2xl p-4 mb-4">
                    <div class="text-sm text-blue-800">
                        <div class="font-black mb-2">��š ��� � � Attention</div>
                        <div>Un nouveau mot de passe temporaire sera g�n�r�. L'utilisateur devra le changer �� sa prochaine connexion.</div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-black text-slate-600 uppercase mb-2">Nouveau mot de passe</label>
                    <input type="password" id="change-password-input" placeholder="Entrez le nouveau mot de passe" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-amber-500 focus:outline-none">
                    <div class="text-xs text-slate-500 mt-2">Minimum 6 caract��res requis</div>
                </div>
            `, [
                { label: 'Changer le mot de passe', onclick: `PDGModule.savePasswordChange(${userId})` },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        savePasswordChange(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');

            const newPassword = document.getElementById('change-password-input')?.value || '';
            if (newPassword.length < 6) return UI.toast('Le mot de passe doit avoir au minimum 6 caract��res', 'warning');

            // Hacher le nouveau mot de passe
            Utils.md5(newPassword).then(hash => {
                user.password = newPassword;
                user.passwordHash = hash;
                CORE.save();
                UI.toast(`Mot de passe de ${user.name} chang� avec succ��s`, 'success');
                UI.closeModal();
                this.showUsersManagementModal();
            });
        },

        toggleUserActive(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');

            user.active = !user.active;
            CORE.save();
            UI.toast(`${user.name} est maintenant ${user.active ? 'actif' : 'inactif'}`, 'info');
            this.showUsersManagementModal();
        },

        showAddUserModal() {
            UI.modal('Ajouter un nouvel utilisateur', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Nom complet</label>
                        <input type="text" id="add-name" placeholder="Nom de l'utilisateur" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Identifiant</label>
                        <input type="text" id="add-username" placeholder="Identifiant unique" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Mot de passe initial</label>
                        <input type="password" id="add-password" placeholder="Mot de passe temporaire" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                        <div class="text-xs text-slate-500 mt-2">Minimum 6 caract��res</div>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Image de profil</label>
                        <div class="flex items-center gap-3">
                            <input type="file" id="add-profile-image" accept="image/*" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none text-sm">
                            <div id="profile-preview" class="w-12 h-12 rounded-lg bg-slate-200 flex items-center justify-center text-sm font-black text-slate-600 flex-shrink-0">--</div>
                        </div>
                        <div class="text-xs text-slate-500 mt-2">JPG, PNG ou GIF (max 2MB)</div>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">R��le</label>
                        <select id="add-role" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                            <option value="gestionnaire">Gestionnaire</option>
                            <option value="vendeur">Vendeur</option>
                            <option value="livreur">Livreur</option>
                            <option value="manager">Manager</option>
                            <option value="pdg">PDG</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Avatar (2 caract��res - optionnel)</label>
                        <input type="text" id="add-avatar" placeholder="Ex: JD" maxlength="2" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                        <div class="text-xs text-slate-500 mt-2">Utilis� si pas d'image de profil</div>
                    </div>
                </div>
            `, [
                { label: 'Cr�er l\'utilisateur', onclick: 'PDGModule.saveNewUser()' },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
            
            // Event listener pour l'aper��u de l'image
            setTimeout(() => {
                const fileInput = document.getElementById('add-profile-image');
                if (fileInput) {
                    fileInput.addEventListener('change', function(e) {
                        if (e.target.files[0]) {
                            const reader = new FileReader();
                            reader.onload = function(event) {
                                const preview = document.getElementById('profile-preview');
                                if (preview) {
                                    preview.innerHTML = '';
                                    const img = document.createElement('img');
                                    img.src = event.target.result;
                                    img.className = 'w-full h-full object-cover rounded-lg';
                                    preview.appendChild(img);
                                }
                            };
                            reader.readAsDataURL(e.target.files[0]);
                        }
                    });
                }
            }, 100);
        },

        saveNewUser() {
            const name = document.getElementById('add-name')?.value?.trim() || '';
            const username = document.getElementById('add-username')?.value?.trim() || '';
            const password = document.getElementById('add-password')?.value || '';
            const role = document.getElementById('add-role')?.value || 'gestionnaire';
            const avatar = document.getElementById('add-avatar')?.value?.trim().toUpperCase() || 'XX';
            const profileImageInput = document.getElementById('add-profile-image');

            if (!name || !username || !password) return UI.toast('Tous les champs sont requis', 'warning');
            if (password.length < 6) return UI.toast('Le mot de passe doit avoir au minimum 6 caract��res', 'warning');

            // V�rifier que l'identifiant n'existe pas
            const exists = CORE.db.users.some(u => u.username === username);
            if (exists) return UI.toast('Cet identifiant existe d�j��', 'error');

            // Traiter l'image de profil si pr�sente
            if (profileImageInput && profileImageInput.files && profileImageInput.files[0]) {
                const file = profileImageInput.files[0];
                
                // V�rifier la taille (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    return UI.toast('L\'image doit faire moins de 2MB', 'error');
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const profileImage = e.target.result; // base64 string
                    
                    // Hacher le mot de passe
                    Utils.md5(password).then(hash => {
                        const newUser = {
                            id: Math.max(...CORE.db.users.map(u => u.id), 0) + 1,
                            name,
                            username,
                            password,
                            passwordHash: hash,
                            role,
                            avatar,
                            profileImage,
                            active: true
                        };

                        CORE.db.users.push(newUser);
                        CORE.save();
                        UI.toast(`${name} a �t� cr�� avec succ��s`, 'success');
                        UI.closeModal();
                        this.showUsersManagementModal();
                    });
                };
                reader.readAsDataURL(file);
            } else {
                // Pas d'image de profil, cr�er l'utilisateur sans
                Utils.md5(password).then(hash => {
                    const newUser = {
                        id: Math.max(...CORE.db.users.map(u => u.id), 0) + 1,
                        name,
                        username,
                        password,
                        passwordHash: hash,
                        role,
                        avatar,
                        active: true
                    };

                    CORE.db.users.push(newUser);
                    CORE.save();
                    UI.toast(`${name} a �t� cr�� avec succ��s`, 'success');
                    UI.closeModal();
                    this.showUsersManagementModal();
                });
            }
        },

        deleteUser(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouv�', 'error');

            // Confirmation avant suppression
            if (!confirm(`�?Štes-vous s��r de vouloir supprimer ${user.name} ?`)) {
                return;
            }

            // Supprimer l'utilisateur
            const index = CORE.db.users.findIndex(u => u.id === userId);
            if (index !== -1) {
                CORE.db.users.splice(index, 1);
                CORE.save();
                UI.toast(`${user.name} a �t� supprim�`, 'success');
                this.showUsersManagementModal();
            } else {
                UI.toast('Utilisateur non trouv�', 'error');
            }
        },

        showChangePersonalPasswordModal() {
            UI.modal('��Ÿ�? Changer votre mot de passe', `
                <div class="space-y-4">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl flex items-center gap-3">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-amber-600 flex-shrink-0"></i>
                        <div class="text-sm text-amber-800 font-medium">Utilisez un mot de passe fort (min 6 caract��res)</div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Ancien mot de passe</label>
                        <input type="password" id="old_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-cyan-500 outline-none" placeholder="Entrez votre ancien mot de passe">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Nouveau mot de passe</label>
                        <input type="password" id="new_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-cyan-500 outline-none" placeholder="Entrez un nouveau mot de passe">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Confirmation du nouveau mot de passe</label>
                        <input type="password" id="confirm_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-cyan-500 outline-none" placeholder="Confirmez le nouveau mot de passe">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Changer le mot de passe', onclick: 'PDGModule.savePersonalPasswordChange()', class: 'px-5 py-2.5 bg-cyan-600 text-white font-black rounded-xl hover:bg-cyan-700' }
            ]);
        },

        async savePersonalPasswordChange() {
            const oldPwd = UI.val('old_pwd');
            const newPwd = UI.val('new_pwd');
            const confirmPwd = UI.val('confirm_pwd');
            const user = CORE.state.currentUser;
            
            if (!oldPwd || !newPwd || !confirmPwd) {
                UI.toast('Tous les champs sont obligatoires', 'error');
                return;
            }
            
            if (newPwd.length < 6) {
                UI.toast('Le nouveau mot de passe doit contenir au moins 6 caract��res', 'error');
                return;
            }
            
            if (newPwd !== confirmPwd) {
                UI.toast('Les mots de passe ne correspondent pas', 'error');
                return;
            }
            
            const oldPwdHash = await Utils.md5(oldPwd);
            if (oldPwdHash !== user.passwordHash) {
                UI.toast('Ancien mot de passe incorrect', 'error');
                return;
            }
            
            const newPwdHash = await Utils.md5(newPwd);
            user.passwordHash = newPwdHash;
            
            const userIndex = CORE.db.users.findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
                CORE.db.users[userIndex] = user;
                CORE.save();
                UI.closeModal();
                UI.toast('���?? Mot de passe chang� avec succ��s', 'success');
                App.rerender();
            } else {
                UI.toast('Erreur lors de la mise �� jour de l\'utilisateur', 'error');
            }
        }
    };

    // =========================================================
    // APP CONTROLLER
    // =========================================================
    const App = {
        init() {
            CORE.load();
            try { i18n.loadLang(); } catch (e) {}
            // Ensure demo dataset exists (orders/deliveries) even if the first login is Manager/PDG
            try { VendeurModule?.init && VendeurModule.init(); } catch(e) {}
            // Reconcile finance ledger from existing data
            CORE.reconcileFinance();
            
            // D�marrer le scheduler du digest quotidien
            CORE.initDailyDigestScheduler();
            
            // D�marrer le scheduler de v�rification des arriv�es imminentes
            CORE.initPendingArrivalsScheduler();
            
            // Initialiser le gestionnaire hors-ligne
            if (typeof OfflineManager !== 'undefined') {
                OfflineManager.init();
            }
            
            CORE.save();

            // ESC closes modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') UI.closeModal();
            });

            if (CORE.state.currentUser) {
                this.launchRole(CORE.state.currentUser.role);
                this.rerender();
            } else {
                this.renderOnboarding();
            }
        },

        onboarding: {
            step: 1,
            authTab: 'register',  // 'register' ou 'login'
            contact: '',
            otp: '',
            otpSent: false,
            mode: null,
            companyName: '',
            currency: 'FCFA',
            timezone: 'Africa/Abidjan',
            city: '',
            pos: '',
            fullName: '',
            password: '',
            joinCode: ''
        },

        onboardingSet(field, value) {
            if (!this.onboarding) this.onboarding = { step: 1 };
            this.onboarding[field] = value;
        },

        setApiUrl() {
            const current = API.baseUrl || 'http://localhost:3000';
            const url = prompt('URL API', current);
            if (!url) return;
            API.setBaseUrl(url.trim());
            UI.toast('URL API mise �� jour', 'success');
        },

        onboardingGo(step) {
            this.onboarding.step = step;
            this.renderOnboarding();
        },

        
        
        // Toggle password visibility
        togglePassword(inputId) {
            const input = document.getElementById(inputId);
            if (input) {
                input.type = input.type === 'password' ? 'text' : 'password';
            }
        },

        
        // Switch between login and register tabs
        switchAuthTab(tab) {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const tabLogin = document.getElementById('tab-login');
            const tabRegister = document.getElementById('tab-register');
            
            if (tab === 'register') {
                loginForm?.classList.add('hidden');
                registerForm?.classList.remove('hidden');
                tabLogin?.classList.remove('bg-white', 'shadow-sm', 'font-semibold', 'text-slate-900');
                tabLogin?.classList.add('font-medium', 'text-slate-500');
                tabRegister?.classList.add('bg-white', 'shadow-sm', 'font-semibold', 'text-slate-900');
                tabRegister?.classList.remove('font-medium', 'text-slate-500');
            } else {
                loginForm?.classList.remove('hidden');
                registerForm?.classList.add('hidden');
                tabRegister?.classList.remove('bg-white', 'shadow-sm', 'font-semibold', 'text-slate-900');
                tabRegister?.classList.add('font-medium', 'text-slate-500');
                tabLogin?.classList.add('bg-white', 'shadow-sm', 'font-semibold', 'text-slate-900');
                tabLogin?.classList.remove('font-medium', 'text-slate-500');
            }
        },


        // Switch between login and register tabs
        switchAuthTab(tab) {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const tabLogin = document.getElementById('tab-login');
            const tabRegister = document.getElementById('tab-register');
            
            if (tab === 'register') {
                loginForm?.classList.add('hidden');
                registerForm?.classList.remove('hidden');
                tabLogin?.classList.remove('bg-white', 'shadow-sm', 'font-semibold', 'text-slate-900');
                tabLogin?.classList.add('font-medium', 'text-slate-500');
                tabRegister?.classList.add('bg-white', 'shadow-sm', 'font-semibold', 'text-slate-900');
                tabRegister?.classList.remove('font-medium', 'text-slate-500');
            } else {
                loginForm?.classList.remove('hidden');
                registerForm?.classList.add('hidden');
                tabRegister?.classList.remove('bg-white', 'shadow-sm', 'font-semibold', 'text-slate-900');
                tabRegister?.classList.add('font-medium', 'text-slate-500');
                tabLogin?.classList.add('bg-white', 'shadow-sm', 'font-semibold', 'text-slate-900');
                tabLogin?.classList.remove('font-medium', 'text-slate-500');
            }
        },

// Login with Google (OAuth - � configurer avec votre client ID)
        async loginWithGoogle() {
            UI.toast('Connexion Google en cours...', 'info');
            // En production, utiliser Google OAuth
            // Pour le moment, simulation
            try {
                // Simuler un d�lai r�seau
                await new Promise(r => setTimeout(r, 1000));
                UI.toast('Google OAuth non configur� - Utilisez email/mot de passe', 'warning');
            } catch (e) {
                UI.toast('Erreur Google: ' + e.message, 'error');
            }
        },

        // Login with Apple
        async loginWithApple() {
            UI.toast('Connexion Apple en cours...', 'info');
            try {
                await new Promise(r => setTimeout(r, 1000));
                UI.toast('Apple Sign-In non configur� - Utilisez email/mot de passe', 'warning');
            } catch (e) {
                UI.toast('Erreur Apple: ' + e.message, 'error');
            }
        },

        // Show forgot password modal
        showForgotPassword() {
            UI.modal({
                title: 'R�initialiser le mot de passe',
                icon: 'key',
                content: `
                    <div class="space-y-4">
                        <p class="text-sm text-slate-600">Entrez votre adresse email et nous vous enverrons un lien pour r�initialiser votre mot de passe.</p>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1.5">Email</label>
                            <input type="email" id="reset-email" placeholder="vous@exemple.com"
                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                        </div>
                        <button onclick="App.sendPasswordReset()" 
                            class="w-full py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold transition-all">
                            Envoyer le lien
                        </button>
                    </div>
                `
            });
        },

        // Send password reset email
        async sendPasswordReset() {
            const email = document.getElementById('reset-email')?.value?.trim();
            if (!email) {
                UI.toast('Veuillez entrer votre email', 'warning');
                return;
            }
            
            UI.toast('Envoi en cours...', 'info');
            try {
                // API call pour reset password
                if (CORE.state.isOnline) {
                    await API.request('/auth/forgot-password', { method: 'POST', body: { email } });
                }
                UI.closeModal();
                UI.toast('Si un compte existe avec cet email, vous recevrez un lien de r�initialisation.', 'success', 5000);
            } catch (e) {
                // Ne pas r�v�ler si l'email existe ou non (s�curit�)
                UI.closeModal();
                UI.toast('Si un compte existe avec cet email, vous recevrez un lien de r�initialisation.', 'success', 5000);
            }
        },

        // Register with email
        async registerWithEmail() {
            const email = document.getElementById('register-email')?.value?.trim();
            const password = document.getElementById('register-password')?.value;
            
            if (!email) {
                UI.toast('Veuillez entrer votre email', 'warning');
                return;
            }
            if (!password || password.length < 8) {
                UI.toast('Le mot de passe doit contenir au moins 8 caract�res', 'warning');
                return;
            }
            
            // Sauvegarder pour l'�tape suivante
            this.onboarding.contact = email;
            this.onboarding.password = password;
            
            // Passer � l'�tape 2 (choix: cr�er boutique ou rejoindre)
            this.onboardingGo(2);
        },

        // Connexion depuis l'onboarding (onglet "Se connecter")
        async onboardingLogin() {
            const emailInput = document.getElementById('login-email');
            const passwordInput = document.getElementById('login-password');
            const errorDiv = document.getElementById('login-error');
            
            const email = (emailInput?.value || '').trim();
            const password = (passwordInput?.value || '').trim();
            
            if (!email || !password) {
                if (errorDiv) {
                    errorDiv.textContent = 'Veuillez remplir tous les champs';
                    errorDiv.classList.remove('hidden');
                }
                return;
            }
            
            // Cacher l'erreur pr�c�dente
            if (errorDiv) errorDiv.classList.add('hidden');
            
            // Essayer API d'abord si online
            if (CORE.state.isOnline) {
                try {
                    const res = await API.login(email, password);
                    const token = res?.accessToken || res?.access_token;
                    if (token) {
                        API.setToken(token);
                        // Charger le profil utilisateur
                        let me = null;
                        try { me = await API.getMe(); } catch (e) { console.warn('getMe failed:', e); }
                        
                        // Cr�er ou r�cup�rer l'utilisateur local
                        let localUser = CORE.db.users?.find(u => u.email === email);
                        if (!localUser) {
                            localUser = CORE.create('users', {
                                name: me?.username || me?.firstName || email.split('@')[0],
                                username: me?.username || email.split('@')[0],
                                email: email,
                                role: (me?.role || 'vendeur').toLowerCase(),
                                active: true,
                                companyId: me?.tenantId || '',
                                permissions: me?.permissions || []
                            });
                        } else {
                            // Mettre � jour le r�le si n�cessaire
                            localUser.role = (me?.role || localUser.role || 'vendeur').toLowerCase();
                            localUser.companyId = me?.tenantId || localUser.companyId;
                            CORE.save();
                        }
                        
                        CORE.state.currentUser = localUser;
                        CORE.save();
                        
                        UI.toast('Connexion r�ussie!', 'success');
                        this.launchRole(localUser.role);
                        this.rerender();
                        
                        // Charger les donn�es du serveur apr�s login
                        if (typeof SyncManager !== 'undefined') {
                            setTimeout(() => SyncManager.syncAll(), 1000);
                        }
                        return;
                    }
                } catch (e) {
                    console.warn('API login failed:', e.message);
                    if (errorDiv) {
                        errorDiv.textContent = 'Identifiants incorrects ou serveur inaccessible';
                        errorDiv.classList.remove('hidden');
                    }
                    return;
                }
            }
            
            // Fallback local si offline
            const localUser = CORE.db.users?.find(u => 
                (u.email === email || u.username === email) && u.password === password && u.active !== false
            );
            
            if (localUser) {
                CORE.state.currentUser = localUser;
                CORE.save();
                UI.toast('Connexion hors-ligne r�ussie', 'success');
                this.launchRole(localUser.role);
                this.rerender();
            } else {
                if (errorDiv) {
                    errorDiv.textContent = CORE.state.isOnline ? 
                        'Identifiants incorrects' : 
                        'Utilisateur non trouv� en mode hors-ligne';
                    errorDiv.classList.remove('hidden');
                }
            }
        },

        // Mode simulation OTP (quand le backend n'a pas l'endpoint)
        _simulatedOtp: null,

        async onboardingSendOtp() {
            const contact = (this.onboarding.contact || '').trim();
            if (!contact) {
                UI.toast('Veuillez entrer un email ou un t&#233;l&#233;phone', 'warning');
                return;
            }
            if (!CORE.state.isOnline) {
                UI.toast('Connexion requise pour envoyer OTP', 'warning');
                return;
            }
            try {
                const res = await API.sendOtp(contact);
                this.onboarding.otpSent = true;
                this._simulatedOtp = null;
                if (res?.otp) {
                    UI.toast('OTP: ' + res.otp, 'info', 8000);
                    console.log('��Ÿ� � OTP:', res.otp);
                } else {
                    UI.toast('OTP envoy&#233;', 'success');
                }
            } catch (e) {
                // Backend n'a pas l'endpoint OTP - mode simulation
                if (e.message.includes('404') || e.message.includes('Not Found')) {
                    this._simulatedOtp = String(Math.floor(100000 + Math.random() * 900000));
                    this.onboarding.otpSent = true;
                    UI.toast('Mode D&#233;mo - Votre code OTP: ' + this._simulatedOtp, 'info', 8000);
                    console.log('��Ÿ� � OTP Simul&#233;:', this._simulatedOtp);
                } else {
                    UI.toast('Erreur OTP: ' + e.message, 'error');
                }
            }
        },

        async onboardingSubmitIdentify() {
            const contact = (this.onboarding.contact || '').trim();
            const otp = (this.onboarding.otp || '').trim();
            if (!contact) {
                UI.toast('Veuillez entrer un email ou un t&#233;l&#233;phone', 'warning');
                return;
            }
            if (!otp) {
                UI.toast('Veuillez entrer le code OTP', 'warning');
                return;
            }
            
            // Mode simulation - v�rifier l'OTP localement
            if (this._simulatedOtp) {
                if (otp === this._simulatedOtp) {
                    this._simulatedOtp = null;
                    UI.toast('OTP valid&#233; (mode d&#233;mo)', 'success');
                    this.onboardingGo(2);
                } else {
                    UI.toast('Code OTP incorrect', 'error');
                }
                return;
            }
            
            if (!CORE.state.isOnline) {
                UI.toast('Connexion requise pour v&#233;rifier OTP', 'warning');
                return;
            }
            try {
                await API.verifyOtp(contact, otp);
                this.onboardingGo(2);
            } catch (e) {
                UI.toast('OTP invalide', 'error');
            }
        },

        onboardingChooseMode(mode) {
            this.onboarding.mode = mode;
            this.onboardingGo(mode === 'create' ? 3 : 4);
        },

        async onboardingSubmitCreate() {
            const name = (this.onboarding.companyName || '').trim();
            const fullName = (this.onboarding.fullName || '').trim();
            const password = (this.onboarding.password || '').trim();
            if (!name || !fullName || !password) {
                UI.toast('Veuillez renseigner le nom, votre nom et un mot de passe', 'warning');
                return;
            }

            const companyId = Utils.uid('ENT');
            const currency = this.onboarding.currency || 'XOF';
            const timezone = this.onboarding.timezone || 'Africa/Abidjan';
            const contact = (this.onboarding.contact || '').trim();
            const username = contact.includes('@') ? contact.split('@')[0] : (contact || Utils.uid('USER'));

            if (CORE.state.isOnline) {
                try {
                    // 1. Cr&#233;er le tenant D'ABORD (pas besoin d'auth)
                    UI.toast('Cr&#233;ation de l\'entreprise...', 'info');
                    const tenant = await API.createTenant(name, fullName, contact);
                    const tenantId = tenant?.id || tenant?.tenantId || tenant?.tenantCode;
                    console.log('Tenant cr&#233;&#233;:', tenant);

                    // 2. Enregistrer l'utilisateur avec le tenantId
                    UI.toast('Cr&#233;ation du compte...', 'info');
                    await API.register(username, contact, password, String(tenantId), 'PDG');
                    console.log('Utilisateur enregistr&#233;');

                    // 3. Se connecter
                    const loginRes = await API.login(contact, password);
                    const token = loginRes?.accessToken || loginRes?.access_token;
                    API.setToken(token);
                    console.log('Connect&#233; avec token');

                    // 4. Sauvegarder localement
                    let me = null;
                    try { me = await API.getMe(); } catch (e) {}
                    const user = CORE.create('users', {
                        name: fullName,
                        username,
                        email: contact,
                        password,
                        role: 'pdg',
                        active: true,
                        pendingApproval: false,
                        companyId: String(tenantId),
                        permissions: Array.isArray(me?.permissions) ? me.permissions : []
                    });

                    CORE.state.currentUser = user;
                    CORE.db.systemConfig = CORE.db.systemConfig || {};
                    CORE.db.systemConfig.appName = name;
                    CORE.db.systemConfig.currency = currency;
                    CORE.db.systemConfig.timezone = timezone;
                    CORE.db.systemConfig.companyId = String(tenantId);
                    CORE.db.systemConfig.tenantCode = tenant?.tenantCode;
                    CORE.save();
                    
                    this.launchRole('pdg');
                    this.rerender();
                    UI.toast('Entreprise cr&#233;&#233;e avec succ&#232;s. Bienvenue !', 'success');
                    return;
                } catch (e) {
                    console.error('API create failed:', e);
                    UI.toast('Erreur API: ' + e.message + ' - Cr&#233;ation locale', 'warning');
                }
            }

            // Fallback local
            CORE.db.companies = CORE.db.companies || [];
            CORE.db.companies.push({
                id: companyId,
                name,
                currency,
                timezone,
                cities: this.onboarding.city ? [this.onboarding.city] : [],
                pointsOfSale: this.onboarding.pos ? [this.onboarding.pos] : [],
                roles: ['pdg', 'manager', 'gestionnaire', 'vendeur', 'livreur'],
                rules: { accessRequiresApproval: true },
                alertThresholds: { stockLow: 10, cashAlert: 50000 },
                hierarchyLevels: ['pdg', 'manager', 'gestionnaire', 'vendeur', 'livreur'],
                createdAt: new Date().toISOString()
            });

            CORE.db.systemConfig = CORE.db.systemConfig || {};
            CORE.db.systemConfig.appName = name;
            CORE.db.systemConfig.currency = currency;
            CORE.db.systemConfig.companyId = companyId;

            const user = CORE.create('users', {
                name: fullName,
                username,
                email: contact,
                password,
                role: 'pdg',
                active: true,
                pendingApproval: false,
                companyId
            });

            CORE.state.currentUser = user;
            CORE.save();
            this.launchRole('pdg');
            this.rerender();
            UI.toast('Entreprise creee. Bienvenue !', 'success');
        },

        async onboardingSubmitJoin() {
            const code = (this.onboarding.joinCode || '').trim();
            const fullName = (this.onboarding.fullName || '').trim();
            const password = (this.onboarding.password || '').trim();
            if (!code || !fullName || !password) {
                UI.toast('Veuillez renseigner le code, votre nom et un mot de passe', 'warning');
                return;
            }

            const contact = (this.onboarding.contact || '').trim();
            const username = contact.includes('@') ? contact.split('@')[0] : contact || Utils.uid('USER');

            if (CORE.state.isOnline) {
                try {
                    // 1. Valider le code d'invitation pour obtenir tenantId et role
                    UI.toast('Validation du code...', 'info');
                    const validateRes = await API.request('/invitations/validate/' + code.toUpperCase(), { method: 'GET' });
                    
                    if (!validateRes.valid) {
                        UI.toast('Code invalide ou expire', 'error');
                        return;
                    }
                    
                    const tenantId = validateRes.tenantId;
                    const role = validateRes.role || 'VENDEUR';
                    
                    // 2. S'inscrire avec le tenantId et role de l'invitation
                    UI.toast('Creation du compte...', 'info');
                    await API.register(username, contact, password, String(tenantId), role);
                    
                    // 3. Se connecter
                    const loginRes = await API.login(contact, password);
                    const token = loginRes?.accessToken || loginRes?.access_token;
                    API.setToken(token);
                    
                    // 4. Sauvegarder localement
                    const user = CORE.create('users', {
                        name: fullName,
                        username,
                        email: contact,
                        password,
                        role: role.toLowerCase(),
                        active: true,
                        pendingApproval: false,
                        companyId: String(tenantId)
                    });
                    
                    CORE.state.currentUser = user;
                    CORE.db.systemConfig = CORE.db.systemConfig || {};
                    CORE.db.systemConfig.companyId = String(tenantId);
                    CORE.save();
                    
                    this.launchRole(role.toLowerCase());
                    this.rerender();
                    UI.toast('Bienvenue ! Vous avez rejoint l\'entreprise.', 'success');
                    return;
                } catch (e) {
                    console.warn('API join failed:', e.message);
                    UI.toast('Erreur: ' + e.message, 'error');
                }
            }

            // Fallback local
            const company = (CORE.db.companies || []).find(c => c.id === code || c.name === code);

            const pendingUser = CORE.create('users', {
                name: fullName,
                username,
                email: contact,
                password,
                role: 'vendeur',
                active: false,
                pendingApproval: true,
                companyId: company?.id || null
            });

            CORE.db.joinRequests = CORE.db.joinRequests || [];
            CORE.db.joinRequests.push({
                id: Utils.uid('JOIN'),
                contact,
                code,
                userId: pendingUser.id,
                status: 'pending',
                createdAt: new Date().toISOString()
            });
            CORE.save();
            UI.toast('Demande envoyee. En attente de validation.', 'success');
            this.onboardingGo(2);
        },

        renderOnboarding() {
            const step = this.onboarding.step || 1;
            this.mount(`
                <div class="min-h-screen bg-slate-50 flex items-center justify-center p-6">
                    <div class="w-full max-w-2xl">
                        <div class="text-center mb-8">
                            <div class="mx-auto h-14 w-14 rounded-2xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white text-xl font-bold shadow-lg shadow-emerald-500/30">R</div>
                            <h1 class="mt-5 text-2xl font-bold text-slate-900">Bienvenue sur RAYA</h1>
                            <p class="mt-2 text-slate-500">G�rez votre boutique en toute simplicit�</p>
                            <div class="mt-3 flex items-center justify-center gap-2 text-xs text-slate-400">
                                <span class="flex items-center gap-1">
                                    <svg class="w-3.5 h-3.5 text-emerald-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                                    S�curis�
                                </span>
                                <span class="text-slate-300"></span>
                                <span class="flex items-center gap-1">
                                    <svg class="w-3.5 h-3.5 text-emerald-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/></svg>
                                    Rapide
                                </span>
                                <span class="text-slate-300"></span>
                                <span class="flex items-center gap-1">
                                    <svg class="w-3.5 h-3.5 text-emerald-500" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"/><path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"/></svg>
                                    Hors-ligne
                                </span>
                            </div>
                        </div>

                        <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-6">
                            ${step === 1 ? `
                                <div class="space-y-5" id="auth-form">
                                    <!-- Toggle Connexion / Inscription -->
                                    <div class="flex bg-slate-100 rounded-xl p-1">
                                        <button type="button" id="tab-login"
                                            class="flex-1 py-2.5 text-sm font-semibold bg-white rounded-lg shadow-sm text-slate-900"
                                            onclick="App.switchAuthTab('login')">
                                            Connexion
                                        </button>
                                        <button type="button" id="tab-register"
                                            class="flex-1 py-2.5 text-sm font-medium text-slate-500"
                                            onclick="App.switchAuthTab('register')">
                                            Cr�er un compte
                                        </button>
                                    </div>

                                    <!-- Boutons sociaux -->
                                    <div class="space-y-3">
                                        <button type="button" onclick="App.loginWithGoogle()" 
                                            class="w-full flex items-center justify-center gap-3 px-4 py-3 border border-slate-200 rounded-xl hover:bg-slate-50 transition-all">
                                            <svg class="w-5 h-5" viewBox="0 0 24 24">
                                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                            </svg>
                                            <span class="text-sm font-medium text-slate-700">Continuer avec Google</span>
                                        </button>
                                        <button type="button" onclick="App.loginWithApple()"
                                            class="w-full flex items-center justify-center gap-3 px-4 py-3 bg-black text-white rounded-xl hover:bg-slate-800 transition-all">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                                            </svg>
                                            <span class="text-sm font-medium">Continuer avec Apple</span>
                                        </button>
                                    </div>

                                    <!-- Separateur -->
                                    <div class="relative">
                                        <div class="absolute inset-0 flex items-center">
                                            <div class="w-full border-t border-slate-200"></div>
                                        </div>
                                        <div class="relative flex justify-center text-sm">
                                            <span class="px-4 bg-white text-slate-500">ou</span>
                                        </div>
                                    </div>

                                    <!-- Formulaire dynamique -->
                                    <div id="login-form">
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700 mb-1.5">Email</label>
                                                <input type="email" id="login-email" placeholder="vous@exemple.com"
                                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"
                                                    onkeypress="if(event.key==='Enter') document.getElementById('login-password').focus()">
                                            </div>
                                            <div class="relative">
                                                <div class="flex items-center justify-between mb-1.5">
                                                    <label class="text-sm font-medium text-slate-700">Mot de passe</label>
                                                    <button type="button" onclick="App.showForgotPassword()" class="text-sm text-emerald-600 hover:text-emerald-700 font-medium">
                                                        Oublie ?
                                                    </button>
                                                </div>
                                                <div class="relative">
                                                    <input type="password" id="login-password" placeholder="Votre mot de passe"
                                                        class="w-full px-4 py-3 pr-12 rounded-xl border border-slate-200 text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"
                                                        onkeypress="if(event.key==='Enter') App.onboardingLogin()">
                                                    <button type="button" onclick="App.togglePassword('login-password')" 
                                                        class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="flex items-center">
                                                <input type="checkbox" id="remember-me" class="w-4 h-4 text-emerald-600 border-slate-300 rounded focus:ring-emerald-500">
                                                <label for="remember-me" class="ml-2 text-sm text-slate-600">Se souvenir de moi</label>
                                            </div>
                                        </div>
                                        <div id="login-error" class="hidden mt-4 px-4 py-3 rounded-xl bg-red-50 border border-red-100 text-red-600 text-sm"></div>
                                        <button type="button" onclick="App.onboardingLogin()" 
                                            class="w-full mt-4 py-3.5 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold transition-all active:scale-[0.98]">
                                            Se connecter
                                        </button>
                                    </div>

                                    <div id="register-form" class="hidden">
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700 mb-1.5">Email</label>
                                                <input type="email" id="register-email" placeholder="vous@exemple.com"
                                                    class="w-full px-4 py-3 rounded-xl border border-slate-200 text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all">
                                            </div>
                                            <div class="relative">
                                                <label class="block text-sm font-medium text-slate-700 mb-1.5">Mot de passe</label>
                                                <div class="relative">
                                                    <input type="password" id="register-password" placeholder="8 caracteres minimum"
                                                        class="w-full px-4 py-3 pr-12 rounded-xl border border-slate-200 text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all">
                                                    <button type="button" onclick="App.togglePassword('register-password')" 
                                                        class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <button type="button" onclick="App.registerWithEmail()" 
                                            class="w-full mt-4 py-3.5 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold transition-all active:scale-[0.98]">
                                            Creer mon compte
                                        </button>
                                        <p class="mt-4 text-xs text-center text-slate-500">
                                            En creant un compte, vous acceptez nos conditions.
                                        </p>
                                    </div>

                                    <!-- Lien code invitation -->
                                    <div class="pt-4 border-t border-slate-100 text-center">
                                        <p class="text-sm text-slate-500">
                                            Code d'invitation ?
                                            <button type="button" onclick="App.onboardingGo(4)" class="text-emerald-600 hover:text-emerald-700 font-medium ml-1">
                                                Rejoindre une equipe
                                            </button>
                                        </p>
                                    </div>
                                </div>
                            ` : ''}

                            ${step === 2 ? `
                                <div class="space-y-4">
                                    <h2 class="text-lg font-semibold text-slate-900">Que voulez-vous faire ?</h2>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <button class="p-4 rounded-xl border border-slate-200 hover:border-emerald-500 text-left" onclick="App.onboardingChooseMode('create')">
                                            <div class="font-semibold text-slate-900">Creer une entreprise</div>
                                            <div class="text-sm text-slate-500">Devenez PDG et configurez vos parametres.</div>
                                        </button>
                                        <button class="p-4 rounded-xl border border-slate-200 hover:border-emerald-500 text-left" onclick="App.onboardingChooseMode('join')">
                                            <div class="font-semibold text-slate-900">Rejoindre une entreprise</div>
                                            <div class="text-sm text-slate-500">Entrez un code ou un lien d'invitation.</div>
                                        </button>
                                    </div>
                                    <button class="text-sm text-slate-500 hover:text-slate-700" onclick="App.onboardingGo(1)">Retour</button>
                                </div>
                            ` : ''}

                            ${step === 3 ? `
                                <div class="space-y-4">
                                    <h2 class="text-lg font-semibold text-slate-900">Creation d'entreprise</h2>
                                    <div class="grid md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2">Nom de l'entreprise</label>
                                            <input type="text" placeholder="RAYA Retail"
                                                class="w-full px-4 py-3 rounded-xl border border-slate-200"
                                                oninput="App.onboardingSet('companyName', this.value)">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2">Votre nom</label>
                                            <input type="text" placeholder="Nom complet"
                                                class="w-full px-4 py-3 rounded-xl border border-slate-200"
                                                oninput="App.onboardingSet('fullName', this.value)">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2">Mot de passe</label>
                                            <input type="password" placeholder="********"
                                                class="w-full px-4 py-3 rounded-xl border border-slate-200"
                                                oninput="App.onboardingSet('password', this.value)">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2">Devise</label>
                                            <select class="w-full px-4 py-3 rounded-xl border border-slate-200"
                                                onchange="App.onboardingSet('currency', this.value)">
                                                <optgroup label="&#127464;&#127758; Afrique">
                                                    <option value="XOF">XOF - Franc CFA BCEAO (Afrique de l'Ouest)</option>
                                                    <option value="XAF">XAF - Franc CFA BEAC (Afrique Centrale)</option>
                                                    <option value="NGN">NGN - Naira nig&#233;rian</option>
                                                    <option value="ZAR">ZAR - Rand sud-africain</option>
                                                    <option value="EGP">EGP - Livre &#233;gyptienne</option>
                                                    <option value="MAD">MAD - Dirham marocain</option>
                                                    <option value="DZD">DZD - Dinar alg&#233;rien</option>
                                                    <option value="TND">TND - Dinar tunisien</option>
                                                    <option value="KES">KES - Shilling kenyan</option>
                                                    <option value="GHS">GHS - Cedi ghan&#233;en</option>
                                                    <option value="ETB">ETB - Birr &#233;thiopien</option>
                                                    <option value="TZS">TZS - Shilling tanzanien</option>
                                                    <option value="UGX">UGX - Shilling ougandais</option>
                                                    <option value="RWF">RWF - Franc rwandais</option>
                                                    <option value="BIF">BIF - Franc burundais</option>
                                                    <option value="CDF">CDF - Franc congolais (RDC)</option>
                                                    <option value="AOA">AOA - Kwanza angolais</option>
                                                    <option value="MZN">MZN - Metical mozambicain</option>
                                                    <option value="ZMW">ZMW - Kwacha zambien</option>
                                                    <option value="BWP">BWP - Pula botswanais</option>
                                                    <option value="MUR">MUR - Roupie mauricienne</option>
                                                    <option value="SCR">SCR - Roupie seychelloise</option>
                                                    <option value="MGA">MGA - Ariary malgache</option>
                                                    <option value="GMD">GMD - Dalasi gambien</option>
                                                    <option value="GNF">GNF - Franc guin&#233;en</option>
                                                    <option value="LRD">LRD - Dollar lib&#233;rien</option>
                                                    <option value="SLL">SLL - Leone sierra-l&#233;onais</option>
                                                    <option value="CVE">CVE - Escudo cap-verdien</option>
                                                    <option value="STN">STN - Dobra de S&#227;o Tom&#233;</option>
                                                    <option value="LYD">LYD - Dinar libyen</option>
                                                    <option value="SDG">SDG - Livre soudanaise</option>
                                                    <option value="SSP">SSP - Livre sud-soudanaise</option>
                                                    <option value="ERN">ERN - Nakfa &#233;rythr&#233;en</option>
                                                    <option value="DJF">DJF - Franc djiboutien</option>
                                                    <option value="SOS">SOS - Shilling somalien</option>
                                                    <option value="MWK">MWK - Kwacha malawien</option>
                                                    <option value="NAD">NAD - Dollar namibien</option>
                                                    <option value="SZL">SZL - Lilangeni swazi</option>
                                                    <option value="LSL">LSL - Loti lesothan</option>
                                                </optgroup>
                                                <optgroup label="&#127466;&#127482; Europe">
                                                    <option value="EUR">EUR - Euro</option>
                                                    <option value="GBP">GBP - Livre sterling</option>
                                                    <option value="CHF">CHF - Franc suisse</option>
                                                    <option value="NOK">NOK - Couronne norv&#233;gienne</option>
                                                    <option value="SEK">SEK - Couronne su&#233;doise</option>
                                                    <option value="DKK">DKK - Couronne danoise</option>
                                                    <option value="PLN">PLN - Zloty polonais</option>
                                                    <option value="CZK">CZK - Couronne tch&#232;que</option>
                                                    <option value="HUF">HUF - Forint hongrois</option>
                                                    <option value="RON">RON - Leu roumain</option>
                                                    <option value="BGN">BGN - Lev bulgare</option>
                                                    <option value="HRK">HRK - Kuna croate</option>
                                                    <option value="RSD">RSD - Dinar serbe</option>
                                                    <option value="UAH">UAH - Hryvnia ukrainienne</option>
                                                    <option value="RUB">RUB - Rouble russe</option>
                                                    <option value="TRY">TRY - Livre turque</option>
                                                    <option value="ISK">ISK - Couronne islandaise</option>
                                                    <option value="ALL">ALL - Lek albanais</option>
                                                    <option value="MKD">MKD - Denar mac&#233;donien</option>
                                                    <option value="BAM">BAM - Mark convertible bosniaque</option>
                                                    <option value="MDL">MDL - Leu moldave</option>
                                                    <option value="BYN">BYN - Rouble bi&#233;lorusse</option>
                                                </optgroup>
                                                <optgroup label="&#127462;&#127480; Am&#233;rique du Nord">
                                                    <option value="USD">USD - Dollar am&#233;ricain</option>
                                                    <option value="CAD">CAD - Dollar canadien</option>
                                                    <option value="MXN">MXN - Peso mexicain</option>
                                                    <option value="GTQ">GTQ - Quetzal guat&#233;malt&#232;que</option>
                                                    <option value="HNL">HNL - Lempira hondurien</option>
                                                    <option value="NIO">NIO - C&#243;rdoba nicaraguayen</option>
                                                    <option value="CRC">CRC - Col&#243;n costaricain</option>
                                                    <option value="PAB">PAB - Balboa panam&#233;en</option>
                                                    <option value="JMD">JMD - Dollar jama&#239;cain</option>
                                                    <option value="TTD">TTD - Dollar de Trinit&#233;-et-Tobago</option>
                                                    <option value="BBD">BBD - Dollar barbadien</option>
                                                    <option value="BSD">BSD - Dollar baham&#233;en</option>
                                                    <option value="BZD">BZD - Dollar b&#233;liz&#233;en</option>
                                                    <option value="HTG">HTG - Gourde ha&#239;tienne</option>
                                                    <option value="DOP">DOP - Peso dominicain</option>
                                                    <option value="CUP">CUP - Peso cubain</option>
                                                    <option value="XCD">XCD - Dollar des Cara&#239;bes orientales</option>
                                                </optgroup>
                                                <optgroup label="&#127463;&#127479; Am&#233;rique du Sud">
                                                    <option value="BRL">BRL - R&#233;al br&#233;silien</option>
                                                    <option value="ARS">ARS - Peso argentin</option>
                                                    <option value="CLP">CLP - Peso chilien</option>
                                                    <option value="COP">COP - Peso colombien</option>
                                                    <option value="PEN">PEN - Sol p&#233;ruvien</option>
                                                    <option value="VES">VES - Bol&#237;var v&#233;n&#233;zu&#233;lien</option>
                                                    <option value="UYU">UYU - Peso uruguayen</option>
                                                    <option value="PYG">PYG - Guarani paraguayen</option>
                                                    <option value="BOB">BOB - Boliviano bolivien</option>
                                                    <option value="GYD">GYD - Dollar guyanien</option>
                                                    <option value="SRD">SRD - Dollar surinamais</option>
                                                </optgroup>
                                                <optgroup label="&#127470;&#127475; Asie">
                                                    <option value="CNY">CNY - Yuan chinois</option>
                                                    <option value="JPY">JPY - Yen japonais</option>
                                                    <option value="KRW">KRW - Won sud-cor&#233;en</option>
                                                    <option value="INR">INR - Roupie indienne</option>
                                                    <option value="IDR">IDR - Roupie indon&#233;sienne</option>
                                                    <option value="MYR">MYR - Ringgit malaisien</option>
                                                    <option value="SGD">SGD - Dollar de Singapour</option>
                                                    <option value="THB">THB - Baht tha&#239;landais</option>
                                                    <option value="VND">VND - Dong vietnamien</option>
                                                    <option value="PHP">PHP - Peso philippin</option>
                                                    <option value="HKD">HKD - Dollar de Hong Kong</option>
                                                    <option value="TWD">TWD - Dollar ta&#239;wanais</option>
                                                    <option value="PKR">PKR - Roupie pakistanaise</option>
                                                    <option value="BDT">BDT - Taka bangladais</option>
                                                    <option value="LKR">LKR - Roupie sri-lankaise</option>
                                                    <option value="NPR">NPR - Roupie n&#233;palaise</option>
                                                    <option value="MMK">MMK - Kyat birman</option>
                                                    <option value="KHR">KHR - Riel cambodgien</option>
                                                    <option value="LAK">LAK - Kip laotien</option>
                                                    <option value="MNT">MNT - Tugrik mongol</option>
                                                    <option value="KZT">KZT - Tenge kazakh</option>
                                                    <option value="UZS">UZS - Sum ouzb&#232;ke</option>
                                                </optgroup>
                                                <optgroup label="&#127312;&#127466; Moyen-Orient">
                                                    <option value="AED">AED - Dirham des &#201;mirats</option>
                                                    <option value="SAR">SAR - Riyal saoudien</option>
                                                    <option value="QAR">QAR - Riyal qatari</option>
                                                    <option value="KWD">KWD - Dinar kowe&#239;tien</option>
                                                    <option value="BHD">BHD - Dinar bahre&#239;ni</option>
                                                    <option value="OMR">OMR - Rial omanais</option>
                                                    <option value="JOD">JOD - Dinar jordanien</option>
                                                    <option value="LBP">LBP - Livre libanaise</option>
                                                    <option value="ILS">ILS - Shekel isra&#233;lien</option>
                                                    <option value="IRR">IRR - Rial iranien</option>
                                                    <option value="IQD">IQD - Dinar irakien</option>
                                                    <option value="SYP">SYP - Livre syrienne</option>
                                                    <option value="YER">YER - Rial y&#233;m&#233;nite</option>
                                                </optgroup>
                                                <optgroup label="&#127462;&#127482; Oc&#233;anie">
                                                    <option value="AUD">AUD - Dollar australien</option>
                                                    <option value="NZD">NZD - Dollar n&#233;o-z&#233;landais</option>
                                                    <option value="FJD">FJD - Dollar fidjien</option>
                                                    <option value="PGK">PGK - Kina papou</option>
                                                    <option value="SBD">SBD - Dollar des &#238;les Salomon</option>
                                                    <option value="VUV">VUV - Vatu vanuatuan</option>
                                                    <option value="WST">WST - Tala samoan</option>
                                                    <option value="TOP">TOP - Pa'anga tongien</option>
                                                    <option value="XPF">XPF - Franc CFP (Pacifique)</option>
                                                </optgroup>
                                                <optgroup label="&#128176; Crypto-monnaies">
                                                    <option value="BTC">BTC - Bitcoin</option>
                                                    <option value="ETH">ETH - Ethereum</option>
                                                    <option value="USDT">USDT - Tether USD</option>
                                                    <option value="USDC">USDC - USD Coin</option>
                                                </optgroup>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2">Fuseau horaire</label>
                                            <select class="w-full px-4 py-3 rounded-xl border border-slate-200"
                                                onchange="App.onboardingSet('timezone', this.value)">
                                                <optgroup label="&#127464;&#127758; Afrique">
                                                    <option value="Africa/Abidjan">Abidjan (UTC+0)</option>
                                                    <option value="Africa/Accra">Accra (UTC+0)</option>
                                                    <option value="Africa/Addis_Ababa">Addis-Abeba (UTC+3)</option>
                                                    <option value="Africa/Algiers">Alger (UTC+1)</option>
                                                    <option value="Africa/Bamako">Bamako (UTC+0)</option>
                                                    <option value="Africa/Bangui">Bangui (UTC+1)</option>
                                                    <option value="Africa/Banjul">Banjul (UTC+0)</option>
                                                    <option value="Africa/Bissau">Bissau (UTC+0)</option>
                                                    <option value="Africa/Blantyre">Blantyre (UTC+2)</option>
                                                    <option value="Africa/Brazzaville">Brazzaville (UTC+1)</option>
                                                    <option value="Africa/Bujumbura">Bujumbura (UTC+2)</option>
                                                    <option value="Africa/Cairo">Le Caire (UTC+2)</option>
                                                    <option value="Africa/Casablanca">Casablanca (UTC+1)</option>
                                                    <option value="Africa/Conakry">Conakry (UTC+0)</option>
                                                    <option value="Africa/Dakar">Dakar (UTC+0)</option>
                                                    <option value="Africa/Dar_es_Salaam">Dar es Salaam (UTC+3)</option>
                                                    <option value="Africa/Djibouti">Djibouti (UTC+3)</option>
                                                    <option value="Africa/Douala">Douala (UTC+1)</option>
                                                    <option value="Africa/Freetown">Freetown (UTC+0)</option>
                                                    <option value="Africa/Gaborone">Gaborone (UTC+2)</option>
                                                    <option value="Africa/Harare">Harare (UTC+2)</option>
                                                    <option value="Africa/Johannesburg">Johannesburg (UTC+2)</option>
                                                    <option value="Africa/Juba">Juba (UTC+2)</option>
                                                    <option value="Africa/Kampala">Kampala (UTC+3)</option>
                                                    <option value="Africa/Khartoum">Khartoum (UTC+2)</option>
                                                    <option value="Africa/Kigali">Kigali (UTC+2)</option>
                                                    <option value="Africa/Kinshasa">Kinshasa (UTC+1)</option>
                                                    <option value="Africa/Lagos">Lagos (UTC+1)</option>
                                                    <option value="Africa/Libreville">Libreville (UTC+1)</option>
                                                    <option value="Africa/Lome">Lom&#233; (UTC+0)</option>
                                                    <option value="Africa/Luanda">Luanda (UTC+1)</option>
                                                    <option value="Africa/Lubumbashi">Lubumbashi (UTC+2)</option>
                                                    <option value="Africa/Lusaka">Lusaka (UTC+2)</option>
                                                    <option value="Africa/Malabo">Malabo (UTC+1)</option>
                                                    <option value="Africa/Maputo">Maputo (UTC+2)</option>
                                                    <option value="Africa/Maseru">Maseru (UTC+2)</option>
                                                    <option value="Africa/Mbabane">Mbabane (UTC+2)</option>
                                                    <option value="Africa/Mogadishu">Mogadiscio (UTC+3)</option>
                                                    <option value="Africa/Monrovia">Monrovia (UTC+0)</option>
                                                    <option value="Africa/Nairobi">Nairobi (UTC+3)</option>
                                                    <option value="Africa/Ndjamena">N'Djamena (UTC+1)</option>
                                                    <option value="Africa/Niamey">Niamey (UTC+1)</option>
                                                    <option value="Africa/Nouakchott">Nouakchott (UTC+0)</option>
                                                    <option value="Africa/Ouagadougou">Ouagadougou (UTC+0)</option>
                                                    <option value="Africa/Porto-Novo">Porto-Novo (UTC+1)</option>
                                                    <option value="Africa/Sao_Tome">S&#227;o Tom&#233; (UTC+0)</option>
                                                    <option value="Africa/Tripoli">Tripoli (UTC+2)</option>
                                                    <option value="Africa/Tunis">Tunis (UTC+1)</option>
                                                    <option value="Africa/Windhoek">Windhoek (UTC+2)</option>
                                                </optgroup>
                                                <optgroup label="&#127466;&#127482; Europe">
                                                    <option value="Europe/Amsterdam">Amsterdam (UTC+1)</option>
                                                    <option value="Europe/Athens">Ath&#232;nes (UTC+2)</option>
                                                    <option value="Europe/Belgrade">Belgrade (UTC+1)</option>
                                                    <option value="Europe/Berlin">Berlin (UTC+1)</option>
                                                    <option value="Europe/Brussels">Bruxelles (UTC+1)</option>
                                                    <option value="Europe/Bucharest">Bucarest (UTC+2)</option>
                                                    <option value="Europe/Budapest">Budapest (UTC+1)</option>
                                                    <option value="Europe/Copenhagen">Copenhague (UTC+1)</option>
                                                    <option value="Europe/Dublin">Dublin (UTC+0)</option>
                                                    <option value="Europe/Helsinki">Helsinki (UTC+2)</option>
                                                    <option value="Europe/Istanbul">Istanbul (UTC+3)</option>
                                                    <option value="Europe/Kiev">Kiev (UTC+2)</option>
                                                    <option value="Europe/Lisbon">Lisbonne (UTC+0)</option>
                                                    <option value="Europe/London">Londres (UTC+0)</option>
                                                    <option value="Europe/Luxembourg">Luxembourg (UTC+1)</option>
                                                    <option value="Europe/Madrid">Madrid (UTC+1)</option>
                                                    <option value="Europe/Monaco">Monaco (UTC+1)</option>
                                                    <option value="Europe/Moscow">Moscou (UTC+3)</option>
                                                    <option value="Europe/Oslo">Oslo (UTC+1)</option>
                                                    <option value="Europe/Paris">Paris (UTC+1)</option>
                                                    <option value="Europe/Prague">Prague (UTC+1)</option>
                                                    <option value="Europe/Rome">Rome (UTC+1)</option>
                                                    <option value="Europe/Stockholm">Stockholm (UTC+1)</option>
                                                    <option value="Europe/Vienna">Vienne (UTC+1)</option>
                                                    <option value="Europe/Warsaw">Varsovie (UTC+1)</option>
                                                    <option value="Europe/Zurich">Zurich (UTC+1)</option>
                                                </optgroup>
                                                <optgroup label="&#127462;&#127480; Am&#233;rique du Nord">
                                                    <option value="America/Chicago">Chicago (UTC-6)</option>
                                                    <option value="America/Denver">Denver (UTC-7)</option>
                                                    <option value="America/Los_Angeles">Los Angeles (UTC-8)</option>
                                                    <option value="America/Mexico_City">Mexico (UTC-6)</option>
                                                    <option value="America/Montreal">Montr&#233;al (UTC-5)</option>
                                                    <option value="America/New_York">New York (UTC-5)</option>
                                                    <option value="America/Phoenix">Phoenix (UTC-7)</option>
                                                    <option value="America/Toronto">Toronto (UTC-5)</option>
                                                    <option value="America/Vancouver">Vancouver (UTC-8)</option>
                                                </optgroup>
                                                <optgroup label="&#127463;&#127479; Am&#233;rique du Sud">
                                                    <option value="America/Argentina/Buenos_Aires">Buenos Aires (UTC-3)</option>
                                                    <option value="America/Bogota">Bogota (UTC-5)</option>
                                                    <option value="America/Caracas">Caracas (UTC-4)</option>
                                                    <option value="America/Lima">Lima (UTC-5)</option>
                                                    <option value="America/Santiago">Santiago (UTC-4)</option>
                                                    <option value="America/Sao_Paulo">S&#227;o Paulo (UTC-3)</option>
                                                </optgroup>
                                                <optgroup label="&#127470;&#127475; Asie">
                                                    <option value="Asia/Baghdad">Bagdad (UTC+3)</option>
                                                    <option value="Asia/Bangkok">Bangkok (UTC+7)</option>
                                                    <option value="Asia/Beirut">Beyrouth (UTC+2)</option>
                                                    <option value="Asia/Dhaka">Dhaka (UTC+6)</option>
                                                    <option value="Asia/Dubai">Duba&#239; (UTC+4)</option>
                                                    <option value="Asia/Ho_Chi_Minh">Ho Chi Minh (UTC+7)</option>
                                                    <option value="Asia/Hong_Kong">Hong Kong (UTC+8)</option>
                                                    <option value="Asia/Jakarta">Jakarta (UTC+7)</option>
                                                    <option value="Asia/Jerusalem">J&#233;rusalem (UTC+2)</option>
                                                    <option value="Asia/Karachi">Karachi (UTC+5)</option>
                                                    <option value="Asia/Kolkata">Calcutta (UTC+5:30)</option>
                                                    <option value="Asia/Kuala_Lumpur">Kuala Lumpur (UTC+8)</option>
                                                    <option value="Asia/Kuwait">Kowe&#239;t (UTC+3)</option>
                                                    <option value="Asia/Manila">Manille (UTC+8)</option>
                                                    <option value="Asia/Riyadh">Riyad (UTC+3)</option>
                                                    <option value="Asia/Seoul">S&#233;oul (UTC+9)</option>
                                                    <option value="Asia/Shanghai">Shanghai (UTC+8)</option>
                                                    <option value="Asia/Singapore">Singapour (UTC+8)</option>
                                                    <option value="Asia/Taipei">Taipei (UTC+8)</option>
                                                    <option value="Asia/Tehran">T&#233;h&#233;ran (UTC+3:30)</option>
                                                    <option value="Asia/Tokyo">Tokyo (UTC+9)</option>
                                                </optgroup>
                                                <optgroup label="&#127462;&#127482; Oc&#233;anie">
                                                    <option value="Australia/Adelaide">Adelaide (UTC+9:30)</option>
                                                    <option value="Australia/Brisbane">Brisbane (UTC+10)</option>
                                                    <option value="Australia/Melbourne">Melbourne (UTC+10)</option>
                                                    <option value="Australia/Perth">Perth (UTC+8)</option>
                                                    <option value="Australia/Sydney">Sydney (UTC+10)</option>
                                                    <option value="Pacific/Auckland">Auckland (UTC+12)</option>
                                                    <option value="Pacific/Fiji">Fidji (UTC+12)</option>
                                                    <option value="Pacific/Honolulu">Honolulu (UTC-10)</option>
                                                    <option value="Pacific/Noumea">Noum&#233;a (UTC+11)</option>
                                                    <option value="Pacific/Tahiti">Tahiti (UTC-10)</option>
                                                </optgroup>
                                                <optgroup label="&#127757; Autres">
                                                    <option value="UTC">UTC (UTC+0)</option>
                                                    <option value="Atlantic/Azores">A&#231;ores (UTC-1)</option>
                                                    <option value="Atlantic/Canary">&#206;les Canaries (UTC+0)</option>
                                                    <option value="Atlantic/Cape_Verde">Cap-Vert (UTC-1)</option>
                                                    <option value="Atlantic/Reykjavik">Reykjavik (UTC+0)</option>
                                                    <option value="Indian/Antananarivo">Antananarivo (UTC+3)</option>
                                                    <option value="Indian/Mauritius">Maurice (UTC+4)</option>
                                                    <option value="Indian/Reunion">La R&#233;union (UTC+4)</option>
                                                </optgroup>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2">Ville principale</label>
                                            <input type="text" placeholder="Abidjan"
                                                class="w-full px-4 py-3 rounded-xl border border-slate-200"
                                                oninput="App.onboardingSet('city', this.value)">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2">Point de vente</label>
                                            <input type="text" placeholder="Boutique Plateau"
                                                class="w-full px-4 py-3 rounded-xl border border-slate-200"
                                                oninput="App.onboardingSet('pos', this.value)">
                                        </div>
                                    </div>
                                    <button class="w-full p-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold" onclick="App.onboardingSubmitCreate()">Creer l'entreprise</button>
                                    <button class="text-sm text-slate-500 hover:text-slate-700" onclick="App.onboardingGo(2)">Retour</button>
                                </div>
                            ` : ''}

                            ${step === 4 ? `
                                <div class="space-y-4">
                                    <h2 class="text-lg font-semibold text-slate-900">Rejoindre une entreprise</h2>
                                    <div>
                                        <label class="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2">Code entreprise / invitation</label>
                                        <input type="text" placeholder="ABC-123"
                                            class="w-full px-4 py-3 rounded-xl border border-slate-200"
                                            oninput="App.onboardingSet('joinCode', this.value)">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2">Votre nom</label>
                                        <input type="text" placeholder="Nom complet"
                                            class="w-full px-4 py-3 rounded-xl border border-slate-200"
                                            oninput="App.onboardingSet('fullName', this.value)">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-2">Mot de passe</label>
                                        <input type="password" placeholder="********"
                                            class="w-full px-4 py-3 rounded-xl border border-slate-200"
                                            oninput="App.onboardingSet('password', this.value)">
                                    </div>
                                    <button class="w-full p-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold" onclick="App.onboardingSubmitJoin()">Envoyer la demande</button>
                                    <button class="text-sm text-slate-500 hover:text-slate-700" onclick="App.onboardingGo(2)">Retour</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `);
        },

        mount(html) {
            const root = document.getElementById('app');
            root.innerHTML = html;
            lucide.createIcons();

            try {
                const company = CORE.getCompanyName() || 'Entreprise';
                document.title = `${company} OS - Enterprise Nervous System`;
            } catch (e) {}

            // Normaliser les textes anglais vers le fran��ais si n�cessaire
            try { i18n.autoTranslateDom(root); } catch (e) {}
            
            // R�appliquer le th��me apr��s le montage
            const role = CORE.state.currentUser?.role;
            if (role === 'vendeur' && VendeurModule?.applyTheme) {
                VendeurModule.applyTheme();
            } else if (role === 'gestionnaire' && GestionnaireModule?.applyTheme) {
                GestionnaireModule.applyTheme();
            } else if (role === 'manager' && ManagerModule?.applyTheme) {
                ManagerModule.applyTheme();
            } else if (role === 'pdg' && PDGModule?.applyTheme) {
                PDGModule.applyTheme();
            } else if (role === 'livreur' && LivreurModule?.applyTheme) {
                LivreurModule.applyTheme();
            }
            
            // Restaurer le focus et la valeur sur le champ de recherche livreurs si present
            setTimeout(() => {
                const livreursSearchInput = document.getElementById('livreurs-search-input');
                if (livreursSearchInput && VendeurModule?.state?.livreursSearch) {
                    livreursSearchInput.value = VendeurModule.state.livreursSearch;
                    livreursSearchInput.focus();
                }
            }, 10);
            
            // Apply data-width to elements
            setTimeout(() => {
                document.querySelectorAll('[data-width]').forEach(el => {
                    el.style.width = el.dataset.width + '%';
                });
            }, 50);
            
            // Attacher le gestionnaire du bouton settings
            const settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const role = CORE.state.currentUser?.role;
                    console.log('Settings button clicked, role:', role);
                    try {
                        if (role === 'vendeur') {
                            console.log('Calling VendeurModule.showSettingsModal');
                            VendeurModule.showSettingsModal.call(VendeurModule);
                        }
                        else if (role === 'gestionnaire') GestionnaireModule.showSettingsModal.call(GestionnaireModule);
                        else if (role === 'livreur') LivreurModule.navigateTo('settings');
                        else if (role === 'manager') ManagerModule.showSettingsModal.call(ManagerModule);
                        else if (role === 'pdg') PDGModule.showSettingsModal.call(PDGModule);
                    } catch(err) {
                        console.error('Error opening settings:', err);
                        console.error('Stack:', err.stack);
                        UI.toast('Erreur: ' + err.message, 'error');
                    }
                }, false);
            }
            
            // Google Maps: init if present in view
            try { Maps.afterRender(); } catch(e) {}
        },

        renderLogin() {
            this.mount(`
                <div class="min-h-screen bg-slate-50 flex items-center justify-center p-6">
                    <div class="w-full max-w-md">
                        <div class="text-center mb-8">
                            <div class="mx-auto h-14 w-14 rounded-2xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white text-xl font-bold shadow-lg shadow-emerald-500/30">R</div>
                            <h1 class="mt-5 text-2xl font-bold text-slate-900">Bienvenue sur RAYA</h1>
                            <p class="mt-2 text-slate-500">G�rez votre boutique en toute simplicit�</p>
                            <div class="mt-3 flex items-center justify-center gap-2 text-xs text-slate-400">
                                <span class="flex items-center gap-1">
                                    <svg class="w-3.5 h-3.5 text-emerald-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                                    S�curis�
                                </span>
                                <span class="text-slate-300"></span>
                                <span class="flex items-center gap-1">
                                    <svg class="w-3.5 h-3.5 text-emerald-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/></svg>
                                    Rapide
                                </span>
                                <span class="text-slate-300"></span>
                                <span class="flex items-center gap-1">
                                    <svg class="w-3.5 h-3.5 text-emerald-500" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"/><path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"/></svg>
                                    Hors-ligne
                                </span>
                            </div>
                        </div>
                            <div class="text-right">
                                <div class="text-3xl font-black">�� � � ${avgRating}</div>
                                <div class="text-xs text-red-100">${ratedDeliveries.length} �valuations</div>
                            </div>
                        </div>
                    </div>

                    <!-- STATISTIQUES PRINCIPALES (4 CARTES) -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <!-- CARTE 1: AUJOURD'HUI -->
                        <div class="bg-white border border-slate-200 p-5 rounded-2xl hover:shadow-lg transition">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <div class="text-xs font-black text-slate-500 uppercase">Aujourd'hui</div>
                                    <div class="text-3xl font-black text-blue-600 mt-2">${completedToday}</div>
                                    <div class="text-xs text-slate-600 mt-1">Livraisons termin�es</div>
                                </div>
                                <div class="text-3xl">��Ÿ? �</div>
                            </div>
                            <div class="text-xs text-slate-500">
                                <span class="font-bold text-amber-600">${pendingToday}</span> en attente
                            </div>
                        </div>

                        <!-- CARTE 2: CE MOIS -->
                        <div class="bg-white border border-slate-200 p-5 rounded-2xl hover:shadow-lg transition">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <div class="text-xs font-black text-slate-500 uppercase">Ce mois</div>
                                    <div class="text-3xl font-black text-emerald-600 mt-2">${thisMonth}</div>
                                    <div class="text-xs text-slate-600 mt-1">Total livraisons</div>
                                </div>
                                <div class="text-3xl">��Ÿ?�?</div>
                            </div>
                            <div class="text-xs text-slate-500">
                                <span class="font-bold text-emerald-600">${lastMonth}</span> le mois dernier
                            </div>
                        </div>

                        <!-- CARTE 3: REVENUS -->
                        <div class="bg-white border border-slate-200 p-5 rounded-2xl hover:shadow-lg transition">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <div class="text-xs font-black text-slate-500 uppercase">Revenus</div>
                                    <div class="text-3xl font-black text-purple-600 mt-2">${thisMonthEarnings.toFixed(2)}$</div>
                                    <div class="text-xs text-slate-600 mt-1">Ce mois</div>
                                </div>
                                <div class="text-3xl">��Ÿ? �</div>
                            </div>
                            <div class="text-xs text-slate-500">
                                <span class="font-bold text-purple-600">${todayEarnings.toFixed(2)}$</span> aujourd'hui
                            </div>
                        </div>

                        <!-- CARTE 4: PERFORMANCE -->
                        <div class="bg-white border border-slate-200 p-5 rounded-2xl hover:shadow-lg transition">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <div class="text-xs font-black text-slate-500 uppercase">Performance</div>
                                    <div class="text-3xl font-black text-indigo-600 mt-2">${deliverySuccessRate}%</div>
                                    <div class="text-xs text-slate-600 mt-1">Taux de r�ussite</div>
                                </div>
                                <div class="text-3xl">��ŸŽ �</div>
                            </div>
                            <div class="text-xs text-slate-500">
                                <span class="font-bold text-indigo-600">${avgDeliveriesPerDay}</span> par jour
                            </div>
                        </div>
                    </div>

                    <!-- SECTION: NOTES DES CLIENTS -->
                    <div class="bg-white border border-slate-200 p-5 rounded-2xl">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-black text-slate-900">�� � � Satisfaction clients</h3>
                            <span class="text-xs font-black bg-amber-100 text-amber-700 px-2 py-1 rounded">${ratedDeliveries.length} avis</span>
                        </div>
                        <div class="space-y-3">
                            <div class="flex items-center gap-3">
                                <span class="text-sm font-bold min-w-fit">5 �� � �</span>
                                <div class="flex-1 bg-slate-100 rounded-full h-2">
                                    <div class="bg-emerald-500 h-2 rounded-full progress-bar" data-width="${ratedDeliveries.length > 0 ? (fiveStarCount / ratedDeliveries.length * 100) : 0}"></div>
                                </div>
                                <span class="text-sm font-bold min-w-fit">${fiveStarCount}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-sm font-bold min-w-fit">4 �� � �</span>
                                <div class="flex-1 bg-slate-100 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full progress-bar" data-width="${ratedDeliveries.length > 0 ? (fourStarCount / ratedDeliveries.length * 100) : 0}"></div>
                                </div>
                                <span class="text-sm font-bold min-w-fit">${fourStarCount}</span>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION: LIVRAISONS EN ATTENTE -->
                    ${recentDeliveries.length > 0 ? `
                    <div class="bg-white border border-slate-200 p-5 rounded-2xl">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-black text-slate-900">��Ÿšš Commandes en attente</h3>
                            <span class="text-xs font-black bg-blue-100 text-blue-700 px-2 py-1 rounded">${recentDeliveries.length}</span>
                        </div>
                        <div class="space-y-2">
                            ${recentHTML}
                        </div>
                    </div>
                    ` : ''}

                    <!-- SECTION: ACC�?S RAPIDE AUX 5 FONCTIONNALIT�S -->
                    <div class="bg-slate-50 border border-slate-200 p-5 rounded-2xl">
                        <h3 class="font-black text-slate-900 mb-4">��š � Acc��s rapide</h3>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                            <button onclick="CourierModule.showDeliveryHistory()" class="p-4 bg-white border border-slate-200 rounded-xl hover:shadow-lg hover:border-blue-300 transition text-center group">
                                <div class="text-3xl mb-2 group-hover:scale-110 transition">��Ÿ? �</div>
                                <div class="text-xs font-bold text-slate-900">Historique</div>
                                <div class="text-[10px] text-slate-500 mt-1">20 derni��res</div>
                            </button>
                            <button onclick="CourierModule.showCourierRatings()" class="p-4 bg-white border border-slate-200 rounded-xl hover:shadow-lg hover:border-amber-300 transition text-center group">
                                <div class="text-3xl mb-2 group-hover:scale-110 transition">�� � �</div>
                                <div class="text-xs font-bold text-slate-900">Notes</div>
                                <div class="text-[10px] text-slate-500 mt-1">${ratedDeliveries.length} �valuations</div>
                            </button>
                            <button onclick="CourierModule.showDocumentsManagement()" class="p-4 bg-white border border-slate-200 rounded-xl hover:shadow-lg hover:border-indigo-300 transition text-center group">
                                <div class="text-3xl mb-2 group-hover:scale-110 transition">��Ÿ??</div>
                                <div class="text-xs font-bold text-slate-900">Documents</div>
                                <div class="text-[10px] text-slate-500 mt-1">3 fichiers</div>
                            </button>
                            <button onclick="CourierModule.showVehicleManagement()" class="p-4 bg-white border border-slate-200 rounded-xl hover:shadow-lg hover:border-red-300 transition text-center group">
                                <div class="text-3xl mb-2 group-hover:scale-110 transition">��Ÿš?</div>
                                <div class="text-xs font-bold text-slate-900">V�hicule</div>
                                <div class="text-[10px] text-slate-500 mt-1">${user.vehicle || 'N/A'}</div>
                            </button>
                            <button onclick="CourierModule.showFinancialStats()" class="p-4 bg-white border border-slate-200 rounded-xl hover:shadow-lg hover:border-purple-300 transition text-center group">
                                <div class="text-3xl mb-2 group-hover:scale-110 transition">��Ÿ? �</div>
                                <div class="text-xs font-bold text-slate-900">Finances</div>
                                <div class="text-[10px] text-slate-500 mt-1">${totalEarnings.toFixed(2)}$</div>
                            </button>
                        </div>
                    </div>

                    <!-- SECTION: R�SUM� GLOBAL -->
                    <div class="bg-gradient-to-r from-slate-100 to-slate-50 border border-slate-200 p-5 rounded-2xl">
                        <h3 class="font-black text-slate-900 mb-4">��Ÿ?Š R�sum� global</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div class="p-3 bg-white rounded-lg border border-slate-100">
                                <div class="text-xs text-slate-600 font-bold uppercase">Total livraisons</div>
                                <div class="text-2xl font-black text-slate-900 mt-1">${deliveries.length}</div>
                            </div>
                            <div class="p-3 bg-white rounded-lg border border-slate-100">
                                <div class="text-xs text-slate-600 font-bold uppercase">Compl�t�es</div>
                                <div class="text-2xl font-black text-emerald-600 mt-1">${completedDeliveries.length}</div>
                            </div>
                            <div class="p-3 bg-white rounded-lg border border-slate-100">
                                <div class="text-xs text-slate-600 font-bold uppercase">Total gagn�</div>
                                <div class="text-2xl font-black text-purple-600 mt-1">${totalEarnings.toFixed(2)}$</div>
                            </div>
                            <div class="p-3 bg-white rounded-lg border border-slate-100">
                                <div class="text-xs text-slate-600 font-bold uppercase">Moyenne/livr.</div>
                                <div class="text-2xl font-black text-indigo-600 mt-1">${(totalEarnings / Math.max(1, completedDeliveries.length)).toFixed(2)}$</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        showDeliveryHistory() {
            const user = CORE.state.currentUser;
            if (!user || user.role !== 'livreur') return;

            // ========== R�CUP�RATION ET TRI DES LIVRAISONS ==========
            const allDeliveries = CORE.db.deliveries.filter(d => d.livreurId === user.id);
            
            // Tri par date la plus r�cente (completedAt ou createdAt)
            const deliveries = allDeliveries
                .sort((a, b) => {
                    const dateA = new Date(a.completedAt || a.createdAt);
                    const dateB = new Date(b.completedAt || b.createdAt);
                    return dateB - dateA;
                })
                .slice(0, 20);

            // ========== STATISTIQUES ==========
            const completed = deliveries.filter(d => d.status === 'livr�').length;
            const pending = deliveries.filter(d => d.status !== 'livr�').length;
            const rated = deliveries.filter(d => d.customerRating && d.customerRating > 0).length;
            const avgRating = rated > 0 
                ? (deliveries.reduce((sum, d) => sum + (d.customerRating || 0), 0) / rated).toFixed(1)
                : 'N/A';

            // ========== GROUPAGE PAR STATUT ==========
            const statusGroups = {
                'livr�': deliveries.filter(d => d.status === 'livr�'),
                'en-cours': deliveries.filter(d => d.status === 'en-cours'),
                'assign�': deliveries.filter(d => d.status === 'assign�'),
                'annul�': deliveries.filter(d => d.status === 'annul�')
            };

            // ========== G�N�RATION HTML DES LIVRAISONS ==========
            const getStatusBadge = (status) => {
                const statusMap = {
                    'livr�': { bg: 'bg-emerald-100', text: 'text-emerald-700', icon: '���?�' },
                    'en-cours': { bg: 'bg-blue-100', text: 'text-blue-700', icon: '��Ÿšš' },
                    'assign�': { bg: 'bg-amber-100', text: 'text-amber-700', icon: '��Ÿ?�' },
                    'annul�': { bg: 'bg-red-100', text: 'text-red-700', icon: '�� ��?' }
                };
                const map = statusMap[status] || { bg: 'bg-slate-100', text: 'text-slate-700', icon: '�� �?' };
                return `<span class="px-3 py-1.5 rounded-lg text-xs font-black ${map.bg} ${map.text}">${map.icon} ${status}</span>`;
            };

            const getRatingStars = (rating) => {
                if (!rating) return '<span class="text-xs text-slate-400">Non not�</span>';
                return `<span class="text-xs font-bold">�� � � ${rating}/5</span>`;
            };

            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (date.toDateString() === today.toDateString()) {
                    return `Aujourd'hui �� ${date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
                } else if (date.toDateString() === yesterday.toDateString()) {
                    return `Hier �� ${date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
                } else {
                    return date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
                }
            };

            const deliveryItemHTML = (d, index) => `
                <div class="group p-4 bg-white border border-slate-200 rounded-xl hover:shadow-md hover:border-slate-300 transition">
                    <div class="flex items-start justify-between gap-3 mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-black text-slate-900">${d.orderRef}</span>
                                <span class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded">#${index + 1}</span>
                            </div>
                            <div class="text-sm text-slate-600 font-medium mt-1">��Ÿ? � ${d.customerName}</div>
                        </div>
                        ${getStatusBadge(d.status)}
                    </div>

                    <div class="space-y-2 mb-3 text-xs">
                        <div class="flex justify-between items-center">
                            <span class="text-slate-600">��Ÿ?� ${formatDate(d.completedAt || d.createdAt)}</span>
                            <span class="font-bold text-slate-900">${d.amount ? d.amount.toFixed(2) + '$' : '�� ?��'}</span>
                        </div>
                        ${d.address ? `<div class="text-slate-600 flex items-start gap-1"><span>��Ÿ? �</span><span class="line-clamp-1">${d.address}</span></div>` : ''}
                    </div>

                    <div class="flex items-center justify-between pt-3 border-t border-slate-100">
                        <div>
                            ${getRatingStars(d.customerRating)}
                        </div>
                        <div class="text-xs text-slate-500">
                            ${d.notes ? `��Ÿ? � ${d.notes.substring(0, 20)}...` : 'Sans note'}
                        </div>
                    </div>
                </div>
            `;

            // ========== G�N�RATION DU MODAL COMPLET ==========
            const historyHTML = deliveries.length === 0
                ? '<div class="text-center py-8 text-slate-400"><div class="text-3xl mb-2">��Ÿ? �</div>Aucune livraison</div>'
                : deliveries.map((d, idx) => deliveryItemHTML(d, idx)).join('');

            const modalContent = `
                <div class="space-y-4">
                    <!-- SECTION: STATISTIQUES -->
                    <div class="grid grid-cols-4 gap-2">
                        <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-lg text-center">
                            <div class="text-lg font-black text-emerald-700">${completed}</div>
                            <div class="text-xs text-emerald-600 font-bold">Compl�t�es</div>
                        </div>
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-center">
                            <div class="text-lg font-black text-blue-700">${pending}</div>
                            <div class="text-xs text-blue-600 font-bold">En attente</div>
                        </div>
                        <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-center">
                            <div class="text-lg font-black text-amber-700">${rated}</div>
                            <div class="text-xs text-amber-600 font-bold">Not�es</div>
                        </div>
                        <div class="p-3 bg-purple-50 border border-purple-200 rounded-lg text-center">
                            <div class="text-lg font-black text-purple-700">�� � � ${avgRating}</div>
                            <div class="text-xs text-purple-600 font-bold">Moyenne</div>
                        </div>
                    </div>

                    <!-- SECTION: FILTRES PAR STATUT -->
                    <div class="flex gap-2 pb-3 border-b border-slate-200">
                        <button onclick="this.parentElement.querySelectorAll('.delivery-item').forEach(e => e.style.display='block'); this.classList.add('bg-slate-900', 'text-white'); this.parentElement.querySelectorAll('button').forEach(b => { if (b !== this) b.classList.remove('bg-slate-900', 'text-white'); })" class="px-3 py-1.5 bg-slate-900 text-white text-xs font-bold rounded-lg transition">
                            ��Ÿ? � Tous (${deliveries.length})
                        </button>
                        ${completed > 0 ? `<button onclick="this.parentElement.parentElement.querySelectorAll('.delivery-item').forEach(e => e.classList.contains('status-livr�') ? e.style.display='block' : e.style.display='none'); this.classList.add('bg-slate-900', 'text-white'); this.parentElement.querySelectorAll('button').forEach(b => { if (b !== this) b.classList.remove('bg-slate-900', 'text-white'); })" class="px-3 py-1.5 bg-slate-100 text-slate-700 text-xs font-bold rounded-lg hover:bg-slate-200 transition">���?� Livraisons (${completed})</button>` : ''}
                        ${pending > 0 ? `<button onclick="this.parentElement.parentElement.querySelectorAll('.delivery-item').forEach(e => !e.classList.contains('status-livr�') ? e.style.display='block' : e.style.display='none'); this.classList.add('bg-slate-900', 'text-white'); this.parentElement.querySelectorAll('button').forEach(b => { if (b !== this) b.classList.remove('bg-slate-900', 'text-white'); })" class="px-3 py-1.5 bg-slate-100 text-slate-700 text-xs font-bold rounded-lg hover:bg-slate-200 transition">��Ÿ�? En attente (${pending})</button>` : ''}
                    </div>

                    <!-- SECTION: LISTE DES LIVRAISONS -->
                    <div class="space-y-3 max-h-[65vh] overflow-y-auto pr-2">
                        ${deliveries.map((d, idx) => `
                            <div class="delivery-item status-${d.status}">
                                ${deliveryItemHTML(d, idx)}
                            </div>
                        `).join('')}
                    </div>

                    <!-- SECTION: R�SUM� D�TAILL� -->
                    <div class="bg-slate-50 border border-slate-200 p-4 rounded-xl text-sm">
                        <div class="font-black text-slate-900 mb-3">��Ÿ?Š R�sum�</div>
                        <div class="grid grid-cols-2 gap-3 text-xs">
                            <div>
                                <span class="text-slate-600">Total livraisons:</span>
                                <div class="font-bold text-slate-900">${allDeliveries.length}</div>
                            </div>
                            <div>
                                <span class="text-slate-600">Taux de r�ussite:</span>
                                <div class="font-bold text-emerald-600">${((completed / deliveries.length) * 100 || 0).toFixed(0)}%</div>
                            </div>
                            <div>
                                <span class="text-slate-600">Derni��re livraison:</span>
                                <div class="font-bold text-slate-900">${deliveries[0] ? formatDate(deliveries[0].completedAt || deliveries[0].createdAt) : '�� ?��'}</div>
                            </div>
                            <div>
                                <span class="text-slate-600">Satisfaction:</span>
                                <div class="font-bold text-amber-600">${avgRating !== 'N/A' ? avgRating + '/5' : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            UI.modal(`��Ÿ? � Historique de livraisons - 20 derni��res`, modalContent, [
                { label: 'Exporter', onclick: 'alert("Fonctionnalit� �� impl�menter")', class: 'px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            lucide.createIcons();
        },

        showDocumentsManagement() {
            const user = CORE.state.currentUser;
            if (!user || user.role !== 'livreur') return;

            // ========== DONN�ES DES DOCUMENTS ==========
            const documents = {
                license: {
                    name: 'Permis de conduire',
                    icon: '��Ÿ?�',
                    number: user.licenseNumber || 'Non renseign�',
                    expiry: user.licenseExpiry || 'Non renseign�',
                    status: user.licenseExpiry && new Date(user.licenseExpiry) > new Date() ? 'Valide' : 'Expir�',
                    uploaded: user.licenseUploadedAt ? new Date(user.licenseUploadedAt).toLocaleDateString('fr-FR') : 'Non t�l�charg�',
                    fileName: user.licenseFileName || 'permis_conduire.pdf',
                    size: user.licenseSize || '2.3 MB'
                },
                insurance: {
                    name: 'Assurance v�hicule',
                    icon: '��Ÿ� ��� � �',
                    number: user.insuranceNumber || 'Non renseign�',
                    expiry: user.insuranceExpiry || 'Non renseign�',
                    status: user.insuranceExpiry && new Date(user.insuranceExpiry) > new Date() ? 'Valide' : 'Expir�',
                    uploaded: user.insuranceUploadedAt ? new Date(user.insuranceUploadedAt).toLocaleDateString('fr-FR') : 'Non t�l�charg�',
                    fileName: user.insuranceFileName || 'assurance_vehicule.pdf',
                    size: user.insuranceSize || '1.8 MB'
                },
                vehicle: {
                    name: 'Document du v�hicule',
                    icon: '��Ÿš?',
                    number: user.vehicleRegistration || 'Non renseign�',
                    plate: user.vehicle || 'Non renseign�',
                    status: 'Valide',
                    uploaded: user.vehicleUploadedAt ? new Date(user.vehicleUploadedAt).toLocaleDateString('fr-FR') : 'Non t�l�charg�',
                    fileName: user.vehicleFileName || 'document_vehicule.pdf',
                    size: user.vehicleSize || '1.5 MB'
                }
            };

            // ========== FONCTION DE RENDU D'UN DOCUMENT ==========
            const renderDocument = (doc, type) => {
                const isExpired = doc.status === 'Expir�';
                const isUploaded = doc.uploaded !== 'Non t�l�charg�';
                const expiryDate = new Date(doc.expiry);
                const daysUntilExpiry = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));

                return `
                    <div class="p-5 border-2 border-slate-200 rounded-xl hover:shadow-lg transition">
                        <!-- HEADER DOCUMENT -->
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-start gap-3">
                                <div class="text-3xl">${doc.icon}</div>
                                <div>
                                    <h4 class="font-black text-slate-900">${doc.name}</h4>
                                    <p class="text-xs text-slate-500 mt-1">Type: ${type.toUpperCase()}</p>
                                </div>
                            </div>
                            <span class="px-3 py-1.5 rounded-lg text-xs font-black ${isExpired ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'}">
                                ${isExpired ? '��š ��� � � EXPIR�' : '���?� VALIDE'}
                            </span>
                        </div>

                        <!-- INFORMATIONS PRINCIPALES -->
                        <div class="bg-slate-50 p-4 rounded-lg mb-4 space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-600">��Ÿ� � Num�ro:</span>
                                <span class="font-bold text-slate-900">${doc.number}</span>
                            </div>
                            ${type !== 'vehicle' ? `
                            <div class="flex justify-between">
                                <span class="text-slate-600">��Ÿ?� Expiration:</span>
                                <span class="font-bold ${isExpired ? 'text-red-700' : 'text-slate-900'}">${doc.expiry}</span>
                            </div>
                            ${daysUntilExpiry !== Infinity && daysUntilExpiry > 0 && daysUntilExpiry <= 30 ? `
                            <div class="flex justify-between items-center bg-amber-50 -mx-4 -mb-2 px-4 py-2 rounded-b-lg border-t border-amber-100">
                                <span class="text-amber-600 text-xs font-bold">�� � � Expire dans ${daysUntilExpiry} jour(s)</span>
                            </div>
                            ` : ''}
                            ` : `
                            <div class="flex justify-between">
                                <span class="text-slate-600">��Ÿš? Plaque:</span>
                                <span class="font-bold text-slate-900">${doc.plate}</span>
                            </div>
                            `}
                        </div>

                        <!-- INFORMATIONS DE T�L�CHARGEMENT -->
                        <div class="grid grid-cols-2 gap-3 mb-4 text-xs">
                            <div class="p-3 bg-blue-50 border border-blue-100 rounded-lg">
                                <div class="text-blue-600 font-bold">��Ÿ? � Fichier</div>
                                <div class="text-blue-700 font-black text-lg">${isUploaded ? '���??' : '���??'}</div>
                                <div class="text-blue-600 text-[10px]">${doc.fileName}</div>
                                <div class="text-blue-500 text-[10px] mt-1">${doc.size}</div>
                            </div>
                            <div class="p-3 bg-purple-50 border border-purple-100 rounded-lg">
                                <div class="text-purple-600 font-bold">��Ÿ? � Envoy�</div>
                                <div class="text-purple-700 font-black text-lg">${isUploaded ? '���??' : '���??'}</div>
                                <div class="text-purple-600 text-[10px]">${doc.uploaded}</div>
                                ${isUploaded ? '<div class="text-purple-500 text-[10px] mt-1">Approuv� ���?�</div>' : '<div class="text-red-600 text-[10px] mt-1 font-bold">Requis</div>'}
                            </div>
                        </div>

                        <!-- BOUTONS D'ACTION -->
                        <div class="flex gap-2">
                            <button onclick="CourierModule.downloadDocument('${type}')" class="flex-1 px-4 py-2.5 bg-blue-600 text-white text-xs font-black rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                ��Ÿ? � T�l�charger
                            </button>
                            <button onclick="CourierModule.uploadDocument('${type}')" class="flex-1 px-4 py-2.5 bg-emerald-600 text-white text-xs font-black rounded-lg hover:bg-emerald-700 transition flex items-center justify-center gap-2">
                                ��Ÿ? � ${isUploaded ? 'Remplacer' : 'Envoyer'}
                            </button>
                            <button onclick="CourierModule.viewDocument('${type}')" class="px-4 py-2.5 bg-slate-200 text-slate-700 text-xs font-black rounded-lg hover:bg-slate-300 transition" title="Pr�visualiser le document">
                                ��Ÿ? ��� � �
                            </button>
                        </div>
                    </div>
                `;
            };

            // ========== G�N�RATION DU CONTENU ==========
            const modalContent = `
                <div class="space-y-5">
                    <!-- ALERTE IMPORTANTE -->
                    <div class="p-4 bg-red-50 border-l-4 border-red-500 rounded-lg">
                        <div class="flex gap-3 items-start">
                            <span class="text-xl">��š ��� � �</span>
                            <div>
                                <div class="font-black text-red-900">Documents importants</div>
                                <p class="text-sm text-red-800 mt-1">Tous les documents doivent ��tre �� jour et valides. Les documents expir�s peuvent affecter votre capacit� �� livrer.</p>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION: PERMIS DE CONDUIRE -->
                    <div>
                        <h3 class="text-sm font-black text-slate-900 mb-3">��Ÿ?� DOCUMENTS D'IDENTIT�</h3>
                        ${renderDocument(documents.license, 'license')}
                    </div>

                    <!-- SECTION: ASSURANCE -->
                    <div>
                        <h3 class="text-sm font-black text-slate-900 mb-3">��Ÿ� ��� � � COUVERTURE ASSURANCE</h3>
                        ${renderDocument(documents.insurance, 'insurance')}
                    </div>

                    <!-- SECTION: V�HICULE -->
                    <div>
                        <h3 class="text-sm font-black text-slate-900 mb-3">��Ÿš? IMMATRICULATION V�HICULE</h3>
                        ${renderDocument(documents.vehicle, 'vehicle')}
                    </div>

                    <!-- SECTION: R�SUM� DE CONFORMIT� -->
                    <div class="p-4 bg-gradient-to-r from-slate-50 to-slate-100 border border-slate-200 rounded-xl">
                        <div class="font-black text-slate-900 mb-3">���?� �tat de conformit�</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full bg-emerald-500 flex items-center justify-center text-white text-xs">���??</span>
                                <span class="text-slate-700">Permis de conduire: <span class="font-bold">${documents.license.status}</span></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full ${documents.insurance.status === 'Expir�' ? 'bg-red-500' : 'bg-emerald-500'} flex items-center justify-center text-white text-xs">���??</span>
                                <span class="text-slate-700">Assurance: <span class="font-bold">${documents.insurance.status}</span></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full bg-emerald-500 flex items-center justify-center text-white text-xs">���??</span>
                                <span class="text-slate-700">Document v�hicule: <span class="font-bold">${documents.vehicle.status}</span></span>
                            </div>
                        </div>
                        <div class="mt-3 p-2 bg-white rounded text-xs text-slate-600">
                            <span class="font-bold">���?� Profil:</span> ${documents.license.status === 'Valide' && documents.insurance.status === 'Valide' ? '��ŸŸ � CONFORME' : '��Ÿ� � �?� R�GULARISER'}
                        </div>
                    </div>

                    <!-- INFORMATION SUPPL�MENTAIRE -->
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-800">
                        <span class="font-bold">��Ÿ? � Conseil:</span> V�rifiez r�guli��rement l'expiration de vos documents. Vous recevrez une notification 30 jours avant l'expiration.
                    </div>
                </div>
            `;

            UI.modal(`��Ÿ?? Gestion des documents`, modalContent, [
                { label: 'Exporter liste', onclick: 'CourierModule.exportDocuments()', class: 'px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            lucide.createIcons();
        },

        // ========== FONCTIONS SUPPORT POUR DOCUMENTS ==========
        downloadDocument(type) {
            UI.toast(`T�l�chargement du document (${type})...`, 'info');
            // Simulation: Dans un vrai syst��me, cela d�clencherait un t�l�chargement
            setTimeout(() => {
                UI.toast(`���?� Document t�l�charg�!`, 'success');
            }, 1500);
        },

        uploadDocument(type) {
            UI.toast(`Ouverture du s�lecteur de fichier pour ${type}...`, 'info');
            // Simulation: Dans un vrai syst��me, cela ouvrirait un s�lecteur de fichier
            setTimeout(() => {
                UI.toast(`���?� Document envoy� avec succ��s!`, 'success');
                CourierModule.showDocumentsManagement();
            }, 1500);
        },

        viewDocument(type) {
            UI.toast(`Affichage du document ${type}...`, 'info');
            // Simulation: Dans un vrai syst��me, cela afficherait l'aper��u du PDF
        },

        exportDocuments() {
            UI.toast(`Export des documents en cours...`, 'info');
            setTimeout(() => {
                UI.toast(`���?� Documents export�s en ZIP!`, 'success');
            }, 2000);
        },

        showCourierRatings() {
            const user = CORE.state.currentUser;
            if (!user || user.role !== 'livreur') return;

            const deliveries = CORE.db.deliveries.filter(d => d.livreurId === user.id && d.customerRating);
            const ratings = [5, 4, 3, 2, 1].map(rate => ({
                rate,
                count: deliveries.filter(d => d.customerRating === rate).length
            }));

            const ratingsHTML = ratings.map(r => `
                <div class="flex items-center gap-3">
                    <span class="text-sm font-bold">${'�� � �'.repeat(r.rate)}</span>
                    <div class="flex-1 bg-slate-100 rounded-full h-2">
                        <div class="bg-amber-500 h-2 rounded-full progress-bar" data-width="${(r.count / deliveries.length * 100) || 0}"></div>
                    </div>
                    <span class="text-sm font-bold">${r.count}</span>
                </div>
            `).join('');

            UI.modal(`�� � � Notes des clients`, `
                <div class="space-y-4">
                    <div class="bg-gradient-to-r from-amber-100 to-amber-50 p-4 rounded-lg">
                        <div class="text-3xl font-black text-center mb-2">
                            ${(deliveries.reduce((sum, d) => sum + d.customerRating, 0) / deliveries.length).toFixed(1)} / 5
                        </div>
                        <div class="text-center text-sm text-slate-600">Bas�e sur ${deliveries.length} avis</div>
                    </div>
                    <div class="space-y-2">${ratingsHTML}</div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        // ========== GESTION DES SETTINGS GESTIONNAIRE ==========
        showGestionnaireSettings() {
            const user = CORE.state.currentUser;
            if (!user || user.role !== 'gestionnaire') return;

            // R�cup�rer les settings actuels ou initialiser
            if (!CORE.state.gestionnaireSettings) {
                CORE.state.gestionnaireSettings = {
                    deliveryPhotoValidationEnabled: true,
                    deliverySignatureEnabled: true,
                    deliveryNotesRequired: false,
                    autoOptimizeRoutes: true,
                    enableFinancialReports: true,
                    enableLiveTracking: true,
                    enableCustomerRatings: true,
                    enableDocumentManagement: true
                };
            }

            const settings = CORE.state.gestionnaireSettings;

            const settingsContent = `
                <div class="space-y-5">
                    <!-- TITRE -->
                    <div class="p-4 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl">
                        <h2 class="text-xl font-black">��š ?��� � � Param��tres de gestion</h2>
                        <p class="text-sm opacity-90 mt-1">Contr��lez les fonctionnalit�s de l'application</p>
                    </div>

                    <!-- SECTION: LIVRAISONS -->
                    <div class="p-5 border-2 border-slate-200 rounded-xl">
                        <h3 class="font-black text-slate-900 mb-4 flex items-center gap-2">
                            <span class="text-lg">��Ÿ? �</span>
                            Livraisons
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- VALIDATION PAR PHOTO -->
                            <div class="p-4 bg-slate-50 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-black text-slate-900">��Ÿ? � Validation par photo</h4>
                                    <p class="text-xs text-slate-600 mt-1">Permettre aux livreurs de valider les livraisons avec une photo de preuve</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle_photo_validation" 
                                        ${settings.deliveryPhotoValidationEnabled ? 'checked' : ''} 
                                        onchange="CourierModule.toggleFeature('deliveryPhotoValidationEnabled', this.checked)"
                                        class="sr-only peer">
                                    <div class="w-14 h-8 bg-slate-300 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-7 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all"></div>
                                </label>
                            </div>

                            <!-- SIGNATURE REQUISE -->
                            <div class="p-4 bg-slate-50 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-black text-slate-900">���? ��� � � Signature du client</h4>
                                    <p class="text-xs text-slate-600 mt-1">Demander la signature num�rique du client �� la livraison</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle_signature" 
                                        ${settings.deliverySignatureEnabled ? 'checked' : ''} 
                                        onchange="CourierModule.toggleFeature('deliverySignatureEnabled', this.checked)"
                                        class="sr-only peer">
                                    <div class="w-14 h-8 bg-slate-300 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-7 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all"></div>
                                </label>
                            </div>

                            <!-- NOTES OBLIGATOIRES -->
                            <div class="p-4 bg-slate-50 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-black text-slate-900">��Ÿ? � Notes obligatoires</h4>
                                    <p class="text-xs text-slate-600 mt-1">Exiger une note pour chaque livraison</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle_notes_required" 
                                        ${settings.deliveryNotesRequired ? 'checked' : ''} 
                                        onchange="CourierModule.toggleFeature('deliveryNotesRequired', this.checked)"
                                        class="sr-only peer">
                                    <div class="w-14 h-8 bg-slate-300 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-7 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all"></div>
                                </label>
                            </div>

                            <!-- OPTIMISATION AUTO -->
                            <div class="p-4 bg-slate-50 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-black text-slate-900">��š � Optimisation auto des routes</h4>
                                    <p class="text-xs text-slate-600 mt-1">Calculer automatiquement les itin�raires optimaux</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle_auto_optimize" 
                                        ${settings.autoOptimizeRoutes ? 'checked' : ''} 
                                        onchange="CourierModule.toggleFeature('autoOptimizeRoutes', this.checked)"
                                        class="sr-only peer">
                                    <div class="w-14 h-8 bg-slate-300 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-7 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION: RAPPORTS & DONN�ES -->
                    <div class="p-5 border-2 border-slate-200 rounded-xl">
                        <h3 class="font-black text-slate-900 mb-4 flex items-center gap-2">
                            <span class="text-lg">��Ÿ?Š</span>
                            Rapports et donn�es
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- RAPPORTS FINANCIERS -->
                            <div class="p-4 bg-slate-50 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-black text-slate-900">��Ÿ? � Rapports financiers</h4>
                                    <p class="text-xs text-slate-600 mt-1">Afficher les statistiques et rapports financiers</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle_financial_reports" 
                                        ${settings.enableFinancialReports ? 'checked' : ''} 
                                        onchange="CourierModule.toggleFeature('enableFinancialReports', this.checked)"
                                        class="sr-only peer">
                                    <div class="w-14 h-8 bg-slate-300 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-7 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all"></div>
                                </label>
                            </div>

                            <!-- SUIVI EN DIRECT -->
                            <div class="p-4 bg-slate-50 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-black text-slate-900">��Ÿ? ��� � � Suivi GPS en direct</h4>
                                    <p class="text-xs text-slate-600 mt-1">Permettre le suivi en temps r�el des livreurs</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle_live_tracking" 
                                        ${settings.enableLiveTracking ? 'checked' : ''} 
                                        onchange="CourierModule.toggleFeature('enableLiveTracking', this.checked)"
                                        class="sr-only peer">
                                    <div class="w-14 h-8 bg-slate-300 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-7 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all"></div>
                                </label>
                            </div>

                            <!-- NOTES CLIENTS -->
                            <div class="p-4 bg-slate-50 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-black text-slate-900">�� � � Notations des clients</h4>
                                    <p class="text-xs text-slate-600 mt-1">Permettre aux clients de noter les livreurs</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle_customer_ratings" 
                                        ${settings.enableCustomerRatings ? 'checked' : ''} 
                                        onchange="CourierModule.toggleFeature('enableCustomerRatings', this.checked)"
                                        class="sr-only peer">
                                    <div class="w-14 h-8 bg-slate-300 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-7 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION: DOCUMENTS & CONFORMIT� -->
                    <div class="p-5 border-2 border-slate-200 rounded-xl">
                        <h3 class="font-black text-slate-900 mb-4 flex items-center gap-2">
                            <span class="text-lg">��Ÿ??</span>
                            Documents et conformit�
                        </h3>
                        
                        <div class="space-y-4">
                            <!-- GESTION DOCUMENTS -->
                            <div class="p-4 bg-slate-50 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-black text-slate-900">��Ÿ?� Gestion des documents</h4>
                                    <p class="text-xs text-slate-600 mt-1">Permettre le suivi des documents livreurs (permis, assurance...)</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle_document_management" 
                                        ${settings.enableDocumentManagement ? 'checked' : ''} 
                                        onchange="CourierModule.toggleFeature('enableDocumentManagement', this.checked)"
                                        class="sr-only peer">
                                    <div class="w-14 h-8 bg-slate-300 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-7 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- R�SUM� DES CHANGEMENTS -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg text-sm">
                        <div class="font-black text-blue-900 mb-2">��Ÿ? � �?� savoir</div>
                        <ul class="text-xs text-blue-800 space-y-1 list-disc list-inside">
                            <li>Les modifications s'appliquent imm�diatement �� tous les livreurs</li>
                            <li>Les fonctionnalit�s d�sactiv�es seront cach�es de l'interface</li>
                            <li>Les donn�es historiques restent accessibles</li>
                            <li>Vous pouvez r�activer une fonctionnalit� �� tout moment</li>
                        </ul>
                    </div>

                    <!-- ACTIONS RAPIDES -->
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="CourierModule.enableAllFeatures()" class="px-4 py-2.5 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 transition text-sm">
                            ���?� Tout activer
                        </button>
                        <button onclick="CourierModule.disableAllFeatures()" class="px-4 py-2.5 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition text-sm">
                            �� ��? Tout d�sactiver
                        </button>
                    </div>
                </div>
            `;

            UI.modal(`��š ?��� � � Param��tres gestionnaire`, settingsContent, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            lucide.createIcons();
        },

        toggleFeature(featureKey, isEnabled) {
            if (!CORE.state.gestionnaireSettings) {
                CORE.state.gestionnaireSettings = {};
            }

            CORE.state.gestionnaireSettings[featureKey] = isEnabled;

            // Log pour debugging
            console.log(`���?� Fonctionnalit� "${featureKey}" ${isEnabled ? 'ACTIV�E' : 'D�SACTIV�E'}`);

            // Notification
            UI.toast(`${isEnabled ? '���?�' : '�� ��?'} ${featureKey.replace(/([A-Z])/g, ' $1').toLowerCase()} - ${isEnabled ? 'Activ�' : 'D�sactiv�'}`, 'info');

            // Sauvegarde dans le localStorage
            localStorage.setItem('gestionnaireSettings', JSON.stringify(CORE.state.gestionnaireSettings));
        },

        enableAllFeatures() {
            if (!CORE.state.gestionnaireSettings) {
                CORE.state.gestionnaireSettings = {};
            }

            Object.keys(CORE.state.gestionnaireSettings).forEach(key => {
                CORE.state.gestionnaireSettings[key] = true;
            });

            localStorage.setItem('gestionnaireSettings', JSON.stringify(CORE.state.gestionnaireSettings));
            UI.toast('���?� Toutes les fonctionnalit�s activ�es!', 'success');
            CourierModule.showGestionnaireSettings();
        },

        disableAllFeatures() {
            if (!CORE.state.gestionnaireSettings) {
                CORE.state.gestionnaireSettings = {};
            }

            Object.keys(CORE.state.gestionnaireSettings).forEach(key => {
                CORE.state.gestionnaireSettings[key] = false;
            });

            localStorage.setItem('gestionnaireSettings', JSON.stringify(CORE.state.gestionnaireSettings));
            UI.toast('�� ��? Toutes les fonctionnalit�s d�sactiv�es!', 'warning');
            CourierModule.showGestionnaireSettings();
        },

        showVehicleManagement() {
            const user = CORE.state.currentUser;
            if (!user || user.role !== 'livreur') return;

            UI.modal(`��Ÿš? Gestion des v�hicules`, `
                <div class="space-y-4">
                    <div class="p-4 border border-slate-200 rounded-lg">
                        <div class="font-bold text-slate-900 mb-2">��Ÿš? ${user.vehicle || 'V�hicule'}</div>
                        <div class="text-sm text-slate-600 mb-3">
                            Marque: BMW | Mod��le: X1 | Ann�e: 2022<br>
                            Plaque: XY-123-AB | Kilom�trage: 45,230 km
                        </div>
                        <div class="space-y-2">
                            <button class="w-full px-3 py-1.5 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 transition">
                                ��Ÿ� � Maintenance
                            </button>
                            <button class="w-full px-3 py-1.5 bg-amber-600 text-white text-xs font-bold rounded-lg hover:bg-amber-700 transition">
                                ��� � Carburant
                            </button>
                        </div>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showFinancialStats() {
            const user = CORE.state.currentUser;
            if (!user || user.role !== 'livreur') return;

            // ========== CALCULS FINANCIERS ==========
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const lastMonthDate = new Date(currentYear, currentMonth - 1, 1);

            const allDeliveries = CORE.db.deliveries.filter(d => d.livreurId === user.id && d.status === 'livr�');
            
            // Total gagn�
            const totalEarnings = allDeliveries.reduce((sum, d) => sum + (d.commission || 0), 0);

            // Ce mois
            const thisMonthDeliveries = allDeliveries.filter(d => {
                const d_date = new Date(d.completedAt);
                return d_date.getMonth() === currentMonth && d_date.getFullYear() === currentYear;
            });
            const thisMonthEarnings = thisMonthDeliveries.reduce((sum, d) => sum + (d.commission || 0), 0);

            // Mois dernier
            const lastMonthDeliveries = allDeliveries.filter(d => {
                const d_date = new Date(d.completedAt);
                return d_date.getMonth() === currentMonth - 1;
            });
            const lastMonthEarnings = lastMonthDeliveries.reduce((sum, d) => sum + (d.commission || 0), 0);

            // Aujourd'hui
            const todayStart = new Date(currentYear, currentMonth, now.getDate());
            const todayDeliveries = allDeliveries.filter(d => {
                const d_date = new Date(d.completedAt);
                return d_date >= todayStart;
            });
            const todayEarnings = todayDeliveries.reduce((sum, d) => sum + (d.commission || 0), 0);

            // Statistiques
            const avgPerDelivery = allDeliveries.length > 0 ? (totalEarnings / allDeliveries.length).toFixed(2) : 0;
            const avgThisMonth = thisMonthDeliveries.length > 0 ? (thisMonthEarnings / thisMonthDeliveries.length).toFixed(2) : 0;
            
            // Bonus de performance
            const performanceBonus = thisMonthDeliveries.length >= 20 ? 150 : 
                                     thisMonthDeliveries.length >= 15 ? 100 : 
                                     thisMonthDeliveries.length >= 10 ? 50 : 0;

            // Progression
            const monthGrowth = lastMonthEarnings > 0 ? (((thisMonthEarnings - lastMonthEarnings) / lastMonthEarnings) * 100).toFixed(0) : 0;

            // Objectifs
            const monthlyTarget = 2000;
            const targetProgress = Math.min(100, (thisMonthEarnings / monthlyTarget) * 100);

            const modalContent = `
                <div class="space-y-5">
                    <!-- CARTES PRINCIPALES -->
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        <!-- TOTAL GAGN� -->
                        <div class="p-5 bg-gradient-to-br from-emerald-500 to-emerald-600 text-white rounded-xl shadow-lg">
                            <div class="text-xs font-black uppercase opacity-90">Total gagn�</div>
                            <div class="text-3xl font-black mt-2">${totalEarnings.toFixed(2)}$</div>
                            <div class="text-xs opacity-75 mt-1">Depuis le d�but</div>
                        </div>

                        <!-- CE MOIS -->
                        <div class="p-5 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl shadow-lg">
                            <div class="text-xs font-black uppercase opacity-90">Ce mois</div>
                            <div class="text-3xl font-black mt-2">${thisMonthEarnings.toFixed(2)}$</div>
                            <div class="text-xs opacity-75 mt-1">${thisMonthDeliveries.length} livraisons</div>
                        </div>

                        <!-- AUJOURD'HUI -->
                        <div class="p-5 bg-gradient-to-br from-amber-500 to-amber-600 text-white rounded-xl shadow-lg">
                            <div class="text-xs font-black uppercase opacity-90">Aujourd'hui</div>
                            <div class="text-3xl font-black mt-2">${todayEarnings.toFixed(2)}$</div>
                            <div class="text-xs opacity-75 mt-1">${todayDeliveries.length} livraisons</div>
                        </div>
                    </div>

                    <!-- OBJECTIF MENSUEL -->
                    <div class="p-5 bg-white border-2 border-purple-200 rounded-xl">
                        <div class="flex items-center justify-between mb-3">
                            <div class="font-black text-slate-900">��ŸŽ � Objectif mensuel</div>
                            <span class="text-sm font-black text-purple-700">${Math.round(targetProgress)}%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-4 overflow-hidden mb-2">
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 h-4 rounded-full transition-all" style="width: ${Math.min(100, Math.max(0, targetProgress))}%"></div>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-600">${thisMonthEarnings.toFixed(2)}$ / ${monthlyTarget}$</span>
                            <span class="font-bold text-purple-700">${(monthlyTarget - thisMonthEarnings).toFixed(2)}$ manquants</span>
                        </div>
                    </div>

                    <!-- STATISTIQUES D�TAILL�ES -->
                    <div class="p-5 bg-white border border-slate-200 rounded-xl">
                        <div class="font-black text-slate-900 mb-4">��Ÿ?Š Statistiques d�taill�es</div>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                <span class="text-slate-600">��Ÿ? � Livraisons ce mois</span>
                                <span class="font-black text-lg text-blue-600">${thisMonthDeliveries.length}</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                <span class="text-slate-600">��Ÿ? � Moyenne par livraison</span>
                                <span class="font-black text-lg text-emerald-600">${avgThisMonth}$</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                <span class="text-slate-600">��Ÿ?�? Croissance vs mois dernier</span>
                                <span class="font-black text-lg ${monthGrowth >= 0 ? 'text-emerald-600' : 'text-red-600'}">${monthGrowth >= 0 ? '+' : ''}${monthGrowth}%</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                <span class="text-slate-600">�� � � Total livraisons</span>
                                <span class="font-black text-lg text-purple-600">${allDeliveries.length}</span>
                            </div>
                        </div>
                    </div>

                    <!-- BONUS DE PERFORMANCE -->
                    <div class="p-5 bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-300 rounded-xl">
                        <div class="flex items-center justify-between mb-3">
                            <div class="font-black text-slate-900">��Ÿ �� Bonus de performance</div>
                            <span class="text-2xl font-black text-amber-600">${performanceBonus}$</span>
                        </div>
                        <div class="text-sm text-slate-700 mb-3">
                            ${performanceBonus > 0 ? 
                                `<div class="text-amber-700 font-bold">���?� Bonus d�bloqu�!</div>
                                 <div class="text-xs text-amber-600 mt-1">
                                    ${performanceBonus === 150 ? '��Ÿ �� Vous avez livr� 20+ commandes ce mois' :
                                      performanceBonus === 100 ? '��Ÿ ��? Vous avez livr� 15+ commandes ce mois' :
                                      performanceBonus === 50 ? '��Ÿ �� Vous avez livr� 10+ commandes ce mois' : ''}
                                 </div>` 
                                : 
                                `<div class="text-slate-700">
                                    Prochains paliers:
                                    <div class="mt-2 space-y-1 text-xs">
                                        <div>${thisMonthDeliveries.length}/10 - 50$ ��Ÿ ��</div>
                                        <div>${thisMonthDeliveries.length}/15 - 100$ ��Ÿ ��?</div>
                                        <div>${thisMonthDeliveries.length}/20 - 150$ ��Ÿ ��</div>
                                    </div>
                                 </div>`
                            }
                        </div>
                    </div>

                    <!-- D�COMPOSITION DES REVENUS -->
                    <div class="p-5 bg-white border border-slate-200 rounded-xl">
                        <div class="font-black text-slate-900 mb-4">��Ÿ? � D�composition</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between p-2">
                                <span class="text-slate-600">Commissions</span>
                                <span class="font-bold text-slate-900">${(totalEarnings * 0.85).toFixed(2)}$</span>
                            </div>
                            <div class="flex justify-between p-2">
                                <span class="text-slate-600">Bonus performance</span>
                                <span class="font-bold text-amber-600">+${performanceBonus}$</span>
                            </div>
                            <div class="flex justify-between p-2">
                                <span class="text-slate-600">Incitatifs</span>
                                <span class="font-bold text-emerald-600">+${(totalEarnings * 0.15).toFixed(2)}$</span>
                            </div>
                            <div class="border-t border-slate-200 flex justify-between p-2 mt-2 font-black">
                                <span>Total</span>
                                <span class="text-emerald-600">${(totalEarnings + performanceBonus).toFixed(2)}$</span>
                            </div>
                        </div>
                    </div>

                    <!-- CONSEIL -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-800">
                        <span class="font-bold">��Ÿ? � Conseil:</span> Vous avez besoin de ${Math.max(0, Math.ceil((monthlyTarget - thisMonthEarnings) / (avgThisMonth || 1)))} livraisons suppl�mentaires pour atteindre votre objectif de ${monthlyTarget}$ ce mois!
                    </div>
                </div>
            `;

            UI.modal(`��Ÿ? � Statistiques financi��res`, modalContent, [
                { label: 'T�l�charger relev�', onclick: 'CourierModule.downloadFinancialStatement()', class: 'px-4 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            lucide.createIcons();
        },

        showMyRoutes() {
            const user = CORE.state.currentUser;
            if (!user || user.role !== 'livreur') return;

            // ========== G�N�RATION DE TOURN�ES ==========
            // R�cup�ration des livraisons assign�es
            const assignedDeliveries = CORE.db.deliveries.filter(d => d.livreurId === user.id && d.status !== 'livr�');
            
            // Groupage par zone/r�gion (simulation bas�e sur la lettre du code postal)
            const routes = {};
            assignedDeliveries.forEach(d => {
                const zone = d.address ? d.address.split(' ')[0].charAt(0).toUpperCase() : 'AUTRE';
                if (!routes[zone]) {
                    routes[zone] = [];
                }
                routes[zone].push(d);
            });

            // Tri des routes
            const sortedZones = Object.keys(routes).sort();
            const todayDeliveries = assignedDeliveries.filter(d => {
                const d_date = new Date(d.createdAt || d.assignedAt);
                const today = new Date();
                return d_date.toDateString() === today.toDateString();
            });

            // ========== FONCTION DE RENDU D'UNE ROUTE ==========
            const renderRoute = (zone, deliveries, index) => {
                const totalStops = deliveries.length;
                const estimatedDistance = (totalStops * 3.5).toFixed(1); // Estimation km
                const estimatedTime = Math.ceil(totalStops * 15); // 15 min par livraison
                
                const routeColor = ['from-blue-500 to-blue-600', 'from-emerald-500 to-emerald-600', 
                                   'from-purple-500 to-purple-600', 'from-orange-500 to-orange-600',
                                   'from-pink-500 to-pink-600', 'from-cyan-500 to-cyan-600'];

                return `
                    <div class="p-5 border-2 border-slate-200 rounded-xl hover:shadow-lg transition">
                        <!-- HEADER ROUTE -->
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 rounded-lg bg-gradient-to-br ${routeColor[index % routeColor.length]} text-white flex items-center justify-center font-black text-lg">
                                    ${zone}
                                </div>
                                <div>
                                    <h4 class="font-black text-slate-900">Route Zone ${zone}</h4>
                                    <p class="text-xs text-slate-500 mt-1">${totalStops} arr��t(s)</p>
                                </div>
                            </div>
                            <button onclick="CourierModule.startRoute('${zone}')" class="px-3 py-1.5 bg-emerald-600 text-white text-xs font-black rounded-lg hover:bg-emerald-700 transition">
                                ��? ��� � � D�marrer
                            </button>
                        </div>

                        <!-- STATISTIQUES ROUTE -->
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div class="p-3 bg-blue-50 rounded-lg text-center">
                                <div class="text-lg font-black text-blue-600">${estimatedDistance}</div>
                                <div class="text-xs text-blue-600">km</div>
                            </div>
                            <div class="p-3 bg-purple-50 rounded-lg text-center">
                                <div class="text-lg font-black text-purple-600">${estimatedTime}</div>
                                <div class="text-xs text-purple-600">min</div>
                            </div>
                            <div class="p-3 bg-emerald-50 rounded-lg text-center">
                                <div class="text-lg font-black text-emerald-600">${(totalStops * 8).toFixed(0)}</div>
                                <div class="text-xs text-emerald-600">$</div>
                            </div>
                        </div>

                        <!-- LISTE DES LIVRAISONS -->
                        <div class="space-y-2 mb-3">
                            ${deliveries.slice(0, 3).map((d, i) => `
                                <div class="p-2 bg-slate-50 rounded-lg text-xs flex justify-between items-center">
                                    <span class="font-bold text-slate-900">${i + 1}. ${d.customerName}</span>
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold ${d.status === 'en-cours' ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700'}">${d.status}</span>
                                </div>
                            `).join('')}
                            ${deliveries.length > 3 ? `<div class="p-2 text-xs text-slate-500 italic">+ ${deliveries.length - 3} autres arr��t(s)</div>` : ''}
                        </div>

                        <!-- BOUTONS ACTION -->
                        <div class="flex gap-2">
                            <button onclick="CourierModule.viewRouteMap('${zone}')" class="flex-1 px-3 py-2 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 transition">
                                ��Ÿ? ��� � � Carte
                            </button>
                            <button onclick="CourierModule.optimizeRoute('${zone}')" class="flex-1 px-3 py-2 bg-slate-600 text-white text-xs font-bold rounded-lg hover:bg-slate-700 transition">
                                ��š � Optimiser
                            </button>
                        </div>
                    </div>
                `;
            };

            const modalContent = `
                <div class="space-y-5">
                    <!-- R�SUM� -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg text-center">
                            <div class="text-2xl font-black text-blue-700">${assignedDeliveries.length}</div>
                            <div class="text-xs text-blue-600 font-bold mt-1">Livraisons</div>
                        </div>
                        <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg text-center">
                            <div class="text-2xl font-black text-purple-700">${sortedZones.length}</div>
                            <div class="text-xs text-purple-600 font-bold mt-1">Routes</div>
                        </div>
                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-lg text-center">
                            <div class="text-2xl font-black text-emerald-700">${(assignedDeliveries.length * 3.5).toFixed(0)}</div>
                            <div class="text-xs text-emerald-600 font-bold mt-1">km</div>
                        </div>
                        <div class="p-4 bg-orange-50 border border-orange-200 rounded-lg text-center">
                            <div class="text-2xl font-black text-orange-700">${Math.ceil(assignedDeliveries.length * 15)}</div>
                            <div class="text-xs text-orange-600 font-bold mt-1">minutes</div>
                        </div>
                    </div>

                    <!-- ROUTES -->
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto">
                        ${sortedZones.length === 0 ? 
                            '<div class="text-center py-8 text-slate-400"><div class="text-3xl mb-2">��Ÿ? �</div>Aucune route assign�e</div>' :
                            sortedZones.map((zone, idx) => renderRoute(zone, routes[zone], idx)).join('')
                        }
                    </div>

                    <!-- R�SUM� OPTIMISATION -->
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
                        <div class="font-black text-slate-900 mb-3">��Ÿ?�? Optimisation</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-600">Itin�raire optimal</span>
                                <span class="font-bold text-emerald-600">���?� Calcul�</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Temps estim�</span>
                                <span class="font-bold text-slate-900">${Math.ceil(assignedDeliveries.length * 15)} min</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Distance totale</span>
                                <span class="font-bold text-slate-900">${(assignedDeliveries.length * 3.5).toFixed(1)} km</span>
                            </div>
                        </div>
                    </div>

                    <!-- CONSEIL -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-800">
                        <span class="font-bold">��Ÿ? � Conseil:</span> Cliquez sur "Optimiser" pour recalculer l'itin�raire le plus efficace et minimiser la distance.
                    </div>
                </div>
            `;

            UI.modal(`��Ÿšš Mes feuilles de route`, modalContent, [
                { label: 'Tout d�marrer', onclick: 'alert("Toutes les routes d�marr�es!")', class: 'px-4 py-2 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 transition' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            lucide.createIcons();
        },

        // ========== FONCTIONS SUPPORT ROUTES & FINANCES ==========
        downloadFinancialStatement() {
            UI.toast('G�n�ration du relev� financier...', 'info');
            setTimeout(() => {
                UI.toast('���?� Relev� t�l�charg� en PDF!', 'success');
            }, 1500);
        },

        startRoute(zone) {
            UI.toast(`��Ÿšš Route Zone ${zone} d�marr�e!`, 'success');
            UI.closeModal();
        },

        viewRouteMap(zone) {
            UI.toast(`Affichage de la carte Zone ${zone}...`, 'info');
        },

        optimizeRoute(zone) {
            UI.toast(`��š � Optimisation de la route Zone ${zone}...`, 'info');
            setTimeout(() => {
                UI.toast('���?� Route optimis�e! �conomie: 2.3 km', 'success');
            }, 1500);
        },
        // ========== VALIDATION DE LIVRAISON PAR IMAGE ==========
        validateDeliveryWithImage(deliveryId) {
            const delivery = CORE.db.deliveries.find(d => d.id === deliveryId);
            if (!delivery) return UI.toast('Livraison introuvable', 'error');

            const user = CORE.state.currentUser;
            if (!user || user.role !== 'livreur') return;

            // ========== V�RIFIER SI LA FONCTIONNALIT� EST ACTIV�E ==========
            const settings = CORE.state.gestionnaireSettings || {};
            
            // Charger depuis localStorage si pas en m�moire
            if (!CORE.state.gestionnaireSettings) {
                const savedSettings = localStorage.getItem('gestionnaireSettings');
                CORE.state.gestionnaireSettings = savedSettings ? JSON.parse(savedSettings) : {
                    deliveryPhotoValidationEnabled: true
                };
            }

            // V�rifier si la fonctionnalit� est activ�e
            if (!CORE.state.gestionnaireSettings.deliveryPhotoValidationEnabled) {
                return UI.toast('�� ��? La validation par photo est actuellement d�sactiv�e par le gestionnaire', 'warning');
            }

            // Initialiser si non existant
            if (!window._deliveryPhotos) {
                window._deliveryPhotos = {};
            }

            const modalContent = `
                <div class="space-y-5">
                    <!-- INFOS LIVRAISON -->
                    <div class="p-5 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl">
                        <div class="font-black text-slate-900 mb-3">��Ÿ? � Commande: ${delivery.orderRef}</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-600">��Ÿ? � Client:</span>
                                <span class="font-bold">${delivery.customerName}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">��Ÿ? � Adresse:</span>
                                <span class="font-bold">${delivery.address || '�� ?��'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">��Ÿ? � Montant:</span>
                                <span class="font-bold text-emerald-600">${delivery.amount || 0}$</span>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION: CAPTURE PHOTO -->
                    <div class="p-5 border-2 border-slate-200 rounded-xl">
                        <h3 class="font-black text-slate-900 mb-4">��Ÿ? � Preuve de livraison</h3>
                        
                        <!-- ZONE DE PREVIEW -->
                        <div id="photo_preview_${deliveryId}" class="mb-4 p-4 bg-slate-100 rounded-lg text-center border-2 border-dashed border-slate-300 min-h-[200px] flex items-center justify-center">
                            <div>
                                <div class="text-4xl mb-2">��Ÿ? �</div>
                                <p class="text-sm text-slate-500">Aucune photo prise</p>
                                <p class="text-xs text-slate-400 mt-1">Cliquez sur "Prendre une photo"</p>
                            </div>
                        </div>

                        <!-- BOUTONS CAPTURE -->
                        <div class="flex gap-2 mb-4">
                            <button onclick="CourierModule.capturePhotoCamera('${deliveryId}')" class="flex-1 px-4 py-3 bg-blue-600 text-white font-black rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                ��Ÿ? � Prendre une photo
                            </button>
                            <button onclick="CourierModule.uploadPhotoFile('${deliveryId}')" class="flex-1 px-4 py-3 bg-slate-600 text-white font-black rounded-lg hover:bg-slate-700 transition flex items-center justify-center gap-2">
                                ��Ÿ? � Importer
                            </button>
                        </div>

                        <!-- INPUT FICHIER CACH� -->
                        <input type="file" id="file_input_${deliveryId}" accept="image/*" style="display: none;" onchange="CourierModule.handlePhotoUpload('${deliveryId}', event)">
                    </div>

                    <!-- SECTION: SIGNATURE CLIENT (OPTIONNEL) -->
                    <div class="p-5 border border-amber-200 bg-amber-50 rounded-xl">
                        <h3 class="font-black text-slate-900 mb-3">���? ��� � � Signature client (optionnel)</h3>
                        <div class="mb-3 p-3 bg-white border-2 border-dashed border-amber-300 rounded-lg min-h-[120px] text-center">
                            <p class="text-sm text-slate-500">Zone de signature - �� impl�menter</p>
                        </div>
                        <button onclick="alert('Fonctionnalit� signature en d�veloppement')" class="w-full px-4 py-2 bg-amber-600 text-white font-black rounded-lg hover:bg-amber-700 transition">
                            ���? ��� � � Demander une signature
                        </button>
                    </div>

                    <!-- SECTION: NOTES DE LIVRAISON -->
                    <div class="p-5 border border-slate-200 rounded-xl">
                        <h3 class="font-black text-slate-900 mb-3">��Ÿ? � Notes de livraison</h3>
                        <textarea id="delivery_notes_${deliveryId}" placeholder="Notes: Client absent? Paquet endommag�? ..." class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm resize-none" rows="3"></textarea>
                        
                        <div class="mt-3 space-y-2">
                            <button onclick="document.getElementById('notes_box_${deliveryId}').innerHTML = '���?� Livraison en bon �tat'; document.getElementById('delivery_notes_${deliveryId}').value = 'Livraison en bon �tat';" class="w-full text-left px-3 py-2 text-sm font-bold text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-lg hover:bg-emerald-100 transition">
                                ���?� Livraison en bon �tat
                            </button>
                            <button onclick="document.getElementById('notes_box_${deliveryId}').innerHTML = '��š ��� � � Paquet endommag�'; document.getElementById('delivery_notes_${deliveryId}').value = 'Paquet endommag�';" class="w-full text-left px-3 py-2 text-sm font-bold text-red-700 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 transition">
                                ��š ��� � � Paquet endommag�
                            </button>
                            <button onclick="document.getElementById('notes_box_${deliveryId}').innerHTML = '�� ��? Client absent'; document.getElementById('delivery_notes_${deliveryId}').value = 'Client absent';" class="w-full text-left px-3 py-2 text-sm font-bold text-orange-700 bg-orange-50 border border-orange-200 rounded-lg hover:bg-orange-100 transition">
                                �� ��? Client absent
                            </button>
                        </div>
                    </div>

                    <!-- SECTION: CHECKLIST -->
                    <div class="p-5 border border-slate-200 rounded-xl">
                        <h3 class="font-black text-slate-900 mb-3">���?� Checklist de livraison</h3>
                        <div class="space-y-2">
                            <label class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded cursor-pointer transition">
                                <input type="checkbox" id="check_customer_${deliveryId}" class="w-5 h-5">
                                <span class="text-sm font-bold text-slate-700">Client confirm�</span>
                            </label>
                            <label class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded cursor-pointer transition">
                                <input type="checkbox" id="check_photo_${deliveryId}" class="w-5 h-5">
                                <span class="text-sm font-bold text-slate-700">Photo prise</span>
                            </label>
                            <label class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded cursor-pointer transition">
                                <input type="checkbox" id="check_intact_${deliveryId}" class="w-5 h-5">
                                <span class="text-sm font-bold text-slate-700">Paquet intact</span>
                            </label>
                            <label class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded cursor-pointer transition">
                                <input type="checkbox" id="check_receipt_${deliveryId}" class="w-5 h-5">
                                <span class="text-sm font-bold text-slate-700">Re��u fourni</span>
                            </label>
                        </div>
                    </div>

                    <!-- CONSEIL -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-800">
                        <span class="font-bold">��Ÿ? � Conseil:</span> Pour plus de transparence, prenez une photo claire de la livraison avec la signature ou le consentement du client.
                    </div>
                </div>
            `;

            UI.modal(`��Ÿ? � Validation de livraison avec photo`, modalContent, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Valider & Livrer', onclick: `CourierModule.confirmDeliveryWithPhoto('${deliveryId}')`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);

            lucide.createIcons();
        },

        capturePhotoCamera(deliveryId) {
            // Simule l'acc��s �� la cam�ra
            UI.toast('��Ÿ? � Ouverture de la cam�ra...', 'info');
            
            // Simulation: g�n��re une image de d�monstration
            setTimeout(() => {
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 300;
                const ctx = canvas.getContext('2d');
                
                // D�grad� de d�monstration
                const gradient = ctx.createLinearGradient(0, 0, 400, 300);
                gradient.addColorStop(0, '#3b82f6');
                gradient.addColorStop(1, '#1e40af');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 400, 300);
                
                // Texte
                ctx.fillStyle = 'white';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('��Ÿ? � Photo de livraison', 200, 130);
                ctx.fillText('Horodatage: ' + new Date().toLocaleTimeString('fr-FR'), 200, 160);
                
                const imageData = canvas.toDataURL('image/jpeg');
                CourierModule.setDeliveryPhoto(deliveryId, imageData);
                UI.toast('���?� Photo captur�e!', 'success');
            }, 500);
        },

        uploadPhotoFile(deliveryId) {
            const input = document.getElementById(`file_input_${deliveryId}`);
            if (input) {
                input.click();
            }
        },

        handlePhotoUpload(deliveryId, event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                return UI.toast('Veuillez s�lectionner une image', 'error');
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                CourierModule.setDeliveryPhoto(deliveryId, e.target.result);
                UI.toast('���?� Photo import�e!', 'success');
            };
            reader.readAsDataURL(file);
        },

        setDeliveryPhoto(deliveryId, imageData) {
            if (!window._deliveryPhotos) {
                window._deliveryPhotos = {};
            }

            window._deliveryPhotos[deliveryId] = {
                data: imageData,
                timestamp: new Date().toISOString(),
                size: imageData.length
            };

            // Mettre �� jour le preview
            const preview = document.getElementById(`photo_preview_${deliveryId}`);
            if (preview) {
                if (imageData) {
                    const photoDate = new Date(window._deliveryPhotos[deliveryId].timestamp).toLocaleString('fr-FR');
                    preview.innerHTML = `
                        <div class="text-center">
                            <img src="${imageData}" alt="Photo de livraison" class="max-h-[180px] rounded-lg mx-auto mb-2 shadow-lg" onerror="this.style.display='none'; if(this.nextElementSibling) this.nextElementSibling.style.display='block'">
                            <div class="text-center text-slate-400" style="display:none">�� ��? Erreur chargement</div>
                            <p class="text-xs text-slate-600">��Ÿ? � ${photoDate}</p>
                        </div>
                    `;
                } else {
                    preview.innerHTML = '<div><div class="text-4xl mb-2">��Ÿ? �</div><p class="text-sm text-slate-500">Aucune photo prise</p><p class="text-xs text-slate-400 mt-1">Cliquez sur "Prendre une photo"</p></div>';
                }
            }

            // Cocher automatiquement la case photo
            const photoCheck = document.getElementById(`check_photo_${deliveryId}`);
            if (photoCheck) {
                photoCheck.checked = true;
            }
        },

        confirmDeliveryWithPhoto(deliveryId) {
            const delivery = CORE.db.deliveries.find(d => d.id === deliveryId);
            if (!delivery) return UI.toast('Livraison introuvable', 'error');

            // V�rifier que la photo est pr�sente
            if (!window._deliveryPhotos || !window._deliveryPhotos[deliveryId]) {
                return UI.toast('��š ��� � � Veuillez prendre une photo', 'warning');
            }

            // V�rifier les cases
            const allChecked = document.getElementById(`check_customer_${deliveryId}`)?.checked &&
                              document.getElementById(`check_photo_${deliveryId}`)?.checked &&
                              document.getElementById(`check_intact_${deliveryId}`)?.checked;

            if (!allChecked) {
                return UI.toast('��š ��� � � Veuillez compl�ter la checklist', 'warning');
            }

            // R�cup�rer les notes
            const notes = document.getElementById(`delivery_notes_${deliveryId}`)?.value || '';

            // Mettre �� jour la livraison
            delivery.status = 'livr�';
            delivery.completedAt = new Date().toISOString();
            delivery.proofPhoto = window._deliveryPhotos[deliveryId].data;
            delivery.photoTimestamp = window._deliveryPhotos[deliveryId].timestamp;
            delivery.deliveryNotes = notes;
            delivery.validatedBy = CORE.state.currentUser.name;
            delivery.validationMethod = 'photo';

            // Sauvegarder
            CORE.db.deliveries = CORE.db.deliveries.map(d => d.id === deliveryId ? delivery : d);

            UI.closeModal();
            UI.toast(`���?� Livraison ${delivery.orderRef} valid�e avec photo!`, 'success');

            // Rerender
            setTimeout(() => {
                App.rerender();
            }, 500);
        },

        viewDeliveryProofPhoto(deliveryId) {
            const delivery = CORE.db.deliveries.find(d => d.id === deliveryId);
            if (!delivery || !delivery.proofPhoto) {
                return UI.toast('Aucune photo de preuve', 'info');
            }

            const modalContent = `
                <div class="space-y-4">
                    ${delivery.proofPhoto ? `<img src="${delivery.proofPhoto}" alt="Preuve de livraison" class="w-full rounded-lg shadow-lg" onerror="this.style.display='none'; if(this.nextElementSibling) this.nextElementSibling.style.display='block'">` : ''}
                    <div class="text-center text-slate-400" ${delivery.proofPhoto ? 'style="display:none"' : ''}>�� ��? Aucune preuve photo</div>
                    
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-600">��Ÿ?� Date/Heure:</span>
                            <span class="font-bold">${new Date(delivery.photoTimestamp).toLocaleString('fr-FR')}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">��Ÿ? � Valid� par:</span>
                            <span class="font-bold">${delivery.validatedBy}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">��Ÿ?� Commande:</span>
                            <span class="font-bold">${delivery.orderRef}</span>
                        </div>
                        ${delivery.deliveryNotes ? `<div class="border-t border-slate-200 pt-2 mt-2"><span class="text-slate-600">��Ÿ? � Notes:</span><p class="font-bold text-slate-900 mt-1">${delivery.deliveryNotes}</p></div>` : ''}
                    </div>
                </div>
            `;

            UI.modal(`��Ÿ? � Preuve de livraison - ${delivery.orderRef}`, modalContent, [
                { label: 'T�l�charger', onclick: 'alert("T�l�chargement de la photo...")', class: 'px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        }
    };
</script>

<!-- ��� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� �
     RAYA ENTERPRISE OS - Multi-Tenant System
     ��� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� ���� � -->
