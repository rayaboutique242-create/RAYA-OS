<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RAYA OS">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="RAYA OS">
    <meta name="msapplication-TileColor" content="#059669">
    <meta name="msapplication-TileImage" content="/icons/icon-144x144.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <title>RAYA OS - Enterprise Nervous System</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * { font-family: 'Inter', sans-serif; }

        /* ========== WHATSAPP DARK THEME ========== */
        :root {
            --wa-bg-primary: #111b21;
            --wa-bg-secondary: #202c33;
            --wa-bg-card: #1f2c34;
            --wa-bg-hover: #2a3942;
            --wa-bg-input: #2a3942;
            --wa-text-primary: #e9edef;
            --wa-text-secondary: #8696a0;
            --wa-text-muted: #667781;
            --wa-border: #2a3942;
            --wa-accent: #00a884;
            --wa-accent-hover: #06cf9c;
            --wa-success: #25d366;
            --wa-danger: #ea4335;
            --wa-warning: #f59e0b;
        }

        /* Dark theme application */
        html.vendeur-dark,
        html.vendeur-dark body {
            background-color: var(--wa-bg-primary) !important;
            color: var(--wa-text-primary) !important;
        }

        html.vendeur-dark #app {
            background-color: var(--wa-bg-primary) !important;
        }

        /* Sidebar dark */
        html.vendeur-dark .bg-white,
        html.vendeur-dark .bg-slate-50,
        html.vendeur-dark .bg-gray-50 {
            background-color: var(--wa-bg-secondary) !important;
        }

        /* Cards and panels */
        html.vendeur-dark .bg-slate-100,
        html.vendeur-dark .bg-gray-100,
        html.vendeur-dark .bg-emerald-50,
        html.vendeur-dark .bg-green-50,
        html.vendeur-dark .bg-blue-50,
        html.vendeur-dark .bg-amber-50,
        html.vendeur-dark .bg-orange-50,
        html.vendeur-dark .bg-red-50,
        html.vendeur-dark .bg-purple-50,
        html.vendeur-dark .bg-pink-50,
        html.vendeur-dark .bg-indigo-50 {
            background-color: var(--wa-bg-card) !important;
        }

        /* Text colors */
        html.vendeur-dark .text-slate-900,
        html.vendeur-dark .text-slate-800,
        html.vendeur-dark .text-slate-700,
        html.vendeur-dark .text-gray-900,
        html.vendeur-dark .text-gray-800,
        html.vendeur-dark .text-gray-700 {
            color: var(--wa-text-primary) !important;
        }

        html.vendeur-dark .text-slate-600,
        html.vendeur-dark .text-slate-500,
        html.vendeur-dark .text-gray-600,
        html.vendeur-dark .text-gray-500 {
            color: var(--wa-text-secondary) !important;
        }

        html.vendeur-dark .text-slate-400,
        html.vendeur-dark .text-slate-300,
        html.vendeur-dark .text-gray-400,
        html.vendeur-dark .text-gray-300 {
            color: var(--wa-text-muted) !important;
        }

        /* Borders */
        html.vendeur-dark .border-slate-200,
        html.vendeur-dark .border-slate-100,
        html.vendeur-dark .border-gray-200,
        html.vendeur-dark .border-gray-100,
        html.vendeur-dark .border-slate-300,
        html.vendeur-dark .border-gray-300 {
            border-color: var(--wa-border) !important;
        }

        /* Inputs */
        html.vendeur-dark input,
        html.vendeur-dark select,
        html.vendeur-dark textarea {
            background-color: var(--wa-bg-input) !important;
            border-color: var(--wa-border) !important;
            color: var(--wa-text-primary) !important;
        }

        html.vendeur-dark input::placeholder,
        html.vendeur-dark textarea::placeholder {
            color: var(--wa-text-muted) !important;
        }

        html.vendeur-dark input:focus,
        html.vendeur-dark select:focus,
        html.vendeur-dark textarea:focus {
            border-color: var(--wa-accent) !important;
            outline-color: var(--wa-accent) !important;
        }

        /* Buttons */
        html.vendeur-dark .bg-slate-200,
        html.vendeur-dark .bg-gray-200 {
            background-color: var(--wa-bg-hover) !important;
        }

        /* Hover states */
        html.vendeur-dark .hover\:bg-slate-50:hover,
        html.vendeur-dark .hover\:bg-gray-50:hover,
        html.vendeur-dark .hover\:bg-slate-100:hover,
        html.vendeur-dark .hover\:bg-gray-100:hover {
            background-color: var(--wa-bg-hover) !important;
        }

        /* Shadows become subtle */
        html.vendeur-dark .shadow-sm,
        html.vendeur-dark .shadow,
        html.vendeur-dark .shadow-lg,
        html.vendeur-dark .shadow-xl {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4) !important;
        }

        /* Glass effect for dark */
        html.vendeur-dark .glass {
            background: rgba(32, 44, 51, 0.85) !important;
            border-color: var(--wa-border) !important;
        }

        /* Dividers */
        html.vendeur-dark hr,
        html.vendeur-dark .divide-slate-100 > * + *,
        html.vendeur-dark .divide-slate-200 > * + * {
            border-color: var(--wa-border) !important;
        }

        /* Modal overlays */
        html.vendeur-dark .bg-black\/50,
        html.vendeur-dark .bg-slate-900\/50 {
            background-color: rgba(0, 0, 0, 0.7) !important;
        }

        /* Tables */
        html.vendeur-dark table th {
            background-color: var(--wa-bg-secondary) !important;
            color: var(--wa-text-secondary) !important;
        }

        html.vendeur-dark table td {
            border-color: var(--wa-border) !important;
        }

        html.vendeur-dark table tr:hover {
            background-color: var(--wa-bg-hover) !important;
        }

        /* Scrollbars */
        html.vendeur-dark ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        html.vendeur-dark ::-webkit-scrollbar-track {
            background: var(--wa-bg-primary);
        }

        html.vendeur-dark ::-webkit-scrollbar-thumb {
            background: var(--wa-bg-hover);
            border-radius: 3px;
        }

        html.vendeur-dark ::-webkit-scrollbar-thumb:hover {
            background: var(--wa-text-muted);
        }

        /* Keep accent colors vibrant */
        html.vendeur-dark .text-emerald-600,
        html.vendeur-dark .text-emerald-500,
        html.vendeur-dark .text-green-600,
        html.vendeur-dark .text-green-500 {
            color: var(--wa-accent) !important;
        }

        html.vendeur-dark .bg-emerald-500,
        html.vendeur-dark .bg-emerald-600,
        html.vendeur-dark .bg-green-500,
        html.vendeur-dark .bg-green-600 {
            background-color: var(--wa-accent) !important;
        }

        html.vendeur-dark .border-emerald-500,
        html.vendeur-dark .border-emerald-600 {
            border-color: var(--wa-accent) !important;
        }

        /* Ring colors */
        html.vendeur-dark .ring-slate-100,
        html.vendeur-dark .ring-slate-200 {
            --tw-ring-color: var(--wa-border) !important;
        }

        /* Gradient backgrounds keep their colors */
        html.vendeur-dark .gradient-vendeur {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%) !important;
        }

        /* ========== END WHATSAPP DARK THEME ========== */

        /* ========== LIVREUR DARK THEME ========== */
        :root {
            --liv-bg-primary: #1a1a2e;
            --liv-bg-secondary: #16213e;
            --liv-bg-card: #1f2937;
            --liv-bg-hover: #374151;
            --liv-bg-input: #374151;
            --liv-text-primary: #f9fafb;
            --liv-text-secondary: #d1d5db;
            --liv-text-muted: #9ca3af;
            --liv-border: #374151;
            --liv-accent: #ef4444;
            --liv-accent-secondary: #f97316;
            --liv-success: #10b981;
        }

        html.livreur-dark,
        html.livreur-dark body {
            background-color: var(--liv-bg-primary) !important;
            color: var(--liv-text-primary) !important;
        }

        html.livreur-dark #app {
            background-color: var(--liv-bg-primary) !important;
        }

        html.livreur-dark .bg-slate-100 {
            background-color: var(--liv-bg-primary) !important;
        }

        html.livreur-dark .bg-white,
        html.livreur-dark .bg-slate-50,
        html.livreur-dark .bg-gray-50 {
            background-color: var(--liv-bg-secondary) !important;
        }

        html.livreur-dark .bg-slate-200,
        html.livreur-dark .bg-gray-100,
        html.livreur-dark .bg-emerald-50,
        html.livreur-dark .bg-green-50,
        html.livreur-dark .bg-blue-50,
        html.livreur-dark .bg-amber-50,
        html.livreur-dark .bg-orange-50,
        html.livreur-dark .bg-red-50,
        html.livreur-dark .bg-purple-50,
        html.livreur-dark .bg-indigo-50,
        html.livreur-dark .bg-teal-50,
        html.livreur-dark .bg-cyan-50 {
            background-color: var(--liv-bg-card) !important;
        }

        /* Gradients spéciaux */
        html.livreur-dark .bg-gradient-to-r.from-amber-50,
        html.livreur-dark .bg-gradient-to-r.from-orange-50,
        html.livreur-dark .bg-gradient-to-r.from-emerald-50,
        html.livreur-dark .bg-gradient-to-r.from-blue-50 {
            background: linear-gradient(to right, var(--liv-bg-card), var(--liv-bg-hover)) !important;
        }

        html.livreur-dark .text-slate-900,
        html.livreur-dark .text-slate-800,
        html.livreur-dark .text-slate-700,
        html.livreur-dark .text-gray-900,
        html.livreur-dark .text-gray-800,
        html.livreur-dark .text-gray-700 {
            color: var(--liv-text-primary) !important;
        }

        html.livreur-dark .text-slate-600,
        html.livreur-dark .text-slate-500,
        html.livreur-dark .text-gray-600,
        html.livreur-dark .text-gray-500 {
            color: var(--liv-text-secondary) !important;
        }

        html.livreur-dark .text-slate-400,
        html.livreur-dark .text-slate-300,
        html.livreur-dark .text-gray-400,
        html.livreur-dark .text-gray-300 {
            color: var(--liv-text-muted) !important;
        }

        html.livreur-dark .border-slate-200,
        html.livreur-dark .border-slate-100,
        html.livreur-dark .border-gray-200,
        html.livreur-dark .border-gray-100,
        html.livreur-dark .border-slate-300 {
            border-color: var(--liv-border) !important;
        }

        html.livreur-dark .border-amber-200,
        html.livreur-dark .border-amber-300,
        html.livreur-dark .border-orange-200 {
            border-color: rgba(245, 158, 11, 0.4) !important;
        }

        html.livreur-dark .border-emerald-200,
        html.livreur-dark .border-emerald-300 {
            border-color: rgba(16, 185, 129, 0.4) !important;
        }

        html.livreur-dark input,
        html.livreur-dark select,
        html.livreur-dark textarea {
            background-color: var(--liv-bg-input) !important;
            border-color: var(--liv-border) !important;
            color: var(--liv-text-primary) !important;
        }

        html.livreur-dark input::placeholder,
        html.livreur-dark textarea::placeholder {
            color: var(--liv-text-muted) !important;
        }

        html.livreur-dark input:focus,
        html.livreur-dark select:focus,
        html.livreur-dark textarea:focus {
            border-color: var(--liv-accent) !important;
        }

        html.livreur-dark .hover\:bg-slate-50:hover,
        html.livreur-dark .hover\:bg-slate-100:hover,
        html.livreur-dark .hover\:bg-gray-50:hover,
        html.livreur-dark .hover\:bg-gray-100:hover {
            background-color: var(--liv-bg-hover) !important;
        }

        html.livreur-dark .shadow-sm,
        html.livreur-dark .shadow,
        html.livreur-dark .shadow-lg,
        html.livreur-dark .shadow-xl,
        html.livreur-dark .shadow-2xl {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4) !important;
        }

        /* Garder le gradient livreur vibrant */
        html.livreur-dark .gradient-livreur {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%) !important;
        }

        /* Badges et accents */
        html.livreur-dark .text-emerald-600,
        html.livreur-dark .text-emerald-700 {
            color: var(--liv-success) !important;
        }

        html.livreur-dark .text-amber-700,
        html.livreur-dark .text-amber-800,
        html.livreur-dark .text-amber-900 {
            color: #fbbf24 !important;
        }

        html.livreur-dark .text-red-600,
        html.livreur-dark .text-red-700 {
            color: var(--liv-accent) !important;
        }

        /* Scrollbars */
        html.livreur-dark ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        html.livreur-dark ::-webkit-scrollbar-track {
            background: var(--liv-bg-primary);
        }

        html.livreur-dark ::-webkit-scrollbar-thumb {
            background: var(--liv-bg-hover);
            border-radius: 3px;
        }

        html.livreur-dark ::-webkit-scrollbar-thumb:hover {
            background: var(--liv-text-muted);
        }

        /* Navigation du bas */
        html.livreur-dark nav.bg-white {
            background-color: var(--liv-bg-secondary) !important;
            border-color: var(--liv-border) !important;
        }

        /* Header */
        html.livreur-dark header.bg-white {
            background-color: var(--liv-bg-secondary) !important;
            border-color: var(--liv-border) !important;
        }

        /* ========== END LIVREUR DARK THEME ========== */

        /* ========== GESTIONNAIRE DARK THEME ========== */
        html.gestionnaire-dark,
        html.gestionnaire-dark body {
            background-color: var(--wa-bg-primary) !important;
            color: var(--wa-text-primary) !important;
        }

        html.gestionnaire-dark #app {
            background-color: var(--wa-bg-primary) !important;
        }

        html.gestionnaire-dark .bg-white,
        html.gestionnaire-dark .bg-slate-50,
        html.gestionnaire-dark .bg-gray-50 {
            background-color: var(--wa-bg-secondary) !important;
        }

        html.gestionnaire-dark .bg-slate-100,
        html.gestionnaire-dark .bg-gray-100,
        html.gestionnaire-dark .bg-amber-50,
        html.gestionnaire-dark .bg-orange-50,
        html.gestionnaire-dark .bg-yellow-50 {
            background-color: var(--wa-bg-card) !important;
        }

        html.gestionnaire-dark .text-slate-900,
        html.gestionnaire-dark .text-slate-800,
        html.gestionnaire-dark .text-slate-700,
        html.gestionnaire-dark .text-gray-900,
        html.gestionnaire-dark .text-gray-800,
        html.gestionnaire-dark .text-gray-700 {
            color: var(--wa-text-primary) !important;
        }

        html.gestionnaire-dark .text-slate-600,
        html.gestionnaire-dark .text-slate-500,
        html.gestionnaire-dark .text-gray-600,
        html.gestionnaire-dark .text-gray-500 {
            color: var(--wa-text-secondary) !important;
        }

        html.gestionnaire-dark .border-slate-200,
        html.gestionnaire-dark .border-slate-100,
        html.gestionnaire-dark .border-gray-200,
        html.gestionnaire-dark .border-gray-100 {
            border-color: var(--wa-border) !important;
        }

        html.gestionnaire-dark input,
        html.gestionnaire-dark select,
        html.gestionnaire-dark textarea {
            background-color: var(--wa-bg-input) !important;
            border-color: var(--wa-border) !important;
            color: var(--wa-text-primary) !important;
        }

        html.gestionnaire-dark .bg-slate-200,
        html.gestionnaire-dark .bg-gray-200 {
            background-color: var(--wa-bg-hover) !important;
        }

        html.gestionnaire-dark .shadow-sm,
        html.gestionnaire-dark .shadow,
        html.gestionnaire-dark .shadow-lg {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4) !important;
        }

        html.gestionnaire-dark table th {
            background-color: var(--wa-bg-secondary) !important;
            color: var(--wa-text-secondary) !important;
        }

        html.gestionnaire-dark table td {
            border-color: var(--wa-border) !important;
        }

        html.gestionnaire-dark ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        html.gestionnaire-dark ::-webkit-scrollbar-track {
            background: var(--wa-bg-primary);
        }

        html.gestionnaire-dark ::-webkit-scrollbar-thumb {
            background: var(--wa-bg-hover);
            border-radius: 3px;
        }
        /* ========== END GESTIONNAIRE DARK THEME ========== */

        /* ========== MANAGER DARK THEME ========== */
        html.manager-dark,
        html.manager-dark body {
            background-color: var(--wa-bg-primary) !important;
            color: var(--wa-text-primary) !important;
        }

        html.manager-dark #app {
            background-color: var(--wa-bg-primary) !important;
        }

        html.manager-dark .bg-white,
        html.manager-dark .bg-slate-50,
        html.manager-dark .bg-gray-50 {
            background-color: var(--wa-bg-secondary) !important;
        }

        html.manager-dark .bg-slate-100,
        html.manager-dark .bg-gray-100,
        html.manager-dark .bg-sky-50,
        html.manager-dark .bg-blue-50,
        html.manager-dark .bg-cyan-50 {
            background-color: var(--wa-bg-card) !important;
        }

        html.manager-dark .text-slate-900,
        html.manager-dark .text-slate-800,
        html.manager-dark .text-slate-700,
        html.manager-dark .text-gray-900,
        html.manager-dark .text-gray-800,
        html.manager-dark .text-gray-700 {
            color: var(--wa-text-primary) !important;
        }

        html.manager-dark .text-slate-600,
        html.manager-dark .text-slate-500,
        html.manager-dark .text-gray-600,
        html.manager-dark .text-gray-500 {
            color: var(--wa-text-secondary) !important;
        }

        html.manager-dark .border-slate-200,
        html.manager-dark .border-slate-100,
        html.manager-dark .border-gray-200,
        html.manager-dark .border-gray-100 {
            border-color: var(--wa-border) !important;
        }

        html.manager-dark input,
        html.manager-dark select,
        html.manager-dark textarea {
            background-color: var(--wa-bg-input) !important;
            border-color: var(--wa-border) !important;
            color: var(--wa-text-primary) !important;
        }

        html.manager-dark .bg-slate-200,
        html.manager-dark .bg-gray-200 {
            background-color: var(--wa-bg-hover) !important;
        }

        html.manager-dark .shadow-sm,
        html.manager-dark .shadow,
        html.manager-dark .shadow-lg {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4) !important;
        }

        html.manager-dark table th {
            background-color: var(--wa-bg-secondary) !important;
            color: var(--wa-text-secondary) !important;
        }

        html.manager-dark table td {
            border-color: var(--wa-border) !important;
        }

        html.manager-dark ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        html.manager-dark ::-webkit-scrollbar-track {
            background: var(--wa-bg-primary);
        }

        html.manager-dark ::-webkit-scrollbar-thumb {
            background: var(--wa-bg-hover);
            border-radius: 3px;
        }
        /* ========== END MANAGER DARK THEME ========== */

        /* ========== PDG DARK THEME ========== */
        html.pdg-dark,
        html.pdg-dark body {
            background-color: var(--wa-bg-primary) !important;
            color: var(--wa-text-primary) !important;
        }

        html.pdg-dark #app {
            background-color: var(--wa-bg-primary) !important;
        }

        html.pdg-dark .bg-white,
        html.pdg-dark .bg-slate-50,
        html.pdg-dark .bg-gray-50 {
            background-color: var(--wa-bg-secondary) !important;
        }

        html.pdg-dark .bg-slate-100,
        html.pdg-dark .bg-gray-100,
        html.pdg-dark .bg-amber-50,
        html.pdg-dark .bg-yellow-50,
        html.pdg-dark .bg-indigo-50,
        html.pdg-dark .bg-violet-50 {
            background-color: var(--wa-bg-card) !important;
        }

        html.pdg-dark .text-slate-900,
        html.pdg-dark .text-slate-800,
        html.pdg-dark .text-slate-700,
        html.pdg-dark .text-gray-900,
        html.pdg-dark .text-gray-800,
        html.pdg-dark .text-gray-700 {
            color: var(--wa-text-primary) !important;
        }

        html.pdg-dark .text-slate-600,
        html.pdg-dark .text-slate-500,
        html.pdg-dark .text-gray-600,
        html.pdg-dark .text-gray-500 {
            color: var(--wa-text-secondary) !important;
        }

        html.pdg-dark .border-slate-200,
        html.pdg-dark .border-slate-100,
        html.pdg-dark .border-gray-200,
        html.pdg-dark .border-gray-100 {
            border-color: var(--wa-border) !important;
        }

        html.pdg-dark input,
        html.pdg-dark select,
        html.pdg-dark textarea {
            background-color: var(--wa-bg-input) !important;
            border-color: var(--wa-border) !important;
            color: var(--wa-text-primary) !important;
        }

        html.pdg-dark .bg-slate-200,
        html.pdg-dark .bg-gray-200 {
            background-color: var(--wa-bg-hover) !important;
        }

        html.pdg-dark .shadow-sm,
        html.pdg-dark .shadow,
        html.pdg-dark .shadow-lg {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4) !important;
        }

        html.pdg-dark table th {
            background-color: var(--wa-bg-secondary) !important;
            color: var(--wa-text-secondary) !important;
        }

        html.pdg-dark table td {
            border-color: var(--wa-border) !important;
        }

        html.pdg-dark ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        html.pdg-dark ::-webkit-scrollbar-track {
            background: var(--wa-bg-primary);
        }

        html.pdg-dark ::-webkit-scrollbar-thumb {
            background: var(--wa-bg-hover);
            border-radius: 3px;
        }

        /* Couleurs d'accent ambrées pour PDG en mode sombre */
        html.pdg-dark .text-amber-600,
        html.pdg-dark .text-amber-500,
        html.pdg-dark .text-amber-700 {
            color: #fbbf24 !important;
        }

        html.pdg-dark .bg-amber-500,
        html.pdg-dark .bg-amber-600 {
            background-color: #f59e0b !important;
        }
        /* ========== END PDG DARK THEME ========== */

        /* Gradients Premium */
        .gradient-pdg { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .gradient-manager { background: linear-gradient(135deg, #0284c7 0%, #0891b2 100%); }
        .gradient-gestionnaire { background: linear-gradient(135deg, #d97706 0%, #ea580c 100%); }
        .gradient-vendeur { background: linear-gradient(135deg, #059669 0%, #10b981 100%); }
        .gradient-livreur { background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.72);
            -webkit-backdrop-filter: blur(14px);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, 0.55);
        }
        .glass-dark {
            background: rgba(15, 23, 42, 0.55);
            -webkit-backdrop-filter: blur(14px);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        /* Animations pour le panier flottant */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .slide-in-right {
            animation: slideInRight 0.3s ease-out forwards;
        }
        .slide-up {
            animation: slideUp 0.3s ease-out forwards;
        }

        /* ========== RESPONSIVE MOBILE ADAPTATION ========== */
        /* Sidebar: hidden on mobile, overlay on toggle */
        @media (max-width: 1023px) {
            aside {
                position: fixed !important;
                left: 0; top: 0; bottom: 0;
                z-index: 999 !important;
                transform: translateX(-100%);
                transition: transform 0.3s cubic-bezier(0.4,0,0.2,1) !important;
                width: 280px !important;
                max-width: 85vw !important;
            }
            aside.mobile-open {
                transform: translateX(0) !important;
            }
            .mobile-sidebar-overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 998;
                backdrop-filter: blur(2px);
            }
            .mobile-sidebar-overlay.active {
                display: block;
            }
            /* Hamburger button */
            .mobile-hamburger {
                display: flex !important;
                position: fixed;
                top: 12px; left: 12px;
                z-index: 997;
                width: 44px; height: 44px;
                border-radius: 12px;
                background: linear-gradient(135deg, #1e293b, #334155);
                color: white;
                align-items: center;
                justify-content: center;
                border: none;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                -webkit-tap-highlight-color: transparent;
            }
            .mobile-hamburger svg { width: 22px; height: 22px; }
            /* Main content: full width on mobile - zero side padding */
            main {
                padding: 0 !important;
                padding-top: 60px !important;
                padding-bottom: 70px !important;
            }
            /* Settings pages full width on mobile */
            main > .space-y-6.fade-in,
            main > .space-y-4,
            main > div > .space-y-6.fade-in,
            main > div {
                padding-left: 0 !important;
                padding-right: 0 !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
            /* Cards use full width */
            main .space-y-6 > div,
            main .space-y-4 > div {
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
            /* Full width buttons and cards - tighter padding on mobile */
            main .p-6 { padding: 12px !important; }
            main .p-8 { padding: 12px !important; }
            main .px-6 { padding-left: 12px !important; padding-right: 12px !important; }
            main .px-8 { padding-left: 12px !important; padding-right: 12px !important; }
            /* Remove excessive border radius for edge-to-edge feel */
            main .rounded-2xl,
            main .rounded-3xl,
            main .rounded-xl {
                border-radius: 8px !important;
            }
            /* Full width grid items with tighter gap */
            main .grid { gap: 8px !important; }
            /* Ensure buttons fill width */
            main button.w-full { width: 100% !important; }
            /* Bottom mobile nav */
            .mobile-bottom-nav {
                display: flex !important;
                position: fixed;
                bottom: 0; left: 0; right: 0;
                z-index: 996;
                background: linear-gradient(to top, #0f172a, #1e293b);
                border-top: 1px solid rgba(255,255,255,0.1);
                padding: 4px 8px;
                padding-bottom: env(safe-area-inset-bottom, 4px);
                justify-content: space-around;
                align-items: center;
                gap: 2px;
            }
            .mobile-bottom-nav button {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 2px;
                padding: 6px 2px;
                border: none;
                background: transparent;
                color: #94a3b8;
                font-size: 9px;
                font-weight: 700;
                cursor: pointer;
                border-radius: 8px;
                transition: all 0.2s;
                -webkit-tap-highlight-color: transparent;
                min-width: 0;
            }
            .mobile-bottom-nav button.active {
                color: #10b981;
                background: rgba(16,185,129,0.1);
            }
            .mobile-bottom-nav button svg,
            .mobile-bottom-nav button i { width: 20px; height: 20px; }
            /* Responsive grids */
            .grid-cols-2 { grid-template-columns: 1fr !important; }
            .grid-cols-3 { grid-template-columns: 1fr !important; }
            .grid-cols-4 { grid-template-columns: repeat(2, 1fr) !important; }
            .grid-cols-5 { grid-template-columns: repeat(2, 1fr) !important; }
            .grid-cols-6 { grid-template-columns: repeat(2, 1fr) !important; }
            /* Fix text overflow */
            .truncate, h1, h2, h3 { overflow-wrap: break-word; word-break: break-word; }
            /* Make tables scrollable */
            table { display: block; overflow-x: auto; }
            /* Fix fixed-right floating buttons */
            .fixed.right-4.bottom-6 { bottom: 70px !important; }
        }
        /* Tablet: handled by mobile overlay mode */
        /* Hide mobile elements on desktop */
        @media (min-width: 1024px) {
            .mobile-hamburger { display: none !important; }
            .mobile-bottom-nav { display: none !important; }
            .mobile-sidebar-overlay { display: none !important; }
        }
        /* Touch-friendly buttons on mobile */
        @media (max-width: 1023px) {
            button, .btn, [onclick] { min-height: 40px; }
            input, select, textarea { font-size: 16px !important; }
        }


        /* --- P3: SYNC STATUS INDICATOR --- */
        #syncIndicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9998;
            display: none;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 500;
            color: #fff;
            background: rgba(30,30,30,0.88);
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 12px rgba(0,0,0,0.25);
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
            transform: translateY(10px);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            cursor: pointer;
            user-select: none;
        }
        #syncIndicator.visible {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }
        #syncIndicator .sync-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }
        #syncIndicator .sync-spinner {
            animation: syncSpin 1s linear infinite;
        }
        @keyframes syncSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        #syncIndicator.sync-ok { background: rgba(22,163,74,0.92); }
        #syncIndicator.sync-err { background: rgba(220,38,38,0.92); }
        #syncIndicator.sync-conflict { background: rgba(234,179,8,0.92); color: #1a1a1a; }
        #syncIndicator .sync-time {
            font-size: 11px;
            opacity: 0.75;
            margin-left: 4px;
        }
        /* Move above mobile bottom nav on small screens */
        @media (max-width: 1023px) {
            #syncIndicator { bottom: 80px; }
        }

    </style>






<style id="raya-login-css">
/* -------------------------------------------------------------------
   RAYA SaaS - Auth & Onboarding Styles
   Adapted from Modules API/js/onboarding-ui.js
   ------------------------------------------------------------------- */

.auth-page, .auth-page *, .auth-page *::before, .auth-page *::after { box-sizing: border-box; }

/* ===== AUTH PAGE LAYOUT ===== */
.auth-page {
    display: flex;
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.auth-left {
    flex: 1;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

@media (min-width: 1024px) {
    .auth-left { display: flex; }
}

.auth-branding {
    max-width: 500px;
}

.auth-branding h1 {
    font-size: 3rem;
    font-weight: 800;
    margin-bottom: 1rem;
}

.auth-branding p {
    font-size: 1.1rem;
    opacity: 0.9;
    line-height: 1.6;
    margin-bottom: 2rem;
}

.auth-features {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
}

.auth-feature {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255,255,255,0.15);
    padding: 0.75rem 1.25rem;
    border-radius: 50px;
    font-size: 0.9rem;
    backdrop-filter: blur(10px);
}

.auth-feature svg {
    width: 18px;
    height: 18px;
}

.auth-right {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    background: white;
}

@media (min-width: 1024px) {
    .auth-right {
        border-radius: 2rem 0 0 2rem;
        max-width: 550px;
    }
}

.auth-container {
    width: 100%;
    max-width: 400px;
}

.auth-logo {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 2rem;
}

.auth-logo-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.auth-logo-text {
    font-size: 1.75rem;
    font-weight: 800;
    color: #1a1a2e;
    letter-spacing: -0.02em;
}

.auth-header {
    margin-bottom: 2rem;
}

.auth-header h2 {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1a1a2e;
    margin-bottom: 0.5rem;
}

.auth-header p {
    color: #6b7280;
    font-size: 1rem;
}

/* Tab Switcher */
.auth-tab-switcher {
    display: flex;
    background: #f3f4f6;
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 1.5rem;
}

.auth-tab-btn {
    flex: 1;
    padding: 0.75rem 1rem;
    border: none;
    background: transparent;
    border-radius: 10px;
    font-weight: 600;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.95rem;
}

.auth-tab-btn.active {
    background: white;
    color: #1a1a2e;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

/* Social Buttons */
.social-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.btn-social {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    background: white;
    font-weight: 600;
    font-size: 0.95rem;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-social:hover {
    border-color: #d1d5db;
    background: #f9fafb;
}

.btn-social svg { width: 20px; height: 20px; }

.btn-apple {
    background: #000;
    border-color: #000;
    color: white;
}

.btn-apple:hover {
    background: #1a1a1a;
    border-color: #1a1a1a;
}

/* Divider */
.auth-divider {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin: 1.5rem 0;
    color: #9ca3af;
    font-size: 0.875rem;
}

.auth-divider::before,
.auth-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: #e5e7eb;
}

/* Form Styles */
.auth-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-group label {
    font-weight: 600;
    font-size: 0.875rem;
    color: #374151;
}

.input-wrapper {
    position: relative;
}

.form-input {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.2s ease;
    background: white;
    box-sizing: border-box;
}

.form-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-input.has-icon {
    padding-right: 3rem;
}

.input-toggle {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    padding: 0.25rem;
}

.input-toggle:hover { color: #6b7280; }

/* Form Options */
.form-options {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.875rem;
}

.checkbox-wrapper {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.checkbox-wrapper input {
    width: 18px;
    height: 18px;
    accent-color: #667eea;
    cursor: pointer;
}

.checkbox-wrapper span { color: #6b7280; }

.link-forgot {
    color: #667eea;
    text-decoration: none;
    font-weight: 500;
}

.link-forgot:hover { text-decoration: underline; }

/* Submit Button */
.btn-submit {
    width: 100%;
    padding: 1rem;
    border: none;
    border-radius: 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
}

.btn-submit:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

/* Error Message */
.auth-error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
    padding: 0.75rem 1rem;
    border-radius: 10px;
    font-size: 0.875rem;
    display: none;
}

.auth-error.show { display: block; }

/* Footer */
.auth-footer {
    text-align: center;
    margin-top: 1.5rem;
    color: #6b7280;
    font-size: 0.875rem;
}

.auth-footer a {
    color: #667eea;
    font-weight: 600;
    text-decoration: none;
}

.auth-footer a:hover { text-decoration: underline; }

/* Register Form Row */
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
}

.modal-content {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modal-header {
    text-align: center;
    margin-bottom: 1.5rem;
}

.modal-header h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1a1a2e;
    margin-bottom: 0.5rem;
}

.modal-header p { color: #6b7280; }

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
    animation: fadeIn 0.3s ease-out;
}

/* Loading Spinner */
.spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ===== ONBOARDING CARD STYLES ===== */
.onboarding-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.onboarding-card {
    background: white;
    border-radius: 24px;
    padding: 2.5rem;
    max-width: 450px;
    width: 100%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
}

.onboarding-card-wide { max-width: 800px; }

.choice-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin: 2rem 0;
}

.choice-card {
    border: 2px solid #e5e7eb;
    border-radius: 16px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.choice-card:hover {
    border-color: #667eea;
    transform: translateY(-4px);
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
}

.choice-icon {
    width: 60px;
    height: 60px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1rem;
    color: white;
}

.choice-card h3 {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1a1a2e;
    margin-bottom: 0.5rem;
}

.choice-card p {
    color: #6b7280;
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.choice-features {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.choice-features span {
    font-size: 0.8rem;
    color: #059669;
}

.gradient-pdg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.gradient-gestionnaire { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
.gradient-vendeur { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    font-size: 0.95rem;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
}

.btn-outline {
    background: white;
    border: 2px solid #e5e7eb;
    color: #374151;
}

.btn-outline:hover {
    border-color: #667eea;
    color: #667eea;
}

.btn-block { width: 100%; }

.btn-back {
    position: absolute;
    top: 1.5rem;
    left: 1.5rem;
    background: none;
    border: none;
    color: #6b7280;
    cursor: pointer;
    padding: 0.5rem;
    font-size: 0.95rem;
}

.btn-logout {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 2rem;
    color: #6b7280;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
}

.btn-logout:hover { color: #dc2626; }

.text-center { text-align: center; }
.text-muted { color: #6b7280; }

.user-welcome {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.avatar {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    font-size: 1.25rem;
}

.avatar-lg { width: 60px; height: 60px; font-size: 1.5rem; }

/* Form Sections */
.form-section {
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
}

.form-section h3 {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 1rem;
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
}

.tags-input {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 0.5rem;
    min-height: 50px;
}

.tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.tag {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    background: #e5e7eb;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
}

.tag button {
    background: none;
    border: none;
    cursor: pointer;
    color: #6b7280;
    font-size: 1rem;
}

.tags-input input {
    border: none;
    outline: none;
    width: 100%;
    padding: 0.25rem;
    font-size: 0.95rem;
}

.step-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.step {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #e5e7eb;
    color: #6b7280;
    font-weight: 600;
    font-size: 0.875rem;
}

.step.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.step.done {
    background: #059669;
    color: white;
}

.step-line {
    width: 40px;
    height: 2px;
    background: #e5e7eb;
}

select.form-input { cursor: pointer; }

/* Join Methods */
.join-methods {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.join-method {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
}

.join-method.active { border-color: #667eea; }

.join-method-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    cursor: pointer;
    font-weight: 600;
}

.join-method-header .chevron {
    margin-left: auto;
    transition: transform 0.2s;
}

.join-method.active .join-method-header .chevron {
    transform: rotate(180deg);
}

.join-method-content {
    display: none;
    padding: 0 1rem 1rem;
}

.join-method.active .join-method-content { display: block; }

.input-code {
    font-size: 1.25rem;
    text-align: center;
    letter-spacing: 0.25em;
    text-transform: uppercase;
}

/* Pending Screen */
.pending-icon { margin-bottom: 1.5rem; }
.icon-xl { width: 80px; height: 80px; }
.text-warning { color: #f59e0b; }

.pending-info {
    background: #f9fafb;
    border-radius: 12px;
    padding: 1.5rem;
    margin: 1.5rem 0;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
    color: #374151;
}

.info-item:last-child { margin-bottom: 0; }

.pending-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

/* Alert */
.alert {
    padding: 0.75rem 1rem;
    border-radius: 10px;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.alert-error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
}

.alert-success {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    color: #059669;
}

.hidden { display: none !important; }

/* Tenant List */
.tenant-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin: 1.5rem 0;
}

.tenant-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.tenant-item:hover {
    border-color: #667eea;
    background: #f9fafb;
}

.tenant-avatar {
    width: 45px;
    height: 45px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
}

.tenant-info { flex: 1; }

.tenant-info h4 {
    font-weight: 600;
    color: #1a1a2e;
    margin-bottom: 0.25rem;
}

.badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.badge-pdg { background: #ede9fe; color: #7c3aed; }
.badge-manager { background: #dbeafe; color: #2563eb; }
.badge-gestionnaire { background: #d1fae5; color: #059669; }
.badge-vendeur { background: #fef3c7; color: #d97706; }
.badge-livreur { background: #fee2e2; color: #dc2626; }

</style>
</head>
<body>
    <div id="app"></div>
    <script>
    // Parse an entity ID from a dropdown value - preserves string IDs (e.g. 'idm_123') instead of parseInt which returns NaN
    function parseId(val) {
        if (!val || val === '' || val === '0') return null;
        const n = Number(val);
        return Number.isFinite(n) && String(n) === String(val) ? n : val;
    }

    const Utils = {
        uid(prefix = 'ID') {
            const time = Date.now().toString(36);
            const random = Math.random().toString(36).slice(2, 10);
            const core = `${time}${random}`.toUpperCase();
            return prefix ? `${prefix}-${core}` : core;
        },
        safeJsonParse(str, fallback = null) {
            try { return JSON.parse(str); } catch (err) { return fallback; }
        },
        todayKey(offset = 0) {
            const date = new Date();
            if (offset) date.setDate(date.getDate() + Number(offset));
            return date.toISOString().slice(0, 10);
        },
        clamp(value, min, max) {
            const num = Number(value);
            if (Number.isNaN(num)) return min;
            return Math.min(Math.max(num, min), max);
        },
        // SECURITY: HTML escaping utility to prevent XSS — use for ALL user-controlled data injected via innerHTML
        escapeHtml(str) {
            if (str == null) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        },
        async md5(str) {
            const input = String(str || '');
            try {
                if (window.crypto?.subtle && typeof TextEncoder !== 'undefined') {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(input);
                    const digest = await window.crypto.subtle.digest('SHA-256', data);
                    return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2, '0')).join('');
                }
            } catch (err) {
                console.warn('[SECURITY] crypto.subtle failed, using weak fallback hash:', err?.message);
            }
            console.warn('[SECURITY] crypto.subtle unavailable — using weak fallback hash. Ensure HTTPS is enabled.');
            return this.md5Sync(input);
        },
        md5Sync(str) {
            let hash = 0;
            const input = String(str || '');
            for (let i = 0; i < input.length; i++) {
                const char = input.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0;
            }
            const absHash = Math.abs(hash);
            const hex = absHash.toString(16) || '0';
            const repeats = Math.ceil(64 / hex.length);
            return hex.repeat(repeats).slice(0, 64);
        },
        readFileAsDataUrl(file) {
            return new Promise((resolve, reject) => {
                if (!file) return reject(new Error('Fichier invalide'));
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error || new Error('Lecture impossible'));
                reader.readAsDataURL(file);
            });
        },
        loadScript(src, id) {
            return new Promise((resolve, reject) => {
                if (id && document.getElementById(id)) return resolve(true);
                if (document.querySelector(`script[src="${src}"]`)) return resolve(true);
                const script = document.createElement('script');
                if (id) script.id = id;
                script.src = src;
                script.async = true;
                script.onload = () => resolve(true);
                script.onerror = () => reject(new Error('Script load failed: ' + src));
                document.head.appendChild(script);
            });
        },
        ensureChartJs() {
            if (window.Chart) return Promise.resolve(true);
            if (!this._chartJsPromise) {
                this._chartJsPromise = this.loadScript(
                    'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js',
                    'chartjs-cdn'
                );
            }
            return this._chartJsPromise;
        },
        // Wait for deferred Lucide script to load
        ensureLucide() {
            if (window.lucide) return Promise.resolve(true);
            if (!this._lucidePromise) {
                this._lucidePromise = new Promise((resolve) => {
                    const check = () => {
                        if (window.lucide) { resolve(true); }
                        else { setTimeout(check, 50); }
                    };
                    check();
                });
            }
            return this._lucidePromise;
        },
        // Safe createIcons: waits for lucide then renders
        safeCreateIcons(root) {
            this.ensureLucide().then(() => {
                try { lucide.createIcons({ nodes: root ? [root] : undefined }); }
                catch(e) {}
            });
        }
    };
    window.Utils = Utils;

    // =========================================================
    // GOOGLE MAPS (Embed + Optional JS API)
    // =========================================================
    // Google Maps auth error hook: fallback to iframe when key is invalid/restricted
    window.gm_authFailure = function() {
        try {
            if (window.CORE && window.CORE.config) {
                window.CORE.config.googleMapsApiKey = '';
                try { window.CORE.save && window.CORE.save(); } catch (e) { console.warn('[MAPS] CORE.save failed:', e); }
            }
        } catch (e) { console.warn('[MAPS] Failed to clear Google Maps API key:', e); }
        try { UI?.toast && UI.toast('Google Maps API: clé invalide (fallback iframe).', 'warning'); } catch (e) { console.warn('[MAPS] UI.toast failed:', e); }
    };

    const Maps = {
        // Default center: Brazzaville
        defaultCenter: { lat: -4.263359, lng: 15.242885 },
        _apiLoaded: false,
        _apiLoading: false,
        _queue: [],

        encode(obj) {
            try {
                return btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
            } catch(e) {
                return '';
            }
        },
        decode(b64) {
            try {
                return JSON.parse(decodeURIComponent(escape(atob(b64))));
            } catch(e) {
                return null;
            }
        },

        embedUrl(query) {
            const q = String(query || '').trim() || 'Brazzaville, Congo';
            return `https://www.google.com/maps?q=${encodeURIComponent(q)}&output=embed`;
        },

        directionsUrl(destination, origin = null) {
            const dest = String(destination || '').trim();
            if (!dest) return 'https://www.google.com/maps';
            const base = 'https://www.google.com/maps/dir/?api=1';
            const params = new URLSearchParams();
            params.set('destination', dest);
            if (origin) params.set('origin', String(origin));
            params.set('travelmode', 'driving');
            return `${base}&${params.toString()}`;
        },

        openDirections(destination, origin = null) {
            window.open(this.directionsUrl(destination, origin), '_blank');
        },

        openDirectionsB64(b64) {
            const data = this.decode(b64) || {};
            const destination = data.destination || data.address || '';
            const origin = data.origin || null;
            return this.openDirections(destination, origin);
        },

        getApiKey() {
            // When served from file://, Google Maps JS API often fails due to referrer restrictions.
            // Prefer iframe mode in that case.
            try {
                if (location.protocol === 'file:') return '';
            } catch(e) {}
            const k = (window.CORE?.config?.googleMapsApiKey || '').trim();
            return k;
        },

        ensureApi(cb) {
            const key = this.getApiKey();
            if (!key) return;
            if (this._apiLoaded) return cb && cb();
            this._queue.push(cb);
            if (this._apiLoading) return;
            this._apiLoading = true;

            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&libraries=places`;
            script.async = true;
            script.defer = true;
            script.onload = () => {
                this._apiLoaded = true;
                this._apiLoading = false;
                const q = [...this._queue];
                this._queue = [];
                q.forEach(fn => { try { fn && fn(); } catch(e) {} });
            };
            script.onerror = () => {
                this._apiLoading = false;
                this._queue = [];
                // Fallback to iframe mode if API fails to load (invalid key, blocked referrer, network)
                try {
                    if (window.CORE && window.CORE.config) {
                        window.CORE.config.googleMapsApiKey = '';
                        try { window.CORE.save && window.CORE.save(); } catch(e) {}
                    }
                } catch(e) {}
                try { UI?.toast && UI.toast('Google Maps API indisponible (fallback iframe).', 'warning'); } catch(e) {}
                try { App?.rerender && App.rerender(); } catch(e) {}
            };
            document.head.appendChild(script);
        },

        initMapsFromDom() {
            const containers = document.querySelectorAll('[data-gmap]');
            if (!containers.length) return;

            const key = this.getApiKey();
            if (!key) return; // iframe mode is used when no key

            this.ensureApi(() => {
                containers.forEach((el) => {
                    if (el.__gmapInited) return;
                    const payload = el.getAttribute('data-gmap');
                    const data = this.decode(payload) || {};
                    const canvas = el.querySelector('[data-gmap-canvas]');
                    if (!canvas) return;

                    el.__gmapInited = true;

                    const map = new google.maps.Map(canvas, {
                        center: this.defaultCenter,
                        zoom: 13,
                        mapTypeControl: false,
                        streetViewControl: false,
                        fullscreenControl: false
                    });

                    const destination = String(data.destination || '').trim();
                    if (!destination) return;

                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ address: destination }, (results, status) => {
                        if (status !== 'OK' || !results || !results[0]) return;
                        const loc = results[0].geometry.location;
                        map.setCenter(loc);
                        map.setZoom(15);
                        new google.maps.Marker({ map, position: loc, title: data.label || destination });
                    });
                });
            });
        },

        afterRender() {
            // Called after each App.mount
            this.initMapsFromDom();
        }
    };

    // =========================================================
    // SYSTÈME DE TRADUCTION (i18n)
    // =========================================================
    const i18n = {
        currentLang: 'fr',

        translations: {
            fr: {
                // Navigation & Menu
                'nav.home': 'Accueil',
                'nav.orders': 'Commandes',
                'nav.products': 'Produits',
                'nav.clients': 'Clients',
                'nav.delivery': 'Livraison',
                'nav.finance': 'Finance',
                'nav.settings': 'Paramètres',
                'nav.help': 'Aide',
                'nav.logout': 'Déconnexion',
                'nav.profile': 'Profil',

                // Actions
                'action.save': 'Enregistrer',
                'action.cancel': 'Annuler',
                'action.delete': 'Supprimer',
                'action.edit': 'Modifier',
                'action.add': 'Ajouter',
                'action.search': 'Rechercher',
                'action.filter': 'Filtrer',
                'action.export': 'Exporter',
                'action.print': 'Imprimer',
                'action.confirm': 'Confirmer',
                'action.close': 'Fermer',
                'action.back': 'Retour',
                'action.next': 'Suivant',
                'action.previous': 'Précédent',
                'action.validate': 'Valider',
                'action.send': 'Envoyer',

                // Status
                'status.pending': 'En attente',
                'status.confirmed': 'Confirmé',
                'status.shipped': 'Expédié',
                'status.delivered': 'Livré',
                'status.cancelled': 'Annulé',
                'status.returned': 'Retourné',
                'status.active': 'Actif',
                'status.inactive': 'Inactif',
                'status.paid': 'Payé',
                'status.unpaid': 'Non payé',

                // Labels
                'label.date': 'Date',
                'label.amount': 'Montant',
                'label.total': 'Total',
                'label.quantity': 'Quantité',
                'label.price': 'Prix',
                'label.name': 'Nom',
                'label.phone': 'Téléphone',
                'label.address': 'Adresse',
                'label.email': 'Email',
                'label.notes': 'Notes',
                'label.description': 'Description',
                'label.category': 'Catégorie',
                'label.payment': 'Paiement',
                'label.customer': 'Client',
                'label.product': 'Produit',
                'label.order': 'Commande',
                'label.delivery': 'Livraison',
                'label.stock': 'Stock',
                'label.revenue': 'Chiffre d\'affaires',
                'label.profit': 'Bénéfice',
                'label.expenses': 'Dépenses',

                // Messages
                'msg.success': 'Opération réussie',
                'msg.error': 'Une erreur est survenue',
                'msg.loading': 'Chargement...',
                'msg.noData': 'Aucune donnée',
                'msg.confirmDelete': 'Êtes-vous sûr de vouloir supprimer ?',
                'msg.saved': 'Enregistré avec succès',
                'msg.deleted': 'Supprimé avec succès',
                'msg.updated': 'Mis à jour avec succès',

                // Time
                'time.today': 'Aujourd\'hui',
                'time.yesterday': 'Hier',
                'time.thisWeek': 'Cette semaine',
                'time.thisMonth': 'Ce mois',
                'time.thisYear': 'Cette année',

                // Settings
                'settings.theme': 'Thème',
                'settings.language': 'Langue',
                'settings.notifications': 'Notifications',
                'settings.preferences': 'Préférences',
                'settings.light': 'Clair',
                'settings.dark': 'Sombre',
                'settings.auto': 'Auto',
                'settings.chooseLanguage': 'Choisissez votre langue préférée',

                // Dashboard
                'dashboard.welcome': 'Bienvenue',
                'dashboard.todaySales': 'Ventes du jour',
                'dashboard.pendingOrders': 'Commandes en attente',
                'dashboard.lowStock': 'Stock faible',
                'dashboard.newClients': 'Nouveaux clients',

                // Products
                'product.addNew': 'Nouveau produit',
                'product.inStock': 'En stock',
                'product.outOfStock': 'Rupture de stock',
                'product.lowStock': 'Stock faible',

                // Orders
                'order.new': 'Nouvelle commande',
                'order.details': 'Détails de la commande',
                'order.items': 'Articles',
                'order.subtotal': 'Sous-total',
                'order.tax': 'Taxe',
                'order.discount': 'Remise',

                // Finance
                'finance.income': 'Revenus',
                'finance.expenses': 'Dépenses',
                'finance.balance': 'Solde',
                'finance.transactions': 'Transactions',
                'finance.budget': 'Budget',
                'finance.report': 'Rapport financier',

                // Vendeur specific
                'vendeur.myPos': 'Mon Point de Vente',
                'vendeur.mySales': 'Mes Ventes',
                'vendeur.myClients': 'Mes Clients',
                'vendeur.newSale': 'Nouvelle Vente',
                'vendeur.cart': 'Panier',
                'vendeur.checkout': 'Paiement',

                // Vendor menu items
                'menu.dashboard': 'Tableau de bord',
                'menu.pos': 'Point de vente',
                'menu.clients': 'Clients',
                'menu.orders': 'Commandes',
                'menu.stock': 'Stock',
                'menu.deliverers': 'Livreurs',
                'menu.reservations': 'Réservations',
                'menu.commissions': 'Commissions',
                'menu.routing': 'Routage',
                'menu.finance': 'Finance',
                'menu.assignment': 'Assignation',
                'menu.reports': 'Rapports',
                'menu.settings': 'Paramètres',
                'menu.logout': 'Déconnexion',
                'menu.all': 'Tout',
                'menu.seeAll': 'Voir tout'
            },

            en: {
                // Navigation & Menu
                'nav.home': 'Home',
                'nav.orders': 'Orders',
                'nav.products': 'Products',
                'nav.clients': 'Customers',
                'nav.delivery': 'Delivery',
                'nav.finance': 'Finance',
                'nav.settings': 'Settings',
                'nav.help': 'Help',
                'nav.logout': 'Logout',
                'nav.profile': 'Profile',

                // Actions
                'action.save': 'Save',
                'action.cancel': 'Cancel',
                'action.delete': 'Delete',
                'action.edit': 'Edit',
                'action.add': 'Add',
                'action.search': 'Search',
                'action.filter': 'Filter',
                'action.export': 'Export',
                'action.print': 'Print',
                'action.confirm': 'Confirm',
                'action.close': 'Close',
                'action.back': 'Back',
                'action.next': 'Next',
                'action.previous': 'Previous',
                'action.validate': 'Validate',
                'action.send': 'Send',

                // Status
                'status.pending': 'Pending',
                'status.confirmed': 'Confirmed',
                'status.shipped': 'Shipped',
                'status.delivered': 'Delivered',
                'status.cancelled': 'Cancelled',
                'status.returned': 'Returned',
                'status.active': 'Active',
                'status.inactive': 'Inactive',
                'status.paid': 'Paid',
                'status.unpaid': 'Unpaid',

                // Labels
                'label.date': 'Date',
                'label.amount': 'Amount',
                'label.total': 'Total',
                'label.quantity': 'Quantity',
                'label.price': 'Price',
                'label.name': 'Name',
                'label.phone': 'Phone',
                'label.address': 'Address',
                'label.email': 'Email',
                'label.notes': 'Notes',
                'label.description': 'Description',
                'label.category': 'Category',
                'label.payment': 'Payment',
                'label.customer': 'Customer',
                'label.product': 'Product',
                'label.order': 'Order',
                'label.delivery': 'Delivery',
                'label.stock': 'Stock',
                'label.revenue': 'Revenue',
                'label.profit': 'Profit',
                'label.expenses': 'Expenses',

                // Messages
                'msg.success': 'Operation successful',
                'msg.error': 'An error occurred',
                'msg.loading': 'Loading...',
                'msg.noData': 'No data',
                'msg.confirmDelete': 'Are you sure you want to delete?',
                'msg.saved': 'Saved successfully',
                'msg.deleted': 'Deleted successfully',
                'msg.updated': 'Updated successfully',

                // Time
                'time.today': 'Today',
                'time.yesterday': 'Yesterday',
                'time.thisWeek': 'This week',
                'time.thisMonth': 'This month',
                'time.thisYear': 'This year',

                // Settings
                'settings.theme': 'Theme',
                'settings.language': 'Language',
                'settings.notifications': 'Notifications',
                'settings.preferences': 'Preferences',
                'settings.light': 'Light',
                'settings.dark': 'Dark',
                'settings.auto': 'Auto',
                'settings.chooseLanguage': 'Choose your preferred language',

                // Dashboard
                'dashboard.welcome': 'Welcome',
                'dashboard.todaySales': 'Today\'s Sales',
                'dashboard.pendingOrders': 'Pending Orders',
                'dashboard.lowStock': 'Low Stock',
                'dashboard.newClients': 'New Customers',

                // Products
                'product.addNew': 'New Product',
                'product.inStock': 'In Stock',
                'product.outOfStock': 'Out of Stock',
                'product.lowStock': 'Low Stock',

                // Orders
                'order.new': 'New Order',
                'order.details': 'Order Details',
                'order.items': 'Items',
                'order.subtotal': 'Subtotal',
                'order.tax': 'Tax',
                'order.discount': 'Discount',

                // Finance
                'finance.income': 'Income',
                'finance.expenses': 'Expenses',
                'finance.balance': 'Balance',
                'finance.transactions': 'Transactions',
                'finance.budget': 'Budget',
                'finance.report': 'Financial Report',

                // Vendeur specific
                'vendeur.myPos': 'My Point of Sale',
                'vendeur.mySales': 'My Sales',
                'vendeur.myClients': 'My Customers',
                'vendeur.newSale': 'New Sale',
                'vendeur.cart': 'Cart',
                'vendeur.checkout': 'Checkout',

                // Vendor menu items
                'menu.dashboard': 'Dashboard',
                'menu.pos': 'Point of Sale',
                'menu.clients': 'Customers',
                'menu.orders': 'Orders',
                'menu.stock': 'Stock',
                'menu.deliverers': 'Deliverers',
                'menu.reservations': 'Reservations',
                'menu.commissions': 'Commissions',
                'menu.routing': 'Routing',
                'menu.finance': 'Finance',
                'menu.assignment': 'Assignment',
                'menu.reports': 'Reports',
                'menu.settings': 'Settings',
                'menu.logout': 'Logout',
                'menu.all': 'All',
                'menu.seeAll': 'See all'
            },

            es: {
                // Navigation & Menu
                'nav.home': 'Inicio',
                'nav.orders': 'Pedidos',
                'nav.products': 'Productos',
                'nav.clients': 'Clientes',
                'nav.delivery': 'Entrega',
                'nav.finance': 'Finanzas',
                'nav.settings': 'Configuración',
                'nav.help': 'Ayuda',
                'nav.logout': 'Cerrar sesión',
                'nav.profile': 'Perfil',

                // Actions
                'action.save': 'Guardar',
                'action.cancel': 'Cancelar',
                'action.delete': 'Eliminar',
                'action.edit': 'Editar',
                'action.add': 'Agregar',
                'action.search': 'Buscar',
                'action.filter': 'Filtrar',
                'action.export': 'Exportar',
                'action.print': 'Imprimir',
                'action.confirm': 'Confirmar',
                'action.close': 'Cerrar',
                'action.back': 'Atrás',
                'action.next': 'Siguiente',
                'action.previous': 'Anterior',
                'action.validate': 'Validar',
                'action.send': 'Enviar',

                // Status
                'status.pending': 'Pendiente',
                'status.confirmed': 'Confirmado',
                'status.shipped': 'Enviado',
                'status.delivered': 'Entregado',
                'status.cancelled': 'Cancelado',
                'status.returned': 'Devuelto',
                'status.active': 'Activo',
                'status.inactive': 'Inactivo',
                'status.paid': 'Pagado',
                'status.unpaid': 'No pagado',

                // Labels
                'label.date': 'Fecha',
                'label.amount': 'Monto',
                'label.total': 'Total',
                'label.quantity': 'Cantidad',
                'label.price': 'Precio',
                'label.name': 'Nombre',
                'label.phone': 'Teléfono',
                'label.address': 'Dirección',
                'label.email': 'Correo',
                'label.notes': 'Notas',
                'label.description': 'Descripción',
                'label.category': 'Categoría',
                'label.payment': 'Pago',
                'label.customer': 'Cliente',
                'label.product': 'Producto',
                'label.order': 'Pedido',
                'label.delivery': 'Entrega',
                'label.stock': 'Stock',
                'label.revenue': 'Ingresos',
                'label.profit': 'Beneficio',
                'label.expenses': 'Gastos',

                // Messages
                'msg.success': 'Operación exitosa',
                'msg.error': 'Ocurrió un error',
                'msg.loading': 'Cargando...',
                'msg.noData': 'Sin datos',
                'msg.confirmDelete': '¿Está seguro de que desea eliminar?',
                'msg.saved': 'Guardado exitosamente',
                'msg.deleted': 'Eliminado exitosamente',
                'msg.updated': 'Actualizado exitosamente',

                // Time
                'time.today': 'Hoy',
                'time.yesterday': 'Ayer',
                'time.thisWeek': 'Esta semana',
                'time.thisMonth': 'Este mes',
                'time.thisYear': 'Este año',

                // Settings
                'settings.theme': 'Tema',
                'settings.language': 'Idioma',
                'settings.notifications': 'Notificaciones',
                'settings.preferences': 'Preferencias',
                'settings.light': 'Claro',
                'settings.dark': 'Oscuro',
                'settings.auto': 'Auto',
                'settings.chooseLanguage': 'Elige tu idioma preferido',

                // Dashboard
                'dashboard.welcome': 'Bienvenido',
                'dashboard.todaySales': 'Ventas del día',
                'dashboard.pendingOrders': 'Pedidos pendientes',
                'dashboard.lowStock': 'Stock bajo',
                'dashboard.newClients': 'Nuevos clientes',

                // Products
                'product.addNew': 'Nuevo producto',
                'product.inStock': 'En stock',
                'product.outOfStock': 'Sin stock',
                'product.lowStock': 'Stock bajo',

                // Orders
                'order.new': 'Nuevo pedido',
                'order.details': 'Detalles del pedido',
                'order.items': 'Artículos',
                'order.subtotal': 'Subtotal',
                'order.tax': 'Impuesto',
                'order.discount': 'Descuento',

                // Finance
                'finance.income': 'Ingresos',
                'finance.expenses': 'Gastos',
                'finance.balance': 'Saldo',
                'finance.transactions': 'Transacciones',
                'finance.budget': 'Presupuesto',
                'finance.report': 'Informe financiero',

                // Vendeur specific
                'vendeur.myPos': 'Mi Punto de Venta',
                'vendeur.mySales': 'Mis Ventas',
                'vendeur.myClients': 'Mis Clientes',
                'vendeur.newSale': 'Nueva Venta',
                'vendeur.cart': 'Carrito',
                'vendeur.checkout': 'Pagar',

                // Vendor menu items
                'menu.dashboard': 'Panel de control',
                'menu.pos': 'Punto de venta',
                'menu.clients': 'Clientes',
                'menu.orders': 'Pedidos',
                'menu.stock': 'Stock',
                'menu.deliverers': 'Repartidores',
                'menu.reservations': 'Reservaciones',
                'menu.commissions': 'Comisiones',
                'menu.routing': 'Enrutamiento',
                'menu.finance': 'Finanzas',
                'menu.assignment': 'Asignación',
                'menu.reports': 'Informes',
                'menu.settings': 'Configuración',
                'menu.logout': 'Cerrar sesión',
                'menu.all': 'Todo',
                'menu.seeAll': 'Ver todo'
            },

            // 🇵🇹 Portuguese (Português)
            pt: {
                'nav.home': 'Início',
                'nav.orders': 'Pedidos',
                'nav.products': 'Produtos',
                'nav.clients': 'Clientes',
                'nav.delivery': 'Entrega',
                'nav.finance': 'Finanças',
                'nav.settings': 'Configurações',
                'nav.help': 'Ajuda',
                'nav.logout': 'Sair',
                'nav.profile': 'Perfil',
                'action.save': 'Salvar',
                'action.cancel': 'Cancelar',
                'action.delete': 'Excluir',
                'action.edit': 'Editar',
                'action.add': 'Adicionar',
                'action.search': 'Pesquisar',
                'action.filter': 'Filtrar',
                'action.export': 'Exportar',
                'action.print': 'Imprimir',
                'action.confirm': 'Confirmar',
                'action.close': 'Fechar',
                'action.back': 'Voltar',
                'action.next': 'Próximo',
                'action.previous': 'Anterior',
                'action.validate': 'Validar',
                'action.send': 'Enviar',
                'status.pending': 'Pendente',
                'status.confirmed': 'Confirmado',
                'status.shipped': 'Enviado',
                'status.delivered': 'Entregue',
                'status.cancelled': 'Cancelado',
                'status.returned': 'Devolvido',
                'status.active': 'Ativo',
                'status.inactive': 'Inativo',
                'status.paid': 'Pago',
                'status.unpaid': 'Não pago',
                'label.date': 'Data',
                'label.amount': 'Valor',
                'label.total': 'Total',
                'label.quantity': 'Quantidade',
                'label.price': 'Preço',
                'label.name': 'Nome',
                'label.phone': 'Telefone',
                'label.address': 'Endereço',
                'label.email': 'Email',
                'label.notes': 'Notas',
                'label.description': 'Descrição',
                'label.category': 'Categoria',
                'label.payment': 'Pagamento',
                'label.customer': 'Cliente',
                'label.product': 'Produto',
                'label.order': 'Pedido',
                'label.delivery': 'Entrega',
                'label.stock': 'Estoque',
                'label.revenue': 'Receita',
                'label.profit': 'Lucro',
                'label.expenses': 'Despesas',
                'msg.success': 'Operação bem-sucedida',
                'msg.error': 'Ocorreu um erro',
                'msg.loading': 'Carregando...',
                'msg.noData': 'Sem dados',
                'msg.confirmDelete': 'Tem certeza que deseja excluir?',
                'msg.saved': 'Salvo com sucesso',
                'msg.deleted': 'Excluído com sucesso',
                'msg.updated': 'Atualizado com sucesso',
                'time.today': 'Hoje',
                'time.yesterday': 'Ontem',
                'time.thisWeek': 'Esta semana',
                'time.thisMonth': 'Este mês',
                'time.thisYear': 'Este ano',
                'settings.theme': 'Tema',
                'settings.language': 'Idioma',
                'settings.notifications': 'Notificações',
                'settings.preferences': 'Preferências',
                'settings.light': 'Claro',
                'settings.dark': 'Escuro',
                'settings.auto': 'Auto',
                'settings.chooseLanguage': 'Escolha o seu idioma preferido',
                'dashboard.welcome': 'Bem-vindo',
                'dashboard.todaySales': 'Vendas de hoje',
                'dashboard.pendingOrders': 'Pedidos pendentes',
                'dashboard.lowStock': 'Estoque baixo',
                'dashboard.newClients': 'Novos clientes',
                'finance.income': 'Receitas',
                'finance.expenses': 'Despesas',
                'finance.balance': 'Saldo',
                'finance.transactions': 'Transações',
                'finance.budget': 'Orçamento',
                'finance.report': 'Relatório financeiro',
                'menu.dashboard': 'Painel',
                'menu.pos': 'Ponto de venda',
                'menu.clients': 'Clientes',
                'menu.orders': 'Pedidos',
                'menu.stock': 'Estoque',
                'menu.deliverers': 'Entregadores',
                'menu.reservations': 'Reservas',
                'menu.commissions': 'Comissões',
                'menu.routing': 'Roteamento',
                'menu.finance': 'Finanças',
                'menu.assignment': 'Atribuição',
                'menu.reports': 'Relatórios',
                'menu.settings': 'Configurações',
                'menu.logout': 'Sair',
                'menu.all': 'Tudo',
                'menu.seeAll': 'Ver tudo'
            },

            // 🇩🇪 German (Deutsch)
            de: {
                'nav.home': 'Startseite',
                'nav.orders': 'Bestellungen',
                'nav.products': 'Produkte',
                'nav.clients': 'Kunden',
                'nav.delivery': 'Lieferung',
                'nav.finance': 'Finanzen',
                'nav.settings': 'Einstellungen',
                'nav.help': 'Hilfe',
                'nav.logout': 'Abmelden',
                'nav.profile': 'Profil',
                'action.save': 'Speichern',
                'action.cancel': 'Abbrechen',
                'action.delete': 'Löschen',
                'action.edit': 'Bearbeiten',
                'action.add': 'Hinzufügen',
                'action.search': 'Suchen',
                'action.filter': 'Filtern',
                'action.export': 'Exportieren',
                'action.print': 'Drucken',
                'action.confirm': 'Bestätigen',
                'action.close': 'Schließen',
                'action.back': 'Zurück',
                'action.next': 'Weiter',
                'action.previous': 'Zurück',
                'action.validate': 'Validieren',
                'action.send': 'Senden',
                'status.pending': 'Ausstehend',
                'status.confirmed': 'Bestätigt',
                'status.shipped': 'Versendet',
                'status.delivered': 'Geliefert',
                'status.cancelled': 'Storniert',
                'status.returned': 'Zurückgegeben',
                'status.active': 'Aktiv',
                'status.inactive': 'Inaktiv',
                'status.paid': 'Bezahlt',
                'status.unpaid': 'Unbezahlt',
                'label.date': 'Datum',
                'label.amount': 'Betrag',
                'label.total': 'Gesamt',
                'label.quantity': 'Menge',
                'label.price': 'Preis',
                'label.name': 'Name',
                'label.phone': 'Telefon',
                'label.address': 'Adresse',
                'label.email': 'E-Mail',
                'label.notes': 'Notizen',
                'label.description': 'Beschreibung',
                'label.category': 'Kategorie',
                'label.payment': 'Zahlung',
                'label.customer': 'Kunde',
                'label.product': 'Produkt',
                'label.order': 'Bestellung',
                'label.delivery': 'Lieferung',
                'label.stock': 'Lager',
                'label.revenue': 'Umsatz',
                'label.profit': 'Gewinn',
                'label.expenses': 'Ausgaben',
                'msg.success': 'Vorgang erfolgreich',
                'msg.error': 'Ein Fehler ist aufgetreten',
                'msg.loading': 'Laden...',
                'msg.noData': 'Keine Daten',
                'msg.confirmDelete': 'Sind Sie sicher, dass Sie löschen möchten?',
                'msg.saved': 'Erfolgreich gespeichert',
                'msg.deleted': 'Erfolgreich gelöscht',
                'msg.updated': 'Erfolgreich aktualisiert',
                'time.today': 'Heute',
                'time.yesterday': 'Gestern',
                'time.thisWeek': 'Diese Woche',
                'time.thisMonth': 'Dieser Monat',
                'time.thisYear': 'Dieses Jahr',
                'settings.theme': 'Thema',
                'settings.language': 'Sprache',
                'settings.notifications': 'Benachrichtigungen',
                'settings.preferences': 'Einstellungen',
                'settings.light': 'Hell',
                'settings.dark': 'Dunkel',
                'settings.auto': 'Auto',
                'settings.chooseLanguage': 'Wählen Sie Ihre bevorzugte Sprache',
                'dashboard.welcome': 'Willkommen',
                'dashboard.todaySales': 'Heutige Verkäufe',
                'dashboard.pendingOrders': 'Offene Bestellungen',
                'dashboard.lowStock': 'Niedriger Bestand',
                'dashboard.newClients': 'Neue Kunden',
                'finance.income': 'Einnahmen',
                'finance.expenses': 'Ausgaben',
                'finance.balance': 'Saldo',
                'finance.transactions': 'Transaktionen',
                'finance.budget': 'Budget',
                'finance.report': 'Finanzbericht',
                'menu.dashboard': 'Dashboard',
                'menu.pos': 'Kasse',
                'menu.clients': 'Kunden',
                'menu.orders': 'Bestellungen',
                'menu.stock': 'Lager',
                'menu.deliverers': 'Lieferanten',
                'menu.reservations': 'Reservierungen',
                'menu.commissions': 'Provisionen',
                'menu.routing': 'Routing',
                'menu.finance': 'Finanzen',
                'menu.assignment': 'Zuweisung',
                'menu.reports': 'Berichte',
                'menu.settings': 'Einstellungen',
                'menu.logout': 'Abmelden',
                'menu.all': 'Alle',
                'menu.seeAll': 'Alle anzeigen'
            },

            // 🇮🇹 Italian (Italiano)
            it: {
                'nav.home': 'Home',
                'nav.orders': 'Ordini',
                'nav.products': 'Prodotti',
                'nav.clients': 'Clienti',
                'nav.delivery': 'Consegna',
                'nav.finance': 'Finanza',
                'nav.settings': 'Impostazioni',
                'nav.help': 'Aiuto',
                'nav.logout': 'Esci',
                'nav.profile': 'Profilo',
                'action.save': 'Salva',
                'action.cancel': 'Annulla',
                'action.delete': 'Elimina',
                'action.edit': 'Modifica',
                'action.add': 'Aggiungi',
                'action.search': 'Cerca',
                'action.filter': 'Filtra',
                'action.export': 'Esporta',
                'action.print': 'Stampa',
                'action.confirm': 'Conferma',
                'action.close': 'Chiudi',
                'action.back': 'Indietro',
                'action.next': 'Avanti',
                'action.previous': 'Precedente',
                'action.validate': 'Valida',
                'action.send': 'Invia',
                'status.pending': 'In attesa',
                'status.confirmed': 'Confermato',
                'status.shipped': 'Spedito',
                'status.delivered': 'Consegnato',
                'status.cancelled': 'Annullato',
                'status.returned': 'Restituito',
                'status.active': 'Attivo',
                'status.inactive': 'Inattivo',
                'status.paid': 'Pagato',
                'status.unpaid': 'Non pagato',
                'label.date': 'Data',
                'label.amount': 'Importo',
                'label.total': 'Totale',
                'label.quantity': 'Quantità',
                'label.price': 'Prezzo',
                'label.name': 'Nome',
                'label.phone': 'Telefono',
                'label.address': 'Indirizzo',
                'label.email': 'Email',
                'label.notes': 'Note',
                'label.description': 'Descrizione',
                'label.category': 'Categoria',
                'label.payment': 'Pagamento',
                'label.customer': 'Cliente',
                'label.product': 'Prodotto',
                'label.order': 'Ordine',
                'label.delivery': 'Consegna',
                'label.stock': 'Magazzino',
                'label.revenue': 'Fatturato',
                'label.profit': 'Profitto',
                'label.expenses': 'Spese',
                'msg.success': 'Operazione riuscita',
                'msg.error': 'Si è verificato un errore',
                'msg.loading': 'Caricamento...',
                'msg.noData': 'Nessun dato',
                'msg.confirmDelete': 'Sei sicuro di voler eliminare?',
                'msg.saved': 'Salvato con successo',
                'msg.deleted': 'Eliminato con successo',
                'msg.updated': 'Aggiornato con successo',
                'time.today': 'Oggi',
                'time.yesterday': 'Ieri',
                'time.thisWeek': 'Questa settimana',
                'time.thisMonth': 'Questo mese',
                'time.thisYear': 'Quest\'anno',
                'settings.theme': 'Tema',
                'settings.language': 'Lingua',
                'settings.notifications': 'Notifiche',
                'settings.preferences': 'Preferenze',
                'settings.light': 'Chiaro',
                'settings.dark': 'Scuro',
                'settings.auto': 'Auto',
                'settings.chooseLanguage': 'Scegli la tua lingua preferita',
                'dashboard.welcome': 'Benvenuto',
                'dashboard.todaySales': 'Vendite di oggi',
                'dashboard.pendingOrders': 'Ordini in sospeso',
                'dashboard.lowStock': 'Scorte basse',
                'dashboard.newClients': 'Nuovi clienti',
                'finance.income': 'Entrate',
                'finance.expenses': 'Spese',
                'finance.balance': 'Saldo',
                'finance.transactions': 'Transazioni',
                'finance.budget': 'Budget',
                'finance.report': 'Rapporto finanziario',
                'menu.dashboard': 'Dashboard',
                'menu.pos': 'Punto vendita',
                'menu.clients': 'Clienti',
                'menu.orders': 'Ordini',
                'menu.stock': 'Magazzino',
                'menu.deliverers': 'Corrieri',
                'menu.reservations': 'Prenotazioni',
                'menu.commissions': 'Commissioni',
                'menu.routing': 'Routing',
                'menu.finance': 'Finanza',
                'menu.assignment': 'Assegnazione',
                'menu.reports': 'Rapporti',
                'menu.settings': 'Impostazioni',
                'menu.logout': 'Esci',
                'menu.all': 'Tutto',
                'menu.seeAll': 'Vedi tutto'
            },

            // 🇸🇦 Arabic (العربية)
            ar: {
                'nav.home': 'الرئيسية',
                'nav.orders': 'الطلبات',
                'nav.products': 'المنتجات',
                'nav.clients': 'العملاء',
                'nav.delivery': 'التوصيل',
                'nav.finance': 'المالية',
                'nav.settings': 'الإعدادات',
                'nav.help': 'مساعدة',
                'nav.logout': 'تسجيل الخروج',
                'nav.profile': 'الملف الشخصي',
                'action.save': 'حفظ',
                'action.cancel': 'إلغاء',
                'action.delete': 'حذف',
                'action.edit': 'تعديل',
                'action.add': 'إضافة',
                'action.search': 'بحث',
                'action.filter': 'تصفية',
                'action.export': 'تصدير',
                'action.print': 'طباعة',
                'action.confirm': 'تأكيد',
                'action.close': 'إغلاق',
                'action.back': 'رجوع',
                'action.next': 'التالي',
                'action.previous': 'السابق',
                'action.validate': 'تحقق',
                'action.send': 'إرسال',
                'status.pending': 'قيد الانتظار',
                'status.confirmed': 'مؤكد',
                'status.shipped': 'تم الشحن',
                'status.delivered': 'تم التوصيل',
                'status.cancelled': 'ملغي',
                'status.returned': 'مرتجع',
                'status.active': 'نشط',
                'status.inactive': 'غير نشط',
                'status.paid': 'مدفوع',
                'status.unpaid': 'غير مدفوع',
                'label.date': 'التاريخ',
                'label.amount': 'المبلغ',
                'label.total': 'الإجمالي',
                'label.quantity': 'الكمية',
                'label.price': 'السعر',
                'label.name': 'الاسم',
                'label.phone': 'الهاتف',
                'label.address': 'العنوان',
                'label.email': 'البريد الإلكتروني',
                'label.notes': 'ملاحظات',
                'label.description': 'الوصف',
                'label.category': 'الفئة',
                'label.payment': 'الدفع',
                'label.customer': 'العميل',
                'label.product': 'المنتج',
                'label.order': 'الطلب',
                'label.delivery': 'التوصيل',
                'label.stock': 'المخزون',
                'label.revenue': 'الإيرادات',
                'label.profit': 'الربح',
                'label.expenses': 'المصروفات',
                'msg.success': 'تمت العملية بنجاح',
                'msg.error': 'حدث خطأ',
                'msg.loading': 'جاري التحميل...',
                'msg.noData': 'لا توجد بيانات',
                'msg.confirmDelete': 'هل أنت متأكد من الحذف؟',
                'msg.saved': 'تم الحفظ بنجاح',
                'msg.deleted': 'تم الحذف بنجاح',
                'msg.updated': 'تم التحديث بنجاح',
                'time.today': 'اليوم',
                'time.yesterday': 'أمس',
                'time.thisWeek': 'هذا الأسبوع',
                'time.thisMonth': 'هذا الشهر',
                'time.thisYear': 'هذه السنة',
                'settings.theme': 'المظهر',
                'settings.language': 'اللغة',
                'settings.notifications': 'الإشعارات',
                'settings.preferences': 'التفضيلات',
                'settings.light': 'فاتح',
                'settings.dark': 'داكن',
                'settings.auto': 'تلقائي',
                'settings.chooseLanguage': 'اختر لغتك المفضلة',
                'dashboard.welcome': 'مرحباً',
                'dashboard.todaySales': 'مبيعات اليوم',
                'dashboard.pendingOrders': 'طلبات قيد الانتظار',
                'dashboard.lowStock': 'مخزون منخفض',
                'dashboard.newClients': 'عملاء جدد',
                'finance.income': 'الدخل',
                'finance.expenses': 'المصروفات',
                'finance.balance': 'الرصيد',
                'finance.transactions': 'المعاملات',
                'finance.budget': 'الميزانية',
                'finance.report': 'التقرير المالي',
                'menu.dashboard': 'لوحة التحكم',
                'menu.pos': 'نقطة البيع',
                'menu.clients': 'العملاء',
                'menu.orders': 'الطلبات',
                'menu.stock': 'المخزون',
                'menu.deliverers': 'المندوبين',
                'menu.reservations': 'الحجوزات',
                'menu.commissions': 'العمولات',
                'menu.routing': 'التوجيه',
                'menu.finance': 'المالية',
                'menu.assignment': 'التعيين',
                'menu.reports': 'التقارير',
                'menu.settings': 'الإعدادات',
                'menu.logout': 'خروج',
                'menu.all': 'الكل',
                'menu.seeAll': 'عرض الكل'
            },

            // 🇨🇳 Chinese Simplified (中文简体)
            zh: {
                'nav.home': '首页',
                'nav.orders': '订单',
                'nav.products': '产品',
                'nav.clients': '客户',
                'nav.delivery': '配送',
                'nav.finance': '财务',
                'nav.settings': '设置',
                'nav.help': '帮助',
                'nav.logout': '退出',
                'nav.profile': '个人资料',
                'action.save': '保存',
                'action.cancel': '取消',
                'action.delete': '删除',
                'action.edit': '编辑',
                'action.add': '添加',
                'action.search': '搜索',
                'action.filter': '筛选',
                'action.export': '导出',
                'action.print': '打印',
                'action.confirm': '确认',
                'action.close': '关闭',
                'action.back': '返回',
                'action.next': '下一步',
                'action.previous': '上一步',
                'action.validate': '验证',
                'action.send': '发送',
                'status.pending': '待处理',
                'status.confirmed': '已确认',
                'status.shipped': '已发货',
                'status.delivered': '已送达',
                'status.cancelled': '已取消',
                'status.returned': '已退货',
                'status.active': '活跃',
                'status.inactive': '停用',
                'status.paid': '已支付',
                'status.unpaid': '未支付',
                'label.date': '日期',
                'label.amount': '金额',
                'label.total': '总计',
                'label.quantity': '数量',
                'label.price': '价格',
                'label.name': '名称',
                'label.phone': '电话',
                'label.address': '地址',
                'label.email': '邮箱',
                'label.notes': '备注',
                'label.description': '描述',
                'label.category': '类别',
                'label.payment': '支付',
                'label.customer': '客户',
                'label.product': '产品',
                'label.order': '订单',
                'label.delivery': '配送',
                'label.stock': '库存',
                'label.revenue': '收入',
                'label.profit': '利润',
                'label.expenses': '支出',
                'msg.success': '操作成功',
                'msg.error': '发生错误',
                'msg.loading': '加载中...',
                'msg.noData': '暂无数据',
                'msg.confirmDelete': '确定要删除吗？',
                'msg.saved': '保存成功',
                'msg.deleted': '删除成功',
                'msg.updated': '更新成功',
                'time.today': '今天',
                'time.yesterday': '昨天',
                'time.thisWeek': '本周',
                'time.thisMonth': '本月',
                'time.thisYear': '今年',
                'settings.theme': '主题',
                'settings.language': '语言',
                'settings.notifications': '通知',
                'settings.preferences': '偏好设置',
                'settings.light': '浅色',
                'settings.dark': '深色',
                'settings.auto': '自动',
                'settings.chooseLanguage': '选择您的首选语言',
                'dashboard.welcome': '欢迎',
                'dashboard.todaySales': '今日销售',
                'dashboard.pendingOrders': '待处理订单',
                'dashboard.lowStock': '库存不足',
                'dashboard.newClients': '新客户',
                'finance.income': '收入',
                'finance.expenses': '支出',
                'finance.balance': '余额',
                'finance.transactions': '交易',
                'finance.budget': '预算',
                'finance.report': '财务报告',
                'menu.dashboard': '仪表盘',
                'menu.pos': '销售点',
                'menu.clients': '客户',
                'menu.orders': '订单',
                'menu.stock': '库存',
                'menu.deliverers': '配送员',
                'menu.reservations': '预订',
                'menu.commissions': '佣金',
                'menu.routing': '路由',
                'menu.finance': '财务',
                'menu.assignment': '分配',
                'menu.reports': '报告',
                'menu.settings': '设置',
                'menu.logout': '退出',
                'menu.all': '全部',
                'menu.seeAll': '查看全部'
            },

            // 🇷🇺 Russian (Русский)
            ru: {
                'nav.home': 'Главная',
                'nav.orders': 'Заказы',
                'nav.products': 'Товары',
                'nav.clients': 'Клиенты',
                'nav.delivery': 'Доставка',
                'nav.finance': 'Финансы',
                'nav.settings': 'Настройки',
                'nav.help': 'Помощь',
                'nav.logout': 'Выйти',
                'nav.profile': 'Профиль',
                'action.save': 'Сохранить',
                'action.cancel': 'Отмена',
                'action.delete': 'Удалить',
                'action.edit': 'Редактировать',
                'action.add': 'Добавить',
                'action.search': 'Поиск',
                'action.filter': 'Фильтр',
                'action.export': 'Экспорт',
                'action.print': 'Печать',
                'action.confirm': 'Подтвердить',
                'action.close': 'Закрыть',
                'action.back': 'Назад',
                'action.next': 'Далее',
                'action.previous': 'Назад',
                'action.validate': 'Проверить',
                'action.send': 'Отправить',
                'status.pending': 'Ожидает',
                'status.confirmed': 'Подтверждён',
                'status.shipped': 'Отправлен',
                'status.delivered': 'Доставлен',
                'status.cancelled': 'Отменён',
                'status.returned': 'Возврат',
                'status.active': 'Активен',
                'status.inactive': 'Неактивен',
                'status.paid': 'Оплачен',
                'status.unpaid': 'Не оплачен',
                'label.date': 'Дата',
                'label.amount': 'Сумма',
                'label.total': 'Итого',
                'label.quantity': 'Количество',
                'label.price': 'Цена',
                'label.name': 'Имя',
                'label.phone': 'Телефон',
                'label.address': 'Адрес',
                'label.email': 'Email',
                'label.notes': 'Заметки',
                'label.description': 'Описание',
                'label.category': 'Категория',
                'label.payment': 'Оплата',
                'label.customer': 'Клиент',
                'label.product': 'Товар',
                'label.order': 'Заказ',
                'label.delivery': 'Доставка',
                'label.stock': 'Склад',
                'label.revenue': 'Выручка',
                'label.profit': 'Прибыль',
                'label.expenses': 'Расходы',
                'msg.success': 'Операция успешна',
                'msg.error': 'Произошла ошибка',
                'msg.loading': 'Загрузка...',
                'msg.noData': 'Нет данных',
                'msg.confirmDelete': 'Вы уверены, что хотите удалить?',
                'msg.saved': 'Успешно сохранено',
                'msg.deleted': 'Успешно удалено',
                'msg.updated': 'Успешно обновлено',
                'time.today': 'Сегодня',
                'time.yesterday': 'Вчера',
                'time.thisWeek': 'На этой неделе',
                'time.thisMonth': 'В этом месяце',
                'time.thisYear': 'В этом году',
                'settings.theme': 'Тема',
                'settings.language': 'Язык',
                'settings.notifications': 'Уведомления',
                'settings.preferences': 'Настройки',
                'settings.light': 'Светлая',
                'settings.dark': 'Тёмная',
                'settings.auto': 'Авто',
                'settings.chooseLanguage': 'Выберите предпочитаемый язык',
                'dashboard.welcome': 'Добро пожаловать',
                'dashboard.todaySales': 'Продажи сегодня',
                'dashboard.pendingOrders': 'Заказы в ожидании',
                'dashboard.lowStock': 'Низкий запас',
                'dashboard.newClients': 'Новые клиенты',
                'finance.income': 'Доход',
                'finance.expenses': 'Расходы',
                'finance.balance': 'Баланс',
                'finance.transactions': 'Транзакции',
                'finance.budget': 'Бюджет',
                'finance.report': 'Финансовый отчёт',
                'menu.dashboard': 'Панель',
                'menu.pos': 'Касса',
                'menu.clients': 'Клиенты',
                'menu.orders': 'Заказы',
                'menu.stock': 'Склад',
                'menu.deliverers': 'Курьеры',
                'menu.reservations': 'Бронирования',
                'menu.commissions': 'Комиссии',
                'menu.routing': 'Маршруты',
                'menu.finance': 'Финансы',
                'menu.assignment': 'Назначение',
                'menu.reports': 'Отчёты',
                'menu.settings': 'Настройки',
                'menu.logout': 'Выйти',
                'menu.all': 'Все',
                'menu.seeAll': 'Показать все'
            }
        },

        // Langues RTL (Right-to-Left)
        rtlLanguages: ['ar', 'he', 'fa', 'ur'],

        setLang(lang) {
            if (this.translations[lang]) {
                this.currentLang = lang;
                document.documentElement.lang = lang;
                localStorage.setItem('raya_language', lang);
                localStorage.setItem('vendeur_language', lang);

                // Gérer RTL pour l'arabe et autres langues
                if (this.rtlLanguages.includes(lang)) {
                    document.documentElement.dir = 'rtl';
                    document.body.style.direction = 'rtl';
                } else {
                    document.documentElement.dir = 'ltr';
                    document.body.style.direction = 'ltr';
                }

                // Persister dans la config CORE
                if (typeof CORE !== 'undefined' && CORE.db) {
                    CORE.db.config = CORE.db.config || {};
                    CORE.db.config.language = lang;
                    if (CORE.save) CORE.save(true);
                }
            }
        },

        // Alias pour compatibilité — ManagerModule, GestionnaireModule, PDGModule, LivreurModule appellent setLanguage()
        setLanguage(lang) {
            this.setLang(lang);
        },

        loadLang() {
            const saved = localStorage.getItem('raya_language') || localStorage.getItem('vendeur_language');
            if (saved && this.translations[saved]) {
                this.currentLang = saved;
                document.documentElement.lang = saved;

                // Appliquer RTL si nécessaire
                if (this.rtlLanguages.includes(saved)) {
                    document.documentElement.dir = 'rtl';
                    document.body.style.direction = 'rtl';
                }
            }
        },

        t(key, fallback = null) {
            const lang = this.currentLang || 'fr';
            const trans = this.translations[lang];
            if (trans && trans[key]) {
                return trans[key];
            }
            // Fallback to French
            if (this.translations.fr && this.translations.fr[key]) {
                return this.translations.fr[key];
            }
            return fallback || key;
        }
    };

    // Alias pour compatibilité avec le code existant (I18n majuscule)
    const I18n = i18n;
    // -- Alias .current ? .currentLang pour les modules qui lisent I18n.current --
    Object.defineProperty(I18n, 'current', { get() { return this.currentLang; } });

    // Fonction globale de traduction
    function t(key, fallback = null) {
        return i18n.t(key, fallback);
    }

    // =========================================================
    // CRDT: Hybrid Logical Clock (HLC) — monotonic ordering across devices
    // =========================================================
    const HLC = {
        _wallTime: 0,
        _counter: 0,
        _deviceId: '',

        init(deviceId) {
            this._deviceId = deviceId;
            this._wallTime = Date.now();
            this._counter = 0;
        },

        /** Generate a new HLC timestamp: "wallTime36-counter36-deviceId" */
        now() {
            var pt = Date.now();
            if (pt > this._wallTime) {
                this._wallTime = pt;
                this._counter = 0;
            } else {
                this._counter++;
            }
            return this._wallTime.toString(36).padStart(10, '0') + '-'
                 + this._counter.toString(36).padStart(4, '0') + '-'
                 + this._deviceId;
        },

        /** Merge with a remote HLC: advances local clock past remote */
        merge(remoteHlc) {
            if (!remoteHlc) return this.now();
            var parts = remoteHlc.split('-');
            if (parts.length < 2) return this.now();
            var remotePt = parseInt(parts[0], 36);
            var remoteCounter = parseInt(parts[1], 36);
            var pt = Date.now();

            if (pt > this._wallTime && pt > remotePt) {
                this._wallTime = pt;
                this._counter = 0;
            } else if (remotePt > this._wallTime) {
                this._wallTime = remotePt;
                this._counter = remoteCounter + 1;
            } else if (this._wallTime === remotePt) {
                this._counter = Math.max(this._counter, remoteCounter) + 1;
            } else {
                this._counter++;
            }
            return this.now();
        },

        /** Compare two HLC strings: returns -1, 0, or 1 */
        compare(a, b) {
            if (!a && !b) return 0;
            if (!a) return -1;
            if (!b) return 1;
            // Lexicographic comparison works because wallTime is zero-padded base36
            return a < b ? -1 : (a > b ? 1 : 0);
        },

        /** Extract wall time (ms) from an HLC string */
        wallTime(hlc) {
            if (!hlc) return 0;
            var parts = hlc.split('-');
            return parseInt(parts[0], 36) || 0;
        },

        /** Extract deviceId from an HLC string */
        device(hlc) {
            if (!hlc) return '';
            var parts = hlc.split('-');
            return parts.length >= 3 ? parts.slice(2).join('-') : '';
        }
    };

    // =========================================================
    // CRDT: Device Identity — unique per browser instance
    // =========================================================
    const DeviceId = {
        _key: 'raya_device_id',
        _id: null,

        get() {
            if (this._id) return this._id;
            this._id = localStorage.getItem(this._key);
            if (!this._id) {
                // Generate 8-char random hex ID
                this._id = Array.from(crypto.getRandomValues(new Uint8Array(4)))
                    .map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
                localStorage.setItem(this._key, this._id);
            }
            return this._id;
        }
    };

    // Initialize HLC with device identity
    HLC.init(DeviceId.get());

    // =========================================================
    // SYSTÈME MULTI-COMPTES (Account Switcher)
    // =========================================================
    const AccountSwitcher = {
        STORAGE_KEY: 'raya_saved_accounts',

        _getUserKey() {
            const cu = CORE.state?.currentUser;
            const uid = cu ? (cu.username || cu.email || cu.id || '') : '';
            return uid ? this.STORAGE_KEY + '_' + uid.toLowerCase().replace(/[^a-z0-9]/g, '_') : this.STORAGE_KEY;
        },

        getSavedAccounts() {
            const userKey = this._getUserKey();
            const migratedFlag = userKey + '_migrated';
            try {
                let accounts = JSON.parse(localStorage.getItem(userKey) || '[]');
                // Migration one-time only: si jamais migré et la clé per-user est vide
                if (accounts.length === 0 && userKey !== this.STORAGE_KEY && !localStorage.getItem(migratedFlag)) {
                    const globalAccounts = JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]');
                    if (globalAccounts.length > 0) {
                        const cu = CORE.state?.currentUser;
                        const cuName = (cu?.username || cu?.email || '').toLowerCase();
                        accounts = globalAccounts.filter(a => (a.username || '').toLowerCase() !== cuName);
                        localStorage.setItem(userKey, JSON.stringify(accounts));
                    }
                    localStorage.setItem(migratedFlag, '1');
                }
                return accounts;
            } catch(e) { return []; }
        },

        saveAccounts(accounts) {
            localStorage.setItem(this._getUserKey(), JSON.stringify(accounts));
            // Marquer comme migré pour éviter que la suppression ne re-déclenche la migration
            const migratedFlag = this._getUserKey() + '_migrated';
            localStorage.setItem(migratedFlag, '1');
            // Aussi nettoyer de la clé globale pour éviter toute résurgence
            try {
                const global = JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]');
                if (global.length > 0) {
                    const savedIds = new Set(accounts.map(a => a.id));
                    const cleaned = global.filter(a => savedIds.has(a.id));
                    if (cleaned.length !== global.length) {
                        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(cleaned));
                    }
                }
            } catch(e) {}
        },

        addAccount(name, username, password) {
            const accounts = this.getSavedAccounts();
            const existing = accounts.findIndex(a => a.username === username);
            const account = {
                id: existing >= 0 ? accounts[existing].id : 'acc_' + CORE.uid(),
                name: name.trim(),
                username: username.trim(),
                password: password,
                lastUsed: null,
                addedAt: existing >= 0 ? accounts[existing].addedAt : new Date().toISOString()
            };
            if (existing >= 0) accounts[existing] = account;
            else accounts.push(account);
            this.saveAccounts(accounts);
            return account;
        },

        removeAccount(accountId) {
            this.saveAccounts(this.getSavedAccounts().filter(a => String(a.id) !== String(accountId)));
        },

        PREV_ACCOUNT_KEY: 'raya_previous_account',
        RETURN_BTN_POS_KEY: 'raya_return_btn_pos',

        _savePreviousAccount() {
            const cu = CORE.state?.currentUser;
            if (!cu) return;
            // Sauvegarder directement les infos du user actuel + tenantId
            const prevData = {
                id: cu.id || CORE.uid(),
                name: cu.name || cu.username || '',
                username: cu.username || cu.email || '',
                email: cu.email || cu.username || '',
                role: cu.role || 'vendeur',
                tenantId: CORE.tenantId || 'default',
                companyId: cu.companyId || CORE.tenantId || 'default',
                storeId: cu.storeId || null,
                pos: cu.pos || null,
                savedAt: new Date().toISOString()
            };
            // Essayer de récupérer le mot de passe depuis les comptes sauvegardés
            const accounts = this.getSavedAccounts();
            const saved = accounts.find(a => a.username === cu.username || a.username === cu.email);
            if (saved && saved.password) prevData.password = saved.password;
            localStorage.setItem(this.PREV_ACCOUNT_KEY, JSON.stringify(prevData));
        },

        getPreviousAccount() {
            try { return JSON.parse(localStorage.getItem(this.PREV_ACCOUNT_KEY) || 'null'); } catch(e) { return null; }
        },

        clearPreviousAccount() {
            localStorage.removeItem(this.PREV_ACCOUNT_KEY);
        },

        async goBackToPreviousAccount() {
            const prev = this.getPreviousAccount();
            if (!prev) return UI.toast('Aucun compte précédent', 'warning');
            this.clearPreviousAccount();
            this._removeReturnButton();

            // Si on a un refresh token, utiliser switchToAccount (uses refresh token now)
            if (prev.refreshToken) {
                await this.switchToAccount(prev);
                return;
            }

            // Sinon, retour direct local (sans API) via tenantId
            try {
                const overlay = document.createElement('div');
                overlay.id = 'account-switch-overlay';
                overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:99999;flex-direction:column;gap:16px;';
                overlay.innerHTML = '<div style="color:white;font-size:20px;font-weight:bold;">↩ Retour au compte précédent...</div>'
                    + '<div style="color:#aaa;font-size:14px;">' + Utils.escapeHtml(prev.name || '') + '</div>'
                    + '<div style="width:40px;height:40px;border:4px solid #555;border-top-color:#4CAF50;border-radius:50%;animation:spin 1s linear infinite;"></div>';
                document.body.appendChild(overlay);

                const targetTenant = prev.tenantId || prev.companyId || 'default';
                CORE.switchTenant(targetTenant);

                // Trouver l'utilisateur dans le tenant
                const email = (prev.username || prev.email || '').toLowerCase();
                let localUser = (CORE.db.users || []).find(u =>
                    (u.username === email || u.email === email || u.id === prev.id) && u.active !== false
                );
                if (localUser) {
                    if (!localUser.pos && localUser.storeId) localUser.pos = String(localUser.storeId);
                    CORE.state.currentUser = localUser;
                    CORE.save(true);
                    App.launchRole(localUser.role);
                    App.rerender();
                    overlay.remove();
                    UI.toast('✅ Retour à ' + (localUser.name || localUser.username), 'success');
                } else {
                    overlay.remove();
                    UI.toast('❌ Utilisateur non trouvé dans le tenant', 'error');
                }
            } catch(err) {
                console.error('[AccountSwitcher] GoBack failed:', err);
                const ov = document.getElementById('account-switch-overlay');
                if (ov) ov.remove();
                UI.toast('❌ Erreur: ' + (err.message || err), 'error');
            }
        },

        _removeReturnButton() {
            const btn = document.getElementById('acc-return-float-btn');
            if (btn) btn.remove();
        },

        showReturnButton() {
            const prev = this.getPreviousAccount();
            if (!prev) return;
            const cu = CORE.state?.currentUser;
            if (cu && cu.username === prev.username) { this.clearPreviousAccount(); return; }
            this._removeReturnButton();

            const btn = document.createElement('div');
            btn.id = 'acc-return-float-btn';
            const savedPos = (() => { try { return JSON.parse(localStorage.getItem(this.RETURN_BTN_POS_KEY)); } catch(e) { return null; } })();
            const startX = savedPos?.x ?? 16;
            const startY = savedPos?.y ?? (window.innerHeight - 90);
            btn.style.cssText = 'position:fixed;left:' + startX + 'px;top:' + startY + 'px;width:52px;height:52px;background:linear-gradient(135deg,#e53935,#c62828);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:grab;z-index:99998;box-shadow:0 4px 16px rgba(229,57,53,0.5),0 0 0 3px rgba(255,255,255,0.15);transition:box-shadow 0.2s;touch-action:none;user-select:none;';
            btn.innerHTML = '<svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>';
            btn.title = '↩ Revenir à ' + (prev.name || prev.username);

            // Tooltip label under button
            const label = document.createElement('div');
            label.style.cssText = 'position:absolute;bottom:-22px;left:50%;transform:translateX(-50%);white-space:nowrap;font-size:10px;color:white;background:rgba(0,0,0,0.7);padding:2px 6px;border-radius:6px;pointer-events:none;';
            label.textContent = prev.name || prev.username;
            btn.appendChild(label);

            // Drag logic (mouse + touch)
            let isDragging = false, wasDragged = false, offsetX = 0, offsetY = 0;

            const onStart = (e) => {
                isDragging = true; wasDragged = false;
                btn.style.cursor = 'grabbing';
                btn.style.transition = 'none';
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const rect = btn.getBoundingClientRect();
                offsetX = clientX - rect.left; offsetY = clientY - rect.top;
                e.preventDefault();
            };

            const onMove = (e) => {
                if (!isDragging) return;
                wasDragged = true;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                let newX = clientX - offsetX, newY = clientY - offsetY;
                newX = Math.max(0, Math.min(window.innerWidth - 56, newX));
                newY = Math.max(0, Math.min(window.innerHeight - 56, newY));
                btn.style.left = newX + 'px'; btn.style.top = newY + 'px';
                e.preventDefault();
            };

            const onEnd = () => {
                if (!isDragging) return;
                isDragging = false;
                btn.style.cursor = 'grab';
                btn.style.transition = 'box-shadow 0.2s';
                localStorage.setItem(this.RETURN_BTN_POS_KEY, JSON.stringify({ x: parseInt(btn.style.left), y: parseInt(btn.style.top) }));
                if (!wasDragged) {
                    AccountSwitcher.goBackToPreviousAccount();
                }
            };

            // P3-3: Use AbortController so listeners can be cleaned up
            if (this._returnBtnAbort) this._returnBtnAbort.abort();
            this._returnBtnAbort = new AbortController();
            const sig = { signal: this._returnBtnAbort.signal };

            btn.addEventListener('mousedown', onStart, sig);
            document.addEventListener('mousemove', onMove, sig);
            document.addEventListener('mouseup', onEnd, sig);
            btn.addEventListener('touchstart', onStart, { passive: false, ...sig });
            document.addEventListener('touchmove', onMove, { passive: false, ...sig });
            document.addEventListener('touchend', onEnd, sig);

            // Hover effect
            btn.addEventListener('mouseenter', () => { if (!isDragging) btn.style.boxShadow = '0 6px 24px rgba(229,57,53,0.7),0 0 0 4px rgba(255,255,255,0.25)'; }, sig);
            btn.addEventListener('mouseleave', () => { if (!isDragging) btn.style.boxShadow = '0 4px 16px rgba(229,57,53,0.5),0 0 0 3px rgba(255,255,255,0.15)'; }, sig);

            document.body.appendChild(btn);
        },

        async switchToAccount(accJson) {
            let account;
            try { account = typeof accJson === 'string' ? JSON.parse(accJson) : accJson; } catch(e) { return; }
            try {
                // Sauvegarder le compte actuel AVANT de toucher quoi que ce soit
                this._savePreviousAccount();

                const accounts = this.getSavedAccounts();
                const idx = accounts.findIndex(a => a.id === account.id);
                if (idx >= 0) { accounts[idx].lastUsed = new Date().toISOString(); this.saveAccounts(accounts); }

                const overlay = document.createElement('div');
                overlay.id = 'account-switch-overlay';
                overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:99999;flex-direction:column;gap:16px;';
                overlay.innerHTML = '<div style="color:white;font-size:20px;font-weight:bold;">🔄 Connexion en cours...</div>'
                    + '<div style="color:#aaa;font-size:14px;">' + Utils.escapeHtml(account.name || '') + ' (@' + Utils.escapeHtml(account.username || '') + ')</div>'
                    + '<div style="width:40px;height:40px;border:4px solid #555;border-top-color:#4CAF50;border-radius:50%;animation:spin 1s linear infinite;"></div>';
                document.body.appendChild(overlay);

                // === SECURITY: Use refresh token instead of stored password ===
                const email = (account.username || '').trim().toLowerCase();
                const storedRefreshToken = account.refreshToken || null;

                // Stratégie 1: Use stored refresh token to get new access token
                if (CORE.state.isOnline && typeof API !== 'undefined' && storedRefreshToken) {
                    try {
                        // Temporarily set the account's refresh token
                        API.setRefreshToken(storedRefreshToken);
                        const refreshOk = await API._refreshAccessToken();
                        if (refreshOk) {
                            // Get user info from the refreshed session
                            try {
                                const meData = await API.getMe();
                                if (meData) {
                                    const tenantId = meData.tenantId || CORE.tenantId || 'default';
                                    try { API.tenantId = tenantId; } catch(e) { console.warn('[AUTH] Failed to set API.tenantId:', e); }

                                    if (typeof CORE.tenantExists === 'function' && !CORE.tenantExists(tenantId)) {
                                        if (typeof CORE.createTenantWithAdmin === 'function') {
                                            CORE.createTenantWithAdmin(tenantId, meData.tenantName || tenantId, {
                                                name: (meData.firstName || '') + ' ' + (meData.lastName || ''),
                                                username: meData.username || email,
                                                email: meData.email || email,
                                                _authMethod: 'api',
                                                role: (meData.role || 'vendeur').toLowerCase(),
                                                companyId: tenantId
                                            });
                                        }
                                    }
                                    CORE.switchTenant(tenantId);

                                    let localUser = (CORE.db.users || []).find(u =>
                                        u.email === (meData.email || email) || u.username === (meData.username || email)
                                    );
                                    if (!localUser) {
                                        localUser = {
                                            id: meData.id || CORE.uid(),
                                            name: (meData.firstName || '') + ' ' + (meData.lastName || ''),
                                            username: meData.username || email,
                                            email: meData.email || email,
                                            _authMethod: 'api',
                                            role: (meData.role || 'vendeur').toLowerCase(),
                                            active: true, companyId: tenantId,
                                            storeId: meData.storeId || null,
                                            pos: meData.storeId ? String(meData.storeId) : null
                                        };
                                        CORE.db.users = CORE.db.users || [];
                                        CORE.db.users.push(localUser);
                                    } else {
                                        localUser.role = (meData.role || localUser.role || 'vendeur').toLowerCase();
                                        localUser.companyId = tenantId;
                                        if (!localUser.pos && localUser.storeId) localUser.pos = String(localUser.storeId);
                                    }

                                    // Update saved refresh token
                                    const newRT = API.getRefreshToken();
                                    if (newRT) {
                                        const accts = this.getSavedAccounts();
                                        const accIdx = accts.findIndex(a => a.id === account.id);
                                        if (accIdx >= 0) { accts[accIdx].refreshToken = newRT; this.saveAccounts(accts); }
                                    }

                                    try { await API.syncAllFromCloud(); } catch(e) { console.warn('[SYNC] syncAllFromCloud failed after account switch:', e.message); }

                                    CORE.state.currentUser = localUser;
                                    CORE.save(true);
                                    App.launchRole(localUser.role);
                                    App.rerender();
                                    overlay.remove();
                                    UI.toast('✅ Connecté en tant que ' + (localUser.name || localUser.username), 'success');
                                    setTimeout(() => this.showReturnButton(), 600);
                                    return;
                                }
                            } catch(meErr) { console.warn('[AccountSwitcher] getMe failed:', meErr.message); }
                        }
                    } catch(e) { console.warn('[AccountSwitcher] Refresh token auth failed:', e.message); }
                }

                // Stratégie 2: Fallback local (offline) — find user by email in local DB
                // Note: no password check in offline mode for account switch (refresh token handles security online)
                const localUserByEmail = (CORE.db.users || []).find(u => (u.username === email || u.email === email) && u.active !== false);
                if (localUserByEmail) {
                    if (!localUserByEmail.pos && localUserByEmail.storeId) localUserByEmail.pos = String(localUserByEmail.storeId);
                    CORE.state.currentUser = localUserByEmail;
                    CORE.save(true);
                    App.launchRole(localUserByEmail.role);
                    App.rerender();
                    overlay.remove();
                    UI.toast('✅ Connecté en tant que ' + (localUserByEmail.name || localUserByEmail.username), 'success');
                    setTimeout(() => this.showReturnButton(), 600);
                    return;
                }

                // Stratégie 3: Chercher dans db.users du tenant actuel
                const directUser = (CORE.db.users || []).find(u =>
                    (u.username === email || u.email === email) && u.active !== false
                );
                if (directUser) {
                    if (!directUser.pos && directUser.storeId) directUser.pos = String(directUser.storeId);
                    CORE.state.currentUser = directUser;
                    CORE.save(true);
                    App.launchRole(directUser.role);
                    App.rerender();
                    overlay.remove();
                    UI.toast('✅ Connecté en tant que ' + (directUser.name || directUser.username), 'success');
                    setTimeout(() => this.showReturnButton(), 600);
                    return;
                }

                // Échec total
                overlay.remove();
                UI.toast('❌ échec de connexion. Vérifiez les identifiants.', 'error');
            } catch(err) {
                console.error('[AccountSwitcher] Switch failed:', err);
                const ov = document.getElementById('account-switch-overlay');
                if (ov) ov.remove();
                UI.toast('❌ Erreur: ' + (err.message || err), 'error');
            }
        },

        // Retourne le HTML inline (pour renderSettings)
        getHTML() {
            try {
                const accounts = this.getSavedAccounts();
                const currentUser = CORE.state?.currentUser;
                const _timeAgo = (date) => {
                    try {
                        const s = Math.floor((Date.now() - date.getTime()) / 1000);
                        if (s < 60) return 'Il y a ' + s + 's';
                        const m = Math.floor(s / 60); if (m < 60) return 'Il y a ' + m + 'min';
                        const h = Math.floor(m / 60); if (h < 24) return 'Il y a ' + h + 'h';
                        return 'Il y a ' + Math.floor(h / 24) + 'j';
                    } catch(e) { return '–'; }
                };
                let h = '<div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:16px;padding:20px;margin:16px 0;border:1px solid rgba(255,255,255,0.1);">'
                    + '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;">'
                    + '<h3 style="color:white;margin:0;font-size:18px;">🔀 Comptes enregistrés</h3>'
                    + '<button onclick="AccountSwitcher.showAddAccountModal()" style="background:#4CAF50;color:white;border:none;border-radius:10px;padding:8px 16px;font-size:13px;cursor:pointer;font-weight:bold;">+ Ajouter un compte</button>'
                    + '</div>';
                if (accounts.length === 0) {
                    h += '<div style="text-align:center;padding:30px 16px;color:#888;"><div style="font-size:40px;margin-bottom:12px;">👤</div><div style="font-size:14px;">Aucun compte enregistré</div><div style="font-size:12px;color:#666;margin-top:6px;">Ajoutez des comptes pour basculer rapidement</div></div>';
                } else {
                    h += '<div style="display:flex;flex-direction:column;gap:10px;">';
                    accounts.forEach(acc => {
                        const isCurrent = currentUser && (currentUser.username === acc.username || currentUser.email === acc.username);
                        const initials = (acc.name || '?').split(' ').map(w => (w||'')[0]).join('').toUpperCase().substring(0, 2) || '?';
                        const bg = isCurrent ? 'rgba(76,175,80,0.15)' : 'rgba(255,255,255,0.05)';
                        const border = isCurrent ? 'rgba(76,175,80,0.4)' : 'rgba(255,255,255,0.08)';
                        const dot = isCurrent ? '#4CAF50' : '#2196F3';
                        const accData = btoa(unescape(encodeURIComponent(JSON.stringify(acc))));
                        const lastUsed = acc.lastUsed ? _timeAgo(new Date(acc.lastUsed)) : 'Jamais';
                        h += '<div style="display:flex;align-items:center;gap:12px;background:' + bg + ';border:1px solid ' + border + ';border-radius:12px;padding:12px 16px;cursor:' + (isCurrent ? 'default' : 'pointer') + ';transition:all 0.2s;"'
                            + (isCurrent ? '' : ' onclick="AccountSwitcher.switchToAccount(decodeURIComponent(escape(atob(\'' + accData + '\'))))"') + '>';
                        h += '<div style="width:44px;height:44px;border-radius:50%;background:' + dot + ';display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:16px;flex-shrink:0;">' + initials + '</div>';
                        h += '<div style="flex:1;min-width:0;">';
                        h += '<div style="color:white;font-weight:600;font-size:15px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">' + (acc.name || '').replace(/\x3c/g,'&lt;');
                        if (isCurrent) h += ' <span style="background:#4CAF50;color:white;font-size:10px;padding:2px 8px;border-radius:10px;font-weight:500;">ACTIF</span>';
                        h += '</div>';
                        h += '<div style="color:#aaa;font-size:12px;margin-top:2px;">@' + (acc.username || '').replace(/\x3c/g,'&lt;') + '</div>';
                        h += '<div style="color:#666;font-size:11px;margin-top:2px;">Dernière connexion: ' + lastUsed + '</div>';
                        h += '</div>';
                        if (!isCurrent) {
                            h += '<button onclick="event.stopPropagation();AccountSwitcher.confirmRemoveAccount(\'' + acc.id + '\',\'' + (acc.name || '').replace(/'/g,"\\'").replace(/\x3c/g,'&lt;') + '\')" style="background:rgba(244,67,54,0.15);border:1px solid rgba(244,67,54,0.3);color:#f44336;border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer;flex-shrink:0;" title="Supprimer">🗑️</button>';
                            h += '<div style="color:#2196F3;font-size:20px;flex-shrink:0;">→</div>';
                        }
                        h += '</div>';
                    });
                    h += '</div>';
                }
                h += '</div>';
                return h;
            } catch(e) {
                return '<div style="background:#1a1a2e;border-radius:16px;padding:20px;margin:16px 0;border:1px solid rgba(255,255,255,0.1);"><h3 style="color:white;margin:0 0 12px 0;font-size:18px;">🔀 Comptes enregistrés</h3><button onclick="AccountSwitcher.showAddAccountModal()" style="background:#4CAF50;color:white;border:none;border-radius:10px;padding:8px 16px;font-size:13px;cursor:pointer;font-weight:bold;">+ Ajouter un compte</button></div>';
            }
        },

        renderSection() {
            const container = document.getElementById('account-switcher-section');
            if (!container) return;
            try {
            const accounts = this.getSavedAccounts();
            const currentUser = CORE.state?.currentUser;

            // Helper pour "il y a X temps"
            const _timeAgo = (date) => {
                try {
                    const s = Math.floor((Date.now() - date.getTime()) / 1000);
                    if (s < 60) return 'Il y a ' + s + 's';
                    const m = Math.floor(s / 60);
                    if (m < 60) return 'Il y a ' + m + 'min';
                    const h = Math.floor(m / 60);
                    if (h < 24) return 'Il y a ' + h + 'h';
                    const d = Math.floor(h / 24);
                    return 'Il y a ' + d + 'j';
                } catch(e) { return '–'; }
            };

            let h = '<div style="background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:16px;padding:20px;margin:16px 0;border:1px solid rgba(255,255,255,0.1);">'
                + '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;">'
                + '<h3 style="color:white;margin:0;font-size:18px;">🔀 Comptes enregistrés</h3>'
                + '<button onclick="AccountSwitcher.showAddAccountModal()" style="background:#4CAF50;color:white;border:none;border-radius:10px;padding:8px 16px;font-size:13px;cursor:pointer;font-weight:bold;">+ Ajouter un compte</button>'
                + '</div>';
            if (accounts.length === 0) {
                h += '<div style="text-align:center;padding:30px 16px;color:#888;">'
                    + '<div style="font-size:40px;margin-bottom:12px;">👤</div>'
                    + '<div style="font-size:14px;">Aucun compte enregistré</div>'
                    + '<div style="font-size:12px;color:#666;margin-top:6px;">Ajoutez des comptes pour basculer rapidement entre eux</div></div>';
            } else {
                h += '<div style="display:flex;flex-direction:column;gap:10px;">';
                accounts.forEach(acc => {
                    const isCurrent = currentUser && (currentUser.username === acc.username || currentUser.email === acc.username);
                    const initials = (acc.name || '?').split(' ').map(w => (w||'')[0]).join('').toUpperCase().substring(0, 2) || '?';
                    const bg = isCurrent ? 'rgba(76,175,80,0.15)' : 'rgba(255,255,255,0.05)';
                    const border = isCurrent ? 'rgba(76,175,80,0.4)' : 'rgba(255,255,255,0.08)';
                    const dot = isCurrent ? '#4CAF50' : '#2196F3';
                    const accData = btoa(unescape(encodeURIComponent(JSON.stringify(acc))));
                    const lastUsed = acc.lastUsed ? _timeAgo(new Date(acc.lastUsed)) : 'Jamais';
                    h += '<div style="display:flex;align-items:center;gap:12px;background:' + bg + ';border:1px solid ' + border + ';border-radius:12px;padding:12px 16px;cursor:' + (isCurrent ? 'default' : 'pointer') + ';transition:all 0.2s;"'
                        + (isCurrent ? '' : ' onclick="AccountSwitcher.switchToAccount(decodeURIComponent(escape(atob(\'' + accData + '\'))))"')
                        + '>';
                    h += '<div style="width:44px;height:44px;border-radius:50%;background:' + dot + ';display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:16px;flex-shrink:0;">' + initials + '</div>';
                    h += '<div style="flex:1;min-width:0;">';
                    h += '<div style="color:white;font-weight:600;font-size:15px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">' + (acc.name || '').replace(/\x3c/g,'&lt;');
                    if (isCurrent) h += ' <span style="background:#4CAF50;color:white;font-size:10px;padding:2px 8px;border-radius:10px;font-weight:500;">ACTIF</span>';
                    h += '</div>';
                    h += '<div style="color:#aaa;font-size:12px;margin-top:2px;">@' + (acc.username || '').replace(/\x3c/g,'&lt;') + '</div>';
                    h += '<div style="color:#666;font-size:11px;margin-top:2px;">Dernière connexion: ' + lastUsed + '</div>';
                    h += '</div>';
                    if (!isCurrent) {
                        h += '<button onclick="event.stopPropagation();AccountSwitcher.confirmRemoveAccount(\'' + acc.id + '\',\'' + (acc.name || '').replace(/'/g,"\\'").replace(/\x3c/g,'&lt;') + '\')" style="background:rgba(244,67,54,0.15);border:1px solid rgba(244,67,54,0.3);color:#f44336;border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer;flex-shrink:0;" title="Supprimer">🗑️</button>';
                        h += '<div style="color:#2196F3;font-size:20px;flex-shrink:0;">→</div>';
                    }
                    h += '</div>';
                });
                h += '</div>';
            }
            h += '</div>';
            container.innerHTML = h;
            } catch(err) {
                console.error('[AccountSwitcher] renderSection error:', err);
                container.innerHTML = '<div style="background:#1a1a2e;border-radius:16px;padding:20px;margin:16px 0;border:1px solid rgba(255,255,255,0.1);">'
                    + '<h3 style="color:white;margin:0 0 12px 0;font-size:18px;">🔀 Comptes enregistrés</h3>'
                    + '<button onclick="AccountSwitcher.showAddAccountModal()" style="background:#4CAF50;color:white;border:none;border-radius:10px;padding:8px 16px;font-size:13px;cursor:pointer;font-weight:bold;">+ Ajouter un compte</button>'
                    + '</div>';
            }
        },

        showAddAccountModal() {
            UI.modal('➕ Ajouter un compte', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Nom d'affichage</label>
                        <input id="acc-sw-name" type="text" placeholder="Ex: Mon compte vendeur" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Identifiant</label>
                        <input id="acc-sw-username" type="text" placeholder="Nom d'utilisateur" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Mot de passe</label>
                        <input id="acc-sw-password" type="password" placeholder="Mot de passe" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none text-sm">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: '✓ Enregistrer', onclick: 'AccountSwitcher.handleAddAccount()' }
            ]);
        },

        async handleAddAccount() {
            const name = document.getElementById('acc-sw-name')?.value?.trim();
            const username = document.getElementById('acc-sw-username')?.value?.trim();
            const password = document.getElementById('acc-sw-password')?.value;
            if (!name) return UI.toast('Veuillez saisir un nom d\'affichage', 'warning');
            if (!username) return UI.toast('Veuillez saisir un identifiant', 'warning');
            if (!password) return UI.toast('Veuillez saisir un mot de passe', 'warning');

            // SECURITY: Verify credentials via API, then store only the refresh token (not the password)
            try {
                if (CORE.state.isOnline && typeof API !== 'undefined') {
                    var loginResult = await API.login(username, password);
                    if (loginResult && loginResult.accessToken) {
                        this.addAccount(name, username);
                        // Update the account with the fresh refresh token
                        var accts = this.getSavedAccounts();
                        var acc = accts.find(a => a.username === username.trim());
                        if (acc && loginResult.refreshToken) {
                            acc.refreshToken = loginResult.refreshToken;
                            this.saveAccounts(accts);
                        }
                        UI.closeModal();
                        UI.toast('✅ Compte "' + name + '" vérifié et enregistré', 'success');
                        App.rerender();
                        setTimeout(() => this.renderSection(), 200);
                        return;
                    }
                }
                UI.toast('❌ Identifiants invalides', 'error');
            } catch(e) {
                var msg = '';
                try { msg = e.data?.message || e.message || ''; } catch(x) {}
                UI.toast('❌ ' + (msg || 'Impossible de vérifier les identifiants'), 'error');
            }
        },

        confirmRemoveAccount(accountId, accountName) {
            UI.modal('🗑️ Supprimer ce compte ?', `
                <div class="text-center space-y-3">
                    <div class="text-5xl">🗑️</div>
                    <p class="text-slate-600">Le compte "<strong>${accountName}</strong>" sera retiré de la liste.<br>Cela ne supprimera pas le compte lui-même.</p>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Supprimer', onclick: "AccountSwitcher.removeAccount('" + accountId + "');UI.closeModal();UI.toast('✅ Compte supprimé','success');setTimeout(function(){var r=CORE.state?.currentUser?.role;if(r==='manager'&&typeof ManagerModule!=='undefined')ManagerModule.showSettingsModal();else if(r==='gestionnaire'&&typeof GestionnaireModule!=='undefined')GestionnaireModule.showSettingsModal();else if(r==='pdg'&&typeof PDGModule!=='undefined')PDGModule.showSettingsModal();else{App.rerender();AccountSwitcher.renderSection();}},100);" }
            ]);
        }
    };
    window.AccountSwitcher = AccountSwitcher;

    // =========================================================
    // CORE SYSTEM (State + DB + Persistence)
    // =========================================================
    const CORE = {
        baseStorageKey: 'raya_os_v2',
        globalStorageKey: 'raya_os_global_v1',
        storageKey: 'raya_os_v2',
        tenantId: 'default',
        global: { tenants: {}, usersIndex: [], lastTenantId: 'default' },
        _seedDb: null,
        config: { appName: 'RAYA OS', currency: 'FCFA', language: 'fr', version: '2.2.4', googleMapsApiKey: '' },

        getCompanyName() {
            return this.db.systemConfig?.appName || this.config.appName;
        },

        setCompanyName(name) {
            if (!name || !name.trim()) return false;
            if (!this.db.systemConfig) this.db.systemConfig = {};
            this.db.systemConfig.appName = name.trim();
            this.config.appName = name.trim();
            this.save();
            return true;
        },
        // ========== SUPPRESSION COMPTE UTILISATEUR ==========
        showDeleteMyAccountModal() {
            const user = this.state.currentUser;
            if (!user) return UI.toast('Aucun utilisateur connecté', 'error');
            if (user.role === 'pdg') return UI.toast('Le PDG doit utiliser la suppression d\'entreprise', 'warning');

            UI.modal('⚠️ Supprimer mon compte', `
                <div class="space-y-4">
                    <div class="p-4 rounded-2xl bg-red-50 border-2 border-red-200">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 bg-red-600 rounded-xl flex items-center justify-center">
                                <i data-lucide="alert-triangle" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-black text-red-800">Action irréversible</h4>
                                <p class="text-xs text-red-600">Cette action ne peut pas être annulée</p>
                            </div>
                        </div>
                        <p class="text-sm text-red-700">Vous êtes sur le point de supprimer définitivement votre compte <strong>"${user.name}"</strong> (${user.role}).</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-2">Entrez votre mot de passe pour confirmer</label>
                        <input type="password" id="delete-account-password" placeholder="Votre mot de passe" class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:ring-2 focus:ring-red-400 focus:border-red-400">
                    </div>
                    <div class="flex gap-3">
                        <button onclick="UI.closeModal()" class="flex-1 py-3 bg-slate-100 text-slate-700 rounded-xl font-bold hover:bg-slate-200 transition">Annuler</button>
                        <button onclick="CORE.confirmDeleteMyAccount()" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-black hover:bg-red-700 transition flex items-center justify-center gap-2 shadow-lg shadow-red-200">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            Supprimer mon compte
                        </button>
                    </div>
                </div>
            `);
            setTimeout(() => lucide.createIcons(), 50);
        },

        async confirmDeleteMyAccount() {
            const user = this.state.currentUser;
            if (!user) return;
            const passwordInput = document.getElementById('delete-account-password');
            const password = passwordInput ? passwordInput.value : '';
            if (!password) return UI.toast('Veuillez entrer votre mot de passe', 'error');

            const passwordHash = typeof Utils !== 'undefined' && Utils.md5 ? await Utils.md5(password) : password;
            if (user.passwordHash && passwordHash !== user.passwordHash) {
                return UI.toast('Mot de passe incorrect', 'error');
            } else if (!user.passwordHash && user.password && password !== user.password) {
                return UI.toast('Mot de passe incorrect', 'error');
            }

            if (!confirm('DERNI\u00c8RE CONFIRMATION\n\nSupprimer votre compte "' + user.name + '" ?\nCette action est IRR\u00c9VERSIBLE.')) return;

            if (typeof RayaAPI !== 'undefined' && user.apiId) {
                try { await API.request('/users/' + user.apiId, { method: 'DELETE' }); } catch(e) { console.warn('API delete:', e); }
            }

            const userId = user.id;
            this.db.users = (this.db.users || []).filter(u => u.id !== userId);
            if (this.global && Array.isArray(this.global.usersIndex)) {
                this.global.usersIndex = this.global.usersIndex.filter(u => !(u.userId === userId && u.companyId === this.tenantId));
            }
            this.save(true);
            this.saveGlobal();
            this.state.currentUser = null;
            if (typeof RayaAPI !== 'undefined') { RayaAPI.clearTokens(); }
            UI.closeModal();
            UI.toast('Votre compte a \u00e9t\u00e9 supprim\u00e9 d\u00e9finitivement', 'success');
            setTimeout(() => { if (typeof App !== 'undefined') App.renderOnboarding(); }, 1500);
        },

        getStorageKey(tenantId = null) {
            const tid = tenantId || this.tenantId || 'default';
            return tid === 'default' ? this.baseStorageKey : `${this.baseStorageKey}::${tid}`;
        },

        _initSeedDb() {
            if (!this._seedDb) {
                this._seedDb = JSON.parse(JSON.stringify(this.db));
            }
        },

        loadGlobal() {
            try {
                const raw = localStorage.getItem(this.globalStorageKey);
                if (raw) {
                    const parsed = Utils.safeJsonParse(raw, null);
                    if (parsed && typeof parsed === 'object') {
                        this.global = {
                            tenants: parsed.tenants || {},
                            usersIndex: Array.isArray(parsed.usersIndex) ? parsed.usersIndex : [],
                            lastTenantId: parsed.lastTenantId || 'default'
                        };
                        return;
                    }
                }
            } catch (_) {}
            this.global = { tenants: {}, usersIndex: [], lastTenantId: 'default' };
            this._ensureTenant('default', this.config.appName || 'Entreprise');
            this._syncGlobalFromTenant();
            this.saveGlobal();
        },

        saveGlobal() {
            try {
                localStorage.setItem(this.globalStorageKey, JSON.stringify(this.global));
            } catch (_) {}
        },

        _ensureTenant(tenantId, name = 'Entreprise') {
            if (!this.global.tenants[tenantId]) {
                this.global.tenants[tenantId] = {
                    id: tenantId,
                    name,
                    createdAt: new Date().toISOString()
                };
            }
        },

        switchTenant(tenantId, opts = {}) {
            const id = tenantId || 'default';
            this._initSeedDb();
            this.tenantId = id;
            this.storageKey = this.getStorageKey(id);
            this.state.tenantId = id;
            this.state.currentUser = null;
            this.db = JSON.parse(JSON.stringify(this._seedDb));
            this.load();
            this._ensureUsersCompanyId();
            this._ensureTenant(id, this.getCompanyName());
            this._syncGlobalFromTenant();
            this.global.lastTenantId = id;
            if (!opts.silent) this.saveGlobal();
        },

        _ensureUsersCompanyId() {
            if (!Array.isArray(this.db.users)) return;
            this.db.users.forEach(u => {
                if (!u.tenantId) u.tenantId = this.tenantId || 'default';
                if (!u.companyId) u.companyId = this.tenantId || 'default';
                if (!u.accountId) u.accountId = u.companyId;
                if (u.pos != null && u.posId == null) u.posId = u.pos;
                if (u.pos == null && u.posId != null) u.pos = u.posId;
            });
        },

        _syncGlobalFromTenant() {
            if (!this.global || !Array.isArray(this.db.users)) return;
            const tenantId = this.tenantId || 'default';
            this.global.usersIndex = (this.global.usersIndex || []).filter(u => u.companyId !== tenantId);
            this.db.users.forEach(u => {
                this.global.usersIndex.push({
                    companyId: tenantId,
                    accountId: u.accountId || tenantId,
                    userId: u.id,
                    username: u.username,
                    password: u.password,
                    passwordHash: u.passwordHash,
                    role: u.role,
                    posId: u.posId ?? u.pos ?? null,
                    active: u.active !== false
                });
            });
        },

        findUserGlobalMatches(username, password) {
            if (!this.global || !Array.isArray(this.global.usersIndex)) return [];
            return this.global.usersIndex.filter(u =>
                u.active !== false &&
                u.username === username &&
                u.password === password
            );
        },

        findUserGlobal(username, password) {
            return this.findUserGlobalMatches(username, password)[0] || null;
        },

        createTenantWithAdmin(companyId, companyName, adminUser) {
            if (!companyId) return null;
            const prevTenant = this.tenantId;
            const prevUser = this.state.currentUser;
            this.switchTenant(companyId, { silent: true });
            if (companyName) {
                this.db.systemConfig = this.db.systemConfig || {};
                this.db.systemConfig.appName = companyName;
                this.config.appName = companyName;
            }
            // Only initialize users array if empty/missing — don't wipe existing users
            if (!this.db.users || this.db.users.length === 0) {
                this.db.users = [];
            }
            const admin = {
                ...adminUser,
                id: adminUser.id || 1,
                active: true,
                companyId,
                accountId: companyId,
                posId: adminUser?.posId ?? adminUser?.pos ?? null,
                pos: adminUser?.pos ?? adminUser?.posId ?? null
            };
            // Check if user already exists by email before adding
            var existingIdx = this.db.users.findIndex(function(u) {
                return (u.email && u.email === adminUser.email) || (u.username && u.username === adminUser.username);
            });
            if (existingIdx >= 0) {
                // Update existing user instead of creating duplicate
                Object.assign(this.db.users[existingIdx], admin);
            } else {
                this.db.users.push(admin);
            }
            this._ensureUsersCompanyId();
            this.save(true);
            this.switchTenant(prevTenant, { silent: true });
            this.state.currentUser = prevUser || null;
            this.save(true);
            return admin;
        },

        isUsernameTaken(username) {
            if (!this.global || !Array.isArray(this.global.usersIndex)) return false;
            return this.global.usersIndex.some(u => u.username === username);
        },

        bootstrap() {
            this.loadGlobal();
            const lastTenant = this.global.lastTenantId || 'default';
            this.switchTenant(lastTenant, { silent: true });
            this._ensureTenant('default', this.getCompanyName() || 'Entreprise par défaut');
            this._ensureUsersCompanyId();
            this._syncGlobalFromTenant();

            // Restore dirty collections from localStorage (survive page refresh)
            this._loadDirtyFromStorage();

            // Vérification de sécurité: s'assurer que tous les utilisateurs locaux sont dans l'index global
            const missingUsers = (this.db.users || []).filter(u => {
                return !this.global.usersIndex.some(g => g.username === u.username && g.companyId === (u.companyId || this.tenantId));
            });
            if (missingUsers.length > 0) {
                console.log('[BOOTSTRAP] Syncing', missingUsers.length, 'missing users to global index');
                this._syncGlobalFromTenant();
            }

            this.saveGlobal();
            console.log('[BOOTSTRAP] Tenant:', this.tenantId, '| Tenants:', Object.keys(this.global.tenants), '| Users index:', (this.global.usersIndex || []).length);
        },

        state: { currentUser: null, tenantId: 'default', isOnline: navigator.onLine, lastSync: new Date().toISOString() },
        db: {
            users: [],
            vendorBadges: [],
            cities: [],
            pointsOfSale: [],
            categories: [],
            products: [],
            // ===== ISOLATION COMPLÈTE PAR POS =====
            // Clients, commandes, livraisons ISOLÉS par POS
            posDataByLocation: {},
            // LEGACY - Garder pour compatibilité temporaire
            clients: [],
            orders: [],
            deliveries: [],
            returns: [],
            financialTransactions: [],
            stockMovements: [],
            notifications: [],
            transferReceipts: [],
            stockTransfers: [],
            posDeleteRequests: [],
            livreurCommissions: [], // [{ id: auto, livreurId, commissionPercent, commissionFixed, createdAt, updatedAt }]
            productVariants: [], // [{ id, productId, attributes: [{name, value}], sku, price, stock, weight, temperature, createdAt, updatedAt }]
            productAttributeTypes: [],
            deposits: [], // [{ id, timestamp, livreurId, livreurName, vendeurId, vendeurName, amount, ordersCount, ordersRef, posId, notes, status: 'enregistre'|'approuve' }]
            activityLogs: [], // [{ id, timestamp, userId, userName, userRole, action, entity, entityId, entityName, details, status, amount }]
            shiftTemplates: [],
            shifts: [], // [{ id, templateId, userId, date, status: 'scheduled'|'confirmed'|'swapped'|'cancelled', notes, replacementId, replacementName }]
            timeOff: [], // [{ id, userId, type: 'congé'|'maladie'|'autre', startDate, endDate, reason, status: 'pending'|'approved'|'rejected' }]
            auditLogs: [], // [{ id, timestamp, userId, userName, userRole, action, entity, entityId, entityName, details, before, after, status }]
            dailyDigestConfigs: [], // [{ id, posId, enabled: true/false, sendTime: '06:00', recipients: [emails], includeVentes: true, includeDepots: true, includeIncidents: true, includeKPIs: true }]
            dailyDigestLogs: [], // [{ id, posId, timestamp, sendTime, recipients, status: 'sent'|'failed', ventes, depots, incidents, kpis }]
            incidents: [], // [{ id, timestamp, type: 'retard'|'annulation'|'litige', severity: 'basse'|'moyenne'|'haute', relatedEntity: delivery/order id, relatedType: 'delivery'|'order', assignedTo: userId, assignedToName, status: 'ouvert'|'en-cours'|'résolu'|'fermé', description, slaStartTime, slaEndTime, slaMinutes, slaStatus: 'en-cours'|'atteint'|'dépassé', notes: [], resolution, createdBy, createdByName, closedAt, closedBy, tags: [], priority }]
            incidentHistory: [], // [{ id, incidentId, timestamp, userId, userName, action, oldValue, newValue, details }]
            messageTemplates: [], // [{ id, name, type: 'sms'|'whatsapp', category: 'delivery'|'reminder'|'alert'|'resolution', content, variables: [], createdBy }]
            messageLog: [], // [{ id, timestamp, recipientId, recipientName, type: 'sms'|'whatsapp'|'call', status: 'sent'|'failed'|'pending', content, duration }]
            productImages: [], // [{ id, productId, productName, url, filename, filesize, uploadedAt, uploadedBy, uploadedByName, isPrimary, alt, tags: [], order }]
            independentDeliveryMen: [], // [{ id, name, phone, vendeurId, vendeurName, createdAt, status: 'active'|'inactive', deliveryCount, totalEarnings, notes }]
            gestionnaireSettings: null, // shared settings object (SLA, approval config, etc.)
            deliveryTicketTemplates: [], // [{ id, vendeurId, vendeurName, name: 'SMS'|'Direct', content, variables: [{name, label, required}], createdAt, updatedAt }]
            suppliers: [],
            purchaseOrders: [], // [{ id, reference, supplierId, productId, qty, unitPrice, totalCost, status: 'pending'|'confirmed'|'received'|'cancelled', deliveryDate, note, createdAt }]
            userAdditionRequests: [], // [{ id, name, username, password, role, avatar, requestedBy, requestedByName, requestedAt, status: 'pending'|'approved'|'rejected', approvedBy, approvedByName, approvedAt, rejectionReason }]
            notifications: [], // [{ id, type: 'stock_low'|'order_rejected'|'incident_open'|'info', title, message, severity: 'low'|'medium'|'high'|'critical', relatedTo: 'product'|'order'|'delivery', relatedId, read: false, createdAt, readAt }]
            alertThresholds: [],
            // ========== SYSTÈME D'ALERTES INTELLIGENTES ==========
            alertPreferences: [], // [{ id, userId, userRole, alertType: 'stock_low'|'order_pending'|'inactive_livreur'|'critical_incident', enabled: true, level: 'info'|'attention'|'critique', silenceStart: '22:00', silenceEnd: '08:00', sendEmail: false, sendSms: false, emailAddress: 'user@example.com', phoneNumber: '+242...' }]
            alertHistory: [], // [{ id, timestamp, userId, userRole, alertType, level, title, message, triggered: true, sent: true, readAt, actionTaken, notes }]
            silenceSchedules: [], // [{ id, userId, name: 'Nuit'|'Réunion'|'Personnalisé', startTime: '22:00', endTime: '08:00', daysOfWeek: ['Mon', 'Tue'...], active: true, exceptions: [] }]
            alertRules: [],
            budgets: [], // [{ id, name, category: 'salaires'|'operationnel'|'marketing'|'logistics'|'maintenance'|'other', amount: 0, startDate, endDate, spent: 0, notes, createdAt, updatedAt }]
            financialTargets: [],
            // ========== OPTIMISATION ROUTAGE LIVREURS ==========
            deliveryRoutes: [], // [{ id, livreurId, livreurName, date, startTime, endTime, status: 'planned'|'in_progress'|'completed', stops: [...], totalDistance: km, estimatedTime: min, estimatedCost: amount, actualTime, actualCost, completedAt }]
            routeStops: [], // [{ id, routeId, orderId, clientId, clientName, address, lat, lng, sequence, status: 'pending'|'visited'|'delivered'|'failed', arrivalTime, departureTime, notes }]
            addressClusters: [], // [{ id, date, clusterId, name, center: {lat, lng}, radius, addresses: [...], livreurId, createdAt }]
            routeOptimizations: [], // [{ id, livreurId, date, optimizedRoute: {...}, originalRoute: {...}, timeSaved: min, costSaved: amount, efficiency: %, appliedAt, result }]
            // ========== INTÉGRATION PAIEMENTS MOBILES ==========
            mobileMoneProviders: [],
            mobilePayments: [], // [{ id, orderId, clientId, clientName, clientPhone, amount, currency: 'XAF', provider: 'mtn'|'airtel'|'orange', transactionId, status: 'pending'|'success'|'failed', qrCode, qrCodeUrl, invoicePDF, invoiceEmail, createdAt, completedAt, errorMessage, metadata }]
            paymentInvoices: [], // [{ id, paymentId, orderId, invoiceNumber, clientName, clientEmail, clientPhone, items: [{name, qty, price}], subtotal, tax, total, pdfUrl, sentAt, downloadedAt, createdAt }]
            paymentHistory: [], // [{ id, clientId, clientName, totalPaid: 0, paymentCount: 0, methods: {mtn: 0, airtel: 0, orange: 0, cash: 0}, lastPaymentDate, lastPaymentMethod, averageAmount }]
            paymentWebhooks: [], // [{ id, provider, event, status: 'pending'|'processed'|'failed', payload, receivedAt, processedAt }]
            // ========== WORKFLOW VALIDATION MULTI-NIVEAUX ==========
            orderApprovals: [], // [{ id, orderId, vendorId, vendorName, amount, status: 'pending'|'approved'|'rejected', managerId, approverName, approvedAt, rejectionReason, createdAt }]
            returnJustifications: [], // [{ id, returnId, orderId, itemCount, reason, description, status: 'pending'|'approved'|'rejected', reviewedBy, reviewedAt, notes, attachments: [] }]
            validationRules: [], // [{ id, entityType: 'order'|'return', threshold: amount|quantity, action: 'require_approval'|'require_justification', level: 'manager'|'gestionnaire', enabled: true }]
            approvalAuditTrail: [], // [{ id, entityType, entityId, action: 'created'|'submitted'|'approved'|'rejected'|'canceled', userId, userName, userRole, timestamp, reason, metadata }]
            // ========== AUDIT TRAIL & CONFORMITÉ ==========
            auditTrail: [],
            complianceLogs: [],
            accessLogs: [],
            dataModificationLogs: [],
            deletionLogs: [],
            exportLogs: [],
            complianceReports: [],
            // ========== GESTION INTELLIGENTE DU STOCK ==========
            stockPredictions: [],
            stockAnalysisABC: [],
            reorderSuggestions: [],
            expiryAlerts: [],
            stockTrendHistory: [],
            promoCodes: [],
            // Rapports et Exports Avancés
            generatedReports: [],
            reportSchedules: [],
            reportTemplates: [],
            financialMetrics: [],
            notificationHistory: [],
            // ========== PERSONNALISATION ET PRÉFÉRENCES ==========
            userPreferences: [],
            dashboardLayouts: [],
            keyboardShortcuts: [],
            themeSettings: [],
            widgetConfigs: [],
            systemConfig: {
                appName: 'RAYA OS',
                appVersion: '1.0.0',
                language: 'fr',
                timezone: 'Africa/Brazzaville',
                dateFormat: 'DD/MM/YYYY',
                currencyCode: 'XAF',
                currencySymbol: 'XAF',
                maintenanceMode: false,
                backupAutomatic: true,
                backupFrequency: 'daily', // daily, weekly, monthly
                backupRetention: 30, // days
                maxLoginAttempts: 5,
                sessionTimeout: 60, // minutes
                enableTwoFactor: false,
                enableApiLogs: true,
                logRetention: 90, // days
                maxUploadSize: 10, // MB
                enableExternalIntegration: false
            },
            backups: [], // [{ id, name, date, size, status: 'success'|'failed', notes }]
            systemLogs: [], // [{ id, timestamp, level: 'info'|'warning'|'error'|'critical', module, message, userId, ipAddress }]
            diagnostics: {
                lastCheck: null,
                cpuUsage: 0,
                memoryUsage: 0,
                storageUsage: 0,
                databaseSize: 0,
                activeUsers: 0,
                totalRequests: 0,
                averageResponseTime: 0,
                errorRate: 0
            },
            userSuspensions: [], // [{ id, userId, userName, suspendedBy, suspendedByName, reason, suspendedAt, resumedAt, duration, status: 'active'|'resolved' }]
            suspensionHistory: [], // [{ id, userId, suspension: {...}, action: 'suspended'|'resumed', timestamp, details }]
            importExportHistory: [], // [{ id, type: 'import'|'export', entity: 'users'|'orders'|'audit'|'products', timestamp, performedBy, performedByName, rowsProcessed, fileName, status: 'success'|'failed', details }]
            externalSyncConfigs: [], // [{ id, name, type: 'api'|'webhook'|'polling', url, method, frequency, lastSync, status: 'active'|'inactive', credentials }]
            roles: [
                { id: 'pdg', name: 'PDG', description: 'Président Directeur Général', color: 'indigo', icon: 'crown', permissions: ['all'], isCustom: false },
                { id: 'manager', name: 'Manager', description: 'Gestionnaire de distribution', color: 'blue', icon: 'briefcase', permissions: ['users.view', 'users.edit', 'users.delete', 'stock.view', 'stock.edit', 'orders.view', 'deliveries.view', 'deliveries.assign', 'finance.view'], isCustom: false },
                { id: 'gestionnaire', name: 'Gestionnaire', description: 'Gestionnaire de stock', color: 'green', icon: 'package', permissions: ['stock.view', 'stock.edit', 'stock.create', 'orders.view', 'products.view', 'products.edit'], isCustom: false },
                { id: 'vendeur', name: 'Vendeur', description: 'Vendeur', color: 'amber', icon: 'shopping-cart', permissions: ['orders.create', 'orders.view', 'products.view', 'clients.view'], isCustom: false },
                { id: 'livreur', name: 'Livreur', description: 'Livreur/Coursier', color: 'purple', icon: 'truck', permissions: ['deliveries.view', 'deliveries.complete', 'orders.view'], isCustom: false }
            ],
            permissions: [
                // Utilisateurs
                { id: 'users.view', label: 'Voir les utilisateurs', category: 'users', entity: 'Utilisateurs', action: 'Voir', icon: 'eye' },
                { id: 'users.create', label: 'Créer des utilisateurs', category: 'users', entity: 'Utilisateurs', action: 'Créer', icon: 'plus' },
                { id: 'users.edit', label: 'Modifier les utilisateurs', category: 'users', entity: 'Utilisateurs', action: 'Modifier', icon: 'edit' },
                { id: 'users.delete', label: 'Supprimer les utilisateurs', category: 'users', entity: 'Utilisateurs', action: 'Supprimer', icon: 'trash' },
                { id: 'users.approve', label: 'Approuver les utilisateurs', category: 'users', entity: 'Utilisateurs', action: 'Approuver', icon: 'check-circle' },
                // Stock
                { id: 'stock.view', label: 'Voir le stock', category: 'stock', entity: 'Stock', action: 'Voir', icon: 'eye' },
                { id: 'stock.create', label: 'Ajouter au stock', category: 'stock', entity: 'Stock', action: 'Créer', icon: 'plus' },
                { id: 'stock.edit', label: 'Modifier le stock', category: 'stock', entity: 'Stock', action: 'Modifier', icon: 'edit' },
                { id: 'stock.delete', label: 'Supprimer du stock', category: 'stock', entity: 'Stock', action: 'Supprimer', icon: 'trash' },
                // Produits
                { id: 'products.view', label: 'Voir les produits', category: 'products', entity: 'Produits', action: 'Voir', icon: 'eye' },
                { id: 'products.create', label: 'Créer des produits', category: 'products', entity: 'Produits', action: 'Créer', icon: 'plus' },
                { id: 'products.edit', label: 'Modifier les produits', category: 'products', entity: 'Produits', action: 'Modifier', icon: 'edit' },
                { id: 'products.delete', label: 'Supprimer les produits', category: 'products', entity: 'Produits', action: 'Supprimer', icon: 'trash' },
                // Commandes
                { id: 'orders.view', label: 'Voir les commandes', category: 'orders', entity: 'Commandes', action: 'Voir', icon: 'eye' },
                { id: 'orders.create', label: 'Créer des commandes', category: 'orders', entity: 'Commandes', action: 'Créer', icon: 'plus' },
                { id: 'orders.edit', label: 'Modifier les commandes', category: 'orders', entity: 'Commandes', action: 'Modifier', icon: 'edit' },
                { id: 'orders.cancel', label: 'Annuler les commandes', category: 'orders', entity: 'Commandes', action: 'Annuler', icon: 'x-circle' },
                // Livraisons
                { id: 'deliveries.view', label: 'Voir les livraisons', category: 'deliveries', entity: 'Livraisons', action: 'Voir', icon: 'eye' },
                { id: 'deliveries.assign', label: 'Assigner les livraisons', category: 'deliveries', entity: 'Livraisons', action: 'Assigner', icon: 'user-plus' },
                { id: 'deliveries.complete', label: 'Compléter les livraisons', category: 'deliveries', entity: 'Livraisons', action: 'Compléter', icon: 'check-square' },
                { id: 'deliveries.cancel', label: 'Annuler les livraisons', category: 'deliveries', entity: 'Livraisons', action: 'Annuler', icon: 'x-circle' },
                // Finances
                { id: 'finance.view', label: 'Voir les finances', category: 'finance', entity: 'Finances', action: 'Voir', icon: 'eye' },
                { id: 'finance.edit', label: 'Modifier les finances', category: 'finance', entity: 'Finances', action: 'Modifier', icon: 'edit' },
                { id: 'finance.export', label: 'Exporter les finances', category: 'finance', entity: 'Finances', action: 'Exporter', icon: 'download' },
                // Clients
                { id: 'clients.view', label: 'Voir les clients', category: 'clients', entity: 'Clients', action: 'Voir', icon: 'eye' },
                { id: 'clients.create', label: 'Créer des clients', category: 'clients', entity: 'Clients', action: 'Créer', icon: 'plus' },
                { id: 'clients.edit', label: 'Modifier les clients', category: 'clients', entity: 'Clients', action: 'Modifier', icon: 'edit' },
                // Rapports et Audit
                { id: 'reports.view', label: 'Voir les rapports', category: 'reports', entity: 'Rapports', action: 'Voir', icon: 'eye' },
                { id: 'reports.export', label: 'Exporter les rapports', category: 'reports', entity: 'Rapports', action: 'Exporter', icon: 'download' },
                { id: 'audit.view', label: 'Voir l\'audit', category: 'audit', entity: 'Audit', action: 'Voir', icon: 'eye' },
                { id: 'audit.export', label: 'Exporter l\'audit', category: 'audit', entity: 'Audit', action: 'Exporter', icon: 'download' }
            ]
        },

        // Persistence
        load() {
            const raw = localStorage.getItem(this.getStorageKey());
            if (!raw) return;
            const parsed = Utils.safeJsonParse(raw, null);
            if (!parsed) return;

            // Merge DB (keep defaults if missing)
            if (parsed.db) {
                for (const [key, value] of Object.entries(parsed.db)) {
                    if (Array.isArray(value)) {
                        this.db[key] = value;
                    }
                }

                // Restaurer systemConfig (objet, pas tableau) si présent
                if (parsed.db.systemConfig && typeof parsed.db.systemConfig === 'object') {
                    this.db.systemConfig = { ...this.db.systemConfig, ...parsed.db.systemConfig };
                    // Mettre à jour aussi config.appName pour cohérence
                    if (parsed.db.systemConfig.appName) {
                        this.config.appName = parsed.db.systemConfig.appName;
                    }
                    if (parsed.db.systemConfig.currency) {
                        this.config.currency = parsed.db.systemConfig.currency;
                    }
                }
                // Restaurer gestionnaireSettings (objet, pas tableau)
                if (parsed.db.gestionnaireSettings && typeof parsed.db.gestionnaireSettings === 'object') {
                    this.db.gestionnaireSettings = { ...this.db.gestionnaireSettings, ...parsed.db.gestionnaireSettings };
                }
            }

            this.state = { ...this.state, ...(parsed.state || {}) };
            // Always use live online status, not stale saved value
            this.state.isOnline = navigator.onLine;
            // Restore currentUser reference
            if (this.state.currentUser && this.state.currentUser.id) {
                const fresh = this.getUser(this.state.currentUser.id);
                this.state.currentUser = fresh || null;
            }
            // Normaliser pos depuis storeId pour tous les utilisateurs restaurés
            if (this.state.currentUser && !this.state.currentUser.pos && this.state.currentUser.storeId) {
                this.state.currentUser.pos = String(this.state.currentUser.storeId);
            }

            // MIGRATION v2.3: Remove old fake/simulated default data from localStorage
            if (!localStorage.getItem('raya_cleanup_v2_3')) {
                const fakeSuppIds = [1, 2, 3];
                const fakeCatIds = [1, 2, 3, 4, 5];
                const fakeShiftIds = [1, 2, 3];
                if (this.db.suppliers && this.db.suppliers.length <= 3 && this.db.suppliers.every(s => fakeSuppIds.includes(s.id))) this.db.suppliers = [];
                if (this.db.categories && this.db.categories.length <= 5 && this.db.categories.every(c => fakeCatIds.includes(c.id))) this.db.categories = [];
                if (this.db.shiftTemplates && this.db.shiftTemplates.length <= 3 && this.db.shiftTemplates.every(s => fakeShiftIds.includes(s.id))) this.db.shiftTemplates = [];
                if (this.db.vendorBadges && this.db.vendorBadges.length <= 5 && this.db.vendorBadges[0]?.id === 'vendeur-mois') this.db.vendorBadges = [];
                if (this.db.mobileMoneProviders && this.db.mobileMoneProviders.length <= 3 && this.db.mobileMoneProviders[0]?.id === 'mtn') this.db.mobileMoneProviders = [];
                if (this.db.alertRules && this.db.alertRules.length <= 6 && this.db.alertRules[0]?.id === 'rule_1') this.db.alertRules = [];
                if (this.db.alertThresholds && this.db.alertThresholds.length <= 6 && this.db.alertThresholds[0]?.id === 'stock_low') this.db.alertThresholds = [];
                if (this.db.financialTargets && this.db.financialTargets.length <= 3 && this.db.financialTargets[0]?.id === 'revenue_target') this.db.financialTargets = [];
                if (this.db.reportTemplates && this.db.reportTemplates.length <= 5 && this.db.reportTemplates[0]?.id === 'sales_summary') this.db.reportTemplates = [];
                if (this.db.productAttributeTypes && this.db.productAttributeTypes.length <= 6 && this.db.productAttributeTypes[0]?.id === 'color') this.db.productAttributeTypes = [];
                localStorage.setItem('raya_cleanup_v2_3', '1');
                this.save();
                console.log('[MIGRATION v2.3] Cleaned simulated default data');
            }

            // MIGRATION v2.4: Remove VendeurModule.seed() fake data (orders, deliveries, productVariants)
            if (!localStorage.getItem('raya_cleanup_v2_4')) {
                let cleaned = false;
                // Remove fake seed orders (CMD-0001 to CMD-0014 with fake sellerId:4, fake clients Marcel/Sylvie)
                const fakeRefs = ['CMD-0001','CMD-0002','CMD-0003','CMD-0004','CMD-0010','CMD-0011','CMD-0012','CMD-0013','CMD-0014'];
                if (this.db.orders && this.db.orders.length > 0) {
                    const before = this.db.orders.length;
                    this.db.orders = this.db.orders.filter(o => !fakeRefs.includes(o.reference));
                    if (this.db.orders.length < before) { cleaned = true; console.log('[MIGRATION v2.4] Removed', before - this.db.orders.length, 'fake orders'); }
                }
                // Remove fake deliveries (orderRef CMD-0002, livreurId:5, Marcel Bakala)
                if (this.db.deliveries && this.db.deliveries.length > 0) {
                    const before = this.db.deliveries.length;
                    this.db.deliveries = this.db.deliveries.filter(d => !fakeRefs.includes(d.orderRef));
                    if (this.db.deliveries.length < before) { cleaned = true; console.log('[MIGRATION v2.4] Removed', before - this.db.deliveries.length, 'fake deliveries'); }
                }
                // Remove fake product variants (SKUs LAIT-001-*, RIZ-001-*)
                if (this.db.productVariants && this.db.productVariants.length > 0) {
                    const before = this.db.productVariants.length;
                    this.db.productVariants = this.db.productVariants.filter(v => !v.sku || (!v.sku.startsWith('LAIT-001-') && !v.sku.startsWith('RIZ-001-')));
                    if (this.db.productVariants.length < before) { cleaned = true; console.log('[MIGRATION v2.4] Removed', before - this.db.productVariants.length, 'fake product variants'); }
                }
                // Remove fake clients that were only referenced by seed data (Marcel Bakala id:1, Sylvie Moukoko id:2)
                // Only remove if they have no REAL orders left
                if (this.db.clients && this.db.clients.length > 0) {
                    const realOrderClientIds = new Set((this.db.orders || []).map(o => o.clientId).filter(Boolean));
                    const before = this.db.clients.length;
                    this.db.clients = this.db.clients.filter(c => {
                        if ((c.name === 'Marcel Bakala' || c.name === 'Sylvie Moukoko') && !realOrderClientIds.has(c.id)) return false;
                        return true;
                    });
                    if (this.db.clients.length < before) { cleaned = true; console.log('[MIGRATION v2.4] Removed', before - this.db.clients.length, 'fake clients'); }
                }
                // Also clean posDataByLocation of matching fake references
                if (this.db.posDataByLocation) {
                    Object.keys(this.db.posDataByLocation).forEach(posId => {
                        const pd = this.db.posDataByLocation[posId];
                        if (pd.orders) pd.orders = pd.orders.filter(o => !fakeRefs.includes(o.reference));
                        if (pd.deliveries) pd.deliveries = pd.deliveries.filter(d => !fakeRefs.includes(d.orderRef));
                    });
                }
                localStorage.setItem('raya_cleanup_v2_4', '1');
                if (cleaned) this.save();
                console.log('[MIGRATION v2.4] Cleaned VendeurModule seed data');
            }

            // MIGRATION v2.5: Clean test/simulated data from generateTestAlerts and old stale notifications
            if (!localStorage.getItem('raya_cleanup_v2_5')) {
                let cleaned25 = false;
                try {
                    // Remove test orders (id starts with "test_order_")
                    if (this.db.orders && this.db.orders.length > 0) {
                        const before = this.db.orders.length;
                        this.db.orders = this.db.orders.filter(o => !String(o.id || '').startsWith('test_order_'));
                        if (this.db.orders.length < before) { cleaned25 = true; console.log('[MIGRATION v2.5] Removed', before - this.db.orders.length, 'test orders'); }
                    }
                    // Remove test deliveries
                    if (this.db.deliveries && this.db.deliveries.length > 0) {
                        const before = this.db.deliveries.length;
                        this.db.deliveries = this.db.deliveries.filter(d => !String(d.id || '').startsWith('test_delivery_'));
                        if (this.db.deliveries.length < before) { cleaned25 = true; console.log('[MIGRATION v2.5] Removed', before - this.db.deliveries.length, 'test deliveries'); }
                    }
                    // Remove test products
                    if (this.db.products && this.db.products.length > 0) {
                        const before = this.db.products.length;
                        this.db.products = this.db.products.filter(p => !String(p.id || '').startsWith('test_product_'));
                        if (this.db.products.length < before) { cleaned25 = true; console.log('[MIGRATION v2.5] Removed', before - this.db.products.length, 'test products'); }
                    }
                    // Remove test incidents
                    if (this.db.incidents && this.db.incidents.length > 0) {
                        const before = this.db.incidents.length;
                        this.db.incidents = this.db.incidents.filter(i => !String(i.id || '').startsWith('test_incident_'));
                        if (this.db.incidents.length < before) { cleaned25 = true; console.log('[MIGRATION v2.5] Removed', before - this.db.incidents.length, 'test incidents'); }
                    }
                    // Clean old notifications (older than 7 days) to prevent stale data accumulation
                    if (this.db.notifications && this.db.notifications.length > 0) {
                        const cutoff = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                        const before = this.db.notifications.length;
                        this.db.notifications = this.db.notifications.filter(n => {
                            if (n.createdAt && new Date(n.createdAt) < cutoff) return false;
                            return true;
                        });
                        if (this.db.notifications.length < before) { cleaned25 = true; console.log('[MIGRATION v2.5] Removed', before - this.db.notifications.length, 'old notifications'); }
                    }
                } catch(e) { console.warn('[MIGRATION v2.5] Error:', e); }
                localStorage.setItem('raya_cleanup_v2_5', '1');
                if (cleaned25) this.save();
                console.log('[MIGRATION v2.5] Cleaned test/simulated data and old notifications');
            }

            // MIGRATION v2.6: Aggressive re-cleanup of ALL fake/simulated data (handles cloud-sync reintroduction)
            if (!localStorage.getItem('raya_cleanup_v2_6')) {
                console.log('[MIGRATION v2.6] Aggressive cleanup - removing all fake/simulated data...');
                let cleaned26 = false;
                try {
                    // --- Fake orders CMD-0001 to CMD-0014 ---
                    if (this.db.orders && this.db.orders.length > 0) {
                        const before = this.db.orders.length;
                        this.db.orders = this.db.orders.filter(o => {
                            const id = (o.id || '').toString();
                            const num = (o.orderNumber || '').toString();
                            if (/^CMD-00(0[1-9]|1[0-4])$/.test(num)) return false;
                            if (/^CMD-00(0[1-9]|1[0-4])$/.test(id)) return false;
                            if (id.startsWith('test_order_') || id.startsWith('demo_')) return false;
                            // Remove orders with fake client names
                            const cn = (o.clientName || '').toLowerCase();
                            if (cn.includes('marcel bakala') || cn.includes('sylvie moukoko')) return false;
                            return true;
                        });
                        if (this.db.orders.length < before) { cleaned26 = true; console.log('[v2.6] Removed', before - this.db.orders.length, 'fake orders'); }
                    }

                    // --- Fake clients ---
                    if (this.db.clients && this.db.clients.length > 0) {
                        const before = this.db.clients.length;
                        this.db.clients = this.db.clients.filter(c => {
                            const n = (c.name || '').toLowerCase();
                            if (n.includes('marcel bakala') || n.includes('sylvie moukoko')) return false;
                            const id = (c.id || '').toString();
                            if (id.startsWith('test_client_') || id.startsWith('demo_')) return false;
                            return true;
                        });
                        if (this.db.clients.length < before) { cleaned26 = true; console.log('[v2.6] Removed', before - this.db.clients.length, 'fake clients'); }
                    }

                    // --- Fake deliveries ---
                    if (this.db.deliveries && this.db.deliveries.length > 0) {
                        const before = this.db.deliveries.length;
                        this.db.deliveries = this.db.deliveries.filter(d => {
                            const id = (d.id || '').toString();
                            if (id.startsWith('test_delivery_') || id.startsWith('demo_')) return false;
                            const oid = (d.orderId || '').toString();
                            if (/^CMD-00(0[1-9]|1[0-4])$/.test(oid)) return false;
                            return true;
                        });
                        if (this.db.deliveries.length < before) { cleaned26 = true; console.log('[v2.6] Removed', before - this.db.deliveries.length, 'fake deliveries'); }
                    }

                    // --- Fake products/variants (LAIT-001-*, RIZ-001-*) ---
                    if (this.db.products && this.db.products.length > 0) {
                        const before = this.db.products.length;
                        this.db.products = this.db.products.filter(p => {
                            const id = (p.id || '').toString();
                            const sku = (p.sku || '').toString();
                            if (id.startsWith('test_product_') || id.startsWith('demo_')) return false;
                            if (/^(LAIT|RIZ)-001-/.test(sku) || /^(LAIT|RIZ)-001-/.test(id)) return false;
                            return true;
                        });
                        if (this.db.products.length < before) { cleaned26 = true; console.log('[v2.6] Removed', before - this.db.products.length, 'fake products'); }
                    }

                    // --- Fake suppliers (IDs 1-3) ---
                    if (this.db.suppliers && this.db.suppliers.length > 0) {
                        const before = this.db.suppliers.length;
                        this.db.suppliers = this.db.suppliers.filter(s => ![1, 2, 3, '1', '2', '3'].includes(s.id));
                        if (this.db.suppliers.length < before) { cleaned26 = true; console.log('[v2.6] Removed', before - this.db.suppliers.length, 'fake suppliers'); }
                    }

                    // --- Fake categories (IDs 1-5) ---
                    if (this.db.categories && this.db.categories.length > 0) {
                        const before = this.db.categories.length;
                        this.db.categories = this.db.categories.filter(c => ![1, 2, 3, 4, 5, '1', '2', '3', '4', '5'].includes(c.id));
                        if (this.db.categories.length < before) { cleaned26 = true; console.log('[v2.6] Removed', before - this.db.categories.length, 'fake categories'); }
                    }

                    // --- Fake shift templates (IDs 1-3) ---
                    if (this.db.shiftTemplates && this.db.shiftTemplates.length > 0) {
                        const before = this.db.shiftTemplates.length;
                        this.db.shiftTemplates = this.db.shiftTemplates.filter(s => ![1, 2, 3, '1', '2', '3'].includes(s.id));
                        if (this.db.shiftTemplates.length < before) { cleaned26 = true; console.log('[v2.6] Removed', before - this.db.shiftTemplates.length, 'fake shift templates'); }
                    }

                    // --- Clear all vendorBadges, alertRules, alertThresholds, financialTargets, reportTemplates if they contain seed data ---
                    ['vendorBadges', 'mobileMoneProviders', 'alertRules', 'alertThresholds', 'financialTargets', 'reportTemplates'].forEach(col => {
                        if (this.db[col] && this.db[col].length > 0) {
                            console.log('[v2.6] Clearing', this.db[col].length, 'items from', col);
                            this.db[col] = [];
                            cleaned26 = true;
                        }
                    });

                    // --- Clear productAttributeTypes seed data ---
                    if (this.db.productAttributeTypes && this.db.productAttributeTypes.length > 0) {
                        this.db.productAttributeTypes = [];
                        cleaned26 = true;
                        console.log('[v2.6] Cleared productAttributeTypes');
                    }

                    // --- Fake incidents ---
                    if (this.db.incidents && this.db.incidents.length > 0) {
                        const before = this.db.incidents.length;
                        this.db.incidents = this.db.incidents.filter(i => {
                            const id = (i.id || '').toString();
                            return !id.startsWith('test_incident_') && !id.startsWith('demo_');
                        });
                        if (this.db.incidents.length < before) { cleaned26 = true; console.log('[v2.6] Removed', before - this.db.incidents.length, 'fake incidents'); }
                    }

                    // --- posDataByLocation: remove fake entries ---
                    if (this.db.posDataByLocation) {
                        const keys = Object.keys(this.db.posDataByLocation);
                        if (keys.length > 0) {
                            this.db.posDataByLocation = {};
                            cleaned26 = true;
                            console.log('[v2.6] Cleared posDataByLocation fake entries');
                        }
                    }

                    // --- Remove fake user ratings ---
                    if (this.db.users && this.db.users.length > 0) {
                        this.db.users.forEach(u => {
                            if (u.rating === 4.5 && !u._ratingVerified) {
                                delete u.rating;
                                cleaned26 = true;
                            }
                        });
                    }

                    // --- Clean old notifications (>7 days) ---
                    if (this.db.notifications && this.db.notifications.length > 0) {
                        const cutoff = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                        const before = this.db.notifications.length;
                        this.db.notifications = this.db.notifications.filter(n => !(n.createdAt && new Date(n.createdAt) < cutoff));
                        if (this.db.notifications.length < before) { cleaned26 = true; console.log('[v2.6] Removed', before - this.db.notifications.length, 'old notifications'); }
                    }

                } catch(e) { console.warn('[MIGRATION v2.6] Error:', e); }

                localStorage.setItem('raya_cleanup_v2_6', '1');
                if (cleaned26) {
                    // Mark ALL affected collections dirty to push cleanup to cloud
                    ['orders', 'clients', 'deliveries', 'products', 'suppliers', 'categories', 'shiftTemplates',
                     'vendorBadges', 'mobileMoneProviders', 'alertRules', 'alertThresholds', 'financialTargets',
                     'reportTemplates', 'productAttributeTypes', 'incidents', 'notifications', 'users'].forEach(col => {
                        if (this.db[col]) this.markDirty(col);
                    });
                    this.save();
                    console.log('[MIGRATION v2.6] ✅ Aggressive cleanup complete & synced to cloud');
                } else {
                    console.log('[MIGRATION v2.6] No fake data found - database is clean');
                }
            }

            // MIGRATION v2.7: Re-cleanup fake/demo data (cloud-sync may reintroduce after v2.6 ran)
            if (!localStorage.getItem('raya_cleanup_v2_7')) {
                console.log('[MIGRATION v2.7] Re-cleaning fake/demo data...');
                let cleaned27 = this._sanitizeFakeData();
                localStorage.setItem('raya_cleanup_v2_7', '1');
                if (cleaned27) {
                    ['orders', 'clients', 'deliveries', 'products', 'suppliers', 'categories', 'shiftTemplates',
                     'vendorBadges', 'mobileMoneProviders', 'alertRules', 'alertThresholds', 'financialTargets',
                     'reportTemplates', 'productAttributeTypes', 'incidents', 'notifications',
                     'financialTransactions', 'stockMovements'].forEach(col => {
                        if (this.db[col]) this.markDirty(col);
                    });
                    this.save();
                    console.log('[MIGRATION v2.7] ✅ Re-cleanup complete & marked for cloud push');
                } else {
                    console.log('[MIGRATION v2.7] No fake data found');
                }
            }

            // MIGRATION v2.8: Clean fake financial transactions & stock movements (missed in v2.7)
            if (!localStorage.getItem('raya_cleanup_v2_8')) {
                console.log('[MIGRATION v2.8] Cleaning fake financial data...');
                let cleaned28 = this._sanitizeFakeData();
                localStorage.setItem('raya_cleanup_v2_8', '1');
                if (cleaned28) {
                    ['financialTransactions', 'stockMovements', 'orders', 'clients', 'deliveries', 'products'].forEach(col => {
                        if (this.db[col]) this.markDirty(col);
                    });
                    this.save();
                    console.log('[MIGRATION v2.8] ✅ Financial cleanup complete & marked for cloud push');
                } else {
                    console.log('[MIGRATION v2.8] No fake financial data found');
                }
            }

            // MIGRATION v2.9: Clean demo/fake notifications (now handled by _sanitizeFakeData)
            if (!localStorage.getItem('raya_cleanup_v2_9')) {
                console.log('[MIGRATION v2.9] Cleaning demo/fake notifications...');
                let cleaned29 = this._sanitizeFakeData();
                localStorage.setItem('raya_cleanup_v2_9', '1');
                if (cleaned29) {
                    ['notifications'].forEach(col => {
                        if (this.db[col]) this.markDirty(col);
                    });
                    this.save();
                    console.log('[MIGRATION v2.9] ✅ Notification cleanup complete & marked for cloud push');
                } else {
                    console.log('[MIGRATION v2.9] No fake notifications found');
                }
            }

            // MIGRATION v3.0: Fix NaN IDs and deduplicate products (cloud UUID duplicates)
            if (!localStorage.getItem('raya_cleanup_v3_0')) {
                console.log('[MIGRATION v3.0] Fixing NaN IDs and deduplicating products...');
                let cleaned30 = false;
                try {
                    // 1. Remove products with NaN, null, or undefined IDs
                    if (this.db.products && this.db.products.length > 0) {
                        const before = this.db.products.length;
                        this.db.products = this.db.products.filter(p => {
                            if (p.id === null || p.id === undefined) return false;
                            if (typeof p.id === 'number' && !Number.isFinite(p.id)) return false; // NaN, Infinity
                            return true;
                        });
                        if (this.db.products.length < before) {
                            cleaned30 = true;
                            console.log('[v3.0] Removed', before - this.db.products.length, 'products with invalid IDs');
                        }
                    }
                    // 2. Deduplicate: if a local product has _apiId matching a cloud product's id,
                    //    keep only the local one (with integer id + _apiId) and discard the cloud duplicate (UUID id)
                    if (this.db.products && this.db.products.length > 0) {
                        const apiIdSet = new Set();
                        this.db.products.forEach(p => { if (p._apiId) apiIdSet.add(String(p._apiId)); });
                        if (apiIdSet.size > 0) {
                            const before = this.db.products.length;
                            this.db.products = this.db.products.filter(p => {
                                // If this product's id is a UUID AND another product already claims it as _apiId, it's a duplicate
                                if (typeof p.id === 'string' && apiIdSet.has(p.id)) {
                                    // Check there's actually a local item with this as _apiId
                                    const localOwner = this.db.products.find(q => q !== p && String(q._apiId) === p.id);
                                    if (localOwner) {
                                        // Merge any cloud-only fields into the local owner before removing
                                        Object.keys(p).forEach(k => {
                                            if (localOwner[k] === undefined || localOwner[k] === null) {
                                                localOwner[k] = p[k];
                                            }
                                        });
                                        return false; // remove cloud duplicate
                                    }
                                }
                                return true;
                            });
                            if (this.db.products.length < before) {
                                cleaned30 = true;
                                console.log('[v3.0] Removed', before - this.db.products.length, 'duplicate cloud products');
                            }
                        }
                    }
                    // 3. Same dedup for other UUID collections (orders, clients, categories, deliveries)
                    ['orders', 'clients', 'categories', 'deliveries'].forEach(col => {
                        if (this.db[col] && this.db[col].length > 0) {
                            const apiIdSet = new Set();
                            this.db[col].forEach(item => { if (item._apiId) apiIdSet.add(String(item._apiId)); });
                            if (apiIdSet.size > 0) {
                                const before = this.db[col].length;
                                this.db[col] = this.db[col].filter(item => {
                                    if (typeof item.id === 'string' && apiIdSet.has(item.id)) {
                                        const localOwner = this.db[col].find(q => q !== item && String(q._apiId) === item.id);
                                        if (localOwner) return false;
                                    }
                                    return true;
                                });
                                if (this.db[col].length < before) {
                                    cleaned30 = true;
                                    console.log('[v3.0] Removed', before - this.db[col].length, 'duplicate cloud', col);
                                }
                            }
                        }
                    });
                } catch(e) { console.warn('[MIGRATION v3.0] Error:', e); }
                localStorage.setItem('raya_cleanup_v3_0', '1');
                if (cleaned30) {
                    ['products', 'orders', 'clients', 'categories', 'deliveries'].forEach(col => {
                        if (this.db[col]) this.markDirty(col);
                    });
                    this.save();
                    console.log('[MIGRATION v3.0] ✅ Deduplication complete & marked for cloud push');
                } else {
                    console.log('[MIGRATION v3.0] No duplicates or invalid IDs found');
                }
            }

            // MIGRATION: Initialiser posStocks pour les produits existants
            this.migrateProductsToPosStocks();

            // MIGRATION v3.1: Strip base64 bloat from localStorage
            if (!localStorage.getItem('raya_cleanup_v3_1')) {
                console.log('[MIGRATION v3.1] Stripping base64 images and reducing event queue...');
                try {
                    var stripped31 = 0;
                    // Strip base64 from products
                    if (Array.isArray(this.db.products)) {
                        this.db.products.forEach(function(p) {
                            if (p.image && typeof p.image === 'string' && p.image.startsWith('data:')) {
                                p.image = '';
                                stripped31++;
                            }
                        });
                    }
                    // Clear productImages entirely (base64 blobs)
                    if (Array.isArray(this.db.productImages) && this.db.productImages.length > 0) {
                        stripped31 += this.db.productImages.length;
                        this.db.productImages = [];
                    }
                    // Trim event queue
                    if (this._eventQueue && this._eventQueue.length > 800) {
                        var before = this._eventQueue.length;
                        this._eventQueue = this._eventQueue.slice(this._eventQueue.length - 800);
                        stripped31 += (before - this._eventQueue.length);
                        this.saveEventQueue();
                    }
                    // Trim oversized posDataByLocation sub-arrays
                    if (this.db.posDataByLocation) {
                        Object.keys(this.db.posDataByLocation).forEach(function(posKey) {
                            var pd = CORE.db.posDataByLocation[posKey];
                            if (pd) {
                                ['orders','clients','deliveries','transactions'].forEach(function(k) {
                                    if (Array.isArray(pd[k]) && pd[k].length > 150) {
                                        stripped31 += (pd[k].length - 150);
                                        pd[k] = pd[k].slice(0, 150);
                                    }
                                });
                            }
                        });
                    }
                    localStorage.setItem('raya_cleanup_v3_1', '1');
                    if (stripped31 > 0) {
                        this.save(true);
                        console.log('[MIGRATION v3.1] ✅ Stripped ' + stripped31 + ' bloat items');
                    } else {
                        console.log('[MIGRATION v3.1] No bloat found');
                    }
                } catch(e) { console.warn('[MIGRATION v3.1] Error:', e); localStorage.setItem('raya_cleanup_v3_1', '1'); }
            }

            // CRDT: Load event queue
            this.loadEventQueue();
        },

        /**
         * Persistent sanitizer: removes all known fake/demo data patterns.
         * Called by migrations AND after every cloud sync to prevent reintroduction.
         * Returns true if anything was cleaned.
         */
        _sanitizeFakeData() {
            let cleaned = false;
            try {
                // Fake orders CMD-0001 to CMD-0014 + test/demo prefixed
                if (this.db.orders && this.db.orders.length > 0) {
                    const before = this.db.orders.length;
                    this.db.orders = this.db.orders.filter(o => {
                        const id = (o.id || '').toString();
                        const num = (o.orderNumber || o.reference || '').toString();
                        if (/^CMD-00(0[1-9]|1[0-4])$/.test(num)) return false;
                        if (/^CMD-00(0[1-9]|1[0-4])$/.test(id)) return false;
                        if (id.startsWith('test_order_') || id.startsWith('demo_')) return false;
                        const cn = (o.clientName || '').toLowerCase();
                        if (cn.includes('marcel bakala') || cn.includes('sylvie moukoko')) return false;
                        return true;
                    });
                    if (this.db.orders.length < before) { cleaned = true; console.log('[SANITIZE] Removed', before - this.db.orders.length, 'fake orders'); }
                }
                // Fake clients
                if (this.db.clients && this.db.clients.length > 0) {
                    const before = this.db.clients.length;
                    this.db.clients = this.db.clients.filter(c => {
                        const n = (c.name || '').toLowerCase();
                        if (n.includes('marcel bakala') || n.includes('sylvie moukoko')) return false;
                        const id = (c.id || '').toString();
                        if (id.startsWith('test_client_') || id.startsWith('demo_')) return false;
                        return true;
                    });
                    if (this.db.clients.length < before) { cleaned = true; console.log('[SANITIZE] Removed', before - this.db.clients.length, 'fake clients'); }
                }
                // Fake deliveries
                if (this.db.deliveries && this.db.deliveries.length > 0) {
                    const before = this.db.deliveries.length;
                    this.db.deliveries = this.db.deliveries.filter(d => {
                        const id = (d.id || '').toString();
                        if (id.startsWith('test_delivery_') || id.startsWith('demo_')) return false;
                        const oid = (d.orderId || '').toString();
                        if (/^CMD-00(0[1-9]|1[0-4])$/.test(oid)) return false;
                        return true;
                    });
                    if (this.db.deliveries.length < before) { cleaned = true; console.log('[SANITIZE] Removed', before - this.db.deliveries.length, 'fake deliveries'); }
                }
                // Fake products (LAIT-001-*, RIZ-001-*, test/demo prefixed)
                if (this.db.products && this.db.products.length > 0) {
                    const before = this.db.products.length;
                    this.db.products = this.db.products.filter(p => {
                        const id = (p.id || '').toString();
                        const sku = (p.sku || '').toString();
                        if (id.startsWith('test_product_') || id.startsWith('demo_')) return false;
                        if (/^(LAIT|RIZ)-001-/.test(sku) || /^(LAIT|RIZ)-001-/.test(id)) return false;
                        return true;
                    });
                    if (this.db.products.length < before) { cleaned = true; console.log('[SANITIZE] Removed', before - this.db.products.length, 'fake products'); }
                }
                // Fake suppliers — only remove if ID matches test/demo prefix patterns, NOT sequential integers
                // (CORE.create() generates sequential IDs 1,2,3... so we must NOT delete by ID alone)
                if (this.db.suppliers && this.db.suppliers.length > 0) {
                    const before = this.db.suppliers.length;
                    this.db.suppliers = this.db.suppliers.filter(s => {
                        const id = (s.id || '').toString();
                        if (id.startsWith('test_supplier_') || id.startsWith('demo_')) return false;
                        return true;
                    });
                    if (this.db.suppliers.length < before) { cleaned = true; console.log('[SANITIZE] Removed', before - this.db.suppliers.length, 'fake suppliers'); }
                }
                // Fake categories — only remove if ID matches test/demo prefix patterns, NOT sequential integers
                // (CORE.create() generates sequential IDs 1,2,3... so we must NOT delete by ID alone)
                if (this.db.categories && this.db.categories.length > 0) {
                    const before = this.db.categories.length;
                    this.db.categories = this.db.categories.filter(c => {
                        const id = (c.id || '').toString();
                        if (id.startsWith('test_category_') || id.startsWith('demo_')) return false;
                        return true;
                    });
                    if (this.db.categories.length < before) { cleaned = true; console.log('[SANITIZE] Removed', before - this.db.categories.length, 'fake categories'); }
                }
                // Fake incidents
                if (this.db.incidents && this.db.incidents.length > 0) {
                    const before = this.db.incidents.length;
                    this.db.incidents = this.db.incidents.filter(i => {
                        const id = (i.id || '').toString();
                        return !id.startsWith('test_incident_') && !id.startsWith('demo_');
                    });
                    if (this.db.incidents.length < before) { cleaned = true; console.log('[SANITIZE] Removed', before - this.db.incidents.length, 'fake incidents'); }
                }
                // Fake financial transactions (linked to fake orders or demo-prefixed)
                if (this.db.financialTransactions && this.db.financialTransactions.length > 0) {
                    const fakeOrderRefs = /^CMD-00(0[1-9]|1[0-4])$/;
                    const before = this.db.financialTransactions.length;
                    this.db.financialTransactions = this.db.financialTransactions.filter(t => {
                        const id = (t.id || '').toString();
                        if (id.startsWith('demo_') || id.startsWith('test_tx_')) return false;
                        const ref = (t.ref || '').toString();
                        if (fakeOrderRefs.test(ref)) return false;
                        const orderId = (t.orderId || '').toString();
                        if (fakeOrderRefs.test(orderId)) return false;
                        if (orderId.startsWith('test_order_') || orderId.startsWith('demo_')) return false;
                        const note = (t.note || '').toLowerCase();
                        if (note.includes('marcel bakala') || note.includes('sylvie moukoko')) return false;
                        if (note.includes('cmd-0001') || note.includes('cmd-0002') || note.includes('cmd-0003') || note.includes('cmd-0004')) return false;
                        if (note.includes('cmd-0010') || note.includes('cmd-0011') || note.includes('cmd-0012') || note.includes('cmd-0013') || note.includes('cmd-0014')) return false;
                        const deliveryId = (t.deliveryId || '').toString();
                        if (deliveryId.startsWith('test_delivery_') || deliveryId.startsWith('demo_')) return false;
                        // userName "System" with no orderId and category sale is likely seed data
                        return true;
                    });
                    if (this.db.financialTransactions.length < before) { cleaned = true; console.log('[SANITIZE] Removed', before - this.db.financialTransactions.length, 'fake financial transactions'); }
                }
                // Fake stock movements (linked to fake orders/products)
                if (this.db.stockMovements && this.db.stockMovements.length > 0) {
                    const before = this.db.stockMovements.length;
                    this.db.stockMovements = this.db.stockMovements.filter(m => {
                        const id = (m.id || '').toString();
                        if (id.startsWith('demo_') || id.startsWith('test_')) return false;
                        const ref = (m.ref || '').toString();
                        if (/^CMD-00(0[1-9]|1[0-4])$/.test(ref)) return false;
                        const productId = (m.productId || '').toString();
                        if (productId.startsWith('test_product_') || productId.startsWith('demo_')) return false;
                        if (/^(LAIT|RIZ)-001-/.test(productId)) return false;
                        return true;
                    });
                    if (this.db.stockMovements.length < before) { cleaned = true; console.log('[SANITIZE] Removed', before - this.db.stockMovements.length, 'fake stock movements'); }
                }

                // Fake/demo notifications — remove test-prefixed, demo-prefixed, and old stale (>7 days)
                if (this.db.notifications && this.db.notifications.length > 0) {
                    const cutoff = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    const before = this.db.notifications.length;
                    this.db.notifications = this.db.notifications.filter(n => {
                        const id = (n.id || '').toString();
                        if (id.startsWith('demo_') || id.startsWith('test_')) return false;
                        const title = (n.title || '').toLowerCase();
                        const msg = (n.message || '').toLowerCase();
                        // Remove notifications referencing fake data patterns
                        if (title.includes('marcel bakala') || title.includes('sylvie moukoko')) return false;
                        if (msg.includes('marcel bakala') || msg.includes('sylvie moukoko')) return false;
                        if (/cmd-00(0[1-9]|1[0-4])/.test(msg) || /cmd-00(0[1-9]|1[0-4])/.test(title)) return false;
                        // Remove old stale notifications (>7 days)
                        if (n.createdAt && new Date(n.createdAt) < cutoff) return false;
                        return true;
                    });
                    if (this.db.notifications.length < before) { cleaned = true; console.log('[SANITIZE] Removed', before - this.db.notifications.length, 'fake/old notifications'); }
                }

                // AUTO-RECOVERY: Ensure default categories exist so product creation is never blocked
                if (!this.db.categories || this.db.categories.length === 0) {
                    const maxId = Math.max(0, ...(this.db.categories || []).map(c => typeof c.id === 'number' ? c.id : 0));
                    this.db.categories = [
                        { id: maxId + 1, name: 'Alimentaire', icon: 'shopping-cart', createdAt: new Date().toISOString() },
                        { id: maxId + 2, name: 'Boissons', icon: 'coffee', createdAt: new Date().toISOString() },
                        { id: maxId + 3, name: 'Hygiène & Entretien', icon: 'sparkles', createdAt: new Date().toISOString() },
                        { id: maxId + 4, name: 'Electronique', icon: 'cpu', createdAt: new Date().toISOString() },
                        { id: maxId + 5, name: 'Divers', icon: 'package', createdAt: new Date().toISOString() }
                    ];
                    cleaned = true;
                    console.log('[SANITIZE] Auto-created default categories (categories were empty)');
                }
            } catch(e) { console.warn('[SANITIZE] Error:', e); }
            return cleaned;
        },

        migrateProductsToPosStocks() {
            const pos = this.db.pointsOfSale || [];
            let needsSave = false;

            // Pour chaque produit
            this.db.products?.forEach(p => {
                if (p && (p.posId === null || p.posId === undefined || p.posId === '')) {
                    const fallbackPosId = p.storeId ?? p.pointOfSaleId ?? p.pos ?? p.store?.id ?? null;
                    if (fallbackPosId !== null && fallbackPosId !== undefined && fallbackPosId !== '') {
                        p.posId = Number.isFinite(Number(fallbackPosId)) ? Number(fallbackPosId) : fallbackPosId;
                        needsSave = true;
                    }
                }
                if (p && p.storeId === undefined && p.posId !== null && p.posId !== undefined && p.posId !== '') {
                    p.storeId = p.posId;
                    needsSave = true;
                }
                if (!p.posStocks) {
                    p.posStocks = {};
                    needsSave = true;

                    // Initialiser le stock pour chaque POS (== pour éviter mismatch string/number)
                    pos.forEach(location => {
                        // Si c'est un produit créé pour ce POS, utiliser son stock
                        if (p.posId == location.id) {
                            p.posStocks[location.id] = {
                                stock: p.stock || 0,
                                price: p.price || 0
                            };
                        } else {
                            // Sinon, initialiser avec 0
                            p.posStocks[location.id] = {
                                stock: 0,
                                price: p.price || 0
                            };
                        }
                    });
                }
            });

            // Aussi, pour les produits existants, s'assurer qu'ils ont posStocks[posId] pour TOUS les POS
            this.db.products?.forEach(p => {
                if (p.posStocks) {
                    pos.forEach(location => {
                        if (!p.posStocks[location.id]) {
                            p.posStocks[location.id] = {
                                stock: p.posId == location.id ? (p.stock || 0) : 0,
                                price: p.price || 0
                            };
                            needsSave = true;
                        }
                    });
                }
            });

            if (needsSave) this.save();
        },
        // ===== P1: DIRTY TRACKING — persisted to localStorage so dirty state survives refresh =====
        _dirtyCollections: new Set(),
        _dirtyStorageKey: 'raya_dirty_collections',
        _loadDirtyFromStorage() {
            try {
                var raw = localStorage.getItem(this._dirtyStorageKey);
                if (raw) {
                    var arr = JSON.parse(raw);
                    if (Array.isArray(arr)) arr.forEach(c => this._dirtyCollections.add(c));
                }
            } catch(e) {}
        },
        _persistDirty() {
            try {
                localStorage.setItem(this._dirtyStorageKey, JSON.stringify(Array.from(this._dirtyCollections)));
            } catch(e) {}
        },
        markDirty(collection) {
            if (collection) {
                this._dirtyCollections.add(collection);
                this._persistDirty();
            }
        },
        getDirtyCollections() {
            return Array.from(this._dirtyCollections);
        },
        clearDirty(collections) {
            if (collections && Array.isArray(collections)) {
                collections.forEach(c => this._dirtyCollections.delete(c));
            } else {
                this._dirtyCollections.clear();
            }
            this._persistDirty();
        },
        hasDirty() {
            return this._dirtyCollections.size > 0;
        },
        // ===== P4: CHANGE LOG — track individual item changes for incremental sync =====
        _changeLog: {},  // { collection: { upserts: Map(id->item), deletes: Set(id) } }
        logChange(collection, op, item) {
            if (!collection || !item || item.id == null) return;
            if (!this._changeLog[collection]) {
                this._changeLog[collection] = { upserts: new Map(), deletes: new Set() };
            }
            var log = this._changeLog[collection];
            var idStr = String(item.id);
            if (op === 'delete') {
                log.upserts.delete(idStr);
                log.deletes.add(item.id);
            } else {
                // create or update — store the full item snapshot
                log.deletes.delete(item.id);
                log.upserts.set(idStr, item);
            }
        },
        getDeltas(collections) {
            var deltas = {};
            var cols = collections || Object.keys(this._changeLog);
            for (var i = 0; i < cols.length; i++) {
                var col = cols[i];
                var log = this._changeLog[col];
                if (!log) continue;
                var upserts = Array.from(log.upserts.values());
                var deletes = Array.from(log.deletes);
                if (upserts.length > 0 || deletes.length > 0) {
                    deltas[col] = { upserts: upserts, deletes: deletes };
                }
            }
            return deltas;
        },
        hasDeltas() {
            var keys = Object.keys(this._changeLog);
            for (var i = 0; i < keys.length; i++) {
                var log = this._changeLog[keys[i]];
                if (log && (log.upserts.size > 0 || log.deletes.size > 0)) return true;
            }
            return false;
        },
        clearChangeLog(collections) {
            if (collections && Array.isArray(collections)) {
                for (var i = 0; i < collections.length; i++) {
                    delete this._changeLog[collections[i]];
                }
            } else {
                this._changeLog = {};
            }
        },

        // --- CRDT: Event Queue à stores pending events for sync ---
        _eventQueue: [],       // Pending events not yet pushed to server
        _eventSeqNo: 0,        // Last known server seqNo (watermark)
        _eventQueueKey: 'raya_event_queue',
        _eventSeqKey: 'raya_event_seqno',

        /** Load event queue from localStorage */
        loadEventQueue() {
            try {
                var raw = localStorage.getItem(this._eventQueueKey);
                this._eventQueue = raw ? JSON.parse(raw) : [];
                var storedSeq = localStorage.getItem(this._eventSeqKey) || '0';
                var parsed = parseInt(storedSeq, 10) || 0;
                // Guard: if seqNo exceeds JS safe integer range, it's corrupted → reset
                if (parsed > Number.MAX_SAFE_INTEGER || parsed < 0 || !Number.isFinite(parsed)) {
                    console.warn('[CRDT] Corrupted seqNo detected (' + storedSeq + ') — resetting to 0');
                    parsed = 0;
                    localStorage.removeItem(this._eventSeqKey);
                }
                this._eventSeqNo = parsed;
            } catch(e) { this._eventQueue = []; this._eventSeqNo = 0; }
        },

        /** Save event queue to localStorage */
        saveEventQueue() {
            try {
                localStorage.setItem(this._eventQueueKey, JSON.stringify(this._eventQueue));
                localStorage.setItem(this._eventSeqKey, String(this._eventSeqNo));
            } catch(e) {
                // On quota error: aggressively trim event queue and retry
                if (e.name === 'QuotaExceededError' || e.code === 22 || e.code === 1014) {
                    console.warn('[CRDT] Event queue save quota exceeded (' + this._eventQueue.length + ' events). Trimming...');
                    // Keep only the last 500 events (from 5000 max)
                    if (this._eventQueue.length > 500) {
                        this._eventQueue = this._eventQueue.slice(this._eventQueue.length - 500);
                    }
                    try {
                        localStorage.setItem(this._eventQueueKey, JSON.stringify(this._eventQueue));
                        localStorage.setItem(this._eventSeqKey, String(this._eventSeqNo));
                        console.warn('[CRDT] ✓ Event queue saved after trimming to ' + this._eventQueue.length + ' events');
                    } catch(e2) {
                        // Still failing — clear event queue entirely (events are synced to cloud)
                        console.warn('[CRDT] Still over quota — clearing event queue (data is synced to cloud)');
                        this._eventQueue = [];
                        try { localStorage.setItem(this._eventQueueKey, '[]'); } catch(e3) {}
                    }
                } else {
                    console.warn('[CRDT] Event queue save failed:', e.message);
                }
            }
        },

        /** Record a CRDT event with HLC timestamp and field-level detail */
        recordEvent(collection, operation, item, changedFields) {
            if (!collection || !item || item.id == null) return;
            var hlc = HLC.now();
            var fields = {};

            if (operation === 'delete') {
                // For delete, record the deleted item's id
                fields = { _deleted: { v: true, hlc: hlc } };
            } else if (operation === 'create') {
                // For create, record ALL fields with the HLC
                var keys = Object.keys(item);
                for (var i = 0; i < keys.length; i++) {
                    var k = keys[i];
                    if (k === '_hlc' || k === '_deviceId') continue;
                    fields[k] = { v: item[k], hlc: hlc };
                }
            } else if (operation === 'update' && changedFields) {
                // For update, record only the CHANGED fields
                var ukeys = Object.keys(changedFields);
                for (var j = 0; j < ukeys.length; j++) {
                    var uk = ukeys[j];
                    if (uk === '_hlc' || uk === '_deviceId') continue;
                    fields[uk] = { v: changedFields[uk], hlc: hlc };
                }
                // Always include updatedAt
                fields.updatedAt = { v: item.updatedAt, hlc: hlc };
            }

            var event = {
                collection: collection,
                itemId: String(item.id),
                operation: operation,
                fields: fields,
                hlc: hlc
            };

            this._eventQueue.push(event);

            // Cap queue size: if > 1000 events, keep newest 800
            if (this._eventQueue.length > 1000) {
                this._eventQueue = this._eventQueue.slice(this._eventQueue.length - 800);
            }

            this.saveEventQueue();
            return event;
        },

        /** Get count of pending events */
        pendingEventCount() {
            return this._eventQueue.length;
        },

        save(immediate = false) {
            // PERF: Debounce localStorage writes — max once per 1s unless immediate
            var self = this;
            var _doSave = function() {
                self._productIndex = null;
                self._userIndex = null;
                var _st0 = performance.now();

                // ── PROACTIVE CAPS: Trim high-volume collections BEFORE serialization ──
                // This prevents quota errors entirely instead of reacting to them.
                var _capCollection = function(col, maxItems) {
                    if (Array.isArray(self.db[col]) && self.db[col].length > maxItems) {
                        self.db[col] = self.db[col].slice(0, maxItems);
                    }
                };
                // Logs & history: keep only recent entries (cloud has full history)
                _capCollection('auditLogs', 200);
                _capCollection('activityLogs', 200);
                _capCollection('systemLogs', 50);
                _capCollection('auditTrail', 100);
                _capCollection('complianceLogs', 50);
                _capCollection('accessLogs', 50);
                _capCollection('dataModificationLogs', 50);
                _capCollection('deletionLogs', 50);
                _capCollection('exportLogs', 50);
                _capCollection('complianceReports', 20);
                _capCollection('alertHistory', 50);
                _capCollection('incidentHistory', 50);
                _capCollection('suspensionHistory', 50);
                _capCollection('importExportHistory', 50);
                _capCollection('messageLog', 50);
                _capCollection('notificationHistory', 50);
                _capCollection('paymentHistory', 50);
                _capCollection('paymentWebhooks', 20);
                _capCollection('dailyDigestLogs', 20);
                _capCollection('approvalAuditTrail', 100);
                // Transactional: keep more but still bounded
                _capCollection('stockMovements', 200);
                _capCollection('financialTransactions', 300);
                _capCollection('notifications', 100);
                _capCollection('deposits', 200);
                _capCollection('mobilePayments', 100);
                _capCollection('paymentInvoices', 100);
                // Core collections: keep bounded (cloud is source of truth)
                _capCollection('orders', 200);
                _capCollection('clients', 300);
                _capCollection('deliveries', 150);
                _capCollection('returns', 100);
                _capCollection('stockTransfers', 50);
                _capCollection('transferReceipts', 50);
                _capCollection('purchaseOrders', 50);
                _capCollection('incidents', 50);
                _capCollection('shifts', 50);
                _capCollection('timeOff', 50);
                _capCollection('orderApprovals', 50);
                _capCollection('returnJustifications', 50);
                _capCollection('expiryAlerts', 50);
                _capCollection('backups', 10);
                // Analytics (regenerable from cloud)
                _capCollection('stockPredictions', 50);
                _capCollection('stockAnalysisABC', 50);
                _capCollection('reorderSuggestions', 50);
                _capCollection('stockTrendHistory', 50);
                _capCollection('generatedReports', 20);
                // ── BASE64 IMAGE STRIPPING ──
                // Product images as base64 are the #1 bloat cause (500KB-2MB each).
                // Strip them before serialization — cloud has the originals.
                _capCollection('productImages', 0); // Never store images in localStorage
                if (Array.isArray(self.db.products)) {
                    self.db.products.forEach(function(p) {
                        if (p.image && typeof p.image === 'string' && p.image.startsWith('data:')) {
                            p.image = ''; // Strip base64, will be re-fetched from cloud
                        }
                    });
                }
                // ── TRANSFER MEDIA STRIPPING (v34, enhanced v36) ──
                // sendMedia and receptionMedia contain raw base64 data blobs (500KB-5MB each).
                // These bloat localStorage AND cause PUT timeouts (30s) on cloud sync.
                // Strip data: URIs — keep only metadata (type, name, date).
                var _stripTransferMedia = function(arr) {
                    if (!Array.isArray(arr)) return;
                    arr.forEach(function(t) {
                        // Strip known media arrays
                        ['sendMedia', 'receptionMedia', 'rejectionMedia', 'media', 'photos', 'attachments'].forEach(function(field) {
                            if (Array.isArray(t[field])) {
                                t[field] = t[field].map(function(m) {
                                    if (m && m.data && typeof m.data === 'string' && m.data.length > 500) {
                                        return { type: m.type, name: m.name, date: m.date, stripped: true };
                                    }
                                    return m;
                                });
                            }
                        });
                        // v36: Strip ANY string field > 5KB (likely base64 or embedded HTML)
                        var tKeys = Object.keys(t);
                        for (var tk = 0; tk < tKeys.length; tk++) {
                            var val = t[tKeys[tk]];
                            if (typeof val === 'string' && val.length > 5000 && tKeys[tk] !== 'id' && tKeys[tk] !== '_id' && tKeys[tk] !== '_apiId') {
                                if (val.startsWith('data:') || val.startsWith('blob:')) {
                                    t[tKeys[tk]] = '[stripped-media]';
                                } else if (val.length > 20000) {
                                    t[tKeys[tk]] = val.substring(0, 200) + '...[truncated]';
                                }
                            }
                        }
                    });
                };
                _stripTransferMedia(self.db.stockTransfers);
                _stripTransferMedia(self.db.transferReceipts);
                // v36: Also strip stockMovements large fields
                if (Array.isArray(self.db.stockMovements)) {
                    self.db.stockMovements.forEach(function(m) {
                        if (m.details && typeof m.details === 'string' && m.details.length > 1000) {
                            m.details = m.details.substring(0, 200) + '...[truncated]';
                        }
                        // Remove any embedded product snapshots
                        if (m.productSnapshot) delete m.productSnapshot;
                        if (m.beforeSnapshot) delete m.beforeSnapshot;
                        if (m.afterSnapshot) delete m.afterSnapshot;
                    });
                }
                // v36: Cap stockMovements more aggressively and sort by date (newest first)
                if (Array.isArray(self.db.stockMovements) && self.db.stockMovements.length > 200) {
                    self.db.stockMovements.sort(function(a, b) {
                        return new Date(b.createdAt || b.date || 0) - new Date(a.createdAt || a.date || 0);
                    });
                    self.db.stockMovements = self.db.stockMovements.slice(0, 200);
                }
                // Trim posDataByLocation sub-collections (ALL sub-arrays, not just 3)
                if (self.db.posDataByLocation) {
                    Object.keys(self.db.posDataByLocation).forEach(function(posKey) {
                        var posData = self.db.posDataByLocation[posKey];
                        if (posData) {
                            if (Array.isArray(posData.orders) && posData.orders.length > 100) posData.orders = posData.orders.slice(0, 100);
                            if (Array.isArray(posData.clients) && posData.clients.length > 150) posData.clients = posData.clients.slice(0, 150);
                            if (Array.isArray(posData.deliveries) && posData.deliveries.length > 100) posData.deliveries = posData.deliveries.slice(0, 100);
                            if (Array.isArray(posData.transactions) && posData.transactions.length > 100) posData.transactions = posData.transactions.slice(0, 100);
                            if (Array.isArray(posData.stockMovements) && posData.stockMovements.length > 100) posData.stockMovements = posData.stockMovements.slice(0, 100);
                            if (Array.isArray(posData.notifications) && posData.notifications.length > 50) posData.notifications = posData.notifications.slice(0, 50);
                            if (Array.isArray(posData.activityLogs) && posData.activityLogs.length > 50) posData.activityLogs = posData.activityLogs.slice(0, 50);
                        }
                    });
                }

                var payload = {
                    state: { ...self.state, currentUser: self.state.currentUser ? { id: self.state.currentUser.id } : null },
                    db: self.db,
                    savedAt: new Date().toISOString()
                };
                self._syncGlobalFromTenant();
                self.saveGlobal();

                // ── SIZE DIAGNOSTIC (only when payload > 3MB) ──
                var jsonPayload = JSON.stringify(payload);
                if (jsonPayload.length > 3 * 1024 * 1024) {
                    console.warn('[SAVE-DIAG] Payload: ' + (jsonPayload.length / 1024).toFixed(0) + 'KB. Top collections:');
                    var _sizes = [];
                    Object.keys(self.db).forEach(function(k) {
                        var s = JSON.stringify(self.db[k] || null);
                        if (s && s.length > 5000) _sizes.push({ name: k, kb: (s.length / 1024).toFixed(1) });
                    });
                    _sizes.sort(function(a, b) { return parseFloat(b.kb) - parseFloat(a.kb); });
                    _sizes.slice(0, 10).forEach(function(s) { console.warn('  ' + s.name + ': ' + s.kb + 'KB'); });
                }

                // ── QuotaExceededError handling ──
                // localStorage has a ~5-10MB limit. When collections grow large
                // (stockMovements, orders, logs...), the serialized payload exceeds it.
                // Strategy: try full save → on quota error, progressively strip
                // low-priority collections from the payload and retry. Cloud is the
                // source of truth — stripped data will be re-fetched on next sync.
                if (!jsonPayload) jsonPayload = JSON.stringify(payload);
                try {
                    localStorage.setItem(self.getStorageKey(), jsonPayload);
                } catch(quotaErr) {
                    if (quotaErr.name === 'QuotaExceededError' || quotaErr.code === 22 || quotaErr.code === 1014) {
                        console.warn('[SAVE] ⚠ localStorage quota exceeded (' + (jsonPayload.length / 1024).toFixed(0) + 'KB). Pruning non-critical data...');
                        // Tiers of collections to strip, from least to most critical
                        var _pruneTiers = [
                            // Tier 1: Logs, history, audit — high volume, low offline value
                            ['activityLogs', 'auditLogs', 'systemLogs', 'auditTrail', 'complianceLogs',
                             'accessLogs', 'dataModificationLogs', 'deletionLogs', 'exportLogs',
                             'complianceReports', 'alertHistory', 'incidentHistory', 'suspensionHistory',
                             'importExportHistory', 'messageLog', 'notificationHistory', 'paymentHistory',
                             'paymentWebhooks', 'dailyDigestLogs', 'approvalAuditTrail'],
                            // Tier 2: Predictions, analytics, templates — regenerable
                            ['stockPredictions', 'stockAnalysisABC', 'reorderSuggestions', 'stockTrendHistory',
                             'deliveryRoutes', 'routeStops', 'addressClusters', 'routeOptimizations',
                             'generatedReports', 'reportSchedules', 'reportTemplates', 'financialMetrics',
                             'messageTemplates', 'deliveryTicketTemplates', 'productImages',
                             'dashboardLayouts', 'widgetConfigs', 'keyboardShortcuts', 'themeSettings'],
                            // Tier 3: Large transactional data (will be re-pulled from cloud)
                            ['stockMovements', 'transferReceipts', 'financialTransactions',
                             'deposits', 'livreurCommissions', 'mobilePayments', 'paymentInvoices'],
                            // Tier 4: Medium transactional data
                            ['deliveries', 'returns', 'incidents', 'orderApprovals',
                             'returnJustifications', 'shifts', 'timeOff', 'expiryAlerts']
                        ];
                        var prunedDb = JSON.parse(JSON.stringify(payload.db));
                        var saved = false;
                        for (var tier = 0; tier < _pruneTiers.length; tier++) {
                            var cols = _pruneTiers[tier];
                            for (var c = 0; c < cols.length; c++) {
                                if (Array.isArray(prunedDb[cols[c]]) && prunedDb[cols[c]].length > 0) {
                                    prunedDb[cols[c]] = [];
                                }
                            }
                            var prunedPayload = JSON.stringify({
                                state: payload.state,
                                db: prunedDb,
                                savedAt: payload.savedAt,
                                _pruned: tier + 1
                            });
                            try {
                                localStorage.setItem(self.getStorageKey(), prunedPayload);
                                console.warn('[SAVE] ✓ Saved after pruning tier ' + (tier + 1) + ' (' + (prunedPayload.length / 1024).toFixed(0) + 'KB)');
                                saved = true;
                                break;
                            } catch(e2) {
                                // Still too large — try next tier
                                console.warn('[SAVE] Still too large after tier ' + (tier + 1) + ', trying next...');
                            }
                        }
                        if (!saved) {
                            // Nuclear option: save only critical state (users, products, categories, stores)
                            console.error('[SAVE] ❌ All prune tiers exhausted. Saving minimal state...');
                            var minimalDb = {
                                users: prunedDb.users || [],
                                products: prunedDb.products || [],
                                categories: prunedDb.categories || [],
                                stores: prunedDb.stores || [],
                                pointsOfSale: prunedDb.pointsOfSale || [],
                                cities: prunedDb.cities || [],
                                clients: prunedDb.clients || [],
                                orders: prunedDb.orders || [],
                                stockTransfers: prunedDb.stockTransfers || [],
                                notifications: prunedDb.notifications || [],
                                roles: prunedDb.roles || [],
                                permissions: prunedDb.permissions || [],
                                systemConfig: prunedDb.systemConfig || {},
                                posDataByLocation: prunedDb.posDataByLocation || {}
                            };
                            try {
                                localStorage.setItem(self.getStorageKey(), JSON.stringify({
                                    state: payload.state,
                                    db: minimalDb,
                                    savedAt: payload.savedAt,
                                    _pruned: 'minimal'
                                }));
                                console.warn('[SAVE] ✓ Minimal state saved');
                            } catch(e3) {
                                console.error('[SAVE] ❌ Cannot save even minimal state:', e3.message);
                            }
                        }
                    } else {
                        console.error('[SAVE] Unexpected localStorage error:', quotaErr);
                    }
                }
                var _elapsed = performance.now() - _st0;
                if (_elapsed > 100) console.warn('[PERF] CORE.save slow: ' + _elapsed.toFixed(0) + 'ms');
            };
            if (immediate) {
                clearTimeout(this._saveTimer);
                _doSave();
            } else {
                // Debounce: batch rapid save calls into one
                if (!this._saveTimer) {
                    this._saveTimer = setTimeout(function() {
                        self._saveTimer = null;
                        // P2-11 FIX: Call save(true) instead of raw _doSave()
                        // so cloud push is also triggered after debounce
                        self.save(true);
                    }, 1000);
                }
                return;
            }

            // === CLOUD-FIRST: Push to server (source of truth) ===
            // PERF: Debounce cloud pushes — batch rapid save(true) calls into one network sync.
            // Without this, a single transfer triggers save(true) which fires 4-5 PUT requests,
            // and if recordStockMovement also calls save(), that's another 4-5 PUTs — all redundant.
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() && navigator.onLine && this.hasDirty()) {
                clearTimeout(this._cloudPushTimer);
                // Auto-reset stuck CORE lock after 60s (aligned with API lock's 120s auto-reset)
                if (this._isCloudPushing && this._cloudPushStart && (Date.now() - this._cloudPushStart > 60000)) {
                    console.warn('[CLOUD-SAVE] Resetting stuck push lock after ' + Math.round((Date.now() - this._cloudPushStart)/1000) + 's');
                    this._isCloudPushing = false;
                }

                // P5: Skip if CORE push is already running (prevents duplicate pushes that collide with API mutex)
                if (this._isCloudPushing) {
                    console.log('[CLOUD-SAVE] Skipping — CORE push already in progress');
                    return;
                }

                // P5: Skip if API global push mutex is already active (periodic sync / login sync running)
                if (typeof API !== 'undefined' && API._isSyncPushing) {
                    var _apiPushAge = API._syncPushStart ? Math.round((Date.now() - API._syncPushStart)/1000) : '?';
                    console.log('[CLOUD-SAVE] Skipping — API sync push in progress (' + _apiPushAge + 's)');
                    return;
                }

                // PERF: Debounce — wait 3s of inactivity before pushing to cloud.
                // This batches multiple rapid saves into a single network sync.
                // E.g., a transfer marks 5 collections dirty across 2 save() calls → 1 sync with 5 collections.
                this._cloudPushTimer = setTimeout(() => {
                    this._doCloudPush(0);
                }, 3000);
            }
        },

        // Extracted cloud push logic with retry support
        _doCloudPush(retryCount) {
            retryCount = retryCount || 0;
            if (!this._isCloudPushing && this.hasDirty()) {
                this._isCloudPushing = true;
                this._cloudPushStart = Date.now();
                var dirtyList = this.getDirtyCollections();
                console.log('[CLOUD-SAVE] ☁ Pushing ' + dirtyList.length + ' dirty collections:', dirtyList.join(', '));
                API.syncDirtyToCloud(dirtyList).then(() => {
                    console.log('[CLOUD-SAVE] ✅ Saved to server (source of truth)');
                    this._isCloudPushing = false;
                    this._consecutiveFailures = 0;
                }).catch(e => {
                    this._isCloudPushing = false;
                    this._consecutiveFailures = (this._consecutiveFailures || 0) + 1;
                    // If not authenticated — don't retry, wait for re-login
                    if (e && (e._noAuth || e._sessionExpired)) {
                        console.warn('[CLOUD-SAVE] ⚠ Not authenticated → data saved locally, waiting for re-login');
                        return;
                    }
                    // Exponential backoff: 5s, 10s, 20s, 40s, max 60s
                    var delay = Math.min(5000 * Math.pow(2, retryCount), 60000);
                    console.warn('[CLOUD-SAVE] ⚠ Push failed (retry ' + (retryCount+1) + ' in ' + (delay/1000) + 's):', e.message);
                    if (retryCount < 5) {
                        this._cloudPushTimer = setTimeout(() => this._doCloudPush(retryCount + 1), delay);
                    } else {
                        console.error('[CLOUD-SAVE] ❌ Max retries reached. Data saved locally, will sync on next cycle.');
                        if (typeof UI !== 'undefined' && UI.toast && this._consecutiveFailures > 3) {
                            UI.toast('⚠ Synchronisation échouée — vos données sont sauvegardées localement', 'warning', 8000);
                        }
                    }
                });
            }
        },
        reset() {
            localStorage.removeItem(this.getStorageKey());
            localStorage.removeItem(this.globalStorageKey);
            localStorage.removeItem('raya_api_tokens');
            if (this.global && this.global.tenants) {
                Object.keys(this.global.tenants).forEach(tid => {
                    localStorage.removeItem(this.getStorageKey(tid));
                });
            }
            if (typeof RayaAPI !== 'undefined') RayaAPI.clearTokens();
            location.reload();
        },

        // CRUD
        create(collection, item, options = {}) {
            // BUG FIX: Only use numeric IDs for max calculation.
            // After sync merge, cloud items with UUID string IDs appear in the collection.
            // Math.max(1, 2, "uuid-string") returns NaN → new items get id: NaN and become invisible.
            const ids = this.db[collection].map(i => i.id).filter(id => typeof id === 'number' && Number.isFinite(id));
            const id = (ids.length > 0 ? Math.max(...ids) : 0) + 1;
            const ts = new Date().toISOString();
            const newItem = { ...item, id, createdAt: ts, updatedAt: ts };
            this.db[collection].push(newItem);

            // File d'attente hors-ligne améliorée
            if (!this.state.isOnline && typeof OfflineManager !== 'undefined') {
                const entityName = item.name || item.orderRef || item.ref || `#${id}`;
                OfflineManager.enqueue({
                    type: 'create',
                    collection,
                    id,
                    data: newItem,
                    desc: options.desc || `Création: ${entityName}`,
                    entityName,
                    userId: this.state.currentUser?.id,
                    userName: this.state.currentUser?.name
                });
            } else if (!this.state.isOnline) {
                // Fallback ancien système
                this.db.pendingSyncs = this.db.pendingSyncs || [];
                this.db.pendingSyncs.push({
                    id: CORE.uid(),
                    type: 'create',
                    collection,
                    id,
                    desc: `Création dans ${collection}`,
                    queuedAt: new Date().toISOString(),
                    status: 'pending',
                    retryCount: 0
                });
            }

            // CRDT: Stamp item with HLC and deviceId
            newItem._hlc = HLC.now();
            newItem._deviceId = DeviceId.get();
            this.recordEvent(collection, 'create', newItem, null);
            this.logChange(collection, 'create', newItem);
            this.markDirty(collection);
            this.save();
            // Background API sync
            if (typeof RayaAPI !== 'undefined' && RayaAPI.isAuthenticated()) {
                RayaAPI.pushToApi(collection, 'create', newItem).catch(function(e) { console.warn('[CORE.create] API sync failed:', e.message); });
            }
            return newItem;
        },
        update(collection, id, updates, options = {}) {
            const index = this.db[collection].findIndex(i => i.id === id);
            if (index !== -1) {
                const oldItem = { ...this.db[collection][index] };
                this.db[collection][index] = { ...this.db[collection][index], ...updates, updatedAt: new Date().toISOString() };

                // File d'attente hors-ligne améliorée
                if (!this.state.isOnline && typeof OfflineManager !== 'undefined') {
                    const entityName = this.db[collection][index].name || this.db[collection][index].orderRef || this.db[collection][index].ref || `#${id}`;
                    OfflineManager.enqueue({
                        type: 'update',
                        collection,
                        id,
                        data: updates,
                        oldData: oldItem,
                        desc: options.desc || `Modification: ${entityName}`,
                        entityName,
                        userId: this.state.currentUser?.id,
                        userName: this.state.currentUser?.name
                    });
                } else if (!this.state.isOnline) {
                    this.db.pendingSyncs = this.db.pendingSyncs || [];
                    this.db.pendingSyncs.push({
                        id: CORE.uid(),
                        type: 'update',
                        collection,
                        id,
                        desc: `Mise à jour dans ${collection}`,
                        queuedAt: new Date().toISOString(),
                        status: 'pending',
                        retryCount: 0
                    });
                }

                // CRDT: Stamp item with HLC and deviceId
                this.db[collection][index]._hlc = HLC.now();
                this.db[collection][index]._deviceId = DeviceId.get();
                this.recordEvent(collection, 'update', this.db[collection][index], updates);
                this.logChange(collection, 'update', this.db[collection][index]);
                this.markDirty(collection);
                this.save();
                // Background API sync
                if (typeof RayaAPI !== 'undefined' && RayaAPI.isAuthenticated()) {
                    RayaAPI.pushToApi(collection, 'update', this.db[collection][index]).catch(function(e) { console.warn('[CORE.update] API sync failed:', e.message); });
                }
                return this.db[collection][index];
            }
            return null;
        },
        delete(collection, id, options = {}) {
            const index = this.db[collection].findIndex(i => i.id === id);
            if (index !== -1) {
                // --- SOFT DELETE: Mark as _deleted instead of physical removal ---
                const item = this.db[collection][index];
                item._deleted = true;
                item._deletedAt = new Date().toISOString();
                item._hlc = typeof HLC !== 'undefined' ? HLC.now() : new Date().toISOString();
                item._deviceId = typeof DeviceId !== 'undefined' ? DeviceId.get() : 'unknown';
                const removed = item;

                // File d'attente hors-ligne améliorée
                if (!this.state.isOnline && typeof OfflineManager !== 'undefined') {
                    const entityName = removed.name || removed.orderRef || removed.ref || `#${id}`;
                    OfflineManager.enqueue({
                        type: 'delete',
                        collection,
                        id,
                        data: removed,
                        desc: options.desc || `Suppression: ${entityName}`,
                        entityName,
                        userId: this.state.currentUser?.id,
                        userName: this.state.currentUser?.name
                    });
                } else if (!this.state.isOnline) {
                    this.db.pendingSyncs = this.db.pendingSyncs || [];
                    this.db.pendingSyncs.push({
                        id: CORE.uid(),
                        type: 'delete',
                        collection,
                        id,
                        desc: `Suppression dans ${collection}`,
                        queuedAt: new Date().toISOString(),
                        status: 'pending',
                        retryCount: 0
                    });
                }

                // CRDT: Record delete event
                this.recordEvent(collection, 'delete', removed, null);
                this.logChange(collection, 'delete', removed);
                this.markDirty(collection);
                this.save();
                // Background API sync
                if (typeof RayaAPI !== 'undefined' && RayaAPI.isAuthenticated()) {
                    RayaAPI.pushToApi(collection, 'delete', removed).catch(function(e) { console.warn('[CORE.delete] API sync failed:', e.message); });
                }
                return removed;
            }
            return null;
        },

        // --- SOFT DELETE HELPERS ---
        /** Get active (non-deleted) items from a collection */
        getActive(collection) {
            return (this.db[collection] || []).filter(function(item) { return !item._deleted; });
        },

        /** Count active (non-deleted) items */
        countActive(collection) {
            return (this.db[collection] || []).filter(function(item) { return !item._deleted; }).length;
        },

        /** Purge soft-deleted items older than N days (default 30) from local DB */
        purgeDeleted(collection, olderThanDays) {
            var days = olderThanDays || 30;
            var cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString();
            var arr = this.db[collection] || [];
            var before = arr.length;
            this.db[collection] = arr.filter(function(item) {
                if (!item._deleted) return true;
                if (!item._deletedAt) return false;
                return item._deletedAt > cutoff;
            });
            var purged = before - this.db[collection].length;
            if (purged > 0) {
                console.log('[SOFT-DELETE] Purged ' + purged + ' items from ' + collection);
                this.markDirty(collection);
                this.save();
            }
            return purged;
        },

        /** Purge all collections of old soft-deleted items */
        purgeAllDeleted(olderThanDays) {
            var self = this;
            var total = 0;
            var collections = Object.keys(this.db).filter(function(k) { return Array.isArray(self.db[k]); });
            collections.forEach(function(col) {
                total += self.purgeDeleted(col, olderThanDays);
            });
            if (total > 0) {
                console.log('[SOFT-DELETE] Total purged across all collections: ' + total);
            }
            return total;
        },

        async processSyncQueue() {
            // Use RayaAPI full sync if authenticated
            if (typeof RayaAPI !== 'undefined' && RayaAPI.isAuthenticated() && CORE.state.isOnline) {
                UI.toast('Synchronisation avec le serveur...', 'info');
                if (typeof SyncIndicator !== 'undefined') SyncIndicator.show('syncing', 'Synchronisation...');
                // Pull from generic cloud sync (tenant_data)
                try { await RayaAPI.syncAllFromCloud(); } catch(e) { console.warn('[processSyncQueue] Cloud pull failed:', e.message); }
                // Push to generic cloud sync
                try { await RayaAPI.syncAllToCloud(); } catch(e) { console.warn('[processSyncQueue] Cloud push failed:', e.message); }
                // PERF: Removed syncFromApi — syncAllFromCloud already pulls all data
                this.db.pendingSyncs = [];
                UI.toast('Synchronisation terminée !', 'success');
                if (typeof SyncIndicator !== 'undefined') SyncIndicator.show('success', 'Sync OK');
                App.rerender();
                return;
            }

            // Déléguer au nouveau OfflineManager si disponible
            if (typeof OfflineManager !== 'undefined') {
                return OfflineManager.syncAll();
            }

            // Ancien système de fallback
            const q = this.db.pendingSyncs || [];
            if (q.length === 0) {
                UI.toast('Aucune opération à synchroniser', 'info');
                return;
            }

            if (!this.state.isOnline) {
                UI.toast('Impossible de synchroniser: hors ligne', 'warning');
                return;
            }

            // Feedback visuel
            const indicator = document.getElementById('sync-indicator');
            let syncedCount = 0;

            if (indicator) {
                indicator.innerHTML = `<div class="flex items-center gap-2 px-3 py-2 bg-blue-500 text-white rounded-full shadow-lg animate-pulse"><i data-lucide="refresh-cw" class="w-4 h-4 animate-spin"></i><span class="text-xs font-black">Synchronisation 0/${q.length}...</span></div>`;
                lucide.createIcons();
            }

            UI.toast(`Synchronisation de ${q.length} opération(s)...`, 'info');

            // Simuler traitement des opérations avec délai progressif
            return new Promise((resolve) => {
                let processed = 0;
                const processNext = () => {
                    if (processed < q.length) {
                        processed++;
                        syncedCount = processed;

                        if (indicator) {
                            indicator.innerHTML = `<div class="flex items-center gap-2 px-3 py-2 bg-blue-500 text-white rounded-full shadow-lg animate-pulse"><i data-lucide="refresh-cw" class="w-4 h-4 animate-spin"></i><span class="text-xs font-black">Synchronisation ${processed}/${q.length}...</span></div>`;
                            lucide.createIcons();
                        }

                        setTimeout(processNext, 300); // 300ms par opération
                    } else {
                        // Tous les sync traités
                        this.db.pendingSyncs = [];
                        this.state.lastSync = new Date().toISOString();
                        this.save();

                        if (indicator) {
                            indicator.innerHTML = `<div class="flex items-center gap-2 px-3 py-2 bg-emerald-500 text-white rounded-full shadow-lg"><i data-lucide="check-circle" class="w-4 h-4"></i><span class="text-xs font-black">✓ Synchronisé (${syncedCount})</span></div>`;
                            lucide.createIcons();

                            // Disparaître après 3 secondes
                            setTimeout(() => {
                                if (indicator && indicator.innerHTML.includes('Synchronisé')) {
                                    indicator.innerHTML = '';
                                }
                            }, 3000);
                        }

                        UI.toast(`${syncedCount} opération(s) synchronisée(s) avec succès`, 'success');
                        App.rerender();
                        resolve(true);
                    }
                };

                processNext();
            });
        },

        async migrateLocalToCloud(options = {}) {
            if (this._migrationInProgress) {
                UI.toast('Migration déjà en cours...', 'info');
                return;
            }
            if (typeof RayaAPI === 'undefined' || !RayaAPI.isAuthenticated()) {
                UI.toast('Connectez-vous pour migrer vers le cloud', 'warning');
                return;
            }
            if (!this.state.isOnline) {
                UI.toast('Impossible de migrer: hors ligne', 'warning');
                return;
            }
            const autoKey = 'raya_migration_done_' + (RayaAPI.tenantId || this.tenantId || 'default');
            if (options.auto && localStorage.getItem(autoKey)) {
                return;
            }
            if (options.auto) {
                options.skipConfirm = true;
            }
            if (!options.skipConfirm) {
                const ok = confirm('Cette migration va envoyer toutes vos donnees locales vers le cloud. Cela peut creer des doublons si des donnees existent deja sur le serveur.\n\nContinuer ?');
                if (!ok) return;
            }

            this._migrationInProgress = true;
            let migrationSuccess = false;
            const stats = {
                categories: { created: 0, skipped: 0, failed: 0 },
                products: { created: 0, skipped: 0, failed: 0 },
                clients: { created: 0, skipped: 0, failed: 0 },
                users: { created: 0, skipped: 0, failed: 0, invalid: 0 },
                orders: { created: 0, skipped: 0, failed: 0 },
                orderItemsSkipped: 0,
                ordersSkipped: 0
            };

            try {
                UI.toast('Migration vers le cloud en cours...', 'info');

                const categories = this.db.categories || [];
                for (let i = 0; i < categories.length; i++) {
                    const c = categories[i];
                    if (c._apiId) { stats.categories.skipped++; continue; }
                    try {
                        const payload = RayaAPI._toApiFormat('categories', c);
                        const result = await RayaAPI.createCategory(payload);
                        if (result && result.id) { c._apiId = result.id; stats.categories.created++; }
                        else { stats.categories.failed++; }
                    } catch (e) { stats.categories.failed++; }
                }

                const categoryIdMap = {};
                categories.forEach(function(c) {
                    if (c._apiId) categoryIdMap[c.id] = c._apiId;
                });

                const products = this.db.products || [];
                for (let i = 0; i < products.length; i++) {
                    const p = products[i];
                    if (p._apiId) { stats.products.skipped++; continue; }
                    try {
                        const productForApi = { ...p };
                        const localCatId = productForApi.category || productForApi.categoryId;
                        if (localCatId && categoryIdMap[localCatId]) {
                            productForApi.categoryId = categoryIdMap[localCatId];
                        }
                        const payload = RayaAPI._toApiFormat('products', productForApi);
                        const result = await RayaAPI.createProduct(payload);
                        if (result && result.id) { p._apiId = result.id; stats.products.created++; }
                        else { stats.products.failed++; }
                    } catch (e) { stats.products.failed++; }
                }

                const productIdMap = {};
                products.forEach(function(p) {
                    if (p._apiId) { productIdMap[p.id] = p._apiId; productIdMap[p._apiId] = p._apiId; }
                });

                const clients = this.db.clients || [];
                for (let i = 0; i < clients.length; i++) {
                    const c = clients[i];
                    if (c._apiId) { stats.clients.skipped++; continue; }
                    try {
                        const payload = RayaAPI._toApiFormat('clients', c);
                        const result = await RayaAPI.createCustomer(payload);
                        if (result && result.id) { c._apiId = result.id; stats.clients.created++; }
                        else { stats.clients.failed++; }
                    } catch (e) { stats.clients.failed++; }
                }

                const users = this.db.users || [];
                for (let i = 0; i < users.length; i++) {
                    const u = users[i];
                    if (u._apiId) { stats.users.skipped++; continue; }
                    if (RayaAPI.user && (u.email === RayaAPI.user.email || u.id === RayaAPI.user.id)) {
                        stats.users.skipped++;
                        continue;
                    }
                    const rawEmail = u.email || u.username || '';
                    const isEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(rawEmail);
                    if (!isEmail || !u.password) { stats.users.invalid++; continue; }

                    const name = u.name || '';
                    const parts = name.split(' ');
                    const firstName = u.firstName || parts[0] || 'User';
                    const lastName = u.lastName || parts.slice(1).join(' ') || '';
                    const role = (u.role || 'vendeur').toUpperCase();

                    try {
                        const result = await RayaAPI.registerUserSilent({
                            email: rawEmail,
                            password: u.password,
                            firstName: firstName,
                            lastName: lastName,
                            role: role,
                            tenantId: RayaAPI.tenantId
                        });
                        if (result && result.user && result.user.id) { u._apiId = result.user.id; stats.users.created++; }
                        else { stats.users.failed++; }
                    } catch (e) { stats.users.failed++; }
                }

                const orders = this.db.orders || [];
                for (let i = 0; i < orders.length; i++) {
                    const o = orders[i];
                    if (o._apiId) { stats.orders.skipped++; continue; }

                    const rawItems = o.items || o.products || [];
                    const mappedItems = rawItems.map(function(it) {
                        const localId = it.productId || it._apiId || it.id;
                        const apiId = productIdMap[localId];
                        if (!apiId) { stats.orderItemsSkipped++; return null; }
                        return { ...it, productId: apiId, _apiId: apiId, id: apiId };
                    }).filter(Boolean);

                    if (mappedItems.length === 0) { stats.ordersSkipped++; continue; }

                    try {
                        const orderForApi = { ...o, items: mappedItems };
                        const payload = RayaAPI._toApiFormat('orders', orderForApi);
                        const result = await RayaAPI.createOrder(payload);
                        if (result && result.id) { o._apiId = result.id; stats.orders.created++; }
                        else { stats.orders.failed++; }
                    } catch (e) { stats.orders.failed++; }
                }

                this.save();
                console.log('[MIGRATION] Stats:', stats);

                UI.toast(
                    'Migration terminee: ' + stats.products.created + ' produits, ' +
                    stats.clients.created + ' clients, ' +
                    stats.users.created + ' utilisateurs, ' +
                    stats.orders.created + ' commandes',
                    'success'
                );

                if (stats.ordersSkipped > 0 || stats.orderItemsSkipped > 0) {
                    UI.toast('Certaines commandes ont ete ignorees (produits non mappes)', 'warning');
                }
                migrationSuccess = true;
            } catch (err) {
                console.error('[MIGRATION] Error:', err);
                UI.toast('Erreur lors de la migration. Consultez la console.', 'error');
            } finally {
                if (migrationSuccess) {
                    try { localStorage.setItem(autoKey, new Date().toISOString()); } catch (e) {}
                }
                this._migrationInProgress = false;
            }
        },

        // Helpers
        // P3-4: Collision-safe unique ID generator (replaces raw Date.now())
        uid() { return Date.now() + '-' + Math.random().toString(36).slice(2, 8); },

        getCity(id) { return this.db.cities.find(c => c.id === id); },
        getPOS(id) {
            return (this.db.pointsOfSale || []).find(p => p.id === id || String(p.id) === String(id));
        },
        getCategory(id) { return this.db.categories.find(c => c.id === id); },
        // P3-6: Indexed lookups â€” rebuild on save, O(1) instead of O(n)
        _productIndex: null,
        _userIndex: null,
        _rebuildIndexes() {
            this._productIndex = new Map();
            (this.db.products || []).forEach(p => {
                this._productIndex.set(p.id, p);
                this._productIndex.set(String(p.id), p);
                // Also index by _apiId so getProduct(uuid) works for transferred products
                if (p._apiId) this._productIndex.set(p._apiId, p);
                if (p._apiId) this._productIndex.set(String(p._apiId), p);
            });
            this._userIndex = new Map();
            (this.db.users || []).forEach(u => { this._userIndex.set(u.id, u); this._userIndex.set(String(u.id), u); if (u._apiId) this._userIndex.set(u._apiId, u); });
        },
        getProduct(id) {
            if (!this._productIndex) this._rebuildIndexes();
            return this._productIndex.get(id)
                || this._productIndex.get(String(id))
                || this.db.products.find(p => p.id === id || String(p.id) === String(id) || (p._apiId && String(p._apiId) === String(id)));
        },
        getUser(id) {
            if (!this._userIndex) this._rebuildIndexes();
            const u = this._userIndex.get(id) || this._userIndex.get(String(id)) || this.db.users.find(u => u.id === id || String(u.id) === String(id) || u._apiId === id);
            if (u) return u;
            // Also resolve independent delivery men
            const indep = (this.db.independentDeliveryMen || []).find(dm => dm.id === id || String(dm.id) === String(id));
            if (indep) {
                return { id: indep.id, name: indep.name + ' (Indépendant)', phone: indep.phone, pos: indep.posId, role: 'livreur', active: indep.status === 'active', isIndependent: true, vehicle: indep.vehicle || 'N/A', rating: indep.rating || 0 };
            }
            return undefined;
        },
        getClient(id) { return this.db.clients.find(c => c.id === id || String(c.id) === String(id)); },
        getProductVariants(productId) { return this.db.productVariants.filter(v => v.productId === productId && !v._deleted); },

        // Main warehouse helpers
        getMainWarehouseProducts() { return (this.db.products || []).filter(p => p.isMainWarehouse); },
        getProductsExcludingMain() { return (this.db.products || []).filter(p => !p.isMainWarehouse); },

        // Stock par POS (Option 1)
        getProductStock(productId, posId) {
            const product = this.getProduct(productId);
            if (!product) return 0;
            if (!posId) return product.stock || 0;

            // Utiliser posStocks si disponible
            if (product.posStocks && product.posStocks[posId]) {
                return product.posStocks[posId].stock || 0;
            }
            // Fallback: si le produit appartient au POS demandé, retourner son stock
            if (product.posId == posId) {
                return product.stock || 0;
            }
            return 0;
        },

        getProductPrice(productId, posId) {
            const product = this.getProduct(productId);
            if (!product) return 0;
            // Si le produit a une structure posStocks
            if (product.posStocks && product.posStocks[posId]) {
                return product.posStocks[posId].price || product.price || 0;
            }
            // Fallback: utiliser le prix global
            return product.price || 0;
        },

        setProductStock(productId, posId, stock) {
            const product = this.getProduct(productId);
            if (!product) return;
            const safeStock = Math.max(0, Number(stock) || 0);
            // If posId is provided, update posStocks for that POS
            if (posId !== null && posId !== undefined && posId !== '') {
                if (!product.posStocks) product.posStocks = {};
                if (!product.posStocks[posId]) product.posStocks[posId] = { stock: 0, price: product.price || 0 };
                product.posStocks[posId].stock = safeStock;
                product.posStocks[posId].lastUpdated = new Date().toISOString();
                // Also update master stock ONLY if product belongs to this POS
                // (prevents transfer from one POS overwriting the master stock)
                if (product.posId == posId || !product.posId) {
                    product.stock = safeStock;
                }
            } else {
                // No posId — update master stock directly
                product.stock = safeStock;
            }
            // FIX: Set updatedAt so _smartMerge preserves this change vs cloud
            product.updatedAt = new Date().toISOString();
            this.markDirty('products');
            this.save();
        },

        setProductPrice(productId, posId, price) {
            const product = this.getProduct(productId);
            if (!product) return;
            if (!product.posStocks) product.posStocks = {};
            if (!product.posStocks[posId]) product.posStocks[posId] = { stock: 0, price: 0 };
            product.posStocks[posId].price = Math.max(0, price);
            this.save();
        },

        // ========== SYSTÈME DE PERMISSIONS CENTRALISÉ ==========

        /**
         * Vérifie si l'utilisateur actuel a accès à une ressource
         * @param {string} resourceType - 'product', 'order', 'user', 'pos', 'delivery'
         * @param {*} resource - l'objet ressource
         * @returns {boolean}
         */
        canAccess(resourceType, resource) {
            const user = this.state.currentUser;
            if (!user) return false;

            // PDG: accès à tout
            if (user.role === 'pdg') return true;

            // Manager: accès à tous les POS
            if (user.role === 'manager') return true;

            // Autres rôles: doivent être dans le même POS
            // Dériver user.pos depuis TOUS les champs possibles
            const userPos = user.pos || user.storeId || user.pointOfSaleId || user.posId || user.store_id || user.locationId;
            if (!userPos) {
                console.warn('[canAccess] userPos undefined for', user.name, '- fields:', { pos: user.pos, storeId: user.storeId, pointOfSaleId: user.pointOfSaleId, posId: user.posId });
                return false;
            }
            const strUserPos = String(userPos);

            switch(resourceType) {
                case 'product':
                    // Vendeur/Gestionnaire: produits de leur POS seulement
                    const productPosId = resource?.posId ?? resource?.storeId ?? resource?.pointOfSaleId ?? resource?.pos ?? resource?.store?.id;
                    // String comparison to handle type mismatch (int vs string, UUID vs number)
                    if (productPosId != null && String(productPosId) === strUserPos) return true;
                    // Loose equality as fallback (handles "1" == 1)
                    if (productPosId == userPos) return true;
                    // Vérifier posStocks (produits transférés) - both raw key and string key
                    if (resource?.posStocks) {
                        if (resource.posStocks[userPos] || resource.posStocks[strUserPos]) return true;
                    }
                    return false;

                case 'order':
                    // Vendeur: commandes de son POS seulement
                    // Gestionnaire: commandes de son POS seulement
                    return resource?.posId == userPos;

                case 'delivery':
                    // Livreur: livraisons assignées à son POS
                    // Vendeur: livraisons des commandes de son POS
                    if (user.role === 'livreur') {
                        return resource?.livreurId === user.id;
                    }
                    return resource?.posId == userPos;

                case 'user':
                    // Gestionnaire/Vendeur: filtrage strict par POS (vérifier tous les champs POS possibles)
                    var resourcePos = resource?.pos ?? resource?.posId ?? resource?.storeId ?? resource?.pointOfSaleId ?? null;
                    if (!resourcePos) return false; // Pas de POS assigné = pas visible
                    return resourcePos == userPos;

                case 'client':
                    // Clients du même POS
                    return resource?.posId == user.pos;

                case 'pos':
                    // Gestionnaire: gérer seulement son POS
                    return resource?.id == user.pos;

                case 'transaction':
                    // Transactions du même POS
                    return resource?.posId == user.pos;

                case 'expense':
                case 'income':
                    // Transactions du même POS
                    return resource?.posId == userPos;

                default:
                    return false;
            }
        },

        /**
         * Vérifie si l'utilisateur peut MODIFIER une ressource
         * @param {string} resourceType
         * @param {*} resource
         * @returns {boolean}
         */
        canModify(resourceType, resource) {
            const user = this.state.currentUser;
            if (!user) return false;

            // PDG et Manager: modification complète
            if (user.role === 'pdg' || user.role === 'manager') return true;

            const userPos = user.pos || user.storeId || user.pointOfSaleId;

            switch(resourceType) {
                case 'product':
                    // Gestionnaire: modifier produits de son POS seulement
                    if (user.role === 'gestionnaire') {
                        const productPosId = resource?.posId ?? resource?.storeId ?? resource?.pointOfSaleId ?? resource?.pos ?? resource?.store?.id;
                        return productPosId == userPos;
                    }
                    return false;

                case 'stock':
                    // Manager et Gestionnaire: modifier le stock
                    if (user.role === 'manager' || user.role === 'gestionnaire') {
                        if (user.role === 'gestionnaire') {
                            return resource?.posId == userPos;
                        }
                        return true; // Manager: tous les POS
                    }
                    return false;

                case 'expense':
                    // Gestionnaire: ajouter dépenses pour son POS
                    if (user.role === 'gestionnaire') {
                        return resource?.posId == userPos;
                    }
                    return false;

                case 'order':
                    // Vendeur: créer commandes pour son POS
                    if (user.role === 'vendeur') {
                        return resource?.posId == userPos;
                    }
                    return false;

                default:
                    return false;
            }
        },

        /**
         * Filtre un array de ressources selon les permissions
         * @param {array} resources
         * @param {string} resourceType
         * @returns {array}
         */
        filterByAccess(resources, resourceType) {
            return resources.filter(r => this.canAccess(resourceType, r));
        },

        getVisibleOrders() {
            return this.filterByAccess(this.db.orders || [], 'order');
        },

        getVisibleClients() {
            return this.filterByAccess(this.db.clients || [], 'client');
        },

        getVisibleDeliveries() {
            return this.filterByAccess(this.db.deliveries || [], 'delivery');
        },

        getVisibleUsers() {
            var raw = (this.db.users || []).filter(u => !u._deleted);
            // Dedup: keep only one entry per email or _apiId (prefer the one with _apiId)
            var seen = {};
            var deduped = [];
            for (var i = 0; i < raw.length; i++) {
                var u = raw[i];
                var key = (u.email || u.username || '').toLowerCase().trim();
                if (!key) { deduped.push(u); continue; }
                if (seen[key]) {
                    // Keep the one with _apiId or the one with more data
                    var existing = seen[key];
                    if (!existing._apiId && u._apiId) { deduped[deduped.indexOf(existing)] = u; seen[key] = u; }
                    // else skip this duplicate
                } else {
                    seen[key] = u;
                    deduped.push(u);
                }
            }
            return this.filterByAccess(deduped, 'user');
        },

        getVisibleProducts() {
            return this.filterByAccess(this.db.products || [], 'product');
        },

        getVisibleTransactions() {
            return this.filterByAccess(this.db.financialTransactions || [], 'transaction');
        },

        getVisibleStockMovements() {
            return this.db.stockMovements || [];
        },

        // ========== FONCTIONS D'ACCÈS ISOLÉ PAR POS ==========
        /**
         * ISOLATION COMPLÈTE: Récupère les clients d'un POS spécifique uniquement
         */
        getPOSClients(posId) {
            if (!posId) return [];
            // Utilise la structure isolée posDataByLocation
            if (this.db.posDataByLocation && this.db.posDataByLocation[posId]) {
                return this.db.posDataByLocation[posId].clients || [];
            }
            // Fallback sur les données avec filtre posId
            return (this.db.clients || []).filter(c => c.posId == posId);
        },

        /**
         * ISOLATION COMPLÈTE: Récupère les commandes d'un POS spécifique uniquement
         */
        getPOSOrders(posId) {
            if (!posId) return [];
            // Utilise la structure isolée posDataByLocation
            if (this.db.posDataByLocation && this.db.posDataByLocation[posId]) {
                return this.db.posDataByLocation[posId].orders || [];
            }
            // Fallback sur les données avec filtre posId
            return (this.db.orders || []).filter(o => o.posId == posId);
        },

        /**
         * ISOLATION COMPLÈTE: Récupère les livraisons d'un POS spécifique uniquement
         */
        getPOSDeliveries(posId) {
            if (!posId) return [];
            // Utilise la structure isolée posDataByLocation
            if (this.db.posDataByLocation && this.db.posDataByLocation[posId]) {
                return this.db.posDataByLocation[posId].deliveries || [];
            }
            // Fallback sur les données avec filtre posId
            return (this.db.deliveries || []).filter(d => d.posId == posId);
        },

        /**
         * ISOLATION COMPLÈTE: Récupère les transactions d'un POS spécifique uniquement
         */
        getPOSTransactions(posId) {
            if (!posId) return [];
            // Utilise la structure isolée posDataByLocation
            if (this.db.posDataByLocation && this.db.posDataByLocation[posId]) {
                return this.db.posDataByLocation[posId].transactions || [];
            }
            // Fallback sur les données avec filtre posId
            return (this.db.financialTransactions || []).filter(t => t.posId == posId);
        },

        /**
         * Récupère les données appropriées selon le rôle de l'utilisateur
         * PDG/Manager: tous les POS
         * Autres: POS assigné uniquement
         */
        getDataForUser(dataType) {
            const user = this.state.currentUser;
            if (!user) return [];

            // PDG et Manager: voir tous les POS
            if (user.role === 'pdg' || user.role === 'manager') {
                switch(dataType) {
                    case 'orders':
                        return this.getVisibleOrders();
                    case 'clients':
                        return this.getVisibleClients();
                    case 'deliveries':
                        return this.getVisibleDeliveries();
                    case 'transactions':
                        return this.getVisibleTransactions();
                    default:
                        return [];
                }
            }

            // Autres rôles: données du POS assigné uniquement
            if (!user.pos) return [];

            switch(dataType) {
                case 'orders':
                    return this.getVisibleOrders();
                case 'clients':
                    return this.getVisibleClients();
                case 'deliveries':
                    return this.getVisibleDeliveries();
                case 'transactions':
                    return this.getVisibleTransactions();
                default:
                    return [];
            }
        },

        /**
         * ISOLATION COMPLÈTE: Ajoute un client à un POS spécifique
         */
        addClientToPOS(posId, client) {
            if (!posId || !client) return null;
            // Initialise la structure si elle n'existe pas
            if (!this.db.posDataByLocation) this.db.posDataByLocation = {};
            if (!this.db.posDataByLocation[posId]) {
                this.db.posDataByLocation[posId] = {
                    clients: [], orders: [], deliveries: [], transactions: []
                };
            }
            // Ajoute le client avec le posId
            client.posId = posId;
            client.id = client.id || Date.now() + Math.random();
            this.db.posDataByLocation[posId].clients.push(client);
            this.save();
            return client;
        },

        /**
         * ISOLATION COMPLÈTE: Ajoute une commande à un POS spécifique
         */
        addOrderToPOS(posId, order) {
            if (!posId || !order) return null;
            // Initialise la structure si elle n'existe pas
            if (!this.db.posDataByLocation) this.db.posDataByLocation = {};
            if (!this.db.posDataByLocation[posId]) {
                this.db.posDataByLocation[posId] = {
                    clients: [], orders: [], deliveries: [], transactions: []
                };
            }
            // Ajoute la commande avec le posId
            order.posId = posId;
            order.id = order.id || Date.now() + Math.random();
            this.db.posDataByLocation[posId].orders.push(order);
            this.save();
            return order;
        },

        /**
         * ISOLATION COMPLÈTE: Ajoute une livraison à un POS spécifique
         */
        addDeliveryToPOS(posId, delivery) {
            if (!posId || !delivery) return null;
            // Initialise la structure si elle n'existe pas
            if (!this.db.posDataByLocation) this.db.posDataByLocation = {};
            if (!this.db.posDataByLocation[posId]) {
                this.db.posDataByLocation[posId] = {
                    clients: [], orders: [], deliveries: [], transactions: []
                };
            }
            // Ajoute la livraison avec le posId
            delivery.posId = posId;
            delivery.id = delivery.id || Date.now() + Math.random();
            this.db.posDataByLocation[posId].deliveries.push(delivery);
            this.save();
            return delivery;
        },

        /**
         * ISOLATION COMPLÈTE: Ajoute une transaction à un POS spécifique
         */
        addTransactionToPOS(posId, transaction) {
            if (!posId || !transaction) return null;
            // Initialise la structure si elle n'existe pas
            if (!this.db.posDataByLocation) this.db.posDataByLocation = {};
            if (!this.db.posDataByLocation[posId]) {
                this.db.posDataByLocation[posId] = {
                    clients: [], orders: [], deliveries: [], transactions: []
                };
            }
            // Ajoute la transaction avec le posId
            transaction.posId = posId;
            transaction.id = transaction.id || Date.now() + Math.random();
            this.db.posDataByLocation[posId].transactions.push(transaction);
            this.save();
            return transaction;
        },

        /**
         * ISOLATION COMPLÈTE: Initialise les structures isolées pour un nouveau POS
         */
        initializePOSData(posId, options = {}) {
            if (!posId) return;
            if (!this.db.posDataByLocation) this.db.posDataByLocation = {};
            const forceReset = !!options.forceReset;
            if (forceReset || !this.db.posDataByLocation[posId]) {
                this.db.posDataByLocation[posId] = {
                    clients: [],
                    orders: [],
                    deliveries: [],
                    transactions: [],
                    notifications: [],
                    stockMovements: [],
                    notes: `Données isolées pour POS ${posId} créé le ${new Date().toLocaleDateString()}`
                };
            }
            this.save();
        },

        /**
         * ISOLATION COMPLÈTE: Diagnose et vérifie que chaque POS est complètement isolé
         * Retourne un rapport détaillé d'isolation
         */
        validatePOSIsolation() {
            const report = {
                timestamp: new Date().toISOString(),
                posCount: (this.db.pointsOfSale || []).length,
                isolationStatus: 'CHECKING',
                issues: [],
                summary: {}
            };

            const pos = this.db.pointsOfSale || [];

            pos.forEach(posRecord => {
                const posId = posRecord.id;

                // Vérifie que chaque POS a une structure isolée
                if (!this.db.posDataByLocation || !this.db.posDataByLocation[posId]) {
                    report.issues.push(`❌ POS ${posId} (${posRecord.name}) n'a pas de structure isolée`);
                } else {
                    report.issues.push(`✅ POS ${posId} (${posRecord.name}) structure isolée OK`);
                }

                // Compte les données isolées
                const posData = this.db.posDataByLocation?.[posId] || {};
                report.summary[`POS_${posId}`] = {
                    name: posRecord.name,
                    clients: (posData.clients || []).length,
                    orders: (posData.orders || []).length,
                    deliveries: (posData.deliveries || []).length,
                    transactions: (posData.transactions || []).length,
                    notifications: (posData.notifications || []).length,
                    stockMovements: (posData.stockMovements || []).length
                };

                // Vérifie qu'aucune donnée du POS n'est accessible en dehors de sa structure
                const orphanedOrders = (this.db.orders || []).filter(o => o.posId === posId &&
                    !(posData.orders || []).find(po => po.id === o.id));
                if (orphanedOrders.length > 0) {
                    report.issues.push(`⚠️ POS ${posId}: ${orphanedOrders.length} commande(s) orpheline(s)`);
                }
            });

            report.isolationStatus = report.issues.filter(i => i.includes('❌')).length === 0 ? 'FULLY_ISOLATED' : 'PARTIALLY_ISOLATED';
            report.issueCount = report.issues.filter(i => i.includes('❌')).length;

            console.log('🔐 ISOLATION REPORT:', report);
            return report;
        },

        /**
         * ISOLATION COMPLÈTE: Enforces isolation by moving all legacy data to isolated structures
         */
        enforceISOLATION() {
            console.log('🔒 Enforcement de l\'isolation complète...');

            // Initialise les structures isolées pour tous les POS
            const pos = this.db.pointsOfSale || [];
            pos.forEach(p => this.initializePOSData(p.id));

            // Migrate les commandes vers les structures isolées
            (this.db.orders || []).forEach(order => {
                if (order.posId && this.db.posDataByLocation && this.db.posDataByLocation[order.posId]) {
                    if (!this.db.posDataByLocation[order.posId].orders) {
                        this.db.posDataByLocation[order.posId].orders = [];
                    }
                    if (!this.db.posDataByLocation[order.posId].orders.find(o => o.id === order.id)) {
                        this.db.posDataByLocation[order.posId].orders.push({...order});
                    }
                }
            });

            // Migrate les livraisons vers les structures isolées
            (this.db.deliveries || []).forEach(delivery => {
                if (delivery.posId && this.db.posDataByLocation && this.db.posDataByLocation[delivery.posId]) {
                    if (!this.db.posDataByLocation[delivery.posId].deliveries) {
                        this.db.posDataByLocation[delivery.posId].deliveries = [];
                    }
                    if (!this.db.posDataByLocation[delivery.posId].deliveries.find(d => d.id === delivery.id)) {
                        this.db.posDataByLocation[delivery.posId].deliveries.push({...delivery});
                    }
                }
            });

            // Migrate les clients vers les structures isolées
            (this.db.clients || []).forEach(client => {
                if (client.posId && this.db.posDataByLocation && this.db.posDataByLocation[client.posId]) {
                    if (!this.db.posDataByLocation[client.posId].clients) {
                        this.db.posDataByLocation[client.posId].clients = [];
                    }
                    if (!this.db.posDataByLocation[client.posId].clients.find(c => c.id === client.id)) {
                        this.db.posDataByLocation[client.posId].clients.push({...client});
                    }
                }
            });

            this.save();
            const report = this.validatePOSIsolation();
            console.log('✅ Isolation forcée terminée:', report);
            return report;
        },

        // ========== KPI ET RAPPORTS PAR POS ==========

        /**
         * Calcule les KPIs d'un POS spécifique
         */
        getPOSKPIs(posId) {
            const orders = (this.db.orders || []).filter(o => o.posId == posId && o.status === 'delivered');
            const allOrders = (this.db.orders || []).filter(o => o.posId == posId);
            const deliveries = (this.db.deliveries || []).filter(d => d.posId == posId);
            const products = (this.db.products || []).filter(p => p.posId == posId);

            const totalRevenue = orders.reduce((sum, o) => sum + (o.total || 0), 0);
            const totalOrders = allOrders.length;
            const deliveredOrders = orders.length;
            const pendingOrders = allOrders.filter(o => o.status === 'pending').length;
            const deliveryRate = totalOrders > 0 ? Math.round((deliveredOrders / totalOrders) * 100) : 0;

            // Stock
            const lowStockProducts = products.filter(p => p.stock <= p.minStock).length;
            const totalStockValue = products.reduce((sum, p) => sum + (p.price * p.stock), 0);

            // Livraisons
            const avgDeliveryTime = deliveries.length > 0
                ? Math.round(deliveries.reduce((sum, d) => sum + (d.deliveryTime || 0), 0) / deliveries.length)
                : 0;

            // Revenue par jour
            const today = Utils.todayKey();
            const todayOrders = orders.filter(o => (o.createdAt || '').startsWith(today));
            const todayRevenue = todayOrders.reduce((sum, o) => sum + (o.total || 0), 0);

            return {
                posId,
                totalRevenue: Math.round(totalRevenue),
                totalOrders,
                deliveredOrders,
                pendingOrders,
                deliveryRate,
                lowStockProducts,
                totalStockValue: Math.round(totalStockValue),
                avgDeliveryTime,
                todayRevenue: Math.round(todayRevenue),
                todayOrders: todayOrders.length
            };
        },

        /**
         * Compare les KPIs de tous les POS
         */
        getAllPOSKPIs() {
            const posList = this.db.pointsOfSale || [];
            return posList.map(pos => this.getPOSKPIs(pos.id));
        },

        /**
         * Top vendeurs par POS
         */
        getTopVendorsByPOS(posId, limit = 5) {
            const vendors = (this.db.users || []).filter(u => u.role === 'vendeur' && u.pos == posId);

            return vendors.map(v => {
                const orders = (this.db.orders || []).filter(o => o.vendeurId === v.id && o.status === 'delivered');
                const totalRevenue = orders.reduce((sum, o) => sum + (o.total || 0), 0);
                const totalOrders = orders.length;
                const avgOrder = totalOrders > 0 ? Math.round(totalRevenue / totalOrders) : 0;

                return {
                    id: v.id,
                    name: v.name,
                    revenue: Math.round(totalRevenue),
                    orderCount: totalOrders,
                    avgOrder,
                    rating: v.rating || 0
                };
            }).sort((a, b) => b.revenue - a.revenue).slice(0, limit);
        },

        /**
         * Top livreurs par POS (par vitesse de livraison)
         */
        getTopDeliveryPersonnelByPOS(posId, limit = 5) {
            const livreurs = (this.db.users || []).filter(u => u.role === 'livreur' && u.pos == posId);

            return livreurs.map(l => {
                const deliveries = (this.db.deliveries || []).filter(d => d.livreurId === l.id && d.posId == posId);
                const completedDeliveries = deliveries.filter(d => d.status === 'livree');
                const avgTime = completedDeliveries.length > 0
                    ? Math.round(completedDeliveries.reduce((sum, d) => sum + (d.deliveryTime || 0), 0) / completedDeliveries.length)
                    : 0;
                const totalDistance = deliveries.reduce((sum, d) => sum + (d.distance || 0), 0);

                return {
                    id: l.id,
                    name: l.name,
                    deliveryCount: completedDeliveries.length,
                    avgDeliveryTime: avgTime,
                    totalDistance: Math.round(totalDistance),
                    vehicle: l.vehicle || 'N/A',
                    rating: l.rating || 0
                };
            }).sort((a, b) => a.avgDeliveryTime - b.avgDeliveryTime).slice(0, limit);
        },

        /**
         * Performance comparative: POS 1 vs POS 2 vs autres
         */
        getPOSPerformanceComparison() {
            const allKPIs = this.getAllPOSKPIs();

            if (allKPIs.length === 0) return null;

            // Trier par revenue
            const sorted = [...allKPIs].sort((a, b) => b.totalRevenue - a.totalRevenue);

            // Calculer les moyennes
            const avgRevenue = Math.round(allKPIs.reduce((sum, k) => sum + k.totalRevenue, 0) / allKPIs.length);
            const avgDeliveryRate = Math.round(allKPIs.reduce((sum, k) => sum + k.deliveryRate, 0) / allKPIs.length);

            return {
                allPOS: sorted,
                averages: {
                    revenue: avgRevenue,
                    deliveryRate: avgDeliveryRate
                },
                topPOS: sorted[0],
                bottomPOS: sorted[sorted.length - 1]
            };
        },

        // ========== ASSIGNATION INTELLIGENTE DES LIVREURS ==========

        /**
         * Récupère les livreurs disponibles d'un POS
         * @param {string} posId - ID du POS
         * @param {boolean} onlyAvailable - Si true, ne retourne que les livreurs libres
         */
        getAvailableLivreursByPOS(posId, onlyAvailable = true) {
            const livreurs = (this.db.users || []).filter(u => u.role === 'livreur' && u.pos === posId && u.active);

            // Inclure les livreurs indépendants approuvés et actifs du même POS
            const independentLivreurs = (this.db.independentDeliveryMen || [])
                .filter(dm => dm.posId == posId && dm.approvalStatus === 'approved' && dm.status === 'active')
                .map(dm => ({
                    id: dm.id,
                    name: dm.name + ' (Indépendant)',
                    phone: dm.phone || '',
                    vehicle: dm.vehicle || 'N/A',
                    pos: posId,
                    role: 'livreur',
                    active: true,
                    isIndependent: true,
                    rating: dm.rating || 0
                }));

            const allLivreurs = [...livreurs, ...independentLivreurs];

            if (!onlyAvailable) return allLivreurs;

            // Compter les livraisons en cours par livreur
            const activeDeliveries = (this.db.deliveries || []).filter(d =>
                d.posId === posId && ['en_cours', 'assigned'].includes(d.status)
            );

            const deliveryCount = {};
            activeDeliveries.forEach(d => {
                if (d.livreurId) {
                    deliveryCount[d.livreurId] = (deliveryCount[d.livreurId] || 0) + 1;
                }
            });

            // Retourner livreurs triés par nombre de livraisons (moins de livraisons = disponible)
            return allLivreurs
                .map(l => ({
                    ...l,
                    activeDeliveries: deliveryCount[l.id] || 0
                }))
                .sort((a, b) => a.activeDeliveries - b.activeDeliveries);
        },

        /**
         * Assigne automatiquement une livraison au livreur disponible
         * @param {string} posId - ID du POS
         * @param {string} deliveryId - ID de la livraison
         */
        autoAssignDelivery(posId, deliveryId) {
            const delivery = this.db.deliveries.find(d => d.id === deliveryId);
            if (!delivery) return null;

            // Vérifier que la livraison appartient à ce POS
            if (delivery.posId !== posId) {
                console.warn("Auto-assign: Delivery does not belong to this POS");
                return null;
            }

            // Récupérer les livreurs disponibles du même POS
            const availableLivreurs = this.getAvailableLivreursByPOS(posId, true);
            if (availableLivreurs.length === 0) {
                return null; // Pas de livreur disponible
            }

            // Assigner au livreur le moins occupé
            const selectedLivreur = availableLivreurs[0];
            delivery.livreurId = selectedLivreur.id;
            delivery.status = 'assigned';
            delivery.assignedAt = new Date().toISOString();

            this.logActivity('update', 'delivery', deliveryId, {
                entityName: `Livraison #${delivery.orderRef || deliveryId}`,
                description: `Auto-assignée à ${selectedLivreur.name}`,
                before: { livreurId: null, status: 'pending' },
                after: { livreurId: selectedLivreur.id, status: 'assigned' }
            });

            this.save();
            return { delivery, livreur: selectedLivreur };
        },

        /**
         * Assigne manuellement une livraison à un livreur (avec vérification POS)
         * @param {string} deliveryId - ID de la livraison
         * @param {string} livreurId - ID du livreur
         */
        assignDeliveryToLivreur(deliveryId, livreurId) {
            const delivery = this.db.deliveries.find(d => d.id === deliveryId);
            let livreur = this.db.users.find(u => u.id === livreurId && u.role === 'livreur');

            // Si pas trouvé dans les users, chercher dans les livreurs indépendants
            if (!livreur) {
                const indep = (this.db.independentDeliveryMen || []).find(dm => dm.id === livreurId && dm.approvalStatus === 'approved' && dm.status === 'active');
                if (indep) {
                    livreur = { id: indep.id, name: indep.name + ' (Indépendant)', phone: indep.phone, pos: indep.posId, role: 'livreur', isIndependent: true };
                }
            }

            if (!delivery || !livreur) return null;

            // Vérifier que le livreur appartient au même POS que la livraison
            if (livreur.pos != delivery.posId) {
                console.warn("Assignment: Livreur and Delivery not in same POS");
                return null;
            }

            const oldLivreurId = delivery.livreurId;
            delivery.livreurId = livreurId;
            delivery.status = 'assigned';
            delivery.assignedAt = new Date().toISOString();

            this.logActivity('update', 'delivery', deliveryId, {
                entityName: `Livraison #${delivery.orderRef || deliveryId}`,
                description: `Assignée manuellement à ${livreur.name}`,
                before: { livreurId: oldLivreurId },
                after: { livreurId: livreurId }
            });

            this.save();
            return { delivery, livreur };
        },

        /**
         * Obtient les livreurs non-assignés du même POS pour une livraison
         */
        getUnassignedLivreurs(posId) {
            return this.getAvailableLivreursByPOS(posId, false)
                .map(l => ({
                    id: l.id,
                    name: l.name,
                    vehicle: l.vehicle || 'N/A',
                    phone: l.phone || '',
                    rating: l.rating || 0,
                    isIndependent: l.isIndependent || false,
                    activeDeliveries: (this.db.deliveries || [])
                        .filter(d => d.livreurId === l.id && ['en_cours', 'assigned'].includes(d.status))
                        .length
                }));
        },

        /**
         * Récupère les statistiques de charge pour les livreurs d'un POS
         */
        getLivreurWorkloadStats(posId) {
            const livreurs = this.getAvailableLivreursByPOS(posId, false);
            const stats = [];

            livreurs.forEach(l => {
                const deliveries = (this.db.deliveries || []).filter(d => d.livreurId === l.id && d.posId === posId);
                const completedToday = deliveries.filter(d =>
                    d.status === 'livree' && (d.createdAt || '').startsWith(Utils.todayKey())
                ).length;
                const activeDeliveries = deliveries.filter(d =>
                    ['en_cours', 'assigned'].includes(d.status)
                ).length;

                stats.push({
                    livreurId: l.id,
                    livreurName: l.name,
                    vehicle: l.vehicle || 'N/A',
                    completedToday,
                    activeDeliveries,
                    totalDistance: deliveries.filter(d => d.status === 'livree').reduce((sum, d) => sum + (d.distance || 0), 0),
                    avgDeliveryTime: deliveries.length > 0
                        ? Math.round(deliveries.reduce((sum, d) => sum + (d.deliveryTime || 0), 0) / deliveries.length)
                        : 0,
                    rating: l.rating || 0
                });
            });

            return stats.sort((a, b) => a.activeDeliveries - b.activeDeliveries);
        },

        // ========== MOUVEMENTS DE STOCK AUDITÉS ==========

        /**
         * Enregistre un mouvement de stock avec audit complet
         * @param {object} movement - {type, productId, quantity, fromPosId, toPosId, notes, reason}
         */
        recordStockMovement(movement) {
            const product = this.getProduct(movement.productId);
            if (!product) return null;

            const user = this.state.currentUser;
            if (!user) return null;

            const fromPos = movement.fromPosId ? this.getPOS(movement.fromPosId) : null;
            const toPos = movement.toPosId ? this.getPOS(movement.toPosId) : null;

            // Déterminer les anciens et nouveaux stocks
            let oldStock = product.stock || 0;
            let newStock = oldStock;
            const status = movement.status || 'completed';
            const meta = movement.meta ? { ...movement.meta } : null;
            const direction = movement.direction || meta?.direction || null;
            const resolvedQty = movement.quantity ?? movement.qty ?? 0;
            const resolvedNote = movement.notes || movement.note || '';
            const resolvedRef = movement.document || movement.ref || null;
            const now = new Date().toISOString();
            const resolvedTimestamp = movement.timestamp || now;

            const movementRecord = {
                id: 'MOV-' + new Date().getTime(),
                type: movement.type || 'adjustment', // 'transfer', 'reception', 'adjustment', 'sale', 'return'
                productId: movement.productId,
                productName: product.name,
                productSku: product.barcode || 'N/A',
                // Store BOTH property names so all display functions work
                quantity: resolvedQty,
                qty: resolvedQty,
                posId: movement.posId !== undefined ? movement.posId : user.pos, // POS source
                fromPosId: movement.fromPosId || null, // Pour les transferts
                fromPosName: fromPos?.name || null,
                toPosId: movement.toPosId || null, // Pour les transferts
                toPosName: toPos?.name || null,
                userId: user.id,
                userName: user.name,
                userRole: user.role,
                // Store all date aliases
                timestamp: resolvedTimestamp,
                createdAt: now,
                date: now,
                notes: resolvedNote,
                note: resolvedNote,
                reason: movement.reason || '', // 'transfer_request', 'manual_adjustment', 'sale', 'return', 'restock'
                status: status, // 'completed', 'pending', 'cancelled'
                direction: direction,
                oldStock: oldStock,
                newStock: newStock,
                unitPrice: movement.unitPrice || product.price,
                totalValue: (movement.unitPrice || product.price || 0) * resolvedQty,
                document: resolvedRef, // référence à commande, retour, etc.
                ref: resolvedRef,
                meta: meta
            };

            this.db.stockMovements.push(movementRecord);

            // Log d'audit
            this.logActivity('create', 'stock_movement', movementRecord.id, {
                entityName: `Mouvement stock: ${product.name}`,
                description: `${movement.type}: ${resolvedQty} unités (${oldStock} → ${newStock})`,
                details: movementRecord
            });

            this.save();
            return movementRecord;
        },

        /**
         * Enregistre un transfert de stock entre deux POS
         * @param {string} fromPosId - POS source
         * @param {string} toPosId - POS destination
         * @param {string} productId - ID du produit
         * @param {number} quantity - Quantité transférée
         * @param {string} notes - Notes du transfert
         */
        recordTransfer(fromPosId, toPosId, productId, quantity, notes = '') {
            const product = this.getProduct(productId);
            if (!product) return null;

            const fromPos = this.getPOS(fromPosId);
            const toPos = this.getPOS(toPosId);
            if (!fromPos || !toPos) return null;

            const qty = Math.max(0, Number(quantity) || 0);
            if (qty <= 0) return null;

            // Initialize posStocks if not exists
            if (!product.posStocks) {
                product.posStocks = {};
            }

            if (!product.posStocks[fromPosId]) {
                product.posStocks[fromPosId] = {
                    stock: 0,
                    lastUpdated: new Date().toISOString()
                };
            }

            // Déduire le stock source immédiatement (réservation pour transfert)
            product.posStocks[fromPosId].stock -= qty;
            if (product.posStocks[fromPosId].stock < 0) {
                product.posStocks[fromPosId].stock = 0;
            }
            product.posStocks[fromPosId].lastUpdated = new Date().toISOString();

            // NE PAS ajouter au POS destination — le gestionnaire doit confirmer la réception

            // Créer le transfert en attente
            const transferId = 'TRF-' + Date.now().toString(36).toUpperCase();
            this.db.stockTransfers = this.db.stockTransfers || [];
            this.db.stockTransfers.push({
                id: transferId,
                productId: product._apiId || productId,
                productName: product.name,
                productSku: product.barcode || product.sku || null,
                productPrice: product.price || 0,
                productCategory: product.category || product.categoryId || null,
                qty: qty,
                sourcePosId: fromPosId,
                sourcePosName: fromPos.name,
                destPosId: toPosId,
                destPosName: toPos.name,
                reason: notes || 'Transfert inter-POS',
                status: 'pending',
                createdBy: this.state.currentUser?.id,
                createdByName: this.state.currentUser?.name || 'Système',
                createdAt: new Date().toISOString(),
                receivedAt: null,
                receivedBy: null,
                receivedByName: null
            });

            const movement = this.recordStockMovement({
                type: 'transfer',
                productId,
                quantity: qty,
                posId: fromPosId,
                fromPosId,
                toPosId,
                notes: (notes || '') + ' - Transfert en attente vers ' + toPos.name,
                ref: transferId,
                reason: 'transfer_request',
                meta: {
                    source: 'manager_transfer',
                    direction: 'out',
                    pairedPosId: toPosId
                }
            });

            // Notification pour le POS destinataire
            this.db.notifications = this.db.notifications || [];
            this.db.notifications.push({
                id: 'NOTIF-' + this.uid(),
                type: 'transfer_incoming',
                title: '📦 Transfert entrant',
                message: qty + ' x ' + product.name + ' en provenance de ' + fromPos.name,
                transferId: transferId,
                posId: toPosId,
                createdAt: new Date().toISOString(),
                read: false
            });

            this.markDirty('products');
            this.markDirty('stockMovements');
            this.markDirty('stockTransfers');
            this.markDirty('notifications');
            return movement;
        },

        createTransferReceipt(data = {}) {
            const now = new Date().toISOString();
            if (!this.db.transferReceipts) this.db.transferReceipts = [];

            const product = data.productId ? this.getProduct(data.productId) : null;
            const receipt = {
                id: Utils.uid('RCPT'),
                reference: data.reference || null,
                productId: data.productId,
                productName: data.productName || product?.name || 'Produit',
                productSku: data.productSku || product?.barcode || 'N/A',
                quantity: Math.max(0, Number(data.quantity) || 0),
                fromPosId: data.fromPosId ?? null,
                fromPosName: data.fromPosName || null,
                toPosId: data.toPosId ?? null,
                toPosName: data.toPosName || null,
                note: data.note || '',
                attachments: Array.isArray(data.attachments) ? data.attachments.map(a => ({ ...a })) : [],
                trackingNumber: data.trackingNumber || '',
                estimatedArrivalAt: data.estimatedArrivalAt || null,
                recommended: data.recommended ?? null,
                status: 'pending',
                createdAt: data.createdAt || now,
                updatedAt: now,
                requestedById: data.requestedById || this.state.currentUser?.id || null,
                requestedByName: data.requestedByName || this.state.currentUser?.name || null,
                createdByName: data.createdByName || this.state.currentUser?.name || null,
                productPrice: data.productPrice || product?.price || 0,
                productCategory: data.productCategory || product?.category || null,
                meta: { status: 'pending', ...(data.meta || {}) }
            };

            this.db.transferReceipts.push(receipt);

            if (product && receipt.toPosId !== null && receipt.toPosId !== undefined) {
                if (!product.posStocks) product.posStocks = {};
                if (!product.posStocks[receipt.toPosId]) {
                    product.posStocks[receipt.toPosId] = {
                        stock: 0,
                        price: product.price || 0,
                        lastUpdated: now,
                        pendingIncoming: 0
                    };
                }

                const entry = product.posStocks[receipt.toPosId];
                const currentPending = Number(entry.pendingIncoming || 0);
                entry.pendingIncoming = Math.max(0, currentPending + receipt.quantity);
                entry.lastUpdated = now;
            }

            this.logActivity('create', 'transfer_receipt', receipt.id, {
                entityName: `Transfert vers ${receipt.toPosName || receipt.toPosId || 'POS'}`,
                description: `${receipt.quantity} unité(s) de ${receipt.productName}`,
                details: receipt,
                status: 'pending'
            });

            this.markDirty('transferReceipts');
            this.markDirty('products');
            this.save();
            return receipt;
        },

        getTransferReceipt(receiptId) {
            return (this.db.transferReceipts || []).find(r => r.id === receiptId) || null;
        },

        getTransferReceipts(filters = {}) {
            const receipts = this.db.transferReceipts || [];
            return receipts
                .filter(r => {
                    if (filters.posId !== undefined && filters.posId !== null) {
                        if (Number(r.toPosId) !== Number(filters.posId)) return false;
                    }
                    if (filters.status) {
                        const statuses = Array.isArray(filters.status) ? filters.status : [filters.status];
                        if (!statuses.includes(r.status)) return false;
                    }
                    return true;
                })
                .sort((a, b) => new Date(b.createdAt || b.updatedAt || 0) - new Date(a.createdAt || a.updatedAt || 0));
        },

        approveTransferReceipt(receiptId, note = '', attachments = null) {
            const receipt = this.getTransferReceipt(receiptId);
            if (!receipt) return { success: false, message: 'Transfert introuvable.' };
            if (receipt.status !== 'pending') return { success: false, message: 'Transfert déjà traité.' };

            const product = this.getProduct(receipt.productId);
            if (!product) return { success: false, message: 'Produit introuvable.' };

            const now = new Date().toISOString();
            receipt.status = 'accepted';
            receipt.updatedAt = now;
            receipt.receivedAt = now;
            receipt.receivedById = this.state.currentUser?.id || null;
            receipt.receivedByName = this.state.currentUser?.name || null;
            if (note) receipt.receivedNote = note;
            if (attachments && Array.isArray(attachments) && attachments.length > 0) {
                receipt.attachments = (receipt.attachments || []).concat(attachments);
            }

            if (!product.posStocks) product.posStocks = {};
            if (!product.posStocks[receipt.toPosId]) {
                product.posStocks[receipt.toPosId] = { stock: 0, lastUpdated: now };
            }
            const entry = product.posStocks[receipt.toPosId];
            const previousStock = Number(entry.stock) || 0;
            const pendingBefore = Number(entry.pendingIncoming || 0);
            entry.stock = previousStock + receipt.quantity;
            entry.lastUpdated = now;
            entry.pendingIncoming = Math.max(0, pendingBefore - receipt.quantity);

            (this.db.stockMovements || []).forEach(m => {
                if (m.meta?.receiptId === receiptId) {
                    m.status = 'completed';
                    const meta = { ...(m.meta || {}) };
                    meta.status = 'accepted';
                    meta.acknowledgedAt = now;
                    meta.acknowledgedBy = receipt.receivedByName || null;
                    if (note) meta.receivedNote = note;
                    m.meta = meta;
                    if (m.direction === 'in' || m.meta?.direction === 'in') {
                        m.oldStock = previousStock;
                        m.newStock = product.posStocks[receipt.toPosId].stock;
                    }
                }
            });

            receipt.meta = { ...(receipt.meta || {}), status: 'accepted' };

            this.logActivity('update', 'transfer_receipt', receipt.id, {
                entityName: `Réception ${receipt.reference || receipt.id}`,
                description: `Réception confirmée (${receipt.quantity} ${receipt.productName})`,
                details: receipt,
                status: 'accepted'
            });

            this.markDirty('transferReceipts');
            this.markDirty('products');
            this.markDirty('stockMovements');
            this.save();
            return { success: true, receipt };
        },

        rejectTransferReceipt(receiptId, reason = '') {
            const receipt = this.getTransferReceipt(receiptId);
            if (!receipt) return { success: false, message: 'Transfert introuvable.' };
            if (receipt.status !== 'pending') return { success: false, message: 'Transfert déjà traité.' };

            const product = this.getProduct(receipt.productId);
            const now = new Date().toISOString();

            receipt.status = 'rejected';
            receipt.updatedAt = now;
            receipt.rejectedAt = now;
            receipt.rejectedById = this.state.currentUser?.id || null;
            receipt.rejectedByName = this.state.currentUser?.name || null;
            receipt.rejectedReason = reason || '';

            if (product) {
                // BUG FIX: Retourner le stock au POS source (fromPosId) au lieu du stock global
                if (!product.posStocks) product.posStocks = {};
                const fromPosId = receipt.fromPosId;
                if (fromPosId) {
                    if (!product.posStocks[fromPosId]) {
                        product.posStocks[fromPosId] = { stock: 0, lastUpdated: now };
                    }
                    product.posStocks[fromPosId].stock = (Number(product.posStocks[fromPosId].stock) || 0) + receipt.quantity;
                    product.posStocks[fromPosId].lastUpdated = now;
                } else {
                    // Fallback: si pas de fromPosId, ajouter au stock global
                    product.stock = (Number(product.stock) || 0) + receipt.quantity;
                }
                // Réduire le pendingIncoming du POS destinataire
                if (receipt.toPosId !== null && receipt.toPosId !== undefined && product.posStocks[receipt.toPosId]) {
                    const entry = product.posStocks[receipt.toPosId];
                    const currentPending = Number(entry.pendingIncoming || 0);
                    entry.pendingIncoming = Math.max(0, currentPending - receipt.quantity);
                    entry.lastUpdated = now;
                }
            }

            (this.db.stockMovements || []).forEach(m => {
                if (m.meta?.receiptId === receiptId) {
                    m.status = 'cancelled';
                    const meta = { ...(m.meta || {}) };
                    meta.status = 'rejected';
                    meta.acknowledgedAt = now;
                    meta.rejectionReason = reason || '';
                    meta.acknowledgedBy = receipt.rejectedByName || null;
                    m.meta = meta;
                }
            });

            receipt.meta = { ...(receipt.meta || {}), status: 'rejected' };

            this.logActivity('update', 'transfer_receipt', receipt.id, {
                entityName: `Réception ${receipt.reference || receipt.id}`,
                description: `Réception rejetée (${receipt.quantity} ${receipt.productName})`,
                details: { ...receipt, reason },
                status: 'rejected'
            });

            this.markDirty('transferReceipts');
            this.markDirty('products');
            this.markDirty('stockMovements');
            this.save();
            return { success: true, receipt };
        },

        getMovementHistory(filters = {}) {
                const user = this.state.currentUser;
                const movementsSource = this.db.stockMovements || [];

                const movementsEnriched = movementsSource.map(m => {
                    const product = this.getProduct(m.productId) || {};
                    const quantity = Number(m.quantity ?? m.qty ?? 0);
                    const unitPrice = Number(m.totalValue && quantity ? m.totalValue / quantity : (m.meta?.unitPrice ?? product.price ?? 0));
                    const timestamp = m.timestamp || m.createdAt || new Date(m.id || Date.now()).toISOString();
                    const direction = m.meta?.direction || m.direction || (m.type === 'transfer'
                        ? (m.fromPosId ? 'out' : (m.toPosId ? 'in' : null))
                        : (m.type === 'out' ? 'out' : (m.type === 'in' ? 'in' : null)));

                    const fromPosName = m.fromPosName
                        || m.meta?.originName
                        || (m.fromPosId !== null && m.fromPosId !== undefined
                            ? (this.getPOS(m.fromPosId)?.name || `POS ${m.fromPosId}`)
                            : (m.meta?.source === 'manager_transfer' ? 'Dépôt principal' : null));

                    const toPosName = m.toPosName
                        || m.meta?.destinationName
                        || (m.toPosId !== null && m.toPosId !== undefined
                            ? (this.getPOS(m.toPosId)?.name || `POS ${m.toPosId}`)
                            : null);

                    return {
                        ...m,
                        qty: quantity,
                        quantity,
                        productName: m.productName || product.name || '—',
                        totalValue: Number(m.totalValue ?? (quantity * unitPrice)),
                        unitPrice,
                        timestamp,
                        direction,
                        fromPosName,
                        toPosName,
                        type: m.type || m.meta?.type || 'adjust'
                    };
                });

                let movements = movementsEnriched;

                if (user && (user.role === 'gestionnaire' || user.role === 'vendeur')) {
                    const userPos = user.pos;
                    movements = movements.filter(m => {
                        const related = [m.posId, m.fromPosId, m.toPosId].filter(v => v !== null && v !== undefined);
                        if (related.length === 0) return true;
                        return related.map(Number).includes(Number(userPos));
                    });
                }

                if (filters.posId) {
                    const targetPos = Number(filters.posId);
                    movements = movements.filter(m => {
                        const related = [m.posId, m.fromPosId, m.toPosId]
                            .filter(v => v !== null && v !== undefined)
                            .map(Number);
                        return related.includes(targetPos);
                    });
                }

                if (filters.productId) {
                    movements = movements.filter(m => Number(m.productId) === Number(filters.productId));
                }

                if (filters.type) {
                    const typeList = Array.isArray(filters.type) ? filters.type : [filters.type];
                    movements = movements.filter(m => typeList.includes(m.type));
                }

                if (filters.direction) {
                    const directionList = Array.isArray(filters.direction) ? filters.direction : [filters.direction];
                    movements = movements.filter(m => m.direction && directionList.includes(m.direction));
                }

                if (filters.userId) {
                    movements = movements.filter(m => m.userId === filters.userId);
                }

                if (filters.search) {
                    const needle = filters.search.toLowerCase();
                    movements = movements.filter(m => {
                        return [m.productName, m.note, m.ref, m.userName]
                            .filter(Boolean)
                            .some(field => String(field).toLowerCase().includes(needle));
                    });
                }

                if (filters.startDate && filters.endDate) {
                    const start = new Date(filters.startDate);
                    const end = new Date(filters.endDate);
                    movements = movements.filter(m => {
                        const movDate = new Date(m.timestamp || m.createdAt);
                        return movDate >= start && movDate <= end;
                    });
                }

                return movements.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            },

        /**
         * Récupère l'historique des mouvements pour un produit
         */
        getProductMovementHistory(productId, posId = null) {
            const user = this.state.currentUser;
            if (!user) return [];

            let movements = (this.db.stockMovements || []).filter(m => m.productId === productId);

            // Appliquer les permissions
            if (user.role === 'gestionnaire' || user.role === 'vendeur') {
                if (posId && posId !== user.pos) return []; // Pas d'accès
                movements = movements.filter(m => m.posId === user.pos);
            }

            return movements.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        },

        /**
         * Génère un résumé des mouvements pour un POS et une période
         */
        getStockMovementSummary(posId, startDate, endDate) {
            const movements = this.getMovementHistory({ posId, startDate, endDate });

            const summary = {
                totalMovements: movements.length,
                byType: {},
                byProduct: {},
                byUser: {},
                totalValue: 0,
                transfers: {
                    sent: movements.filter(m => m.type === 'transfer' && m.fromPosId === posId).length,
                    received: movements.filter(m => m.type === 'transfer' && m.toPosId === posId).length
                }
            };

            movements.forEach(m => {
                // Par type
                summary.byType[m.type] = (summary.byType[m.type] || 0) + 1;

                // Par produit
                if (!summary.byProduct[m.productName]) {
                    summary.byProduct[m.productName] = { qty: 0, value: 0, movements: 0 };
                }
                summary.byProduct[m.productName].qty += m.quantity;
                summary.byProduct[m.productName].value += m.totalValue;
                summary.byProduct[m.productName].movements += 1;

                // Par utilisateur
                if (!summary.byUser[m.userName]) {
                    summary.byUser[m.userName] = { count: 0, role: m.userRole };
                }
                summary.byUser[m.userName].count += 1;

                summary.totalValue += m.totalValue;
            });

            return summary;
        },

        // Gestion améliorée des variantes
        createProductVariant(productId, attributes, sku, price, stock, weight = null, temperature = null) {
            const product = this.getProduct(productId);
            if (!product) return null;

            const variant = {
                id: 'VAR-' + new Date().getTime(),
                productId: productId,
                attributes: attributes, // [{name, value}, ...]
                sku: sku,
                price: price || product.price,
                stock: stock || 0,
                weight: weight,
                temperature: temperature,
                barcode: null,
                active: true,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                notes: ''
            };

            this.db.productVariants.push(variant);
            this.logActivity('create', 'product_variant', variant.id, {
                entityName: `Variante de ${product.name}`,
                description: attributes.map(a => a.name + ': ' + a.value).join(', ')
            });
            this.markDirty('productVariants');
            this.save();
            return variant;
        },

        updateProductVariant(variantId, updates) {
            const variant = this.db.productVariants.find(v => v.id === variantId && !v._deleted);
            if (!variant) return null;

            const before = { ...variant };
            Object.assign(variant, updates);
            variant.updatedAt = new Date().toISOString();

            this.logActivity('update', 'product_variant', variantId, {
                entityName: `Variante`,
                description: `Mise à jour variante`,
                before, after: variant
            });
            this.markDirty('productVariants');
            this.save();
            return variant;
        },

        deleteProductVariant(variantId) {
            const variant = this.db.productVariants.find(v => v.id === variantId);
            if (!variant) return false;

            variant._deleted = true;
            variant.updatedAt = new Date().toISOString();
            this.logActivity('delete', 'product_variant', variantId, {
                entityName: `Variante`,
                description: `Variante supprimée`
            });
            this.markDirty('productVariants');
            this.save();
            return true;
        },

        getVariantDescription(variant) {
            return variant.attributes.map(a => a.name + ': ' + a.value).join(' • ');
        },

        getVariantStockStatus(variant) {
            if (variant.stock <= 0) return { status: 'rupture', label: 'Rupture', color: 'red' };
            if (variant.stock <= 5) return { status: 'critique', label: 'Critique', color: 'orange' };
            if (variant.stock <= 20) return { status: 'faible', label: 'Faible', color: 'amber' };
            return { status: 'ok', label: 'OK', color: 'emerald' };
        },

        getProductWithVariants(productId) {
            const product = this.getProduct(productId);
            if (!product) return null;

            return {
                ...product,
                variants: this.getProductVariants(productId)
            };
        },

        searchVariants(productId, searchTerm = '') {
            const variants = this.getProductVariants(productId);
            if (!searchTerm) return variants;

            const term = searchTerm.toLowerCase();
            return variants.filter(v =>
                v.sku.toLowerCase().includes(term) ||
                v.attributes.some(a => a.value.toLowerCase().includes(term))
            );
        },

        getVariantsBySKU(sku) {
            return this.db.productVariants.find(v => v.sku === sku);
        },

        // Image Management
        uploadProductImage(productId, base64Data, filename, alt = '') {
            const product = this.getProduct(productId);
            if (!product) return null;

            const filesize = Math.round((base64Data.length * 3) / 4);
            const existingImages = this.db.productImages.filter(img => img.productId === productId);
            const isPrimary = existingImages.length === 0;

            const image = {
                id: 'img_' + new Date().getTime(),
                productId: productId,
                productName: product.name,
                url: base64Data,
                filename: filename || `image_${Date.now()}`,
                filesize: filesize,
                uploadedAt: new Date().toISOString(),
                uploadedBy: this.state.currentUser?.id,
                uploadedByName: this.state.currentUser?.name,
                isPrimary: isPrimary,
                alt: alt,
                tags: [],
                order: existingImages.length
            };

            this.db.productImages.push(image);

            // Si c'est la première image et que le produit n'a pas d'image, la définir comme principale
            if (isPrimary && !product.image) {
                this.update('products', productId, { image: base64Data });
            }

            this.save();
            return image;
        },

        getProductImages(productId) {
            const images = this.db.productImages.filter(img => img.productId === productId);
            return images.sort((a, b) => (a.order || 0) - (b.order || 0));
        },

        getPrimaryProductImage(productId) {
            return this.db.productImages.find(img => img.productId === productId && img.isPrimary);
        },

        setPrimaryImage(imageId) {
            const image = this.db.productImages.find(img => img.id === imageId);
            if (!image) return false;

            // Unset previous primary
            this.db.productImages.forEach(img => {
                if (img.productId === image.productId && img.isPrimary) {
                    img.isPrimary = false;
                }
            });

            image.isPrimary = true;
            this.save();
            return true;
        },

        deleteProductImage(imageId) {
            const index = this.db.productImages.findIndex(img => img.id === imageId);
            if (index === -1) return false;

            const deleted = this.db.productImages[index];
            this.db.productImages.splice(index, 1);

            // If deleted was primary, set new primary
            const remaining = this.db.productImages.filter(img => img.productId === deleted.productId);
            if (remaining.length > 0 && !remaining.some(img => img.isPrimary)) {
                remaining[0].isPrimary = true;
            }

            // Re-order remaining images
            remaining.forEach((img, idx) => {
                img.order = idx;
            });

            this.save();
            return true;
        },

        reorderProductImages(productId, imageIds) {
            const images = this.db.productImages.filter(img => img.productId === productId);
            imageIds.forEach((id, idx) => {
                const img = images.find(i => i.id === id);
                if (img) img.order = idx;
            });
            this.save();
        },

        updateImageMetadata(imageId, alt, tags) {
            const image = this.db.productImages.find(img => img.id === imageId);
            if (!image) return false;
            image.alt = alt;
            image.tags = tags;
            this.save();
            return true;
        },

        // Independent Delivery Men Management
        createIndependentDeliveryMan(name, phone, vendeurId, notes = '') {
            const vendor = this.getUser(vendeurId);
            if (!vendor) return null;

            const settings = this.getGestionnaireSettings();
            const approvalStatus = settings.independentDeliveryMenApprovalRequired ? 'pending' : 'approved';

            const deliveryMan = {
                id: 'idm_' + new Date().getTime(),
                name: name,
                phone: phone,
                vendeurId: vendeurId,
                vendeurName: vendor.name,
                posId: vendor.pos || vendor.storeId || null,
                createdAt: new Date().toISOString(),
                approvalStatus: approvalStatus,
                status: 'active',
                deliveryCount: 0,
                totalEarnings: 0,
                notes: notes
            };

            this.db.independentDeliveryMen.push(deliveryMan);
            this.markDirty('independentDeliveryMen');
            this.save();
            return deliveryMan;
        },

        getIndependentDeliveryMen(vendeurId = null) {
            let men = this.db.independentDeliveryMen || [];
            if (vendeurId) {
                men = men.filter(m => String(m.vendeurId) == String(vendeurId) && m.approvalStatus === 'approved');
            }
            return men;
        },

        // Récupérer un template de bon de livraison existant
        getDeliveryTicketTemplate(vendeurId, type) {
            this.db.deliveryTicketTemplates = this.db.deliveryTicketTemplates || [];
            return this.db.deliveryTicketTemplates.find(t => t.vendeurId === vendeurId && t.name === type);
        },

        // Récupérer ou créer un template par défaut
        getOrCreateDefaultTemplate(vendeurId, type) {
            this.db.deliveryTicketTemplates = this.db.deliveryTicketTemplates || [];
            let template = this.db.deliveryTicketTemplates.find(t => t.vendeurId === vendeurId && t.name === type);

            if (!template) {
                // Créer un template par défaut
                const smsDefault = '📦 Commande {orderRef}\nClient: {clientName}\n📍 {address}\n📱 {clientPhone}\n💰 Montant: {amount}\n🚚 À collecter: {collectedAmount}\n\nProduits:\n{items}\n\n⏰ Livraison prévue: {deliveryTime}';

                const directDefault = '============================\n       BON DE LIVRAISON\n============================\nRéf: {orderRef}\nDate: ' + new Date().toLocaleDateString('fr-FR') + '\n\nClient: {clientName}\nAdresse: {address}\nTél: {clientPhone}\n\n----------------------------\nPRODUITS:\n{items}\n----------------------------\n\nTotal: {amount}\nÀ collecter: {collectedAmount}\n\nHeure de livraison: {deliveryTime}\n============================';

                const defaultContent = type === 'SMS' ? smsDefault : directDefault;

                template = {
                    id: CORE.uid(),
                    vendeurId: vendeurId,
                    vendeurName: this.getUser(vendeurId)?.name || 'Vendeur',
                    name: type,
                    content: defaultContent,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                this.db.deliveryTicketTemplates.push(template);
                this.save();
            }

            return template;
        },

        updateDeliveryTicketTemplate(vendeurId, type, content) {
            let template = this.getDeliveryTicketTemplate(vendeurId, type);

            if (template) {
                template.content = content;
                template.updatedAt = new Date().toISOString();
                this.save();
                return template;
            }

            // Si le template n'existe pas, le créer
            template = this.getOrCreateDefaultTemplate(vendeurId, type);
            template.content = content;
            template.updatedAt = new Date().toISOString();
            this.save();
            return template;
        },

        // Récupérer les paramètres de reçu d'un vendeur
        getReceiptSettings(vendeurId) {
            this.db.receiptSettings = this.db.receiptSettings || {};
            return this.db.receiptSettings[vendeurId] || {
                companyName: '',
                subtitle: 'Reçu de Livraison',
                phone: '',
                address: '',
                showLogo: true,
                showItems: true,
                showSignature: true,
                showCommission: false,
                showProofPhotos: false,
                thankMessage: 'Merci pour votre confiance!',
                footerNote: ''
            };
        },

        // Sauvegarder les paramètres de reçu d'un vendeur
        saveReceiptSettings(vendeurId, settings) {
            this.db.receiptSettings = this.db.receiptSettings || {};
            this.db.receiptSettings[vendeurId] = {
                ...settings,
                updatedAt: new Date().toISOString()
            };
            this.save();
            return this.db.receiptSettings[vendeurId];
        },

        // Récupérer les paramètres de validation de livraison par POS
        getDeliveryValidationSettings(posId) {
            this.db.deliveryValidationSettings = this.db.deliveryValidationSettings || {};
            return this.db.deliveryValidationSettings[posId] || {
                requirePhoto: true,
                requireSignature: false,
                minPhotos: 1,
                maxPhotos: 5,
                requireBoth: false // Si true, exige photo ET signature
            };
        },

        // Sauvegarder les paramètres de validation de livraison par POS
        saveDeliveryValidationSettings(posId, settings) {
            this.db.deliveryValidationSettings = this.db.deliveryValidationSettings || {};
            this.db.deliveryValidationSettings[posId] = {
                ...settings,
                updatedAt: new Date().toISOString()
            };
            this.save();
            return this.db.deliveryValidationSettings[posId];
        },

        // Vérifier si une livraison peut être validée selon les paramètres
        canValidateDelivery(deliveryId, photos, signature) {
            const d = this.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return { valid: false, message: 'Livraison non trouvée' };

            // Récupérer le POS de la livraison
            const posId = d.posId || d.vendeurId;
            const settings = this.getDeliveryValidationSettings(posId);

            const hasPhotos = photos && photos.length > 0;
            const hasEnoughPhotos = photos && photos.length >= (settings.minPhotos || 1);
            const hasSignature = !!signature;

            // Si les deux sont désactivés, permettre la validation
            if (!settings.requirePhoto && !settings.requireSignature) {
                return { valid: true };
            }

            // Si les deux sont requis
            if (settings.requireBoth) {
                if (!hasEnoughPhotos) {
                    return { valid: false, message: `Veuillez ajouter au moins ${settings.minPhotos || 1} photo(s)` };
                }
                if (!hasSignature) {
                    return { valid: false, message: 'La signature du client est requise' };
                }
                return { valid: true };
            }

            // Si photo requise uniquement
            if (settings.requirePhoto && !settings.requireSignature) {
                if (!hasEnoughPhotos) {
                    return { valid: false, message: `Veuillez ajouter au moins ${settings.minPhotos || 1} photo(s)` };
                }
                return { valid: true };
            }

            // Si signature requise uniquement
            if (settings.requireSignature && !settings.requirePhoto) {
                if (!hasSignature) {
                    return { valid: false, message: 'La signature du client est requise' };
                }
                return { valid: true };
            }

            // Si l'un ou l'autre (photo OU signature)
            if (settings.requirePhoto || settings.requireSignature) {
                if (!hasPhotos && !hasSignature) {
                    return { valid: false, message: 'Veuillez ajouter une photo OU la signature du client' };
                }
                return { valid: true };
            }

            return { valid: true };
        },

        renderDeliveryTicket(vendeurId, type, delivery, order) {
            const template = this.getOrCreateDefaultTemplate(vendeurId, type);
            if (!template) return '';

            let content = template.content;

            // Remplacer les variables
            const replacements = {
                '{orderRef}': delivery?.orderRef || '',
                '{clientName}': delivery?.clientName || '',
                '{address}': delivery?.address || '',
                '{clientPhone}': delivery?.clientPhone || '',
                '{amount}': this.formatPrice(order?.total || 0),
                '{collectedAmount}': this.formatPrice(delivery?.amount || 0)
            };

            Object.entries(replacements).forEach(([key, value]) => {
                content = content.replace(new RegExp(key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), value);
            });

            return content;
        },

        approveIndependentDeliveryMan(deliveryManId) {
            const deliveryMan = this.db.independentDeliveryMen.find(dm => dm.id == deliveryManId);
            if (deliveryMan) {
                deliveryMan.approvalStatus = 'approved';
                deliveryMan.approvedAt = new Date().toISOString();
                deliveryMan.updatedAt = new Date().toISOString();
                this.markDirty('independentDeliveryMen');
                this.save();
                return true;
            }
            return false;
        },

        rejectIndependentDeliveryMan(deliveryManId, reason = '') {
            const index = this.db.independentDeliveryMen.findIndex(dm => dm.id == deliveryManId);
            if (index !== -1) {
                const deliveryMan = this.db.independentDeliveryMen[index];
                deliveryMan.approvalStatus = 'rejected';
                deliveryMan.rejectionReason = reason;
                deliveryMan.rejectedAt = new Date().toISOString();
                deliveryMan.updatedAt = new Date().toISOString();
                this.markDirty('independentDeliveryMen');
                this.save();
                return true;
            }
            return false;
        },

        getPendingDeliveryMen(posId) {
            const men = (this.db.independentDeliveryMen || []).filter(dm => dm.approvalStatus === 'pending');
            if (posId != null) return men.filter(dm => String(dm.posId) == String(posId));
            return men;
        },

        getApprovedDeliveryMen(vendeurId) {
            return (this.db.independentDeliveryMen || []).filter(dm => String(dm.vendeurId) == String(vendeurId) && dm.approvalStatus === 'approved');
        },

        // Gestionnaire Settings — stored in CORE.db for cloud sync
        getGestionnaireSettings() {
            const defaults = {
                independentDeliveryMenApprovalRequired: true,
                slaRetardBasse: 480,
                slaRetardMoyenne: 240,
                slaRetardHaute: 120,
                slaAnnulBasse: 240,
                slaAnnulMoyenne: 120,
                slaAnnulHaute: 60,
                slaLitigeBasse: 1440,
                slaLitigeMoyenne: 480,
                slaLitigeHaute: 240,
                deliveryPhotoValidationEnabled: true,
                deliveryPhotoSignatureEnabled: false,
                deliveryPhotoGPSEnabled: false,
                deliveryRatingEnabled: true
            };

            // Migrate from old plain localStorage if exists
            const legacy = localStorage.getItem('gestionnaire_settings');
            if (legacy) {
                try {
                    const parsed = JSON.parse(legacy);
                    this.db.gestionnaireSettings = { ...defaults, ...parsed };
                    this.markDirty('gestionnaireSettings');
                    this.save();
                } catch(e) { console.warn('[MIGRATION] gestionnaire settings migration failed:', e); }
                localStorage.removeItem('gestionnaire_settings');
            }

            if (this.db.gestionnaireSettings && typeof this.db.gestionnaireSettings === 'object') {
                return { ...defaults, ...this.db.gestionnaireSettings };
            }
            return defaults;
        },

        setGestionnaireSettings(settings) {
            const current = this.getGestionnaireSettings();
            this.db.gestionnaireSettings = { ...current, ...settings };
            this.markDirty('gestionnaireSettings');
            this.save();
            return this.db.gestionnaireSettings;
        },

        // Système de paramètres globaux
        getSystemSetting(key, defaultValue = null) {
            try {
                const settings = JSON.parse(localStorage.getItem('system_settings') || '{}');
                return settings.hasOwnProperty(key) ? settings[key] : defaultValue;
            } catch (e) {
                return defaultValue;
            }
        },

        setSystemSetting(key, value) {
            try {
                const settings = JSON.parse(localStorage.getItem('system_settings') || '{}');
                settings[key] = value;
                localStorage.setItem('system_settings', JSON.stringify(settings));
                return true;
            } catch (e) {
                return false;
            }
        },

        // Role & Permission Management
        createCustomRole(name, baseRole, permissions = {}) {
            const roles = this.getCustomRoles();
            const role = {
                id: 'role_' + new Date().getTime(),
                name,
                baseRole, // 'gestionnaire', 'superviseur_vendeurs', 'responsable_livraison'
                permissions: {
                    dashboard: permissions.dashboard !== false,
                    stocks: permissions.stocks !== false,
                    deliveries: permissions.deliveries !== false,
                    team: permissions.team !== false,
                    planning: permissions.planning !== false,
                    reports: permissions.reports !== false,
                    reconciliation: permissions.reconciliation !== false,
                    auditlog: permissions.auditlog !== false,
                    incidents: permissions.incidents !== false,
                    settings: permissions.settings || false,
                    createUsers: permissions.createUsers || false,
                    editUsers: permissions.editUsers || false,
                    deleteUsers: permissions.deleteUsers || false,
                    manageRoles: permissions.manageRoles || false,
                    viewFinances: permissions.viewFinances || false,
                    exportReports: permissions.exportReports || false,
                    approveOrders: permissions.approveOrders || false,
                    resolveIncidents: permissions.resolveIncidents || false
                },
                createdAt: new Date().toISOString(),
                createdBy: this.state.currentUser?.id
            };
            roles.push(role);
            localStorage.setItem('custom_roles', JSON.stringify(roles));
            return role;
        },

        getCustomRoles() {
            const raw = localStorage.getItem('custom_roles');
            return raw ? JSON.parse(raw) : [];
        },

        updateCustomRole(roleId, updates) {
            const roles = this.getCustomRoles();
            const idx = roles.findIndex(r => r.id === roleId);
            if (idx === -1) return null;
            roles[idx] = { ...roles[idx], ...updates };
            localStorage.setItem('custom_roles', JSON.stringify(roles));
            return roles[idx];
        },

        deleteCustomRole(roleId) {
            const roles = this.getCustomRoles();
            const idx = roles.findIndex(r => r.id === roleId);
            if (idx === -1) return false;
            roles.splice(idx, 1);
            localStorage.setItem('custom_roles', JSON.stringify(roles));
            return true;
        },

        assignRoleToUser(userId, roleId) {
            const user = this.getUser(userId);
            if (!user) return false;
            user.customRole = roleId;
            this.update('users', userId, { customRole: roleId });
            return true;
        },

        hasPermission(userId, permissionKey) {
            const user = this.getUser(userId);
            if (!user) return false;

            // Les gestionnaires ont toutes les permissions
            if (user.role === 'gestionnaire') return true;

            // Vérifier les permissions personnalisées si rôle assigné
            if (user.customRole) {
                const roles = this.getCustomRoles();
                const customRole = roles.find(r => r.id === user.customRole);
                if (customRole && customRole.permissions) {
                    return customRole.permissions[permissionKey] === true;
                }
            }

            return false;
        },

        getDefaultPermissionsForRole(baseRole) {
            const defaults = {
                'superviseur_vendeurs': {
                    dashboard: true,
                    stocks: true,
                    deliveries: true,
                    team: true,
                    planning: true,
                    reports: true,
                    reconciliation: false,
                    auditlog: false,
                    incidents: true,
                    settings: false,
                    createUsers: true,
                    editUsers: true,
                    deleteUsers: true,
                    manageRoles: false,
                    viewFinances: false,
                    exportReports: true,
                    approveOrders: true,
                    resolveIncidents: true
                },
                'responsable_livraison': {
                    dashboard: true,
                    stocks: false,
                    deliveries: true,
                    team: true,
                    planning: true,
                    reports: true,
                    reconciliation: false,
                    auditlog: false,
                    incidents: true,
                    settings: false,
                    createUsers: false,
                    editUsers: false,
                    deleteUsers: false,
                    manageRoles: false,
                    viewFinances: false,
                    exportReports: true,
                    approveOrders: false,
                    resolveIncidents: true
                },
                'superviseur_stocks': {
                    dashboard: true,
                    stocks: true,
                    deliveries: false,
                    team: false,
                    planning: false,
                    reports: true,
                    reconciliation: true,
                    auditlog: true,
                    incidents: false,
                    settings: false,
                    createUsers: false,
                    editUsers: false,
                    deleteUsers: false,
                    manageRoles: false,
                    viewFinances: true,
                    exportReports: true,
                    approveOrders: false,
                    resolveIncidents: false
                }
            };
            return defaults[baseRole] || {};
        },

        // Custom Reports & Export
        generateReportData(posId, dateFrom, dateTo, metrics = []) {
            const start = new Date(dateFrom);
            const end = new Date(dateTo);
            end.setHours(23, 59, 59, 999);

            const data = {
                posId,
                reportTitle: CORE.getPOS(posId)?.name || 'Rapport',
                generatedAt: new Date().toISOString(),
                period: { from: dateFrom, to: dateTo },
                metrics: {}
            };

            // Commandes
            if (metrics.includes('orders') || metrics.length === 0) {
                const orders = (CORE.db.orders || []).filter(o => {
                    const oTime = o.createdAt ? new Date(o.createdAt) : null;
                    return o.posId === posId && oTime && oTime >= start && oTime <= end;
                });
                data.metrics.orders = {
                    total: orders.length,
                    totalAmount: orders.reduce((sum, o) => sum + (o.totalAmount || 0), 0),
                    byStatus: {},
                    byVendor: {}
                };
                orders.forEach(o => {
                    data.metrics.orders.byStatus[o.status] = (data.metrics.orders.byStatus[o.status] || 0) + 1;
                    const vendor = o.vendeurId ? CORE.getUser(o.vendeurId)?.name : 'Unknown';
                    data.metrics.orders.byVendor[vendor] = (data.metrics.orders.byVendor[vendor] || 0) + 1;
                });
            }

            // Livraisons
            if (metrics.includes('deliveries') || metrics.length === 0) {
                const deliveries = (CORE.db.deliveries || []).filter(d => {
                    const dTime = d.createdAt ? new Date(d.createdAt) : null;
                    return dTime && dTime >= start && dTime <= end;
                });
                const succeeded = deliveries.filter(d => d.status === 'livree').length;
                data.metrics.deliveries = {
                    total: deliveries.length,
                    succeeded,
                    failed: deliveries.length - succeeded,
                    successRate: deliveries.length > 0 ? Math.round((succeeded / deliveries.length) * 100) : 0,
                    byStatus: {}
                };
                deliveries.forEach(d => {
                    data.metrics.deliveries.byStatus[d.status] = (data.metrics.deliveries.byStatus[d.status] || 0) + 1;
                });
            }

            // Revenus
            if (metrics.includes('revenue') || metrics.length === 0) {
                const orders = (CORE.db.orders || []).filter(o => {
                    const oTime = o.createdAt ? new Date(o.createdAt) : null;
                    return o.posId === posId && oTime && oTime >= start && oTime <= end;
                });
                const totalRevenue = orders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);
                const avgOrder = orders.length > 0 ? Math.round(totalRevenue / orders.length) : 0;
                data.metrics.revenue = {
                    total: totalRevenue,
                    average: avgOrder,
                    orders: orders.length,
                    dailyAverage: Math.round(totalRevenue / ((end - start) / (1000 * 60 * 60 * 24)))
                };
            }

            // Stocks
            if (metrics.includes('stocks') || metrics.length === 0) {
                const products = (CORE.db.products || []).filter(p => p.posId === posId);
                const lowStock = products.filter(p => p.stock <= p.minStock);
                data.metrics.stocks = {
                    totalProducts: products.length,
                    totalUnits: products.reduce((sum, p) => sum + (p.stock || 0), 0),
                    lowStockCount: lowStock.length,
                    lowStockProducts: lowStock.map(p => ({ name: p.name, stock: p.stock, min: p.minStock }))
                };
            }

            // Incidents
            if (metrics.includes('incidents') || metrics.length === 0) {
                const incidents = (CORE.db.incidents || []).filter(i => {
                    const iTime = i.createdAt ? new Date(i.createdAt) : null;
                    return i.posId === posId && iTime && iTime >= start && iTime <= end;
                });
                const resolved = incidents.filter(i => i.resolved).length;
                data.metrics.incidents = {
                    total: incidents.length,
                    resolved,
                    open: incidents.length - resolved,
                    resolutionRate: incidents.length > 0 ? Math.round((resolved / incidents.length) * 100) : 0,
                    byType: {}
                };
                incidents.forEach(i => {
                    data.metrics.incidents.byType[i.type] = (data.metrics.incidents.byType[i.type] || 0) + 1;
                });
            }

            return data;
        },

        exportToCSV(data) {
            let csv = 'RAPPORT: ' + data.reportTitle + '\n';
            csv += 'Généré le: ' + new Date().toLocaleString('fr-FR') + '\n';
            csv += 'Période: ' + data.period.from + ' à ' + data.period.to + '\n\n';

            Object.entries(data.metrics).forEach(([key, metric]) => {
                csv += key.toUpperCase() + '\n';
                if (typeof metric === 'object') {
                    Object.entries(metric).forEach(([k, v]) => {
                        if (typeof v === 'object' && !Array.isArray(v)) {
                            csv += '  ' + k + '\n';
                            Object.entries(v).forEach(([sk, sv]) => {
                                csv += '    ' + sk + ',' + sv + '\n';
                            });
                        } else if (Array.isArray(v)) {
                            csv += '  ' + k + '\n';
                            v.forEach(item => {
                                csv += '    ' + JSON.stringify(item) + '\n';
                            });
                        } else {
                            csv += '  ' + k + ',' + v + '\n';
                        }
                    });
                }
                csv += '\n';
            });

            return csv;
        },

        exportToJSON(data) {
            return JSON.stringify(data, null, 2);
        },

        downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        },

        // Audit Trail Methods
        logAuditAction(action, details = {}) {
            const auditLog = JSON.parse(localStorage.getItem('audit_log') || '[]');
            const auditEntry = {
                id: 'audit_' + CORE.uid(),
                timestamp: new Date().toISOString(),
                userId: this.state.currentUser?.id || 'unknown',
                userName: this.state.currentUser?.name || 'Unknown',
                userRole: this.state.currentUser?.role || 'unknown',
                action: action,
                details: details,
                status: 'completed',
                reversible: details.reversible !== false,
                reverseFunction: details.reverseFunction || null
            };
            auditLog.push(auditEntry);
            // Keep only last 1000 entries
            if (auditLog.length > 1000) auditLog.shift();
            localStorage.setItem('audit_log', JSON.stringify(auditLog));
            return auditEntry;
        },

        getAuditLog(filters = {}) {
            const auditLog = JSON.parse(localStorage.getItem('audit_log') || '[]');
            let filtered = auditLog;

            if (filters.action) {
                filtered = filtered.filter(entry => entry.action.includes(filters.action));
            }
            if (filters.userId) {
                filtered = filtered.filter(entry => entry.userId === filters.userId);
            }
            if (filters.from && filters.to) {
                const fromTime = new Date(filters.from).getTime();
                const toTime = new Date(filters.to).getTime();
                filtered = filtered.filter(entry => {
                    const entryTime = new Date(entry.timestamp).getTime();
                    return entryTime >= fromTime && entryTime <= toTime;
                });
            }
            if (filters.reversibleOnly) {
                filtered = filtered.filter(entry => entry.reversible);
            }

            return filtered.reverse();
        },

        reverseAuditAction(auditId) {
            const auditLog = JSON.parse(localStorage.getItem('audit_log') || '[]');
            const entry = auditLog.find(e => e.id === auditId);

            if (!entry || !entry.reversible) {
                return { success: false, message: 'Cannot reverse this action' };
            }

            // Mark as reversed
            entry.status = 'reversed';
            entry.reversedAt = new Date().toISOString();
            entry.reversedBy = this.state.currentUser?.id || 'unknown';

            // Log the reversal action
            this.logAuditAction('AUDIT_REVERSE', {
                reversedAuditId: auditId,
                originalAction: entry.action,
                reversible: false
            });

            localStorage.setItem('audit_log', JSON.stringify(auditLog));
            return { success: true, message: 'Action reversed successfully' };
        },

        searchAuditLog(searchTerm) {
            const auditLog = JSON.parse(localStorage.getItem('audit_log') || '[]');
            return auditLog.filter(entry =>
                entry.action.toLowerCase().includes(searchTerm.toLowerCase()) ||
                entry.userName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                JSON.stringify(entry.details).toLowerCase().includes(searchTerm.toLowerCase())
            ).reverse();
        },

        getAuditStats() {
            const auditLog = JSON.parse(localStorage.getItem('audit_log') || '[]');
            const stats = {
                totalActions: auditLog.length,
                actionsByType: {},
                actionsByUser: {},
                actionsLast24h: 0,
                actionsLast7d: 0,
                reversedActions: 0
            };

            const now = new Date();
            const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            auditLog.forEach(entry => {
                // Count by action type
                stats.actionsByType[entry.action] = (stats.actionsByType[entry.action] || 0) + 1;
                // Count by user
                stats.actionsByUser[entry.userName] = (stats.actionsByUser[entry.userName] || 0) + 1;
                // Count recent actions
                const entryTime = new Date(entry.timestamp);
                if (entryTime >= oneDayAgo) stats.actionsLast24h++;
                if (entryTime >= sevenDaysAgo) stats.actionsLast7d++;
                // Count reversed
                if (entry.status === 'reversed') stats.reversedActions++;
            });

            return stats;
        },

        // Shift Management Methods
        getShiftsByDate(posId, date) {
            const dateStr = typeof date === 'string' ? date : date.toISOString().split('T')[0];
            return (this.db.shifts || []).filter(s => s.posId === posId && s.date === dateStr && s.status !== 'cancelled');
        },

        getActiveShifts(posId, date) {
            return this.getShiftsByDate(posId, date).filter(s => s.status === 'confirmed' || s.status === 'scheduled');
        },

        getShiftTemplate(templateId) {
            return (this.db.shiftTemplates || []).find(t => t.id === templateId);
        },

        getCapacityBySlot(posId, date) {
            const dateStr = typeof date === 'string' ? date : date.toISOString().split('T')[0];
            const templates = (this.db.shiftTemplates || []).filter(t => t.posId === posId);
            const capacity = {};

            templates.forEach(template => {
                const shiftsForSlot = (this.db.shifts || []).filter(s =>
                    s.posId === posId &&
                    s.date === dateStr &&
                    s.templateId === template.id &&
                    (s.status === 'confirmed' || s.status === 'scheduled')
                );
                capacity[template.name] = {
                    template,
                    capacity: template.capacity || 5,
                    assigned: shiftsForSlot.length,
                    available: (template.capacity || 5) - shiftsForSlot.length
                };
            });

            return capacity;
        },

        getUserTimeOff(userId, startDate = null, endDate = null) {
            let timeOff = (this.db.timeOff || []).filter(t => t.userId === userId && t.status === 'approved');

            if (startDate) {
                const start = new Date(startDate);
                timeOff = timeOff.filter(t => {
                    const tStart = new Date(t.startDate);
                    const tEnd = new Date(t.endDate);
                    const checkDate = new Date(startDate);
                    return checkDate >= tStart && checkDate <= tEnd;
                });
            }

            if (endDate && startDate !== endDate) {
                const end = new Date(endDate);
                timeOff = timeOff.filter(t => {
                    const tStart = new Date(t.startDate);
                    const tEnd = new Date(t.endDate);
                    const checkDate = new Date(endDate);
                    return checkDate >= tStart && checkDate <= tEnd;
                });
            }

            return timeOff;
        },

        formatPrice(amount) {
            const n = Number(amount || 0);
            return `${n.toLocaleString('fr-FR')} ${this.config.currency}`;
        },
        formatDate(date) { return new Date(date).toLocaleString('fr-FR'); },
        formatTime(date) { return new Date(date).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }); },
        formatDateForInput(date) {
            if (!date) return '';
            try {
                const d = new Date(date);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                return '';
            }
        },

        paymentMethodLabel(method) {
            const map = {
                cash: 'Cash',
                mobile: 'Mobile Money',
                card: 'Carte Bancaire',
                check: 'Chèque',
                cod: 'Paiement à la livraison'
            };
            if (!method) return '—';
            return map[method] || String(method);
        },

        paymentStatusLabel(status) {
            const map = {
                paid: 'Payé',
                pending: 'En attente',
                failed: 'Échoué',
                refunded: 'Remboursé'
            };
            if (!status) return '—';
            return map[status] || String(status);
        },

        // =====================
        // ROLE & PERMISSION MANAGEMENT
        // =====================
        hasPermission(userId, permissionId) {
            const user = this.getUser(userId);
            if (!user) return false;

            // PDG a toutes les permissions
            if (user.role === 'pdg') return true;

            // Trouver le rôle de l'utilisateur
            const role = this.db.roles?.find(r => r.id === user.role);
            if (!role) return false;

            // Vérifier si la permission est dans le rôle
            return role.permissions?.includes(permissionId) || role.permissions?.includes('all');
        },

        hasPermissionByRole(roleId, permissionId) {
            const role = this.db.roles?.find(r => r.id === roleId);
            if (!role) return false;
            return role.permissions?.includes(permissionId) || role.permissions?.includes('all');
        },

        // Modifier les permissions d'un rôle
        updateRolePermissions(roleId, permissions) {
            const role = this.db.roles?.find(r => r.id === roleId);
            if (!role || !role.isCustom && roleId !== 'manager') return false; // Seul manager est modifiable parmi les rôles par défaut

            const oldPermissions = [...role.permissions];
            role.permissions = permissions;

            this.logAudit('update', 'role', roleId, role.name,
                { permissionsAdded: permissions.filter(p => !oldPermissions.includes(p)), permissionsRemoved: oldPermissions.filter(p => !permissions.includes(p)) },
                { permissions: oldPermissions },
                { permissions: permissions }
            );

            this.save();
            return true;
        },

        // Créer un rôle personnalisé
        createCustomRole(name, description, permissions, color = 'slate', icon = 'shield') {
            const id = 'role_' + Date.now();
            const customRole = {
                id,
                name,
                description,
                color,
                icon,
                permissions,
                isCustom: true,
                createdAt: new Date().toISOString(),
                createdBy: this.state.currentUser?.id
            };

            this.db.roles.push(customRole);

            this.logAudit('create', 'role', id, name,
                { description, color, icon, permissions },
                null,
                customRole
            );

            this.save();
            return customRole;
        },

        // Supprimer un rôle personnalisé
        deleteCustomRole(roleId) {
            const role = this.db.roles?.find(r => r.id === roleId);
            if (!role || !role.isCustom) return false;

            const usersWithRole = this.db.users?.filter(u => u.role === roleId).length || 0;
            if (usersWithRole > 0) {
                UI.toast(`Impossible de supprimer: ${usersWithRole} utilisateur(s) ont ce rôle`, 'error');
                return false;
            }

            this.db.roles = this.db.roles.filter(r => r.id !== roleId);

            this.logAudit('delete', 'role', roleId, role.name,
                { description: 'Rôle personnalisé supprimé' },
                role,
                null
            );

            this.save();
            return true;
        },

        // Obtenir les rôles disponibles pour l'utilisateur
        getAvailableRoles() {
            return this.db.roles || [];
        },

        // NOTIFICATION & ALERTS SYSTEM
        createNotification(type, title, message, severity = 'medium', relatedTo = null, relatedId = null) {
            const notification = {
                id: CORE.uid(),
                type, // 'stock_low', 'order_rejected', 'incident_open', 'info'
                title,
                message,
                severity, // 'low', 'medium', 'high', 'critical'
                relatedTo, // 'product', 'order', 'delivery', null
                relatedId, // ID du produit/commande/livraison
                read: false,
                createdAt: new Date().toISOString(),
                readAt: null
            };
            this.db.notifications.push(notification);
            this.save();
            return notification;
        },

        dismissNotification(notificationId) {
            const notif = this.db.notifications?.find(n => n.id === notificationId);
            if (notif) {
                notif.read = true;
                notif.readAt = new Date().toISOString();
                this.save();
            }
        },

        getUnreadNotificationCount() {
            return (this.db.notifications || []).filter(n => !n.read).length;
        },

        getNotificationsByType(type) {
            return (this.db.notifications || []).filter(n => n.type === type);
        },

        checkStockLevels() {
            const threshold = this.db.alertThresholds?.find(t => t.id === 'stock_low');
            const criticalThreshold = this.db.alertThresholds?.find(t => t.id === 'stock_critical');

            if (!threshold?.enabled && !criticalThreshold?.enabled) return;

            (this.db.products || []).forEach(product => {
                const stockQty = product.quantity || 0;
                const criticalVal = criticalThreshold?.threshold || 5;
                const lowVal = threshold?.threshold || 10;

                // Check if already notified for this product today
                const today = new Date().toDateString();
                const alreadyNotified = this.db.notifications?.some(n =>
                    n.type === 'stock_critical' && n.relatedId === product.id &&
                    new Date(n.createdAt).toDateString() === today
                );

                if (criticalThreshold?.enabled && stockQty <= criticalVal && !alreadyNotified) {
                    this.createNotification(
                        'stock_critical',
                        `⚠️ Stock Critique: ${product.name}`,
                        `Le stock du produit "${product.name}" est critique (${stockQty} unités)`,
                        'critical',
                        'product',
                        product.id
                    );
                } else if (threshold?.enabled && stockQty <= lowVal && !alreadyNotified) {
                    this.createNotification(
                        'stock_low',
                        `📦 Stock Faible: ${product.name}`,
                        `Le stock du produit "${product.name}" est faible (${stockQty} unités)`,
                        'high',
                        'product',
                        product.id
                    );
                }
            });
        },

        updateAlertThreshold(thresholdId, newValue) {
            const threshold = this.db.alertThresholds?.find(t => t.id === thresholdId);
            if (threshold) {
                threshold.threshold = newValue;
                this.save();
                return true;
            }
            return false;
        },

        toggleAlertThreshold(thresholdId, enabled) {
            const threshold = this.db.alertThresholds?.find(t => t.id === thresholdId);
            if (threshold) {
                threshold.enabled = enabled;
                this.save();
                return true;
            }
            return false;
        },

        getAlertThresholds() {
            return this.db.alertThresholds || [];
        },

        getNotificationHistory(limit = 100) {
            return (this.db.notifications || []).sort((a, b) =>
                new Date(b.createdAt) - new Date(a.createdAt)
            ).slice(0, limit);
        },

        clearOldNotifications(daysOld = 30) {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysOld);
            const before = this.db.notifications.length;
            this.db.notifications = this.db.notifications.filter(n =>
                new Date(n.createdAt) > cutoffDate
            );
            if (this.db.notifications.length < before) {
                this.save();
            }
        },

        // FINANCIAL MANAGEMENT SYSTEM
        createBudget(name, category, amount, startDate, endDate, notes = '') {
            const budget = {
                id: CORE.uid(),
                name,
                category, // 'salaires', 'operationnel', 'marketing', 'logistics', 'maintenance', 'other'
                amount,
                startDate,
                endDate,
                spent: 0,
                notes,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            this.db.budgets.push(budget);
            this.save();
            return budget;
        },

        updateBudgetSpent(budgetId, spentAmount) {
            const budget = this.db.budgets?.find(b => b.id === budgetId);
            if (budget) {
                budget.spent = spentAmount;
                budget.updatedAt = new Date().toISOString();
                this.save();
                return budget;
            }
            return null;
        },

        getBudgets(category = null, dateRange = null) {
            let budgets = this.db.budgets || [];
            if (category) {
                budgets = budgets.filter(b => b.category === category);
            }
            if (dateRange) {
                budgets = budgets.filter(b => {
                    const start = new Date(b.startDate);
                    const end = new Date(b.endDate);
                    return start >= dateRange.start && end <= dateRange.end;
                });
            }
            return budgets;
        },

        calculateFinancialMetrics(dateFrom, dateTo) {
            const orders = (this.db.orders || []).filter(o => {
                const orderDate = new Date(o.createdAt);
                return orderDate >= new Date(dateFrom) && orderDate <= new Date(dateTo);
            });

            const transactions = (this.db.transactions || []).filter(t => {
                const txDate = new Date(t.date);
                return txDate >= new Date(dateFrom) && txDate <= new Date(dateTo);
            });

            const expenses = (this.db.expenses || []).filter(e => {
                const expDate = new Date(e.date);
                return expDate >= new Date(dateFrom) && expDate <= new Date(dateTo);
            });

            // Calculate revenues
            const totalRevenue = orders.reduce((sum, o) => sum + (o.total || 0), 0);

            // Calculate costs
            const productCosts = orders.reduce((sum, o) => {
                return sum + (o.items || []).reduce((itemSum, item) => {
                    const product = this.getProduct(item.productId);
                    return itemSum + ((product?.costPrice || 0) * (item.qty || 0));
                }, 0);
            }, 0);

            const deliveryCosts = (this.db.deliveries || [])
                .filter(d => {
                    const dDate = new Date(d.createdAt);
                    return dDate >= new Date(dateFrom) && dDate <= new Date(dateTo);
                })
                .reduce((sum, d) => sum + (d.costPrice || 0), 0);

            const operatingExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);

            const totalCosts = productCosts + deliveryCosts + operatingExpenses;
            const grossProfit = totalRevenue - productCosts;
            const netProfit = totalRevenue - totalCosts;
            const profitMargin = totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(2) : 0;
            const roi = totalCosts > 0 ? ((netProfit / totalCosts) * 100).toFixed(2) : 0;

            return {
                date: new Date().toISOString(),
                totalRevenue: parseFloat(totalRevenue.toFixed(2)),
                totalCosts: parseFloat(totalCosts.toFixed(2)),
                productCosts: parseFloat(productCosts.toFixed(2)),
                deliveryCosts: parseFloat(deliveryCosts.toFixed(2)),
                operatingExpenses: parseFloat(operatingExpenses.toFixed(2)),
                grossProfit: parseFloat(grossProfit.toFixed(2)),
                netProfit: parseFloat(netProfit.toFixed(2)),
                profitMargin: parseFloat(profitMargin),
                roi: parseFloat(roi),
                ordersCount: orders.length,
                deliveriesCount: (this.db.deliveries || []).filter(d => {
                    const dDate = new Date(d.createdAt);
                    return dDate >= new Date(dateFrom) && dDate <= new Date(dateTo);
                }).length
            };
        },

        getBudgetStatus(budgetId) {
            const budget = this.db.budgets?.find(b => b.id === budgetId);
            if (!budget) return null;

            const remaining = budget.amount - budget.spent;
            const percentageUsed = budget.amount > 0 ? (budget.spent / budget.amount * 100).toFixed(2) : '0.00';
            const status = budget.spent > budget.amount ? 'over' : (percentageUsed > 80 ? 'warning' : 'ok');

            return {
                budget,
                spent: budget.spent,
                remaining: Math.max(0, remaining),
                percentageUsed: parseFloat(percentageUsed),
                status // 'ok', 'warning', 'over'
            };
        },

        getBudgetComparison(month = null) {
            const budgets = this.db.budgets || [];
            const now = new Date();
            const targetMonth = month || new Date(now.getFullYear(), now.getMonth(), 1);

            const activeBudgets = budgets.filter(b => {
                const start = new Date(b.startDate);
                const end = new Date(b.endDate);
                return start <= targetMonth && end >= targetMonth;
            });

            const totalBudgeted = activeBudgets.reduce((sum, b) => sum + b.amount, 0);
            const totalSpent = activeBudgets.reduce((sum, b) => sum + b.spent, 0);
            const totalRemaining = totalBudgeted - totalSpent;
            const overallPercentage = totalBudgeted > 0 ? ((totalSpent / totalBudgeted) * 100).toFixed(2) : 0;

            return {
                period: targetMonth.toISOString().split('T')[0],
                totalBudgeted: parseFloat(totalBudgeted.toFixed(2)),
                totalSpent: parseFloat(totalSpent.toFixed(2)),
                totalRemaining: Math.max(0, parseFloat(totalRemaining.toFixed(2))),
                overallPercentage: parseFloat(overallPercentage),
                budgets: activeBudgets.map(b => this.getBudgetStatus(b.id))
            };
        },

        setFinancialTarget(targetId, value) {
            const target = this.db.financialTargets?.find(t => t.id === targetId);
            if (target) {
                if (target.percentage) {
                    target.percentage = value;
                } else {
                    target.amount = value;
                }
                this.save();
                return target;
            }
            return null;
        },

        getFinancialHealth() {
            const today = new Date();
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            const metrics = this.calculateFinancialMetrics(lastMonth.toISOString(), today.toISOString());
            const budgetComparison = this.getBudgetComparison();

            const healthScore = this.calculateHealthScore(metrics, budgetComparison);

            return {
                metrics,
                budgetComparison,
                healthScore, // 0-100
                status: healthScore >= 80 ? 'excellent' : (healthScore >= 60 ? 'bon' : (healthScore >= 40 ? 'moyen' : 'faible'))
            };
        },

        calculateHealthScore(metrics, budgetComparison) {
            let score = 100;

            // Profit margin impact
            const marginScore = Math.min(metrics.profitMargin, 100);
            score = score * (marginScore / 100);

            // Budget adherence impact
            if (budgetComparison.overallPercentage > 90) {
                score -= 10;
            } else if (budgetComparison.overallPercentage > 100) {
                score -= 30;
            }

            // Revenue vs cost ratio
            if (metrics.totalCosts > metrics.totalRevenue * 0.7) {
                score -= 15;
            }

            // Ensure score is between 0 and 100
            return Math.max(0, Math.min(100, score.toFixed(2)));
        },

        // SYSTEM MANAGEMENT
        createBackup(notes = '') {
            const backup = {
                id: CORE.uid(),
                name: `Backup-${new Date().toISOString().split('T')[0]}-${Math.random().toString(36).substr(2, 9)}`,
                date: new Date().toISOString(),
                size: this.getStorageSize(),
                status: 'success',
                notes,
                data: {
                    users: [...this.db.users],
                    orders: [...(this.db.orders || [])],
                    deliveries: [...(this.db.deliveries || [])],
                    products: [...(this.db.products || [])],
                    transactions: [...(this.db.transactions || [])],
                    expenses: [...(this.db.expenses || [])],
                    budgets: [...(this.db.budgets || [])]
                }
            };

            this.db.backups.push(backup);
            this.logSystemEvent('backup_created', `Sauvegarde créée: ${backup.name}`, 'info');
            this.save();
            return backup;
        },

        restoreBackup(backupId) {
            const backup = this.db.backups?.find(b => b.id === backupId);
            if (!backup) return { success: false, message: 'Sauvegarde non trouvée' };

            try {
                // Restore data
                if (backup.data.users) this.db.users = [...backup.data.users];
                if (backup.data.orders) this.db.orders = [...backup.data.orders];
                if (backup.data.deliveries) this.db.deliveries = [...backup.data.deliveries];
                if (backup.data.products) this.db.products = [...backup.data.products];
                if (backup.data.transactions) this.db.transactions = [...backup.data.transactions];
                if (backup.data.expenses) this.db.expenses = [...backup.data.expenses];
                if (backup.data.budgets) this.db.budgets = [...backup.data.budgets];

                this.save();
                this.logSystemEvent('backup_restored', `Sauvegarde restaurée: ${backup.name}`, 'warning');
                return { success: true, message: 'Sauvegarde restaurée avec succès' };
            } catch (e) {
                this.logSystemEvent('backup_restore_failed', `Erreur lors de la restauration: ${e.message}`, 'error');
                return { success: false, message: 'Erreur lors de la restauration' };
            }
        },

        deleteBackup(backupId) {
            const before = (this.db.backups || []).length;
            this.db.backups = (this.db.backups || []).filter(b => b.id !== backupId);
            if (this.db.backups.length < before) {
                this.logSystemEvent('backup_deleted', `Sauvegarde supprimée: ${backupId}`, 'info');
                this.save();
                return true;
            }
            return false;
        },

        getBackups() {
            return (this.db.backups || []).sort((a, b) => new Date(b.date) - new Date(a.date));
        },

        logSystemEvent(level, message, type = 'info') {
            const event = {
                id: CORE.uid(),
                timestamp: new Date().toISOString(),
                level: type, // 'info', 'warning', 'error', 'critical'
                module: 'SYSTEM',
                message,
                userId: this.state.currentUser?.id,
                ipAddress: 'local'
            };

            if (!this.db.systemLogs) this.db.systemLogs = [];
            this.db.systemLogs.push(event);

            // Keep only last 1000 logs
            if (this.db.systemLogs.length > 1000) {
                this.db.systemLogs = this.db.systemLogs.slice(-1000);
            }

            this.save();
            return event;
        },

        getSystemLogs(limit = 100, level = null) {
            let logs = (this.db.systemLogs || []).sort((a, b) =>
                new Date(b.timestamp) - new Date(a.timestamp)
            ).slice(0, limit);

            if (level) {
                logs = logs.filter(l => l.level === level);
            }

            return logs;
        },

        clearOldLogs(daysOld = 90) {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysOld);
            const before = this.db.systemLogs.length;
            this.db.systemLogs = (this.db.systemLogs || []).filter(l =>
                new Date(l.timestamp) > cutoffDate
            );
            if (this.db.systemLogs.length < before) {
                this.save();
            }
        },

        updateSystemConfig(key, value) {
            if (this.db.systemConfig[key] !== undefined) {
                this.db.systemConfig[key] = value;
                this.logSystemEvent('config_updated', `Configuration mise à jour: ${key} = ${value}`, 'info');
                this.save();
                return true;
            }
            return false;
        },

        getSystemConfig() {
            return this.db.systemConfig;
        },

        // Retourne l'indicatif téléphonique du pays basé sur la devise de l'entreprise
        getCountryPhoneCode() {
            const currency = (this.db.systemConfig?.currency || this.db.systemConfig?.currencyCode || this.config?.currency || 'XOF').toUpperCase();
            const currencyToCode = {
                'XOF': '225',  // Côte d'Ivoire (UEMOA) — default for FCFA UEMOA
                'XAF': '242',  // Congo-Brazzaville (CEMAC) — default for FCFA CEMAC
                'NGN': '234',  // Nigeria
                'ZAR': '27',   // Afrique du Sud
                'KES': '254',  // Kenya
                'GHS': '233',  // Ghana
                'MAD': '212',  // Maroc
                'EGP': '20',   // Egypte
                'TZS': '255',  // Tanzanie
                'CDF': '243',  // RD Congo
                'RWF': '250',  // Rwanda
                'MGA': '261',  // Madagascar
                'EUR': '33',   // France
                'USD': '1',    // USA
                'GBP': '44',   // Royaume-Uni
                'CAD': '1',    // Canada
                'CHF': '41',   // Suisse
                'CNY': '86',   // Chine
                'JPY': '81',   // Japon
                'AED': '971',  // Émirats
                'SAR': '966',  // Arabie Saoudite
                'BRL': '55',   // Brésil
                'INR': '91',   // Inde
                'TRY': '90',   // Turquie
            };
            // Also check timezone for more precise country within same currency zone
            const tz = (this.db.systemConfig?.timezone || '').toLowerCase();
            if (currency === 'XAF') {
                if (tz.includes('douala') || tz.includes('cameroun')) return '237'; // Cameroun
                if (tz.includes('libreville') || tz.includes('gabon')) return '241'; // Gabon
                if (tz.includes('bangui')) return '236'; // Centrafrique
                if (tz.includes('ndjamena') || tz.includes('tchad')) return '235'; // Tchad
                if (tz.includes('malabo')) return '240'; // Guinée Équatoriale
                return '242'; // Congo-Brazzaville (default CEMAC)
            }
            if (currency === 'XOF') {
                if (tz.includes('dakar') || tz.includes('senegal')) return '221'; // Sénégal
                if (tz.includes('bamako') || tz.includes('mali')) return '223'; // Mali
                if (tz.includes('ouaga') || tz.includes('burkina')) return '226'; // Burkina Faso
                if (tz.includes('niamey') || tz.includes('niger')) return '227'; // Niger
                if (tz.includes('lome') || tz.includes('togo')) return '228'; // Togo
                if (tz.includes('cotonou') || tz.includes('porto-novo') || tz.includes('benin')) return '229'; // Bénin
                if (tz.includes('bissau')) return '245'; // Guinée-Bissau
                return '225'; // Côte d'Ivoire (default UEMOA)
            }
            return currencyToCode[currency] || '242';
        },

        // Formate un numéro de téléphone pour WhatsApp (format international sans +)
        formatPhoneForWhatsApp(phone) {
            if (!phone) return '';
            let p = String(phone).trim().replace(/[\s\-\.\(\)]/g, '');
            // Déjà au format international avec +
            if (p.startsWith('+')) return p.substring(1);
            // Déjà au format international sans + (commence par indicatif connu, > 10 chiffres)
            if (/^\d{11,15}$/.test(p)) {
                const code = this.getCountryPhoneCode();
                if (p.startsWith(code)) return p;
            }
            // Numéro local commençant par 0
            if (p.startsWith('0')) {
                return this.getCountryPhoneCode() + p.substring(1);
            }
            // Numéro local sans 0 (ex: 6 XXXXXXX)
            if (/^\d{6,10}$/.test(p)) {
                return this.getCountryPhoneCode() + p;
            }
            return p;
        },

        // -- SMS TICKET FORMAT (identique au WhatsApp) --
        buildDeliveryTicketSMS(opts = {}) {
            const pdv = this.db.pointsDeVente?.find(p => p.id === this.state.activePDV);
            const pdvName = pdv?.nom || 'RAYA STORE';
            const pdvTel = pdv?.telephone || 'N/A';
            const { orderRef, clientName, clientPhone, address, deliveryTime, amount, orderItems, prefix } = opts;

            let msg = '';
            if (prefix) msg += prefix + '\n';
            msg += '📦 BON DE LIVRAISON\n';
            msg += '━━━━━━━━━━━━━━━━━━\n\n';
            msg += '🏪 De: ' + pdvName + '\n';
            msg += '📋 Réf: ' + (orderRef || 'N/A') + '\n';
            msg += '📅 Date: ' + new Date().toLocaleDateString('fr-FR') + '\n\n';

            msg += '👤 CLIENT\n';
            msg += '━━━━━━━━━━━━━━━━━━\n';
            msg += 'Nom: ' + (clientName || 'Non spécifié') + '\n';
            if (clientPhone) msg += 'Tél: ' + clientPhone + '\n';
            msg += '📍 Adresse: ' + (address || 'Non spécifiée') + '\n';
            if (deliveryTime) msg += '⏰ Heure souhaitée: ' + deliveryTime + '\n';
            msg += '\n';

            msg += '📦 ARTICLES À LIVRER\n';
            msg += '━━━━━━━━━━━━━━━━━━\n';
            if (orderItems && orderItems.length > 0) {
                orderItems.forEach((item, idx) => {
                    msg += (idx + 1) + '. ' + item.name + '\n';
                    msg += '   Qté: ' + item.qty + ' × ' + this.formatPrice(item.price) + ' = ' + this.formatPrice(item.qty * item.price) + '\n';
                });
            } else {
                msg += '(Aucun détail disponible)\n';
            }
            msg += '\n';

            msg += '💰 MONTANT TOTAL: ' + this.formatPrice(amount || 0) + '\n\n';
            msg += '━━━━━━━━━━━━━━━━━━\n';
            msg += '⚠️ Merci de confirmer la livraison une fois effectuée.\n';
            msg += '📞 Contact boutique: ' + pdvTel;
            return msg;
        },

        // Retourne le placeholder téléphone selon le pays de l'entreprise
        getPhonePlaceholder() {
            const code = this.getCountryPhoneCode();
            const placeholders = {
                '225': '+225 07 XX XX XX XX',
                '242': '+242 06 XXX XX XX',
                '243': '+243 09 XX XXX XX XX',
                '237': '+237 6 XX XX XX XX',
                '221': '+221 7X XXX XX XX',
                '234': '+234 80X XXX XXXX',
                '33': '+33 06 XX XX XX XX',
                '1': '+1 XXX XXX XXXX',
                '212': '+212 6 XX XX XX XX',
            };
            return placeholders[code] || `+${code} ...`;
        },

        getDiagnostics() {
            const diagnostics = {
                ...this.db.diagnostics,
                lastCheck: new Date().toISOString(),
                databaseSize: this.getStorageSize(),
                activeUsers: (this.db.users || []).filter(u => u.active).length,
                totalUsers: (this.db.users || []).length,
                totalOrders: (this.db.orders || []).length,
                totalDeliveries: (this.db.deliveries || []).length,
                totalProducts: (this.db.products || []).length,
                backupsCount: (this.db.backups || []).length,
                logsCount: (this.db.systemLogs || []).length,
                auditLogsCount: (this.db.auditLogs || []).length
            };

            this.db.diagnostics = diagnostics;
            this.save();
            return diagnostics;
        },

        getStorageSize() {
            const dataStr = JSON.stringify(this.db);
            const bytes = new Blob([dataStr]).size;
            return (bytes / 1024 / 1024).toFixed(2); // MB
        },

        cleanupSystem() {
            const config = this.db.systemConfig;

            // Clear old logs
            this.clearOldLogs(config.logRetention);

            // Clear old notifications
            CORE.clearOldNotifications(30);

            // Clear old audit logs
            const auditCutoff = new Date();
            auditCutoff.setDate(auditCutoff.getDate() - 90);
            this.db.auditLogs = (this.db.auditLogs || []).filter(log =>
                new Date(log.timestamp) > auditCutoff
            );

            // Delete old backups beyond retention
            this.db.backups = (this.db.backups || []).filter(b => {
                const backupDate = new Date(b.date);
                const now = new Date();
                const days = (now - backupDate) / (1000 * 60 * 60 * 24);
                return days <= config.backupRetention;
            });

            this.logSystemEvent('cleanup_executed', 'Nettoyage système exécuté', 'info');
            this.save();
            return true;
        },

        exportSystemData() {
            const data = {
                exportDate: new Date().toISOString(),
                systemConfig: this.db.systemConfig,
                statistics: this.getDiagnostics(),
                dataExport: {
                    users: this.db.users.length,
                    orders: (this.db.orders || []).length,
                    deliveries: (this.db.deliveries || []).length,
                    products: (this.db.products || []).length,
                    transactions: (this.db.transactions || []).length
                }
            };
            return data;
        },

        // USER SUSPENSION MANAGEMENT
        suspendUser(userId, reason, durationDays = 7) {
            const user = this.getUser(userId);
            if (!user) return { success: false, message: 'Utilisateur non trouvé' };

            const currentUser = this.state.currentUser;
            const suspension = {
                id: CORE.uid(),
                userId,
                userName: user.name,
                suspendedBy: currentUser?.id,
                suspendedByName: currentUser?.name,
                reason,
                suspendedAt: new Date().toISOString(),
                resumedAt: null,
                duration: durationDays,
                expectedResumeDate: new Date(Date.now() + durationDays * 24 * 60 * 60 * 1000).toISOString(),
                status: 'active'
            };

            user.suspended = true;
            user.suspensionId = suspension.id;
            user.suspendedAt = suspension.suspendedAt;
            user.suspensionReason = reason;

            this.db.userSuspensions.push(suspension);

            // Add to history
            this.suspensionHistoryEntry('suspended', suspension, { action: 'Utilisateur suspendu', reason });

            this.logAudit('suspend', 'user', userId, user.name,
                { reason, duration: durationDays },
                { suspended: false },
                { suspended: true }
            );

            this.save();
            this.logSystemEvent('user_suspended', `Utilisateur ${user.name} suspendu pour: ${reason}`, 'warning');

            return { success: true, message: `${user.name} suspendu avec succès`, suspension };
        },

        resumeUser(userId) {
            const user = this.getUser(userId);
            if (!user) return { success: false, message: 'Utilisateur non trouvé' };

            if (!user.suspended) return { success: false, message: 'Utilisateur non suspendu' };

            const suspension = this.db.userSuspensions?.find(s => s.id === user.suspensionId);

            user.suspended = false;
            user.suspensionId = null;
            user.suspendedAt = null;
            user.suspensionReason = null;

            if (suspension) {
                suspension.status = 'resolved';
                suspension.resumedAt = new Date().toISOString();
            }

            // Add to history
            this.suspensionHistoryEntry('resumed', suspension, { action: 'Utilisateur réactivé' });

            this.logAudit('resume', 'user', userId, user.name,
                { resumeReason: 'Suspension levée' },
                { suspended: true },
                { suspended: false }
            );

            this.save();
            this.logSystemEvent('user_resumed', `Utilisateur ${user.name} réactivé`, 'info');

            return { success: true, message: `${user.name} réactivé avec succès` };
        },

        suspensionHistoryEntry(action, suspension, details) {
            const entry = {
                id: CORE.uid(),
                userId: suspension?.userId,
                suspension,
                action, // 'suspended' or 'resumed'
                timestamp: new Date().toISOString(),
                details,
                performedBy: this.state.currentUser?.id,
                performedByName: this.state.currentUser?.name
            };

            if (!this.db.suspensionHistory) this.db.suspensionHistory = [];
            this.db.suspensionHistory.push(entry);
        },

        getUserSuspensions(userId = null) {
            let suspensions = this.db.userSuspensions || [];
            if (userId) {
                suspensions = suspensions.filter(s => s.userId === userId);
            }
            return suspensions.sort((a, b) => new Date(b.suspendedAt) - new Date(a.suspendedAt));
        },

        getSuspensionHistory(userId = null, limit = 100) {
            let history = (this.db.suspensionHistory || []).sort((a, b) =>
                new Date(b.timestamp) - new Date(a.timestamp)
            );

            if (userId) {
                history = history.filter(h => h.userId === userId);
            }

            return history.slice(0, limit);
        },

        getActiveSuspensions() {
            return (this.db.userSuspensions || []).filter(s => s.status === 'active');
        },

        getSuspendedUsers() {
            return this.db.users.filter(u => u.suspended);
        },

        isSuspended(userId) {
            const user = this.getUser(userId);
            return user ? user.suspended : false;
        },

        // ========== IMPORT/EXPORT & SYNC ==========
        parseCSVData(csvContent) {
            const lines = csvContent.trim().split('\n');
            if (lines.length < 2) return { headers: [], data: [] };

            const headers = lines[0].split(',').map(h => h.trim());
            const data = lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim());
                const row = {};
                headers.forEach((header, idx) => {
                    row[header] = values[idx] || '';
                });
                return row;
            });

            return { headers, data };
        },

        importUsersFromCSV(csvContent, dryRun = false) {
            const currentUser = this.state.currentUser;
            if (!currentUser || currentUser.role !== 'pdg') {
                return { success: false, message: 'Permission denied' };
            }

            const { headers, data } = this.parseCSVData(csvContent);
            const requiredFields = ['name', 'username', 'email', 'password', 'role'];
            const missingFields = requiredFields.filter(f => !headers.includes(f));

            if (missingFields.length > 0) {
                return { success: false, message: `Champs manquants: ${missingFields.join(', ')}` };
            }

            let successCount = 0;
            let errorCount = 0;
            const errors = [];

            data.forEach((row, idx) => {
                try {
                    // Validation
                    if (!row.name || !row.username || !row.email || !row.password) {
                        errorCount++;
                        errors.push(`Ligne ${idx + 2}: Champs obligatoires manquants`);
                        return;
                    }

                    // Vérifier l'unicité
                    if (this.db.users.find(u => u.username === row.username)) {
                        errorCount++;
                        errors.push(`Ligne ${idx + 2}: Utilisateur ${row.username} existe déjà`);
                        return;
                    }

                    if (!dryRun) {
                        const newUser = {
                            id: CORE.uid() + Math.random(),
                            name: row.name,
                            username: row.username,
                            email: row.email,
                            password: row.password,
                            role: row.role || 'vendeur',
                            deliveryCenter: row.deliveryCenter || '',
                            active: row.active === 'true' ? true : true,
                            suspended: false,
                            createdAt: new Date().toISOString(),
                            importedFrom: 'csv'
                        };

                        this.db.users.push(newUser);
                        successCount++;
                    } else {
                        successCount++;
                    }
                } catch (e) {
                    errorCount++;
                    errors.push(`Ligne ${idx + 2}: ${e.message}`);
                }
            });

            if (!dryRun) {
                this.save();
                this.logAudit('import', 'users', 'bulk', 'Import en masse', {
                    source: 'csv',
                    rowsProcessed: data.length,
                    successCount,
                    errorCount
                });
            }

            const importRecord = {
                id: CORE.uid(),
                type: 'import',
                entity: 'users',
                timestamp: new Date().toISOString(),
                performedBy: currentUser.id,
                performedByName: currentUser.name,
                rowsProcessed: data.length,
                fileName: 'import_users.csv',
                status: errorCount === 0 ? 'success' : 'partial',
                details: { successCount, errorCount, errors: errors.slice(0, 10) }
            };

            this.db.importExportHistory.push(importRecord);
            this.save();

            return {
                success: errorCount === 0,
                message: `Importé: ${successCount} réussi(s), ${errorCount} erreur(s)`,
                successCount,
                errorCount,
                errors: errors.slice(0, 10)
            };
        },

        exportUsersToCSV() {
            const headers = ['ID', 'Nom', 'Identifiant', 'Email', 'Rôle', 'Centre', 'Actif', 'Suspendu', 'Date Création'];
            const rows = this.db.users.map(user => [
                user.id,
                user.name,
                user.username,
                user.email || '',
                user.role,
                user.deliveryCenter || '',
                user.active ? 'Oui' : 'Non',
                user.suspended ? 'Oui' : 'Non',
                new Date(user.createdAt).toLocaleDateString('fr-FR')
            ]);

            let csv = headers.join(',') + '\n';
            csv += rows.map(row => row.map(cell => '"' + cell + '"').join(',')).join('\n');

            const currentUser = this.state.currentUser;
            const exportRecord = {
                id: CORE.uid(),
                type: 'export',
                entity: 'users',
                timestamp: new Date().toISOString(),
                performedBy: currentUser.id,
                performedByName: currentUser.name,
                rowsProcessed: this.db.users.length,
                fileName: `users_${new Date().getTime()}.csv`,
                status: 'success',
                details: { totalRows: this.db.users.length }
            };

            this.db.importExportHistory.push(exportRecord);
            this.save();

            return csv;
        },

        exportOrdersToCSV() {
            const headers = ['ID', 'Numéro', 'Client', 'Montant', 'Statut', 'Date', 'Vendeur'];
            const rows = (this.db.orders || []).map(order => [
                order.id,
                order.orderNumber || '',
                order.client || '',
                order.totalAmount || '0',
                order.status || 'pending',
                new Date(order.createdAt).toLocaleDateString('fr-FR'),
                order.vendorName || ''
            ]);

            let csv = headers.join(',') + '\n';
            csv += rows.map(row => row.map(cell => '"' + cell + '"').join(',')).join('\n');

            const currentUser = this.state.currentUser;
            const exportRecord = {
                id: CORE.uid(),
                type: 'export',
                entity: 'orders',
                timestamp: new Date().toISOString(),
                performedBy: currentUser.id,
                performedByName: currentUser.name,
                rowsProcessed: rows.length,
                fileName: `orders_${new Date().getTime()}.csv`,
                status: 'success',
                details: { totalRows: rows.length }
            };

            this.db.importExportHistory.push(exportRecord);
            this.save();

            return csv;
        },

        exportAuditToCSV() {
            const headers = ['Heure', 'Utilisateur', 'Rôle', 'Action', 'Entité', 'Statut', 'Détails'];
            const rows = (this.db.auditTrail || []).map(entry => [
                new Date(entry.timestamp).toLocaleDateString('fr-FR'),
                entry.userName || '',
                entry.userRole || '',
                entry.action || '',
                entry.entity || '',
                entry.status || 'success',
                JSON.stringify(entry.details || {}).slice(0, 50)
            ]);

            let csv = headers.join(',') + '\n';
            csv += rows.map(row => row.map(cell => '"' + cell + '"').join(',')).join('\n');

            const currentUser = this.state.currentUser;
            const exportRecord = {
                id: CORE.uid(),
                type: 'export',
                entity: 'audit',
                timestamp: new Date().toISOString(),
                performedBy: currentUser.id,
                performedByName: currentUser.name,
                rowsProcessed: rows.length,
                fileName: `audit_${new Date().getTime()}.csv`,
                status: 'success',
                details: { totalRows: rows.length }
            };

            this.db.importExportHistory.push(exportRecord);
            this.save();

            return csv;
        },

        exportDataAsJSON(entity = 'all') {
            const currentUser = this.state.currentUser;
            let dataToExport = {};

            if (entity === 'all' || entity === 'users') dataToExport.users = this.db.users;
            if (entity === 'all' || entity === 'orders') dataToExport.orders = this.db.orders || [];
            if (entity === 'all' || entity === 'audit') dataToExport.auditTrail = this.db.auditTrail || [];
            if (entity === 'all' || entity === 'products') dataToExport.products = this.db.products || [];

            const json = JSON.stringify(dataToExport, null, 2);

            const exportRecord = {
                id: CORE.uid(),
                type: 'export',
                entity: entity === 'all' ? 'complete_backup' : entity,
                timestamp: new Date().toISOString(),
                performedBy: currentUser.id,
                performedByName: currentUser.name,
                rowsProcessed: Object.values(dataToExport).flat().length,
                fileName: `export_${entity}_${new Date().getTime()}.json`,
                status: 'success',
                details: { entities: Object.keys(dataToExport) }
            };

            this.db.importExportHistory.push(exportRecord);
            this.save();

            return json;
        },

        getImportExportHistory(limit = 50) {
            return (this.db.importExportHistory || [])
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, limit);
        },

        syncWithExternalSystem(configId) {
            const config = this.db.externalSyncConfigs?.find(c => c.id === configId);
            if (!config || config.status !== 'active') return { success: false, message: 'Config inactive' };

            const currentUser = this.state.currentUser;
            const timestamp = new Date().toISOString();

            try {
                // Simulation d'une synchronisation
                const syncData = {
                    timestamp,
                    users: this.db.users.length,
                    orders: (this.db.orders || []).length,
                    syncid: CORE.uid()
                };

                config.lastSync = timestamp;
                this.save();

                this.logAudit('sync', 'external_system', config.id, config.name, {
                    syncData,
                    status: 'success'
                });

                return {
                    success: true,
                    message: 'Synchronisation réussie',
                    syncData
                };
            } catch (e) {
                this.logAudit('sync', 'external_system', config.id, config.name, {
                    error: e.message,
                    status: 'failed'
                });

                return {
                    success: false,
                    message: `Erreur: ${e.message}`
                };
            }
        },

        addExternalSyncConfig(name, type, url, frequency = 'daily', method = 'POST') {
            const config = {
                id: CORE.uid(),
                name,
                type, // 'api', 'webhook', 'polling'
                url,
                method,
                frequency, // 'hourly', 'daily', 'weekly'
                lastSync: null,
                status: 'active',
                credentials: {},
                createdAt: new Date().toISOString()
            };

            this.db.externalSyncConfigs.push(config);
            this.save();

            this.logAudit('create', 'external_sync_config', config.id, name);

            return config;
        },

        deleteExternalSyncConfig(configId) {
            const idx = this.db.externalSyncConfigs.findIndex(c => c.id === configId);
            if (idx >= 0) {
                this.db.externalSyncConfigs.splice(idx, 1);
                this.save();
            }
        },

        logAudit(action, entity, entityId, entityName = '', details = {}, before = null, after = null, status = 'success') {
            const currentUser = this.state.currentUser;
            if (!currentUser) return;

            const auditEntry = {
                id: CORE.uid(),
                timestamp: new Date().toISOString(),
                userId: currentUser.id,
                userName: currentUser.name,
                userRole: currentUser.role,
                action,
                entity,
                entityId,
                entityName,
                details: typeof details === 'string' ? { description: details } : details,
                // PERF: Don't store full before/after snapshots — they bloat localStorage
                before: null,
                after: null,
                status,
                ipAddress: 'localhost'
            };

            if (!this.db.auditLogs) this.db.auditLogs = [];
            this.db.auditLogs.unshift(auditEntry);
            // Cap inline to avoid unbounded growth between saves
            if (this.db.auditLogs.length > 250) this.db.auditLogs.length = 250;
            this.save();
            return auditEntry;
        },

        notify(type, message, data = {}) {
            // ===== ISOLATION: Notifications isolées par POS =====
            const posId = this.state.currentUser?.pos || this.state.currentUser?.storeId;
            const notification = {
                id: CORE.uid(),
                type,
                message,
                data,
                read: false,
                createdAt: new Date().toISOString(),
                posId: posId // Isoler la notification pour un POS spécifique
            };

            // Ajoute aussi aux notifications globales pour la compatibilité
            this.db.notifications.unshift(notification);

            // Ajoute aussi aux notifications isolées du POS
            if (posId && this.db.posDataByLocation && this.db.posDataByLocation[posId]) {
                if (!this.db.posDataByLocation[posId].notifications) {
                    this.db.posDataByLocation[posId].notifications = [];
                }
                this.db.posDataByLocation[posId].notifications.unshift(notification);
            }

            this.save();
            const toastType = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : 'success';
            UI.toast(message, toastType);
        },

        recordStockMovement({ productId, type, qty, note, ref, posId = null, fromPosId = null, toPosId = null, meta = {}, quantity = null, userId = null, userName = null, notes = null, reason = null, document = null, timestamp = null, direction = null }) {
            if (!productId) return null;

            const product = this.getProduct(productId);
            const currentUser = this.state.currentUser || {};
            const resolvedQty = Number((qty !== undefined && qty !== null) ? qty : (quantity !== undefined && quantity !== null ? quantity : 0));
            const effectiveQty = Number.isFinite(resolvedQty) ? resolvedQty : 0;
            const effectivePosId = (posId !== undefined && posId !== null) ? posId : (currentUser.pos ?? null);
            const effectiveNote = note || notes || reason || null;
            const effectiveRef = ref || document || null;
            const now = new Date().toISOString();

            const movement = {
                id: CORE.uid(),
                productId,
                productName: product?.name || '—',
                type: type || 'adjust',
                // Store BOTH property names so all display functions work
                qty: effectiveQty,
                quantity: effectiveQty,
                ref: effectiveRef,
                document: effectiveRef,
                note: effectiveNote,
                notes: effectiveNote,
                reason: reason || null,
                userId: userId !== null && userId !== undefined ? userId : (currentUser.id ?? null),
                userName: userName || currentUser.name || 'System',
                // Store all date aliases
                createdAt: now,
                timestamp: timestamp || now,
                date: now,
                posId: effectivePosId,
                fromPosId: fromPosId ?? null,
                toPosId: toPosId ?? null,
                direction: direction || (meta?.direction) || null,
                meta: meta || {}
            };

            this.db.stockMovements = this.db.stockMovements || [];
            this.db.stockMovements.unshift(movement);
            // Cap to prevent unbounded growth (full history lives in cloud)
            if (this.db.stockMovements.length > 500) this.db.stockMovements.length = 500;

            if (effectivePosId !== null && this.db.posDataByLocation && this.db.posDataByLocation[effectivePosId]) {
                const location = this.db.posDataByLocation[effectivePosId];
                if (!location.stockMovements) location.stockMovements = [];
                location.stockMovements.unshift(movement);
                if (location.stockMovements.length > 100) location.stockMovements.length = 100;
            }

            this.save();
            return movement;
        },

        // =====================
        // FINANCE LEDGER (Manager/PDG)
        // =====================
        recordFinancialTransaction({
            type = 'income', // income | expense
            category = 'sale', // sale | expense | commission | refund | adjustment
            amount = 0,
            method = null, // cash | mobile | cod | internal
            ref = null,
            note = null,
            orderId = null,
            deliveryId = null,
            posId = null,
            cityId = null,
            settled = null // true | false (null => auto)
        }) {
            const autoSettled = settled === null
                ? (category === 'commission' ? false : true)
                : Boolean(settled);

            const tx = {
                id: CORE.uid(),
                type,
                category,
                amount: Number(amount || 0),
                method,
                ref,
                note,
                orderId,
                deliveryId,
                posId,
                cityId,
                settled: autoSettled,
                settledAt: autoSettled ? new Date().toISOString() : null,
                userId: this.state.currentUser?.id || null,
                userName: this.state.currentUser?.name || 'System',
                createdAt: new Date().toISOString()
            };
            this.db.financialTransactions.unshift(tx);
            // Cap to prevent unbounded growth (full history lives in cloud)
            if (this.db.financialTransactions.length > 500) this.db.financialTransactions.length = 500;
            this.save();
            return tx;
        },

        ensureSaleTransaction(order) {
            if (!order) return;
            if (order.paymentStatus !== 'paid') return;
            const exists = (this.db.financialTransactions || []).some(t => t.category === 'sale' && t.orderId === order.id);
            if (exists) return;

            this.recordFinancialTransaction({
                type: 'income',
                category: 'sale',
                amount: order.total || 0,
                method: order.paymentMethod || null,
                ref: order.reference,
                note: `Vente ${order.reference}`,
                orderId: order.id,
                posId: order.posId || null,
                cityId: order.cityId || null
            });
        },

        ensureCommissionTransaction(delivery) {
            if (!delivery) return;
            if (delivery.status !== 'livree') return;
            const exists = (this.db.financialTransactions || []).some(t => t.category === 'commission' && t.deliveryId === delivery.id);
            if (exists) return;

            const linkedOrder = delivery.orderId ? this.db.orders.find(o => o.id === delivery.orderId) : null;
            const commission = delivery.commission || this.calculateDeliveryCommission(delivery);

            this.recordFinancialTransaction({
                type: 'expense',
                category: 'commission',
                amount: commission,
                method: 'internal',
                ref: delivery.orderRef,
                note: `Commission livreur (${delivery.orderRef})`,
                orderId: delivery.orderId || null,
                deliveryId: delivery.id,
                posId: linkedOrder?.posId || null,
                cityId: linkedOrder?.cityId || null,
                settled: false
            });
        },

        reconcileFinance() {
            // Backfill ledger entries based on existing orders/deliveries
            // Ensure sales ledger for paid orders
            (this.db.orders || []).forEach(o => {
                if ((o.paymentStatus || '') === 'paid') this.ensureSaleTransaction(o);
            });
            // Ensure commissions ledger for delivered deliveries
            (this.db.deliveries || []).forEach(d => {
                if ((d.status || '') === 'livree') this.ensureCommissionTransaction(d);
            });
        },

        // Commissions par livreur
        getLivreurCommission(livreurId) {
            return this.db.livreurCommissions.find(c => c.livreurId === livreurId);
        },

        setLivreurCommission(livreurId, commissionPercent, commissionFixed = 0) {
            let c = this.db.livreurCommissions.find(x => x.livreurId === livreurId);
            if (!c) {
                this.db.livreurCommissions.push({
                    id: CORE.uid(),
                    livreurId,
                    commissionPercent: Number(commissionPercent || 0),
                    commissionFixed: Number(commissionFixed || 0),
                    createdAt: new Date().toISOString()
                });
            } else {
                c.commissionPercent = Number(commissionPercent || 0);
                c.commissionFixed = Number(commissionFixed || 0);
                c.updatedAt = new Date().toISOString();
            }
            this.save();
        },

        calculateDeliveryCommission(delivery) {
            const livreurCommission = this.getLivreurCommission(delivery.livreurId);
            if (livreurCommission) {
                // Si une commission personnalisée est définie, l'utiliser
                const percent = livreurCommission.commissionPercent || 5;
                const fixed = livreurCommission.commissionFixed || 0;
                const baseCommission = Math.round((delivery.amount || 0) * (percent / 100));
                return baseCommission + fixed;
            }
            // Sinon, utiliser la commission par défaut (5%)
            return Math.round((delivery.amount || 0) * 0.05);
        },

        // =====================
        // SYSTÈME D'ACTIVITÉ
        // =====================
        logActivity(action, entity, entityId, details = {}) {
            const user = CORE.state.currentUser;
            if (!user) {
                console.warn('⚠️ logActivity: Pas d\'utilisateur actuellement connecté');
                return;
            }

            const entityMap = {
                order: 'Commande',
                delivery: 'Livraison',
                return: 'Retour',
                client: 'Client',
                product: 'Produit',
                payment: 'Paiement',
                discount: 'Remise',
                stock: 'Stock',
                deposits: 'Dépôt',
                shift: 'Shift',
                inventory: 'Inventaire',
                user: 'Utilisateur'
            };

            const actionMap = {
                create: 'Créé',
                update: 'Modifié',
                delete: 'Supprimé',
                cancel: 'Annulé',
                refund: 'Remboursé',
                paid: 'Payé',
                delivered: 'Livré',
                rejected: 'Rejeté',
                approved: 'Approuvé',
                deposit: 'Dépôt',
                assign: 'Affectation',
                status_change: 'Changement statut',
                validate: 'Validation'
            };

            const log = {
                id: Utils.uid('LOG'),
                timestamp: new Date().toISOString(),
                userId: user.id,
                userName: user.name,
                userRole: user.role,
                posId: user.pos || null,
                action: actionMap[action] || action,
                entity: entityMap[entity] || entity,
                entityId,
                entityName: details.entityName || '',
                details: details.description || '',
                status: details.status || 'success',
                amount: details.amount || 0
            };

            if (!CORE.db.activityLogs) CORE.db.activityLogs = [];
            CORE.db.activityLogs.push(log);
            // Cap inline to avoid unbounded growth between saves
            if (CORE.db.activityLogs.length > 250) CORE.db.activityLogs = CORE.db.activityLogs.slice(-250);

            // Also record in auditLogs for the gestionnaire module
            if (!CORE.db.auditLogs) CORE.db.auditLogs = [];
            CORE.db.auditLogs.push({
                id: Utils.uid('AUDIT'),
                timestamp: new Date().toISOString(),
                userId: user.id,
                userName: user.name,
                userRole: user.role,
                action: action,
                entity: entity,
                entityId,
                entityName: details.entityName || '',
                details: details.description || '',
                before: null,
                after: null,
                status: 'recorded'
            });
            // Cap inline
            if (CORE.db.auditLogs.length > 250) CORE.db.auditLogs = CORE.db.auditLogs.slice(-250);

            CORE.save();
            console.log('✓ Activité enregistrée:', log.action, log.entity);
            return log;
        },

        getActivityLogs(filters = {}) {
            let logs = CORE.db.activityLogs || [];
            const currentUserRole = (CORE.state?.currentUser?.role || '').toLowerCase();

            // Un gestionnaire ne doit pas voir les activités PDG/Manager
            if (currentUserRole === 'gestionnaire') {
                logs = logs.filter(l => {
                    const role = (l?.userRole || '').toLowerCase();
                    return role !== 'pdg' && role !== 'manager';
                });
            }

            // Filtrer par POS
            if (filters.posId) {
                logs = logs.filter(l => l.posId == filters.posId);
            }

            // Filtrer par utilisateur
            if (filters.userId) {
                logs = logs.filter(l => l.userId === filters.userId);
            }

            // Filtrer par entité
            if (filters.entity) {
                logs = logs.filter(l => l.entity === filters.entity);
            }

            // Filtrer par date de début
            if (filters.startDate) {
                logs = logs.filter(l => new Date(l.timestamp) >= new Date(filters.startDate));
            }

            // Filtrer par date de fin
            if (filters.endDate) {
                logs = logs.filter(l => new Date(l.timestamp) <= new Date(filters.endDate));
            }

            // Filtrer par montant minimum
            if (filters.minAmount) {
                logs = logs.filter(l => l.amount >= filters.minAmount);
            }

            // Filtrer par montant maximum
            if (filters.maxAmount) {
                logs = logs.filter(l => l.amount <= filters.maxAmount);
            }

            // Recherche texte
            if (filters.search) {
                const q = filters.search.toLowerCase();
                logs = logs.filter(l =>
                    l.userName.toLowerCase().includes(q) ||
                    l.entity.toLowerCase().includes(q) ||
                    l.entityName.toLowerCase().includes(q) ||
                    l.details.toLowerCase().includes(q)
                );
            }

            // Trier par date décroissante
            return logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        },

        // =====================
        // DAILY DIGEST
        // =====================
        getDailyDigestConfig(posId) {
            const configs = this.db.dailyDigestConfigs || [];
            return configs.find(c => c.posId === posId) || null;
        },

        setDailyDigestConfig(posId, config) {
            if (!this.db.dailyDigestConfigs) this.db.dailyDigestConfigs = [];
            const index = this.db.dailyDigestConfigs.findIndex(c => c.posId === posId);

            const digestConfig = {
                id: config.id || Utils.uid('DGST'),
                posId,
                enabled: config.enabled !== false,
                sendTime: config.sendTime || '06:00',
                recipients: config.recipients || [],
                includeVentes: config.includeVentes !== false,
                includeDepots: config.includeDepots !== false,
                includeIncidents: config.includeIncidents !== false,
                includeKPIs: config.includeKPIs !== false,
                createdAt: config.createdAt || new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (index >= 0) {
                this.db.dailyDigestConfigs[index] = digestConfig;
            } else {
                this.db.dailyDigestConfigs.push(digestConfig);
            }

            this.save();
            return digestConfig;
        },

        generateDailyDigest(posId, date = null) {
            const targetDate = date ? new Date(date) : new Date();
            const startOfDay = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
            const endOfDay = new Date(startOfDay.getTime() + 24 * 60 * 60 * 1000);

            const config = this.getDailyDigestConfig(posId);
            if (!config || !config.enabled) return null;

            const pos = this.getPOS(posId);
            const digest = {
                id: Utils.uid('DIGEST'),
                posId,
                posName: pos ? pos.name : 'POS ' + posId,
                date: startOfDay.toISOString().split('T')[0],
                timestamp: new Date().toISOString(),
                status: 'pending'
            };

            // Ventes du jour
            if (config.includeVentes) {
                const orders = (this.db.orders || []).filter(o => {
                    if (o.posId !== posId) return false;
                    const oDate = new Date(o.createdAt);
                    return oDate >= startOfDay && oDate < endOfDay;
                });

                const deliveredOrders = orders.filter(o => o.status === 'delivered');
                const totalRevenue = deliveredOrders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);

                digest.ventes = {
                    total: orders.length,
                    delivered: deliveredOrders.length,
                    pending: orders.filter(o => o.status !== 'delivered').length,
                    revenue: totalRevenue,
                    avgValue: orders.length > 0 ? totalRevenue / orders.length : 0
                };
            }

            // Dépôts du jour
            if (config.includeDepots) {
                const deposits = (this.db.deposits || []).filter(d => {
                    if (d.posId !== posId) return false;
                    const dDate = new Date(d.timestamp);
                    return dDate >= startOfDay && dDate < endOfDay;
                });

                digest.depots = {
                    total: deposits.length,
                    totalAmount: deposits.reduce((sum, d) => sum + (d.amount || 0), 0),
                    avgDeposit: deposits.length > 0 ? deposits.reduce((sum, d) => sum + (d.amount || 0), 0) / deposits.length : 0
                };
            }

            // Incidents du jour
            if (config.includeIncidents) {
                const deliveries = (this.db.deliveries || []).filter(d => {
                    const order = (this.db.orders || []).find(o => o.id === d.orderId);
                    if (!order || order.posId !== posId) return false;
                    const dDate = new Date(d.createdAt);
                    return dDate >= startOfDay && dDate < endOfDay;
                });

                const incidents = deliveries.filter(d => ['probleme', 'annulea'].includes(d.status));

                digest.incidents = {
                    total: incidents.length,
                    problems: incidents.filter(d => d.status === 'probleme').length,
                    cancelled: incidents.filter(d => d.status === 'annulea').length,
                    details: incidents.map(d => ({
                        orderRef: d.orderRef,
                        status: d.status,
                        reason: d.recallReason || 'Non spécifié'
                    }))
                };
            }

            // KPIs clés
            if (config.includeKPIs) {
                const allDeliveries = (this.db.deliveries || []).filter(d => {
                    const order = (this.db.orders || []).find(o => o.id === d.orderId);
                    if (!order || order.posId !== posId) return false;
                    const dDate = new Date(d.createdAt);
                    return dDate >= startOfDay && dDate < endOfDay;
                });

                const delivered = allDeliveries.filter(d => d.status === 'livree');
                const onTimeDeliveries = delivered.filter(d => {
                    if (!d.assignedAt || !d.deliveredAt) return false;
                    const mins = (new Date(d.deliveredAt) - new Date(d.assignedAt)) / 60000;
                    return mins <= 60; // 60 minutes threshold
                });

                digest.kpis = {
                    deliveryRate: allDeliveries.length > 0 ? Math.round((delivered.length / allDeliveries.length) * 100) : 0,
                    onTimeRate: delivered.length > 0 ? Math.round((onTimeDeliveries.length / delivered.length) * 100) : 0,
                    avgDeliveryTime: delivered.length > 0
                        ? Math.round(delivered.reduce((sum, d) => {
                            if (!d.assignedAt || !d.deliveredAt) return sum;
                            return sum + (new Date(d.deliveredAt) - new Date(d.assignedAt)) / 60000;
                        }, 0) / delivered.length)
                        : 0,
                    customerSatisfaction: 'N/A' // À calculer selon votre logique
                };
            }

            // Log du digest
            if (!this.db.dailyDigestLogs) this.db.dailyDigestLogs = [];
            this.db.dailyDigestLogs.push(digest);
            this.save();

            return digest;
        },

        sendDailyDigest(posId) {
            const config = this.getDailyDigestConfig(posId);
            if (!config || !config.enabled || !config.recipients || config.recipients.length === 0) {
                return null;
            }

            const digest = this.generateDailyDigest(posId);
            if (!digest) return null;

            // Simuler l'envoi (dans une vraie app, utiliser nodemailer ou service email)
            config.recipients.forEach(recipient => {
                console.log(`📧 Digest envoyé à ${recipient} pour ${digest.posName}`);
                // En production: CORE.sendEmail(recipient, subject, htmlContent);
            });

            digest.status = 'sent';
            digest.sentAt = new Date().toISOString();
            this.save();

            return digest;
        },

        initDailyDigestScheduler() {
            // Vérifier et envoyer les digests planifiés chaque minute
            if (this._digestSchedulerId) clearInterval(this._digestSchedulerId);

            this._digestSchedulerId = setInterval(() => {
                const now = new Date();
                const currentTime = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');

                // Vérifier tous les POS configurés
                const configs = this.db.dailyDigestConfigs || [];
                configs.forEach(config => {
                    if (config.enabled && config.sendTime === currentTime) {
                        // Vérifier que le digest du jour n'a pas déjà été envoyé
                        const today = now.toISOString().split('T')[0];
                        const alreadySent = (this.db.dailyDigestLogs || []).some(log =>
                            log.posId === config.posId &&
                            log.date === today &&
                            log.status === 'sent'
                        );

                        if (!alreadySent) {
                            this.sendDailyDigest(config.posId);
                            console.log(`✅ Digest quotidien envoyé pour POS ${config.posId}`);
                        }
                    }
                });
            }, 60000); // Vérifier chaque minute
        },

        stopDailyDigestScheduler() {
            if (this._digestSchedulerId) {
                clearInterval(this._digestSchedulerId);
                this._digestSchedulerId = null;
            }
        },

        initPendingArrivalsScheduler() {
            // Vérifier les arrivées imminentes toutes les heures
            if (this._arrivalsSchedulerId) clearInterval(this._arrivalsSchedulerId);

            this._arrivalsSchedulerId = setInterval(() => {
                this.checkPendingArrivals();
            }, 3600000); // Vérifier chaque heure (3600000 ms)

            // Vérifier aussi au démarrage
            this.checkPendingArrivals();
        },

        stopPendingArrivalsScheduler() {
            if (this._arrivalsSchedulerId) {
                clearInterval(this._arrivalsSchedulerId);
                this._arrivalsSchedulerId = null;
            }
        },

        checkPendingArrivals() {
            const purchaseOrders = this.db.purchaseOrders || [];
            const now = new Date();

            purchaseOrders.forEach(order => {
                // Vérifier si la commande est en attente ou confirmée (pas reçue)
                if (!['pending', 'confirmed'].includes(order.status)) return;

                // Vérifier si une date de livraison a été définie
                if (!order.deliveryDate) return;

                const deliveryDate = new Date(order.deliveryDate);
                const reminderDays = order.reminderDays || 3;

                // Calculer la date à partir de laquelle on doit envoyer la notification
                const reminderDate = new Date(deliveryDate);
                reminderDate.setDate(reminderDate.getDate() - reminderDays);

                // Vérifier si on est dans la période de rappel
                if (now >= reminderDate && now < deliveryDate) {
                    // Vérifier si la notification a déjà été envoyée
                    const notificationKey = `arrival_reminder_${order.id}`;
                    const alreadyNotified = (this.db.notificationLog || []).some(log => log.key === notificationKey);

                    if (!alreadyNotified) {
                        const supplier = this.db.suppliers?.find(s => s.id === order.supplierId);
                        const product = this.db.products?.find(p => p.id === order.productId);
                        const daysUntilArrival = Math.ceil((deliveryDate - now) / (1000 * 60 * 60 * 24));

                        this.notify('info', `📦 Arrivée imminente: ${order.reference} (${product?.name || 'Produit'}) de ${supplier?.name || 'Fournisseur'} dans ${daysUntilArrival} jour(s)`, { purchaseOrderId: order.id, type: 'arrival_reminder' });

                        // Enregistrer que la notification a été envoyée
                        if (!this.db.notificationLog) this.db.notificationLog = [];
                        this.db.notificationLog.push({ key: notificationKey, sentAt: now.toISOString() });
                        this.save();
                    }
                }
            });
        },

        // =====================
        // CENTRE D'INCIDENTS
        // =====================
        createIncident(type, relatedEntity, relatedType, description, severity = 'moyenne') {
            // type: 'retard', 'annulation', 'litige'
            // relatedType: 'delivery' ou 'order'
            // severity: 'basse', 'moyenne', 'haute'
            const now = new Date();
            const incidentId = 'INC-' + now.getTime();

            // Déterminer les minutes SLA selon le type et la sévérité
            const slaMinutes = {
                'retard': { 'basse': 480, 'moyenne': 240, 'haute': 120 }, // 8h, 4h, 2h
                'annulation': { 'basse': 240, 'moyenne': 120, 'haute': 60 }, // 4h, 2h, 1h
                'litige': { 'basse': 1440, 'moyenne': 480, 'haute': 240 } // 24h, 8h, 4h
            };

            const minutes = slaMinutes[type]?.[severity] || 240;
            const slaEndTime = new Date(now.getTime() + minutes * 60000).toISOString();

            const incident = {
                id: incidentId,
                timestamp: now.toISOString(),
                type: type, // retard, annulation, litige
                severity: severity,
                relatedEntity: relatedEntity,
                relatedType: relatedType,
                assignedTo: null,
                assignedToName: null,
                status: 'ouvert', // ouvert, en-cours, résolu, fermé
                description: description,
                slaStartTime: now.toISOString(),
                slaEndTime: slaEndTime,
                slaMinutes: minutes,
                slaStatus: 'en-cours',
                notes: [],
                resolution: null,
                createdBy: this.state.currentUser?.id,
                createdByName: this.state.currentUser?.name,
                closedAt: null,
                closedBy: null,
                tags: [],
                priority: severity === 'haute' ? 1 : (severity === 'moyenne' ? 2 : 3)
            };

            this.db.incidents.push(incident);
            this.logActivity('create', 'incident', incidentId, {
                entityName: `Incident ${type}`,
                description: description,
                severity: severity
            });

            // Create notification for incident
            if (this.db.alertThresholds?.find(t => t.id === 'incident_open')?.enabled) {
                this.createNotification(
                    'incident_open',
                    `🚨 Incident Ouvert: ${type.toUpperCase()}`,
                    `${description} (Sévérité: ${severity})`,
                    severity === 'haute' ? 'critical' : 'high'
                );
            }

            this.save();
            return incident;
        },

        assignIncident(incidentId, userId) {
            const incident = this.db.incidents.find(i => i.id === incidentId);
            if (!incident) return null;

            const before = { assignedTo: incident.assignedTo, assignedToName: incident.assignedToName };
            const user = this.getUser(userId);

            incident.assignedTo = userId;
            incident.assignedToName = user?.name || 'Unknown';
            incident.status = incident.status === 'ouvert' ? 'en-cours' : incident.status;

            this.recordIncidentHistory(incidentId, 'assign', before,
                { assignedTo: userId, assignedToName: incident.assignedToName });
            this.logActivity('assign', 'incident', incidentId, {
                entityName: `Incident #${incidentId}`,
                description: `Assigné à ${incident.assignedToName}`,
                before, after: { assignedTo: userId }
            });
            this.save();
            return incident;
        },

        updateIncidentStatus(incidentId, newStatus) {
            const incident = this.db.incidents.find(i => i.id === incidentId);
            if (!incident) return null;

            const before = incident.status;
            incident.status = newStatus;

            if (newStatus === 'fermé' && !incident.closedAt) {
                incident.closedAt = new Date().toISOString();
                incident.closedBy = this.state.currentUser?.id;
            }

            // Calculer SLA status à la fermeture
            if (newStatus === 'résolu' || newStatus === 'fermé') {
                const closeTime = new Date();
                const slaEnd = new Date(incident.slaEndTime);
                incident.slaStatus = closeTime <= slaEnd ? 'atteint' : 'dépassé';
            }

            this.recordIncidentHistory(incidentId, 'status_change', { status: before }, { status: newStatus });
            this.logActivity('status_change', 'incident', incidentId, {
                entityName: `Incident #${incidentId}`,
                description: `Statut changé de ${before} à ${newStatus}`,
                before: { status: before },
                after: { status: newStatus }
            });
            this.save();
            return incident;
        },

        addIncidentNote(incidentId, text) {
            const incident = this.db.incidents.find(i => i.id === incidentId);
            if (!incident) return null;

            const note = {
                id: 'NOTE-' + new Date().getTime(),
                timestamp: new Date().toISOString(),
                userId: this.state.currentUser?.id,
                userName: this.state.currentUser?.name,
                text: text
            };

            incident.notes.push(note);
            this.recordIncidentHistory(incidentId, 'note_added', null, { note: text });
            this.logActivity('note', 'incident', incidentId, {
                entityName: `Incident #${incidentId}`,
                description: `Note ajoutée: ${text.substring(0, 50)}...`
            });
            this.save();
            return note;
        },

        setIncidentResolution(incidentId, resolution) {
            const incident = this.db.incidents.find(i => i.id === incidentId);
            if (!incident) return null;

            incident.resolution = resolution;
            if (incident.status === 'ouvert' || incident.status === 'en-cours') {
                incident.status = 'résolu';
            }

            this.recordIncidentHistory(incidentId, 'resolution_set', null, { resolution: resolution });
            this.logActivity('resolve', 'incident', incidentId, {
                entityName: `Incident #${incidentId}`,
                description: `Résolution: ${resolution.substring(0, 50)}...`
            });
            this.save();
            return incident;
        },

        recordIncidentHistory(incidentId, action, oldValue, newValue) {
            const historyEntry = {
                id: 'HIST-' + new Date().getTime(),
                incidentId: incidentId,
                timestamp: new Date().toISOString(),
                userId: this.state.currentUser?.id,
                userName: this.state.currentUser?.name,
                action: action, // assign, status_change, note_added, resolution_set, tag_added
                oldValue: oldValue,
                newValue: newValue,
                details: {}
            };

            this.db.incidentHistory.push(historyEntry);
            this.save();
            return historyEntry;
        },

        getIncidentStats() {
            const incidents = this.db.incidents || [];
            const now = new Date();

            return {
                total: incidents.length,
                open: incidents.filter(i => i.status === 'ouvert').length,
                inProgress: incidents.filter(i => i.status === 'en-cours').length,
                resolved: incidents.filter(i => i.status === 'résolu' || i.status === 'fermé').length,
                slaBreached: incidents.filter(i => i.slaStatus === 'dépassé').length,
                bySeverity: {
                    haute: incidents.filter(i => i.severity === 'haute').length,
                    moyenne: incidents.filter(i => i.severity === 'moyenne').length,
                    basse: incidents.filter(i => i.severity === 'basse').length
                },
                byType: {
                    retard: incidents.filter(i => i.type === 'retard').length,
                    annulation: incidents.filter(i => i.type === 'annulation').length,
                    litige: incidents.filter(i => i.type === 'litige').length
                },
                avgResolutionTime: this.calculateAvgResolutionTime()
            };
        },

        calculateAvgResolutionTime() {
            const incidents = this.db.incidents.filter(i => i.closedAt);
            if (incidents.length === 0) return 0;

            const totalTime = incidents.reduce((sum, i) => {
                const created = new Date(i.timestamp);
                const closed = new Date(i.closedAt);
                return sum + (closed - created);
            }, 0);

            return Math.round(totalTime / incidents.length / 60000); // en minutes
        },

        getIncidents(filters = {}) {
            let incidents = this.db.incidents || [];

            if (filters.status) {
                incidents = incidents.filter(i => i.status === filters.status);
            }
            if (filters.type) {
                incidents = incidents.filter(i => i.type === filters.type);
            }
            if (filters.severity) {
                incidents = incidents.filter(i => i.severity === filters.severity);
            }
            if (filters.slaStatus) {
                incidents = incidents.filter(i => i.slaStatus === filters.slaStatus);
            }
            if (filters.assignedTo) {
                incidents = incidents.filter(i => i.assignedTo === filters.assignedTo);
            }
            if (filters.search) {
                const q = filters.search.toLowerCase();
                incidents = incidents.filter(i =>
                    i.id.toLowerCase().includes(q) ||
                    i.description.toLowerCase().includes(q) ||
                    i.relatedEntity.toString().includes(q) ||
                    (i.assignedToName && i.assignedToName.toLowerCase().includes(q))
                );
            }
            if (filters.startDate) {
                const start = new Date(filters.startDate);
                incidents = incidents.filter(i => new Date(i.timestamp) >= start);
            }
            if (filters.endDate) {
                const end = new Date(filters.endDate);
                end.setHours(23, 59, 59, 999);
                incidents = incidents.filter(i => new Date(i.timestamp) <= end);
            }

            // Trier par priorité puis par date
            incidents.sort((a, b) => {
                if (a.priority !== b.priority) return a.priority - b.priority;
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            return incidents;
        },

        getIncidentHistory(incidentId) {
            return (this.db.incidentHistory || []).filter(h => h.incidentId === incidentId)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        },

        exportIncidents(filters = {}) {
            const incidents = this.getIncidents(filters);
            const headers = ['ID', 'Date', 'Type', 'Sévérité', 'Statut', 'SLA', 'Assigné à', 'Description', 'Résolution'];
            const rows = incidents.map(i => [
                i.id,
                new Date(i.timestamp).toLocaleString('fr-FR'),
                i.type,
                i.severity,
                i.status,
                i.slaStatus,
                i.assignedToName || 'Non assigné',
                (i.description || '').substring(0, 50),
                (i.resolution || '').substring(0, 50)
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => '"' + (cell || '').toString().replace(/"/g, '""') + '"').join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `incidents_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        },

        // =====================
        // BOÎTE À OUTILS MANAGER
        // =====================
        initDefaultMessageTemplates() {
            if ((this.db.messageTemplates || []).length > 0) return;

            const templates = [
                {
                    id: 'tpl_delivery_confirm',
                    name: 'Confirmation de livraison',
                    type: 'whatsapp',
                    category: 'delivery',
                    content: 'Bonjour {{name}}, votre commande {{orderRef}} a été confiée au livreur {{driverName}} qui sera chez vous en {{estimatedTime}}min. Numéro de suivi: {{trackingId}}',
                    variables: ['name', 'orderRef', 'driverName', 'estimatedTime', 'trackingId']
                },
                {
                    id: 'tpl_delivery_reminder',
                    name: 'Rappel de livraison',
                    type: 'sms',
                    category: 'reminder',
                    content: '{{name}}: Votre commande {{orderRef}} arrive dans 30min. Assurez-vous d\'être disponible.',
                    variables: ['name', 'orderRef']
                },
                {
                    id: 'tpl_delay_alert',
                    name: 'Alerte de retard',
                    type: 'whatsapp',
                    category: 'alert',
                    content: 'Désolé {{name}}, votre livraison {{orderRef}} subit un léger retard. Nous nous excusons. ETA: {{newETA}}',
                    variables: ['name', 'orderRef', 'newETA']
                },
                {
                    id: 'tpl_resolution_confirm',
                    name: 'Confirmation de résolution',
                    type: 'whatsapp',
                    category: 'resolution',
                    content: 'Merci {{name}}, votre incident a été résolu. Voici le détail: {{resolution}}. N\'hésitez pas à nous recontacter.',
                    variables: ['name', 'resolution']
                },
                {
                    id: 'tpl_payment_reminder',
                    name: 'Rappel paiement COD',
                    type: 'sms',
                    category: 'reminder',
                    content: 'Montant à payer à la livraison: {{amount}} FCFA. Commande: {{orderRef}}',
                    variables: ['amount', 'orderRef']
                }
            ];

            templates.forEach(t => {
                t.createdBy = 'system';
                this.db.messageTemplates.push(t);
            });
            this.save();
        },

        getMessageTemplates(type = null, category = null) {
            let templates = this.db.messageTemplates || [];

            if (type) {
                templates = templates.filter(t => t.type === type);
            }
            if (category) {
                templates = templates.filter(t => t.category === category);
            }

            return templates;
        },

        saveMessageTemplate(template) {
            const existing = this.db.messageTemplates.find(t => t.id === template.id);
            if (existing) {
                Object.assign(existing, template);
            } else {
                template.id = 'tpl_' + new Date().getTime();
                template.createdBy = this.state.currentUser?.id;
                this.db.messageTemplates.push(template);
            }
            this.save();
            return template;
        },

        sendMessage(recipientId, templateId, variables = {}) {
            const template = this.db.messageTemplates.find(t => t.id === templateId);
            const recipient = this.getUser(recipientId);

            if (!template || !recipient) return null;

            // Remplacer les variables
            let content = template.content;
            Object.entries(variables).forEach(([key, value]) => {
                content = content.replace(new RegExp(`{{${key}}}`, 'g'), value);
            });

            const message = {
                id: 'MSG-' + new Date().getTime(),
                timestamp: new Date().toISOString(),
                recipientId: recipientId,
                recipientName: recipient.name,
                recipientPhone: recipient.phone,
                type: template.type,
                status: 'sent',
                content: content,
                templateId: templateId,
                sentBy: this.state.currentUser?.id,
                sentByName: this.state.currentUser?.name
            };

            this.db.messageLog.push(message);
            this.logActivity('send_message', 'message', message.id, {
                entityName: `Message ${template.type} à ${recipient.name}`,
                description: content.substring(0, 50)
            });
            this.save();
            return message;
        },

        initiateCall(recipientId, reason = '') {
            const recipient = this.getUser(recipientId);
            if (!recipient || !recipient.phone) {
                return { error: 'Numéro non disponible' };
            }

            const call = {
                id: 'CALL-' + new Date().getTime(),
                timestamp: new Date().toISOString(),
                recipientId: recipientId,
                recipientName: recipient.name,
                recipientPhone: recipient.phone,
                initiatedBy: this.state.currentUser?.id,
                initiatedByName: this.state.currentUser?.name,
                status: 'initiated',
                duration: 0,
                reason: reason
            };

            this.db.messageLog.push(call);
            this.logActivity('call', 'communication', call.id, {
                entityName: `Appel à ${recipient.name}`,
                description: reason
            });
            this.save();
            return call;
        },

        quickAssignDelivery(deliveryId, userId) {
            const d = this.db.deliveries.find(x => x.id === deliveryId);
            const user = this.getUser(userId);
            if (!d || !user) return null;

            const oldLivreur = d.livreurId ? this.getUser(d.livreurId)?.name : 'Non assigné';
            d.livreurId = userId;
            d.livreurName = user.name;
            d.livreurPhone = user.phone;
            d.assignedAt = new Date().toISOString();
            d.status = 'assigned';

            this.logActivity('assign', 'delivery', d.id, {
                entityName: `Commande ${d.orderRef}`,
                description: `Assignée à ${user.name}`,
                before: { livreur: oldLivreur },
                after: { livreur: user.name }
            });

            this.save();
            return d;
        },

        quickRecallDelivery(deliveryId, reason = '') {
            const d = this.db.deliveries.find(x => x.id === deliveryId);
            if (!d) return null;

            const oldLivreur = d.livreurName || 'N/A';
            d.status = 'recalled';
            d.recalledAt = new Date().toISOString();
            d.recallReason = reason;
            d.previousLivreurId = d.livreurId;
            d.livreurId = null;
            d.livreurName = null;

            this.logActivity('recall', 'delivery', d.id, {
                entityName: `Commande ${d.orderRef}`,
                description: `Rappelée de ${oldLivreur}. Raison: ${reason}`,
                before: { status: 'assigned', livreur: oldLivreur },
                after: { status: 'recalled' }
            });

            this.save();
            return d;
        },

        notifyUser(userId, title, message, type = 'info') {
            // type: info, warning, error, success
            const notification = {
                id: 'NOTIF-' + new Date().getTime(),
                timestamp: new Date().toISOString(),
                userId: userId,
                title: title,
                message: message,
                type: type,
                read: false
            };

            if (!this.db.notifications) this.db.notifications = [];
            this.db.notifications.push(notification);
            this.save();
            return notification;
        },

        openTaxesReport(userId) {
            // Générer rapport taxes pour un utilisateur
            const user = this.getUser(userId);
            if (!user) return null;

            const txs = (this.db.financialTransactions || []).filter(t => t.userId === userId);
            const sales = txs.filter(t => t.type === 'sale');
            const commissions = txs.filter(t => t.type === 'commission');
            const deposits = txs.filter(t => t.type === 'deposit');

            const totalSales = sales.reduce((sum, t) => sum + t.amount, 0);
            const totalCommissions = commissions.reduce((sum, t) => sum + t.amount, 0);
            const totalDeposits = deposits.reduce((sum, t) => sum + t.amount, 0);

            return {
                userId: user.id,
                userName: user.name,
                userRole: user.role,
                periodStart: new Date(new Date().setDate(1)).toISOString(),
                periodEnd: new Date().toISOString(),
                totalSales: totalSales,
                totalCommissions: totalCommissions,
                totalDeposits: totalDeposits,
                netIncome: totalSales - totalDeposits,
                taxableAmount: Math.max(0, totalSales * 0.15),
                transactions: txs
            };
        },

        // =====================
        // DASHBOARD FINANCIER
        // =====================
        getFinancialMetrics(userId, startDate = null, endDate = null, posId = null) {
            let txs = (this.db.financialTransactions || []).filter(t => t.userId === userId);

            // Filtrer par POS si spécifié
            if (posId) {
                txs = txs.filter(t => t.posId == posId || !t.posId);
            }

            let filtered = txs;
            if (startDate) {
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
                filtered = filtered.filter(t => new Date(t.createdAt) >= start);
            }
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                filtered = filtered.filter(t => new Date(t.createdAt) <= end);
            }

            const income = filtered.filter(t => t.type === 'income').reduce((sum, t) => sum + (t.amount || 0), 0);
            const expenses = filtered.filter(t => t.type === 'expense').reduce((sum, t) => sum + (t.amount || 0), 0);
            const profit = income - expenses;

            return {
                totalIncome: income,
                totalExpenses: expenses,
                netProfit: profit,
                profitMargin: income > 0 ? ((profit / income) * 100).toFixed(2) : 0,
                transactionCount: filtered.length,
                averageTransaction: filtered.length > 0 ? (income / filtered.length).toFixed(2) : 0
            };
        },

        getCashFlowByPeriod(userId, period = 'daily', posId = null) {
            // period: 'daily', 'weekly', 'monthly'
            let txs = (this.db.financialTransactions || []).filter(t => t.userId === userId);

            // Filtrer par POS si spécifié
            if (posId) {
                txs = txs.filter(t => t.posId == posId || !t.posId);
            }

            const cashFlow = {};

            txs.forEach(t => {
                const date = new Date(t.createdAt);
                let key;

                if (period === 'daily') {
                    key = date.toISOString().split('T')[0];
                } else if (period === 'weekly') {
                    const week = Math.floor((date.getDate() + 6) / 7);
                    const month = date.getMonth() + 1;
                    const year = date.getFullYear();
                    key = `${year}-W${week < 10 ? '0' + week : week}`;
                } else if (period === 'monthly') {
                    key = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                }

                if (!cashFlow[key]) {
                    cashFlow[key] = { income: 0, expenses: 0, net: 0 };
                }

                if (t.type === 'income') {
                    cashFlow[key].income += t.amount || 0;
                } else {
                    cashFlow[key].expenses += t.amount || 0;
                }
                cashFlow[key].net = cashFlow[key].income - cashFlow[key].expenses;
            });

            return cashFlow;
        },

        getProfitByClient(userId) {
            const orders = (this.db.orders || []).filter(o => o.vendeurId === userId);
            const profit = {};

            orders.forEach(order => {
                const clientId = order.clientId || 'unknown';
                const clientName = order.clientName || 'Client inconnu';

                // Trouver le revenu de cette commande
                const sale = (this.db.financialTransactions || []).find(t =>
                    t.userId === userId && t.category === 'sale' && t.orderId === order.id
                );
                const revenue = sale ? sale.amount : order.total || 0;

                // Trouver les commissions associées à cette commande
                const delivery = (this.db.deliveries || []).find(d => d.orderId === order.id);
                const commission = delivery ? (
                    (this.db.financialTransactions || []).find(t =>
                        t.userId === userId && t.category === 'commission' && t.deliveryId === delivery.id
                    )?.amount || 0
                ) : 0;

                if (!profit[clientId]) {
                    profit[clientId] = { name: clientName, revenue: 0, expenses: 0, profit: 0, orderCount: 0 };
                }
                profit[clientId].revenue += revenue;
                profit[clientId].expenses += commission;
                profit[clientId].profit = profit[clientId].revenue - profit[clientId].expenses;
                profit[clientId].orderCount++;
            });

            return Object.values(profit).sort((a, b) => b.profit - a.profit);
        },

        getProfitByCategory(userId) {
            const orders = (this.db.orders || []).filter(o => o.vendeurId === userId);
            const profit = {};

            orders.forEach(order => {
                const categoryId = order.categoryId || 'unknown';
                const categoryName = order.categoryName || 'Catégorie inconnue';

                const sale = (this.db.financialTransactions || []).find(t =>
                    t.userId === userId && t.category === 'sale' && t.orderId === order.id
                );
                const revenue = sale ? sale.amount : order.total || 0;

                if (!profit[categoryId]) {
                    profit[categoryId] = { name: categoryName, revenue: 0, expenses: 0, profit: 0, orderCount: 0 };
                }
                profit[categoryId].revenue += revenue;
                profit[categoryId].orderCount++;
            });

            Object.keys(profit).forEach(key => {
                profit[key].profit = profit[key].revenue - profit[key].expenses;
            });

            return Object.values(profit).sort((a, b) => b.profit - a.profit);
        },

        getFinancialStatement(userId, startDate = null, endDate = null, posId = null) {
            const metrics = this.getFinancialMetrics(userId, startDate, endDate, posId);
            let txs = (this.db.financialTransactions || []).filter(t => t.userId === userId);

            // Filtrer par POS si spécifié
            if (posId) {
                txs = txs.filter(t => t.posId == posId || !t.posId);
            }

            let filtered = txs;
            if (startDate) {
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
                filtered = filtered.filter(t => new Date(t.createdAt) >= start);
            }
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                filtered = filtered.filter(t => new Date(t.createdAt) <= end);
            }

            // Grouper par catégorie
            const byCategory = {};
            filtered.forEach(t => {
                const cat = t.category || 'other';
                if (!byCategory[cat]) {
                    byCategory[cat] = { income: 0, expenses: 0 };
                }
                if (t.type === 'income') {
                    byCategory[cat].income += t.amount || 0;
                } else {
                    byCategory[cat].expenses += t.amount || 0;
                }
            });

            const taxRate = 0.19; // 19% VAT
            const grossProfit = metrics.totalIncome - metrics.totalExpenses;
            const taxes = Math.round(grossProfit * taxRate);
            const netProfit = grossProfit - taxes;

            return {
                period: { startDate, endDate },
                revenues: {
                    sales: byCategory.sale?.income || 0,
                    other: byCategory.other?.income || 0,
                    total: metrics.totalIncome
                },
                expenses: {
                    commissions: byCategory.commission?.expenses || 0,
                    operational: byCategory.expense?.expenses || 0,
                    other: byCategory.other?.expenses || 0,
                    total: metrics.totalExpenses
                },
                grossProfit,
                taxRate: (taxRate * 100).toFixed(0) + '%',
                taxes,
                netProfit,
                profitMargin: metrics.profitMargin
            };
        },

        calculateTaxesOwed(userId, startDate = null, endDate = null, posId = null) {
            const statement = this.getFinancialStatement(userId, startDate, endDate, posId);
            const vendeur = CORE.db.users.find(u => u.id === userId);

            // Utiliser le taux personnalisé si défini, sinon utiliser le taux par défaut
            let taxRate = statement.taxRate;
            if (vendeur && vendeur.customTaxRate !== undefined && vendeur.customTaxRate !== null) {
                taxRate = vendeur.customTaxRate / 100; // Convertir le pourcentage en décimal
            }

            const taxesOwed = Math.round(statement.grossProfit * taxRate);

            // Utiliser la date d'échéance personnalisée si définie
            let dueDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            if (vendeur && vendeur.customDueDate) {
                dueDate = vendeur.customDueDate;
            }

            return {
                grossIncome: statement.revenues.total,
                taxableIncome: statement.grossProfit,
                taxRate: (taxRate * 100).toFixed(0) + '%',
                taxesOwed: taxesOwed,
                dueDate: dueDate
            };
        },

        // =====================
        // RECONCILIATION SYSTEM
        // =====================
        getDepositReconciliation(posId, dateFrom = null, dateTo = null) {
            const deposits = (this.db.deposits || []).filter(d => d.posId === posId && d.status === 'enregistre');

            let filtered = deposits;
            if (dateFrom) {
                const start = new Date(dateFrom);
                filtered = filtered.filter(d => new Date(d.timestamp) >= start);
            }
            if (dateTo) {
                const end = new Date(dateTo);
                end.setHours(23, 59, 59, 999);
                filtered = filtered.filter(d => new Date(d.timestamp) <= end);
            }

            // P3-5: Build orderRef â†’ order Map once (O(n) instead of O(nÂ²))
            const ordersByRef = new Map();
            (this.db.orders || []).forEach(o => { if (o.orderRef) ordersByRef.set(o.orderRef, o); });

            return filtered.map(deposit => {
                // VÃ©rifier les commandes dÃ©clarÃ©es
                const ordersInDeposit = (deposit.ordersRef || []).map(ref => ordersByRef.get(ref)).filter(Boolean);

                // Calculer le revenu réel de ces commandes
                const actualRevenue = ordersInDeposit.reduce((sum, o) => sum + (o.total || 0), 0);
                const declaredAmount = deposit.amount || 0;
                const discrepancy = declaredAmount - actualRevenue;

                // Vérifier le compte de commandes
                const declaredCount = deposit.ordersCount || 0;
                const actualCount = ordersInDeposit.length;
                const orderMismatch = declaredCount - actualCount;

                // Statut de l'écart
                let anomalyType = 'OK';
                if (Math.abs(discrepancy) > 1000) anomalyType = 'CRITICAL_AMOUNT';
                if (orderMismatch !== 0) anomalyType = 'ORDER_MISMATCH';
                if (discrepancy > 0) anomalyType = 'OVER_DECLARED';
                if (discrepancy < 0) anomalyType = 'UNDER_DECLARED';

                return {
                    depositId: deposit.id,
                    timestamp: deposit.timestamp,
                    livreurName: deposit.livreurName,
                    vendeurName: deposit.vendeurName,
                    declaredAmount,
                    actualRevenue,
                    discrepancy,
                    discrepancyPercent: declaredAmount > 0 ? ((discrepancy / declaredAmount) * 100).toFixed(2) : 0,
                    declaredCount,
                    actualCount,
                    orderMismatch,
                    ordersRef: deposit.ordersRef || [],
                    // P3-5: Use Map-based lookup instead of nested filter+find
                    missingOrders: deposit.ordersRef ? deposit.ordersRef
                        .map(ref => ordersByRef.get(ref))
                        .filter(o => o && !ordersInDeposit.find(od => od.id === o.id))
                        .map(o => ({id: o.id, ref: o.orderRef, amount: o.total})) : [],
                    anomalyType,
                    anomalySeverity: anomalyType === 'OK' ? 'green' : anomalyType === 'CRITICAL_AMOUNT' ? 'red' : 'amber',
                    notes: deposit.notes || ''
                };
            });
        },

        getReconciliationSummary(posId, dateFrom = null, dateTo = null) {
            const reconciliations = this.getDepositReconciliation(posId, dateFrom, dateTo);

            const summary = {
                totalDeposits: reconciliations.length,
                totalDeclared: reconciliations.reduce((sum, r) => sum + r.declaredAmount, 0),
                totalActual: reconciliations.reduce((sum, r) => sum + r.actualRevenue, 0),
                totalDiscrepancy: reconciliations.reduce((sum, r) => sum + r.discrepancy, 0),
                totalOrderMismatch: reconciliations.reduce((sum, r) => sum + Math.abs(r.orderMismatch), 0),
                anomalies: {
                    ok: reconciliations.filter(r => r.anomalyType === 'OK').length,
                    overDeclared: reconciliations.filter(r => r.anomalyType === 'OVER_DECLARED').length,
                    underDeclared: reconciliations.filter(r => r.anomalyType === 'UNDER_DECLARED').length,
                    criticalAmount: reconciliations.filter(r => r.anomalyType === 'CRITICAL_AMOUNT').length,
                    orderMismatch: reconciliations.filter(r => r.anomalyType === 'ORDER_MISMATCH').length
                },
                recommendations: []
            };

            // Générer des recommandations
            if (summary.anomalies.overDeclared > 0) {
                summary.recommendations.push('⚠️ Dépôts suraugmentés détectés - Vérifier les montants déclarés');
            }
            if (summary.anomalies.underDeclared > 0) {
                summary.recommendations.push('⚠️ Dépôts sous-déclarés - Rechercher les commandes manquantes');
            }
            if (summary.anomalies.criticalAmount > 0) {
                summary.recommendations.push('🔴 Écarts critiques > 1000 FCFA - Enquête recommandée');
            }
            if (summary.anomalies.orderMismatch > 0) {
                summary.recommendations.push('❌ Mismatch commandes-dépôts - Validation urgente');
            }
            if (summary.anomalies.ok === summary.totalDeposits) {
                summary.recommendations.push('✅ Tous les dépôts sont réconciliés correctement');
            }

            return summary;
        },

        validateDeposits(posId, depositIds = []) {
            // Marquer les dépôts comme approuvés après réconciliation
            const idsToValidate = depositIds.length > 0 ? depositIds :
                (this.db.deposits || [])
                    .filter(d => d.posId === posId && d.status === 'enregistre')
                    .map(d => d.id);

            idsToValidate.forEach(id => {
                const idx = (this.db.deposits || []).findIndex(d => d.id === id);
                if (idx !== -1) {
                    this.db.deposits[idx].status = 'approuve';
                    this.db.deposits[idx].validatedAt = new Date().toISOString();
                }
            });

            this.save();
            return {
                validatedCount: idsToValidate.length,
                successMessage: `${idsToValidate.length} dépôt(s) validé(s)`
            };
        },

        // Getter pour accéder à l'utilisateur courant via CORE.user
        get user() {
            const u = this.state.currentUser;
            // Normaliser pos depuis storeId si manquant
            if (u && !u.pos && u.storeId) { u.pos = String(u.storeId); }
            return u;
        }
    };

    // Expose CORE for optional integrations (e.g. Maps)
    window.CORE = CORE;

    // =========================================================
    // OFFLINE MANAGER - Gestion avancée du mode hors-ligne
    // =========================================================
    const OfflineManager = {
        // Configuration
        config: {
            maxRetries: 5,
            baseRetryDelay: 1000, // ms
            maxRetryDelay: 60000, // 1 minute max
            autoSyncInterval: 300000, // 5 min (PERF: reduced from 60s — now handled by App periodic sync)
            minAutoSyncInterval: 60000,
            maxAutoSyncInterval: 600000,
            batchSize: 25,
            maxQueueSize: 500
        },

        // État
        state: {
            isOnline: navigator.onLine,
            isSyncing: false,
            autoSyncTimer: null,
            lastSyncAttempt: null,
            consecutiveFailures: 0
        },

        // Initialiser le gestionnaire
        init() {
            // Écouter les événements online/offline
            window.addEventListener('online', () => this.handleOnline());
            window.addEventListener('offline', () => this.handleOffline());

            // PERF: Don't start OfflineManager auto-sync — App._finishInit periodic sync handles it.
            // Having two independent sync timers doubles the request volume.
            // OfflineManager only syncs pendingSyncs queue on reconnect (handleOnline).
            // if (navigator.onLine) { this.startAutoSync(); }

            // Initialiser la structure dans CORE.db
            if (!CORE.db.pendingSyncs) CORE.db.pendingSyncs = [];
            if (!CORE.db.syncHistory) CORE.db.syncHistory = [];

            // PERF: Cloud pull at startup is handled by App.init() cloud-first flow.
            // OfflineManager no longer does its own duplicate sync to save ~15 requests.
            console.log('[OFFLINE-MGR] Init done — startup sync delegated to App.init cloud-first');
        },

        // Événement: connexion rétablie
        handleOnline() {
            this.state.isOnline = true;
            CORE.state.isOnline = true;
            this.state.consecutiveFailures = 0;

            UI.toast('🌐 Connexion rétablie!', 'success');

            // PERF: On reconnect, use syncAllFromCloud (incremental via /sync/meta)
            // instead of syncFromApi which hits 7 REST endpoints.
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() && API.syncAllFromCloud) {
                API.syncAllFromCloud(true).then(function() {
                    console.log('[CLOUD] ✅ Données cloud resynchronisées après reconnexion');
                    if (typeof CORE !== 'undefined') CORE.save(true);
                    if (typeof App !== 'undefined' && App.rerender) App.rerender();
                }).catch(function(err) {
                    console.warn('[CLOUD] ⚠️ Pull cloud échoué après reconnexion:', err.message || err);
                });
            }

            // PERF: Don't start auto-sync — the main periodic sync in App._finishInit handles it
            // this.startAutoSync();

            // Tenter une sync immédiate si des actions sont en attente
            const pendingCount = this.getPendingCount();
            if (pendingCount > 0) {
                setTimeout(() => {
                    this.syncAll();
                }, 2000);
            }

            App.rerender();
        },

        // Événement: connexion perdue
        handleOffline() {
            this.state.isOnline = false;
            CORE.state.isOnline = false;

            UI.toast('⚠️ Mode Hors Ligne - Les actions seront synchronisées au retour de la connexion', 'warning');

            // Arrêter l'auto-sync
            this.stopAutoSync();

            App.rerender();
        },

        // Démarrer la synchronisation automatique périodique
        startAutoSync() {
            this.stopAutoSync();
            this.scheduleNext();
        },

        // Adaptive sync scheduling: backs off when idle, speeds up when busy
        scheduleNext(delay) {
            this.stopAutoSync();
            var cfg = this.config;
            var interval = delay || cfg.autoSyncInterval;
            var self = this;
            this.state.autoSyncTimer = setTimeout(function() {
                if (self.state.isOnline && !self.state.isSyncing && self.getPendingCount() > 0) {
                    self.syncAll().then(function(result) {
                        var pending = self.getPendingCount();
                        var next = cfg.autoSyncInterval;
                        if (pending > 20) next = cfg.minAutoSyncInterval;
                        else if (pending === 0) next = cfg.maxAutoSyncInterval;
                        self.scheduleNext(next);
                    }).catch(function() { self.scheduleNext(cfg.maxAutoSyncInterval); });
                } else {
                    self.scheduleNext(self.getPendingCount() === 0 ? cfg.maxAutoSyncInterval : cfg.autoSyncInterval);
                }
            }, interval);
        },

        // Arrêter la synchronisation automatique
        stopAutoSync() {
            if (this.state.autoSyncTimer) {
                clearInterval(this.state.autoSyncTimer);
                this.state.autoSyncTimer = null;
            }
        },

        // Ajouter une action à la file d'attente
        enqueue(action) {
            if (!CORE.db.pendingSyncs) CORE.db.pendingSyncs = [];

            // Vérifier la limite
            if (CORE.db.pendingSyncs.length >= this.config.maxQueueSize) {
                UI.toast('⚠️ File d\'attente pleine - supprimez d\'anciennes actions', 'error');
                return false;
            }

            const queueItem = {
                id: CORE.uid() + Math.random().toString(36).substr(2, 9),
                ...action,
                queuedAt: new Date().toISOString(),
                retryCount: 0,
                status: 'pending', // pending, syncing, failed, success
                lastError: null
            };

            CORE.db.pendingSyncs.push(queueItem);
            CORE.save();

            // Notifier l'utilisateur
            this.updateIndicator();

            return queueItem.id;
        },

        // Obtenir le nombre d'actions en attente
        getPendingCount() {
            return (CORE.db.pendingSyncs || []).filter(s => s.status !== 'success').length;
        },

        // Obtenir toutes les actions en attente
        getPendingActions() {
            return (CORE.db.pendingSyncs || []).filter(s => s.status !== 'success');
        },

        // Synchroniser toutes les actions en attente
        async syncAll() {
            if (!this.state.isOnline) {
                UI.toast('⚠️ Impossible de synchroniser: hors ligne', 'warning');
                return { success: false, synced: 0, failed: 0 };
            }

            if (this.state.isSyncing) {
                return { success: false, synced: 0, failed: 0, reason: 'already_syncing' };
            }

            const pending = this.getPendingActions();
            if (pending.length === 0) {
                return { success: true, synced: 0, failed: 0 };
            }

            this.state.isSyncing = true;
            this.state.lastSyncAttempt = new Date().toISOString();
            this.updateIndicator('syncing', pending.length);

            let synced = 0;
            let failed = 0;

            for (let i = 0; i < pending.length; i++) {
                const action = pending[i];


                // Batch yield: pause briefly every batchSize items to keep UI responsive
                if (i > 0 && i % (this.config.batchSize || 25) === 0) {
                    await new Promise(function(r) { setTimeout(r, 50); });
                }
                this.updateIndicator('syncing', pending.length, i + 1);

                try {
                    // Simuler la synchronisation (remplacer par vraie API)
                    await this.syncAction(action);

                    // Marquer comme synchronisé
                    action.status = 'success';
                    action.syncedAt = new Date().toISOString();
                    synced++;

                } catch (error) {
                    action.retryCount++;
                    action.lastError = error.message || 'Erreur inconnue';

                    if (action.retryCount >= this.config.maxRetries) {
                        action.status = 'failed';
                        failed++;
                    } else {
                        action.status = 'pending';
                    }
                }
            }

            // Nettoyer les actions réussies
            CORE.db.pendingSyncs = CORE.db.pendingSyncs.filter(s => s.status !== 'success');

            // Sauvegarder l'historique de sync
            if (!CORE.db.syncHistory) CORE.db.syncHistory = [];
            CORE.db.syncHistory.push({
                date: new Date().toISOString(),
                synced,
                failed,
                remaining: CORE.db.pendingSyncs.length
            });

            // Limiter l'historique à 50 entrées
            if (CORE.db.syncHistory.length > 50) {
                CORE.db.syncHistory = CORE.db.syncHistory.slice(-50);
            }

            CORE.state.lastSync = new Date().toISOString();
            CORE.save();

            this.state.isSyncing = false;

            if (failed > 0) {
                this.state.consecutiveFailures++;
                this.updateIndicator('error', failed);
                UI.toast(`⚠️ ${synced} synchronisée(s), ${failed} échouée(s)`, 'warning');
            } else if (synced > 0) {
                this.state.consecutiveFailures = 0;
                this.updateIndicator('success', synced);
                UI.toast(`✅ ${synced} action(s) synchronisée(s)`, 'success');
            }

            App.rerender();

            return { success: failed === 0, synced, failed };
        },

        // Synchroniser une action individuelle (à adapter selon l'API réelle)
        async syncAction(action) {
            // === REAL CLOUD SYNC via RayaAPI ===
            if (typeof API === 'undefined' || !API.isAuthenticated || !API.isAuthenticated()) {
                throw new Error('Non authentifié - impossible de synchroniser');
            }
            if (!navigator.onLine) {
                throw new Error('Hors ligne - synchronisation reportée');
            }

            var collection = action.collection;
            var actionType = action.type; // 'create', 'update', 'delete'
            var data = action.data;

            if (!collection || !actionType || !data) {
                console.warn('[SYNC] Action invalide:', action);
                return true; // Mark as done to avoid retry loop
            }

            // Map to API endpoint via collectionMap
            var endpoint = API.collectionMap ? API.collectionMap[collection] : null;
            if (!endpoint) {
                console.warn('[SYNC] Collection non mappée:', collection);
                return true; // No API endpoint for this collection, skip
            }

            try {
                // Use the existing pushToApi which handles format conversion
                await API.pushToApi(collection, actionType, data);
                console.log('[SYNC] ✅ ' + actionType + ' ' + collection + ' #' + (data.id || '?'));
                return true;
            } catch (err) {
                console.error('[SYNC] ❌ ' + actionType + ' ' + collection + ':', err.message || err);
                throw err; // Re-throw so the retry logic in syncAll() can handle it
            }
        },

        // Supprimer une action de la file
        removeFromQueue(actionId) {
            const index = CORE.db.pendingSyncs.findIndex(a => a.id === actionId);
            if (index !== -1) {
                CORE.db.pendingSyncs.splice(index, 1);
                CORE.save();
                this.updateIndicator();
                return true;
            }
            return false;
        },

        // Vider la file d'attente
        clearQueue() {
            CORE.db.pendingSyncs = [];
            CORE.save();
            this.updateIndicator();
            UI.toast('File d\'attente vidée', 'info');
        },

        // Réessayer les actions échouées
        async retryFailed() {
            const failed = (CORE.db.pendingSyncs || []).filter(s => s.status === 'failed');
            failed.forEach(a => {
                a.status = 'pending';
                a.retryCount = 0;
            });
            CORE.save();

            if (failed.length > 0) {
                return this.syncAll();
            }
            return { success: true, synced: 0, failed: 0 };
        },

        // Mettre à jour l'indicateur visuel
        updateIndicator(status = 'idle', count = 0, current = 0) {
            const indicator = document.getElementById('offline-indicator');
            if (!indicator) return;

            const pendingCount = this.getPendingCount();
            const failedCount = (CORE.db.pendingSyncs || []).filter(s => s.status === 'failed').length;

            if (!this.state.isOnline) {
                indicator.innerHTML = `
                    <div class="flex items-center gap-2 px-3 py-2 bg-amber-500 text-white rounded-full shadow-lg cursor-pointer hover:bg-amber-600 transition" onclick="OfflineManager.showQueueModal()">
                        <i data-lucide="wifi-off" class="w-4 h-4"></i>
                        <span class="text-xs font-black">Hors ligne${pendingCount > 0 ? ` (${pendingCount})` : ''}</span>
                    </div>`;
            } else if (status === 'syncing') {
                indicator.innerHTML = `
                    <div class="flex items-center gap-2 px-3 py-2 bg-blue-500 text-white rounded-full shadow-lg animate-pulse">
                        <i data-lucide="refresh-cw" class="w-4 h-4 animate-spin"></i>
                        <span class="text-xs font-black">Sync ${current}/${count}...</span>
                    </div>`;
            } else if (status === 'error' || failedCount > 0) {
                indicator.innerHTML = `
                    <div class="flex items-center gap-2 px-3 py-2 bg-red-500 text-white rounded-full shadow-lg cursor-pointer hover:bg-red-600 transition" onclick="OfflineManager.showQueueModal()">
                        <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                        <span class="text-xs font-black">${failedCount} échec(s)</span>
                    </div>`;
            } else if (status === 'success') {
                indicator.innerHTML = `
                    <div class="flex items-center gap-2 px-3 py-2 bg-emerald-500 text-white rounded-full shadow-lg">
                        <i data-lucide="check-circle" class="w-4 h-4"></i>
                        <span class="text-xs font-black">✓ Synchronisé</span>
                    </div>`;
                setTimeout(() => {
                    if (this.getPendingCount() === 0) {
                        indicator.innerHTML = '';
                    }
                }, 3000);
            } else if (pendingCount > 0) {
                indicator.innerHTML = `
                    <div class="flex items-center gap-2 px-3 py-2 bg-slate-700 text-white rounded-full shadow-lg cursor-pointer hover:bg-slate-800 transition" onclick="OfflineManager.showQueueModal()">
                        <i data-lucide="clock" class="w-4 h-4"></i>
                        <span class="text-xs font-black">${pendingCount} en attente</span>
                    </div>`;
            } else {
                indicator.innerHTML = '';
            }

            lucide.createIcons();
        },

        // Afficher le modal de gestion de la file d'attente
        showQueueModal() {
            const pending = CORE.db.pendingSyncs || [];
            const failed = pending.filter(a => a.status === 'failed');
            const waiting = pending.filter(a => a.status === 'pending');

            // Grouper par type d'action
            const grouped = {};
            pending.forEach(a => {
                const key = a.type || 'Autre';
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(a);
            });

            const typeLabels = {
                'create': '➕ Créations',
                'update': '✏️ Modifications',
                'delete': '🗑️ Suppressions',
                'Autre': '📋 Autres'
            };

            const typeColors = {
                'create': 'emerald',
                'update': 'blue',
                'delete': 'red',
                'Autre': 'slate'
            };

            let content = `
                <div class="space-y-4">
                    <!-- Résumé -->
                    <div class="grid grid-cols-3 gap-3">
                        <div class="p-4 bg-slate-50 rounded-2xl text-center">
                            <div class="text-2xl font-black text-slate-900">${pending.length}</div>
                            <div class="text-xs text-slate-500">Total</div>
                        </div>
                        <div class="p-4 bg-amber-50 rounded-2xl text-center">
                            <div class="text-2xl font-black text-amber-600">${waiting.length}</div>
                            <div class="text-xs text-amber-700">En attente</div>
                        </div>
                        <div class="p-4 bg-red-50 rounded-2xl text-center">
                            <div class="text-2xl font-black text-red-600">${failed.length}</div>
                            <div class="text-xs text-red-700">Échecs</div>
                        </div>
                    </div>

                    <!-- Statut connexion -->
                    <div class="p-4 rounded-2xl ${this.state.isOnline ? 'bg-emerald-50 border border-emerald-200' : 'bg-red-50 border border-red-200'}">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full ${this.state.isOnline ? 'bg-emerald-500' : 'bg-red-500'} animate-pulse"></div>
                            <div>
                                <div class="font-black ${this.state.isOnline ? 'text-emerald-800' : 'text-red-800'}">
                                    ${this.state.isOnline ? '🌐 En ligne' : '📡 Hors ligne'}
                                </div>
                                <div class="text-xs ${this.state.isOnline ? 'text-emerald-600' : 'text-red-600'}">
                                    Dernière sync: ${CORE.state.lastSync ? new Date(CORE.state.lastSync).toLocaleString('fr-FR') : 'Jamais'}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions par type -->
                    ${pending.length > 0 ? `
                        <div class="space-y-3 max-h-64 overflow-y-auto">
                            ${Object.keys(grouped).map(type => `
                                <div class="p-3 bg-${typeColors[type] || 'slate'}-50 rounded-xl border border-${typeColors[type] || 'slate'}-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-black text-sm text-${typeColors[type] || 'slate'}-800">${typeLabels[type] || type}</span>
                                        <span class="text-xs font-bold text-${typeColors[type] || 'slate'}-600">${grouped[type].length}</span>
                                    </div>
                                    <div class="space-y-1">
                                        ${grouped[type].slice(0, 5).map(a => `
                                            <div class="flex items-center justify-between text-xs p-2 bg-white rounded-lg">
                                                <div class="flex-1 truncate">
                                                    <span class="${a.status === 'failed' ? 'text-red-600' : 'text-slate-600'}">${a.desc || a.collection || 'Action'}</span>
                                                    ${a.status === 'failed' ? `<span class="ml-1 text-red-500">(échec)</span>` : ''}
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <span class="text-slate-400">${a.queuedAt ? new Date(a.queuedAt).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}) : ''}</span>
                                                    <button onclick="OfflineManager.removeFromQueue('${a.id}');OfflineManager.showQueueModal()" class="text-red-500 hover:text-red-700">
                                                        <i data-lucide="x" class="w-3 h-3"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                        ${grouped[type].length > 5 ? `<div class="text-xs text-center text-slate-400">+ ${grouped[type].length - 5} autres</div>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div class="p-8 text-center text-slate-400">
                            <i data-lucide="check-circle" class="w-12 h-12 mx-auto mb-3 text-emerald-400"></i>
                            <div class="font-bold">Aucune action en attente</div>
                            <div class="text-xs mt-1">Toutes les données sont synchronisées</div>
                        </div>
                    `}

                    <!-- Boutons d'action -->
                    ${pending.length > 0 ? `
                        <div class="flex flex-wrap gap-2">
                            ${this.state.isOnline ? `
                                <button onclick="OfflineManager.syncAll();UI.closeModal()" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-xl font-black hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    Synchroniser maintenant
                                </button>
                            ` : ''}
                            ${failed.length > 0 ? `
                                <button onclick="OfflineManager.retryFailed();UI.closeModal()" class="px-4 py-3 bg-amber-500 text-white rounded-xl font-black hover:bg-amber-600 transition flex items-center justify-center gap-2">
                                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                    Réessayer (${failed.length})
                                </button>
                            ` : ''}
                            <button onclick="if(confirm('Supprimer toutes les actions en attente?')){OfflineManager.clearQueue();UI.closeModal()}" class="px-4 py-3 bg-red-100 text-red-700 rounded-xl font-black hover:bg-red-200 transition">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    ` : ''}

                    ${(typeof RayaAPI !== 'undefined' && RayaAPI.isAuthenticated()) ? `
                        <div class="pt-2 border-t border-slate-100">
                            <button onclick="CORE.migrateLocalToCloud();UI.closeModal()" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-xl font-black hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                                <i data-lucide="cloud-upload" class="w-4 h-4"></i>
                                Migrer les donnees locales vers le cloud
                            </button>
                            <div class="text-xs text-slate-400 mt-2">Envoi de toutes les donnees locales vers le serveur (peut creer des doublons).</div>
                        </div>
                    ` : ''}
                </div>
            `;

            UI.modal('📡 File de synchronisation', content, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-lg' });

            if (typeof RayaAPI !== 'undefined' && RayaAPI.isAuthenticated() && CORE.state.isOnline) {
                setTimeout(function() {
                    CORE.migrateLocalToCloud({ auto: true, skipConfirm: true });
                }, 0);
            }
        },

        // Générer le badge de statut pour l'interface
        getStatusBadge() {
            const pending = this.getPendingCount();
            const failed = (CORE.db.pendingSyncs || []).filter(s => s.status === 'failed').length;

            if (!this.state.isOnline) {
                return `<span class="inline-flex items-center gap-1 px-2 py-1 bg-amber-100 text-amber-800 rounded-full text-xs font-bold">
                    <span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span>
                    Hors ligne${pending > 0 ? ` (${pending})` : ''}
                </span>`;
            }

            if (failed > 0) {
                return `<span class="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-bold cursor-pointer" onclick="OfflineManager.showQueueModal()">
                    <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                    ${failed} échec(s)
                </span>`;
            }

            if (pending > 0) {
                return `<span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold cursor-pointer" onclick="OfflineManager.showQueueModal()">
                    <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span>
                    ${pending} en attente
                </span>`;
            }

            return `<span class="inline-flex items-center gap-1 px-2 py-1 bg-emerald-100 text-emerald-800 rounded-full text-xs font-bold">
                <span class="w-2 h-2 bg-emerald-500 rounded-full"></span>
                En ligne
            </span>`;
        }
    };

    // Exposer globalement
    window.OfflineManager = OfflineManager;

    // =========================================================
    // UI
    // =========================================================
    const UI = {
        toast(message, type = 'success') {
            // Vérifier si les notifications sont activées
            const notificationsEnabled = VendeurModule.state?.preferences?.notificationsEnabled ?? CORE.state.preferences?.notificationsEnabled ?? true;
            if (!notificationsEnabled) {
                console.log('Notifications désactivées - toast non affiché:', message);
                return;
            }

            let container = document.getElementById('toastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'fixed top-5 right-5 z-[9999] flex flex-col gap-2 items-end pointer-events-none';
                document.body.appendChild(container);
            }
            const colors = { success: 'bg-emerald-600', error: 'bg-red-600', warning: 'bg-amber-500', info: 'bg-blue-600' };
            const icons = { success: 'check-circle', error: 'alert-circle', warning: 'alert-triangle', info: 'info' };

            const toast = document.createElement('div');
            toast.className = `toast pointer-events-auto ${colors[type] || colors.success} text-white px-4 py-3 rounded-xl shadow-xl flex items-center gap-3 min-w-[280px] backdrop-blur-md bg-opacity-95`;
            toast.innerHTML = `
                <i data-lucide="${icons[type] || icons.success}" class="w-5 h-5"></i>
                <span class="flex-1 font-medium text-sm">${typeof Utils !== 'undefined' && Utils.escapeHtml ? Utils.escapeHtml(message) : message}</span>
                <button class="p-1.5 rounded-lg hover:bg-white/15 transition" aria-label="Fermer">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            `;
            container.appendChild(toast);
            lucide.createIcons();

            // 🔊 Jouer le son de notification stylisé
            UI.playGenericNotificationSound(type);

            toast.querySelector('button').addEventListener('click', () => toast.remove());
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 250); }, 3500);
        },

        playNotificationSound() {
            try {
                // Vérifier si les sons sont activés
                const soundEnabled = CORE.state.preferences?.soundEnabled ?? VendeurModule.state.preferences?.soundEnabled ?? true;
                const volume = CORE.state.preferences?.soundVolume ?? VendeurModule.state.preferences?.soundVolume ?? 0.8;

                if (!soundEnabled) return;

                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const now = audioContext.currentTime;

                // Créer un son style Shopify - deux bips agréables
                const osc1 = audioContext.createOscillator();
                const osc2 = audioContext.createOscillator();
                const gain = audioContext.createGain();
                const gain2 = audioContext.createGain();

                // Premier bip (note haute - E4)
                osc1.frequency.setValueAtTime(329.63, now);
                osc1.type = 'sine';
                gain.gain.setValueAtTime(0.6 * volume, now);
                gain.gain.exponentialRampToValueAtTime(0.05 * volume, now + 0.15);

                osc1.connect(gain);
                gain.connect(audioContext.destination);

                osc1.start(now);
                osc1.stop(now + 0.15);

                // Deuxième bip (note plus haute - G4) avec délai
                osc2.frequency.setValueAtTime(391.995, now + 0.05);
                osc2.type = 'sine';
                gain2.gain.setValueAtTime(0.6 * volume, now + 0.05);
                gain2.gain.exponentialRampToValueAtTime(0.05 * volume, now + 0.25);

                osc2.connect(gain2);
                gain2.connect(audioContext.destination);

                osc2.start(now + 0.05);
                osc2.stop(now + 0.25);
            } catch (e) {
                console.log('🔊 Son de notification activé');
            }
        },

        playGenericNotificationSound(type = 'success') {
            try {
                // Vérifier si les sons sont activés
                const soundEnabled = CORE.state.preferences?.soundEnabled ?? VendeurModule.state.preferences?.soundEnabled ?? true;
                const volume = CORE.state.preferences?.soundVolume ?? VendeurModule.state.preferences?.soundVolume ?? 0.8;

                if (!soundEnabled) return;

                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const now = audioContext.currentTime;
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();

                // Fréquences différentes selon le type
                const frequencies = {
                    success: 523.25,  // C5
                    error: 293.66,    // D4
                    warning: 440,     // A4
                    info: 349.23      // F4
                };

                const freq = frequencies[type] || frequencies.success;

                osc.frequency.setValueAtTime(freq, now);
                osc.type = 'sine';

                gain.gain.setValueAtTime(0.25 * volume, now);
                gain.gain.exponentialRampToValueAtTime(0.01 * volume, now + 0.2);

                osc.connect(gain);
                gain.connect(audioContext.destination);

                osc.start(now);
                osc.stop(now + 0.2);
            } catch (e) {
                console.log('🔊 Son de notification activé');
            }
        },

        modal(title, content, actions = [], options = {}) {
            // Support pour l'ancienne signature avec onBack comme 4ème paramètre
            let onBack = null;
            let maxWidth = 'max-w-lg';
            let noPadding = false;

            if (typeof options === 'function') {
                onBack = options;
            } else if (typeof options === 'object' && options !== null) {
                onBack = options.onBack || null;
                maxWidth = options.maxWidth || 'max-w-lg';
                noPadding = options.noPadding || false;
            }

            let container = document.getElementById('modalContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'modalContainer';
                document.body.appendChild(container);
            }

            // Initialiser l'historique des modales s'il n'existe pas
            if (!window.modalStack) window.modalStack = [];
            if (!window.currentModalBack) window.currentModalBack = null;

            // Sauvegarder l'état actuel avant d'afficher la nouvelle modale
            const currentModal = container.innerHTML;
            if (currentModal && currentModal.length > 0) {
                window.modalStack.push(currentModal);
            }

            // Créer le bouton retour - TOUJOURS visible
            const backButtonHTML = `
                <button onclick="UI.goBack()" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition font-bold text-sm flex items-center gap-1" aria-label="Retour" title="Retour">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i> Retour
                </button>
            `;

            container.innerHTML = `
                <div class="fixed inset-0 bg-slate-900/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm" data-modal-overlay>
                    <div class="slide-up bg-white rounded-3xl shadow-2xl ${maxWidth} w-full max-h-[90vh] overflow-hidden flex flex-col" role="dialog" aria-modal="true" aria-label="${title}">
                        ${noPadding ? '' : `<div class="flex items-center justify-between p-6 border-b border-slate-100 bg-slate-50/50 gap-3">
                            ${backButtonHTML}
                            <h3 class="text-lg font-black text-slate-800 flex-1">${typeof Utils !== 'undefined' && Utils.escapeHtml ? Utils.escapeHtml(title) : title}</h3>
                            <button onclick="UI.closeModal()" class="p-2 hover:bg-slate-200 rounded-full transition flex-shrink-0" aria-label="Fermer">
                                <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
                            </button>
                        </div>`}
                        <div class="modal-content ${noPadding ? '' : 'p-6'} overflow-y-auto">${content}</div>
                        ${actions.length > 0 ? `<div class="flex items-center justify-end gap-3 p-6 border-t border-slate-100 bg-slate-50">${actions.map(a => `<button onclick="${a.onclick}" class="${a.class || 'px-5 py-2.5 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200 transition'}">${a.label}</button>`).join('')}</div>` : ''}
                    </div>
                </div>`;

            // Sauvegarder le callback de retour
            if (onBack) {
                window.currentModalBack = onBack;
            }

            // Créer les icônes lucide
            setTimeout(() => {
                lucide.createIcons();
            }, 0);

            const overlay = container.querySelector('[data-modal-overlay]');
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) UI.closeModal();
            });

            // Focus first input if exists
            setTimeout(() => {
                const first = container.querySelector('input,select,textarea,button');
                if (first && first !== container.querySelector('[aria-label="Retour"]') && first !== container.querySelector('[aria-label="Fermer"]')) {
                    first.focus();
                }
            }, 0);
        },

        updateModalContent(content) {
            const container = document.querySelector('#modalContainer .modal-content');
            if (!container) return;
            container.innerHTML = content;
            setTimeout(() => {
                if (window.lucide) lucide.createIcons();
            }, 0);
        },

        confirm({ title, message, confirmLabel = 'Confirmer', confirmClass = 'bg-red-600 hover:bg-red-700 text-white', onConfirm }) {
            const _e = typeof Utils !== 'undefined' && Utils.escapeHtml ? Utils.escapeHtml : (s => s);
            this.modal(title, `<p class="text-slate-600 font-medium">${_e(message)}</p>`, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: confirmLabel, onclick: `(${onConfirm.toString()})()`, class: `px-5 py-2.5 rounded-xl font-bold transition ${confirmClass}` }
            ]);
        },

        closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
            if (window.modalStack) window.modalStack = [];
            if (window.currentModalBack) window.currentModalBack = null;
        },

        goBack() {
            const container = document.getElementById('modalContainer');

            // Si on a un callback de retour personnalisé, l'utiliser
            if (window.currentModalBack) {
                const backFn = window.currentModalBack;
                window.currentModalBack = null;
                if (window.modalStack) window.modalStack.pop(); // Enlever la modale actuelle
                backFn();
                return;
            }

            // Sinon, restaurer la modale précédente de l'historique
            if (window.modalStack && window.modalStack.length > 0) {
                container.innerHTML = window.modalStack.pop();
                setTimeout(() => lucide.createIcons(), 0);

                const overlay = container.querySelector('[data-modal-overlay]');
                if (overlay) {
                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) UI.closeModal();
                    });
                }
            } else {
                // Sinon, juste fermer la modale
                this.closeModal();
            }
        },

        badge(text, color = 'slate') {
            const colors = {
                slate: 'bg-slate-100 text-slate-600',
                emerald: 'bg-emerald-100 text-emerald-700',
                amber: 'bg-amber-100 text-amber-700',
                red: 'bg-red-100 text-red-700',
                blue: 'bg-blue-100 text-blue-700',
                purple: 'bg-purple-100 text-purple-700'
            };
            return `<span class="px-2.5 py-0.5 ${colors[color] || colors.slate} rounded-full text-xs font-bold border border-transparent bg-opacity-60">${text}</span>`;
        },

        input(id, label, type = 'text', value = '', placeholder = '', required = false) {
            return `
                <div>
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-wider mb-1.5">${label}${required ? ' *' : ''}</label>
                    <input type="${type}" id="${id}" value="${value}" placeholder="${placeholder}"
                        class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:bg-white focus:border-transparent outline-none transition font-medium text-slate-800 placeholder-slate-400"
                        ${required ? 'required' : ''}>
                </div>`;
        },

        select(id, label, options, selected = '', required = false) {
            return `
                <div>
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-wider mb-1.5">${label}${required ? ' *' : ''}</label>
                    <select id="${id}" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:bg-white focus:border-transparent outline-none transition font-medium text-slate-800" ${required ? 'required' : ''}>
                        <option value="">Sélectionner...</option>
                        ${options.map(o => `<option value="${o.value}" ${String(o.value) === String(selected) ? 'selected' : ''}>${o.label}</option>`).join('')}
                    </select>
                </div>`;
        },

        textarea(id, label, value = '', placeholder = '', rows = 3) {
            return `
                <div>
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-wider mb-1.5">${label}</label>
                    <textarea id="${id}" rows="${rows}" placeholder="${placeholder}" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:bg-white focus:border-transparent outline-none transition font-medium text-slate-800 placeholder-slate-400">${value}</textarea>
                </div>`;
        },

        val(id) {
            const el = document.getElementById(id);
            return el ? el.value : '';
        }
    };

    const NotificationUtils = {
        severityConfig: {
            critical: {
                label: 'Critique',
                panel: 'border-l-4 border-l-red-600 bg-red-50 border border-red-200',
                badge: 'bg-red-200 text-red-800',
                dot: 'bg-red-500',
                chip: 'bg-red-600 text-white'
            },
            high: {
                label: 'Élevée',
                panel: 'border-l-4 border-l-orange-500 bg-orange-50 border border-orange-200',
                badge: 'bg-orange-200 text-orange-800',
                dot: 'bg-orange-500',
                chip: 'bg-orange-500 text-white'
            },
            medium: {
                label: 'Modérée',
                panel: 'border-l-4 border-l-amber-500 bg-amber-50 border border-amber-200',
                badge: 'bg-amber-200 text-amber-800',
                dot: 'bg-amber-500',
                chip: 'bg-amber-500 text-white'
            },
            low: {
                label: 'Faible',
                panel: 'border-l-4 border-l-slate-400 bg-slate-50 border border-slate-200',
                badge: 'bg-slate-200 text-slate-700',
                dot: 'bg-slate-400',
                chip: 'bg-slate-500 text-white'
            },
            info: {
                label: 'Information',
                panel: 'border-l-4 border-l-blue-500 bg-blue-50 border border-blue-200',
                badge: 'bg-blue-200 text-blue-800',
                dot: 'bg-blue-500',
                chip: 'bg-blue-500 text-white'
            }
        },

        defaultFilters() {
            return {
                severity: 'all',
                period: '7d',
                type: 'all',
                search: '',
                showUnread: false
            };
        },

        ensureFilters(filters) {
            return { ...this.defaultFilters(), ...(filters || {}) };
        },

        normalizeSeverity(raw) {
            const map = {
                critical: 'critical',
                danger: 'critical',
                red: 'critical',
                high: 'high',
                warning: 'high',
                orange: 'high',
                amber: 'high',
                medium: 'medium',
                success: 'medium',
                yellow: 'medium',
                low: 'low',
                minor: 'low',
                green: 'low',
                info: 'info',
                blue: 'info'
            };
            const key = String(raw || 'info').toLowerCase();
            return map[key] || 'info';
        },

        getSeverityMeta(raw) {
            const key = this.normalizeSeverity(raw);
            return this.severityConfig[key] || this.severityConfig.info;
        },

        getTimestamp(notification) {
            if (!notification) return null;
            const value = notification.createdAt || notification.timestamp || notification.date || notification.created_at;
            if (!value) return null;
            const date = value instanceof Date ? value : new Date(value);
            return isNaN(date.getTime()) ? null : date;
        },

        matchesPeriod(date, period) {
            if (!period || period === 'all') return true;
            if (!date) return false;
            const now = new Date();
            const diff = now.getTime() - date.getTime();
            const day = 24 * 60 * 60 * 1000;
            if (period === '24h') return diff <= day;
            if (period === '7d') return diff <= day * 7;
            if (period === '30d') return diff <= day * 30;
            return true;
        },

        applyFilters(list, filters) {
            const f = this.ensureFilters(filters);
            const search = String(f.search || '').trim().toLowerCase();
            return list.filter(n => {
                const severity = this.normalizeSeverity(n.severity);
                if (f.severity !== 'all' && severity !== f.severity) return false;
                if (f.showUnread && n.read) return false;
                if (f.type !== 'all') {
                    const typeKey = n.type ? String(n.type) : '';
                    if (typeKey.toLowerCase() !== f.type.toLowerCase()) return false;
                }
                const ts = this.getTimestamp(n);
                if (!this.matchesPeriod(ts, f.period)) return false;
                if (search) {
                    const haystack = [n.title, n.message, n.type, n.relatedTo].map(part => String(part || '').toLowerCase()).join(' ');
                    if (!haystack.includes(search)) return false;
                }
                return true;
            });
        },

        groupByDate(list) {
            const buckets = {};
            list.forEach(item => {
                const date = this.getTimestamp(item);
                const key = date ? date.toISOString().slice(0, 10) : 'unknown';
                if (!buckets[key]) buckets[key] = [];
                buckets[key].push(item);
            });

            return Object.entries(buckets)
                .sort((a, b) => {
                    if (a[0] === 'unknown') return 1;
                    if (b[0] === 'unknown') return -1;
                    return new Date(b[0]) - new Date(a[0]);
                })
                .map(([key, items]) => ({
                    key,
                    label: this.formatDateLabel(key),
                    items: items.sort((a, b) => {
                        const tsA = this.getTimestamp(a) || 0;
                        const tsB = this.getTimestamp(b) || 0;
                        return tsB - tsA;
                    })
                }));
        },

        formatDateLabel(key) {
            if (key === 'unknown') return 'Date inconnue';
            const date = new Date(key);
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);

            const isSameDay = (d1, d2) => d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();

            if (isSameDay(date, today)) return 'Aujourd\'hui';
            if (isSameDay(date, yesterday)) return 'Hier';

            return date.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
        },

        formatRelative(date) {
            if (!date) return 'Date inconnue';
            const now = new Date();
            const diff = now.getTime() - date.getTime();
            const minute = 60 * 1000;
            const hour = 60 * minute;
            const day = 24 * hour;
            if (diff < minute) return 'à l\'instant';
            if (diff < hour) {
                const mins = Math.floor(diff / minute);
                return `il y a ${mins} min`;
            }
            if (diff < day) {
                const hours = Math.floor(diff / hour);
                return `il y a ${hours} h`;
            }
            const days = Math.floor(diff / day);
            if (days < 30) return `il y a ${days} j`;
            return date.toLocaleDateString('fr-FR');
        },

        getTypeOptions(list) {
            const set = new Set();
            list.forEach(item => {
                if (item.type) set.add(String(item.type));
            });
            return Array.from(set).sort((a, b) => a.localeCompare(b));
        },

        getTypeLabel(type) {
            if (!type) return 'Système';
            return String(type)
                .replace(/_/g, ' ')
                .replace(/\s+/g, ' ')
                .trim()
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        },

        escape(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/\x3c/g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        },

        countBySeverity(list) {
            const counts = { all: list.length, critical: 0, high: 0, medium: 0, low: 0, info: 0 };
            list.forEach(item => {
                const key = this.normalizeSeverity(item.severity);
                counts[key] = (counts[key] || 0) + 1;
            });
            return counts;
        }
    };

    // ========== ROUTING & LOAD BALANCING ==========
    const RoutingEngine = {
        getUnassignedDeliveries(posId = null) {
            return (CORE.db.deliveries || []).filter(d => !d.livreurId && d.status !== 'livree' && d.status !== 'cancelled' && (!posId || d.posId === posId));
        },
        getLivreurLoad(livreurId) {
            const pending = (CORE.db.deliveries || []).filter(d => d.livreurId === livreurId && ['en_cours','en_attente'].includes(d.status));
            const totalVolume = pending.reduce((a, d) => a + (d.amount || 0), 0);
            return { count: pending.length, volume: totalVolume };
        },
        getAvailableLivreurs(posId, zoneId = null) {
            const users = CORE.db.users.filter(u => u.role === 'livreur' && u.active && u.pos === posId);
            // Include independent deliverers
            const indepUsers = (CORE.db.independentDeliveryMen || []).filter(dm => dm.posId == posId && dm.approvalStatus === 'approved' && dm.status === 'active').map(dm => ({ id: dm.id, name: dm.name + ' (Indépendant)', phone: dm.phone || '', vehicle: dm.vehicle || 'N/A', pos: posId, role: 'livreur', active: true, isIndependent: true }));
            const allUsers = [...users, ...indepUsers];
            return allUsers.map(u => ({
                ...u,
                load: this.getLivreurLoad(u.id),
                capacity: 5,
                available: this.getLivreurLoad(u.id).count < 5
            }));
        },
        getDeliveryPriority(delivery) {
            const order = CORE.db.orders.find(o => o.id === delivery.orderId);
            if (!order) return 1;
            let score = 1;
            if (order.tags && order.tags.includes('express')) score += 10;
            if (order.tags && order.tags.includes('vip')) score += 5;
            const createdTime = new Date(order.createdAt);
            const ageMins = (Date.now() - createdTime) / 60000;
            score += Math.min(5, ageMins / 60);
            return score;
        },
        suggestAssignment(delivery, posId) {
            const livreurs = this.getAvailableLivreurs(posId, delivery.zoneId);
            if (livreurs.length === 0) return null;
            const inZone = livreurs.filter(l => l.zoneId === delivery.zoneId);
            const candidates = inZone.length > 0 ? inZone : livreurs;
            const best = candidates.reduce((a, b) => a.load.count < b.load.count ? a : b);
            return best;
        },
        suggestRouteBatch(posId, limit = 10) {
            const unassigned = this.getUnassignedDeliveries(posId).slice(0, limit);
            const sorted = unassigned.sort((a, b) => this.getDeliveryPriority(b) - this.getDeliveryPriority(a));
            return sorted.map(d => ({
                delivery: d,
                priority: this.getDeliveryPriority(d),
                suggestion: this.suggestAssignment(d, posId),
                reason: d.status === 'pending' ? 'new' : 'pending'
            }));
        },
        autoAssignBatch(posId, limit = 10) {
            const batch = this.suggestRouteBatch(posId, limit);
            let assigned = 0;
            batch.forEach(item => {
                if (item.suggestion) {
                    CORE.update('deliveries', item.delivery.id, {
                        livreurId: item.suggestion.id,
                        status: 'en_attente'
                    });
                    assigned += 1;
                }
            });
            return assigned;
        },

        // =====================
        // GESTION DES UTILISATEURS (MANAGER)
        // =====================
        showUsersManagementModal() {
            const users = (CORE.db.users || []).filter(u => {
                // Le Manager ne voit le PDG que si pdg_manager_access est activé
                if (u.role === 'pdg' && !CORE.getSystemSetting('pdg_manager_access', false)) {
                    return false;
                }
                return true;
            });

            UI.modal('Gestion des Utilisateurs', `
                <div class="mb-4">
                    <button onclick="ManagerModule.showAddUserModal()" class="w-full px-4 py-3 ${CORE.getSystemSetting('manager_manage_users', false) ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-slate-400 cursor-not-allowed'} text-white rounded-xl text-sm font-black transition" ${!CORE.getSystemSetting('manager_manage_users', false) ? 'disabled' : ''}>
                        + Ajouter un utilisateur ${!CORE.getSystemSetting('manager_manage_users', false) ? '(Non autorisé)' : ''}
                    </button>
                </div>
                <div class="space-y-4 max-h-[50vh] overflow-y-auto">
                    ${users.length === 0 ? '<div class="p-4 text-center text-slate-500">Aucun utilisateur à gérer</div>' : users.map(u => `
                        <div class="p-4 rounded-2xl border border-slate-200 bg-white">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex items-center gap-3 flex-1">
                                    ${u.profileImage ? `<img src="${u.profileImage}" class="w-12 h-12 rounded-xl object-cover">` : `<div class="w-12 h-12 gradient-${u.role} rounded-xl flex items-center justify-center text-white font-black text-sm">${Utils.escapeHtml(u.avatar)}</div>`}
                                    <div class="flex-1">
                                        <div class="font-black text-slate-900">${Utils.escapeHtml(u.name)}</div>
                                        <div class="text-xs text-slate-500 space-y-1">
                                            <div>Role: <span class="font-bold text-slate-700">${Utils.escapeHtml(u.role)}</span></div>
                                            <div>Identifiant: <span class="font-mono text-emerald-600">${Utils.escapeHtml(u.username || 'N/A')}</span></div>
                                            <div>Mot de passe: <span class="font-mono text-cyan-600">••••••••</span></div> class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-xs font-black hover:bg-indigo-700 transition">📋 Détails</button>
                                    <button onclick="ManagerModule.showEditUserModal('${u.id}')" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-black hover:bg-blue-700 transition">Modifier</button>
                                    <button onclick="ManagerModule.toggleUserActive('${u.id}')" class="px-3 py-2 ${u.active ? 'bg-red-600 hover:bg-red-700' : 'bg-emerald-600 hover:bg-emerald-700'} text-white rounded-lg text-xs font-black transition">${u.active ? 'Désactiver' : 'Activer'}</button>
                                    <button onclick="ManagerModule.showChangePasswordModal('${u.id}')" class="px-3 py-2 bg-amber-600 text-white rounded-lg text-xs font-black hover:bg-amber-700 transition">Mot de passe</button>
                                    <button onclick="ManagerModule.deleteUser('${u.id}')" class="px-3 py-2 ${CORE.getSystemSetting('manager_manage_users', false) ? 'bg-rose-600 hover:bg-rose-700' : 'bg-slate-400 cursor-not-allowed'} text-white rounded-lg text-xs font-black transition" ${!CORE.getSystemSetting('manager_manage_users', false) ? 'disabled' : ''}>🗑️ Supprimer</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showUserDetailsModal(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouvé', 'error');

            // Vérifier que le Manager peut voir le PDG
            if (user.role === 'pdg' && !CORE.getSystemSetting('pdg_manager_access', false)) {
                return UI.toast('Vous n\'avez pas la permission de voir les détails du PDG', 'error');
            }

            const roleColors = {
                'pdg': 'text-purple-700 bg-purple-50',
                'manager': 'text-blue-700 bg-blue-50',
                'gestionnaire': 'text-slate-700 bg-slate-50',
                'vendeur': 'text-emerald-700 bg-emerald-50',
                'livreur': 'text-orange-700 bg-orange-50'
            };

            const roleColor = roleColors[user.role] || 'text-slate-700 bg-slate-50';

            UI.modal(`Détails: ${user.name}`, `
                <div class="space-y-4 max-h-[60vh] overflow-y-auto">
                    <div class="flex items-start gap-4 pb-4 border-b border-slate-200">
                        <div>
                            ${user.profileImage && typeof user.profileImage === 'string' && user.profileImage.trim() ? `<img src="${user.profileImage}" class="w-20 h-20 rounded-xl object-cover" onerror="this.style.display='none'">` : `<div class="w-20 h-20 gradient-${user.role} rounded-xl flex items-center justify-center text-white font-black text-2xl">${user.avatar}</div>`}
                        </div>
                        <div class="flex-1">
                            <div class="font-black text-lg text-slate-900">${user.name}</div>
                            <div class="text-xs font-bold ${roleColor} px-3 py-1 rounded-full inline-block mt-2">${user.role.toUpperCase()}</div>
                            <div class="text-xs text-slate-600 mt-2">ID: ${user.id}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 rounded-lg bg-slate-50">
                            <div class="text-xs font-black text-slate-600 uppercase">Identifiant</div>
                            <div class="text-sm font-mono text-slate-900 mt-1">${user.username || 'N/A'}</div>
                        </div>
                        <div class="p-3 rounded-lg bg-slate-50">
                            <div class="text-xs font-black text-slate-600 uppercase">Mot de passe</div>
                            <div class="text-sm font-mono text-slate-900 mt-1">${user.password || 'N/A'}</div>
                        </div>
                    </div>

                    <div class="p-3 rounded-lg bg-emerald-50 border border-emerald-200">
                        <div class="text-xs font-black text-emerald-700 uppercase">Statut</div>
                        <div class="text-sm font-bold text-emerald-900 mt-1">${user.active ? '✓ Actif' : '✗ Inactif'}</div>
                    </div>

                    ${user.city ? `<div class="p-3 rounded-lg bg-cyan-50 border border-cyan-200">
                        <div class="text-xs font-black text-cyan-700 uppercase">Ville</div>
                        <div class="text-sm text-cyan-900 mt-1">${(() => {
                            const city = CORE.db.cities?.find(c => c.id === user.city);
                            return city ? city.name : 'N/A';
                        })()}</div>
                    </div>` : ''}

                    ${user.pos ? `<div class="p-3 rounded-lg bg-lime-50 border border-lime-200">
                        <div class="text-xs font-black text-lime-700 uppercase">Point de Vente</div>
                        <div class="text-sm text-lime-900 mt-1">${(() => {
                            const pos = CORE.db.pointsOfSale?.find(p => p.id === user.pos);
                            return pos ? pos.name : 'N/A';
                        })()}</div>
                    </div>` : ''}

                    ${user.bio ? `<div class="p-3 rounded-lg bg-blue-50 border border-blue-200">
                        <div class="text-xs font-black text-blue-700 uppercase">Bio</div>
                        <div class="text-sm text-blue-900 mt-1">${user.bio}</div>
                    </div>` : ''}

                    ${user.specialties ? `<div class="p-3 rounded-lg bg-indigo-50 border border-indigo-200">
                        <div class="text-xs font-black text-indigo-700 uppercase">Spécialités</div>
                        <div class="text-sm text-indigo-900 mt-1">${user.specialties.join(', ')}</div>
                    </div>` : ''}

                    ${user.rating || user.totalSales || user.salesCount ? `<div class="grid grid-cols-3 gap-3">
                        ${user.rating ? `<div class="p-3 rounded-lg bg-yellow-50">
                            <div class="text-xs font-black text-yellow-700 uppercase">Note</div>
                            <div class="text-lg font-black text-yellow-900 mt-1">⭐ ${user.rating}</div>
                        </div>` : ''}
                        ${user.totalSales ? `<div class="p-3 rounded-lg bg-purple-50">
                            <div class="text-xs font-black text-purple-700 uppercase">Ventes</div>
                            <div class="text-sm text-purple-900 mt-1">${CORE.formatPrice(user.totalSales)}</div>
                        </div>` : ''}
                        ${user.salesCount ? `<div class="p-3 rounded-lg bg-pink-50">
                            <div class="text-xs font-black text-pink-700 uppercase">Nb Ventes</div>
                            <div class="text-lg font-black text-pink-900 mt-1">${user.salesCount}</div>
                        </div>` : ''}
                    </div>` : ''}

                    ${user.badge ? `<div class="p-3 rounded-lg bg-yellow-50 border border-yellow-200">
                        <div class="text-xs font-black text-yellow-700 uppercase">Badge</div>
                        <div class="text-sm text-yellow-900 mt-1">${(() => {
                            const badge = CORE.db.vendorBadges?.find(b => b.id === user.badge);
                            return badge ? badge.label : user.badge;
                        })()}</div>
                    </div>` : ''}

                    ${user.deliveryCount ? `<div class="p-3 rounded-lg bg-orange-50 border border-orange-200">
                        <div class="text-xs font-black text-orange-700 uppercase">Livraisons effectuées</div>
                        <div class="text-sm font-black text-orange-900 mt-1">${user.deliveryCount}</div>
                    </div>` : ''}

                    ${user.phone ? `<div class="p-3 rounded-lg bg-teal-50 border border-teal-200">
                        <div class="text-xs font-black text-teal-700 uppercase">Téléphone</div>
                        <div class="text-sm text-teal-900 mt-1">${user.phone}</div>
                    </div>` : ''}

                    ${user.vehicle ? `<div class="p-3 rounded-lg bg-red-50 border border-red-200">
                        <div class="text-xs font-black text-red-700 uppercase">Véhicule</div>
                        <div class="text-sm text-red-900 mt-1">${user.vehicle}</div>
                    </div>` : ''}

                    ${user.joinedDate ? `<div class="p-3 rounded-lg bg-gray-50 border border-gray-200">
                        <div class="text-xs font-black text-gray-700 uppercase">Date d'adhésion</div>
                        <div class="text-sm text-gray-900 mt-1">${user.joinedDate}</div>
                    </div>` : ''}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showEditUserModal(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouvé', 'error');

            // Vérifier que le Manager n'essaie pas de modifier le PDG sans permission
            if (user.role === 'pdg' && !CORE.getSystemSetting('pdg_manager_access', false)) {
                return UI.toast('Vous n\'avez pas la permission de modifier le PDG', 'error');
            }

            UI.modal(`Modifier: ${user.name}`, `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Identifiant</label>
                        <input type="text" id="edit-username" value="${user.username || ''}" placeholder="Identifiant" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Rôle</label>
                        <select id="edit-role" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="pdg" ${user.role === 'pdg' ? 'selected' : ''}>PDG</option>
                            <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Manager</option>
                            <option value="gestionnaire" ${user.role === 'gestionnaire' ? 'selected' : ''}>Gestionnaire</option>
                            <option value="vendeur" ${user.role === 'vendeur' ? 'selected' : ''}>Vendeur</option>
                            <option value="livreur" ${user.role === 'livreur' ? 'selected' : ''}>Livreur</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 p-4 bg-red-50 border border-red-200 rounded-2xl">
                    <div class="text-xs font-black text-red-700 mb-3">🔐 Réinitialiser le mot de passe</div>
                    <button onclick="ManagerModule.resetUserPassword(${userId})" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg text-xs font-black hover:bg-red-700 transition">
                        Réinitialiser le mot de passe
                    </button>
                </div>
            `, [
                { label: 'Enregistrer', onclick: `ManagerModule.saveEditUser(${userId})` },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        async saveEditUser(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouvé', 'error');

            const newUsername = document.getElementById('edit-username')?.value?.trim();
            const newRole = document.getElementById('edit-role')?.value;

            if (!newUsername) return UI.toast('L\'identifiant est requis', 'warning');

            // Vérifier que l'identifiant n'existe pas ailleurs (local + global)
            const existsLocal = CORE.db.users.some(u => u.id !== userId && u.username === newUsername);
            const otherTenantUser = CORE.global?.usersIndex?.find(u => u.username === newUsername && u.companyId !== CORE.tenantId);
            if (existsLocal || otherTenantUser) return UI.toast('Cet identifiant existe déjà', 'error');

            const oldUsername = user.username;
            const oldRole = user.role;
            const usernameChanged = oldUsername !== newUsername;
            const roleChanged = newRole && newRole !== oldRole;

            // 1. Mettre à jour l'utilisateur local
            user.username = newUsername;
            user.role = newRole || user.role;

            // 2. Propager dans l'index global (usersIndex)
            if (CORE.global && Array.isArray(CORE.global.usersIndex)) {
                const globalEntry = CORE.global.usersIndex.find(u => u.userId === userId && u.companyId === (CORE.tenantId || 'default'));
                if (globalEntry) {
                    if (usernameChanged) globalEntry.username = newUsername;
                    if (roleChanged) globalEntry.role = newRole;
                }
            }
            CORE._syncGlobalFromTenant();

            // 3. Audit log avec before/after
            const beforeData = { username: oldUsername, role: oldRole };
            const afterData = { username: newUsername, role: newRole || oldRole };
            const changes = [];
            if (usernameChanged) changes.push(`identifiant: "${oldUsername}" → "${newUsername}"`);
            if (roleChanged) changes.push(`rôle: "${oldRole}" → "${newRole}"`);
            CORE.logAudit('update', 'user', userId, user.name, {
                description: `Utilisateur modifié: ${changes.join(', ') || 'aucun changement'}`
            }, beforeData, afterData);

            // 4. Sauvegarder localement + marquer dirty
            CORE.save();
            CORE.markDirty('users');

            // 5. Synchroniser avec le backend API
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated()) {
                try {
                    const backendUserId = user._apiId || user.apiId || user.backendId || userId;
                    // Re-register with new credentials if username changed
                    if (usernameChanged) {
                        await API.registerUserSilent({
                            email: newUsername,
                            password: user.password,
                            firstName: user.name?.split(' ')[0] || '',
                            lastName: user.name?.split(' ').slice(1).join(' ') || '',
                            role: (newRole || user.role).toUpperCase(),
                            tenantId: CORE.tenantId
                        }).catch(e => console.warn('[saveEditUser] API re-register:', e.message));
                    }
                    // Push full users list to cloud
                    await API.request('/sync/users', { method: 'PUT', body: { data: CORE.db.users || [] } });
                    console.log('[MANAGER] Cloud users synced after edit');
                } catch(e) {
                    console.warn('[saveEditUser] Cloud sync failed:', e.message);
                }
            }

            UI.toast('Utilisateur modifié avec succès', 'success');
            UI.closeModal();
            this.showUsersManagementModal();
        },

        async resetUserPassword(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouvé', 'error');

            // Vérifier que le Manager n'essaie pas de modifier le mot de passe du PDG sans permission
            if (user.role === 'pdg' && !CORE.getSystemSetting('pdg_manager_access', false)) {
                return UI.toast('Vous n\'avez pas la permission de réinitialiser le mot de passe du PDG', 'error');
            }

            // Réinitialiser à un mot de passe par défaut : "123456"
            const hash = await Utils.md5('123456');
            user.password = '123456';
            user.passwordHash = hash;

            // Propager dans l'index global
            CORE._syncGlobalFromTenant();
            CORE.save();
            CORE.markDirty('users');
            CORE.logAudit('update', 'user', userId, user.name, { description: `Mot de passe réinitialisé à la valeur par défaut` });

            // Sync cloud
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated()) {
                try {
                    await API.request('/sync/users', { method: 'PUT', body: { data: CORE.db.users || [] } });
                    console.log('[MANAGER] Cloud users synced after password reset');
                } catch(e) { console.warn('[MANAGER] Cloud sync password reset failed:', e.message); }
            }

            UI.toast(`✓ Mot de passe de ${user.name} réinitialisé à "123456"`, 'success');
            UI.closeModal();
            this.showUsersManagementModal();
        },

        showChangePasswordModal(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouvé', 'error');

            // Vérifier que le Manager n'essaie pas de modifier le mot de passe du PDG sans permission
            if (user.role === 'pdg' && !CORE.getSystemSetting('pdg_manager_access', false)) {
                return UI.toast('Vous n\'avez pas la permission de modifier le mot de passe du PDG', 'error');
            }

            UI.modal(`Changer le mot de passe: ${user.name}`, `
                <div class="space-y-4 bg-blue-50 border border-blue-200 rounded-2xl p-4 mb-4">
                    <div class="text-sm text-blue-800">
                        <div class="font-black mb-2">⚠️ Attention</div>
                        <div>Un nouveau mot de passe temporaire sera généré. L'utilisateur devra le changer à sa prochaine connexion.</div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-black text-slate-600 uppercase mb-2">Nouveau mot de passe</label>
                    <input type="password" id="change-password-input" placeholder="Entrez le nouveau mot de passe" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-amber-500 focus:outline-none">
                    <div class="text-xs text-slate-500 mt-2">Minimum 6 caractères requis</div>
                </div>
            `, [
                { label: 'Changer le mot de passe', onclick: `ManagerModule.savePasswordChange(${userId})` },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        async savePasswordChange(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouvé', 'error');

            const newPassword = document.getElementById('change-password-input')?.value || '';
            if (newPassword.length < 6) return UI.toast('Le mot de passe doit avoir au minimum 6 caractères', 'warning');

            // Hacher le nouveau mot de passe
            const hash = await Utils.md5(newPassword);
            user.password = newPassword;
            user.passwordHash = hash;

            // Propager dans l'index global
            CORE._syncGlobalFromTenant();
            CORE.save();
            CORE.markDirty('users');
            CORE.logAudit('update', 'user', userId, user.name, { description: `Mot de passe changé manuellement` });

            // Sync cloud
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated()) {
                try {
                    await API.request('/sync/users', { method: 'PUT', body: { data: CORE.db.users || [] } });
                    console.log('[MANAGER] Cloud users synced after password change');
                } catch(e) { console.warn('[MANAGER] Cloud sync password change failed:', e.message); }
            }

            UI.toast(`Mot de passe de ${user.name} changé avec succès`, 'success');
            UI.closeModal();
            this.showUsersManagementModal();
        },

        async toggleUserActive(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouvé', 'error');

            // Vérifier que le Manager n'essaie pas de désactiver le PDG sans permission
            if (user.role === 'pdg' && !CORE.getSystemSetting('pdg_manager_access', false)) {
                return UI.toast('Vous n\'avez pas la permission de modifier l\'état du PDG', 'error');
            }

            const newActive = !user.active;
            const backendUserId = user._apiId || user.apiId || user.backendId || userId;
            // Call backend
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated()) {
                try {
                    const endpoint = newActive ? '/users/' + backendUserId + '/reactivate' : '/users/' + backendUserId + '/deactivate';
                    await API.request(endpoint, { method: 'PATCH' });
                    console.log('[MANAGER] toggleUserActive backend OK:', backendUserId, newActive ? 'reactivated' : 'deactivated');
                } catch(e) {
                    console.warn('[MANAGER] toggleUserActive backend failed:', e.message);
                }
            }
            user.active = newActive;
            CORE.save();
            UI.toast(`${user.name} est maintenant ${user.active ? 'actif' : 'inactif'}`, 'info');
            this.showUsersManagementModal();
        },

        // ========== GESTION DES PARAMÈTRES LIVREUR ==========
        showDeliveryFeaturesSettings() {
            const settings = CORE.getGestionnaireSettings();

            const modalContent = `
                <div class="space-y-5">
                    <!-- HEADER -->
                    <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl">
                        <h3 class="font-black text-slate-900">🚚 Paramètres des fonctionnalités livreur</h3>
                        <p class="text-sm text-slate-600 mt-1">Activez ou désactivez les fonctionnalités disponibles pour les livreurs</p>
                    </div>

                    <!-- VALIDATION PAR PHOTO -->
                    <div class="p-5 border-2 border-slate-200 rounded-xl hover:shadow-md transition">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h4 class="font-black text-slate-900">📸 Validation par photo</h4>
                                <p class="text-sm text-slate-600 mt-1">Les livreurs doivent prendre une photo pour valider les livraisons</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="feature_photo" ${settings.deliveryPhotoValidationEnabled ? 'checked' : ''} class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                            </label>
                        </div>
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-800">
                            <span class="font-bold">ℹ️ Impact:</span> Obligation de preuve photo pour chaque livraison (traçabilité accrue)
                        </div>
                    </div>

                    <!-- SIGNATURE CLIENT -->
                    <div class="p-5 border-2 border-slate-200 rounded-xl hover:shadow-md transition opacity-60">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h4 class="font-black text-slate-900">✍️ Signature client (Prochainement)</h4>
                                <p class="text-sm text-slate-600 mt-1">Demander la signature électronique du client</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="feature_signature" ${settings.deliveryPhotoSignatureEnabled ? 'checked' : ''} disabled class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-300 rounded-full"></div>
                            </label>
                        </div>
                        <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-xs text-amber-800">
                            <span class="font-bold">⏳ Status:</span> Fonctionnalité en développement
                        </div>
                    </div>

                    <!-- GÉOLOCALISATION -->
                    <div class="p-5 border-2 border-slate-200 rounded-xl hover:shadow-md transition opacity-60">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h4 class="font-black text-slate-900">📍 Géolocalisation GPS (Prochainement)</h4>
                                <p class="text-sm text-slate-600 mt-1">Enregistrer la position GPS lors de chaque livraison</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="feature_gps" ${settings.deliveryPhotoGPSEnabled ? 'checked' : ''} disabled class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-300 rounded-full"></div>
                            </label>
                        </div>
                        <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-xs text-amber-800">
                            <span class="font-bold">⏳ Status:</span> Fonctionnalité en développement
                        </div>
                    </div>

                    <!-- NOTATION CLIENT -->
                    <div class="p-5 border-2 border-slate-200 rounded-xl hover:shadow-md transition">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h4 class="font-black text-slate-900">⭐ Notation des clients</h4>
                                <p class="text-sm text-slate-600 mt-1">Les clients peuvent évaluer les livreurs après livraison</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="feature_rating" ${settings.deliveryRatingEnabled ? 'checked' : ''} class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                            </label>
                        </div>
                        <div class="p-3 bg-purple-50 border border-purple-200 rounded-lg text-xs text-purple-800">
                            <span class="font-bold">ℹ️ Impact:</span> Améliore la qualité du service et la responsabilité des livreurs
                        </div>
                    </div>

                    <!-- RÉSUMÉ DES STATUTS -->
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
                        <div class="font-black text-slate-900 mb-3">✅ Résumé</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full ${settings.deliveryPhotoValidationEnabled ? 'bg-emerald-500' : 'bg-slate-300'} flex items-center justify-center text-white text-xs font-bold">✓</span>
                                <span class="text-slate-700">Validation par photo: <span class="font-bold">${settings.deliveryPhotoValidationEnabled ? '🟢 ACTIVÉ' : '🔴 DÉSACTIVÉ'}</span></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full ${settings.deliveryRatingEnabled ? 'bg-emerald-500' : 'bg-slate-300'} flex items-center justify-center text-white text-xs font-bold">✓</span>
                                <span class="text-slate-700">Notation clients: <span class="font-bold">${settings.deliveryRatingEnabled ? '🟢 ACTIVÉ' : '🔴 DÉSACTIVÉ'}</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- CONSEIL -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-800">
                        <span class="font-bold">💡 Conseil:</span> Activez la validation par photo pour améliorer la traçabilité et réduire les litiges avec les clients.
                    </div>
                </div>
            `;

            UI.modal(`⚙️ Paramètres des fonctionnalités livreur`, modalContent, [
                { label: 'Enregistrer', onclick: 'ManagerModule.saveDeliveryFeaturesSettings()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);

            lucide.createIcons();
        },

        saveDeliveryFeaturesSettings() {
            const settings = CORE.getGestionnaireSettings();

            // Récupérer les valeurs des checkboxes
            settings.deliveryPhotoValidationEnabled = document.getElementById('feature_photo')?.checked || false;
            settings.deliveryRatingEnabled = document.getElementById('feature_rating')?.checked || false;

            // Sauvegarder
            CORE.setGestionnaireSettings(settings);

            UI.closeModal();
            UI.toast('✅ Paramétres de livraison enregistrès!', 'success');
        },

        loadUserPreferences() {
            const user = CORE.state.currentUser;
            if (!user) return;

            // Charger le thème sauvegardé
            const savedTheme = localStorage.getItem('user_theme_' + user.id);
            if (savedTheme) {
                // this.applyTheme(savedTheme); // Si la méthode existe
            }

            // Charger les autres préférences
            const userPrefs = CORE.db.userPreferences?.find(p => p.userId === user.id);
            if (userPrefs?.compactMode) {
                document.body.classList.add('compact-mode');
            }

            // Initialiser les raccourcis clavier
            if (this.setupKeyboardShortcuts) {
                this.setupKeyboardShortcuts();
            }
        },

        showAddUserModal() {
            // Vérifier si le PDG a autorisé le Manager à ajouter des utilisateurs
            if (!CORE.getSystemSetting('manager_manage_users', false)) {
                return UI.toast('Le PDG n\'a pas autorisé l\'ajout d\'utilisateurs par le Manager', 'error');
            }

            UI.modal('Ajouter un nouvel utilisateur', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Nom complet</label>
                        <input type="text" id="add-name" placeholder="Nom de l'utilisateur" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Identifiant</label>
                        <input type="text" id="add-username" placeholder="Identifiant unique" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Mot de passe initial</label>
                        <input type="password" id="add-password" placeholder="Mot de passe temporaire" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                        <div class="text-xs text-slate-500 mt-2">Minimum 6 caractères</div>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Rôle</label>
                        <select id="add-role" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                            <option value="gestionnaire">Gestionnaire</option>
                            <option value="vendeur">Vendeur</option>
                            <option value="livreur">Livreur</option>
                            <option value="manager">Manager</option>
                            <option value="pdg">PDG</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Avatar (2 caractères)</label>
                        <input type="text" id="add-avatar" placeholder="Ex: JD" maxlength="2" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                    </div>
                </div>
            `, [
                { label: 'Demander l\'ajout', onclick: 'ManagerModule.requestAddUser()' },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        requestAddUser() {
            const name = document.getElementById('add-name')?.value?.trim() || '';
            const username = document.getElementById('add-username')?.value?.trim() || '';
            const password = document.getElementById('add-password')?.value || '';
            const role = document.getElementById('add-role')?.value || 'gestionnaire';
            const avatar = document.getElementById('add-avatar')?.value?.trim().toUpperCase() || 'XX';

            if (!name || !username || !password) return UI.toast('Tous les champs sont requis', 'warning');
            if (password.length < 6) return UI.toast('Le mot de passe doit avoir au minimum 6 caractères', 'warning');

            // Vérifier que l'identifiant n'existe pas (local + global)
            const existsLocal = CORE.db.users.some(u => u.username === username);
            const existsGlobal = CORE.isUsernameTaken ? CORE.isUsernameTaken(username) : false;
            if (existsLocal || existsGlobal) return UI.toast('Cet identifiant existe déjà', 'error');

            // Hacher le mot de passe
            Utils.md5(password).then(hash => {
                const currentUser = CORE.state.currentUser;
                const request = {
                    id: Math.max(...(CORE.db.userAdditionRequests || []).map(r => r.id || 0), 0) + 1,
                    name,
                    username,
                    password,
                    passwordHash: hash,
                    role,
                    avatar,
                    requestedBy: currentUser.id,
                    requestedByName: currentUser.name,
                    requestedAt: new Date().toISOString(),
                    status: 'pending',
                    approvedBy: null,
                    approvedByName: null,
                    approvedAt: null,
                    rejectionReason: null
                };

                if (!CORE.db.userAdditionRequests) CORE.db.userAdditionRequests = [];
                CORE.db.userAdditionRequests.push(request);
                CORE.markDirty('userAdditionRequests');
                CORE.save();
                UI.toast(`Demande d'ajout de ${name} envoyée au PDG pour approbation`, 'success');
                UI.closeModal();
                this.showUsersManagementModal();
            });
        },

        saveNewUser() {
            const name = document.getElementById('add-name')?.value?.trim() || '';
            const username = document.getElementById('add-username')?.value?.trim() || '';
            const password = document.getElementById('add-password')?.value || '';
            const role = document.getElementById('add-role')?.value || 'gestionnaire';
            const avatar = document.getElementById('add-avatar')?.value?.trim().toUpperCase() || 'XX';

            if (!name || !username || !password) return UI.toast('Tous les champs sont requis', 'warning');
            if (password.length < 6) return UI.toast('Le mot de passe doit avoir au minimum 6 caractères', 'warning');

            // Vérifier que l'identifiant n'existe pas
            // Vérifier que l'identifiant n'existe pas (local + global)
            const existsLocal = CORE.db.users.some(u => u.username === username);
            const existsGlobal = CORE.isUsernameTaken ? CORE.isUsernameTaken(username) : false;
            if (existsLocal || existsGlobal) return UI.toast('Cet identifiant existe déjà', 'error');

            // Hacher le mot de passe
            Utils.md5(password).then(hash => {
                const newUser = {
                    id: Math.max(...CORE.db.users.map(u => u.id), 0) + 1,
                    name,
                    username,
                    password,
                    passwordHash: hash,
                    role,
                    avatar,
                    active: true,
                    joinedDate: new Date().toISOString(),
                    companyId: CORE.tenantId || 'default',
                    accountId: CORE.tenantId || 'default',
                    posId: null
                };

                CORE.db.users.push(newUser);
                // Clear _deletedUserIds when creating a new user (prevents old deletion filters blocking)
                if (CORE._deletedUserIds && Object.keys(CORE._deletedUserIds).length > 0) {
                    CORE._deletedUserIds = {};
                    try { localStorage.setItem('_deletedUserIds', '{}'); } catch(e) {}
                }
                CORE.save();
                CORE.markDirty('users');

                // Background API sync - register user on backend
                if (typeof RayaAPI !== 'undefined' && RayaAPI.isAuthenticated()) {
                    API.registerUserSilent({ email: username, password: password, firstName: name.split(' ')[0], lastName: name.split(' ').slice(1).join(' '), role: role.toUpperCase(), tenantId: CORE.tenantId }).then(function(res) {
                        if (res && res.user && res.user.id) { newUser._apiId = res.user.id; CORE.save(); console.log('[MANAGER] User registered, apiId:', res.user.id); }
                    }).catch(function(e) { console.warn('[saveNewUser] API sync failed:', e.message); });
                    // Push users collection to cloud sync
                    API.request('/sync/users', { method: 'PUT', body: { data: CORE.db.users || [] } }).then(function() {
                        console.log('[MANAGER] Cloud users synced after new user creation');
                    }).catch(function(e) { console.warn('[MANAGER] Cloud sync after user creation failed:', e.message); });
                }

                UI.toast(`${name} a été créé avec succès`, 'success');
                UI.closeModal();
                this.showUsersManagementModal();
            });
        },

        async deleteUser(userId) {
            if (!CORE.getSystemSetting('manager_manage_users', false)) {
                return UI.toast('Le PDG n\'a pas autorisé la suppression d\'utilisateurs par le Manager', 'error');
            }
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouvé', 'error');
            if (user.role === 'pdg') return UI.toast('Impossible de supprimer le PDG', 'error');
            if (!confirm(`Êtes-vous sûr de vouloir supprimer ${user.name} ?`)) return;

            const backendUserId = user._apiId || user.apiId || user.backendId || userId;
            console.log('[MANAGER] deleteUser called, userId:', userId, 'backendUserId:', backendUserId);

            // 1. Backend: remove membership (this also deactivates the user account)
            let backendOk = false;
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated()) {
                try {
                    await API.request('/user-tenants/members/' + backendUserId, { method: 'DELETE' });
                    console.log('[MANAGER] Backend membership removed + user deactivated for', backendUserId);
                    backendOk = true;
                } catch(e) {
                    console.warn('[MANAGER] Backend remove membership failed:', e.message);
                    try {
                        await API.request('/users/' + backendUserId + '/deactivate', { method: 'PATCH' });
                        console.log('[MANAGER] Backend user deactivated via fallback:', backendUserId);
                        backendOk = true;
                    } catch(e2) {
                        console.error('[MANAGER] Both backend calls failed:', e.message, e2.message);
                    }
                }
            } else {
                console.warn('[MANAGER] Not authenticated, skipping backend calls');
            }

            // 2. Remove locally + mark as deleted so sync won't re-add
            if (!CORE._deletedUserIds) CORE._deletedUserIds = {};
            CORE._deletedUserIds[backendUserId] = true;
            CORE._deletedUserIds[userId] = true;
            CORE._deletedUserIds[String(backendUserId)] = true;
            CORE._deletedUserIds[String(userId)] = true;
            try { localStorage.setItem('_deletedUserIds', JSON.stringify(CORE._deletedUserIds)); } catch(e) {}

            CORE.db.users = (CORE.db.users || []).filter(u =>
                String(u.id) !== String(userId) && String(u.id) !== String(backendUserId) &&
                String(u._apiId || '') !== String(userId) && String(u._apiId || '') !== String(backendUserId)
            );
            CORE.logAudit('delete', 'user', userId, user.name, { description: `Utilisateur supprimé: ${user.name} (${user.role})` });
            CORE.save();

            // 3. Push updated users list to cloud so the deleted user is also removed from cloud data
            if (backendOk && typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated()) {
                try {
                    await API.request('/sync/users', { method: 'PUT', body: { data: CORE.db.users || [] } });
                    console.log('[MANAGER] Cloud users collection updated after deletion');
                } catch(syncErr) {
                    console.warn('[MANAGER] Cloud sync after delete failed:', syncErr.message);
                }
            }

            UI.toast(`${user.name} a été supprimé` + (backendOk ? '' : ' (local seulement)'), backendOk ? 'success' : 'warning');
            UI.closeModal();
            App.rerender();
        },

        showSettingsModal() {
            const currentLang = I18n.currentLang || 'fr';
            const currentTheme = this.state?.theme || 'light';
            const languages = [
                { code: 'fr', flag: '🇫🇷', name: 'Français' },
                { code: 'en', flag: '🇬🇧', name: 'English' },
                { code: 'es', flag: '🇪🇸', name: 'Español' },
                { code: 'pt', flag: '🇵🇹', name: 'Português' },
                { code: 'de', flag: '🇩🇪', name: 'Deutsch' },
                { code: 'it', flag: '🇮🇹', name: 'Italiano' },
                { code: 'ar', flag: '🇸🇦', name: 'العربية' },
                { code: 'zh', flag: '🇨🇳', name: '中文' },
                { code: 'ru', flag: '🇷🇺', name: 'Русский' }
            ];

            UI.modal('⚙️ Paramètres Manager', `
                <div class="space-y-4">
                    <!-- Section Langue (Tiroir) -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-2xl overflow-hidden">
                        <button onclick="document.getElementById('manager-modal-language-drawer').classList.toggle('hidden'); document.getElementById('manager-modal-language-chevron').classList.toggle('rotate-180')" class="w-full flex items-center justify-between p-4 hover:bg-blue-100/50 transition-all">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
                                    <i data-lucide="globe" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="text-left">
                                    <div class="font-black text-slate-900">${t('settings.language')}</div>
                                    <div class="text-xs text-slate-500">${languages.find(l => l.code === currentLang)?.flag || '🌍'} ${languages.find(l => l.code === currentLang)?.name || 'Français'}</div>
                                </div>
                            </div>
                            <i id="manager-modal-language-chevron" data-lucide="chevron-down" class="w-5 h-5 text-slate-400 transition-transform duration-300"></i>
                        </button>
                        <div id="manager-modal-language-drawer" class="hidden border-t border-blue-200 bg-white/50 p-4">
                            <p class="text-xs text-slate-500 mb-3">${t('settings.chooseLanguage')}</p>
                            <div class="grid grid-cols-5 gap-2">
                                ${languages.map(lang => `
                                    <button onclick="ManagerModule.setLanguage('${lang.code}')" class="p-2 rounded-xl border-2 transition-all text-2xl hover:scale-110 flex flex-col items-center gap-1 ${currentLang === lang.code ? 'border-blue-500 bg-blue-100 shadow-lg scale-105' : 'border-slate-200 hover:border-slate-300 bg-white'}">
                                        <span>${lang.flag}</span>
                                        <span class="text-[9px] font-bold text-slate-600">${lang.name.slice(0, 4)}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Section Thème -->
                    <div class="p-4 bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-2xl">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center">
                                <i data-lucide="palette" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-slate-900">${t('settings.theme')}</div>
                                <div class="text-xs text-slate-500">Personnalisez l'apparence</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            ${[
                                { id: 'light', icon: '☀️', label: t('settings.light'), gradient: 'from-amber-400 to-orange-500' },
                                { id: 'dark', icon: '🌙', label: t('settings.dark'), gradient: 'from-slate-700 to-slate-900' },
                                { id: 'auto', icon: '🔄', label: t('settings.auto'), gradient: 'from-blue-500 to-purple-600' }
                            ].map(theme => `
                                <button onclick="ManagerModule.setTheme('${theme.id}')" class="group p-3 rounded-xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${currentTheme === theme.id ? 'border-purple-500 shadow-lg shadow-purple-100 scale-105' : 'border-slate-200 hover:border-slate-300 hover:shadow-md'}">
                                    <div class="w-12 h-12 bg-gradient-to-br ${theme.gradient} rounded-lg flex items-center justify-center text-xl shadow-md ${currentTheme === theme.id ? 'ring-2 ring-purple-300' : ''}">
                                        ${theme.icon}
                                    </div>
                                    <span class="text-xs font-bold ${currentTheme === theme.id ? 'text-purple-700' : 'text-slate-600'}">${theme.label}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Section Utilisateurs -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center border border-blue-200"><i data-lucide="users" class="w-5 h-5 text-blue-600"></i></div>
                            <div>
                                <div class="font-black text-blue-900">Gestion des Utilisateurs</div>
                                <div class="text-xs text-blue-700">Modifier les identifiants et mots de passe</div>
                            </div>
                        </div>
                        <button onclick="ManagerModule.showUsersManagementModal()" class="text-xs font-black text-blue-600 hover:text-blue-700">Gérer</button>
                    </div>

                    <div class="h-px bg-slate-200 my-2"></div>

                    <div class="border-t border-slate-200 pt-4">
                        <div class="text-xs font-black text-slate-600 uppercase tracking-wider mb-3">🔒 Sécurité et Confidentialité</div>
                        <button onclick="ManagerModule.showChangePersonalPasswordModal()" class="w-full p-3 rounded-2xl bg-sky-50 border border-sky-200 hover:bg-sky-100 transition flex items-center gap-3 mb-3">
                            <i data-lucide="key" class="w-5 h-5 text-sky-600"></i>
                            <div class="text-left flex-1">
                                <div class="text-xs font-black text-sky-700">Changer votre mot de passe</div>
                                <div class="text-[10px] text-sky-600">Modifiez votre mot de passe personnel</div>
                            </div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-sky-400"></i>
                        </button>
                    </div>


                    <!-- Zone Dangereuse -->
                    <div class="p-4 rounded-2xl bg-gradient-to-r from-red-50 to-rose-50 border-2 border-red-200 mt-3">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="alert-triangle" class="w-4 h-4 text-red-600"></i>
                            <span class="text-xs font-black text-red-700">Zone Dangereuse</span>
                        </div>
                        <button onclick="CORE.showDeleteMyAccountModal()" class="w-full py-2.5 bg-red-600 hover:bg-red-700 text-white font-black text-sm rounded-xl transition flex items-center justify-center gap-2">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            Supprimer mon compte
                        </button>
                        <p class="text-[10px] text-red-400 mt-1 text-center">Action irréversible</p>
                    </div>
                    <div class="h-px bg-slate-200 my-2"></div>

                    <button onclick="App.logout()" class="w-full py-3 bg-red-50 text-red-600 font-black rounded-xl hover:bg-red-100 transition flex items-center justify-center gap-2">
                        <i data-lucide="log-out" class="w-4 h-4"></i> Déconnexion
                    </button>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            setTimeout(() => lucide?.createIcons?.(), 50);
        },

        setLanguage(code) {
            I18n.setLanguage(code);
            // Mettre à jour aussi les préférences VendeurModule si disponibles
            if (VendeurModule?.state?.preferences) VendeurModule.state.preferences.language = code;
            UI.closeModal();
            const langNames = { fr: 'Français', en: 'English', es: 'Español', ar: 'العربية', pt: 'Português', zh: '中文', tr: 'Türkçe', de: 'Deutsch', ru: 'Русский' };
            UI.toast(`✓ Langue: ${langNames[code] || code.toUpperCase()}`, 'success');
            App.rerender();
            this.showSettingsModal();
        },

        setTheme(theme) {
            this.state.theme = theme;
            VendeurModule.setTheme(theme);
            UI.closeModal();
            this.showSettingsModal();
        },

        showInviteEmployeeModal() {
            // Delegate to the main PDGModule implementation (full invitation management page)
            if (PDGModule.renderInvitationManagement) {
                PDGModule._invitationTab = PDGModule._invitationTab || 'create';
                PDGModule._invitations = PDGModule._invitations || [];
                PDGModule._joinRequests = PDGModule._joinRequests || [];
                App.mount(PDGModule.renderInvitationManagement());
                PDGModule.loadInvitationData();
                setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 80);
            }
        },

        async generateInviteCode() {
            // Delegate to main PDGModule implementation
            // This is just a fallback if called from the earlier context
            const type = document.getElementById('invite-type')?.value || 'code';
            const email = document.getElementById('invite-email')?.value?.trim() || '';
            const role = document.getElementById('invite-role')?.value || 'VENDEUR';
            const storeId = document.getElementById('invite-pos')?.value || '';
            const message = document.getElementById('invite-message')?.value?.trim() || '';

            if (typeof API === 'undefined' || !API.isAuthenticated || !API.isAuthenticated()) {
                UI.toast('Connexion requise pour créer une invitation', 'warning');
                return;
            }

            try {
                const data = { role };
                if (email) data.email = email;
                if (storeId) data.storeId = storeId;
                if (message) data.message = message;
                const result = await API.createInvitation(data);
                const code = result.code || result.invitationCode || result.invitation?.invitationCode || 'N/A';
                UI.toast('Invitation créée : ' + code, 'success');
            } catch (err) {
                console.error('[INVITE]', err);
                UI.toast('Erreur: ' + (err.message || err), 'warning');
            }
        },

        showChangePersonalPasswordModal() {
            UI.modal('🔒 Changer votre mot de passe', `
                <div class="space-y-4">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl flex items-center gap-3">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-amber-600 flex-shrink-0"></i>
                        <div class="text-sm text-amber-800 font-medium">Utilisez un mot de passe fort (min 6 caractères)</div>
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Ancien mot de passe</label>
                        <input type="password" id="old_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Entrez votre ancien mot de passe">
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Nouveau mot de passe</label>
                        <input type="password" id="new_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Entrez un nouveau mot de passe">
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Confirmation du nouveau mot de passe</label>
                        <input type="password" id="confirm_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Confirmez le nouveau mot de passe">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Changer le mot de passe', onclick: 'ManagerModule.savePersonalPasswordChange()', class: 'px-5 py-2.5 bg-sky-600 text-white font-black rounded-xl hover:bg-sky-700' }
            ]);
        },

        async savePersonalPasswordChange() {
            const oldPwd = UI.val('old_pwd');
            const newPwd = UI.val('new_pwd');
            const confirmPwd = UI.val('confirm_pwd');
            const user = CORE.state.currentUser;

            if (!oldPwd || !newPwd || !confirmPwd) {
                UI.toast('Tous les champs sont obligatoires', 'error');
                return;
            }

            if (newPwd.length < 6) {
                UI.toast('Le nouveau mot de passe doit contenir au moins 6 caractères', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                UI.toast('Les mots de passe ne correspondent pas', 'error');
                return;
            }

            const oldPwdHash = await Utils.md5(oldPwd);
            if (user.passwordHash) {
                if (oldPwdHash !== user.passwordHash) {
                    UI.toast('Ancien mot de passe incorrect', 'error');
                    return;
                }
            } else if (user.password) {
                if (oldPwd !== user.password) {
                    UI.toast('Ancien mot de passe incorrect', 'error');
                    return;
                }
            } else {
                UI.toast('Impossible de vérifier le mot de passe', 'error');
                return;
            }

            const newPwdHash = await Utils.md5(newPwd);
            user.passwordHash = newPwdHash;

            const userIndex = CORE.db.users.findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
                CORE.db.users[userIndex] = user;
                CORE.save();
                UI.closeModal();
                UI.toast('✓ Mot de passe changé avec succès', 'success');
                App.rerender();
            } else {
                UI.toast('Erreur lors de la mise à jour de l\'utilisateur', 'error');
            }
        }
    };

    // =========================================================
    // MODULE: VENDEUR
    // =========================================================
    const VendeurModule = {
        state: {
            currentView: 'dashboard',
            theme: 'light',
            // posMode: 'sale' | 'reservation'
            posMode: 'sale',
            cart: [],
            cartDrawerOpen: false,

            // REMISES & PROMO
            globalDiscount: { type: 'percent', value: 0 }, // type: 'percent' | 'fixed'
            promoCode: null,

            // Panier spécial Réservations (visible uniquement en mode réservation)
            reservationCart: [],
            reservationCartDrawerOpen: false,
            reservationManualDeliveryFee: 0,

            // Détails de livraison saisis par le vendeur (obligatoires pour COD)
            deliveryDetails: { name: '', phone: '', address: '', date: '', time: '' },
            categoryFilter: null,
            searchQuery: '',
            ordersFilter: 'all',
            ordersSearch: '',
            clientsSearch: '',
            livreursSearch: '',
            deliveriesSearch: '',
            deliveriesStatus: 'all',
            reservationsSearch: '',
            reservationsStatus: 'all',
            deliveryZoneId: null,
            manualDeliveryFee: 0,
            parkedCarts: [], // Paniers en attente

            // Retours
            returnsSearch: '',
            returnCart: [], // Items sélectionnés pour retour

            // Stock pagination & filtres
            stockSearch: '',
            stockCategoryFilter: 'all',
            stockStatusFilter: 'all',
            stockSortBy: 'name',
            stockPage: 1,
            stockPerPage: 30,

            // Clients Favoris
            favoriteClients: [], // [clientId]
            lastAccessedClients: [], // [{clientId, lastAccessDate}]

            // Préférences Personnelles
            preferences: {
                language: 'fr', // 'fr' | 'en' | 'es'
                notificationsEnabled: true,
                theme: 'light', // 'light' | 'dark' | 'auto'
                favoritedPaymentMethods: [], // ['cash', 'card', 'mobile_money']
                soundEnabled: true, // Audio notifications
                soundVolume: 0.5, // Volume 0 to 1
                keyboardShortcutsEnabled: true,
                soundNotificationsEnabled: true,
                emailNotificationsEnabled: false,
                compactMode: false,
                receiptLogoText: '', // Texte personnalisé pour le logo sur le reçu
                receiptSubtitle: '' // Sous-titre personnalisé pour le reçu
            }
        },

        // =====================
        // LOGIQUE PROMO / REMISES
        // =====================

        applyPromoCode(code) {
            const c = (code || '').trim().toUpperCase();
            if (!c) {
                this.state.promoCode = null;
                this.state.globalDiscount = { type: 'percent', value: 0 };
                return UI.toast('Code promo retiré', 'info');
            }

            // Codes promo depuis la base de données (gérés par le PDG/Manager)
            const dbPromos = (CORE.db.promoCodes || []).reduce((acc, p) => {
                if (p.active !== false && (!p.expiresAt || new Date(p.expiresAt) > new Date())) {
                    acc[p.code.toUpperCase()] = { type: p.type || 'percent', value: p.value || 0, label: p.label || p.code };
                }
                return acc;
            }, {});

            if (dbPromos[c]) {
                this.state.promoCode = c;
                this.state.globalDiscount = { type: dbPromos[c].type, value: dbPromos[c].value };
                UI.toast(`Code ${c} appliqué : ${dbPromos[c].label}`, 'success');
            } else {
                UI.toast('Code promo invalide', 'error');
            }
            App.rerender();
        },

        promptGlobalDiscount() {
            UI.modal('Remise Globale', `
                <div class="space-y-4">
                    <p class="text-xs text-slate-500">Appliquer une réduction sur le total du panier.</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="VendeurModule.setGlobalDiscount('percent', 5)" class="p-3 border border-slate-200 rounded-xl hover:bg-emerald-50 hover:border-emerald-200 font-bold text-sm">-5%</button>
                        <button onclick="VendeurModule.setGlobalDiscount('percent', 10)" class="p-3 border border-slate-200 rounded-xl hover:bg-emerald-50 hover:border-emerald-200 font-bold text-sm">-10%</button>
                        <button onclick="VendeurModule.setGlobalDiscount('percent', 15)" class="p-3 border border-slate-200 rounded-xl hover:bg-emerald-50 hover:border-emerald-200 font-bold text-sm">-15%</button>
                        <button onclick="VendeurModule.setGlobalDiscount('percent', 20)" class="p-3 border border-slate-200 rounded-xl hover:bg-emerald-50 hover:border-emerald-200 font-bold text-sm">-20%</button>
                    </div>
                    <div class="border-t border-slate-100 pt-3">
                        ${UI.input('custom_disc_val', 'Ou montant personnalisé', 'number', '', 'Montant en FCFA')}
                        <button onclick="VendeurModule.setGlobalDiscount('fixed', document.getElementById('custom_disc_val').value)" class="mt-2 w-full py-2 bg-slate-900 text-white rounded-xl font-bold text-sm">Appliquer montant</button>
                    </div>
                    <button onclick="VendeurModule.setGlobalDiscount('percent', 0)" class="w-full py-2 bg-red-50 text-red-600 rounded-xl font-bold text-sm">Annuler remise</button>
                </div>
            `, [ { label: 'Fermer', onclick: 'UI.closeModal()' } ]);
        },

        setGlobalDiscount(type, val) {
            const value = Number(val || 0);
            this.state.globalDiscount = { type, value };
            this.state.promoCode = null; // Reset promo code if manual override
            UI.closeModal();
            UI.toast(`Remise globale appliquée`, 'success');
            App.rerender();
        },

        promptLineDiscount(index) {
            const item = this.state.cart[index];
            if (!item) return;
            UI.modal(`Remise sur ${item.name}`, `
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="VendeurModule.setLineDiscount(${index}, 0)" class="p-2 border border-slate-200 rounded-xl text-xs font-bold hover:bg-red-50 text-red-600">0%</button>
                        <button onclick="VendeurModule.setLineDiscount(${index}, 5)" class="p-2 border border-slate-200 rounded-xl text-xs font-bold hover:bg-emerald-50">5%</button>
                        <button onclick="VendeurModule.setLineDiscount(${index}, 10)" class="p-2 border border-slate-200 rounded-xl text-xs font-bold hover:bg-emerald-50">10%</button>
                    </div>
                    ${UI.input('line_disc_custom', 'Autre %', 'number', item.discountPercent || '', 'Ex: 25')}
                    <button onclick="VendeurModule.setLineDiscount(${index}, document.getElementById('line_disc_custom').value)" class="w-full py-2 bg-slate-900 text-white rounded-xl font-bold text-sm">Appliquer</button>
                </div>
            `, [ { label: 'Fermer', onclick: 'UI.closeModal()' } ]);
        },

        setLineDiscount(index, percent) {
            const p = Utils.clamp(Number(percent || 0), 0, 100);
            if (this.state.cart[index]) {
                this.state.cart[index].discountPercent = p;
                // Recalc price logic handles the rest
            }
            UI.closeModal();
            App.rerender();
        },

        // Calcul du prix final d'une ligne (avec remise ligne + gros volume)
        getLinePrice(item) {
            let price = item.price;

            // 1. Prix de gros automatique (simulé) : si qty >= 10, -10% sur le prix de base
            if (item.qty >= 10) {
                // On applique le prix de gros sur la base, sauf si une remise ligne manuelle est plus forte ?
                // Ici on cumule ou on prend le meilleur ? Disons qu'on applique le prix de gros comme base.
                // Pour simplifier : Wholesale est une "remise ligne automatique".
                // Si l'utilisateur a mis une remise manuelle, on prend celle-là. Sinon on checke le volume.
                if (item.discountPercent === undefined || item.discountPercent === null) {
                    // Pas de remise manuelle, on check le volume
                    return Math.round(price * 0.9); // -10% auto
                }
            }

            // 2. Remise ligne manuelle
            if (item.discountPercent > 0) {
                price = price * (1 - (item.discountPercent / 100));
            }

            return Math.round(price);
        },

        // =====================
        // PANIERS EN ATTENTE (Park/Retrieve)
        // =====================
        parkCurrentCart() {
            if (this.state.cart.length === 0) return UI.toast('Panier vide', 'warning');

            const clientName = this.state.deliveryDetails?.name || (this.state.selectedClientId ? CORE.getClient(this.state.selectedClientId)?.name : '');
            const defaultName = clientName ? `Client: ${clientName}` : `Panier ${new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})}`;

            UI.modal('Mettre en attente', `
                <div class="space-y-4">
                    <p class="text-slate-500 text-sm">Mettre ce panier de côté pour le reprendre plus tard.</p>
                    ${UI.input('park_name', 'Nom de référence', 'text', defaultName, 'Ex: Client chemise bleue', true)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Mettre en attente', onclick: 'VendeurModule.saveParkedCart()', class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        saveParkedCart() {
            const name = UI.val('park_name').trim() || 'Panier sans nom';

            this.state.parkedCarts.push({
                id: CORE.uid(),
                name: name,
                items: [...this.state.cart], // Copie du tableau
                deliveryDetails: { ...this.state.deliveryDetails },
                selectedClientId: this.state.selectedClientId,
                manualDeliveryFee: this.state.manualDeliveryFee,
                total: this.getGrandTotal(),
                savedAt: new Date()
            });

            this.clearCart(); // Vide le panier actuel
            UI.closeModal();
            UI.toast('Panier mis en attente', 'success');
            App.rerender();
        },

        showParkedCartsModal() {
            const list = this.state.parkedCarts.sort((a,b) => b.savedAt - a.savedAt);

            UI.modal('Paniers en attente (' + list.length + ')', `
                <div class="space-y-3 max-h-[60vh] overflow-y-auto">
                    ${list.length === 0 ? '<div class="p-8 text-center text-slate-400 font-medium">Aucun panier en attente</div>' : list.map(p => `
                        <div class="p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 transition flex items-center justify-between gap-4">
                            <div class="min-w-0">
                                <div class="font-black text-slate-900 truncate">${p.name}</div>
                                <div class="text-xs text-slate-500">
                                    ${p.items.length} articles • ${CORE.formatPrice(p.total)}
                                    <span class="mx-1">•</span> ${CORE.formatTime(p.savedAt)}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="VendeurModule.deleteParkedCart(${p.id})" class="p-2 rounded-xl bg-red-50 text-red-600 hover:bg-red-100 transition" title="Supprimer">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                                <button onclick="VendeurModule.restoreParkedCart(${p.id})" class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700 transition flex items-center gap-2">
                                    Reprendre <i data-lucide="arrow-right" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        restoreParkedCart(id) {
            const index = this.state.parkedCarts.findIndex(p => p.id === id);
            if (index === -1) return;
            const parked = this.state.parkedCarts[index];

            // Si le panier actuel n'est pas vide, on demande confirmation ou on propose d'échanger
            if (this.state.cart.length > 0) {
                if (!confirm("Le panier actuel n'est pas vide. Voulez-vous l'écraser par le panier en attente ?")) return;
            }

            // Restauration
            this.state.cart = [...parked.items];
            this.state.deliveryDetails = { ...parked.deliveryDetails };
            this.state.selectedClientId = parked.selectedClientId;
            this.state.manualDeliveryFee = parked.manualDeliveryFee || 0;

            // Suppression de la liste des attentes
            this.state.parkedCarts.splice(index, 1);

            UI.closeModal();
            UI.toast('Panier repris', 'success');
            App.rerender();
        },

        deleteParkedCart(id) {
            this.state.parkedCarts = this.state.parkedCarts.filter(p => p.id !== id);
            // Réactualiser la modale
            this.showParkedCartsModal();
        },

        init() {
            console.log('[VendeurModule] init called');
            console.log('[VendeurModule] init - this.state.theme:', this.state.theme);
            this.loadPreferences(); // Charger les préférences sauvegardées
            this.loadThemePreference(); // Charger et appliquer le thème sauvegardé
            this.loadLanguagePreference(); // Charger la langue préférée
            console.log('[VendeurModule] init - after loadThemePreference, this.state.theme:', this.state.theme);
            CORE.initDefaultMessageTemplates(); // Initialiser les templates de messages
            // Plus de données simulées - l'entreprise démarre vide
        },

        seed() {
            // Fonction désactivée - pas de données de démonstration
            console.log('[VendeurModule] seed() désactivé - entreprise démarre vierge');
        },

        navigateTo(view) {
            console.log('[PDG] navigateTo:', view);
            this.state.currentView = view;
            try { App.rerender(); } catch(e) { console.error('[PDG] rerender crashed:', e); alert('Erreur rendu: ' + e.message); }
        },

        getOfflineStatus() {
            const pendingCount = (CORE.db.pendingSyncs || []).length;
            return {
                isOnline: CORE.state.isOnline,
                pendingCount,                // ...existing code...
                showPOSModal() {
                  if (!CORE.hasPermission('managePos')) {
                    return UI.toast('Accès refusé', 'error');
                  }
                  // Si ManagerModule expose le gestionnaire POS, l'utiliser
                  if (typeof ManagerModule?.showPosManager === 'function') {
                    return ManagerModule.showPosManager();
                  }
                  // Sinon utiliser un module POS partagé
                  if (typeof POSModule?.showManager === 'function') {
                    return POSModule.showManager();
                  }
                  UI.toast('Module POS indisponible', 'warning');
                },
                // ...existing code...
                lastSync: CORE.state.lastSync,
                offlineWarning: !CORE.state.isOnline && this.state.cart.length > 0
            };
        },

        setTheme(theme) {
            console.log('[VendeurModule] setTheme - START with theme:', theme);
            this.state.theme = theme;
            this.state.preferences.theme = theme;
            localStorage.setItem('vendeur_theme', theme);
            console.log('[VendeurModule] setTheme - saved theme to localStorage:', theme);
            console.log('[VendeurModule] setTheme - calling savePreferences...');
            this.savePreferences();
            console.log('[VendeurModule] setTheme - savePreferences done');

            // Appliquer le thème directement (pas d'appel à this.applyTheme)
            const html = document.documentElement;
            const body = document.body;
            console.log('[VendeurModule] setTheme - applying theme directly:', theme);

            html.classList.remove('vendeur-dark', 'vendeur-light', 'vendeur-auto');
            if (body) body.classList.remove('vendeur-dark', 'vendeur-light', 'vendeur-auto');

            if (theme === 'dark') {
                html.classList.add('vendeur-dark');
                if (body) body.classList.add('vendeur-dark');
                html.style.filter = 'none';
                html.style.backgroundColor = '#111b21';
                console.log('[VendeurModule] setTheme - applied WhatsApp dark theme');
            } else if (theme === 'light') {
                html.classList.add('vendeur-light');
                if (body) body.classList.add('vendeur-light');
                html.style.filter = 'none';
                html.style.backgroundColor = '#ffffff';
                console.log('[VendeurModule] setTheme - applied light theme');
            } else if (theme === 'auto') {
                html.classList.add('vendeur-auto');
                if (body) body.classList.add('vendeur-auto');
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.filter = 'none';
                html.style.backgroundColor = isDark ? '#111b21' : '#ffffff';
                if (isDark) {
                    html.classList.add('vendeur-dark');
                    if (body) body.classList.add('vendeur-dark');
                }
                console.log('[VendeurModule] setTheme - auto theme, isDark:', isDark);
            }

            UI.toast(`Thème: ${theme === 'light' ? 'Clair' : theme === 'dark' ? 'Sombre' : 'Auto'}`, 'success');
            console.log('[VendeurModule] setTheme - UI.toast done, calling App.rerender...');
            App.rerender();
            console.log('[VendeurModule] setTheme - DONE');
        },

        applyTheme() {
            const html = document.documentElement;
            const body = document.body;
            const theme = this.state.theme;
            console.log('[VendeurModule] applyTheme - applying theme:', theme);

            // Enlever toutes les classes de thème
            html.classList.remove('vendeur-dark', 'vendeur-light', 'vendeur-auto');
            if (body) body.classList.remove('vendeur-dark', 'vendeur-light', 'vendeur-auto');

            if (theme === 'dark') {
                html.classList.add('vendeur-dark');
                if (body) body.classList.add('vendeur-dark');
                html.style.filter = 'none';
                html.style.backgroundColor = '#111b21';
                console.log('[VendeurModule] applyTheme - applied WhatsApp dark theme');
            } else if (theme === 'light') {
                html.classList.add('vendeur-light');
                if (body) body.classList.add('vendeur-light');
                html.style.filter = 'none';
                html.style.backgroundColor = '#ffffff';
                console.log('[VendeurModule] applyTheme - applied light theme');
            } else if (theme === 'auto') {
                html.classList.add('vendeur-auto');
                if (body) body.classList.add('vendeur-auto');
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.filter = 'none';
                html.style.backgroundColor = isDark ? '#111b21' : '#ffffff';
                if (isDark) {
                    html.classList.add('vendeur-dark');
                    if (body) body.classList.add('vendeur-dark');
                }
                console.log('[VendeurModule] applyTheme - auto theme, isDark:', isDark);
            }
        },

        loadThemePreference() {
            const saved = localStorage.getItem('vendeur_theme');
            console.log('[VendeurModule] loadThemePreference - saved from localStorage:', saved);
            if (saved) {
                this.state.theme = saved;
                console.log('[VendeurModule] loadThemePreference - set theme to:', this.state.theme);
                this.applyTheme();
            }
        },

        // Changer la langue
        setLanguage(lang) {
            this.state.preferences.language = lang;
            CORE.db.config = CORE.db.config || {};
            CORE.db.config.language = lang;
            localStorage.setItem('vendeur_language', lang);
            localStorage.setItem('raya_language', lang);

            // Utiliser le système i18n global
            i18n.setLang(lang);

            this.savePreferences();
            CORE.save(true);

            const langNames = { fr: 'Français', en: 'English', es: 'Español' };
            UI.toast(`✓ ${t('settings.language')}: ${langNames[lang] || lang}`, 'success');
            App.rerender();
        },

        loadLanguagePreference() {
            const saved = localStorage.getItem('vendeur_language') || localStorage.getItem('raya_language');
            if (saved) {
                this.state.preferences.language = saved;
                CORE.db.config = CORE.db.config || {};
                CORE.db.config.language = saved;
                // Synchroniser avec i18n global
                i18n.setLang(saved);
            }
        },

        // =====================
        // PROFIL VENDEUR PERSONNALISÉ
        // =====================
        getVendorProfile(userId) {
            const user = CORE.getUser(userId);
            if (!user || user.role !== 'vendeur') return null;
            return user;
        },

        getVendorStats(userId) {
            const user = CORE.getUser(userId);
            if (!user) return null;

            const userOrders = CORE.getVisibleOrders().filter(o => o.sellerId === userId && o.status === 'delivered');
            const totalSales = userOrders.reduce((a, o) => a + (o.total || 0), 0);
            const orderCount = userOrders.length;
            const avgOrder = orderCount > 0 ? Math.round(totalSales / orderCount) : 0;

            return {
                totalSales,
                salesCount: orderCount,
                avgOrder,
                rating: user.rating || 0,
                specialties: user.specialties || [],
                badge: user.badge || null,
                joinedDate: user.joinedDate || null
            };
        },

        // Independent Delivery Men Management
        showAddIndependentDeliveryManModal() {
            const settings = CORE.getGestionnaireSettings();

            UI.modal('➕ Ajouter livreur indépendant', `
                <div class="space-y-4">
                    ${UI.input('idm_name','Nom complet','text','','Ex: Mohamed Diallo',true)}
                    ${UI.input('idm_phone','Téléphone','tel','', CORE.getPhonePlaceholder(), true)}
                    ${UI.textarea('idm_notes','Notes (optionnel)','','Ex: Livre pour Plateau/Poto-Poto...',2)}
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl text-xs text-blue-700">
                        <div class="font-black mb-2">📱 Bons de livraison par SMS</div>
                        <p>Ce livreur indépendant recevra les bons de livraison uniquement par SMS avec tous les détails (client, adresse, montant).</p>
                    </div>
                    ${settings.independentDeliveryMenApprovalRequired ?
                        `<div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl text-xs text-amber-700">
                            <div class="font-black mb-1">⏳ Approbation requise</div>
                            <p>Ce livreur doit être approuvé par le gestionnaire avant d'être utilisé.</p>
                        </div>` :
                        `<div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl text-xs text-emerald-700">
                            <div class="font-black mb-1">✅ Approbation automatique</div>
                            <p>Ce livreur sera immédiatement disponible pour les livraisons.</p>
                        </div>`
                    }
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Ajouter', onclick: 'VendeurModule.saveIndependentDeliveryMan()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        saveIndependentDeliveryMan() {
            const name = UI.val('idm_name').trim();
            const phone = UI.val('idm_phone').trim();
            const notes = UI.val('idm_notes').trim();

            if (!name || !phone) return UI.toast('Nom et téléphone requis', 'warning');

            const vendeurId = CORE.state.currentUser?.id;
            const created = CORE.createIndependentDeliveryMan(name, phone, vendeurId, notes);

            if (created) {
                UI.closeModal();
                UI.toast(`Livreur indépendant "${name}" ajouté`, 'success');
                VendeurModule.showIndependentDeliveryMenList();
            }
        },

        showIndependentDeliveryMenList() {
            const vendeurId = CORE.state.currentUser?.id;
            const settings = CORE.getGestionnaireSettings();
            const allDeliveryMen = CORE.db.independentDeliveryMen.filter(dm => String(dm.vendeurId) == String(vendeurId));
            const approvedDeliveryMen = allDeliveryMen.filter(dm => dm.approvalStatus === 'approved');
            const pendingDeliveryMen = allDeliveryMen.filter(dm => dm.approvalStatus === 'pending');
            const rejectedDeliveryMen = allDeliveryMen.filter(dm => dm.approvalStatus === 'rejected');

            UI.modal('👥 Mes livreurs indépendants', `
                <div class="space-y-4 max-h-[600px] overflow-y-auto">
                    <div class="flex gap-2">
                        <button onclick="VendeurModule.showAddIndependentDeliveryManModal()" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-xl font-black text-sm hover:bg-emerald-700 transition flex items-center justify-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i> Ajouter
                        </button>
                    </div>

                    ${settings.independentDeliveryMenApprovalRequired && pendingDeliveryMen.length > 0 ? `
                        <div class="p-4 bg-amber-50 border-2 border-amber-300 rounded-2xl">
                            <div class="flex items-start gap-2">
                                <i data-lucide="hourglass" class="w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0"></i>
                                <div>
                                    <div class="font-black text-amber-900">En attente d'approbation</div>
                                    <div class="text-sm text-amber-800">${pendingDeliveryMen.length} livreur(s) doit/doivent être approuvé(s) par le gestionnaire avant d'être utilisé(s).</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    ${approvedDeliveryMen.length === 0 && allDeliveryMen.length === 0 ? `
                        <div class="text-center py-12 text-slate-400">
                            <i data-lucide="users" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                            <div class="font-medium">Aucun livreur indépendant</div>
                            <div class="text-xs mt-1">Cliquez sur "Ajouter" pour commencer</div>
                        </div>
                    ` : `
                        <div class="border-t border-slate-200 pt-4">
                            ${approvedDeliveryMen.length > 0 ? `
                                <div class="mb-4">
                                    <div class="text-xs font-black text-emerald-700 uppercase mb-2">✅ Livreurs actifs (${approvedDeliveryMen.length})</div>
                                    <div class="space-y-2">
                                        ${approvedDeliveryMen.map(dm => `
                                            <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-xl">
                                                <div class="flex items-start justify-between">
                                                    <div>
                                                        <div class="font-black text-slate-900">${dm.name}</div>
                                                        <div class="text-sm text-slate-500 mt-1">📱 ${dm.phone}</div>
                                                    </div>
                                                    <span class="px-2 py-1 bg-emerald-600 text-white text-xs font-black rounded">Approuvé</span>
                                                </div>
                                                ${dm.notes ? `<div class="text-xs text-slate-600 mb-2 mt-2">📝 ${dm.notes}</div>` : ''}
                                                <div class="grid grid-cols-2 gap-2 text-xs text-slate-600 mb-3">
                                                    <div>Livraisons: <b>${dm.deliveryCount}</b></div>
                                                    <div>Gains: <b>${CORE.formatPrice(dm.totalEarnings)}</b></div>
                                                </div>
                                                <div class="flex gap-2">
                                                    <button onclick="VendeurModule.editIndependentDeliveryMan('${dm.id}')" class="flex-1 px-3 py-1.5 bg-blue-600 text-white text-xs font-black rounded hover:bg-blue-700">Éditer</button>
                                                    <button onclick="VendeurModule.deleteIndependentDeliveryMan('${dm.id}'); VendeurModule.showIndependentDeliveryMenList()" class="flex-1 px-3 py-1.5 bg-red-600 text-white text-xs font-black rounded hover:bg-red-700">Supprimer</button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${pendingDeliveryMen.length > 0 ? `
                                <div class="mb-4">
                                    <div class="text-xs font-black text-amber-700 uppercase mb-2">⏳ En attente (${pendingDeliveryMen.length})</div>
                                    <div class="space-y-2">
                                        ${pendingDeliveryMen.map(dm => `
                                            <div class="p-3 bg-amber-50 border border-amber-200 rounded-xl opacity-60">
                                                <div class="flex items-start justify-between">
                                                    <div>
                                                        <div class="font-black text-slate-900">${dm.name}</div>
                                                        <div class="text-sm text-slate-500 mt-1">📱 ${dm.phone}</div>
                                                    </div>
                                                    <span class="px-2 py-1 bg-amber-600 text-white text-xs font-black rounded">Attente</span>
                                                </div>
                                                ${dm.notes ? `<div class="text-xs text-slate-600 mb-2 mt-2">📝 ${dm.notes}</div>` : ''}
                                                <div class="flex gap-2">
                                                    <button onclick="VendeurModule.editIndependentDeliveryMan('${dm.id}')" class="flex-1 px-3 py-1.5 bg-blue-600 text-white text-xs font-black rounded hover:bg-blue-700">Éditer</button>
                                                    <button onclick="VendeurModule.deleteIndependentDeliveryMan('${dm.id}'); VendeurModule.showIndependentDeliveryMenList()" class="flex-1 px-3 py-1.5 bg-red-600 text-white text-xs font-black rounded hover:bg-red-700">Supprimer</button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}

                            ${rejectedDeliveryMen.length > 0 ? `
                                <div>
                                    <div class="text-xs font-black text-red-700 uppercase mb-2">❌ Rejetés (${rejectedDeliveryMen.length})</div>
                                    <div class="space-y-2">
                                        ${rejectedDeliveryMen.map(dm => `
                                            <div class="p-3 bg-red-50 border border-red-200 rounded-xl">
                                                <div class="flex items-start justify-between">
                                                    <div>
                                                        <div class="font-black text-slate-900">${dm.name}</div>
                                                        <div class="text-sm text-slate-500 mt-1">📱 ${dm.phone}</div>
                                                    </div>
                                                    <span class="px-2 py-1 bg-red-600 text-white text-xs font-black rounded">Rejeté</span>
                                                </div>
                                                ${dm.rejectionReason ? `<div class="text-xs text-red-700 font-medium mt-2 p-2 bg-red-100 rounded">Raison: ${dm.rejectionReason}</div>` : ''}
                                                <div class="flex gap-2 mt-2">
                                                    <button onclick="VendeurModule.deleteIndependentDeliveryMan('${dm.id}'); VendeurModule.showIndependentDeliveryMenList()" class="flex-1 px-3 py-1.5 bg-red-600 text-white text-xs font-black rounded hover:bg-red-700">Supprimer</button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        editIndependentDeliveryMan(deliveryManId) {
            const dm = CORE.db.independentDeliveryMen.find(m => String(m.id) == String(deliveryManId));
            if (!dm) return;

            UI.modal('✏️ Éditer livreur indépendant', '<div class="space-y-4">' + UI.input('edit_idm_name','Nom complet','text', dm.name || '', '',true) + UI.input('edit_idm_phone','Téléphone','tel', dm.phone || '', '', true) + UI.textarea('edit_idm_notes','Notes','', dm.notes || '', 2) + UI.select('edit_idm_status','Statut', [{value:'active',label:'Actif'},{value:'inactive',label:'Inactif'}], dm.status || 'active', true) + '</div>', [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'VendeurModule.updateIndependentDeliveryMan(\'' + deliveryManId + '\')', class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        updateIndependentDeliveryMan(deliveryManId) {
            const dm = CORE.db.independentDeliveryMen.find(m => String(m.id) == String(deliveryManId));
            if (!dm) return;

            const name = UI.val('edit_idm_name').trim();
            const phone = UI.val('edit_idm_phone').trim();
            const notes = UI.val('edit_idm_notes').trim();
            const status = UI.val('edit_idm_status');

            if (!name || !phone) return UI.toast('Nom et téléphone requis', 'warning');

            dm.name = name;
            dm.phone = phone;
            dm.notes = notes;
            dm.status = status;
            dm.updatedAt = new Date().toISOString();
            CORE.markDirty('independentDeliveryMen');
            CORE.save();

            UI.closeModal();
            UI.toast('Livreur mis à jour', 'success');
            App.rerender();
        },

        deleteIndependentDeliveryMan(deliveryManId) {
            if (!confirm('Supprimer ce livreur indépendant?')) return;

            const index = CORE.db.independentDeliveryMen.findIndex(m => String(m.id) == String(deliveryManId));
            if (index !== -1) {
                const deleted = CORE.db.independentDeliveryMen[index];
                CORE.db.independentDeliveryMen.splice(index, 1);

                // Unassign all deliveries referencing this deleted deliverer
                let unassignedCount = 0;
                (CORE.db.deliveries || []).forEach(d => {
                    if (d.livreurId && String(d.livreurId) === String(deliveryManId)) {
                        d.previousLivreurId = d.livreurId;
                        d.livreurId = null;
                        d.livreurName = null;
                        if (d.status !== 'livree' && d.status !== 'annulee') {
                            d.status = 'en_attente';
                        }
                        unassignedCount++;
                    }
                });

                CORE.markDirty('independentDeliveryMen');
                if (unassignedCount > 0) CORE.markDirty('deliveries');
                CORE.save();
                UI.toast('Livreur supprimé' + (unassignedCount > 0 ? ` (${unassignedCount} livraison(s) désassignée(s))` : ''), 'success');
                App.rerender();
            }
        },

        sendDeliveryBySMS(deliveryId, deliveryManId) {
            const result = CORE.sendDeliveryBySMS(deliveryId, deliveryManId);
            if (result) {
                UI.toast('Bon envoyé par SMS', 'success');
                App.rerender();
            } else {
                UI.toast('Erreur lors de l\'envoi', 'error');
            }
        },

        // Delivery Ticket Templates
        showDeliveryTemplatesModal() {
            const vendeurId = CORE.state.currentUser?.id;
            const smsTemplate = CORE.getOrCreateDefaultTemplate(vendeurId, 'SMS');
            const directTemplate = CORE.getOrCreateDefaultTemplate(vendeurId, 'Direct');
            const receiptSettings = CORE.getReceiptSettings(vendeurId);

            UI.modal('📋 Formats des bons et reçus', `
                <div class="space-y-6 max-h-[700px] overflow-y-auto">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl text-sm text-blue-700">
                        <div class="font-black mb-1">💡 Personnalisation</div>
                        <p>Personnalisez les formats des bons de livraison et des reçus imprimés par vos livreurs.</p>
                    </div>

                    <!-- Tabs -->
                    <div class="flex gap-2 border-b border-slate-200 pb-2">
                        <button onclick="VendeurModule.switchTemplateTab('sms')" id="tab_sms" class="px-4 py-2 rounded-xl font-bold text-sm bg-blue-100 text-blue-700">📱 SMS</button>
                        <button onclick="VendeurModule.switchTemplateTab('direct')" id="tab_direct" class="px-4 py-2 rounded-xl font-bold text-sm bg-slate-100 text-slate-600">🖨️ Direct</button>
                        <button onclick="VendeurModule.switchTemplateTab('receipt')" id="tab_receipt" class="px-4 py-2 rounded-xl font-bold text-sm bg-slate-100 text-slate-600">🧾 Reçu</button>
                    </div>

                    <!-- SMS Template -->
                    <div id="panel_sms" class="template-panel">
                        <div class="border border-slate-200 rounded-2xl overflow-hidden">
                            <div class="p-4 bg-slate-50 border-b border-slate-200 font-black text-slate-900">📱 Format SMS</div>
                            <div class="p-4">
                                <textarea id="sms_template" class="w-full h-40 px-3 py-2 border border-slate-200 rounded-xl font-mono text-sm" placeholder="Contenu du SMS...">${smsTemplate?.content || ''}</textarea>
                                <div class="mt-3 text-xs text-slate-600">
                                    <div class="font-black mb-2">Variables disponibles:</div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <span>• {orderRef} - Référence</span>
                                        <span>• {clientName} - Nom client</span>
                                        <span>• {address} - Adresse</span>
                                        <span>• {clientPhone} - Téléphone</span>
                                        <span>• {amount} - Montant total</span>
                                        <span>• {collectedAmount} - À collecter</span>
                                        <span>• {items} - Produits à livrer</span>
                                        <span>• {deliveryTime} - Heure de livraison</span>
                                    </div>
                                </div>
                                <button onclick="VendeurModule.saveDeliveryTemplate('SMS')" class="w-full mt-3 px-4 py-2 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition">
                                    💾 Enregistrer format SMS
                                </button>
                            </div>
                        </div>
                        <div class="border border-slate-200 rounded-2xl overflow-hidden mt-4">
                            <div class="p-4 bg-slate-50 border-b border-slate-200 font-black text-slate-900">👁️ Aperçu SMS</div>
                            <div class="p-4 bg-slate-900 text-white rounded-xl font-mono text-sm whitespace-pre-wrap break-words max-h-48 overflow-y-auto" id="sms_preview">
                                (aperçu du SMS)
                            </div>
                        </div>
                    </div>

                    <!-- Direct Template -->
                    <div id="panel_direct" class="template-panel hidden">
                        <div class="border border-slate-200 rounded-2xl overflow-hidden">
                            <div class="p-4 bg-slate-50 border-b border-slate-200 font-black text-slate-900">🖨️ Format Direct</div>
                            <div class="p-4">
                                <textarea id="direct_template" class="w-full h-40 px-3 py-2 border border-slate-200 rounded-xl font-mono text-sm" placeholder="Contenu du bon direct...">${directTemplate?.content || ''}</textarea>
                                <div class="mt-3 text-xs text-slate-600">
                                    <div class="font-black mb-2">Variables disponibles:</div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <span>• {orderRef} - Référence</span>
                                        <span>• {clientName} - Nom client</span>
                                        <span>• {address} - Adresse</span>
                                        <span>• {clientPhone} - Téléphone</span>
                                        <span>• {amount} - Montant total</span>
                                        <span>• {collectedAmount} - À collecter</span>
                                        <span>• {items} - Produits à livrer</span>
                                        <span>• {deliveryTime} - Heure de livraison</span>
                                    </div>
                                </div>
                                <button onclick="VendeurModule.saveDeliveryTemplate('Direct')" class="w-full mt-3 px-4 py-2 bg-orange-600 text-white font-black rounded-xl hover:bg-orange-700 transition">
                                    💾 Enregistrer format Direct
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Receipt Template -->
                    <div id="panel_receipt" class="template-panel hidden">
                        <div class="border border-slate-200 rounded-2xl overflow-hidden">
                            <div class="p-4 bg-slate-50 border-b border-slate-200 font-black text-slate-900">🧾 Format Reçu de Livraison</div>
                            <div class="p-4 space-y-4">
                                <!-- En-tête personnalisé -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Nom de l'entreprise</label>
                                    <input type="text" id="receipt_company_name" value="${receiptSettings.companyName || ''}" class="w-full px-3 py-2 border border-slate-200 rounded-xl" placeholder="Ex: Ma Boutique SARL">
                                </div>

                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Slogan / Sous-titre</label>
                                    <input type="text" id="receipt_subtitle" value="${receiptSettings.subtitle || ''}" class="w-full px-3 py-2 border border-slate-200 rounded-xl" placeholder="Ex: Livraison rapide et sûre">
                                </div>

                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Téléphone boutique</label>
                                    <input type="text" id="receipt_phone" value="${receiptSettings.phone || ''}" class="w-full px-3 py-2 border border-slate-200 rounded-xl" placeholder="Ex: ${CORE.getPhonePlaceholder()}">
                                </div>

                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Adresse boutique</label>
                                    <input type="text" id="receipt_address" value="${receiptSettings.address || ''}" class="w-full px-3 py-2 border border-slate-200 rounded-xl" placeholder="Ex: Abidjan, Cocody">
                                </div>

                                <!-- Options d'affichage -->
                                <div class="border-t border-slate-200 pt-4">
                                    <div class="font-bold text-slate-700 mb-3">Options d'affichage</div>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="receipt_show_logo" ${receiptSettings.showLogo !== false ? 'checked' : ''} class="w-4 h-4 rounded border-slate-300">
                                            <span class="text-sm">Afficher le logo/emoji</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="receipt_show_items" ${receiptSettings.showItems !== false ? 'checked' : ''} class="w-4 h-4 rounded border-slate-300">
                                            <span class="text-sm">Afficher le détail des articles</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="receipt_show_signature" ${receiptSettings.showSignature !== false ? 'checked' : ''} class="w-4 h-4 rounded border-slate-300">
                                            <span class="text-sm">Zone de signature client</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="receipt_show_commission" ${receiptSettings.showCommission ? 'checked' : ''} class="w-4 h-4 rounded border-slate-300">
                                            <span class="text-sm">Afficher la commission livreur</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="receipt_show_proof_photos" ${receiptSettings.showProofPhotos ? 'checked' : ''} class="w-4 h-4 rounded border-slate-300">
                                            <span class="text-sm">Mention "Photos de preuve"</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Message de remerciement -->
                                <div class="border-t border-slate-200 pt-4">
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Message de remerciement</label>
                                    <input type="text" id="receipt_thank_message" value="${receiptSettings.thankMessage || 'Merci pour votre confiance!'}" class="w-full px-3 py-2 border border-slate-200 rounded-xl" placeholder="Ex: Merci pour votre confiance!">
                                </div>

                                <!-- Note de bas de page -->
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-1">Note de bas de page (optionnel)</label>
                                    <textarea id="receipt_footer_note" class="w-full h-20 px-3 py-2 border border-slate-200 rounded-xl text-sm" placeholder="Ex: Conditions de retour, politique de remboursement...">${receiptSettings.footerNote || ''}</textarea>
                                </div>

                                <button onclick="VendeurModule.saveReceiptSettings()" class="w-full mt-3 px-4 py-2 bg-green-600 text-white font-black rounded-xl hover:bg-green-700 transition">
                                    💾 Enregistrer format Reçu
                                </button>
                            </div>
                        </div>

                        <!-- Aperçu du reçu -->
                        <div class="border border-slate-200 rounded-2xl overflow-hidden mt-4">
                            <div class="p-4 bg-slate-50 border-b border-slate-200 font-black text-slate-900 flex justify-between items-center">
                                <span>👁️ Aperçu du Reçu</span>
                                <button onclick="VendeurModule.refreshReceiptPreview()" class="px-3 py-1 bg-slate-200 text-slate-700 rounded-lg text-xs font-bold hover:bg-slate-300">🔄 Actualiser</button>
                            </div>
                            <div id="receipt_preview" class="p-4 bg-white max-h-80 overflow-y-auto">
                                <div class="mx-auto bg-slate-50 p-4 rounded-xl font-mono text-xs" style="max-width: 280px;">
                                    (Cliquez sur "Actualiser" pour voir l'aperçu)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            // Ajouter listeners pour l'aperçu SMS
            const smsInput = document.getElementById('sms_template');
            if (smsInput) {
                smsInput.addEventListener('input', () => {
                    document.getElementById('sms_preview').textContent = smsInput.value;
                });
            }
        },

        // Changer d'onglet de template
        switchTemplateTab(tab) {
            // Masquer tous les panels
            document.querySelectorAll('.template-panel').forEach(p => p.classList.add('hidden'));
            // Réinitialiser tous les tabs
            ['sms', 'direct', 'receipt'].forEach(t => {
                const btn = document.getElementById(`tab_${t}`);
                if (btn) {
                    btn.classList.remove('bg-blue-100', 'text-blue-700');
                    btn.classList.add('bg-slate-100', 'text-slate-600');
                }
            });
            // Afficher le panel sélectionné
            const panel = document.getElementById(`panel_${tab}`);
            if (panel) panel.classList.remove('hidden');
            // Activer le tab
            const activeBtn = document.getElementById(`tab_${tab}`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-slate-100', 'text-slate-600');
                activeBtn.classList.add('bg-blue-100', 'text-blue-700');
            }
            // Rafraîchir l'aperçu du reçu si on est sur l'onglet reçu
            if (tab === 'receipt') {
                setTimeout(() => this.refreshReceiptPreview(), 100);
            }
        },

        // Rafraîchir l'aperçu du reçu
        refreshReceiptPreview() {
            const settings = {
                companyName: UI.val('receipt_company_name') || CORE.getCompanyName(),
                subtitle: UI.val('receipt_subtitle') || 'Reçu de Livraison',
                phone: UI.val('receipt_phone') || '',
                address: UI.val('receipt_address') || '',
                showLogo: document.getElementById('receipt_show_logo')?.checked !== false,
                showItems: document.getElementById('receipt_show_items')?.checked !== false,
                showSignature: document.getElementById('receipt_show_signature')?.checked !== false,
                showCommission: document.getElementById('receipt_show_commission')?.checked || false,
                showProofPhotos: document.getElementById('receipt_show_proof_photos')?.checked || false,
                thankMessage: UI.val('receipt_thank_message') || 'Merci pour votre confiance!',
                footerNote: UI.val('receipt_footer_note') || ''
            };

            const previewHtml = `
                <div class="mx-auto bg-white border border-slate-200 p-3 rounded-lg font-mono text-[10px]" style="max-width: 280px;">
                    <div class="text-center mb-1"><span class="text-[9px] text-slate-400 italic">Aperçu du reçu</span></div>
                    <div class="text-center border-b border-dashed border-slate-400 pb-2 mb-2">
                        ${settings.showLogo ? '<div class="text-lg">🚚</div>' : ''}
                        <div class="font-bold text-sm">${settings.companyName}</div>
                        <div class="text-slate-500 text-[9px]">${settings.subtitle}</div>
                        ${settings.phone ? `<div class="text-[9px]">📞 ${settings.phone}</div>` : ''}
                        ${settings.address ? `<div class="text-[9px]">📍 ${settings.address}</div>` : ''}
                    </div>
                    <div class="border-b border-dashed border-slate-300 pb-2 mb-2">
                        <div class="flex justify-between"><span class="text-slate-500">N° Bon:</span><span class="font-bold text-slate-400">CMD-XXXXX</span></div>
                        <div class="flex justify-between"><span class="text-slate-500">Date:</span><span>${new Date().toLocaleDateString('fr-FR')}</span></div>
                        <div class="flex justify-between"><span class="text-slate-500">Statut:</span><span class="bg-green-500 text-white px-1 rounded text-[8px]">✓ LIVRéE</span></div>
                    </div>
                    <div class="border-b border-dashed border-slate-300 pb-2 mb-2">
                        <div class="flex justify-between"><span class="text-slate-500">Client:</span><span class="text-slate-400">Nom du client</span></div>
                        <div class="flex justify-between"><span class="text-slate-500">Tél:</span><span class="text-slate-400">+XXX XX XX XX XX</span></div>
                    </div>
                    ${settings.showItems ? `
                        <div class="border-b border-dashed border-slate-300 pb-2 mb-2">
                            <div class="font-bold mb-1">Articles</div>
                            <div class="flex justify-between text-[9px] text-slate-400"><span>Article 1</span><span>x2</span><span>--- F</span></div>
                            <div class="flex justify-between text-[9px] text-slate-400"><span>Article 2</span><span>x1</span><span>--- F</span></div>
                        </div>
                    ` : ''}
                    <div class="text-center font-bold text-sm py-2 bg-slate-100 rounded my-2">
                        TOTAL: --- F
                    </div>
                    ${settings.showCommission ? `
                        <div class="flex justify-between text-[9px] text-slate-500 border-b border-dashed border-slate-300 pb-2 mb-2">
                            <span>Commission livreur:</span><span>--- F</span>
                        </div>
                    ` : ''}
                    ${settings.showProofPhotos ? `
                        <div class="text-center text-[9px] text-green-600 border-b border-dashed border-slate-300 pb-2 mb-2">
                            📷 Photos de preuve jointes
                        </div>
                    ` : ''}
                    ${settings.showSignature ? `
                        <div class="text-center mt-3">
                            <div class="text-[9px] text-slate-500">Signature client</div>
                            <div class="border-b border-slate-400 w-24 mx-auto mt-4 mb-1"></div>
                        </div>
                    ` : ''}
                    <div class="text-center text-slate-500 mt-3 pt-2 border-t border-dashed border-slate-400">
                        <div>${settings.thankMessage}</div>
                        ${settings.footerNote ? `<div class="mt-1 text-[8px]">${settings.footerNote}</div>` : ''}
                    </div>
                </div>
            `;
            document.getElementById('receipt_preview').innerHTML = previewHtml;
        },

        // Sauvegarder les paramètres du reçu
        saveReceiptSettings() {
            const vendeurId = CORE.state.currentUser?.id;
            const settings = {
                companyName: UI.val('receipt_company_name')?.trim() || '',
                subtitle: UI.val('receipt_subtitle')?.trim() || '',
                phone: UI.val('receipt_phone')?.trim() || '',
                address: UI.val('receipt_address')?.trim() || '',
                showLogo: document.getElementById('receipt_show_logo')?.checked !== false,
                showItems: document.getElementById('receipt_show_items')?.checked !== false,
                showSignature: document.getElementById('receipt_show_signature')?.checked !== false,
                showCommission: document.getElementById('receipt_show_commission')?.checked || false,
                showProofPhotos: document.getElementById('receipt_show_proof_photos')?.checked || false,
                thankMessage: UI.val('receipt_thank_message')?.trim() || 'Merci pour votre confiance!',
                footerNote: UI.val('receipt_footer_note')?.trim() || ''
            };

            CORE.saveReceiptSettings(vendeurId, settings);
            UI.toast('Format du reçu enregistré', 'success');
            this.refreshReceiptPreview();
        },

        saveDeliveryTemplate(type) {
            const vendeurId = CORE.state.currentUser?.id;
            const content = type === 'SMS' ? UI.val('sms_template').trim() : UI.val('direct_template').trim();

            if (!content) return UI.toast('Le contenu ne peut pas être vide', 'warning');

            CORE.updateDeliveryTicketTemplate(vendeurId, type, content);
            UI.toast(`Format ${type} enregistré`, 'success');
        },

        showVendorProfileModal(userId) {
            const user = CORE.getUser(userId);
            if (!user || user.role !== 'vendeur') return;

            const stats = this.getVendorStats(userId);
            const badges = CORE.db.vendorBadges || [];
            const currentBadge = user.badge ? badges.find(b => b.id === user.badge) : null;
            const joinedDate = user.joinedDate ? new Date(user.joinedDate).toLocaleDateString('fr-FR') : '—';

            UI.modal(`👤 Profil - ${user.name}`, `
                <div class="space-y-6">
                    <!-- Header Profile -->
                    <div class="flex items-start gap-4">
                        <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-slate-300 to-slate-400 flex items-center justify-center text-2xl font-black text-white shadow-lg">
                            ${user.avatar}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h2 class="text-lg font-black text-slate-900">${user.name}</h2>
                                <div class="flex items-center gap-1">
                                    ${[...Array(Math.floor(stats.rating))].map(() => `<i data-lucide="star" class="w-4 h-4 text-yellow-400 fill-yellow-400"></i>`).join('')}
                                    <span class="text-xs font-black text-slate-600 ml-1">${stats.rating.toFixed(1)}</span>
                                </div>
                            </div>
                            <div class="text-xs text-slate-500">Membre depuis ${joinedDate}</div>
                            ${currentBadge ? `
                                <div class="mt-2 inline-flex items-center gap-1 px-2 py-1 bg-${currentBadge.color}-100 text-${currentBadge.color}-700 rounded-full text-xs font-bold">
                                    <i data-lucide="${currentBadge.icon}" class="w-3 h-3"></i> ${currentBadge.label}
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Bio & Spécialités -->
                    ${user.bio ? `
                        <div class="p-3 bg-slate-50 rounded-xl border border-slate-200">
                            <div class="text-xs font-bold text-slate-600 mb-1 uppercase">📝 Bio</div>
                            <div class="text-sm text-slate-700">${user.bio}</div>
                        </div>
                    ` : ''}

                    ${stats.specialties && stats.specialties.length > 0 ? `
                        <div class="p-3 bg-blue-50 rounded-xl border border-blue-200">
                            <div class="text-xs font-bold text-blue-600 mb-2 uppercase">🎯 Spécialités</div>
                            <div class="flex flex-wrap gap-1">
                                ${stats.specialties.map(s => `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-black">${s}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Statistiques -->
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="p-3 bg-emerald-50 rounded-xl">
                            <div class="text-2xl font-black text-emerald-600">${stats.salesCount}</div>
                            <div class="text-[10px] font-bold text-emerald-600 uppercase mt-1">Ventes</div>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-xl">
                            <div class="text-2xl font-black text-blue-600">${CORE.formatPrice(stats.totalSales).split(' ')[0]}</div>
                            <div class="text-[10px] font-bold text-blue-600 uppercase mt-1">Total</div>
                        </div>
                        <div class="p-3 bg-purple-50 rounded-xl">
                            <div class="text-2xl font-black text-purple-600">${CORE.formatPrice(stats.avgOrder).split(' ')[0]}</div>
                            <div class="text-[10px] font-bold text-purple-600 uppercase mt-1">Moyenne</div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showEditVendorProfileModal(userId) {
            const user = CORE.getUser(userId);
            if (!user || user.role !== 'vendeur') return;

            const specialtiesList = [
                'Laiterie', 'Épicerie', 'Huiles', 'Céréales', 'Boissons', 'Surgelés', 'Électronique', 'Hygiène',
                'Viande & Poisson', 'Fruits & Légumes', 'Boulangerie', 'Pâtisserie', 'Cosmétiques', 'Vêtements',
                'Chaussures', 'Accessoires', 'Pharmacie', 'Jouets', 'Livres', 'Fournitures Scolaires',
                'Équipement Maison', 'Mobilier', 'Décoration', 'Jardin', 'Animaux', 'Sport & Loisirs',
                'Beauté & Wellness', 'Technologie', 'Informatique', 'Travaux & Outils'
            ];

            UI.modal(`✏️ Éditer Profil - ${user.name}`, `
                <div class="space-y-4">
                    ${UI.textarea('vendor_bio', 'Bio / Description', user.bio || '', 'Décrivez vos expériences et spécialités...', 3)}

                    <div>
                        <label class="block text-xs font-black text-slate-500 uppercase tracking-wider mb-2">Spécialités (cochez celles qui vous correspondent)</label>
                        <div class="grid grid-cols-2 gap-2 max-h-96 overflow-y-auto p-2 border border-slate-200 rounded-xl bg-slate-50">
                            ${specialtiesList.map(s => `<label class="flex items-center gap-2 p-2 rounded-lg border border-slate-200 hover:bg-white cursor-pointer bg-white"><input type="checkbox" class="specialty-checkbox" value="${s}" ${(user.specialties || []).includes(s) ? 'checked' : ''}><span class="text-sm font-bold text-slate-700">${s}</span></label>`).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Sauvegarder', onclick: `VendeurModule.saveVendorProfile(${userId})`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        saveVendorProfile(userId) {
            const user = CORE.getUser(userId);
            if (!user) return;

            const bio = UI.val('vendor_bio').trim();
            const specialtyCheckboxes = document.querySelectorAll('.specialty-checkbox:checked');
            const specialties = Array.from(specialtyCheckboxes).map(cb => cb.value);

            user.bio = bio;
            user.specialties = specialties;
            CORE.save();

            UI.closeModal();
            UI.toast('Profil mis à jour ✓', 'success');
            App.rerender();
        },

        showVendorProfileModalFromSettings(userId) {
            this.showVendorProfileModal(userId);
            window.currentModalBack = () => this.showSettingsModal();
        },

        showEditVendorProfileModalFromSettings(userId) {
            this.showEditVendorProfileModal(userId);
            window.currentModalBack = () => this.showSettingsModal();
        },

        // =====================
        // KPIs & PERFORMANCES
        // =====================
        getKPIs(userId, period = 'today') {
            const user = CORE.getUser(userId);
            if (!user) return null;

            // Déterminer la date de début
            const now = new Date();
            let startDate = new Date();

            if (period === 'today') {
                startDate.setHours(0, 0, 0, 0);
            } else if (period === 'week') {
                startDate.setDate(now.getDate() - 7);
            } else if (period === 'month') {
                startDate.setDate(now.getDate() - 30);
            }

            const startTime = startDate.getTime();
            const userPos = user.pos;

            // Récupérer les commandes du vendeur pendant la période (filtré par POS)
            const userOrders = CORE.getVisibleOrders().filter(o =>
                o.sellerId === userId &&
                new Date(o.createdAt).getTime() >= startTime &&
                (o.posId == userPos || !o.posId || !userPos)
            );

            // Commandes livrées vs totales
            const deliveredOrders = userOrders.filter(o => o.status === 'delivered');
            const totalOrders = userOrders.length;

            // KPIs de vente
            const totalSales = deliveredOrders.reduce((a, o) => a + (o.total || 0), 0);
            const avgTicket = deliveredOrders.length > 0 ? Math.round(totalSales / deliveredOrders.length) : 0;
            const conversionRate = totalOrders > 0 ? Math.round((deliveredOrders.length / totalOrders) * 100) : 0;

            // Nombre de clients uniques
            const uniqueClients = [...new Set(userOrders
                .filter(o => o.clientId)
                .map(o => o.clientId))].length;

            // Clients par jour
            const daysInPeriod = Math.max(1, Math.ceil((now - startDate) / (1000 * 60 * 60 * 24)));
            const clientsPerDay = Math.round(uniqueClients / daysInPeriod);

            // Satisfaction client (basée sur les notes des clients)
            const clientsWithOrders = new Set(deliveredOrders.map(o => o.clientId).filter(Boolean));
            let satisfactionScore = 4.5; // Par défaut
            let satisfactionCount = 0;

            clientsWithOrders.forEach(clientId => {
                const c = CORE.getClient(clientId);
                if (c && c.tags) {
                    if (c.tags.includes('bon-client')) satisfactionScore += 1;
                    if (c.tags.includes('mauvais-client')) satisfactionScore -= 1;
                    satisfactionCount++;
                }
            });

            if (satisfactionCount > 0) {
                satisfactionScore = Math.max(1, Math.min(5, satisfactionScore / (satisfactionCount || 1)));
            }

            return {
                period,
                totalSales,
                avgTicket,
                uniqueClients,
                clientsPerDay,
                conversionRate,
                deliveredOrders: deliveredOrders.length,
                totalOrders,
                satisfactionScore: satisfactionScore.toFixed(1),
                daysInPeriod
            };
        },

        showKPIsModal(userId) {
            const user = CORE.getUser(userId);
            const kpis = {
                today: this.getKPIs(userId, 'today'),
                week: this.getKPIs(userId, 'week'),
                month: this.getKPIs(userId, 'month')
            };

            const currentKPIs = kpis.today;

            // Récupérer le nom du POS
            const posName = user?.pos ? (CORE.db.pos?.find(p => p.id === user.pos)?.name || 'POS inconnu') : 'Tous les POS';

            UI.modal('📈 KPIs & Performances', `
                <div class="space-y-6">
                    <!-- POS Filter Info -->
                    <div class="p-3 bg-indigo-50 rounded-xl border border-indigo-200 flex items-center gap-2">
                        <span class="text-xl">📍</span>
                        <div>
                            <div class="text-xs font-bold text-indigo-600 uppercase">Filtré par Point de Vente</div>
                            <div class="text-sm font-bold text-indigo-700">${posName}</div>
                        </div>
                    </div>

                    <!-- Period Selector -->
                    <div class="flex gap-2">
                        <button onclick="document.querySelectorAll('.kpi-period').forEach(e => e.classList.add('hidden')); document.getElementById('kpi-today').classList.remove('hidden'); this.classList.add('bg-emerald-600','text-white'); this.classList.remove('bg-slate-100','text-slate-700'); document.querySelectorAll('.kpi-btn').forEach(b => { if(b !== this) { b.classList.remove('bg-emerald-600','text-white'); b.classList.add('bg-slate-100','text-slate-700'); } })" class="kpi-btn px-4 py-2 bg-emerald-600 text-white rounded-lg font-bold text-sm hover:bg-emerald-700 transition">Aujourd'hui</button>
                        <button onclick="document.querySelectorAll('.kpi-period').forEach(e => e.classList.add('hidden')); document.getElementById('kpi-week').classList.remove('hidden'); this.classList.add('bg-emerald-600','text-white'); this.classList.remove('bg-slate-100','text-slate-700'); document.querySelectorAll('.kpi-btn').forEach(b => { if(b !== this) { b.classList.remove('bg-emerald-600','text-white'); b.classList.add('bg-slate-100','text-slate-700'); } })" class="kpi-btn px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-bold text-sm hover:bg-slate-200 transition">7 jours</button>
                        <button onclick="document.querySelectorAll('.kpi-period').forEach(e => e.classList.add('hidden')); document.getElementById('kpi-month').classList.remove('hidden'); this.classList.add('bg-emerald-600','text-white'); this.classList.remove('bg-slate-100','text-slate-700'); document.querySelectorAll('.kpi-btn').forEach(b => { if(b !== this) { b.classList.remove('bg-emerald-600','text-white'); b.classList.add('bg-slate-100','text-slate-700'); } })" class="kpi-btn px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-bold text-sm hover:bg-slate-200 transition">30 jours</button>
                    </div>

                    <!-- Today KPIs -->
                    <div id="kpi-today" class="kpi-period space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-4 bg-emerald-50 rounded-xl border border-emerald-200">
                                <div class="text-xs font-bold text-emerald-600 uppercase mb-1">💰 Total Ventes</div>
                                <div class="text-2xl font-black text-emerald-700">${CORE.formatPrice(kpis.today.totalSales)}</div>
                                <div class="text-xs text-emerald-600 mt-1">${kpis.today.deliveredOrders} ventes livrées</div>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
                                <div class="text-xs font-bold text-blue-600 uppercase mb-1">📊 Ticket Moyen</div>
                                <div class="text-2xl font-black text-blue-700">${CORE.formatPrice(kpis.today.avgTicket)}</div>
                                <div class="text-xs text-blue-600 mt-1">Par transaction</div>
                            </div>
                            <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
                                <div class="text-xs font-bold text-purple-600 uppercase mb-1">👥 Clients Uniques</div>
                                <div class="text-2xl font-black text-purple-700">${kpis.today.uniqueClients}</div>
                                <div class="text-xs text-purple-600 mt-1">${kpis.today.clientsPerDay} par jour</div>
                            </div>
                            <div class="p-4 bg-amber-50 rounded-xl border border-amber-200">
                                <div class="text-xs font-bold text-amber-600 uppercase mb-1">🎯 Conversion</div>
                                <div class="text-2xl font-black text-amber-700">${kpis.today.conversionRate}%</div>
                                <div class="text-xs text-amber-600 mt-1">${kpis.today.totalOrders} paniers créés</div>
                            </div>
                        </div>

                        <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-xs font-bold text-yellow-600 uppercase">⭐ Satisfaction Client</div>
                                <div class="text-2xl font-black text-yellow-700">${kpis.today.satisfactionScore}/5</div>
                            </div>
                            <div class="flex gap-1">
                                ${[...Array(5)].map((_, i) => `
                                    <div class="h-1 flex-1 rounded-full ${i < Math.floor(kpis.today.satisfactionScore) ? 'bg-yellow-400' : 'bg-slate-200'}"></div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Week KPIs -->
                    <div id="kpi-week" class="kpi-period hidden space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-4 bg-emerald-50 rounded-xl border border-emerald-200">
                                <div class="text-xs font-bold text-emerald-600 uppercase mb-1">💰 Total Ventes</div>
                                <div class="text-2xl font-black text-emerald-700">${CORE.formatPrice(kpis.week.totalSales)}</div>
                                <div class="text-xs text-emerald-600 mt-1">${kpis.week.deliveredOrders} ventes</div>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
                                <div class="text-xs font-bold text-blue-600 uppercase mb-1">📊 Ticket Moyen</div>
                                <div class="text-2xl font-black text-blue-700">${CORE.formatPrice(kpis.week.avgTicket)}</div>
                                <div class="text-xs text-blue-600 mt-1">7 derniers jours</div>
                            </div>
                            <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
                                <div class="text-xs font-bold text-purple-600 uppercase mb-1">👥 Clients Uniques</div>
                                <div class="text-2xl font-black text-purple-700">${kpis.week.uniqueClients}</div>
                                <div class="text-xs text-purple-600 mt-1">${kpis.week.clientsPerDay} par jour</div>
                            </div>
                            <div class="p-4 bg-amber-50 rounded-xl border border-amber-200">
                                <div class="text-xs font-bold text-amber-600 uppercase mb-1">🎯 Conversion</div>
                                <div class="text-2xl font-black text-amber-700">${kpis.week.conversionRate}%</div>
                                <div class="text-xs text-amber-600 mt-1">${kpis.week.totalOrders} paniers</div>
                            </div>
                        </div>
                        <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-xs font-bold text-yellow-600 uppercase">⭐ Satisfaction Client</div>
                                <div class="text-2xl font-black text-yellow-700">${kpis.week.satisfactionScore}/5</div>
                            </div>
                            <div class="flex gap-1">
                                ${[...Array(5)].map((_, i) => `
                                    <div class="h-1 flex-1 rounded-full ${i < Math.floor(kpis.week.satisfactionScore) ? 'bg-yellow-400' : 'bg-slate-200'}"></div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Month KPIs -->
                    <div id="kpi-month" class="kpi-period hidden space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-4 bg-emerald-50 rounded-xl border border-emerald-200">
                                <div class="text-xs font-bold text-emerald-600 uppercase mb-1">💰 Total Ventes</div>
                                <div class="text-2xl font-black text-emerald-700">${CORE.formatPrice(kpis.month.totalSales)}</div>
                                <div class="text-xs text-emerald-600 mt-1">${kpis.month.deliveredOrders} ventes</div>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-xl border border-blue-200">
                                <div class="text-xs font-bold text-blue-600 uppercase mb-1">📊 Ticket Moyen</div>
                                <div class="text-2xl font-black text-blue-700">${CORE.formatPrice(kpis.month.avgTicket)}</div>
                                <div class="text-xs text-blue-600 mt-1">30 derniers jours</div>
                            </div>
                            <div class="p-4 bg-purple-50 rounded-xl border border-purple-200">
                                <div class="text-xs font-bold text-purple-600 uppercase mb-1">👥 Clients Uniques</div>
                                <div class="text-2xl font-black text-purple-700">${kpis.month.uniqueClients}</div>
                                <div class="text-xs text-purple-600 mt-1">${kpis.month.clientsPerDay} par jour</div>
                            </div>
                            <div class="p-4 bg-amber-50 rounded-xl border border-amber-200">
                                <div class="text-xs font-bold text-amber-600 uppercase mb-1">🎯 Conversion</div>
                                <div class="text-2xl font-black text-amber-700">${kpis.month.conversionRate}%</div>
                                <div class="text-xs text-amber-600 mt-1">${kpis.month.totalOrders} paniers</div>
                            </div>
                        </div>
                        <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-xs font-bold text-yellow-600 uppercase">⭐ Satisfaction Client</div>
                                <div class="text-2xl font-black text-yellow-700">${kpis.month.satisfactionScore}/5</div>
                            </div>
                            <div class="flex gap-1">
                                ${[...Array(5)].map((_, i) => `
                                    <div class="h-1 flex-1 rounded-full ${i < Math.floor(kpis.month.satisfactionScore) ? 'bg-yellow-400' : 'bg-slate-200'}"></div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        // =====================
        // CLIENTS FAVORIS & HISTORIQUE
        // =====================
        toggleFavoriteClient(clientId) {
            const idx = this.state.favoriteClients.indexOf(clientId);
            if (idx >= 0) {
                this.state.favoriteClients.splice(idx, 1);
                UI.toast('Client retiré des favoris', 'info');
            } else {
                this.state.favoriteClients.push(clientId);
                UI.toast('Client ajouté aux favoris ⭐', 'success');
            }
            CORE.save();
            App.rerender();
        },

        isFavoriteClient(clientId) {
            return this.state.favoriteClients.includes(clientId);
        },

        recordClientAccess(clientId) {
            if (!clientId) return;
            const now = new Date().toISOString();
            const idx = this.state.lastAccessedClients.findIndex(a => a.clientId === clientId);
            if (idx >= 0) {
                this.state.lastAccessedClients.splice(idx, 1);
            }
            this.state.lastAccessedClients.unshift({ clientId, lastAccessDate: now });
            // Garder seulement les 10 derniers accès
            this.state.lastAccessedClients = this.state.lastAccessedClients.slice(0, 10);
            CORE.save();
        },

        getFavoriteClients() {
            return this.state.favoriteClients
                .map(clientId => CORE.getClient(clientId))
                .filter(c => c !== null)
                .map(c => {
                    const orders = CORE.getVisibleOrders().filter(o => o.clientId === c.id && o.status === 'delivered');
                    return {
                        ...c,
                        orderCount: orders.length,
                        totalSpent: orders.reduce((a, o) => a + (o.total || 0), 0),
                        lastOrder: orders.length > 0 ? orders[orders.length - 1].createdAt : null
                    };
                });
        },

        getRecentClients() {
            return this.state.lastAccessedClients
                .map(a => CORE.getClient(a.clientId))
                .filter(c => c !== null)
                .slice(0, 5);
        },

        showFavoritesModal() {
            const favorites = this.getFavoriteClients();

            if (favorites.length === 0) {
                UI.toast('Aucun client favori pour le moment', 'info');
                return;
            }

            UI.modal(`⭐ Clients Favoris (${favorites.length})`, `
                <div class="space-y-3 max-h-96 overflow-y-auto">
                    ${favorites.map(c => {
                        const lastOrderDate = c.lastOrder ? new Date(c.lastOrder).toLocaleDateString('fr-FR') : '—';
                        return `
                            <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl hover:bg-slate-100 transition cursor-pointer" onclick="VendeurModule.recordClientAccess(${c.id}); VendeurModule.selectClient(${c.id}); UI.closeModal()">
                                <div class="flex items-start justify-between mb-2">
                                    <div class="flex-1">
                                        <h3 class="font-bold text-slate-900">${c.name}</h3>
                                        <p class="text-xs text-slate-600">${c.phone || '—'}</p>
                                    </div>
                                    <button onclick="event.stopPropagation(); VendeurModule.toggleFavoriteClient(${c.id})" class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-lg text-xs font-bold hover:bg-yellow-200 transition">⭐ Retirer</button>
                                </div>
                                <div class="grid grid-cols-3 gap-2 text-xs">
                                    <div class="p-2 bg-white rounded-lg border border-slate-200">
                                        <div class="font-bold text-slate-900">${c.orderCount}</div>
                                        <div class="text-slate-600">Commandes</div>
                                    </div>
                                    <div class="p-2 bg-white rounded-lg border border-slate-200">
                                        <div class="font-bold text-slate-900">${CORE.formatPrice(c.totalSpent).split(' ')[0]}</div>
                                        <div class="text-slate-600">Dépensé</div>
                                    </div>
                                    <div class="p-2 bg-white rounded-lg border border-slate-200">
                                        <div class="font-bold text-slate-900">${lastOrderDate}</div>
                                        <div class="text-slate-600">Dernier</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        // =====================
        // PRÉFÉRENCES PERSONNELLES
        // =====================
        loadPreferences() {
            const saved = localStorage.getItem('vendeur_preferences');
            if (saved) {
                try {
                    this.state.preferences = { ...this.state.preferences, ...JSON.parse(saved) };
                } catch(e) {}
            }
        },

        savePreferences() {
            console.log('[VendeurModule] savePreferences called');
            try {
                localStorage.setItem('vendeur_preferences', JSON.stringify(this.state.preferences));
                console.log('[VendeurModule] savePreferences - saved to localStorage');
                CORE.save();
                console.log('[VendeurModule] savePreferences - CORE.save() called');
            } catch(e) {
                console.error('[VendeurModule] savePreferences ERROR:', e);
            }
        },

        showPreferencesModal() {
            const prefs = this.state.preferences;
            const user = CORE.state.currentUser;
            const posData = CORE.getPOS(user?.pos);

            const paymentMethods = [
                { id: 'cash', label: 'Espèces', icon: '💵', desc: 'Paiement comptant' },
                { id: 'card', label: 'Carte', icon: '💳', desc: 'Visa, Mastercard' },
                { id: 'mobile_money', label: 'Mobile Money', icon: '📱', desc: 'Orange, MTN, Airtel' },
                { id: 'check', label: 'Chèque', icon: '✍️', desc: 'Paiement différé' }
            ];

            const languages = [
                { code: 'fr', flag: '🇫🇷', name: 'Français' },
                { code: 'en', flag: '🇬🇧', name: 'English' },
                { code: 'es', flag: '🇪🇸', name: 'Español' },
                { code: 'pt', flag: '🇵🇹', name: 'Português' },
                { code: 'de', flag: '🇩🇪', name: 'Deutsch' },
                { code: 'it', flag: '🇮🇹', name: 'Italiano' },
                { code: 'ar', flag: '🇸🇦', name: 'العربية' },
                { code: 'zh', flag: '🇨🇳', name: '中文' },
                { code: 'ru', flag: '🇷🇺', name: 'Русский' }
            ];

            UI.modal('⚙️ Préférences', `
                <div class="space-y-4">
                    <!-- Tabs de navigation -->
                    <div class="flex border-b border-slate-200 -mx-6 px-6">
                        <button onclick="VendeurModule.switchSettingsTab('general')" id="tab-general" class="flex-1 px-4 py-3 text-sm font-bold text-emerald-600 border-b-2 border-emerald-500 bg-emerald-50/50 flex items-center justify-center gap-2">
                            <i data-lucide="sliders" class="w-4 h-4"></i>
                            Général
                        </button>
                        <button onclick="VendeurModule.switchSettingsTab('appearance')" id="tab-appearance" class="flex-1 px-4 py-3 text-sm font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 flex items-center justify-center gap-2 transition">
                            <i data-lucide="palette" class="w-4 h-4"></i>
                            Apparence
                        </button>
                        <button onclick="VendeurModule.switchSettingsTab('notifications')" id="tab-notifications" class="flex-1 px-4 py-3 text-sm font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 flex items-center justify-center gap-2 transition">
                            <i data-lucide="bell" class="w-4 h-4"></i>
                            Alertes
                        </button>
                        <button onclick="VendeurModule.switchSettingsTab('advanced')" id="tab-advanced" class="flex-1 px-4 py-3 text-sm font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 flex items-center justify-center gap-2 transition">
                            <i data-lucide="cog" class="w-4 h-4"></i>
                            Avancé
                        </button>
                    </div>

                    <!-- Contenu des tabs -->
                    <div class="max-h-[60vh] overflow-y-auto">

                        <!-- Tab: Général -->
                        <div id="content-general" class="space-y-6">
                            <!-- Langue (Tiroir) -->
                                <div class="rounded-2xl border border-slate-200 overflow-hidden">
                                    <button onclick="document.getElementById('language-drawer').classList.toggle('hidden'); document.getElementById('language-chevron').classList.toggle('rotate-180')" class="w-full flex items-center justify-between p-4 bg-gradient-to-r from-slate-50 to-white hover:from-blue-50 hover:to-indigo-50 transition-all">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
                                                <i data-lucide="globe" class="w-5 h-5 text-white"></i>
                                            </div>
                                            <div class="text-left">
                                                <h3 class="font-black text-slate-800">${t('settings.language')}</h3>
                                                <p class="text-xs text-slate-500">${languages.find(l => l.code === prefs.language)?.flag || '🌍'} ${languages.find(l => l.code === prefs.language)?.name || 'Français'}</p>
                                            </div>
                                        </div>
                                        <i id="language-chevron" data-lucide="chevron-down" class="w-5 h-5 text-slate-400 transition-transform duration-300"></i>
                                    </button>
                                    <div id="language-drawer" class="hidden border-t border-slate-200 bg-white p-4">
                                        <p class="text-xs text-slate-500 mb-3">${t('settings.chooseLanguage')}</p>
                                        <div class="grid grid-cols-3 gap-2">
                                            ${languages.map(lang => `
                                                <button onclick="VendeurModule.setLanguage('${lang.code}')" class="group relative px-3 py-3 rounded-xl font-bold text-sm transition-all duration-300 flex flex-col items-center gap-1 ${prefs.language === lang.code ? 'bg-gradient-to-br from-blue-500 to-indigo-600 text-white shadow-lg shadow-blue-200 scale-105' : 'bg-slate-50 text-slate-700 hover:bg-slate-100 hover:scale-102'}">
                                                    <span class="text-2xl">${lang.flag}</span>
                                                    <span class="text-xs">${lang.name}</span>
                                                    ${prefs.language === lang.code ? '<div class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full flex items-center justify-center"><i data-lucide="check" class="w-2.5 h-2.5 text-white"></i></div>' : ''}
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>

                                <!-- Modes de paiement -->
                                <div>
                                    <div class="flex items-center gap-2 mb-4">
                                        <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center">
                                            <i data-lucide="wallet" class="w-5 h-5 text-white"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-black text-slate-800">Paiements favoris</h3>
                                            <p class="text-xs text-slate-500">Sélectionnez vos modes préférés</p>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        ${paymentMethods.map(pm => {
                                            const isFav = prefs.favoritedPaymentMethods?.includes(pm.id);
                                            return `
                                                <button onclick="VendeurModule.togglePaymentMethodPreference('${pm.id}')" class="group p-4 rounded-xl border-2 transition-all duration-300 flex items-center gap-3 ${isFav ? 'bg-gradient-to-br from-emerald-50 to-green-50 border-emerald-400 shadow-lg shadow-emerald-100' : 'bg-white border-slate-200 hover:border-slate-300 hover:shadow-md'}">
                                                    <span class="text-2xl">${pm.icon}</span>
                                                    <div class="text-left flex-1">
                                                        <div class="font-bold text-sm ${isFav ? 'text-emerald-700' : 'text-slate-700'}">${pm.label}</div>
                                                        <div class="text-[10px] ${isFav ? 'text-emerald-600' : 'text-slate-400'}">${pm.desc}</div>
                                                    </div>
                                                    ${isFav ? '<i data-lucide="check-circle" class="w-5 h-5 text-emerald-500"></i>' : '<i data-lucide="circle" class="w-5 h-5 text-slate-300 group-hover:text-slate-400"></i>'}
                                                </button>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>

                            <!-- Tab: Apparence -->
                            <div id="content-appearance" class="space-y-6 hidden">
                                <!-- Thème -->
                                <div>
                                    <div class="flex items-center gap-2 mb-4">
                                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center">
                                            <i data-lucide="sun-moon" class="w-5 h-5 text-white"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-black text-slate-800">${t('settings.theme')}</h3>
                                            <p class="text-xs text-slate-500">Personnalisez l'apparence</p>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-3 gap-3">
                                        ${[
                                            { id: 'light', icon: '☀️', label: t('settings.light'), desc: 'Interface claire', gradient: 'from-amber-400 to-orange-500' },
                                            { id: 'dark', icon: '🌙', label: t('settings.dark'), desc: 'Mode sombre WhatsApp', gradient: 'from-slate-700 to-slate-900' },
                                            { id: 'auto', icon: '🔄', label: t('settings.auto'), desc: 'Suit le système', gradient: 'from-blue-500 to-purple-600' }
                                        ].map(theme => `
                                            <button onclick="VendeurModule.setTheme('${theme.id}')" class="group p-4 rounded-2xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${prefs.theme === theme.id ? 'border-emerald-400 shadow-xl shadow-emerald-100 scale-105' : 'border-slate-200 hover:border-slate-300 hover:shadow-lg'}">
                                                <div class="w-16 h-16 bg-gradient-to-br ${theme.gradient} rounded-xl flex items-center justify-center text-3xl shadow-lg ${prefs.theme === theme.id ? 'ring-4 ring-emerald-200' : ''}">
                                                    ${theme.icon}
                                                </div>
                                                <div class="text-center">
                                                    <div class="font-black text-sm text-slate-800">${theme.label}</div>
                                                    <div class="text-[10px] text-slate-500">${theme.desc}</div>
                                                </div>
                                                ${prefs.theme === theme.id ? '<div class="w-6 h-6 bg-emerald-500 rounded-full flex items-center justify-center"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>' : ''}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>

                                <!-- Mode compact -->
                                <div class="p-4 rounded-2xl bg-gradient-to-r from-slate-50 to-slate-100 border border-slate-200">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-white rounded-xl shadow-sm flex items-center justify-center">
                                                <i data-lucide="minimize-2" class="w-5 h-5 text-slate-600"></i>
                                            </div>
                                            <div>
                                                <div class="font-bold text-sm text-slate-800">Mode compact</div>
                                                <div class="text-xs text-slate-500">Interface plus dense</div>
                                            </div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" ${prefs.compactMode ? 'checked' : ''} onchange="VendeurModule.state.preferences.compactMode = this.checked; VendeurModule.savePreferences(); App.rerender()" class="sr-only peer">
                                            <div class="w-14 h-7 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all after:shadow-md peer-checked:bg-emerald-500"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab: Notifications -->
                            <div id="content-notifications" class="space-y-4 hidden">
                                <div class="flex items-center gap-2 mb-4">
                                    <div class="w-10 h-10 bg-gradient-to-br from-rose-500 to-red-600 rounded-xl flex items-center justify-center">
                                        <i data-lucide="bell-ring" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-black text-slate-800">Alertes & Sons</h3>
                                        <p class="text-xs text-slate-500">Configurez vos notifications</p>
                                    </div>
                                </div>

                                ${[
                                    { id: 'notificationsEnabled', icon: '🔔', label: 'Notifications push', desc: 'Alertes dans le navigateur', checked: prefs.notificationsEnabled },
                                    { id: 'soundNotificationsEnabled', icon: '🔊', label: 'Sons', desc: 'Alertes sonores', checked: prefs.soundNotificationsEnabled },
                                    { id: 'emailNotificationsEnabled', icon: '📧', label: 'Emails', desc: 'Résumé quotidien', checked: prefs.emailNotificationsEnabled }
                                ].map(opt => `
                                    <div class="p-4 rounded-2xl bg-white border border-slate-200 hover:shadow-md transition-all">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-3">
                                                <span class="text-2xl">${opt.icon}</span>
                                                <div>
                                                    <div class="font-bold text-sm text-slate-800">${opt.label}</div>
                                                    <div class="text-xs text-slate-500">${opt.desc}</div>
                                                </div>
                                            </div>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" ${opt.checked ? 'checked' : ''} onchange="VendeurModule.state.preferences.${opt.id} = this.checked; VendeurModule.savePreferences()" class="sr-only peer">
                                                <div class="w-14 h-7 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all after:shadow-md peer-checked:bg-emerald-500"></div>
                                            </label>
                                        </div>
                                    </div>
                                `).join('')}

                                <!-- Volume -->
                                <div class="p-4 rounded-2xl bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200">
                                    <div class="flex items-center gap-3 mb-3">
                                        <span class="text-2xl">🎚️</span>
                                        <div class="flex-1">
                                            <div class="font-bold text-sm text-slate-800">Volume des sons</div>
                                        </div>
                                        <span class="text-sm font-bold text-blue-600">${Math.round((prefs.soundVolume || 0.5) * 100)}%</span>
                                    </div>
                                    <input type="range" min="0" max="1" step="0.1" value="${prefs.soundVolume || 0.5}" onchange="VendeurModule.state.preferences.soundVolume = parseFloat(this.value); VendeurModule.savePreferences(); UI.playGenericNotificationSound('info')" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                                </div>
                            </div>

                            <!-- Tab: Avancé -->
                            <div id="content-advanced" class="space-y-4 hidden">
                                <div class="flex items-center gap-2 mb-4">
                                    <div class="w-10 h-10 bg-gradient-to-br from-slate-600 to-slate-800 rounded-xl flex items-center justify-center">
                                        <i data-lucide="settings-2" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-black text-slate-800">Paramètres avancés</h3>
                                        <p class="text-xs text-slate-500">Options pour utilisateurs expérimentés</p>
                                    </div>
                                </div>

                                <!-- Raccourcis clavier -->
                                <div class="p-4 rounded-2xl bg-white border border-slate-200">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">⌨️</span>
                                            <div>
                                                <div class="font-bold text-sm text-slate-800">Raccourcis clavier</div>
                                                <div class="text-xs text-slate-500">Productivité accrue</div>
                                            </div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" ${prefs.keyboardShortcutsEnabled ? 'checked' : ''} onchange="VendeurModule.state.preferences.keyboardShortcutsEnabled = this.checked; VendeurModule.savePreferences(); VendeurModule.showPreferencesModal()" class="sr-only peer">
                                            <div class="w-14 h-7 bg-slate-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all after:shadow-md peer-checked:bg-emerald-500"></div>
                                        </label>
                                    </div>
                                    ${prefs.keyboardShortcutsEnabled ? `
                                        <div class="grid grid-cols-2 gap-2 mt-3 p-3 bg-slate-50 rounded-xl">
                                            ${[
                                                { keys: 'Ctrl+S', action: 'Valider panier' },
                                                { keys: 'Ctrl+P', action: 'Imprimer ticket' },
                                                { keys: 'Ctrl+N', action: 'Nouveau panier' },
                                                { keys: 'Ctrl+F', action: 'Rechercher' }
                                            ].map(sc => `
                                                <div class="flex items-center gap-2">
                                                    <kbd class="px-2 py-1 bg-white border border-slate-300 rounded text-xs font-mono font-bold text-slate-700 shadow-sm">${sc.keys}</kbd>
                                                    <span class="text-xs text-slate-600">${sc.action}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>

                                <!-- Personnalisation du Ticket -->
                                <div class="p-4 rounded-2xl bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200">
                                    <div class="flex items-center gap-3 mb-4">
                                        <span class="text-2xl">🧾</span>
                                        <div>
                                            <div class="font-bold text-sm text-slate-800">Personnalisation du ticket</div>
                                            <div class="text-xs text-slate-500">Texte affiché sur les reçus de vente</div>
                                        </div>
                                    </div>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-xs font-bold text-slate-600 mb-1">Nom de la boutique (logo)</label>
                                            <input type="text" id="pref_receipt_logo" value="${prefs.receiptLogoText || ''}" placeholder="${CORE.getCompanyName()}"
                                                class="w-full px-3 py-2 border border-emerald-200 rounded-xl text-sm font-bold focus:ring-2 focus:ring-emerald-300 focus:border-emerald-400"
                                                onchange="VendeurModule.state.preferences.receiptLogoText = this.value; VendeurModule.savePreferences();">
                                            <div class="text-[10px] text-slate-400 mt-1">Laissez vide pour utiliser le nom par défaut</div>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-slate-600 mb-1">Sous-titre / Slogan</label>
                                            <input type="text" id="pref_receipt_subtitle" value="${prefs.receiptSubtitle || ''}" placeholder="Ex: Votre satisfaction, notre priorité"
                                                class="w-full px-3 py-2 border border-emerald-200 rounded-xl text-sm focus:ring-2 focus:ring-emerald-300 focus:border-emerald-400"
                                                onchange="VendeurModule.state.preferences.receiptSubtitle = this.value; VendeurModule.savePreferences();">
                                        </div>
                                        <button onclick="VendeurModule.previewReceipt()" class="w-full px-3 py-2 bg-emerald-600 text-white rounded-xl text-xs font-bold hover:bg-emerald-700 transition flex items-center justify-center gap-2">
                                            <i data-lucide="eye" class="w-3 h-3"></i>
                                            Aperçu du ticket
                                        </button>
                                    </div>
                                </div>

                                <!-- Données -->
                                <div class="p-4 rounded-2xl bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200">
                                    <div class="flex items-center gap-3 mb-3">
                                        <span class="text-2xl">💾</span>
                                        <div>
                                            <div class="font-bold text-sm text-slate-800">Données locales</div>
                                            <div class="text-xs text-slate-500">Gérer le stockage</div>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="VendeurModule.exportAllData()" class="flex-1 px-3 py-2 bg-white border border-amber-300 text-amber-700 rounded-xl text-xs font-bold hover:bg-amber-50 transition flex items-center justify-center gap-1">
                                            <i data-lucide="download" class="w-3 h-3"></i>
                                            Exporter
                                        </button>
                                        <button onclick="if(confirm('Réinitialiser tous les paramètres ?')) { localStorage.removeItem('vendeur_preferences'); location.reload(); }" class="flex-1 px-3 py-2 bg-white border border-red-300 text-red-600 rounded-xl text-xs font-bold hover:bg-red-50 transition flex items-center justify-center gap-1">
                                            <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                                            Réinitialiser
                                        </button>
                                    </div>
                                </div>

                                <!-- Version -->
                                <div class="p-4 rounded-2xl bg-gradient-to-r from-slate-800 to-slate-900 text-white">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center text-xl font-black">${CORE.getCompanyName().charAt(0)}</div>
                                            <div>
                                                <div class="font-black">${CORE.getCompanyName()}</div>
                                                <div class="text-xs text-slate-400">Version ${CORE.config.version}</div>
                                            </div>
                                        </div>
                                        <span class="px-3 py-1 bg-emerald-500/20 text-emerald-400 rounded-full text-xs font-bold">À jour</span>
                                    </div>
                                </div>
                            <!-- Supprimer le compte -->
                            <div class="p-4 rounded-2xl bg-gradient-to-r from-red-100 to-rose-100 border-2 border-red-300 mt-4">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-11 h-11 bg-gradient-to-br from-red-600 to-red-800 rounded-xl flex items-center justify-center shadow-lg">
                                        <i data-lucide="trash-2" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-black text-red-800">Zone Dangereuse</h4>
                                        <p class="text-xs text-red-600">Actions irréversibles</p>
                                    </div>
                                </div>
                                <button onclick="PDGModule.showDeleteAccountModal()" class="w-full p-3 bg-red-600 hover:bg-red-700 text-white font-black text-sm rounded-xl transition flex items-center justify-center gap-2 shadow-lg shadow-red-200">
                                    <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                                    Supprimer définitivement ce compte
                                </button>
                                <p class="text-[10px] text-red-500 mt-2 text-center">Cette action supprimera toutes les données de l'entreprise</p>
                            </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer actions -->
                    <div class="p-4 flex justify-between items-center">
                        <button onclick="App.logout()" class="px-4 py-2 bg-red-50 text-red-600 rounded-xl font-bold text-sm hover:bg-red-100 transition flex items-center gap-2">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            ${t('menu.logout')}
                        </button>
                        <button onclick="VendeurModule.savePreferences(); UI.closeModal(); UI.toast('✓ Préférences enregistrées', 'success')" class="px-6 py-2.5 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-xl font-bold text-sm hover:shadow-lg hover:shadow-emerald-200 transition-all flex items-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            ${t('action.save')}
                    </div>
                </div>
            `, [], { maxWidth: 'max-w-2xl' });

            setTimeout(() => lucide.createIcons(), 50);
        },

        switchSettingsTab(tabId) {
            // Cacher tous les contenus
            ['general', 'appearance', 'notifications', 'advanced'].forEach(id => {
                const content = document.getElementById('content-' + id);
                const tab = document.getElementById('tab-' + id);
                if (content) content.classList.add('hidden');
                if (tab) {
                    tab.classList.remove('text-emerald-600', 'border-b-2', 'border-emerald-500', 'bg-emerald-50/50');
                    tab.classList.add('text-slate-500');
                }
            });

            // Afficher le contenu sélectionné
            const activeContent = document.getElementById('content-' + tabId);
            const activeTab = document.getElementById('tab-' + tabId);
            if (activeContent) activeContent.classList.remove('hidden');
            if (activeTab) {
                activeTab.classList.remove('text-slate-500');
                activeTab.classList.add('text-emerald-600', 'border-b-2', 'border-emerald-500', 'bg-emerald-50/50');
            }

            setTimeout(() => lucide.createIcons(), 50);
        },

        previewReceipt() {
            const prefs = this.state.preferences || {};
            const logoText = prefs.receiptLogoText?.trim() || CORE.getCompanyName();
            const subtitleText = prefs.receiptSubtitle?.trim() || '';
            const posName = CORE.getPOS(CORE.state.currentUser?.pos)?.name || 'Point de vente';
            const now = new Date();
            const reference = 'CMD-APU-' + now.getTime().toString().slice(-6);

            const previewItems = [
                { name: 'Article 1', qty: 2, price: 5000 },
                { name: 'Article 2', qty: 1, price: 12500 },
                { name: 'Article 3', qty: 3, price: 2500 }
            ];
            const subtotal = previewItems.reduce((a, it) => a + (it.qty * it.price), 0);

            UI.modal('👁️ Aperçu du ticket', `
                <div class="p-4 bg-white border-2 border-dashed border-slate-300 rounded-xl">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="font-black text-slate-900 text-xl">${logoText}</div>
                            ${subtitleText ? `<div class="text-xs text-emerald-600 font-medium italic">${subtitleText}</div>` : ''}
                            <div class="text-xs text-slate-500 font-bold uppercase tracking-wider">${posName}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-black">${reference}</div>
                            <div class="text-xs text-slate-500">${now.toLocaleDateString('fr-FR')} ${now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                    </div>
                    <div class="my-4 h-px bg-slate-200"></div>
                    <div class="space-y-2">
                        ${previewItems.map(it => `<div class="flex justify-between text-sm"><span>${it.qty}× ${it.name}</span><span class="font-bold">${CORE.formatPrice(it.qty * it.price)}</span></div>`).join('')}
                    </div>
                    <div class="my-4 h-px bg-slate-200"></div>
                    <div class="flex justify-between items-center">
                        <div class="text-sm font-bold text-slate-600">Total</div>
                        <div class="text-2xl font-black text-emerald-600">${CORE.formatPrice(subtotal)}</div>
                    </div>
                    <div class="mt-2 text-xs text-slate-500">Paiement: <span class="font-bold">Espèces</span></div>
                    <div class="mt-4 text-center text-xs text-slate-400">--- Merci de votre visite ! ---</div>
                </div>
                <div class="mt-3 p-3 bg-emerald-50 border border-emerald-200 rounded-xl text-xs text-emerald-700">
                    <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                    Ceci est un aperçu. Les modifications sont automatiquement sauvegardées.
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            setTimeout(() => lucide.createIcons(), 50);
        },

        exportAllData() {
            const data = {
                preferences: this.state.preferences,
                exportDate: new Date().toISOString(),
                version: CORE.config.version
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'raya-preferences-' + Utils.todayKey() + '.json';
            a.click();
            URL.revokeObjectURL(url);
            UI.toast('✓ Données exportées', 'success');
        },

        togglePaymentMethodPreference(methodId) {
            const idx = this.state.preferences.favoritedPaymentMethods.indexOf(methodId);
            if (idx >= 0) {
                this.state.preferences.favoritedPaymentMethods.splice(idx, 1);
            } else {
                this.state.preferences.favoritedPaymentMethods.push(methodId);
            }
            this.savePreferences();
            App.rerender();
        },

        // =====================
        // HISTORIQUE D'ACTIVITÉ
        // =====================
        showActivityHistoryModal() {
            this.activityFilters = this.activityFilters || {};
            const userPos = CORE.user?.pos;
            const filters = { ...this.activityFilters, posId: userPos };
            const logs = CORE.getActivityLogs(filters);

            const allLogs = CORE.getActivityLogs({ posId: userPos }) || [];
            const entities = [...new Set(allLogs.map(l => l.entity))];

            UI.modal(`📋 Historique d'Activité`, `
                <div class="space-y-4">
                    <!-- Filtres -->
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-black text-slate-600 mb-1">📅 Du</label>
                            <input type="date" id="activity_date_from" value="${filters.startDate || ''}" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm" onchange="VendeurModule.activityFilters.startDate = this.value; VendeurModule.showActivityHistoryModal();">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-slate-600 mb-1">📅 Au</label>
                            <input type="date" id="activity_date_to" value="${filters.endDate || ''}" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm" onchange="VendeurModule.activityFilters.endDate = this.value; VendeurModule.showActivityHistoryModal();">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-600 mb-1">🏷️ Entité</label>
                        <select id="activity_entity" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm" onchange="VendeurModule.activityFilters.entity = this.value || null; VendeurModule.showActivityHistoryModal();">
                            <option value="">Toutes les entités</option>
                            ${entities.map(e => `<option value="${e}" ${filters.entity === e ? 'selected' : ''}>${e}</option>`).join('')}
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-600 mb-1">🔍 Recherche</label>
                        <input type="text" id="activity_search" value="${filters.search || ''}" placeholder="Utilisateur, client, description..." class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm" onchange="VendeurModule.activityFilters.search = this.value; VendeurModule.showActivityHistoryModal();">
                    </div>

                    <div class="flex gap-2">
                        <button onclick="VendeurModule.exportActivityCSV()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-bold text-sm hover:bg-blue-700 transition flex items-center justify-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            CSV
                        </button>
                        <button onclick="VendeurModule.exportActivityPDF()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-bold text-sm hover:bg-red-700 transition flex items-center justify-center gap-2">
                            <i data-lucide="file-pdf" class="w-4 h-4"></i>
                            PDF
                        </button>
                    </div>

                    <!-- Timeline -->
                    <div class="space-y-2 max-h-96 overflow-y-auto">
                        ${logs.length > 0 ? logs.map((log, idx) => {
                            const date = new Date(log.timestamp);
                            const dateStr = date.toLocaleDateString('fr-FR');
                            const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                            const isLast = idx === logs.length - 1;

                            // Couleurs par action
                            const colors = {
                                'Créé': 'bg-green-50 border-green-200',
                                'Modifié': 'bg-blue-50 border-blue-200',
                                'Supprimé': 'bg-red-50 border-red-200',
                                'Annulé': 'bg-amber-50 border-amber-200',
                                'Remboursé': 'bg-purple-50 border-purple-200',
                                'Payé': 'bg-emerald-50 border-emerald-200',
                                'Livré': 'bg-cyan-50 border-cyan-200'
                            };

                            return `
                                <div class="relative">
                                    ${!isLast ? '<div class="absolute left-4 top-10 w-0.5 h-12 bg-slate-200"></div>' : ''}
                                    <div class="p-4 rounded-xl border-2 ${colors[log.action] || 'bg-slate-50 border-slate-200'}">
                                        <div class="flex items-start gap-3">
                                            <div class="w-8 h-8 rounded-full bg-slate-300 flex items-center justify-center text-xs font-black text-white flex-shrink-0">
                                                ${log.userName.charAt(0).toUpperCase()}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="font-bold text-slate-900">${log.action} ${log.entity}</div>
                                                <div class="text-xs text-slate-600 mt-1">
                                                    <strong>${log.userName}</strong> • ${dateStr} à ${timeStr}
                                                </div>
                                                ${log.entityName ? `<div class="text-sm font-bold text-slate-700 mt-1">${log.entityName}</div>` : ''}
                                                ${log.details ? `<div class="text-xs text-slate-700 mt-1 italic">${log.details}</div>` : ''}
                                                ${log.amount > 0 ? `<div class="text-sm font-bold text-slate-800 mt-2">${CORE.formatPrice(log.amount)}</div>` : ''}
                                            </div>
                                            <span class="px-2 py-1 rounded-full text-xs font-black ${log.status === 'success' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
                                                ${log.status === 'success' ? '✓' : '✗'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('') : `
                            <div class="text-center py-8 text-slate-500">
                                <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                <p class="text-sm font-bold">Aucune activité</p>
                            </div>
                        `}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        exportActivityCSV() {
            const userPos = CORE.user?.pos;
            const filters = { ...this.activityFilters || {}, posId: userPos };
            const logs = CORE.getActivityLogs(filters);

            const headers = ['Date', 'Heure', 'Utilisateur', 'Rôle', 'Action', 'Entité', 'Nom', 'Détails', 'Montant'];
            const rows = logs.map(log => {
                const date = new Date(log.timestamp);
                return [
                    date.toLocaleDateString('fr-FR'),
                    date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                    log.userName,
                    log.userRole,
                    log.action,
                    log.entity,
                    log.entityName,
                    log.details,
                    log.amount > 0 ? log.amount : ''
                ];
            });

            let csv = headers.join(',') + '\n';
            csv += rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `historique-activite-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            UI.toast('Historique exporté en CSV ✓', 'success');
        },

        exportActivityPDF() {
            const userPos = CORE.user?.pos;
            const filters = { ...this.activityFilters || {}, posId: userPos };
            const logs = CORE.getActivityLogs(filters);

            let html = `
                <html>
                <head>
                    <meta charset="utf-8">
                    <title>Historique d'Activité</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; background: white; }
                        h1 { color: #1f2937; border-bottom: 2px solid #059669; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background: #f3f4f6; padding: 10px; text-align: left; border: 1px solid #d1d5db; font-weight: bold; }
                        td { padding: 10px; border: 1px solid #d1d5db; }
                        tr:nth-child(even) { background: #f9fafb; }
                        .amount { font-weight: bold; text-align: right; }
                        .success { color: #059669; }
                        .error { color: #dc2626; }
                    </style>
                </head>
                <body>
                    <h1>📋 Historique d'Activité</h1>
                    <p>Généré le ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Date/Heure</th>
                                <th>Utilisateur</th>
                                <th>Action</th>
                                <th>Entité</th>
                                <th>Détails</th>
                                <th>Montant</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${logs.map(log => {
                                const date = new Date(log.timestamp);
                                const dateTime = date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                                return `
                                    <tr>
                                        <td>${dateTime}</td>
                                        <td>${log.userName} (${log.userRole})</td>
                                        <td>${log.action}</td>
                                        <td>${log.entity}</td>
                                        <td>${log.entityName} ${log.details ? `<br>${log.details}` : ''}</td>
                                        <td class="amount ${log.status === 'success' ? 'success' : 'error'}">${log.amount > 0 ? CORE.formatPrice(log.amount) : ''}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            const blob = new Blob([html], { type: 'text/html;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `historique-activite-${new Date().toISOString().split('T')[0]}.html`;
            link.click();

            UI.toast('Historique exporté en PDF ✓', 'success');
        },

        // =====================
        // MODE RÉSERVATION (Panier dédié)
        // =====================
        openReservationCart() {
            // Le panier réservation est séparé. Par défaut, on copie le panier courant si non vide,
            // pour que le vendeur puisse transformer rapidement un panier en réservation.
            if (this.state.cart.length > 0 && this.state.reservationCart.length === 0) {
                this.state.reservationCart = this.state.cart.map(i => ({ ...i }));
                // On ne vide pas le panier normal, c'est volontaire (panier séparé)
            }
            this.state.reservationCartDrawerOpen = true;
            App.rerender();
        },
        closeReservationCart() { this.state.reservationCartDrawerOpen = false; App.rerender(); },
        clearReservationCart() {
            this.state.reservationCart = [];
            this.state.reservationManualDeliveryFee = 0;
            this.state.reservationCartDrawerOpen = false;
            App.rerender();
        },
        addToReservationCart(productId) {
            const p = CORE.getProduct(productId);
            if (!p || !p.active) return UI.toast('Produit indisponible', 'error');

            // Get stock for this POS (supports posStocks)
            const userPos = CORE.user?.pos;
            const posStock = CORE.getProductStock(productId, userPos);
            if (posStock <= 0) return UI.toast('Stock épuisé', 'warning');

            const item = this.state.reservationCart.find(i => i.productId === productId);
            if (item) {
                if (item.qty < posStock) item.qty++;
                else UI.toast('Stock maximum atteint', 'warning');
            } else {
                // Get price for this POS (supports posStocks)
                const posPrice = CORE.getProductPrice(productId, userPos);
                this.state.reservationCart.push({ productId: p.id, name: p.name, price: posPrice, qty: 1, maxStock: posStock });
            }
            App.rerender();
        },
        updateReservationCartQty(index, delta) {
            const item = this.state.reservationCart[index];
            if (!item) return;
            const newQty = item.qty + delta;
            if (newQty <= 0) this.state.reservationCart.splice(index, 1);
            else item.qty = Math.min(newQty, item.maxStock);
            App.rerender();
        },
        removeReservationCartItem(index) {
            if (index < 0 || index >= this.state.reservationCart.length) return;
            this.state.reservationCart.splice(index, 1);
            App.rerender();
        },
        getReservationCartTotal() { return this.state.reservationCart.reduce((a, b) => a + (b.price * b.qty), 0); },
        getReservationDeliveryFee() {
            return this.state.reservationManualDeliveryFee !== undefined ? this.state.reservationManualDeliveryFee : 0;
        },
        setReservationManualDeliveryFee(val) {
            const amount = Number(val) || 0;
            this.state.reservationManualDeliveryFee = amount;
            const totalEl = document.getElementById('res-cart-total-display');
            if(totalEl) totalEl.textContent = CORE.formatPrice(this.getReservationGrandTotal());
        },
        getReservationGrandTotal() { return this.getReservationCartTotal() + this.getReservationDeliveryFee(); },

        // Cart
        addToCart(productId) {
            const p = CORE.getProduct(productId);
            if (!p || !p.active) return UI.toast('Produit indisponible', 'error');

            // Get stock for this POS (supports posStocks)
            const userPos = CORE.user?.pos;
            const posStock = CORE.getProductStock(productId, userPos);
            if (posStock <= 0) return UI.toast('Stock épuisé', 'warning');

            // Vérifier s'il y a des variantes
            const variants = CORE.getProductVariants(productId);
            if (variants.length > 0) {
                // Afficher le sélecteur de variante
                this.showVariantPickerModal(productId);
                return;
            }

            const item = this.state.cart.find(i => i.productId === productId && !i.variantId);
            if (item) {
                if (item.qty < posStock) item.qty++;
                else UI.toast('Stock maximum atteint', 'warning');
            } else {
                // Get price for this POS (supports posStocks)
                const posPrice = CORE.getProductPrice(productId, userPos);
                // Init with no discount
                this.state.cart.push({ productId: p.id, name: p.name, price: posPrice, qty: 1, maxStock: posStock, discountPercent: 0 });
            }
            App.rerender();
        },
        updateCartQty(index, delta) {
            const item = this.state.cart[index];
            if (!item) return;
            const newQty = item.qty + delta;
            if (newQty <= 0) this.state.cart.splice(index, 1);
            else item.qty = Math.min(newQty, item.maxStock);
            App.rerender();
        },
        removeCartItem(index) {
            if (index < 0 || index >= this.state.cart.length) return;
            this.state.cart.splice(index, 1);
            App.rerender();
        },
        openCartDrawer() { this.state.cartDrawerOpen = true; App.rerender(); },
        closeCartDrawer() { this.state.cartDrawerOpen = false; App.rerender(); },
        toggleCartDrawer() { this.state.cartDrawerOpen = !this.state.cartDrawerOpen; App.rerender(); },
        clearCart() {
            this.state.cart = [];
            this.state.selectedClientId = null;
            this.state.deliveryZoneId = null;
            this.state.cartDrawerOpen = false;
            this.state.globalDiscount = { type: 'percent', value: 0 };
            this.state.promoCode = null;
            App.rerender();
        },
        // Total Panier avec remises ligne
        getCartTotal() {
            return this.state.cart.reduce((a, b) => {
                const linePrice = this.getLinePrice(b);
                return a + (linePrice * b.qty);
            }, 0);
        },
        getDeliveryFee() {
            return this.state.manualDeliveryFee !== undefined ? this.state.manualDeliveryFee : 0;
        },
        setManualDeliveryFee(val) {
            const amount = Number(val) || 0;
            this.state.manualDeliveryFee = amount;
            const totalEl = document.getElementById('cart-total-display');
            if(totalEl) totalEl.textContent = CORE.formatPrice(this.getGrandTotal());
        },
        // Grand Total avec remise globale
        getGrandTotal() {
            const subtotal = this.getCartTotal();
            const delivery = this.getDeliveryFee();
            let total = subtotal;

            // Appliquer remise globale
            if (this.state.globalDiscount.type === 'percent' && this.state.globalDiscount.value > 0) {
                total = total * (1 - (this.state.globalDiscount.value / 100));
            } else if (this.state.globalDiscount.type === 'fixed' && this.state.globalDiscount.value > 0) {
                total = Math.max(0, total - this.state.globalDiscount.value);
            }

            return Math.round(total) + delivery;
        },

        getStats() {
            const today = Utils.todayKey();
            const ordersToday = CORE.getVisibleOrders().filter(o => (o.createdAt || '').startsWith(today));
            const revenueToday = ordersToday.filter(o => o.status === 'delivered').reduce((a, o) => a + (o.total || 0), 0);
            const lowStock = CORE.getVisibleProducts().filter(p => !p.isMainWarehouse && p.stock <= p.minStock).length;
            const pending = CORE.getVisibleOrders().filter(o => ['pending','confirmed','delivering'].includes(o.status)).length;
            return {
                todayRevenue: revenueToday,
                todayTransactions: ordersToday.length,
                pendingDeliveries: pending,
                lowStockProducts: lowStock
            };
        },

        // =====================
        // RÉSERVATIONS (widgets + historique)
        // =====================
        getReservationsList() {
            const userPos = CORE.user?.pos;
            const res = CORE.getVisibleDeliveries()
                .filter(d => (!d.posId || d.posId == userPos) && d.status === 'reservation')
                .sort((a, b) => {
                    const ad = (a.deliveryDate || a.createdAt || '');
                    const bd = (b.deliveryDate || b.createdAt || '');
                    const cmp = String(ad).localeCompare(String(bd));
                    if (cmp !== 0) return cmp;
                    return String(a.deliveryTime || '').localeCompare(String(b.deliveryTime || ''));
                });
            return res;
        },

        getReservationsStats() {
            const today = Utils.todayKey();
            const list = this.getReservationsList();
            const total = list.length;
            const todayCount = list.filter(d => (d.deliveryDate || '').startsWith(today)).length;
            const upcomingCount = list.filter(d => {
                const dd = (d.deliveryDate || '').trim();
                return dd && dd >= today;
            }).length;
            return { total, todayCount, upcomingCount };
        },

        formatReservationWhen(d) {
            const date = (d?.deliveryDate || '').trim();
            const time = (d?.deliveryTime || '').trim();
            if (!date && !time) return '—';
            return `${date || '—'}${time ? ' ' + time : ''}`;
        },

        renderReservationsWidget() {
            const stats = this.getReservationsStats();
            const list = this.getReservationsList().slice(0, 5);
            return `
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                    <div class="flex items-center justify-between mb-5">
                        <div>
                            <h3 class="font-black text-lg text-slate-800">Réservations</h3>
                            <p class="text-xs text-slate-500 font-bold">Livraisons futures (non assignées)</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="VendeurModule.navigateTo('reservations')" class="px-3 py-2 rounded-xl bg-slate-100 text-slate-700 text-xs font-black hover:bg-slate-200 transition">Historique</button>
                            <button onclick="VendeurModule.showReservationModal()" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700 transition flex items-center gap-2">
                                <i data-lucide="calendar-plus" class="w-4 h-4"></i>
                                Nouvelle
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="p-4 rounded-2xl bg-slate-50 border border-slate-200">
                            <div class="text-[10px] font-black text-slate-500 uppercase tracking-wider">Aujourd'hui</div>
                            <div class="mt-1 text-2xl font-black text-slate-900">${stats.todayCount}</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-slate-50 border border-slate-200">
                            <div class="text-[10px] font-black text-slate-500 uppercase tracking-wider">À venir</div>
                            <div class="mt-1 text-2xl font-black text-slate-900">${stats.upcomingCount}</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-slate-50 border border-slate-200">
                            <div class="text-[10px] font-black text-slate-500 uppercase tracking-wider">Total</div>
                            <div class="mt-1 text-2xl font-black text-slate-900">${stats.total}</div>
                        </div>
                    </div>

                    ${stats.total === 0 ? `
                        <div class="p-6 rounded-2xl border border-dashed border-slate-200 bg-white text-center">
                            <div class="mx-auto w-12 h-12 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center">
                                <i data-lucide="calendar-clock" class="w-6 h-6"></i>
                            </div>
                            <div class="mt-3 font-black text-slate-900">Aucune réservation</div>
                            <div class="text-xs text-slate-500">Créez une livraison future (COD) puis assignez-la à l'heure prévue.</div>
                            <button onclick="VendeurModule.showReservationModal()" class="mt-4 px-4 py-2.5 rounded-xl bg-slate-900 text-white text-xs font-black hover:bg-slate-800 transition">Créer une réservation</button>
                        </div>
                    ` : `
                        <div class="space-y-2">
                            ${list.map(d => {
                                const when = this.formatReservationWhen(d);
                                return `
                                <div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 flex items-start justify-between gap-4">
                                    <div class="min-w-0">
                                        <div class="flex items-center gap-2 flex-wrap">
                                            <div class="font-black text-slate-900">${d.orderRef}</div>
                                            ${UI.badge('Réservation', 'purple')}
                                        </div>
                                        <div class="text-xs text-slate-500 truncate">${d.clientName || '—'} • ${d.address || '—'}</div>
                                        <div class="mt-1 text-xs text-emerald-700 font-black">Prévu: ${when}</div>
                                    </div>
                                    <div class="text-right shrink-0">
                                        <div class="font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                                        <div class="mt-2 flex flex-wrap gap-2 justify-end">
                                            <button onclick="VendeurModule.showEditDeliveryModal(${d.id})" class="px-3 py-2 rounded-xl bg-slate-100 text-xs font-black text-slate-700 hover:bg-slate-200">Modifier</button>
                                            <button onclick="VendeurModule.showAssignDeliveryModal(${d.id})" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-black hover:bg-slate-800">Assigner</button>
                                        </div>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    `}

                    ${stats.total > 5 ? `<div class="mt-4 text-xs text-slate-500">Affichage des 5 prochaines réservations. Ouvrez l’historique pour tout voir.</div>` : ''}
                </div>
            `;
        },

        renderDepositsWidget() {
            const deposits = (CORE.db.deposits || []).filter(d => d.vendeurId === CORE.state.currentUser?.id);
            const totalAmount = deposits.reduce((sum, d) => sum + d.amount, 0);
            const monthDeposits = deposits.filter(d => {
                const date = new Date(d.timestamp);
                const now = new Date();
                return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            }).length;
            const avgAmount = deposits.length > 0 ? Math.round(deposits.reduce((sum, d) => sum + d.amount, 0) / deposits.length) : 0;

            return `
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                    <div class="flex items-center justify-between mb-5">
                        <div>
                            <h3 class="font-black text-lg text-slate-800">📥 Dépôts Livreurs</h3>
                            <p class="text-xs text-slate-500 font-bold">Montants reçus en caisse</p>
                        </div>
                        <button onclick="VendeurModule.recordDeposit()" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs font-black hover:bg-indigo-700 transition flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Nouveau
                        </button>
                    </div>

                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="p-4 rounded-2xl bg-indigo-50 border border-indigo-200">
                            <div class="text-xs text-indigo-600 font-black uppercase tracking-wider mb-1">Total</div>
                            <div class="text-2xl font-black text-indigo-700">${totalAmount.toLocaleString()} F</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-purple-50 border border-purple-200">
                            <div class="text-xs text-purple-600 font-black uppercase tracking-wider mb-1">Mois</div>
                            <div class="text-2xl font-black text-purple-700">${monthDeposits}</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-pink-50 border border-pink-200">
                            <div class="text-xs text-pink-600 font-black uppercase tracking-wider mb-1">Moyenne</div>
                            <div class="text-2xl font-black text-pink-700">${avgAmount.toLocaleString()} F</div>
                        </div>
                    </div>

                    ${deposits.length > 0 ? `
                        <div class="space-y-2">
                            ${deposits.slice(-5).reverse().map(d => `
                                <div class="p-3 bg-slate-50 rounded-xl border border-slate-200 flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center">
                                            <i data-lucide="user" class="w-4 h-4 text-indigo-600"></i>
                                        </div>
                                        <div>
                                            <div class="font-black text-slate-900 text-sm">${d.livreurName}</div>
                                            <div class="text-xs text-slate-500">${new Date(d.timestamp).toLocaleDateString('fr-FR')}</div>
                                        </div>
                                    </div>
                                    <div class="font-black text-indigo-600">${d.amount.toLocaleString()} F</div>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="VendeurModule.showDepositsModal()" class="mt-4 w-full py-2 text-xs font-black text-indigo-600 hover:text-indigo-700">Voir tout →</button>
                    ` : `
                        <div class="text-center py-8 text-slate-500">
                            <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                            <p class="text-sm font-bold">Aucun dépôt enregistré</p>
                            <p class="text-xs opacity-75">Enregistrez le premier dépôt</p>
                        </div>
                    `}
                </div>
            `;
        },

        renderPendingCODWidget() {
            try {
            // COD orders not yet paid (awaiting livreur deposit)
            const pendingCOD = CORE.getVisibleOrders().filter(o =>
                o.paymentMethod === 'cod' &&
                o.paymentStatus !== 'paid' &&
                o.status !== 'cancelled'
            );

            // Enrich each order with livreur info
            const enriched = pendingCOD.map(o => {
                const delivery = (CORE.db.deliveries || []).find(d => d.orderId == o.id);
                const livreurId = delivery?.livreurId || 'unassigned';
                const livreur = livreurId !== 'unassigned' ? (CORE.getUser(livreurId) || (CORE.db.independentDeliveryMen || []).find(dm => String(dm.id) == String(livreurId))) : null;
                const livreurName = livreur?.name || (livreurId === 'unassigned' ? 'Non assigné' : 'Livreur inconnu');
                return { ...o, _livreurId: livreurId, _livreurName: livreurName };
            });

            const totalPending = pendingCOD.reduce((s, o) => s + (o.total || 0), 0);

            return `
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-amber-200" style="border-left: 4px solid #f59e0b;">
                    <div class="flex items-center justify-between mb-5">
                        <div>
                            <h3 class="font-black text-lg text-slate-800">💰 COD en attente de dépôt</h3>
                            <p class="text-xs text-slate-500 font-bold">Argent chez les livreurs</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="px-3 py-1 rounded-full bg-amber-100 text-amber-700 text-xs font-black">${pendingCOD.length} commande${pendingCOD.length > 1 ? 's' : ''}</span>
                        </div>
                    </div>

                    <div class="p-4 rounded-2xl bg-amber-50 border border-amber-200 mb-4">
                        <div class="text-xs text-amber-600 font-black uppercase tracking-wider mb-1">Total en attente</div>
                        <div class="text-2xl font-black text-amber-700">${totalPending.toLocaleString()} F</div>
                    </div>

                    ${enriched.length > 0 ? `
                    <div class="space-y-2">
                        ${enriched.slice(0, 8).map(o => `
                            <div class="p-3 bg-amber-50 rounded-xl border border-amber-200 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-amber-100 rounded-full flex items-center justify-center">
                                        <i data-lucide="receipt" class="w-4 h-4 text-amber-600"></i>
                                    </div>
                                    <div>
                                        <div class="font-black text-slate-900 text-sm">${o.reference}</div>
                                        <div class="text-xs text-slate-500">${o._livreurName} • ${o.clientName || 'Client'}</div>
                                    </div>
                                </div>
                                <div class="font-black text-amber-600 text-sm">${(o.total || 0).toLocaleString()} F</div>
                            </div>
                        `).join('')}
                    </div>

                    ${enriched.length > 8 ? `
                        <button onclick="VendeurModule.showPendingCODModal()" class="mt-4 w-full py-2 text-xs font-black text-amber-600 hover:text-amber-700">Voir tout (${enriched.length}) →</button>
                    ` : ''}
                    ` : `
                    <div class="text-center py-6 text-slate-400">
                        <i data-lucide="check-circle" class="w-8 h-8 mx-auto mb-2 text-emerald-400"></i>
                        <p class="text-sm font-bold text-emerald-600">Aucun COD en attente</p>
                        <p class="text-xs text-slate-400">Tous les dépôts sont à jour</p>
                    </div>
                    `}
                </div>
            `;
            } catch(e) { console.error('renderPendingCODWidget error:', e); return '<div class="p-4 bg-red-50 border border-red-200 rounded-2xl text-red-600 text-sm">Erreur widget COD</div>'; }
        },

        recordDepositForLivreur(livreurId) {
            // Pre-fill deposit form for a specific livreur
            const pendingCOD = CORE.getVisibleOrders().filter(o =>
                o.paymentMethod === 'cod' &&
                o.paymentStatus !== 'paid' &&
                o.status !== 'cancelled'
            );
            const livreurOrders = pendingCOD.filter(o => {
                const delivery = (CORE.db.deliveries || []).find(d => d.orderId == o.id);
                const lid = delivery?.livreurId || 'unassigned';
                return String(lid) == String(livreurId);
            });

            const totalAmount = livreurOrders.reduce((s, o) => s + (o.total || 0), 0);
            const refs = livreurOrders.map(o => o.reference).join(', ');

            // Open the normal deposit form
            this.recordDeposit();

            // Pre-fill the fields after modal renders
            setTimeout(() => {
                const livreurSelect = document.getElementById('dep_livreur');
                const amountInput = document.getElementById('dep_amount');
                const ordersCountInput = document.getElementById('dep_ordersCount');
                const ordersRefInput = document.getElementById('dep_ordersRef');

                if (livreurSelect) {
                    livreurSelect.value = livreurId;
                    livreurSelect.dispatchEvent(new Event('change'));
                }
                if (amountInput) amountInput.value = totalAmount;
                if (ordersCountInput) ordersCountInput.value = livreurOrders.length;
                if (ordersRefInput) ordersRefInput.value = refs;
            }, 200);
        },

        showPendingCODModal() {
            const pendingCOD = CORE.getVisibleOrders().filter(o =>
                o.paymentMethod === 'cod' &&
                o.paymentStatus !== 'paid' &&
                o.status !== 'cancelled'
            );

            // Enrich each order with livreur info
            const enriched = pendingCOD.map(o => {
                const delivery = (CORE.db.deliveries || []).find(d => d.orderId == o.id);
                const livreurId = delivery?.livreurId || 'unassigned';
                const livreur = livreurId !== 'unassigned' ? (CORE.getUser(livreurId) || (CORE.db.independentDeliveryMen || []).find(dm => String(dm.id) == String(livreurId))) : null;
                const livreurName = livreur?.name || (livreurId === 'unassigned' ? 'Non assigné' : 'Livreur inconnu');
                const statusLabels = { pending: 'En attente', delivering: 'En livraison', delivered: 'Livré' };
                return { ...o, _livreurId: livreurId, _livreurName: livreurName, _statusLabel: statusLabels[o.status] || o.status };
            });

            const totalPending = pendingCOD.reduce((s, o) => s + (o.total || 0), 0);

            UI.modal('💰 COD en attente de dépôt', `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 rounded-2xl bg-amber-50 border border-amber-200 text-center">
                            <div class="text-xs text-amber-600 font-black uppercase">Total en attente</div>
                            <div class="text-2xl font-black text-amber-700">${totalPending.toLocaleString()} F</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-orange-50 border border-orange-200 text-center">
                            <div class="text-xs text-orange-600 font-black uppercase">Commandes</div>
                            <div class="text-2xl font-black text-orange-700">${enriched.length}</div>
                        </div>
                    </div>

                    ${enriched.length > 0 ? `
                    <div class="space-y-2">
                        ${enriched.map(o => `
                            <div class="p-3 bg-slate-50 rounded-xl border border-slate-200 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center">
                                        <i data-lucide="receipt" class="w-5 h-5 text-amber-600"></i>
                                    </div>
                                    <div>
                                        <div class="font-black text-slate-900 text-sm">${o.reference}</div>
                                        <div class="text-xs text-slate-500">${o._livreurName} • ${o.clientName || 'Client'}</div>
                                        <div class="text-[10px] text-slate-400">${o._statusLabel} • ${o.createdAt ? new Date(o.createdAt).toLocaleDateString('fr-FR') : ''}</div>
                                    </div>
                                </div>
                                <div class="font-black text-amber-600">${(o.total || 0).toLocaleString()} F</div>
                            </div>
                        `).join('')}
                    </div>
                    ` : `
                    <div class="text-center py-8 text-slate-500">
                        <i data-lucide="check-circle" class="w-10 h-10 mx-auto mb-2 text-emerald-400"></i>
                        <p class="font-bold">Aucun COD en attente</p>
                        <p class="text-xs">Tous les dépôts sont à jour</p>
                    </div>
                    `}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()', class: 'px-5 py-2.5 bg-slate-200 text-slate-800 font-black rounded-xl hover:bg-slate-300 transition' }
            ]);
            if (typeof lucide !== 'undefined') lucide.createIcons();
        },

        createOrder(paymentMethod = 'cash') {
            if (this.state.cart.length === 0) return UI.toast('Panier vide', 'error');

            // Vérifier le statut offline
            if (!CORE.state.isOnline) {
                UI.toast('⚠️ Mode Hors Ligne: la vente sera synchronisée quand la connexion revient', 'warning');
            }

            if (paymentMethod === 'cod') {
                this.showCODConfirmationModal();
                return;
            }

            this.finalizeOrder({
                paymentMethod,
                paymentStatus: 'paid',
                deliveryDetails: null,
                livreurId: null
            });
        },

        // =====================
        // RÉSERVATION (livraison future)
        // =====================
        showReservationModal() {
            // Réservation = création d'une commande COD + bon de livraison planifié (non assigné)
            // Ouvre le mode panier Réservation (panier séparé)
            this.state.posMode = 'reservation';
            if (this.state.reservationCart.length === 0 && this.state.cart.length > 0) {
                // Copie rapide du panier normal si déjà préparé
                this.state.reservationCart = this.state.cart.map(i => ({ ...i }));
                this.state.reservationManualDeliveryFee = this.state.manualDeliveryFee || 0;
            }

            if (this.state.reservationCart.length === 0) {
                UI.toast('Ajoutez des articles au panier Réservation avant de créer une réservation', 'warning');
                this.navigateTo('pos');
                this.openReservationCart();
                return;
            }

            const userPos = CORE.user?.pos;
            const vendeurId = CORE.state.currentUser?.id;
            const livreurs = CORE.getVisibleUsers().filter(u => u.role === 'livreur' && (u.pos == userPos || u.posId == userPos) && u.active);
            const activeDeliveries = CORE.getVisibleDeliveries().filter(d => d.posId == userPos && d.status === 'en_cours');
            const counts = {};
            activeDeliveries.forEach(d => {
                if (d.livreurId) counts[d.livreurId] = (counts[d.livreurId] || 0) + 1;
            });
            livreurs.sort((a, b) => (counts[a.id] || 0) - (counts[b.id] || 0));

            // Livreurs indépendants approuvés
            const approvedIndep = (CORE.db.independentDeliveryMen || [])
                .filter(dm => String(dm.vendeurId) == String(vendeurId) && dm.approvalStatus === 'approved');

            const dd = this.state.deliveryDetails || {};
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const ddDay = String(today.getDate()).padStart(2, '0');
            const todayStr = `${yyyy}-${mm}-${ddDay}`;

            const optionsLivreurs = [
                { value: '', label: '-- Choisir un livreur (Optionnel) --' },
                ...livreurs.map(l => {
                    const c = counts[l.id] || 0;
                    const status = c > 0 ? `(${c} en cours 🔴)` : `(${c} en cours 🟢)`;
                    return { value: l.id, label: `${l.name} ${status}` };
                }),
                ...approvedIndep.map(dm => {
                    const c = counts[dm.id] || 0;
                    const status = c > 0 ? `(${c} en cours 🔴)` : `(${c} en cours 🟢)`;
                    return { value: dm.id, label: `${dm.name} (Indépendant) ${status}` };
                })
            ];

            UI.modal('Réservation (livraison future)', `
                <div class="space-y-4">
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl text-sm">
                        <div class="flex justify-between mb-1">
                            <span class="text-slate-500">Total prévu:</span>
                            <span class="font-black text-slate-800">${CORE.formatPrice(this.getGrandTotal())}</span>
                        </div>
                        <div class="text-xs text-slate-500">La réservation crée une commande en <b>paiement à la livraison</b> (COD) + un bon de livraison.</div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        ${UI.input('res_date', 'Date de livraison', 'date', dd.date || todayStr, '', true)}
                        ${UI.input('res_time', 'Heure', 'time', dd.time || '', '', false)}
                    </div>

                    <div class="space-y-3">
                        ${UI.input('res_name', 'Nom du client', 'text', dd.name || '', '', true)}
                        ${UI.input('res_phone', 'Téléphone', 'tel', dd.phone || '', '', true)}
                        ${UI.textarea('res_address', 'Adresse de livraison', dd.address || '', 'Quartier, rue, repères...', 2)}
                    </div>

                    <div class="pt-2 border-t border-slate-100">
                        <label class="block text-sm font-bold text-slate-700 mb-2">Assigner un livreur (optionnel)</label>
                        <select id="res_livreur" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-emerald-500 outline-none font-medium">
                            ${optionsLivreurs.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                        </select>
                        <div class="text-xs text-slate-500 mt-1">Vous pouvez assigner un livreur déjà occupé (cumul de courses).</div>
                    </div>

                    <div id="res_whatsapp_container" style="display:none" class="pt-2">
                        <button onclick="VendeurModule.submitReservation(false, true)" class="w-full py-3 px-4 bg-green-500 text-white font-black rounded-xl hover:bg-green-600 transition flex items-center justify-center gap-2 text-sm">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                            Enregistrer + WhatsApp
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-3 pt-4 border-t border-slate-100">
                        <button onclick="VendeurModule.submitReservation(false)" class="py-3 px-4 bg-slate-100 text-slate-700 font-black rounded-xl hover:bg-slate-200 transition text-sm">
                            Enregistrer
                        </button>
                        <button onclick="VendeurModule.submitReservation(true)" class="py-3 px-4 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="message-square" class="w-4 h-4"></i> Enregistrer + SMS
                        </button>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);

            // Toggle WhatsApp button based on selected livreur
            setTimeout(() => {
                const sel = document.getElementById('res_livreur');
                const waContainer = document.getElementById('res_whatsapp_container');
                if (sel && waContainer) {
                    const indepIds = new Set((CORE.db.independentDeliveryMen || []).filter(dm => dm.approvalStatus === 'approved').map(dm => String(dm.id)));
                    const toggle = () => { waContainer.style.display = indepIds.has(String(sel.value)) ? '' : 'none'; };
                    sel.addEventListener('change', toggle);
                    toggle();
                }
            }, 50);
        },

        submitReservation(sendSms = false, sendWhatsApp = false) {
            const date = (document.getElementById('res_date')?.value || '').trim();
            const time = (document.getElementById('res_time')?.value || '').trim();
            const name = (document.getElementById('res_name')?.value || '').trim();
            const phone = (document.getElementById('res_phone')?.value || '').trim();
            const address = (document.getElementById('res_address')?.value || '').trim();
            const livreurIdRaw = document.getElementById('res_livreur')?.value;
            const livreurId = parseId(livreurIdRaw);

            if (!date || !name || !phone || !address) {
                return UI.toast('Date, nom, téléphone et adresse requis', 'warning');
            }

            // Une réservation ne doit PAS être assignée automatiquement.
            // On enregistre la commande COD + un bon de livraison au statut "reservation" (planifié).
            this.state.deliveryDetails = { name, phone, address, date, time };

            // Utiliser le panier Réservation sans toucher au panier normal
            const prevCart = this.state.cart;
            const prevFee = this.state.manualDeliveryFee;
            this.state.cart = this.state.reservationCart.map(i => ({ ...i }));
            this.state.manualDeliveryFee = this.state.reservationManualDeliveryFee || 0;

            const { order, delivery } = this.finalizeOrder({
                paymentMethod: 'cod',
                paymentStatus: 'pending',
                deliveryDetails: { name, phone, address, date, time },
                livreurId: null,
                deliveryStatus: 'reservation'
            }) || {};

            // Restaurer panier normal
            this.state.cart = prevCart;
            this.state.manualDeliveryFee = prevFee;

            // Vider le panier Réservation après enregistrement
            this.state.reservationCart = [];
            this.state.reservationManualDeliveryFee = 0;
            this.state.reservationCartDrawerOpen = false;

            // Optionnel: préparer un SMS au livreur choisi (sans assigner). On n'envoie que si demandé et si un livreur est sélectionné.
            if (sendSms && livreurId) {
                const l = CORE.getUser(livreurId);
                const phoneTo = (l?.phone || '').trim();
                if (phoneTo) {
                    const ref = delivery?.orderRef || order?.reference || 'Course';
                    const when = `${date}${time ? ' ' + time : ''}`;
                    const resItems = this.state.reservationCart || [];
                    const msg = CORE.buildDeliveryTicketSMS({
                        prefix: '📅 RÉSERVATION - Livraison prévue: ' + when,
                        orderRef: ref, clientName: name, clientPhone: phone,
                        address, deliveryTime: time, amount: order?.total || 0,
                        orderItems: resItems.map(i => ({ name: i.name || i.productName, qty: i.qty, price: i.price }))
                    });
                    window.open(`sms:${phoneTo}?body=${encodeURIComponent(msg)}`, '_blank');
                } else {
                    UI.toast('Téléphone du livreur manquant', 'warning');
                }
            }

            // Optionnel: envoyer via WhatsApp pour livreur indépendant
            if (sendWhatsApp && livreurId && delivery) {
                const indep = (CORE.db.independentDeliveryMen || []).find(dm => String(dm.id) == String(livreurId));
                if (indep) {
                    const phoneTo = (indep.phone || '').trim().replace(/\s+/g, '').replace(/-/g, '');
                    let waPhone = CORE.formatPhoneForWhatsApp(phoneTo);

                    const ref = delivery?.orderRef || order?.reference || 'Course';
                    const when = `${date}${time ? ' ' + time : ''}`;
                    const amount = order?.total || 0;
                    const msg = `📦 *RÉSERVATION*\nRéf: ${ref}\nLivraison prévue: ${when}\nClient: ${name}\nTél: ${phone}\nAdresse: ${address}\nMontant: ${CORE.formatPrice(amount)}\n⚠️ Assignation à faire à l'heure prévue.`;
                    window.open(`https://wa.me/${waPhone}?text=${encodeURIComponent(msg)}`, '_blank');
                }
            }

            UI.closeModal();
            UI.toast('Réservation enregistrée (non assignée)', 'success');
            // aller sur l'historique des réservations
            this.navigateTo('reservations');
        },

        showCODConfirmationModal() {
            const userPos = CORE.user?.pos;
            const vendeurId = CORE.state.currentUser?.id;
            const livreurs = CORE.getVisibleUsers().filter(u => u.role === 'livreur' && u.active && (u.pos == userPos || u.posId == userPos));

            // Count active deliveries for this POS
            const activeDeliveries = CORE.getVisibleDeliveries().filter(d => d.status === 'en_cours' && d.posId == userPos);
            const counts = {};
            activeDeliveries.forEach(d => {
                if (d.livreurId) counts[d.livreurId] = (counts[d.livreurId] || 0) + 1;
            });

            // Sort by workload (ascending) so freer drivers appear first, but all are selectable
            livreurs.sort((a, b) => (counts[a.id] || 0) - (counts[b.id] || 0));

            // Livreurs indépendants approuvés
            const approvedIndep = (CORE.db.independentDeliveryMen || [])
                .filter(dm => String(dm.vendeurId) == String(vendeurId) && dm.approvalStatus === 'approved');

            const dd = this.state.deliveryDetails || {};

            const optionsLivreurs = [
                { value: '', label: '-- Choisir un livreur (Optionnel) --' },
                ...livreurs.map(l => {
                    const count = counts[l.id] || 0;
                    // Affichage clair du nombre de courses
                    const status = count > 0 ? `(${count} en cours 🔴)` : `(${count} en cours 🟢)`;
                    return { value: l.id, label: `${l.name} ${status}` };
                }),
                ...approvedIndep.map(dm => {
                    const c = counts[dm.id] || 0;
                    const status = c > 0 ? `(${c} en cours 🔴)` : `(${c} en cours 🟢)`;
                    return { value: dm.id, label: `${dm.name} (Indépendant) ${status}` };
                })
            ];

            UI.modal('Validation Livraison (COD)', `
                <div class="space-y-4">
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl text-sm">
                        <div class="flex justify-between mb-1">
                            <span class="text-slate-500">Total à encaisser:</span>
                            <span class="font-black text-slate-800">${CORE.formatPrice(this.getGrandTotal())}</span>
                        </div>
                    </div>

                    <div class="space-y-3">
                        ${UI.input('cod_name', 'Nom du client', 'text', dd.name || '', '', true)}
                        ${UI.input('cod_phone', 'Téléphone', 'tel', dd.phone || '', '', true)}
                        ${UI.textarea('cod_address', 'Adresse de livraison', dd.address || '', 'Quartier, rue, repères...', 2)}
                        ${UI.input('cod_date', 'Date de livraison', 'date', dd.date || '', '', false)}
                        ${UI.input('cod_time', 'Heure de livraison', 'time', dd.time || '', 'Immédiat', false)}
                    </div>

                    <div class="pt-2 border-t border-slate-100">
                        <label class="block text-sm font-bold text-slate-700 mb-2">Assigner un livreur</label>
                        <select id="cod_livreur" class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-emerald-500 outline-none font-medium">
                            ${optionsLivreurs.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                        </select>
                        <div class="text-xs text-slate-500 mt-1">Vous pouvez assigner un livreur déjà occupé (cumul de courses).</div>
                    </div>

                    <div id="cod_whatsapp_container" style="display:none" class="pt-2">
                        <button onclick="VendeurModule.sendCODViaWhatsApp()" class="w-full py-3 px-4 bg-green-500 text-white font-black rounded-xl hover:bg-green-600 transition flex items-center justify-center gap-2 text-sm">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                            Envoyer + WhatsApp
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-3 pt-4 border-t border-slate-100">
                        <button onclick="VendeurModule.submitCODOrder(false)" class="py-3 px-4 bg-slate-100 text-slate-700 font-black rounded-xl hover:bg-slate-200 transition text-sm">
                            Assignation Directe
                        </button>
                        <button onclick="VendeurModule.submitCODOrder(true)" class="py-3 px-4 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="message-square" class="w-4 h-4"></i> SMS
                        </button>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);

            // Toggle WhatsApp button based on selected livreur
            setTimeout(() => {
                const sel = document.getElementById('cod_livreur');
                const waContainer = document.getElementById('cod_whatsapp_container');
                if (sel && waContainer) {
                    const indepIds = new Set((CORE.db.independentDeliveryMen || []).filter(dm => dm.approvalStatus === 'approved').map(dm => String(dm.id)));
                    const toggle = () => { waContainer.style.display = indepIds.has(String(sel.value)) ? '' : 'none'; };
                    sel.addEventListener('change', toggle);
                    toggle();
                }
            }, 50);
        },

        submitCODOrder(sendSms = false) {
            const name = document.getElementById('cod_name').value.trim();
            const phone = document.getElementById('cod_phone').value.trim();
            const address = document.getElementById('cod_address').value.trim();
            const date = document.getElementById('cod_date').value.trim();
            const time = document.getElementById('cod_time').value.trim();
            const livreurIdRaw = document.getElementById('cod_livreur').value;
            const livreurId = parseId(livreurIdRaw);

            if (!name || !phone || !address) {
                return UI.toast('Nom, téléphone et adresse requis pour la livraison', 'warning');
            }

            this.state.deliveryDetails = { name, phone, address, date, time };

            // Vérifier si validation requise
            const cartTotal = this.getCartTotal();
            const validation = ValidationModule.checkValidationRequired('order', cartTotal);

            if (validation.required) {
                // Afficher modal pour confirmation
                const content = `
                    <div class="space-y-4">
                        <div class="bg-amber-50 rounded-lg p-4 border border-amber-200">
                            <div class="text-sm text-amber-800">
                                <strong>⚠️ Cette commande dépasse le seuil de ${CORE.formatPrice(validation.rule.threshold)}</strong>
                            </div>
                            <div class="text-sm text-amber-700 mt-2">
                                Montant: <strong>${CORE.formatPrice(cartTotal)}</strong>
                            </div>
                            <div class="text-sm text-amber-700 mt-2">
                                Cette commande devra être approuvée par un Manager avant traitement.
                            </div>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                            <div class="text-sm text-blue-700">
                                Les validations seront enregistrées dans l'audit trail.
                            </div>
                        </div>
                    </div>
                `;

                UI.modal(content, [
                    { label: '✓ Continuer & Soumettre', onclick: `VendeurModule.confirmAndSubmitCODOrder(${sendSms ? 'true' : 'false'})` },
                    { label: 'Annuler', onclick: 'UI.closeModal()' }
                ], '⚠️ Validation Requise');
                return;
            }

            const { order, delivery } = this.finalizeOrder({
                paymentMethod: 'cod',
                paymentStatus: 'pending',
                deliveryDetails: { name, phone, address, date, time },
                livreurId
            }) || {};

            // Envoi SMS (optionnel) au livreur sélectionné
            if (sendSms) {
                if (!livreurId) {
                    UI.toast('Aucun livreur sélectionné pour SMS', 'warning');
                } else {
                    const l = CORE.getUser(livreurId);
                    const phoneTo = (l?.phone || '').trim();
                    if (!phoneTo) {
                        UI.toast('Téléphone du livreur manquant', 'warning');
                    } else {
                        const ref = delivery?.orderRef || order?.reference || 'Course';
                        const codOrder = order || CORE.getVisibleOrders().find(o => o.id === delivery?.orderId);
                        const msg = CORE.buildDeliveryTicketSMS({
                            orderRef: ref, clientName: name, clientPhone: phone,
                            address, deliveryTime: time, amount: delivery?.amount || order?.total || 0,
                            orderItems: codOrder?.items || []
                        });
                        window.open(`sms:${phoneTo}?body=${encodeURIComponent(msg)}`, '_blank');
                    }
                }
            }

            UI.closeModal();
        },

        confirmAndSubmitCODOrder(sendSms = false) {
            const name = document.getElementById('cod_name')?.value.trim() || this.state.deliveryDetails?.name;
            const phone = document.getElementById('cod_phone')?.value.trim() || this.state.deliveryDetails?.phone;
            const address = document.getElementById('cod_address')?.value.trim() || this.state.deliveryDetails?.address;
            const date = document.getElementById('cod_date')?.value.trim() || this.state.deliveryDetails?.date;
            const time = document.getElementById('cod_time')?.value.trim() || this.state.deliveryDetails?.time;
            const livreurIdRaw = document.getElementById('cod_livreur')?.value;
            const livreurId = parseId(livreurIdRaw);

            const { order, delivery } = this.finalizeOrder({
                paymentMethod: 'cod',
                paymentStatus: 'pending',
                deliveryDetails: { name, phone, address, date, time },
                livreurId
            }) || {};

            if (order) {
                // Soumettre pour approbation
                ValidationModule.submitOrderForApproval(order.id);
                UI.toast(`✓ Commande créée et soumise pour approbation`, 'success');
            }

            UI.closeModal();
        },

        finalizeOrder({ paymentMethod, paymentStatus, deliveryDetails, livreurId, deliveryStatus = null }) {
            const subtotal = this.getCartTotal();
            const deliveryFee = this.getDeliveryFee();
            const total = subtotal + deliveryFee;
            const ref = `CMD-${String(CORE.getVisibleOrders().length + 1).padStart(4,'0')}`;
            const userPos = CORE.state.currentUser?.pos || CORE.user?.pos;

            // Stock checks (POS-aware)
            for (const it of this.state.cart) {
                const p = CORE.getProduct(it.productId);
                if (!p) return UI.toast(`Produit introuvable: ${it.name}`, 'error');
                if (it.variantId) {
                    const variant = CORE.db.productVariants.find(v => v.id === it.variantId && !v._deleted);
                    if (!variant || variant.stock < it.qty) return UI.toast(`Stock variante insuffisant: ${it.name}`, 'error');
                } else {
                    const availableStock = CORE.getProductStock(it.productId, userPos);
                    if (availableStock < it.qty) return UI.toast(`Stock insuffisant: ${it.name}`, 'error');
                }
            }

            // Deduct stock (POS-aware: updates both posStocks and master stock)
            for (const it of this.state.cart) {
                const p = CORE.getProduct(it.productId);
                if (it.variantId) {
                    const variant = CORE.db.productVariants.find(v => v.id === it.variantId);
                    if (variant) {
                        CORE.updateProductVariant(variant.id, { stock: variant.stock - it.qty });
                    }
                } else {
                    // Build updates: always decrement master stock
                    const updates = { stock: Math.max(0, (p.stock || 0) - it.qty) };
                    // Also decrement POS-specific stock if posStocks exists
                    if (userPos && p.posStocks && p.posStocks[userPos]) {
                        const newPosStocks = JSON.parse(JSON.stringify(p.posStocks));
                        newPosStocks[userPos].stock = Math.max(0, (newPosStocks[userPos].stock || 0) - it.qty);
                        updates.posStocks = newPosStocks;
                    }
                    CORE.update('products', p.id, updates);
                }
                CORE.recordStockMovement({ productId: p.id, type: 'out', qty: it.qty, ref, note: 'Vente', variantId: it.variantId || null });
            }

            const clientName = deliveryDetails?.name || (this.state.selectedClientId ? CORE.getClient(this.state.selectedClientId)?.name : 'Client');
            const clientPhone = deliveryDetails?.phone || '';
            const clientAddress = deliveryDetails?.address || '';
            const deliveryDate = deliveryDetails?.date || null;
            const deliveryTime = deliveryDetails?.time || null;

            // Détection de client existant ou création automatique
            let clientId = this.state.selectedClientId || null;
            const clientPosId = userPos || CORE.user?.pos || 1;
            if (!clientId && clientPhone) {
                // Chercher par téléphone - filtré par POS
                const existingClient = CORE.getVisibleClients().find(c =>
                    (c.phone || '').replace(/\s+/g, '') === clientPhone.replace(/\s+/g, '') &&
                    c.posId == clientPosId
                );
                if (existingClient) {
                    clientId = existingClient.id;
                    // Mettre à jour les infos du client si nécessaire
                    if (clientAddress && !existingClient.address) {
                        CORE.update('clients', clientId, { address: clientAddress });
                    }
                    if (clientName && clientName !== 'Client' && !existingClient.name) {
                        CORE.update('clients', clientId, { name: clientName });
                    }
                } else if (clientName && clientName !== 'Client') {
                    // Créer automatiquement un nouveau client
                    const newClient = CORE.create('clients', {
                        name: clientName,
                        phone: clientPhone,
                        address: clientAddress || '',
                        posId: CORE.user?.pos || 1,
                        createdAt: new Date().toISOString()
                    });
                    clientId = newClient.id;
                    console.log('✅ Nouveau client créé automatiquement:', newClient);
                }
            } else if (!clientId && clientName && clientName !== 'Client') {
                // Même sans téléphone, créer le client si on a un nom
                const existingByName = CORE.getVisibleClients().find(c =>
                    c.name?.toLowerCase().trim() === clientName.toLowerCase().trim() &&
                    c.posId == (CORE.user?.pos || 1)
                );
                if (existingByName) {
                    clientId = existingByName.id;
                    // Mettre à jour le téléphone si fourni
                    if (clientPhone && !existingByName.phone) {
                        CORE.update('clients', clientId, { phone: clientPhone });
                    }
                } else {
                    const newClient = CORE.create('clients', {
                        name: clientName,
                        phone: clientPhone || '',
                        address: clientAddress || '',
                        posId: CORE.user?.pos || 1,
                        createdAt: new Date().toISOString()
                    });
                    clientId = newClient.id;
                    console.log('✅ Nouveau client créé automatiquement (sans téléphone):', newClient);
                }
            }

            const order = CORE.create('orders', {
                reference: ref,
                subtotal,
                deliveryFee,
                total,
                status: paymentMethod === 'cod' ? (livreurId ? 'delivering' : 'pending') : 'delivered',
                paymentMethod, // garder le code (cash/mobile/card/cod)
                paymentStatus,
                sellerId: CORE.state.currentUser?.id,
                        posId: CORE.user?.pos || 1,
                cityId: CORE.state.currentUser?.city || 1,
                clientId: clientId || undefined, // Lier au client existant si trouvé
                clientName,
                clientPhone,
                clientAddress,
                deliveryDate,
                deliveryTime,
                items: this.state.cart.map(i => ({ productId: i.productId, name: i.name, qty: i.qty, price: i.price, variantId: i.variantId || null, sku: i.sku || null, attributes: i.attributes || null }))
            });

            // Enregistrer l'activité
            CORE.logActivity('create', 'order', order.id, {
                entityName: `Commande ${order.reference}`,
                description: `${order.items?.length || 0} articles - ${clientName}`,
                amount: order.total,
                status: 'success'
            });

            if (paymentStatus === 'paid') CORE.ensureSaleTransaction(order);

            let delivery = null;
            if (paymentMethod === 'cod') {
                const forcedStatus = deliveryStatus ? String(deliveryStatus) : null;
                const effectiveLivreurId = forcedStatus ? null : (livreurId || null);
                // Statut initial toujours 'en_attente' - c'est au livreur de signaler 'en_cours'
                const effectiveStatus = forcedStatus ? forcedStatus : 'en_attente';

                delivery = CORE.create('deliveries', {
                    orderId: order.id,
                    orderRef: order.reference,
                    clientName,
                    clientPhone,
                    address: clientAddress,
                    deliveryDate,
                    deliveryTime,
                    livreurId: effectiveLivreurId,
                        posId: CORE.user?.pos || 1,
                    status: effectiveStatus,
                    amount: total,
                    commission: Math.round(total * 0.05)
                });

                if (forcedStatus === 'reservation') {
                    UI.toast('Bon de livraison planifié (réservation)', 'info');
                } else if (effectiveLivreurId) {
                    const l = CORE.getUser(effectiveLivreurId);
                    UI.toast(`Course assignée à ${l?.name || 'Livreur'}`, 'info');
                } else {
                    UI.toast('Course mise en attente (Dispatch)', 'info');
                }
            }

            this.state.cart = [];
            this.state.deliveryDetails = null; // Reset details after successful order

            UI.toast(`Commande ${order.reference} créée`, 'success');
            this.showReceiptModal(order.id);
            App.rerender();
            return { order, delivery };
        },

        showReceiptModal(orderId) {
            const o = CORE.getVisibleOrders().find(x => x.id === orderId);
            if (!o) return;
            const items = (o.items || []).map(it => `<div class="flex justify-between text-sm"><span>${it.qty}× ${it.name}</span><span class="font-bold">${CORE.formatPrice(it.qty * it.price)}</span></div>`).join('');

            const subtotal = o.subtotal ?? (o.items || []).reduce((a,it)=>a+(Number(it.qty||0)*Number(it.price||0)),0);
            const deliveryFee = Number(o.deliveryFee || 0);
            const hasDelivery = deliveryFee > 0;

            // Texte personnalisé du logo
            const prefs = this.state.preferences || {};
            const logoText = prefs.receiptLogoText?.trim() || CORE.getCompanyName();
            const subtitleText = prefs.receiptSubtitle?.trim() || '';

            UI.modal('Ticket de caisse', `
                <div class="print-area">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="font-black text-slate-900 text-xl">${logoText}</div>
                            ${subtitleText ? `<div class="text-xs text-emerald-600 font-medium italic">${subtitleText}</div>` : ''}
                            <div class="text-xs text-slate-500 font-bold uppercase tracking-wider">${CORE.getPOS(o.posId)?.name || 'Point de vente'}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-black">${o.reference}</div>
                            <div class="text-xs text-slate-500">${CORE.formatDate(o.createdAt)}</div>
                        </div>
                    </div>
                    <div class="my-4 h-px bg-slate-200"></div>
                    <div class="space-y-2">${items}</div>
                    <div class="my-4 h-px bg-slate-200"></div>

                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between"><span class="font-bold text-slate-600">Sous-total</span><span class="font-black">${CORE.formatPrice(subtotal)}</span></div>
                        ${hasDelivery ? `<div class="flex justify-between"><span class="font-bold text-slate-600">Livraison</span><span class="font-black">${CORE.formatPrice(deliveryFee)}</span></div>` : ''}
                    </div>

                    <div class="mt-3 flex justify-between items-center">
                        <div class="text-sm font-bold text-slate-600">Total</div>
                        <div class="text-2xl font-black text-emerald-600">${CORE.formatPrice(o.total)}</div>
                    </div>
                    <div class="mt-2 text-xs text-slate-500">Paiement: <span class="font-bold">${CORE.paymentMethodLabel(o.paymentMethod)}</span></div>
                    ${o.zoneName ? `<div class="mt-1 text-xs text-slate-500">Zone: <span class="font-bold">${o.zoneName}</span></div>` : ''}
                </div>
                <div class="no-print mt-5 p-4 bg-slate-50 rounded-2xl border border-slate-200 text-xs text-slate-600">
                    Astuce: cliquez sur <b>Imprimer</b> pour générer un ticket.
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' },
                { label: 'Imprimer', onclick: 'window.print()', class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        // =====================
        // GESTION CLIENTS LÉGÈRE
        // =====================
        getClientOrderHistory(clientId) {
            return CORE.getVisibleOrders()
                .filter(o => o.clientId === clientId)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        },

        getClientStats(clientId) {
            const orders = this.getClientOrderHistory(clientId);
            const totalSpent = orders.reduce((a, o) => a + (o.total || 0), 0);
            const totalItems = orders.reduce((a, o) => a + (o.items?.reduce((x, i) => x + i.qty, 0) || 0), 0);
            const avgOrder = orders.length > 0 ? Math.round(totalSpent / orders.length) : 0;
            const lastOrder = orders[0];
            const lastOrderDate = lastOrder ? lastOrder.createdAt : null;
            return { totalSpent, totalItems, avgOrder, lastOrderDate, orderCount: orders.length };
        },

        updateClientNotes(clientId, notes) {
            const c = CORE.getClient(clientId);
            if (c) {
                c.notes = notes.trim();
                CORE.save();
                UI.toast('Notes sauvegardées', 'success');
                this.showClientPickerModal();
            }
        },

        updateClientTags(clientId, tags) {
            const c = CORE.getClient(clientId);
            if (c) {
                c.tags = Array.isArray(tags) ? tags : [];
                CORE.save();
                UI.toast('Tags sauvegardés', 'success');
                this.showClientPickerModal();
            }
        },

        showClientTagsModal(clientId) {
            const c = CORE.getClient(clientId);
            if (!c) return;

            const availableTags = CORE.db.clientTags || [];
            const clientTags = c.tags || [];

            UI.modal(`Classifier - ${c.name}`, `
                <div class="space-y-4">
                    <p class="text-xs text-slate-500">Sélectionnez les tags pour classifier ce client.</p>

                    <div class="grid grid-cols-2 gap-2">
                        ${availableTags.map(tag => {
                            const isSelected = clientTags.includes(tag.id);
                            const colorMap = {
                                emerald: 'border-emerald-300 bg-emerald-50',
                                red: 'border-red-300 bg-red-50',
                                purple: 'border-purple-300 bg-purple-50',
                                amber: 'border-amber-300 bg-amber-50',
                                blue: 'border-blue-300 bg-blue-50',
                                cyan: 'border-cyan-300 bg-cyan-50'
                            };
                            const colorText = {
                                emerald: 'text-emerald-700',
                                red: 'text-red-700',
                                purple: 'text-purple-700',
                                amber: 'text-amber-700',
                                blue: 'text-blue-700',
                                cyan: 'text-cyan-700'
                            };
                            const color = colorMap[tag.color] || colorMap.slate;
                            const textColor = colorText[tag.color] || 'text-slate-700';

                            return `
                                <button onclick="VendeurModule.toggleClientTag('${tag.id}', ${clientTags.includes(tag.id) ? 'true' : 'false'}, ${clientId})" class="p-3 rounded-xl border-2 transition ${isSelected ? color + ' border-opacity-100' : 'border-slate-200 bg-white hover:border-slate-300'}">
                                    <div class="flex items-center gap-2">
                                        <i data-lucide="${tag.icon}" class="w-4 h-4 ${isSelected ? textColor : 'text-slate-400'}"></i>
                                        <span class="text-xs font-black ${isSelected ? textColor : 'text-slate-600'}">${tag.label}</span>
                                    </div>
                                </button>
                            `;
                        }).join('')}
                    </div>

                    ${clientTags.length > 0 ? `
                        <div class="p-3 bg-slate-50 rounded-xl border border-slate-200">
                            <div class="text-xs font-bold text-slate-600 mb-2">Tags actuels:</div>
                            <div class="flex flex-wrap gap-1">
                                ${clientTags.map(tagId => {
                                    const tag = availableTags.find(t => t.id === tagId);
                                    if (!tag) return '';
                                    return `<span class="px-2 py-1 bg-slate-100 text-slate-700 text-xs font-bold rounded-full flex items-center gap-1">
                                        <i data-lucide="${tag.icon}" class="w-3 h-3"></i> ${tag.label}
                                    </span>`;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Sauvegarder', onclick: `VendeurModule.updateClientTags(${clientId}, [${clientTags.map(t => `'${t}'`).join(', ')}])`, class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition' }
            ]);
        },

        toggleClientTag(tagId, isSelected, clientId) {
            const c = CORE.getClient(clientId);
            if (!c) return;

            c.tags = c.tags || [];
            if (isSelected) {
                c.tags = c.tags.filter(t => t !== tagId);
            } else {
                if (!c.tags.includes(tagId)) {
                    c.tags.push(tagId);
                }
            }

            CORE.save();
            this.showClientTagsModal(clientId);
        },

        // Clients - debounce pour la recherche
        clientPickerSearchTimeout: null,
        handleClientPickerSearch(value) {
            this.state.clientPickerSearch = value;
            // Debounce: attendre 300ms après la dernière frappe
            clearTimeout(this.clientPickerSearchTimeout);
            this.clientPickerSearchTimeout = setTimeout(() => {
                this.showClientPickerModal();
                // Restaurer le focus après le rerender
                setTimeout(() => {
                    const input = document.getElementById('client-picker-search');
                    if (input) {
                        input.focus();
                        input.setSelectionRange(input.value.length, input.value.length);
                    }
                }, 50);
            }, 300);
        },

        showClientPickerModal() {
            const userPos = CORE.user?.pos || CORE.state.currentUser?.pos;
            const q = (this.state.clientPickerSearch || '').toLowerCase().trim();
            const clients = CORE.getVisibleClients()
                .filter(c => c.posId == userPos) // Filtrer par POS
                .filter(c => !q || (c.name || '').toLowerCase().includes(q) || (c.phone || '').toLowerCase().includes(q) || (c.notes || '').toLowerCase().includes(q))
                .sort((a, b) => {
                    // Trier: segment VIP en premier, puis par dernière date d'achat
                    const aVip = (a.segment === 'vip') ? 0 : 1;
                    const bVip = (b.segment === 'vip') ? 0 : 1;
                    if (aVip !== bVip) return aVip - bVip;
                    return new Date(b.lastPurchaseDate || 0) - new Date(a.lastPurchaseDate || 0);
                })
                .slice(0, 30);

            UI.modal('Sélectionner un client', `
                <div class="space-y-4">
                    <div class="relative flex gap-2">
                        <div class="relative flex-1">
                            <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                            <input id="client-picker-search" value="${this.state.clientPickerSearch}" onkeyup="VendeurModule.handleClientPickerSearch(this.value)" onkeypress="if(event.key==='Enter'){event.preventDefault();}" placeholder="Nom, téléphone ou notes..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-2 max-h-[55vh] overflow-auto">
                        ${clients.length === 0 ? `<div class="p-6 text-center text-slate-400 font-medium">Aucun client trouvé</div>` : ''}
                        ${clients.map(c => {
                            const selected = this.state.selectedClientId === c.id;
                            const stats = this.getClientStats(c.id);
                            const isVip = c.segment === 'vip';
                            const clientTags = c.tags || [];
                            const availableTags = CORE.db.clientTags || [];

                            return `
                            <div class="rounded-2xl border ${selected ? 'border-emerald-300 bg-emerald-50' : 'border-slate-100 bg-white hover:bg-slate-50'} transition p-3">
                                <div class="flex items-start justify-between gap-2 mb-2">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2">
                                            <div class="font-black text-slate-900 truncate">${c.name}</div>
                                            ${isVip ? `<span class="text-xs font-black px-1.5 py-0.5 bg-purple-100 text-purple-700 rounded">VIP</span>` : ''}
                                        </div>
                                        <div class="text-xs text-slate-500">${c.phone || ''}</div>
                                    </div>
                                    <button onclick="VendeurModule.selectClient(${c.id})" class="${selected ? 'bg-emerald-500 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'} px-3 py-1.5 rounded-lg font-black text-xs transition">
                                        Choisir
                                    </button>
                                </div>

                                <div class="text-xs text-slate-600 mb-2">
                                    <div><b>Adresse:</b> ${c.address || '—'}</div>
                                </div>

                                ${c.notes ? `<div class="mb-2 p-2 bg-blue-50 border border-blue-100 rounded-lg"><div class="text-xs text-blue-700"><b>📝 Notes:</b> ${c.notes}</div></div>` : ''}

                                ${clientTags.length > 0 ? `
                                    <div class="mb-2 flex flex-wrap gap-1">
                                        ${clientTags.map(tagId => {
                                            const tag = availableTags.find(t => t.id === tagId);
                                            if (!tag) return '';
                                            const colorBg = {
                                                emerald: 'bg-emerald-100 text-emerald-700',
                                                red: 'bg-red-100 text-red-700',
                                                purple: 'bg-purple-100 text-purple-700',
                                                amber: 'bg-amber-100 text-amber-700',
                                                blue: 'bg-blue-100 text-blue-700',
                                                cyan: 'bg-cyan-100 text-cyan-700'
                                            }[tag.color] || 'bg-slate-100 text-slate-700';
                                            return `<span class="px-2 py-0.5 ${colorBg} text-[10px] font-black rounded-full flex items-center gap-1">
                                                <i data-lucide="${tag.icon}" class="w-3 h-3"></i> ${tag.label}
                                            </span>`;
                                        }).join('')}
                                    </div>
                                ` : ''}

                                <div class="grid grid-cols-4 gap-1 text-xs mb-2">
                                    <div class="bg-slate-50 p-1.5 rounded">
                                        <div class="text-slate-500 font-bold">Achats</div>
                                        <div class="font-black text-slate-800">${stats.orderCount}</div>
                                    </div>
                                    <div class="bg-emerald-50 p-1.5 rounded">
                                        <div class="text-emerald-600 font-bold">Total</div>
                                        <div class="font-black text-emerald-700 text-xs">${CORE.formatPrice(stats.totalSpent).split(' ')[0]}</div>
                                    </div>
                                    <div class="bg-blue-50 p-1.5 rounded">
                                        <div class="text-blue-600 font-bold">Articles</div>
                                        <div class="font-black text-blue-700">${stats.totalItems}</div>
                                    </div>
                                    <div class="bg-amber-50 p-1.5 rounded">
                                        <div class="text-amber-600 font-bold">Moy.</div>
                                        <div class="font-black text-amber-700 text-xs">${CORE.formatPrice(stats.avgOrder).split(' ')[0]}</div>
                                    </div>
                                </div>

                                <div class="flex gap-2">
                                    <button onclick="VendeurModule.showClientHistoryModal(${c.id})" class="flex-1 px-2 py-1.5 bg-blue-100 text-blue-700 rounded-lg font-bold text-xs hover:bg-blue-200 transition flex items-center justify-center gap-1">
                                        <i data-lucide="history" class="w-3 h-3"></i> Historique
                                    </button>
                                    <button onclick="VendeurModule.showClientNotesModal(${c.id})" class="flex-1 px-2 py-1.5 bg-purple-100 text-purple-700 rounded-lg font-bold text-xs hover:bg-purple-200 transition flex items-center justify-center gap-1">
                                        <i data-lucide="edit-2" class="w-3 h-3"></i> Notes
                                    </button>
                                    <button onclick="VendeurModule.showClientTagsModal(${c.id})" class="flex-1 px-2 py-1.5 bg-amber-100 text-amber-700 rounded-lg font-bold text-xs hover:bg-amber-200 transition flex items-center justify-center gap-1">
                                        <i data-lucide="tag" class="w-3 h-3"></i> Classer
                                    </button>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `, [
                { label: 'Nouveau client', onclick: 'VendeurModule.showNewClientModal()', class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showClientHistoryModal(clientId) {
            const c = CORE.getClient(clientId);
            if (!c) return;

            const orders = this.getClientOrderHistory(clientId);
            const stats = this.getClientStats(clientId);

            UI.modal(`Historique - ${c.name}`, `
                <div class="space-y-4">
                    <div class="grid grid-cols-4 gap-2 text-xs">
                        <div class="bg-slate-50 p-3 rounded-xl">
                            <div class="text-slate-500 font-bold uppercase">Commandes</div>
                            <div class="font-black text-lg text-slate-800">${stats.orderCount}</div>
                        </div>
                        <div class="bg-emerald-50 p-3 rounded-xl">
                            <div class="text-emerald-600 font-bold uppercase">Dépensé</div>
                            <div class="font-black text-emerald-700">${CORE.formatPrice(stats.totalSpent)}</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-xl">
                            <div class="text-blue-600 font-bold uppercase">Articles</div>
                            <div class="font-black text-lg text-blue-700">${stats.totalItems}</div>
                        </div>
                        <div class="bg-amber-50 p-3 rounded-xl">
                            <div class="text-amber-600 font-bold uppercase">Moyenne</div>
                            <div class="font-black text-amber-700">${CORE.formatPrice(stats.avgOrder)}</div>
                        </div>
                    </div>

                    <div class="space-y-2 max-h-[40vh] overflow-y-auto">
                        ${orders.length === 0 ? `<div class="p-6 text-center text-slate-400 font-medium">Aucune commande</div>` : ''}
                        ${orders.map((o, idx) => `
                            <div class="p-3 border border-slate-200 rounded-xl bg-slate-50">
                                <div class="flex items-center justify-between mb-1">
                                    <div class="font-bold text-slate-800">${o.reference}</div>
                                    <div class="text-xs font-bold text-emerald-600">${CORE.formatPrice(o.total)}</div>
                                </div>
                                <div class="text-xs text-slate-500 mb-1">
                                    ${CORE.formatDate(o.createdAt)}
                                </div>
                                <div class="text-xs text-slate-600">
                                    ${o.items?.map(it => `${it.qty}× ${it.name}`).join(', ') || '—'}
                                </div>
                                <div class="mt-1 flex gap-1">
                                    <span class="px-2 py-0.5 text-xs font-bold rounded ${
                                        o.status === 'delivered' ? 'bg-emerald-100 text-emerald-700' :
                                        o.status === 'cancelled' ? 'bg-red-100 text-red-700' :
                                        'bg-blue-100 text-blue-700'
                                    }">${o.status === 'delivered' ? '✓ Livrée' : o.status === 'cancelled' ? '✕ Annulée' : '⏳ ' + o.status}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showClientNotesModal(clientId) {
            const c = CORE.getClient(clientId);
            if (!c) return;

            UI.modal(`Modifier notes - ${c.name}`, `
                <div class="space-y-4">
                    <p class="text-xs text-slate-500">Ajoutez des notes rapides pour ce client (statut VIP, préférences, etc.)</p>
                    <textarea id="client_notes" rows="4" placeholder="Ex: Client VIP, préfère livraison le jeudi, numéro de compte: XXXX..." class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:bg-white focus:border-transparent outline-none transition font-medium text-slate-800 placeholder-slate-400">${c.notes || ''}</textarea>
                    <div class="text-xs text-slate-400">
                        ${(c.notes || '').length} / 500 caractères
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Sauvegarder', onclick: `VendeurModule.updateClientNotes(${clientId}, document.getElementById('client_notes').value)`, class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition' }
            ]);
        },

        selectClient(clientId) {
            const c = CORE.getClient(clientId);
            if (!c) return;
            this.state.selectedClientId = c.id;
            this.recordClientAccess(clientId); // Enregistrer l'accès
            // Pré-remplir détails de livraison depuis le client (si non déjà saisis)
            const dd = this.state.deliveryDetails || { name: '', phone: '', address: '', date: '', time: '' };
            this.state.deliveryDetails = {
                name: dd.name || c.name || '',
                phone: dd.phone || c.phone || '',
                address: dd.address || c.address || '',
                date: dd.date || '',
                time: dd.time || ''
            };
            UI.closeModal();
            UI.toast('Client sélectionné', 'success');
            App.rerender();
        },

        showNewClientModal() {
            UI.modal('Nouveau client', `
                <div class="space-y-4">
                    ${UI.input('new_client_name','Nom complet','text','','Ex: Ibrahim Bakary',true)}
                    ${UI.input('new_client_phone','Téléphone','tel','',CORE.getPhonePlaceholder(),true)}
                    ${UI.textarea('new_client_address','Adresse','','Rue / Quartier')}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'VendeurModule.saveNewClient()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },
        saveNewClient() {
            const name = UI.val('new_client_name').trim();
            const phone = UI.val('new_client_phone').trim();
            const address = UI.val('new_client_address').trim();
            if (!name || !phone) return UI.toast('Nom et téléphone requis', 'warning');
            const created = CORE.create('clients', { name, phone, address, totalOrders: 0, totalSpent: 0 });
            this.state.selectedClientId = created.id;
            // Pré-remplir détails livraison avec le client créé
            this.state.deliveryDetails = { name: created.name || '', phone: created.phone || '', address: created.address || '', date: '', time: '' };
            UI.closeModal();
            UI.toast('Client ajouté', 'success');
            App.rerender();
        },

        // Détails de livraison (saisie manuelle par le vendeur)
        showDeliveryDetailsModal() {
            const selectedClient = this.state.selectedClientId ? CORE.getClient(this.state.selectedClientId) : null;
            const dd = this.state.deliveryDetails || { name: '', phone: '', address: '', date: '', time: '' };

            // Si aucun détail saisi, on propose par défaut ceux du client
            const initName = dd.name || selectedClient?.name || '';
            const initPhone = dd.phone || selectedClient?.phone || '';
            const initAddress = dd.address || selectedClient?.address || '';
            const initDate = dd.date || '';
            const initTime = dd.time || '';

            const suggestionsHtml = `
                <div id="client-suggestions-container" class="hidden p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                    <div class="text-xs font-black text-blue-700 mb-3">💡 Clients correspondants trouvés:</div>
                    <div id="client-suggestions-list" class="space-y-2"></div>
                </div>
            `;

            UI.modal('Détails de livraison', `
                <div class="space-y-4">
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">
                        Ces informations seront utilisées sur le <b>bon de livraison</b> (paiement à la livraison).
                    </div>
                    ${UI.input('dd_name','Nom','text', initName, 'Nom du client / réception', true)}
                    ${UI.input('dd_phone','Téléphone','tel', initPhone, CORE.getPhonePlaceholder(), true)}
                    ${UI.input('dd_date','Date de livraison','date', initDate, '', false)}
                    ${UI.input('dd_time','Heure de livraison','time', initTime, '', false)}
                    ${UI.textarea('dd_address','Adresse', initAddress, 'Adresse complète (quartier, rue, repères)', 3)}
                    ${suggestionsHtml}
                </div>
            `, [
                { label: 'Effacer', onclick: 'VendeurModule.clearDeliveryDetails()', class: 'px-5 py-2.5 bg-slate-100 text-slate-700 font-black rounded-xl hover:bg-slate-200 transition' },
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'VendeurModule.saveDeliveryDetails()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);

            // Ajouter les écouteurs pour les suggestions en temps réel
            setTimeout(() => {
                const nameInput = document.getElementById('dd_name');
                const phoneInput = document.getElementById('dd_phone');
                const addressInput = document.getElementById('dd_address');

                const onInput = () => {
                    const name = nameInput?.value?.trim() || '';
                    const phone = phoneInput?.value?.trim() || '';
                    const address = addressInput?.value?.trim() || '';
                    VendeurModule.updateClientSuggestions(name, phone, address);
                };

                nameInput?.addEventListener('input', onInput);
                phoneInput?.addEventListener('input', onInput);
                addressInput?.addEventListener('input', onInput);
            }, 100);
        },

        updateClientSuggestions(name, phone, address) {
            const userPos = CORE.user?.pos || CORE.state.currentUser?.pos;
            const suggestions = [];

            // Rechercher par téléphone (exact) - filtré par POS
            if (phone) {
                const cleanPhone = phone.replace(/\s+/g, '').replace(/[^0-9]/g, '');
                if (cleanPhone.length >= 7) {
                    const byPhone = CORE.getVisibleClients().filter(c => {
                        if (c.posId != userPos) return false; // Filtre POS
                        const cPhone = (c.phone || '').replace(/\s+/g, '').replace(/[^0-9]/g, '');
                        return cPhone.endsWith(cleanPhone) || cleanPhone.endsWith(cPhone);
                    });
                    suggestions.push(...byPhone);
                }
            }

            // Rechercher par nom (début du nom) - filtré par POS
            if (name && name.length >= 2) {
                const nameQuery = name.toLowerCase();
                const byName = CORE.getVisibleClients().filter(c =>
                    c.posId == userPos && // Filtre POS
                    (c.name || '').toLowerCase().startsWith(nameQuery) &&
                    !suggestions.find(s => s.id === c.id)
                );
                suggestions.push(...byName);
            }

            // Rechercher par adresse (partielle) - filtré par POS
            if (address && address.length >= 3) {
                const addressQuery = address.toLowerCase();
                const byAddress = CORE.getVisibleClients().filter(c =>
                    c.posId == userPos && // Filtre POS
                    (c.address || '').toLowerCase().includes(addressQuery) &&
                    !suggestions.find(s => s.id === c.id)
                );
                suggestions.push(...byAddress);
            }

            // Limiter à 5 suggestions
            const uniqueSuggestions = suggestions.slice(0, 5);

            // Afficher les suggestions
            const container = document.getElementById('client-suggestions-container');
            const list = document.getElementById('client-suggestions-list');

            if (uniqueSuggestions.length > 0) {
                container?.classList.remove('hidden');
                list.innerHTML = uniqueSuggestions.map(c => `
                    <div class="p-3 bg-white border border-blue-200 rounded-xl flex items-center justify-between cursor-pointer hover:bg-blue-50 transition group">
                        <div class="flex-1">
                            <div class="font-black text-slate-900 text-sm">${Utils.escapeHtml(c.name)}</div>
                            <div class="text-xs text-slate-500">${Utils.escapeHtml(c.phone || 'N/A')} • ${Utils.escapeHtml(c.address || 'Adresse non définie')}</div>
                        </div>
                        <button onclick="VendeurModule.selectClientSuggestion(${c.id})" class="px-3 py-1.5 bg-blue-600 text-white text-xs font-black rounded-lg opacity-0 group-hover:opacity-100 transition">Utiliser</button>
                    </div>
                `).join('');
            } else {
                container?.classList.add('hidden');
            }
        },

        selectClientSuggestion(clientId) {
            const client = CORE.getClient(clientId);
            if (!client) return;

            // Pré-remplir avec les infos du client
            document.getElementById('dd_name').value = client.name || '';
            document.getElementById('dd_phone').value = client.phone || '';
            document.getElementById('dd_address').value = client.address || '';

            // Sélectionner le client aussi
            this.state.selectedClientId = clientId;

            // Masquer les suggestions
            const container = document.getElementById('client-suggestions-container');
            container?.classList.add('hidden');

            UI.toast(`Client ${client.name} sélectionné`, 'success');
        },

        saveDeliveryDetails() {
            const name = UI.val('dd_name').trim();
            const phoneRaw = UI.val('dd_phone').trim();
            const date = UI.val('dd_date').trim();
            const time = UI.val('dd_time').trim();
            const address = UI.val('dd_address').trim();
            if (!name || !phoneRaw) return UI.toast('Nom et téléphone requis', 'warning');

            const phone = phoneRaw.replace(/\s+/g, ' ').trim();
            const digits = phone.replace(/[^0-9]/g, '');
            if (digits.length < 7) return UI.toast('Numéro de téléphone invalide', 'warning');

            // Vérifier si le client existe déjà (par téléphone) - filtré par POS
            const cleanPhone = phone.replace(/\s+/g, '').replace(/[^0-9]/g, '');
            const userPos = CORE.user?.pos || CORE.state.currentUser?.pos || 1;
            let existingClient = CORE.getVisibleClients().find(c => {
                const cPhone = (c.phone || '').replace(/\s+/g, '').replace(/[^0-9]/g, '');
                return (cPhone.endsWith(cleanPhone) || cleanPhone.endsWith(cPhone)) && c.posId == userPos;
            });

            // Si le client n'existe pas, le créer automatiquement
            if (!existingClient) {
                existingClient = CORE.create('clients', {
                    name,
                    phone,
                    address: address || '',
                    email: '',
                    totalOrders: 0,
                    totalSpent: 0,
                    status: 'active',
                    segment: 'nouveau',
                    tags: [],
                    notes: 'Créé automatiquement lors d\'une saisie de livraison',
                    posId: userPos
                });
                UI.toast(`✨ Nouveau client créé: ${name}`, 'success');
            }

            // Sélectionner le client (nouveau ou existant)
            this.state.selectedClientId = existingClient.id;
            this.state.deliveryDetails = { name, phone, address, date, time };

            UI.closeModal();
            UI.toast('Détails de livraison enregistrés', 'success');
            App.rerender();
        },

        clearDeliveryDetails() {
            this.state.deliveryDetails = { name: '', phone: '', address: '', date: '', time: '' };
            UI.closeModal();
            UI.toast('Détails de livraison effacés', 'info');
            App.rerender();
        },

        // =====================
        // VARIANTES AVANCÉES
        // =====================
        showProductVariantsModal(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return;

            const variants = CORE.getProductVariants(productId);
            const attrTypes = CORE.db.productAttributeTypes || [];

            UI.modal(`Variantes: ${product.name}`, `
                <div class="space-y-4">
                    <div class="text-xs text-slate-500">Gérez les SKU, prix et stocks par variante.</div>

                    <div class="max-h-[50vh] overflow-y-auto space-y-3">
                        ${variants.length === 0 ? `
                            <div class="p-6 text-center text-slate-400 bg-slate-50 rounded-xl border border-slate-200">
                                <div class="text-sm font-medium">Aucune variante</div>
                                <div class="text-xs mt-1">Cliquez ci-dessous pour ajouter une variante.</div>
                            </div>
                        ` : ''}

                        ${variants.map((v, idx) => `
                            <div class="border border-slate-200 rounded-xl p-3 bg-slate-50">
                                <div class="flex items-start justify-between mb-2">
                                    <div>
                                        <div class="text-xs font-black text-slate-500 uppercase">SKU</div>
                                        <div class="font-mono text-sm font-bold text-slate-800">${v.sku || '—'}</div>
                                    </div>
                                    <button onclick="VendeurModule.deleteProductVariant(${productId}, ${idx})" class="px-2 py-1 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 text-xs font-bold">
                                        Supprimer
                                    </button>
                                </div>

                                <div class="grid grid-cols-3 gap-2 mb-2 text-xs">
                                    <div>
                                        <div class="font-black text-slate-500 uppercase mb-0.5">Prix</div>
                                        <div class="font-bold text-slate-800">${CORE.formatPrice(v.price || product.price)}</div>
                                    </div>
                                    <div>
                                        <div class="font-black text-slate-500 uppercase mb-0.5">Stock</div>
                                        <div class="font-bold text-slate-800">${v.stock ?? product.stock}</div>
                                    </div>
                                    <div>
                                        <div class="font-black text-slate-500 uppercase mb-0.5">Attributs</div>
                                        <div class="text-slate-700">${(v.attributes || []).length}</div>
                                    </div>
                                </div>

                                ${(v.attributes || []).map(attr => `
                                    <div class="text-xs bg-white border border-slate-200 rounded px-2 py-1 mb-1 flex items-center justify-between">
                                        <span class="font-medium text-slate-600">${attr.name}:</span>
                                        <span class="font-bold text-slate-800">${attr.value}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `).join('')}
                    </div>

                    <div class="pt-3 border-t border-slate-100">
                        <button onclick="VendeurModule.showAddVariantModal(${productId})" class="w-full py-3 px-4 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition text-sm flex items-center justify-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i> Ajouter une variante
                        </button>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showAddVariantModal(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return;

            window._vendeurVariantAttrsCount = 2; // Start with 2 attribute rows

            UI.modal(`Nouvelle variante: ${product.name}`, `
                <div class="space-y-4">
                    <div class="text-xs text-slate-500">Définissez les attributs, SKU, prix et stock.</div>

                    <div class="space-y-3 bg-slate-50 p-3 rounded-xl border border-slate-200">
                        <div class="text-xs font-bold text-slate-600">Attributs</div>
                        <div id="vendeur_variant_attrs" class="space-y-2">
                            <div class="flex gap-2 items-end">
                                <div class="flex-1">
                                    <input id="var_attr_name_v0" type="text" placeholder="Nom (ex: Couleur)" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                                </div>
                                <div class="flex-1">
                                    <input id="var_attr_v0" type="text" placeholder="Valeur (ex: Rouge)" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                                </div>
                            </div>
                            <div class="flex gap-2 items-end">
                                <div class="flex-1">
                                    <input id="var_attr_name_v1" type="text" placeholder="Nom (ex: Taille)" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                                </div>
                                <div class="flex-1">
                                    <input id="var_attr_v1" type="text" placeholder="Valeur (ex: M)" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                                </div>
                            </div>
                        </div>
                        <button onclick="VendeurModule.addVariantAttrField()" class="text-sm px-3 py-2 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-200 transition w-full font-bold">+ Ajouter un attribut</button>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        ${UI.input('var_sku', 'SKU (optionnel)', 'text', '', 'Ex: PROD-001-RED-M')}
                        ${UI.input('var_price', 'Prix (vide = prix du produit)', 'number', '', (product.price || 0).toString())}
                    </div>

                    ${UI.input('var_stock', 'Stock', 'number', Math.max(0, parseInt(product.stock) || 0).toString(), '', true)}

                    <div class="text-xs text-slate-500 bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <div class="font-bold text-blue-700 mb-1">💡 Conseil</div>
                        Ajoutez au moins un attribut (ex: Couleur, Taille) pour différencier cette variante.
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Créer', onclick: `VendeurModule.saveProductVariant(${productId})`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        addVariantAttrField() {
            const idx = window._vendeurVariantAttrsCount++;
            const container = document.getElementById('vendeur_variant_attrs');
            if (!container) return;
            const div = document.createElement('div');
            div.className = 'flex gap-2 items-end';
            div.innerHTML = `
                <div class="flex-1">
                    <input id="var_attr_name_v${idx}" type="text" placeholder="Nom attribut" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                </div>
                <div class="flex-1">
                    <input id="var_attr_v${idx}" type="text" placeholder="Valeur" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                </div>
                <button onclick="this.parentElement.remove()" class="px-2 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200 text-xs font-black">✕</button>
            `;
            container.appendChild(div);
        },

        saveProductVariant(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return;

            // Collect attributes from dynamic fields in the modal
            const attributes = [];
            for (let i = 0; i < 20; i++) {
                const nameEl = document.getElementById(`var_attr_name_v${i}`);
                const valEl = document.getElementById(`var_attr_v${i}`);
                if (nameEl && valEl) {
                    const name = nameEl.value?.trim();
                    const value = valEl.value?.trim();
                    if (name && value) attributes.push({ name, value });
                }
            }

            const sku = UI.val('var_sku').trim() || null;
            const priceRaw = UI.val('var_price').trim();
            const price = priceRaw ? Number(priceRaw) : product.price;
            const stock = Number(UI.val('var_stock') || 0);

            if (stock <= 0) return UI.toast('Stock doit être > 0', 'warning');
            if (attributes.length === 0) return UI.toast('Au moins un attribut requis', 'warning');

            CORE.createProductVariant(productId, attributes, sku, price, stock);

            UI.closeModal();
            UI.toast('Variante créée', 'success');
            this.showProductVariantsModal(productId);
        },

        deleteProductVariant(productId, variantIdx) {
            const variants = CORE.getProductVariants(productId);
            if (variantIdx >= 0 && variantIdx < variants.length) {
                const v = variants[variantIdx];
                CORE.deleteProductVariant(v.id);
                UI.toast('Variante supprimée', 'success');
                this.showProductVariantsModal(productId);
            }
        },

        // Vue vendeur: afficher TOUTES les variantes d'un produit
        showVariantsList(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return;

            const variants = CORE.getProductVariants(productId);

            UI.modal(`Variantes: ${product.name}`, `
                <div class="space-y-2 max-h-[70vh] overflow-y-auto">
                    ${variants.length === 0 ? `
                        <div class="p-6 text-center text-slate-400 bg-slate-50 rounded-xl border border-slate-200">
                            <div class="text-sm font-medium">Aucune variante</div>
                            <div class="text-xs mt-1">Ajoutez une variante depuis le Stock Control Center</div>
                        </div>
                    ` : ''}

                    ${variants.map((v, idx) => `
                        <div class="p-3 border border-slate-200 rounded-xl bg-slate-50 hover:bg-slate-100 transition">
                            <div class="grid grid-cols-4 gap-2 mb-2">
                                <div>
                                    <div class="text-[9px] font-bold text-slate-500 uppercase">Prix</div>
                                    <div class="font-black text-emerald-600">${CORE.formatPrice(v.price || product.price)}</div>
                                </div>
                                <div>
                                    <div class="text-[9px] font-bold text-slate-500 uppercase">Stock</div>
                                    <div class="font-black ${v.stock > 0 ? 'text-slate-900' : 'text-red-600'}">${v.stock}</div>
                                </div>
                                <div>
                                    <div class="text-[9px] font-bold text-slate-500 uppercase">SKU</div>
                                    <div class="font-mono text-xs">${v.sku || '—'}</div>
                                </div>
                                <div class="text-right">
                                    <button onclick="VendeurModule.addToCartWithVariant(${productId}, ${idx})" class="px-2 py-1 bg-emerald-600 text-white rounded font-black text-xs hover:bg-emerald-700">Ajouter</button>
                                </div>
                            </div>
                            ${(v.attributes || []).length > 0 ? `
                                <div class="flex flex-wrap gap-1">
                                    ${(v.attributes || []).map(attr => `
                                        <span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-[10px] font-bold">${attr.name}: ${attr.value}</span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        // Afficher les variantes au moment d'ajouter au panier
        showVariantPickerModal(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return;

            const variants = CORE.getProductVariants(productId);

            if (variants.length === 0) {
                // Pas de variante: ajouter directement
                this.addToCart(productId);
                return;
            }

            UI.modal(`Sélectionner variante: ${product.name}`, `
                <div class="space-y-3 max-h-[60vh] overflow-y-auto">
                    ${variants.map((v, idx) => `
                        <button onclick="VendeurModule.addToCartWithVariant(${productId}, ${idx})" class="w-full p-3 border-2 border-slate-200 rounded-xl hover:border-emerald-500 hover:bg-emerald-50 transition text-left">
                            <div class="flex items-start justify-between mb-1">
                                <div class="flex-1">
                                    ${(v.attributes || []).map(attr => `
                                        <div class="text-xs text-slate-600 font-medium">${attr.name}: <span class="font-bold text-slate-800">${attr.value}</span></div>
                                    `).join('')}
                                </div>
                                <div class="text-right ml-2">
                                    <div class="font-black text-emerald-600">${CORE.formatPrice(v.price || product.price)}</div>
                                    <div class="text-xs text-slate-500">Stock: ${v.stock ?? product.stock}</div>
                                </div>
                            </div>
                            ${v.sku ? `<div class="text-xs font-mono text-slate-500">SKU: ${v.sku}</div>` : ''}
                        </button>
                    `).join('')}
                </div>
            `, [
                { label: 'Ajouter sans variante', onclick: `VendeurModule.addToCart(${productId}); UI.closeModal();` },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        addToCartWithVariant(productId, variantIdx) {
            const p = CORE.getProduct(productId);
            if (!p || !p.active) return UI.toast('Produit indisponible', 'error');

            const variants = CORE.getProductVariants(productId);
            if (variantIdx >= variants.length) return UI.toast('Variante invalide', 'error');

            const variant = variants[variantIdx];
            const availableStock = variant.stock ?? p.stock;

            if (availableStock <= 0) return UI.toast('Stock épuisé pour cette variante', 'warning');

            const variantKey = JSON.stringify(variant.attributes || []);
            const existingItem = this.state.cart.find(i => i.productId === productId && i.variantKey === variantKey);

            if (existingItem) {
                if (existingItem.qty < availableStock) {
                    existingItem.qty++;
                } else {
                    UI.toast('Stock maximum pour cette variante', 'warning');
                }
            } else {
                this.state.cart.push({
                    productId: p.id,
                    name: p.name,
                    price: variant.price || p.price,
                    qty: 1,
                    maxStock: availableStock,
                    discountPercent: 0,
                    variantId: variant.id,
                    variantKey,
                    sku: variant.sku,
                    attributes: variant.attributes
                });
            }

            UI.closeModal();
            App.rerender();
        },

        showOrderDetail(orderId) {
            const o = CORE.getVisibleOrders().find(x => x.id === orderId);
            if (!o) return;
            const statusColors = { pending: 'amber', delivering: 'purple', delivered: 'emerald', cancelled: 'red' };

            // Chercher la livraison associée
            const delivery = CORE.getVisibleDeliveries().find(d => d.orderId === orderId);
            const hasProof = delivery && (delivery.proofPhotos?.length > 0 || delivery.proofSignature);
            const isDelivered = delivery && delivery.status === 'livree';

            // Section livraison si applicable
            let deliverySection = '';
            if (delivery) {
                const livreur = delivery.livreurId ? CORE.getUser(delivery.livreurId) : null;
                const deliveryStatusColors = { en_attente: 'slate', en_cours: 'amber', livree: 'emerald', probleme: 'red', annulee: 'red' };
                const deliveryStatusLabels = { en_attente: 'En attente', en_cours: 'En cours', livree: 'Livrée', probleme: 'Problème', annulee: 'Annulée' };

                deliverySection = `
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-2xl p-4">
                        <div class="text-xs font-black text-blue-600 uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i data-lucide="truck" class="w-4 h-4"></i> Livraison
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-bold text-slate-700">Référence</span>
                                <span class="text-sm font-black text-slate-900">${delivery.orderRef}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-bold text-slate-700">Statut</span>
                                ${UI.badge(deliveryStatusLabels[delivery.status] || delivery.status, deliveryStatusColors[delivery.status] || 'slate')}
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-bold text-slate-700">Livreur</span>
                                <span class="text-sm font-black text-slate-900">${livreur ? livreur.name : '<span class="text-slate-400">Non assigné</span>'}</span>
                            </div>
                            ${delivery.address ? `
                                <div class="flex items-start justify-between">
                                    <span class="text-sm font-bold text-slate-700">Adresse</span>
                                    <span class="text-sm text-slate-900 text-right max-w-[60%]">${delivery.address}</span>
                                </div>
                            ` : ''}
                            ${delivery.deliveryTime ? `
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-bold text-slate-700">Heure prévue</span>
                                    <span class="text-sm font-black text-amber-700">${delivery.deliveryTime}</span>
                                </div>
                            ` : ''}
                            ${delivery.deliveredAt ? `
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-bold text-slate-700">Livrée le</span>
                                    <span class="text-sm text-emerald-700 font-bold">${new Date(delivery.deliveredAt).toLocaleString('fr-FR')}</span>
                                </div>
                            ` : ''}
                        </div>

                        ${hasProof ? `
                            <div class="mt-4 pt-3 border-t border-blue-200">
                                <button onclick="VendeurModule.showDeliveryProofModal(${delivery.id})" class="w-full py-3 px-4 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition flex items-center justify-center gap-2">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                    Voir les preuves de livraison
                                    ${delivery.proofPhotos?.length ? `<span class="px-2 py-0.5 bg-white/20 rounded-full text-xs">${delivery.proofPhotos.length} 📷</span>` : ''}
                                    ${delivery.proofSignature ? `<span class="px-2 py-0.5 bg-white/20 rounded-full text-xs">✍️</span>` : ''}
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            UI.modal(`Commande ${o.reference}`, `
                <div class="space-y-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-xs text-slate-500 font-bold uppercase">Statut</div>
                            <div class="mt-1">${UI.badge(o.status, statusColors[o.status] || 'slate')}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-500 font-bold uppercase">Total</div>
                            <div class="text-2xl font-black text-slate-900">${CORE.formatPrice(o.total)}</div>
                        </div>
                    </div>
                    <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-2">Articles</div>
                        <div class="space-y-2">
                            ${(o.items || []).map(it => `
                                <div class="flex justify-between text-sm">
                                    <div class="font-bold text-slate-800">${it.qty}× ${it.name}</div>
                                    <div class="font-black">${CORE.formatPrice(it.qty * it.price)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-2">Paiement</div>
                        <div class="flex items-center justify-between">
                            <div class="text-sm font-bold text-slate-800">Méthode</div>
                            <div class="text-sm font-black">${CORE.paymentMethodLabel(o.paymentMethod)}</div>
                        </div>
                        <div class="flex items-center justify-between mt-2">
                            <div class="text-sm font-bold text-slate-800">Statut</div>
                            <div>${UI.badge(CORE.paymentStatusLabel(o.paymentStatus), o.paymentStatus === 'paid' ? 'emerald' : 'amber')}</div>
                        </div>
                    </div>

                    ${deliverySection}

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="VendeurModule.setOrderStatus(${o.id},\'delivered\')" class="px-4 py-3 rounded-xl bg-emerald-600 text-white font-black hover:bg-emerald-700 transition">Marquer livré</button>
                        <button onclick="VendeurModule.setOrderStatus(${o.id},\'cancelled\')" class="px-4 py-3 rounded-xl bg-red-600 text-white font-black hover:bg-red-700 transition">Annuler</button>
                    </div>
                    <div class="text-xs text-slate-500">Créée: ${CORE.formatDate(o.createdAt)}</div>
                </div>
            `);
        },

        // Modal pour afficher les preuves de livraison (photos + signature)
        showDeliveryProofModal(deliveryId) {
            const d = (CORE.getVisibleDeliveries() || []).find(x => x.id === deliveryId);
            if (!d) return UI.toast('Livraison introuvable', 'error');

            const hasPhotos = d.proofPhotos && d.proofPhotos.length > 0;
            const hasSignature = !!d.proofSignature;
            const livreur = d.livreurId ? CORE.getUser(d.livreurId) : null;

            if (!hasPhotos && !hasSignature) {
                return UI.toast('Aucune preuve de livraison disponible', 'info');
            }

            UI.modal(`📷 Preuves de livraison - ${d.orderRef}`, `
                <div class="space-y-4">
                    <!-- Info livraison -->
                    <div class="p-4 bg-gradient-to-r from-emerald-50 to-teal-50 rounded-2xl border border-emerald-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-black text-emerald-900">${d.clientName || 'Client'}</div>
                                <div class="text-xs text-emerald-700">${d.address || ''}</div>
                                ${livreur ? `<div class="text-xs text-emerald-600 mt-1">Livreur: <span class="font-bold">${livreur.name}</span></div>` : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                                <div class="text-xs text-emerald-600">✓ Livrée</div>
                            </div>
                        </div>
                    </div>

                    ${hasPhotos ? `
                        <!-- Galerie photos -->
                        <div>
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                                <i data-lucide="camera" class="w-4 h-4"></i>
                                Photos de preuve (${d.proofPhotos.length})
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                ${d.proofPhotos.map((photo, idx) => `
                                    <div class="aspect-square rounded-2xl overflow-hidden border-2 border-emerald-300 cursor-pointer hover:border-emerald-500 transition shadow-lg" onclick="VendeurModule.viewProofPhoto('${photo.replace(/'/g, "\\'")}')">
                                        <img src="${photo}" class="w-full h-full object-cover hover:scale-105 transition">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${hasSignature ? `
                        <!-- Signature client -->
                        <div>
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-3 flex items-center gap-2">
                                <span class="text-lg">✍️</span>
                                Signature client
                            </div>
                            <div class="p-4 bg-white rounded-2xl border-2 border-blue-200 cursor-pointer hover:border-blue-400 transition shadow-lg" onclick="VendeurModule.viewProofSignature(${d.id})">
                                <img src="${d.proofSignature}" class="w-full max-h-40 object-contain" alt="Signature du client">
                            </div>
                        </div>
                    ` : ''}

                    <!-- Note du livreur -->
                    ${d.proofNote ? `
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-2">Note du livreur</div>
                            <div class="text-sm text-slate-700">${d.proofNote}</div>
                        </div>
                    ` : ''}

                    <!-- Horodatage -->
                    <div class="text-center text-xs text-slate-400 pt-2 border-t border-slate-100">
                        Validée le ${d.proofTimestamp ? new Date(d.proofTimestamp).toLocaleString('fr-FR') : (d.deliveredAt ? new Date(d.deliveredAt).toLocaleString('fr-FR') : '—')}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-lg' });

            setTimeout(() => lucide.createIcons(), 50);
        },

        // Voir une photo de preuve en plein écran
        viewProofPhoto(photoSrc) {
            UI.modal('📷 Photo de preuve', `
                <div class="flex flex-col items-center gap-4">
                    <div class="max-w-full max-h-[70vh] overflow-auto rounded-xl border border-slate-200 shadow-lg">
                        <img src="${photoSrc}" class="max-w-full" alt="Photo de preuve">
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-2xl' });
        },

        setOrderStatus(orderId, status) {
            const o = CORE.getVisibleOrders().find(x => x.id === orderId);
            if (!o) return;

            // Cohérence: on ne marque pas "delivered" manuellement une commande COD si la livraison n'est pas livrée
            if (status === 'delivered' && o.paymentMethod === 'cod') {
                const del = CORE.getVisibleDeliveries().find(d => d.orderId === o.id);
                if (!del || del.status !== 'livree') {
                    return UI.toast('Commande COD: livrez d’abord la course', 'warning');
                }
            }

            // Si on annule une commande non annulée => remettre stock (POS-aware)
            if (status === 'cancelled' && o.status !== 'cancelled') {
                const cancelPosId = o.posId || CORE.state.currentUser?.pos;
                for (const it of (o.items || [])) {
                    const p = CORE.getProduct(it.productId);
                    if (!p) continue;
                    const returnQty = Number(it.qty || 0);
                    const updates = { stock: Number(p.stock || 0) + returnQty };
                    // Also restore POS-specific stock
                    if (cancelPosId && p.posStocks && p.posStocks[cancelPosId]) {
                        const newPosStocks = JSON.parse(JSON.stringify(p.posStocks));
                        newPosStocks[cancelPosId].stock = (newPosStocks[cancelPosId].stock || 0) + returnQty;
                        updates.posStocks = newPosStocks;
                    }
                    CORE.update('products', p.id, updates);
                    CORE.recordStockMovement({ productId: p.id, type: 'in', qty: returnQty, ref: o.reference, note: 'Annulation commande (retour stock)' });
                }

                // Si une course existe, l’annuler aussi
                const d = CORE.getVisibleDeliveries().find(x => x.orderId === o.id && ['en_cours','en_attente','reservation'].includes(x.status));
                if (d) {
                    CORE.update('deliveries', d.id, { status: 'annulee', livreurId: null, cancelledAt: new Date().toISOString() });
                }
            }

            const updated = CORE.update('orders', orderId, { status });
            if (updated) {
                // Enregistrer l'activité
                const statusLabel = { delivered: 'Livré', cancelled: 'Annulé', paid: 'Payé', pending: 'En attente' }[status] || status;
                CORE.logActivity(status, 'order', orderId, {
                    entityName: `Commande ${o.reference}`,
                    description: `Statut changé à ${statusLabel}`,
                    amount: o.total,
                    status: 'success'
                });

                // Create notification for cancelled orders
                if (status === 'cancelled' && CORE.db.alertThresholds?.find(t => t.id === 'order_rejected')?.enabled) {
                    CORE.createNotification(
                        'order_rejected',
                        `❌ Commande Annulée: ${o.reference}`,
                        `La commande ${o.reference} a été annulée. Montant: ${o.total} XAF`,
                        'medium',
                        'order',
                        o.id
                    );
                }

                UI.toast(`Statut mis à jour: ${status}`, 'success');
                UI.closeModal();
                App.rerender();
            }
        },

        // UI chunks
        renderStatCard(label, value, icon, colorClass) {
            return `
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm card-hover group">
                    <div class="w-12 h-12 ${colorClass} rounded-2xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                        <i data-lucide="${icon}" class="w-6 h-6"></i>
                    </div>
                    <div class="text-3xl font-black text-slate-800 tracking-tight">${value}</div>
                    <div class="text-sm text-slate-400 font-bold uppercase tracking-wider mt-1">${label}</div>
                </div>`;
        },
        renderOrderRow(o) {
            const colors = { pending: 'amber', delivering: 'purple', delivered: 'emerald', cancelled: 'red' };
            const pm = o.paymentMethod ? CORE.paymentMethodLabel(o.paymentMethod) : null;

            // Vérifier si une livraison avec preuves existe
            const delivery = CORE.getVisibleDeliveries().find(d => d.orderId === o.id);
            const hasPhotos = delivery?.proofPhotos?.length > 0;
            const hasSignature = !!delivery?.proofSignature;
            const hasProof = hasPhotos || hasSignature;

            // Badge de preuve
            let proofBadge = '';
            if (hasProof) {
                if (hasPhotos && hasSignature) {
                    proofBadge = `<span class="text-[10px] font-bold text-emerald-700 bg-emerald-50 px-1.5 py-0.5 rounded-lg">📷+✍️</span>`;
                } else if (hasPhotos) {
                    proofBadge = `<span class="text-[10px] font-bold text-emerald-700 bg-emerald-50 px-1.5 py-0.5 rounded-lg">📷 ${delivery.proofPhotos.length}</span>`;
                } else if (hasSignature) {
                    proofBadge = `<span class="text-[10px] font-bold text-blue-700 bg-blue-50 px-1.5 py-0.5 rounded-lg">✍️</span>`;
                }
            }

            return `
                <button onclick="VendeurModule.showOrderDetail(${o.id})" class="w-full text-left flex items-center justify-between p-4 rounded-2xl hover:bg-slate-50 border border-transparent hover:border-slate-100 transition group">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-xs text-slate-500 group-hover:bg-white group-hover:shadow-md transition">#${o.id}</div>
                        <div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-slate-800">${o.reference}</span>
                                ${proofBadge}
                            </div>
                            <div class="text-xs text-slate-400 font-medium">${CORE.formatDate(o.createdAt)}</div>
                            ${pm ? `<div class="mt-1 text-[10px] text-slate-500 font-bold uppercase tracking-wider">${pm}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="font-bold text-slate-800">${CORE.formatPrice(o.total)}</div>
                        ${UI.badge(o.status, colors[o.status] || 'slate')}
                    </div>
                </button>`;
        },

        // ==================
        // ANALYTICS AVANCÉE
        // ==================
        getAdvancedDashboardMetrics() {
            const userId = CORE.state.currentUser?.id;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const last7Days = new Date(today);
            last7Days.setDate(last7Days.getDate() - 7);
            const last30Days = new Date(today);
            last30Days.setDate(last30Days.getDate() - 30);

            const visibleOrders = CORE.getVisibleOrders();
            const visibleClients = CORE.getVisibleClients();
            const visibleDeliveries = CORE.getVisibleDeliveries();

            // Commandes d'aujourd'hui
            const todayOrders = (visibleOrders || []).filter(o => {
                const orderDate = new Date(o.createdAt || new Date());
                return o.sellerId === userId && orderDate >= today && orderDate < new Date(today.getTime() + 86400000);
            });

            // Commandes des 7 derniers jours
            const last7DaysOrders = (visibleOrders || []).filter(o => {
                const orderDate = new Date(o.createdAt || new Date());
                return o.sellerId === userId && orderDate >= last7Days;
            });

            // Commandes des 30 derniers jours
            const last30DaysOrders = (visibleOrders || []).filter(o => {
                const orderDate = new Date(o.createdAt || new Date());
                return o.sellerId === userId && orderDate >= last30Days;
            });

            // Clients nouveaux d'aujourd'hui
            const todayNewClients = (visibleClients || []).filter(c => {
                const clientDate = new Date(c.createdAt || new Date());
                return clientDate >= today && clientDate < new Date(today.getTime() + 86400000);
            }).length;

            // Clients nouveaux 7 jours
            const last7DaysNewClients = (visibleClients || []).filter(c => {
                const clientDate = new Date(c.createdAt || new Date());
                return clientDate >= last7Days;
            }).length;

            // Top 5 produits
            const productSales = {};
            last30DaysOrders.forEach(o => {
                (o.items || []).forEach(item => {
                    if (!productSales[item.productId]) {
                        productSales[item.productId] = { qty: 0, revenue: 0, name: item.name };
                    }
                    productSales[item.productId].qty += item.qty;
                    productSales[item.productId].revenue += item.qty * item.price;
                });
            });

            const top5Products = Object.values(productSales)
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 5);

            // Top 5 clients
            const clientOrders = {};
            last30DaysOrders.forEach(o => {
                const key = `${o.clientName}-${o.clientPhone}`;
                if (!clientOrders[key]) {
                    clientOrders[key] = { name: o.clientName, phone: o.clientPhone, count: 0, total: 0 };
                }
                clientOrders[key].count += 1;
                clientOrders[key].total += o.total;
            });

            const top5Clients = Object.values(clientOrders)
                .sort((a, b) => b.total - a.total)
                .slice(0, 5);

            // Temps moyen de traitement
            const completedDeliveries = (visibleDeliveries || []).filter(d => d.status === 'livree' && d.deliveredAt);
            const avgProcessingTime = completedDeliveries.length > 0
                ? completedDeliveries.reduce((sum, d) => {
                    const created = new Date(d.createdAt || 0);
                    const delivered = new Date(d.deliveredAt || 0);
                    return sum + ((delivered - created) / 3600000); // en heures
                }, 0) / completedDeliveries.length
                : 0;

            // CA journalier 7 jours
            const sales7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const dayEnd = new Date(dayStart.getTime() + 86400000);
                const daySales = (visibleOrders || [])
                    .filter(o => {
                        const oDate = new Date(o.createdAt || new Date());
                        return o.sellerId === userId && oDate >= dayStart && oDate < dayEnd;
                    })
                    .reduce((sum, o) => sum + o.total, 0);
                sales7Days.push({
                    date: date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' }),
                    value: daySales
                });
            }

            return {
                todayRevenue: todayOrders.reduce((sum, o) => sum + o.total, 0),
                todayOrders: todayOrders.length,
                todayNewClients,
                last7DaysRevenue: last7DaysOrders.reduce((sum, o) => sum + o.total, 0),
                last7DaysOrders: last7DaysOrders.length,
                last7DaysNewClients,
                last30DaysRevenue: last30DaysOrders.reduce((sum, o) => sum + o.total, 0),
                last30DaysOrders: last30DaysOrders.length,
                avgOrderValue: last30DaysOrders.length > 0 ? Math.round(last30DaysOrders.reduce((sum, o) => sum + o.total, 0) / last30DaysOrders.length) : 0,
                top5Products,
                top5Clients,
                avgProcessingTime: Math.round(avgProcessingTime * 10) / 10,
                sales7Days,
                completedDeliveries: completedDeliveries.length
            };
        },

        renderDashboard() {
            const stats = this.getStats();
            const vendorProfile = this.getVendorProfile(CORE.state.currentUser?.id);
            const vendorStats = vendorProfile ? this.getVendorStats(CORE.state.currentUser?.id) : null;
            const badges = CORE.db.vendorBadges || [];
            const currentBadge = vendorProfile && vendorProfile.badge ? badges.find(b => b.id === vendorProfile.badge) : null;

            return `
                <div class="fade-in max-w-5xl mx-auto space-y-8">
                    <!-- Profil Vendeur Card -->
                    ${vendorProfile && vendorStats ? `
                        <div class="bg-gradient-to-r from-slate-900 to-slate-800 rounded-3xl p-6 text-white shadow-lg overflow-hidden relative">
                            <div class="absolute top-0 right-0 w-40 h-40 bg-slate-700/20 rounded-full -mr-10 -mt-10"></div>
                            <div class="relative z-10">
                                <div class="flex items-start justify-between mb-6">
                                    <div class="flex items-center gap-4">
                                        <div class="w-16 h-16 rounded-2xl bg-white/20 flex items-center justify-center text-3xl font-black">
                                            ${vendorProfile.avatar}
                                        </div>
                                        <div>
                                            <h2 class="text-2xl font-black">${CORE.state.currentUser.name}</h2>
                                            <div class="flex items-center gap-2 mt-1">
                                                ${vendorStats.rating > 0 ? `${[...Array(Math.floor(vendorStats.rating))].map(() => `<i data-lucide="star" class="w-4 h-4 text-yellow-300 fill-yellow-300"></i>`).join('')}
                                                <span class="text-sm font-bold">${vendorStats.rating.toFixed(1)}/5</span>` : `<span class="text-sm opacity-70">⭐ Pas encore noté</span>`}
                                            </div>
                                        </div>
                                    </div>
                                    <button onclick="VendeurModule.showVendorProfileModal(${CORE.state.currentUser?.id})" class="px-4 py-2 bg-white/20 text-white rounded-xl font-bold hover:bg-white/30 transition">
                                        👁️ Voir Profil
                                    </button>
                                </div>

                                <div class="grid grid-cols-4 gap-3 text-center">
                                    <div>
                                        <div class="text-2xl font-black">${vendorStats.salesCount}</div>
                                        <div class="text-xs font-bold opacity-75">Ventes</div>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-black">${CORE.formatPrice(vendorStats.totalSales).split(' ')[0]}</div>
                                        <div class="text-xs font-bold opacity-75">Total</div>
                                    </div>
                                    <div>
                                        <div class="text-2xl font-black">${CORE.formatPrice(vendorStats.avgOrder).split(' ')[0]}</div>
                                        <div class="text-xs font-bold opacity-75">Moyenne</div>
                                    </div>
                                    <div>
                                        ${currentBadge ? `
                                            <div class="text-sm font-black">${currentBadge.label}</div>
                                            <div class="text-xs font-bold opacity-75">Badge</div>
                                        ` : ''}
                                    </div>
                                </div>

                                ${vendorStats.specialties && vendorStats.specialties.length > 0 ? `
                                    <div class="mt-4 flex flex-wrap gap-2">
                                        ${vendorStats.specialties.map(s => `<span class="px-2 py-1 bg-white/15 text-white text-xs font-black rounded-full">${s}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h1 class="text-3xl font-black text-slate-800">Tableau de Bord</h1>
                            <p class="text-slate-500 font-medium">Ventes, commandes, stock — tout au même endroit.</p>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="VendeurModule.navigateTo('clients')" class="px-5 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-50 transition flex items-center gap-2">
                                <i data-lucide="users" class="w-5 h-5"></i> Clients
                            </button>
                            <button onclick="VendeurModule.showActivityHistoryModal()" class="px-5 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-50 transition flex items-center gap-2">
                                <i data-lucide="history" class="w-5 h-5"></i> Activité
                            </button>
                            <button onclick="VendeurModule.showReservationModal()" class="px-5 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-50 transition flex items-center gap-2">
                                <i data-lucide="calendar-clock" class="w-5 h-5"></i> Réservation
                            </button>
                            <button onclick="VendeurModule.navigateTo('livreurs')" class="px-5 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-50 transition flex items-center gap-2">
                                <i data-lucide="bike" class="w-5 h-5"></i> Livreurs
                            </button>
                            <button onclick="VendeurModule.state.posMode='sale';VendeurModule.navigateTo('pos')" class="px-6 py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-700 transition flex items-center gap-2">
                                <i data-lucide="plus" class="w-5 h-5"></i> Nouvelle vente
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        ${this.renderStatCard('CA (aujourd\'hui)', CORE.formatPrice(stats.todayRevenue), 'wallet', 'bg-blue-50 text-blue-600')}
                        ${this.renderStatCard('Transactions', stats.todayTransactions, 'shopping-bag', 'bg-emerald-50 text-emerald-600')}
                        ${this.renderStatCard('En attente', stats.pendingDeliveries, 'truck', 'bg-amber-50 text-amber-600')}
                        ${this.renderStatCard('Stock critique', stats.lowStockProducts, 'alert-circle', 'bg-red-50 text-red-600')}
                    </div>

                    ${(() => {
                        const metrics = this.getAdvancedDashboardMetrics();
                        return `
                            <!-- KPI Avancées -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm">
                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">CA Aujourd'hui</div>
                                    <div class="text-2xl font-black text-blue-600 mt-2">${CORE.formatPrice(metrics.todayRevenue)}</div>
                                    <div class="text-xs text-slate-400 mt-2">📊 ${metrics.todayOrders} commandes</div>
                                </div>
                                <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm">
                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">CA 7 jours</div>
                                    <div class="text-2xl font-black text-purple-600 mt-2">${CORE.formatPrice(metrics.last7DaysRevenue)}</div>
                                    <div class="text-xs text-slate-400 mt-2">📈 ${metrics.last7DaysOrders} commandes</div>
                                </div>
                                <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm">
                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">CA 30 jours</div>
                                    <div class="text-2xl font-black text-emerald-600 mt-2">${CORE.formatPrice(metrics.last30DaysRevenue)}</div>
                                    <div class="text-xs text-slate-400 mt-2">💰 Moyen: ${CORE.formatPrice(metrics.avgOrderValue)}</div>
                                </div>
                                <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm">
                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Clients Nouveaux</div>
                                    <div class="text-2xl font-black text-cyan-600 mt-2">${metrics.todayNewClients}/${metrics.last7DaysNewClients}</div>
                                    <div class="text-xs text-slate-400 mt-2">👥 Aujourd'hui/7j</div>
                                </div>
                            </div>

                            <!-- Graphique Ventes 7 jours -->
                            <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
                                <div class="mb-4">
                                    <h3 class="font-black text-slate-900">📈 Ventes - 7 derniers jours</h3>
                                    <p class="text-xs text-slate-500">Chiffre d'affaires quotidien</p>
                                </div>
                                <div class="flex items-end gap-2 h-32">
                                    ${metrics.sales7Days.map((day, idx) => {
                                        const maxVal = Math.max(...metrics.sales7Days.map(d => d.value)) || 1;
                                        const height = (day.value / maxVal) * 100;
                                        return `
                                            <div class="flex-1 flex flex-col items-center gap-2">
                                                <div class="w-full bg-gradient-to-t from-emerald-500 to-emerald-400 rounded-t-xl transition hover:from-emerald-600 hover:to-emerald-500" style="height: ${Math.max(height, 10)}%" title="${CORE.formatPrice(day.value)}"></div>
                                                <span class="text-xs font-bold text-slate-600">${day.date}</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>

                            <!-- Top Produits et Clients -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Top 5 Produits -->
                                <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
                                    <h3 class="font-black text-slate-900 mb-4">🏆 Top 5 Produits</h3>
                                    <div class="space-y-3">
                                        ${metrics.top5Products.length === 0 ? `
                                            <div class="p-4 text-center text-slate-400 text-sm">Aucune vente sur 30 jours</div>
                                        ` : metrics.top5Products.map((p, idx) => `
                                            <div class="flex items-center gap-3">
                                                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-emerald-100 text-emerald-600 font-black text-xs flex items-center justify-center">${idx + 1}</div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="font-bold text-slate-900 truncate">${p.name}</div>
                                                    <div class="text-xs text-slate-500">${p.qty} ventes • ${CORE.formatPrice(p.revenue)}</div>
                                                </div>
                                                <div class="text-sm font-black text-emerald-600">${Math.round((p.revenue / metrics.last30DaysRevenue) * 100)}%</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <!-- Top 5 Clients -->
                                <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm">
                                    <h3 class="font-black text-slate-900 mb-4">👑 Top 5 Clients</h3>
                                    <div class="space-y-3">
                                        ${metrics.top5Clients.length === 0 ? `
                                            <div class="p-4 text-center text-slate-400 text-sm">Aucune vente sur 30 jours</div>
                                        ` : metrics.top5Clients.map((c, idx) => `
                                            <div class="flex items-center gap-3">
                                                <div class="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 font-black text-xs flex items-center justify-center">${idx + 1}</div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="font-bold text-slate-900 truncate">${c.name}</div>
                                                    <div class="text-xs text-slate-500">${c.count} commandes • ${CORE.formatPrice(c.total)}</div>
                                                </div>
                                                <div class="text-sm font-black text-blue-600">${Math.round((c.total / metrics.last30DaysRevenue) * 100)}%</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>

                            <!-- Temps de traitement -->
                            <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl p-6 border border-amber-200">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <div class="text-xs font-black text-amber-600 uppercase tracking-wider">⏱️ Temps moyen</div>
                                        <div class="text-3xl font-black text-amber-700 mt-2">${metrics.avgProcessingTime}h</div>
                                        <div class="text-xs text-amber-600 mt-2">Traitement commande</div>
                                    </div>
                                    <div>
                                        <div class="text-xs font-black text-orange-600 uppercase tracking-wider">✅ Livrés</div>
                                        <div class="text-3xl font-black text-orange-700 mt-2">${metrics.completedDeliveries}</div>
                                        <div class="text-xs text-orange-600 mt-2">Commandes complétées</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    })()}

                    ${this.renderReservationsWidget()}

                    <!-- Widget Dépôts Livreurs -->
                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                        <div class="flex items-center justify-between mb-5">
                            <div>
                                <h3 class="font-black text-lg text-slate-800">📥 Dépôts Livreurs</h3>
                                <p class="text-xs text-slate-500 font-bold">Montants reçus en caisse</p>
                            </div>
                            <button onclick="VendeurModule.recordDeposit()" class="px-3 py-2 rounded-xl bg-indigo-600 text-white text-xs font-black hover:bg-indigo-700 transition flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Nouveau
                            </button>
                        </div>

                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div class="p-4 rounded-2xl bg-indigo-50 border border-indigo-200">
                                <div class="text-xs text-indigo-600 font-black uppercase tracking-wider mb-1">Total</div>
                                <div class="text-2xl font-black text-indigo-700">${(() => {
                                    const deposits = (CORE.db.deposits || []).filter(d => d.vendeurId === CORE.state.currentUser?.id);
                                    return deposits.reduce((sum, d) => sum + d.amount, 0).toLocaleString();
                                })()} F</div>
                            </div>
                            <div class="p-4 rounded-2xl bg-purple-50 border border-purple-200">
                                <div class="text-xs text-purple-600 font-black uppercase tracking-wider mb-1">Mois</div>
                                <div class="text-2xl font-black text-purple-700">${(() => {
                                    const deposits = (CORE.db.deposits || []).filter(d => {
                                        const date = new Date(d.timestamp);
                                        const now = new Date();
                                        return d.vendeurId === CORE.state.currentUser?.id && date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
                                    });
                                    return deposits.length;
                                })()}</div>
                            </div>
                            <div class="p-4 rounded-2xl bg-pink-50 border border-pink-200">
                                <div class="text-xs text-pink-600 font-black uppercase tracking-wider mb-1">Moyenne</div>
                                <div class="text-2xl font-black text-pink-700">${(() => {
                                    const deposits = (CORE.db.deposits || []).filter(d => d.vendeurId === CORE.state.currentUser?.id);
                                    const avg = deposits.length > 0 ? Math.round(deposits.reduce((sum, d) => sum + d.amount, 0) / deposits.length) : 0;
                                    return avg.toLocaleString();
                                })()} F</div>
                            </div>
                        </div>

                        ${(() => {
                            const deposits = (CORE.db.deposits || []).filter(d => d.vendeurId === CORE.state.currentUser?.id);
                            return deposits.length > 0 ? `
                                <div class="space-y-2">
                                    ${deposits.slice(-5).reverse().map(d => `
                                        <div class="p-3 bg-slate-50 rounded-xl border border-slate-200 flex items-center justify-between">
                                            <div class="flex items-center gap-3">
                                                <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center">
                                                    <i data-lucide="user" class="w-4 h-4 text-indigo-600"></i>
                                                </div>
                                                <div>
                                                    <div class="font-black text-slate-900 text-sm">${d.livreurName}</div>
                                                    <div class="text-xs text-slate-500">${new Date(d.timestamp).toLocaleDateString('fr-FR')}</div>
                                                </div>
                                            </div>
                                            <div class="font-black text-indigo-600">${d.amount.toLocaleString()} F</div>
                                        </div>
                                    `).join('')}
                                </div>
                                <button onclick="VendeurModule.showDepositsModal()" class="mt-4 w-full py-2 text-xs font-black text-indigo-600 hover:text-indigo-700">Voir tout →</button>
                            ` : `
                                <div class="text-center py-8 text-slate-500">
                                    <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                    <p class="text-sm font-bold">Aucun dépôt enregistré</p>
                                    <p class="text-xs opacity-75">Enregistrez le premier dépôt</p>
                                </div>
                            `;
                        })()}
                    </div>

                    <!-- Clients Favoris & Historique -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Clients Favoris -->
                        <div class="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-3xl p-6 shadow-sm border border-amber-200">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="font-black text-lg text-slate-800 flex items-center gap-2">
                                    <i data-lucide="star" class="w-5 h-5 text-yellow-500 fill-yellow-500"></i>
                                    Clients Favoris
                                </h3>
                                ${this.state.favoriteClients.length > 0 ? `
                                    <button onclick="VendeurModule.showFavoritesModal()" class="text-xs font-black text-amber-700 hover:text-amber-800 bg-white px-3 py-1 rounded-lg hover:bg-amber-50 transition">
                                        Voir tous (${this.state.favoriteClients.length})
                                    </button>
                                ` : ''}
                            </div>
                            ${(() => {
                                const favorites = this.getFavoriteClients().slice(0, 3);
                                return favorites.length > 0 ? `
                                    <div class="space-y-2">
                                        ${favorites.map(c => `
                                            <div class="p-3 bg-white rounded-xl border border-amber-100 hover:border-amber-300 transition cursor-pointer hover:bg-amber-50" onclick="VendeurModule.recordClientAccess(${c.id}); VendeurModule.selectClient(${c.id})">
                                                <div class="flex items-center justify-between mb-1">
                                                    <div class="font-bold text-slate-800 text-sm">${c.name}</div>
                                                    <button onclick="event.stopPropagation(); VendeurModule.toggleFavoriteClient(${c.id})" class="text-yellow-500 hover:text-yellow-600" title="Retirer des favoris">⭐</button>
                                                </div>
                                                <div class="flex items-center justify-between text-xs text-slate-600">
                                                    <span>${c.orderCount} commandes</span>
                                                    <span>${CORE.formatPrice(c.totalSpent).split(' ')[0]}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="text-center py-8 text-slate-500">
                                        <i data-lucide="heart" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                        <p class="text-sm font-bold">Aucun client favori</p>
                                        <p class="text-xs opacity-75">Épinglez vos meilleurs clients</p>
                                    </div>
                                `;
                            })()}
                        </div>

                        <!-- Historique d'Accès Rapide -->
                        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-3xl p-6 shadow-sm border border-blue-200">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="font-black text-lg text-slate-800 flex items-center gap-2">
                                    <i data-lucide="history" class="w-5 h-5 text-blue-600"></i>
                                    Accès Rapide
                                </h3>
                            </div>
                            ${(() => {
                                const recent = this.getRecentClients();
                                return recent.length > 0 ? `
                                    <div class="space-y-2">
                                        ${recent.map((c, idx) => `
                                            <div class="p-3 bg-white rounded-xl border border-blue-100 hover:border-blue-300 transition cursor-pointer hover:bg-blue-50" onclick="VendeurModule.recordClientAccess(${c.id}); VendeurModule.selectClient(${c.id})">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <div class="font-bold text-slate-800 text-sm">${c.name}</div>
                                                        <div class="text-xs text-slate-600">${c.phone || '—'}</div>
                                                    </div>
                                                    <button onclick="event.stopPropagation(); VendeurModule.toggleFavoriteClient(${c.id}); event.stopPropagation();" class="text-slate-400 hover:text-yellow-500 transition" title="Ajouter aux favoris">
                                                        ${this.isFavoriteClient(c.id) ? '⭐' : '☆'}
                                                    </button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="text-center py-8 text-slate-500">
                                        <i data-lucide="clock" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                        <p class="text-sm font-bold">Aucun historique</p>
                                        <p class="text-xs opacity-75">Sélectionnez un client</p>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>

                    <!-- Historique d'Activité Rapide -->
                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-black text-lg text-slate-800 flex items-center gap-2">
                                <i data-lucide="activity" class="w-5 h-5"></i>
                                Activité Récente
                            </h3>
                            <button onclick="VendeurModule.showActivityHistoryModal()" class="px-4 py-2 bg-emerald-100 text-emerald-700 rounded-lg font-black text-sm hover:bg-emerald-200 transition flex items-center gap-2">
                                <i data-lucide="history" class="w-4 h-4"></i>
                                Voir tout
                            </button>
                        </div>
                        <div class="space-y-2">
                            ${(() => {
                                const recentLogs = CORE.getActivityLogs({}).slice(0, 5);
                                return recentLogs.length > 0 ? recentLogs.map(log => {
                                    const date = new Date(log.timestamp);
                                    const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                                    return `
                                        <div class="flex items-center gap-3 p-3 rounded-lg bg-slate-50 hover:bg-slate-100 transition">
                                            <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                                            <div class="flex-1 min-w-0">
                                                <div class="text-xs font-black text-slate-900">${log.action} ${log.entity}</div>
                                                <div class="text-[10px] text-slate-600">${log.userName} • ${timeStr}</div>
                                            </div>
                                            ${log.amount > 0 ? `<div class="text-xs font-bold text-slate-800">${CORE.formatPrice(log.amount)}</div>` : ''}
                                        </div>
                                    `;
                                }).join('') : `
                                    <div class="text-center py-4 text-slate-500">
                                        <p class="text-xs font-bold">Aucune activité</p>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-black text-lg text-slate-800">Dernières commandes</h3>
                            <button onclick="VendeurModule.navigateTo('orders')" class="text-sm font-black text-emerald-700 hover:text-emerald-800">Voir tout</button>
                        </div>
                        <div class="space-y-3">
                            ${(CORE.getVisibleOrders() || []).slice(-6).reverse().map(o => this.renderOrderRow(o)).join('')}
                        </div>
                    </div>
                </div>`;
        },

        renderPOS() {
            const userPos = CORE.user?.pos || CORE.user?.storeId;
            if (!userPos) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assigné</div></div>`;
            }

            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'POS ' + userPos;
            const categories = CORE.db.categories;
            const productsBase = CORE.getVisibleProducts();
            const q = (this.state.searchQuery || '').toLowerCase().trim();
            const products = (productsBase || []).filter(p => {
                // Product must either:
                // 1. Have posId matching the seller's POS, OR
                // 2. Have stock in posStocks for the seller's POS
                const belongsToPos = p.posId == userPos ||
                                     (p.posStocks && p.posStocks[userPos] && p.posStocks[userPos].stock > 0);

                return belongsToPos &&
                       (!this.state.categoryFilter || p.categoryId === this.state.categoryFilter) &&
                       (!q || (p.name || '').toLowerCase().includes(q));
            });
            const getCatColor = (id) => ['bg-orange-100 text-orange-600', 'bg-blue-100 text-blue-600', 'bg-indigo-100 text-indigo-600', 'bg-emerald-100 text-emerald-600'][id%4];

            const selectedClient = this.state.selectedClientId ? CORE.getClient(this.state.selectedClientId) : null;
            const isReservationMode = (this.state.posMode === 'reservation');

            return `
                <div class="flex flex-col gap-4 h-full fade-in pb-24 lg:pb-0">
                    <!-- POS Header -->
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-black text-slate-900">Point de Vente</h2>
                            <p class="text-sm text-slate-500 font-medium">${posName} - ${products.length} produit(s)</p>
                        </div>
                    </div>

                    ${!CORE.state.isOnline ? `
                        <button onclick="OfflineManager.showQueueModal()" class="w-full p-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-2xl border border-orange-600 shadow-lg flex items-start gap-3 hover:shadow-xl transition cursor-pointer text-left">
                            <i data-lucide="wifi-off" class="w-5 h-5 mt-0.5 flex-shrink-0"></i>
                            <div class="flex-1">
                                <div class="font-black text-sm">⏸️ Mode Hors Ligne Activé</div>
                                <div class="text-xs opacity-90 mt-0.5">Toutes vos actions seront sauvegardées et synchronisées au retour de la connexion. Cliquez pour voir la file d'attente.</div>
                            </div>
                            <div class="px-3 py-1 bg-white/20 rounded-full text-xs font-bold">
                                ${(CORE.db.pendingSyncs || []).filter(s => s.status !== 'success').length} en attente
                            </div>
                        </button>
                    ` : ''}

                    <div class="flex flex-col lg:flex-row lg:items-center gap-3">
                        <div class="flex-1">
                            <div class="relative">
                                <i data-lucide="search" class="w-5 h-5 text-slate-400 absolute left-4 top-1/2 -translate-y-1/2"></i>
                                <input id="pos-search-input" type="text" value="${this.state.searchQuery}" onkeyup="VendeurModule.updatePOSSearch(this.value)" placeholder="Rechercher un produit..." class="w-full pl-12 pr-4 py-3 rounded-2xl border border-slate-200 bg-white focus:ring-2 focus:ring-emerald-500 outline-none font-medium" style="direction: ltr; text-align: left;" autocomplete="off">
                            </div>
                        </div>

                        <!-- Sync Indicator / Offline Manager -->
                        <div id="sync-indicator">
                            ${(() => {
                                const pendingCount = (CORE.db.pendingSyncs || []).filter(s => s.status !== 'success').length;
                                const failedCount = (CORE.db.pendingSyncs || []).filter(s => s.status === 'failed').length;
                                const lastSync = CORE.state.lastSync ? new Date(CORE.state.lastSync).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'}) : '—';

                                if (!CORE.state.isOnline) {
                                    return `
                                        <button onclick="OfflineManager.showQueueModal()" class="flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-amber-100 to-orange-100 text-amber-800 rounded-2xl border-2 border-amber-300 shadow-sm hover:shadow-md transition cursor-pointer" title="Voir la file d'attente">
                                            <i data-lucide="wifi-off" class="w-5 h-5"></i>
                                            <div>
                                                <div class="text-xs font-black uppercase tracking-wider">⏸️ Hors Ligne</div>
                                                <div class="text-[10px] opacity-75">${pendingCount} action(s) en attente</div>
                                            </div>
                                        </button>
                                    `;
                                } else if (failedCount > 0) {
                                    return `
                                        <button onclick="OfflineManager.showQueueModal()" class="flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-red-100 to-red-200 text-red-800 rounded-2xl border-2 border-red-300 shadow-sm hover:shadow-md transition cursor-pointer">
                                            <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                                            <div>
                                                <div class="text-xs font-black uppercase tracking-wider">⚠️ Échecs de sync</div>
                                                <div class="text-[10px] opacity-75">${failedCount} action(s) échouée(s)</div>
                                            </div>
                                        </button>
                                    `;
                                } else if (pendingCount > 0) {
                                    return `
                                        <button onclick="OfflineManager.syncAll()" class="flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl border border-blue-600 shadow-lg hover:shadow-xl transition animate-pulse">
                                            <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                                            <div>
                                                <div class="text-xs font-black uppercase tracking-wider">🔄 Synchroniser</div>
                                                <div class="text-[10px] opacity-90">${pendingCount} action(s) en attente</div>
                                            </div>
                                        </button>
                                    `;
                                } else {
                                    return `
                                        <div class="flex items-center gap-3 px-4 py-3 bg-emerald-50 text-emerald-700 rounded-2xl border border-emerald-200" title="Synchronisé">
                                            <i data-lucide="cloud-check" class="w-5 h-5"></i>
                                            <div>
                                                <div class="text-xs font-black uppercase tracking-wider">✓ En Ligne</div>
                                                <div class="text-[10px] opacity-75">Sync: ${lastSync}</div>
                                            </div>
                                        </div>
                                    `;
                                }
                            })()}
                        </div>

                        <!-- Offline Indicator pour les mises à jour dynamiques -->
                        <div id="offline-indicator"></div>

                        <div class="flex gap-2 flex-wrap">
                            <button onclick="VendeurModule.showDeliveryDetailsModal()" class="px-4 py-3 rounded-2xl bg-white border border-slate-200 font-bold hover:bg-slate-50 transition flex items-center gap-2">
                                <i data-lucide="map-pin" class="w-5 h-5"></i>
                                ${(() => {
                                    const dd = VendeurModule.state.deliveryDetails || { name:'', phone:'', address:'', date:'', time:'' };
                                    const ok = (dd.name || '').trim() && (dd.phone || '').trim() && (dd.address || '').trim();
                                    const when = (dd.date ? dd.date : '') + (dd.time ? (dd.date ? ' ' : '') + dd.time : '');
                                    return ok ? (when ? `${dd.name} • ${when}` : dd.name) : 'Livraison';
                                })()}
                            </button>

                            ${isReservationMode ? `
                                <button onclick="VendeurModule.openReservationCart()" class="px-4 py-3 rounded-2xl bg-emerald-600 text-white font-black hover:bg-emerald-700 transition flex items-center gap-2">
                                    <i data-lucide="calendar-clock" class="w-5 h-5"></i>
                                    Panier réservation
                                </button>
                            ` : `
                                <button onclick="VendeurModule.state.posMode='reservation';VendeurModule.openReservationCart()" class="px-4 py-3 rounded-2xl bg-white border border-slate-200 font-black hover:bg-slate-50 transition flex items-center gap-2">
                                    <i data-lucide="calendar-clock" class="w-5 h-5"></i>
                                    Réservation
                                </button>
                            `}

                            <button onclick="${isReservationMode ? 'VendeurModule.clearReservationCart()' : 'VendeurModule.clearCart()'}" class="px-4 py-3 rounded-2xl bg-red-50 text-red-600 font-black hover:bg-red-100 transition">Vider</button>

                            ${!isReservationMode && this.state.parkedCarts && this.state.parkedCarts.length > 0 ? `
                                <button onclick="VendeurModule.showParkedCartsModal()" class="px-4 py-3 rounded-2xl bg-amber-100 text-amber-800 font-black hover:bg-amber-200 transition flex items-center gap-2 relative">
                                    <i data-lucide="layers" class="w-5 h-5"></i>
                                    <span class="hidden xl:inline">En attente</span>
                                    <span class="w-6 h-6 rounded-full bg-white text-amber-700 flex items-center justify-center text-xs font-black">${this.state.parkedCarts.length}</span>
                                </button>
                            ` : ''}
                        </div>
                    </div>

                    <div class="flex gap-6 flex-1 min-h-0">
                        <div class="flex-1 flex flex-col min-w-0">
                            <div class="overflow-x-auto pb-3 hide-scrollbar flex gap-3">
                                <button onclick="VendeurModule.state.categoryFilter=null;App.rerender()" class="px-5 py-2.5 rounded-2xl font-black transition-all ${!this.state.categoryFilter ? 'bg-slate-900 text-white shadow-lg' : 'bg-white text-slate-700 border border-slate-200 hover:bg-slate-50'}">Tout</button>
                                ${categories.map(c => `
                                    <button onclick="VendeurModule.state.categoryFilter=${c.id};App.rerender()" class="px-5 py-2.5 rounded-2xl font-black transition-all whitespace-nowrap flex items-center gap-2 ${this.state.categoryFilter === c.id ? 'bg-slate-900 text-white shadow-lg' : 'bg-white text-slate-700 border border-slate-200 hover:bg-slate-50'}">
                                        <i data-lucide="${c.icon}" class="w-4 h-4"></i> ${c.name}
                                    </button>
                                `).join('')}
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 overflow-y-auto pr-2 pb-4">
                                ${products.map(p => {
                                    const variants = CORE.getProductVariants(p.id);
                                    // Get stock for this POS (supports posStocks)
                                    const posStock = CORE.getProductStock(p.id, userPos);
                                    return `
                                    <div onclick="${isReservationMode ? `VendeurModule.addToReservationCart(${p.id})` : `VendeurModule.addToCart(${p.id})`}" class="bg-white p-4 rounded-3xl border border-slate-100 cursor-pointer card-hover group relative overflow-hidden">
                                        <div class="absolute top-4 right-4 z-10 flex flex-col gap-1">
                                            <span class="bg-white text-slate-800 text-[10px] font-black px-2 py-1 rounded-full shadow-sm border border-slate-200">${posStock} stock</span>
                                            ${variants.length > 0 ? `<span class="bg-purple-600 text-white text-[10px] font-black px-2 py-1 rounded-full shadow-sm">${variants.length} var.</span>` : ''}
                                        </div>
                                        ${p.image ? `
                                        <div class="w-full aspect-[4/3] rounded-2xl mb-3 overflow-hidden group-hover:scale-105 transition-transform">
                                            <img src="${p.image}" alt="${(p.name || '').replace(/"/g, '&quot;')}" class="w-full h-full object-cover" onerror="this.parentElement.innerHTML='<div class=\\'w-full h-full ${getCatColor(p.categoryId)} flex items-center justify-center\\'><i data-lucide=\\'package\\' class=\\'w-10 h-10 opacity-50\\'></i></div>';lucide?.createIcons()">
                                        </div>
                                        ` : `
                                        <div class="w-full aspect-[4/3] ${getCatColor(p.categoryId)} rounded-2xl mb-3 flex items-center justify-center group-hover:scale-105 transition-transform">
                                            <i data-lucide="package" class="w-10 h-10 opacity-50"></i>
                                        </div>
                                        `}
                                        <div class="font-black text-slate-800 truncate">${p.name}</div>

                                        <div class="flex justify-between items-center mt-1">
                                            <div class="text-emerald-600 font-black">${CORE.formatPrice(CORE.getProductPrice(p.id, userPos))}</div>
                                            <div class="flex items-center gap-2">
                                                <button onclick="event.stopPropagation(); ManagerModule.showProductInfoModal('${p.id}')" class="px-3 py-1 rounded-xl bg-blue-600 text-white text-xs font-black hover:bg-blue-700">Info</button>
                                                ${variants.length > 0 ? `<button onclick="event.stopPropagation(); VendeurModule.showVariantsList('${p.id}')" class="px-3 py-1 rounded-xl bg-purple-600 text-white text-xs font-black hover:bg-purple-700">Var.</button>` : ''}
                                                <button onclick="event.stopPropagation(); (${isReservationMode} ? VendeurModule.addToReservationCart('${p.id}') : VendeurModule.addToCart('${p.id}'))" class="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 group-hover:bg-emerald-500 group-hover:text-white transition">
                                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                        </div>
                                        ${posStock <= p.minStock ? `<div class="mt-2 text-xs font-black text-red-600">Stock bas (min ${p.minStock})</div>` : ''}
                                    </div>
                                `;
                                }).join('')}
                            </div>
                        </div>

                        ${(() => {
                            // =====================================================
                            // Panier NORMAL vs Panier RÉSERVATION
                            // =====================================================
                            if (isReservationMode) {
                                const cartCount = this.state.reservationCart.reduce((a,b)=>a+b.qty,0);
                                const subtotal = this.getReservationCartTotal();
                                const deliveryFee = this.getReservationDeliveryFee();
                                const total = this.getReservationGrandTotal();

                                const itemsHtml = this.state.reservationCart.length === 0
                                    ? `
                                        <div class="h-40 flex flex-col items-center justify-center text-slate-300">
                                            <i data-lucide="calendar-clock" class="w-8 h-8 mb-2"></i>
                                            <p class="text-xs font-bold uppercase tracking-wider">Panier réservation vide</p>
                                        </div>
                                    `
                                    : this.state.reservationCart.map((item, index) => `
                                        <div class="p-3 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 transition">
                                            <div class="flex items-start gap-3">
                                                <div class="flex-1 min-w-0">
                                                    <div class="text-sm font-black text-slate-900 truncate">${item.name}</div>
                                                    <div class="mt-0.5 text-xs text-slate-500">
                                                        PU <span class="font-bold text-slate-700">${CORE.formatPrice(item.price)}</span>
                                                        <span class="mx-1">•</span>
                                                        Ligne <span class="font-black text-slate-900">${CORE.formatPrice(item.price * item.qty)}</span>
                                                    </div>
                                                </div>
                                                <button onclick="VendeurModule.removeReservationCartItem(${index})" class="no-select w-8 h-8 rounded-xl bg-white border border-slate-200 text-slate-500 hover:text-red-600 hover:border-red-200 hover:bg-red-50 flex items-center justify-center transition" title="Supprimer">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </div>

                                            <div class="mt-2 flex items-center justify-between">
                                                <div class="inline-flex items-center gap-1 bg-slate-100 rounded-xl p-1">
                                                    <button aria-label="Diminuer" onclick="VendeurModule.updateReservationCartQty(${index}, -1)" class="no-select w-7 h-7 rounded-lg bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 flex items-center justify-center transition"><i data-lucide="minus" class="w-4 h-4"></i></button>
                                                    <span class="no-select w-8 text-center font-black text-slate-900">${item.qty}</span>
                                                    <button aria-label="Augmenter" onclick="VendeurModule.updateReservationCartQty(${index}, 1)" class="no-select w-7 h-7 rounded-lg bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 flex items-center justify-center transition"><i data-lucide="plus" class="w-4 h-4"></i></button>
                                                </div>
                                                <div class="text-[11px] font-black text-slate-500">Stock: ${item.maxStock}</div>
                                            </div>
                                        </div>
                                    `).join('');

                                const footerHtml = `
                                    <div class="space-y-3">
                                        <div class="space-y-1">
                                            <div class="flex justify-between text-xs font-bold text-slate-600">
                                                <span>Sous-total</span>
                                                <span class="font-black text-slate-900">${CORE.formatPrice(subtotal)}</span>
                                            </div>
                                            <div class="flex justify-between items-center text-xs font-bold text-slate-600">
                                                <span>Livraison</span>
                                                <input type="number" value="${Math.max(0, parseInt(this.state.reservationManualDeliveryFee) || 0)}" oninput="VendeurModule.setReservationManualDeliveryFee(this.value)" class="w-20 text-right bg-slate-100 border border-slate-300 rounded px-1 py-0.5 text-xs font-black focus:ring-1 focus:ring-emerald-500 outline-none" placeholder="0">
                                            </div>
                                        </div>

                                        <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200 flex items-end justify-between">
                                            <div>
                                                <div class="text-[10px] font-black text-slate-500 uppercase tracking-wider">Total réservation</div>
                                                <div class="text-xs text-slate-500">(incl. livraison)</div>
                                            </div>
                                            <div id="res-cart-total-display" class="text-2xl font-black text-emerald-600 tracking-tight">${CORE.formatPrice(total)}</div>
                                        </div>

                                        <button onclick="VendeurModule.showReservationModal()" class="w-full py-3 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700 transition flex items-center justify-center gap-2">
                                            <i data-lucide="calendar-check" class="w-4 h-4"></i>
                                            Créer une réservation
                                        </button>

                                        <div class="grid grid-cols-2 gap-2">
                                            <button onclick="VendeurModule.clearReservationCart()" class="py-3 rounded-xl bg-red-50 text-red-700 text-xs font-black hover:bg-red-100 transition">Vider</button>
                                            <button onclick="VendeurModule.state.posMode='sale';VendeurModule.closeReservationCart();App.rerender()" class="py-3 rounded-xl bg-slate-100 text-slate-700 text-xs font-black hover:bg-slate-200 transition">Retour vente</button>
                                        </div>
                                    </div>
                                `;

                                const floatingCart = `
                                    <div class="fixed right-4 bottom-6 z-30 pb-safe">
                                        <button onclick="VendeurModule.openReservationCart()" class="no-select group relative">
                                            ${cartCount > 0 ? `
                                                <span class="absolute -top-2 -right-2 z-10 min-w-[24px] h-6 px-1.5 bg-purple-500 text-white text-xs font-black rounded-full flex items-center justify-center shadow-lg shadow-purple-500/40 animate-bounce">${cartCount > 99 ? '99+' : cartCount}</span>
                                            ` : ''}
                                            <div class="relative w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-500 via-purple-600 to-purple-700 text-white shadow-2xl shadow-purple-500/50 flex items-center justify-center transition-all duration-300 group-hover:scale-110 group-hover:shadow-purple-500/70 group-active:scale-95 group-hover:rotate-[-5deg]">
                                                <i data-lucide="calendar-clock" class="w-7 h-7"></i>
                                                <div class="absolute inset-0 rounded-2xl bg-gradient-to-tr from-white/20 to-transparent pointer-events-none"></div>
                                            </div>
                                            ${cartCount > 0 ? `
                                                <div class="absolute right-full mr-3 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-x-2 group-hover:translate-x-0 pointer-events-none">
                                                    <div class="bg-slate-900 text-white px-4 py-2 rounded-xl shadow-xl whitespace-nowrap">
                                                        <div class="text-[10px] font-bold text-purple-300 uppercase">Réservation</div>
                                                        <div class="text-lg font-black">${CORE.formatPrice(total)}</div>
                                                    </div>
                                                    <div class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-1 w-2 h-2 bg-slate-900 rotate-45"></div>
                                                </div>
                                            ` : ''}
                                        </button>
                                    </div>
                                `;

                                const drawer = this.state.reservationCartDrawerOpen ? `
                                    <div class="fixed inset-0 z-40">
                                        <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm" onclick="VendeurModule.closeReservationCart()"></div>
                                        <div class="absolute inset-y-0 right-0 w-full max-w-md bg-white shadow-2xl overflow-hidden flex flex-col slide-in-right">
                                            <div class="p-5 bg-gradient-to-r from-purple-700 to-purple-600 text-white">
                                                <div class="flex items-start justify-between gap-3">
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center">
                                                            <i data-lucide="calendar-clock" class="w-5 h-5"></i>
                                                        </div>
                                                        <div>
                                                            <div class="font-black text-xl tracking-tight">Panier Réservation</div>
                                                            <div class="text-[11px] text-purple-200 font-bold uppercase tracking-wider">${CORE.getPOS(CORE.user?.pos)?.name || 'POS'} • ${cartCount} article(s)</div>
                                                        </div>
                                                    </div>
                                                    <button onclick="VendeurModule.closeReservationCart()" class="w-10 h-10 rounded-xl bg-white/10 hover:bg-white/20 flex items-center justify-center transition">
                                                        <i data-lucide="x" class="w-5 h-5"></i>
                                                    </button>
                                                </div>

                                                <div class="mt-4 grid grid-cols-2 gap-2">
                                                    <button onclick="VendeurModule.showDeliveryDetailsModal()" class="w-full py-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-white font-black text-xs transition flex items-center justify-center gap-2">
                                                        <i data-lucide="map-pin" class="w-4 h-4"></i>
                                                        Livraison
                                                    </button>
                                                    <button onclick="VendeurModule.state.posMode='sale';VendeurModule.closeReservationCart();App.rerender()" class="w-full py-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-white font-black text-xs transition flex items-center justify-center gap-2">
                                                        <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                                                        Vente
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="flex-1 overflow-auto p-4 space-y-3 bg-slate-50">
                                                ${itemsHtml}
                                            </div>

                                            <div class="sticky bottom-0 p-4 border-t border-slate-200 bg-white">
                                                ${footerHtml}
                                            </div>
                                        </div>
                                    </div>
                                ` : '';

                                return `${floatingCart}${drawer}`;
                            }

                            // ====== Panier NORMAL (vente)
                            const cartCount = this.state.cart.reduce((a,b)=>a+b.qty,0);
                            const subtotal = this.getCartTotal();
                            const total = this.getGrandTotal();

                            const itemsHtml = this.state.cart.length === 0
                                ? `
                                    <div class="h-48 flex flex-col items-center justify-center text-slate-400">
                                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center mb-4">
                                            <i data-lucide="shopping-bag" class="w-8 h-8 text-slate-400"></i>
                                        </div>
                                        <p class="text-sm font-black text-slate-500">Panier vide</p>
                                        <p class="text-xs text-slate-400 mt-1">Ajoutez des produits pour commencer</p>
                                    </div>
                                `
                                : this.state.cart.map((item, index) => `
                                    <div class="p-4 rounded-2xl border border-slate-200 bg-gradient-to-br from-white to-slate-50 hover:shadow-md hover:border-slate-300 transition-all duration-200">
                                        <div class="flex items-start gap-3">
                                            <div class="flex-1 min-w-0">
                                                <div class="text-sm font-black text-slate-900 truncate">${item.name}</div>
                                                ${item.attributes && item.attributes.length > 0 ? `
                                                    <div class="mt-1.5 flex flex-wrap gap-1">
                                                        ${item.attributes.map(attr => `
                                                            <span class="text-[10px] px-2 py-1 bg-gradient-to-r from-purple-100 to-indigo-100 text-purple-700 rounded-lg font-bold">${attr.name}: ${attr.value}</span>
                                                        `).join('')}
                                                    </div>
                                                ` : ''}
                                                ${item.sku ? `<div class="text-[10px] text-slate-400 font-mono mt-1">SKU: ${item.sku}</div>` : ''}
                                                <div class="mt-1.5 text-xs text-slate-500">
                                                    <span class="text-slate-400">Unité:</span> <span class="font-bold text-slate-700">${CORE.formatPrice(item.price)}</span>
                                                    <span class="mx-2 text-slate-300">|</span>
                                                    <span class="text-slate-400">Total:</span> <span class="font-black text-emerald-600">${CORE.formatPrice(item.price * item.qty)}</span>
                                                </div>
                                            </div>
                                            <button onclick="VendeurModule.removeCartItem(${index})" class="no-select w-9 h-9 rounded-xl bg-red-50 border border-red-100 text-red-400 hover:text-red-600 hover:border-red-300 hover:bg-red-100 flex items-center justify-center transition-all duration-200" title="Supprimer">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>

                                        <div class="mt-3 flex items-center justify-between">
                                            <div class="inline-flex items-center gap-1 bg-slate-100 rounded-xl p-1 shadow-inner">
                                                <button aria-label="Diminuer" onclick="VendeurModule.updateCartQty(${index}, -1)" class="no-select w-8 h-8 rounded-lg bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 hover:border-slate-300 flex items-center justify-center transition shadow-sm"><i data-lucide="minus" class="w-4 h-4"></i></button>
                                                <span class="no-select w-10 text-center font-black text-slate-900 text-lg">${item.qty}</span>
                                                <button aria-label="Augmenter" onclick="VendeurModule.updateCartQty(${index}, 1)" class="no-select w-8 h-8 rounded-lg bg-white border border-slate-200 text-slate-700 hover:bg-slate-50 hover:border-slate-300 flex items-center justify-center transition shadow-sm"><i data-lucide="plus" class="w-4 h-4"></i></button>
                                            </div>
                                            <div class="text-[11px] font-bold text-slate-400 flex items-center gap-1">
                                                <i data-lucide="package" class="w-3 h-3"></i>
                                                Stock: <span class="text-slate-600">${item.maxStock}</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('');

                            const footerHtml = `
                                <div class="space-y-3">
                                    <div class="space-y-2 p-3 rounded-xl bg-slate-50 border border-slate-100">
                                        <div class="flex justify-between text-sm font-bold text-slate-600">
                                            <span class="flex items-center gap-2"><i data-lucide="shopping-bag" class="w-4 h-4 text-slate-400"></i>Sous-total</span>
                                            <span class="font-black text-slate-900">${CORE.formatPrice(subtotal)}</span>
                                        </div>
                                        <div class="flex justify-between items-center text-sm font-bold text-slate-600">
                                            <span class="flex items-center gap-2"><i data-lucide="truck" class="w-4 h-4 text-slate-400"></i>Livraison</span>
                                            <input type="number" value="${Math.max(0, parseInt(this.state.manualDeliveryFee) || 0)}" oninput="VendeurModule.setManualDeliveryFee(this.value)" class="w-20 text-right bg-white border border-slate-200 rounded-lg px-2 py-1 text-sm font-black focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition" placeholder="0">
                                        </div>
                                    </div>

                                    <div class="p-3 rounded-2xl bg-gradient-to-br from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-500/30">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="text-[10px] font-black text-emerald-100 uppercase tracking-wider">Total à payer</div>
                                            </div>
                                            <div id="cart-total-display" class="text-2xl font-black tracking-tight">${CORE.formatPrice(total)}</div>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-4 gap-1.5">
                                        <button onclick="VendeurModule.createOrder('cash')" class="py-2.5 rounded-xl bg-gradient-to-br from-slate-800 to-slate-900 text-white text-[10px] font-black hover:from-slate-700 hover:to-slate-800 transition-all shadow-md flex flex-col items-center gap-0.5">
                                            <i data-lucide="banknote" class="w-4 h-4"></i>
                                            <span>Cash</span>
                                        </button>
                                        <button onclick="VendeurModule.createOrder('mobile')" class="py-2.5 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 text-white text-[10px] font-black hover:from-blue-400 hover:to-blue-500 transition-all shadow-md flex flex-col items-center gap-0.5">
                                            <i data-lucide="smartphone" class="w-4 h-4"></i>
                                            <span>Mobile</span>
                                        </button>
                                        <button onclick="VendeurModule.createOrder('card')" class="py-2.5 rounded-xl bg-gradient-to-br from-indigo-500 to-indigo-600 text-white text-[10px] font-black hover:from-indigo-400 hover:to-indigo-500 transition-all shadow-md flex flex-col items-center gap-0.5">
                                            <i data-lucide="credit-card" class="w-4 h-4"></i>
                                            <span>Carte</span>
                                        </button>
                                        <button onclick="VendeurModule.createOrder('check')" class="py-2.5 rounded-xl bg-gradient-to-br from-violet-500 to-violet-600 text-white text-[10px] font-black hover:from-violet-400 hover:to-violet-500 transition-all shadow-md flex flex-col items-center gap-0.5">
                                            <i data-lucide="file-signature" class="w-4 h-4"></i>
                                            <span>Chèque</span>
                                        </button>
                                    </div>

                                    <button onclick="VendeurModule.createOrder('cod')" class="w-full py-2.5 rounded-xl bg-gradient-to-r from-amber-400 to-orange-500 text-white text-sm font-black hover:from-amber-500 hover:to-orange-600 transition-all shadow-lg shadow-amber-500/30 hover:shadow-amber-500/50 flex items-center justify-center gap-2">
                                        <i data-lucide="package" class="w-4 h-4"></i>
                                        COD (Paiement à la livraison)
                                    </button>

                                    <div class="flex gap-2">
                                        <button onclick="VendeurModule.parkCurrentCart()" class="flex-1 py-2 rounded-xl bg-slate-100 text-slate-600 text-xs font-black hover:bg-slate-200 transition flex items-center justify-center gap-1.5">
                                            <i data-lucide="pause-circle" class="w-3.5 h-3.5"></i> En attente
                                        </button>
                                        <button onclick="VendeurModule.clearCart()" class="px-4 py-2 rounded-xl bg-red-50 text-red-500 text-xs font-black hover:bg-red-100 hover:text-red-600 transition flex items-center justify-center gap-1">
                                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                        </button>
                                    </div>
                                </div>
                            `;

                            const floatingCart = `
                                <div class="fixed right-4 bottom-6 z-30 pb-safe">
                                    <button onclick="VendeurModule.openCartDrawer()" class="no-select group relative">
                                        <!-- Badge compteur -->
                                        ${cartCount > 0 ? `
                                            <span class="absolute -top-2 -right-2 z-10 min-w-[24px] h-6 px-1.5 bg-red-500 text-white text-xs font-black rounded-full flex items-center justify-center shadow-lg shadow-red-500/40 animate-bounce">${cartCount > 99 ? '99+' : cartCount}</span>
                                        ` : ''}

                                        <!-- Bouton principal -->
                                        <div class="relative w-16 h-16 rounded-2xl bg-gradient-to-br from-emerald-500 via-emerald-600 to-emerald-700 text-white shadow-2xl shadow-emerald-500/50 flex items-center justify-center transition-all duration-300 group-hover:scale-110 group-hover:shadow-emerald-500/70 group-active:scale-95 group-hover:rotate-[-5deg]">
                                            <i data-lucide="shopping-bag" class="w-7 h-7"></i>

                                            <!-- Effet brillance -->
                                            <div class="absolute inset-0 rounded-2xl bg-gradient-to-tr from-white/20 to-transparent pointer-events-none"></div>
                                        </div>

                                        <!-- Info bulle avec total -->
                                        ${cartCount > 0 ? `
                                            <div class="absolute right-full mr-3 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-x-2 group-hover:translate-x-0 pointer-events-none">
                                                <div class="bg-slate-900 text-white px-4 py-2 rounded-xl shadow-xl whitespace-nowrap">
                                                    <div class="text-[10px] font-bold text-slate-400 uppercase">Total</div>
                                                    <div class="text-lg font-black">${CORE.formatPrice(total)}</div>
                                                </div>
                                                <div class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-1 w-2 h-2 bg-slate-900 rotate-45"></div>
                                            </div>
                                        ` : ''}
                                    </button>
                                </div>
                            `;

                            const drawer = this.state.cartDrawerOpen ? `
                                <div class="fixed inset-0 z-40">
                                    <div class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm" onclick="VendeurModule.closeCartDrawer()"></div>

                                    <!-- Drawer plein écran mobile, panel droit desktop -->
                                    <div class="absolute inset-y-0 right-0 w-full max-w-md bg-white shadow-2xl overflow-hidden flex flex-col slide-in-right">
                                        <!-- Header compact -->
                                        <div class="p-3 sm:p-4 bg-gradient-to-r from-slate-900 to-slate-800 text-white flex-shrink-0">
                                            <div class="flex items-center justify-between gap-2">
                                                <div class="flex items-center gap-2 min-w-0">
                                                    <div class="w-8 h-8 rounded-lg bg-white/10 flex items-center justify-center flex-shrink-0">
                                                        <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                                                    </div>
                                                    <div class="min-w-0">
                                                        <div class="font-black text-base tracking-tight">Panier <span class="text-emerald-400">(${cartCount})</span></div>
                                                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider truncate">${CORE.getPOS(CORE.user?.pos)?.name || 'POS'}</div>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-1.5 flex-shrink-0">
                                                    <button onclick="VendeurModule.showClientPickerModal()" class="py-1.5 px-2.5 rounded-lg bg-white/10 hover:bg-white/20 text-white font-bold text-[10px] transition flex items-center gap-1" title="Client">
                                                        <i data-lucide="user" class="w-3.5 h-3.5"></i>
                                                        <span class="hidden sm:inline max-w-[80px] truncate">${selectedClient ? selectedClient.name : 'Client'}</span>
                                                    </button>
                                                    <button onclick="VendeurModule.showDeliveryDetailsModal()" class="py-1.5 px-2.5 rounded-lg bg-white/10 hover:bg-white/20 text-white font-bold text-[10px] transition flex items-center gap-1" title="Livraison">
                                                        <i data-lucide="map-pin" class="w-3.5 h-3.5"></i>
                                                    </button>
                                                    <button onclick="VendeurModule.closeCartDrawer()" class="w-8 h-8 rounded-lg bg-white/10 hover:bg-white/20 flex items-center justify-center transition">
                                                        <i data-lucide="x" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            ${selectedClient ? `
                                                <div class="mt-2 px-2 py-1.5 rounded-lg bg-emerald-500/20 border border-emerald-400/30 flex items-center gap-2">
                                                    <span class="text-[10px] font-black text-emerald-100">👤 ${selectedClient.name}</span>
                                                    <span class="text-[10px] text-emerald-200/70">${selectedClient.phone || ''}</span>
                                                </div>
                                            ` : ''}
                                        </div>

                                        <!-- Items — scrollable -->
                                        <div class="flex-1 overflow-auto p-3 sm:p-4 space-y-2 bg-slate-50 min-h-0">
                                            ${itemsHtml}
                                        </div>

                                        <!-- Footer — scrollable si déborde sur petit écran -->
                                        <div class="flex-shrink-0 max-h-[55vh] overflow-y-auto p-3 sm:p-4 border-t border-slate-200 bg-white">
                                            ${footerHtml}
                                        </div>
                                    </div>
                                </div>
                            ` : '';

                            return `${floatingCart}${drawer}`;
                        })()}
                    </div>
                </div>`;
        },

        renderOrders() {
            const user = CORE.state.currentUser;
            const userPos = CORE.user?.pos;

            // Pour PDG/Manager: voir tous les POS
            if (user?.role === 'pdg' || user?.role === 'manager') {
                const q = (document.getElementById('orders-search-input')?.value || '').toLowerCase().trim();
                const filter = this.state.ordersFilter;
                let orders = [...(CORE.getVisibleOrders() || [])].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                if (filter !== 'all') orders = orders.filter(o => o.status === filter);
                if (q) orders = orders.filter(o => (o.reference || '').toLowerCase().includes(q));

                const statuses = [
                    { value: 'all', label: 'Toutes' },
                    { value: 'pending', label: 'En attente' },
                    { value: 'delivered', label: 'Livrées' },
                    { value: 'cancelled', label: 'Annulées' }
                ];

                return `
                    <div class="fade-in max-w-5xl mx-auto space-y-6">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 class="text-2xl font-black text-slate-900">Commandes (Tous les POS)</h2>
                                <p class="text-slate-500 font-medium">${orders.length} commande(s)</p>
                            </div>
                            <div class="flex gap-3">
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input id="orders-search-input" type="text" value="${this.state.ordersSearch}" onkeyup="VendeurModule.updateOrdersSearch(this.value)" placeholder="CMD-0001..." class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="direction: ltr; text-align: left;" autocomplete="off">
                                </div>
                                <select onchange="VendeurModule.state.ordersFilter=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${statuses.map(s => `<option value="${s.value}" ${s.value===filter?'selected':''}>${s.label}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                            <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                                <div class="text-sm font-black text-slate-700">${orders.length} résultat(s)</div>
                                <button onclick="CORE.reset()" class="text-xs font-black text-slate-500 hover:text-red-600">Réinitialiser</button>
                            </div>
                            <div class="p-4 space-y-2">
                                ${orders.length === 0 ? `<div class="p-10 text-center text-slate-400 font-medium">Aucune commande</div>` : ''}
                                ${orders.map(o => this.renderOrderRow(o)).join('')}
                            </div>
                        </div>
                    </div>`;
            }

            // Pour autres rôles: voir seulement le POS assigné
            if (!userPos) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assigné</div></div>`;
            }

            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'POS ' + userPos;
            const q = (document.getElementById('orders-search-input')?.value || '').toLowerCase().trim();
            const filter = this.state.ordersFilter;
            let orders = (CORE.getVisibleOrders() || []).filter(o => o.posId == userPos).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
            if (filter !== 'all') orders = orders.filter(o => o.status === filter);
            if (q) orders = orders.filter(o => (o.reference || '').toLowerCase().includes(q));

            const statuses = [
                { value: 'all', label: 'Toutes' },
                { value: 'pending', label: 'En attente' },
                { value: 'delivered', label: 'Livrées' },
                { value: 'cancelled', label: 'Annulées' }
            ];

            return `
                <div class="fade-in max-w-5xl mx-auto space-y-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">Commandes</h2>
                            <p class="text-slate-500 font-medium">${posName} - ${orders.length} commande(s)</p>
                        </div>
                        <div class="flex gap-3">
                            <div class="relative">
                                <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                <input id="orders-search-input" type="text" value="${this.state.ordersSearch}" onkeyup="VendeurModule.updateOrdersSearch(this.value)" placeholder="CMD-0001..." class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="direction: ltr; text-align: left;" autocomplete="off">
                            </div>
                            <select onchange="VendeurModule.state.ordersFilter=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                ${statuses.map(s => `<option value="${s.value}" ${s.value===filter?'selected':''}>${s.label}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <div class="text-sm font-black text-slate-700">${orders.length} résultat(s)</div>
                        </div>
                        <div class="p-4 space-y-2">
                            ${orders.length === 0 ? `<div class="p-10 text-center text-slate-400 font-medium">Aucune commande</div>` : ''}
                            ${orders.map(o => this.renderOrderRow(o)).join('')}
                        </div>
                    </div>
                </div>`;
        },

        renderStock() {
            const posId = CORE.user?.pos || CORE.user?.storeId;
            if (!posId) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assigné</div></div>`;
            }

            const posData = CORE.getPOS(posId);
            const posName = posData?.name || 'POS ' + posId;
            const pendingReceipts = CORE.getTransferReceipts({ posId, status: 'pending' });
            const pendingCount = pendingReceipts.length;

            // State filters
            const searchQuery = (this.state.stockSearch || '').toLowerCase().trim();
            const categoryFilter = this.state.stockCategoryFilter || 'all';
            const statusFilter = this.state.stockStatusFilter || 'all';
            const sortBy = this.state.stockSortBy || 'name';
            const page = this.state.stockPage || 1;
            const perPage = this.state.stockPerPage || 30;

            // Get all products for this POS
            const allProducts = (CORE.getVisibleProducts() || []).filter(p => {
                const matchesPosId = (p.posId == posId || String(p.posId) === String(posId));
                const hasStockInPos = p.posStocks && p.posStocks[posId] && p.posStocks[posId].stock > 0;
                return matchesPosId || hasStockInPos;
            });

            // Apply filters
            let filteredProducts = allProducts.filter(p => {
                // Search filter
                if (searchQuery && !(p.name || '').toLowerCase().includes(searchQuery) &&
                    !(p.barcode || '').toLowerCase().includes(searchQuery) &&
                    !(p.reference || '').toLowerCase().includes(searchQuery)) return false;

                // Category filter
                if (categoryFilter !== 'all' && p.categoryId != categoryFilter) return false;

                // Status filter
                const stock = CORE.getProductStock(p.id, posId);
                const minStock = p.minStock || 0;
                if (statusFilter === 'critical' && stock > minStock * 0.5) return false;
                if (statusFilter === 'low' && (stock > minStock || stock <= minStock * 0.5)) return false;
                if (statusFilter === 'ok' && stock <= minStock) return false;
                if (statusFilter === 'outofstock' && stock > 0) return false;

                return true;
            });

            // Sorting
            filteredProducts.sort((a, b) => {
                const stockA = CORE.getProductStock(a.id, posId);
                const stockB = CORE.getProductStock(b.id, posId);
                switch (sortBy) {
                    case 'stock_asc': return stockA - stockB;
                    case 'stock_desc': return stockB - stockA;
                    case 'price_asc': return (a.price || 0) - (b.price || 0);
                    case 'price_desc': return (b.price || 0) - (a.price || 0);
                    case 'critical': return (stockA - (a.minStock || 0)) - (stockB - (b.minStock || 0));
                    default: return (a.name || '').localeCompare(b.name || '');
                }
            });

            // Calculate stats
            const totalProducts = allProducts.length;
            const totalFiltered = filteredProducts.length;
            const totalPages = Math.ceil(totalFiltered / perPage);
            const currentPage = Math.min(page, totalPages || 1);

            // Stats
            const okCount = allProducts.filter(p => CORE.getProductStock(p.id, posId) > (p.minStock || 0)).length;
            const lowCount = allProducts.filter(p => {
                const s = CORE.getProductStock(p.id, posId);
                return s <= (p.minStock || 0) && s > (p.minStock || 0) * 0.5;
            }).length;
            const criticalCount = allProducts.filter(p => {
                const s = CORE.getProductStock(p.id, posId);
                return s <= (p.minStock || 0) * 0.5 && s > 0;
            }).length;
            const outCount = allProducts.filter(p => CORE.getProductStock(p.id, posId) === 0).length;

            // Pagination
            const startIdx = (currentPage - 1) * perPage;
            const paginatedProducts = filteredProducts.slice(startIdx, startIdx + perPage);

            // Categories for filter
            const categories = CORE.db.categories || [];

            // Generate pagination buttons
            const pages = [];
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    pages.push(i);
                } else if (pages[pages.length - 1] !== '...') {
                    pages.push('...');
                }
            }

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="package" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-black text-slate-900">📦 Stock</h2>
                                    <p class="text-slate-500 font-medium">${posName} • ${totalFiltered}/${totalProducts} produit(s)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${pendingCount > 0 ? `
                        <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <div>
                                <div class="font-black text-amber-900">${pendingCount} transfert(s) en attente de validation</div>
                                <div class="text-xs text-amber-700 space-y-1 mt-2">
                                    ${pendingReceipts.slice(0, 2).map(r => `<div>• ${r.quantity} × ${r.productName} (${r.reference || r.id})</div>`).join('')}
                                    ${pendingCount > 2 ? `<div class="italic">+ ${pendingCount - 2} autre(s) transfert(s)...</div>` : ''}
                                </div>
                            </div>
                            <button onclick="GestionnaireModule.showTransferReceiptsCenter()" class="px-4 py-2.5 bg-amber-600 text-white text-xs font-black rounded-xl hover:bg-amber-700 transition">Valider maintenant</button>
                        </div>
                    ` : ''}

                    <!-- Stats KPIs -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-2xl border border-emerald-200 cursor-pointer hover:shadow-md transition" onclick="VendeurModule.state.stockStatusFilter='ok';VendeurModule.state.stockPage=1;App.rerender()">
                            <div class="text-xs font-black text-emerald-600 uppercase">Stock OK</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${okCount}</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-2xl border border-amber-200 cursor-pointer hover:shadow-md transition" onclick="VendeurModule.state.stockStatusFilter='low';VendeurModule.state.stockPage=1;App.rerender()">
                            <div class="text-xs font-black text-amber-600 uppercase">Stock Bas</div>
                            <div class="text-2xl font-black text-amber-900 mt-1">${lowCount}</div>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-2xl border border-red-200 cursor-pointer hover:shadow-md transition" onclick="VendeurModule.state.stockStatusFilter='critical';VendeurModule.state.stockPage=1;App.rerender()">
                            <div class="text-xs font-black text-red-600 uppercase">Critique</div>
                            <div class="text-2xl font-black text-red-900 mt-1">${criticalCount}</div>
                        </div>
                        <div class="bg-gradient-to-br from-slate-50 to-slate-100 p-4 rounded-2xl border border-slate-200 cursor-pointer hover:shadow-md transition" onclick="VendeurModule.state.stockStatusFilter='outofstock';VendeurModule.state.stockPage=1;App.rerender()">
                            <div class="text-xs font-black text-slate-600 uppercase">Rupture</div>
                            <div class="text-2xl font-black text-slate-900 mt-1">${outCount}</div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <div class="flex flex-wrap gap-3 items-center">
                            <!-- Search -->
                            <div class="relative flex-1 min-w-[200px]">
                                <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                <input type="text" value="${searchQuery}"
                                    oninput="VendeurModule.state.stockSearch=this.value;VendeurModule.state.stockPage=1;App.rerender()"
                                    placeholder="Rechercher produit, code..."
                                    class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium">
                            </div>
                            <!-- Category -->
                            <select onchange="VendeurModule.state.stockCategoryFilter=this.value;VendeurModule.state.stockPage=1;App.rerender()"
                                class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold min-w-[150px]">
                                <option value="all" ${categoryFilter === 'all' ? 'selected' : ''}>Toutes catégories</option>
                                ${categories.map(c => `<option value="${c.id}" ${categoryFilter == c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                            </select>
                            <!-- Status -->
                            <select onchange="VendeurModule.state.stockStatusFilter=this.value;VendeurModule.state.stockPage=1;App.rerender()"
                                class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold min-w-[150px]">
                                <option value="all" ${statusFilter === 'all' ? 'selected' : ''}>Tous les stocks</option>
                                <option value="ok" ${statusFilter === 'ok' ? 'selected' : ''}>✅ Stock OK</option>
                                <option value="low" ${statusFilter === 'low' ? 'selected' : ''}>⚠️ Stock bas</option>
                                <option value="critical" ${statusFilter === 'critical' ? 'selected' : ''}>🔴 Critique</option>
                                <option value="outofstock" ${statusFilter === 'outofstock' ? 'selected' : ''}>❌ Rupture</option>
                            </select>
                            <!-- Sort -->
                            <select onchange="VendeurModule.state.stockSortBy=this.value;App.rerender()"
                                class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold min-w-[130px]">
                                <option value="name" ${sortBy === 'name' ? 'selected' : ''}>Nom A-Z</option>
                                <option value="stock_asc" ${sortBy === 'stock_asc' ? 'selected' : ''}>Stock ↑</option>
                                <option value="stock_desc" ${sortBy === 'stock_desc' ? 'selected' : ''}>Stock ↓</option>
                                <option value="price_asc" ${sortBy === 'price_asc' ? 'selected' : ''}>Prix ↑</option>
                                <option value="price_desc" ${sortBy === 'price_desc' ? 'selected' : ''}>Prix ↓</option>
                                <option value="critical" ${sortBy === 'critical' ? 'selected' : ''}>+ Critiques</option>
                            </select>
                            <!-- Reset -->
                            ${(searchQuery || categoryFilter !== 'all' || statusFilter !== 'all') ? `
                            <button onclick="VendeurModule.state.stockSearch='';VendeurModule.state.stockCategoryFilter='all';VendeurModule.state.stockStatusFilter='all';VendeurModule.state.stockPage=1;App.rerender()"
                                class="px-3 py-2.5 bg-red-100 text-red-700 rounded-xl font-bold hover:bg-red-200 transition flex items-center gap-1">
                                <i data-lucide="x" class="w-4 h-4"></i> Reset
                            </button>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Products Table -->
                    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                        <!-- Pagination info header -->
                        <div class="p-4 border-b border-slate-100 flex flex-wrap items-center justify-between gap-2">
                            <span class="text-sm text-slate-600 font-medium">
                                ${totalFiltered === 0 ? 'Aucun produit' : `Affichage ${startIdx + 1}-${Math.min(startIdx + perPage, totalFiltered)} sur ${totalFiltered}`}
                            </span>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-500">Par page:</span>
                                <select onchange="VendeurModule.state.stockPerPage=parseInt(this.value);VendeurModule.state.stockPage=1;App.rerender()" class="px-2 py-1 rounded-lg border border-slate-200 bg-white text-sm font-bold">
                                    <option value="20" ${perPage === 20 ? 'selected' : ''}>20</option>
                                    <option value="30" ${perPage === 30 ? 'selected' : ''}>30</option>
                                    <option value="50" ${perPage === 50 ? 'selected' : ''}>50</option>
                                    <option value="100" ${perPage === 100 ? 'selected' : ''}>100</option>
                                </select>
                            </div>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-left min-w-[700px]">
                                <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4">Produit</th>
                                        <th class="px-6 py-4">Catégorie</th>
                                        <th class="px-6 py-4 text-right">Prix</th>
                                        <th class="px-6 py-4 text-center">Stock</th>
                                        <th class="px-6 py-4 text-center">Min</th>
                                        <th class="px-6 py-4">Statut</th>
                                        <th class="px-6 py-4 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${paginatedProducts.length === 0 ? `
                                    <tr><td colspan="6" class="px-6 py-12 text-center text-slate-400 font-medium">
                                        <i data-lucide="package-x" class="w-10 h-10 mx-auto mb-2 opacity-50"></i>
                                        <div>Aucun produit trouvé</div>
                                    </td></tr>
                                    ` : paginatedProducts.map(p => {
                                        const posStock = CORE.getProductStock(p.id, posId);
                                        const posPrice = CORE.getProductPrice(p.id, posId);
                                        const minStock = p.minStock || 0;
                                        const isCritical = posStock <= minStock * 0.5;
                                        const isLow = posStock <= minStock && !isCritical;
                                        const isOut = posStock === 0;
                                        return `
                                        <tr class="hover:bg-slate-50 transition">
                                            <td class="px-6 py-4">
                                                <div class="font-black text-slate-900">${p.name}</div>
                                                <div class="text-[10px] text-slate-400">#${p.barcode || p.id}</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <span class="px-3 py-1 bg-slate-100 rounded-lg text-xs font-bold text-slate-600">${CORE.getCategory(p.categoryId)?.name || '—'}</span>
                                            </td>
                                            <td class="px-6 py-4 text-right font-black">${CORE.formatPrice(posPrice)}</td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="text-lg font-black ${isOut || isCritical ? 'text-red-600' : isLow ? 'text-amber-600' : 'text-slate-900'}">${posStock}</span>
                                            </td>
                                            <td class="px-6 py-4 text-center font-bold text-slate-500">${minStock}</td>
                                            <td class="px-6 py-4">
                                                ${isOut ? UI.badge('Rupture', 'red') :
                                                  isCritical ? UI.badge('Critique', 'red') :
                                                  isLow ? UI.badge('Bas', 'amber') :
                                                  UI.badge('OK', 'emerald')}
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <button onclick="ManagerModule.showEditProductModal('${p.id}')" class="px-3 py-1.5 bg-blue-600 text-white text-xs font-black rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-1">
                                                    ✏️ Éditer
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination controls -->
                        ${totalPages > 1 ? `
                        <div class="p-4 border-t border-slate-100 flex items-center justify-center gap-2">
                            <button onclick="VendeurModule.state.stockPage=1;App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === 1 ? 'disabled' : ''}><i data-lucide="chevrons-left" class="w-4 h-4"></i></button>
                            <button onclick="VendeurModule.state.stockPage=Math.max(1,VendeurModule.state.stockPage-1);App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === 1 ? 'disabled' : ''}><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                            ${pages.map(p => p === '...' ? `<span class="px-2 text-slate-400">...</span>` : `<button onclick="VendeurModule.state.stockPage=${p};App.rerender()" class="px-3 py-2 rounded-lg ${p === currentPage ? 'bg-emerald-600 text-white' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm">${p}</button>`).join('')}
                            <button onclick="VendeurModule.state.stockPage=Math.min(${totalPages},VendeurModule.state.stockPage+1);App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === totalPages ? 'disabled' : ''}><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                            <button onclick="VendeurModule.state.stockPage=${totalPages};App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === totalPages ? 'disabled' : ''}><i data-lucide="chevrons-right" class="w-4 h-4"></i></button>
                        </div>
                        ` : ''}
                    </div>
                </div>`;
        },

        renderMovements() {
            const userPos = CORE.user?.pos;
            const movements = CORE.getMovementHistory({ posId: userPos });
            const typeIcons = {
                'transfer': '📦 Transfert',
                'reception': '📥 Réception',
                'adjustment': '✏️ Ajustement',
                'sale': '🛒 Vente',
                'return': '↩️ Retour'
            };
            const reasonLabels = {
                'transfer_request': 'Demande de transfert',
                'manual_adjustment': 'Ajustement manuel',
                'sale': 'Vente',
                'return': 'Retour client',
                'restock': 'Réapprovisionnement'
            };

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div class="flex items-end justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">📦 Mouvements de Stock</h2>
                            <p class="text-slate-500 font-medium">Historique audité de chaque mouvement avec traçabilité complète.</p>
                        </div>
                        <button onclick="GestionnaireModule.showTransferModal()" class="px-5 py-3 bg-slate-900 text-white rounded-xl font-black hover:bg-slate-800 transition flex items-center gap-2">
                            <i data-lucide="arrow-right-left" class="w-5 h-5"></i> Transférer
                        </button>
                    </div>

                    <div class="grid grid-cols-4 gap-4">
                        <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Total mouvements</div>
                            <div class="text-2xl font-black text-slate-900 mt-2">${movements.length}</div>
                        </div>
                        <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Transferts</div>
                            <div class="text-2xl font-black text-blue-600 mt-2">${movements.filter(m => m.type === 'transfer').length}</div>
                        </div>
                        <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Ajustements</div>
                            <div class="text-2xl font-black text-amber-600 mt-2">${movements.filter(m => m.type === 'adjustment').length}</div>
                        </div>
                        <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Valeur totale</div>
                            <div class="text-2xl font-black text-emerald-600 mt-2">${CORE.formatPrice(movements.reduce((sum, m) => sum + (m.totalValue || 0), 0))}</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider border-b border-slate-100">
                                <tr>
                                    <th class="px-6 py-4">Date & Heure</th>
                                    <th class="px-6 py-4">Type</th>
                                    <th class="px-6 py-4">Produit</th>
                                    <th class="px-6 py-4 text-center">Quantité</th>
                                    <th class="px-6 py-4">De / À</th>
                                    <th class="px-6 py-4">Qui</th>
                                    <th class="px-6 py-4">Notes</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50">
                                ${movements.length === 0 ? `
                                    <tr>
                                        <td colspan="7" class="px-6 py-12 text-center text-slate-400 font-medium">
                                            <div class="flex flex-col items-center gap-2">
                                                <i data-lucide="inbox" class="w-8 h-8"></i>
                                                <span>Aucun mouvement de stock enregistré</span>
                                            </div>
                                        </td>
                                    </tr>
                                ` : movements.map(m => `
                                    <tr class="hover:bg-slate-50 transition cursor-pointer" onclick="GestionnaireModule.showMovementDetail('${m.id}')">
                                        <td class="px-6 py-4 font-mono text-xs">
                                            <div class="font-black text-slate-900">${new Date(m.timestamp).toLocaleDateString('fr-FR')}</div>
                                            <div class="text-slate-400">${new Date(m.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <span class="px-3 py-1 bg-slate-100 rounded-lg text-xs font-bold text-slate-700">${typeIcons[m.type] || m.type}</span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="font-black text-slate-900">${m.productName}</div>
                                            <div class="text-[10px] text-slate-400">SKU: ${m.productSku}</div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <span class="font-black text-slate-900">${m.quantity > 0 ? '+' : ''}${m.quantity}</span>
                                        </td>
                                        <td class="px-6 py-4 text-xs">
                                            ${m.type === 'transfer' ? `
                                                <div class="font-black text-slate-900">${m.fromPosName} → ${m.toPosName}</div>
                                            ` : `
                                                <div class="text-slate-500">${reasonLabels[m.reason] || m.reason || '—'}</div>
                                            `}
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="font-black text-slate-900">${m.userName}</div>
                                            <div class="text-[10px] text-slate-400">${m.userRole}</div>
                                        </td>
                                        <td class="px-6 py-4 max-w-xs truncate text-slate-600 text-xs">
                                            ${m.notes ? `<span title="${m.notes}">${m.notes.substring(0, 30)}${m.notes.length > 30 ? '...' : ''}</span>` : '<span class="text-slate-300">—</span>'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        },

        showTransferReceiptsCenter(tab = null) {
            const posId = CORE.user?.pos || CORE.state.currentUser?.pos || null;
            if (!posId) {
                UI.toast('POS non défini', 'error');
                return;
            }

            const activeTab = tab || this.state.transferReceiptsTab || 'pending';
            this.state.transferReceiptsTab = activeTab;

            const allReceipts = CORE.getTransferReceipts({ posId });
            const counts = { pending: 0, accepted: 0, rejected: 0 };
            allReceipts.forEach(r => {
                if (counts[r.status] !== undefined) counts[r.status] += 1;
            });

            const grouped = {
                pending: allReceipts.filter(r => r.status === 'pending'),
                accepted: allReceipts.filter(r => r.status === 'accepted'),
                rejected: allReceipts.filter(r => r.status === 'rejected')
            };

            const activeList = grouped[activeTab] || [];
            const emptyLabel = activeTab === 'pending'
                ? 'Aucun transfert en attente'
                : activeTab === 'accepted'
                    ? 'Aucune réception validée'
                    : 'Aucun transfert rejeté';

            const listHtml = activeList.length
                ? activeList.map(r => this.renderTransferReceiptCard(r, activeTab === 'pending')).join('')
                : `<div class="p-6 text-center text-slate-400 font-medium">${emptyLabel}</div>`;

            const tabs = [
                { key: 'pending', label: `En attente (${counts.pending})` },
                { key: 'accepted', label: `Validées (${counts.accepted})` },
                { key: 'rejected', label: `Rejetées (${counts.rejected})` }
            ];

            UI.modal('📥 Réceptions de stock', `
                <div class="space-y-4">
                    <div class="flex flex-wrap gap-2">
                        ${tabs.map(t => `<button onclick="GestionnaireModule.showTransferReceiptsCenter('${t.key}')" class="px-4 py-2 rounded-xl font-black text-sm ${activeTab === t.key ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">${t.label}</button>`).join('')}
                    </div>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto pr-1">${listHtml}</div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            setTimeout(() => { lucide?.createIcons?.(); }, 50);
        },

        renderTransferReceiptCard(receipt, showActions = false) {
            const statusBadge = receipt.status === 'accepted'
                ? UI.badge('Validée', 'emerald')
                : receipt.status === 'rejected'
                    ? UI.badge('Rejetée', 'red')
                    : UI.badge('En attente', 'amber');
            const etaLabel = receipt.estimatedArrivalAt ? new Date(receipt.estimatedArrivalAt).toLocaleDateString('fr-FR') : '—';
            const createdLabel = receipt.createdAt ? new Date(receipt.createdAt).toLocaleString('fr-FR') : '—';
            const attachmentsCount = Array.isArray(receipt.attachments) ? receipt.attachments.length : 0;
            const proofCount = Array.isArray(receipt.proofAttachments) ? receipt.proofAttachments.length : 0;

            return `
                <div class="p-4 bg-white border border-slate-200 rounded-2xl shadow-sm">
                    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                        <div>
                            <div class="flex items-center gap-2">
                                <div class="font-black text-slate-900">${receipt.productName}</div>
                                ${statusBadge}
                            </div>
                            <div class="text-xs text-slate-500 mt-1">Réf: ${receipt.reference || receipt.id}</div>
                            <div class="text-xs text-slate-500 mt-1">Quantité: <span class="font-black text-slate-900">${receipt.quantity}</span></div>
                            <div class="text-xs text-slate-500 mt-1">Envoyé par: ${receipt.fromPosName || 'Dépôt principal'}</div>
                            <div class="text-xs text-slate-500 mt-1">Créé le ${createdLabel}</div>
                            <div class="text-xs text-slate-500 mt-1">ETA: ${etaLabel}</div>
                            ${attachmentsCount ? `<div class="text-xs text-slate-500 mt-1">📎 ${attachmentsCount} pièce(s) expéditeur</div>` : ''}
                            ${proofCount ? `<div class="text-xs text-emerald-600 mt-1">✅ ${proofCount} preuve(s) reçues</div>` : ''}
                        </div>
                        <div class="flex flex-col items-stretch md:items-end gap-2">
                            <button onclick="GestionnaireModule.showTransferReceiptDetails('${receipt.id}')" class="px-4 py-2 bg-slate-900 text-white text-xs font-black rounded-xl hover:bg-slate-800 transition">Détails</button>
                            ${showActions ? `
                                <div class="flex gap-2">
                                    <button onclick="GestionnaireModule.showApproveTransferReceiptModal('${receipt.id}')" class="px-4 py-2 bg-emerald-600 text-white text-xs font-black rounded-xl hover:bg-emerald-700 transition">Valider</button>
                                    <button onclick="GestionnaireModule.showRejectTransferReceiptModal('${receipt.id}')" class="px-4 py-2 bg-red-600 text-white text-xs font-black rounded-xl hover:bg-red-700 transition">Rejeter</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ${receipt.note ? `<div class="mt-3 text-xs text-slate-600 bg-slate-50 border border-slate-100 rounded-xl p-3">${receipt.note}</div>` : ''}
                </div>
            `;
        },

        showTransferReceiptDetails(receiptId) {
            const receipt = CORE.getTransferReceipt(receiptId);
            if (!receipt) {
                UI.toast('Transfert introuvable', 'error');
                return;
            }

            const etaLabel = receipt.estimatedArrivalAt ? new Date(receipt.estimatedArrivalAt).toLocaleString('fr-FR') : '—';
            const createdLabel = receipt.createdAt ? new Date(receipt.createdAt).toLocaleString('fr-FR') : '—';
            const updatedLabel = receipt.updatedAt ? new Date(receipt.updatedAt).toLocaleString('fr-FR') : '—';
            const attachments = Array.isArray(receipt.attachments) ? receipt.attachments : [];
            const proofs = Array.isArray(receipt.proofAttachments) ? receipt.proofAttachments : [];

            UI.modal(`📦 ${receipt.productName}`, `
                <div class="space-y-4 text-sm text-slate-600">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Référence</div>
                            <div class="font-black text-slate-900">${receipt.reference || receipt.id}</div>
                        </div>
                        <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Quantité</div>
                            <div class="font-black text-slate-900">${receipt.quantity}</div>
                        </div>
                        <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Origine</div>
                            <div class="font-black text-slate-900">${receipt.fromPosName || 'Dépôt principal'}</div>
                        </div>
                        <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Destinataire</div>
                            <div class="font-black text-slate-900">${receipt.toPosName || `POS ${receipt.toPosId}`}</div>
                        </div>
                        <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Créé le</div>
                            <div class="font-black text-slate-900">${createdLabel}</div>
                        </div>
                        <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Mise à jour</div>
                            <div class="font-black text-slate-900">${updatedLabel}</div>
                        </div>
                        <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Statut</div>
                            <div>${receipt.status === 'accepted' ? UI.badge('Validée','emerald') : receipt.status === 'rejected' ? UI.badge('Rejetée','red') : UI.badge('En attente','amber')}</div>
                        </div>
                        <div class="p-3 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">ETA</div>
                            <div class="font-black text-slate-900">${etaLabel}</div>
                        </div>
                    </div>
                    ${receipt.note ? `<div class="p-3 bg-white border border-slate-200 rounded-xl">${receipt.note}</div>` : ''}
                    ${attachments.length ? `
                        <div>
                            <div class="text-xs font-black text-slate-500 uppercase mb-2">Pièces jointes expéditeur</div>
                            <div class="flex flex-wrap gap-2">
                                ${attachments.map((att, idx) => `<a href="${att.dataUrl}" target="_blank" class="px-3 py-2 bg-slate-100 border border-slate-200 rounded-xl text-xs font-bold text-slate-700 hover:bg-slate-200 transition">Pièce ${idx + 1}</a>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${proofs.length ? `
                        <div>
                            <div class="text-xs font-black text-slate-500 uppercase mb-2">Preuves de réception</div>
                            <div class="flex flex-wrap gap-2">
                                ${proofs.map((att, idx) => `<a href="${att.dataUrl}" target="_blank" class="px-3 py-2 bg-emerald-100 border border-emerald-200 rounded-xl text-xs font-bold text-emerald-700 hover:bg-emerald-200 transition">Preuve ${idx + 1}</a>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            setTimeout(() => { lucide?.createIcons?.(); }, 50);
        },

        resetReceiptProofState() {
            this.state.pendingReceiptFiles = [];
            const preview = document.getElementById('transfer_receipt_preview');
            if (preview) preview.innerHTML = '<div class="text-xs text-slate-500">Aucune pièce jointe</div>';
        },

        handleReceiptAttachmentChange(event) {
            const files = Array.from(event?.target?.files || []);
            this.state.pendingReceiptFiles = files;
            this.updateReceiptAttachmentPreview(files);
        },

        updateReceiptAttachmentPreview(files = null) {
            const list = Array.isArray(files) ? files : (this.state.pendingReceiptFiles || []);
            const preview = document.getElementById('transfer_receipt_preview');
            if (!preview) return;
            if (!list.length) {
                preview.innerHTML = '<div class="text-xs text-slate-500">Aucune pièce jointe</div>';
                return;
            }
            preview.innerHTML = list.map((file, idx) => {
                const sizeKb = file.size ? Math.round(file.size / 1024) : 0;
                const type = (file.type || 'fichier').split('/')[0];
                return `
                    <div class="flex items-center justify-between gap-3 px-3 py-2 bg-white border border-slate-200 rounded-xl">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-black text-slate-900">${idx + 1}.</span>
                            <div class="text-xs font-bold text-slate-700 truncate max-w-[220px]" title="${file.name}">${file.name || 'Pièce jointe'}</div>
                            <span class="text-[10px] uppercase font-black text-slate-400">${type}</span>
                        </div>
                        <span class="text-[10px] text-slate-500">${sizeKb} Ko</span>
                    </div>
                `;
            }).join('');
        },

        showApproveTransferReceiptModal(receiptId) {
            const receipt = CORE.getTransferReceipt(receiptId);
            if (!receipt) {
                UI.toast('Transfert introuvable', 'error');
                return;
            }

            this.resetReceiptProofState();

            UI.modal('✅ Valider la réception', `
                <div class="space-y-4">
                    <p class="text-sm text-slate-600">Confirmez la réception de <span class="font-black text-slate-900">${receipt.quantity}</span> ${receipt.productName}.</p>
                    <textarea id="transfer_receipt_note" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500" rows="3" placeholder="Note de réception (optionnel)"></textarea>
                    <div class="space-y-2">
                        <label class="text-xs font-black text-slate-600 uppercase">Ajoutez des preuves (photos/vidéos)</label>
                        <input id="transfer_receipt_files" type="file" accept="image/*,video/*" multiple onchange="GestionnaireModule.handleReceiptAttachmentChange(event)" class="w-full text-sm text-slate-600">
                        <div id="transfer_receipt_preview" class="space-y-2 p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs text-slate-500">Aucune pièce jointe</div>
                        <div class="text-[11px] text-slate-400">Formats acceptés: images et vidéos. Minimum une pièce requise.</div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Valider', onclick: `GestionnaireModule.executeApproveTransferReceipt('${receipt.id}')`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);

            setTimeout(() => { this.updateReceiptAttachmentPreview(); }, 50);
        },

        async executeApproveTransferReceipt(receiptId) {
            const note = (document.getElementById('transfer_receipt_note')?.value || '').trim();
            const files = Array.from(this.state.pendingReceiptFiles || []);
            if (!files.length) {
                UI.toast('Ajoutez au moins une preuve visuelle', 'warning');
                return;
            }

            let attachments = [];
            try {
                attachments = await Promise.all(files.map(async (file) => {
                    const dataUrl = await Utils.readFileAsDataUrl(file);
                    return {
                        id: Utils.uid('ATT'),
                        name: file.name || 'attachment',
                        type: file.type || 'application/octet-stream',
                        size: file.size || 0,
                        dataUrl,
                        uploadedAt: new Date().toISOString()
                    };
                }));
            } catch (err) {
                UI.toast('Lecture des pièces jointe(s) impossible', 'error');
                return;
            }

            const result = CORE.approveTransferReceipt(receiptId, note, attachments);
            if (!result?.success) {
                UI.toast(result?.message || 'Impossible de valider la réception', 'error');
                return;
            }

            UI.closeModal();
            this.resetReceiptProofState();
            UI.toast('Réception validée', 'success');
            setTimeout(() => {
                this.showTransferReceiptsCenter(this.state.transferReceiptsTab || 'pending');
                App.rerender();
            }, 50);
        },


        showRejectTransferReceiptModal(receiptId) {
            const receipt = CORE.getTransferReceipt(receiptId);
            if (!receipt) {
                UI.toast('Transfert introuvable', 'error');
                return;
            }

            UI.modal('✖️ Rejeter la réception', `
                <div class="space-y-4">
                    <p class="text-sm text-slate-600">Expliquez la raison du rejet pour ${receipt.reference || receipt.id}.</p>
                    <textarea id="transfer_receipt_reason" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-red-500" rows="3" placeholder="Motif du rejet (obligatoire)"></textarea>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Rejeter', onclick: `GestionnaireModule.executeRejectTransferReceipt('${receipt.id}')`, class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);
        },

        executeRejectTransferReceipt(receiptId) {
            const reason = (document.getElementById('transfer_receipt_reason')?.value || '').trim();
            if (!reason) {
                UI.toast('Motif requis pour rejeter', 'warning');
                return;
            }

            const result = CORE.rejectTransferReceipt(receiptId, reason);
            if (!result?.success) {
                UI.toast(result?.message || 'Impossible de rejeter la réception', 'error');
                return;
            }

            UI.closeModal();
            UI.toast('Réception rejetée', 'info');
            setTimeout(() => {
                this.showTransferReceiptsCenter(this.state.transferReceiptsTab || 'pending');
                App.rerender();
            }, 50);
        },

        // =====================
        // LIVREURS (Vendeur)
        // =====================
        getLivreursForSeller() {
            const userPos = CORE.user?.pos;
            const vendeurId = CORE.state.currentUser?.id;
            const livreurs = CORE.getVisibleUsers().filter(u => u.role === 'livreur' && u.active !== false && (u.pos == userPos || u.posId == userPos));
            const activeDeliveries = CORE.getVisibleDeliveries().filter(d => d.posId == userPos && d.status === 'en_cours');
            const counts = {};
            activeDeliveries.forEach(d => {
                if (d.livreurId) counts[d.livreurId] = (counts[d.livreurId] || 0) + 1;
            });

            // Inclure les livreurs indépendants approuvés de ce vendeur
            const approvedIndependent = (CORE.db.independentDeliveryMen || [])
                .filter(dm => String(dm.vendeurId) == String(vendeurId) && dm.approvalStatus === 'approved')
                .map(dm => ({
                    id: dm.id,
                    name: dm.name + ' (Indépendant)',
                    phone: dm.phone || '',
                    vehicle: dm.vehicle || '',
                    rating: dm.rating || null,
                    active: true,
                    role: 'livreur',
                    isIndependent: true,
                    avatar: dm.name ? dm.name.slice(0, 2).toUpperCase() : '??',
                    deliveryCount: dm.deliveryCount || 0
                }));

            const allLivreurs = [...livreurs, ...approvedIndependent];

            return allLivreurs.map(l => {
                const activeCount = counts[l.id] || 0;
                return {
                    ...l,
                    activeCount,
                    isBusy: activeCount > 0,
                    activeDelivery: activeDeliveries.find(d => d.livreurId === l.id) || null
                };
            });
        },

        showAssignDeliveryModal(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;

            // Récupérer les livreurs disponibles du même POS
            // Récupérer tous les livreurs (classiques + indépendants) via getUnassignedLivreurs
            const allLivreurs = CORE.getUnassignedLivreurs(d.posId);

            UI.modal(`Assigner ${d.orderRef}`, `
                <div class="space-y-4">
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Client</div>
                        <div class="mt-1 font-black text-slate-900">${d.clientName}</div>
                        <div class="text-xs text-slate-500">${d.address}</div>
                    </div>

                    ${allLivreurs.length > 0 ? `
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-xl flex items-center gap-2">
                            <i data-lucide="info" class="w-4 h-4 text-blue-600 flex-shrink-0"></i>
                            <span class="text-xs text-blue-800">${allLivreurs.filter(l => l.activeDeliveries === 0).length} livreur(s) entièrement disponible(s)</span>
                        </div>
                    ` : `
                        <div class="p-3 bg-amber-50 border border-amber-200 rounded-xl flex items-center gap-2">
                            <i data-lucide="alert-circle" class="w-4 h-4 text-amber-600 flex-shrink-0"></i>
                            <span class="text-xs text-amber-800">⚠️ Aucun livreur disponible pour ce POS</span>
                        </div>
                    `}

                    ${allLivreurs.length > 0 ? UI.select('assign_livreur','Livreur', allLivreurs.map(l => {
                        const status = l.activeDeliveries > 0 ? `${l.activeDeliveries} en cours 🔴` : `Libre 🟢`;
                        const badge = l.isIndependent ? ' ⭐' : '';
                        return { value: l.id, label: `${l.name} (${l.vehicle}) - ${status}${badge}` };
                    }), d.livreurId || '', true) : ''}

                    <div id="assign_whatsapp_container" style="display:none" class="pt-2">
                        <button onclick="VendeurModule.sendAssignViaWhatsApp(${d.id})" class="w-full py-3 px-4 bg-green-500 text-white font-black rounded-xl hover:bg-green-600 transition flex items-center justify-center gap-2 text-sm">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                            Envoyer via WhatsApp
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-3 pt-4 border-t border-slate-100">
                        <button onclick="VendeurModule.assignDelivery(${d.id}, false)" class="py-3 px-4 bg-slate-100 text-slate-700 font-black rounded-xl hover:bg-slate-200 transition text-xs" ${allLivreurs.length === 0 ? 'disabled' : ''}>
                            Assignation
                        </button>
                        <button onclick="VendeurModule.assignDelivery(${d.id}, true)" class="py-3 px-4 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition flex items-center justify-center gap-2 text-xs" ${allLivreurs.length === 0 ? 'disabled' : ''}>
                            <i data-lucide="message-square" class="w-4 h-4"></i> SMS
                        </button>
                    </div>

                    <button onclick="VendeurModule.autoAssignDelivery(${d.id})" class="w-full py-3 px-4 bg-emerald-50 text-emerald-700 font-black rounded-xl hover:bg-emerald-100 transition border border-emerald-200 text-sm flex items-center justify-center gap-2">
                        <i data-lucide="zap" class="w-4 h-4"></i> Assignation Intelligente Automatique
                    </button>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);

            // Toggle WhatsApp button based on selected livreur
            setTimeout(() => {
                const sel = document.getElementById('assign_livreur');
                const waContainer = document.getElementById('assign_whatsapp_container');
                if (sel && waContainer) {
                    const indepIds = new Set((CORE.db.independentDeliveryMen || []).filter(dm => dm.approvalStatus === 'approved').map(dm => String(dm.id)));
                    const toggle = () => { waContainer.style.display = indepIds.has(String(sel.value)) ? '' : 'none'; };
                    sel.addEventListener('change', toggle);
                    toggle();
                }
            }, 50);
        },

        // Send delivery assignment via WhatsApp to independent delivery man
        sendAssignViaWhatsApp(deliveryId) {
            const livreurIdRaw = document.getElementById('assign_livreur')?.value;
            if (!livreurIdRaw) return UI.toast('S\u00e9lectionnez un livreur', 'warning');
            // First assign normally
            VendeurModule.assignDelivery(deliveryId, false);
            // Then open WhatsApp
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (d) VendeurModule.sendDeliveryToWhatsApp(deliveryId);
        },

        // Send COD order via WhatsApp to independent delivery man
        sendCODViaWhatsApp() {
            VendeurModule.submitCODOrder(false);
            // After submission, get the latest delivery and open WhatsApp
            setTimeout(() => {
                const deliveries = CORE.getVisibleDeliveries().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                if (deliveries.length > 0) {
                    VendeurModule.sendDeliveryToWhatsApp(deliveries[0].id);
                }
            }, 300);
        },

        autoAssignDelivery(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return UI.toast('Livraison introuvable', 'error');

            const result = CORE.autoAssignDelivery(d.posId, deliveryId);
            if (!result) {
                return UI.toast('Aucun livreur disponible pour ce POS', 'warning');
            }

            UI.closeModal();
            UI.toast(`✓ Auto-assignée à ${result.livreur.name}`, 'success');
            App.rerender();
        },

        assignDelivery(deliveryId, sendSms = false) {
            const livreurId = parseId(UI.val('assign_livreur'));
            if (!livreurId) return UI.toast('Sélectionnez un livreur', 'warning');

            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;

            // Chercher d'abord dans les users classiques, puis dans les livreurs indépendants
            let livreur = CORE.getUser(livreurId);
            let isIndependent = false;
            if (!livreur || livreur.role !== 'livreur') {
                const indep = (CORE.db.independentDeliveryMen || []).find(dm => dm.id === livreurId && dm.approvalStatus === 'approved' && dm.status === 'active');
                if (indep) {
                    livreur = { id: indep.id, name: indep.name + ' (Indépendant)', phone: indep.phone, pos: indep.posId, role: 'livreur', isIndependent: true };
                    isIndependent = true;
                } else {
                    return UI.toast('Livreur invalide', 'error');
                }
            }

            // Vérifier que le livreur appartient au même POS que la livraison
            if (livreur.pos != d.posId) {
                return UI.toast('Le livreur n\'appartient pas au même POS que la livraison', 'error');
            }

            // Assignation/réassignation possible même si la course était "annulée", "rappelée" ou une "reservation".
            // Le statut reste 'en_attente' après assignation - c'est au livreur de signaler 'en_cours'
            const nextStatus = (d.status === 'livree') ? 'livree' : 'en_attente';
            const previousLivreurId = d.livreurId || d.previousLivreurId || null;
            const oldDelivery = { ...d };

            CORE.update('deliveries', d.id, {
                previousLivreurId,
                livreurId,
                status: nextStatus,
                assignedAt: nextStatus === 'en_cours' ? new Date().toISOString() : (d.assignedAt || null),
                // clear recall info on reassign
                recallReason: null,
                recalledAt: null
            });

            const o = CORE.getVisibleOrders().find(x => x.id === d.orderId);
            if (o && nextStatus === 'en_cours' && o.status !== 'delivered') {
                CORE.update('orders', o.id, { status: 'delivering' });
            }

            // Record audit log
            CORE.logActivity('assign', 'delivery', d.id, {
                entityName: `Commande ${d.orderRef}`,
                description: `Affectation à ${livreur.name} - Statut: ${nextStatus}`,
                before: { livreurId: previousLivreurId },
                after: { livreurId: livreur.id }
            });

            if (sendSms && livreur.phone) {
                const order = d.orderId ? CORE.getVisibleOrders().find(x => x.id === d.orderId) : null;
                const msg = CORE.buildDeliveryTicketSMS({
                    orderRef: d.orderRef, clientName: d.clientName, clientPhone: d.clientPhone,
                    address: d.address, deliveryTime: d.deliveryTime, amount: d.amount,
                    orderItems: order?.items || []
                });
                window.open(`sms:${livreur.phone}?body=${encodeURIComponent(msg)}`, '_blank');
            }

            CORE.notify('info', `Course ${d.orderRef} assignée à ${livreur.name}`, { deliveryId: d.id, livreurId });

            // 🔊 Jouer le son de notification pour le livreur
            UI.playNotificationSound();

            UI.closeModal();
            App.rerender();
        },

        setDeliveryStatusBySeller(deliveryId, status) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;

            const oldStatus = d.status;
            CORE.update('deliveries', d.id, { status, deliveredAt: status === 'livree' ? new Date().toISOString() : (d.deliveredAt || null) });

            // Créer automatiquement des incidents pour les problèmes
            if (status === 'probleme' && oldStatus !== 'probleme') {
                CORE.createIncident('retard', d.id, 'delivery', `Problème de livraison: ${d.orderRef}`, 'haute');
            } else if (status === 'annulee' && oldStatus !== 'annulee') {
                CORE.createIncident('annulation', d.id, 'delivery', `Livraison annulée: ${d.orderRef}`, 'haute');
            }

            // Synchroniser commande (si existante)
            const o = CORE.getVisibleOrders().find(x => x.id === d.orderId);
            if (o) {
                if (status === 'livree') {
                    // COD: l'argent est avec le livreur, paymentStatus reste 'pending' jusqu'au dépôt en caisse
                    const orderUpdates = { status: 'delivered' };
                    if (o.paymentMethod !== 'cod') {
                        // Non-COD: déjà payé (cash/mobile/card à la commande)
                        orderUpdates.paymentStatus = o.paymentStatus || 'paid';
                    }
                    const updatedOrder = CORE.update('orders', o.id, orderUpdates);

                    // Ledger: enregistrer la vente SEULEMENT si non-COD (déjà payé)
                    if (o.paymentMethod !== 'cod') {
                        CORE.ensureSaleTransaction(updatedOrder);
                    }

                    // Ledger: commission livreur
                    CORE.ensureCommissionTransaction({ ...d, status: 'livree' });
                }
                if (status === 'probleme') {
                    // laisse la commande en pending/delivering selon votre logique; on garde simple
                    CORE.update('orders', o.id, { status: o.status === 'delivered' ? o.status : 'delivering' });
                }
            }

            // Record audit log for status change
            CORE.logActivity('status_change', 'delivery', d.id, {
                entityName: `Commande ${d.orderRef}`,
                description: `Statut modifié: ${oldStatus} → ${status}`,
                before: { status: oldStatus },
                after: { status: status }
            });

            UI.toast(`Course mise à jour: ${status}`, 'success');
            App.rerender();
        },

        // Rappeler un bon de livraison déjà envoyé à un livreur
        // - permet de désassigner un livreur et remettre en dispatch
        // - garde l'historique: recalledAt, recallReason, previousLivreurId
        // - la livraison reste modifiable ensuite

        showDeliveryDetailModal(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;

            const livreur = d.livreurId ? CORE.getUser(d.livreurId) : null;
            const order = d.orderId ? CORE.getVisibleOrders().find(o => o.id === d.orderId) : null;
            const orderItems = order?.items || [];

            const statusBadge = d.status === 'livree' ? UI.badge('Livrée', 'emerald') :
                                d.status === 'probleme' ? UI.badge('Problème', 'red') :
                                d.status === 'en_attente' ? UI.badge('À assigner', 'blue') :
                                d.status === 'annulee' ? UI.badge('Annulée', 'slate') :
                                UI.badge('En cours', 'amber');

            const phone = (livreur?.phone || '').trim();
            const livreurHtml = !livreur ? '<div class="text-sm text-slate-500">Aucun livreur assigné</div>' :
                '<div class="flex items-start justify-between gap-3"><div><div class="font-black text-slate-900">' + livreur.name + '</div><div class="text-xs text-slate-500">' + (livreur.vehicle || '—') + ' • note ' + (livreur.rating || '—') + '</div>' + (phone ? '<div class="mt-1 text-xs text-slate-600"><b>' + phone + '</b></div>' : '<div class="mt-1 text-xs text-amber-700 font-bold">Téléphone manquant</div>') + '</div><div class="flex flex-col gap-2"><button onclick="VendeurModule.showEditLivreurModal(\'' + livreur.id + '\')" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-50">Modifier tel.</button><button onclick="VendeurModule.callLivreur(\'' + livreur.id + '\')" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700">📞 Appeler</button></div></div>';

            const productsContent = orderItems.length === 0 ? '<div class="text-xs text-blue-700">Aucun produit</div>' :
                '<div class="space-y-2 max-h-48 overflow-y-auto">' + orderItems.map(item => '<div class="p-2 bg-white rounded border border-blue-200"><div class="flex items-center justify-between gap-2"><div class="flex-1 text-xs"><div class="font-bold text-slate-900">' + item.name + '</div><div class="text-blue-700">Qty: <strong>' + item.qty + '</strong> × ' + CORE.formatPrice(item.price) + '</div></div><div class="font-bold text-slate-900 text-xs">' + CORE.formatPrice(item.qty * item.price) + '</div></div></div>').join('') + '</div>';

            // Historique des rappels pour la vue détail
            const recallHistory = d.recallHistory || [];
            let recallHistoryHtml = '';
            if (recallHistory.length > 0) {
                recallHistoryHtml = '<div class="p-4 bg-red-50 border border-red-200 rounded-2xl"><div class="text-xs font-black text-red-600 uppercase tracking-wider mb-2">⚠️ Historique des rappels (' + recallHistory.length + ')</div><div class="space-y-2 max-h-32 overflow-y-auto">' + recallHistory.map((r, idx) => {
                    const liv = r.livreurId ? CORE.getUser(r.livreurId) : null;
                    const dateStr = r.date ? new Date(r.date).toLocaleString('fr-FR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : '—';
                    return '<div class="p-2 bg-white rounded-xl border border-red-100 text-xs"><div class="flex items-center justify-between"><span class="font-bold text-red-700">#' + (idx + 1) + ' - ' + (liv?.name || r.livreurName || 'Livreur inconnu') + '</span><span class="text-slate-400">' + dateStr + '</span></div><div class="mt-1 text-slate-600">' + (r.reason || 'Aucune raison spécifiée') + '</div></div>';
                }).join('') + '</div></div>';
            }

            // Photos de preuve de livraison
            let proofPhotosHtml = '';
            if (d.proofPhotos && d.proofPhotos.length > 0) {
                proofPhotosHtml = '<div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl"><div class="text-xs font-black text-emerald-600 uppercase tracking-wider mb-2 flex items-center gap-2"><i data-lucide="camera" class="w-4 h-4"></i> Photos de preuve (' + d.proofPhotos.length + ')</div><div class="grid grid-cols-4 gap-2">' + d.proofPhotos.map((photo, idx) => '<div class="aspect-square rounded-xl overflow-hidden border border-emerald-300 cursor-pointer" onclick="VendeurModule.viewProofPhoto(\'' + photo.substring(0, 50) + '...\', ' + d.id + ', ' + idx + ')"><img src="' + photo + '" class="w-full h-full object-cover hover:scale-110 transition"></div>').join('') + '</div>' + (d.proofNote ? '<div class="mt-2 p-2 bg-white rounded-lg text-xs text-slate-600"><b>Note:</b> ' + d.proofNote + '</div>' : '') + (d.proofTimestamp ? '<div class="mt-1 text-xs text-emerald-700 text-right">Validé le ' + new Date(d.proofTimestamp).toLocaleString('fr-FR') + '</div>' : '') + '</div>';
            }

            // Signature de preuve
            let proofSignatureHtml = '';
            if (d.proofSignature) {
                proofSignatureHtml = '<div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl"><div class="text-xs font-black text-blue-600 uppercase tracking-wider mb-2 flex items-center gap-2">✍️ Signature client</div><div class="bg-white p-3 rounded-xl border border-blue-200 cursor-pointer" onclick="VendeurModule.viewProofSignature(' + d.id + ')"><img src="' + d.proofSignature + '" class="w-full max-h-32 object-contain"></div>' + (d.proofTimestamp ? '<div class="mt-1 text-xs text-blue-700 text-right">Signé le ' + new Date(d.proofTimestamp).toLocaleString('fr-FR') + '</div>' : '') + '</div>';
            }

            UI.modal('Course ' + d.orderRef, '<div class="space-y-4 max-h-[80vh] overflow-y-auto"><div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl flex items-start justify-between gap-4"><div><div class="text-xs font-black text-slate-500 uppercase tracking-wider">Statut</div><div class="mt-1">' + statusBadge + '</div></div><div class="text-right"><div class="text-xs font-black text-slate-500 uppercase tracking-wider">Montant</div><div class="text-2xl font-black text-emerald-600">' + CORE.formatPrice(d.amount) + '</div></div></div><div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl"><div class="text-xs font-black text-slate-500 uppercase tracking-wider">Client</div><div class="mt-1 font-black text-slate-900">' + (d.clientName || '—') + '</div><div class="flex items-center justify-between gap-3 mt-1"><div class="text-xs text-slate-600">' + (d.clientPhone || '') + '</div>' + (d.clientPhone ? '<a href="tel:' + d.clientPhone + '" class="px-3 py-2 bg-emerald-600 text-white text-xs font-black rounded-lg hover:bg-emerald-700 transition flex items-center gap-1 whitespace-nowrap">📞 Appeler</a>' : '') + '</div><div class="mt-2 text-xs text-slate-600"><b>Adresse:</b> ' + (d.address || '—') + '</div>' + (d.deliveryTime ? '<div class="mt-1 text-xs text-slate-600"><b>Heure souhaitée:</b> ' + d.deliveryTime + '</div>' : '') + (d.recallReason ? '<div class="mt-3 p-3 rounded-xl bg-amber-50 border border-amber-100 text-xs text-amber-800"><b>Dernier rappel:</b> ' + d.recallReason + '</div>' : '') + '</div>' + recallHistoryHtml + proofPhotosHtml + proofSignatureHtml + '<div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl"><div class="font-black text-blue-900 mb-3">📦 Produits (' + orderItems.length + ')</div>' + productsContent + '</div><div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl"><div class="text-xs font-black text-slate-500 uppercase tracking-wider">Livreur</div><div class="mt-2">' + livreurHtml + '</div></div><div class="grid grid-cols-2 gap-2"><button onclick="UI.closeModal();VendeurModule.showEditDeliveryModal(' + d.id + ')" class="px-4 py-3 rounded-xl bg-slate-900 text-white font-black hover:bg-slate-800 transition">Modifier livraison</button><button onclick="UI.closeModal();VendeurModule.showAssignDeliveryModal(' + d.id + ')" class="px-4 py-3 rounded-xl bg-white border border-slate-200 font-black hover:bg-slate-50 transition">Réassigner</button><button onclick="VendeurModule.sendDeliveryToWhatsApp(' + d.id + ')" class="px-4 py-3 rounded-xl bg-green-500 text-white font-black hover:bg-green-600 transition col-span-2 flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg> Envoyer via WhatsApp</button>' + (d.livreurId && ['en_cours','probleme'].includes(d.status) ? '<button onclick="UI.closeModal();VendeurModule.showRecallDeliveryModal(' + d.id + ')" class="px-4 py-3 rounded-xl bg-red-50 text-red-700 font-black hover:bg-red-100 transition col-span-2">Rappeler bon de livraison</button>' : '') + (d.status !== 'livree' ? '<button onclick="VendeurModule.setDeliveryStatusBySeller(' + d.id + ',\'livree\');UI.closeModal()" class="px-4 py-3 rounded-xl bg-emerald-600 text-white font-black hover:bg-emerald-700 transition col-span-2">Marquer livrée</button>' : '') + '</div></div>', [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        // Voir une photo de preuve en plein écran
        viewProofPhoto(preview, deliveryId, photoIndex) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d || !d.proofPhotos || !d.proofPhotos[photoIndex]) return;

            const photo = d.proofPhotos[photoIndex];
            UI.modal('📷 Photo de preuve', `
                <div class="flex items-center justify-center">
                    <img src="${photo}" class="max-w-full max-h-[70vh] rounded-2xl shadow-lg">
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-3xl' });
        },

        // Voir la signature de preuve en plein écran
        viewProofSignature(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d || !d.proofSignature) return;

            UI.modal('✍️ Signature client', `
                <div class="flex flex-col items-center gap-4">
                    <div class="p-6 bg-white rounded-2xl border-2 border-slate-200 shadow-lg">
                        <img src="${d.proofSignature}" class="max-w-full max-h-[50vh]" alt="Signature du client">
                    </div>
                    <div class="text-sm text-slate-600">
                        Signature pour la commande <span class="font-bold">${d.orderRef}</span>
                    </div>
                    <div class="text-xs text-slate-400">
                        ${d.proofTimestamp ? new Date(d.proofTimestamp).toLocaleString('fr-FR') : ''}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-md' });
        },

        // Envoyer le bon de livraison via WhatsApp à un livreur indépendant
        sendDeliveryToWhatsApp(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;

            const order = d.orderId ? CORE.getVisibleOrders().find(o => o.id === d.orderId) : null;
            const orderItems = order?.items || [];
            const pdv = CORE.db.pointsDeVente?.find(p => p.id === CORE.state.activePDV);
            const pdvName = pdv?.nom || 'RAYA STORE';

            // Construire le message du bon de livraison
            let message = "📦 *BON DE LIVRAISON*\n";
            message += "━━━━━━━━━━━━━━━━━━\n\n";
            message += "🏪 *De:* " + pdvName + "\n";
            message += "📋 *Réf:* " + (d.orderRef || 'N/A') + "\n";
            message += "📅 *Date:* " + new Date().toLocaleDateString('fr-FR') + "\n\n";

            message += "👤 *CLIENT*\n";
            message += "━━━━━━━━━━━━━━━━━━\n";
            message += "Nom: " + (d.clientName || 'Non spécifié') + "\n";
            if (d.clientPhone) message += "Tél: " + d.clientPhone + "\n";
            message += "📍 Adresse: " + (d.address || 'Non spécifiée') + "\n";
            if (d.deliveryTime) message += "⏰ Heure souhaitée: " + d.deliveryTime + "\n";
            message += "\n";

            message += "📦 *ARTICLES À LIVRER*\n";
            message += "━━━━━━━━━━━━━━━━━━\n";
            if (orderItems.length > 0) {
                orderItems.forEach((item, idx) => {
                    message += (idx + 1) + ". " + item.name + "\n";
                    message += "   Qté: " + item.qty + " × " + CORE.formatPrice(item.price) + " = " + CORE.formatPrice(item.qty * item.price) + "\n";
                });
            } else {
                message += "(Aucun détail disponible)\n";
            }
            message += "\n";

            message += "💰 *MONTANT TOTAL: " + CORE.formatPrice(d.amount) + "*\n\n";

            message += "━━━━━━━━━━━━━━━━━━\n";
            message += "⚠️ Merci de confirmer la livraison une fois effectuée.\n";
            message += "📞 Contact boutique: " + (pdv?.telephone || 'N/A');

            // -- AUTO-SELECT PHONE FIX -- Résoudre le téléphone du livreur assigné
            let livreurPhone = '';
            let livreurName = '';
            if (d.livreurId) {
                let livreurObj = CORE.getUser(d.livreurId);
                if (!livreurObj) {
                    const indep = (CORE.db.independentDeliveryMen || []).find(dm => String(dm.id) == String(d.livreurId));
                    if (indep) livreurObj = indep;
                }
                if (livreurObj) {
                    livreurPhone = (livreurObj.phone || '').trim();
                    livreurName = livreurObj.name || '';
                }
            }

            // Afficher modal pour saisir le numéro WhatsApp
            UI.modal('📱 Envoyer via WhatsApp', `
                <div class="space-y-4">
                    <div class="p-4 bg-green-50 border border-green-200 rounded-2xl">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                            </div>
                            <div>
                                <div class="font-black text-green-800">Envoyer à un livreur${livreurName ? ' : ' + livreurName : ' indépendant'}</div>
                                <div class="text-sm text-green-600">Le bon de livraison sera envoyé via WhatsApp</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Numéro WhatsApp du livreur</label>
                        <input type="tel" id="whatsappNumber" value="${livreurPhone}" placeholder="Ex: ${CORE.getPhonePlaceholder()}" class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-green-500 focus:ring-4 focus:ring-green-100 text-lg font-bold" autofocus>
                        ${livreurPhone ? '<div class="mt-1 text-xs text-green-600 font-bold">✓ Numéro du livreur pré-rempli automatiquement</div>' : '<div class="mt-1 text-xs text-slate-500">Format: numéro local (commenéant par 0) ou international (+' + CORE.getCountryPhoneCode() + '...)</div>'}
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
                        <div class="text-xs font-bold text-slate-500 uppercase mb-2">Aperçu du message</div>
                        <div class="max-h-48 overflow-y-auto text-xs text-slate-700 whitespace-pre-wrap bg-white p-3 rounded-lg border border-slate-200">${message.replace(/\*/g, '').replace(/\n/g, '<br>')}</div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="UI.closeModal()" class="px-4 py-3 rounded-xl bg-slate-100 text-slate-700 font-bold hover:bg-slate-200 transition">Annuler</button>
                        <button onclick="VendeurModule.openWhatsAppDelivery('${encodeURIComponent(message)}')" class="px-4 py-3 rounded-xl bg-green-500 text-white font-bold hover:bg-green-600 transition flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                            Envoyer
                        </button>
                    </div>
                </div>
            `, [], { maxWidth: 'max-w-lg' });
        },

        // Ouvrir WhatsApp avec le bon de livraison
        openWhatsAppDelivery(encodedMessage) {
            const phoneInput = document.getElementById('whatsappNumber');
            if (!phoneInput) return;

            let phone = phoneInput.value.trim().replace(/\s+/g, '').replace(/-/g, '');

            if (!phone) {
                UI.toast('Veuillez saisir un numéro de téléphone', 'error');
                return;
            }

            // Convertir au format international selon le pays de l'entreprise
            phone = CORE.formatPhoneForWhatsApp(phone);

            // Vérifier que le numéro semble valide
            if (!/^\d{7,15}$/.test(phone)) {
                UI.toast('Format de numéro invalide', 'error');
                return;
            }

            const message = decodeURIComponent(encodedMessage);
            const whatsappUrl = 'https://wa.me/' + phone + '?text=' + encodeURIComponent(message);

            window.open(whatsappUrl, '_blank');
            UI.closeModal();
            UI.toast('WhatsApp ouvert avec le bon de livraison', 'success');
        },

        showEditDeliveryModal(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;

            const livreurs = this.getLivreursForSeller().filter(l => l.active);

            // Récupérer la commande associée
            const order = d.orderId ? CORE.getVisibleOrders().find(o => o.id === d.orderId) : null;
            const orderItems = order?.items || [];

            UI.modal(`Modifier ${d.orderRef}`, `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    ${UI.input('edit_del_client','Client','text', d.clientName || '', 'Nom client', true)}
                    ${UI.input('edit_del_phone','Téléphone','tel', d.clientPhone || '', CORE.getPhonePlaceholder(), false)}
                    ${UI.input('edit_del_time','Heure de livraison','time', d.deliveryTime || '', '', false)}
                    ${UI.textarea('edit_del_address','Adresse', d.address || '', 'Adresse complète', 3)}

                    ${UI.select('edit_del_livreur','Livreur', livreurs.map(l => {
                        const c = l.activeCount || 0;
                        const statusTxt = c > 0 ? `(${c} en cours 🔴)` : `(${c} en cours 🟢)`;
                        return { value: l.id, label: `${l.name} ${statusTxt}` };
                    }), d.livreurId || '')}

                    ${UI.select('edit_del_status','Statut', [
                        { value: 'en_attente', label: 'À assigner' },
                        { value: 'en_cours', label: 'En cours' },
                        { value: 'livree', label: 'Livrée' },
                        { value: 'probleme', label: 'Problème' },
                        { value: 'annulee', label: 'Annulée' }
                    ], d.status || 'en_cours')}

                    <!-- Produits de la commande -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="font-black text-blue-900 mb-3">📦 Produits (${orderItems.length})</div>
                        ${orderItems.length === 0 ? `
                            <div class="text-xs text-blue-700">Aucun produit</div>
                        ` : `
                            <div class="space-y-2 max-h-48 overflow-y-auto">
                                ${orderItems.map((item, idx) => `
                                    <div class="flex items-center gap-2 p-2 bg-white rounded border border-blue-200">
                                        <div class="flex-1 text-xs">
                                            <div class="font-bold text-slate-900">${item.name}</div>
                                            <div class="text-blue-700">Qty: <strong>${item.qty}</strong> × ${CORE.formatPrice(item.price)}</div>
                                        </div>
                                        <button onclick="VendeurModule.removeOrderItem(${order.id}, ${idx})" class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">✕</button>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                        <button onclick="VendeurModule.showAddProductToOrderModal(${order?.id || 0})" class="w-full mt-3 px-3 py-2 bg-blue-600 text-white text-xs font-black rounded hover:bg-blue-700">+ Ajouter produit</button>
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">
                        Vous pouvez modifier une livraison même si elle est <b>annulée</b> ou <b>rappelée</b>.
                        ${d.recalledAt ? `<div class="mt-1">Dernier rappel: <b>${CORE.formatDate(d.recalledAt)}</b></div>` : ''}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 pt-2 border-t border-slate-100">
                        <button onclick="VendeurModule.saveDeliveryEdits(${d.id}, false, false)" class="py-3 px-4 bg-slate-100 text-slate-700 font-black rounded-xl hover:bg-slate-200 transition text-xs">
                            Enregistrer
                        </button>
                        <button onclick="VendeurModule.saveDeliveryEdits(${d.id}, false, true)" class="py-3 px-4 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition text-xs">
                            Enregistrer + Réassigner
                        </button>
                        <button onclick="VendeurModule.saveDeliveryEdits(${d.id}, true, false)" class="py-3 px-4 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition flex items-center justify-center gap-2 text-xs">
                            <i data-lucide="message-square" class="w-4 h-4"></i> Enregistrer + SMS
                        </button>
                    </div>

                    <div class="text-xs text-slate-500">Astuce: utilisez <b>Enregistrer + Réassigner</b> pour ouvrir directement la sélection du livreur après modification.</div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        removeOrderItem(orderId, itemIndex) {
            const order = CORE.getVisibleOrders().find(o => o.id === orderId);
            if (!order || !order.items || !order.items[itemIndex]) {
                alert('Impossible de retirer cet article');
                return;
            }

            // Retirer l'article
            order.items.splice(itemIndex, 1);

            // Recalculer le total
            if (order.items.length > 0) {
                order.total = order.items.reduce((sum, item) => sum + (item.qty * item.price), 0);
            } else {
                order.total = 0;
            }

            // Sauvegarder
            CORE.save('orders', order, order.id);

            // Recharger le modal
            const delivery = CORE.getVisibleDeliveries().find(d => d.orderId === orderId);
            if (delivery) VendeurModule.showEditDeliveryModal(delivery.id);
            console.log(`Article ${itemIndex} retiré de la commande ${orderId}`);
        },

        showAddProductToOrderModal(orderId) {
            const order = CORE.getVisibleOrders().find(o => o.id === orderId);
            if (!order) {
                alert('Commande introuvable');
                return;
            }

            const products = CORE.getVisibleProducts() || [];
            const userPos = CORE.user?.pos;
            const vendorProducts = products.filter(p => p.posId === userPos && p.active);

            if (vendorProducts.length === 0) {
                alert('Aucun produit disponible');
                return;
            }

            UI.modal('Ajouter un produit', `
                <div class="space-y-3">
                    <div class="text-xs text-slate-600 mb-3">Sélectionnez un produit à ajouter à cette commande</div>

                    <div class="max-h-64 overflow-y-auto space-y-2">
                        ${vendorProducts.map(p => `
                            <div class="p-3 border border-slate-200 rounded-lg hover:border-slate-400 hover:bg-slate-50 cursor-pointer transition" onclick="VendeurModule.selectProductForOrder(${orderId}, ${p.id}, '${p.name.replace(/'/g, "\\'")}', ${p.price || 0})">
                                <div class="font-bold text-slate-900 text-sm">${p.name}</div>
                                <div class="text-xs text-blue-600 font-semibold">${CORE.formatPrice(p.price || 0)}</div>
                                ${p.sku ? `<div class="text-xs text-slate-500">SKU: ${p.sku}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>

                    <div class="text-xs text-slate-500 text-center p-3 bg-slate-50 rounded">
                        Cliquez sur un produit pour le sélectionner et entrer la quantité
                    </div>
                </div>
            `, false, true);
        },

        selectProductForOrder(orderId, productId, productName, productPrice) {
            UI.closeModal();

            const qty = prompt('Entrez la quantité:', '1');
            if (!qty || isNaN(qty) || parseInt(qty) <= 0) {
                return;
            }

            const order = CORE.getVisibleOrders().find(o => o.id === orderId);
            if (!order) {
                alert('Commande introuvable');
                return;
            }

            // Initialiser items s'il n'existe pas
            if (!order.items) order.items = [];

            // Vérifier si le produit existe déjà
            const existingItem = order.items.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.qty += parseInt(qty);
            } else {
                order.items.push({
                    productId: productId,
                    name: productName,
                    qty: parseInt(qty),
                    price: productPrice
                });
            }

            // Recalculer le total
            order.total = order.items.reduce((sum, item) => sum + (item.qty * item.price), 0);

            // Sauvegarder
            CORE.save('orders', order, order.id);

            // Recharger le modal
            const delivery = CORE.getVisibleDeliveries().find(d => d.orderId === orderId);
            if (delivery) VendeurModule.showEditDeliveryModal(delivery.id);
            console.log(`Produit ${productId} ajouté à la commande ${orderId}`);
        },

        saveDeliveryEdits(deliveryId, sendSms = false, openAssign = false) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;

            const clientName = UI.val('edit_del_client').trim();
            const clientPhone = UI.val('edit_del_phone').trim();
            const deliveryTime = UI.val('edit_del_time').trim();
            const address = UI.val('edit_del_address').trim();
            const livreurId = parseId(UI.val('edit_del_livreur'));
            let status = UI.val('edit_del_status') || d.status;

            if (!clientName) return UI.toast('Nom client requis', 'warning');
            if (!address) return UI.toast('Adresse requise', 'warning');

            // Normalisation: si un livreur est sélectionné => la livraison devient "en_cours" (même si elle était annulée/rappelée)
            if (livreurId) {
                if (status !== 'livree') status = 'en_cours';
            } else {
                // Pas de livreur: on évite un statut incohérent
                if (status === 'en_cours') status = 'en_attente';
            }

            // Update delivery
            const deliveryUpdates = { clientName, clientPhone, address, deliveryTime: deliveryTime || null, livreurId, status };
            // Si on réactive (en_cours), on efface les traces de rappel
            if (status === 'en_cours') {
                deliveryUpdates.recallReason = null;
                deliveryUpdates.recalledAt = null;
            }
            // Si annulée, on force désassignation
            if (status === 'annulee') {
                deliveryUpdates.livreurId = null;
            }
            CORE.update('deliveries', d.id, deliveryUpdates);

            // Update linked order (client fields + statut)
            const o = CORE.getVisibleOrders().find(x => x.id === d.orderId);
            if (o) {
                CORE.update('orders', o.id, { clientName, clientPhone, clientAddress: address, deliveryTime: deliveryTime || null });
                if (o.status !== 'delivered') {
                    if (status === 'en_cours') CORE.update('orders', o.id, { status: 'delivering' });
                    if (status === 'en_attente') CORE.update('orders', o.id, { status: 'pending' });
                }
            }

            // If seller sets status to livree/probleme, sync order + ledger
            if (status === 'livree' || status === 'probleme') {
                this.setDeliveryStatusBySeller(d.id, status);
            }

            // Optional SMS to assigned driver
            const updatedDelivery = CORE.getVisibleDeliveries().find(x => x.id === d.id);
            const livreur = livreurId ? CORE.getUser(livreurId) : null;
            if (sendSms && livreur?.phone) {
                const editOrder = updatedDelivery.orderId ? CORE.getVisibleOrders().find(x => x.id === updatedDelivery.orderId) : null;
                const msg = CORE.buildDeliveryTicketSMS({
                    prefix: '✏️ MISE À JOUR',
                    orderRef: updatedDelivery.orderRef, clientName: updatedDelivery.clientName,
                    clientPhone: updatedDelivery.clientPhone, address: updatedDelivery.address,
                    deliveryTime: updatedDelivery.deliveryTime, amount: updatedDelivery.amount,
                    orderItems: editOrder?.items || []
                });
                window.open(`sms:${livreur.phone}?body=${encodeURIComponent(msg)}`, '_blank');
            }

            UI.toast('Livraison mise à jour', 'success');
            UI.closeModal();
            App.rerender();

            if (openAssign) {
                // Ouvre directement la modale d’assignation après l’enregistrement
                setTimeout(() => {
                    try { VendeurModule.showAssignDeliveryModal(deliveryId); } catch(e) { console.warn('[DELIVERY] showAssignDeliveryModal failed:', e); }
                }, 0);
            }

            if (livreurId && !sendSms) {
                UI.toast(`Réassignée à ${CORE.getUser(livreurId)?.name || 'livreur'}`, 'info');
            }
        },

        // Rappeler un bon de livraison déjà envoyé à un livreur
        // Permet aussi de rappeler une livraison même si elle est "probleme".
        showRecallDeliveryModal(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;

            const livreur = d.livreurId ? CORE.getUser(d.livreurId) : null;
            const previous = d.previousLivreurId ? CORE.getUser(d.previousLivreurId) : null;

            // Afficher l'historique des rappels si existant
            const recallHistory = d.recallHistory || [];
            let historyHtml = '';
            if (recallHistory.length > 0) {
                historyHtml = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-2xl">
                        <div class="text-xs font-black text-red-600 uppercase tracking-wider mb-2">
                            ⚠️ Historique des rappels (${recallHistory.length})
                        </div>
                        <div class="space-y-2 max-h-32 overflow-y-auto">
                            ${recallHistory.map((r, idx) => {
                                const liv = r.livreurId ? CORE.getUser(r.livreurId) : null;
                                const dateStr = r.date ? new Date(r.date).toLocaleString('fr-FR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' }) : '—';
                                return `
                                    <div class="p-2 bg-white rounded-xl border border-red-100 text-xs">
                                        <div class="flex items-center justify-between">
                                            <span class="font-bold text-red-700">#${idx + 1} - ${liv?.name || 'Livreur inconnu'}</span>
                                            <span class="text-slate-400">${dateStr}</span>
                                        </div>
                                        <div class="mt-1 text-slate-600">${r.reason || 'Aucune raison spécifiée'}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            UI.modal(`Rappeler ${d.orderRef}`, `
                <div class="space-y-4">
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Bon de livraison</div>
                        <div class="mt-1 font-black text-slate-900">${d.orderRef}</div>
                        <div class="text-xs text-slate-500">Client: <b>${d.clientName || '—'}</b></div>
                        <div class="text-xs text-slate-500">Adresse: <b>${d.address || '—'}</b></div>
                        <div class="mt-2 text-xs text-slate-500">
                            Livreur actuel: <span class="font-bold text-red-600">${livreur?.name || 'Aucun'}</span>
                        </div>
                        ${previous ? `<div class="mt-1 text-xs text-slate-400">Précédent: ${previous.name}</div>` : ''}
                    </div>

                    ${historyHtml}

                    ${UI.select('recall_action','Action',[
                        { value: 'en_attente', label: 'Remettre en Dispatch (désassigner le livreur)' },
                        { value: 'annulee', label: 'Annuler définitivement la livraison' }
                    ], 'en_attente', true)}

                    ${UI.textarea('recall_reason','Raison du rappel', '', 'ex: client absent, erreur adresse, changement livreur...', 3)}

                    <div class="p-4 bg-amber-50 border border-amber-100 rounded-2xl text-xs text-amber-800">
                        <b>Attention :</b> Le livreur sera notifié que la course lui est retirée. La commande repassera en statut "En attente".
                    </div>
                </div>
            `, [
                { label: 'Retour', onclick: 'UI.closeModal()' },
                { label: 'Confirmer le Rappel', onclick: `VendeurModule.recallDelivery(${d.id})`, class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);
        },

        recallDelivery(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;

            const action = UI.val('recall_action') || 'en_attente';
            const reason = UI.val('recall_reason').trim();

            const previousLivreurId = d.livreurId || null;
            const previousLivreur = previousLivreurId ? CORE.getUser(previousLivreurId) : null;

            // Construire l'historique des rappels (ajouter cette entrée)
            const recallHistory = Array.isArray(d.recallHistory) ? [...d.recallHistory] : [];
            recallHistory.push({
                date: new Date().toISOString(),
                livreurId: previousLivreurId,
                livreurName: previousLivreur?.name || null,
                reason: reason || null,
                action: action,
                recalledBy: CORE.state.currentUser?.id || null
            });

            // Désassigner + changer le statut (on garde trace du livreur précédent + historique complet)
            CORE.update('deliveries', d.id, {
                status: action,
                previousLivreurId: previousLivreurId,
                livreurId: null,
                recallReason: reason || null,
                recalledAt: new Date().toISOString(),
                recallHistory: recallHistory,
                recallCount: recallHistory.length
            });

            // Synchroniser la commande liée : Si on rappelle le bon, la commande n'est plus "en cours de livraison"
            const o = CORE.getVisibleOrders().find(x => x.id === d.orderId);
            if (o) {
                if (o.status !== 'delivered') {
                    // Force le statut en attente car il n'y a plus de livreur
                    CORE.update('orders', o.id, { status: 'pending' });
                }
            }

            // Notifier l'ancien livreur (si SMS possible)
            if (previousLivreur?.phone) {
                try {
                    const msg = `Rappel course ${d.orderRef}. Cette course vous a été retirée. Raison: ${reason || '—'}.`;
                    // Ne force pas l'ouverture SMS automatiquement (pas souhaité). On garde juste une notification interne.
                    CORE.notify('info', `Livreur informé (rappel): ${previousLivreur.name}`, { deliveryId: d.id, previousLivreurId });
                } catch(e) { console.warn('[DELIVERY] Failed to notify previous livreur:', e); }
            }

            UI.closeModal();
            UI.toast(`Bon de livraison rappelé (${recallHistory.length}x)`, 'success');
            CORE.notify('info', `Bon de livraison ${d.orderRef} rappelé${previousLivreur ? ` (désassigné: ${previousLivreur.name})` : ''} - Rappel #${recallHistory.length}`, { deliveryId: d.id, action, previousLivreurId, recallCount: recallHistory.length });
            App.rerender();
        },

        showSettingsModal() {
            this.navigateTo('settings'); App.rerender();
            setTimeout(() => { if (window.AccountSwitcher) AccountSwitcher.renderSection(); }, 200);
        },

        openSettings() {
            this.showSettingsModal();
        },

        recordDeposit() {
            const userPos = CORE.user?.pos;
            // FILTRER les livreurs par POS du vendeur, exclure supprimés et inactifs
            const _regLivreurs = CORE.getVisibleUsers().filter(u => u.role === 'livreur' && !u._deleted && u.active !== false && (u.pos == userPos || u.posId == userPos));
            const _indepLivreurs = (CORE.db.independentDeliveryMen || []).filter(dm => dm.posId == userPos && !dm._deleted && dm.approvalStatus === 'approved' && dm.status === 'active').map(dm => ({ id: dm.id, name: dm.name + ' (Indépendant)' }));
            const livreurOptions = [..._regLivreurs, ..._indepLivreurs].map(u => ({ value: u.id, label: u.name }));
            const today = new Date().toISOString().split('T')[0];

            UI.modal('📥 Enregistrer Dépôt Livreur', `
                <div class="space-y-4">
                    ${livreurOptions.length === 0 ? '<div class="p-4 bg-amber-50 border border-amber-200 rounded-xl text-amber-700 text-sm font-bold">⚠️ Aucun livreur disponible pour ce point de vente</div>' : ''}
                    ${UI.select('dep_livreur', 'Livreur', livreurOptions, '', true)}
                    ${UI.input('dep_date', 'Date', 'date', today, '', true)}
                    ${UI.input('dep_amount', 'Montant', 'number', '', 'ex: 50000', true)}
                    ${UI.input('dep_ordersCount', 'Nombre de commandes', 'number', '', 'ex: 5', true)}
                    ${UI.input('dep_ordersRef', 'Références commandes', 'text', '', 'ex: CMD001, CMD002', false)}
                    ${UI.textarea('dep_notes', 'Notes', '', 'facultatif')}
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-xl text-xs text-blue-700">
                        💡 Sélectionnez le livreur et la date pour remplissage automatique des commandes
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'VendeurModule.saveDeposit()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);

            // Ajouter event listener au select du livreur et à la date
            setTimeout(() => {
                const livreurSelect = document.getElementById('dep_livreur');
                const dateInput = document.getElementById('dep_date');

                const fillOrdersData = () => {
                    const livreurId = parseId(livreurSelect.value);
                    const date = dateInput.value;

                    if (!livreurId || !date) return;

                    // Chercher les livraisons de ce livreur à cette date
                    const deliveries = CORE.getVisibleDeliveries().filter(d => {
                        if (d.livreurId != livreurId) return false;
                        const dDate = d.deliveredAt || d.actualDeliveryDate || d.deliveryDate || d.createdAt;
                        return dDate && dDate.split('T')[0] === date;
                    });

                    // Ne garder que les commandes COD non encore payées (pas déjà déposées)
                    const pendingDeliveries = deliveries.filter(d => {
                        const order = d.orderId ? (CORE.db.orders || []).find(o => o.id == d.orderId) : null;
                        if (!order) return true; // inclure si pas d'ordre trouvé
                        return order.paymentMethod === 'cod' && order.paymentStatus !== 'paid';
                    });

                    if (pendingDeliveries.length > 0) {
                        const ordersCount = pendingDeliveries.length;
                        const ordersRef = pendingDeliveries.map(d => d.orderRef).filter(Boolean).join(', ');
                        const totalAmount = pendingDeliveries.reduce((sum, d) => {
                            const order = d.orderId ? (CORE.db.orders || []).find(o => o.id == d.orderId) : null;
                            return sum + (order?.total || d.amount || 0);
                        }, 0);

                        document.getElementById('dep_ordersCount').value = ordersCount;
                        document.getElementById('dep_ordersRef').value = ordersRef;
                        document.getElementById('dep_amount').value = totalAmount;

                        UI.toast(`${ordersCount} commande(s) COD en attente — ${totalAmount.toLocaleString()} F`, 'success');
                    } else {
                        document.getElementById('dep_ordersCount').value = '';
                        document.getElementById('dep_ordersRef').value = '';
                        document.getElementById('dep_amount').value = '';
                        if (deliveries.length > 0) {
                            UI.toast('Toutes les commandes de ce livreur à cette date sont déjà déposées', 'info');
                        }
                    }
                };

                if (livreurSelect) livreurSelect.addEventListener('change', fillOrdersData);
                if (dateInput) dateInput.addEventListener('change', fillOrdersData);
            }, 100);
        },

        saveDeposit() {
            const livreurId = parseId(UI.val('dep_livreur'));
            const amount = parseFloat(UI.val('dep_amount')) || 0;
            const ordersCount = parseInt(UI.val('dep_ordersCount'), 10) || 0;
            const ordersRef = UI.val('dep_ordersRef');
            const notes = UI.val('dep_notes');
            const depositDate = UI.val('dep_date') || new Date().toISOString().split('T')[0];
            const vendeur = CORE.state.currentUser;
            // Chercher dans users ET independentDeliveryMen
            const livreur = CORE.getUser(livreurId) || (CORE.db.independentDeliveryMen || []).find(dm => dm.id === livreurId);

            if (!livreurId || !amount) return UI.toast('Veuillez remplir le livreur et le montant', 'warning');
            if (!livreur) return UI.toast('Livreur introuvable', 'error');
            if (amount < 0) return UI.toast('Le montant ne peut pas être négatif', 'error');

            CORE.db.deposits = CORE.db.deposits || [];
            const deposit = {
                id: CORE.uid(),
                timestamp: new Date().toISOString(),
                depositDate,
                livreurId,
                livreurName: livreur.name,
                vendeurId: vendeur.id,
                vendeurName: vendeur.name,
                amount,
                ordersCount,
                ordersRef: ordersRef || '',
                posId: vendeur.pos || 1,
                notes: notes || '',
                status: 'enregistre'
            };

            CORE.db.deposits.push(deposit);
            CORE.save();

            // Marquer les commandes COD associées comme payées et enregistrer les transactions
            if (ordersRef) {
                const refs = ordersRef.split(',').map(r => r.trim()).filter(Boolean);
                refs.forEach(ref => {
                    const order = (CORE.db.orders || []).find(o => o.reference === ref);
                    if (order && order.paymentMethod === 'cod' && order.paymentStatus !== 'paid') {
                        order.paymentStatus = 'paid';
                        order.updatedAt = new Date().toISOString();
                        CORE.save();
                        CORE.ensureSaleTransaction(order);
                    }
                });
            }
            // Aussi chercher par livreurId + date les livraisons COD non payées
            const depDeliveries = (CORE.db.deliveries || []).filter(dl => {
                if (dl.livreurId != livreurId) return false;
                if (dl.status !== 'livree') return false;
                const dlDate = (dl.deliveredAt || dl.createdAt || '').split('T')[0];
                return dlDate === depositDate;
            });
            depDeliveries.forEach(dl => {
                const order = dl.orderId ? (CORE.db.orders || []).find(o => String(o.id) == String(dl.orderId)) : null;
                if (order && order.paymentMethod === 'cod' && order.paymentStatus !== 'paid') {
                    order.paymentStatus = 'paid';
                    order.updatedAt = new Date().toISOString();
                    CORE.save();
                    CORE.ensureSaleTransaction(order);
                }
            });

            // Enregistrer la transaction financière du dépôt
            CORE.recordFinancialTransaction({
                type: 'income',
                category: 'depot_livreur',
                amount: amount,
                method: 'cash',
                ref: `DEP-${deposit.id}`,
                note: `Dépôt livreur: ${livreur.name} (${ordersCount} commande(s))`,
                depositId: deposit.id,
                posId: vendeur.pos || 1
            });

            // Log l'activité
            CORE.logActivity('deposit', 'deposits', deposit.id, {
                entityName: `Dépôt de ${livreur.name}`,
                description: `Montant: ${amount} FCFA, Commandes: ${ordersCount}`,
                amount: amount
            });

            UI.closeModal();
            UI.toast(`Dépôt de ${amount} FCFA enregistré — commandes COD marquées payées`, 'success');
            App.rerender();
        },

        showDepositsModal() {
            const deposits = CORE.db.deposits || [];
            const vendeur = CORE.state.currentUser;
            const userPos = CORE.user?.pos;
            // FILTRER par POS du vendeur
            const myDeposits = deposits.filter(d => d.vendeurId === vendeur.id && (d.posId == userPos || !d.posId));
            const totalAmount = myDeposits.reduce((sum, d) => sum + d.amount, 0);
            const totalOrders = myDeposits.reduce((sum, d) => sum + d.ordersCount, 0);

            const depositsHTML = myDeposits.length === 0
                ? '<div class="text-center text-slate-400 py-8">Aucun dépôt enregistré</div>'
                : myDeposits.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).map(d => `
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl space-y-2">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center">
                                    <i data-lucide="user" class="w-5 h-5 text-emerald-700"></i>
                                </div>
                                <div>
                                    <div class="font-black text-slate-900">${d.livreurName}</div>
                                    <div class="text-xs text-slate-500">${new Date(d.timestamp).toLocaleDateString('fr-FR')}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-black text-emerald-600 text-lg">${d.amount.toLocaleString()} F</div>
                                <div class="text-xs text-slate-500">${d.ordersCount} commande(s)</div>
                            </div>
                        </div>
                        ${d.ordersRef ? `<div class="text-xs text-slate-600">Commandes: ${d.ordersRef}</div>` : ''}
                        ${d.notes ? `<div class="text-xs text-slate-600 italic">Note: ${d.notes}</div>` : ''}
                        <div class="flex gap-2 pt-2">
                            <button onclick="VendeurModule.deleteDeposit(${d.id})" class="flex-1 px-3 py-1 bg-red-50 text-red-600 text-xs font-black rounded-lg hover:bg-red-100 transition">Supprimer</button>
                        </div>
                    </div>
                `).join('');

            UI.modal('📥 Historique des Dépôts', `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                            <div class="text-xs text-emerald-600 font-black uppercase mb-1">Total Dépôts</div>
                            <div class="text-2xl font-black text-emerald-700">${totalAmount.toLocaleString()} F</div>
                        </div>
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl">
                            <div class="text-xs text-blue-600 font-black uppercase mb-1">Total Commandes</div>
                            <div class="text-2xl font-black text-blue-700">${totalOrders}</div>
                        </div>
                    </div>
                    <div class="border-t border-slate-200 pt-4">
                        <div class="text-xs font-black text-slate-600 uppercase mb-3">Détail des dépôts</div>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            ${depositsHTML}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Nouveau Dépôt', onclick: 'VendeurModule.recordDeposit()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        deleteDeposit(depositId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce dépôt?')) return;
            CORE.db.deposits = CORE.db.deposits.filter(d => d.id !== depositId);
            CORE.save();
            CORE.logActivity('delete', 'deposits', depositId, 'Dépôt supprimé');
            UI.toast('Dépôt supprimé', 'success');
            this.showDepositsModal();
        },

        toggleLivreurActive(livreurId) {
            const l = CORE.getUser(livreurId);
            if (!l) {
                // Peut être un livreur indépendant
                const indep = (CORE.db.independentDeliveryMen || []).find(dm => String(dm.id) == String(livreurId));
                if (indep) {
                    indep.status = indep.status === 'active' ? 'inactive' : 'active';
                    indep.updatedAt = new Date().toISOString();
                    CORE.markDirty('independentDeliveryMen');
                    CORE.save();
                    UI.toast(indep.status === 'active' ? 'Livreur activé' : 'Livreur désactivé', 'info');
                    App.rerender();
                }
                return;
            }
            if (l.role !== 'livreur') return;
            CORE.update('users', l.id, { active: !l.active });
            UI.toast(!l.active ? 'Livreur désactivé' : 'Livreur activé', 'info');
            App.rerender();
        },

        copyToClipboard(text) {
            if (!text) return UI.toast('Aucune donnée à copier', 'warning');
            if (navigator.clipboard?.writeText) {
                navigator.clipboard.writeText(text).then(() => UI.toast('Copié', 'success')).catch(() => UI.toast('Impossible de copier', 'error'));
            } else {
                // fallback
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                try { document.execCommand('copy'); UI.toast('Copié', 'success'); }
                catch { UI.toast('Impossible de copier', 'error'); }
                ta.remove();
            }
        },

        callLivreur(livreurId) {
            let l = CORE.getUser(livreurId);
            if (!l) l = (CORE.db.independentDeliveryMen || []).find(dm => String(dm.id) == String(livreurId));
            const phone = (l?.phone || '').trim();
            if (!phone) return UI.toast('Numéro de téléphone manquant', 'warning');
            // Créer un lien temporaire pour ouvrir le composeur téléphone
            const a = document.createElement('a');
            a.href = `tel:${phone}`;
            a.target = '_blank';
            a.rel = 'noopener';
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => a.remove(), 100);
        },

        showEditLivreurModal(livreurId) {
            // Vérifier si c'est un livreur indépendant
            const indep = (CORE.db.independentDeliveryMen || []).find(dm => String(dm.id) == String(livreurId));
            if (indep) {
                return this.editIndependentDeliveryMan(livreurId);
            }
            const l = CORE.getUser(livreurId);
            if (!l || l.role !== 'livreur') return;
            UI.modal(`Modifier le livreur`, `
                <div class="space-y-4">
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Livreur</div>
                        <div class="mt-1 font-black text-slate-900">${l.name}</div>
                    </div>

                    ${UI.input('edit_livreur_phone','Numéro de téléphone','tel', l.phone || '', CORE.getPhonePlaceholder(), true)}
                    <div class="text-xs text-slate-500">Le vendeur peut <b>modifier</b> ce numéro pour pouvoir appeler le livreur.</div>

                    ${UI.select('edit_livreur_vehicle','Véhicule',[{value:'moto',label:'Moto'},{value:'voiture',label:'Voiture'},{value:'velo',label:'Vélo'},{value:'',label:'—'}], l.vehicle || '')}
                    ${UI.input('edit_livreur_rating','Note (0-5)','number', l.rating ?? '', 'ex: 4.8')}

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">
                        Astuce: après modification, utilisez <b>Copier</b> ou <b>Appeler</b> depuis la liste.
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: `VendeurModule.saveLivreur(${l.id})`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        saveLivreur(livreurId) {
            // Vérifier si c'est un livreur indépendant
            const indep = (CORE.db.independentDeliveryMen || []).find(dm => String(dm.id) == String(livreurId));
            if (indep) {
                const phoneRaw = UI.val('edit_livreur_phone').trim();
                if (!phoneRaw) return UI.toast('Téléphone requis', 'warning');
                const phone = phoneRaw.replace(/\s+/g, ' ').trim();
                const digits = phone.replace(/[^0-9]/g, '');
                if (digits.length < 7) return UI.toast('Numéro de téléphone invalide', 'warning');
                const vehicle = UI.val('edit_livreur_vehicle').trim();
                const ratingRaw = UI.val('edit_livreur_rating');
                const rating = ratingRaw === '' ? null : Utils.clamp(parseFloat(ratingRaw), 0, 5);
                indep.phone = phone;
                indep.vehicle = vehicle || indep.vehicle || null;
                if (rating !== null) indep.rating = rating;
                indep.updatedAt = new Date().toISOString();
                CORE.markDirty('independentDeliveryMen');
                CORE.save();
                UI.closeModal();
                UI.toast('Téléphone du livreur mis à jour', 'success');
                App.rerender();
                return;
            }
            const l = CORE.getUser(livreurId);
            if (!l || l.role !== 'livreur') return;
            const phoneRaw = UI.val('edit_livreur_phone').trim();
            const vehicle = UI.val('edit_livreur_vehicle').trim();
            const ratingRaw = UI.val('edit_livreur_rating');
            const rating = ratingRaw === '' ? null : Utils.clamp(parseFloat(ratingRaw), 0, 5);

            if (!phoneRaw) return UI.toast('Téléphone requis', 'warning');

            // Normalisation + validation légère (évite les numéros vides / trop courts)
            const phone = phoneRaw.replace(/\s+/g, ' ').trim();
            const digits = phone.replace(/[^0-9]/g, '');
            if (digits.length < 7) return UI.toast('Numéro de téléphone invalide', 'warning');

            CORE.update('users', l.id, { phone, vehicle: vehicle || null, rating: rating ?? l.rating ?? null });
            UI.closeModal();
            UI.toast('Téléphone du livreur mis à jour', 'success');
            App.rerender();
        },

        renderLivreurRow(l) {
            const badge = !l.active ? UI.badge('Inactif', 'slate') : (l.activeCount || 0) > 0 ? UI.badge('En course', 'amber') : UI.badge('Disponible', 'emerald');
            const vehicle = l.vehicle ? `<div class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">${l.vehicle}</div>` : '';
            const phone = (l.phone || '').trim();

            const phoneLine = phone ? `
                <button onclick="VendeurModule.callLivreur('${l.id}')" class="mt-1 text-xs text-slate-600 flex items-center gap-2 hover:text-emerald-700 transition" title="Appeler">
                    <i data-lucide="phone" class="w-3.5 h-3.5 text-slate-400"></i>
                    <span class="font-bold underline decoration-dotted underline-offset-2">${phone}</span>
                </button>
            ` : `
                <div class="mt-1 text-xs text-amber-700 flex items-center gap-2">
                    <i data-lucide="alert-triangle" class="w-3.5 h-3.5"></i>
                    <span class="font-bold">Téléphone manquant</span>
                </div>
            `;

            const editLabel = phone ? 'Modifier téléphone' : 'Ajouter téléphone';

            return `
                <div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 flex items-start justify-between gap-4">
                    <div class="flex items-start gap-3 min-w-0">
                        <div class="w-12 h-12 gradient-livreur rounded-2xl flex items-center justify-center text-white font-black shrink-0">${l.avatar || (l.name||'?').slice(0,2).toUpperCase()}</div>
                        <div class="min-w-0">
                            <div class="flex items-center gap-2 flex-wrap">
                                <div class="font-black text-slate-900 truncate">${l.name}</div>
                                ${badge}
                            </div>
                            <div class="mt-1 grid grid-cols-2 gap-x-4 gap-y-1">
                                <div class="text-xs text-slate-500">Note: <span class="font-black">${l.rating || '—'}</span></div>
                                <div class="text-xs text-slate-500">Courses: <span class="font-black">${l.deliveryCount || '—'}</span></div>
                                <div class="text-xs text-slate-500 col-span-2">En cours: <span class="font-black">${l.activeCount ?? 0}</span></div>
                            </div>
                            ${vehicle}
                            ${phoneLine}
                            ${l.activeDelivery ? `<div class="mt-1 text-[11px] text-slate-600">Course: <b>${l.activeDelivery.orderRef}</b></div>` : ''}

                            <div class="mt-3 flex flex-wrap gap-2">
                                <button onclick="VendeurModule.showEditLivreurModal('${l.id}')" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-50">${editLabel}</button>
                                <button onclick="VendeurModule.copyToClipboard('${(phone || '').replace(/'/g, '&#39;')}')" class="px-3 py-2 rounded-xl bg-slate-100 text-xs font-black text-slate-700 hover:bg-slate-200">Copier</button>
                                <button onclick="VendeurModule.callLivreur('${l.id}')" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700">Appeler</button>
                            </div>
                        </div>
                    </div>

                    <div class="text-right space-y-2 shrink-0">
                        <button onclick="VendeurModule.toggleLivreurActive('${l.id}')" class="px-3 py-2 rounded-xl ${l.active ? 'bg-slate-100 text-slate-700 hover:bg-slate-200' : 'bg-emerald-600 text-white hover:bg-emerald-700'} text-xs font-black transition">
                            ${l.active ? 'Désactiver' : 'Activer'}
                        </button>
                        ${l.activeDelivery ? `<button onclick="VendeurModule.showDeliveryDetailModal(${l.activeDelivery.id})" class="w-full px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-50">Détails course</button>` : `<button onclick="UI.toast('Aucune course en cours', 'info')" class="w-full px-3 py-2 rounded-xl bg-slate-100 text-xs font-black text-slate-600">—</button>`}
                    </div>
                </div>`;
        },

        renderReservations() {
            const userPos = CORE.user?.pos;
            if (!userPos) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assigné</div></div>`;
            }

            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'POS ' + userPos;
            const q = (document.getElementById('reservations-search-input')?.value || '').toLowerCase().trim();
            const st = this.state.reservationsStatus || 'all';

            let res = CORE.getVisibleDeliveries()
                .filter(d => d.status === 'reservation' && (!d.posId || d.posId == userPos))
                .sort((a,b)=> {
                    const ad = (a.deliveryDate || a.createdAt || '');
                    const bd = (b.deliveryDate || b.createdAt || '');
                    return String(ad).localeCompare(String(bd));
                });

            if (q) {
                res = res.filter(d =>
                    (d.orderRef || '').toLowerCase().includes(q) ||
                    (d.clientName || '').toLowerCase().includes(q) ||
                    (d.address || '').toLowerCase().includes(q)
                );
            }

            // filtre simple: all | today | upcoming
            const todayKey = Utils.todayKey();
            if (st === 'today') {
                res = res.filter(d => (d.deliveryDate || '').startsWith(todayKey));
            }
            if (st === 'upcoming') {
                res = res.filter(d => {
                    const dd = (d.deliveryDate || '').trim();
                    return dd && dd >= todayKey;
                });
            }

            return `
                <div class="fade-in max-w-6xl mx-auto space-y-6">
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">Réservations</h2>
                            <p class="text-slate-500 font-medium">${posName} - Livraisons futures (non assignées)</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                <input id="reservations-search-input" type="text" value="${this.state.reservationsSearch}" onkeyup="VendeurModule.updateReservationsSearch(this.value)" placeholder="Ref, client, adresse..." class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" style="direction: ltr; text-align: left;" autocomplete="off">
                            </div>
                            <select onchange="VendeurModule.state.reservationsStatus=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                ${[
                                    {value:'all',label:'Toutes'},
                                    {value:'today',label:"Aujourd'hui"},
                                    {value:'upcoming',label:'À venir'}
                                ].map(o=>`<option value="${o.value}" ${o.value===this.state.reservationsStatus?'selected':''}>${o.label}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <div class="text-sm font-black text-slate-700">${res.length} réservation(s)</div>
                            <button onclick="VendeurModule.showReservationModal()" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-black hover:bg-emerald-700 transition text-xs">Nouvelle réservation</button>
                        </div>
                        <div class="p-4 space-y-2">
                            ${res.length === 0 ? `<div class="p-10 text-center text-slate-400 font-medium">Aucune réservation</div>` : ''}
                            ${res.map(d => {
                                const when = (d.deliveryDate ? d.deliveryDate : '—') + (d.deliveryTime ? ' ' + d.deliveryTime : '');
                                return `
                                <div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 flex items-start justify-between gap-4">
                                    <div class="min-w-0">
                                        <div class="flex items-center gap-2 flex-wrap">
                                            <div class="font-black text-slate-900">${d.orderRef}</div>
                                            ${UI.badge('Réservation', 'purple')}
                                        </div>
                                        <div class="text-xs text-slate-500 truncate">${d.clientName || '—'} • ${d.address || '—'}</div>
                                        <div class="mt-1 text-xs text-emerald-700 font-black">Prévu: ${when}</div>
                                    </div>
                                    <div class="text-right shrink-0">
                                        <div class="font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                                        <div class="mt-2 flex flex-wrap gap-2 justify-end">
                                            <button onclick="VendeurModule.showEditDeliveryModal(${d.id})" class="px-3 py-2 rounded-xl bg-slate-100 text-xs font-black text-slate-700 hover:bg-slate-200">Modifier</button>
                                            <button onclick="VendeurModule.showAssignDeliveryModal(${d.id})" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-black hover:bg-slate-800">Assigner</button>
                                            <button onclick="VendeurModule.showAssignDeliveryModal(${d.id});UI.toast('Sélectionnez le livreur puis cliquez sur SMS', 'info')" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700">Assigner + SMS</button>
                                        </div>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        },

        renderClients() {
            const user = CORE.state.currentUser;
            const userPos = CORE.user?.pos;
            const visibleClients = CORE.getVisibleClients() || [];
            const visibleOrders = CORE.getVisibleOrders() || [];

            // Déterminer les clients à afficher selon le rôle
            let clients = [];
            let posName = '';
            let allClientsForStats = [];

            if (user?.role === 'pdg' || user?.role === 'manager') {
                // PDG/Manager: voir tous les clients
                clients = visibleClients;
                posName = 'Tous les POS';
                allClientsForStats = clients;
            } else {
                // Autres rôles: voir les clients du POS assigné seulement
                if (!userPos) {
                    return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assigné</div></div>`;
                }
                const posData = CORE.getPOS(userPos);
                posName = posData?.name || 'POS ' + userPos;
                clients = visibleClients.filter(c => c.posId == userPos) || [];
                allClientsForStats = clients;
            }

            const q = (document.getElementById('vendeur-clients-search-input')?.value || '').toLowerCase().trim();
            clients = clients
                .filter(c => !q || (c.name || '').toLowerCase().includes(q) || (c.phone || '').toLowerCase().includes(q) || (c.address || '').toLowerCase().includes(q))
                .sort((a, b) => {
                    const aVip = (a.segment === 'vip') ? 0 : 1;
                    const bVip = (b.segment === 'vip') ? 0 : 1;
                    if (aVip !== bVip) return aVip - bVip;
                    return new Date(b.lastPurchaseDate || 0) - new Date(a.lastPurchaseDate || 0);
                });

            const totalClients = allClientsForStats.length;
            const vipClients = allClientsForStats.filter(c => c.segment === 'vip').length;
            const totalSpent = allClientsForStats.reduce((a, c) => a + (c.totalSpent || 0), 0);
            const avgSpent = totalClients > 0 ? Math.round(totalSpent / totalClients) : 0;

            return `
                <div class="fade-in max-w-6xl mx-auto space-y-6 pb-20">
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h1 class="text-3xl font-black text-slate-800">Gestion des Clients</h1>
                            <p class="text-slate-500 font-medium">${posName} - ${totalClients} client(s)</p>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="VendeurModule.showNewClientModal()" class="px-6 py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-700 transition flex items-center gap-2">
                                <i data-lucide="plus" class="w-5 h-5"></i> Nouveau client
                            </button>
                            <button onclick="VendeurModule.showClientPickerModal()" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition flex items-center gap-2">
                                <i data-lucide="search" class="w-5 h-5"></i> Sélectionner
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-3xl p-5 border border-blue-200">
                            <div class="text-xs text-blue-600 font-black uppercase tracking-wider mb-2">Total Clients</div>
                            <div class="text-3xl font-black text-blue-700">${totalClients}</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-3xl p-5 border border-purple-200">
                            <div class="text-xs text-purple-600 font-black uppercase tracking-wider mb-2">Clients VIP</div>
                            <div class="text-3xl font-black text-purple-700">${vipClients}</div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-green-50 rounded-3xl p-5 border border-emerald-200">
                            <div class="text-xs text-emerald-600 font-black uppercase tracking-wider mb-2">Total Dépensé</div>
                            <div class="text-3xl font-black text-emerald-700">${CORE.formatPrice(totalSpent).split(' ')[0]}</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-3xl p-5 border border-amber-200">
                            <div class="text-xs text-amber-600 font-black uppercase tracking-wider mb-2">Moyenne/Client</div>
                            <div class="text-3xl font-black text-amber-700">${CORE.formatPrice(avgSpent).split(' ')[0]}</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                            <div>
                                <h2 class="font-black text-slate-900">Tous les clients</h2>
                                <p class="text-xs text-slate-500 mt-1">Cliquez sur un client pour voir ses détails et modifier ses paramètres</p>
                            </div>
                            <div class="relative">
                                <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                <input id="vendeur-clients-search-input" type="text" value="${this.state.clientsSearch || ''}" onkeyup="VendeurModule.updateClientsSearch(this.value)" placeholder="Nom, téléphone, adresse..." class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium" style="direction: ltr; text-align: left;" autocomplete="off">
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50 border-b border-slate-200">
                                    <tr class="text-xs font-black text-slate-600 uppercase tracking-wider">
                                        <th class="px-6 py-3 text-left">Nom</th>
                                        <th class="px-6 py-3 text-left">Téléphone</th>
                                        <th class="px-6 py-3 text-left">Adresse</th>
                                        <th class="px-6 py-3 text-right">Commandes</th>
                                        <th class="px-6 py-3 text-right">Total Dépensé</th>
                                        <th class="px-6 py-3 text-center">Segment</th>
                                        <th class="px-6 py-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${clients.length === 0 ? `
                                        <tr>
                                            <td colspan="7" class="px-6 py-10 text-center text-slate-400 font-medium">
                                                Aucun client trouvé. <a href="javascript:VendeurModule.showNewClientModal()" class="text-blue-600 font-bold hover:underline">Créer un nouveau client</a>
                                            </td>
                                        </tr>
                                    ` : ''}
                                    ${clients.map(c => {
                                        const orders = visibleOrders.filter(o => o.clientId === c.id && o.status === 'delivered');
                                        const totalSpent = orders.reduce((a, o) => a + (o.total || 0), 0);
                                        const isFavorite = this.isFavoriteClient(c.id);
                                        const tags = c.tags || [];
                                        const availableTags = CORE.db.clientTags || [];

                                        return `
                                            <tr class="hover:bg-slate-50 transition">
                                                <td class="px-6 py-4">
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-300 to-slate-400 flex items-center justify-center text-white font-black text-sm">
                                                            ${c.name.charAt(0).toUpperCase()}
                                                        </div>
                                                        <div>
                                                            <div class="font-bold text-slate-900">${c.name}</div>
                                                            ${c.segment === 'vip' ? '<span class="text-xs font-black text-purple-600 bg-purple-50 px-2 py-0.5 rounded-full">VIP</span>' : ''}
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-4 text-slate-700 font-medium">${c.phone || '—'}</td>
                                                <td class="px-6 py-4 text-slate-600 text-sm">${c.address || '—'}</td>
                                                <td class="px-6 py-4 text-right font-bold text-slate-900">${orders.length}</td>
                                                <td class="px-6 py-4 text-right font-bold text-emerald-600">${CORE.formatPrice(totalSpent)}</td>
                                                <td class="px-6 py-4 text-center">
                                                    ${c.segment === 'vip' ? '<span class="text-xs font-black bg-purple-100 text-purple-700 px-3 py-1 rounded-full">VIP</span>' :
                                                      c.segment === 'regular' ? '<span class="text-xs font-black bg-blue-100 text-blue-700 px-3 py-1 rounded-full">Régulier</span>' :
                                                      '<span class="text-xs font-black bg-slate-100 text-slate-700 px-3 py-1 rounded-full">Standard</span>'}
                                                </td>
                                                <td class="px-6 py-4 text-center">
                                                    <div class="flex items-center justify-center gap-2">
                                                        <button onclick="VendeurModule.toggleFavoriteClient(${c.id})" class="px-2 py-1 rounded text-sm font-bold hover:bg-yellow-50 transition" title="Ajouter/retirer des favoris">
                                                            ${isFavorite ? '⭐' : '☆'}
                                                        </button>
                                                        <button onclick="VendeurModule.showClientHistoryModal(${c.id})" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-xs font-bold hover:bg-blue-200 transition">Historique</button>
                                                        <button onclick="VendeurModule.showClientNotesModal(${c.id})" class="px-3 py-1 bg-purple-100 text-purple-700 rounded-lg text-xs font-bold hover:bg-purple-200 transition">Notes</button>
                                                        <button onclick="VendeurModule.showClientTagsModal(${c.id})" class="px-3 py-1 bg-amber-100 text-amber-700 rounded-lg text-xs font-bold hover:bg-amber-200 transition">Classer</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        },

        livreursSearchTimer: null,
        updateOrdersSearch(value) {
            // Mettre à jour le state
            this.state.ordersSearch = value;

            // Annuler le timer précédent
            if (this.ordersSearchTimer) clearTimeout(this.ordersSearchTimer);

            // Attendre 500ms avant de rerender pour laisser l'utilisateur taper
            this.ordersSearchTimer = setTimeout(() => {
                // Sauvegarder la position du curseur avant rerender
                const input = document.getElementById('orders-search-input');
                const cursorPos = input?.selectionStart || 0;

                // Rerender
                App.rerender();

                // Restaurer la position du curseur après rerender
                setTimeout(() => {
                    const newInput = document.getElementById('orders-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updatePOSSearch(value) {
            // Mettre à jour le state
            this.state.searchQuery = value;

            // Annuler le timer précédent
            if (this.posSearchTimer) clearTimeout(this.posSearchTimer);

            // Attendre 500ms avant de rerender pour laisser l'utilisateur taper
            this.posSearchTimer = setTimeout(() => {
                // Sauvegarder la position du curseur avant rerender
                const input = document.getElementById('pos-search-input');
                const cursorPos = input?.selectionStart || 0;

                // Rerender
                this.navigateTo('pos');

                // Restaurer la position du curseur après rerender
                setTimeout(() => {
                    const newInput = document.getElementById('pos-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateReservationsSearch(value) {
            // Mettre à jour le state
            this.state.reservationsSearch = value;

            // Annuler le timer précédent
            if (this.reservationsSearchTimer) clearTimeout(this.reservationsSearchTimer);

            // Attendre 500ms avant de rerender pour laisser l'utilisateur taper
            this.reservationsSearchTimer = setTimeout(() => {
                // Sauvegarder la position du curseur avant rerender
                const input = document.getElementById('reservations-search-input');
                const cursorPos = input?.selectionStart || 0;

                // Rerender
                App.rerender();

                // Restaurer la position du curseur après rerender
                setTimeout(() => {
                    const newInput = document.getElementById('reservations-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateClientsSearch(value) {
            // Mettre à jour le state
            this.state.clientsSearch = value;

            // Annuler le timer précédent
            if (this.clientsSearchTimer) clearTimeout(this.clientsSearchTimer);

            // Attendre 500ms avant de rerender
            this.clientsSearchTimer = setTimeout(() => {
                const input = document.getElementById('vendeur-clients-search-input');
                const cursorPos = input?.selectionStart || 0;

                App.rerender();

                setTimeout(() => {
                    const newInput = document.getElementById('vendeur-clients-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateDeliveriesSearch(value) {
            // Mettre à jour le state
            this.state.deliveriesSearch = value;

            // Annuler le timer précédent
            if (this.deliveriesSearchTimer) clearTimeout(this.deliveriesSearchTimer);

            // Attendre 500ms avant de rerender
            this.deliveriesSearchTimer = setTimeout(() => {
                const input = document.getElementById('vendeur-deliveries-search-input');
                const cursorPos = input?.selectionStart || 0;

                App.rerender();

                setTimeout(() => {
                    const newInput = document.getElementById('vendeur-deliveries-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateLivreursSearch(value) {
            // Mettre à jour le state immédiatement pour le filtre
            this.state.livreursSearch = value;

            // Annuler le timer précédent
            if (this.livreursSearchTimer) clearTimeout(this.livreursSearchTimer);

            // Attendre 300ms avant de rerender pour laisser l'utilisateur taper
            this.livreursSearchTimer = setTimeout(() => {
                App.rerender();
            }, 300);
        },

        renderLivreurs() {
            const userPos = CORE.user?.pos;
            if (!userPos) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assigné</div></div>`;
            }

            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'POS ' + userPos;
            const q = (this.state.livreursSearch || '').toLowerCase().trim();
            let livreurs = this.getLivreursForSeller();
            const visibleDeliveries = CORE.getVisibleDeliveries() || [];
            if (q) livreurs = livreurs.filter(l =>
                (l.name || '').toLowerCase().includes(q) ||
                (l.email || '').toLowerCase().includes(q) ||
                (l.phone || '').toLowerCase().includes(q) ||
                (l.username || '').toLowerCase().includes(q)
            );

            const activeCount = livreurs.filter(l => l.active).length;
            const availableCount = livreurs.filter(l => l.active && !l.isBusy).length;
            const busyCount = livreurs.filter(l => l.active && l.isBusy).length;

            // courses (toutes selon filtre) - FILTRÉES PAR POS
            const dq = (document.getElementById('vendeur-deliveries-search-input')?.value || '').toLowerCase().trim();
            const ds = this.state.deliveriesStatus || 'all';
            let deliveriesInProgress = visibleDeliveries
                .filter(d => {
                    // Filtre par POS (inclure si posId manquant pour compatibilité)
                    if (d.posId && d.posId != userPos) return false;
                    if (ds === 'all') return true;
                    if (ds === 'open') return ['en_cours','en_attente','probleme','reservation'].includes(d.status);
                    return d.status === ds;
                })
                .sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));

            if (dq) {
                deliveriesInProgress = deliveriesInProgress.filter(d =>
                    (d.orderRef || '').toLowerCase().includes(dq) ||
                    (d.clientName || '').toLowerCase().includes(dq) ||
                    (d.address || '').toLowerCase().includes(dq)
                );
            }

            return `
                <div class="fade-in max-w-6xl mx-auto space-y-6">
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">Livreurs</h2>
                            <p class="text-slate-500 font-medium">${posName} - Disponibilités et courses en cours</p>
                        </div>
                        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 flex-1 sm:flex-none">
                            <button onclick="VendeurModule.showIndependentDeliveryMenList()" class="px-4 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition flex items-center justify-center gap-2 text-sm whitespace-nowrap">
                                <i data-lucide="users" class="w-4 h-4"></i> Livreurs indépendants
                            </button>
                            <div class="relative flex-1 sm:flex-auto">
                                <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none"></i>
                                <input id="livreurs-search-input" placeholder="Saisissez le nom du livreur..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" type="text" autocomplete="off" onkeyup="VendeurModule.updateLivreursSearch(this.value)">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-3xl border border-slate-100 p-5">
                            <div class="text-xs text-slate-500 font-black uppercase tracking-wider">Livreurs actifs</div>
                            <div class="text-3xl font-black text-slate-900 mt-1">${activeCount}</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-100 p-5">
                            <div class="text-xs text-slate-500 font-black uppercase tracking-wider">Disponibles</div>
                            <div class="text-3xl font-black text-emerald-600 mt-1">${availableCount}</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-100 p-5">
                            <div class="text-xs text-slate-500 font-black uppercase tracking-wider">En course</div>
                            <div class="text-3xl font-black text-amber-600 mt-1">${busyCount}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                                <h3 class="font-black text-slate-900">Équipe de livraison</h3>
                                <div class="text-xs text-slate-400 font-bold">${livreurs.length} total</div>
                            </div>
                            <div class="p-4 space-y-2">
                                ${livreurs.length === 0 ? `
                                    <div class="p-10 text-center text-slate-400 font-medium">
                                        Aucun livreur trouvé.
                                        <div class="mt-2 text-xs">Astuce: ajoutez/activez un utilisateur avec le rôle <b>livreur</b>.</div>
                                    </div>` : ''}
                                ${livreurs.map(l => this.renderLivreurRow(l)).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-slate-100 flex flex-col gap-3">
                                <div class="flex items-center justify-between">
                                    <h3 class="font-black text-slate-900">Bons de livraison</h3>
                                    <div class="text-xs text-slate-400 font-bold">${deliveriesInProgress.length}</div>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <select onchange="VendeurModule.state.deliveriesStatus=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold text-xs">
                                        ${[
                                            {value:'all',label:'Tous'},
                                            {value:'open',label:'Ouverts'},
                                            {value:'en_attente',label:'À assigner'},
                                            {value:'en_cours',label:'En cours'},
                                            {value:'probleme',label:'Problème'},
                                            {value:'livree',label:'Livrée'},
                                            {value:'annulee',label:'Annulée'}
                                        ].map(o => `<option value="${o.value}" ${o.value===VendeurModule.state.deliveriesStatus?'selected':''}>${o.label}</option>`).join('')}
                                    </select>
                                    <div class="relative">
                                        <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                        <input id="vendeur-deliveries-search-input" type="text" value="${this.state.deliveriesSearch}" onkeyup="VendeurModule.updateDeliveriesSearch(this.value)" placeholder="Rechercher bon..." class="pl-10 pr-4 py-2 rounded-xl border border-slate-200 bg-white font-medium text-xs w-[220px] max-w-full" style="direction: ltr; text-align: left;" autocomplete="off">
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 space-y-2">
                                ${deliveriesInProgress.length === 0 ? `<div class="p-10 text-center text-slate-400 font-medium">Aucune course en cours</div>` : ''}
                                ${deliveriesInProgress.map(d => {
                                    const badge = d.status === 'livree' ? UI.badge('Livrée', 'emerald') :
                                                  d.status === 'probleme' ? UI.badge('Problème', 'red') :
                                                  d.status === 'en_attente' ? UI.badge('À assigner', 'blue') :
                                                  d.status === 'annulee' ? UI.badge('Annulée', 'slate') :
                                                  UI.badge('En cours', 'amber');
                                    const livreurName = CORE.getUser(d.livreurId)?.name || '—';
                                    const canRecall = d.livreurId && ['en_cours', 'probleme'].includes(d.status);
                                    const recalled = !!d.recalledAt;
                                    const recallCount = d.recallCount || (d.recallHistory?.length || 0);
                                    const isCancelled = d.status === 'annulee';
                                    const dId = d.id;

                                    return '<div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 flex items-start justify-between gap-4">' +
                                        '<div class="min-w-0">' +
                                        '<div class="flex items-center gap-2 flex-wrap">' +
                                        '<div class="font-black text-slate-900">' + d.orderRef + '</div>' +
                                        badge +
                                        (recallCount >= 2 ? UI.badge(recallCount + 'x rappelé', 'red') : (recalled ? UI.badge('Rappelé', 'amber') : '')) +
                                        '</div>' +
                                        '<div class="text-xs text-slate-500 truncate">' + d.clientName + ' • ' + d.address + '</div>' +
                                        (d.deliveryTime ? '<div class="mt-1 text-xs text-emerald-700 font-black">Heure: ' + d.deliveryTime + '</div>' : '') +
                                        '<div class="mt-1 text-xs text-slate-400">Livreur: <span class="font-black text-slate-700">' + livreurName + '</span></div>' +
                                        (d.recallReason ? '<div class="mt-1 text-[11px] text-amber-800 truncate"><b>Rappel:</b> ' + d.recallReason + '</div>' : '') +
                                        '</div>' +
                                        '<div class="text-right shrink-0">' +
                                        '<div class="font-black text-emerald-600">' + CORE.formatPrice(d.amount) + '</div>' +
                                        '<div class="mt-2 flex flex-wrap gap-2 justify-end">' +
                                        (String(d.livreurId || '').startsWith('idm_') ? '' : '<button onclick="VendeurModule.openChat(' + dId + ')" class="px-3 py-2 rounded-xl bg-indigo-50 text-indigo-600 border border-indigo-100 text-xs font-black hover:bg-indigo-100 flex items-center gap-1"><i data-lucide="message-circle" class="w-3 h-3"></i> Chat</button>') +
                                        '<button onclick="VendeurModule.showDeliveryDetailModal(' + dId + ')" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-50">Détails</button>' +
                                        '<button onclick="VendeurModule.showEditDeliveryModal(' + dId + ')" class="px-3 py-2 rounded-xl bg-slate-100 text-xs font-black text-slate-700 hover:bg-slate-200">Modifier</button>' +
                                        '<button onclick="VendeurModule.showAssignDeliveryModal(' + dId + ')" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-black hover:bg-slate-800">' + (isCancelled ? 'Réactiver' : 'Réassigner') + '</button>' +
                                        (canRecall ? '<button onclick="VendeurModule.showRecallDeliveryModal(' + dId + ')" class="px-3 py-2 rounded-xl bg-red-50 text-red-700 text-xs font-black hover:bg-red-100">Rappeler</button>' : '') +
                                        '</div>' +
                                        '</div>' +
                                        '</div>';
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>`;
        },

        renderRoutage() {
            const posId = CORE.user?.pos;
            if (!posId) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assigné</div></div>`;
            }

            const posData = CORE.getPOS(posId);
            const posName = posData?.name || 'POS ' + posId;
            const batch = RoutingEngine.suggestRouteBatch(posId, 15);

            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">🚗 Routage & Charge</h2>
                            <p class="text-slate-500 font-medium">${posName} - Équilibrage automatique des livraisons</p>
                        </div>
                        <button onclick="RoutingEngine.autoAssignBatch(${posId}, 15); UI.toast('${batch.filter(b => b.suggestion).length} livraisons assignées', 'success'); App.rerender()" class="px-4 py-3 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition flex items-center gap-2">
                            <i data-lucide="zap" class="w-5 h-5"></i> Assigner tout
                        </button>
                    </div>

                    <!-- Livraisons en attente -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 space-y-4">
                        <div class="flex items-center gap-2">
                            <h3 class="text-xl font-black text-slate-900">📦 À Affecter (${batch.length})</h3>
                            ${batch.length > 0 ? `<span class="px-3 py-1 bg-amber-100 text-amber-700 text-xs font-black rounded-full">${batch.filter(b => !b.suggestion).length} sans suggestion</span>` : ''}
                        </div>

                        ${batch.length === 0 ? `
                            <div class="p-10 text-center text-slate-400">
                                <i data-lucide="check-circle" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                <p class="font-bold">Toutes les livraisons sont assignées ✓</p>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${batch.map((item, idx) => {
                                    const d = item.delivery;
                                    const s = item.suggestion;
                                    const order = CORE.getVisibleOrders().find(o => o.id === d.orderId);
                                    const isExpress = order?.tags?.includes('express');
                                    const isVip = order?.tags?.includes('vip');

                                    return `
                                        <div class="p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 transition flex items-start gap-4">
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="text-sm font-black text-slate-900">${d.orderRef}</span>
                                                    ${isExpress ? `<span class="px-2 py-0.5 bg-red-100 text-red-700 text-xs font-black rounded">EXPRESS</span>` : ''}
                                                    ${isVip ? `<span class="px-2 py-0.5 bg-purple-100 text-purple-700 text-xs font-black rounded">VIP</span>` : ''}
                                                    <span class="text-sm font-black text-amber-600">Pri: ${item.priority.toFixed(1)}</span>
                                                </div>
                                                <div class="text-xs text-slate-500">${d.clientName} • ${d.address}</div>
                                                <div class="text-xs text-slate-400 mt-1">Montant: <b>${CORE.formatPrice(d.amount)}</b></div>
                                            </div>
                                            <div class="text-right shrink-0">
                                                ${s ? `
                                                    <div class="mb-2">
                                                        <div class="text-sm font-black text-emerald-700 mb-1">Suggéré:</div>
                                                        <div class="text-xs text-slate-600"><b>${s.name}</b></div>
                                                        <div class="text-xs text-slate-400">Charge: ${s.load.count}/${s.capacity}</div>
                                                    </div>
                                                    <button onclick="VendeurModule.assignDelivery(${d.id}, false); RoutingEngine.suggestRouteBatch(${posId}, 15); App.rerender()" class="w-full px-3 py-2 bg-emerald-600 text-white text-xs font-black rounded-lg hover:bg-emerald-700 transition">Assigner</button>
                                                ` : `
                                                    <div class="text-xs text-slate-400">
                                                        <i data-lucide="alert-circle" class="w-4 h-4 text-red-500 inline"></i> Aucun livreur disponible
                                                    </div>
                                                `}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>

                    <!-- Charge par livreur -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 space-y-4">
                        <h3 class="text-xl font-black text-slate-900">👥 Charge par Livreur</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${RoutingEngine.getAvailableLivreurs(posId).map(l => {
                                const load = l.load;
                                const percent = Math.min(100, (load.count / l.capacity) * 100);

                                return `
                                    <div class="p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 transition">
                                        <div class="font-bold text-slate-900 mb-2">${l.name}</div>
                                        <div class="text-xs text-slate-500 mb-3">${l.vehicle || 'N/A'}</div>
                                        <div class="flex items-center gap-2 mb-2">
                                            <div class="text-sm font-black text-slate-900">${load.count}/${l.capacity}</div>
                                            <div class="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
                                                <div class="h-full ${percent > 75 ? 'bg-red-500' : percent > 50 ? 'bg-amber-500' : 'bg-emerald-500'}" data-width="${percent}"></div>
                                            </div>
                                        </div>
                                        <div class="text-xs text-slate-500">Vol: <b>${CORE.formatPrice(load.volume)}</b></div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>`;
        },

        // =====================
        // FINANCE (Vendeur)
        // =====================
        renderFinance() {
            const uid = CORE.state.currentUser?.id;
            const view = CORE.state.financeView || 'overview';

            return view === 'overview' ? this.renderFinanceOverview() :
                   view === 'transactions' ? this.renderFinanceTransactions() :
                   view === 'statement' ? this.renderFinanceStatement() :
                   view === 'expenses' ? this.renderFinanceExpenses() :
                   view === 'income' ? this.renderFinanceIncome() :
                   view === 'budgets' ? this.renderFinanceBudgets() :
                   view === 'profitability' ? this.renderProfitabilityAnalysis() :
                   view === 'activity' ? this.renderFinanceActivity() : this.renderFinanceOverview();
        },

        renderFinanceOverview() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'Mon POS';
            const dateFrom = CORE.state.financeDateFrom || '';
            const dateTo = CORE.state.financeDateTo || '';

            const metrics = CORE.getFinancialMetrics(uid, dateFrom || null, dateTo || null, userPos);
            const cashFlow = CORE.getCashFlowByPeriod(uid, 'daily', userPos);
            const lastDays = Object.entries(cashFlow).slice(-7).map(([date, flow]) => ({
                date,
                ...flow
            }));

            const visibleTxs = CORE.getVisibleTransactions() || [];
            const visibleOrders = CORE.getVisibleOrders() || [];

            // Calculer les taxes une fois
            const taxes = CORE.calculateTaxesOwed(uid, null, null, userPos);

            // Stats par type de transaction - FILTRÉ PAR POS
            let allTxs = visibleTxs.filter(t => t.userId === uid && (t.posId == userPos || !t.posId));
            const incomeTxs = allTxs.filter(t => t.type === 'income');
            const expenseTxs = allTxs.filter(t => t.type === 'expense');

            // Stats par méthode de paiement
            const orders = visibleOrders.filter(o => o.posId == userPos);
            const paymentMethods = {
                cash: orders.filter(o => o.paymentMethod === 'cash').reduce((s, o) => s + (o.total || 0), 0),
                mobile: orders.filter(o => o.paymentMethod === 'mobile').reduce((s, o) => s + (o.total || 0), 0),
                card: orders.filter(o => o.paymentMethod === 'card').reduce((s, o) => s + (o.total || 0), 0),
                cod: orders.filter(o => o.paymentMethod === 'cod').reduce((s, o) => s + (o.total || 0), 0)
            };
            const totalPayments = Object.values(paymentMethods).reduce((a, b) => a + b, 0) || 1;

            // Top catégories de dépenses
            const expenseByCategory = {};
            expenseTxs.forEach(t => {
                const cat = t.category || 'autre';
                expenseByCategory[cat] = (expenseByCategory[cat] || 0) + (t.amount || 0);
            });
            const topExpenseCategories = Object.entries(expenseByCategory)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            // Dernières transactions
            const recentTxs = [...allTxs].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="CORE.state.financeView = '${v}'; App.rerender()" class="px-4 py-2.5 rounded-xl font-bold text-sm transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-500/30' : 'bg-white text-slate-600 hover:bg-slate-50 border border-slate-200'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-6">
                    <!-- Header avec navigation -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-emerald-500/30">
                                    <i data-lucide="wallet" class="w-6 h-6"></i>
                                </div>
                                Finance & Comptabilité
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">${posName} • Suivi complet des flux financiers</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aperçu', 'layout-grid', true)}
                            ${navBtn('transactions', 'Transactions', 'list')}
                            ${navBtn('income', 'Revenus', 'trending-up')}
                            ${navBtn('expenses', 'Dépenses', 'trending-down')}
                            ${navBtn('budgets', 'Budgets', 'pie-chart')}
                            ${navBtn('statement', 'États', 'file-text')}
                        </div>
                    </div>

                    <!-- Filtres Date -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <div class="flex flex-wrap items-end gap-4">
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Période du</label>
                                <input type="date" value="${dateFrom}"
                                    onchange="CORE.state.financeDateFrom = this.value; App.rerender()"
                                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none font-medium">
                            </div>
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Au</label>
                                <input type="date" value="${dateTo}"
                                    onchange="CORE.state.financeDateTo = this.value; App.rerender()"
                                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none font-medium">
                            </div>
                            <button onclick="CORE.state.financeDateFrom=''; CORE.state.financeDateTo=''; App.rerender()" class="px-4 py-2.5 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-200 transition">
                                Réinitialiser
                            </button>
                            <button onclick="VendeurModule.exportFinanceReport()" class="px-4 py-2.5 bg-emerald-600 text-white rounded-xl font-bold text-sm hover:bg-emerald-700 transition flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> Exporter
                            </button>
                        </div>
                    </div>

                    <!-- KPIs Principaux -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-5 text-white shadow-lg shadow-emerald-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-up" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Revenus</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(metrics.totalIncome)}</div>
                                <div class="text-xs opacity-70 mt-2">${incomeTxs.length} entrées</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl p-5 text-white shadow-lg shadow-red-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-down" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Dépenses</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(metrics.totalExpenses)}</div>
                                <div class="text-xs opacity-70 mt-2">${expenseTxs.length} sorties</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-5 text-white shadow-lg shadow-blue-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="bar-chart-3" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Bénéfice Net</span>
                                </div>
                                <div class="text-3xl font-black">${metrics.netProfit >= 0 ? '+' : ''}${CORE.formatPrice(metrics.netProfit)}</div>
                                <div class="text-xs opacity-70 mt-2">Marge: ${metrics.profitMargin}%</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-5 text-white shadow-lg shadow-amber-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="receipt" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Impôts Est.</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(taxes.taxesOwed)}</div>
                                <div class="text-xs opacity-70 mt-2">Taux: ${taxes.taxRate}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Grille principale -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Colonne gauche: Cash Flow + Répartition paiements -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Cash Flow 7 Derniers Jours -->
                            <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-black text-slate-900 flex items-center gap-2">
                                        <i data-lucide="activity" class="w-5 h-5 text-emerald-500"></i>
                                        Cash Flow - 7 Derniers Jours
                                    </h3>
                                    <div class="flex items-center gap-4 text-xs">
                                        <span class="flex items-center gap-1"><span class="w-3 h-3 bg-emerald-500 rounded-full"></span> Entrées</span>
                                        <span class="flex items-center gap-1"><span class="w-3 h-3 bg-red-500 rounded-full"></span> Sorties</span>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    ${lastDays.length === 0 ? '<div class="text-center py-8 text-slate-400">Aucune donnée disponible</div>' : lastDays.map(day => {
                                        const maxVal = Math.max(...lastDays.map(d => Math.max(d.income || 0, d.expenses || 0))) || 1;
                                        const incomeWidth = ((day.income || 0) / maxVal) * 100;
                                        const expenseWidth = ((day.expenses || 0) / maxVal) * 100;
                                        return `
                                            <div class="flex items-center gap-4 group hover:bg-slate-50 p-2 rounded-xl transition">
                                                <div class="w-20 text-sm font-bold text-slate-600">${day.date}</div>
                                                <div class="flex-1 space-y-1">
                                                    <div class="flex items-center gap-2">
                                                        <div class="h-4 bg-gradient-to-r from-emerald-400 to-emerald-500 rounded-full transition-all" style="width: ${incomeWidth}%"></div>
                                                        <span class="text-xs font-bold text-emerald-600">+${CORE.formatPrice(day.income || 0)}</span>
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <div class="h-4 bg-gradient-to-r from-red-400 to-red-500 rounded-full transition-all" style="width: ${expenseWidth}%"></div>
                                                        <span class="text-xs font-bold text-red-600">-${CORE.formatPrice(day.expenses || 0)}</span>
                                                    </div>
                                                </div>
                                                <div class="text-right min-w-[80px]">
                                                    <div class="text-sm font-black ${(day.income || 0) - (day.expenses || 0) >= 0 ? 'text-emerald-600' : 'text-red-600'}">
                                                        ${(day.income || 0) - (day.expenses || 0) >= 0 ? '+' : ''}${CORE.formatPrice((day.income || 0) - (day.expenses || 0))}
                                                    </div>
                                                    <div class="text-[10px] text-slate-400">Solde</div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>

                            <!-- Répartition par méthode de paiement -->
                            <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                <h3 class="text-lg font-black text-slate-900 flex items-center gap-2 mb-6">
                                    <i data-lucide="credit-card" class="w-5 h-5 text-blue-500"></i>
                                    Répartition par Méthode de Paiement
                                </h3>
                                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div class="text-center p-4 bg-slate-50 rounded-xl">
                                        <div class="w-12 h-12 bg-slate-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                            <i data-lucide="banknote" class="w-6 h-6 text-slate-600"></i>
                                        </div>
                                        <div class="text-lg font-black text-slate-900">${CORE.formatPrice(paymentMethods.cash)}</div>
                                        <div class="text-xs text-slate-500 font-bold">Cash</div>
                                        <div class="text-[10px] text-slate-400">${Math.round((paymentMethods.cash / totalPayments) * 100)}%</div>
                                    </div>
                                    <div class="text-center p-4 bg-blue-50 rounded-xl">
                                        <div class="w-12 h-12 bg-blue-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                            <i data-lucide="smartphone" class="w-6 h-6 text-blue-600"></i>
                                        </div>
                                        <div class="text-lg font-black text-blue-900">${CORE.formatPrice(paymentMethods.mobile)}</div>
                                        <div class="text-xs text-blue-700 font-bold">Mobile Money</div>
                                        <div class="text-[10px] text-blue-500">${Math.round((paymentMethods.mobile / totalPayments) * 100)}%</div>
                                    </div>
                                    <div class="text-center p-4 bg-indigo-50 rounded-xl">
                                        <div class="w-12 h-12 bg-indigo-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                            <i data-lucide="credit-card" class="w-6 h-6 text-indigo-600"></i>
                                        </div>
                                        <div class="text-lg font-black text-indigo-900">${CORE.formatPrice(paymentMethods.card)}</div>
                                        <div class="text-xs text-indigo-700 font-bold">Carte</div>
                                        <div class="text-[10px] text-indigo-500">${Math.round((paymentMethods.card / totalPayments) * 100)}%</div>
                                    </div>
                                    <div class="text-center p-4 bg-amber-50 rounded-xl">
                                        <div class="w-12 h-12 bg-amber-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                            <i data-lucide="truck" class="w-6 h-6 text-amber-600"></i>
                                        </div>
                                        <div class="text-lg font-black text-amber-900">${CORE.formatPrice(paymentMethods.cod)}</div>
                                        <div class="text-xs text-amber-700 font-bold">COD</div>
                                        <div class="text-[10px] text-amber-500">${Math.round((paymentMethods.cod / totalPayments) * 100)}%</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Colonne droite: Actions rapides + Top dépenses + Dernières transactions -->
                        <div class="space-y-6">
                            <!-- Actions rapides -->
                            <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 text-white">
                                <h3 class="text-lg font-black mb-4 flex items-center gap-2">
                                    <i data-lucide="zap" class="w-5 h-5 text-amber-400"></i>
                                    Actions Rapides
                                </h3>
                                <div class="space-y-3">
                                    <button onclick="VendeurModule.showNewExpenseModal()" class="w-full px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                        <i data-lucide="minus-circle" class="w-5 h-5"></i>
                                        Enregistrer une dépense
                                    </button>
                                    <button onclick="VendeurModule.showNewIncomeModal()" class="w-full px-4 py-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                        <i data-lucide="plus-circle" class="w-5 h-5"></i>
                                        Enregistrer un revenu
                                    </button>
                                    <button onclick="VendeurModule.showDepositsModal()" class="w-full px-4 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                        <i data-lucide="download" class="w-5 h-5"></i>
                                        Dépôts livreurs
                                    </button>
                                    <button onclick="VendeurModule.showTransferModal()" class="w-full px-4 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                        <i data-lucide="arrow-right-left" class="w-5 h-5"></i>
                                        Transfert de fonds
                                    </button>
                                </div>
                            </div>

                            <!-- Widget COD en attente de dépôt -->
                            ${this.renderPendingCODWidget()}

                            <!-- Top dépenses par catégorie -->
                            <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                <h3 class="text-lg font-black text-slate-900 flex items-center gap-2 mb-4">
                                    <i data-lucide="pie-chart" class="w-5 h-5 text-red-500"></i>
                                    Top Dépenses
                                </h3>
                                ${topExpenseCategories.length === 0 ? '<div class="text-center py-4 text-slate-400 text-sm">Aucune dépense enregistrée</div>' : `
                                    <div class="space-y-3">
                                        ${topExpenseCategories.map(([cat, amount], i) => {
                                            const colors = ['bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-yellow-500', 'bg-lime-500'];
                                            const maxAmount = topExpenseCategories[0][1] || 1;
                                            return `
                                                <div class="flex items-center gap-3">
                                                    <div class="w-8 h-8 ${colors[i]} rounded-lg flex items-center justify-center text-white text-xs font-black">${i + 1}</div>
                                                    <div class="flex-1">
                                                        <div class="flex justify-between mb-1">
                                                            <span class="text-sm font-bold text-slate-700 capitalize">${cat}</span>
                                                            <span class="text-sm font-black text-red-600">${CORE.formatPrice(amount)}</span>
                                                        </div>
                                                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                                            <div class="${colors[i]} h-full rounded-full" style="width: ${(amount / maxAmount) * 100}%"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `}
                                <button onclick="CORE.state.financeView = 'expenses'; App.rerender()" class="w-full mt-4 px-4 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-200 transition">
                                    Voir toutes les dépenses →
                                </button>
                            </div>

                            <!-- Dernières transactions -->
                            <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                <h3 class="text-lg font-black text-slate-900 flex items-center gap-2 mb-4">
                                    <i data-lucide="clock" class="w-5 h-5 text-slate-500"></i>
                                    Dernières Transactions
                                </h3>
                                <div class="space-y-3">
                                    ${recentTxs.length === 0 ? '<div class="text-center py-4 text-slate-400 text-sm">Aucune transaction</div>' : recentTxs.map(t => `
                                        <div class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded-lg transition">
                                            <div class="w-10 h-10 rounded-xl flex items-center justify-center ${t.type === 'income' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}">
                                                <i data-lucide="${t.type === 'income' ? 'arrow-down-left' : 'arrow-up-right'}" class="w-5 h-5"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="text-sm font-bold text-slate-900 truncate">${t.category || t.note || 'Transaction'}</div>
                                                <div class="text-xs text-slate-500">${CORE.formatDate(t.createdAt)}</div>
                                            </div>
                                            <div class="text-sm font-black ${t.type === 'income' ? 'text-emerald-600' : 'text-red-600'}">
                                                ${t.type === 'income' ? '+' : '-'}${CORE.formatPrice(t.amount)}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <button onclick="CORE.state.financeView = 'transactions'; App.rerender()" class="w-full mt-4 px-4 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-200 transition">
                                    Voir tout l'historique →
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
        },

        // Page détaillée des transactions
        renderFinanceTransactions() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            const dateFrom = CORE.state.financeDateFrom || '';
            const dateTo = CORE.state.financeDateTo || '';
            const filter = CORE.state.financeFilter || 'all';
            const search = CORE.state.financeSearch || '';

            // FILTRÉ PAR POS
            let txs = (CORE.getVisibleTransactions() || []).filter(t => t.userId === uid && (t.posId == userPos || !t.posId));

            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                fromDate.setHours(0, 0, 0, 0);
                txs = txs.filter(t => new Date(t.createdAt) >= fromDate);
            }
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                txs = txs.filter(t => new Date(t.createdAt) <= toDate);
            }
            if (filter !== 'all') {
                txs = txs.filter(t => t.type === filter);
            }
            if (search) {
                const q = search.toLowerCase();
                txs = txs.filter(t =>
                    (t.category || '').toLowerCase().includes(q) ||
                    (t.note || '').toLowerCase().includes(q) ||
                    (t.reference || '').toLowerCase().includes(q)
                );
            }

            txs = txs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            const totalIncome = txs.filter(t => t.type === 'income').reduce((s, t) => s + (t.amount || 0), 0);
            const totalExpense = txs.filter(t => t.type === 'expense').reduce((s, t) => s + (t.amount || 0), 0);

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="CORE.state.financeView = '${v}'; App.rerender()" class="px-4 py-2.5 rounded-xl font-bold text-sm transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-500/30' : 'bg-white text-slate-600 hover:bg-slate-50 border border-slate-200'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-slate-700 to-slate-800 rounded-2xl flex items-center justify-center text-white shadow-lg">
                                    <i data-lucide="list" class="w-6 h-6"></i>
                                </div>
                                Historique des Transactions
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">${txs.length} transaction(s) trouvée(s)</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aperçu', 'layout-grid')}
                            ${navBtn('transactions', 'Transactions', 'list', true)}
                            ${navBtn('income', 'Revenus', 'trending-up')}
                            ${navBtn('expenses', 'Dépenses', 'trending-down')}
                        </div>
                    </div>

                    <!-- Filtres et recherche -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <div class="flex flex-wrap items-end gap-4">
                            <div class="flex-1 min-w-[200px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Rechercher</label>
                                <div class="flex gap-2">
                                    <input type="text" id="finance-search-input" placeholder="Catégorie, note, référence..." value="${search}"
                                        onkeypress="if(event.key==='Enter'){CORE.state.financeSearch = this.value; App.rerender();}"
                                        class="flex-1 px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none font-medium">
                                    <button onclick="CORE.state.financeSearch = document.getElementById('finance-search-input').value; App.rerender()" class="px-4 py-2.5 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 transition">
                                        <i data-lucide="search" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="min-w-[150px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Type</label>
                                <select onchange="CORE.state.financeFilter = this.value; App.rerender()" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none font-medium">
                                    <option value="all" ${filter === 'all' ? 'selected' : ''}>Tous</option>
                                    <option value="income" ${filter === 'income' ? 'selected' : ''}>Revenus</option>
                                    <option value="expense" ${filter === 'expense' ? 'selected' : ''}>Dépenses</option>
                                </select>
                            </div>
                            <div class="min-w-[150px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Du</label>
                                <input type="date" value="${dateFrom}"
                                    onchange="CORE.state.financeDateFrom = this.value; App.rerender()"
                                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none font-medium">
                            </div>
                            <div class="min-w-[150px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Au</label>
                                <input type="date" value="${dateTo}"
                                    onchange="CORE.state.financeDateTo = this.value; App.rerender()"
                                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none font-medium">
                            </div>
                        </div>
                    </div>

                    <!-- Résumé -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-4 text-center">
                            <div class="text-xs font-bold text-emerald-600 uppercase tracking-wider mb-1">Total Revenus</div>
                            <div class="text-2xl font-black text-emerald-700">+${CORE.formatPrice(totalIncome)}</div>
                        </div>
                        <div class="bg-red-50 border border-red-200 rounded-2xl p-4 text-center">
                            <div class="text-xs font-bold text-red-600 uppercase tracking-wider mb-1">Total Dépenses</div>
                            <div class="text-2xl font-black text-red-700">-${CORE.formatPrice(totalExpense)}</div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4 text-center">
                            <div class="text-xs font-bold text-blue-600 uppercase tracking-wider mb-1">Solde Net</div>
                            <div class="text-2xl font-black ${totalIncome - totalExpense >= 0 ? 'text-blue-700' : 'text-red-700'}">${totalIncome - totalExpense >= 0 ? '+' : ''}${CORE.formatPrice(totalIncome - totalExpense)}</div>
                        </div>
                    </div>

                    <!-- Tableau des transactions -->
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4">Date</th>
                                        <th class="px-6 py-4">Type</th>
                                        <th class="px-6 py-4">Catégorie</th>
                                        <th class="px-6 py-4">Description</th>
                                        <th class="px-6 py-4">Référence</th>
                                        <th class="px-6 py-4 text-right">Montant</th>
                                        <th class="px-6 py-4 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${txs.length === 0 ? `<tr><td colspan="7" class="px-6 py-12 text-center text-slate-400 italic">Aucune transaction trouvée</td></tr>` : ''}
                                    ${txs.map(t => `
                                        <tr class="hover:bg-slate-50 transition">
                                            <td class="px-6 py-4 text-slate-600">${CORE.formatDate(t.createdAt)}</td>
                                            <td class="px-6 py-4">
                                                <span class="px-3 py-1.5 rounded-full text-xs font-bold ${
                                                    t.type === 'income' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'
                                                }">
                                                    ${t.type === 'income' ? '↓ Entrée' : '↑ Sortie'}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4 font-bold text-slate-900 capitalize">${t.category || '—'}</td>
                                            <td class="px-6 py-4 text-slate-600 max-w-[200px] truncate">${t.note || '—'}</td>
                                            <td class="px-6 py-4 text-xs text-slate-400 font-mono">${t.reference || '—'}</td>
                                            <td class="px-6 py-4 text-right font-black text-lg ${t.type === 'income' ? 'text-emerald-600' : 'text-red-600'}">
                                                ${t.type === 'income' ? '+' : '-'}${CORE.formatPrice(t.amount)}
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                <button onclick="VendeurModule.showTransactionDetail(${t.id})" class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition">
                                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                                </button>
                                                <button onclick="VendeurModule.deleteTransaction(${t.id})" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        },

        // Page des dépenses détaillées
        renderFinanceExpenses() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            // FILTRÉ PAR POS
            let expenses = ((CORE.getVisibleTransactions() || []).filter(t => t.userId === uid && t.type === 'expense' && (t.posId == userPos || !t.posId)) || [])
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            // Grouper par catégorie
            const byCategory = {};
            expenses.forEach(e => {
                const cat = e.category || 'autre';
                if (!byCategory[cat]) byCategory[cat] = { total: 0, count: 0, items: [] };
                byCategory[cat].total += e.amount || 0;
                byCategory[cat].count++;
                byCategory[cat].items.push(e);
            });

            const totalExpenses = expenses.reduce((s, e) => s + (e.amount || 0), 0);
            const categories = Object.entries(byCategory).sort((a, b) => b[1].total - a[1].total);

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="CORE.state.financeView = '${v}'; App.rerender()" class="px-4 py-2.5 rounded-xl font-bold text-sm transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-red-500 to-red-600 text-white shadow-lg shadow-red-500/30' : 'bg-white text-slate-600 hover:bg-slate-50 border border-slate-200'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-red-500/30">
                                    <i data-lucide="trending-down" class="w-6 h-6"></i>
                                </div>
                                Suivi des Dépenses
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Total: <span class="text-red-600 font-black">${CORE.formatPrice(totalExpenses)}</span> répartis en ${categories.length} catégorie(s)</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aperçu', 'layout-grid')}
                            ${navBtn('transactions', 'Transactions', 'list')}
                            ${navBtn('expenses', 'Dépenses', 'trending-down', true)}
                            <button onclick="VendeurModule.showNewExpenseModal()" class="px-4 py-2.5 bg-red-600 text-white rounded-xl font-bold text-sm hover:bg-red-700 transition flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Nouvelle dépense
                            </button>
                        </div>
                    </div>

                    <!-- Répartition par catégorie -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Graphique visuel -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="text-lg font-black text-slate-900 mb-6">Répartition par Catégorie</h3>
                            <div class="space-y-4">
                                ${categories.map(([cat, data], i) => {
                                    const percent = totalExpenses > 0 ? Math.round((data.total / totalExpenses) * 100) : 0;
                                    const colors = ['from-red-500 to-red-600', 'from-orange-500 to-orange-600', 'from-amber-500 to-amber-600', 'from-yellow-500 to-yellow-600', 'from-lime-500 to-lime-600', 'from-green-500 to-green-600', 'from-teal-500 to-teal-600', 'from-cyan-500 to-cyan-600'];
                                    return `
                                        <div class="space-y-2">
                                            <div class="flex justify-between items-center">
                                                <span class="font-bold text-slate-700 capitalize flex items-center gap-2">
                                                    <span class="w-3 h-3 bg-gradient-to-r ${colors[i % colors.length]} rounded-full"></span>
                                                    ${cat}
                                                </span>
                                                <span class="text-sm">
                                                    <span class="font-black text-red-600">${CORE.formatPrice(data.total)}</span>
                                                    <span class="text-slate-400 ml-2">(${percent}%)</span>
                                                </span>
                                            </div>
                                            <div class="h-4 bg-slate-100 rounded-full overflow-hidden">
                                                <div class="h-full bg-gradient-to-r ${colors[i % colors.length]} rounded-full transition-all" style="width: ${percent}%"></div>
                                            </div>
                                            <div class="text-xs text-slate-400">${data.count} transaction(s)</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Liste détaillée par catégorie -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm max-h-[600px] overflow-y-auto">
                            <h3 class="text-lg font-black text-slate-900 mb-6">Détail par Catégorie</h3>
                            <div class="space-y-6">
                                ${categories.map(([cat, data]) => `
                                    <div class="border-b border-slate-100 pb-4 last:border-0">
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="font-black text-slate-800 capitalize">${cat}</h4>
                                            <span class="text-lg font-black text-red-600">${CORE.formatPrice(data.total)}</span>
                                        </div>
                                        <div class="space-y-2">
                                            ${data.items.slice(0, 5).map(item => `
                                                <div class="flex items-center justify-between text-sm p-2 bg-slate-50 rounded-lg">
                                                    <div class="flex-1 min-w-0">
                                                        <div class="text-slate-600 truncate">${item.note || 'Sans description'}</div>
                                                        <div class="text-xs text-slate-400">${CORE.formatDate(item.createdAt)}</div>
                                                    </div>
                                                    <div class="font-bold text-red-600 ml-4">${CORE.formatPrice(item.amount)}</div>
                                                </div>
                                            `).join('')}
                                            ${data.items.length > 5 ? `<div class="text-xs text-slate-400 text-center">+ ${data.items.length - 5} autres transactions</div>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Tableau complet -->
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="p-4 border-b border-slate-200 bg-slate-50">
                            <h3 class="font-black text-slate-900">Toutes les Dépenses</h3>
                        </div>
                        <div class="overflow-x-auto max-h-[400px]">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3">Date</th>
                                        <th class="px-6 py-3">Catégorie</th>
                                        <th class="px-6 py-3">Description</th>
                                        <th class="px-6 py-3 text-right">Montant</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${expenses.map(e => `
                                        <tr class="hover:bg-red-50 transition">
                                            <td class="px-6 py-3 text-slate-600">${CORE.formatDate(e.createdAt)}</td>
                                            <td class="px-6 py-3 font-bold text-slate-900 capitalize">${e.category || '—'}</td>
                                            <td class="px-6 py-3 text-slate-600">${e.note || '—'}</td>
                                            <td class="px-6 py-3 text-right font-black text-red-600">-${CORE.formatPrice(e.amount)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        },

        // Page des revenus détaillés
        renderFinanceIncome() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            // FILTRÉ PAR POS
            let incomes = ((CORE.getVisibleTransactions() || []).filter(t => t.userId === uid && t.type === 'income' && (t.posId == userPos || !t.posId)) || [])
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            // Grouper par source/catégorie
            const bySource = {};
            incomes.forEach(i => {
                const src = i.category || 'vente';
                if (!bySource[src]) bySource[src] = { total: 0, count: 0, items: [] };
                bySource[src].total += i.amount || 0;
                bySource[src].count++;
                bySource[src].items.push(i);
            });

            // Stats des ventes
            const orders = (CORE.getVisibleOrders() || []).filter(o => o.posId == userPos);
            const totalSales = orders.reduce((s, o) => s + (o.total || 0), 0);
            const todayOrders = orders.filter(o => {
                const d = new Date(o.createdAt);
                const today = new Date();
                return d.toDateString() === today.toDateString();
            });
            const todaySales = todayOrders.reduce((s, o) => s + (o.total || 0), 0);

            const totalIncome = incomes.reduce((s, i) => s + (i.amount || 0), 0);
            const sources = Object.entries(bySource).sort((a, b) => b[1].total - a[1].total);

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="CORE.state.financeView = '${v}'; App.rerender()" class="px-4 py-2.5 rounded-xl font-bold text-sm transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg shadow-emerald-500/30' : 'bg-white text-slate-600 hover:bg-slate-50 border border-slate-200'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-emerald-500/30">
                                    <i data-lucide="trending-up" class="w-6 h-6"></i>
                                </div>
                                Suivi des Revenus
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Total enregistré: <span class="text-emerald-600 font-black">${CORE.formatPrice(totalIncome)}</span></p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aperçu', 'layout-grid')}
                            ${navBtn('transactions', 'Transactions', 'list')}
                            ${navBtn('income', 'Revenus', 'trending-up', true)}
                            <button onclick="VendeurModule.showNewIncomeModal()" class="px-4 py-2.5 bg-emerald-600 text-white rounded-xl font-bold text-sm hover:bg-emerald-700 transition flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Nouveau revenu
                            </button>
                        </div>
                    </div>

                    <!-- KPIs Ventes -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl p-5 text-white">
                            <div class="text-xs font-bold uppercase tracking-wider opacity-80 mb-2">Ventes Totales</div>
                            <div class="text-2xl font-black">${CORE.formatPrice(totalSales)}</div>
                            <div class="text-xs opacity-70 mt-1">${orders.length} commandes</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-5 text-white">
                            <div class="text-xs font-bold uppercase tracking-wider opacity-80 mb-2">Ventes Aujourd'hui</div>
                            <div class="text-2xl font-black">${CORE.formatPrice(todaySales)}</div>
                            <div class="text-xs opacity-70 mt-1">${todayOrders.length} commandes</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl p-5 text-white">
                            <div class="text-xs font-bold uppercase tracking-wider opacity-80 mb-2">Panier Moyen</div>
                            <div class="text-2xl font-black">${CORE.formatPrice(orders.length > 0 ? totalSales / orders.length : 0)}</div>
                            <div class="text-xs opacity-70 mt-1">Par commande</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-5 text-white">
                            <div class="text-xs font-bold uppercase tracking-wider opacity-80 mb-2">Autres Revenus</div>
                            <div class="text-2xl font-black">${CORE.formatPrice(totalIncome)}</div>
                            <div class="text-xs opacity-70 mt-1">${incomes.length} entrées</div>
                        </div>
                    </div>

                    <!-- Répartition par source -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="text-lg font-black text-slate-900 mb-6">Sources de Revenus</h3>
                            <div class="space-y-4">
                                ${sources.length === 0 ? '<div class="text-center py-8 text-slate-400">Aucun revenu enregistré</div>' : sources.map(([src, data], i) => {
                                    const percent = totalIncome > 0 ? Math.round((data.total / totalIncome) * 100) : 0;
                                    const colors = ['from-emerald-500 to-emerald-600', 'from-teal-500 to-teal-600', 'from-cyan-500 to-cyan-600', 'from-blue-500 to-blue-600', 'from-indigo-500 to-indigo-600'];
                                    return `
                                        <div class="space-y-2">
                                            <div class="flex justify-between items-center">
                                                <span class="font-bold text-slate-700 capitalize">${src}</span>
                                                <span class="font-black text-emerald-600">${CORE.formatPrice(data.total)} <span class="text-slate-400 text-sm">(${percent}%)</span></span>
                                            </div>
                                            <div class="h-4 bg-slate-100 rounded-full overflow-hidden">
                                                <div class="h-full bg-gradient-to-r ${colors[i % colors.length]} rounded-full" style="width: ${percent}%"></div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm max-h-[400px] overflow-y-auto">
                            <h3 class="text-lg font-black text-slate-900 mb-6">Derniers Revenus</h3>
                            <div class="space-y-3">
                                ${incomes.slice(0, 10).map(i => `
                                    <div class="flex items-center gap-3 p-3 bg-emerald-50 rounded-xl">
                                        <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center text-emerald-600">
                                            <i data-lucide="arrow-down-left" class="w-5 h-5"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-slate-900 capitalize">${i.category || 'Revenu'}</div>
                                            <div class="text-xs text-slate-500">${i.note || '—'} • ${CORE.formatDate(i.createdAt)}</div>
                                        </div>
                                        <div class="font-black text-emerald-600">+${CORE.formatPrice(i.amount)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>`;
        },

        // Page de gestion des budgets
        renderFinanceBudgets() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;

            // Budgets FILTRÉS PAR POS
            const budgets = CORE.db.budgets?.filter(b => b.userId === uid && (b.posId == userPos || !b.posId)) || [];

            // Calculer les dépenses par catégorie pour le mois en cours - FILTRÉ PAR POS
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const expenses = (CORE.getVisibleTransactions().filter(t =>
                t.userId === uid &&
                t.type === 'expense' &&
                (t.posId == userPos || !t.posId) &&
                new Date(t.createdAt) >= monthStart
            ) || []);

            const expenseByCategory = {};
            expenses.forEach(e => {
                const cat = e.category || 'autre';
                expenseByCategory[cat] = (expenseByCategory[cat] || 0) + (e.amount || 0);
            });

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="CORE.state.financeView = '${v}'; App.rerender()" class="px-4 py-2.5 rounded-xl font-bold text-sm transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow-lg shadow-purple-500/30' : 'bg-white text-slate-600 hover:bg-slate-50 border border-slate-200'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-purple-500/30">
                                    <i data-lucide="pie-chart" class="w-6 h-6"></i>
                                </div>
                                Gestion des Budgets
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Planifiez et suivez vos dépenses par catégorie</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aperçu', 'layout-grid')}
                            ${navBtn('budgets', 'Budgets', 'pie-chart', true)}
                            <button onclick="VendeurModule.showNewBudgetModal()" class="px-4 py-2.5 bg-purple-600 text-white rounded-xl font-bold text-sm hover:bg-purple-700 transition flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Nouveau budget
                            </button>
                        </div>
                    </div>

                    <!-- Budgets actifs -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${budgets.length === 0 ? `
                            <div class="col-span-full bg-white rounded-2xl border-2 border-dashed border-slate-200 p-12 text-center">
                                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i data-lucide="pie-chart" class="w-8 h-8 text-slate-400"></i>
                                </div>
                                <h3 class="text-lg font-black text-slate-900 mb-2">Aucun budget défini</h3>
                                <p class="text-slate-500 mb-4">Créez des budgets pour suivre vos dépenses par catégorie</p>
                                <button onclick="VendeurModule.showNewBudgetModal()" class="px-6 py-3 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition">
                                    Créer mon premier budget
                                </button>
                            </div>
                        ` : budgets.map(b => {
                            const spent = expenseByCategory[b.category] || 0;
                            const percent = b.amount > 0 ? Math.min(Math.round((spent / b.amount) * 100), 100) : 0;
                            const remaining = Math.max(b.amount - spent, 0);
                            const isOver = spent > b.amount;
                            return `
                                <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm ${isOver ? 'border-red-300 bg-red-50' : ''} relative group">
                                    <!-- Actions en haut à droite -->
                                    <div class="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onclick="VendeurModule.editBudget(${b.id})" class="p-1.5 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition" title="Modifier">
                                            <i data-lucide="edit-2" class="w-3.5 h-3.5"></i>
                                        </button>
                                        <button onclick="VendeurModule.deleteBudget(${b.id})" class="p-1.5 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition" title="Supprimer">
                                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                                        </button>
                                    </div>
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="font-black text-slate-900 capitalize">${b.category}</h4>
                                        <span class="px-2 py-1 rounded-full text-xs font-bold ${isOver ? 'bg-red-100 text-red-600' : percent >= 80 ? 'bg-amber-100 text-amber-600' : 'bg-emerald-100 text-emerald-600'}">
                                            ${isOver ? '⚠️ Dépassé!' : percent >= 80 ? '⚡ Attention' : '✓ OK'}
                                        </span>
                                    </div>
                                    <div class="space-y-3">
                                        <div class="flex justify-between text-sm">
                                            <span class="text-slate-500">Dépensé</span>
                                            <span class="font-black ${isOver ? 'text-red-600' : 'text-slate-900'}">${CORE.formatPrice(spent)}</span>
                                        </div>
                                        <div class="h-3 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full rounded-full transition-all ${isOver ? 'bg-gradient-to-r from-red-500 to-red-600' : percent >= 80 ? 'bg-gradient-to-r from-amber-500 to-amber-600' : 'bg-gradient-to-r from-purple-500 to-purple-600'}" style="width: ${Math.min(percent, 100)}%"></div>
                                        </div>
                                        <div class="flex justify-between text-sm">
                                            <span class="text-slate-500">Budget</span>
                                            <span class="font-bold text-slate-700">${CORE.formatPrice(b.amount)}</span>
                                        </div>
                                        <div class="flex justify-between text-sm">
                                            <span class="text-slate-500">Utilisé</span>
                                            <span class="font-bold ${isOver ? 'text-red-600' : percent >= 80 ? 'text-amber-600' : 'text-purple-600'}">${percent}%</span>
                                        </div>
                                        <div class="pt-3 border-t border-slate-100 flex justify-between">
                                            <span class="text-sm text-slate-500">Restant</span>
                                            <span class="font-black ${isOver ? 'text-red-600' : 'text-emerald-600'}">${isOver ? '-' : ''}${CORE.formatPrice(isOver ? spent - b.amount : remaining)}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <!-- Résumé des dépenses du mois -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                        <h3 class="text-lg font-black text-slate-900 mb-6">Dépenses du Mois en Cours</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            ${Object.entries(expenseByCategory).sort((a, b) => b[1] - a[1]).map(([cat, amount]) => `
                                <div class="text-center p-4 bg-slate-50 rounded-xl">
                                    <div class="text-lg font-black text-red-600">${CORE.formatPrice(amount)}</div>
                                    <div class="text-xs font-bold text-slate-600 capitalize mt-1">${cat}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
        },

        // Fonctions utilitaires pour la finance
        showNewIncomeModal() {
            const incomeCategories = [
                { value: 'vente', label: '🛒 Vente directe' },
                { value: 'service', label: '🔧 Service rendu' },
                { value: 'remboursement', label: '↩️ Remboursement reçu' },
                { value: 'depot_livreur', label: '📥 Dépôt livreur' },
                { value: 'investissement', label: '💼 Investissement/Capital' },
                { value: 'pret', label: '🏦 Prêt reçu' },
                { value: 'autre', label: '📋 Autre' }
            ];

            UI.modal('Nouveau Revenu', `
                <div class="space-y-4">
                    ${UI.input('vi_amount', 'Montant', 'number', '', 'ex: 50000', true)}
                    ${UI.select('vi_category', 'Source / Catégorie', incomeCategories, 'vente', true)}
                    ${UI.textarea('vi_note', 'Description', '', 'Détails du revenu...', 2)}
                    ${UI.input('vi_ref', 'Référence (optionnel)', 'text', '', 'Numéro de reçu...')}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'VendeurModule.saveNewIncome()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' }
            ]);
        },

        saveNewIncome() {
            const amount = parseFloat(UI.val('vi_amount')) || 0;
            const category = UI.val('vi_category') || 'autre';
            const note = UI.val('vi_note') || '';
            const reference = UI.val('vi_ref') || '';

            if (amount <= 0) {
                return UI.toast('Montant invalide', 'warning');
            }

            CORE.db.financialTransactions = CORE.db.financialTransactions || [];
            // P3-7: Use CORE.create() for CRDT stamps + cloud sync
            const viEntry = CORE.create('financialTransactions', {
                userId: CORE.state.currentUser?.id,
                posId: CORE.user?.pos,
                type: 'income',
                amount,
                category,
                note,
                reference
            });
            CORE.logAudit('create', 'income', viEntry.id, category, { description: `Revenu: ${CORE.formatPrice(amount)} - ${category}`, amount });
            UI.closeModal();
            UI.toast('Revenu enregistré avec succès', 'success');
            App.rerender();
        },

        showTransferModal() {
            UI.modal('Transfert de Fonds', `
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl text-sm text-blue-700">
                        <i data-lucide="info" class="w-4 h-4 inline mr-2"></i>
                        Enregistrez un transfert entre comptes ou vers un fournisseur
                    </div>
                    ${UI.input('vt_amount', 'Montant', 'number', '', 'ex: 100000', true)}
                    ${UI.select('vt_type', 'Type de transfert', [
                        { value: 'bank_deposit', label: '🏦 Dépôt en banque' },
                        { value: 'supplier_payment', label: '📦 Paiement fournisseur' },
                        { value: 'salary', label: '💼 Paiement salaire' },
                        { value: 'transfer_out', label: '➡️ Transfert sortant' },
                        { value: 'transfer_in', label: '⬅️ Transfert entrant' }
                    ], 'bank_deposit', true)}
                    ${UI.textarea('vt_note', 'Description', '', 'Détails du transfert...', 2)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'VendeurModule.saveTransfer()', class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700' }
            ]);
        },

        saveTransfer() {
            const amount = parseFloat(UI.val('vt_amount')) || 0;
            const type = UI.val('vt_type') || 'transfer_out';
            const note = UI.val('vt_note') || '';

            if (amount <= 0) {
                return UI.toast('Montant invalide', 'warning');
            }

            const isIncome = type === 'transfer_in';

            CORE.db.financialTransactions = CORE.db.financialTransactions || [];
            // P3-7: Use CORE.create() for CRDT stamps + cloud sync
            CORE.create('financialTransactions', {
                userId: CORE.state.currentUser?.id,
                posId: CORE.user?.pos,
                type: isIncome ? 'income' : 'expense',
                amount,
                category: type,
                note
            });
            UI.closeModal();
            UI.toast('Transfert enregistré', 'success');
            App.rerender();
        },

        showNewBudgetModal() {
            UI.modal('➕ Nouveau Budget', `
                <div class="space-y-4">
                    <div class="p-4 bg-purple-50 border border-purple-200 rounded-xl text-sm text-purple-700">
                        <i data-lucide="info" class="w-4 h-4 inline mr-2"></i>
                        Définissez un budget mensuel pour suivre vos dépenses par catégorie
                    </div>
                    ${UI.select('vb_category', 'Catégorie', [
                        { value: 'stock', label: '📦 Stock/Produits' },
                        { value: 'transport', label: '🚚 Transport' },
                        { value: 'salaire', label: '💼 Salaires' },
                        { value: 'loyer', label: '🏢 Loyer' },
                        { value: 'electricite', label: '⚡ électricité/Eau' },
                        { value: 'telephone', label: '📱 Téléphone/Internet' },
                        { value: 'maintenance', label: '🔧 Maintenance' },
                        { value: 'hygieneEntretien', label: '🧹 Hygiène/Entretien' },
                        { value: 'publicite', label: '📢 Publicité' },
                        { value: 'assurance', label: '🛡️ Assurance' },
                        { value: 'taxe', label: '💰 Taxes/Impôts' },
                        { value: 'banque', label: '🏦 Frais bancaires' },
                        { value: 'deplacement', label: '🚗 Déplacement' },
                        { value: 'formation', label: '📚 Formation' },
                        { value: 'equipement', label: '🛠️ Équipement' },
                        { value: 'autre', label: '📋 Autre' }
                    ], 'stock', true)}
                    ${UI.input('vb_amount', 'Budget mensuel (FCFA)', 'number', '', 'ex: 500000', true)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Créer le budget', onclick: 'VendeurModule.saveNewBudget()', class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700' }
            ]);
        },

        saveNewBudget() {
            const category = UI.val('vb_category');
            const amount = parseFloat(UI.val('vb_amount')) || 0;

            if (amount <= 0) {
                return UI.toast('Montant invalide', 'warning');
            }

            CORE.db.budgets = CORE.db.budgets || [];
            // P3-7: Use CORE.create() for CRDT stamps + cloud sync
            CORE.create('budgets', {
                userId: CORE.state.currentUser?.id,
                posId: CORE.user?.pos,
                category,
                amount
            });
            UI.closeModal();
            UI.toast('Budget créé avec succès', 'success');
            App.rerender();
        },

        editBudget(budgetId) {
            const budget = CORE.db.budgets?.find(b => b.id === budgetId);
            if (!budget) return UI.toast('Budget introuvable', 'error');

            const categories = [
                { value: 'stock', label: '📦 Stock/Produits' },
                { value: 'transport', label: '🚚 Transport' },
                { value: 'salaire', label: '💼 Salaires' },
                { value: 'loyer', label: '🏢 Loyer' },
                { value: 'electricite', label: '⚡ électricité/Eau' },
                { value: 'telephone', label: '📱 Téléphone/Internet' },
                { value: 'maintenance', label: '🔧 Maintenance' },
                { value: 'hygieneEntretien', label: '🧹 Hygiène/Entretien' },
                { value: 'publicite', label: '📢 Publicité' },
                { value: 'assurance', label: '🛡️ Assurance' },
                { value: 'taxe', label: '💰 Taxes/Impôts' },
                { value: 'banque', label: '🏦 Frais bancaires' },
                { value: 'deplacement', label: '🚗 Déplacement' },
                { value: 'formation', label: '📚 Formation' },
                { value: 'equipement', label: '🛠️ Équipement' },
                { value: 'autre', label: '📋 Autre' }
            ];

            UI.modal('✏️ Modifier Budget', `
                <div class="space-y-4">
                    <div class="p-4 bg-purple-50 border border-purple-200 rounded-xl">
                        <div class="text-xs font-bold text-purple-600 uppercase mb-1">Budget actuel</div>
                        <div class="text-2xl font-black text-purple-700 capitalize">${budget.category} - ${CORE.formatPrice(budget.amount)}</div>
                    </div>
                    ${UI.select('vbe_category', 'Catégorie', categories, budget.category, true)}
                    ${UI.input('vbe_amount', 'Nouveau montant mensuel', 'number', budget.amount, 'ex: 500000', true)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: `VendeurModule.updateBudget(${budgetId})`, class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700' }
            ]);
        },

        updateBudget(budgetId) {
            const category = UI.val('vbe_category');
            const amount = parseFloat(UI.val('vbe_amount')) || 0;

            if (amount <= 0) {
                return UI.toast('Montant invalide', 'warning');
            }

            const budgetIndex = CORE.db.budgets?.findIndex(b => b.id === budgetId);
            if (budgetIndex === -1) return UI.toast('Budget introuvable', 'error');

            CORE.db.budgets[budgetIndex].category = category;
            CORE.db.budgets[budgetIndex].amount = amount;
            CORE.db.budgets[budgetIndex].updatedAt = new Date().toISOString();

            CORE.save(true);
            UI.closeModal();
            UI.toast('Budget modifié avec succès', 'success');
            App.rerender();
        },

        deleteBudget(budgetId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce budget ?')) return;

            CORE.db.budgets = CORE.db.budgets?.filter(b => b.id !== budgetId) || [];
            CORE.save(true);
            UI.toast('Budget supprimé', 'success');
            App.rerender();
        },

        showTransactionDetail(txId) {
            const tx = CORE.getVisibleTransactions().find(t => t.id === txId);
            if (!tx) return UI.toast('Transaction introuvable', 'error');

            UI.modal('Détail Transaction', `
                <div class="space-y-4">
                    <div class="p-4 rounded-2xl ${tx.type === 'income' ? 'bg-emerald-50 border border-emerald-200' : 'bg-red-50 border border-red-200'}">
                        <div class="text-center">
                            <div class="text-xs font-bold uppercase tracking-wider ${tx.type === 'income' ? 'text-emerald-600' : 'text-red-600'} mb-2">
                                ${tx.type === 'income' ? 'ENTRÉE' : 'SORTIE'}
                            </div>
                            <div class="text-3xl font-black ${tx.type === 'income' ? 'text-emerald-700' : 'text-red-700'}">
                                ${tx.type === 'income' ? '+' : '-'}${CORE.formatPrice(tx.amount)}
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between py-2 border-b border-slate-100">
                            <span class="text-slate-500">Catégorie</span>
                            <span class="font-bold text-slate-900 capitalize">${tx.category || '—'}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-slate-100">
                            <span class="text-slate-500">Description</span>
                            <span class="font-bold text-slate-900">${tx.note || '—'}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-slate-100">
                            <span class="text-slate-500">Référence</span>
                            <span class="font-mono text-slate-600">${tx.reference || '—'}</span>
                        </div>
                        <div class="flex justify-between py-2">
                            <span class="text-slate-500">Date</span>
                            <span class="font-bold text-slate-900">${CORE.formatDate(tx.createdAt)} à ${CORE.formatTime(tx.createdAt)}</span>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' },
                { label: 'Supprimer', onclick: `VendeurModule.deleteTransaction(${txId})`, class: 'px-4 py-2 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700' }
            ]);
        },

        deleteTransaction(txId) {
            if (!confirm('Supprimer cette transaction ?')) return;
            CORE.db.financialTransactions = CORE.db.financialTransactions?.filter(t => t.id !== txId) || [];
            CORE.save(true);
            UI.closeModal();
            UI.toast('Transaction supprimée', 'success');
            App.rerender();
        },

        exportFinanceReport() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            // FILTRÉ PAR POS
            const txs = CORE.getVisibleTransactions().filter(t => t.userId === uid && (t.posId == userPos || !t.posId)) || [];
            const metrics = CORE.getFinancialMetrics(uid, null, null, userPos);

            let csv = 'Date,Type,Catégorie,Description,Référence,Montant\\n';
            txs.forEach(t => {
                csv += `"${CORE.formatDate(t.createdAt)}","${t.type}","${t.category || ''}","${(t.note || '').replace(/"/g, '""')}","${t.reference || ''}","${t.type === 'income' ? '+' : '-'}${t.amount}"\\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'rapport_financier_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
            UI.toast('Rapport exporté en CSV', 'success');
        },

        renderProfitabilityAnalysis() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'Mon POS';
            const byClient = CORE.getProfitByClient(uid);
            const byCategory = CORE.getProfitByCategory(uid);

            return `
                <div class="fade-in max-w-6xl mx-auto space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">📈 Analyse de Rentabilité</h2>
                            <p class="text-slate-500 font-medium mt-1">${posName} - Profit par client et par catégorie</p>
                        </div>
                        <button onclick="CORE.state.financeView = 'overview'; App.rerender()" class="px-4 py-2 bg-slate-200 text-slate-900 rounded-xl font-bold hover:bg-slate-300 transition">Retour</button>
                    </div>

                    <!-- Profit par Client -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm">
                        <h3 class="text-xl font-black text-slate-900 mb-4">👥 Top Clients par Profit</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50">
                                    <tr class="text-xs font-black text-slate-500 uppercase">
                                        <th class="px-4 py-3">Client</th>
                                        <th class="px-4 py-3 text-right">Commandes</th>
                                        <th class="px-4 py-3 text-right">Revenu</th>
                                        <th class="px-4 py-3 text-right">Dépenses</th>
                                        <th class="px-4 py-3 text-right">Profit</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${byClient.slice(0, 10).map(c => `
                                        <tr class="hover:bg-slate-50 transition">
                                            <td class="px-4 py-3 font-bold">${c.name}</td>
                                            <td class="px-4 py-3 text-right">${c.orderCount}</td>
                                            <td class="px-4 py-3 text-right text-emerald-600 font-bold">+${CORE.formatPrice(c.revenue)}</td>
                                            <td class="px-4 py-3 text-right text-red-600">-${CORE.formatPrice(c.expenses)}</td>
                                            <td class="px-4 py-3 text-right font-black ${c.profit > 0 ? 'text-blue-600' : 'text-red-600'}">${c.profit > 0 ? '+' : ''}${CORE.formatPrice(c.profit)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Profit par Catégorie -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm">
                        <h3 class="text-xl font-black text-slate-900 mb-4">📦 Profit par Catégorie</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${byCategory.map(cat => `
                                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                                    <div class="font-bold text-slate-900 mb-2">${cat.name}</div>
                                    <div class="text-2xl font-black text-blue-600">${CORE.formatPrice(cat.profit)}</div>
                                    <div class="text-xs text-slate-500 mt-2">${cat.orderCount} commandes • ${CORE.formatPrice(cat.revenue)} CA</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
        },

        renderFinanceStatement() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'Mon POS';
            const dateFrom = CORE.state.financeDateFrom || null;
            const dateTo = CORE.state.financeDateTo || null;
            // FILTRÉ PAR POS
            const stmt = CORE.getFinancialStatement(uid, dateFrom, dateTo, userPos);
            const taxes = CORE.calculateTaxesOwed(uid, dateFrom, dateTo, userPos);

            return `
                <div class="fade-in max-w-4xl mx-auto space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">📋 États Financiers</h2>
                            <p class="text-slate-500 font-medium mt-1">${posName} - Compte de résultat simplifié</p>
                        </div>
                        <button onclick="CORE.state.financeView = 'overview'; App.rerender()" class="px-4 py-2 bg-slate-200 text-slate-900 rounded-xl font-bold hover:bg-slate-300 transition">Retour</button>
                    </div>

                    <!-- Compte de Résultat (P&L) -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-8 shadow-sm space-y-6">
                        <div>
                            <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-6">Compte de Résultat</div>

                            <div class="space-y-4 border-b-2 border-slate-200 pb-6 mb-6">
                                <div class="flex justify-between items-center">
                                    <div class="font-bold text-slate-900">Ventes</div>
                                    <div class="text-right">
                                        <div class="font-bold text-emerald-600">${CORE.formatPrice(stmt.revenues.sales)}</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <div class="text-sm text-slate-600">Autres Revenus</div>
                                    <div class="text-right text-emerald-600">${CORE.formatPrice(stmt.revenues.other)}</div>
                                </div>
                                <div class="flex justify-between items-center font-black text-lg">
                                    <div>Total Revenus</div>
                                    <div class="text-emerald-600">${CORE.formatPrice(stmt.revenues.total)}</div>
                                </div>
                            </div>

                            <div class="space-y-4 border-b-2 border-slate-200 pb-6 mb-6">
                                <div class="flex justify-between items-center">
                                    <div class="font-bold text-slate-900">Commissions Livreurs</div>
                                    <div class="text-right">
                                        <div class="font-bold text-red-600">-${CORE.formatPrice(stmt.expenses.commissions)}</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <div class="text-sm text-slate-600">Frais Opérationnels</div>
                                    <div class="text-right text-red-600">-${CORE.formatPrice(stmt.expenses.operational)}</div>
                                </div>
                                <div class="flex justify-between items-center">
                                    <div class="text-sm text-slate-600">Autres Dépenses</div>
                                    <div class="text-right text-red-600">-${CORE.formatPrice(stmt.expenses.other)}</div>
                                </div>
                                <div class="flex justify-between items-center font-black text-lg">
                                    <div>Total Dépenses</div>
                                    <div class="text-red-600">-${CORE.formatPrice(stmt.expenses.total)}</div>
                                </div>
                            </div>

                            <div class="space-y-4 border-b-2 border-slate-200 pb-6 mb-6">
                                <div class="flex justify-between items-center font-bold text-lg">
                                    <div>Bénéfice Brut</div>
                                    <div class="text-blue-600">${CORE.formatPrice(stmt.grossProfit)}</div>
                                </div>
                            </div>

                            <div class="space-y-4 pb-6">
                                <div class="flex justify-between items-center">
                                    <div class="font-bold text-slate-900">Impôts (${stmt.taxRate})</div>
                                    <div class="text-right">
                                        <div class="font-bold text-orange-600">-${CORE.formatPrice(stmt.taxes)}</div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center font-black text-xl bg-emerald-50 p-4 rounded-2xl">
                                    <div>Bénéfice Net</div>
                                    <div class="text-emerald-600">${CORE.formatPrice(stmt.netProfit)}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Taxes Dues -->
                    <div class="bg-orange-50 border border-orange-200 rounded-3xl p-6">
                        <h3 class="text-lg font-black text-slate-900 mb-4">⚠️ Simulation d'Impôts</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <div class="text-sm text-slate-600 mb-1">Revenu imposable</div>
                                <div class="text-2xl font-black text-slate-900">${CORE.formatPrice(taxes.taxableIncome)}</div>
                            </div>
                            <div>
                                <div class="text-sm text-slate-600 mb-1">Impôts estimés</div>
                                <div class="text-2xl font-black text-orange-600">${CORE.formatPrice(taxes.taxesOwed)}</div>
                            </div>
                        </div>

                        <!-- Champs modifiables -->
                        <div class="border-t border-orange-200 pt-4">
                            <div class="text-xs font-black text-orange-700 uppercase mb-3">Paramètres personnalisés</div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-700 mb-1">Taux personnalisé (%)</label>
                                    <input type="number" id="custom_tax_rate" placeholder="${taxes.taxRate}" min="0" max="100" step="0.1" class="w-full px-3 py-2 border border-orange-300 rounded-lg bg-white text-sm font-bold focus:ring-2 focus:ring-orange-500 outline-none">
                                    <div class="text-[10px] text-slate-500 mt-1">Laisser vide pour valeur par défaut</div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-700 mb-1">Échéance (date)</label>
                                    <input type="date" id="custom_due_date" value="${taxes.dueDate}" class="w-full px-3 py-2 border border-orange-300 rounded-lg bg-white text-sm font-bold focus:ring-2 focus:ring-orange-500 outline-none">
                                </div>
                            </div>
                            <button onclick="VendeurModule.recalculateTaxes()" class="w-full mt-3 px-4 py-2 bg-orange-600 text-white rounded-lg font-black text-sm hover:bg-orange-700 transition flex items-center justify-center gap-2">
                                <i data-lucide="calculator" class="w-4 h-4"></i> Recalculer
                            </button>
                        </div>
                    </div>
                </div>`;
        },

        renderFinanceActivity() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'Mon POS';
            const dateFrom = CORE.state.financeDateFrom || '';
            const dateTo = CORE.state.financeDateTo || '';

            // FILTRÉ PAR POS
            let txs = CORE.getVisibleTransactions().filter(t => t.userId === uid && (t.posId == userPos || !t.posId));

            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                fromDate.setHours(0, 0, 0, 0);
                txs = txs.filter(t => new Date(t.createdAt) >= fromDate);
            }
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                txs = txs.filter(t => new Date(t.createdAt) <= toDate);
            }

            txs = txs.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

            return `
                <div class="fade-in max-w-5xl mx-auto space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">🔄 Activité Financière</h2>
                            <p class="text-slate-500 font-medium mt-1">${posName} - Historique détaillé de toutes les transactions</p>
                        </div>
                        <button onclick="CORE.state.financeView = 'overview'; App.rerender()" class="px-4 py-2 bg-slate-200 text-slate-900 rounded-xl font-bold hover:bg-slate-300 transition">Retour</button>
                    </div>

                    <!-- Filtres Date -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-slate-900 mb-2">De</label>
                                <input type="date" value="${dateFrom}"
                                    onchange="CORE.state.financeDateFrom = this.value; App.rerender()"
                                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-900 mb-2">Jusqu'à</label>
                                <input type="date" value="${dateTo}"
                                    onchange="CORE.state.financeDateTo = this.value; App.rerender()"
                                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                        ${dateFrom || dateTo ? `<div class="text-xs text-slate-500 mt-4">Affichage de ${txs.length} transaction(s)</div>` : ''}
                    </div>

                    <!-- Tableau Transactions -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                <tr>
                                    <th class="px-6 py-4">Type</th>
                                    <th class="px-6 py-4">Catégorie</th>
                                    <th class="px-6 py-4">Note</th>
                                    <th class="px-6 py-4 text-right">Montant</th>
                                    <th class="px-6 py-4 text-right">Date</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50">
                                ${txs.length === 0 ? `<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400 italic">Aucune transaction trouvée</td></tr>` : ''}
                                ${txs.map(t => `
                                    <tr class="hover:bg-slate-50 transition">
                                        <td class="px-6 py-4">
                                            <span class="px-3 py-1 rounded-full text-xs font-bold ${
                                                t.type === 'income' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'
                                            }">
                                                ${t.type === 'income' ? '📈 Revenu' : '📉 Dépense'}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 font-bold text-slate-900">${t.category || 'N/A'}</td>
                                        <td class="px-6 py-4">${t.note || 'N/A'}</td>
                                        <td class="px-6 py-4 text-right font-black ${t.type === 'income' ? 'text-emerald-600' : 'text-red-600'}">
                                            ${t.type === 'income' ? '+' : '-'}${CORE.formatPrice(t.amount)}
                                        </td>
                                        <td class="px-6 py-4 text-right text-xs text-slate-500">${CORE.formatDate(t.createdAt)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        },

        showTaxesModal() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.user?.pos;
            // FILTRÉ PAR POS
            const taxes = CORE.calculateTaxesOwed(uid, null, null, userPos);

            UI.modal('Simulation d\'Impôts', `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-blue-50 rounded-2xl border border-blue-200">
                            <div class="text-sm text-blue-700 font-bold mb-2">Revenu Imposable</div>
                            <div class="text-2xl font-black text-blue-900">${CORE.formatPrice(taxes.taxableIncome)}</div>
                        </div>
                        <div class="p-4 bg-orange-50 rounded-2xl border border-orange-200">
                            <div class="text-sm text-orange-700 font-bold mb-2">Impôts Estimés</div>
                            <div class="text-2xl font-black text-orange-900">${CORE.formatPrice(taxes.taxesOwed)}</div>
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-2xl">
                        <div class="text-sm text-slate-600 mb-2">Taux: <strong>${taxes.taxRate}</strong></div>
                        <div class="text-sm text-slate-600 mb-2">Échéance: <strong>${taxes.dueDate}</strong></div>
                        <div class="text-xs text-slate-500 pt-3 border-t border-slate-200 mt-3">
                            Cette estimation est basée sur vos transactions financières enregistrées. Consultez un expert-comptable pour validation.
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showNewExpenseModal() {
            const expenseCategories = [
                { value: 'stock', label: '📦 Achat de stock/produits' },
                { value: 'transport', label: '🚚 Frais de transport' },
                { value: 'salaire', label: '💼 Salaires' },
                { value: 'loyer', label: '🏢 Loyer/Local' },
                { value: 'electricite', label: '⚡ électricité/Eau' },
                { value: 'telephone', label: '📱 Téléphone/Internet' },
                { value: 'maintenance', label: '🔧 Maintenance/Réparation' },
                { value: 'hygieneEntretien', label: '🧹 Hygiène/Entretien' },
                { value: 'publicite', label: '📢 Publicité/Marketing' },
                { value: 'assurance', label: '🛡️ Assurance' },
                { value: 'taxe', label: '💰 Taxes/Impôts' },
                { value: 'banque', label: '🏦 Frais bancaires' },
                { value: 'deplacement', label: '🚗 Déplacement/Carburant' },
                { value: 'formation', label: '📚 Formation/Cours' },
                { value: 'equipement', label: '🛠️ Équipement/Matériel' },
                { value: 'autre', label: '📋 Autre' }
            ];

            UI.modal('Nouvelle dépense', `
                <div class="space-y-4">
                    ${UI.input('ve_amount', 'Montant', 'number', '', 'ex: 5000', true)}
                    ${UI.select('ve_category', 'Motif / Catégorie', expenseCategories, 'stock', true)}
                    ${UI.textarea('ve_note', 'Détails additionnels', '', 'ex: Achat de produits à Kinshasa le 15 Jan...', 2)}
                    ${UI.input('ve_ref', 'Référence (optionnel)', 'text', '', 'Ticket de caisse...')}
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">
                        Cette dépense sera enregistrée dans la comptabilité du point de vente en tant que "Sortie Cash".
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Valider', onclick: 'VendeurModule.saveExpense()', class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);
        },

        saveExpense() {
            const amount = Number(UI.val('ve_amount') || 0);
            const category = UI.val('ve_category') || 'autre';
            const note = UI.val('ve_note').trim();
            const ref = UI.val('ve_ref').trim();

            if (amount <= 0) return UI.toast('Montant invalide', 'warning');
            if (!category) return UI.toast('Veuillez sélectionner une catégorie', 'warning');

            // Construire la note complète avec la catégorie sélectionnée
            const categoryLabels = {
                'stock': 'Achat de stock/produits',
                'transport': 'Frais de transport',
                'salaire': 'Salaires',
                'loyer': 'Loyer/Local',
                'electricite': 'Électricité/Eau',
                'telephone': 'Téléphone/Internet',
                'maintenance': 'Maintenance/Réparation',
                'hygieneEntretien': 'Hygiène/Entretien',
                'publicite': 'Publicité/Marketing',
                'assurance': 'Assurance',
                'taxe': 'Taxes/Impôts',
                'banque': 'Frais bancaires',
                'deplacement': 'Déplacement/Carburant',
                'formation': 'Formation/Cours',
                'equipement': 'Équipement/Matériel',
                'autre': 'Autre'
            };

            const categoryLabel = categoryLabels[category] || category;
            const fullNote = `[${categoryLabel}] ${note}`;

            CORE.recordFinancialTransaction({
                type: 'expense',
                category: 'expense',
                amount,
                method: 'cash',
                ref,
                note: fullNote,
                posId: CORE.user?.pos,
                cityId: CORE.state.currentUser?.city,
                settled: true
            });
            CORE.logAudit('create', 'expense', Date.now(), categoryLabel, { description: `Dépense: ${CORE.formatPrice(amount)} - ${categoryLabel}`, amount });

            UI.closeModal();
            UI.toast('Dépense enregistrée', 'success');
            App.rerender();
        },

        recalculateTaxes() {
            const customTaxRate = document.getElementById('custom_tax_rate')?.value;
            const customDueDate = document.getElementById('custom_due_date')?.value;

            if (!customTaxRate && !customDueDate) {
                UI.toast('Veuillez modifier au moins un paramètre', 'warning');
                return;
            }

            // Sauvegarder les paramètres personnalisés
            this.state.customTaxRate = customTaxRate ? parseFloat(customTaxRate) : null;
            this.state.customDueDate = customDueDate || null;

            CORE.save();
            UI.toast('Paramétres d\'impét mises à jour ✓', 'success');
            App.rerender();
        },

        renderCommissions() {
            const userPos = CORE.user?.pos;
            if (!userPos) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assigné</div></div>`;
            }

            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'POS ' + userPos;
            const _regLiv = CORE.getVisibleUsers().filter(u => u.role === 'livreur' && u.active && (u.pos == userPos || u.posId == userPos));
            const _indepLiv = (CORE.db.independentDeliveryMen || []).filter(dm => dm.posId == userPos && dm.approvalStatus === 'approved' && dm.status === 'active').map(dm => ({ id: dm.id, name: dm.name + ' (Indépendant)', phone: dm.phone || '', vehicle: dm.vehicle || '', active: true, role: 'livreur', isIndependent: true }));
            const livreurs = [..._regLiv, ..._indepLiv];

            return `
                <div class="space-y-6 max-w-6xl fade-in">
                    <div>
                        <h2 class="text-2xl font-black text-slate-900">Gestion des Commissions</h2>
                        <p class="text-sm text-slate-500 font-medium mt-1">${posName} - Fixez les taux de commission pour chaque livreur.</p>
                    </div>

                    ${livreurs.length === 0 ? `
                        <div class="bg-white rounded-3xl border border-slate-200 p-12 text-center">
                            <div class="text-6xl mb-4">💰</div>
                            <div class="text-xl font-bold text-slate-700">Aucun livreur</div>
                            <p class="text-slate-500 mt-2">Aucun livreur n'est assigné à ${posName}</p>
                        </div>
                    ` : `
                        <div class="grid grid-cols-1 gap-4">
                            ${livreurs.map(l => {
                                const comm = CORE.getLivreurCommission(l.id);
                                const percent = comm?.commissionPercent || 5;
                                const fixed = comm?.commissionFixed || 0;
                                return `
                                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden hover:shadow-lg transition">
                                        <div class="p-6">
                                            <div class="flex items-center gap-4 mb-6">
                                                <div class="w-12 h-12 gradient-livreur rounded-2xl flex items-center justify-center text-white font-black text-lg">${l.avatar}</div>
                                                <div class="flex-1">
                                                    <div class="font-black text-slate-900 text-lg">${l.name}</div>
                                                    <div class="text-xs text-slate-500 font-bold">${l.vehicle || 'Véhicule non spécifié'}</div>
                                                </div>
                                                <button onclick="VendeurModule.editLivreurCommission(${l.id}, '${l.name}')" class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-black hover:bg-emerald-700 transition">
                                                    Modifier
                                                </button>
                                            </div>

                                            <div class="grid grid-cols-2 gap-4">
                                                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Commission %</div>
                                                    <div class="text-2xl font-black text-slate-900 mt-2">${percent}%</div>
                                                    <div class="text-[10px] text-slate-400 mt-1">du montant</div>
                                                </div>
                                                <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Commission Fixe</div>
                                                    <div class="text-2xl font-black text-slate-900 mt-2">${CORE.formatPrice(fixed)}</div>
                                                    <div class="text-[10px] text-slate-400 mt-1">par livraison</div>
                                                </div>
                                            </div>

                                            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-2xl">
                                                <div class="text-xs text-blue-700 font-bold">Exemple</div>
                                                <div class="text-sm text-blue-900 font-bold mt-1">Livraison de 50 000 FCFA = ${CORE.formatPrice(Math.round(50000 * (percent/100)) + fixed)}</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>`;
        },

        editLivreurCommission(livreurId, livreurName) {
            const comm = CORE.getLivreurCommission(livreurId);
            const percent = comm?.commissionPercent || 5;
            const fixed = comm?.commissionFixed || 0;

            UI.modal(`Modifier Commission - ${livreurName}`, `
                <div class="space-y-5">
                    <div>
                        <label class="text-sm font-black text-slate-700 block mb-2">Pourcentage (%)</label>
                        <div class="flex items-center gap-3">
                            <input type="number" id="comm_percent" value="${percent}" min="0" max="100" step="0.5" class="flex-1 px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                            <span class="text-2xl font-black text-slate-900">%</span>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Pourcentage appliqué au montant total de chaque livraison</p>
                    </div>

                    <div>
                        <label class="text-sm font-black text-slate-700 block mb-2">Commission Fixe (FCFA)</label>
                        <input type="number" id="comm_fixed" value="${fixed}" min="0" step="500" class="w-full px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500">
                        <p class="text-xs text-slate-500 mt-2">Montant fixe ajouté à chaque livraison</p>
                    </div>

                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                        <div class="text-xs font-black text-emerald-700 uppercase">Exemple Calculé</div>
                        <div class="mt-2 text-sm">
                            <div class="text-emerald-900 font-bold">Livraison 50 000 FCFA:</div>
                            <div class="text-emerald-700 mt-1">= (50 000 × <span id="percent_display">${percent}</span>%) + <span id="fixed_display">${CORE.formatPrice(fixed)}</span></div>
                            <div class="text-lg font-black text-emerald-900 mt-2">= <span id="total_display">${CORE.formatPrice(Math.round(50000 * (percent/100)) + fixed)}</span></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="document.getElementById('comm_percent').value=5; VendeurModule.updateCommissionPreview(${livreurId})" class="py-2 px-3 bg-slate-100 text-slate-700 rounded-lg text-xs font-black hover:bg-slate-200">5% (défaut)</button>
                        <button onclick="document.getElementById('comm_percent').value=10; VendeurModule.updateCommissionPreview(${livreurId})" class="py-2 px-3 bg-slate-100 text-slate-700 rounded-lg text-xs font-black hover:bg-slate-200">10%</button>
                        <button onclick="document.getElementById('comm_percent').value=15; VendeurModule.updateCommissionPreview(${livreurId})" class="py-2 px-3 bg-slate-100 text-slate-700 rounded-lg text-xs font-black hover:bg-slate-200">15%</button>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()', class: 'px-4 py-2 rounded-xl bg-slate-200 text-slate-700 font-black hover:bg-slate-300' },
                { label: 'Sauvegarder', onclick: `VendeurModule.saveLivreurCommission(${livreurId}, '${livreurName}')`, class: 'px-4 py-2 rounded-xl bg-emerald-600 text-white font-black hover:bg-emerald-700' }
            ]);
        },

        updateCommissionPreview(livreurId) {
            const percent = Number(document.getElementById('comm_percent')?.value || 5);
            const fixed = Number(document.getElementById('comm_fixed')?.value || 0);
            const sample = 50000;
            const total = Math.round(sample * (percent / 100)) + fixed;

            document.getElementById('percent_display').textContent = percent;
            document.getElementById('fixed_display').textContent = CORE.formatPrice(fixed);
            document.getElementById('total_display').textContent = CORE.formatPrice(total);
        },

        saveLivreurCommission(livreurId, livreurName) {
            const percent = Number(document.getElementById('comm_percent')?.value || 5);
            const fixed = Number(document.getElementById('comm_fixed')?.value || 0);

            if (percent < 0 || percent > 100) {
                UI.toast('Le pourcentage doit être entre 0 et 100', 'error');
                return;
            }

            if (fixed < 0) {
                UI.toast('La commission fixe ne peut pas être négative', 'error');
                return;
            }

            CORE.setLivreurCommission(livreurId, percent, fixed);
            UI.closeModal();
            UI.toast(`Commission de ${livreurName} mise à jour`, 'success');
            App.rerender();
        },

        showChangePersonalPasswordModal() {
            UI.modal('🔒 Changer votre mot de passe', `
                <div class="space-y-4">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl flex items-center gap-3">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-amber-600 flex-shrink-0"></i>
                        <div class="text-sm text-amber-800 font-medium">Utilisez un mot de passe fort (min 6 caractères)</div>
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Ancien mot de passe</label>
                        <input type="password" id="old_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Entrez votre ancien mot de passe">
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Nouveau mot de passe</label>
                        <input type="password" id="new_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Entrez un nouveau mot de passe">
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Confirmation du nouveau mot de passe</label>
                        <input type="password" id="confirm_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Confirmez le nouveau mot de passe">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Changer le mot de passe', onclick: 'VendeurModule.savePersonalPasswordChange()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' }
            ]);
        },

        async savePersonalPasswordChange() {
            const oldPwd = UI.val('old_pwd');
            const newPwd = UI.val('new_pwd');
            const confirmPwd = UI.val('confirm_pwd');
            const user = CORE.state.currentUser;

            if (!oldPwd || !newPwd || !confirmPwd) {
                UI.toast('Tous les champs sont obligatoires', 'error');
                return;
            }

            if (newPwd.length < 6) {
                UI.toast('Le nouveau mot de passe doit contenir au moins 6 caractères', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                UI.toast('Les mots de passe ne correspondent pas', 'error');
                return;
            }

            const oldPwdHash = await Utils.md5(oldPwd);
            if (user.passwordHash) {
                if (oldPwdHash !== user.passwordHash) {
                    UI.toast('Ancien mot de passe incorrect', 'error');
                    return;
                }
            } else if (user.password) {
                if (oldPwd !== user.password) {
                    UI.toast('Ancien mot de passe incorrect', 'error');
                    return;
                }
            } else {
                UI.toast('Impossible de vérifier le mot de passe', 'error');
                return;
            }

            const newPwdHash = await Utils.md5(newPwd);
            user.passwordHash = newPwdHash;

            const userIndex = CORE.getVisibleUsers().findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
                CORE.db.users[userIndex] = user;
                CORE.save();
                UI.closeModal();
                UI.toast('✓ Mot de passe changé avec succès', 'success');
                App.rerender();
            } else {
                UI.toast('Erreur lors de la mise à jour de l\'utilisateur', 'error');
            }
        },

        // Modal de configuration des preuves de validation de livraison
        showDeliveryValidationSettingsModal() {
            const user = CORE.state.currentUser;
            if (!user) return;

            const posId = user.pos;
            const settings = CORE.getDeliveryValidationSettings(posId);
            const posData = CORE.getPOS(posId);

            UI.modal('✓ Paramétres de validation des livraisons', `
                <div class="space-y-4">
                    <!-- En-tête info POS -->
                    <div class="p-4 bg-gradient-to-r from-teal-50 to-cyan-50 border border-teal-200 rounded-2xl">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-teal-500 rounded-xl flex items-center justify-center">
                                <i data-lucide="store" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-teal-900">${posData?.name || 'Point de vente'}</div>
                                <div class="text-xs text-teal-600">Ces paramètres s'appliquent aux livreurs de ce POS</div>
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="flex items-start gap-3">
                            <i data-lucide="info" class="w-5 h-5 text-blue-600 mt-0.5"></i>
                            <div class="text-sm text-blue-800">
                                Configurez les preuves que vos livreurs doivent fournir pour valider une livraison.
                                Ces paramètres affectent tous les livreurs assignés à ce point de vente.
                            </div>
                        </div>
                    </div>

                    <!-- Options principales -->
                    <div class="space-y-3">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Preuves requises</div>

                        <!-- Exiger photo -->
                        <div class="flex items-center justify-between p-4 rounded-xl bg-white border border-slate-200 hover:border-emerald-300 transition">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="camera" class="w-5 h-5 text-emerald-600"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-slate-800">Photos de livraison</div>
                                    <div class="text-xs text-slate-500">Le livreur doit prendre des photos</div>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="validation_require_photo" ${settings.requirePhoto ? 'checked' : ''} onchange="VendeurModule.toggleValidationPhotoOptions()" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                            </label>
                        </div>

                        <!-- Options photos (min photos) -->
                        <div id="photo_options_container" class="${settings.requirePhoto ? '' : 'hidden'} ml-6 p-3 bg-slate-50 rounded-xl border border-slate-200">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-slate-700">Nombre minimum de photos</span>
                                <select id="validation_min_photos" onchange="VendeurModule.updateValidationSummary()" class="px-3 py-1.5 rounded-lg border border-slate-200 text-sm font-bold">
                                    ${[1, 2, 3, 4, 5].map(n => `<option value="${n}" ${settings.minPhotos === n ? 'selected' : ''}>${n}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <!-- Exiger signature -->
                        <div class="flex items-center justify-between p-4 rounded-xl bg-white border border-slate-200 hover:border-blue-300 transition">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                    <span class="text-xl">✍️</span>
                                </div>
                                <div>
                                    <div class="font-bold text-slate-800">Signature client</div>
                                    <div class="text-xs text-slate-500">Le client doit signer sur l'écran</div>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="validation_require_signature" ${settings.requireSignature ? 'checked' : ''} onchange="VendeurModule.updateValidationSummary()" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
                            </label>
                        </div>

                        <!-- Exiger les deux -->
                        <div class="flex items-center justify-between p-4 rounded-xl bg-white border border-slate-200 hover:border-purple-300 transition">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="shield-check" class="w-5 h-5 text-purple-600"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-slate-800">Exiger les deux</div>
                                    <div class="text-xs text-slate-500">Photo ET signature obligatoires</div>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="validation_require_both" ${settings.requireBoth ? 'checked' : ''} onchange="VendeurModule.updateValidationSummary()" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-500"></div>
                            </label>
                        </div>
                    </div>

                    <!-- Résumé de la configuration -->
                    <div id="validation_summary" class="p-4 bg-slate-100 rounded-xl">
                        <div class="text-xs font-bold text-slate-500 uppercase mb-2">Configuration actuelle</div>
                        <div class="text-sm text-slate-700" id="validation_summary_text">
                            ${this.getValidationSummaryText(settings)}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: '💾 Enregistrer', onclick: 'VendeurModule.saveDeliveryValidationSettings()', class: 'px-5 py-2.5 bg-teal-600 text-white font-black rounded-xl hover:bg-teal-700' }
            ]);

            setTimeout(() => lucide.createIcons(), 50);
        },

        // Toggle des options photo
        toggleValidationPhotoOptions() {
            const photoEnabled = document.getElementById('validation_require_photo')?.checked;
            const container = document.getElementById('photo_options_container');
            if (container) {
                if (photoEnabled) {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            }
            this.updateValidationSummary();
        },

        // Mettre à jour le résumé
        updateValidationSummary() {
            const settings = {
                requirePhoto: document.getElementById('validation_require_photo')?.checked || false,
                requireSignature: document.getElementById('validation_require_signature')?.checked || false,
                requireBoth: document.getElementById('validation_require_both')?.checked || false,
                minPhotos: parseInt(document.getElementById('validation_min_photos')?.value || '1')
            };
            const summaryEl = document.getElementById('validation_summary_text');
            if (summaryEl) {
                summaryEl.textContent = this.getValidationSummaryText(settings);
            }
        },

        // Générer le texte de résumé
        getValidationSummaryText(settings) {
            if (!settings.requirePhoto && !settings.requireSignature) {
                return '⚠️ Aucune preuve requise - Les livreurs peuvent valider sans justificatif';
            }
            if (settings.requireBoth) {
                return `📷 + ✍️ Les livreurs doivent fournir ${settings.minPhotos || 1} photo(s) ET la signature du client`;
            }
            if (settings.requirePhoto && settings.requireSignature) {
                return `📷 OU ✍️ Les livreurs doivent fournir ${settings.minPhotos || 1} photo(s) OU la signature du client`;
            }
            if (settings.requirePhoto) {
                return `📷 Les livreurs doivent fournir ${settings.minPhotos || 1} photo(s) de livraison`;
            }
            if (settings.requireSignature) {
                return '✍️ Les livreurs doivent obtenir la signature du client';
            }
            return 'Configuration personnalisée';
        },

        // Sauvegarder les paramètres de validation
        saveDeliveryValidationSettings() {
            const user = CORE.state.currentUser;
            if (!user) return;

            const posId = user.pos;
            const settings = {
                requirePhoto: document.getElementById('validation_require_photo')?.checked || false,
                requireSignature: document.getElementById('validation_require_signature')?.checked || false,
                requireBoth: document.getElementById('validation_require_both')?.checked || false,
                minPhotos: parseInt(document.getElementById('validation_min_photos')?.value || '1'),
                maxPhotos: 5
            };

            CORE.saveDeliveryValidationSettings(posId, settings);
            UI.closeModal();
            UI.toast('✓ Paramétres de validation enregistrès', 'success');
        },

        // ========== RAPPORTS ET KPIs PAR POS ==========
        renderReports() {
            const userPos = CORE.user?.pos;
            if (!userPos) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assigné</div></div>`;
            }

            const kpis = CORE.getPOSKPIs(userPos);
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'POS ' + userPos;
            const topVendors = CORE.getTopVendorsByPOS(userPos, 5);
            const topDelivery = CORE.getTopDeliveryPersonnelByPOS(userPos, 5);

            // Trouver le rang du vendeur actuel
            const currentUser = CORE.user;
            const myRank = topVendors.findIndex(v => v.id === currentUser?.id) + 1;
            const myStats = topVendors.find(v => v.id === currentUser?.id) || { revenue: 0, orderCount: 0, avgOrder: 0, rating: 0 };

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div class="flex items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">📊 Mes Rapports et KPIs</h2>
                            <p class="text-slate-500 font-medium">Performance de ${posName}</p>
                        </div>
                    </div>

                    <!-- Mes Performances Personnelles -->
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl p-6 text-white shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-2xl font-black">${currentUser?.avatar || '👤'}</div>
                            <div>
                                <h3 class="text-xl font-black">${currentUser?.name || 'Vendeur'}</h3>
                                <p class="text-blue-200 text-sm">${myRank > 0 ? '🏆 Rang #' + myRank + ' dans votre POS' : 'Nouveau vendeur'}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-white/10 rounded-xl p-4">
                                <div class="text-xs text-blue-200 uppercase tracking-wider">Mon Revenu</div>
                                <div class="mt-1 text-2xl font-black">${CORE.formatPrice(myStats.revenue)}</div>
                            </div>
                            <div class="bg-white/10 rounded-xl p-4">
                                <div class="text-xs text-blue-200 uppercase tracking-wider">Mes Commandes</div>
                                <div class="mt-1 text-2xl font-black">${myStats.orderCount}</div>
                            </div>
                            <div class="bg-white/10 rounded-xl p-4">
                                <div class="text-xs text-blue-200 uppercase tracking-wider">Panier Moyen</div>
                                <div class="mt-1 text-2xl font-black">${CORE.formatPrice(myStats.avgOrder)}</div>
                            </div>
                            <div class="bg-white/10 rounded-xl p-4">
                                <div class="text-xs text-blue-200 uppercase tracking-wider">Ma Note</div>
                                <div class="mt-1 text-2xl font-black">⭐ ${myStats.rating || 0}</div>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs du POS -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="p-6 bg-white rounded-2xl border border-slate-200 shadow-sm">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Revenu POS</div>
                            <div class="mt-2 text-3xl font-black text-slate-900">${CORE.formatPrice(kpis?.totalRevenue || 0)}</div>
                            <div class="mt-2 text-xs text-slate-600">${posName}</div>
                        </div>
                        <div class="p-6 bg-white rounded-2xl border border-slate-200 shadow-sm">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Commandes POS</div>
                            <div class="mt-2 text-3xl font-black text-blue-600">${kpis?.totalOrders || 0}</div>
                            <div class="mt-2 text-xs text-slate-600">Dont ${kpis?.deliveredOrders || 0} livrées</div>
                        </div>
                        <div class="p-6 bg-white rounded-2xl border border-slate-200 shadow-sm">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Taux Livraison</div>
                            <div class="mt-2 text-3xl font-black text-emerald-600">${kpis?.deliveryRate || 0}%</div>
                            <div class="mt-2 text-xs text-slate-600">Succès livraisons</div>
                        </div>
                        <div class="p-6 bg-white rounded-2xl border border-slate-200 shadow-sm">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Stock Critique</div>
                            <div class="mt-2 text-3xl font-black ${(kpis?.lowStockProducts || 0) > 0 ? 'text-red-600' : 'text-green-600'}">${kpis?.lowStockProducts || 0}</div>
                            <div class="mt-2 text-xs text-slate-600">Produits à réapprovisionner</div>
                        </div>
                    </div>

                    <!-- Top Vendeurs et Livreurs du POS -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Top Vendeurs de mon POS -->
                        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-slate-200">
                                <h3 class="text-lg font-black text-slate-900">🏆 Top Vendeurs - ${posName}</h3>
                            </div>
                            <div class="p-6 space-y-3">
                                ${topVendors.length > 0 ? topVendors.map((v, i) => `
                                    <div class="flex items-center justify-between p-3 ${v.id === currentUser?.id ? 'bg-blue-50 border border-blue-200' : 'bg-slate-50'} rounded-lg">
                                        <div class="flex items-center gap-3">
                                            <span class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 text-white flex items-center justify-center text-sm font-black">${i+1}</span>
                                            <div>
                                                <div class="font-bold text-sm text-slate-900">${v.name} ${v.id === currentUser?.id ? '(Moi)' : ''}</div>
                                                <div class="text-xs text-slate-500">${v.orderCount} cmd • ${CORE.formatPrice(v.avgOrder)} moy</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-emerald-600">${CORE.formatPrice(v.revenue)}</div>
                                            <div class="text-xs text-slate-500">⭐ ${v.rating || 0}</div>
                                        </div>
                                    </div>
                                `).join('') : '<div class="text-center text-slate-500 py-4">Aucun vendeur</div>'}
                            </div>
                        </div>

                        <!-- Top Livreurs de mon POS -->
                        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-slate-200">
                                <h3 class="text-lg font-black text-slate-900">⚡ Top Livreurs - ${posName}</h3>
                            </div>
                            <div class="p-6 space-y-3">
                                ${topDelivery.length > 0 ? topDelivery.map((l, i) => `
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                                        <div class="flex items-center gap-3">
                                            <span class="w-8 h-8 rounded-full bg-gradient-to-br from-orange-400 to-orange-600 text-white flex items-center justify-center text-sm font-black">${i+1}</span>
                                            <div>
                                                <div class="font-bold text-sm text-slate-900">${l.name}</div>
                                                <div class="text-xs text-slate-500">${l.deliveryCount} liv • ${l.vehicle}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-blue-600">${l.avgDeliveryTime} min</div>
                                            <div class="text-xs text-slate-500">⭐ ${l.rating || 0}</div>
                                        </div>
                                    </div>
                                `).join('') : '<div class="text-center text-slate-500 py-4">Aucun livreur</div>'}
                            </div>
                        </div>
                    </div>

                    <!-- Revenu Aujourd'hui -->
                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-black text-slate-900">📈 Performance du Jour</h3>
                                <p class="text-slate-500 text-sm">Revenu et commandes aujourd'hui</p>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-black text-emerald-600">${CORE.formatPrice(kpis?.todayRevenue || 0)}</div>
                                <div class="text-sm text-slate-500">${kpis?.todayOrders || 0} commandes</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        showPOSDetailedReportModal(posId) {
            const posData = CORE.getPOS(posId);
            const kpis = CORE.getPOSKPIs(posId);
            const topVendors = CORE.getTopVendorsByPOS(posId, 5);
            const topDelivery = CORE.getTopDeliveryPersonnelByPOS(posId, 5);

            let vendorHtml = "";
            topVendors.forEach((v, i) => {
                vendorHtml += '<div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg"><div class="flex items-center gap-2"><span class="font-black text-lg w-8 h-8 flex items-center justify-center bg-gradient-to-br from-blue-400 to-blue-600 text-white rounded-full">' + (i+1) + '</span><div><div class="font-bold text-slate-900">' + v.name + '</div><div class="text-xs text-slate-500">' + v.orderCount + ' commandes</div></div></div><div class="text-right"><div class="font-black text-emerald-600">' + CORE.formatPrice(v.revenue) + '</div><div class="text-xs text-slate-500">Moy: ' + CORE.formatPrice(v.avgOrder) + '</div></div></div>';
            });

            let deliveryHtml = "";
            topDelivery.forEach((l, i) => {
                deliveryHtml += '<div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg"><div class="flex items-center gap-2"><span class="font-black text-lg w-8 h-8 flex items-center justify-center bg-gradient-to-br from-orange-400 to-orange-600 text-white rounded-full">' + (i+1) + '</span><div><div class="font-bold text-slate-900">' + l.name + '</div><div class="text-xs text-slate-500">' + l.vehicle + ' • ' + l.deliveryCount + ' livraisons</div></div></div><div class="text-right"><div class="font-black text-blue-600">' + l.avgDeliveryTime + ' min</div><div class="text-xs text-slate-500">' + Math.round(l.totalDistance) + ' km</div></div></div>';
            });

            const modalTitle = "Report for " + (posData?.name || "POS " + posId);
            const content = `
                <div class="space-y-6 max-h-[80vh] overflow-y-auto">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl">
                            <div class="text-xs font-black text-blue-600 uppercase">Revenue</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${CORE.formatPrice(kpis.totalRevenue)}</div>
                        </div>
                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                            <div class="text-xs font-black text-emerald-600 uppercase">Orders</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${kpis.totalOrders}</div>
                        </div>
                        <div class="p-4 bg-orange-50 border border-orange-200 rounded-xl">
                            <div class="text-xs font-black text-orange-600 uppercase">Delivery Rate</div>
                            <div class="text-2xl font-black text-orange-900 mt-1">${kpis.deliveryRate}%</div>
                        </div>
                        <div class="p-4 bg-purple-50 border border-purple-200 rounded-xl">
                            <div class="text-xs font-black text-purple-600 uppercase">Low Stock</div>
                            <div class="text-2xl font-black text-purple-900 mt-1">${kpis.lowStockProducts}</div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl border border-slate-200 p-4">
                        <h4 class="font-black text-slate-900 mb-3">Top Vendors</h4>
                        <div class="space-y-2">${vendorHtml}</div>
                    </div>
                    <div class="bg-white rounded-xl border border-slate-200 p-4">
                        <h4 class="font-black text-slate-900 mb-3">Top Delivery Personnel</h4>
                        <div class="space-y-2">${deliveryHtml}</div>
                    </div>
                </div>
            `;

            UI.modal(modalTitle, content, [
                { label: "Close", onclick: "UI.closeModal()" }
            ]);
        },

        renderSmartAssignment() {
            const userPos = CORE.user?.pos;
            if (!userPos) {
                return `<div class="text-center py-12"><div class="text-slate-500 text-lg">Aucun POS assigné</div></div>`;
            }

            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'POS ' + userPos;
            const stats = CORE.getLivreurWorkloadStats(userPos);
            const totalDeliveries = stats.reduce((sum, s) => sum + s.completedToday, 0);
            const availableCount = stats.filter(s => s.activeDeliveries === 0).length;

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div class="flex items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">🚚 Assignation Intelligente</h2>
                            <p class="text-slate-500 font-medium">Livreurs de ${posName}</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="px-4 py-2 bg-emerald-100 text-emerald-700 rounded-xl font-bold">
                                ${availableCount} disponible(s)
                            </div>
                            <div class="px-4 py-2 bg-blue-100 text-blue-700 rounded-xl font-bold">
                                ${totalDeliveries} livraisons aujourd'hui
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="p-6 border-b border-slate-200 bg-gradient-to-r from-blue-50 to-indigo-50">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-xl font-black text-slate-900">${posName}</h3>
                                    <p class="text-sm text-slate-600 mt-1">${stats.length} livreur(s) assigné(s)</p>
                                </div>
                            </div>
                        </div>

                        ${stats.length > 0 ? `
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-slate-50 border-b border-slate-200">
                                        <tr>
                                            <th class="px-6 py-3 text-left font-black text-slate-600 uppercase tracking-wider text-xs">Livreur</th>
                                            <th class="px-6 py-3 text-left font-black text-slate-600 uppercase tracking-wider text-xs">Véhicule</th>
                                            <th class="px-6 py-3 text-center font-black text-slate-600 uppercase tracking-wider text-xs">En cours</th>
                                            <th class="px-6 py-3 text-center font-black text-slate-600 uppercase tracking-wider text-xs">Aujourd'hui</th>
                                            <th class="px-6 py-3 text-center font-black text-slate-600 uppercase tracking-wider text-xs">Temps moy</th>
                                            <th class="px-6 py-3 text-right font-black text-slate-600 uppercase tracking-wider text-xs">Distance</th>
                                            <th class="px-6 py-3 text-center font-black text-slate-600 uppercase tracking-wider text-xs">Rating</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-200">
                                        ${stats.map(s => `
                                            <tr class="hover:bg-slate-50 transition">
                                                <td class="px-6 py-4 font-bold text-slate-900">${s.livreurName}</td>
                                                <td class="px-6 py-4 text-slate-700">${s.vehicle}</td>
                                                <td class="px-6 py-4 text-center">
                                                    <span class="px-3 py-1 rounded-lg font-bold text-xs ${s.activeDeliveries === 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">
                                                        ${s.activeDeliveries}
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 text-center font-bold text-slate-900">${s.completedToday}</td>
                                                <td class="px-6 py-4 text-center text-slate-700">${s.avgDeliveryTime} min</td>
                                                <td class="px-6 py-4 text-right text-slate-700">${Math.round(s.totalDistance)} km</td>
                                                <td class="px-6 py-4 text-center font-bold text-slate-900">⭐ ${s.rating}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div class="p-12 text-center">
                                <div class="text-6xl mb-4">🚚</div>
                                <div class="text-xl font-bold text-slate-700">Aucun livreur assigné</div>
                                <p class="text-slate-500 mt-2">Aucun livreur n'est actuellement assigné à ${posName}</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        },

        renderSettings() {
            const user = CORE.state.currentUser;
            if (!user) return '<div>Chargement...</div>';
            const posData = CORE.getPOS(user?.pos);
            const prefs = this.state.preferences;
            const currentTheme = this.state?.theme || 'light';
            const currentLang = I18n.current || 'fr';

            return `
                <div class="space-y-6 fade-in">
                    <!-- Header gradient -->
                    <div class="bg-gradient-to-br from-emerald-500 via-emerald-600 to-teal-600 p-6 rounded-2xl relative overflow-hidden">
                        <div class="absolute inset-0 opacity-30" style="background-image: url('data:image/svg+xml,%3Csvg width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cg fill=\"none\" fill-rule=\"evenodd\"%3E%3Cg fill=\"%23ffffff\" fill-opacity=\"0.05\"%3E%3Cpath d=\"M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\"%2F%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E')"></div>
                        <div class="relative flex items-center gap-4">
                            <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-3xl font-black text-white border-2 border-white/30 shadow-xl">
                                ${user.avatar || user.name.charAt(0).toUpperCase()}
                            </div>
                            <div class="flex-1">
                                <h2 class="text-2xl font-black text-white drop-shadow-lg">${user.name}</h2>
                                <p class="text-emerald-100 font-medium text-sm">${posData?.name || 'Point de vente'}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="px-2 py-0.5 bg-white/20 backdrop-blur-sm rounded-full text-xs font-bold text-white capitalize">${user.role}</span>
                                    <span class="px-2 py-0.5 bg-white/20 backdrop-blur-sm rounded-full text-xs font-bold text-white flex items-center gap-1">
                                        <span class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span> En ligne
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions rapides -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                        <div class="grid grid-cols-4 gap-3">
                            <button onclick="VendeurModule.showVendorProfileModalFromSettings(${user.id})" class="group p-4 rounded-xl bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 hover:shadow-lg hover:scale-105 transition-all flex flex-col items-center gap-2">
                                <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center shadow-lg shadow-blue-200 group-hover:shadow-xl">
                                    <i data-lucide="user" class="w-6 h-6 text-white"></i>
                                </div>
                                <span class="text-xs font-black text-blue-700">Profil</span>
                            </button>
                            <button onclick="VendeurModule.showEditVendorProfileModalFromSettings(${user.id})" class="group p-4 rounded-xl bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 hover:shadow-lg hover:scale-105 transition-all flex flex-col items-center gap-2">
                                <div class="w-12 h-12 bg-purple-500 rounded-xl flex items-center justify-center shadow-lg shadow-purple-200 group-hover:shadow-xl">
                                    <i data-lucide="edit-3" class="w-6 h-6 text-white"></i>
                                </div>
                                <span class="text-xs font-black text-purple-700">\u00C9diter</span>
                            </button>
                            <button onclick="VendeurModule.showDeliveryTemplatesModal()" class="group p-4 rounded-xl bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 hover:shadow-lg hover:scale-105 transition-all flex flex-col items-center gap-2">
                                <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center shadow-lg shadow-orange-200 group-hover:shadow-xl">
                                    <i data-lucide="receipt" class="w-6 h-6 text-white"></i>
                                </div>
                                <span class="text-xs font-black text-orange-700">Bons</span>
                            </button>
                            <button onclick="VendeurModule.showKPIsModal(${user.id})" class="group p-4 rounded-xl bg-gradient-to-br from-emerald-50 to-emerald-100 border border-emerald-200 hover:shadow-lg hover:scale-105 transition-all flex flex-col items-center gap-2">
                                <div class="w-12 h-12 bg-emerald-500 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-200 group-hover:shadow-xl">
                                    <i data-lucide="trending-up" class="w-6 h-6 text-white"></i>
                                </div>
                                <span class="text-xs font-black text-emerald-700">KPIs</span>
                            </button>
                        </div>
                    </div>

                    <!-- Apparence -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center shadow-lg">
                                <i data-lucide="palette" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h3 class="font-black text-slate-800">${t('settings.theme')}</h3>
                                <p class="text-xs text-slate-500">Personnalisez l'interface</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            ${[
                                { id: 'light', icon: 'sun', label: t('settings.light'), color: 'amber' },
                                { id: 'dark', icon: 'moon', label: t('settings.dark'), color: 'slate' },
                                { id: 'auto', icon: 'monitor', label: t('settings.auto'), color: 'blue' }
                            ].map(theme => `
                                <button onclick="VendeurModule.setTheme('${theme.id}')" class="p-4 rounded-xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${currentTheme === theme.id ? 'border-emerald-500 bg-emerald-50 shadow-lg shadow-emerald-100' : 'border-slate-200 hover:border-slate-300 hover:bg-slate-50'}">
                                    <i data-lucide="${theme.icon}" class="w-6 h-6 ${currentTheme === theme.id ? 'text-emerald-600' : 'text-slate-400'}"></i>
                                    <span class="text-xs font-bold ${currentTheme === theme.id ? 'text-emerald-700' : 'text-slate-600'}">${theme.label}</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Langue (Tiroir) -->
                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                        <button onclick="document.getElementById('vendeur-language-drawer').classList.toggle('hidden'); document.getElementById('vendeur-language-chevron').classList.toggle('rotate-180')" class="w-full flex items-center justify-between p-5 hover:bg-slate-50 transition-all">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-500 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="globe" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left">
                                    <h3 class="font-black text-slate-800">${t('settings.language')}</h3>
                                    <p class="text-xs text-slate-500">${[
                                        { code: 'fr', flag: '🇫🇷', name: 'Français' },
                                        { code: 'en', flag: '🇬🇧', name: 'English' },
                                        { code: 'es', flag: '🇪🇸', name: 'Español' },
                                        { code: 'pt', flag: '🇵🇹', name: 'Português' },
                                        { code: 'de', flag: '🇩🇪', name: 'Deutsch' },
                                        { code: 'it', flag: '🇮🇹', name: 'Italiano' },
                                        { code: 'ar', flag: '🇸🇦', name: 'العربية' },
                                        { code: 'zh', flag: '🇨🇳', name: '中文' },
                                        { code: 'ru', flag: '🇷🇺', name: 'Русский' }
                                    ].find(l => l.code === prefs.language)?.flag || '🌍'} ${[
                                        { code: 'fr', flag: '🇫🇷', name: 'Français' },
                                        { code: 'en', flag: '🇬🇧', name: 'English' },
                                        { code: 'es', flag: '🇪🇸', name: 'Español' },
                                        { code: 'pt', flag: '🇵🇹', name: 'Português' },
                                        { code: 'de', flag: '🇩🇪', name: 'Deutsch' },
                                        { code: 'it', flag: '🇮🇹', name: 'Italiano' },
                                        { code: 'ar', flag: '🇸🇦', name: 'العربية' },
                                        { code: 'zh', flag: '🇨🇳', name: '中文' },
                                        { code: 'ru', flag: '🇷🇺', name: 'Русский' }
                                    ].find(l => l.code === prefs.language)?.name || 'Français'}</p>
                                </div>
                            </div>
                            <i id="vendeur-language-chevron" data-lucide="chevron-down" class="w-5 h-5 text-slate-400 transition-transform duration-300"></i>
                        </button>
                        <div id="vendeur-language-drawer" class="hidden border-t border-slate-200 bg-slate-50 p-5">
                            <p class="text-xs text-slate-500 mb-3">${t('settings.chooseLanguage')}</p>
                            <div class="grid grid-cols-5 gap-2">
                                ${[
                                    { code: 'fr', flag: '🇫🇷' },
                                    { code: 'en', flag: '🇬🇧' },
                                    { code: 'es', flag: '🇪🇸' },
                                    { code: 'pt', flag: '🇵🇹' },
                                    { code: 'de', flag: '🇩🇪' },
                                    { code: 'it', flag: '🇮🇹' },
                                    { code: 'ar', flag: '🇸🇦' },
                                    { code: 'zh', flag: '🇨🇳' },
                                    { code: 'ru', flag: '🇷🇺' }
                                ].map(lang => `
                                    <button onclick="VendeurModule.setLanguage('${lang.code}')" class="p-2.5 rounded-xl border-2 transition-all text-2xl hover:scale-110 ${prefs.language === lang.code ? 'border-blue-500 bg-blue-50 shadow-lg' : 'border-slate-200 hover:border-slate-300 bg-white'}">
                                        ${lang.flag}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Notifications -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-rose-500 to-red-500 rounded-xl flex items-center justify-center shadow-lg">
                                <i data-lucide="bell" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h3 class="font-black text-slate-800">${t('settings.notifications')}</h3>
                                <p class="text-xs text-slate-500">Alertes et sons</p>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-4 rounded-xl bg-slate-50 border border-slate-200">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center border border-slate-200">
                                        <i data-lucide="bell" class="w-5 h-5 text-slate-600"></i>
                                    </div>
                                    <span class="text-sm font-bold text-slate-700">Notifications</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" ${prefs.notificationsEnabled ? 'checked' : ''} onchange="VendeurModule.state.preferences.notificationsEnabled = this.checked; VendeurModule.savePreferences()" class="sr-only peer">
                                    <div class="w-11 h-6 bg-slate-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between p-4 rounded-xl bg-slate-50 border border-slate-200">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center border border-slate-200">
                                        <i data-lucide="volume-2" class="w-5 h-5 text-slate-600"></i>
                                    </div>
                                    <span class="text-sm font-bold text-slate-700">Sons</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" ${prefs.soundEnabled ? 'checked' : ''} onchange="VendeurModule.state.preferences.soundEnabled = this.checked; VendeurModule.savePreferences()" class="sr-only peer">
                                    <div class="w-11 h-6 bg-slate-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- S\u00E9curit\u00E9 -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl flex items-center justify-center shadow-lg">
                                <i data-lucide="shield" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h3 class="font-black text-slate-800">S\u00E9curit\u00E9</h3>
                                <p class="text-xs text-slate-500">Mot de passe et confidentialit\u00E9</p>
                            </div>
                        </div>
                        <button onclick="VendeurModule.showChangePersonalPasswordModal()" class="w-full p-4 rounded-xl bg-amber-50 border border-amber-200 hover:bg-amber-100 transition flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i data-lucide="key" class="w-5 h-5 text-amber-600"></i>
                                <span class="text-sm font-bold text-amber-700">Changer mon mot de passe</span>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-amber-400"></i>
                        </button>
                    </div>

                    <!-- Validation Livraisons -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-teal-500 to-cyan-500 rounded-xl flex items-center justify-center shadow-lg">
                                <i data-lucide="check-circle" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h3 class="font-black text-slate-800">Validation livraisons</h3>
                                <p class="text-xs text-slate-500">Preuves requises par les livreurs</p>
                            </div>
                        </div>
                        <button onclick="VendeurModule.showDeliveryValidationSettingsModal()" class="w-full p-4 rounded-xl bg-teal-50 border border-teal-200 hover:bg-teal-100 transition flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i data-lucide="settings-2" class="w-5 h-5 text-teal-600"></i>
                                <span class="text-sm font-bold text-teal-700">Configurer les preuves requises</span>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-teal-400"></i>
                        </button>
                    </div>

                    <!-- Infos entreprise -->
                    <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl p-5 text-white shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center text-xl font-black">${CORE.getCompanyName().charAt(0)}</div>
                                <div>
                                    <div class="font-black">${CORE.getCompanyName()}</div>
                                    <div class="text-xs text-slate-400">v${CORE.config.version} \u2022 POS: ${posData?.name || 'N/A'}</div>
                                </div>
                            </div>
                            <span class="px-3 py-1 bg-emerald-500/20 text-emerald-400 rounded-full text-xs font-bold">\u2713 \u00C0 jour</span>
                        </div>
                    </div>

                    <!-- Plus d'options -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                        <button onclick="VendeurModule.showPreferencesModal()" class="w-full p-4 rounded-xl bg-slate-50 border border-slate-200 hover:bg-slate-100 transition flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i data-lucide="settings-2" class="w-5 h-5 text-slate-600"></i>
                                <div class="text-left">
                                    <div class="text-sm font-black text-slate-700">Plus d'options</div>
                                    <div class="text-xs text-slate-500">Pr\u00E9f\u00E9rences avanc\u00E9es</div>
                                </div>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i>
                        </button>
                    </div>

                    <!-- Multi-comptes -->
                    ${window.AccountSwitcher ? AccountSwitcher.getHTML() : '<div id="account-switcher-section"></div>'}

                    <!-- Zone de danger -->
                    <div class="bg-red-50 rounded-2xl border border-red-200 overflow-hidden">
                        <div class="p-5 border-b border-red-200 font-black text-red-700 flex items-center gap-2">
                            <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                            <span>Zone de danger</span>
                        </div>
                        <div class="p-5 space-y-3">
                            <button onclick="CORE.showDeleteMyAccountModal()" class="w-full py-3 rounded-xl bg-white border-2 border-red-300 text-red-700 font-black hover:bg-red-100 transition flex items-center justify-center gap-2">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                                <span>Supprimer mon compte</span>
                            </button>
                            <button onclick="App.logout()" class="w-full py-3 rounded-xl bg-red-600 text-white font-black hover:bg-red-700 transition flex items-center justify-center gap-2">
                                <i data-lucide="log-out" class="w-5 h-5"></i>
                                <span>D\u00E9connexion</span>
                            </button>
                        </div>
                    </div>
                </div>`;
        },

        renderActivityLog() {
            const posId = CORE.user?.pos;
            const userId = CORE.state.currentUser?.id;
            const userRole = (CORE.state.currentUser?.role || '').toLowerCase();
            const filterType = this.state.activityFilter || 'all';

            // Merge activityLogs + auditLogs for this user/pos
            let logs = [...(CORE.db.activityLogs || []), ...(CORE.db.auditLogs || [])];
            // Deduplicate
            const seen = new Set();
            logs = logs.filter(l => { const k = l.id + '_' + l.timestamp; if (seen.has(k)) return false; seen.add(k); return true; });
            // Filter by user's POS or own actions
            logs = logs.filter(l => (l.posId && l.posId == posId) || l.userId == userId);
            if (userRole === 'gestionnaire') {
                logs = logs.filter(l => {
                    const role = (l?.userRole || '').toLowerCase();
                    return role !== 'pdg' && role !== 'manager';
                });
            }
            if (filterType !== 'all') logs = logs.filter(l => l.action === filterType || l.entity === filterType);
            logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const today = new Date().toDateString();
            const todayLogs = logs.filter(l => new Date(l.timestamp).toDateString() === today);
            const actions = [...new Set(logs.map(l => l.action).filter(Boolean))];

            const actionIcons = { 'create': '➕', 'update': '✏️', 'delete': '🗑️', 'complete': '✅', 'deposit': '💰', 'accept': '🤝', 'assign': '👤', 'status_change': '🔄' };
            const actionColors = { 'create': 'emerald', 'update': 'blue', 'delete': 'red', 'complete': 'emerald', 'deposit': 'amber', 'accept': 'purple', 'assign': 'indigo', 'status_change': 'cyan' };

            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">📋 Journal d'Activité</h2>
                            <p class="text-slate-500 text-sm font-medium">Historique de toutes vos actions</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-black text-emerald-600">${todayLogs.length}</div>
                            <div class="text-xs text-slate-500">actions aujourd'hui</div>
                        </div>
                    </div>

                    <div class="flex gap-2 overflow-x-auto pb-2">
                        <button onclick="VendeurModule.state.activityFilter='all';App.rerender()" class="px-3 py-1.5 rounded-full text-xs font-black whitespace-nowrap ${filterType === 'all' ? 'bg-slate-900 text-white' : 'bg-white border border-slate-200 text-slate-600'}">
                            Tout (${logs.length})
                        </button>
                        ${actions.slice(0, 6).map(a => `
                            <button onclick="VendeurModule.state.activityFilter='${a}';App.rerender()" class="px-3 py-1.5 rounded-full text-xs font-black whitespace-nowrap ${filterType === a ? 'bg-slate-900 text-white' : 'bg-white border border-slate-200 text-slate-600'}">
                                ${actionIcons[a] || '📝'} ${a}
                            </button>
                        `).join('')}
                    </div>

                    <div class="space-y-2">
                        ${logs.length === 0 ? '<div class="text-center py-12 text-slate-400"><div class="text-4xl mb-3">📭</div><div class="font-bold">Aucune activité enregistrée</div></div>' : logs.slice(0, 100).map(l => {
                            const color = actionColors[l.action] || 'slate';
                            return `
                            <div class="bg-white rounded-2xl border border-slate-200 p-4 hover:shadow-md transition">
                                <div class="flex items-start justify-between">
                                    <div class="flex items-start gap-3">
                                        <div class="w-9 h-9 rounded-xl bg-${color}-100 flex items-center justify-center text-lg flex-shrink-0">${actionIcons[l.action] || '📝'}</div>
                                        <div>
                                            <div class="font-black text-slate-900 text-sm">${l.entityName || l.details || l.action || '—'}</div>
                                            <div class="text-xs text-slate-500 mt-0.5">${l.entity || ''} ${l.entityId ? '#' + l.entityId : ''}</div>
                                        </div>
                                    </div>
                                    <div class="text-right flex-shrink-0">
                                        <span class="px-2 py-0.5 rounded-full text-[10px] font-black bg-${color}-100 text-${color}-700">${l.action || l.status || '—'}</span>
                                        <div class="text-[10px] text-slate-400 mt-1">${CORE.formatDate(l.timestamp)}</div>
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>

                </div>`;
        },

                render() {
            const view = this.state.currentView;
            this.loadThemePreference(); // Charger le thème préféré
            const content = view === 'settings' ? this.renderSettings() :
                            view === 'dashboard' ? this.renderDashboard() :
                            view === 'pos' ? this.renderPOS() :
                            view === 'orders' ? this.renderOrders() :
                            view === 'stock' ? this.renderStock() :
                            view === 'clients' ? this.renderClients() :
                            view === 'livreurs' ? this.renderLivreurs() :
                            view === 'commissions' ? this.renderCommissions() :
                            view === 'reservations' ? this.renderReservations() :
                            view === 'routage' ? this.renderRoutage() :
                            view === 'finance' ? this.renderFinance() :
                            view === 'rapports' ? this.renderReports() :
                            view === 'assignation' ? this.renderSmartAssignment() :
                            view === 'activite' ? this.renderActivityLog() :
                            this.renderDashboard();

            return `
                <div class="flex h-screen bg-slate-100">
                    <aside class="w-72 bg-gradient-to-b from-emerald-900 via-slate-900 to-slate-950 text-white flex flex-col no-print relative overflow-hidden">
                        <!-- Effets de fond -->
                        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,rgba(16,185,129,0.2),transparent_50%)] pointer-events-none"></div>
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-400 via-emerald-500 to-emerald-600"></div>

                        <!-- Header -->
                        <div class="p-6 flex items-center gap-4 flex-shrink-0 relative">
                            <div class="w-12 h-12 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-500/30 ring-2 ring-white/10">
                                <i data-lucide="shopping-bag" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h1 class="font-black text-xl tracking-tight">RAYA<span class="text-emerald-400">.pos</span></h1>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">${CORE.getPOS(CORE.user?.pos)?.name || 'Vendeur'}</p>
                            </div>
                        </div>

                        <!-- Navigation -->
                        <nav class="flex-1 px-4 py-2 space-y-1 overflow-y-auto">
                            ${this.renderNavIcon('dashboard', 'layout-dashboard', t('menu.dashboard'), CORE.getUnreadNotificationCount())}
                            ${this.renderNavIcon('pos', 'shopping-cart', t('menu.pos'))}
                            ${this.renderNavIcon('clients', 'users', t('menu.clients'))}
                            ${this.renderNavIcon('orders', 'receipt', t('menu.orders'), (CORE.db.orders || []).filter(o => o.status === 'pending' || o.status === 'new').length)}
                            ${this.renderNavIcon('stock', 'package', t('menu.stock'), (typeof GestionnaireModule !== 'undefined' && GestionnaireModule.getPendingIncomingTransfers ? GestionnaireModule.getPendingIncomingTransfers().length : 0))}
                            ${this.renderNavIcon('livreurs', 'bike', t('menu.deliverers'))}
                            ${this.renderNavIcon('reservations', 'calendar-clock', t('menu.reservations'))}
                            ${this.renderNavIcon('commissions', 'percent', t('menu.commissions'))}
                            ${this.renderNavIcon('routage', 'route', t('menu.routing'))}
                            ${this.renderNavIcon('finance', 'wallet', t('menu.finance'))}
                            ${this.renderNavIcon('assignation', 'send', t('menu.assignment'))}
                            ${this.renderNavIcon('rapports', 'bar-chart-2', t('menu.reports'))}
                            ${this.renderNavIcon('activite', 'clipboard-list', 'Journal d\'activité')}
                        </nav>

                        <!-- Footer -->
                        <div class="p-4 border-t border-white/5 relative">
                            <button onclick="VendeurModule.navigateTo('settings')" class="w-full flex items-center gap-3 px-4 py-3 bg-white/5 hover:bg-white/10 rounded-xl transition-all duration-200 group">
                                <i data-lucide="settings" class="w-5 h-5 text-slate-400 group-hover:text-emerald-400 group-hover:rotate-90 transition-all duration-300"></i>
                                <span class="text-sm font-bold text-slate-300 group-hover:text-white">${t('menu.settings')}</span>
                            </button>
                        </div>
                    </aside>

                    <main class="flex-1 overflow-auto bg-slate-50">
                        <header class="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-20">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-xl font-black text-slate-900">Point de Vente</h2>
                                    <p class="text-sm text-slate-500">Vendeur: ${CORE.state.currentUser?.name}</p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div class="flex items-center gap-2 px-3 py-1.5 bg-emerald-50 rounded-full">
                                        <span class="w-2 h-2 bg-emerald-500 rounded-full pulse-dot"></span>
                                        <span class="text-sm text-emerald-700 font-black">En ligne</span>
                                    </div>
                                </div>
                            </div>
                        </header>
                        <div class="p-6">${content}</div>
                    </main>
                </div>`;
        },

        renderNavIcon(view, icon, label = '', badge = 0) {
            const active = this.state.currentView === view;
            const title = label || view.charAt(0).toUpperCase() + view.slice(1);
            return `<button onclick="VendeurModule.navigateTo('${view}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group ${active ? 'bg-gradient-to-r from-emerald-500/20 to-emerald-600/10 text-emerald-400 shadow-lg shadow-emerald-500/10 border-l-2 border-emerald-400' : 'text-slate-400 hover:bg-white/5 hover:text-white'}">
                <div class="relative flex-shrink-0">
                    <i data-lucide="${icon}" class="w-5 h-5 ${active ? 'drop-shadow-[0_0_8px_rgba(16,185,129,0.5)]' : ''}"></i>
                    ${badge > 0 ? `<span class="absolute -top-2 -right-2 min-w-[18px] h-[18px] bg-red-500 text-white text-[10px] font-black rounded-full flex items-center justify-center animate-pulse shadow-lg shadow-red-500/40">${badge > 9 ? '9+' : badge}</span>` : ''}
                </div>
                <span class="text-sm font-bold truncate">${title}</span>
                ${active ? '<div class="ml-auto w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>' : ''}
            </button>`;
        },

        openChat(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;
            CORE.db.messages = CORE.db.messages || [];
            const currentUser = CORE.state.currentUser;

            const renderMessages = () => {
                const msgs = CORE.db.messages.filter(m => m.deliveryId === deliveryId).sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
                if (msgs.length === 0) return '<div class="text-center text-slate-400 text-sm py-10">Aucun message.</div>';
                return msgs.map(m => {
                    const isMe = m.senderId === currentUser.id;
                    return `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[80%]">
                                <div class="px-4 py-2 rounded-2xl text-sm ${isMe ? 'bg-emerald-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-800 rounded-tl-none'}">${m.text}</div>
                                <div class="text-[10px] text-slate-400 mt-1 ${isMe ? 'text-right' : 'text-left'}">${isMe ? 'Moi' : m.senderName} • ${CORE.formatTime(m.createdAt)}</div>
                            </div>
                        </div>`;
                }).join('');
            };

            UI.modal(`Chat: ${d.orderRef}`, `
                <div class="flex flex-col h-[50vh]">
                    <div class="p-3 bg-slate-50 border-b border-slate-200 text-xs text-slate-500 flex justify-between">
                        <span>Client: <b>${d.clientName}</b></span>
                        <span>Livreur: <b>${CORE.getUser(d.livreurId)?.name || '...'}</b></span>
                    </div>
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3">${renderMessages()}</div>
                    <div class="mt-4 flex gap-2">
                        <input id="chat-input" class="flex-1 px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500 bg-slate-50 focus:bg-white transition" placeholder="Message..." onkeypress="if(event.key==='Enter') VendeurModule.sendChat(${deliveryId})">
                        <button onclick="VendeurModule.sendChat(${deliveryId})" class="px-4 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition"><i data-lucide="send" class="w-5 h-5"></i></button>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
            setTimeout(() => { const el = document.getElementById('chat-messages'); if(el) el.scrollTop = el.scrollHeight; }, 50);
        },

        sendChat(deliveryId) {
            const input = document.getElementById('chat-input');
            const text = input ? input.value.trim() : '';
            if (!text) return;
            CORE.db.messages = CORE.db.messages || [];
            CORE.db.messages.push({ id: CORE.uid(), deliveryId, senderId: CORE.state.currentUser?.id, senderName: CORE.state.currentUser?.name, role: CORE.state.currentUser?.role, text, createdAt: new Date().toISOString() });
            CORE.markDirty('messages');
            CORE.save();

            // 🔊 Jouer le son de notification pour le message
            UI.playGenericNotificationSound('info');

            this.openChat(deliveryId); // Refresh
        },

        // ========== RAPPORTS ET EXPORTS AVANCÉS ==========
        showReportsModal() {
            UI.modal('📊 Rapports & Exports Avancés', `
                <div class="space-y-4 max-h-[75vh] overflow-y-auto">
                    <!-- Générateur de Rapports Personnalisés -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="flex items-center gap-3 mb-3">
                            <i data-lucide="file-text" class="w-5 h-5 text-blue-600"></i>
                            <div class="font-black text-blue-900">Générer un Rapport Personnalisé</div>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs font-black text-slate-600">Nom du rapport</label>
                                <input type="text" id="report_name" placeholder="Ex: Ventes Janvier 2025" class="w-full mt-1 px-3 py-2 border border-blue-200 rounded-xl bg-white">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-xs font-black text-slate-600">Du</label>
                                    <input type="date" id="report_from" class="w-full mt-1 px-3 py-2 border border-blue-200 rounded-xl bg-white">
                                </div>
                                <div>
                                    <label class="text-xs font-black text-slate-600">Au</label>
                                    <input type="date" id="report_to" class="w-full mt-1 px-3 py-2 border border-blue-200 rounded-xl bg-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600">Métriques à inclure</label>
                                <div class="mt-2 space-y-2">
                                    <label class="flex items-center gap-2"><input type="checkbox" id="report_metric_revenue" checked class="w-4 h-4 rounded"><span class="text-sm">Revenus totaux</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" id="report_metric_orders" checked class="w-4 h-4 rounded"><span class="text-sm">Nombre de commandes</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" id="report_metric_profit" checked class="w-4 h-4 rounded"><span class="text-sm">Bénéfices et marges</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" id="report_metric_products" class="w-4 h-4 rounded"><span class="text-sm">Produits les plus vendus</span></label>
                                    <label class="flex items-center gap-2"><input type="checkbox" id="report_metric_vendors" class="w-4 h-4 rounded"><span class="text-sm">Performance vendeurs</span></label>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600">Format d'export</label>
                                <div class="mt-2 space-y-2">
                                    <label class="flex items-center gap-2"><input type="radio" name="report_format" value="html" checked class="w-4 h-4"><span class="text-sm">📄 HTML (Aperçu)</span></label>
                                    <label class="flex items-center gap-2"><input type="radio" name="report_format" value="excel" class="w-4 h-4"><span class="text-sm">📊 Excel (Tableaux)</span></label>
                                    <label class="flex items-center gap-2"><input type="radio" name="report_format" value="pdf" class="w-4 h-4"><span class="text-sm">📋 PDF (Impression)</span></label>
                                </div>
                            </div>
                            <button onclick="ManagerModule.generateCustomReport()" class="w-full px-4 py-2 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition">Générer le Rapport</button>
                        </div>
                    </div>

                    <!-- Rapports Automatiques par Email -->
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                        <div class="flex items-center gap-3 mb-3">
                            <i data-lucide="mail" class="w-5 h-5 text-emerald-600"></i>
                            <div class="font-black text-emerald-900">Rapports Automatiques par Email</div>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs font-black text-slate-600">Nom du programme</label>
                                <input type="text" id="schedule_name" placeholder="Ex: Rapport Ventes Hebdo" class="w-full mt-1 px-3 py-2 border border-emerald-200 rounded-xl bg-white">
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600">Email destinataire</label>
                                <input type="email" id="schedule_email" placeholder="direction@company.cg" class="w-full mt-1 px-3 py-2 border border-emerald-200 rounded-xl bg-white">
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600">Fréquence</label>
                                <select id="schedule_frequency" class="w-full mt-1 px-3 py-2 border border-emerald-200 rounded-xl bg-white">
                                    <option value="daily">📅 Quotidien</option>
                                    <option value="weekly">📆 Hebdomadaire</option>
                                    <option value="monthly">📊 Mensuel</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600">Heure d'envoi</label>
                                <input type="time" id="schedule_time" value="08:00" class="w-full mt-1 px-3 py-2 border border-emerald-200 rounded-xl bg-white">
                            </div>
                            <button onclick="ManagerModule.createReportSchedule()" class="w-full px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition">Créer le Programme</button>
                        </div>
                    </div>

                    <!-- Rapports Générés Récents -->
                    <div class="p-4 bg-purple-50 border border-purple-200 rounded-2xl">
                        <div class="flex items-center gap-3 mb-3">
                            <i data-lucide="history" class="w-5 h-5 text-purple-600"></i>
                            <div class="font-black text-purple-900">Historique des Rapports (${CORE.db.generatedReports.length})</div>
                        </div>
                        <div class="space-y-2 max-h-[300px] overflow-y-auto">
                            ${CORE.db.generatedReports.length === 0 ? `
                                <div class="text-center py-6 text-slate-400 text-sm">Aucun rapport généré</div>
                            ` : CORE.db.generatedReports.sort((a,b) => new Date(b.generatedAt) - new Date(a.generatedAt)).map(r => `
                                <div class="p-3 bg-white rounded-xl border border-purple-100 flex items-center justify-between">
                                    <div>
                                        <div class="font-black text-slate-900 text-sm">${r.name}</div>
                                        <div class="text-xs text-slate-500">${CORE.formatDate(r.generatedAt)} • ${r.format.toUpperCase()} • ${r.generatedByName}</div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="ManagerModule.downloadReport('${r.id}')" class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">Télécharger</button>
                                        <button onclick="ManagerModule.deleteReport('${r.id}')" class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">Supprimer</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Programmes Actifs -->
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                        <div class="flex items-center gap-3 mb-3">
                            <i data-lucide="clock" class="w-5 h-5 text-amber-600"></i>
                            <div class="font-black text-amber-900">Programmes Actifs (${CORE.db.reportSchedules.filter(s => s.enabled).length})</div>
                        </div>
                        <div class="space-y-2 max-h-[250px] overflow-y-auto">
                            ${CORE.db.reportSchedules.filter(s => s.enabled).length === 0 ? `
                                <div class="text-center py-4 text-slate-400 text-sm">Aucun programme actif</div>
                            ` : CORE.db.reportSchedules.filter(s => s.enabled).map(s => `
                                <div class="p-3 bg-white rounded-xl border border-amber-100 flex items-center justify-between">
                                    <div>
                                        <div class="font-black text-slate-900 text-sm">${s.name}</div>
                                        <div class="text-xs text-slate-500">${s.frequency === 'daily' ? '📅 Quotidien' : s.frequency === 'weekly' ? '📆 Hebdo' : '📊 Mensuel'} • ${s.time} • ${s.recipient}</div>
                                    </div>
                                    <button onclick="ManagerModule.toggleSchedule('${s.id}')" class="px-3 py-1 bg-red-500 text-white text-xs font-black rounded hover:bg-red-600">Désactiver</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        generateCustomReport() {
            const name = UI.val('report_name');
            const from = UI.val('report_from');
            const to = UI.val('report_to');
            const format = document.querySelector('input[name="report_format"]:checked')?.value || 'html';

            if (!name || !from || !to) return UI.toast('Remplissez tous les champs', 'warning');

            const metrics = [];
            if (document.getElementById('report_metric_revenue')?.checked) metrics.push('revenue');
            if (document.getElementById('report_metric_orders')?.checked) metrics.push('orders');
            if (document.getElementById('report_metric_profit')?.checked) metrics.push('profit');
            if (document.getElementById('report_metric_products')?.checked) metrics.push('products');
            if (document.getElementById('report_metric_vendors')?.checked) metrics.push('vendors');

            // Générer les données du rapport
            const reportData = this.generateReportData(from, to, metrics);

            // Créer l'enregistrement du rapport
            const report = {
                id: 'report_' + CORE.uid(),
                name: name,
                type: 'custom',
                generatedBy: CORE.state.currentUser?.id,
                generatedByName: CORE.state.currentUser?.name,
                generatedAt: new Date().toISOString(),
                metrics: metrics,
                format: format,
                data: reportData,
                downloadCount: 0,
                isArchived: false
            };

            CORE.db.generatedReports.push(report);
            CORE.logAuditAction('REPORT_GENERATED', { reportName: name, format: format, metrics: metrics.join(', ') });
            CORE.save();

            UI.toast('✓ Rapport généré avec succès', 'success');

            // Exporter selon le format
            if (format === 'html') {
                this.exportReportToHTML(report);
            } else if (format === 'excel') {
                this.exportReportToExcel(report);
            } else if (format === 'pdf') {
                this.exportReportToPDF(report);
            }

            this.showReportsModal();
        },

        generateReportData(fromDate, toDate, metrics) {
            const data = {
                period: { from: fromDate, to: toDate },
                generatedAt: new Date().toLocaleString('fr-FR'),
                metrics: {}
            };

            if (metrics.includes('revenue')) {
                const orders = CORE.getVisibleOrders().filter(o => {
                    const oDate = new Date(o.createdAt).toISOString().split('T')[0];
                    return oDate >= fromDate && oDate <= toDate;
                });
                data.metrics.totalRevenue = orders.reduce((a, o) => a + (o.totalAmount || 0), 0);
                data.metrics.orderCount = orders.length;
                data.metrics.averageOrder = orders.length > 0 ? data.metrics.totalRevenue / orders.length : 0;
            }

            if (metrics.includes('profit')) {
                const totalExpenses = CORE.getVisibleTransactions()
                    .filter(t => {
                        const tDate = new Date(t.createdAt || t.date).toISOString().split('T')[0];
                        return tDate >= fromDate && tDate <= toDate && t.type === 'expense';
                    })
                    .reduce((a, t) => a + (t.amount || 0), 0);
                const totalRevenue = data.metrics.totalRevenue || 0;
                data.metrics.totalExpenses = totalExpenses;
                data.metrics.netProfit = totalRevenue - totalExpenses;
                data.metrics.profitMargin = totalRevenue > 0 ? ((data.metrics.netProfit / totalRevenue) * 100).toFixed(2) : 0;
            }

            if (metrics.includes('products')) {
                const orderItems = [];
                CORE.getVisibleOrders().forEach(o => {
                    if (o.items && Array.isArray(o.items)) {
                        orderItems.push(...o.items);
                    }
                });
                const productSales = {};
                orderItems.forEach(item => {
                    if (!productSales[item.productId]) {
                        productSales[item.productId] = { qty: 0, revenue: 0 };
                    }
                    productSales[item.productId].qty += item.qty || 0;
                    productSales[item.productId].revenue += (item.price || 0) * (item.qty || 0);
                });
                data.metrics.topProducts = Object.entries(productSales)
                    .map(([pId, sales]) => {
                        const prod = CORE.getVisibleProducts().find(p => p.id === parseInt(pId));
                        return { name: prod?.name || 'Inconnu', qty: sales.qty, revenue: sales.revenue };
                    })
                    .sort((a, b) => b.revenue - a.revenue)
                    .slice(0, 10);
            }

            if (metrics.includes('vendors')) {
                const vendors = CORE.getVisibleUsers().filter(u => u.role === 'vendeur');
                data.metrics.vendorPerformance = vendors.map(v => {
                    const vOrders = CORE.getVisibleOrders().filter(o => o.vendeurId === v.id);
                    const vRevenue = vOrders.reduce((a, o) => a + (o.totalAmount || 0), 0);
                    return { name: v.name, totalSales: vRevenue, orderCount: vOrders.length, rating: v.rating || 0 };
                });
            }

            return data;
        },

        exportReportToHTML(report) {
            const html = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Rapport: ${report.name}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        h1 { color: #1e293b; border-bottom: 3px solid #0284c7; padding-bottom: 10px; }
        h2 { color: #475569; margin-top: 30px; border-left: 4px solid #0284c7; padding-left: 10px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 12px; text-align: left; border: 1px solid #e2e8f0; }
        th { background: #f1f5f9; font-weight: bold; color: #1e293b; }
        tr:nth-child(even) { background: #f8fafc; }
        .metric-box { display: inline-block; background: #e0f2fe; border: 2px solid #0284c7; border-radius: 8px; padding: 15px; margin: 10px; min-width: 200px; }
        .metric-value { font-size: 24px; font-weight: bold; color: #0284c7; }
        .metric-label { font-size: 12px; color: #64748b; margin-top: 5px; }
        @media print { body { margin: 0; } .container { box-shadow: none; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 ${report.name}</h1>
        <p><strong>Période:</strong> ${report.data.period.from} au ${report.data.period.to}</p>
        <p><strong>Généré le:</strong> ${report.data.generatedAt}</p>
        <p><strong>Généré par:</strong> ${report.data.generatedByName || 'Système'}</p>

        ${report.data.metrics.totalRevenue !== undefined ? `
        <h2>💰 Revenus</h2>
        <div class="metric-box">
            <div class="metric-value">${CORE.formatPrice(report.data.metrics.totalRevenue)}</div>
            <div class="metric-label">Revenu Total</div>
        </div>
        <div class="metric-box">
            <div class="metric-value">${report.data.metrics.orderCount}</div>
            <div class="metric-label">Nombre de Commandes</div>
        </div>
        <div class="metric-box">
            <div class="metric-value">${CORE.formatPrice(report.data.metrics.averageOrder)}</div>
            <div class="metric-label">Commande Moyenne</div>
        </div>
        ` : ''}

        ${report.data.metrics.netProfit !== undefined ? `
        <h2>📈 Rentabilité</h2>
        <div class="metric-box">
            <div class="metric-value">${CORE.formatPrice(report.data.metrics.netProfit)}</div>
            <div class="metric-label">Bénéfice Net</div>
        </div>
        <div class="metric-box">
            <div class="metric-value">${report.data.metrics.profitMargin}%</div>
            <div class="metric-label">Marge Bénéficiaire</div>
        </div>
        ` : ''}

        ${report.data.metrics.topProducts ? `
        <h2>🏆 Produits les Plus Vendus</h2>
        <table>
            <thead><tr><th>Produit</th><th>Quantité</th><th>Revenu</th></tr></thead>
            <tbody>
            ${report.data.metrics.topProducts.map(p => `
                <tr><td>${p.name}</td><td>${p.qty}</td><td>${CORE.formatPrice(p.revenue)}</td></tr>
            `).join('')}
            </tbody>
        </table>
        ` : ''}

        ${report.data.metrics.vendorPerformance ? `
        <h2>👥 Performance Vendeurs</h2>
        <table>
            <thead><tr><th>Vendeur</th><th>Ventes</th><th>Commandes</th><th>Note</th></tr></thead>
            <tbody>
            ${report.data.metrics.vendorPerformance.map(v => `
                <tr><td>${v.name}</td><td>${CORE.formatPrice(v.totalSales)}</td><td>${v.orderCount}</td><td>${v.rating.toFixed(1)}/5 ⭐</td></tr>
            `).join('')}
            </tbody>
        </table>
        ` : ''}

        <p style="margin-top: 40px; text-align: center; color: #64748b; font-size: 12px;">
            Document généré par ${CORE.getCompanyName()} • ${new Date().toLocaleString('fr-FR')}
        </p>
    </div>
</body>
</html>`;

            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name}_${new Date().getTime()}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            report.downloadCount = (report.downloadCount || 0) + 1;
            CORE.save();
        },

        exportReportToExcel(report) {
            let csv = 'sep=,\n';
            csv += `Rapport,${report.name}\n`;
            csv += `Période,${report.data.period.from} au ${report.data.period.to}\n`;
            csv += `Généré le,${report.data.generatedAt}\n\n`;

            if (report.data.metrics.totalRevenue !== undefined) {
                csv += 'REVENUS\n';
                csv += `Revenu Total,${report.data.metrics.totalRevenue}\n`;
                csv += `Nombre de Commandes,${report.data.metrics.orderCount}\n`;
                csv += `Commande Moyenne,${report.data.metrics.averageOrder}\n\n`;
            }

            if (report.data.metrics.netProfit !== undefined) {
                csv += 'RENTABILITÉ\n';
                csv += `Bénéfice Net,${report.data.metrics.netProfit}\n`;
                csv += `Marge Bénéficiaire,${report.data.metrics.profitMargin}%\n`;
                csv += `Dépenses Totales,${report.data.metrics.totalExpenses}\n\n`;
            }

            if (report.data.metrics.topProducts) {
                csv += 'PRODUITS LES PLUS VENDUS\n';
                csv += 'Produit,Quantité,Revenu\n';
                report.data.metrics.topProducts.forEach(p => {
                    csv += `${p.name},${p.qty},${p.revenue}\n`;
                });
                csv += '\n';
            }

            if (report.data.metrics.vendorPerformance) {
                csv += 'PERFORMANCE VENDEURS\n';
                csv += 'Vendeur,Ventes,Commandes,Note\n';
                report.data.metrics.vendorPerformance.forEach(v => {
                    csv += `${v.name},${v.totalSales},${v.orderCount},${v.rating}\n`;
                });
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `${report.name}_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            report.downloadCount = (report.downloadCount || 0) + 1;
            CORE.save();
        },

        exportReportToPDF(report) {
            // Simuler un PDF (en production, utiliser une librairie comme jsPDF)
            const pdfContent = `Rapport: ${report.name}\nPériode: ${report.data.period.from} au ${report.data.period.to}\n\n${JSON.stringify(report.data, null, 2)}`;
            const blob = new Blob([pdfContent], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${report.name}_${new Date().getTime()}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            report.downloadCount = (report.downloadCount || 0) + 1;
            CORE.save();
            UI.toast('📄 PDF généré (version basique)', 'success');
        },

        createReportSchedule() {
            const name = UI.val('schedule_name');
            const email = UI.val('schedule_email');
            const frequency = UI.val('schedule_frequency');
            const time = UI.val('schedule_time');

            if (!name || !email || !frequency) return UI.toast('Remplissez tous les champs', 'warning');

            const schedule = {
                id: 'schedule_' + CORE.uid(),
                name: name,
                recipient: email,
                frequency: frequency,
                time: time,
                dayOfWeek: frequency === 'weekly' ? new Date().getDay() : null,
                enabled: true,
                nextRun: new Date().toISOString(),
                createdBy: CORE.state.currentUser?.id,
                createdAt: new Date().toISOString()
            };

            CORE.db.reportSchedules.push(schedule);
            CORE.logAuditAction('SCHEDULE_CREATED', { scheduleName: name, frequency: frequency, recipient: email });
            CORE.save();

            UI.toast('✓ Programme créé. Les rapports seront envoyés à ' + email, 'success');
            document.getElementById('schedule_name').value = '';
            document.getElementById('schedule_email').value = '';
            this.showReportsModal();
        },

        toggleSchedule(scheduleId) {
            const schedule = CORE.db.reportSchedules.find(s => s.id === scheduleId);
            if (schedule) {
                schedule.enabled = !schedule.enabled;
                CORE.logAuditAction('SCHEDULE_' + (schedule.enabled ? 'ENABLED' : 'DISABLED'), { scheduleName: schedule.name });
                CORE.save();
                this.showReportsModal();
            }
        },

        downloadReport(reportId) {
            const report = CORE.db.generatedReports.find(r => r.id === reportId);
            if (!report) return UI.toast('Rapport introuvable', 'error');

            if (report.format === 'html') {
                this.exportReportToHTML(report);
            } else if (report.format === 'excel') {
                this.exportReportToExcel(report);
            } else if (report.format === 'pdf') {
                this.exportReportToPDF(report);
            }
        },

        deleteReport(reportId) {
            if (!confirm('Supprimer ce rapport ?')) return;
            const idx = CORE.db.generatedReports.findIndex(r => r.id === reportId);
            if (idx !== -1) {
                CORE.db.generatedReports.splice(idx, 1);
                CORE.logAuditAction('REPORT_DELETED', { reportId: reportId });
                CORE.save();
                this.showReportsModal();
            }
        },

        // ========== AUDIT TRAIL & CONFORMITÉ ==========
        showAuditTrailModal() {
            const user = CORE.state.currentUser;
            // Merge auditTrail + auditLogs (unified view)
            const allLogs = [...(CORE.db.auditTrail || []), ...(CORE.db.auditLogs || [])];
            // Deduplicate by id
            const seen = new Set();
            const uniqueLogs = allLogs.filter(l => { if (seen.has(l.id)) return false; seen.add(l.id); return true; });
            const logs = uniqueLogs.filter(log => log.userRole === 'manager' || !log.userRole).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            UI.modal('📋 Audit Trail - Historique Complet', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="text-xs text-blue-600 font-black">Total Actions</div>
                            <div class="text-2xl font-black text-blue-700">${logs.length}</div>
                        </div>
                        <div class="p-3 bg-red-50 rounded-lg border border-red-200">
                            <div class="text-xs text-red-600 font-black">Erreurs</div>
                            <div class="text-2xl font-black text-red-700">${logs.filter(l => l.status === 'failed').length}</div>
                        </div>
                        <div class="p-3 bg-amber-50 rounded-lg border border-amber-200">
                            <div class="text-xs text-amber-600 font-black">Avertissements</div>
                            <div class="text-2xl font-black text-amber-700">${logs.filter(l => l.status === 'warning').length}</div>
                        </div>
                        <div class="p-3 bg-emerald-50 rounded-lg border border-emerald-200">
                            <div class="text-xs text-emerald-600 font-black">Succès</div>
                            <div class="text-2xl font-black text-emerald-700">${logs.filter(l => l.status === 'success').length}</div>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <div class="text-xs font-black text-slate-600 uppercase mb-3">Actions Récentes</div>
                        <div class="space-y-2">
                            ${logs.length === 0 ? `<div class="text-center py-8 text-slate-400">Aucune action enregistrée</div>` : logs.slice(0, 50).map(log => `
                                <div class="p-3 rounded-lg border ${log.status === 'failed' ? 'border-red-200 bg-red-50' : log.status === 'warning' ? 'border-amber-200 bg-amber-50' : 'border-slate-200 bg-slate-50'} flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-xs font-black px-2 py-1 rounded ${log.status === 'failed' ? 'bg-red-200 text-red-700' : log.status === 'warning' ? 'bg-amber-200 text-amber-700' : 'bg-emerald-200 text-emerald-700'}">${log.status === 'failed' ? '❌' : log.status === 'warning' ? '⚠️' : '✅'} ${log.status.toUpperCase()}</span>
                                            <span class="text-xs text-slate-500">${CORE.formatDate(log.timestamp)}</span>
                                        </div>
                                        <div class="font-black text-slate-900 text-sm">${log.action}</div>
                                        <div class="text-xs text-slate-600 mt-1">${log.description || log.entityName || ''}</div>
                                        <div class="text-[10px] text-slate-500 mt-1">Par: <b>${log.userName}</b> • ${log.category || 'system'}</div>
                                    </div>
                                    ${log.before && log.after ? `<button onclick="ManagerModule.showAuditDetails('${log.id}')" class="px-2 py-1 text-xs font-black text-blue-600 hover:text-blue-800">Détails</button>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Exporter', onclick: 'ManagerModule.exportAuditTrail()', class: 'px-4 py-2 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700' },
                { label: 'Rapport Conformité', onclick: 'ManagerModule.showComplianceReport()', class: 'px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showAccessLogs() {
            const logs = CORE.db.accessLogs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            const today = logs.filter(l => new Date(l.timestamp).toDateString() === new Date().toDateString());

            UI.modal('🔓 Historique des Accès', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="p-3 bg-purple-50 rounded-lg border border-purple-200">
                            <div class="text-xs text-purple-600 font-black">Total Accès</div>
                            <div class="text-2xl font-black text-purple-700">${logs.length}</div>
                        </div>
                        <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                            <div class="text-xs text-indigo-600 font-black">Aujourd'hui</div>
                            <div class="text-2xl font-black text-indigo-700">${today.length}</div>
                        </div>
                        <div class="p-3 bg-cyan-50 rounded-lg border border-cyan-200">
                            <div class="text-xs text-cyan-600 font-black">Erreurs Login</div>
                            <div class="text-2xl font-black text-cyan-700">${logs.filter(l => !l.success).length}</div>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <div class="text-xs font-black text-slate-600 uppercase mb-3">Accès Récents</div>
                        <div class="space-y-2">
                            ${logs.slice(0, 50).map(log => `
                                <div class="p-3 rounded-lg border border-slate-200 bg-slate-50 flex items-start justify-between">
                                    <div>
                                        <div class="font-black text-slate-900 text-sm">${log.action}: ${log.resource || 'N/A'}</div>
                                        <div class="text-xs text-slate-600 mt-1">${log.userName} • ${CORE.formatDate(log.timestamp)}</div>
                                        <div class="text-[10px] text-slate-500">Durée: ${log.duration || 0}ms • ${log.deviceType || 'web'}</div>
                                    </div>
                                    <span class="text-xs font-black px-2 py-1 rounded ${log.success ? 'bg-emerald-200 text-emerald-700' : 'bg-red-200 text-red-700'}">
                                        ${log.success ? '✅ OK' : '❌ FAILED'}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Exporter', onclick: 'ManagerModule.exportAccessLogs()', class: 'px-4 py-2 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showDataModificationLogs() {
            const logs = CORE.db.dataModificationLogs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            UI.modal('📝 Modifications de Données', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="p-3 bg-indigo-50 rounded-lg border border-indigo-200">
                            <div class="text-xs text-indigo-600 font-black">Total Modifs</div>
                            <div class="text-2xl font-black text-indigo-700">${logs.length}</div>
                        </div>
                        <div class="p-3 bg-teal-50 rounded-lg border border-teal-200">
                            <div class="text-xs text-teal-600 font-black">Approuvées</div>
                            <div class="text-2xl font-black text-teal-700">${logs.filter(l => l.approvedBy).length}</div>
                        </div>
                        <div class="p-3 bg-orange-50 rounded-lg border border-orange-200">
                            <div class="text-xs text-orange-600 font-black">En Attente</div>
                            <div class="text-2xl font-black text-orange-700">${logs.filter(l => !l.approvedBy).length}</div>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <div class="text-xs font-black text-slate-600 uppercase mb-3">Historique des Modifications</div>
                        <div class="space-y-2">
                            ${logs.slice(0, 50).map(log => `
                                <div class="p-3 rounded-lg border border-slate-200 bg-slate-50">
                                    <div class="flex items-start justify-between mb-2">
                                        <div>
                                            <div class="font-black text-slate-900 text-sm">${log.table}</div>
                                            <div class="text-xs text-slate-600">${log.recordName || log.recordId}</div>
                                        </div>
                                        <span class="text-xs font-black px-2 py-1 rounded ${log.approvedBy ? 'bg-emerald-200 text-emerald-700' : 'bg-amber-200 text-amber-700'}">
                                            ${log.approvedBy ? '✅ APPROUVé' : '⏳ ATTENTE'}
                                        </span>
                                    </div>
                                    <div class="text-xs text-slate-600 mt-2">
                                        <b>${log.fieldName}:</b>
                                        <span class="line-through text-red-600">${log.oldValue}</span>
                                        → <span class="text-emerald-600">${log.newValue}</span>
                                    </div>
                                    <div class="text-[10px] text-slate-500 mt-1">Par: ${log.userName} • ${CORE.formatDate(log.timestamp)}</div>
                                    ${log.reason ? `<div class="text-[10px] text-slate-500">Raison: ${log.reason}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Exporter', onclick: 'ManagerModule.exportDataModificationLogs()', class: 'px-4 py-2 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showComplianceReport() {
            const period = 'monthly';
            const logs = CORE.db.auditTrail;
            const criticalEvents = logs.filter(l => l.status === 'failed' || l.action.includes('DELETE'));
            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            const monthLogs = logs.filter(l => new Date(l.timestamp) >= lastMonth);

            UI.modal('📊 Rapport de Conformité', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <div class="p-4 bg-gradient-to-r from-slate-900 to-slate-800 text-white rounded-2xl">
                        <div class="font-black text-lg mb-1">Rapport de Conformité - ${period === 'daily' ? 'Quotidien' : period === 'weekly' ? 'Hebdomadaire' : 'Mensuel'}</div>
                        <div class="text-xs text-white/60">Généré le ${CORE.formatDate(new Date().toISOString())}</div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                            <div class="text-xs text-blue-600 font-black uppercase">Actions Totales</div>
                            <div class="text-3xl font-black text-blue-700 mt-2">${logs.length}</div>
                            <div class="text-xs text-blue-600 mt-2">${monthLogs.length} ce mois</div>
                        </div>

                        <div class="p-4 bg-red-50 border border-red-200 rounded-2xl">
                            <div class="text-xs text-red-600 font-black uppercase">Événements Critiques</div>
                            <div class="text-3xl font-black text-red-700 mt-2">${criticalEvents.length}</div>
                            <div class="text-xs text-red-600 mt-2">Dépasse le seuil: ${criticalEvents.length > 10 ? '⚠️ OUI' : '✅ NON'}</div>
                        </div>

                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                            <div class="text-xs text-emerald-600 font-black uppercase">Taux de Succès</div>
                            <div class="text-3xl font-black text-emerald-700 mt-2">${logs.length > 0 ? ((logs.filter(l => l.status === 'success').length / logs.length) * 100).toFixed(1) : 0}%</div>
                            <div class="text-xs text-emerald-600 mt-2">Cible: = 95%</div>
                        </div>

                        <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                            <div class="text-xs text-amber-600 font-black uppercase">Accès Non Autorisés</div>
                            <div class="text-3xl font-black text-amber-700 mt-2">${CORE.db.accessLogs.filter(l => !l.success).length}</div>
                            <div class="text-xs text-amber-600 mt-2">Tentatives bloquées</div>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <div class="font-black text-slate-900 mb-3">Résumé de Conformité</div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <span class="font-black text-slate-900">RGPD - Traçabilité des accès</span>
                                <span class="px-3 py-1 rounded-full bg-emerald-200 text-emerald-700 text-xs font-black">✅ CONFORME</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <span class="font-black text-slate-900">Audit Trail complète (${logs.length} actions)</span>
                                <span class="px-3 py-1 rounded-full bg-emerald-200 text-emerald-700 text-xs font-black">✅ CONFORME</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <span class="font-black text-slate-900">Modifications tracées et approuvées</span>
                                <span class="px-3 py-1 rounded-full ${CORE.db.dataModificationLogs.filter(l => !l.approvedBy).length > 0 ? 'bg-amber-200 text-amber-700' : 'bg-emerald-200 text-emerald-700'} text-xs font-black">
                                    ${CORE.db.dataModificationLogs.filter(l => !l.approvedBy).length > 0 ? '⚠️ ATTENTE' : '✅ CONFORME'}
                                </span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <span class="font-black text-slate-900">Suppressions authentifiées</span>
                                <span class="px-3 py-1 rounded-full bg-emerald-200 text-emerald-700 text-xs font-black">✅ CONFORME</span>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                        <div class="font-black text-emerald-900 mb-2">🎯 Score de Conformité Global</div>
                        <div class="flex items-center">
                            <div class="flex-1 h-3 bg-slate-200 rounded-full overflow-hidden mr-3">
                                <div class="h-full bg-emerald-600" style="width: 92%"></div>
                            </div>
                            <div class="text-2xl font-black text-emerald-700">92%</div>
                        </div>
                        <div class="text-xs text-emerald-700 mt-2">✓ Tous les critères majeurs respectés</div>
                    </div>
                </div>
            `, [
                { label: 'Exporter Rapport', onclick: 'ManagerModule.exportComplianceReport()', class: 'px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        exportAuditTrail() {
            const logs = CORE.db.auditTrail.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            let csv = 'sep=,\n';
            csv += 'Timestamp,User,Action,Entity,Status,Description\n';
            logs.forEach(log => {
                csv += `"${log.timestamp}","${log.userName}","${log.action}","${log.entityName || log.entity}","${log.status}","${(log.description || '').replace(/"/g, '""')}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `audit_trail_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('✓ Audit trail exporté', 'success');
        },

        exportAccessLogs() {
            const logs = CORE.db.accessLogs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            let csv = 'sep=,\n';
            csv += 'Timestamp,User,Role,Action,Resource,Success,Duration(ms),Device\n';
            logs.forEach(log => {
                csv += `"${log.timestamp}","${log.userName}","${log.userRole}","${log.action}","${log.resource || ''}","${log.success}","${log.duration || 0}","${log.deviceType || 'web'}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `access_logs_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('✓ Accès exportés', 'success');
        },

        exportDataModificationLogs() {
            const logs = CORE.db.dataModificationLogs;
            let csv = 'sep=,\n';
            csv += 'Timestamp,User,Table,Record,Field,OldValue,NewValue,ApprovedBy,ApprovedDate\n';
            logs.forEach(log => {
                csv += `"${log.timestamp}","${log.userName}","${log.table}","${log.recordName}","${log.fieldName}","${(log.oldValue || '').replace(/"/g, '""')}","${(log.newValue || '').replace(/"/g, '""')}","${log.approvedBy || ''}","${log.approvedAt || ''}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `data_modifications_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('✓ Modifications exportées', 'success');
        },

        exportComplianceReport() {
            const report = `
RAPPORT DE CONFORMITÉ - ${CORE.getCompanyName()}
Généré le: ${CORE.formatDate(new Date().toISOString())}

=== RÉSUMÉ ===
Total Actions: ${CORE.db.auditTrail.length}
Événements Critiques: ${CORE.db.auditTrail.filter(l => l.status === 'failed').length}
Accès Non Autorisés: ${CORE.db.accessLogs.filter(l => !l.success).length}

=== CONFORMITÉ ===
✓ RGPD - Traéabilité: CONFORME
✓ Audit Trail: CONFORME (${CORE.db.auditTrail.length} actions)
✓ Modifications: ${CORE.db.dataModificationLogs.filter(l => !l.approvedBy).length > 0 ? 'EN ATTENTE' : 'CONFORME'}
✓ Suppressions: CONFORME

=== SCORE GLOBAL ===
92% de conformité

Approuvé par: Manager System
Date d'approbation: ${new Date().toLocaleDateString('fr-FR')}
            `;

            const blob = new Blob([report], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `compliance_report_${new Date().getTime()}.txt`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('✓ Rapport de conformité exporté', 'success');
        },

        logManagerAction(action, description, entity = null, entityId = null, changes = null) {
            const user = CORE.state.currentUser;
            if (!user) return;

            const auditLog = {
                id: 'audit_' + CORE.uid(),
                timestamp: new Date().toISOString(),
                userId: user.id,
                userName: user.name,
                userRole: user.role,
                action: action,
                category: 'manager',
                entity: entity,
                entityId: entityId,
                entityName: description,
                actionType: 'update',
                description: description,
                status: 'success',
                changes: changes || [],
                before: null,
                after: null
            };

            CORE.db.auditTrail = CORE.db.auditTrail || [];
            CORE.db.auditTrail.push(auditLog);

            // Also write to unified auditLogs (used by PDG + Gestionnaire audit pages)
            CORE.db.auditLogs = CORE.db.auditLogs || [];
            CORE.db.auditLogs.push(auditLog);

            CORE.save();
        },

        logAccessEvent(action, resource = null, success = true) {
            const user = CORE.state.currentUser;
            if (!user) return;

            const accessLog = {
                id: 'access_' + CORE.uid(),
                timestamp: new Date().toISOString(),
                userId: user.id,
                userName: user.name,
                userRole: user.role,
                action: action,
                resource: resource,
                resourceId: null,
                duration: 0,
                ipAddress: 'N/A',
                location: 'Manager Module',
                deviceType: 'web',
                success: success
            };

            CORE.db.accessLogs = CORE.db.accessLogs || [];
            CORE.db.accessLogs.push(accessLog);
            CORE.save();
        },

        logDataModification(table, recordId, recordName, fieldName, oldValue, newValue, reason = null) {
            const user = CORE.state.currentUser;
            if (!user) return;

            const modLog = {
                id: 'mod_' + CORE.uid(),
                timestamp: new Date().toISOString(),
                userId: user.id,
                userName: user.name,
                table: table,
                recordId: recordId,
                recordName: recordName,
                fieldName: fieldName,
                oldValue: oldValue,
                newValue: newValue,
                reason: reason,
                approvedBy: null,
                approvedAt: null
            };

            CORE.db.dataModificationLogs = CORE.db.dataModificationLogs || [];
            CORE.db.dataModificationLogs.push(modLog);
            CORE.save();
        },

        // ========== GESTION INTELLIGENTE DU STOCK ==========

        // 📊 Analyse ABC (Pareto) - Catégorise les produits par importance
        performABCAnalysis() {
            const products = CORE.getProductsExcludingMain();
            if (products.length === 0) return [];

            // Calculer le CA par produit
            const productMetrics = products.map(p => {
                const orders = CORE.getVisibleOrders().filter(o => o.items?.some(i => i.productId === p.id));
                const totalRevenue = orders.reduce((sum, o) => sum + (o.items.find(i => i.productId === p.id)?.total || 0), 0);
                const totalQty = orders.reduce((sum, o) => sum + (o.items.find(i => i.productId === p.id)?.quantity || 0), 0);

                return {
                    id: p.id,
                    name: p.name,
                    sku: p.sku,
                    stock: p.stock,
                    revenue: totalRevenue,
                    qty: totalQty,
                    profitMargin: p.profitMargin || 20,
                    profitValue: (totalRevenue * (p.profitMargin || 20)) / 100
                };
            }).sort((a, b) => b.revenue - a.revenue);

            // Calculer les pourcentages cumulés
            const totalRevenue = productMetrics.reduce((sum, p) => sum + p.revenue, 0);
            let cumulativePercentage = 0;
            const analysis = productMetrics.map(p => {
                cumulativePercentage += (p.revenue / totalRevenue) * 100;
                let category = 'C';
                if (cumulativePercentage <= 80) category = 'A';
                else if (cumulativePercentage <= 95) category = 'B';

                return {
                    id: p.id,
                    name: p.name,
                    sku: p.sku,
                    category: category,
                    revenue: p.revenue,
                    qty: p.qty,
                    profitValue: p.profitValue,
                    revenuePct: (p.revenue / totalRevenue) * 100,
                    cumulativePct: cumulativePercentage,
                    stock: p.stock,
                    priority: category === 'A' ? '🔴 CRITIQUE' : category === 'B' ? '🟡 IMPORTANT' : '🟢 NORMAL'
                };
            });

            CORE.db.stockAnalysisABC = analysis;
            CORE.save();
            return analysis;
        },

        // 📈 Prédictions de stock basées sur tendances
        predictStockLevels(daysAhead = 30) {
            const predictions = [];
            const products = CORE.getProductsExcludingMain();

            products.forEach(product => {
                // Récupérer les mouvements récents (90 derniers jours)
                const now = new Date();
                const ninetyDaysAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);

                const recentMovements = CORE.getVisibleStockMovements()
                    .filter(m => m.productId === product.id && new Date(m.createdAt) >= ninetyDaysAgo)
                    .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

                // Calculer la tendance de consommation moyenne
                const outMovements = recentMovements.filter(m => m.type === 'out');
                const totalQtyOut = outMovements.reduce((sum, m) => sum + m.qty, 0);
                const daysWithData = 90;
                const avgDailyConsumption = totalQtyOut / daysWithData;

                // Prédire le stock dans N jours
                const predictedStock = product.stock - (avgDailyConsumption * daysAhead);
                const daysUntilStockOut = predictedStock > 0 ? Math.floor(product.stock / (avgDailyConsumption || 1)) : 0;

                // Estimer si on va passer sous le minimum
                const willGoUnderMinimum = predictedStock < (product.minStock || 10);
                const riskLevel = predictedStock < 0 ? '🔴 RUPTURE' : predictedStock < product.minStock ? '🟡 RISQUE' : '🟢 OK';

                predictions.push({
                    id: product.id,
                    name: product.name,
                    sku: product.sku,
                    currentStock: product.stock,
                    minStock: product.minStock,
                    avgDailyConsumption: avgDailyConsumption.toFixed(2),
                    predictedStock: Math.max(0, predictedStock).toFixed(2),
                    daysUntilStockOut: daysUntilStockOut,
                    riskLevel: riskLevel,
                    willGoUnderMinimum: willGoUnderMinimum,
                    recommendedReorder: willGoUnderMinimum,
                    daysAhead: daysAhead,
                    confidence: recentMovements.length > 10 ? 'HAUTE' : 'MOYENNE'
                });
            });

            CORE.db.stockPredictions = predictions;
            CORE.save();
            return predictions.sort((a, b) => {
                if (a.riskLevel.includes('RUPTURE')) return -1;
                if (b.riskLevel.includes('RUPTURE')) return 1;
                if (a.riskLevel.includes('RISQUE')) return -1;
                if (b.riskLevel.includes('RISQUE')) return 1;
                return 0;
            });
        },

        // 🤖 Générer suggestions d'approvisionnement automatique
        generateReorderSuggestions() {
            const predictions = this.predictStockLevels(30);
            const abc = this.performABCAnalysis();
            const suggestions = [];

            predictions.forEach(pred => {
                if (pred.willGoUnderMinimum || pred.currentStock < pred.minStock) {
                    const abcItem = abc.find(a => a.id === pred.id);
                    const product = CORE.getVisibleProducts().find(p => p.id === pred.id);

                    // Déterminer la quantité optimale à commander
                    let orderQty = product.minStock * 3; // Commande 3x le minimum par défaut
                    if (abcItem?.category === 'A') orderQty = product.minStock * 4; // Plus pour les produits critiques
                    if (abcItem?.category === 'C') orderQty = product.minStock * 2; // Moins pour les produits ordinaires

                    // Urgence
                    let urgency = 'NORMAL';
                    if (pred.currentStock < product.minStock) urgency = '🔴 URGENT';
                    else if (pred.daysUntilStockOut < 7) urgency = '🟡 HAUTE';
                    else if (pred.daysUntilStockOut < 14) urgency = '🟠 MOYEN';

                    suggestions.push({
                        id: 'sugg_' + CORE.uid() + '_' + pred.id,
                        productId: pred.id,
                        productName: pred.name,
                        sku: pred.sku,
                        currentStock: pred.currentStock,
                        minStock: pred.minStock,
                        suggestedQty: Math.ceil(orderQty),
                        estimatedCost: (product.costPrice || 0) * orderQty,
                        urgency: urgency,
                        reason: pred.riskLevel,
                        daysUntilStockOut: pred.daysUntilStockOut,
                        abcCategory: abcItem?.category || 'N/A',
                        priority: abcItem?.category === 'A' ? 1 : abcItem?.category === 'B' ? 2 : 3,
                        createdAt: new Date().toISOString(),
                        status: 'pending',
                        estimatedDelivery: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString()
                    });
                }
            });

            // Trier par urgence et priorité
            suggestions.sort((a, b) => {
                if (a.priority !== b.priority) return a.priority - b.priority;
                return b.urgency.localeCompare(a.urgency);
            });

            CORE.db.reorderSuggestions = suggestions;
            CORE.save();
            return suggestions;
        },

        // ⚠️ Gestion des alertes de péremption/obsolescence
        generateExpiryAlerts() {
            const alerts = [];
            const now = new Date();
            const products = CORE.getVisibleProducts();

            products.forEach(product => {
                let alert = null;
                let severity = 'INFO';
                let reason = '';

                // Vérifier la date de péremption si disponible
                if (product.expiryDate) {
                    const expiryDate = new Date(product.expiryDate);
                    const daysUntilExpiry = Math.floor((expiryDate - now) / (1000 * 60 * 60 * 24));

                    if (daysUntilExpiry < 0) {
                        severity = '🔴 EXPIRÉ';
                        reason = `Expiré depuis ${Math.abs(daysUntilExpiry)} jour(s)`;
                    } else if (daysUntilExpiry < 7) {
                        severity = '🔴 CRITIQUE';
                        reason = `Expire dans ${daysUntilExpiry} jour(s)`;
                    } else if (daysUntilExpiry < 30) {
                        severity = '🟡 ATTENTION';
                        reason = `Expire dans ${daysUntilExpiry} jour(s)`;
                    } else if (daysUntilExpiry < 60) {
                        severity = '🟠 PRÉAVIS';
                        reason = `Expire dans ${daysUntilExpiry} jour(s)`;
                    }

                    if (severity !== 'INFO') {
                        alert = {
                            id: 'alert_' + CORE.uid() + '_' + product.id,
                            productId: product.id,
                            productName: product.name,
                            sku: product.sku,
                            type: 'expiry',
                            severity: severity,
                            reason: reason,
                            expiryDate: product.expiryDate,
                            daysUntilExpiry: Math.max(0, daysUntilExpiry),
                            stock: product.stock,
                            action: daysUntilExpiry < 7 ? 'PROMO_IMMÉDIATE' : daysUntilExpiry < 30 ? 'PROMO' : 'SURVEILLANCE',
                            createdAt: new Date().toISOString()
                        };
                    }
                }

                // Vérifier l'obsolescence (pas vendu depuis X jours)
                const lastMovement = CORE.getVisibleStockMovements()
                    .filter(m => m.productId === product.id && m.type === 'out')
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];

                if (!lastMovement) {
                    const daysWithoutMovement = Math.floor((now - new Date(product.createdAt)) / (1000 * 60 * 60 * 24));
                    if (daysWithoutMovement > 90) {
                        severity = '🟡 OBSOLÈTE';
                        reason = `Aucune vente depuis ${daysWithoutMovement} jour(s)`;
                        alert = {
                            id: 'alert_' + CORE.uid() + '_obs_' + product.id,
                            productId: product.id,
                            productName: product.name,
                            sku: product.sku,
                            type: 'obsolescence',
                            severity: severity,
                            reason: reason,
                            daysWithoutMovement: daysWithoutMovement,
                            stock: product.stock,
                            action: 'REVOIR_PRIX',
                            createdAt: new Date().toISOString()
                        };
                    }
                } else {
                    const daysSinceLastMovement = Math.floor((now - new Date(lastMovement.createdAt)) / (1000 * 60 * 60 * 24));
                    if (daysSinceLastMovement > 60 && product.stock > product.minStock * 2) {
                        severity = '🟠 LENT';
                        reason = `Faible rotation (${daysSinceLastMovement} jours sans vente)`;
                        alert = {
                            id: 'alert_' + CORE.uid() + '_slow_' + product.id,
                            productId: product.id,
                            productName: product.name,
                            sku: product.sku,
                            type: 'slow_moving',
                            severity: severity,
                            reason: reason,
                            daysSinceLastSale: daysSinceLastMovement,
                            stock: product.stock,
                            action: 'PROMO_OU_RÉDUCTION',
                            createdAt: new Date().toISOString()
                        };
                    }
                }

                if (alert) alerts.push(alert);
            });

            CORE.db.expiryAlerts = alerts;
            CORE.save();
            return alerts;
        },

        // Interface d'affichage - Tableau de bord Gestion Intelligente
        showSmartStockDashboard() {
            const predictions = this.predictStockLevels(30);
            const abc = this.performABCAnalysis();
            const suggestions = this.generateReorderSuggestions();
            const alerts = this.generateExpiryAlerts();

            const criticalCount = predictions.filter(p => p.riskLevel.includes('RUPTURE')).length;
            const atRiskCount = predictions.filter(p => p.riskLevel.includes('RISQUE')).length;
            const expiryAlertsCount = alerts.filter(a => a.type === 'expiry').length;
            const obsoleteCount = alerts.filter(a => a.type === 'obsolescence').length;

            UI.modal('🤖 Gestion Intelligente du Stock', `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <!-- Indicateurs clés -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="p-4 bg-red-50 border border-red-200 rounded-2xl">
                            <div class="text-xs text-red-600 font-black uppercase">Rupture</div>
                            <div class="text-3xl font-black text-red-700 mt-2">${criticalCount}</div>
                            <div class="text-[10px] text-red-600 mt-1">Produits à risque immédiat</div>
                        </div>
                        <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                            <div class="text-xs text-amber-600 font-black uppercase">Risque</div>
                            <div class="text-3xl font-black text-amber-700 mt-2">${atRiskCount}</div>
                            <div class="text-[10px] text-amber-600 mt-1">Sous le minimum</div>
                        </div>
                        <div class="p-4 bg-orange-50 border border-orange-200 rounded-2xl">
                            <div class="text-xs text-orange-600 font-black uppercase">Péremption</div>
                            <div class="text-3xl font-black text-orange-700 mt-2">${expiryAlertsCount}</div>
                            <div class="text-[10px] text-orange-600 mt-1">À gérer d'urgence</div>
                        </div>
                        <div class="p-4 bg-purple-50 border border-purple-200 rounded-2xl">
                            <div class="text-xs text-purple-600 font-black uppercase">Obsolète</div>
                            <div class="text-3xl font-black text-purple-700 mt-2">${obsoleteCount}</div>
                            <div class="text-[10px] text-purple-600 mt-1">Faible rotation</div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="flex gap-2 border-b border-slate-200">
                        <button onclick="ManagerModule.showStockPredictions()" class="px-4 py-3 font-black text-sm border-b-2 border-blue-500 text-blue-600">📈 Prédictions</button>
                        <button onclick="ManagerModule.showABCAnalysis()" class="px-4 py-3 font-black text-sm text-slate-500 hover:text-slate-700">📊 Analyse ABC</button>
                        <button onclick="ManagerModule.showReorderSuggestions()" class="px-4 py-3 font-black text-sm text-slate-500 hover:text-slate-700">🤖 Suggestions</button>
                        <button onclick="ManagerModule.showExpiryAlerts()" class="px-4 py-3 font-black text-sm text-slate-500 hover:text-slate-700">⚠️ Alertes</button>
                    </div>

                    <!-- Contenu prédictions -->
                    <div id="smartstock-content" class="space-y-3">
                        ${predictions.slice(0, 10).map(p => `
                            <div class="p-4 rounded-xl border ${p.riskLevel.includes('RUPTURE') ? 'border-red-300 bg-red-50' : p.riskLevel.includes('RISQUE') ? 'border-amber-300 bg-amber-50' : 'border-emerald-300 bg-emerald-50'} flex items-center justify-between">
                                <div>
                                    <div class="font-black text-slate-900">${Utils.escapeHtml(p.name)} <span class="text-xs text-slate-500">(${Utils.escapeHtml(p.sku)})</span></div>
                                    <div class="text-sm text-slate-600 mt-1">
                                        Stock: <b>${p.currentStock}</b> → Prédit: <b>${p.predictedStock}</b> | Consommation: <b>${p.avgDailyConsumption}/jour</b>
                                    </div>
                                    <div class="text-xs text-slate-500 mt-1">Rupture dans ${p.daysUntilStockOut} jours • Confiance: ${p.confidence}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-black">${p.riskLevel}</div>
                                    <button onclick="ManagerModule.createReorder(${p.id})" class="mt-2 px-3 py-1 text-xs font-black rounded-lg bg-blue-600 text-white hover:bg-blue-700">Commander</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `, [
                { label: 'Exporter Rapport', onclick: 'ManagerModule.exportSmartStockReport()', class: 'px-4 py-2 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showStockPredictions() {
            const predictions = CORE.db.stockPredictions || this.predictStockLevels(30);
            document.getElementById('smartstock-content').innerHTML = predictions.map(p => `
                <div class="p-4 rounded-xl border ${p.riskLevel.includes('RUPTURE') ? 'border-red-300 bg-red-50' : p.riskLevel.includes('RISQUE') ? 'border-amber-300 bg-amber-50' : 'border-emerald-300 bg-emerald-50'} flex items-center justify-between">
                    <div>
                        <div class="font-black text-slate-900">${p.name} <span class="text-xs text-slate-500">(${p.sku})</span></div>
                        <div class="text-sm text-slate-600 mt-1">
                            Stock: <b>${p.currentStock}</b> → Prédit: <b>${p.predictedStock}</b> | Consommation: <b>${p.avgDailyConsumption}/jour</b>
                        </div>
                        <div class="text-xs text-slate-500 mt-1">Rupture dans ${p.daysUntilStockOut} jours • Confiance: ${p.confidence}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-black">${p.riskLevel}</div>
                        <button onclick="ManagerModule.createReorder(${p.id})" class="mt-2 px-3 py-1 text-xs font-black rounded-lg bg-blue-600 text-white hover:bg-blue-700">Commander</button>
                    </div>
                </div>
            `).join('');
        },

        showABCAnalysis() {
            const abc = CORE.db.stockAnalysisABC || this.performABCAnalysis();
            document.getElementById('smartstock-content').innerHTML = `
                <div class="space-y-4">
                    ${['A', 'B', 'C'].map(cat => {
                        const items = abc.filter(a => a.category === cat);
                        const label = cat === 'A' ? '🔴 CRITIQUE (80% CA)' : cat === 'B' ? '🟡 IMPORTANT (15% CA)' : '🟢 NORMAL (5% CA)';
                        return `
                            <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                <div class="font-black text-slate-900 mb-3">${label}</div>
                                <div class="space-y-2">
                                    ${items.slice(0, 8).map(item => `
                                        <div class="p-3 bg-white rounded-lg border border-slate-100 flex items-center justify-between">
                                            <div class="flex-1">
                                                <div class="font-black text-slate-900 text-sm">${item.name}</div>
                                                <div class="text-xs text-slate-600 mt-1">CA: ${CORE.formatPrice(item.revenue)} • Stock: ${item.stock} • Marge: ${CORE.formatPrice(item.profitValue)}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-black text-slate-900">${item.revenuePct.toFixed(1)}%</div>
                                                <div class="text-xs text-slate-500">CA cumulé</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        },

        showReorderSuggestions() {
            const suggestions = CORE.db.reorderSuggestions || this.generateReorderSuggestions();
            document.getElementById('smartstock-content').innerHTML = suggestions.length === 0 ? `
                <div class="text-center py-10 text-slate-400">✅ Aucune suggestion d'approvisionnement</div>
            ` : suggestions.map(s => `
                <div class="p-4 rounded-xl border border-slate-200 bg-slate-50 flex items-start justify-between">
                    <div>
                        <div class="font-black text-slate-900">${s.productName} <span class="text-xs text-slate-500">${s.sku}</span></div>
                        <div class="text-sm text-slate-600 mt-1">
                            Stock: ${s.currentStock} → Suggéré: <b>${s.suggestedQty}</b> unités
                        </div>
                        <div class="text-xs text-slate-500 mt-1">
                            Catégorie ${s.abcCategory} • Urgence: ${s.urgency} • Coût: ${CORE.formatPrice(s.estimatedCost)}
                        </div>
                        <div class="text-[10px] text-slate-400 mt-1">Raison: ${s.reason}</div>
                    </div>
                    <button onclick="ManagerModule.acceptReorderSuggestion('${s.id}')" class="px-3 py-2 rounded-lg bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700">✓ Accepter</button>
                </div>
            `).join('');
        },

        showExpiryAlerts() {
            const alerts = CORE.db.expiryAlerts || this.generateExpiryAlerts();
            document.getElementById('smartstock-content').innerHTML = alerts.length === 0 ? `
                <div class="text-center py-10 text-slate-400">✅ Aucune alerte de péremption</div>
            ` : alerts.map(a => `
                <div class="p-4 rounded-xl border ${a.type === 'expiry' ? 'border-red-200 bg-red-50' : a.type === 'obsolescence' ? 'border-purple-200 bg-purple-50' : 'border-orange-200 bg-orange-50'} flex items-start justify-between">
                    <div>
                        <div class="font-black ${a.type === 'expiry' ? 'text-red-900' : a.type === 'obsolescence' ? 'text-purple-900' : 'text-orange-900'}">${a.productName}</div>
                        <div class="text-sm text-slate-600 mt-1">${a.reason}</div>
                        <div class="text-xs text-slate-500 mt-1">Action recommandée: <b>${a.action}</b></div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-black">${a.severity}</div>
                        <button onclick="alert('Action: ${a.action}')" class="mt-2 px-3 py-1 text-xs font-black rounded-lg bg-slate-700 text-white hover:bg-slate-800">→ Agir</button>
                    </div>
                </div>
            `).join('');
        },

        createReorder(productId) {
            const product = CORE.getVisibleProducts().find(p => p.id === productId);
            if (!product) return;

            const qty = product.minStock * 3;
            const cost = (product.costPrice || 0) * qty;

            UI.modal('Créer une commande d\'approvisionnement', `
                <div class="space-y-4">
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <div class="font-black text-slate-900 mb-2">${product.name}</div>
                        <div class="grid grid-cols-2 gap-4 mt-3">
                            <div>
                                <div class="text-xs text-slate-500 font-black uppercase">Stock actuel</div>
                                <div class="text-2xl font-black text-slate-900">${product.stock}</div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-500 font-black uppercase">Qté à commander</div>
                                <div class="text-2xl font-black text-blue-600">${qty}</div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-500 font-black uppercase">Coût unitaire</div>
                                <div class="text-lg font-black text-slate-900">${CORE.formatPrice(product.costPrice || 0)}</div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-500 font-black uppercase">Coût total</div>
                                <div class="text-2xl font-black text-emerald-600">${CORE.formatPrice(cost)}</div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="font-black text-blue-900 text-sm">ℹ️ Cette commande a été suggérée par le système d'IA</div>
                        <div class="text-xs text-blue-700 mt-2">Vous pouvez ajuster les quantités ou ajouter des commentaires avant de valider.</div>
                    </div>
                </div>
            `, [
                { label: 'Créer la commande', onclick: 'ManagerModule.confirmReorder(' + productId + ', ' + qty + ')', class: 'px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        confirmReorder(productId, qty) {
            const product = CORE.getVisibleProducts().find(p => p.id === productId);
            if (!product) return;

            const order = {
                id: 'po_' + CORE.uid(),
                reference: 'PO-' + Date.now().toString().slice(-6),
                type: 'purchase_order',
                productId: productId,
                productName: product.name,
                qty: qty,
                unitPrice: product.costPrice || 0,
                totalCost: (product.costPrice || 0) * qty,
                status: 'pending',
                createdAt: new Date().toISOString(),
                createdBy: CORE.state.currentUser?.id,
                createdByName: CORE.state.currentUser?.name,
                expectedDelivery: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),
                notes: 'Généré automatiquement par le système d\'IA'
            };

            CORE.db.purchaseOrders = CORE.db.purchaseOrders || [];
            CORE.db.purchaseOrders.push(order);
            ManagerModule.logManagerAction('REORDER_CREATED', `Commande d'approvisionnement créée: ${product.name} (${qty} unités)`, 'stock', productId);
            CORE.save();

            UI.toast('✓ Commande d\'approvisionnement créée', 'success');
            UI.closeModal();
        },

        acceptReorderSuggestion(suggestionId) {
            const suggestion = CORE.db.reorderSuggestions.find(s => s.id === suggestionId);
            if (!suggestion) return;

            this.confirmReorder(suggestion.productId, suggestion.suggestedQty);
            suggestion.status = 'accepted';
            CORE.save();
        },

        exportSmartStockReport() {
            const predictions = CORE.db.stockPredictions || [];
            const abc = CORE.db.stockAnalysisABC || [];
            const suggestions = CORE.db.reorderSuggestions || [];
            const alerts = CORE.db.expiryAlerts || [];

            const report = `
RAPPORT GESTION INTELLIGENTE DU STOCK
Généré le: ${CORE.formatDate(new Date().toISOString())}

========== RÉSUMÉ EXÉCUTIF ==========
Produits à risque de rupture: ${predictions.filter(p => p.riskLevel.includes('RUPTURE')).length}
Produits à risque: ${predictions.filter(p => p.riskLevel.includes('RISQUE')).length}
Suggestions d'approvisionnement: ${suggestions.length}
Alertes de péremption: ${alerts.filter(a => a.type === 'expiry').length}
Produits obsolètes: ${alerts.filter(a => a.type === 'obsolescence').length}

========== PRÉDICTIONS STOCK (30 JOURS) ==========
${predictions.slice(0, 20).map(p => `
${p.name} (${p.sku})
- Stock actuel: ${p.currentStock} → Prédit: ${p.predictedStock}
- Consommation moyenne: ${p.avgDailyConsumption}/jour
- Risque: ${p.riskLevel}
- Confiance: ${p.confidence}
`).join('')}

========== ANALYSE ABC (PARETO) ==========
${['A', 'B', 'C'].map(cat => {
    const items = abc.filter(a => a.category === cat);
    const label = cat === 'A' ? 'CATÉGORIE A - CRITIQUE' : cat === 'B' ? 'CATÉGORIE B - IMPORTANT' : 'CATÉGORIE C - NORMAL';
    return `
${label}
Nombre de produits: ${items.length}
Chiffre d'affaires total: ${CORE.formatPrice(items.reduce((s, i) => s + i.revenue, 0))}
Marge totale: ${CORE.formatPrice(items.reduce((s, i) => s + i.profitValue, 0))}
`;
}).join('')}

========== SUGGESTIONS D'APPROVISIONNEMENT ==========
${suggestions.slice(0, 20).map(s => `
${s.productName} (${s.sku}) - Urgence: ${s.urgency}
- Quantité à commander: ${s.suggestedQty}
- Coût estimé: ${CORE.formatPrice(s.estimatedCost)}
- Raison: ${s.reason}
`).join('')}

========== ALERTES DE PÉREMPTION/OBSOLESCENCE ==========
${alerts.slice(0, 20).map(a => `
${a.productName} (${a.sku})
- Type: ${a.type}
- Sévérité: ${a.severity}
- Raison: ${a.reason}
- Action: ${a.action}
`).join('')}

========== RECOMMANDATIONS ==========
1. Traiter en priorité les produits en rupture immédiate
2. Valider les suggestions d'approvisionnement pour les catégories A et B
3. Gérer les promo pour les produits proches de l'expiration
4. Revoir la stratégie de prix pour les produits obsolètes

Rapport généré par le système d'IA de gestion du stock
            `;

            const blob = new Blob([report], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `smart_stock_report_${new Date().getTime()}.txt`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('✓ Rapport exporté', 'success');
        },

        // ========== PERSONNALISATION ET PRÉFÉRENCES ==========

        // 🎨 Tableau de bord personnalisable avec drag & drop
        showPersonalizationModal() {
            const user = CORE.state.currentUser;
            if (!user) return;

            const userPrefs = CORE.db.userPreferences?.find(p => p.userId === user.id) || {
                userId: user.id,
                userName: user.name,
                theme: 'light',
                language: 'fr',
                compactMode: false,
                enableNotifications: true,
                enableSounds: true,
                defaultDashboard: 'overview',
                sidebarCollapsed: false,
                dateFormat: 'DD/MM/YYYY',
                numberFormat: 'fr-FR'
            };

            const themeSettings = CORE.db.themeSettings?.find(t => t.userId === user.id);
            const alertPrefs = AlertesModule.getAlertPreferences(user.id);
            const silenceSchedules = AlertesModule.getSilenceSchedules(user.id);

            UI.modal('⚙️ Personnalisation & Préférences', `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <!-- Onglets -->
                    <div class="flex gap-2 border-b border-slate-200 overflow-x-auto">
                        <button onclick="document.getElementById('pref-theme').classList.remove('hidden'); document.getElementById('pref-dashboard').classList.add('hidden'); document.getElementById('pref-shortcuts').classList.add('hidden'); document.getElementById('pref-alerts').classList.add('hidden')" class="px-4 py-3 font-black text-sm border-b-2 border-blue-500 text-blue-600 whitespace-nowrap">🎨 Thème</button>
                        <button onclick="document.getElementById('pref-dashboard').classList.remove('hidden'); document.getElementById('pref-theme').classList.add('hidden'); document.getElementById('pref-shortcuts').classList.add('hidden'); document.getElementById('pref-alerts').classList.add('hidden')" class="px-4 py-3 font-black text-sm text-slate-500 hover:text-slate-700 whitespace-nowrap">📊 Dashboard</button>
                        <button onclick="document.getElementById('pref-shortcuts').classList.remove('hidden'); document.getElementById('pref-theme').classList.add('hidden'); document.getElementById('pref-dashboard').classList.add('hidden'); document.getElementById('pref-alerts').classList.add('hidden')" class="px-4 py-3 font-black text-sm text-slate-500 hover:text-slate-700 whitespace-nowrap">⌨️ Raccourcis</button>
                        <button onclick="document.getElementById('pref-alerts').classList.remove('hidden'); document.getElementById('pref-theme').classList.add('hidden'); document.getElementById('pref-dashboard').classList.add('hidden'); document.getElementById('pref-shortcuts').classList.add('hidden')" class="px-4 py-3 font-black text-sm text-slate-500 hover:text-slate-700 whitespace-nowrap">🔔 Alertes</button>
                    </div>

                    <!-- Tab Thème -->
                    <div id="pref-theme" class="space-y-4">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-slate-900 mb-4">🌙 Mode sombre/clair</div>
                            <div class="space-y-3">
                                <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100">
                                    <input type="radio" name="theme" value="light" ${userPrefs.theme === 'light' ? 'checked' : ''} onchange="ManagerModule.saveThemePreference('light')">
                                    <span>☀️ Mode Clair (Jour)</span>
                                </label>
                                <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100">
                                    <input type="radio" name="theme" value="dark" ${userPrefs.theme === 'dark' ? 'checked' : ''} onchange="ManagerModule.saveThemePreference('dark')">
                                    <span>🌙 Mode Sombre (Nuit)</span>
                                </label>
                                <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100">
                                    <input type="radio" name="theme" value="auto" ${userPrefs.theme === 'auto' ? 'checked' : ''} onchange="ManagerModule.saveThemePreference('auto')">
                                    <span>🔄 Auto (Système)</span>
                                </label>
                            </div>
                        </div>

                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-slate-900 mb-4">🎨 Couleur d'accent</div>
                            <div class="grid grid-cols-4 gap-3">
                                ${['blue', 'emerald', 'purple', 'amber', 'red', 'cyan', 'indigo', 'rose'].map(color => `
                                    <button onclick="ManagerModule.setAccentColor('${color}')" class="p-4 rounded-xl font-black text-xs transition hover:scale-110 ${themeSettings?.accentColor === color ? 'ring-4 ring-offset-2' : ''}" style="background: var(--${color}-600, #3b82f6); color: white;">
                                        ${color === themeSettings?.accentColor ? '✓' : ''} ${color}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-slate-900 mb-3">⚙️ Préférences d'interface</div>
                            <div class="space-y-3">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" ${userPrefs.compactMode ? 'checked' : ''} onchange="ManagerModule.updateUserPref('compactMode', this.checked)">
                                    <span class="text-sm font-black">Mode compact</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" ${userPrefs.sidebarCollapsed ? 'checked' : ''} onchange="ManagerModule.updateUserPref('sidebarCollapsed', this.checked)">
                                    <span class="text-sm font-black">Barre latérale réduite</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Dashboard -->
                    <div id="pref-dashboard" class="hidden space-y-4">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-slate-900 mb-4">📊 Layout par défaut</div>
                            <div class="space-y-2">
                                ${['overview', 'inventory', 'finance', 'team'].map(layout => `
                                    <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-100">
                                        <input type="radio" name="defaultDashboard" value="${layout}" ${userPrefs.defaultDashboard === layout ? 'checked' : ''} onchange="ManagerModule.updateUserPref('defaultDashboard', '${layout}')">
                                        <span class="font-black text-sm">${layout === 'overview' ? '📈 Aperçu' : layout === 'inventory' ? '📦 Inventaire' : layout === 'finance' ? '💰 Finance' : '👥 Équipe'}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>

                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                            <div class="font-black text-blue-900 text-sm">ℹ️ Widgets personnalisables</div>
                            <div class="text-xs text-blue-700 mt-2">Glissez & déposez les widgets pour réorganiser votre dashboard</div>
                        </div>

                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-slate-900 mb-3">📌 Widgets visibles</div>
                            <div class="space-y-2">
                                ${['dashboard_overview', 'audit_trail', 'compliance', 'smart_stock', 'recent_orders', 'critical_products'].map((widget, idx) => `
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" checked onchange="ManagerModule.toggleWidget('${widget}', this.checked)">
                                        <span class="text-sm font-black">${widget === 'dashboard_overview' ? '📈 Vue d\'ensemble' : widget === 'audit_trail' ? '📋 Audit' : widget === 'compliance' ? '✅ Conformité' : widget === 'smart_stock' ? '🤖 Stock IA' : widget === 'recent_orders' ? '📦 Commandes' : '⚠️ Produits critiques'}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Tab Raccourcis clavier -->
                    <div id="pref-shortcuts" class="hidden space-y-4">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-slate-900 mb-4">⌨️ Raccourcis clavier</div>
                            <div class="space-y-2 max-h-96 overflow-y-auto">
                                <div class="grid grid-cols-2 gap-4 text-xs">
                                    <div class="p-3 bg-white rounded-lg border border-slate-200">
                                        <span class="font-black">Ctrl + K</span>
                                        <div class="text-slate-600 mt-1">Palette de commandes</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-lg border border-slate-200">
                                        <span class="font-black">Ctrl + /</span>
                                        <div class="text-slate-600 mt-1">Aide (raccourcis)</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-lg border border-slate-200">
                                        <span class="font-black">Ctrl + D</span>
                                        <div class="text-slate-600 mt-1">Dashboard</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-lg border border-slate-200">
                                        <span class="font-black">Ctrl + 1</span>
                                        <div class="text-slate-600 mt-1">Inventaire</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-lg border border-slate-200">
                                        <span class="font-black">Ctrl + 2</span>
                                        <div class="text-slate-600 mt-1">Finance</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-lg border border-slate-200">
                                        <span class="font-black">Ctrl + 3</span>
                                        <div class="text-slate-600 mt-1">Équipe</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-lg border border-slate-200">
                                        <span class="font-black">Ctrl + S</span>
                                        <div class="text-slate-600 mt-1">Recherche</div>
                                    </div>
                                    <div class="p-3 bg-white rounded-lg border border-slate-200">
                                        <span class="font-black">Esc</span>
                                        <div class="text-slate-600 mt-1">Fermer modal</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                            <div class="font-black text-emerald-900 text-sm">✅ Raccourcis clavier activés</div>
                            <div class="text-xs text-emerald-700 mt-2">Appuyez sur Ctrl + / pour voir tous les raccourcis</div>
                        </div>
                    </div>

                    <!-- Tab Alertes Intelligentes -->
                    <div id="pref-alerts" class="hidden space-y-4">
                        <!-- Types d'alertes -->
                        <div class="grid grid-cols-3 gap-3">
                            <div class="p-3 bg-blue-50 rounded-lg border border-blue-200 text-center">
                                <span class="font-black text-blue-700">🔵 Info</span>
                                <div class="text-xs text-blue-600 mt-1">Informations générales</div>
                            </div>
                            <div class="p-3 bg-amber-50 rounded-lg border border-amber-200 text-center">
                                <span class="font-black text-amber-700">🟡 Attention</span>
                                <div class="text-xs text-amber-600 mt-1">À surveiller</div>
                            </div>
                            <div class="p-3 bg-red-50 rounded-lg border border-red-200 text-center">
                                <span class="font-black text-red-700">🔴 Critique</span>
                                <div class="text-xs text-red-600 mt-1">Action requise</div>
                            </div>
                        </div>

                        <!-- Préférences d'alertes par type -->
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-slate-900 mb-4">🔔 Alertes par type</div>
                            <div class="space-y-3">
                                ${Object.entries(alertPrefs.alerts || {}).map(([type, config]) => `
                                    <div class="p-3 border border-slate-200 rounded-lg bg-white">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="font-black text-sm">
                                                ${type === 'stock_low' ? '📦' : type === 'stock_critical' ? '🚨' : type === 'order_pending' ? '⏳' : type === 'inactive_livreur' ? '😴' : type === 'critical_incident' ? '🔴' : '📊'}
                                                ${type.replace(/_/g, ' ')}
                                            </span>
                                            <label class="flex items-center gap-2">
                                                <input type="checkbox" ${config.enabled ? 'checked' : ''} onchange="AlertesModule.updateAlertPreference(${user.id}, '${type}', this.checked, '${config.level}', ${config.sendEmail || false}, ${config.sendSms || false}); App.rerender()">
                                                <span class="text-xs font-black">Actif</span>
                                            </label>
                                        </div>
                                        <div class="flex gap-2 items-center text-xs">
                                            <span>Niveau:</span>
                                            <select onchange="AlertesModule.updateAlertPreference(${user.id}, '${type}', ${config.enabled}, this.value, ${config.sendEmail || false}, ${config.sendSms || false}); App.rerender()" class="px-2 py-1 rounded border border-slate-300 text-xs font-black">
                                                <option value="info" ${config.level === 'info' ? 'selected' : ''}>Info</option>
                                                <option value="attention" ${config.level === 'attention' ? 'selected' : ''}>Attention</option>
                                                <option value="critique" ${config.level === 'critique' ? 'selected' : ''}>Critique</option>
                                            </select>
                                            ${['stock_critical', 'critical_incident'].includes(type) ? `
                                                <label class="flex items-center gap-1 cursor-pointer ml-auto">
                                                    <input type="checkbox" ${config.sendEmail ? 'checked' : ''} onchange="AlertesModule.updateAlertPreference(${user.id}, '${type}', ${config.enabled}, '${config.level}', this.checked, ${config.sendSms || false}); App.rerender()">
                                                    <span class="text-xs">📧 Email</span>
                                                </label>
                                                <label class="flex items-center gap-1 cursor-pointer">
                                                    <input type="checkbox" ${config.sendSms ? 'checked' : ''} onchange="AlertesModule.updateAlertPreference(${user.id}, '${type}', ${config.enabled}, '${config.level}', ${config.sendEmail || false}, this.checked); App.rerender()">
                                                    <span class="text-xs">📱 SMS</span>
                                                </label>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Mode Silence Programmable -->
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-slate-900 mb-4">🤐 Mode silence programmable</div>
                            <div class="space-y-3">
                                ${silenceSchedules.length > 0 ? silenceSchedules.map((schedule, idx) => `
                                    <div class="p-3 bg-white rounded-lg border border-slate-200 flex items-center justify-between">
                                        <div>
                                            <div class="font-black text-sm">${schedule.name}</div>
                                            <div class="text-xs text-slate-500">⏰ ${schedule.startTime} - ${schedule.endTime}</div>
                                        </div>
                                        <button onclick="AlertesModule.deleteSilenceSchedule(${schedule.id}); App.rerender()" class="px-2 py-1 text-xs font-black bg-red-100 text-red-600 rounded hover:bg-red-200">Supprimer</button>
                                    </div>
                                `).join('') : `<div class="text-center text-sm text-slate-500">Aucun mode silence configuré</div>`}

                                <button onclick="AlertesModule.showAddSilenceSchedule(${user.id})" class="w-full px-3 py-2 bg-emerald-600 text-white font-black rounded-lg hover:bg-emerald-700 mt-2">+ Ajouter un mode silence</button>
                            </div>
                        </div>

                        <!-- Informations de contact pour alertes critiques -->
                        <div class="p-4 bg-blue-50 rounded-2xl border border-blue-200">
                            <div class="font-black text-blue-900 mb-3">📬 Contact pour alertes critiques</div>
                            <div class="space-y-2">
                                <input type="email" placeholder="Email" value="${alertPrefs.emailAddress || ''}" onchange="AlertesModule.updateContactInfo(${user.id}, 'email', this.value)" class="w-full px-3 py-2 border border-blue-300 rounded-lg text-xs font-black placeholder-blue-400">
                                <input type="tel" placeholder="Téléphone" value="${alertPrefs.phoneNumber || ''}" onchange="AlertesModule.updateContactInfo(${user.id}, 'phone', this.value)" class="w-full px-3 py-2 border border-blue-300 rounded-lg text-xs font-black placeholder-blue-400">
                            </div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Réinitialiser', onclick: 'ManagerModule.resetPreferences()', class: 'px-4 py-2 bg-slate-600 text-white font-black rounded-xl hover:bg-slate-700' },
                { label: 'Exporter', onclick: 'ManagerModule.exportPreferences()', class: 'px-4 py-2 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        // 🌙 Gestion du thème sombre/clair
        saveThemePreference(theme) {
            const user = CORE.state.currentUser;
            if (!user) return;

            let userPrefs = CORE.db.userPreferences?.find(p => p.userId === user.id);
            if (!userPrefs) {
                userPrefs = { userId: user.id, userName: user.name };
                CORE.db.userPreferences = CORE.db.userPreferences || [];
                CORE.db.userPreferences.push(userPrefs);
            }

            userPrefs.theme = theme;
            this.applyTheme(theme);
            CORE.save();
            localStorage.setItem('user_theme_' + user.id, theme);
            UI.toast(`✓ Thème changé: ${theme === 'light' ? 'Clair' : theme === 'dark' ? 'Sombre' : 'Auto'}`, 'success');
        },

        applyTheme(theme) {
            const html = document.documentElement;

            if (theme === 'dark') {
                html.style.filter = 'invert(1) hue-rotate(180deg)';
                html.style.backgroundColor = '#000';
                document.body.style.backgroundColor = '#000';
            } else if (theme === 'light') {
                html.style.filter = 'none';
                html.style.backgroundColor = '#fff';
                document.body.style.backgroundColor = '#fff';
            } else if (theme === 'auto') {
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.filter = isDark ? 'invert(1) hue-rotate(180deg)' : 'none';
                html.style.backgroundColor = isDark ? '#000' : '#fff';
            }
        },

        setAccentColor(color) {
            const user = CORE.state.currentUser;
            if (!user) return;

            let themeSettings = CORE.db.themeSettings?.find(t => t.userId === user.id);
            if (!themeSettings) {
                themeSettings = { userId: user.id, accentColor: color };
                CORE.db.themeSettings = CORE.db.themeSettings || [];
                CORE.db.themeSettings.push(themeSettings);
            } else {
                themeSettings.accentColor = color;
            }

            CORE.save();
            localStorage.setItem('user_accent_' + user.id, color);
            UI.toast(`✓ Couleur d'accent changée`, 'success');
        },

        // 🔧 Raccourcis clavier
        setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl + K = Palette de commandes
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    this.showCommandPalette();
                }
                // Ctrl + / = Aide
                if (e.ctrlKey && e.key === '/') {
                    e.preventDefault();
                    this.showKeyboardHelp();
                }
                // Ctrl + D = Dashboard
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    this.navigateTo('dashboard');
                }
                // Ctrl + 1 = Inventaire
                if (e.ctrlKey && e.key === '1') {
                    e.preventDefault();
                    this.navigateTo('inventory');
                }
                // Ctrl + 2 = Finance
                if (e.ctrlKey && e.key === '2') {
                    e.preventDefault();
                    this.navigateTo('finance');
                }
                // Ctrl + 3 = Équipe
                if (e.ctrlKey && e.key === '3') {
                    e.preventDefault();
                    this.navigateTo('team');
                }
                // Ctrl + S = Recherche
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    this.showSearchModal();
                }
                // Esc = Fermer modal
                if (e.key === 'Escape') {
                    UI.closeModal();
                }
            });
        },

        showCommandPalette() {
            let query = '';
            const commands = [
                { name: 'Dashboard', icon: '📈', action: 'ManagerModule.navigateTo("dashboard")' },
                { name: 'Inventaire', icon: '📦', action: 'ManagerModule.navigateTo("inventory")' },
                { name: 'Finance', icon: '💰', action: 'ManagerModule.navigateTo("finance")' },
                { name: 'Équipe', icon: '👥', action: 'ManagerModule.navigateTo("team")' },
                { name: 'Audit Trail', icon: '📋', action: 'ManagerModule.showAuditTrailModal()' },
                { name: 'Rapport de Conformité', icon: '✅', action: 'ManagerModule.showComplianceReport()' },
                { name: 'Gestion Intelligente', icon: '🤖', action: 'ManagerModule.showSmartStockDashboard()' },
                { name: 'Préférences', icon: '⚙️', action: 'ManagerModule.showPersonalizationModal()' },
                { name: 'Déconnexion', icon: '🚪', action: 'CORE.logout()' }
            ];

            UI.modal('🔍 Palette de Commandes', `
                <div class="space-y-3">
                    <input id="cmd-search" type="text" placeholder="Rechercher une commande..." class="w-full px-4 py-3 rounded-xl border border-slate-300 outline-none focus:ring-2 focus:ring-blue-500 font-black" onkeyup="ManagerModule.filterCommands(this.value)">
                    <div id="cmd-list" class="space-y-2 max-h-80 overflow-y-auto">
                        ${commands.map((cmd, idx) => `
                            <div id="cmd-${idx}" class="p-3 rounded-lg border border-slate-200 bg-slate-50 cursor-pointer hover:bg-blue-50 transition flex items-center gap-3" onclick="${cmd.action}; UI.closeModal();">
                                <span class="text-xl">${cmd.icon}</span>
                                <div>
                                    <div class="font-black text-slate-900">${cmd.name}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);

            setTimeout(() => document.getElementById('cmd-search')?.focus(), 100);
        },

        filterCommands(query) {
            const items = document.querySelectorAll('[id^="cmd-"]');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query.toLowerCase()) ? 'flex' : 'none';
            });
        },

        showKeyboardHelp() {
            UI.modal('⌨️ Aide - Raccourcis clavier', `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-xs text-slate-600 uppercase mb-3">Navigation</div>
                            <div class="space-y-2 text-sm">
                                <div><span class="font-black bg-slate-200 px-2 py-1 rounded">Ctrl + D</span> Dashboard</div>
                                <div><span class="font-black bg-slate-200 px-2 py-1 rounded">Ctrl + 1</span> Inventaire</div>
                                <div><span class="font-black bg-slate-200 px-2 py-1 rounded">Ctrl + 2</span> Finance</div>
                                <div><span class="font-black bg-slate-200 px-2 py-1 rounded">Ctrl + 3</span> Équipe</div>
                            </div>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="font-black text-xs text-slate-600 uppercase mb-3">Recherche & Commandes</div>
                            <div class="space-y-2 text-sm">
                                <div><span class="font-black bg-slate-200 px-2 py-1 rounded">Ctrl + K</span> Palette</div>
                                <div><span class="font-black bg-slate-200 px-2 py-1 rounded">Ctrl + S</span> Recherche</div>
                                <div><span class="font-black bg-slate-200 px-2 py-1 rounded">Esc</span> Fermer</div>
                            </div>
                        </div>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showSearchModal() {
            UI.modal('🔍 Recherche Globale', `
                <div class="space-y-4">
                    <input id="global-search" type="text" placeholder="Rechercher partout..." class="w-full px-4 py-3 rounded-xl border border-slate-300 outline-none focus:ring-2 focus:ring-blue-500 font-black" onkeyup="ManagerModule.performGlobalSearch(this.value)">
                    <div id="search-results" class="space-y-2 max-h-80 overflow-y-auto">
                        <div class="text-center text-slate-400">Entrez une recherche...</div>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);

            setTimeout(() => document.getElementById('global-search')?.focus(), 100);
        },

        performGlobalSearch(query) {
            if (!query || query.length < 2) {
                document.getElementById('search-results').innerHTML = '<div class="text-center text-slate-400">Entrez au moins 2 caractères...</div>';
                return;
            }

            const q = query.toLowerCase();
            const results = [];

            // Chercher dans les produits
            CORE.getVisibleProducts().slice(0, 5).forEach(p => {
                if (p.name.toLowerCase().includes(q) || p.sku?.toLowerCase().includes(q)) {
                    results.push({ type: 'product', name: p.name, icon: '📦' });
                }
            });

            // Chercher dans les commandes
            CORE.getVisibleOrders().slice(0, 5).forEach(o => {
                if (o.reference.toLowerCase().includes(q)) {
                    results.push({ type: 'order', name: o.reference, icon: '🛒' });
                }
            });

            // Chercher dans les utilisateurs
            CORE.getVisibleUsers().slice(0, 5).forEach(u => {
                if (u.name.toLowerCase().includes(q) || u.email?.toLowerCase().includes(q)) {
                    results.push({ type: 'user', name: u.name, icon: '👤' });
                }
            });

            if (results.length === 0) {
                document.getElementById('search-results').innerHTML = '<div class="text-center text-slate-400">Aucun résultat trouvé</div>';
                return;
            }

            document.getElementById('search-results').innerHTML = results.map(r => `
                <div class="p-3 rounded-lg border border-slate-200 bg-slate-50 cursor-pointer hover:bg-blue-50 transition flex items-center gap-3">
                    <span class="text-xl">${r.icon}</span>
                    <div>
                        <div class="font-black text-slate-900">${Utils.escapeHtml(r.name)}</div>
                        <div class="text-xs text-slate-500">${Utils.escapeHtml(r.type)}</div>
                    </div>
                </div>
            `).join('');
        },

        // 💾 Gestion des préférences utilisateur
        updateUserPref(key, value) {
            const user = CORE.state.currentUser;
            if (!user) return;

            let userPrefs = CORE.db.userPreferences?.find(p => p.userId === user.id);
            if (!userPrefs) {
                userPrefs = { userId: user.id, userName: user.name };
                CORE.db.userPreferences = CORE.db.userPreferences || [];
                CORE.db.userPreferences.push(userPrefs);
            }

            userPrefs[key] = value;
            CORE.save();
            localStorage.setItem('user_pref_' + key + '_' + user.id, JSON.stringify(value));
        },

        toggleWidget(widgetId, visible) {
            const user = CORE.state.currentUser;
            if (!user) return;

            let config = CORE.db.widgetConfigs?.find(c => c.userId === user.id);
            if (!config) {
                config = { userId: user.id, widgets: {} };
                CORE.db.widgetConfigs = CORE.db.widgetConfigs || [];
                CORE.db.widgetConfigs.push(config);
            }

            if (!config.widgets) config.widgets = {};
            config.widgets[widgetId] = visible;
            CORE.save();
        },

        resetPreferences() {
            if (!confirm('Êtes-vous sûr de vouloir réinitialiser toutes les préférences?')) return;

            const user = CORE.state.currentUser;
            if (!user) return;

            // Supprimer les préférences utilisateur
            const prefIdx = CORE.db.userPreferences?.findIndex(p => p.userId === user.id);
            if (prefIdx >= 0) CORE.db.userPreferences.splice(prefIdx, 1);

            // Supprimer les paramètres de thème
            const themeIdx = CORE.db.themeSettings?.findIndex(t => t.userId === user.id);
            if (themeIdx >= 0) CORE.db.themeSettings.splice(themeIdx, 1);

            // Supprimer les layouts
            const layoutIdx = CORE.db.dashboardLayouts?.findIndex(l => l.userId === user.id);
            if (layoutIdx >= 0) CORE.db.dashboardLayouts.splice(layoutIdx, 1);

            CORE.save();
            localStorage.removeItem('user_theme_' + user.id);
            UI.toast('✓ Préférences réinitialisées', 'success');
            setTimeout(() => location.reload(), 500);
        },

        exportPreferences() {
            const user = CORE.state.currentUser;
            if (!user) return;

            const userPrefs = CORE.db.userPreferences?.find(p => p.userId === user.id) || {};
            const themeSettings = CORE.db.themeSettings?.find(t => t.userId === user.id) || {};
            const widgets = CORE.db.widgetConfigs?.find(c => c.userId === user.id)?.widgets || {};

            const data = {
                exportedAt: new Date().toISOString(),
                user: user.name,
                preferences: userPrefs,
                theme: themeSettings,
                widgets: widgets
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.setAttribute('href', URL.createObjectURL(blob));
            link.setAttribute('download', `preferences_${user.id}_${Date.now()}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('✓ Préférences exportées', 'success');
        },

        loadUserPreferences() {
            const user = CORE.state.currentUser;
            if (!user) return;

            // Charger le thème sauvegardé
            const savedTheme = localStorage.getItem('user_theme_' + user.id);
            if (savedTheme) {
                this.applyTheme(savedTheme);
            }

            // Charger les autres préférences
            const userPrefs = CORE.db.userPreferences?.find(p => p.userId === user.id);
            if (userPrefs?.compactMode) {
                document.body.classList.add('compact-mode');
            }

            // Initialiser les raccourcis clavier
            this.setupKeyboardShortcuts();
        }
    };

    // =========================================================
    // MODULE: GESTIONNAIRE (Logistique / Stock)
    // =========================================================
    const GestionnaireModule = {
        // productBelongsToPos — delegate to ManagerModule (shared logic)
        productBelongsToPos(product, posId) {
            if (typeof ManagerModule !== 'undefined' && ManagerModule.productBelongsToPos) {
                return ManagerModule.productBelongsToPos(product, posId);
            }
            if (!posId) return true;
            if (!product) return false;
            const strPosId = String(posId);
            if (String(product.posId) === strPosId) return true;
            const sm = product.posStocks || {};
            const e = sm[strPosId] ?? sm[posId] ?? null;
            // FIX: If posStocks entry EXISTS for this POS, the product belongs here
            // (even if stock=0 or timestamps are missing — the entry itself proves assignment)
            if (e) return true;
            return false;
        },

        state: {
            currentView: 'dashboard',
            financeView: 'overview',
            theme: 'light',
            notificationsEnabled: true,
            preferences: { notificationsEnabled: true, soundEnabled: true, soundVolume: 0.8 },
            slaThresholds: { minOnTimeRate: 80, maxPendingOrders: 10, minDailyDeposits: 50000, maxDeliveryMinutes: 60 },
            kpiTimerId: null,
            notifications: [],
            notificationHistory: [],
            notificationFilters: NotificationUtils.defaultFilters(),
            criticalAlerts: {},
            transferReceiptsTab: 'pending',
            pendingReceiptFiles: [],
            // Livraisons filtres
            deliveryStatus: 'all',
            deliverySearch: '',
            // Stock pagination et filtres
            stockSearch: '',
            stockCategoryFilter: 'all',
            stockStatusFilter: 'all',
            stockSortBy: 'name',
            stockViewMode: 'table',
            stockPage: 1,
            stockPerPage: 50,
            stockTab: 'dashboard', // dashboard | indicators | history | analysis | recommendations
            // Cache système
            cache: {
                products: { data: null, timestamp: 0, ttl: 30000 },
                stocks: { data: null, timestamp: 0, ttl: 20000 },
                movements: { data: null, timestamp: 0, ttl: 30000 }
            }
        },

        // ============ SYSTÈME DE CACHING ============
        getCachedData(key) {
            const cache = this.state.cache[key];
            if (!cache) return null;
            const now = Date.now();
            if (now - cache.timestamp > cache.ttl) {
                cache.data = null;
                return null;
            }
            return cache.data;
        },

        setCachedData(key, data) {
            if (this.state.cache[key]) {
                this.state.cache[key].data = data;
                this.state.cache[key].timestamp = Date.now();
            }
        },

        invalidateCache(keys = null) {
            if (!keys) {
                Object.keys(this.state.cache).forEach(k => {
                    this.state.cache[k].data = null;
                });
            } else {
                (Array.isArray(keys) ? keys : [keys]).forEach(k => {
                    if (this.state.cache[k]) this.state.cache[k].data = null;
                });
            }
        },

        getProductsOptimized() {
            let cached = this.getCachedData('products');
            if (cached) return cached;

            const posId = CORE.state.currentUser?.pos || CORE.state.currentUser?.storeId;

            // SELF-HEALING: Fix posStocks key mismatch from earlier broken transfers
            // When confirmTransferReception used transfer.destPosId instead of user.pos,
            // posStocks was written to a wrong key. Detect and copy to user's actual POS key.
            if (posId && !this._posStocksHealed) {
                this._posStocksHealed = true;
                const strPosId = String(posId);
                let healed = 0;
                (CORE.db.products || []).forEach(p => {
                    if (!p.posStocks) return;
                    // Skip if product already has entry for user's POS
                    if (p.posStocks[strPosId] || p.posStocks[posId]) return;
                    // Look for any posStocks entry that has lastTransfer (= was set by transfer reception)
                    const keys = Object.keys(p.posStocks);
                    let bestEntry = null;
                    let bestKey = null;
                    for (const k of keys) {
                        const entry = p.posStocks[k];
                        if (entry && entry.lastTransfer) {
                            if (!bestEntry || (entry.lastTransfer > bestEntry.lastTransfer)) {
                                bestEntry = entry;
                                bestKey = k;
                            }
                        }
                    }
                    if (bestEntry && bestKey) {
                        // This product had a transfer received but posStocks key doesn't match user's POS
                        // Check if the product was meant for this POS (destPosName matches)
                        console.warn('[SELF-HEAL] Product "' + p.name + '" (id=' + p.id + ') has posStocks[' + bestKey + '] with lastTransfer but no entry for user POS "' + strPosId + '". Copying.');
                        p.posStocks[strPosId] = JSON.parse(JSON.stringify(bestEntry));
                        p.posStocks[strPosId]._healedFrom = bestKey;
                        p.posStocks[strPosId]._healedAt = new Date().toISOString();
                        // Also clear lockedToPosId if it blocks visibility
                        if (p.lockedToPosId && String(p.lockedToPosId) !== strPosId) {
                            p.lockedToPosId = null;
                        }
                        p.updatedAt = new Date().toISOString();
                        healed++;
                    }
                });
                if (healed > 0) {
                    console.log('[SELF-HEAL] Fixed posStocks for ' + healed + ' product(s). Saving...');
                    CORE._productIndex = null;
                    CORE.markDirty('products');
                    CORE.save(true);
                }
            }

            // Utiliser la même logique que ManagerModule.productBelongsToPos()
            // pour que le gestionnaire et le manager voient les mêmes produits
            const _rawProducts = CORE.db.products || [];
            const _allVisible = CORE.getVisibleProducts() || [];
            const _user = CORE.state.currentUser;
            console.log('[DIAG-PRODUCTS] FULL STATE:', {
                posId: posId,
                posIdType: typeof posId,
                userPos: _user?.pos,
                userStoreId: _user?.storeId,
                userPointOfSaleId: _user?.pointOfSaleId,
                userRole: _user?.role,
                userName: _user?.name,
                rawProductsCount: _rawProducts.length,
                visibleProductsCount: _allVisible.length
            });
            // Log ALL raw products (there should be very few)
            _rawProducts.forEach((p, i) => {
                const belongs = (typeof ManagerModule !== 'undefined' && ManagerModule.productBelongsToPos) 
                    ? ManagerModule.productBelongsToPos(p, posId) : 'N/A';
                console.log('[DIAG-PRODUCTS] RAW[' + i + ']:', { 
                    id: p.id, name: p.name, posId: p.posId, posIdType: typeof p.posId,
                    lockedToPosId: p.lockedToPosId, 
                    posStocksKeys: p.posStocks ? Object.keys(p.posStocks) : 'none', 
                    posStocksDetail: p.posStocks ? JSON.stringify(p.posStocks).substring(0, 300) : 'none',
                    stock: p.stock,
                    canAccess: CORE.canAccess('product', p),
                    belongsToPos: belongs
                });
            });
            const products = _allVisible.filter(p => {
                if (typeof ManagerModule !== 'undefined' && ManagerModule.productBelongsToPos) {
                    const result = ManagerModule.productBelongsToPos(p, posId);
                    if (!result) console.log('[DIAG-FILTER] REJECTED by productBelongsToPos:', p.id, p.name);
                    return result;
                }
                // Fallback si ManagerModule non disponible
                if (String(p.posId) === String(posId)) return true;
                if (p.posStocks && p.posStocks[posId]) return true;
                if (p.posStocks && p.posStocks[String(posId)]) return true;
                console.log('[DIAG-FILTER] REJECTED by fallback:', p.id, p.name);
                return false;
            }).map(p => {
                // Enrichir le produit avec le stock du POS actuel
                const posStock = CORE.getProductStock(p.id, posId);
                const posPrice = p.posStocks && p.posStocks[posId] ? (p.posStocks[posId].price || p.price || 0) : (p.price || 0);
                return {
                    ...p,
                    stock: posStock,
                    displayPrice: posPrice
                };
            });

            // SAFETY NET: If 0 products after filter but raw products exist,
            // show ONLY products that belong to this user's company (not other POS)
            if (products.length === 0 && _rawProducts.length > 0) {
                console.error('[DIAG-PRODUCTS] ❌ FILTER PRODUCED 0 PRODUCTS! posId=' + posId + ' type=' + typeof posId);
                // Try to find products with ANY matching criteria (relaxed match)
                const fallbackProducts = _rawProducts.filter(p => {
                    if (p._deleted || p.isMainWarehouse) return false;
                    // Accept if posId matches with loose comparison
                    if (p.posId != null && posId != null && String(p.posId) === String(posId)) return true;
                    if (p.posId == posId) return true;
                    // Accept if ANY posStocks key matches
                    if (posId != null && p.posStocks) {
                        if (p.posStocks[posId] || p.posStocks[String(posId)]) return true;
                    }
                    // Accept if product was created via transfer (it belongs somewhere in our system)
                    if (p.createdViaTransfer && p.posStocks && Object.keys(p.posStocks).length > 0) {
                        console.log('[SAFETY-NET] Including transfer product:', p.name, 'posStocks keys:', Object.keys(p.posStocks));
                        return true;
                    }
                    return false;
                }).map(p => {
                    const posStock = (posId && p.posStocks && (p.posStocks[posId] || p.posStocks[String(posId)]))
                        ? (Number((p.posStocks[posId] || p.posStocks[String(posId)]).stock) || 0)
                        : (p.posStocks ? Object.values(p.posStocks).reduce((s, e) => s + (Number(e?.stock) || 0), 0) : (p.stock || 0));
                    return { ...p, stock: posStock, displayPrice: p.price || 0, _safetyNet: true };
                });
                if (fallbackProducts.length > 0) {
                    console.log('[SAFETY-NET] Showing ' + fallbackProducts.length + ' products via relaxed filter');
                    this.setCachedData('products', fallbackProducts);
                    return fallbackProducts;
                }
            }

            this.setCachedData('products', products);
            return products;
        },

        getStockMovementsOptimized(limit = 100) {
            let cached = this.getCachedData('movements');
            if (cached) return cached;

            const posId = CORE.state.currentUser?.pos || CORE.state.currentUser?.storeId;
            const movements = CORE.getVisibleStockMovements().filter(m => m.posId == posId || !m.posId).slice(0, limit);
            this.setCachedData('movements', movements);
            return movements;
        },

        renderNavItem(view, icon, label, badge = 0) {
            const isActive = this.state.currentView === view;
            return `
                <button onclick="GestionnaireModule.navigateTo('${view}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group ${isActive ? 'bg-gradient-to-r from-cyan-500/20 to-teal-500/10 text-cyan-400 border-l-2 border-cyan-400' : 'text-slate-400 hover:bg-white/5 hover:text-white'}">
                    <div class="w-9 h-9 rounded-xl ${isActive ? 'bg-cyan-500/20' : 'bg-white/5 group-hover:bg-white/10'} flex items-center justify-center transition-all duration-200 relative">
                        <i data-lucide="${icon}" class="w-5 h-5 ${isActive ? 'drop-shadow-[0_0_8px_rgba(6,182,212,0.5)]' : ''}"></i>
                        ${badge > 0 ? `<span class="absolute -top-1 -right-1 w-5 h-5 bg-amber-500 text-white text-[10px] font-black rounded-full flex items-center justify-center animate-pulse">${badge}</span>` : ''}
                    </div>
                    <span class="font-bold text-sm">${label}</span>
                    ${isActive ? '<div class="ml-auto w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></div>' : ''}
                </button>`;
        },

        navigateTo(view) {
            this.state.currentView = view;
            if (view === 'team') this.startKpiTimer(); else this.stopKpiTimer();
            App.rerender();
        },

        setTheme(theme) {
            this.state.theme = theme;
            localStorage.setItem('gestionnaire_theme', theme);

            // Appliquer le thème directement (style WhatsApp comme Vendeur)
            const html = document.documentElement;
            const body = document.body;

            html.classList.remove('gestionnaire-dark', 'gestionnaire-light', 'gestionnaire-auto');
            if (body) body.classList.remove('gestionnaire-dark', 'gestionnaire-light', 'gestionnaire-auto');
            html.style.filter = 'none';

            if (theme === 'dark') {
                html.classList.add('gestionnaire-dark');
                if (body) body.classList.add('gestionnaire-dark');
                html.style.backgroundColor = '#111b21';
            } else if (theme === 'light') {
                html.classList.add('gestionnaire-light');
                if (body) body.classList.add('gestionnaire-light');
                html.style.backgroundColor = '#ffffff';
            } else if (theme === 'auto') {
                html.classList.add('gestionnaire-auto');
                if (body) body.classList.add('gestionnaire-auto');
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.backgroundColor = isDark ? '#111b21' : '#ffffff';
                if (isDark) {
                    html.classList.add('gestionnaire-dark');
                    if (body) body.classList.add('gestionnaire-dark');
                }
            }

            UI.toast('Thème: ' + (theme === 'light' ? 'Clair' : theme === 'dark' ? 'Sombre' : 'Auto'), 'success');
            App.rerender();
        },

        applyTheme() {
            const html = document.documentElement;
            const body = document.body;
            const theme = this.state.theme;

            html.classList.remove('gestionnaire-dark', 'gestionnaire-light', 'gestionnaire-auto');
            if (body) body.classList.remove('gestionnaire-dark', 'gestionnaire-light', 'gestionnaire-auto');
            html.style.filter = 'none';

            if (theme === 'dark') {
                html.classList.add('gestionnaire-dark');
                if (body) body.classList.add('gestionnaire-dark');
                html.style.backgroundColor = '#111b21';
            } else if (theme === 'light') {
                html.classList.add('gestionnaire-light');
                if (body) body.classList.add('gestionnaire-light');
                html.style.backgroundColor = '#ffffff';
            } else if (theme === 'auto') {
                html.classList.add('gestionnaire-auto');
                if (body) body.classList.add('gestionnaire-auto');
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.backgroundColor = isDark ? '#111b21' : '#ffffff';
                if (isDark) {
                    html.classList.add('gestionnaire-dark');
                    if (body) body.classList.add('gestionnaire-dark');
                }
            }
        },

        loadThemePreference() {
            const saved = localStorage.getItem('gestionnaire_theme');
            if (saved) {
                this.state.theme = saved;
                this.applyTheme();
            }
            this.loadNotificationPreference();
            this.loadSlaThresholds();
        },

        loadSlaThresholds() {
            const raw = localStorage.getItem('gestionnaire_sla_thresholds');
            if (!raw) return;
            try {
                const parsed = JSON.parse(raw);
                if (parsed && typeof parsed === 'object') {
                    this.state.slaThresholds = { ...this.state.slaThresholds, ...parsed };
                }
            } catch (e) {}
        },
        saveSlaThresholds(th = null) {
            const next = th || this.state.slaThresholds;
            localStorage.setItem('gestionnaire_sla_thresholds', JSON.stringify(next));
            UI.toast('Seuils SLA enregistrés', 'success');
            App.rerender();
        },
        getTeamKPIs(posId) {
            const th = this.state.slaThresholds;
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const orders = (CORE.getVisibleOrders() || []).filter(o => o.posId == posId);
            const pendingOrders = orders.filter(o => ['pending','delivering','reserved'].includes(o.status)).length;
            const ordersById = new Map(orders.map(o => [o.id, o]));
            const deliveries = (CORE.getVisibleDeliveries() || []).filter(d => ordersById.has(d.orderId));
            const delivered = deliveries.filter(d => d.status === 'livree' && d.deliveredAt);
            const onTimeDelivered = delivered.filter(d => {
                const startTs = d.assignedAt || d.createdAt;
                const endTs = d.deliveredAt;
                if (!startTs || !endTs) return false;
                const mins = (new Date(endTs) - new Date(startTs)) / 60000;
                return mins <= th.maxDeliveryMinutes;
            });
            const onTimeRate = delivered.length > 0 ? Math.round((onTimeDelivered.length / delivered.length) * 100) : 0;
            const depositsToday = (CORE.db.deposits || []).filter(d => {
                if (!d.timestamp) return false;
                const t = new Date(d.timestamp);
                return t >= startOfDay && t <= now && d.posId === posId;
            });
            const dailyDeposits = Math.round(depositsToday.reduce((a, d) => a + (d.amount || 0), 0));
            return { onTimeRate, dailyDeposits, pendingOrders };
        },
        evaluateSLA(kpis) {
            const th = this.state.slaThresholds;
            const alerts = [];
            if (kpis.onTimeRate < th.minOnTimeRate) alerts.push({ key: 'onTimeRate', label: 'Taux livraison dans les délais', value: kpis.onTimeRate + '%', threshold: th.minOnTimeRate + '%', severity: 'red' });
            if (kpis.pendingOrders > th.maxPendingOrders) alerts.push({ key: 'pendingOrders', label: 'Commandes en attente', value: kpis.pendingOrders, threshold: th.maxPendingOrders, severity: 'amber' });
            if (kpis.dailyDeposits < th.minDailyDeposits) alerts.push({ key: 'dailyDeposits', label: 'Dépôts journaliers', value: CORE.formatPrice(kpis.dailyDeposits), threshold: CORE.formatPrice(th.minDailyDeposits), severity: 'red' });
            return alerts;
        },
        startKpiTimer() {
            if (this.state.kpiTimerId) return;
            // refresh KPIs every 10s
            this.state.kpiTimerId = setInterval(() => { if (document.visibilityState === 'visible') App.rerender(); }, 60000); // PERF: 60s instead of 10s, skip when hidden
        },
        stopKpiTimer() {
            if (this.state.kpiTimerId) { clearInterval(this.state.kpiTimerId); this.state.kpiTimerId = null; }
        },

        addNotification(type, title, message, severity = 'info') {
            const notification = {
                id: CORE.uid(),
                type,
                title,
                message,
                severity,
                timestamp: new Date(),
                read: false
            };

            this.state.notifications.push(notification);
            this.state.notificationHistory.push(notification);

            // Garder seulement les 100 dernières notifications en historique
            if (this.state.notificationHistory.length > 100) {
                this.state.notificationHistory.shift();
            }

            // Auto-remove après 10s
            setTimeout(() => {
                this.state.notifications = this.state.notifications.filter(n => n.id !== notification.id);
            }, 10000);

            // Toast visuel
            UI.toast(title + ': ' + message, severity);
        },

        checkCriticalEvents() {
            // Si notifications désactivées, ne pas vérifier
            if (!this.state.notificationsEnabled) return;

            const posId = CORE.state.currentUser?.pos || CORE.state.currentUser?.storeId;
            if (!posId) return; // Éviter les erreurs si pas connecté

            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            // Vérifier SLA dépassé — seulement si des livraisons réelles existent
            const kpis = this.getTeamKPIs(posId);
            const th = this.state.slaThresholds;

            // Ne vérifier le SLA que s'il y a des vraies livraisons terminées
            const orders = (CORE.getVisibleOrders() || []).filter(o => o.posId == posId);
            const deliveries = (CORE.getVisibleDeliveries() || []).filter(d => d.status === 'livree' && d.deliveredAt);
            const hasRealDeliveryData = deliveries.length > 0;

            if (hasRealDeliveryData && kpis.onTimeRate < th.minOnTimeRate && !this.state.criticalAlerts['sla_rate']) {
                this.addNotification('sla', '📊 SLA Taux livraison',
                    `Taux ${kpis.onTimeRate}% < ${th.minOnTimeRate}% (seuil)`, 'red');
                this.state.criticalAlerts['sla_rate'] = true;
            } else if (!hasRealDeliveryData || kpis.onTimeRate >= th.minOnTimeRate) {
                delete this.state.criticalAlerts['sla_rate'];
            }

            if (kpis.pendingOrders > th.maxPendingOrders && !this.state.criticalAlerts['pending']) {
                this.addNotification('pending', '⏱️ Commandes en attente',
                    `${kpis.pendingOrders} commandes en attente (max: ${th.maxPendingOrders})`, 'amber');
                this.state.criticalAlerts['pending'] = true;
            } else if (kpis.pendingOrders <= th.maxPendingOrders) {
                delete this.state.criticalAlerts['pending'];
            }

            // Ne vérifier les dépôts que s'il y a des commandes réelles aujourd'hui
            const todayOrders = orders.filter(o => o.createdAt && new Date(o.createdAt) >= startOfDay);
            if (todayOrders.length > 0 && kpis.dailyDeposits < th.minDailyDeposits && !this.state.criticalAlerts['deposits']) {
                this.addNotification('deposits', '💰 Dépôts en retard',
                    `Dépôts: ${CORE.formatPrice(kpis.dailyDeposits)} < ${CORE.formatPrice(th.minDailyDeposits)}`, 'red');
                this.state.criticalAlerts['deposits'] = true;
            } else if (todayOrders.length === 0 || kpis.dailyDeposits >= th.minDailyDeposits) {
                delete this.state.criticalAlerts['deposits'];
            }

            // Vérifier stocks faibles — seulement les produits avec minStock > 0 configuré
            const lowStockProducts = (CORE.getVisibleProducts() || []).filter(p =>
                p.posId == posId && p.minStock > 0 && p.stock <= p.minStock && !this.state.criticalAlerts['stock_' + p.id]
            );

            lowStockProducts.forEach(p => {
                this.addNotification('stock', '📦 Stock faible',
                    `${p.name}: ${p.stock}/${p.minStock} min`, 'amber');
                this.state.criticalAlerts['stock_' + p.id] = true;
            });

            // Vérifier incidents ouverts
            const incidents = (CORE.db.incidents || []).filter(i => i.posId == posId && !i.resolved);
            incidents.forEach(inc => {
                if (!this.state.criticalAlerts['incident_' + inc.id]) {
                    this.addNotification('incident', '🚨 Incident escaladé',
                        `${inc.type}: ${inc.description || 'Nouveau problème'}`, 'red');
                    this.state.criticalAlerts['incident_' + inc.id] = true;
                }
            });

            // Vérifier les transferts entrants (transfer_incoming) dans CORE.db.notifications
            const incomingTransferNotifs = (CORE.db.notifications || []).filter(n =>
                n.type === 'transfer_incoming' &&
                String(n.posId) === String(posId) &&
                !n.read
            );
            incomingTransferNotifs.forEach(n => {
                if (!this.state.criticalAlerts['transfer_' + n.id]) {
                    const transfer = (CORE.db.stockTransfers || []).find(t => t.id === n.transferId)
                        || (CORE.db.transferReceipts || []).find(t => t.id === n.transferId);
                    // FIX: transfers have qty/quantity, not items[]
                    const itemCount = transfer ? (transfer.qty || transfer.quantity || 1) : 0;
                    const fromPosName = transfer ? (CORE.getPOS(transfer.sourcePosId || transfer.fromPosId)?.name || transfer.sourcePosName || transfer.fromPosName || 'Dépôt principal') : 'un POS';
                    this.addNotification('transfer_incoming', '📦 Transfert entrant',
                        `${itemCount} produit(s) reçu(s) de ${fromPosName} — Veuillez valider ou rejeter`,
                        'amber');
                    this.state.criticalAlerts['transfer_' + n.id] = true;
                }
            });
        },

        testNotification() {
            // Removed — no test data generation in production
        },

        toggleNotifications() {
            this.state.notificationsEnabled = !this.state.notificationsEnabled;
            localStorage.setItem('gestionnaire_notifications_enabled', this.state.notificationsEnabled);
            const status = this.state.notificationsEnabled ? 'Activées' : 'Désactivées';
            UI.toast(`Notifications ${status}`, this.state.notificationsEnabled ? 'success' : 'info');
            App.rerender();
        },

        loadNotificationPreference() {
            const saved = localStorage.getItem('gestionnaire_notifications_enabled');
            if (saved !== null) {
                this.state.notificationsEnabled = saved === 'true';
            }
        },

        generateTestAlerts() {
            // Removed — no test data generation in production
        },

        renderNotificationCenter() {
            if (!this.state.notifications || this.state.notifications.length === 0) return '';

            return `
                <div class="fixed top-4 right-4 max-w-sm z-50 space-y-2">
                    ${this.state.notifications.map(n => `
                        <div class="animate-slideIn p-4 rounded-2xl backdrop-blur-md border shadow-2xl transition-all hover:shadow-xl ${
                            n.severity === 'red' ? 'bg-red-50/95 border-red-200 text-red-900' :
                            n.severity === 'amber' ? 'bg-amber-50/95 border-amber-200 text-amber-900' :
                            n.severity === 'success' ? 'bg-emerald-50/95 border-emerald-200 text-emerald-900' :
                            'bg-blue-50/95 border-blue-200 text-blue-900'
                        }">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 text-xl">
                                    ${n.severity === 'red' ? '❌' :
                                      n.severity === 'amber' ? '⚠️' :
                                      n.severity === 'success' ? '✅' :
                                      'ℹ️'}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="font-black text-sm leading-tight">${n.title}</p>
                                    <p class="text-xs opacity-90 mt-1">${n.message}</p>
                                </div>
                                <button onclick="GestionnaireModule.dismissNotification(${n.id})" class="flex-shrink-0 text-lg opacity-60 hover:opacity-100 transition">✕</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        },

        dismissNotification(id) {
            this.state.notifications = this.state.notifications.filter(n => n.id !== id);
            const record = this.state.notificationHistory.find(n => n.id === id);
            if (record) {
                record.read = true;
                record.readAt = new Date();
            }
        },

        getNotificationFilters() {
            if (!this.state.notificationFilters) {
                this.state.notificationFilters = NotificationUtils.defaultFilters();
            }
            return NotificationUtils.ensureFilters(this.state.notificationFilters);
        },

        updateNotificationFilter(key, value) {
            const current = this.getNotificationFilters();
            this.state.notificationFilters = { ...current, [key]: value };
            this.refreshNotificationHistoryModal();
        },

        toggleUnreadFilter() {
            const current = this.getNotificationFilters();
            this.state.notificationFilters = { ...current, showUnread: !current.showUnread };
            this.refreshNotificationHistoryModal();
        },

        resetNotificationFilters() {
            this.state.notificationFilters = NotificationUtils.defaultFilters();
            this.refreshNotificationHistoryModal();
        },

        markAllNotificationHistoryRead() {
            this.state.notificationHistory.forEach(item => {
                item.read = true;
                item.readAt = item.readAt || new Date();
            });
            this.refreshNotificationHistoryModal();
        },

        toggleNotificationRead(id) {
            const notification = this.state.notificationHistory.find(n => n.id === id);
            if (!notification) return;
            const nextState = !notification.read;
            notification.read = nextState;
            notification.readAt = nextState ? new Date() : null;
            this.refreshNotificationHistoryModal();
        },

        refreshNotificationHistoryModal() {
            const container = document.querySelector('#modalContainer .modal-content');
            if (!container) return;
            UI.updateModalContent(this.renderNotificationHistoryContent());
        },

        renderNotificationHistoryContent() {
            const filters = this.getNotificationFilters();
            const allHistory = this.state.notificationHistory.slice().reverse();
            const filtered = NotificationUtils.applyFilters(allHistory, filters);
            const grouped = NotificationUtils.groupByDate(filtered);
            const counts = NotificationUtils.countBySeverity(allHistory);
            const typeOptions = NotificationUtils.getTypeOptions(allHistory);

            const severityOptions = [
                { key: 'all', label: 'Toutes', chip: 'bg-slate-200 text-slate-700' },
                { key: 'critical', label: 'Critiques' },
                { key: 'high', label: 'Élevées' },
                { key: 'medium', label: 'Modérées' },
                { key: 'low', label: 'Faibles' },
                { key: 'info', label: 'Info' }
            ];

            const periodOptions = [
                { key: '24h', label: '24h' },
                { key: '7d', label: '7j' },
                { key: '30d', label: '30j' },
                { key: 'all', label: 'Tout' }
            ];

            return `
                <div class="space-y-5">
                    <div class="flex flex-col gap-4 bg-slate-50 border border-slate-200 rounded-2xl p-4">
                        <div class="flex flex-wrap items-center gap-3 justify-between">
                            <div>
                                <div class="font-black text-slate-900 text-sm">${filtered.length} résultat${filtered.length > 1 ? 's' : ''}</div>
                                <div class="text-xs text-slate-500">${allHistory.length} notifications enregistrées</div>
                            </div>
                            <div class="flex flex-wrap gap-2 text-xs font-black">
                                <button class="px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-100 transition" onclick="GestionnaireModule.resetNotificationFilters()">Réinitialiser</button>
                                <button class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition" onclick="GestionnaireModule.markAllNotificationHistoryRead()">Tout marquer lu</button>
                            </div>
                        </div>

                        <div class="grid gap-3">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div class="relative flex gap-2">
                                    <input type="search" id="gestionnaire-notif-search" value="${NotificationUtils.escape(filters.search)}" onkeypress="if(event.key==='Enter'){GestionnaireModule.updateNotificationFilter('search', this.value)}" placeholder="Rechercher titre, message, type..." class="flex-1 px-4 py-2.5 rounded-xl border border-slate-200 bg-white text-sm focus:ring-2 focus:ring-emerald-500 focus:border-transparent" />
                                    <button onclick="GestionnaireModule.updateNotificationFilter('search', document.getElementById('gestionnaire-notif-search').value)" class="px-3 py-2 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition"><i data-lucide="search" class="w-4 h-4"></i></button>
                                </div>
                                <div class="flex items-center gap-2">
                                    ${periodOptions.map(option => `
                                        <button class="px-3 py-2 rounded-lg text-xs font-black border ${filters.period === option.key ? 'bg-slate-900 text-white border-slate-900' : 'bg-white border-slate-200 hover:bg-slate-100'}" onclick="GestionnaireModule.updateNotificationFilter('period', '${option.key}')">${option.label}</button>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="flex flex-wrap items-center gap-2">
                                ${severityOptions.map(option => {
                                    const meta = option.key !== 'all' ? NotificationUtils.getSeverityMeta(option.key) : null;
                                    const isActive = filters.severity === option.key;
                                    const base = option.key === 'all' ? option.chip : meta?.chip;
                                    return `<button class="px-3 py-1.5 rounded-full text-[11px] font-black border ${isActive ? (option.key === 'all' ? 'border-slate-900 bg-slate-900 text-white' : 'border-transparent ' + base) : 'border-slate-200 bg-white text-slate-600'}" onclick=\"GestionnaireModule.updateNotificationFilter('severity','${option.key}')\">${option.label} (${counts[option.key] ?? 0})</button>`;
                                }).join('')}
                                <button class="px-3 py-1.5 rounded-full text-[11px] font-black border ${filters.showUnread ? 'bg-amber-500 border-transparent text-white' : 'bg-white border-slate-200 text-slate-600'}" onclick="GestionnaireModule.toggleUnreadFilter()">${filters.showUnread ? 'Non lues uniquement' : 'Inclure non lues'}</button>
                            </div>

                            ${typeOptions.length > 0 ? `
                                <div>
                                    <label class="text-[11px] uppercase font-black text-slate-500 tracking-wide mb-1 block">Type</label>
                                    <select class="w-full md:w-auto px-3 py-2 border border-slate-200 rounded-lg text-sm font-black bg-white" onchange="GestionnaireModule.updateNotificationFilter('type', this.value)">
                                        <option value="all" ${filters.type === 'all' ? 'selected' : ''}>Tous les types</option>
                                        ${typeOptions.map(type => `<option value="${NotificationUtils.escape(type)}" ${filters.type.toLowerCase() === type.toLowerCase() ? 'selected' : ''}>${NotificationUtils.escape(NotificationUtils.getTypeLabel(type))}</option>`).join('')}
                                    </select>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    ${filtered.length === 0 ? `
                        <div class="p-10 text-center border border-dashed border-slate-200 rounded-2xl bg-white">
                            <div class="text-4xl mb-2">🕊️</div>
                            <div class="font-black text-slate-700">Aucun résultat</div>
                            <div class="text-xs text-slate-500 mt-1">Ajustez vos filtres ou élargissez la période.</div>
                        </div>
                    ` : `
                        <div class="space-y-6">
                            ${grouped.map(group => `
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between text-xs font-black text-slate-500 uppercase tracking-wide">
                                        <span>${group.label}</span>
                                        <span>${group.items.length} notification${group.items.length > 1 ? 's' : ''}</span>
                                    </div>
                                    <div class="space-y-3">
                                        ${group.items.map(item => {
                                            const meta = NotificationUtils.getSeverityMeta(item.severity);
                                            const ts = NotificationUtils.getTimestamp(item);
                                            const relative = NotificationUtils.formatRelative(ts);
                                            const readClass = item.read ? 'opacity-80' : 'ring-2 ring-offset-2 ring-slate-300';
                                            return `
                                                <div class="p-4 rounded-2xl transition ${meta.panel} ${readClass}">
                                                    <div class="flex flex-col gap-3">
                                                        <div class="flex items-start gap-3">
                                                            <span class="w-2 h-2 mt-1 rounded-full ${meta.dot}"></span>
                                                            <div class="flex-1">
                                                                <div class="flex flex-wrap items-start gap-2 justify-between">
                                                                    <div>
                                                                        <div class="text-sm font-black text-slate-900">${NotificationUtils.escape(item.title)}</div>
                                                                        ${item.message ? `<div class="text-xs text-slate-600 mt-1">${NotificationUtils.escape(item.message)}</div>` : ''}
                                                                    </div>
                                                                    <button class="text-[10px] font-black px-2 py-1 rounded-full border border-transparent ${item.read ? 'bg-white text-slate-500 border-slate-200' : 'bg-slate-900 text-white'}" onclick="GestionnaireModule.toggleNotificationRead(${item.id})">${item.read ? 'Marquer non lu' : 'Marquer lu'}</button>
                                                                </div>
                                                                <div class="flex flex-wrap items-center gap-2 mt-3 text-[10px] font-black text-slate-500">
                                                                    <span class="px-2 py-1 rounded-full ${meta.badge}">${meta.label}</span>
                                                                    <span class="px-2 py-1 rounded-full bg-slate-200 text-slate-700">${NotificationUtils.escape(NotificationUtils.getTypeLabel(item.type))}</span>
                                                                    <span>${relative}</span>
                                                                    ${ts ? `<span class="text-slate-400">${CORE.formatDate(ts)}</span>` : ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        },

        showNotificationHistory() {
            UI.modal('📋 Historique des notifications', this.renderNotificationHistoryContent(), [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showAddShiftModal() {
            const posId = CORE.user?.pos;
            const vendeurs = (CORE.getVisibleUsers() || []).filter(u => u.role === 'vendeur' && u.pos === posId);
            const livreurs = (CORE.getVisibleUsers() || []).filter(u => u.role === 'livreur' && u.pos === posId);
            const allUsers = [...vendeurs, ...livreurs];
            const templates = CORE.db.shiftTemplates.filter(t => t.posId === posId);
            const userOptions = allUsers.map(u => ({ value: u.id, label: u.name }));
            const templateOptions = templates.map(t => ({ value: t.id, label: `${t.name} (${t.startTime}-${t.endTime})` }));

            UI.modal('Ajouter un Shift', `
                <div class="space-y-4">
                    ${UI.select('shift_user','Personne', userOptions, '', true)}
                    ${UI.input('shift_date','Date','date', new Date().toISOString().split('T')[0], '', true)}

                    <!-- Section Créneau -->
                    <div class="border-t border-slate-200 pt-4 space-y-3">
                        <div class="font-black text-slate-900">🕐 Créneau Horaire:</div>

                        <!-- Option 1: Template prédéfini -->
                        <div class="space-y-2">
                            <label class="flex items-center gap-2">
                                <input type="radio" id="shift_mode_template" name="shift_mode" value="template" ${templateOptions.length > 0 ? 'checked' : 'disabled'} class="w-4 h-4">
                                <span class="text-sm font-bold text-slate-700">Utiliser un template</span>
                            </label>
                            ${templateOptions.length > 0 ? `
                                <select id="shift_template" class="w-full px-3 py-2.5 rounded-lg border border-slate-200 font-bold text-sm">
                                    <option value="">-- Sélectionner un template --</option>
                                    ${templateOptions.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                                </select>
                            ` : `
                                <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-xs text-amber-800">
                                    Aucun template disponible. Utilisez la saisie manuelle.
                                </div>
                            `}
                        </div>

                        <!-- Option 2: Saisie manuelle -->
                        <div class="space-y-2">
                            <label class="flex items-center gap-2">
                                <input type="radio" id="shift_mode_manual" name="shift_mode" value="manual" class="w-4 h-4">
                                <span class="text-sm font-bold text-slate-700">Saisir manuellement</span>
                            </label>
                            <div class="grid grid-cols-2 gap-3 opacity-50 transition" id="shift_manual_inputs">
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-slate-600">Heure de début</label>
                                    <input type="time" id="shift_start_time" class="w-full px-3 py-2 rounded-lg border border-slate-200 font-bold" value="08:00" disabled>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-slate-600">Heure de fin</label>
                                    <input type="time" id="shift_end_time" class="w-full px-3 py-2 rounded-lg border border-slate-200 font-bold" value="18:00" disabled>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${UI.textarea('shift_notes','Notes', '', 'notes optionnelles')}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Ajouter', onclick: 'GestionnaireModule.saveShift()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);

            // Ajouter les event listeners pour les radio buttons
            setTimeout(() => {
                const templateRadio = document.getElementById('shift_mode_template');
                const manualRadio = document.getElementById('shift_mode_manual');
                const templateSelect = document.getElementById('shift_template');
                const manualInputs = document.getElementById('shift_manual_inputs');
                const startTimeInput = document.getElementById('shift_start_time');
                const endTimeInput = document.getElementById('shift_end_time');

                if (templateRadio) {
                    templateRadio.addEventListener('change', () => {
                        if (templateRadio.checked) {
                            if (templateSelect) templateSelect.disabled = false;
                            startTimeInput.disabled = true;
                            endTimeInput.disabled = true;
                            manualInputs.classList.add('opacity-50');
                            if (templateSelect) templateSelect.parentElement.classList.remove('opacity-50');
                        }
                    });
                }

                if (manualRadio) {
                    manualRadio.addEventListener('change', () => {
                        if (manualRadio.checked) {
                            if (templateSelect) templateSelect.disabled = true;
                            startTimeInput.disabled = false;
                            endTimeInput.disabled = false;
                            manualInputs.classList.remove('opacity-50');
                            if (templateSelect) templateSelect.parentElement.classList.add('opacity-50');
                        }
                    });
                }

                // Initialiser l'état
                if (templateOptions.length > 0 && templateRadio) {
                    templateRadio.checked = true;
                    if (templateSelect) templateSelect.disabled = false;
                    startTimeInput.disabled = true;
                    endTimeInput.disabled = true;
                } else if (manualRadio) {
                    manualRadio.checked = true;
                    if (templateSelect) templateSelect.disabled = true;
                    startTimeInput.disabled = false;
                    endTimeInput.disabled = false;
                    manualInputs.classList.remove('opacity-50');
                }

                lucide.createIcons();
            }, 50);
        },

        saveShift() {
            const userId = parseInt(UI.val('shift_user') || '0', 10);
            const date = UI.val('shift_date');
            const notes = UI.val('shift_notes') || '';
            if (!userId || !date) return UI.toast('Champs requis', 'warning');

            const shiftMode = document.querySelector('input[name="shift_mode"]:checked')?.value;
            let templateId = null;
            let startTime = null;
            let endTime = null;

            if (shiftMode === 'template') {
                templateId = parseInt(UI.val('shift_template') || '0', 10);
                if (!templateId) return UI.toast('Sélectionnez un template', 'warning');
            } else if (shiftMode === 'manual') {
                startTime = document.getElementById('shift_start_time')?.value;
                endTime = document.getElementById('shift_end_time')?.value;
                if (!startTime || !endTime) return UI.toast('Saisissez les heures', 'warning');
                if (startTime >= endTime) return UI.toast('L\'heure de fin doit être après le début', 'warning');
            } else {
                return UI.toast('Sélectionnez un mode de créneau', 'warning');
            }

            const posId = CORE.user?.pos;
            const shift = CORE.create('shifts', {
                templateId: templateId || null,
                manualStartTime: startTime,
                manualEndTime: endTime,
                userId,
                date,
                posId,
                status: 'scheduled',
                notes
            });
            UI.closeModal();
            UI.toast('Shift ajouté', 'success');
            App.rerender();
        },

        showTimeOffModal() {
            const posId = CORE.user?.pos;
            const vendeurs = (CORE.getVisibleUsers() || []).filter(u => u.role === 'vendeur' && u.pos === posId);
            const livreurs = (CORE.getVisibleUsers() || []).filter(u => u.role === 'livreur' && u.pos === posId);
            const allUsers = [...vendeurs, ...livreurs];
            const userOptions = allUsers.map(u => ({ value: u.id, label: u.name }));

            UI.modal('Demander un Congé/Absence', `
                <div class="space-y-4">
                    ${UI.select('timeoff_user','Personne', userOptions, '', true)}
                    ${UI.select('timeoff_type','Type', [
                        {value:'congé',label:'Congé'},
                        {value:'maladie',label:'Maladie'},
                        {value:'autre',label:'Autre'}
                    ], 'congé', true)}
                    ${UI.input('timeoff_start','Date début','date', new Date().toISOString().split('T')[0], '', true)}
                    ${UI.input('timeoff_end','Date fin','date', new Date().toISOString().split('T')[0], '', true)}
                    ${UI.textarea('timeoff_reason','Raison', '', 'facultatif')}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'GestionnaireModule.saveTimeOff()', class: 'px-5 py-2.5 bg-amber-600 text-white font-black rounded-xl hover:bg-amber-700 transition' }
            ]);
        },

        saveTimeOff() {
            const userId = parseInt(UI.val('timeoff_user') || '0', 10);
            const type = UI.val('timeoff_type');
            const startDate = UI.val('timeoff_start');
            const endDate = UI.val('timeoff_end');
            const reason = UI.val('timeoff_reason') || '';
            if (!userId || !startDate || !endDate) return UI.toast('Champs requis', 'warning');

            if (new Date(endDate) < new Date(startDate)) return UI.toast('Date fin avant date début', 'error');

            const timeOff = CORE.create('timeOff', {
                userId,
                type,
                startDate,
                endDate,
                reason,
                status: 'approved'
            });
            UI.closeModal();
            UI.toast('Absence enregistrée', 'success');
            App.rerender();
        },

        quickReplacement(slotName, posId, date) {
            const vendeurs = (CORE.getVisibleUsers() || []).filter(u => u.role === 'vendeur' && u.pos === posId && u.active);
            const livreurs = (CORE.getVisibleUsers() || []).filter(u => u.role === 'livreur' && u.pos === posId && u.active);
            const allUsers = [...vendeurs, ...livreurs];
            const userOptions = allUsers.map(u => ({ value: u.id, label: u.name }));

            UI.modal(`Remplacement Rapide - ${slotName}`, `
                <div class="space-y-4">
                    <p class="text-sm text-slate-600">Sélectionnez une personne pour couvrir le créneau <b>${slotName}</b> du <b>${new Date(date).toLocaleDateString('fr-FR')}</b>.</p>
                    ${UI.select('repl_user','Personne disponible', userOptions, '', true)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Assigner', onclick: `GestionnaireModule.assignQuickReplacement('${slotName}', ${posId}, '${date}')`, class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        assignQuickReplacement(slotName, posId, date) {
            const userId = parseInt(UI.val('repl_user') || '0', 10);
            if (!userId) return UI.toast('Sélectionnez une personne', 'warning');

            const template = CORE.db.shiftTemplates.find(t => t.name === slotName && t.posId === posId);
            if (!template) return UI.toast('Créneau non trouvé', 'error');

            const shift = CORE.create('shifts', {
                templateId: template.id,
                userId,
                date,
                posId,
                status: 'confirmed',
                notes: `Remplacement rapide - ${slotName}`
            });

            UI.closeModal();
            const user = CORE.getUser(userId);
            UI.toast(`${user.name} assigné au créneau ${slotName}`, 'success');
            App.rerender();
        },

        quickRestockModal() {
            const options = (CORE.getVisibleProducts() || []).filter(p => !p.isMainWarehouse).map(p => ({ value: p.id, label: `${p.name} (stock: ${p.stock})` }));
            UI.modal('Ajustement stock', `
                <div class="space-y-4">
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-xl text-xs text-blue-700">
                        <strong>💡 Astuce:</strong> Pour des ajustements en masse, utilisez <button class="text-blue-600 font-bold hover:underline" onclick="UI.closeModal(); GestionnaireModule.showImportMovementsModal()">l'import CSV</button>
                    </div>
                    ${UI.select('mov_product','Produit',options,'',true)}
                    ${UI.input('mov_qty','Quantité','number','1','ex: 10',true)}
                    ${UI.select('mov_type','Type',[{value:'in',label:'Entrée (réappro)'},{value:'out',label:'Sortie'},{value:'adjust',label:'Ajustement'}],'in',true)}
                    ${UI.textarea('mov_note','Note','','facultatif')}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'GestionnaireModule.applyStockMovement()', class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        quickAdjustStock(productId) {
            const p = CORE.getProduct(productId);
            if (!p) return;
            UI.modal(`Ajuster: ${p.name}`, `
                <div class="space-y-4">
                    ${UI.input('adj_qty','Quantité (+/-)','number','1','ex: 10',true)}
                    ${UI.select('adj_dir','Sens',[{value:'in',label:'Ajouter'},{value:'out',label:'Retirer'}],'in',true)}
                    ${UI.textarea('adj_note','Note','','facultatif')}
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">
                        Stock actuel: <b>${p.stock}</b> • Min: <b>${p.minStock}</b>
                    </div>
                    <div id="adj_preview" class="p-4 bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-200 rounded-xl hidden">
                        <div class="font-black text-amber-900 mb-3">✓ Aperéu de l'ajustement:</div>
                        <div id="adj_preview_text" class="p-3 bg-white rounded border border-amber-200">
                            <div class="font-black text-lg text-slate-900">${p.stock} <span class="text-amber-500 mx-1">→</span> ${p.stock}</div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Appliquer', onclick: `GestionnaireModule.applyQuickAdjust(${p.id})`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);

            // Ajouter event listeners pour aperçu en temps réel
            setTimeout(() => {
                const updatePreview = () => {
                    const dir = UI.val('adj_dir') || 'in';
                    const qty = Math.abs(parseInt(UI.val('adj_qty') || '0', 10));
                    const preview = document.getElementById('adj_preview');
                    const previewText = document.getElementById('adj_preview_text');

                    if (qty > 0) {
                        const newStock = dir === 'out' ? Math.max(0, p.stock - qty) : p.stock + qty;
                        preview.classList.remove('hidden');
                        previewText.innerHTML = `<div class="font-black text-lg text-slate-900">${p.stock} <span class="text-amber-500 mx-1">→</span> ${newStock}</div>`;
                    } else {
                        preview.classList.add('hidden');
                    }
                };

                ['adj_qty', 'adj_dir'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.addEventListener('change', updatePreview);
                        el.addEventListener('input', updatePreview);
                    }
                });
            }, 100);
        },

        applyQuickAdjust(productId) {
            const dir = UI.val('adj_dir');
            const qty = Math.abs(parseInt(UI.val('adj_qty') || '0', 10));
            const note = UI.val('adj_note');
            if (!qty) return UI.toast('Quantité invalide', 'warning');
            const p = CORE.getProduct(productId);
            if (!p) return;

            const next = dir === 'out' ? (p.stock || 0) - qty : (p.stock || 0) + qty;
            if (next < 0) return UI.toast('Stock ne peut pas être négatif', 'error');
            const updates = { stock: next };
            // Also update POS-specific stock
            const adjPosId = CORE.user?.pos;
            if (adjPosId && p.posStocks && p.posStocks[adjPosId]) {
                const newPosStocks = JSON.parse(JSON.stringify(p.posStocks));
                const curPosStock = newPosStocks[adjPosId].stock || 0;
                const nextPos = dir === 'out' ? curPosStock - qty : curPosStock + qty;
                newPosStocks[adjPosId].stock = Math.max(0, nextPos);
                updates.posStocks = newPosStocks;
            }
            CORE.update('products', p.id, updates);
            CORE.recordStockMovement({ productId: p.id, type: dir === 'out' ? 'out' : 'in', qty, note: note || 'Ajustement rapide' });
            CORE.logAudit('update', 'stock', p.id, p.name, { description: `Ajustement stock: ${p.name} ${dir === 'out' ? '-' : '+'}${qty} (${p.stock} → ${next})` }, { stock: p.stock }, { stock: next });
            UI.closeModal();
            UI.toast('Stock mis à jour', 'success');
            App.rerender();
        },

        showManageVariantsModal(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return;

            const variants = CORE.getProductVariants(productId);
            const attributeTypes = CORE.db.productAttributeTypes || [];

            const variantHTML = variants.length === 0
                ? '<div class="p-8 text-center text-slate-400 font-medium">Aucune variante encore</div>'
                : `<div class="space-y-2 max-h-80 overflow-y-auto">
                    ${variants.map(v => {
                        const status = CORE.getVariantStockStatus(v);
                        return `
                            <div class="p-3 bg-slate-50 rounded-xl border border-slate-100 hover:bg-slate-100 transition group">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="text-xs text-slate-500 mt-1">
                                            SKU: <code class="bg-slate-200 px-1 rounded">${v.sku}</code> •
                                            Prix: ${CORE.formatPrice(v.price)} •
                                            Stock: <span class="font-bold text-${status.color}-600">${v.stock}</span>
                                        </div>
                                    </div>
                                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                                        <button onclick="GestionnaireModule.editVariantModal('${productId}', '${v.id}')" class="px-2 py-1 bg-blue-600 text-white text-xs font-black rounded">Éditer</button>
                                        <button onclick="GestionnaireModule.deleteVariant('${productId}', '${v.id}')" class="px-2 py-1 bg-red-600 text-white text-xs font-black rounded">Supprimer</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>`;

            UI.modal(`📦 Variantes: ${product.name}`, `
                <div class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 p-3 rounded-xl text-xs text-blue-700 font-bold">
                        ${variants.length} variante(s) existante(s)
                    </div>
                    ${variantHTML}
                    <button onclick="GestionnaireModule.addVariantModal('${productId}')" class="w-full py-2 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition">
                        ➕ Ajouter variante
                    </button>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        addVariantModal(productId) {
            const product = CORE.getProduct(productId);

            window.variantAttrsCount = 3; // Start with 3 default fields

            UI.modal(`➕ Nouvelle variante: ${product.name}`, `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">SKU (réf. variante)</label>
                        <input id="var_sku" type="text" placeholder="Ex: PROD-001-BLU-S" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Attributs</label>
                        <div id="variant-attrs-container" class="space-y-3">
                            <div id="var_attr_row_0" class="flex gap-2 items-end">
                                <div class="flex-1">
                                    <input id="var_attr_name_0" type="text" placeholder="Nom (ex: Couleur)" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                                </div>
                                <div class="flex-1">
                                    <input id="var_attr_0" type="text" placeholder="Valeur (ex: Rouge)" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                                </div>
                                <button onclick="document.getElementById('var_attr_row_0').remove()" class="px-2 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200 text-xs font-black">✕</button>
                            </div>
                            <div id="var_attr_row_1" class="flex gap-2 items-end">
                                <div class="flex-1">
                                    <input id="var_attr_name_1" type="text" placeholder="Nom (ex: Taille)" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                                </div>
                                <div class="flex-1">
                                    <input id="var_attr_1" type="text" placeholder="Valeur (ex: M)" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                                </div>
                                <button onclick="document.getElementById('var_attr_row_1').remove()" class="px-2 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200 text-xs font-black">✕</button>
                            </div>
                            <div id="var_attr_row_2" class="flex gap-2 items-end">
                                <div class="flex-1">
                                    <input id="var_attr_name_2" type="text" placeholder="Nom attribut" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                                </div>
                                <div class="flex-1">
                                    <input id="var_attr_2" type="text" placeholder="Valeur" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                                </div>
                                <button onclick="document.getElementById('var_attr_row_2').remove()" class="px-2 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200 text-xs font-black">✕</button>
                            </div>
                        </div>
                        <button onclick="GestionnaireModule.addAttributeField()" class="mt-3 w-full py-2 px-3 bg-blue-100 text-blue-700 rounded-xl font-black text-xs hover:bg-blue-200 transition">
                            + Ajouter un attribut
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Prix</label>
                            <input id="var_price" type="number" value="${Math.max(0, parseFloat(product.price) || 0)}" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Stock</label>
                            <input id="var_stock" type="number" value="0" min="0" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                        </div>
                    </div>
                    <textarea id="var_notes" placeholder="Notes spéciales..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm" rows="2"></textarea>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Créer', onclick: `GestionnaireModule.createVariant('${productId}')`, class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        addAttributeField() {
            const idx = window.variantAttrsCount++;
            const container = document.getElementById('variant-attrs-container');
            if (!container) return;

            const div = document.createElement('div');
            div.id = `var_attr_row_${idx}`;
            div.className = 'flex gap-2 items-end';
            div.innerHTML = `
                <div class="flex-1">
                    <input id="var_attr_name_${idx}" type="text" placeholder="Nom attribut" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                </div>
                <div class="flex-1">
                    <input id="var_attr_${idx}" type="text" placeholder="Valeur" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                </div>
                <button onclick="document.getElementById('var_attr_row_${idx}').remove()" class="px-2 py-2 bg-red-100 text-red-600 rounded hover:bg-red-200 text-xs font-black">✕</button>
            `;
            container.appendChild(div);
        },

        createVariant(productId) {
            const sku = UI.val('var_sku');
            const price = parseInt(UI.val('var_price') || '0', 10);
            const stock = parseInt(UI.val('var_stock') || '0', 10);
            const notes = UI.val('var_notes');

            // P3-8: Guard NaN and validate
            if (!sku?.trim()) return UI.toast('SKU obligatoire', 'warning');
            if (isNaN(price) || price <= 0) return UI.toast('Prix invalide (doit Ãªtre > 0)', 'warning');
            if (isNaN(stock) || stock < 0) return UI.toast('Stock invalide', 'warning');

            // Récupérer les attributs remplis dynamiquement
            const attributes = [];
            for (let i = 0; i < window.variantAttrsCount; i++) {
                const nameInput = document.getElementById(`var_attr_name_${i}`);
                const valueInput = document.getElementById(`var_attr_${i}`);

                if (nameInput && valueInput) {
                    const name = nameInput.value?.trim();
                    const value = valueInput.value?.trim();

                    if (name && value) {
                        attributes.push({ name: name, value: value });
                    }
                }
            }

            if (attributes.length === 0) {
                return UI.toast('Au moins un attribut est obligatoire', 'warning');
            }

            CORE.createProductVariant(productId, attributes, sku, price, stock);
            UI.closeModal();
            UI.toast('Variante créée', 'success');
            App.rerender();
        },

        editVariantModal(productId, variantId) {
            const variant = CORE.db.productVariants.find(v => v.id === variantId);
            if (!variant) return;

            UI.modal(`✏️ Éditer variante`, `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">SKU</label>
                        <input id="edit_var_sku" type="text" value="${variant.sku || ''}" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Prix</label>
                            <input id="edit_var_price" type="number" value="${Math.max(0, parseFloat(variant.price) || 0)}" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                        </div>
                        <div>
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Stock</label>
                            <input id="edit_var_stock" type="number" value="${Math.max(0, parseInt(variant.stock) || 0)}" min="0" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                        </div>
                    </div>
                    <div class="p-3 bg-slate-50 rounded-xl border border-slate-100 text-sm">
                        <div class="font-black text-slate-900 mb-2">Attributs actuels:</div>
                        ${(variant.attributes || []).length > 0 ? `
                            <div class="space-y-1">
                                ${(variant.attributes || []).map(a => `
                                    <div class="flex items-center gap-2 text-xs">
                                        <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-lg font-bold">${a.name}: ${a.value}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div class="text-xs text-slate-400">Aucun attribut</div>'}
                    </div>
                    <textarea id="edit_var_notes" placeholder="Notes..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm" rows="2">${variant.notes || ''}</textarea>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Sauvegarder', onclick: `GestionnaireModule.saveVariantEdit('${variantId}')`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        saveVariantEdit(variantId) {
            const sku = UI.val('edit_var_sku');
            const price = parseInt(UI.val('edit_var_price') || '0', 10);
            const stock = parseInt(UI.val('edit_var_stock') || '0', 10);
            const notes = UI.val('edit_var_notes');

            // P3-8: Guard NaN
            if (isNaN(price) || price <= 0) return UI.toast('Prix invalide (doit Ãªtre > 0)', 'warning');
            if (isNaN(stock) || stock < 0) return UI.toast('Stock invalide', 'warning');
            CORE.updateProductVariant(variantId, { sku, price, stock, notes });
            UI.closeModal();
            UI.toast('Variante mise à jour', 'success');
            App.rerender();
        },

        deleteVariant(productId, variantId) {
            if (!confirm('Supprimer cette variante?')) return;
            CORE.deleteProductVariant(variantId);
            UI.toast('Variante supprimée', 'success');
            App.rerender();
        },

        showImageManagementModal(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return;

            const images = CORE.getProductImages(productId);

            UI.modal(`📸 Galerie: ${product.name}`, `
                <div class="space-y-4 max-h-[600px] overflow-y-auto">
                    <div class="p-4 bg-blue-50 border-2 border-dashed border-blue-300 rounded-2xl text-center cursor-pointer hover:bg-blue-100 transition" onclick="GestionnaireModule.showImageUploadModal(${productId})">
                        <div><i data-lucide="upload-cloud" class="w-8 h-8 text-blue-600 mx-auto mb-2"></i></div>
                        <div class="font-black text-blue-900 text-sm">Ajouter des images</div>
                        <div class="text-xs text-blue-700">Cliquez ou glissez-déposez</div>
                    </div>

                    ${images.length > 0 ? `
                        <div class="grid grid-cols-3 gap-3">
                            ${images.map(img => `
                                <div class="relative group border border-slate-200 rounded-xl overflow-hidden hover:border-blue-400 transition">
                                    <img src="${img.url}" alt="${img.alt || 'Produit'}" class="w-full h-32 object-cover">
                                    ${img.isPrimary ? '<div class="absolute top-2 left-2 px-2 py-1 bg-emerald-500 text-white text-xs font-black rounded">Principale</div>' : ''}
                                    <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-2">
                                        ${!img.isPrimary ? `<button onclick="CORE.setPrimaryImage('${img.id}'); GestionnaireModule.showImageManagementModal(${productId})" class="p-2 bg-emerald-600 text-white rounded hover:bg-emerald-700" title="Définir comme principale"><i data-lucide="star" class="w-4 h-4"></i></button>` : ''}
                                        <button onclick="GestionnaireModule.showImageEditModal(${productId}, '${img.id}')" class="p-2 bg-blue-600 text-white rounded hover:bg-blue-700" title="Éditer"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                        <button onclick="GestionnaireModule.deleteImage('${img.id}', ${productId})" class="p-2 bg-red-600 text-white rounded hover:bg-red-700" title="Supprimer"><i data-lucide="trash" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="text-xs text-slate-500 text-center pt-2">${images.length} image(s)</div>
                    ` : `
                        <div class="p-8 text-center text-slate-500">
                            <i data-lucide="image-off" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                            <div class="text-sm">Aucune image pour ce produit</div>
                        </div>
                    `}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showImageUploadModal(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return;

            UI.modal(`⬆️ Télécharger image: ${product.name}`, `
                <div class="space-y-4">
                    <div id="upload_preview" class="hidden">
                        <img id="img_preview" class="w-full h-64 object-contain rounded-xl border border-slate-200 mb-3">
                    </div>

                    <div class="p-6 bg-slate-50 border-2 border-dashed border-slate-300 rounded-2xl text-center cursor-pointer hover:bg-slate-100 transition"
                         ondrop="event.preventDefault(); GestionnaireModule.handleImageDrop(event, ${productId})"
                         ondragover="event.preventDefault(); event.currentTarget.classList.add('bg-blue-50', 'border-blue-400')"
                         ondragleave="event.currentTarget.classList.remove('bg-blue-50', 'border-blue-400')">
                        <input id="file_input" type="file" accept="image/*" style="display:none" onchange="GestionnaireModule.handleImageSelect(event, ${productId})">
                        <button onclick="document.getElementById('file_input').click()" type="button" class="w-full">
                            <i data-lucide="image" class="w-12 h-12 text-slate-400 mx-auto mb-2"></i>
                            <div class="font-bold text-slate-900">Sélectionner image</div>
                            <div class="text-xs text-slate-500">PNG, JPG, WebP (Max 5MB)</div>
                        </button>
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Texte alternatif (alt)</label>
                        <input id="img_alt" type="text" placeholder="Décrire l'image..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Tags (optionnel)</label>
                        <input id="img_tags" type="text" placeholder="Ex: Face avant, Détail, Couleur..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Télécharger', onclick: `GestionnaireModule.saveProductImage(${productId})`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        handleImageSelect(event, productId) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                UI.toast('Fichier trop volumineux (max 5MB)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('upload_preview');
                const previewImg = document.getElementById('img_preview');
                if (preview && previewImg) {
                    previewImg.src = e.target.result;
                    preview.classList.remove('hidden');
                    GestionnaireModule.currentImageData = { base64: e.target.result, filename: file.name };
                }
            };
            reader.readAsDataURL(file);
        },

        handleImageDrop(event, productId) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('file_input').files = files;
                GestionnaireModule.handleImageSelect({ target: { files: files } }, productId);
            }
        },

        saveProductImage(productId) {
            if (!GestionnaireModule.currentImageData) {
                UI.toast('Sélectionnez une image', 'error');
                return;
            }

            const alt = UI.val('img_alt') || '';
            const tagsStr = UI.val('img_tags') || '';
            const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()) : [];

            const image = CORE.uploadProductImage(
                productId,
                GestionnaireModule.currentImageData.base64,
                GestionnaireModule.currentImageData.filename,
                alt
            );

            if (image) {
                CORE.updateImageMetadata(image.id, alt, tags);
                GestionnaireModule.currentImageData = null;
                UI.toast('Image téléchargée', 'success');
                UI.closeModal();
                GestionnaireModule.showImageManagementModal(productId);
            }
        },






        showImageEditModal(productId, imageId) {
            const image = CORE.db.productImages.find(img => img.id === imageId);
            if (!image) return;

            UI.modal(`✏️ Éditer image`, `
                <div class="space-y-4">
                    <img src="${image.url}" alt="${image.alt}" class="w-full h-48 object-contain rounded-xl border border-slate-200">

                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Texte alternatif</label>
                        <input id="edit_img_alt" type="text" value="${image.alt || ''}" placeholder="Décrire l'image..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Tags</label>
                        <input id="edit_img_tags" type="text" value="${image.tags ? image.tags.join(', ') : ''}" placeholder="Ex: Face avant, Détail..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm">
                    </div>

                    <div class="p-3 bg-slate-50 rounded-xl border border-slate-100 text-xs text-slate-600">
                        <div class="font-black mb-1">Informations:</div>
                        <div>📅 ${CORE.formatDate(image.uploadedAt)}</div>
                        <div>👤 ${image.uploadedByName || 'Unknown'}</div>
                        <div>📦 ${Math.round(image.filesize / 1024)}KB</div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: `GestionnaireModule.updateImageMetadata('${imageId}', ${productId})`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        updateImageMetadata(imageId, productId) {
            const alt = UI.val('edit_img_alt') || '';
            const tagsStr = UI.val('edit_img_tags') || '';
            const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()) : [];

            if (CORE.updateImageMetadata(imageId, alt, tags)) {
                UI.toast('Image mise à jour', 'success');
                UI.closeModal();
                GestionnaireModule.showImageManagementModal(productId);
            }
        },

        deleteImage(imageId, productId) {
            if (!confirm('Supprimer cette image?')) return;
            if (CORE.deleteProductImage(imageId)) {
                UI.toast('Image supprimée', 'success');
                GestionnaireModule.showImageManagementModal(productId);
            }
        },

        currentImageData: null,

        showSettingsModal() {
            this.navigateTo('settings'); App.rerender();
            setTimeout(() => { if (window.AccountSwitcher) AccountSwitcher.renderSection(); }, 200);
        },

        setLanguage(code) {
            I18n.setLanguage(code);
            if (VendeurModule?.state?.preferences) VendeurModule.state.preferences.language = code;
            UI.closeModal();
            const langNames = { fr: 'Français', en: 'English', es: 'Español', ar: 'العربية', pt: 'Português', zh: '中文', tr: 'Türkçe', de: 'Deutsch', ru: 'Русский' };
            UI.toast(`✓ Langue: ${langNames[code] || code.toUpperCase()}`, 'success');
            App.rerender();
            this.showSettingsModal();
        },

        showThemeModal() {
            UI.modal('🎨 Thème', `
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="GestionnaireModule.setTheme('light'); UI.closeModal()" class="p-4 rounded-xl border-2 transition flex flex-col items-center justify-center gap-2 ${this.state.theme === 'light' ? 'border-amber-500 bg-amber-50' : 'border-slate-200 hover:border-slate-300'}">
                            <i data-lucide="sun" class="w-6 h-6 ${this.state.theme === 'light' ? 'text-amber-600' : 'text-slate-400'}"></i>
                            <span class="text-xs font-black ${this.state.theme === 'light' ? 'text-amber-700' : 'text-slate-600'}">Clair</span>
                        </button>
                        <button onclick="GestionnaireModule.setTheme('dark'); UI.closeModal()" class="p-4 rounded-xl border-2 transition flex flex-col items-center justify-center gap-2 ${this.state.theme === 'dark' ? 'border-amber-500 bg-amber-50' : 'border-slate-200 hover:border-slate-300'}">
                            <i data-lucide="moon" class="w-6 h-6 ${this.state.theme === 'dark' ? 'text-amber-600' : 'text-slate-400'}"></i>
                            <span class="text-xs font-black ${this.state.theme === 'dark' ? 'text-amber-700' : 'text-slate-600'}">Sombre</span>
                        </button>
                        <button onclick="GestionnaireModule.setTheme('auto'); UI.closeModal()" class="p-4 rounded-xl border-2 transition flex flex-col items-center justify-center gap-2 ${this.state.theme === 'auto' ? 'border-amber-500 bg-amber-50' : 'border-slate-200 hover:border-slate-300'}">
                            <i data-lucide="monitor" class="w-6 h-6 ${this.state.theme === 'auto' ? 'text-amber-600' : 'text-slate-400'}"></i>
                            <span class="text-xs font-black ${this.state.theme === 'auto' ? 'text-amber-700' : 'text-slate-600'}">Auto</span>
                        </button>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showSlaConfigModal() {
            UI.modal('⚡ SLA & KPIs', `
                <div class="space-y-4 max-h-[500px] overflow-y-auto">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Taux dans les délais min (%)</label>
                            <input id="sla_onTime" type="number" min="0" max="100" value="${this.state.slaThresholds.minOnTimeRate}" class="w-full px-3 py-2 bg-white border border-slate-200 rounded-xl text-sm font-medium" />
                        </div>
                        <div>
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Commandes en attente max</label>
                            <input id="sla_pending" type="number" min="0" value="${this.state.slaThresholds.maxPendingOrders}" class="w-full px-3 py-2 bg-white border border-slate-200 rounded-xl text-sm font-medium" />
                        </div>
                        <div>
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Dépôts journaliers min (FCFA)</label>
                            <input id="sla_deposits" type="number" min="0" value="${this.state.slaThresholds.minDailyDeposits}" class="w-full px-3 py-2 bg-white border border-slate-200 rounded-xl text-sm font-medium" />
                        </div>
                        <div>
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Délai livraison max (min)</label>
                            <input id="sla_minutes" type="number" min="1" value="${this.state.slaThresholds.maxDeliveryMinutes}" class="w-full px-3 py-2 bg-white border border-slate-200 rounded-xl text-sm font-medium" />
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: '(function(){ const t={ minOnTimeRate: parseInt(document.getElementById("sla_onTime").value||"80",10), maxPendingOrders: parseInt(document.getElementById("sla_pending").value||"10",10), minDailyDeposits: parseInt(document.getElementById("sla_deposits").value||"50000",10), maxDeliveryMinutes: parseInt(document.getElementById("sla_minutes").value||"60",10)}; GestionnaireModule.state.slaThresholds=t; GestionnaireModule.saveSlaThresholds(t); UI.closeModal(); })()', class: 'px-4 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700' }
            ]);
        },

        showChangePersonalPasswordModal() {
            UI.modal('🔒 Changer votre mot de passe', `
                <div class="space-y-4">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl flex items-center gap-3">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-amber-600 flex-shrink-0"></i>
                        <div class="text-sm text-amber-800 font-medium">Utilisez un mot de passe fort (min 6 caractères)</div>
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Ancien mot de passe</label>
                        <input type="password" id="old_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Entrez votre ancien mot de passe">
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Nouveau mot de passe</label>
                        <input type="password" id="new_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Entrez un nouveau mot de passe">
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Confirmation du nouveau mot de passe</label>
                        <input type="password" id="confirm_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-sky-500 outline-none" placeholder="Confirmez le nouveau mot de passe">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Changer le mot de passe', onclick: 'GestionnaireModule.savePersonalPasswordChange()', class: 'px-5 py-2.5 bg-sky-600 text-white font-black rounded-xl hover:bg-sky-700' }
            ]);
        },

        savePersonalPasswordChange() {
            const oldPwd = UI.val('old_pwd');
            const newPwd = UI.val('new_pwd');
            const confirmPwd = UI.val('confirm_pwd');
            const user = CORE.state.currentUser;

            if (!oldPwd || !newPwd || !confirmPwd) {
                UI.toast('Tous les champs sont obligatoires', 'error');
                return;
            }

            if (newPwd.length < 6) {
                UI.toast('Le nouveau mot de passe doit contenir au moins 6 caractères', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                UI.toast('Les mots de passe ne correspondent pas', 'error');
                return;
            }

            if (oldPwd === newPwd) {
                UI.toast('Le nouveau mot de passe doit être différent', 'error');
                return;
            }

            // Vérifier l'ancien mot de passe
            if (user.password !== oldPwd) {
                UI.toast('Ancien mot de passe incorrect', 'error');
                return;
            }

            // Mettre à jour
            user.password = newPwd;
            CORE.save();
            UI.closeModal();
            UI.toast('Mot de passe modifié avec succès', 'success');
        },

        applyStockMovement() {
            const productId = parseInt(UI.val('mov_product') || '0', 10);
            const qty = Math.abs(parseInt(UI.val('mov_qty') || '0', 10));
            const type = UI.val('mov_type');
            const note = UI.val('mov_note');
            if (!productId || !qty || !type) return UI.toast('Champs requis', 'warning');
            const p = CORE.getProduct(productId);
            if (!p) return;

            let next = p.stock || 0;
            if (type === 'in') next = (p.stock || 0) + qty;
            if (type === 'out') next = (p.stock || 0) - qty;
            if (type === 'adjust') next = qty;
            // P3-10: Clamp global stock to 0 (consistent with posStocks)
            next = Math.max(0, next);
            if (type === 'out' && next === 0 && (p.stock || 0) > 0 && qty > (p.stock || 0)) return UI.toast('Stock ne peut pas être négatif', 'error');

            const updates = { stock: next };
            // Also update POS-specific stock
            const movPosId = CORE.user?.pos;
            if (movPosId && p.posStocks && p.posStocks[movPosId]) {
                const newPosStocks = JSON.parse(JSON.stringify(p.posStocks));
                let nextPos = newPosStocks[movPosId].stock || 0;
                if (type === 'in') nextPos += qty;
                if (type === 'out') nextPos -= qty;
                if (type === 'adjust') nextPos = qty;
                newPosStocks[movPosId].stock = Math.max(0, nextPos);
                updates.posStocks = newPosStocks;
            }
            CORE.update('products', p.id, updates);
            CORE.recordStockMovement({ productId: p.id, type, qty, note });
            this.invalidateCache(['products', 'stocks']);
            UI.closeModal();
            UI.toast('Mouvement enregistré', 'success');
            App.rerender();
        },

        // ============ IMPORT/EXPORT DE PRODUITS ============
        showImportProductsModal() {
            UI.modal('📥 Importer des produits (CSV)', `
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="text-sm text-blue-700 font-bold">📋 Format attendu:</div>
                        <div class="text-xs text-blue-600 mt-2 font-mono bg-white p-2 rounded border border-blue-100">
                            nom,reference,prix,stock,minStock,category
                            <br/>Produit1,REF001,15000,50,10,Électronique
                        </div>
                    </div>

                    <div class="border-2 border-dashed border-slate-300 rounded-2xl p-6 text-center cursor-pointer hover:border-blue-400 transition"
                         ondrop="event.preventDefault(); GestionnaireModule.handleImportDrop(event)"
                         ondragover="event.preventDefault(); event.currentTarget.classList.add('border-blue-400', 'bg-blue-50')"
                         ondragleave="event.currentTarget.classList.remove('border-blue-400', 'bg-blue-50')">
                        <input id="import_csv" type="file" accept=".csv" style="display:none" onchange="GestionnaireModule.handleImportFile(event)">
                        <button onclick="document.getElementById('import_csv').click()" type="button" class="w-full">
                            <i data-lucide="upload-cloud" class="w-12 h-12 text-slate-400 mx-auto mb-2"></i>
                            <div class="font-bold text-slate-900">Sélectionner un fichier CSV</div>
                            <div class="text-xs text-slate-500">ou glissez-déposez un fichier</div>
                        </button>
                    </div>

                    <div class="space-y-2 text-xs text-slate-600">
                        <div>✓ Formats acceptés: CSV (UTF-8)</div>
                        <div>✓ Taille max: 5MB</div>
                        <div>✓ Colonnes requises: nom, reference, prix, stock</div>
                        <div id="import_preview" class="hidden mt-4 p-4 bg-slate-50 rounded-xl">
                            <div class="font-bold text-slate-900 mb-2">Aperçu (premiers éléments):</div>
                            <div id="import_preview_content"></div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Importer', onclick: 'GestionnaireModule.applyImport()', id: 'btn_apply_import', disabled: true, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed' }
            ]);
            lucide.createIcons();
        },

        handleImportDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('import_csv').files = files;
                this.handleImportFile({ target: { files: files } });
            }
        },

        handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                UI.toast('Fichier trop volumineux (max 5MB)', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\\n').filter(l => l.trim());
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());

                    const requiredFields = ['nom', 'reference', 'prix'];
                    const missingFields = requiredFields.filter(f => !headers.includes(f));
                    if (missingFields.length > 0) {
                        return UI.toast(`Champs manquants: ${missingFields.join(', ')}`, 'error');
                    }

                    const products = [];
                    for (let i = 1; i < Math.min(lines.length, 11); i++) {
                        const values = lines[i].split(',').map(v => v.trim());
                        const product = {};
                        headers.forEach((h, idx) => {
                            product[h] = values[idx] || '';
                        });
                        if (product.nom) products.push(product);
                    }

                    window._importData = {
                        file: file.name,
                        products: products,
                        totalLines: lines.length - 1
                    };

                    const preview = products.slice(0, 5).map(p =>
                        `<div class="text-xs border-t border-slate-200 py-2">
                            <strong>${p.nom}</strong> (${p.reference}) - ${p.prix} FCFA
                        </div>`
                    ).join('');

                    document.getElementById('import_preview').classList.remove('hidden');
                    document.getElementById('import_preview_content').innerHTML = preview;
                    document.getElementById('btn_apply_import').disabled = false;

                    UI.toast(`📋 ${window._importData.totalLines} produits trouvés`, 'success');
                } catch (err) {
                    UI.toast('Erreur lors de la lecture du fichier: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        },

        applyImport() {
            if (!window._importData || !window._importData.products.length) {
                return UI.toast('Aucun produit à importer', 'warning');
            }

            const posId = CORE.user?.pos;
            if (!posId) return UI.toast('POS non défini', 'error');

            let imported = 0, skipped = 0, errors = 0;
            const results = [];

            window._importData.products.forEach((p, idx) => {
                try {
                    if (!p.nom || !p.reference || !p.prix) {
                        skipped++;
                        results.push(`⏭️ Ligne ${idx + 2}: Données incomplètes`);
                        return;
                    }

                    // Vérifier doublon
                    const existing = (CORE.getVisibleProducts() || []).find(prod =>
                        prod.reference === p.reference && prod.posId === posId
                    );
                    if (existing) {
                        skipped++;
                        results.push(`⏭️ Ligne ${idx + 2}: ${p.reference} existe déjà`);
                        return;
                    }

                    // Créer le produit
                    const newProduct = CORE.create('products', {
                        name: p.nom,
                        reference: p.reference,
                        price: Math.max(0, parseFloat(p.prix) || 0),
                        stock: Math.max(0, parseInt(p.stock) || 0),
                        minStock: Math.max(0, parseInt(p.minstock) || 5),
                        category: p.category || 'Non catégorisé',
                        posId: posId,
                        active: true
                    });

                    imported++;
                    results.push(`✅ Ligne ${idx + 2}: ${p.reference} importé`);
                } catch (err) {
                    errors++;
                    results.push(`❌ Ligne ${idx + 2}: ${err.message}`);
                }
            });

            CORE.save();
            this.invalidateCache(['products', 'stocks']);

            const message = `✅ ${imported} produit(s) importé(s) | ⏭️ ${skipped} ignoré(s) | ❌ ${errors} erreur(s)`;
            UI.toast(message, imported > 0 ? 'success' : 'warning');

            // Afficher détails
            const details = results.slice(0, 20).join('<br/>');
            UI.modal('📊 Résumé import', `
                <div class="space-y-4">
                    <div class="p-4 ${imported > 0 ? 'bg-emerald-50 border-emerald-200' : 'bg-amber-50 border-amber-200'} border rounded-xl text-sm font-bold">
                        ${message}
                    </div>
                    <div class="max-h-64 overflow-y-auto text-xs space-y-1">
                        ${details}
                        ${results.length > 20 ? `<div class="text-slate-500 italic">... et ${results.length - 20} autres</div>` : ''}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal(); GestionnaireModule.state.currentView = "stocks"; App.rerender();' }
            ]);
        },

        showExportProductsModal() {
            const products = this.getProductsOptimized();

            UI.modal('📤 Exporter les produits', `
                <div class="space-y-4">
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition">
                            <input type="radio" id="export_all" name="export_range" value="all" checked class="w-4 h-4">
                            <div>
                                <div class="font-black text-slate-900">Tous les produits</div>
                                <div class="text-xs text-slate-500">${products.length} produits</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition">
                            <input type="radio" id="export_lowstock" name="export_range" value="lowstock" class="w-4 h-4">
                            <div>
                                <div class="font-black text-slate-900">Stock faible uniquement</div>
                                <div class="text-xs text-slate-500">${products.filter(p => p.stock <= p.minStock).length} produits</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 transition">
                            <input type="radio" id="export_selected" name="export_range" value="selected" class="w-4 h-4">
                            <div>
                                <div class="font-black text-slate-900">Produits avec variantes</div>
                                <div class="text-xs text-slate-500">${products.filter(p => CORE.getProductVariants(p.id).length > 0).length} produits</div>
                            </div>
                        </label>
                    </div>

                    <div class="border-t pt-4">
                        <label class="text-xs font-black text-slate-600 uppercase mb-2 block">Colonnes à exporter</label>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="col_name" checked class="w-4 h-4"> <span class="text-sm">Nom</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="col_ref" checked class="w-4 h-4"> <span class="text-sm">Référence</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="col_prix" checked class="w-4 h-4"> <span class="text-sm">Prix</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="col_stock" checked class="w-4 h-4"> <span class="text-sm">Stock</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="col_minstock" checked class="w-4 h-4"> <span class="text-sm">Stock Min</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="col_category" class="w-4 h-4"> <span class="text-sm">Catégorie</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" id="col_status" class="w-4 h-4"> <span class="text-sm">Statut</span>
                            </label>
                        </div>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-3 text-xs text-blue-700">
                        <strong>💡 Format:</strong> CSV (Excel/Calc compatible)
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Télécharger', onclick: 'GestionnaireModule.applyExport()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        applyExport() {
            const range = document.querySelector('input[name="export_range"]:checked')?.value || 'all';
            let products = this.getProductsOptimized();

            if (range === 'lowstock') {
                products = products.filter(p => p.stock <= p.minStock);
            } else if (range === 'selected') {
                products = products.filter(p => CORE.getProductVariants(p.id).length > 0);
            }

            const columns = [
                { id: 'name', label: 'Nom', checked: document.getElementById('col_name')?.checked },
                { id: 'reference', label: 'Référence', checked: document.getElementById('col_ref')?.checked },
                { id: 'price', label: 'Prix', checked: document.getElementById('col_prix')?.checked },
                { id: 'stock', label: 'Stock', checked: document.getElementById('col_stock')?.checked },
                { id: 'minStock', label: 'Stock Min', checked: document.getElementById('col_minstock')?.checked },
                { id: 'category', label: 'Catégorie', checked: document.getElementById('col_category')?.checked },
                { id: 'active', label: 'Statut', checked: document.getElementById('col_status')?.checked }
            ].filter(c => c.checked);

            if (columns.length === 0) {
                return UI.toast('Sélectionnez au moins une colonne', 'warning');
            }

            // Générer CSV
            let csv = columns.map(c => `"${c.label}"`).join(',') + '\\n';
            csv += products.map(p => {
                return columns.map(col => {
                    let value = p[col.id] || '';
                    if (col.id === 'active') value = p.active ? 'Actif' : 'Inactif';
                    value = String(value).replace(/"/g, '""');
                    return `"${value}"`;
                }).join(',');
            }).join('\\n');

            // Télécharger
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `produits_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            UI.closeModal();
            UI.toast(`✅ ${products.length} produit(s) exporté(s)`, 'success');
        },

        showImportMovementsModal() {
            UI.modal('📥 Importer des mouvements stock', `
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="text-sm text-blue-700 font-bold">📋 Format attendu:</div>
                        <div class="text-xs text-blue-600 mt-2 font-mono bg-white p-2 rounded border border-blue-100">
                            reference,type,quantite,note
                            <br/>REF001,in,50,Réappro fournisseur
                        </div>
                        <div class="text-xs text-blue-600 mt-2">Types: <code>in</code> (entrée), <code>out</code> (sortie), <code>adjust</code> (ajustement)</div>
                    </div>

                    <div class="border-2 border-dashed border-slate-300 rounded-2xl p-6 text-center cursor-pointer hover:border-blue-400 transition"
                         ondrop="event.preventDefault(); GestionnaireModule.handleMovementsImportDrop(event)"
                         ondragover="event.preventDefault(); event.currentTarget.classList.add('border-blue-400', 'bg-blue-50')"
                         ondragleave="event.currentTarget.classList.remove('border-blue-400', 'bg-blue-50')">
                        <input id="import_movements_csv" type="file" accept=".csv" style="display:none" onchange="GestionnaireModule.handleMovementsImportFile(event)">
                        <button onclick="document.getElementById('import_movements_csv').click()" type="button" class="w-full">
                            <i data-lucide="upload-cloud" class="w-12 h-12 text-slate-400 mx-auto mb-2"></i>
                            <div class="font-bold text-slate-900">Sélectionner un fichier CSV</div>
                        </button>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Importer', onclick: 'GestionnaireModule.applyMovementsImport()', id: 'btn_import_movements', disabled: true, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl disabled:opacity-50' }
            ]);
        },

        handleMovementsImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\\n').filter(l => l.trim());
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());

                    const movements = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim());
                        movements.push({
                            reference: values[0],
                            type: values[1],
                            qty: parseInt(values[2]) || 0,
                            note: values[3] || ''
                        });
                    }

                    window._movementsImportData = movements;
                    document.getElementById('btn_import_movements').disabled = false;
                    UI.toast(`✅ ${movements.length} mouvements trouvés`, 'success');
                } catch (err) {
                    UI.toast('Erreur: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        },

        handleMovementsImportDrop(event) {
            event.preventDefault();
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                this.handleMovementsImportFile({ target: { files: files } });
            }
        },

        applyMovementsImport() {
            if (!window._movementsImportData || !window._movementsImportData.length) {
                return UI.toast('Aucun mouvement à importer', 'warning');
            }

            let applied = 0, failed = 0;
            window._movementsImportData.forEach(m => {
                const product = CORE.getVisibleProducts().find(p => p.reference === m.reference);
                if (!product) {
                    failed++;
                    return;
                }

                if (!['in', 'out', 'adjust'].includes(m.type)) {
                    failed++;
                    return;
                }

                let newStock = product.stock;
                if (m.type === 'in') newStock += m.qty;
                if (m.type === 'out') newStock = Math.max(0, newStock - m.qty);
                if (m.type === 'adjust') newStock = m.qty;

                // Mettre à jour stock global ET posStocks
                const impPosId = CORE.user?.pos;
                const impUpdates = { stock: newStock };
                if (impPosId && product.posStocks) {
                    const newPosStocks = JSON.parse(JSON.stringify(product.posStocks));
                    if (!newPosStocks[impPosId]) newPosStocks[impPosId] = { stock: 0, price: product.price || 0 };
                    newPosStocks[impPosId].stock = Math.max(0, newStock);
                    impUpdates.posStocks = newPosStocks;
                }
                CORE.update('products', product.id, impUpdates);
                CORE.recordStockMovement({
                    productId: product.id,
                    type: m.type,
                    qty: m.qty,
                    note: m.note || 'Import en masse'
                });
                applied++;
            });

            CORE.save();
            this.invalidateCache(['products', 'stocks']);
            UI.closeModal();
            UI.toast(`✅ ${applied} mouvement(s) importé(s) | ❌ ${failed} erreur(s)`, applied > 0 ? 'success' : 'warning');
            App.rerender();
        },

        renderDashboard() {
            const user = CORE.state.currentUser;
            const posId = user?.pos;

            // PDG/Manager: voir tous les POS
            const visibleProducts = CORE.getVisibleProducts() || [];
            const allProducts = (user?.role === 'pdg' || user?.role === 'manager')
                ? visibleProducts
                : visibleProducts.filter(p => p.posId == posId);

            const lowStockCount = allProducts.filter(p => !p.isMainWarehouse && p.stock <= p.minStock).length;
            const lastMov = this.getStockMovementsOptimized(8);
            const products = this.getProductsOptimized();
            const totalMovements = (user?.role === 'pdg' || user?.role === 'manager')
                ? CORE.getVisibleStockMovements().length
                : CORE.getVisibleStockMovements().filter(m => m.posId == posId || !m.posId).length;

            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-end justify-between mb-6">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">📊 Tableau de bord Logistique</h2>
                            <p class="text-slate-500 font-medium">Vue d'ensemble des stocks et mouvements</p>
                        </div>
                        <button onclick="GestionnaireModule.showImportProductsModal()" class="px-4 py-2.5 bg-blue-600 text-white rounded-xl font-black text-sm hover:bg-blue-700 transition flex items-center gap-2">
                            <i data-lucide="upload" class="w-4 h-4"></i> Import en masse
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-sm font-black uppercase tracking-wider">Alertes stock</div>
                            <div class="text-4xl font-black ${lowStockCount > 0 ? 'text-red-600' : 'text-emerald-600'} mt-2">${lowStockCount}</div>
                            <p class="text-xs text-slate-400 mt-2">Produits sous seuil critique</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-sm font-black uppercase tracking-wider">Produits</div>
                            <div class="text-4xl font-black text-slate-900 mt-2">${products.length}</div>
                            <p class="text-xs text-slate-400 mt-2">Références actives</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-sm font-black uppercase tracking-wider">Mouvements</div>
                            <div class="text-4xl font-black text-slate-900 mt-2">${totalMovements}</div>
                            <p class="text-xs text-slate-400 mt-2">Historique (derniers 100)</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-black text-slate-900">Mouvements récents</h3>
                            <button onclick="GestionnaireModule.quickRestockModal()" class="text-xs font-black text-sky-700">Nouveau mouvement</button>
                        </div>
                        <div class="p-0">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4">Produit</th>
                                        <th class="px-6 py-4">Type</th>
                                        <th class="px-6 py-4 text-right">Qté</th>
                                        <th class="px-6 py-4 text-right">Date</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${lastMov.length === 0 ? `<tr><td colspan="4" class="px-6 py-10 text-center text-slate-400 italic">Aucun mouvement enregistré</td></tr>` : ''}
                                    ${lastMov.map(m => {
                                        const mQty = m.qty ?? m.quantity ?? 0;
                                        const mDate = m.createdAt || m.timestamp || m.date;
                                        const mRef = m.ref || m.document || '';
                                        const typeMap = { 'in': 'Entrée', 'out': 'Sortie', 'adjust': 'Ajustement', 'transfer': 'Transfert', 'main_depot_transfer': 'Transfert dépôt' };
                                        const typeLabel = typeMap[m.type] || m.type || '—';
                                        return `
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-6 py-4">
                                                <div class="font-black text-slate-900">${m.productName || '—'}</div>
                                                <div class="text-[10px] text-slate-400">${mRef}</div>
                                            </td>
                                            <td class="px-6 py-4">${UI.badge(typeLabel, m.type==='out'?'red':m.type==='in'?'emerald':'blue')}</td>
                                            <td class="px-6 py-4 text-right font-black ${m.type==='out'?'text-red-600':'text-slate-900'}">${m.type==='out' ? '-' : '+'}${mQty}</td>
                                            <td class="px-6 py-4 text-right text-xs text-slate-500">${CORE.formatDate(mDate)}</td>
                                        </tr>
                                    `; }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        },

        renderStocks() {
            const posId = CORE.state.currentUser?.pos || CORE.state.currentUser?.storeId || null;
            const pos = posId ? CORE.getPOS(posId) : null;
            const products = this.getProductsOptimized();
            const searchQuery = (this.state.stockSearch || '').toLowerCase().trim();
            const categoryFilter = this.state.stockCategoryFilter || 'all';
            const statusFilter = this.state.stockStatusFilter || 'all';
            const sortBy = this.state.stockSortBy || 'name';
            const viewMode = this.state.stockViewMode || 'table';
            const page = this.state.stockPage || 1;
            const perPage = this.state.stockPerPage || 50;

            // Filtrer les produits
            let filteredProducts = products.filter(p => {
                if (searchQuery && !(p.name || '').toLowerCase().includes(searchQuery) &&
                    !(p.barcode || '').toLowerCase().includes(searchQuery) &&
                    !(p.reference || '').toLowerCase().includes(searchQuery)) return false;
                if (categoryFilter !== 'all' && p.categoryId != categoryFilter) return false;

                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                const minStock = p.minStock || 0;
                if (statusFilter === 'critical' && stock > minStock * 0.5) return false;
                if (statusFilter === 'low' && (stock > minStock || stock <= minStock * 0.5)) return false;
                if (statusFilter === 'ok' && stock <= minStock) return false;
                if (statusFilter === 'outofstock' && stock > 0) return false;

                return true;
            });

            // Tri
            filteredProducts.sort((a, b) => {
                const stockA = posId ? (CORE.getProductStock(a.id, posId) || a.stock || 0) : (a.stock || 0);
                const stockB = posId ? (CORE.getProductStock(b.id, posId) || b.stock || 0) : (b.stock || 0);
                switch (sortBy) {
                    case 'stock_asc': return stockA - stockB;
                    case 'stock_desc': return stockB - stockA;
                    case 'price_asc': return (a.price || 0) - (b.price || 0);
                    case 'price_desc': return (b.price || 0) - (a.price || 0);
                    case 'value_desc': return (stockB * (b.price || 0)) - (stockA * (a.price || 0));
                    case 'name_desc': return (b.name || '').localeCompare(a.name || '');
                    default: return (a.name || '').localeCompare(b.name || '');
                }
            });

            // Pagination
            const totalFiltered = filteredProducts.length;
            const totalPages = Math.ceil(totalFiltered / perPage);
            const currentPage = Math.min(page, totalPages || 1);
            const startIdx = (currentPage - 1) * perPage;
            const paginatedProducts = filteredProducts.slice(startIdx, startIdx + perPage);

            // Generate pagination buttons
            const paginationPages = [];
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationPages.push(i);
                } else if (paginationPages[paginationPages.length - 1] !== '...') {
                    paginationPages.push('...');
                }
            }

            // Calculs des métriques
            const totalProducts = products.length;
            const totalStock = products.reduce((sum, p) => {
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                return sum + stock;
            }, 0);
            const totalValue = products.reduce((sum, p) => {
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                return sum + (stock * (p.price || 0));
            }, 0);
            const lowStockCount = products.filter(p => {
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                return stock <= (p.minStock || 0) && stock > (p.minStock || 0) * 0.5;
            }).length;
            const criticalCount = products.filter(p => {
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                return stock <= (p.minStock || 0) * 0.5;
            }).length;
            const outOfStockCount = products.filter(p => {
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                return stock === 0;
            }).length;
            const healthyCount = products.filter(p => {
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                return stock > (p.minStock || 0);
            }).length;

            // Catégories
            const categories = CORE.db.categories || [];
            const categoryStats = {};
            products.forEach(p => {
                const catName = CORE.getCategory(p.categoryId)?.name || 'Non catégorisé';
                if (!categoryStats[catName]) categoryStats[catName] = { count: 0, value: 0, stock: 0 };
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                categoryStats[catName].count++;
                categoryStats[catName].stock += stock;
                categoryStats[catName].value += stock * (p.price || 0);
            });

            // Mouvements récents (dernières 24h)
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
            const recentMovements = CORE.getVisibleStockMovements()
                .filter(m => {
                    if (String(m.posId) !== String(posId)) return false;
                    const mDate = m.createdAt || m.timestamp || m.date || '';
                    return mDate >= yesterday;
                })
                .sort((a, b) => new Date(b.createdAt || b.timestamp || b.date || 0) - new Date(a.createdAt || a.timestamp || a.date || 0))
                .slice(0, 10);

            // Produits les plus critiques
            const criticalProducts = products
                .map(p => {
                    const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                    const minStock = p.minStock || 1;
                    const ratio = stock / minStock;
                    return { ...p, stock, ratio };
                })
                .filter(p => p.ratio <= 1)
                .sort((a, b) => a.ratio - b.ratio)
                .slice(0, 8);

            // Valeur par catégorie pour graphique
            const categoryChartData = Object.entries(categoryStats)
                .sort((a, b) => b[1].value - a[1].value)
                .slice(0, 6);
            const maxCatValue = Math.max(...categoryChartData.map(c => c[1].value), 1);

            return `
                <div class="fade-in space-y-6">
                    <!-- En-tête -->
                    <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
                        <div>
                            <div class="flex items-center gap-3">
                                <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="package" class="w-7 h-7 text-white"></i>
                                </div>
                                <div>
                                    <h2 class="text-3xl font-black text-slate-900">📦 Gestion du Stock</h2>
                                    <p class="text-slate-500 font-medium">${pos?.name || 'Tous POS'} • ${filteredProducts.length}/${totalProducts} produit(s) affichés</p>
                                </div>
                            </div>
                            ${/* DIAGNOSTIC VISIBLE — à retirer après debug */ ''}
                            ${totalProducts === 0 ? `<div class="mt-2 p-3 bg-yellow-100 border border-yellow-400 rounded-xl text-xs text-yellow-800 font-mono break-all">
                                <b>🔍 DIAGNOSTIC (temporaire):</b><br>
                                user.pos = ${JSON.stringify(CORE.state.currentUser?.pos)} (${typeof CORE.state.currentUser?.pos})<br>
                                user.storeId = ${JSON.stringify(CORE.state.currentUser?.storeId)} (${typeof CORE.state.currentUser?.storeId})<br>
                                user.pointOfSaleId = ${JSON.stringify(CORE.state.currentUser?.pointOfSaleId)}<br>
                                user.posId = ${JSON.stringify(CORE.state.currentUser?.posId)}<br>
                                user.role = ${CORE.state.currentUser?.role}<br>
                                posId used = ${JSON.stringify(posId)} (${typeof posId})<br>
                                CORE.db.products.length = ${(CORE.db.products||[]).length}<br>
                                getVisibleProducts().length = ${(CORE.getVisibleProducts()||[]).length}<br>
                                pointsOfSale = ${JSON.stringify((CORE.db.pointsOfSale||[]).map(p=>({id:p.id,name:p.name,idType:typeof p.id})))}<br>
                                products = ${JSON.stringify((CORE.db.products||[]).slice(0,5).map(p=>({id:p.id,name:p.name,posId:p.posId,posIdType:typeof p.posId,posStocksKeys:p.posStocks?Object.keys(p.posStocks):'none',locked:p.lockedToPosId})))}
                            </div>` : ''}
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="GestionnaireModule.showAddProductModal()" class="px-4 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-xl font-black text-sm hover:from-emerald-600 hover:to-teal-700 transition shadow-lg shadow-emerald-500/30 flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Nouveau produit
                            </button>
                            <button onclick="GestionnaireModule.showAddStockModal()" class="px-4 py-2.5 bg-blue-600 text-white rounded-xl font-black text-sm hover:bg-blue-700 transition flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> Entrée stock
                            </button>
                            <button onclick="GestionnaireModule.exportStockCSV()" class="px-4 py-2.5 bg-slate-700 text-white rounded-xl font-black text-sm hover:bg-slate-800 transition flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> Export CSV
                            </button>
                        </div>
                    </div>

                    <!-- Alerte transferts en attente -->
                    ${(() => {
                        const pendingCount = this.getPendingTransfersCount ? this.getPendingTransfersCount() : 0;
                        return pendingCount > 0 ? `
                        <div class="bg-gradient-to-r from-amber-500 to-orange-500 rounded-2xl p-4 text-white shadow-lg cursor-pointer hover:from-amber-600 hover:to-orange-600 transition" onclick="GestionnaireModule.showPendingTransfersModal()">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center animate-pulse">
                                        <i data-lucide="package-check" class="w-6 h-6"></i>
                                    </div>
                                    <div>
                                        <div class="font-black text-lg">📦 ${pendingCount} transfert(s) à réceptionner</div>
                                        <div class="text-sm opacity-90">Cliquez pour valider ou rejeter</div>
                                    </div>
                                </div>
                                <i data-lucide="chevron-right" class="w-6 h-6"></i>
                            </div>
                        </div>
                        ` : '';
                    })()}

                    <!-- Alerte notifications transferts (confirmations/rejets) -->
                    ${(() => {
                        const notifCount = this.getTransferNotificationsCount ? this.getTransferNotificationsCount() : 0;
                        return notifCount > 0 ? `
                        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 rounded-2xl p-4 text-white shadow-lg cursor-pointer hover:from-blue-600 hover:to-indigo-700 transition" onclick="GestionnaireModule.showTransferNotificationsModal()">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center animate-pulse">
                                        <i data-lucide="bell-ring" class="w-6 h-6"></i>
                                    </div>
                                    <div>
                                        <div class="font-black text-lg">🔔 ${notifCount} notification(s) de transfert</div>
                                        <div class="text-sm opacity-90">Réponses des POS destinataires - Cliquez pour voir les preuves</div>
                                    </div>
                                </div>
                                <i data-lucide="chevron-right" class="w-6 h-6"></i>
                            </div>
                        </div>
                        ` : '';
                    })()}

                    <!-- Barre d'actions rapides -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <div class="flex items-center gap-2 mb-3">
                            <i data-lucide="zap" class="w-5 h-5 text-amber-500"></i>
                            <span class="font-black text-slate-800">Actions rapides</span>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-5 lg:grid-cols-10 gap-3">
                            <button onclick="GestionnaireModule.showAddProductModal()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-slate-200 hover:border-emerald-300 hover:bg-emerald-50/50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="package-plus" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Nouveau produit</span>
                            </button>
                            <button class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-blue-500 bg-blue-50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="layout-dashboard" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Dashboard</span>
                            </button>
                            <button onclick="GestionnaireModule.showPendingTransfersModal()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 ${this.getPendingTransfersCount && this.getPendingTransfersCount() > 0 ? 'border-amber-500 bg-amber-50 animate-pulse' : 'border-slate-200 hover:border-amber-300 hover:bg-amber-50/50'} transition group relative">
                                <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="package-check" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Réceptions</span>
                                ${this.getPendingTransfersCount && this.getPendingTransfersCount() > 0 ? `<span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-black rounded-full flex items-center justify-center">${this.getPendingTransfersCount()}</span>` : ''}
                            </button>
                            <button onclick="GestionnaireModule.showTransferNotificationsModal()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 ${this.getTransferNotificationsCount && this.getTransferNotificationsCount() > 0 ? 'border-blue-500 bg-blue-50' : 'border-slate-200 hover:border-blue-300 hover:bg-blue-50/50'} transition group relative">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="bell-ring" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Notifs Transferts</span>
                                ${this.getTransferNotificationsCount && this.getTransferNotificationsCount() > 0 ? `<span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-black rounded-full flex items-center justify-center">${this.getTransferNotificationsCount()}</span>` : ''}
                            </button>
                            <button onclick="GestionnaireModule.showStockIndicators()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-slate-200 hover:border-emerald-300 hover:bg-emerald-50/50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="gauge" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Indicateurs</span>
                            </button>
                            <button onclick="GestionnaireModule.showStockHistory()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-slate-200 hover:border-purple-300 hover:bg-purple-50/50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-violet-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="history" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Historique</span>
                            </button>
                            <button onclick="GestionnaireModule.showBulkReorderModal()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-slate-200 hover:border-amber-300 hover:bg-amber-50/50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="repeat" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Réappro masse</span>
                            </button>
                            <button onclick="GestionnaireModule.showTransferStockModal()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-slate-200 hover:border-cyan-300 hover:bg-cyan-50/50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="send" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Envoyer Stock</span>
                            </button>
                            <button onclick="GestionnaireModule.showStockAnalysis()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-slate-200 hover:border-pink-300 hover:bg-pink-50/50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-pink-500 to-rose-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="bar-chart-3" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Analyse</span>
                            </button>
                            <button onclick="GestionnaireModule.showStockRecommendations()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-slate-200 hover:border-indigo-300 hover:bg-indigo-50/50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="lightbulb" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Recommandations</span>
                            </button>
                            <button onclick="GestionnaireModule.exportStockCSV()" class="flex flex-col items-center gap-2 p-3 rounded-xl border-2 border-slate-200 hover:border-slate-400 hover:bg-slate-50 transition group">
                                <div class="w-10 h-10 bg-gradient-to-br from-slate-600 to-slate-800 rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition">
                                    <i data-lucide="download" class="w-5 h-5 text-white"></i>
                                </div>
                                <span class="text-xs font-bold text-slate-700">Export CSV</span>
                            </button>
                        </div>
                    </div>

                    <!-- KPIs Principaux -->
                    <div class="grid grid-cols-2 lg:grid-cols-6 gap-4">
                        <div class="bg-gradient-to-br from-slate-50 to-slate-100 p-5 rounded-2xl border border-slate-200 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Total Produits</div>
                                    <div class="text-3xl font-black text-slate-900 mt-2">${totalProducts}</div>
                                </div>
                                <div class="w-12 h-12 bg-slate-200 rounded-xl flex items-center justify-center">
                                    <i data-lucide="box" class="w-6 h-6 text-slate-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-5 rounded-2xl border border-blue-200 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-black text-blue-600 uppercase tracking-wider">Unités Stock</div>
                                    <div class="text-3xl font-black text-blue-900 mt-2">${totalStock.toLocaleString()}</div>
                                </div>
                                <div class="w-12 h-12 bg-blue-200 rounded-xl flex items-center justify-center">
                                    <i data-lucide="layers" class="w-6 h-6 text-blue-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-5 rounded-2xl border border-emerald-200 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-black text-emerald-600 uppercase tracking-wider">Valeur Totale</div>
                                    <div class="text-2xl font-black text-emerald-900 mt-2">${CORE.formatPrice(totalValue)}</div>
                                </div>
                                <div class="w-12 h-12 bg-emerald-200 rounded-xl flex items-center justify-center">
                                    <i data-lucide="banknote" class="w-6 h-6 text-emerald-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-5 rounded-2xl border border-green-200 shadow-sm cursor-pointer hover:shadow-md transition" onclick="GestionnaireModule.state.stockStatusFilter='ok';App.rerender()">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-black text-green-600 uppercase tracking-wider">Stock OK</div>
                                    <div class="text-3xl font-black text-green-900 mt-2">${healthyCount}</div>
                                </div>
                                <div class="w-12 h-12 bg-green-200 rounded-xl flex items-center justify-center">
                                    <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-5 rounded-2xl border border-amber-200 shadow-sm cursor-pointer hover:shadow-md transition" onclick="GestionnaireModule.state.stockStatusFilter='low';App.rerender()">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-black text-amber-600 uppercase tracking-wider">Stock Bas</div>
                                    <div class="text-3xl font-black text-amber-900 mt-2">${lowStockCount}</div>
                                </div>
                                <div class="w-12 h-12 bg-amber-200 rounded-xl flex items-center justify-center">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-amber-600"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-red-100 p-5 rounded-2xl border border-red-200 shadow-sm cursor-pointer hover:shadow-md transition" onclick="GestionnaireModule.state.stockStatusFilter='critical';App.rerender()">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-xs font-black text-red-600 uppercase tracking-wider">Critique</div>
                                    <div class="text-3xl font-black text-red-900 mt-2">${criticalCount}</div>
                                </div>
                                <div class="w-12 h-12 bg-red-200 rounded-xl flex items-center justify-center">
                                    <i data-lucide="alert-octagon" class="w-6 h-6 text-red-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alertes critiques -->
                    ${criticalProducts.length > 0 ? `
                    <div class="bg-gradient-to-r from-red-500 to-orange-500 rounded-2xl p-6 text-white shadow-xl">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <div class="font-black text-lg">⚠️ Alertes Stock Critique</div>
                                <div class="text-white/80 text-sm">${criticalProducts.length} produit(s) nécessitent une attention immédiate</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                            ${criticalProducts.map(p => {
                                const percent = Math.round(p.ratio * 100);
                                return `
                                <div class="bg-white/10 backdrop-blur rounded-xl p-4 hover:bg-white/20 transition cursor-pointer" onclick="GestionnaireModule.showQuickStockModal(${p.id})">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="font-bold text-sm truncate flex-1">${p.name}</span>
                                        <span class="px-2 py-1 bg-white/20 rounded-lg text-xs font-black ml-2">${percent}%</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="flex-1 h-2 bg-white/20 rounded-full overflow-hidden">
                                            <div class="h-full ${percent <= 25 ? 'bg-red-300' : 'bg-amber-300'} rounded-full" style="width: ${Math.max(5, percent)}%"></div>
                                        </div>
                                        <span class="text-xs font-bold">${p.stock}/${p.minStock || 0}</span>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ` : `
                    <div class="bg-gradient-to-r from-emerald-500 to-teal-500 rounded-2xl p-6 text-white shadow-xl">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                <i data-lucide="check-circle" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <div class="font-black text-lg">✅ Tous les stocks sont OK</div>
                                <div class="text-white/80 text-sm">Aucun produit en situation critique</div>
                            </div>
                        </div>
                    </div>
                    `}

                    <!-- Graphiques et statistiques -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Répartition par catégorie -->
                        <div class="lg:col-span-2 bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-lg font-black text-slate-900">📊 Valeur par Catégorie</h3>
                                <span class="text-xs text-slate-500">${Object.keys(categoryStats).length} catégories</span>
                            </div>
                            <div class="space-y-4">
                                ${categoryChartData.map(([cat, data], idx) => {
                                    const percent = Math.round((data.value / totalValue) * 100) || 0;
                                    const widthPercent = Math.round((data.value / maxCatValue) * 100);
                                    const colors = ['bg-blue-500', 'bg-emerald-500', 'bg-amber-500', 'bg-purple-500', 'bg-pink-500', 'bg-cyan-500'];
                                    return `
                                    <div class="group">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-2">
                                                <div class="w-3 h-3 ${colors[idx % colors.length]} rounded-full"></div>
                                                <span class="font-bold text-slate-900">${cat}</span>
                                                <span class="text-xs text-slate-500">(${data.count} produits)</span>
                                            </div>
                                            <div class="text-right">
                                                <span class="font-black text-slate-900">${CORE.formatPrice(data.value)}</span>
                                                <span class="text-xs text-slate-500 ml-2">${percent}%</span>
                                            </div>
                                        </div>
                                        <div class="h-3 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full ${colors[idx % colors.length]} rounded-full transition-all duration-500 group-hover:opacity-80" style="width: ${widthPercent}%"></div>
                                        </div>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Mouvements récents -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-black text-slate-900">🔄 Mouvements (24h)</h3>
                                <span class="px-2 py-1 bg-slate-100 rounded-lg text-xs font-bold text-slate-600">${recentMovements.length}</span>
                            </div>
                            <div class="space-y-3 max-h-80 overflow-y-auto">
                                ${recentMovements.length === 0 ? `
                                <div class="text-center py-8 text-slate-400">
                                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                    <div class="text-sm">Aucun mouvement récent</div>
                                </div>
                                ` : recentMovements.map(m => {
                                    const isIn = m.type === 'in' || m.type === 'main_depot_transfer';
                                    const isOut = m.type === 'out';
                                    const mQty = m.qty ?? m.quantity ?? 0;
                                    const mDate = m.createdAt || m.timestamp || m.date;
                                    const mNote = m.ref || m.document || m.note || m.notes || '—';
                                    return `
                                    <div class="flex items-center gap-3 p-3 rounded-xl ${isIn ? 'bg-emerald-50' : isOut ? 'bg-red-50' : 'bg-blue-50'} transition hover:shadow-sm">
                                        <div class="w-10 h-10 ${isIn ? 'bg-emerald-200 text-emerald-700' : isOut ? 'bg-red-200 text-red-700' : 'bg-blue-200 text-blue-700'} rounded-xl flex items-center justify-center font-black text-sm">
                                            ${isIn ? '+' : isOut ? '-' : '±'}${mQty}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-slate-900 truncate">${m.productName || 'Produit #' + m.productId}</div>
                                            <div class="text-xs text-slate-500">${mNote}</div>
                                        </div>
                                        <div class="text-xs text-slate-400">${mDate ? new Date(mDate).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : '—'}</div>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                            ${recentMovements.length > 0 ? `
                            <button onclick="GestionnaireModule.showImportMovementsModal()" class="w-full mt-4 py-2.5 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition text-sm">
                                Voir tous les mouvements
                            </button>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Filtres et recherche -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                        <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                            <div class="flex flex-wrap gap-3 items-center">
                                <!-- Recherche -->
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input type="text" value="${searchQuery}"
                                        oninput="GestionnaireModule.state.stockSearch=this.value;GestionnaireModule.state.stockPage=1;App.rerender()"
                                        placeholder="Rechercher produit, code..."
                                        class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium w-64">
                                </div>
                                <!-- Catégorie -->
                                <select onchange="GestionnaireModule.state.stockCategoryFilter=this.value;GestionnaireModule.state.stockPage=1;App.rerender()"
                                    class="px-4 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    <option value="all" ${categoryFilter === 'all' ? 'selected' : ''}>Toutes catégories</option>
                                    ${categories.map(c => `<option value="${c.id}" ${categoryFilter == c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                </select>
                                <!-- Statut stock -->
                                <select onchange="GestionnaireModule.state.stockStatusFilter=this.value;GestionnaireModule.state.stockPage=1;App.rerender()"
                                    class="px-4 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    <option value="all" ${statusFilter === 'all' ? 'selected' : ''}>Tous les stocks</option>
                                    <option value="ok" ${statusFilter === 'ok' ? 'selected' : ''}>✅ Stock OK</option>
                                    <option value="low" ${statusFilter === 'low' ? 'selected' : ''}>⚠️ Stock bas</option>
                                    <option value="critical" ${statusFilter === 'critical' ? 'selected' : ''}>🔴 Critique</option>
                                    <option value="outofstock" ${statusFilter === 'outofstock' ? 'selected' : ''}>❌ Rupture</option>
                                </select>
                                <!-- Tri -->
                                <select onchange="GestionnaireModule.state.stockSortBy=this.value;App.rerender()"
                                    class="px-4 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    <option value="name" ${sortBy === 'name' ? 'selected' : ''}>Nom A-Z</option>
                                    <option value="name_desc" ${sortBy === 'name_desc' ? 'selected' : ''}>Nom Z-A</option>
                                    <option value="stock_asc" ${sortBy === 'stock_asc' ? 'selected' : ''}>Stock ↑</option>
                                    <option value="stock_desc" ${sortBy === 'stock_desc' ? 'selected' : ''}>Stock ↓</option>
                                    <option value="price_asc" ${sortBy === 'price_asc' ? 'selected' : ''}>Prix ↑</option>
                                    <option value="price_desc" ${sortBy === 'price_desc' ? 'selected' : ''}>Prix ↓</option>
                                    <option value="value_desc" ${sortBy === 'value_desc' ? 'selected' : ''}>Valeur ↓</option>
                                </select>
                            </div>
                            <div class="flex gap-2">
                                <!-- Mode vue -->
                                <button onclick="GestionnaireModule.state.stockViewMode='table';App.rerender()"
                                    class="p-2.5 rounded-xl ${viewMode === 'table' ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">
                                    <i data-lucide="list" class="w-5 h-5"></i>
                                </button>
                                <button onclick="GestionnaireModule.state.stockViewMode='grid';App.rerender()"
                                    class="p-2.5 rounded-xl ${viewMode === 'grid' ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">
                                    <i data-lucide="grid-3x3" class="w-5 h-5"></i>
                                </button>
                                <!-- Réinitialiser filtres -->
                                ${(searchQuery || categoryFilter !== 'all' || statusFilter !== 'all') ? `
                                <button onclick="GestionnaireModule.state.stockSearch='';GestionnaireModule.state.stockCategoryFilter='all';GestionnaireModule.state.stockStatusFilter='all';App.rerender()"
                                    class="px-4 py-2.5 bg-red-100 text-red-700 rounded-xl font-bold hover:bg-red-200 transition">
                                    <i data-lucide="x" class="w-4 h-4"></i> Reset
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Liste des produits -->
                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <div class="font-black text-slate-900">${filteredProducts.length} produit(s) trouvé(s)</div>
                            <div class="flex gap-2">
                                <button onclick="GestionnaireModule.showBulkRestockModal()" class="px-4 py-2 bg-amber-100 text-amber-700 rounded-xl font-bold text-sm hover:bg-amber-200 transition flex items-center gap-2">
                                    <i data-lucide="truck" class="w-4 h-4"></i> Réappro groupée
                                </button>
                            </div>
                        </div>

                        ${viewMode === 'grid' ? `
                        <div class="p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            ${filteredProducts.length === 0 ? `
                            <div class="col-span-full py-16 text-center text-slate-400">
                                <i data-lucide="package-x" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                                <div class="font-bold">Aucun produit trouvé</div>
                                <div class="text-sm">Modifiez vos filtres de recherche</div>
                            </div>
                            ` : paginatedProducts.map(p => {
                                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                                const minStock = p.minStock || 0;
                                const ratio = minStock > 0 ? (stock / minStock) : 1;
                                const percent = Math.round(ratio * 100);
                                const isCritical = ratio <= 0.5;
                                const isLow = ratio <= 1 && !isCritical;
                                const isOK = ratio > 1;
                                const statusColor = isCritical ? 'red' : isLow ? 'amber' : 'emerald';
                                const value = stock * (p.price || 0);

                                return `
                                <div class="bg-slate-50 rounded-2xl p-5 border border-slate-200 hover:shadow-lg hover:border-${statusColor}-300 transition group cursor-pointer" onclick="GestionnaireModule.showQuickStockModal(${p.id})">
                                    <div class="flex items-start justify-between mb-3">
                                        <div class="flex-1 min-w-0">
                                            <div class="font-black text-slate-900 truncate">${p.name}</div>
                                            <div class="text-xs text-slate-500">${CORE.getCategory(p.categoryId)?.name || '—'}</div>
                                        </div>
                                        <span class="px-2 py-1 ${isCritical ? 'bg-red-100 text-red-700' : isLow ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'} rounded-lg text-xs font-black">
                                            ${isCritical ? '🔴' : isLow ? '⚠️' : '✅'}
                                        </span>
                                    </div>
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="text-3xl font-black ${isCritical ? 'text-red-600' : isLow ? 'text-amber-600' : 'text-slate-900'}">${stock}</div>
                                        <div class="text-xs text-slate-500">/ min ${minStock}</div>
                                    </div>
                                    <div class="h-2 bg-slate-200 rounded-full overflow-hidden mb-3">
                                        <div class="h-full ${isCritical ? 'bg-red-500' : isLow ? 'bg-amber-500' : 'bg-emerald-500'} rounded-full transition-all" style="width: ${Math.min(100, percent)}%"></div>
                                    </div>
                                    <div class="flex items-center justify-between text-sm">
                                        <span class="font-bold text-slate-700">${CORE.formatPrice(p.price || 0)}</span>
                                        <span class="text-slate-500">Val: ${CORE.formatPrice(value)}</span>
                                    </div>
                                    <div class="mt-3 pt-3 border-t border-slate-200 opacity-0 group-hover:opacity-100 transition flex gap-2">
                                        <button onclick="event.stopPropagation();GestionnaireModule.showQuickStockModal(${p.id})" class="flex-1 py-2 bg-emerald-600 text-white rounded-lg text-xs font-bold hover:bg-emerald-700">+ Entrée</button>
                                        <button onclick="event.stopPropagation();GestionnaireModule.showQuickSortieModal(${p.id})" class="flex-1 py-2 bg-red-600 text-white rounded-lg text-xs font-bold hover:bg-red-700">- Sortie</button>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                        ` : `
                        <div class="overflow-x-auto">
                            <table class="w-full text-left min-w-[900px]">
                                <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4">Produit</th>
                                        <th class="px-6 py-4">Catégorie</th>
                                        <th class="px-6 py-4 text-right">Prix</th>
                                        <th class="px-6 py-4 text-center">Stock</th>
                                        <th class="px-6 py-4 text-center">Min</th>
                                        <th class="px-6 py-4">État</th>
                                        <th class="px-6 py-4 text-right">Valeur</th>
                                        <th class="px-6 py-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${filteredProducts.length === 0 ? `
                                    <tr><td colspan="8" class="px-6 py-16 text-center text-slate-400">
                                        <i data-lucide="package-x" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                                        <div class="font-bold">Aucun produit trouvé</div>
                                    </td></tr>
                                    ` : paginatedProducts.map(p => {
                                        const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                                        const minStock = p.minStock || 0;
                                        const ratio = minStock > 0 ? (stock / minStock) : 1;
                                        const isCritical = ratio <= 0.5;
                                        const isLow = ratio <= 1 && !isCritical;
                                        const value = stock * (p.price || 0);

                                        return `
                                        <tr class="hover:bg-slate-50 transition group">
                                            <td class="px-6 py-4">
                                                <div class="font-black text-slate-900">${p.name}</div>
                                                <div class="text-[10px] text-slate-400">#${p.barcode || p.reference || p.id}</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <span class="px-3 py-1 bg-slate-100 rounded-lg text-xs font-bold text-slate-600">${CORE.getCategory(p.categoryId)?.name || '—'}</span>
                                            </td>
                                            <td class="px-6 py-4 text-right font-black text-slate-900">${CORE.formatPrice(p.price || 0)}</td>
                                            <td class="px-6 py-4 text-center">
                                                <span class="text-xl font-black ${isCritical ? 'text-red-600' : isLow ? 'text-amber-600' : 'text-slate-900'}">${stock}</span>
                                            </td>
                                            <td class="px-6 py-4 text-center font-bold text-slate-500">${minStock}</td>
                                            <td class="px-6 py-4">
                                                ${isCritical ? `<span class="px-3 py-1 bg-red-100 text-red-700 rounded-lg text-xs font-black">🔴 Critique</span>` :
                                                  isLow ? `<span class="px-3 py-1 bg-amber-100 text-amber-700 rounded-lg text-xs font-black">⚠️ Bas</span>` :
                                                  `<span class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-lg text-xs font-black">✅ OK</span>`}
                                            </td>
                                            <td class="px-6 py-4 text-right font-bold text-slate-700">${CORE.formatPrice(value)}</td>
                                            <td class="px-6 py-4 text-right">
                                                <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition">
                                                    <button onclick="GestionnaireModule.showQuickStockModal('${p.id}')" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700" title="Entrée stock">
                                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="GestionnaireModule.showQuickSortieModal('${p.id}')" class="px-3 py-2 rounded-xl bg-red-600 text-white text-xs font-black hover:bg-red-700" title="Sortie stock">
                                                        <i data-lucide="minus" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="ManagerModule.showEditProductModal('${p.id}')" class="px-3 py-2 rounded-xl bg-blue-600 text-white text-xs font-black hover:bg-blue-700" title="Éditer produit">
                                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                                    </button>
                                                    <button onclick="GestionnaireModule.showProductDetailModal('${p.id}')" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300" title="Détails">
                                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination controls -->
                        ${totalPages > 1 ? `
                        <div class="p-4 border-t border-slate-100 flex flex-wrap items-center justify-between gap-4">
                            <div class="text-sm text-slate-600 font-medium">
                                ${totalFiltered === 0 ? 'Aucun produit' : `Affichage ${startIdx + 1}-${Math.min(startIdx + perPage, totalFiltered)} sur ${totalFiltered} produit(s)`}
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-500">Par page:</span>
                                <select onchange="GestionnaireModule.state.stockPerPage=parseInt(this.value);GestionnaireModule.state.stockPage=1;App.rerender()" class="px-2 py-1 rounded-lg border border-slate-200 bg-white text-sm font-bold">
                                    <option value="25" ${perPage === 25 ? 'selected' : ''}>25</option>
                                    <option value="50" ${perPage === 50 ? 'selected' : ''}>50</option>
                                    <option value="100" ${perPage === 100 ? 'selected' : ''}>100</option>
                                    <option value="200" ${perPage === 200 ? 'selected' : ''}>200</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="GestionnaireModule.state.stockPage=1;App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === 1 ? 'disabled' : ''}><i data-lucide="chevrons-left" class="w-4 h-4"></i></button>
                                <button onclick="GestionnaireModule.state.stockPage=Math.max(1,GestionnaireModule.state.stockPage-1);App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === 1 ? 'disabled' : ''}><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                                ${paginationPages.map(p => p === '...' ? `<span class="px-2 text-slate-400">...</span>` : `<button onclick="GestionnaireModule.state.stockPage=${p};App.rerender()" class="px-3 py-2 rounded-lg ${p === currentPage ? 'bg-blue-600 text-white' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm">${p}</button>`).join('')}
                                <button onclick="GestionnaireModule.state.stockPage=Math.min(${totalPages},GestionnaireModule.state.stockPage+1);App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === totalPages ? 'disabled' : ''}><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                                <button onclick="GestionnaireModule.state.stockPage=${totalPages};App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === totalPages ? 'disabled' : ''}><i data-lucide="chevrons-right" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        ` : totalFiltered > 0 ? `
                        <div class="p-4 text-center text-sm text-slate-500 border-t border-slate-100">
                            ${totalFiltered} produit(s) affiché(s)
                        </div>
                        ` : ''}
                        `}
                    </div>
                </div>
            `;
        },

        // Modal rapide pour entrée stock
        showQuickStockModal(productId) {
            const p = CORE.getVisibleProducts().find(x => x.id === productId);
            if (!p) return UI.toast('Produit introuvable', 'error');
            const posId = CORE.user?.pos;
            const currentStock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);

            UI.modal(`📥 Entrée Stock: ${p.name}`, `
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl flex items-center justify-between">
                        <span class="font-bold text-blue-900">Stock actuel</span>
                        <span class="text-2xl font-black text-blue-600">${currentStock}</span>
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Quantité à ajouter</label>
                        <input type="number" id="quick_stock_qty" min="1" value="1" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold text-xl text-center" autofocus>
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Note/Référence</label>
                        <input type="text" id="quick_stock_note" placeholder="Ex: Livraison fournisseur #123" class="w-full px-4 py-3 border border-slate-200 rounded-xl">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Ajouter au stock', onclick: `GestionnaireModule.applyQuickStock(${productId}, 'in')`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        // Modal rapide pour sortie stock
        showQuickSortieModal(productId) {
            const p = CORE.getVisibleProducts().find(x => x.id === productId);
            if (!p) return UI.toast('Produit introuvable', 'error');
            const posId = CORE.user?.pos;
            const currentStock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);

            UI.modal(`📤 Sortie Stock: ${p.name}`, `
                <div class="space-y-4">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl flex items-center justify-between">
                        <span class="font-bold text-amber-900">Stock actuel</span>
                        <span class="text-2xl font-black text-amber-600">${currentStock}</span>
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Quantité à retirer</label>
                        <input type="number" id="quick_stock_qty" min="1" max="${currentStock}" value="1" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold text-xl text-center" autofocus>
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Raison</label>
                        <select id="quick_stock_reason" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold">
                            <option value="Vente directe">Vente directe</option>
                            <option value="Perte/Casse">Perte/Casse</option>
                            <option value="Périmé">Périmé</option>
                            <option value="Transfert">Transfert</option>
                            <option value="Retour fournisseur">Retour fournisseur</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Note</label>
                        <input type="text" id="quick_stock_note" placeholder="Détails supplémentaires" class="w-full px-4 py-3 border border-slate-200 rounded-xl">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Retirer du stock', onclick: `GestionnaireModule.applyQuickStock(${productId}, 'out')`, class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);
        },

        applyQuickStock(productId, type) {
            const pReal = CORE.getProduct(productId);
            if (!pReal) return UI.toast('Produit introuvable', 'error');

            const qty = parseInt(document.getElementById('quick_stock_qty')?.value) || 0;
            const note = document.getElementById('quick_stock_note')?.value || '';
            const reason = document.getElementById('quick_stock_reason')?.value || '';

            if (qty <= 0) return UI.toast('Quantité invalide', 'error');

            const posId = CORE.user?.pos;
            const currentStock = posId ? (CORE.getProductStock(pReal.id, posId) || pReal.stock || 0) : (pReal.stock || 0);
            const newStock = type === 'in' ? currentStock + qty : currentStock - qty;

            if (newStock < 0) return UI.toast('Stock insuffisant', 'error');

            // Mettre à jour stock global ET posStocks
            const updates = { stock: newStock };
            if (posId && pReal.posStocks) {
                const newPosStocks = JSON.parse(JSON.stringify(pReal.posStocks));
                if (!newPosStocks[posId]) newPosStocks[posId] = { stock: 0, price: pReal.price || 0 };
                newPosStocks[posId].stock = Math.max(0, newStock);
                updates.posStocks = newPosStocks;
            }
            CORE.update('products', pReal.id, updates);
            CORE.recordStockMovement({
                productId: pReal.id,
                type,
                qty,
                note: reason ? `${reason}: ${note}` : note,
                posId: posId,
                userName: CORE.state.currentUser?.name
            });

            this.invalidateCache(['products', 'stocks']);
            UI.closeModal();
            UI.toast(`${type === 'in' ? 'Entrée' : 'Sortie'} de ${qty} unité(s) enregistrée`, 'success');
            App.rerender();
        },

        // Modal d'inventaire
        showStockInventoryModal() {
            const products = this.getProductsOptimized();
            const posId = CORE.user?.pos;

            UI.modal('📋 Lancer un Inventaire', `
                <div class="space-y-4">
                    <div class="p-4 bg-purple-50 border border-purple-200 rounded-2xl">
                        <div class="font-black text-purple-900 mb-2">À propos de l'inventaire</div>
                        <div class="text-sm text-purple-700">L'inventaire permet de recenser et ajuster les stocks réels. ${products.length} produits seront inclus.</div>
                    </div>

                    <div class="space-y-3">
                        <label class="flex items-center gap-3 p-4 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50">
                            <input type="radio" name="inventory_type" value="full" checked class="w-4 h-4">
                            <div>
                                <div class="font-black text-slate-900">Inventaire complet</div>
                                <div class="text-xs text-slate-500">Tous les produits (${products.length})</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-4 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50">
                            <input type="radio" name="inventory_type" value="alerts" class="w-4 h-4">
                            <div>
                                <div class="font-black text-slate-900">Produits en alerte uniquement</div>
                                <div class="text-xs text-slate-500">${products.filter(p => (p.stock || 0) <= (p.minStock || 0)).length} produits</div>
                            </div>
                        </label>
                    </div>

                    <div class="pt-4 border-t">
                        <button onclick="GestionnaireModule.exportInventorySheet()" class="w-full py-3 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition flex items-center justify-center gap-2">
                            <i data-lucide="download" class="w-5 h-5"></i>
                            Télécharger feuille d'inventaire (CSV)
                        </button>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            lucide.createIcons();
        },

        exportInventorySheet() {
            const products = this.getProductsOptimized();
            const posId = CORE.user?.pos;
            const pos = posId ? CORE.getPOS(posId) : null;
            const now = new Date().toLocaleDateString('fr-FR');

            let csv = 'ID,Produit,Code-barres,Catégorie,Stock système,Stock réel (à compléter),Écart,Notes\n';
            products.forEach(p => {
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
                csv += `${p.id},"${(p.name || '').replace(/"/g, '""')}","${p.barcode || ''}","${CORE.getCategory(p.categoryId)?.name || ''}",${stock},,,\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `inventaire_${pos?.name || 'pos'}_${now.replace(/\//g, '-')}.csv`;
            link.click();

            UI.toast("Feuille d'inventaire téléchargée", 'success');
        },

        // Modal de réappro groupée
        showBulkRestockModal() {
            const products = this.getProductsOptimized().filter(p => {
                const stock = p.stock || 0;
                return stock <= (p.minStock || 0);
            });

            if (products.length === 0) {
                return UI.toast('Aucun produit en alerte de stock', 'info');
            }

            UI.modal('🚚 Réapprovisionnement Groupé', `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                        <div class="font-black text-amber-900">${products.length} produit(s) en alerte</div>
                        <div class="text-sm text-amber-700">Sélectionnez les produits à réapprovisionner</div>
                    </div>

                    <div class="space-y-2">
                        ${products.map(p => {
                            const stock = p.stock || 0;
                            const minStock = p.minStock || 0;
                            const toOrder = Math.max(0, minStock * 2 - stock);
                            return `
                            <div class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl hover:bg-slate-50">
                                <input type="checkbox" id="restock_${p.id}" checked class="w-4 h-4 rounded">
                                <div class="flex-1">
                                    <div class="font-bold text-slate-900">${p.name}</div>
                                    <div class="text-xs text-slate-500">Stock: ${stock} / Min: ${minStock}</div>
                                </div>
                                <input type="number" id="restock_qty_${p.id}" value="${toOrder}" min="1" class="w-20 px-3 py-2 border border-slate-200 rounded-lg text-center font-bold">
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Appliquer réappro', onclick: 'GestionnaireModule.applyBulkRestock()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        applyBulkRestock() {
            const products = this.getProductsOptimized().filter(p => (p.stock || 0) <= (p.minStock || 0));
            let count = 0;

            products.forEach(p => {
                const checkbox = document.getElementById(`restock_${p.id}`);
                const qtyInput = document.getElementById(`restock_qty_${p.id}`);

                if (checkbox?.checked && qtyInput) {
                    const qty = parseInt(qtyInput.value) || 0;
                    if (qty > 0) {
                        const pReal = CORE.getProduct(p.id);
                        const curStock = pReal ? (pReal.stock || 0) : (p.stock || 0);
                        const newStock = curStock + qty;
                        // Mettre à jour stock global ET posStocks
                        const bPosId = CORE.user?.pos;
                        const bUpdates = { stock: newStock };
                        if (bPosId && pReal && pReal.posStocks) {
                            const newPosStocks = JSON.parse(JSON.stringify(pReal.posStocks));
                            if (!newPosStocks[bPosId]) newPosStocks[bPosId] = { stock: 0, price: pReal.price || 0 };
                            newPosStocks[bPosId].stock = Math.max(0, newStock);
                            bUpdates.posStocks = newPosStocks;
                        }
                        CORE.update('products', p.id, bUpdates);
                        CORE.recordStockMovement({
                            productId: p.id,
                            type: 'in',
                            qty: qty,
                            note: 'Réapprovisionnement groupé',
                posId: CORE.user?.pos,
                userName: CORE.state.currentUser?.name
                        });
                        count++;
                    }
                }
            });

            this.invalidateCache(['products', 'stocks']);
            UI.closeModal();
            UI.toast(`${count} produit(s) réapprovisionné(s)`, 'success');
            App.rerender();
        },

        showProductDetailModal(productId) {
            const p = CORE.getVisibleProducts().find(x => x.id === productId);
            if (!p) return UI.toast('Produit introuvable', 'error');

            const posId = CORE.user?.pos;
                const stock = posId ? (CORE.getProductStock(p.id, posId) || p.stock || 0) : (p.stock || 0);
            const movements = CORE.getVisibleStockMovements()
                .filter(m => m.productId === productId)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 10);

            UI.modal(`📦 ${p.name}`, `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-slate-50 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase">Prix</div>
                            <div class="text-2xl font-black text-slate-900 mt-1">${CORE.formatPrice(p.price || 0)}</div>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-2xl">
                            <div class="text-xs font-black text-blue-600 uppercase">Stock</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${stock}</div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 rounded-2xl">
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><span class="font-bold text-slate-500">Catégorie:</span> ${CORE.getCategory(p.categoryId)?.name || '—'}</div>
                            <div><span class="font-bold text-slate-500">Code-barres:</span> ${p.barcode || '—'}</div>
                            <div><span class="font-bold text-slate-500">Stock min:</span> ${p.minStock || 0}</div>
                            <div><span class="font-bold text-slate-500">Valeur:</span> ${CORE.formatPrice(stock * (p.price || 0))}</div>
                        </div>
                    </div>

                    <div>
                        <div class="font-black text-slate-900 mb-3">Derniers mouvements</div>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            ${movements.length === 0 ? '<div class="text-slate-400 text-sm">Aucun mouvement</div>' :
                            movements.map(m => `
                                <div class="flex items-center gap-3 p-2 rounded-lg ${m.type === 'in' ? 'bg-emerald-50' : m.type === 'out' ? 'bg-red-50' : 'bg-blue-50'}">
                                    <span class="font-black ${m.type === 'in' ? 'text-emerald-600' : m.type === 'out' ? 'text-red-600' : 'text-blue-600'}">${m.type === 'in' ? '+' : '-'}${m.qty}</span>
                                    <span class="flex-1 text-sm text-slate-600">${m.note || m.ref || '—'}</span>
                                    <span class="text-xs text-slate-400">${CORE.formatDate(m.createdAt)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' },
                { label: 'Entrée stock', onclick: `UI.closeModal();GestionnaireModule.showQuickStockModal(${productId})`, class: 'px-4 py-2 bg-emerald-600 text-white font-bold rounded-xl' }
            ]);
        },

        // ========== NOUVELLES FONCTIONS STOCK ==========

        showAddProductModal() {
            const categories = (CORE.db.categories || []).filter(c => !c._deleted);
            const posId = CORE.user?.pos || 1;

            UI.modal('➕ Nouveau Produit', `
                <div class="space-y-4">
                    <div class="p-4 bg-gradient-to-r from-emerald-50 to-teal-50 border border-emerald-200 rounded-xl">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center">
                                <i data-lucide="package-plus" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-emerald-800">Ajouter un nouveau produit</div>
                                <div class="text-xs text-emerald-600">Remplissez les informations du produit</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-black text-slate-700 mb-2">Nom du produit *</label>
                            <input type="text" id="new_product_name" placeholder="Ex: T-shirt Nike" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium">
                        </div>
                        <div>
                            <label class="block text-sm font-black text-slate-700 mb-2">Code/SKU</label>
                            <input type="text" id="new_product_code" placeholder="Ex: TSH-001" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium">
                        </div>
                        <div>
                            <label class="block text-sm font-black text-slate-700 mb-2">Catégorie</label>
                            <div class="flex gap-2">
                                <select id="new_product_category" class="flex-1 px-4 py-3 border border-slate-200 rounded-xl font-bold">
                                    <option value="">Sans catégorie</option>
                                    ${categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                                </select>
                                <button onclick="GestionnaireModule.showQuickAddCategoryModal()" class="px-3 py-2 bg-blue-600 text-white rounded-xl font-black text-xs hover:bg-blue-700 whitespace-nowrap">+ Nouvelle</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-black text-slate-700 mb-2">Prix d'achat</label>
                            <input type="number" id="new_product_cost" min="0" placeholder="0" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold">
                        </div>
                        <div>
                            <label class="block text-sm font-black text-slate-700 mb-2">Prix de vente *</label>
                            <input type="number" id="new_product_price" min="0" placeholder="0" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold">
                        </div>
                        <div>
                            <label class="block text-sm font-black text-slate-700 mb-2">Stock initial</label>
                            <input type="number" id="new_product_stock" min="0" value="0" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold">
                        </div>
                        <div>
                            <label class="block text-sm font-black text-slate-700 mb-2">Stock minimum</label>
                            <input type="number" id="new_product_min" min="0" value="5" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-black text-slate-700 mb-2">Description</label>
                            <textarea id="new_product_desc" placeholder="Description du produit..." rows="2" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium"></textarea>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-black text-slate-700 mb-2">📸 Image du produit</label>
                            <div class="p-4 border-2 border-dashed border-emerald-300 rounded-xl text-center cursor-pointer hover:bg-emerald-50 transition" onclick="document.getElementById('gest_new_product_image').click()">
                                <i data-lucide="upload-cloud" class="w-8 h-8 text-emerald-500 mx-auto mb-2"></i>
                                <div class="font-bold text-emerald-700 text-sm">Cliquez pour ajouter une image</div>
                                <div class="text-xs text-slate-500">JPG, PNG (max 2 Mo)</div>
                                <input id="gest_new_product_image" type="file" accept="image/*" style="display:none" onchange="GestionnaireModule.handleNewProductImage(event)">
                            </div>
                            <div id="gest_product_image_preview" class="mt-2"></div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Créer le produit', onclick: 'GestionnaireModule.saveNewProduct()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' }
            ]);
            setTimeout(() => lucide.createIcons(), 50);
        },

        saveNewProduct() {
            const name = document.getElementById('new_product_name')?.value?.trim();
            const code = document.getElementById('new_product_code')?.value?.trim() || '';
            const categoryId = parseInt(document.getElementById('new_product_category')?.value) || null;
            const cost = parseFloat(document.getElementById('new_product_cost')?.value) || 0;
            const price = parseFloat(document.getElementById('new_product_price')?.value) || 0;
            const stock = parseInt(document.getElementById('new_product_stock')?.value) || 0;
            const minStock = parseInt(document.getElementById('new_product_min')?.value) || 5;
            const description = document.getElementById('new_product_desc')?.value?.trim() || '';

            if (!name) return UI.toast('Le nom du produit est requis', 'warning');
            if (price <= 0) return UI.toast('Le prix de vente doit être supérieur à 0', 'warning');

            const posId = CORE.user?.pos || 1;
            // Initialiser posStocks directement pour éviter la migration qui peut remettre le stock à 0
            const posStocks = {};
            posStocks[posId] = { stock: stock, price: price };
            // Aussi ajouter les autres POS avec stock 0
            (CORE.db.pointsOfSale || []).forEach(loc => {
                if (!posStocks[loc.id]) posStocks[loc.id] = { stock: 0, price: price };
            });
            const newProduct = CORE.create('products', {
                name,
                code,
                categoryId,
                costPrice: cost,
                price,
                stock,
                minStock,
                description,
                image: window._gestNewProductImage || null,
                posId,
                storeId: posId,
                posStocks,
                active: true,
                createdBy: CORE.state.currentUser?.id
            });

            this.invalidateCache('products');

            // Upload image to productImages collection if available
            if (window._gestNewProductImage && newProduct) {
                CORE.uploadProductImage(newProduct.id, window._gestNewProductImage, name + '.jpg');
            }
            window._gestNewProductImage = null;

            // Audit logging
            CORE.logAudit('create', 'product', newProduct.id, name, { description: `Produit créé: ${name} (prix: ${price}, stock: ${stock})` });

            // Background API sync
            if (typeof RayaAPI !== 'undefined' && RayaAPI.isAuthenticated()) {
                RayaAPI.createProduct(newProduct).catch(function(e) { console.warn('[saveNewProduct] API sync failed:', e.message); });
            }

            UI.closeModal();
            UI.toast('Produit créé avec succès', 'success');
            App.rerender();
        },

        showQuickAddCategoryModal() {
            // Sauvegarder les données du formulaire produit
            window._savedGestProductForm = {
                name: document.getElementById('new_product_name')?.value || '',
                code: document.getElementById('new_product_code')?.value || '',
                cost: document.getElementById('new_product_cost')?.value || '',
                price: document.getElementById('new_product_price')?.value || '',
                stock: document.getElementById('new_product_stock')?.value || '',
                min: document.getElementById('new_product_min')?.value || '',
                desc: document.getElementById('new_product_desc')?.value || '',
                image: window._gestNewProductImage || null
            };

            UI.modal('➕ Nouvelle catégorie', `
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl">
                        <div class="text-sm text-blue-700 font-bold">Créez une catégorie pour organiser vos produits</div>
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Nom de la catégorie *</label>
                        <input type="text" id="quick_cat_name" placeholder="Ex: Électronique, Vêtements..." class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium" autofocus>
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Icône (emoji optionnel)</label>
                        <input type="text" id="quick_cat_icon" placeholder="Ex: 👕 📱 🍎" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'GestionnaireModule.cancelQuickCategory()' },
                { label: 'Créer et continuer', onclick: 'GestionnaireModule.saveQuickCategory()', class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700' }
            ]);
        },

        cancelQuickCategory() {
            UI.closeModal();
            // Ré-ouvrir le formulaire produit avec les données sauvegardées
            this.showAddProductModal();
            setTimeout(() => this._restoreGestProductForm(), 100);
        },

        saveQuickCategory() {
            const name = document.getElementById('quick_cat_name')?.value?.trim();
            const icon = document.getElementById('quick_cat_icon')?.value?.trim() || '';
            if (!name) return UI.toast('Le nom est requis', 'warning');

            const newCat = CORE.create('categories', { name, icon });
            UI.closeModal();
            UI.toast(`Catégorie "${name}" créée`, 'success');

            // Ré-ouvrir le formulaire produit et sélectionner la nouvelle catégorie
            this.showAddProductModal();
            setTimeout(() => {
                this._restoreGestProductForm();
                const sel = document.getElementById('new_product_category');
                if (sel && newCat) sel.value = String(newCat.id);
            }, 100);
        },

        _restoreGestProductForm() {
            const s = window._savedGestProductForm;
            if (!s) return;
            const setVal = (id, val) => { const el = document.getElementById(id); if (el && val) el.value = val; };
            setVal('new_product_name', s.name);
            setVal('new_product_code', s.code);
            setVal('new_product_cost', s.cost);
            setVal('new_product_price', s.price);
            setVal('new_product_stock', s.stock);
            setVal('new_product_min', s.min);
            setVal('new_product_desc', s.desc);
            // Restore image
            if (s.image) {
                window._gestNewProductImage = s.image;
                const preview = document.getElementById('gest_product_image_preview');
                if (preview) {
                    preview.innerHTML = '<div class="flex items-center gap-3 mt-2"><img src="' + s.image + '" class="w-16 h-16 object-cover rounded-xl border border-emerald-300"><button onclick="GestionnaireModule.removeNewProductImage()" class="px-3 py-1 bg-red-100 text-red-600 text-xs font-bold rounded-lg hover:bg-red-200">Supprimer</button></div>';
                }
            }
            window._savedGestProductForm = null;
        },

        handleNewProductImage(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) return;
            if (file.size > 2 * 1024 * 1024) return UI.toast('Image trop lourde (max 2 Mo)', 'warning');
            const reader = new FileReader();
            reader.onload = (e) => {
                window._gestNewProductImage = e.target.result;
                const preview = document.getElementById('gest_product_image_preview');
                if (preview) {
                    preview.innerHTML = `
                        <div class="flex items-center gap-3 mt-2">
                            <img src="${e.target.result}" class="w-16 h-16 object-cover rounded-xl border border-emerald-300">
                            <div class="flex-1">
                                <div class="text-xs font-bold text-emerald-700">${file.name}</div>
                                <div class="text-xs text-slate-500">${(file.size / 1024).toFixed(0)} Ko</div>
                            </div>
                            <button onclick="GestionnaireModule.removeNewProductImage()" class="px-3 py-1 bg-red-100 text-red-600 text-xs font-bold rounded-lg hover:bg-red-200">Supprimer</button>
                        </div>
                    `;
                }
            };
            reader.readAsDataURL(file);
        },

        removeNewProductImage() {
            window._gestNewProductImage = null;
            const preview = document.getElementById('gest_product_image_preview');
            if (preview) preview.innerHTML = '';
            const input = document.getElementById('gest_new_product_image');
            if (input) input.value = '';
        },

        exportStockCSV() {
            const products = this.getProductsOptimized();
            const categories = CORE.db.categories || [];

            let csv = 'sep=,\n';
            csv += 'ID,Code,Nom,Categorie,Stock,Stock Min,Prix Achat,Prix Vente,Valeur Stock,Statut\n';

            products.forEach(p => {
                const cat = categories.find(c => c.id === p.categoryId);
                const value = (p.stock || 0) * (p.price || 0);
                const status = (p.stock || 0) <= 0 ? 'Rupture' : (p.stock || 0) <= (p.minStock || 0) ? 'Critique' : 'OK';
                csv += `${p.id},"${p.code || ''}","${p.name || ''}","${cat?.name || 'Sans categorie'}",${p.stock || 0},${p.minStock || 0},${p.costPrice || 0},${p.price || 0},${value},"${status}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'stock_export_' + new Date().toISOString().slice(0,10) + '.csv';
            link.click();

            UI.toast('Export CSV terminé (' + products.length + ' produits)', 'success');
        },

        showBulkReorderModal() {
            const products = this.getProductsOptimized();
            const lowStock = products.filter(p => (p.stock || 0) <= (p.minStock || 0));

            UI.modal('🔄 Réapprovisionnement en Masse', `
                <div class="space-y-4">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-xl">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-amber-500 rounded-xl flex items-center justify-center">
                                <i data-lucide="alert-triangle" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-amber-800">${lowStock.length} produit(s) à réapprovisionner</div>
                                <div class="text-xs text-amber-600">Sélectionnez les produits et quantités</div>
                            </div>
                        </div>
                    </div>

                    ${lowStock.length === 0 ? `
                        <div class="text-center py-8 text-slate-400">
                            <i data-lucide="check-circle" class="w-16 h-16 mx-auto mb-3 text-emerald-400"></i>
                            <div class="font-bold text-emerald-600">Tous les stocks sont OK!</div>
                            <div class="text-sm">Aucun produit ne nécessite de réapprovisionnement</div>
                        </div>
                    ` : `
                        <div class="space-y-3 max-h-[50vh] overflow-y-auto">
                            ${lowStock.map(p => {
                                const deficit = Math.max(0, (p.minStock || 5) * 2 - (p.stock || 0));
                                return `
                                <div class="flex items-center gap-4 p-4 bg-white border border-slate-200 rounded-xl">
                                    <input type="checkbox" id="reorder_${p.id}" checked class="w-5 h-5 rounded border-slate-300 text-emerald-600">
                                    <div class="flex-1">
                                        <div class="font-bold text-slate-900">${p.name}</div>
                                        <div class="text-xs text-slate-500">Stock: ${p.stock || 0} / Min: ${p.minStock || 0}</div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-slate-500">Qté:</span>
                                        <input type="number" id="reorder_qty_${p.id}" value="${deficit}" min="1" class="w-20 px-3 py-2 border border-slate-200 rounded-lg font-bold text-center">
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-xl text-sm text-blue-700">
                            <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                            Les quantités suggérées ramènent le stock à 2x le minimum
                        </div>
                    `}
                </div>
            `, lowStock.length > 0 ? [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Appliquer le réapprovisionnement', onclick: 'GestionnaireModule.applyBulkReorder()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl' }
            ] : [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            setTimeout(() => lucide.createIcons(), 50);
        },

        applyBulkReorder() {
            const products = this.getProductsOptimized();
            let updated = 0;

            products.forEach(p => {
                const checkbox = document.getElementById('reorder_' + p.id);
                const qtyInput = document.getElementById('reorder_qty_' + p.id);

                if (checkbox?.checked && qtyInput) {
                    const qty = parseInt(qtyInput.value) || 0;
                    if (qty > 0) {
                        p.stock = (p.stock || 0) + qty;
                        CORE.recordStockMovement(p.id, qty, 'in', 'Réappro masse', CORE.state.currentUser?.pos);
                        updated++;
                    }
                }
            });

            if (updated > 0) {
                CORE.save();
                this.invalidateCache();
                UI.closeModal();
                UI.toast(updated + ' produit(s) réapprovisionnés', 'success');
                App.rerender();
            } else {
                UI.toast('Aucun produit sélectionné', 'warning');
            }
        },

        showTransferStockModal() {
            const products = CORE.getVisibleProducts() || [];
            const posList = CORE.db.pointsOfSale || [];
            const currentPosId = CORE.state.currentUser?.pos || CORE.state.currentUser?.storeId;

            if (posList.length < 2) {
                return UI.toast('Vous devez avoir au moins 2 POS pour transférer du stock', 'warning');
            }

            // POS source = POS actuel du gestionnaire
            const sourcePos = CORE.getPOS(currentPosId) || posList[0];
            const otherPos = posList.filter(p => p.id !== sourcePos.id);

            // Calculer les stats
            const stockStats = {};
            posList.forEach(pos => {
                const posProducts = products.filter(p => (CORE.getProductStock(p.id, pos.id) || 0) > 0);
                const totalStock = posProducts.reduce((sum, p) => sum + (CORE.getProductStock(p.id, pos.id) || 0), 0);
                const totalValue = posProducts.reduce((sum, p) => sum + ((CORE.getProductStock(p.id, pos.id) || 0) * (p.price || 0)), 0);
                const criticalCount = posProducts.filter(p => (CORE.getProductStock(p.id, pos.id) || 0) <= (p.minStock || 0)).length;
                stockStats[pos.id] = { totalStock, totalValue, criticalCount, productCount: posProducts.length };
            });

            // Suggestions intelligentes
            const suggestions = [];
            otherPos.forEach((destPos) => {
                products.forEach(p => {
                    const srcStock = CORE.getProductStock(p.id, sourcePos.id) || 0;
                    const dstStock = CORE.getProductStock(p.id, destPos.id) || 0;
                    const minStock = p.minStock || 0;
                    const destTarget = Math.max(minStock * 2, minStock + 20);
                    const destDeficit = Math.max(0, destTarget - dstStock);

                    if (srcStock <= 0 || destDeficit <= 0) return;

                    const suggestedQty = Math.min(srcStock, destDeficit);
                    suggestions.push({
                        productId: p.id,
                        productName: p.name,
                        destPosId: destPos.id,
                        destPosName: destPos.name,
                        sourceStock: srcStock,
                        destStock: dstStock,
                        minStock,
                        suggestedQty,
                        severity: dstStock <= Math.max(1, minStock * 0.5) ? 'critical' : 'low'
                    });
                });
            });

            suggestions.sort((a, b) => {
                if (a.severity !== b.severity) return a.severity === 'critical' ? -1 : 1;
                return b.suggestedQty - a.suggestedQty;
            });

            const topSuggestions = suggestions.slice(0, 6);
            const defaultDestPos = otherPos[0] || posList[0];
            const productsWithStock = products.filter(p => (CORE.getProductStock(p.id, sourcePos.id) || 0) > 0);
            const defaultProduct = productsWithStock[0];
            const sourceStats = stockStats[sourcePos.id] || {};

            const html = `
                <div class="space-y-5 max-h-[85vh] overflow-y-auto">
                    <!-- Header avec stats -->
                    <div class="p-4 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl text-white">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <i data-lucide="arrow-left-right" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <div class="font-black text-lg">Transfert depuis ${sourcePos.name}</div>
                                <div class="text-sm opacity-90">Envoyez du stock vers un autre point de vente</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="p-3 bg-white/10 rounded-xl text-center">
                                <div class="text-2xl font-black">${sourceStats.totalStock?.toLocaleString() || 0}</div>
                                <div class="text-xs opacity-80">Unités disponibles</div>
                            </div>
                            <div class="p-3 bg-white/10 rounded-xl text-center">
                                <div class="text-2xl font-black">${CORE.formatPrice ? CORE.formatPrice(sourceStats.totalValue || 0) : (sourceStats.totalValue || 0).toLocaleString() + ' F'}</div>
                                <div class="text-xs opacity-80">Valeur stock</div>
                            </div>
                            <div class="p-3 bg-white/10 rounded-xl text-center">
                                <div class="text-2xl font-black">${suggestions.length}</div>
                                <div class="text-xs opacity-80">Opportunités</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                        <!-- Formulaire de transfert -->
                        <div class="space-y-4">
                            <div class="p-5 bg-white rounded-2xl border border-slate-200 shadow-sm space-y-4">
                                <div class="flex items-center gap-2 text-sm font-black text-slate-700 uppercase">
                                    <i data-lucide="send" class="w-4 h-4 text-purple-500"></i>
                                    Nouveau transfert
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Produit à transférer</label>
                                    <select id="gtf_product" class="w-full px-4 py-3 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-purple-500">
                                        <option value="">Sélectionner un produit</option>
                                        ${productsWithStock.map(p => `
                                            <option value="${p.id}" ${p.id === defaultProduct?.id ? 'selected' : ''}>
                                                ${p.name} • Stock: ${CORE.getProductStock(p.id, sourcePos.id) || 0}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">POS Destination</label>
                                    <select id="gtf_dest_pos" class="w-full px-4 py-3 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-purple-500">
                                        ${otherPos.map(pos => `
                                            <option value="${pos.id}" ${pos.id === defaultDestPos.id ? 'selected' : ''}>
                                                ${pos.name} ${stockStats[pos.id]?.criticalCount > 0 ? '⚠️' : ''}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-3 text-center text-sm">
                                    <div class="p-3 rounded-xl bg-blue-50 border border-blue-200">
                                        <div class="text-xs font-bold text-blue-600 uppercase">Stock source</div>
                                        <div id="gtf_summary_source" class="text-2xl font-black text-blue-900">0</div>
                                    </div>
                                    <div class="p-3 rounded-xl bg-emerald-50 border border-emerald-200">
                                        <div class="text-xs font-bold text-emerald-600 uppercase">Stock dest.</div>
                                        <div id="gtf_summary_dest" class="text-2xl font-black text-emerald-900">0</div>
                                    </div>
                                </div>

                                <div class="p-3 rounded-xl bg-purple-50 border border-purple-200">
                                    <div class="flex items-center justify-between text-sm font-bold text-purple-700">
                                        <span>Stock source après transfert</span>
                                        <span id="gtf_summary_after" class="text-lg">0</span>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Quantité à transférer</label>
                                    <div class="flex gap-2">
                                        <input id="gtf_qty" type="number" min="0" value="0" class="flex-1 px-4 py-3 rounded-xl border border-slate-200 font-black text-xl text-center bg-white focus:ring-2 focus:ring-purple-500">
                                    </div>
                                    <div id="gtf_warning" class="mt-2 text-xs font-bold text-red-600 hidden">⚠️ Stock insuffisant</div>
                                </div>

                                <div class="flex flex-wrap gap-2">
                                    <button data-gtf-set="25" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300 transition">25%</button>
                                    <button data-gtf-set="50" class="px-3 py-2 rounded-xl bg-purple-600 text-white text-xs font-black hover:bg-purple-700 transition">50%</button>
                                    <button data-gtf-set="75" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300 transition">75%</button>
                                    <button data-gtf-set="+10" class="px-3 py-2 rounded-xl bg-slate-100 text-slate-600 text-xs font-black hover:bg-slate-200 transition">+10</button>
                                    <button data-gtf-set="+25" class="px-3 py-2 rounded-xl bg-slate-100 text-slate-600 text-xs font-black hover:bg-slate-200 transition">+25</button>
                                    <button data-gtf-set="clear" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-100 transition">Reset</button>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Motif du transfert</label>
                                    <textarea id="gtf_reason" class="w-full px-4 py-3 rounded-xl border border-slate-200 font-medium bg-white" rows="2" placeholder="Ex: Rééquilibrage stocks, demande POS..."></textarea>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">📅 Date d'arrivée estimée</label>
                                    <input type="datetime-local" id="gtf_eta" class="w-full px-4 py-3 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-purple-500">
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">📸 Photos/Vidéos du stock (optionnel)</label>
                                    <div class="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center hover:border-purple-400 transition cursor-pointer" onclick="document.getElementById('gtf_media_input').click()">
                                        <input type="file" id="gtf_media_input" accept="image/*,video/*" multiple class="hidden" onchange="GestionnaireModule.handleTransferMediaUpload(event)">
                                        <i data-lucide="camera" class="w-8 h-8 text-slate-400 mx-auto mb-2"></i>
                                        <div class="text-sm text-slate-500">Cliquez pour ajouter photos/vidéos</div>
                                        <div class="text-xs text-slate-400">Preuve de l'état du stock avant envoi</div>
                                    </div>
                                    <div id="gtf_media_preview" class="grid grid-cols-4 gap-2 mt-3"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Suggestions et destinations -->
                        <div class="space-y-4">
                            ${topSuggestions.length > 0 ? `
                            <div class="p-5 bg-white rounded-2xl border border-slate-200 shadow-sm">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center gap-2 text-sm font-black text-slate-700 uppercase">
                                        <i data-lucide="sparkles" class="w-4 h-4 text-amber-500"></i>
                                        Suggestions intelligentes
                                    </div>
                                    <span class="text-xs font-bold text-slate-500">${topSuggestions.length} opportunités</span>
                                </div>
                                <div class="space-y-2 max-h-60 overflow-y-auto">
                                    ${topSuggestions.map(s => `
                                        <div class="p-3 rounded-xl border ${s.severity === 'critical' ? 'border-red-200 bg-red-50' : 'border-amber-200 bg-amber-50'} flex items-center justify-between gap-3 hover:shadow-md transition cursor-pointer" data-gtf-suggestion data-dest-id="${s.destPosId}" data-product-id="${s.productId}" data-suggested-qty="${s.suggestedQty}">
                                            <div class="flex-1 min-w-0">
                                                <div class="font-black text-slate-900 text-sm truncate">${s.productName}</div>
                                                <div class="text-xs text-slate-600">→ ${s.destPosName} (Stock: ${s.destStock}/${s.minStock})</div>
                                            </div>
                                            <div class="text-right flex-shrink-0">
                                                <div class="text-lg font-black ${s.severity === 'critical' ? 'text-red-600' : 'text-amber-600'}">${s.suggestedQty}</div>
                                                <div class="text-[10px] text-slate-500">suggéré</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}

                            <div class="p-5 bg-white rounded-2xl border border-slate-200 shadow-sm">
                                <div class="flex items-center gap-2 text-sm font-black text-slate-700 uppercase mb-4">
                                    <i data-lucide="map-pin" class="w-4 h-4 text-blue-500"></i>
                                    POS Destinations
                                </div>
                                <div class="space-y-2">
                                    ${otherPos.map(pos => {
                                        const stats = stockStats[pos.id] || {};
                                        return `
                                            <div class="p-3 rounded-xl ${stats.criticalCount > 0 ? 'bg-red-50 border border-red-200' : 'bg-slate-50 border border-slate-200'} hover:shadow-sm transition">
                                                <div class="flex items-center justify-between mb-1">
                                                    <span class="font-black text-slate-900">${pos.name}</span>
                                                    ${stats.criticalCount > 0 ? `<span class="px-2 py-0.5 bg-red-500 text-white text-[10px] font-black rounded-full">${stats.criticalCount} critique(s)</span>` : ''}
                                                </div>
                                                <div class="flex items-center justify-between text-xs text-slate-600">
                                                    <span>${stats.productCount || 0} produits</span>
                                                    <span class="font-bold">${stats.totalStock || 0} unités</span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            UI.modal('↔️ Transfert de Stock', html, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Effectuer le transfert', onclick: 'GestionnaireModule.executeStockTransfer()', class: 'px-5 py-2.5 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-black rounded-xl hover:from-purple-700 hover:to-indigo-700 transition' }
            ]);

            setTimeout(() => {
                const modalEl = document.querySelector('#modalContainer .slide-up');
                if (modalEl) {
                    modalEl.classList.remove('max-w-lg');
                    modalEl.classList.add('max-w-4xl');
                }
                lucide.createIcons();

                const destPosSelect = document.getElementById('gtf_dest_pos');
                const productSelect = document.getElementById('gtf_product');
                const qtyInput = document.getElementById('gtf_qty');
                const summarySource = document.getElementById('gtf_summary_source');
                const summaryDest = document.getElementById('gtf_summary_dest');
                const summaryAfter = document.getElementById('gtf_summary_after');
                const warning = document.getElementById('gtf_warning');
                const sourcePosId = CORE.user?.pos || 1;

                const updateSummary = function() {
                    const productId = parseInt(productSelect?.value || 0, 10);
                    const destId = parseInt(destPosSelect?.value || 0, 10);
                    const qty = parseInt(qtyInput?.value || 0, 10);

                    const sourceStock = CORE.getProductStock(productId, sourcePosId) || 0;
                    const destStock = CORE.getProductStock(productId, destId) || 0;
                    const newSourceStock = Math.max(0, sourceStock - qty);

                    if (summarySource) summarySource.textContent = sourceStock;
                    if (summaryDest) summaryDest.textContent = destStock;
                    if (summaryAfter) summaryAfter.textContent = newSourceStock + ' unités';
                    if (warning) warning.classList.toggle('hidden', qty <= sourceStock);
                };

                if (destPosSelect) destPosSelect.addEventListener('change', updateSummary);
                if (productSelect) productSelect.addEventListener('change', updateSummary);
                if (qtyInput) qtyInput.addEventListener('input', updateSummary);

                // Boutons de pourcentage
                document.querySelectorAll('[data-gtf-set]').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        const action = btn.getAttribute('data-gtf-set');
                        const productId = parseInt(productSelect?.value || 0, 10);
                        const sourceStock = CORE.getProductStock(productId, sourcePosId) || 0;

                        if (action === '25') qtyInput.value = Math.floor(sourceStock * 0.25);
                        else if (action === '50') qtyInput.value = Math.floor(sourceStock * 0.5);
                        else if (action === '75') qtyInput.value = Math.floor(sourceStock * 0.75);
                        else if (action === 'clear') qtyInput.value = 0;
                        else if (action.startsWith('+')) qtyInput.value = parseInt(qtyInput.value || 0, 10) + parseInt(action.substring(1), 10);

                        updateSummary();
                    });
                });

                // Suggestions cliquables
                document.querySelectorAll('[data-gtf-suggestion]').forEach(function(el) {
                    el.addEventListener('click', function() {
                        const destId = el.getAttribute('data-dest-id');
                        const productId = el.getAttribute('data-product-id');
                        const suggestedQty = el.getAttribute('data-suggested-qty');

                        if (destPosSelect) destPosSelect.value = destId;
                        if (productSelect) productSelect.value = productId;
                        if (qtyInput) qtyInput.value = suggestedQty;
                        updateSummary();
                    });
                });

                updateSummary();
            }, 100);
        },

        // Média pour le transfert sortant
        _transferMedia: [],

        handleTransferMediaUpload(event) {
            const files = event.target.files;
            if (!files.length) return;

            const preview = document.getElementById('gtf_media_preview');
            if (!preview) return;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                const isVideo = file.type.startsWith('video/');

                reader.onload = (e) => {
                    this._transferMedia.push({
                        type: isVideo ? 'video' : 'image',
                        data: e.target.result,
                        name: file.name
                    });

                    const div = document.createElement('div');
                    div.className = 'rounded-lg overflow-hidden border border-slate-200 relative';
                    if (isVideo) {
                        div.innerHTML = `<video src="${e.target.result}" class="w-full h-16 object-cover"></video>
                            <div class="absolute inset-0 flex items-center justify-center bg-black/30">
                                <i data-lucide="play" class="w-6 h-6 text-white"></i>
                            </div>`;
                    } else {
                        div.innerHTML = `<img src="${e.target.result}" class="w-full h-16 object-cover">`;
                    }
                    preview.appendChild(div);
                    lucide.createIcons();
                };
                reader.readAsDataURL(file);
            });
        },

        executeStockTransfer() {
            const productIdRaw = (document.getElementById('gtf_product')?.value || '').toString().trim();
            const destPosIdRaw = (document.getElementById('gtf_dest_pos')?.value || '').toString().trim();
            const qty = parseInt(document.getElementById('gtf_qty')?.value || 0);
            const reason = document.getElementById('gtf_reason')?.value?.trim() || 'Transfert inter-POS';
            const eta = document.getElementById('gtf_eta')?.value || null;
            const media = this._transferMedia || [];
            const sourcePosRaw = CORE.state.currentUser?.pos || CORE.state.currentUser?.storeId;

            const posList = CORE.db.pointsOfSale || [];
            const sourcePos = (CORE.getPOS ? CORE.getPOS(sourcePosRaw) : null)
                || posList.find(p => String(p.id) === String(sourcePosRaw))
                || posList[0]
                || null;
            const destPos = (CORE.getPOS ? CORE.getPOS(destPosIdRaw) : null)
                || posList.find(p => String(p.id) === String(destPosIdRaw))
                || null;

            const sourcePosId = sourcePos ? sourcePos.id : sourcePosRaw;
            const destPosId = destPos ? destPos.id : destPosIdRaw;
            const productId = productIdRaw;

            if (!productIdRaw) return UI.toast('Sélectionnez un produit', 'warning');
            if (!destPosIdRaw) return UI.toast('Sélectionnez une destination', 'warning');
            if (qty <= 0) return UI.toast('La quantité doit être supérieure à 0', 'warning');

            const product = CORE.getProduct ? CORE.getProduct(productId) : CORE.getVisibleProducts().find(p => p.id === productId);

            if (!product || !sourcePos || !destPos) {
                return UI.toast('Données invalides', 'error');
            }

            // Vérifier le stock source
            const sourceStock = CORE.getProductStock ? (CORE.getProductStock(productId, sourcePosId) || 0) : (product.stock || 0);
            if (sourceStock < qty) {
                return UI.toast('Stock insuffisant (disponible: ' + sourceStock + ')', 'error');
            }

            // NOUVEAU: Créer un transfert en attente au lieu d'appliquer directement
            const transferId = 'TRF-' + Date.now().toString(36).toUpperCase();
            CORE.db.stockTransfers = CORE.db.stockTransfers || [];

            const transfer = {
                id: transferId,
                productId: product._apiId || productId,
                productName: product.name,
                productSku: product.barcode || product.sku || null,
                productPrice: product.price || 0,
                productCategory: product.category || product.categoryId || null,
                qty: qty,
                sourcePosId: sourcePosId,
                sourcePosName: sourcePos.name,
                destPosId: destPosId,
                destPosName: destPos.name,
                reason: reason,
                status: 'pending', // pending, accepted, rejected
                createdBy: CORE.state.currentUser?.id,
                createdByName: CORE.state.currentUser?.name || 'Inconnu',
                createdAt: new Date().toISOString(),
                // Nouvelles infos: date d'arrivée et médias d'envoi
                estimatedArrival: eta,
                sendMedia: media, // Photos/vidéos du stock avant envoi
                // Champs pour la réception
                receivedBy: null,
                receivedByName: null,
                receivedAt: null,
                receptionNote: null,
                receptionMedia: [], // URLs des images/vidéos de preuve
                rejectionReason: null
            };

            CORE.db.stockTransfers.push(transfer);

            // Déduire le stock source immédiatement (réservé pour transfert)
            const newSourceStock = sourceStock - qty;
            if (CORE.setProductStock) {
                CORE.setProductStock(productId, sourcePosId, newSourceStock);
            }

            // Enregistrer le mouvement de sortie (réservation)
            if (CORE.recordStockMovement) {
                CORE.recordStockMovement({
                    productId: productId,
                    type: 'out',
                    qty: qty,
                    ref: transferId,
                    note: reason + ' - Transfert en attente vers ' + destPos.name,
                    posId: sourcePosId
                });
            }

            // Créer une notification pour le POS destinataire
            CORE.db.notifications = CORE.db.notifications || [];
            CORE.db.notifications.push({
                id: 'NOTIF-' + CORE.uid(),
                type: 'transfer_incoming',
                title: '📦 Transfert entrant',
                message: qty + ' x ' + product.name + ' en provenance de ' + sourcePos.name,
                details: eta ? 'Arrivée estimée: ' + new Date(eta).toLocaleString('fr-FR') : '',
                transferId: transferId,
                posId: destPosId,
                createdAt: new Date().toISOString(),
                read: false,
                hasMedia: media.length > 0,
                mediaCount: media.length
            });

            // Réinitialiser les médias temporaires
            this._transferMedia = [];

            // Enregistrer dans le journal d'audit
            CORE.db.auditLogs = CORE.db.auditLogs || [];
            CORE.db.auditLogs.push({
                id: 'AUDIT-' + CORE.uid(),
                timestamp: new Date().toISOString(),
                userId: CORE.state.currentUser?.id,
                userName: CORE.state.currentUser?.name || 'Système',
                userRole: CORE.state.currentUser?.role || 'gestionnaire',
                posId: sourcePosId,
                action: 'transfer_out',
                entity: 'stock',
                entityId: transferId,
                entityName: product.name,
                details: 'Transfert de ' + qty + ' unités vers ' + destPos.name,
                status: 'recorded'
            });

            CORE.markDirty('stockTransfers');
            CORE.markDirty('products');
            CORE.markDirty('stockMovements');
            CORE.markDirty('notifications');
            CORE.save(true);

            // SYNC FIX: Force immediate cloud push (500ms debounce instead of 3s)
            // so that the destination POS sees the transfer immediately
            clearTimeout(CORE._cloudPushTimer);
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() && navigator.onLine) {
                CORE._cloudPushTimer = setTimeout(() => CORE._doCloudPush(0), 500);
            }

            this.invalidateCache();
            UI.closeModal();
            UI.toast('📤 Transfert envoyé! En attente de réception par ' + destPos.name, 'success');
            App.rerender();
        },

        // ========== SYSTÈME DE RÉCEPTION DES TRANSFERTS ==========

        getPendingIncomingTransfers() {
            const currentPosId = CORE.state.currentUser?.pos || CORE.state.currentUser?.storeId;
            // FIX: Check BOTH stockTransfers (inter-POS) AND transferReceipts (depot→POS)
            const fromStockTransfers = (CORE.db.stockTransfers || []).filter(t =>
                String(t.destPosId) === String(currentPosId) && t.status === 'pending'
            ).map(t => ({ ...t, _source: 'stockTransfers' }));
            const fromReceipts = (CORE.db.transferReceipts || []).filter(t =>
                String(t.toPosId) === String(currentPosId) && t.status === 'pending'
            ).map(t => ({
                ...t,
                _source: 'transferReceipts',
                // Normalize field names for unified display
                destPosId: t.toPosId,
                destPosName: t.toPosName,
                sourcePosId: t.fromPosId,
                sourcePosName: t.fromPosName || 'Dépôt principal',
                qty: t.quantity || t.qty,
                createdByName: t.createdByName || t.requestedByName || 'Manager'
            }));
            return [...fromStockTransfers, ...fromReceipts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        },

        getPendingOutgoingTransfers() {
            const currentPosId = CORE.state.currentUser?.pos || CORE.state.currentUser?.storeId;
            const fromStockTransfers = (CORE.db.stockTransfers || []).filter(t =>
                String(t.sourcePosId) === String(currentPosId) && t.status === 'pending'
            );
            const fromReceipts = (CORE.db.transferReceipts || []).filter(t =>
                String(t.fromPosId) === String(currentPosId) && t.status === 'pending'
            ).map(t => ({
                ...t,
                _source: 'transferReceipts',
                destPosId: t.toPosId,
                destPosName: t.toPosName,
                sourcePosId: t.fromPosId,
                sourcePosName: t.fromPosName || 'Dépôt principal',
                qty: t.quantity || t.qty
            }));
            return [...fromStockTransfers, ...fromReceipts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        },

        getTransferHistory() {
            const currentPosId = CORE.state.currentUser?.pos || CORE.state.currentUser?.storeId;
            const fromStockTransfers = (CORE.db.stockTransfers || []).filter(t =>
                (String(t.destPosId) === String(currentPosId) || String(t.sourcePosId) === String(currentPosId)) && t.status !== 'pending'
            );
            const fromReceipts = (CORE.db.transferReceipts || []).filter(t =>
                (String(t.toPosId) === String(currentPosId) || String(t.fromPosId) === String(currentPosId)) && t.status !== 'pending'
            ).map(t => ({
                ...t,
                _source: 'transferReceipts',
                destPosId: t.toPosId,
                destPosName: t.toPosName,
                sourcePosId: t.fromPosId,
                sourcePosName: t.fromPosName || 'Dépôt principal',
                qty: t.quantity || t.qty,
                createdByName: t.createdByName || t.requestedByName || 'Manager'
            }));
            return [...fromStockTransfers, ...fromReceipts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        },

        async showPendingTransfersModal() {
            // ...existing code...
            const incoming = this.getPendingIncomingTransfers();
            const outgoing = this.getPendingOutgoingTransfers();
            const history = this.getTransferHistory();
            const currentPosName = CORE.getPOS(CORE.state.currentUser?.pos)?.name || 'Mon POS';

            const html = `
                <div class="space-y-5 max-h-[80vh] overflow-y-auto">
                    <!-- Alerte transferts entrants -->
                    ${incoming.length > 0 ? `
                    <div class="p-4 bg-gradient-to-r from-amber-500 to-orange-500 rounded-2xl text-white">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <i data-lucide="package-check" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <div class="font-black text-lg">📥 ${incoming.length} transfert(s) à réceptionner</div>
                                <div class="text-sm opacity-90">Validez la réception avec preuves</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Transferts entrants -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="download" class="w-5 h-5 text-emerald-600"></i>
                            <span class="font-black text-slate-900">Transferts entrants (à réceptionner)</span>
                            <span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-black">${incoming.length}</span>
                        </div>
                        ${incoming.length === 0 ? `
                            <div class="text-center py-6 text-slate-400">
                                <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                <div>Aucun transfert en attente</div>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${incoming.map(t => `
                                    <div class="p-4 rounded-xl border-2 border-amber-300 bg-amber-50 hover:shadow-lg transition">
                                        <div class="flex items-start justify-between gap-4">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="font-black text-slate-900">${t.productName}</span>
                                                    <span class="px-2 py-0.5 bg-amber-500 text-white text-xs font-black rounded-full">EN ATTENTE</span>
                                                </div>
                                                <div class="text-2xl font-black text-amber-600 mb-2">${t.qty} unités</div>
                                                <div class="text-sm text-slate-600">
                                                    <div>📍 De: <strong>${t.sourcePosName}</strong></div>
                                                    <div>👤 Par: ${t.createdByName}</div>
                                                    <div>📅 Envoyé le: ${new Date(t.createdAt).toLocaleString('fr-FR')}</div>
                                                    ${t.estimatedArrival ? `<div class="mt-1 px-2 py-1 bg-purple-100 text-purple-700 rounded-lg inline-block">🚚 <strong>Arrivée estimée:</strong> ${new Date(t.estimatedArrival).toLocaleString('fr-FR')}</div>` : ''}
                                                    ${t.reason ? `<div class="mt-1">📝 Motif: ${t.reason}</div>` : ''}
                                                </div>
                                                ${t.sendMedia && t.sendMedia.length > 0 ? `
                                                    <div class="mt-3">
                                                        <div class="text-xs font-bold text-slate-500 mb-2">📸 Photos/vidéos du stock envoyé (${t.sendMedia.length})</div>
                                                        <div class="grid grid-cols-4 gap-2">
                                                            ${t.sendMedia.slice(0, 4).map(m => `
                                                                <div class="rounded-lg overflow-hidden border border-slate-200 relative cursor-pointer" onclick="window.open('${m.data}', '_blank')">
                                                                    ${m.type === 'video' ? `
                                                                        <video src="${m.data}" class="w-full h-12 object-cover"></video>
                                                                        <div class="absolute inset-0 flex items-center justify-center bg-black/30">
                                                                            <i data-lucide="play" class="w-4 h-4 text-white"></i>
                                                                        </div>
                                                                    ` : `
                                                                        <img src="${m.data}" class="w-full h-12 object-cover hover:opacity-80">
                                                                    `}
                                                                </div>
                                                            `).join('')}
                                                            ${t.sendMedia.length > 4 ? `<div class="flex items-center justify-center text-xs font-bold text-slate-500">+${t.sendMedia.length - 4}</div>` : ''}
                                                        </div>
                                                        <button onclick="GestionnaireModule.showSendMedia('${t.id}')" class="mt-2 text-xs text-purple-600 hover:underline font-bold">Voir toutes les photos/vidéos</button>
                                                    </div>
                                                ` : ''}
                                            </div>
                                            <div class="flex flex-col gap-2">
                                                <button onclick="GestionnaireModule.showReceiveTransferModal('${t.id}')" class="px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition flex items-center gap-2">
                                                    <i data-lucide="check-circle" class="w-4 h-4"></i> Réceptionner
                                                </button>
                                                <button onclick="GestionnaireModule.showRejectTransferModal('${t.id}')" class="px-4 py-2 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition flex items-center gap-2">
                                                    <i data-lucide="x-circle" class="w-4 h-4"></i> Rejeter
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>

                    <!-- Transferts sortants -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="upload" class="w-5 h-5 text-blue-600"></i>
                            <span class="font-black text-slate-900">Transferts sortants (en attente de réception)</span>
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-black">${outgoing.length}</span>
                        </div>
                        ${outgoing.length === 0 ? `
                            <div class="text-center py-6 text-slate-400">
                                <i data-lucide="send" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                <div>Aucun transfert en cours</div>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${outgoing.map(t => `
                                    <div class="p-4 rounded-xl border border-blue-200 bg-blue-50">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="font-black text-slate-900">${t.productName}</div>
                                                <div class="text-lg font-bold text-blue-600">${t.qty} unités → ${t.destPosName}</div>
                                                <div class="text-xs text-slate-500">Envoyé le ${new Date(t.createdAt).toLocaleString('fr-FR')}</div>
                                            </div>
                                            <div class="px-3 py-1.5 bg-blue-500 text-white text-xs font-black rounded-full flex items-center gap-1">
                                                <i data-lucide="clock" class="w-3 h-3"></i> En attente
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>

                    <!-- Historique des transferts reçus -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="history" class="w-5 h-5 text-slate-600"></i>
                            <span class="font-black text-slate-900">Historique des transferts reçus</span>
                            <span class="px-2 py-1 bg-slate-100 text-slate-700 rounded-full text-xs font-black">${history.length}</span>
                        </div>
                        ${history.length === 0 ? `
                            <div class="text-center py-6 text-slate-400">
                                <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                <div>Aucun transfert reçu</div>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${history.map(t => `
                                    <div class="p-4 rounded-xl border border-slate-200 bg-slate-50">
                                        <div class="flex items-start justify-between gap-4">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="font-black text-slate-900">${t.productName}</span>
                                                    <span class="px-2 py-0.5 bg-slate-400 text-white text-xs font-black rounded-full">${t.status === 'accepted' ? 'REÇU' : t.status}</span>
                                                </div>
                                                <div class="text-2xl font-black text-slate-600 mb-2">${t.qty} unités</div>
                                                <div class="text-sm text-slate-600">
                                                    <div>📍 De: <strong>${t.sourcePosName}</strong></div>
                                                    <div>👤 Par: ${t.createdByName}</div>
                                                    <div>📅 Envoyé le: ${new Date(t.createdAt).toLocaleString('fr-FR')}</div>
                                                    ${t.receivedAt ? `<div>📦 Reçu le: ${new Date(t.receivedAt).toLocaleString('fr-FR')}</div>` : ''}
                                                    ${t.reason ? `<div class="mt-1">📝 Motif: ${t.reason}</div>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;

            UI.modal('📦 Gestion des Transferts', html, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            setTimeout(() => {
                const modalEl = document.querySelector('#modalContainer .slide-up');
                if (modalEl) {
                    modalEl.classList.remove('max-w-lg');
                    modalEl.classList.add('max-w-3xl');
                }
                lucide.createIcons();
            }, 50);
        },

        showReceiveTransferModal(transferId) {
            // FIX: Search BOTH stockTransfers and transferReceipts (depot→POS)
            let transfer = (CORE.db.stockTransfers || []).find(t => t.id === transferId);
            let _transferSource = 'stockTransfers';
            if (!transfer) {
                transfer = (CORE.db.transferReceipts || []).find(t => t.id === transferId);
                _transferSource = 'transferReceipts';
                if (transfer) {
                    // Normalize fields for display
                    transfer = { ...transfer, sourcePosId: transfer.fromPosId, sourcePosName: transfer.fromPosName || 'Dépôt principal', destPosId: transfer.toPosId, destPosName: transfer.toPosName, qty: transfer.quantity || transfer.qty, _source: _transferSource };
                }
            }
            if (!transfer) return UI.toast('Transfert introuvable', 'error');

            // Stocker temporairement les médias
            this._receptionMedia = [];

            const html = `
                <div class="space-y-5">
                    <div class="p-4 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-2xl text-white">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <i data-lucide="package-check" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <div class="font-black text-lg">Réception de transfert</div>
                                <div class="text-sm opacity-90">Confirmez la réception avec preuves</div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <div class="text-slate-500">Produit</div>
                                <div class="font-black text-slate-900 text-lg">${transfer.productName}</div>
                            </div>
                            <div>
                                <div class="text-slate-500">Quantité</div>
                                <div class="font-black text-emerald-600 text-2xl">${transfer.qty} unités</div>
                            </div>
                            <div>
                                <div class="text-slate-500">Provenance</div>
                                <div class="font-bold text-slate-900">${transfer.sourcePosName}</div>
                            </div>
                            <div>
                                <div class="text-slate-500">Envoyé par</div>
                                <div class="font-bold text-slate-900">${transfer.createdByName}</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">📸 Preuves de réception (photos/vidéos)</label>
                        <div class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center hover:border-emerald-400 transition cursor-pointer" onclick="document.getElementById('reception_media').click()">
                            <input type="file" id="reception_media" multiple accept="image/*,video/*" class="hidden" onchange="GestionnaireModule.handleReceptionMediaUpload(event)">
                            <i data-lucide="upload-cloud" class="w-10 h-10 mx-auto mb-2 text-slate-400"></i>
                            <div class="font-bold text-slate-600">Cliquez pour ajouter des photos/vidéos</div>
                            <div class="text-xs text-slate-400 mt-1">JPG, PNG, MP4 acceptés</div>
                        </div>
                        <div id="reception_media_preview" class="grid grid-cols-4 gap-2 mt-3"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">📝 Note de réception</label>
                        <textarea id="reception_note" rows="2" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium" placeholder="Ex: Colis en bon état, quantité vérifiée..."></textarea>
                    </div>

                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-xl">
                        <div class="flex items-start gap-3">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600 mt-0.5"></i>
                            <div class="text-sm text-amber-700">
                                <div class="font-bold">Important</div>
                                <div>En validant, le stock sera ajouté à votre inventaire et le POS source recevra la confirmation.</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            UI.modal('✅ Valider la Réception', html, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Confirmer la réception', onclick: `GestionnaireModule.confirmTransferReception('${transferId}')`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' }
            ]);

            setTimeout(() => lucide.createIcons(), 50);
        },

        handleReceptionMediaUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('reception_media_preview');
            if (!preview) return;

            this._receptionMedia = this._receptionMedia || [];

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const isVideo = file.type.startsWith('video/');
                    const mediaData = {
                        type: isVideo ? 'video' : 'image',
                        data: e.target.result,
                        name: file.name,
                        date: new Date().toISOString()
                    };
                    this._receptionMedia.push(mediaData);

                    // Afficher la preview
                    const div = document.createElement('div');
                    div.className = 'relative rounded-lg overflow-hidden border border-slate-200';
                    if (isVideo) {
                        div.innerHTML = `
                            <video src="${e.target.result}" class="w-full h-20 object-cover"></video>
                            <div class="absolute inset-0 bg-black/30 flex items-center justify-center">
                                <i data-lucide="play-circle" class="w-8 h-8 text-white"></i>
                            </div>
                        `;
                    } else {
                        div.innerHTML = `<img src="${e.target.result}" class="w-full h-20 object-cover">`;
                    }
                    preview.appendChild(div);
                    lucide.createIcons();
                };
                reader.readAsDataURL(file);
            });
        },

        confirmTransferReception(transferId) {
            // FIX: Search BOTH stockTransfers and transferReceipts
            let transfer = (CORE.db.stockTransfers || []).find(t => t.id == transferId);
            let _transferSource = 'stockTransfers';
            if (!transfer) {
                transfer = (CORE.db.transferReceipts || []).find(t => t.id == transferId);
                _transferSource = 'transferReceipts';
                if (transfer) {
                    transfer.sourcePosId = transfer.fromPosId;
                    transfer.sourcePosName = transfer.fromPosName || 'Dépôt principal';
                    transfer.destPosId = transfer.toPosId;
                    transfer.destPosName = transfer.toPosName;
                    transfer.qty = transfer.quantity || transfer.qty;
                    transfer._source = _transferSource;
                }
            }
            if (!transfer) {
                console.error('Transfert introuvable:', transferId);
                return UI.toast('Transfert introuvable', 'error');
            }

            // SYNC FIX: Pull latest products from cloud before confirming reception
            // to ensure we have the latest stock data from the source POS
            (async () => {
                try {
                    if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() && navigator.onLine) {
                        const freshProducts = await API.request('/sync/products?light=1', { method: 'GET', timeout: 8000 });
                        if (freshProducts && Array.isArray(freshProducts.data)) {
                            CORE.db.products = API._smartMerge(CORE.db.products || [], freshProducts.data);
                            // FIX: Invalidate product index after replacing the array
                            // Without this, getProduct() returns stale references from the OLD array,
                            // and setProductStock() modifies a ghost object instead of the real product
                            CORE._productIndex = null;
                            console.log('[TRANSFER-RECEPTION] Pulled ' + freshProducts.data.length + ' products from cloud before confirmation');
                        }
                    }
                } catch(e) {
                    console.warn('[TRANSFER-RECEPTION] Could not pull latest products:', e.message);
                }
                this._doConfirmTransferReception(transfer, transferId);
            })();
        },

        _doConfirmTransferReception(transfer, transferId) {

            const note = document.getElementById('reception_note')?.value?.trim() || '';
            const media = this._receptionMedia || [];

            // S'assurer que les IDs sont cohérents (comparer en tant que strings ou numbers)
            const productId = transfer.productId;
            const destPosId = transfer.destPosId;
            const sourcePosId = transfer.sourcePosId;
            const qty = Number(transfer.qty) || 0;
            
            // DIAGNOSTIC: Log the user's POS vs the transfer's destPosId
            const _userPos = CORE.state.currentUser?.pos || CORE.state.currentUser?.storeId;
            console.log('[TRANSFER-RECEPTION] POS diagnostic:', {
                userPos: _userPos, userPosType: typeof _userPos,
                destPosId: destPosId, destPosIdType: typeof destPosId,
                match: String(_userPos) === String(destPosId),
                sourcePosId: sourcePosId, transferId: transferId
            });
            
            // BUG FIX (v36): If the transfer's destPosId doesn't match the current user's POS,
            // the product will be invisible to this user. Use the user's POS as the REAL destination.
            const effectiveDestPosId = _userPos || destPosId;

            // BUG FIX: Chercher dans TOUS les produits avec recherche multi-critères
            // Le productId peut être un entier (local) ou un UUID (cloud) — il faut chercher les deux
            const allProducts = CORE.db.products || [];
            const pidStr = String(productId);
            let product = allProducts.find(p => p.id == productId)
                || allProducts.find(p => String(p.id) === pidStr)
                || allProducts.find(p => p._origLocalId != null && String(p._origLocalId) === pidStr)
                || allProducts.find(p => p._apiId != null && String(p._apiId) === pidStr)
                || allProducts.find(p => p.barcode && transfer.productSku && p.barcode === transfer.productSku)
                || allProducts.find(p => transfer.productName && p.name === transfer.productName);

            console.log('[TRANSFER-RECEPTION] Recherche produit:', { productId, pidStr, found: !!product, productFoundId: product?.id, productFoundName: product?.name });

            // Si le produit n'existe pas du tout, le créer à partir des infos du transfert
            if (!product) {
                // BUG FIX: Use CORE.create() to get a proper sequential integer ID
                // instead of CORE.uid() which produces a string-based ID that breaks lookups.
                // Also initialize posStocks for the destination POS.
                const destPosStocks = {};
                destPosStocks[destPosId] = { stock: 0, price: transfer.productPrice || 0, lastUpdated: new Date().toISOString() };
                // Initialize posStocks for all known POS with stock=0
                (CORE.db.pointsOfSale || []).forEach(loc => {
                    if (!destPosStocks[loc.id]) destPosStocks[loc.id] = { stock: 0, price: transfer.productPrice || 0 };
                });
                product = CORE.create('products', {
                    name: transfer.productName || 'Produit transféré',
                    price: transfer.productPrice || 0,
                    costPrice: transfer.productPrice || 0,
                    categoryId: transfer.productCategory || null,
                    category: transfer.productCategory || null,
                    barcode: transfer.productSku || null,
                    sku: transfer.productSku || null,
                    description: 'Produit créé automatiquement lors du transfert depuis ' + (transfer.sourcePosName || 'Dépôt principal'),
                    stock: 0,
                    minStock: 5,
                    posStocks: destPosStocks,
                    posId: destPosId,
                    storeId: destPosId,
                    active: true,
                    createdViaTransfer: true,
                    originalTransferId: transferId,
                    originalProductId: productId,
                    _apiId: (typeof productId === 'string' && /^[0-9a-f]{8}-/i.test(productId)) ? productId : null
                });
                // Rebuild index so the new product is immediately findable
                CORE._productIndex = null;
                console.log('[TRANSFER-RECEPTION] Nouveau produit créé (id=' + product.id + '):', product.name);
                UI.toast('ℹ️ Nouveau produit créé: ' + product.name, 'info');
            }

            // Mettre à jour le transfert
            transfer.status = 'accepted';
            transfer.receivedBy = CORE.state.currentUser?.id;
            transfer.receivedByName = CORE.state.currentUser?.name || 'Inconnu';
            transfer.receivedAt = new Date().toISOString();
            transfer.receptionNote = note;
            transfer.receptionMedia = media;

            // BUG FIX (v34): Clear lockedToPosId so the product is visible at the destination POS.
            if (product.lockedToPosId && String(product.lockedToPosId) !== String(effectiveDestPosId)) {
                console.log('[TRANSFER-RECEPTION] Clearing lockedToPosId=' + product.lockedToPosId + ' for product ' + product.id + ' received at POS ' + effectiveDestPosId);
                product.lockedToPosId = null;
            }

            // Ajouter le stock au POS destinataire (use effectiveDestPosId = user's POS)
            if (!product.posStocks) product.posStocks = {};
            if (!product.posStocks[effectiveDestPosId]) product.posStocks[effectiveDestPosId] = { stock: 0, price: product.price || 0 };
            const currentDestStock = Number(product.posStocks[effectiveDestPosId].stock) || 0;
            const newDestStock = currentDestStock + qty;
            product.posStocks[effectiveDestPosId].stock = newDestStock;
            product.posStocks[effectiveDestPosId].lastUpdated = new Date().toISOString();
            product.posStocks[effectiveDestPosId].lastTransfer = new Date().toISOString();

            // ALSO set posStocks for the original destPosId if different from user POS
            if (String(destPosId) !== String(effectiveDestPosId)) {
                if (!product.posStocks[destPosId]) product.posStocks[destPosId] = { stock: 0, price: product.price || 0 };
                product.posStocks[destPosId].stock = (Number(product.posStocks[destPosId].stock) || 0) + qty;
                product.posStocks[destPosId].lastUpdated = new Date().toISOString();
                product.posStocks[destPosId].lastTransfer = new Date().toISOString();
                console.log('[TRANSFER-RECEPTION] Also set posStocks for original destPosId=' + destPosId + ' (differs from user POS=' + effectiveDestPosId + ')');
            }

            // BUG FIX: Décrémenter pendingIncoming
            if (product.posStocks[effectiveDestPosId].pendingIncoming) {
                product.posStocks[effectiveDestPosId].pendingIncoming = Math.max(0,
                    Number(product.posStocks[effectiveDestPosId].pendingIncoming) - qty
                );
            }

            // Also update master stock if product belongs to this POS
            if (product.posId && (String(product.posId) === String(effectiveDestPosId) || String(product.posId) === String(destPosId))) {
                product.stock = newDestStock;
            }
            product.updatedAt = new Date().toISOString();
            CORE._productIndex = null;
            CORE.markDirty('products');

            // LOG DEBUG : Vérifier le stock après ajout
            console.log('[DEBUG TRANSFERT] Après mise à jour stock direct:', {
                produitId: product.id,
                produitNom: product.name,
                effectiveDestPosId: effectiveDestPosId,
                originalDestPosId: destPosId,
                userPos: _userPos,
                stockAvant: currentDestStock,
                stockApres: newDestStock,
                qtyAjoutée: qty,
                posStocks: JSON.parse(JSON.stringify(product.posStocks))
            });

            // Enregistrer le mouvement d'entrée
            CORE.db.stockMovements = CORE.db.stockMovements || [];
            CORE.db.stockMovements.push({
                id: 'MOV-' + CORE.uid(),
                productId: product.id,
                productName: product.name,
                type: 'transfer_in',
                quantity: qty,
                qty: qty,
                ref: transferId,
                note: 'Réception transfert depuis ' + transfer.sourcePosName + (note ? ' - ' + note : ''),
                posId: effectiveDestPosId,
                createdBy: CORE.state.currentUser?.id,
                createdByName: CORE.state.currentUser?.name,
                createdAt: new Date().toISOString(),
                status: 'completed'
            });

            // BUG FIX: Marquer les mouvements orphelins (créés à l'envoi) comme 'completed'
            // executeMainTransfer crée des mouvements avec status:'pending' et ref = receipt.id
            // qui ne sont jamais mis à jour — les marquer maintenant
            (CORE.db.stockMovements || []).forEach(m => {
                if (m.status === 'pending' && (m.ref === transferId ||
                    (transfer._source === 'transferReceipts' && m.meta?.receiptId === transferId))) {
                    m.status = 'completed';
                    m.completedAt = new Date().toISOString();
                }
            });

            // Notification au POS source avec preuves
            CORE.db.notifications = CORE.db.notifications || [];
            CORE.db.notifications.push({
                id: 'NOTIF-' + CORE.uid(),
                type: 'transfer_received',
                title: '✅ Transfert réceptionné',
                message: qty + ' x ' + product.name + ' reçus par ' + transfer.destPosName,
                details: note ? 'Note: ' + note : '',
                transferId: transferId,
                posId: sourcePosId,
                createdAt: new Date().toISOString(),
                read: false,
                hasMedia: media.length > 0,
                mediaCount: media.length,
                receivedByName: CORE.state.currentUser?.name || 'Inconnu'
            });

            this._receptionMedia = [];

            // Marquer la notification entrante comme lue
            (CORE.db.notifications || []).forEach(n => {
                if (n.transferId == transferId && n.type === 'transfer_incoming') {
                    n.read = true;
                    n.processedAt = new Date().toISOString();
                }
            });

            // Enregistrer dans le journal d'audit
            CORE.db.auditLogs = CORE.db.auditLogs || [];
            CORE.db.auditLogs.push({
                id: 'AUDIT-' + CORE.uid(),
                timestamp: new Date().toISOString(),
                userId: CORE.state.currentUser?.id,
                userName: CORE.state.currentUser?.name || 'Système',
                userRole: CORE.state.currentUser?.role || 'gestionnaire',
                posId: effectiveDestPosId,
                action: 'transfer_in',
                entity: 'stock',
                entityId: transferId,
                entityName: product.name,
                details: 'Réception de ' + qty + ' unités depuis ' + transfer.sourcePosName,
                status: 'recorded'
            });

            CORE.markDirty('stockTransfers');
            CORE.markDirty('transferReceipts');
            CORE.markDirty('products');
            CORE.markDirty('stockMovements');
            CORE.markDirty('notifications');
            CORE.save(true);

            // BUG FIX (v36): Verify the product is actually visible after save.
            // If getProductsOptimized or productBelongsToPos fails silently, 
            // we detect it here and log the exact reason.
            var _verifyProductId = product.id;
            var _verifyDestPos = effectiveDestPosId;
            var _verifyProduct = (CORE.db.products || []).find(function(p) { return p.id === _verifyProductId; });
            if (!_verifyProduct) {
                console.error('[TRANSFER-RECEPTION] ❌ CRITICAL: Product id=' + _verifyProductId + ' NOT FOUND in CORE.db.products after save! Array length=' + (CORE.db.products || []).length);
            } else {
                var _vps = _verifyProduct.posStocks || {};
                var _hasDestStock = _vps[_verifyDestPos] || _vps[String(_verifyDestPos)];
                console.log('[TRANSFER-RECEPTION] ✅ Verification:', {
                    productId: _verifyProduct.id,
                    productName: _verifyProduct.name,
                    posId: _verifyProduct.posId,
                    lockedToPosId: _verifyProduct.lockedToPosId || null,
                    destPosId: _verifyDestPos,
                    hasDestStock: !!_hasDestStock,
                    destStock: _hasDestStock ? _hasDestStock.stock : 'N/A',
                    posStocksKeys: Object.keys(_vps),
                    userPos: CORE.state.currentUser?.pos,
                    userPosType: typeof CORE.state.currentUser?.pos,
                    destPosIdType: typeof _verifyDestPos
                });
                // Extra: check visibility through the full filter chain
                var _canSee = CORE.canAccess('product', _verifyProduct);
                var _belongsToPos = (typeof ManagerModule !== 'undefined' && ManagerModule.productBelongsToPos) 
                    ? ManagerModule.productBelongsToPos(_verifyProduct, CORE.state.currentUser?.pos || CORE.state.currentUser?.storeId) 
                    : 'ManagerModule unavailable';
                console.log('[TRANSFER-RECEPTION] Visibility check:', { canAccess: _canSee, productBelongsToPos: _belongsToPos });
                if (!_canSee || _belongsToPos === false) {
                    console.error('[TRANSFER-RECEPTION] ❌ Product is NOT VISIBLE! canAccess=' + _canSee + ', belongsToPos=' + _belongsToPos);
                    // Emergency fix: force posStocks with string key to match user.pos
                    var _userPosStr = String(CORE.state.currentUser?.pos || CORE.state.currentUser?.storeId || '');
                    if (_userPosStr && !_vps[_userPosStr]) {
                        console.warn('[TRANSFER-RECEPTION] Applying emergency posStocks fix with string key "' + _userPosStr + '"');
                        _verifyProduct.posStocks[_userPosStr] = { 
                            stock: newDestStock, 
                            price: _verifyProduct.price || 0, 
                            lastUpdated: new Date().toISOString(),
                            lastTransfer: new Date().toISOString()
                        };
                        _verifyProduct.updatedAt = new Date().toISOString();
                        CORE._productIndex = null;
                        CORE.save(true);
                    }
                }
            }

            // SYNC FIX: Force immediate cloud push (500ms) so the source POS sees the confirmation quickly
            clearTimeout(CORE._cloudPushTimer);
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() && navigator.onLine) {
                CORE._cloudPushTimer = setTimeout(() => CORE._doCloudPush(0), 500);
            }

            this.invalidateCache();
            UI.closeModal();
            UI.toast('✅ Réception confirmée! ' + qty + ' ' + product.name + ' ajoutés au stock', 'success');

            // Rafraîchir l'interface
            App.rerender();

            // Rouvrir le modal des transferts après un délai
            setTimeout(() => this.showPendingTransfersModal(), 500);
        },

        showRejectTransferModal(transferId) {
            // FIX: Search BOTH stockTransfers and transferReceipts
            let transfer = (CORE.db.stockTransfers || []).find(t => t.id == transferId);
            if (!transfer) {
                transfer = (CORE.db.transferReceipts || []).find(t => t.id == transferId);
                if (transfer) {
                    transfer = { ...transfer, sourcePosId: transfer.fromPosId, sourcePosName: transfer.fromPosName || 'Dépôt principal', destPosId: transfer.toPosId, destPosName: transfer.toPosName, qty: transfer.quantity || transfer.qty, _source: 'transferReceipts' };
                }
            }
            if (!transfer) return UI.toast('Transfert introuvable', 'error');

            const html = `
                <div class="space-y-5">
                    <div class="p-4 bg-gradient-to-r from-red-500 to-rose-500 rounded-2xl text-white">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <i data-lucide="x-circle" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <div class="font-black text-lg">Rejeter le transfert</div>
                                <div class="text-sm opacity-90">Le stock sera retourné au POS source</div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <div class="font-black text-slate-900">${transfer.productName}</div>
                        <div class="text-lg font-bold text-red-600">${transfer.qty} unités de ${transfer.sourcePosName}</div>
                    </div>

                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">📝 Motif du rejet *</label>
                        <textarea id="rejection_reason" rows="3" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium" placeholder="Ex: Colis endommagé, quantité incorrecte, produit non conforme..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">📸 Photos du problème (optionnel)</label>
                        <div class="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center hover:border-red-400 transition cursor-pointer" onclick="document.getElementById('rejection_media').click()">
                            <input type="file" id="rejection_media" multiple accept="image/*" class="hidden" onchange="GestionnaireModule.handleRejectionMediaUpload(event)">
                            <i data-lucide="camera" class="w-8 h-8 mx-auto mb-1 text-slate-400"></i>
                            <div class="text-sm font-bold text-slate-600">Ajouter des photos</div>
                        </div>
                        <div id="rejection_media_preview" class="grid grid-cols-4 gap-2 mt-2"></div>
                    </div>
                </div>
            `;

            this._rejectionMedia = [];

            UI.modal('❌ Rejeter le Transfert', html, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Confirmer le rejet', onclick: `GestionnaireModule.confirmTransferRejection('${transferId}')`, class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700' }
            ]);

            setTimeout(() => lucide.createIcons(), 50);
        },

        handleRejectionMediaUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('rejection_media_preview');
            if (!preview) return;

            this._rejectionMedia = this._rejectionMedia || [];

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this._rejectionMedia.push({ type: 'image', data: e.target.result, name: file.name });
                    const div = document.createElement('div');
                    div.className = 'rounded-lg overflow-hidden border border-slate-200';
                    div.innerHTML = `<img src="${e.target.result}" class="w-full h-16 object-cover">`;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        },

        confirmTransferRejection(transferId) {
            // FIX: Search BOTH stockTransfers and transferReceipts
            let transfer = (CORE.db.stockTransfers || []).find(t => t.id == transferId);
            let _transferSource = 'stockTransfers';
            if (!transfer) {
                transfer = (CORE.db.transferReceipts || []).find(t => t.id == transferId);
                _transferSource = 'transferReceipts';
                if (transfer) {
                    transfer.sourcePosId = transfer.fromPosId;
                    transfer.sourcePosName = transfer.fromPosName || 'Dépôt principal';
                    transfer.destPosId = transfer.toPosId;
                    transfer.destPosName = transfer.toPosName;
                    transfer.qty = transfer.quantity || transfer.qty;
                    transfer._source = _transferSource;
                }
            }
            if (!transfer) {
                console.error('Transfert introuvable:', transferId);
                return UI.toast('Transfert introuvable', 'error');
            }

            const reason = document.getElementById('rejection_reason')?.value?.trim();
            if (!reason) return UI.toast('Veuillez indiquer le motif du rejet', 'warning');

            const media = this._rejectionMedia || [];

            // S'assurer que les IDs sont cohérents
            const productId = transfer.productId;
            const sourcePosId = transfer.sourcePosId;
            const qty = Number(transfer.qty) || 0;

            // BUG FIX: Utiliser CORE.getProduct() au lieu de getVisibleProducts()
            // getVisibleProducts() filtre par POS courant, mais le produit appartient au POS source
            let product = CORE.getProduct ? CORE.getProduct(productId) : null;
            if (!product) product = (CORE.db.products || []).find(p => p.id == productId);
            if (!product) {
                console.error('Produit introuvable:', productId);
                return UI.toast('Produit introuvable', 'error');
            }

            // Mettre à jour le transfert
            transfer.status = 'rejected';
            transfer.rejectedBy = CORE.state.currentUser?.id;
            transfer.rejectedByName = CORE.state.currentUser?.name || 'Inconnu';
            transfer.rejectedAt = new Date().toISOString();
            transfer.rejectionReason = reason;
            transfer.rejectionMedia = media;

            // Retourner le stock au POS source (mise à jour directe posStocks)
            // Pour les transferts depuis le dépôt principal, restaurer product.stock
            if (sourcePosId === 'main_depot' || transfer.fromWarehouse || transfer._source === 'transferReceipts') {
                product.stock = (product.stock || 0) + qty;
            } else {
                const sourceStock = CORE.getProductStock ? (CORE.getProductStock(productId, sourcePosId) || 0) : 0;
                const newSourceStock = sourceStock + qty;

                if (!product.posStocks) product.posStocks = {};
                if (!product.posStocks[sourcePosId]) product.posStocks[sourcePosId] = { stock: 0, price: product.price || 0 };
                product.posStocks[sourcePosId].stock = Math.max(0, newSourceStock);
            }

            // BUG FIX: Décrémenter pendingIncoming au POS destinataire (incrémenté dans createTransferReceipt)
            const destPosIdForPending = transfer.destPosId || transfer.toPosId;
            if (destPosIdForPending && product.posStocks && product.posStocks[destPosIdForPending]?.pendingIncoming) {
                product.posStocks[destPosIdForPending].pendingIncoming = Math.max(0,
                    Number(product.posStocks[destPosIdForPending].pendingIncoming) - qty
                );
            }
            product.updatedAt = new Date().toISOString();
            CORE._productIndex = null;

            // Enregistrer le mouvement de retour
            CORE.db.stockMovements = CORE.db.stockMovements || [];
            CORE.db.stockMovements.push({
                id: 'MOV-' + CORE.uid(),
                productId: productId,
                productName: product.name,
                type: 'in',
                qty: qty,
                ref: transferId + '-RETURN',
                note: 'Retour transfert rejeté par ' + transfer.destPosName + ': ' + reason,
                posId: sourcePosId,
                createdBy: CORE.state.currentUser?.id,
                createdByName: CORE.state.currentUser?.name,
                createdAt: new Date().toISOString()
            });

            // Notification au POS source avec preuves
            CORE.db.notifications = CORE.db.notifications || [];
            CORE.db.notifications.push({
                id: 'NOTIF-' + CORE.uid(),
                type: 'transfer_rejected',
                title: '❌ Transfert rejeté',
                message: transfer.destPosName + ' a rejeté ' + qty + ' x ' + product.name,
                details: 'Motif: ' + reason,
                transferId: transferId,
                posId: sourcePosId,
                createdAt: new Date().toISOString(),
                read: false,
                hasMedia: media.length > 0,
                mediaCount: media.length,
                rejectedByName: CORE.state.currentUser?.name || 'Inconnu'
            });

            this._rejectionMedia = [];

            // Marquer la notification entrante comme lue
            (CORE.db.notifications || []).forEach(n => {
                if (n.transferId == transferId && n.type === 'transfer_incoming') {
                    n.read = true;
                    n.processedAt = new Date().toISOString();
                }
            });

            // Enregistrer dans le journal d'audit
            const destPosId = transfer.destPosId;
            CORE.db.auditLogs = CORE.db.auditLogs || [];
            CORE.db.auditLogs.push({
                id: 'AUDIT-' + CORE.uid(),
                timestamp: new Date().toISOString(),
                userId: CORE.state.currentUser?.id,
                userName: CORE.state.currentUser?.name || 'Système',
                userRole: CORE.state.currentUser?.role || 'gestionnaire',
                posId: destPosId,
                action: 'transfer_reject',
                entity: 'stock',
                entityId: transferId,
                entityName: product.name,
                details: 'Rejet de ' + qty + ' unités depuis ' + transfer.sourcePosName + ' - Motif: ' + reason,
                status: 'recorded'
            });

            CORE.markDirty('stockTransfers');
            CORE.markDirty('transferReceipts');
            CORE.markDirty('products');
            CORE.markDirty('stockMovements');
            CORE.markDirty('notifications');
            CORE.save(true);

            // SYNC FIX: Force immediate cloud push so source POS sees rejection quickly
            clearTimeout(CORE._cloudPushTimer);
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() && navigator.onLine) {
                CORE._cloudPushTimer = setTimeout(() => CORE._doCloudPush(0), 500);
            }

            this.invalidateCache();
            UI.closeModal();
            UI.toast('❌ Transfert rejeté. Stock retourné à ' + transfer.sourcePosName, 'info');

            setTimeout(() => this.showPendingTransfersModal(), 300);
        },

        showTransferHistoryModal() {
            const history = this.getTransferHistory().slice(0, 20);
            const currentPosId = CORE.state.currentUser?.pos;

            const html = `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    ${history.length === 0 ? `
                        <div class="text-center py-12 text-slate-400">
                            <i data-lucide="archive" class="w-16 h-16 mx-auto mb-3 opacity-50"></i>
                            <div class="font-bold">Aucun historique de transfert</div>
                        </div>
                    ` : history.map(t => {
                        const isIncoming = t.destPosId == currentPosId;
                        const statusColors = {
                            accepted: 'bg-emerald-100 text-emerald-700 border-emerald-200',
                            rejected: 'bg-red-100 text-red-700 border-red-200'
                        };
                        const statusLabels = {
                            accepted: '✅ Réceptionné',
                            rejected: '❌ Rejeté'
                        };
                        return `
                            <div class="p-4 rounded-xl border ${statusColors[t.status] || 'border-slate-200 bg-slate-50'}">
                                <div class="flex items-start justify-between gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="${isIncoming ? 'text-emerald-600' : 'text-blue-600'}">${isIncoming ? '📥' : '📤'}</span>
                                            <span class="font-black text-slate-900">${t.productName}</span>
                                            <span class="px-2 py-0.5 text-xs font-bold rounded-full ${statusColors[t.status]}">${statusLabels[t.status]}</span>
                                        </div>
                                        <div class="text-lg font-bold text-slate-700">${t.qty} unités</div>
                                        <div class="text-sm text-slate-600">
                                            ${isIncoming ? 'De ' + t.sourcePosName : 'Vers ' + t.destPosName}
                                            • ${new Date(t.createdAt).toLocaleDateString('fr-FR')}
                                        </div>
                                        ${t.status === 'accepted' && t.receivedByName ? `
                                            <div class="text-xs text-emerald-600 mt-1">Reçu par ${t.receivedByName} le ${new Date(t.receivedAt).toLocaleString('fr-FR')}</div>
                                        ` : ''}
                                        ${t.status === 'rejected' && t.rejectionReason ? `
                                            <div class="text-xs text-red-600 mt-1">Motif: ${t.rejectionReason}</div>
                                        ` : ''}
                                    </div>
                                    ${(t.receptionMedia?.length > 0 || t.rejectionMedia?.length > 0) ? `
                                        <button onclick="GestionnaireModule.showTransferMedia('${t.id}')" class="px-3 py-1.5 bg-slate-200 text-slate-700 rounded-lg text-xs font-bold hover:bg-slate-300 flex items-center gap-1">
                                            <i data-lucide="image" class="w-3 h-3"></i> Preuves
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            UI.modal('📋 Historique des Transferts', html, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            setTimeout(() => {
                const modalEl = document.querySelector('#modalContainer .slide-up');
                if (modalEl) {
                    modalEl.classList.remove('max-w-lg');
                    modalEl.classList.add('max-w-2xl');
                }
                lucide.createIcons();
            }, 50);
        },

        showTransferMedia(transferId) {
            const transfer = (CORE.db.stockTransfers || []).find(t => t.id === transferId);
            if (!transfer) return;

            const media = [...(transfer.receptionMedia || []), ...(transfer.rejectionMedia || [])];

            if (media.length === 0) {
                return UI.toast('Aucune preuve disponible', 'info');
            }

            const html = `
                <div class="space-y-4">
                    <div class="text-sm text-slate-600 text-center">${media.length} fichier(s) de preuve</div>
                    <div class="grid grid-cols-2 gap-4">
                        ${media.map(m => `
                            <div class="rounded-xl overflow-hidden border border-slate-200">
                                ${m.type === 'video' ? `
                                    <video src="${m.data}" controls class="w-full"></video>
                                ` : `
                                    <img src="${m.data}" class="w-full cursor-pointer hover:opacity-90" onclick="window.open('${m.data}', '_blank')">
                                `}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            UI.modal('📸 Preuves de ' + (transfer.status === 'accepted' ? 'Réception' : 'Rejet'), html, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showSendMedia(transferId) {
            const transfer = (CORE.db.stockTransfers || []).find(t => t.id === transferId);
            if (!transfer) return;

            const media = transfer.sendMedia || [];

            if (media.length === 0) {
                return UI.toast('Aucune photo/vidéo d\'envoi disponible', 'info');
            }

            const html = `
                <div class="space-y-4">
                    <div class="p-4 bg-purple-50 border border-purple-200 rounded-xl">
                        <div class="font-bold text-purple-800">📦 ${transfer.productName}</div>
                        <div class="text-sm text-purple-600">${transfer.qty} unités envoyées par ${transfer.sourcePosName}</div>
                        ${transfer.estimatedArrival ? `<div class="text-sm text-purple-600 mt-1">🚚 Arrivée estimée: ${new Date(transfer.estimatedArrival).toLocaleString('fr-FR')}</div>` : ''}
                    </div>
                    <div class="text-sm text-slate-600 text-center">${media.length} fichier(s) joints à l'envoi</div>
                    <div class="grid grid-cols-2 gap-4 max-h-[50vh] overflow-y-auto">
                        ${media.map(m => `
                            <div class="rounded-xl overflow-hidden border border-slate-200">
                                ${m.type === 'video' ? `
                                    <video src="${m.data}" controls class="w-full"></video>
                                ` : `
                                    <img src="${m.data}" class="w-full cursor-pointer hover:opacity-90" onclick="window.open('${m.data}', '_blank')">
                                `}
                                <div class="p-2 text-xs text-slate-500 truncate">${m.name || 'Fichier'}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            UI.modal('📸 Photos/Vidéos du stock envoyé', html, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        // Compteur pour badge notification
        getPendingTransfersCount() {
            return this.getPendingIncomingTransfers().length;
        },

        // Notifications de transferts (entrantes + réceptions confirmées/rejetées)
        getTransferNotifications() {
            const currentPosId = CORE.state.currentUser?.pos || CORE.state.currentUser?.storeId;
            return (CORE.db.notifications || []).filter(n =>
                (String(n.posId) === String(currentPosId)) &&
                (n.type === 'transfer_incoming' || n.type === 'transfer_received' || n.type === 'transfer_rejected') &&
                !n.read
            ).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        },

        getTransferNotificationsCount() {
            return this.getTransferNotifications().length;
        },

        showTransferNotificationsModal() {
            const notifications = this.getTransferNotifications();
            const _nPosId = CORE.state.currentUser?.pos || CORE.state.currentUser?.storeId;
            const allNotifications = (CORE.db.notifications || []).filter(n =>
                (String(n.posId) === String(_nPosId)) &&
                (n.type === 'transfer_incoming' || n.type === 'transfer_received' || n.type === 'transfer_rejected')
            ).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 20);

            const html = `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    ${notifications.length > 0 ? `
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-xl text-sm">
                            <span class="font-bold text-blue-700">${notifications.length} nouvelle(s) notification(s)</span>
                        </div>
                    ` : ''}

                    ${allNotifications.length === 0 ? `
                        <div class="text-center py-12 text-slate-400">
                            <i data-lucide="bell-off" class="w-16 h-16 mx-auto mb-3 opacity-50"></i>
                            <div class="font-bold">Aucune notification de transfert</div>
                        </div>
                    ` : allNotifications.map(n => {
                        const isReceived = n.type === 'transfer_received';
                        const isIncoming = n.type === 'transfer_incoming';
                        const transfer = (CORE.db.stockTransfers || []).find(t => t.id === n.transferId);
                        const borderClass = isIncoming ? 'border-amber-300 bg-amber-50' : (isReceived ? '' : 'border-red-200 bg-red-50');
                        const icon = isIncoming ? '📦' : (isReceived ? '✅' : '❌');
                        return `
                            <div class="p-4 rounded-xl border ${!n.read ? 'border-blue-300 bg-blue-50' : 'border-slate-200 bg-white'} ${borderClass}">
                                <div class="flex items-start justify-between gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-xl">${icon}</span>
                                            <span class="font-black text-slate-900">${n.title}</span>
                                            ${!n.read ? '<span class="px-2 py-0.5 bg-blue-500 text-white text-[10px] font-black rounded-full">NOUVEAU</span>' : ''}
                                        </div>
                                        <div class="text-sm text-slate-700 mb-2">${n.message}</div>
                                        ${n.details ? `<div class="text-xs text-slate-500 italic">${n.details}</div>` : ''}
                                        <div class="text-xs text-slate-400 mt-2">
                                            ${new Date(n.createdAt).toLocaleString('fr-FR')}
                                            ${n.receivedByName ? ' • Par ' + n.receivedByName : ''}
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        ${isIncoming && transfer && transfer.status === 'pending' ? `
                                            <button onclick="UI.closeModal();GestionnaireModule.showPendingTransfersModal()" class="px-3 py-2 bg-amber-600 text-white rounded-xl text-xs font-bold hover:bg-amber-700 flex items-center gap-1">
                                                📦 Voir transfert
                                            </button>
                                        ` : ''}
                                        ${transfer && (transfer.receptionMedia?.length > 0 || transfer.rejectionMedia?.length > 0) ? `
                                            <button onclick="GestionnaireModule.showTransferMedia('${n.transferId}')" class="px-3 py-2 bg-slate-800 text-white rounded-xl text-xs font-bold hover:bg-slate-900 flex items-center gap-1">
                                                <i data-lucide="image" class="w-4 h-4"></i>
                                                Voir preuves (${(transfer.receptionMedia?.length || 0) + (transfer.rejectionMedia?.length || 0)})
                                            </button>
                                        ` : ''}
                                        ${!n.read ? `
                                            <button onclick="GestionnaireModule.markNotificationRead('${n.id}')" class="px-3 py-2 bg-slate-200 text-slate-700 rounded-xl text-xs font-bold hover:bg-slate-300">
                                                Marquer lu
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}

                    ${notifications.length > 0 ? `
                        <button onclick="GestionnaireModule.markAllTransferNotificationsRead()" class="w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-xl transition">
                            Tout marquer comme lu
                        </button>
                    ` : ''}
                </div>
            `;

            UI.modal('🔔 Notifications de Transferts', html, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            setTimeout(() => {
                const modalEl = document.querySelector('#modalContainer .slide-up');
                if (modalEl) {
                    modalEl.classList.remove('max-w-lg');
                    modalEl.classList.add('max-w-2xl');
                }
                lucide.createIcons();
            }, 50);
        },

        markNotificationRead(notifId) {
            const notif = (CORE.db.notifications || []).find(n => n.id === notifId);
            if (notif) {
                notif.read = true;
                notif.readAt = new Date().toISOString();
                notif.updatedAt = new Date().toISOString();
                CORE.markDirty('notifications');
                CORE.save(true);
                this.showTransferNotificationsModal();
            }
        },

        markAllTransferNotificationsRead() {
            const currentPosId = CORE.state.currentUser?.pos;
            let changed = false;
            (CORE.db.notifications || []).forEach(n => {
                if (n.posId == currentPosId && (n.type === 'transfer_incoming' || n.type === 'transfer_received' || n.type === 'transfer_rejected') && !n.read) {
                    n.read = true;
                    n.readAt = new Date().toISOString();
                    n.updatedAt = new Date().toISOString();
                    changed = true;
                }
            });
            if (changed) CORE.markDirty('notifications');
            CORE.save(true);
            UI.closeModal();
            UI.toast('Toutes les notifications marquées comme lues', 'success');
            App.rerender();
        },

        showStockAnalysis() {
            const products = this.getProductsOptimized();
            const totalProducts = products.length;
            const totalStock = products.reduce((s, p) => s + (p.stock || 0), 0);
            const totalValue = products.reduce((s, p) => s + (p.stock || 0) * (p.price || 0), 0);
            const lowStock = products.filter(p => (p.stock || 0) <= (p.minStock || 0)).length;
            const outOfStock = products.filter(p => (p.stock || 0) === 0).length;

            // Top 5 produits par valeur
            const topByValue = [...products].sort((a, b) => ((b.stock || 0) * (b.price || 0)) - ((a.stock || 0) * (a.price || 0))).slice(0, 5);

            UI.modal('📊 Analyse du Stock', `
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="p-4 bg-blue-50 rounded-xl text-center">
                            <div class="text-3xl font-black text-blue-600">${totalProducts}</div>
                            <div class="text-xs font-bold text-blue-500">Produits</div>
                        </div>
                        <div class="p-4 bg-emerald-50 rounded-xl text-center">
                            <div class="text-3xl font-black text-emerald-600">${totalStock}</div>
                            <div class="text-xs font-bold text-emerald-500">Unités</div>
                        </div>
                        <div class="p-4 bg-violet-50 rounded-xl text-center">
                            <div class="text-2xl font-black text-violet-600">${(totalValue/1000).toFixed(1)}k</div>
                            <div class="text-xs font-bold text-violet-500">Valeur</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-amber-50 border border-amber-200 rounded-xl">
                            <div class="flex items-center gap-2">
                                <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600"></i>
                                <div>
                                    <div class="text-xl font-black text-amber-600">${lowStock}</div>
                                    <div class="text-xs text-amber-500">Stock faible</div>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 bg-red-50 border border-red-200 rounded-xl">
                            <div class="flex items-center gap-2">
                                <i data-lucide="x-circle" class="w-5 h-5 text-red-600"></i>
                                <div>
                                    <div class="text-xl font-black text-red-600">${outOfStock}</div>
                                    <div class="text-xs text-red-500">Rupture</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 rounded-xl">
                        <div class="font-black text-slate-800 mb-3">🏆 Top 5 par valeur stock</div>
                        <div class="space-y-2">
                            ${topByValue.map((p, i) => `
                                <div class="flex items-center gap-3">
                                    <div class="w-6 h-6 bg-gradient-to-r ${i === 0 ? 'from-amber-400 to-amber-500' : i === 1 ? 'from-slate-300 to-slate-400' : i === 2 ? 'from-orange-300 to-orange-400' : 'from-slate-200 to-slate-300'} rounded-full flex items-center justify-center text-xs font-black text-white">${i + 1}</div>
                                    <div class="flex-1 text-sm font-bold text-slate-700">${p.name}</div>
                                    <div class="text-sm font-black text-slate-900">${((p.stock || 0) * (p.price || 0)).toLocaleString()} F</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            setTimeout(() => lucide.createIcons(), 50);
        },

        showStockRecommendations() {
            const products = this.getProductsOptimized();
            const recommendations = [];

            // Produits en rupture
            const outOfStock = products.filter(p => (p.stock || 0) === 0);
            if (outOfStock.length > 0) {
                recommendations.push({
                    type: 'danger',
                    icon: 'x-circle',
                    title: outOfStock.length + ' produit(s) en rupture',
                    desc: 'Commander immédiatement: ' + outOfStock.slice(0, 3).map(p => p.name).join(', ') + (outOfStock.length > 3 ? '...' : ''),
                    action: 'GestionnaireModule.showBulkReorderModal()'
                });
            }

            // Stock faible
            const lowStock = products.filter(p => (p.stock || 0) > 0 && (p.stock || 0) <= (p.minStock || 0));
            if (lowStock.length > 0) {
                recommendations.push({
                    type: 'warning',
                    icon: 'alert-triangle',
                    title: lowStock.length + ' produit(s) stock faible',
                    desc: 'Anticiper la commande: ' + lowStock.slice(0, 3).map(p => p.name).join(', '),
                    action: 'GestionnaireModule.showBulkReorderModal()'
                });
            }

            // Surstock
            const overStock = products.filter(p => (p.stock || 0) > (p.minStock || 5) * 5);
            if (overStock.length > 0) {
                recommendations.push({
                    type: 'info',
                    icon: 'package',
                    title: overStock.length + ' produit(s) en surstock',
                    desc: 'Envisager une promotion ou un transfert',
                    action: null
                });
            }

            if (recommendations.length === 0) {
                recommendations.push({
                    type: 'success',
                    icon: 'check-circle',
                    title: 'Stock optimal!',
                    desc: 'Aucune action requise pour le moment',
                    action: null
                });
            }

            const colors = { danger: 'red', warning: 'amber', info: 'blue', success: 'emerald' };

            UI.modal('💡 Recommandations Stock', `
                <div class="space-y-4">
                    ${recommendations.map(r => `
                        <div class="p-4 bg-${colors[r.type]}-50 border border-${colors[r.type]}-200 rounded-xl">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 bg-${colors[r.type]}-500 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="${r.icon}" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="font-black text-${colors[r.type]}-800">${r.title}</div>
                                    <div class="text-sm text-${colors[r.type]}-600">${r.desc}</div>
                                    ${r.action ? `<button onclick="${r.action}" class="mt-2 px-4 py-2 bg-${colors[r.type]}-600 text-white text-sm font-bold rounded-lg hover:bg-${colors[r.type]}-700">Agir maintenant</button>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            setTimeout(() => lucide.createIcons(), 50);
        },

        showStockHistory() {
            const userPos = CORE.state.currentUser?.pos;
            const movements = CORE.getVisibleStockMovements().filter(m => String(m.posId) === String(userPos));
            const recent = movements.sort((a, b) => new Date(b.createdAt || b.timestamp || b.date || 0) - new Date(a.createdAt || a.timestamp || a.date || 0)).slice(0, 30);
            const products = CORE.getVisibleProducts() || [];

            // Map type codes to human-readable labels
            const typeLabels = { 'in': 'Entrée', 'out': 'Sortie', 'adjust': 'Ajustement', 'transfer': 'Transfert', 'main_depot_transfer': 'Transfert dépôt' };

            UI.modal('📜 Historique des Mouvements', `
                <div class="space-y-4">
                    <div class="p-3 bg-slate-50 rounded-xl">
                        <div class="text-sm font-bold text-slate-600">30 derniers mouvements</div>
                    </div>

                    ${recent.length === 0 ? `
                        <div class="text-center py-8 text-slate-400">
                            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2"></i>
                            <div>Aucun mouvement enregistré</div>
                        </div>
                    ` : `
                        <div class="space-y-2 max-h-[60vh] overflow-y-auto">
                            ${recent.map(m => {
                                const product = products.find(p => p.id === m.productId);
                                const isIn = m.type === 'in' || (m.type === 'transfer' && m.direction === 'in') || (m.type === 'main_depot_transfer');
                                const isOut = m.type === 'out' || (m.type === 'transfer' && m.direction === 'out');
                                const mQty = m.qty ?? m.quantity ?? 0;
                                const mNote = m.note || m.notes || m.reason || '';
                                const mDate = m.createdAt || m.timestamp || m.date;
                                const dateStr = mDate ? new Date(mDate).toLocaleDateString('fr-FR') : '—';
                                const typeLabel = typeLabels[m.type] || m.type || 'Mouvement';
                                const noteDisplay = mNote ? mNote : typeLabel;
                                return `
                                <div class="flex items-center gap-3 p-3 bg-white border border-slate-200 rounded-xl">
                                    <div class="w-8 h-8 ${isIn ? 'bg-emerald-100' : isOut ? 'bg-red-100' : 'bg-blue-100'} rounded-lg flex items-center justify-center">
                                        <i data-lucide="${isIn ? 'arrow-down' : isOut ? 'arrow-up' : 'repeat'}" class="w-4 h-4 ${isIn ? 'text-emerald-600' : isOut ? 'text-red-600' : 'text-blue-600'}"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-bold text-slate-900">${product?.name || m.productName || 'Produit #' + m.productId}</div>
                                        <div class="text-xs text-slate-500">${noteDisplay} • ${dateStr}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-black ${isIn ? 'text-emerald-600' : isOut ? 'text-red-600' : 'text-blue-600'}">${isIn ? '+' : isOut ? '-' : '±'}${mQty}</div>
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            setTimeout(() => lucide.createIcons(), 50);
        },

        showStockIndicators() {
            const products = this.getProductsOptimized();
            const categories = CORE.db.categories || [];

            // Stats par catégorie
            const catStats = categories.map(cat => {
                const catProducts = products.filter(p => p.categoryId === cat.id);
                return {
                    name: cat.name,
                    count: catProducts.length,
                    stock: catProducts.reduce((s, p) => s + (p.stock || 0), 0),
                    value: catProducts.reduce((s, p) => s + (p.stock || 0) * (p.price || 0), 0)
                };
            }).filter(c => c.count > 0);

            const totalValue = products.reduce((s, p) => s + (p.stock || 0) * (p.price || 0), 0);
            const avgPrice = products.length > 0 ? products.reduce((s, p) => s + (p.price || 0), 0) / products.length : 0;
            const rotationRate = 85; // Taux fictif

            UI.modal('📈 Indicateurs Stock', `
                <div class="space-y-4">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="p-4 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl text-center text-white">
                            <div class="text-3xl font-black">${(totalValue/1000000).toFixed(2)}M</div>
                            <div class="text-xs opacity-90">Valeur totale</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl text-center text-white">
                            <div class="text-3xl font-black">${avgPrice.toFixed(0)}</div>
                            <div class="text-xs opacity-90">Prix moyen</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-violet-500 to-violet-600 rounded-xl text-center text-white">
                            <div class="text-3xl font-black">${rotationRate}%</div>
                            <div class="text-xs opacity-90">Rotation</div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 rounded-xl">
                        <div class="font-black text-slate-800 mb-3">Stock par catégorie</div>
                        <div class="space-y-3">
                            ${catStats.length === 0 ? '<div class="text-center text-slate-400 py-4">Aucune catégorie</div>' : catStats.map(cat => `
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="font-bold text-slate-700">${cat.name}</span>
                                        <span class="font-black text-slate-900">${cat.stock} unités</span>
                                    </div>
                                    <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-blue-500 to-emerald-500 rounded-full" style="width: ${Math.min(100, (cat.value / totalValue) * 100)}%"></div>
                                    </div>
                                    <div class="text-xs text-slate-500 text-right">${cat.value.toLocaleString()} F</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
            setTimeout(() => lucide.createIcons(), 50);
        },

        showAddStockModal() {
            const products = this.getProductsOptimized();

            UI.modal('📥 Nouvelle Entrée Stock', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Produit</label>
                        <select id="add_stock_product" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold">
                            <option value="">Sélectionner un produit</option>
                            ${products.map(p => `<option value="${p.id}">${p.name} (Stock: ${p.stock || 0})</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Quantité</label>
                        <input type="number" id="add_stock_qty" min="1" value="1" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-bold text-center text-xl">
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-2">Note/Référence</label>
                        <input type="text" id="add_stock_note" placeholder="Ex: Livraison #456" class="w-full px-4 py-3 border border-slate-200 rounded-xl">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Ajouter', onclick: 'GestionnaireModule.applyAddStock()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        applyAddStock() {
            const productId = parseInt(document.getElementById('add_stock_product')?.value);
            const qty = parseInt(document.getElementById('add_stock_qty')?.value) || 0;
            const note = document.getElementById('add_stock_note')?.value || '';

            if (!productId) return UI.toast('Sélectionnez un produit', 'error');
            if (qty <= 0) return UI.toast('Quantité invalide', 'error');

            const pReal = CORE.getProduct(productId);
            if (!pReal) return UI.toast('Produit introuvable', 'error');

            const posId = CORE.state.currentUser?.pos;
            const currentStock = posId ? (CORE.getProductStock(pReal.id, posId) || pReal.stock || 0) : (pReal.stock || 0);
            const newStock = currentStock + qty;

            // Mettre à jour stock global ET posStocks
            const updates = { stock: newStock };
            if (posId && pReal.posStocks) {
                const newPosStocks = JSON.parse(JSON.stringify(pReal.posStocks));
                if (!newPosStocks[posId]) newPosStocks[posId] = { stock: 0, price: pReal.price || 0 };
                newPosStocks[posId].stock = Math.max(0, newStock);
                updates.posStocks = newPosStocks;
            }
            CORE.update('products', productId, updates);
            CORE.recordStockMovement({
                productId,
                type: 'in',
                qty,
                note,
                posId: posId,
                userName: CORE.state.currentUser?.name
            });

            this.invalidateCache(['products', 'stocks']);
            UI.closeModal();
            UI.toast(`+${qty} unité(s) ajoutée(s) à ${pReal.name}`, 'success');
            App.rerender();
        },

        // Fonction pour afficher les détails d'une livraison avec preuves (Gestionnaire)
        showDeliveryDetail(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return UI.toast('Livraison introuvable', 'error');
            const livreur = d.livreurId ? CORE.getUser(d.livreurId) : null;
            const badge = d.status === 'livree' ? UI.badge('Livrée','emerald') :
                          d.status === 'probleme' ? UI.badge('Problème','red') :
                          d.status === 'en_attente' ? UI.badge('À assigner','blue') :
                          d.status === 'annulee' ? UI.badge('Annulée','slate') : UI.badge('En cours','amber');

            const hasProofPhotos = d.proofPhotos && d.proofPhotos.length > 0;
            const hasProofSignature = !!d.proofSignature;
            const hasProof = hasProofPhotos || hasProofSignature;

            UI.modal(`📦 Livraison ${d.orderRef}`, `
                <div class="space-y-4 max-h-[75vh] overflow-y-auto">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Statut</div>
                            <div class="mt-1">${badge}</div>
                        </div>
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-right">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Montant</div>
                            <div class="mt-1 text-2xl font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Client</div>
                        <div class="mt-1 font-black text-slate-900">${d.clientName || '—'}</div>
                        <div class="text-xs text-slate-600">${d.clientPhone || ''}</div>
                        <div class="mt-2 text-xs text-slate-600"><b>Adresse:</b> ${d.address || '—'}</div>
                        ${d.deliveryTime ? `<div class="mt-1 text-xs text-slate-600"><b>Heure:</b> ${d.deliveryTime}</div>` : ''}
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Livreur</div>
                        <div class="mt-1 font-black">${livreur?.name || 'Non assigné'}</div>
                        <div class="text-xs text-slate-600">${livreur?.phone || ''}</div>
                    </div>

                    ${hasProof ? `
                    <!-- PREUVES DE LIVRAISON -->
                    <div class="p-4 bg-gradient-to-r from-emerald-50 to-teal-50 border-2 border-emerald-300 rounded-2xl">
                        <div class="text-xs font-black text-emerald-700 uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i data-lucide="camera" class="w-4 h-4"></i>
                            📷 Preuves de livraison
                        </div>

                        ${hasProofPhotos ? `
                        <div class="mb-3">
                            <div class="text-xs font-bold text-emerald-600 mb-2">Photos (${d.proofPhotos.length})</div>
                            <div class="grid grid-cols-3 gap-2">
                                ${d.proofPhotos.map((photo, idx) => `
                                    <div class="aspect-square rounded-xl overflow-hidden border-2 border-emerald-300 cursor-pointer hover:border-emerald-500 transition shadow-md" onclick="window.open('${photo.replace(/'/g, "\\'")}', '_blank')">
                                        <img src="${photo}" class="w-full h-full object-cover hover:scale-105 transition" alt="Preuve ${idx + 1}">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${hasProofSignature ? `
                        <div>
                            <div class="text-xs font-bold text-emerald-600 mb-2">✍️ Signature client</div>
                            <div class="p-3 bg-white rounded-xl border-2 border-blue-200 cursor-pointer hover:border-blue-400 transition" onclick="window.open('${d.proofSignature.replace(/'/g, "\\'")}', '_blank')">
                                <img src="${d.proofSignature}" class="w-full max-h-24 object-contain" alt="Signature">
                            </div>
                        </div>
                        ` : ''}

                        ${d.proofNote ? `
                        <div class="mt-3 p-3 bg-white rounded-xl border border-emerald-200">
                            <div class="text-xs font-bold text-slate-500 mb-1">Note du livreur</div>
                            <div class="text-sm text-slate-700">${d.proofNote}</div>
                        </div>
                        ` : ''}

                        <div class="text-center text-xs text-emerald-600 mt-3">
                            Validée le ${d.proofTimestamp ? new Date(d.proofTimestamp).toLocaleString('fr-FR') : (d.deliveredAt ? new Date(d.deliveredAt).toLocaleString('fr-FR') : '—')}
                        </div>
                    </div>
                    ` : (d.status === 'livree' ? `
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-center">
                        <div class="text-slate-400 text-sm">📷 Aucune preuve de livraison disponible</div>
                    </div>
                    ` : '')}

                    ${d.recallReason ? `<div class="p-4 bg-amber-50 border border-amber-100 rounded-2xl text-xs text-amber-800"><b>Rappel:</b> ${d.recallReason}</div>` : ''}
                    ${d.recalledAt ? `<div class="text-xs text-slate-500">Rappelée: ${CORE.formatDate(d.recalledAt)}</div>` : ''}
                    <div class="text-xs text-slate-500">Créée: ${CORE.formatDate(d.createdAt)}</div>
                    ${d.deliveredAt ? `<div class="text-xs text-emerald-600">Livrée: ${CORE.formatDate(d.deliveredAt)}</div>` : ''}
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        renderDeliveries() {
            const user = CORE.state.currentUser;
            const posId = user?.pos;
            const statusFilter = this.state.deliveryStatus || 'all';
            const searchQuery = (this.state.deliverySearch || '').toLowerCase().trim();

            // Visibilité basée sur les règles d'accès
            let allDeliveries = CORE.getVisibleDeliveries() || [];
            if (user?.role !== 'pdg' && user?.role !== 'manager' && posId) {
                allDeliveries = allDeliveries.filter(d => d.posId == posId);
            }

            let all = allDeliveries;

            // Filtrer par statut
            if (statusFilter !== 'all') {
                all = all.filter(d => d.status === statusFilter);
            }

            // Filtrer par recherche
            if (searchQuery) {
                all = all.filter(d =>
                    (d.orderRef || '').toLowerCase().includes(searchQuery) ||
                    (d.clientName || '').toLowerCase().includes(searchQuery) ||
                    (d.address || '').toLowerCase().includes(searchQuery) ||
                    (CORE.getUser(d.livreurId)?.name || '').toLowerCase().includes(searchQuery)
                );
            }

            all = all.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 50);

            const stats = {
                total: allDeliveries.length,
                livree: allDeliveries.filter(d => d.status === 'livree').length,
                en_cours: allDeliveries.filter(d => d.status === 'en_cours').length,
                en_attente: allDeliveries.filter(d => d.status === 'en_attente').length,
                probleme: allDeliveries.filter(d => d.status === 'probleme').length
            };

            return `
                <div class="fade-in space-y-6">
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">📦 Historique des livraisons</h2>
                            <p class="text-slate-500 font-medium">Suivi complet avec preuves de livraison</p>
                        </div>
                    </div>

                    <!-- Stats rapides -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                        <div class="p-4 bg-slate-100 rounded-2xl text-center">
                            <div class="text-2xl font-black text-slate-900">${stats.total}</div>
                            <div class="text-xs text-slate-600 font-bold">Total</div>
                        </div>
                        <div class="p-4 bg-emerald-100 rounded-2xl text-center">
                            <div class="text-2xl font-black text-emerald-700">${stats.livree}</div>
                            <div class="text-xs text-emerald-600 font-bold">Livrées</div>
                        </div>
                        <div class="p-4 bg-amber-100 rounded-2xl text-center">
                            <div class="text-2xl font-black text-amber-700">${stats.en_cours}</div>
                            <div class="text-xs text-amber-600 font-bold">En cours</div>
                        </div>
                        <div class="p-4 bg-blue-100 rounded-2xl text-center">
                            <div class="text-2xl font-black text-blue-700">${stats.en_attente}</div>
                            <div class="text-xs text-blue-600 font-bold">À assigner</div>
                        </div>
                        <div class="p-4 bg-red-100 rounded-2xl text-center">
                            <div class="text-2xl font-black text-red-700">${stats.probleme}</div>
                            <div class="text-xs text-red-600 font-bold">Problèmes</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex flex-col md:flex-row md:items-center gap-3 justify-between">
                            <div class="font-black text-slate-900">${all.length} résultat(s)</div>
                            <div class="flex gap-3 flex-wrap">
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input type="text" value="${this.state.deliverySearch || ''}"
                                        onkeyup="GestionnaireModule.state.deliverySearch=this.value;App.rerender()"
                                        placeholder="Rechercher..."
                                        class="pl-10 pr-4 py-2 rounded-xl border border-slate-200 bg-white font-medium w-48">
                                </div>
                                <select onchange="GestionnaireModule.state.deliveryStatus=this.value;App.rerender()"
                                    class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                                    <option value="all" ${statusFilter === 'all' ? 'selected' : ''}>Tous statuts</option>
                                    <option value="livree" ${statusFilter === 'livree' ? 'selected' : ''}>Livrées</option>
                                    <option value="en_cours" ${statusFilter === 'en_cours' ? 'selected' : ''}>En cours</option>
                                    <option value="en_attente" ${statusFilter === 'en_attente' ? 'selected' : ''}>À assigner</option>
                                    <option value="probleme" ${statusFilter === 'probleme' ? 'selected' : ''}>Problèmes</option>
                                    <option value="annulee" ${statusFilter === 'annulee' ? 'selected' : ''}>Annulées</option>
                                </select>
                            </div>
                        </div>
                        <div class="divide-y divide-slate-50">
                            ${all.length === 0 ? `<div class="p-10 text-center text-slate-400 font-medium">Aucune livraison trouvée</div>` : ''}
                            ${all.map(d => {
                                const hasProof = (d.proofPhotos && d.proofPhotos.length > 0) || d.proofSignature;
                                const badge = d.status === 'livree' ? UI.badge('Livrée','emerald') :
                                              d.status === 'en_cours' ? UI.badge('En cours','amber') :
                                              d.status === 'en_attente' ? UI.badge('À assigner','blue') :
                                              d.status === 'probleme' ? UI.badge('Problème','red') : UI.badge('Annulée','slate');
                                return `
                                <button onclick="GestionnaireModule.showDeliveryDetail(${d.id})" class="w-full text-left p-4 hover:bg-slate-50 flex items-center justify-between transition">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-12 ${hasProof ? 'bg-emerald-100' : 'bg-slate-100'} rounded-xl flex items-center justify-center flex-shrink-0">
                                            ${hasProof ? '<i data-lucide="camera" class="w-5 h-5 text-emerald-600"></i>' : '<i data-lucide="package" class="w-5 h-5 text-slate-500"></i>'}
                                        </div>
                                        <div>
                                            <div class="font-black text-slate-900">${d.orderRef}</div>
                                            <div class="text-xs text-slate-500">${d.clientName} • ${d.address || '—'}</div>
                                            <div class="text-xs text-slate-400">Livreur: ${CORE.getUser(d.livreurId)?.name || 'Non assigné'}</div>
                                        </div>
                                    </div>
                                    <div class="text-right flex flex-col items-end gap-1">
                                        <div class="font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                                        ${badge}
                                        ${hasProof ? '<span class="text-[10px] text-emerald-600 font-bold">📷 Preuve dispo</span>' : ''}
                                    </div>
                                </button>
                            `}).join('')}
                        </div>
                    </div>
                </div>`;
        },

        renderReports() {
            const posId = CORE.state.currentUser?.pos;
            const dateFrom = CORE.state.reportDateFrom || '';
            const dateTo = CORE.state.reportDateTo || '';

            const baseDeliveries = CORE.getVisibleDeliveries() || [];
            const allDeliveries = posId ? baseDeliveries.filter(d => d.posId === posId) : baseDeliveries;
            const filteredDeliveries = dateFrom && dateTo
                ? allDeliveries.filter(d => {
                    const deliveryDate = new Date(d.createdAt).toISOString().split('T')[0];
                    return deliveryDate >= dateFrom && deliveryDate <= dateTo;
                })
                : allDeliveries;

            const delivered = filteredDeliveries.filter(d => d.status === 'livree').length;
            const pending = filteredDeliveries.filter(d => ['en_attente', 'en_cours'].includes(d.status)).length;
            const cancelled = filteredDeliveries.filter(d => d.status === 'annulee').length;
            const totalRevenue = filteredDeliveries.filter(d => d.status === 'livree').reduce((a, d) => a + (d.amount || 0), 0);
            const avgDeliveryTime = filteredDeliveries.length > 0 ? Math.round(filteredDeliveries.reduce((a, d) => {
                if (!d.assignedAt || !d.deliveredAt) return a;
                return a + (new Date(d.deliveredAt) - new Date(d.assignedAt)) / 60000;
            }, 0) / filteredDeliveries.filter(d => d.assignedAt && d.deliveredAt).length) : 0;

            const deliveriesByStatus = {
                livree: filteredDeliveries.filter(d => d.status === 'livree').length,
                en_cours: filteredDeliveries.filter(d => d.status === 'en_cours').length,
                en_attente: filteredDeliveries.filter(d => d.status === 'en_attente').length,
                probleme: filteredDeliveries.filter(d => d.status === 'probleme').length,
                annulee: filteredDeliveries.filter(d => d.status === 'annulee').length
            };

            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">📊 Rapports & Analyses</h2>
                            <p class="text-slate-500 font-medium">Statistiques des livraisons et performance du POS</p>
                        </div>
                    </div>

                    <!-- Filtres de date -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 flex gap-4 items-end flex-wrap">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Du</label>
                            <input type="date" id="reportDateFrom" value="${dateFrom}" onchange="CORE.state.reportDateFrom = this.value; GestionnaireModule.state.currentView = 'reports'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl">
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Au</label>
                            <input type="date" id="reportDateTo" value="${dateTo}" onchange="CORE.state.reportDateTo = this.value; GestionnaireModule.state.currentView = 'reports'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl">
                        </div>
                        <button onclick="CORE.state.reportDateFrom = ''; CORE.state.reportDateTo = ''; GestionnaireModule.state.currentView = 'reports'; App.rerender()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-black hover:bg-slate-200 transition text-sm">Réinitialiser</button>
                    </div>

                    <!-- KPIs principaux -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-3xl border border-emerald-200 p-6 shadow-sm">
                            <div class="text-emerald-700 text-xs font-black uppercase tracking-wider mb-2">Livrées</div>
                            <div class="text-3xl font-black text-emerald-600">${delivered}</div>
                            <div class="text-xs text-emerald-600 mt-1">${filteredDeliveries.length > 0 ? Math.round(delivered / filteredDeliveries.length * 100) : 0}% du total</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-3xl border border-amber-200 p-6 shadow-sm">
                            <div class="text-amber-700 text-xs font-black uppercase tracking-wider mb-2">En cours</div>
                            <div class="text-3xl font-black text-amber-600">${pending}</div>
                            <div class="text-xs text-amber-600 mt-1">${filteredDeliveries.length > 0 ? Math.round(pending / filteredDeliveries.length * 100) : 0}% du total</div>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-3xl border border-red-200 p-6 shadow-sm">
                            <div class="text-red-700 text-xs font-black uppercase tracking-wider mb-2">Annulées</div>
                            <div class="text-3xl font-black text-red-600">${cancelled}</div>
                            <div class="text-xs text-red-600 mt-1">${filteredDeliveries.length > 0 ? Math.round(cancelled / filteredDeliveries.length * 100) : 0}% du total</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-3xl border border-blue-200 p-6 shadow-sm">
                            <div class="text-blue-700 text-xs font-black uppercase tracking-wider mb-2">Revenu</div>
                            <div class="text-3xl font-black text-blue-600">${CORE.formatPrice(totalRevenue)}</div>
                            <div class="text-xs text-blue-600 mt-1">Livraisons confirmées</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-3xl border border-purple-200 p-6 shadow-sm">
                            <div class="text-purple-700 text-xs font-black uppercase tracking-wider mb-2">Temps moy</div>
                            <div class="text-3xl font-black text-purple-600">${avgDeliveryTime}m</div>
                            <div class="text-xs text-purple-600 mt-1">Affectation → Livraison</div>
                        </div>
                    </div>

                    <!-- Graphique de statuts -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6">
                        <h3 class="text-xl font-black text-slate-900 mb-4">Répartition par statut</h3>
                        <div class="space-y-3">
                            ${['livree', 'en_cours', 'en_attente', 'probleme', 'annulee'].map(status => {
                                const count = deliveriesByStatus[status];
                                const percent = filteredDeliveries.length > 0 ? Math.round(count / filteredDeliveries.length * 100) : 0;
                                const colors = {
                                    'livree': 'bg-emerald-500',
                                    'en_cours': 'bg-amber-500',
                                    'en_attente': 'bg-blue-500',
                                    'probleme': 'bg-red-500',
                                    'annulee': 'bg-slate-400'
                                };
                                const labels = {
                                    'livree': 'Livrées',
                                    'en_cours': 'En cours',
                                    'en_attente': 'En attente',
                                    'probleme': 'Problème',
                                    'annulea': 'Annulées'
                                };
                                return `
                                    <div class="flex items-center gap-4">
                                        <div class="w-32 text-sm font-black text-slate-900">${labels[status]}</div>
                                        <div class="flex-1 h-8 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full ${colors[status]} transition-all duration-300" data-width="${percent}"></div>
                                        </div>
                                        <div class="w-20 text-right text-sm font-black text-slate-900">${count} (${percent}%)</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Tableau détaillé -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="text-xl font-black text-slate-900">Détail des livraisons</h3>
                            <span class="text-sm text-slate-500">${filteredDeliveries.length} résultat(s)</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 border-b border-slate-100">
                                    <tr>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Commande</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Client</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Livreur</th>
                                        <th class="px-6 py-3 text-right font-black text-slate-900">Montant</th>
                                        <th class="px-6 py-3 text-center font-black text-slate-900">Statut</th>
                                        <th class="px-6 py-3 text-right font-black text-slate-900">Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredDeliveries.slice(0, 50).map(d => `
                                        <tr class="border-b border-slate-100 hover:bg-slate-50 transition">
                                            <td class="px-6 py-3 font-black text-slate-900">${d.orderRef}</td>
                                            <td class="px-6 py-3 text-slate-600">${d.clientName}</td>
                                            <td class="px-6 py-3 text-slate-600">${CORE.getUser(d.livreurId)?.name || '—'}</td>
                                            <td class="px-6 py-3 text-right font-black text-slate-900">${CORE.formatPrice(d.amount)}</td>
                                            <td class="px-6 py-3 text-center">${UI.badge(d.status, d.status === 'livree' ? 'emerald' : d.status === 'en_cours' ? 'amber' : d.status === 'annulea' ? 'red' : 'slate')}</td>
                                            <td class="px-6 py-3 text-right text-slate-500 text-xs">${CORE.formatDate(d.createdAt)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ${filteredDeliveries.length > 50 ? `<div class="p-4 text-center text-slate-500 text-xs">Affichage des 50 premiers résultats. Total: ${filteredDeliveries.length}</div>` : ''}
                        </div>
                    </div>
                </div>`;
        },

        recordAuditLog(action, entity, entityId, entityName = '', details = '', before = null, after = null) {
            const user = CORE.state.currentUser;
            const audit = CORE.create('auditLogs', {
                timestamp: new Date().toISOString(),
                userId: user?.id,
                userName: user?.name || 'Système',
                userRole: user?.role || 'system',
                action,
                entity,
                entityId,
                entityName,
                details,
                before,
                after,
                status: 'recorded'
            });
            return audit;
        },

        renderAuditLog() {
            const posId = CORE.state.currentUser?.pos;
            const filterUser = CORE.state.auditFilterUser || '';
            const filterAction = CORE.state.auditFilterAction || '';
            const filterEntity = CORE.state.auditFilterEntity || '';
            const dateFrom = CORE.state.auditDateFrom || '';
            const dateTo = CORE.state.auditDateTo || '';

            // Utilisateurs du POS du gestionnaire
            const posUsers = CORE.getVisibleUsers().filter(u => u.active && u.pos == posId);
            const posUserIds = posUsers.map(u => u.id);
            const currentUserId = CORE.state.currentUser?.id;

            // Filtrer par POS du gestionnaire (logs créés par utilisateurs de ce POS)
            let auditLogs = (CORE.db.auditLogs || []).filter(log => {
                // Si le log a un posId, vérifier qu'il correspond
                if (log.posId) return log.posId == posId;
                // Logs créés par l'utilisateur actuel
                if (log.userId == currentUserId) return true;
                // Logs créés par un utilisateur du même POS
                if (log.userId && posUserIds.includes(log.userId)) return true;
                // Si aucun filtre ne s'applique, afficher quand même (mode permissif)
                if (!log.posId && !log.userId) return true;
                return false;
            });

            // Filter by date range
            if (dateFrom || dateTo) {
                auditLogs = auditLogs.filter(log => {
                    const logDate = new Date(log.timestamp).toISOString().split('T')[0];
                    if (dateFrom && logDate < dateFrom) return false;
                    if (dateTo && logDate > dateTo) return false;
                    return true;
                });
            }

            // Filter by user
            if (filterUser) {
                auditLogs = auditLogs.filter(log => log.userId == filterUser);
            }

            // Filter by action
            if (filterAction) {
                auditLogs = auditLogs.filter(log => log.action === filterAction);
            }

            // Filter by entity
            if (filterEntity) {
                auditLogs = auditLogs.filter(log => log.entity === filterEntity);
            }

            // Sort by date descending
            auditLogs = auditLogs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Actions et entités basées sur les logs filtrés du POS
            const actions = [...new Set(auditLogs.map(l => l.action).filter(a => a))];
            const entities = [...new Set(auditLogs.map(l => l.entity).filter(e => e))];

            const actionColors = {
                'create': 'emerald',
                'update': 'blue',
                'delete': 'red',
                'assign': 'purple',
                'deposit': 'amber',
                'status_change': 'cyan',
                'export': 'slate',
                'validate': 'green'
            };

            const entityIcons = {
                'order': 'receipt',
                'delivery': 'truck',
                'deposit': 'wallet',
                'product': 'box',
                'user': 'user',
                'shift': 'calendar',
                'inventory': 'package'
            };

            const posName = CORE.getPOS(posId)?.name || 'Mon POS';

            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">📋 Journal d'Audit</h2>
                            <p class="text-slate-500 font-medium">Traçabilité des actions sur <strong>${posName}</strong></p>
                        </div>
                        <button onclick="GestionnaireModule.exportAuditLog()" class="px-4 py-2 bg-slate-900 text-white rounded-xl font-black hover:bg-slate-800 transition flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Exporter
                        </button>
                    </div>

                    <!-- Filtres -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 space-y-4">
                        <h3 class="font-black text-slate-900">Filtres</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                            <!-- Filtre par utilisateur -->
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Utilisateur</label>
                                <select onchange="CORE.state.auditFilterUser = this.value; GestionnaireModule.state.currentView = 'auditlog'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-amber-500 transition">
                                    <option value="">Tous</option>
                                    ${posUsers.map(u => `<option value="${u.id}" ${filterUser == u.id ? 'selected' : ''}>${u.name}</option>`).join('')}
                                </select>
                            </div>

                            <!-- Filtre par action -->
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Action</label>
                                <select onchange="CORE.state.auditFilterAction = this.value; GestionnaireModule.state.currentView = 'auditlog'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-amber-500 transition">
                                    <option value="">Toutes</option>
                                    ${actions.map(a => `<option value="${a}" ${filterAction === a ? 'selected' : ''}>${a}</option>`).join('')}
                                </select>
                            </div>

                            <!-- Filtre par entité -->
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Entité</label>
                                <select onchange="CORE.state.auditFilterEntity = this.value; GestionnaireModule.state.currentView = 'auditlog'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-amber-500 transition">
                                    <option value="">Toutes</option>
                                    ${entities.map(e => `<option value="${e}" ${filterEntity === e ? 'selected' : ''}>${e}</option>`).join('')}
                                </select>
                            </div>

                            <!-- Date depuis -->
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Du</label>
                                <input type="date" value="${dateFrom}" onchange="CORE.state.auditDateFrom = this.value; GestionnaireModule.state.currentView = 'auditlog'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-amber-500 transition">
                            </div>

                            <!-- Date jusqu'à -->
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Au</label>
                                <input type="date" value="${dateTo}" onchange="CORE.state.auditDateTo = this.value; GestionnaireModule.state.currentView = 'auditlog'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-amber-500 transition">
                            </div>
                        </div>
                        <button onclick="CORE.state.auditFilterUser = ''; CORE.state.auditFilterAction = ''; CORE.state.auditFilterEntity = ''; CORE.state.auditDateFrom = ''; CORE.state.auditDateTo = ''; GestionnaireModule.state.currentView = 'auditlog'; App.rerender()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-black hover:bg-slate-200 transition">Réinitialiser les filtres</button>
                    </div>

                    <!-- Statistiques -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">Total événements</div>
                            <div class="text-4xl font-black text-slate-900 mt-2">${auditLogs.length}</div>
                            <p class="text-xs text-slate-400 mt-2">Enregistrés</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">Modifications statuts</div>
                            <div class="text-4xl font-black text-blue-600 mt-2">${auditLogs.filter(l => l.action === 'status_change').length}</div>
                            <p class="text-xs text-slate-400 mt-2">Changements</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">Dépôts enregistrés</div>
                            <div class="text-4xl font-black text-amber-600 mt-2">${auditLogs.filter(l => l.action === 'deposit').length}</div>
                            <p class="text-xs text-slate-400 mt-2">Dépôts</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">Affectations</div>
                            <div class="text-4xl font-black text-purple-600 mt-2">${auditLogs.filter(l => l.action === 'assign').length}</div>
                            <p class="text-xs text-slate-400 mt-2">Assignations</p>
                        </div>
                    </div>

                    <!-- Tableau des logs -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="text-xl font-black text-slate-900">Historique des actions</h3>
                            <span class="text-sm text-slate-500">${auditLogs.length} résultat(s)</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 border-b border-slate-100">
                                    <tr>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Date/Heure</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Utilisateur</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Action</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Entité</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Détails</th>
                                        <th class="px-6 py-3 text-center font-black text-slate-900">Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${auditLogs.length === 0 ? '<tr><td colspan="6" class="px-6 py-10 text-center text-slate-400 italic">Aucun événement enregistré</td></tr>' : ''}
                                    ${auditLogs.slice(0, 100).map(log => {
                                        return `<tr class="border-b border-slate-100 hover:bg-slate-50 transition">
                                            <td class="px-6 py-4">
                                                <div class="font-black text-slate-900 text-xs">${new Date(log.timestamp).toLocaleDateString('fr-FR')}</div>
                                                <div class="text-[10px] text-slate-500">${new Date(log.timestamp).toLocaleTimeString('fr-FR')}</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="font-black text-slate-900">${log.userName}</div>
                                                <div class="text-[10px] text-slate-500 uppercase">${log.userRole}</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                ${UI.badge(log.action, actionColors[log.action] || 'slate')}
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="flex items-center gap-2">
                                                    <i data-lucide="${entityIcons[log.entity] || 'file'}" class="w-4 h-4 text-slate-400"></i>
                                                    <span class="font-black text-slate-900">${log.entity}</span>
                                                </div>
                                                <div class="text-[10px] text-slate-500">#${log.entityId}</div>
                                            </td>
                                            <td class="px-6 py-4 text-sm text-slate-600">
                                                <div class="max-w-xs truncate">${log.entityName || '—'}</div>
                                                <div class="text-[10px] text-slate-400 mt-1">${log.details || '—'}</div>
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                ${UI.badge(log.status || 'recorded', 'emerald')}
                                            </td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                            ${auditLogs.length > 100 ? `<div class="p-4 text-center text-slate-500 text-xs">Affichage des 100 premiers résultats. Total: ${auditLogs.length}</div>` : ''}
                        </div>
                    </div>
                </div>`;
        },

        exportAuditLog() {
            const auditLogs = CORE.db.auditLogs || [];
            if (auditLogs.length === 0) {
                UI.toast('Aucun événement à exporter', 'warning');
                return;
            }

            // Prepare CSV data
            const headers = ['Date', 'Heure', 'Utilisateur', 'Rôle', 'Action', 'Entité', 'ID', 'Nom', 'Détails', 'Avant', 'Après', 'Statut'];
            const rows = auditLogs.map(log => [
                new Date(log.timestamp).toLocaleDateString('fr-FR'),
                new Date(log.timestamp).toLocaleTimeString('fr-FR'),
                log.userName || '—',
                log.userRole || '—',
                log.action || '—',
                log.entity || '—',
                log.entityId || '—',
                log.entityName || '—',
                log.details || '—',
                log.before ? JSON.stringify(log.before) : '—',
                log.after ? JSON.stringify(log.after) : '—',
                log.status || '—'
            ]);

            // Create CSV content
            let csv = headers.map(h => `"${h}"`).join(',') + '\n';
            csv += rows.map(r => r.map(v => {
                const str = String(v || '');
                return `"${str.replace(/"/g, '""')}"`;
            }).join(',')).join('\n');

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `journal_audit_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            UI.toast('Audit log exporté en CSV', 'success');
        },

        showDailyDigestConfig() {
            const posId = CORE.state.currentUser?.pos;
            const config = CORE.getDailyDigestConfig(posId) || {
                posId,
                enabled: false,
                sendTime: '06:00',
                recipients: [],
                includeVentes: true,
                includeDepots: true,
                includeIncidents: true,
                includeKPIs: true
            };

            UI.modal('⏰ Configuration Digest Quotidien', `
                <div class="space-y-4">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                        <div class="flex items-start gap-3">
                            <i data-lucide="info" class="w-5 h-5 text-amber-600 mt-0.5 flex-shrink-0"></i>
                            <p class="text-sm text-amber-700">Le digest quotidien récapitule les ventes, dépôts, incidents et KPIs chaque matin.</p>
                        </div>
                    </div>

                    <!-- Activation -->
                    <div class="flex items-center justify-between p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div>
                            <div class="font-black text-slate-900">Activer le digest</div>
                            <div class="text-xs text-slate-500">Envoyer chaque matin</div>
                        </div>
                        <input type="checkbox" id="digest_enabled" ${config.enabled ? 'checked' : ''} class="w-5 h-5">
                    </div>

                    <!-- Heure d'envoi -->
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Heure d'envoi</label>
                        <input type="time" id="digest_time" value="${config.sendTime}" class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-amber-500">
                    </div>

                    <!-- Email destinataires -->
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Destinataires (emails)</label>
                        <textarea id="digest_recipients" placeholder="user@example.com&#10;autre@example.com" class="w-full px-4 py-2 border border-slate-200 rounded-xl h-20 focus:ring-2 focus:ring-amber-500">${config.recipients.join('\\n')}</textarea>
                        <div class="text-[10px] text-slate-500 mt-1">Un email par ligne</div>
                    </div>

                    <!-- Contenu du digest -->
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl space-y-3">
                        <div class="font-black text-slate-900 text-sm">Éléments à inclure</div>

                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="digest_ventes" ${config.includeVentes ? 'checked' : ''}>
                            <label for="digest_ventes" class="text-sm font-black text-slate-700 cursor-pointer">📊 Résumé des ventes</label>
                        </div>

                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="digest_depots" ${config.includeDepots ? 'checked' : ''}>
                            <label for="digest_depots" class="text-sm font-black text-slate-700 cursor-pointer">💰 Dépôts du jour</label>
                        </div>

                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="digest_incidents" ${config.includeIncidents ? 'checked' : ''}>
                            <label for="digest_incidents" class="text-sm font-black text-slate-700 cursor-pointer">⚠️ Incidents</label>
                        </div>

                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="digest_kpis" ${config.includeKPIs ? 'checked' : ''}>
                            <label for="digest_kpis" class="text-sm font-black text-slate-700 cursor-pointer">📈 KPIs clés</label>
                        </div>
                    </div>

                    <!-- Test -->
                    <button onclick="GestionnaireModule.testDailyDigest()" class="w-full px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-black hover:bg-slate-200 transition text-sm">
                        📧 Envoyer un test maintenant
                    </button>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'GestionnaireModule.saveDailyDigestConfig()', class: 'px-5 py-2.5 bg-amber-600 text-white font-black rounded-xl hover:bg-amber-700 transition' }
            ]);
        },

        saveDailyDigestConfig() {
            const posId = CORE.state.currentUser?.pos;
            const enabled = document.getElementById('digest_enabled')?.checked || false;
            const sendTime = document.getElementById('digest_time')?.value || '06:00';
            const recipientsText = document.getElementById('digest_recipients')?.value || '';
            const recipients = recipientsText.split('\\n').map(e => e.trim()).filter(e => e.length > 0);

            const includeVentes = document.getElementById('digest_ventes')?.checked !== false;
            const includeDepots = document.getElementById('digest_depots')?.checked !== false;
            const includeIncidents = document.getElementById('digest_incidents')?.checked !== false;
            const includeKPIs = document.getElementById('digest_kpis')?.checked !== false;

            const config = CORE.setDailyDigestConfig(posId, {
                enabled,
                sendTime,
                recipients,
                includeVentes,
                includeDepots,
                includeIncidents,
                includeKPIs
            });

            UI.closeModal();
            UI.toast('Configuration du digest enregistrée', 'success');
            App.rerender();
        },

        testDailyDigest() {
            const posId = CORE.state.currentUser?.pos;
            const digest = CORE.sendDailyDigest(posId);
            if (!digest) {
                UI.toast('Le digest n\'est pas configuré ou pas activé', 'warning');
            } else {
                UI.toast(`Test de digest envoyé pour ${digest.posName}`, 'success');
            }
        },

        renderIncidentCenter() {
            const posId = CORE.state.currentUser?.pos;
            const filters = {
                status: document.getElementById('inc_status')?.value || 'tous',
                type: document.getElementById('inc_type')?.value || 'tous',
                severity: document.getElementById('inc_severity')?.value || 'tous',
                slaStatus: document.getElementById('inc_sla')?.value || 'tous',
                search: document.getElementById('inc_search')?.value || ''
            };

            const filterObj = {};
            if (filters.status !== 'tous') filterObj.status = filters.status;
            if (filters.type !== 'tous') filterObj.type = filters.type;
            if (filters.severity !== 'tous') filterObj.severity = filters.severity;
            if (filters.slaStatus !== 'tous') filterObj.slaStatus = filters.slaStatus;
            if (filters.search) filterObj.search = filters.search;

            // Filtrer les incidents par POS du gestionnaire
            const allIncidents = CORE.getIncidents(filterObj);
            const incidents = allIncidents.filter(i => i.posId == posId || !i.posId);

            // Calculer les stats filtrées par POS
            const posIncidents = (CORE.db.incidents || []).filter(i => i.posId == posId || !i.posId);
            const stats = {
                open: posIncidents.filter(i => i.status === 'ouvert').length,
                inProgress: posIncidents.filter(i => i.status === 'en-cours').length,
                resolved: posIncidents.filter(i => i.status === 'résolu' || i.status === 'fermé').length,
                slaBreached: posIncidents.filter(i => i.slaStatus === 'dépassé').length
            };

            const slaColorMap = { 'en-cours': 'bg-blue-50 border-blue-200', 'atteint': 'bg-emerald-50 border-emerald-200', 'dépassé': 'bg-red-50 border-red-200' };
            const statusColorMap = { 'ouvert': 'bg-red-100 text-red-800', 'en-cours': 'bg-blue-100 text-blue-800', 'résolu': 'bg-emerald-100 text-emerald-800', 'fermé': 'bg-slate-100 text-slate-800' };
            const severityColorMap = { 'haute': 'text-red-600', 'moyenne': 'text-amber-600', 'basse': 'text-blue-600' };

            return `
                <div class="fade-in space-y-6">
                    <!-- Statistiques -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-red-500 to-red-600 text-white p-6 rounded-2xl shadow-sm">
                            <div class="text-xs font-black uppercase tracking-wider opacity-90">Incidents ouverts</div>
                            <div class="text-3xl font-black mt-2">${stats.open}</div>
                            <div class="text-xs opacity-75 mt-1">En attente d'action</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-orange-600 text-white p-6 rounded-2xl shadow-sm">
                            <div class="text-xs font-black uppercase tracking-wider opacity-90">SLA dépassés</div>
                            <div class="text-3xl font-black mt-2">${stats.slaBreached}</div>
                            <div class="text-xs opacity-75 mt-1">Hors délai</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-2xl shadow-sm">
                            <div class="text-xs font-black uppercase tracking-wider opacity-90">En cours</div>
                            <div class="text-3xl font-black mt-2">${stats.inProgress}</div>
                            <div class="text-xs opacity-75 mt-1">Assignés</div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 text-white p-6 rounded-2xl shadow-sm">
                            <div class="text-xs font-black uppercase tracking-wider opacity-90">Résolus</div>
                            <div class="text-3xl font-black mt-2">${stats.resolved}</div>
                            <div class="text-xs opacity-75 mt-1">Fermés avec succès</div>
                        </div>
                    </div>

                    <!-- Filtres -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 space-y-4">
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                            <div>
                                <input type="text" id="inc_search" placeholder="Chercher..." class="w-full px-3 py-2 border border-slate-200 rounded-xl text-sm" onkeyup="App.rerender()">
                            </div>
                            <select id="inc_status" class="px-3 py-2 border border-slate-200 rounded-xl text-sm" onchange="App.rerender()">
                                <option value="tous">Tous les statuts</option>
                                <option value="ouvert">Ouvert</option>
                                <option value="en-cours">En cours</option>
                                <option value="résolu">Résolu</option>
                                <option value="fermé">Fermé</option>
                            </select>
                            <select id="inc_type" class="px-3 py-2 border border-slate-200 rounded-xl text-sm" onchange="App.rerender()">
                                <option value="tous">Tous les types</option>
                                <option value="retard">Retard</option>
                                <option value="annulation">Annulation</option>
                                <option value="litige">Litige</option>
                            </select>
                            <select id="inc_severity" class="px-3 py-2 border border-slate-200 rounded-xl text-sm" onchange="App.rerender()">
                                <option value="tous">Toutes sévérités</option>
                                <option value="haute">Haute</option>
                                <option value="moyenne">Moyenne</option>
                                <option value="basse">Basse</option>
                            </select>
                            <select id="inc_sla" class="px-3 py-2 border border-slate-200 rounded-xl text-sm" onchange="App.rerender()">
                                <option value="tous">Tous SLA</option>
                                <option value="en-cours">En cours</option>
                                <option value="atteint">Atteint</option>
                                <option value="dépassé">Dépassé ⚠️</option>
                            </select>
                        </div>
                    </div>

                    <!-- Table d'incidents -->
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-black text-slate-900">Incidents (${incidents.length})</h3>
                            <div class="flex gap-2">
                                ${window._incidentDrafts && window._incidentDrafts.length > 0 ? `
                                    <button onclick="GestionnaireModule.showDraftsModal()" class="px-3 py-1.5 bg-amber-500 text-white text-xs font-black rounded-lg hover:bg-amber-600 transition flex items-center gap-1">
                                        📋 Brouillons (${window._incidentDrafts.length})
                                    </button>
                                ` : ''}
                                <button onclick="GestionnaireModule.showNewIncidentModal()" class="px-3 py-1.5 bg-red-600 text-white text-xs font-black rounded-lg hover:bg-red-700 transition">
                                    ➕ Nouvel incident
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th class="px-6 py-3 font-black text-slate-600">ID</th>
                                        <th class="px-6 py-3 font-black text-slate-600">Type</th>
                                        <th class="px-6 py-3 font-black text-slate-600">Description</th>
                                        <th class="px-6 py-3 font-black text-slate-600">Statut</th>
                                        <th class="px-6 py-3 font-black text-slate-600">Assigné</th>
                                        <th class="px-6 py-3 font-black text-slate-600">SLA</th>
                                        <th class="px-6 py-3 font-black text-slate-600">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${incidents.length === 0 ? `<tr><td colspan="7" class="px-6 py-8 text-center text-slate-400 italic">Aucun incident trouvé</td></tr>` : ''}
                                    ${incidents.map(inc => {
                                        const timeRemaining = Math.max(0, new Date(inc.slaEndTime) - new Date());
                                        const hoursRemaining = Math.round(timeRemaining / 3600000);
                                        return `
                                            <tr class="hover:bg-slate-50 transition">
                                                <td class="px-6 py-3">
                                                    <span class="font-black text-slate-900">${inc.id}</span>
                                                </td>
                                                <td class="px-6 py-3">
                                                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-100 text-xs font-bold">
                                                        ${inc.type === 'retard' ? '⏱️' : inc.type === 'annulation' ? '❌' : '⚖️'} ${inc.type}
                                                    </span>
                                                </td>
                                                <td class="px-6 py-3">
                                                    <div class="text-slate-900 font-medium">${inc.description.substring(0, 40)}</div>
                                                    <div class="text-xs text-slate-400">Sévérité: <span class="${severityColorMap[inc.severity]}">${inc.severity}</span></div>
                                                </td>
                                                <td class="px-6 py-3">
                                                    <span class="px-2 py-1 rounded-lg text-xs font-black ${statusColorMap[inc.status]}">${inc.status}</span>
                                                </td>
                                                <td class="px-6 py-3">
                                                    <div class="text-sm font-medium">${inc.assignedToName || '—'}</div>
                                                </td>
                                                <td class="px-6 py-3">
                                                    <div class="text-xs font-black">
                                                        <span class="px-2 py-1 rounded-lg ${slaColorMap[inc.slaStatus]}">${inc.slaStatus}</span>
                                                        <div class="text-slate-500 text-[10px] mt-1">${hoursRemaining}h restantes</div>
                                                    </div>
                                                </td>
                                                <td class="px-6 py-3">
                                                    <button onclick="GestionnaireModule.showIncidentDetail('${inc.id}')" class="text-xs font-black text-blue-600 hover:text-blue-800">
                                                        Voir détails
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        },

        showNewIncidentModal() {
            // Types d'incidents prédéfinis + types personnalisés
            const defaultTypes = [
                {value: 'retard', label: '⏱️ Retard de livraison'},
                {value: 'annulation', label: '❌ Annulation'},
                {value: 'litige', label: '⚖️ Litige client'}
            ];

            const customTypes = (CORE.db.customIncidentTypes || []).map(t => ({
                value: t.id,
                label: `${t.icon || '•'} ${t.name}`
            }));

            const allTypes = [...defaultTypes, ...customTypes];

            // Récupérer les données sauvegardées si brouillon existant
            const savedDraft = window._incidentDraft;

            UI.modal('➕ Créer un nouvel incident', `
                <div class="space-y-4">
                    <!-- Brouillons existants -->
                    ${window._incidentDrafts && window._incidentDrafts.length > 0 ? `
                        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 space-y-3">
                            <div class="font-black text-amber-900">📋 Brouillons en attente (${window._incidentDrafts.length})</div>
                            <div class="space-y-2">
                                ${window._incidentDrafts.map((draft, idx) => `
                                    <div class="flex items-center justify-between bg-white p-2 rounded border border-amber-100">
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-slate-900 text-sm truncate">${draft.type || 'Sans type'}</div>
                                            <div class="text-xs text-slate-500 truncate">${draft.description?.substring(0, 40) || 'Sans description'}...</div>
                                        </div>
                                        <div class="flex gap-1 flex-shrink-0">
                                            <button onclick="GestionnaireModule.loadIncidentDraft(${idx})" class="px-2 py-1 bg-blue-600 text-white text-xs font-bold rounded hover:bg-blue-700 transition">Charger</button>
                                            <button onclick="GestionnaireModule.deleteIncidentDraft(${idx})" class="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded hover:bg-red-700 transition">✕</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="border-t border-slate-200 pt-4 space-y-4">
                        <div class="space-y-2">
                            <label class="text-sm font-black text-slate-700">Type d'incident</label>
                            <div class="flex gap-2">
                                <select id="new_inc_type" class="flex-1 px-3 py-2.5 rounded-lg border border-slate-200 font-bold">
                                    <option value="">-- Sélectionner un type --</option>
                                    ${allTypes.map(t => `<option value="${t.value}" ${savedDraft?.type === t.value ? 'selected' : ''}>${t.label}</option>`).join('')}
                                    <option value="__new__" class="border-t-2 border-slate-300">➕ Créer un nouveau type...</option>
                                </select>
                                <button onclick="GestionnaireModule.showNewIncidentTypeModal()" class="px-3 py-2.5 bg-blue-600 text-white font-black rounded-lg hover:bg-blue-700 transition text-sm" title="Ajouter un type">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>

                        ${UI.select('new_inc_severity', 'Sévérité', [
                            {value: 'basse', label: 'Basse'},
                            {value: 'moyenne', label: 'Moyenne'},
                            {value: 'haute', label: 'Haute'}
                        ], savedDraft?.severity || 'moyenne', true)}

                        <div class="space-y-2">
                            <label class="text-sm font-bold text-slate-700">Description</label>
                            <textarea id="new_inc_desc" placeholder="Décrivez l'incident en détail" class="w-full px-3 py-2 rounded-lg border border-slate-200 font-medium h-24 resize-none">${savedDraft?.description || ''}</textarea>
                        </div>

                        ${UI.input('new_inc_entity', 'Entité associée', 'text', savedDraft?.entity || '', 'ID de livraison ou commande')}
                    </div>
                </div>
            `, [
                { label: 'Mettre en pause', onclick: 'GestionnaireModule.pauseIncidentCreation()', class: 'px-5 py-2.5 bg-amber-600 text-white font-black rounded-xl hover:bg-amber-700 transition' },
                { label: 'Annuler', onclick: 'UI.closeModal(); window._incidentDraft = null;' },
                { label: 'Créer', onclick: 'GestionnaireModule.createNewIncident()', class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);

            // Gestion du changement de type
            setTimeout(() => {
                const typeSelect = document.getElementById('new_inc_type');
                if (typeSelect) {
                    typeSelect.addEventListener('change', () => {
                        if (typeSelect.value === '__new__') {
                            UI.closeModal();
                            GestionnaireModule.showNewIncidentTypeModal();
                        }
                    });
                }
                lucide.createIcons();
            }, 50);
        },

        pauseIncidentCreation() {
            const type = UI.val('new_inc_type');
            const severity = UI.val('new_inc_severity');
            const description = document.getElementById('new_inc_desc')?.value || '';
            const entity = UI.val('new_inc_entity');

            if (!type && !severity && !description && !entity) {
                return UI.toast('Aucune donnée à sauvegarder', 'info');
            }

            // Initialiser le tableau de brouillons
            if (!window._incidentDrafts) {
                window._incidentDrafts = [];
            }

            // Créer le brouillon
            const draft = {
                type: type,
                severity: severity,
                description: description,
                entity: entity,
                savedAt: new Date().toISOString()
            };

            // Ajouter le brouillon
            window._incidentDrafts.push(draft);

            UI.closeModal();
            UI.toast(`✅ Brouillon sauvegardé! (${window._incidentDrafts.length} brouillon(s) en attente)`, 'success');

            // Mettre à jour le badge si en liste
            App.rerender();
        },

        loadIncidentDraft(index) {
            if (!window._incidentDrafts || !window._incidentDrafts[index]) {
                return UI.toast('Brouillon introuvable', 'error');
            }

            const draft = window._incidentDrafts[index];
            window._incidentDraft = draft;

            UI.closeModal();
            setTimeout(() => {
                GestionnaireModule.showNewIncidentModal();
            }, 100);
        },

        deleteIncidentDraft(index) {
            if (!window._incidentDrafts) return;

            window._incidentDrafts.splice(index, 1);

            if (window._incidentDrafts.length === 0) {
                UI.closeModal();
                UI.toast('✅ Brouillon supprimé', 'info');
            } else {
                UI.toast('✅ Brouillon supprimé', 'info');
                GestionnaireModule.showDraftsModal();
            }
        },

        showNewIncidentTypeModal() {
            UI.modal('➕ Créer un nouveau type d\'incident', `
                <div class="space-y-4">
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                        Créez un type d'incident personnalisé pour votre organisation
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-bold text-slate-700">Nom du type</label>
                        <input type="text" id="new_type_name" placeholder="ex: Produit endommagé, Retour" class="w-full px-3 py-2 rounded-lg border border-slate-200 font-medium">
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-bold text-slate-700">Icône/Emoji (optionnel)</label>
                        <input type="text" id="new_type_icon" placeholder="ex: 📦 🚚 ⚠️" class="w-full px-3 py-2 rounded-lg border border-slate-200 font-medium" maxlength="3">
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-bold text-slate-700">Description</label>
                        <textarea id="new_type_desc" placeholder="Décrivez quand ce type d'incident devrait être utilisé..." class="w-full px-3 py-2 rounded-lg border border-slate-200 font-medium h-20 resize-none"></textarea>
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-bold text-slate-700">Sévérité par défaut</label>
                        <select id="new_type_severity" class="w-full px-3 py-2 rounded-lg border border-slate-200 font-bold">
                            <option value="basse">Basse</option>
                            <option value="moyenne" selected>Moyenne</option>
                            <option value="haute">Haute</option>
                        </select>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Créer le type', onclick: 'GestionnaireModule.createNewIncidentType()', class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        createNewIncidentType() {
            const name = document.getElementById('new_type_name')?.value?.trim();
            const icon = document.getElementById('new_type_icon')?.value?.trim() || '•';
            const desc = document.getElementById('new_type_desc')?.value?.trim() || '';
            const defaultSeverity = document.getElementById('new_type_severity')?.value || 'moyenne';

            if (!name) return UI.toast('Nom requis', 'warning');

            // Initialiser le tableau si nécessaire
            if (!CORE.db.customIncidentTypes) {
                CORE.db.customIncidentTypes = [];
            }

            // Créer le nouveau type
            const newType = CORE.create('customIncidentTypes', {
                name: name,
                icon: icon,
                description: desc,
                defaultSeverity: defaultSeverity,
                active: true,
                createdAt: new Date().toISOString()
            });

            UI.closeModal();
            UI.toast(`✅ Type d'incident "${name}" créé!`, 'success');

            // Réouvrir le modal d'incident
            setTimeout(() => {
                GestionnaireModule.showNewIncidentModal();
            }, 300);
        },

        createNewIncident() {
            const type = UI.val('new_inc_type');
            const severity = UI.val('new_inc_severity');
            const description = UI.val('new_inc_desc');
            const entity = UI.val('new_inc_entity');

            if (!type || !severity || !description || !entity) {
                return UI.toast('Tous les champs sont obligatoires', 'warning');
            }

            CORE.createIncident(type, entity, 'delivery', description, severity);
            UI.closeModal();
            UI.toast('Incident créé avec succès', 'success');
            App.rerender();
        },

        showDraftsModal() {
            if (!window._incidentDrafts || window._incidentDrafts.length === 0) {
                UI.toast('Aucun brouillon en attente', 'info');
                return;
            }

            const drafts = window._incidentDrafts;
            const draftsList = drafts.map((draft, idx) => `
                <div class="p-4 border border-slate-200 rounded-lg bg-slate-50 hover:bg-slate-100 transition">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-lg font-black">${draft.type === 'retard' ? '⏱️' : draft.type === 'annulation' ? '❌' : '⚖️'}</span>
                                <span class="font-black text-slate-900">${draft.type}</span>
                                <span class="px-2 py-0.5 rounded bg-slate-200 text-xs font-bold text-slate-700">${draft.severity}</span>
                            </div>
                            <div class="text-sm text-slate-700 mb-2">
                                <strong>Entité:</strong> ${draft.entity}
                            </div>
                            <div class="text-sm text-slate-600 line-clamp-2">
                                ${draft.description}
                            </div>
                            <div class="text-xs text-slate-400 mt-2">
                                Sauvegardé: ${new Date(draft.savedAt).toLocaleString('fr-FR')}
                            </div>
                        </div>
                        <div class="flex gap-2 ml-3">
                            <button onclick="GestionnaireModule.loadIncidentDraft(${idx})" class="px-3 py-1.5 bg-blue-600 text-white text-xs font-black rounded-lg hover:bg-blue-700 transition">
                                ↩️ Charger
                            </button>
                            <button onclick="GestionnaireModule.deleteIncidentDraft(${idx})" class="px-3 py-1.5 bg-red-600 text-white text-xs font-black rounded-lg hover:bg-red-700 transition">
                                ✕
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            UI.modal(`
                <div class="space-y-4">
                    <h2 class="text-xl font-black text-slate-900">📋 Brouillons en attente (${drafts.length})</h2>
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto">
                        ${draftsList}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            lucide.createIcons();
        },

        showIncidentDetail(incidentId) {
            const incident = CORE.db.incidents.find(i => i.id === incidentId);
            if (!incident) {
                UI.toast('Incident non trouvé', 'error');
                return;
            }

            const history = CORE.getIncidentHistory(incident.id);
            const slaColorMap = { 'en-cours': 'text-blue-600', 'atteint': 'text-emerald-600', 'dépassé': 'text-red-600' };
            const statusColorMap = { 'ouvert': 'bg-red-100 text-red-800', 'en-cours': 'bg-blue-100 text-blue-800', 'résolu': 'bg-emerald-100 text-emerald-800', 'fermé': 'bg-slate-100 text-slate-800' };

            const timeRemaining = Math.max(0, new Date(incident.slaEndTime) - new Date());
            const daysRemaining = Math.floor(timeRemaining / 86400000);
            const hoursRemaining = Math.floor((timeRemaining % 86400000) / 3600000);

            UI.modal(`Incident ${incident.id}`, `
                <div class="space-y-6">
                    <!-- En-tête -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs text-slate-500 font-black uppercase">Type</div>
                            <div class="text-lg font-black text-slate-900 mt-1">${incident.type}</div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-500 font-black uppercase">Sévérité</div>
                            <div class="text-lg font-black text-slate-900 mt-1">${incident.severity}</div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div>
                        <div class="text-xs text-slate-500 font-black uppercase">Description</div>
                        <div class="mt-2 p-3 bg-slate-50 rounded-lg text-sm text-slate-700">${incident.description}</div>
                    </div>

                    <!-- Statut et SLA -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs text-slate-500 font-black uppercase">Statut</div>
                            <div class="mt-2">
                                <select id="detail_status" class="px-3 py-2 border border-slate-200 rounded-lg text-sm font-black w-full">
                                    <option value="ouvert" ${incident.status === 'ouvert' ? 'selected' : ''}>Ouvert</option>
                                    <option value="en-cours" ${incident.status === 'en-cours' ? 'selected' : ''}>En cours</option>
                                    <option value="résolu" ${incident.status === 'résolu' ? 'selected' : ''}>Résolu</option>
                                    <option value="fermé" ${incident.status === 'fermé' ? 'selected' : ''}>Fermé</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-500 font-black uppercase">SLA</div>
                            <div class="mt-2 px-3 py-2 rounded-lg bg-slate-50 text-sm">
                                <span class="${slaColorMap[incident.slaStatus]} font-black">${incident.slaStatus}</span>
                                <div class="text-xs text-slate-500 mt-1">${daysRemaining}j ${hoursRemaining}h restantes</div>
                            </div>
                        </div>
                    </div>

                    <!-- Assignation -->
                    <div>
                        <div class="text-xs text-slate-500 font-black uppercase">Assigné à</div>
                        <div class="mt-2">
                            <select id="detail_assignee" class="px-3 py-2 border border-slate-200 rounded-lg text-sm font-black w-full">
                                <option value="">Non assigné</option>
                                ${CORE.getVisibleUsers().filter(u => u.role === 'gestionnaire' || u.role === 'manager').map(u =>
                                    `<option value="${u.id}" ${incident.assignedTo === u.id ? 'selected' : ''}>${u.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <div class="text-xs text-slate-500 font-black uppercase mb-2">Notes (${incident.notes.length})</div>
                        <div class="space-y-3 max-h-48 overflow-y-auto">
                            ${incident.notes.map(n => `
                                <div class="p-3 bg-slate-50 rounded-lg border-l-2 border-blue-400">
                                    <div class="flex justify-between text-xs">
                                        <span class="font-black text-slate-700">${n.userName}</span>
                                        <span class="text-slate-400">${new Date(n.timestamp).toLocaleString('fr-FR')}</span>
                                    </div>
                                    <div class="text-sm text-slate-700 mt-2">${n.text}</div>
                                </div>
                            `).join('')}
                        </div>
                        <textarea id="detail_note" placeholder="Ajouter une note..." class="w-full mt-3 px-3 py-2 border border-slate-200 rounded-lg text-sm" rows="3"></textarea>
                    </div>

                    <!-- Résolution -->
                    <div>
                        <div class="text-xs text-slate-500 font-black uppercase">Résolution</div>
                        <textarea id="detail_resolution" placeholder="Comment l\'incident a été résolu..." class="w-full mt-2 px-3 py-2 border border-slate-200 rounded-lg text-sm" rows="2">${incident.resolution || ''}</textarea>
                    </div>

                    <!-- Historique -->
                    <div>
                        <div class="text-xs text-slate-500 font-black uppercase mb-2">Historique</div>
                        <div class="space-y-2 max-h-32 overflow-y-auto text-xs">
                            ${history.map(h => `
                                <div class="p-2 bg-slate-50 rounded text-slate-600">
                                    <span class="font-black">${h.userName}</span> - ${h.action} - ${new Date(h.timestamp).toLocaleString('fr-FR')}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Sauvegarder', onclick: `GestionnaireModule.saveIncidentChanges('${incident.id}')`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        saveIncidentChanges(incidentId) {
            const newStatus = document.getElementById('detail_status')?.value;
            const newAssignee = document.getElementById('detail_assignee')?.value;
            const noteText = document.getElementById('detail_note')?.value;
            const resolutionText = document.getElementById('detail_resolution')?.value;

            if (newStatus) {
                CORE.updateIncidentStatus(incidentId, newStatus);
            }

            if (newAssignee) {
                CORE.assignIncident(incidentId, newAssignee);
            }

            if (noteText?.trim()) {
                CORE.addIncidentNote(incidentId, noteText.trim());
            }

            if (resolutionText?.trim()) {
                CORE.setIncidentResolution(incidentId, resolutionText.trim());
            }

            UI.closeModal();
            UI.toast('Incident mis à jour', 'success');
            App.rerender();
        },

        showIncidentConfig() {
            UI.modal('⚠️ Configuration Centre d\'Incidents', `
                <div class="space-y-4">
                    <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
                        <div class="font-black text-slate-900 mb-3">SLA par type et sévérité (en minutes)</div>

                        <div class="space-y-3">
                            <div>
                                <div class="text-xs font-black text-slate-600 mb-2">RETARDS</div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">Sévérité basse</label>
                                        <input type="number" id="sla_retard_basse" value="480" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">Sévérité moyenne</label>
                                        <input type="number" id="sla_retard_moyenne" value="240" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">Sévérité haute</label>
                                        <input type="number" id="sla_retard_haute" value="120" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div class="text-xs font-black text-slate-600 mb-2">ANNULATIONS</div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">Sévérité basse</label>
                                        <input type="number" id="sla_annul_basse" value="240" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">Sévérité moyenne</label>
                                        <input type="number" id="sla_annul_moyenne" value="120" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">Sévérité haute</label>
                                        <input type="number" id="sla_annul_haute" value="60" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <div class="text-xs font-black text-slate-600 mb-2">LITIGES</div>
                                <div class="grid grid-cols-3 gap-2">
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">Sévérité basse</label>
                                        <input type="number" id="sla_litige_basse" value="1440" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">Sévérité moyenne</label>
                                        <input type="number" id="sla_litige_moyenne" value="480" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 font-bold mb-1">Sévérité haute</label>
                                        <input type="number" id="sla_litige_haute" value="240" class="w-full px-2 py-1 border border-slate-200 rounded-lg text-sm font-medium" min="1">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                        <div class="text-xs text-blue-700 font-bold">
                            <strong>💡 SLA:</strong> Temps imparti pour résoudre l'incident. Les incidents avec un SLA dépassé nécessitent une escalade immédiate.
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'GestionnaireModule.saveIncidentConfig()', class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);
        },

        saveIncidentConfig() {
            // Les SLA sont appliqués directement lors de la création d'incident dans CORE.createIncident()
            // Cette config est juste pour l'affichage et la documentation
            const config = {
                retard: {
                    basse: parseInt(document.getElementById('sla_retard_basse')?.value || 480),
                    moyenne: parseInt(document.getElementById('sla_retard_moyenne')?.value || 240),
                    haute: parseInt(document.getElementById('sla_retard_haute')?.value || 120)
                },
                annulation: {
                    basse: parseInt(document.getElementById('sla_annul_basse')?.value || 240),
                    moyenne: parseInt(document.getElementById('sla_annul_moyenne')?.value || 120),
                    haute: parseInt(document.getElementById('sla_annul_haute')?.value || 60)
                },
                litige: {
                    basse: parseInt(document.getElementById('sla_litige_basse')?.value || 1440),
                    moyenne: parseInt(document.getElementById('sla_litige_moyenne')?.value || 480),
                    haute: parseInt(document.getElementById('sla_litige_haute')?.value || 240)
                }
            };

            localStorage.setItem('incident_sla_config', JSON.stringify(config));
            UI.closeModal();
            UI.toast('Configuration des SLA sauvegardée', 'success');
            App.rerender();
        },

        renderIndependentDeliveryMenApproval() {
            const myPos = CORE.state.currentUser?.pos || CORE.state.currentUser?.storeId;
            const allMen = CORE.db.independentDeliveryMen || [];
            const posFilter = dm => myPos == null || String(dm.posId) == String(myPos);
            const pending = allMen.filter(dm => dm.approvalStatus === 'pending' && posFilter(dm));
            const approved = allMen.filter(dm => dm.approvalStatus === 'approved' && posFilter(dm));
            const rejected = allMen.filter(dm => dm.approvalStatus === 'rejected' && posFilter(dm));
            const settings = CORE.getGestionnaireSettings();
            const esc = s => (s || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">👥 Approbation Livreurs Indépendants</h2>
                            <p class="text-slate-500 font-medium">Validez les demandes d'ajout de livreurs indépendants</p>
                        </div>
                    </div>

                    <!-- Toggle approbation -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-5 shadow-sm flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center">
                                <i data-lucide="shield-check" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-slate-900 text-sm">Approbation obligatoire</div>
                                <div class="text-xs text-slate-500">Les vendeurs doivent attendre votre validation</div>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="enable_approval" ${settings.independentDeliveryMenApprovalRequired ? 'checked' : ''} onchange="GestionnaireModule.saveSettingsConfig()" class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:ring-2 peer-focus:ring-cyan-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                        </label>
                    </div>

                    <!-- Statistiques -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm">
                            <div class="text-amber-700 text-xs font-black uppercase tracking-wider mb-2">En attente</div>
                            <div class="text-3xl font-black text-amber-600">${pending.length}</div>
                            <div class="text-xs text-amber-600 mt-1">À examiner</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm">
                            <div class="text-emerald-700 text-xs font-black uppercase tracking-wider mb-2">Approuvés</div>
                            <div class="text-3xl font-black text-emerald-600">${approved.length}</div>
                            <div class="text-xs text-emerald-600 mt-1">Actifs</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm">
                            <div class="text-red-700 text-xs font-black uppercase tracking-wider mb-2">Rejetés</div>
                            <div class="text-3xl font-black text-red-600">${rejected.length}</div>
                            <div class="text-xs text-red-600 mt-1">Refusés</div>
                        </div>
                    </div>

                    <!-- Demandes en attente -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100">
                            <h3 class="text-xl font-black text-slate-900">⏳ En attente d'approbation</h3>
                        </div>
                        ${pending.length === 0 ?
                            `<div class="p-12 text-center text-slate-400 italic">Aucune demande en attente</div>` :
                            `<div class="divide-y divide-slate-100">
                                ${pending.map(dm => `
                                    <div class="p-6 hover:bg-slate-50 transition flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-3 mb-2">
                                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-400 to-amber-600 flex items-center justify-center text-white font-black text-lg">
                                                    ${dm.name.charAt(0).toUpperCase()}
                                                </div>
                                                <div>
                                                    <div class="font-black text-slate-900 text-lg">${dm.name}</div>
                                                    <div class="text-sm text-slate-600">📞 ${dm.phone}</div>
                                                </div>
                                            </div>
                                            <div class="mt-3 space-y-2 text-sm">
                                                <div class="text-slate-700"><strong>Vendeur:</strong> ${dm.vendeurName}</div>
                                                ${dm.notes ? `<div class="text-slate-600 italic">📝 ${dm.notes}</div>` : ''}
                                                <div class="text-xs text-slate-500">Créé: ${CORE.formatDate(dm.createdAt)}</div>
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="GestionnaireModule.approveLivreur('${dm.id}')" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black text-sm hover:bg-emerald-700 transition flex items-center gap-2">
                                                <i data-lucide="check-circle" class="w-4 h-4"></i>
                                                Approuver
                                            </button>
                                            <button onclick="GestionnaireModule.showRejectModal('${dm.id}', '${esc(dm.name)}')" class="px-4 py-2 bg-red-600 text-white rounded-xl font-black text-sm hover:bg-red-700 transition flex items-center gap-2">
                                                <i data-lucide="x-circle" class="w-4 h-4"></i>
                                                Rejeter
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>

                    <!-- Approuvés -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100">
                            <h3 class="text-xl font-black text-slate-900">✅ Livreurs approuvés</h3>
                        </div>
                        ${approved.length === 0 ?
                            `<div class="p-12 text-center text-slate-400 italic">Aucun livreur approuvé</div>` :
                            `<div class="divide-y divide-slate-100">
                                ${approved.map(dm => `
                                    <div class="p-6 hover:bg-slate-50 transition flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-3 mb-2">
                                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center text-white font-black text-lg">
                                                    ${dm.name.charAt(0).toUpperCase()}
                                                </div>
                                                <div>
                                                    <div class="font-black text-slate-900 text-lg">${dm.name}</div>
                                                    <div class="text-sm text-slate-600">📞 ${dm.phone}</div>
                                                </div>
                                            </div>
                                            <div class="mt-3 space-y-2 text-sm">
                                                <div class="text-slate-700"><strong>Vendeur:</strong> ${dm.vendeurName}</div>
                                                <div class="text-slate-600"><strong>Livraisons:</strong> ${dm.deliveryCount}</div>
                                                <div class="text-xs text-slate-500">Approuvé: ${CORE.formatDate(dm.approvedAt)}</div>
                                            </div>
                                        </div>
                                        <button onclick="GestionnaireModule.rejectApprovedLivreur('${dm.id}')" class="px-4 py-2 bg-red-100 text-red-700 rounded-xl font-black text-sm hover:bg-red-200 transition">
                                            Retirer
                                        </button>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>

                    <!-- Rejetés -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100">
                            <h3 class="text-xl font-black text-slate-900">❌ Livreurs rejetés</h3>
                        </div>
                        ${rejected.length === 0 ?
                            `<div class="p-12 text-center text-slate-400 italic">Aucun livreur rejeté</div>` :
                            `<div class="divide-y divide-slate-100">
                                ${rejected.map(dm => `
                                    <div class="p-6 hover:bg-slate-50 transition">
                                        <div class="flex items-start gap-3 mb-2">
                                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center text-white font-black text-lg">
                                                ${dm.name.charAt(0).toUpperCase()}
                                            </div>
                                            <div class="flex-1">
                                                <div class="font-black text-slate-900 text-lg">${dm.name}</div>
                                                <div class="text-sm text-slate-600">📞 ${dm.phone}</div>
                                            </div>
                                        </div>
                                        <div class="mt-3 space-y-2 text-sm">
                                            <div class="text-slate-700"><strong>Vendeur:</strong> ${dm.vendeurName}</div>
                                            ${dm.rejectionReason ? `<div class="p-3 bg-red-50 rounded-lg text-red-700 font-medium">Raison: ${dm.rejectionReason}</div>` : ''}
                                            <div class="text-xs text-slate-500">Rejeté: ${CORE.formatDate(dm.rejectedAt)}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                </div>`;
        },

        approveLivreur(deliveryManId) {
            if (CORE.approveIndependentDeliveryMan(deliveryManId)) {
                UI.toast('Livreur approuvé avec succès', 'success');
                this.state.currentView = 'deliverymen';
                App.rerender();
            }
        },

        showRejectModal(deliveryManId, deliveryManName) {
            UI.modal(`Rejeter ${deliveryManName}`, `
                <div class="space-y-4">
                    <div class="p-4 bg-red-50 border border-red-200 rounded-2xl">
                        <div class="text-sm text-red-700">
                            Vous êtes sur le point de rejeter ce livreur. Veuillez fournir une raison.
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Raison du rejet</label>
                        <textarea id="reject_reason" placeholder="Ex: Numéro de téléphone invalide, documents manquants..." class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-red-500" rows="3"></textarea>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Rejeter', onclick: `GestionnaireModule.rejectLivreur('${deliveryManId}')`, class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);
        },

        rejectLivreur(deliveryManId) {
            const reason = UI.val('reject_reason') || '';
            if (CORE.rejectIndependentDeliveryMan(deliveryManId, reason)) {
                UI.closeModal();
                UI.toast('Livreur rejeté', 'success');
                this.state.currentView = 'deliverymen';
                App.rerender();
            }
        },

        rejectApprovedLivreur(deliveryManId) {
            if (!confirm('Êtes-vous sûr de vouloir retirer ce livreur approuvé?')) return;
            if (CORE.rejectIndependentDeliveryMan(deliveryManId, 'Retiré par gestionnaire')) {
                UI.toast('Livreur retiré', 'success');
                this.state.currentView = 'deliverymen';
                App.rerender();
            }
        },

        saveSettingsConfig() {
            const enableApproval = document.getElementById('enable_approval')?.checked ?? true;

            // Merge — don't wipe other settings
            CORE.setGestionnaireSettings({ independentDeliveryMenApprovalRequired: enableApproval });
            UI.toast('Paramètre d\'approbation enregistré', 'success');
            App.rerender();
        },

        getDashboardMetrics() {
            const posId = CORE.state.currentUser?.pos;
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            const visibleOrders = CORE.getVisibleOrders() || [];
            const visibleDeliveries = CORE.getVisibleDeliveries() || [];

            // Commandes du jour
            const ordersToday = visibleOrders.filter(o => {
                const oTime = o.createdAt ? new Date(o.createdAt) : null;
                return o.posId === posId && oTime && oTime >= startOfDay && oTime <= now;
            });

            // Revenu du jour
            const revenueToday = ordersToday.reduce((sum, o) => sum + (o.totalAmount || 0), 0);

            // Livraisons du jour
            const deliveriesToday = visibleDeliveries.filter(d => {
                const dTime = d.createdAt ? new Date(d.createdAt) : null;
                return d.posId === posId && dTime && dTime >= startOfDay && dTime <= now;
            });

            const deliveriesSucceeded = deliveriesToday.filter(d => d.status === 'livree').length;
            const deliverySuccessRate = deliveriesToday.length > 0 ? Math.round((deliveriesSucceeded / deliveriesToday.length) * 100) : 0;

            // Tendance 7 jours
            const ordersLast7 = visibleOrders.filter(o => {
                const oTime = o.createdAt ? new Date(o.createdAt) : null;
                return o.posId === posId && oTime && oTime >= sevenDaysAgo && oTime <= now;
            });
            const ordersPerDay7 = (ordersLast7.length / 7).toFixed(1);

            // Tendance 30 jours
            const ordersLast30 = visibleOrders.filter(o => {
                const oTime = o.createdAt ? new Date(o.createdAt) : null;
                return o.posId === posId && oTime && oTime >= thirtyDaysAgo && oTime <= now;
            });
            const totalRevenue30 = ordersLast30.reduce((sum, o) => sum + (o.totalAmount || 0), 0);

            // Commandes en cours
            const ordersPending = ordersToday.filter(o => ['pending', 'confirmed', 'preparing'].includes(o.status)).length;

            // Incidents
            const incidents = (CORE.db.incidents || []).filter(i => i.posId === posId && !i.resolved);

            return {
                ordersToday: ordersToday.length,
                revenueToday,
                deliverySuccessRate,
                ordersPerDay7,
                totalRevenue30,
                ordersPending,
                incidentsOpen: incidents.length,
                deliveriesToday: deliveriesToday.length
            };
        },

        renderDashboard() {
            const posId = CORE.state.currentUser?.pos;
            const pos = CORE.getPOS(posId);
            const metrics = this.getDashboardMetrics();
            const now = new Date();
            const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const visibleOrders = CORE.getVisibleOrders() || [];

            return `
                <div class="fade-in space-y-6">
                    <!-- En-tête avec heure -->
                    <div class="flex items-start justify-between">
                        <div>
                            <h1 class="text-3xl font-black text-slate-900">📊 Tableau de bord</h1>
                            <p class="text-slate-500 font-medium mt-1">${pos ? pos.name : 'POS'} • Mise à jour: ${timeStr}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-400">${now.toLocaleDateString('fr-FR')}</div>
                            <div class="text-2xl font-black text-slate-900 mt-1">${timeStr}</div>
                        </div>
                    </div>

                    <!-- Cartes de synthèse principales -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <!-- Commandes du jour -->
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-2xl p-6 shadow-sm">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-blue-600 text-sm font-bold uppercase tracking-wider">Commandes</p>
                                    <p class="text-4xl font-black text-slate-900 mt-2">${metrics.ordersToday}</p>
                                    <p class="text-xs text-blue-700 mt-3">📈 ${metrics.ordersPerDay7}/jour (moy 7j)</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-200 rounded-xl flex items-center justify-center text-blue-600">
                                    <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Revenu du jour -->
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 border border-emerald-200 rounded-2xl p-6 shadow-sm">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-emerald-600 text-sm font-bold uppercase tracking-wider">Revenu jour</p>
                                    <p class="text-4xl font-black text-slate-900 mt-2">${CORE.formatPrice(metrics.revenueToday)}</p>
                                    <p class="text-xs text-emerald-700 mt-3">📊 ${CORE.formatPrice(metrics.totalRevenue30 / 30)}/jour (moy 30j)</p>
                                </div>
                                <div class="w-12 h-12 bg-emerald-200 rounded-xl flex items-center justify-center text-emerald-600">
                                    <i data-lucide="trending-up" class="w-6 h-6"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Taux réussite livraisons -->
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 border border-amber-200 rounded-2xl p-6 shadow-sm">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-amber-600 text-sm font-bold uppercase tracking-wider">Livraisons</p>
                                    <p class="text-4xl font-black text-slate-900 mt-2">${metrics.deliverySuccessRate}%</p>
                                    <p class="text-xs text-amber-700 mt-3">${metrics.deliveriesToday} course${metrics.deliveriesToday > 1 ? 's' : ''} (${metrics.deliveriesSucceeded} réussies)</p>
                                </div>
                                <div class="w-12 h-12 bg-amber-200 rounded-xl flex items-center justify-center text-amber-600">
                                    <i data-lucide="truck" class="w-6 h-6"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Incidents ouverts -->
                        <div class="bg-gradient-to-br from-red-50 to-red-100 border ${metrics.incidentsOpen > 0 ? 'border-red-300' : 'border-red-200'} rounded-2xl p-6 shadow-sm">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-red-600 text-sm font-bold uppercase tracking-wider">Incidents</p>
                                    <p class="text-4xl font-black text-slate-900 mt-2">${metrics.incidentsOpen}</p>
                                    <p class="text-xs text-red-700 mt-3">${metrics.ordersPending} commande${metrics.ordersPending > 1 ? 's' : ''} en attente</p>
                                </div>
                                <div class="w-12 h-12 bg-red-200 rounded-xl flex items-center justify-center text-red-600">
                                    <i data-lucide="alert-circle" class="w-6 h-6"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Graphiques de tendance -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Tendance commandes 7 jours -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-black text-slate-900">📈 Commandes (7 derniers jours)</h3>
                                <span class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold">Tendance</span>
                            </div>
                            <div class="h-48 flex items-end justify-around gap-2">
                                ${Array.from({length: 7}).map((_, i) => {
                                    const date = new Date(new Date().getTime() - (6 - i) * 24 * 60 * 60 * 1000);
                                    const startOfDay = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                                    const endOfDay = new Date(startOfDay.getTime() + 24 * 60 * 60 * 1000);
                                    const posId = CORE.state.currentUser?.pos;
                                    const dayOrders = visibleOrders.filter(o => {
                                        const oTime = o.createdAt ? new Date(o.createdAt) : null;
                                        return o.posId === posId && oTime && oTime >= startOfDay && oTime < endOfDay;
                                    });
                                    const maxHeight = 100;
                                    const height = Math.max(10, (dayOrders.length / (metrics.ordersToday || 1)) * maxHeight);
                                    return `
                                        <div class="flex flex-col items-center gap-1">
                                            <div class="w-6 bg-gradient-to-t from-blue-500 to-blue-400 rounded-t transition hover:from-blue-600 hover:to-blue-500" style="height: ${height}%;" title="${dayOrders.length} cmd"></div>
                                            <span class="text-[10px] text-slate-500 font-bold">${['L', 'M', 'M', 'J', 'V', 'S', 'D'][date.getDay()]}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Tendance revenu 30 jours -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-black text-slate-900">💰 Revenu (30 derniers jours)</h3>
                                <span class="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full font-bold">Total</span>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-slate-600">Total 30j</span>
                                    <span class="font-black text-emerald-600">${CORE.formatPrice(metrics.totalRevenue30)}</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-3">
                                    <div class="bg-gradient-to-r from-emerald-400 to-emerald-600 h-3 rounded-full" data-width="${Math.min(100, (metrics.totalRevenue30 / 1000000) * 100)}"></div>
                                </div>
                                <div class="flex items-center justify-between pt-2">
                                    <span class="text-sm text-slate-600">Moyenne/jour</span>
                                    <span class="font-bold text-slate-900">${CORE.formatPrice(metrics.totalRevenue30 / 30)}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alertes et recommandations -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                        <h3 class="font-black text-slate-900 mb-4">🎯 Recommandations</h3>
                        <div class="space-y-2">
                            ${metrics.deliverySuccessRate < 80 ? `<div class="p-3 bg-amber-50 border border-amber-200 rounded-xl text-sm"><span class="font-bold text-amber-700">⚠️ Taux livraison:</span> <span class="text-amber-600">${metrics.deliverySuccessRate}% (cible: 80%+)</span></div>` : ''}
                            ${metrics.ordersPending > 10 ? `<div class="p-3 bg-red-50 border border-red-200 rounded-xl text-sm"><span class="font-bold text-red-700">🔴 Commandes en attente:</span> <span class="text-red-600">${metrics.ordersPending} commandes (réduire les retards)</span></div>` : ''}
                            ${metrics.incidentsOpen > 0 ? `<div class="p-3 bg-red-50 border border-red-200 rounded-xl text-sm"><span class="font-bold text-red-700">🚨 Incidents ouverts:</span> <span class="text-red-600">${metrics.incidentsOpen} incident(s) à résoudre</span></div>` : ''}
                            ${metrics.deliverySuccessRate >= 80 && metrics.ordersPending <= 10 && metrics.incidentsOpen === 0 ? `<div class="p-3 bg-emerald-50 border border-emerald-200 rounded-xl text-sm"><span class="font-bold text-emerald-700">✅ Tout va bien!</span> <span class="text-emerald-600">Continuez comme éa!</span></div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        },

        showRoleManagementModal() {
            const customRoles = CORE.getCustomRoles();

            UI.modal('🔐 Gestion des Rôles et Permissions', `
                <div class="max-h-[600px] overflow-y-auto">
                    <div class="space-y-4">
                        <!-- Bouton créer rôle -->
                        <button onclick="GestionnaireModule.showCreateRoleModal()" class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-black hover:from-blue-700 hover:to-blue-800 transition">
                            ➕ Créer un nouveau rôle personnalisé
                        </button>

                        <!-- Rôles standard prédéfinis -->
                        <div class="bg-slate-50 rounded-2xl border border-slate-200 p-4">
                            <h3 class="font-black text-slate-900 mb-3">📋 Rôles prédéfinis</h3>
                            <div class="space-y-2">
                                <div class="p-3 rounded-lg bg-white border border-emerald-200 cursor-pointer hover:shadow-md transition" onclick="GestionnaireModule.showRoleDetails('superviseur_vendeurs', 'Superviseur Vendeurs')">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-black text-slate-900">👥 Superviseur Vendeurs</p>
                                            <p class="text-xs text-slate-500 mt-1">Gère les vendeurs et les commandes</p>
                                        </div>
                                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
                                    </div>
                                </div>
                                <div class="p-3 rounded-lg bg-white border border-blue-200 cursor-pointer hover:shadow-md transition" onclick="GestionnaireModule.showRoleDetails('responsable_livraison', 'Responsable Livraison')">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-black text-slate-900">🚚 Responsable Livraison</p>
                                            <p class="text-xs text-slate-500 mt-1">Gère les livraisons et les incidents</p>
                                        </div>
                                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
                                    </div>
                                </div>
                                <div class="p-3 rounded-lg bg-white border border-amber-200 cursor-pointer hover:shadow-md transition" onclick="GestionnaireModule.showRoleDetails('superviseur_stocks', 'Superviseur Stocks')">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-black text-slate-900">📦 Superviseur Stocks</p>
                                            <p class="text-xs text-slate-500 mt-1">Gère les stocks et la réconciliation</p>
                                        </div>
                                        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rôles personnalisés -->
                        ${customRoles.length > 0 ? `
                            <div class="bg-slate-50 rounded-2xl border border-slate-200 p-4">
                                <h3 class="font-black text-slate-900 mb-3">⚙️ Rôles personnalisés (${customRoles.length})</h3>
                                <div class="space-y-2">
                                    ${customRoles.map(role => `
                                        <div class="p-3 rounded-lg bg-white border border-slate-200 hover:shadow-md transition">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <p class="font-black text-slate-900">${role.name}</p>
                                                    <p class="text-xs text-slate-500 mt-1">Base: ${role.baseRole === 'superviseur_vendeurs' ? '👥 Superviseur Vendeurs' : role.baseRole === 'responsable_livraison' ? '🚚 Responsable Livraison' : '📦 Superviseur Stocks'}</p>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <button onclick="GestionnaireModule.showEditRoleModal('${role.id}')" class="text-blue-600 font-black text-xs hover:text-blue-700">Éditer</button>
                                                    <button onclick="GestionnaireModule.deleteRole('${role.id}')" class="text-red-600 font-black text-xs hover:text-red-700">Supprimer</button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Info -->
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-xl text-xs text-blue-700">
                            <strong>💡 Tip:</strong> Les rôles personnalisés permettent une gestion fine des permissions par utilisateur.
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showCreateRoleModal() {
            UI.modal('Créer un nouveau rôle', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-black text-slate-600 mb-2">Nom du rôle</label>
                        <input type="text" id="role_name" placeholder="Ex: Responsable Qualité" class="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-600 mb-2">Basé sur</label>
                        <select id="role_base" class="w-full px-4 py-2 border border-slate-200 rounded-xl bg-white focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Sélectionner --</option>
                            <option value="superviseur_vendeurs">👥 Superviseur Vendeurs</option>
                            <option value="responsable_livraison">🚚 Responsable Livraison</option>
                            <option value="superviseur_stocks">📦 Superviseur Stocks</option>
                        </select>
                    </div>
                    <div class="p-3 bg-amber-50 border border-amber-200 rounded-xl text-xs text-amber-700">
                        Les permissions seront préconfiguées selon le rôle de base choisi.
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Créer', onclick: 'GestionnaireModule.createRole()', class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        createRole() {
            const name = UI.val('role_name');
            const baseRole = UI.val('role_base');
            if (!name || !baseRole) return UI.toast('Tous les champs sont requis', 'warning');

            const defaultPerms = CORE.getDefaultPermissionsForRole(baseRole);
            CORE.createCustomRole(name, baseRole, defaultPerms);

            // Log audit action
            CORE.logAuditAction('ROLE_CREATE', {
                roleName: name,
                baseRole: baseRole,
                permissions: Object.keys(defaultPerms),
                reversible: true
            });

            UI.closeModal();
            UI.toast(`Rôle "${name}" créé`, 'success');
            App.rerender();
        },

        deleteRole(roleId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce rôle?')) return;
            CORE.deleteCustomRole(roleId);

            // Log audit action
            CORE.logAuditAction('ROLE_DELETE', {
                roleId: roleId,
                reversible: true
            });

            UI.toast('Rôle supprimé', 'success');
            App.rerender();
        },

        showRoleDetails(baseRole, roleName) {
            const perms = CORE.getDefaultPermissionsForRole(baseRole);
            const permLabels = {
                dashboard: '📊 Tableau de bord',
                stocks: '📦 Gestion stocks',
                deliveries: '🚚 Suivi livraisons',
                team: '👥 Équipe',
                planning: '📅 Planification',
                reports: '📈 Rapports',
                reconciliation: '💰 Réconciliation',
                auditlog: '📋 Journal d\'audit',
                incidents: '⚠️ Centre d\'Incidents',
                settings: '⚙️ Paramètres',
                createUsers: '➕ Créer utilisateurs',
                editUsers: '✏️ Éditer utilisateurs',
                deleteUsers: '🗑️ Supprimer utilisateurs',
                manageRoles: '🔐 Gérer les rôles',
                viewFinances: '💳 Voir les finances',
                exportReports: '📤 Exporter les rapports',
                approveOrders: '✅ Approuver les commandes',
                resolveIncidents: '🔧 Résoudre les incidents'
            };

            const permGrid = Object.entries(perms).map(([key, val]) => `
                <div class="flex items-center gap-2">
                    ${val ? `<i data-lucide="check-circle" class="w-4 h-4 text-emerald-600"></i>` : `<i data-lucide="circle" class="w-4 h-4 text-slate-300"></i>`}
                    <span class="text-sm ${val ? 'text-slate-900 font-black' : 'text-slate-400'}">${permLabels[key]}</span>
                </div>
            `).join('');

            UI.modal(`📋 Détails: ${roleName}`, `
                <div class="space-y-3">
                    <div class="grid grid-cols-1 gap-2">
                        ${permGrid}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showEditRoleModal(roleId) {
            const roles = CORE.getCustomRoles();
            const role = roles.find(r => r.id === roleId);
            if (!role) return;

            const perms = role.permissions || {};
            const permLabels = {
                dashboard: '📊 Tableau de bord',
                stocks: '📦 Gestion stocks',
                deliveries: '🚚 Suivi livraisons',
                team: '👥 Équipe',
                planning: '📅 Planification',
                reports: '📈 Rapports',
                reconciliation: '💰 Réconciliation',
                auditlog: '📋 Journal d\'audit',
                incidents: '⚠️ Centre d\'Incidents',
                settings: '⚙️ Paramètres',
                createUsers: '➕ Créer utilisateurs',
                editUsers: '✏️ Éditer utilisateurs',
                deleteUsers: '🗑️ Supprimer utilisateurs',
                manageRoles: '🔐 Gérer les rôles',
                viewFinances: '💳 Voir les finances',
                exportReports: '📤 Exporter les rapports',
                approveOrders: '✅ Approuver les commandes',
                resolveIncidents: '🔧 Résoudre les incidents'
            };

            UI.modal(`Éditer: ${role.name}`, `
                <div class="max-h-96 overflow-y-auto space-y-2">
                    ${Object.entries(permLabels).map(([key, label]) => `
                        <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50 cursor-pointer">
                            <input type="checkbox" id="perm_${key}" ${perms[key] ? 'checked' : ''} class="w-4 h-4">
                            <span class="text-sm font-black text-slate-900">${label}</span>
                        </label>
                    `).join('')}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: `GestionnaireModule.saveRoleChanges('${roleId}')`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        saveRoleChanges(roleId) {
            const permLabels = {
                dashboard: '📊 Tableau de bord',
                stocks: '📦 Gestion stocks',
                deliveries: '🚚 Suivi livraisons',
                team: '👥 Équipe',
                planning: '📅 Planification',
                reports: '📈 Rapports',
                reconciliation: '💰 Réconciliation',
                auditlog: '📋 Journal d\'audit',
                incidents: '⚠️ Centre d\'Incidents',
                settings: '⚙️ Paramètres',
                createUsers: '➕ Créer utilisateurs',
                editUsers: '✏️ Éditer utilisateurs',
                deleteUsers: '🗑️ Supprimer utilisateurs',
                manageRoles: '🔐 Gérer les rôles',
                viewFinances: '💳 Voir les finances',
                exportReports: '📤 Exporter les rapports',
                approveOrders: '✅ Approuver les commandes',
                resolveIncidents: '🔧 Résoudre les incidents'
            };

            const newPerms = {};
            Object.keys(permLabels).forEach(key => {
                newPerms[key] = document.getElementById('perm_' + key)?.checked || false;
            });

            CORE.updateCustomRole(roleId, { permissions: newPerms });

            // Log audit action
            CORE.logAuditAction('ROLE_UPDATE', {
                roleId: roleId,
                updatedPermissions: Object.keys(newPerms).filter(k => newPerms[k]),
                reversible: true
            });

            UI.closeModal();
            UI.toast('Rôle mis à jour', 'success');
            App.rerender();
        },

        showCustomReportBuilder() {
            const posId = CORE.state.currentUser?.pos;
            const today = new Date().toISOString().split('T')[0];
            const thirtyDaysAgo = new Date(new Date().getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            UI.modal('📊 Générateur de Rapports Personnalisés', `
                <div class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- Période -->
                    <div class="p-4 border border-slate-200 rounded-2xl">
                        <h3 class="font-black text-slate-900 mb-3">📅 Sélection de la période</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-600 mb-1">Du</label>
                                <input type="date" id="report_from" value="${thirtyDaysAgo}" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-600 mb-1">Au</label>
                                <input type="date" id="report_to" value="${today}" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- Métriques -->
                    <div class="p-4 border border-slate-200 rounded-2xl">
                        <h3 class="font-black text-slate-900 mb-3">📈 Sélection des métriques</h3>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="metric_orders" checked class="w-4 h-4">
                                <span class="text-sm font-black text-slate-900">📦 Commandes</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="metric_deliveries" checked class="w-4 h-4">
                                <span class="text-sm font-black text-slate-900">🚚 Livraisons</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="metric_revenue" checked class="w-4 h-4">
                                <span class="text-sm font-black text-slate-900">💰 Revenus</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="metric_stocks" class="w-4 h-4">
                                <span class="text-sm font-black text-slate-900">📦 Stocks</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="metric_incidents" class="w-4 h-4">
                                <span class="text-sm font-black text-slate-900">⚠️ Incidents</span>
                            </label>
                        </div>
                    </div>

                    <!-- Format export -->
                    <div class="p-4 border border-slate-200 rounded-2xl">
                        <h3 class="font-black text-slate-900 mb-3">💾 Format d'export</h3>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="export_format" value="csv" checked class="w-4 h-4">
                                <span class="text-sm font-black text-slate-900">📊 CSV (Excel)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="export_format" value="json" class="w-4 h-4">
                                <span class="text-sm font-black text-slate-900">📄 JSON</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="export_format" value="html" class="w-4 h-4">
                                <span class="text-sm font-black text-slate-900">🖨️ HTML (Impression)</span>
                            </label>
                        </div>
                    </div>

                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-xl text-xs text-blue-700">
                        <strong>💡 Conseil:</strong> Sélectionnez les métriques pertinentes pour réduire la taille du rapport.
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Générer le rapport', onclick: 'GestionnaireModule.generateCustomReport()', class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        generateCustomReport() {
            const posId = CORE.state.currentUser?.pos;
            const from = UI.val('report_from');
            const to = UI.val('report_to');
            const format = document.querySelector('input[name="export_format"]:checked')?.value || 'csv';

            const metrics = [];
            if (document.getElementById('metric_orders')?.checked) metrics.push('orders');
            if (document.getElementById('metric_deliveries')?.checked) metrics.push('deliveries');
            if (document.getElementById('metric_revenue')?.checked) metrics.push('revenue');
            if (document.getElementById('metric_stocks')?.checked) metrics.push('stocks');
            if (document.getElementById('metric_incidents')?.checked) metrics.push('incidents');

            if (metrics.length === 0) return UI.toast('Sélectionnez au moins une métrique', 'warning');
            if (!from || !to) return UI.toast('Sélectionnez une période', 'warning');

            const reportData = CORE.generateReportData(posId, from, to, metrics);

            // Log audit action
            CORE.logAuditAction('REPORT_GENERATED', {
                dateFrom: from,
                dateTo: to,
                metrics: metrics.join(', '),
                format: format,
                reversible: false
            });

            UI.closeModal();
            UI.toast('Rapport généré avec succès', 'success');

            if (format === 'csv') {
                const csv = CORE.exportToCSV(reportData);
                const filename = `rapport_${from}_${to}.csv`;
                CORE.downloadFile(csv, filename, 'text/csv;charset=utf-8;');
            } else if (format === 'json') {
                const json = CORE.exportToJSON(reportData);
                const filename = `rapport_${from}_${to}.json`;
                CORE.downloadFile(json, filename, 'application/json;charset=utf-8;');
            } else if (format === 'html') {
                this.exportToHTML(reportData);
            }
        },

        exportToHTML(reportData) {
            const getHtmlContent = () => {
                let html = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${reportData.reportTitle}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: white; }
        h1 { color: #1e293b; border-bottom: 3px solid #3b82f6; padding-bottom: 10px; }
        h2 { color: #475569; margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { padding: 10px; text-align: left; border: 1px solid #e2e8f0; }
        th { background-color: #f1f5f9; font-weight: bold; }
        tr:nth-child(even) { background-color: #f8fafc; }
        .metric-card { background: #f0f9ff; border: 1px solid #e0f2fe; border-radius: 8px; padding: 15px; margin: 10px 0; }
        .metric-label { font-weight: bold; color: #0369a1; }
        .metric-value { font-size: 24px; color: #1e293b; font-weight: bold; }
        .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #64748b; }
        @media print { body { margin: 0; } }
    </style>
</head>
<body>
    <h1>📊 ${reportData.reportTitle}</h1>
    <p><strong>Période:</strong> ${reportData.period.from} au ${reportData.period.to}</p>
    <p><strong>Généré le:</strong> ${new Date().toLocaleString('fr-FR')}</p>`;

                // Commandes
                if (reportData.metrics.orders) {
                    const o = reportData.metrics.orders;
                    html += `
    <h2>📦 Commandes</h2>
    <div class="metric-card">
        <div class="metric-label">Total des commandes</div>
        <div class="metric-value">${o.total}</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Montant total</div>
        <div class="metric-value">${CORE.formatPrice(o.totalAmount)}</div>
    </div>`;
                    if (Object.keys(o.byVendor || {}).length > 0) {
                        html += `<table>
        <thead><tr><th>Vendeur</th><th>Nombre de commandes</th></tr></thead>
        <tbody>`;
                        Object.entries(o.byVendor || {}).forEach(([v, count]) => {
                            html += `<tr><td>${v}</td><td>${count}</td></tr>`;
                        });
                        html += `</tbody></table>`;
                    }
                }

                // Livraisons
                if (reportData.metrics.deliveries) {
                    const d = reportData.metrics.deliveries;
                    html += `
    <h2>🚚 Livraisons</h2>
    <div class="metric-card">
        <div class="metric-label">Total</div>
        <div class="metric-value">${d.total}</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Taux de réussite</div>
        <div class="metric-value">${d.successRate}%</div>
    </div>`;
                }

                // Revenus
                if (reportData.metrics.revenue) {
                    const r = reportData.metrics.revenue;
                    html += `
    <h2>💰 Revenus</h2>
    <div class="metric-card">
        <div class="metric-label">Total</div>
        <div class="metric-value">${CORE.formatPrice(r.total)}</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Moyenne par jour</div>
        <div class="metric-value">${CORE.formatPrice(r.dailyAverage)}</div>
    </div>`;
                }

                // Stocks
                if (reportData.metrics.stocks) {
                    const s = reportData.metrics.stocks;
                    html += `
    <h2>📦 Stocks</h2>
    <div class="metric-card">
        <div class="metric-label">Produits en stock faible</div>
        <div class="metric-value">${s.lowStockCount}</div>
    </div>`;
                    if (s.lowStockProducts && s.lowStockProducts.length > 0) {
                        html += `<table>
        <thead><tr><th>Produit</th><th>Stock</th><th>Minimum</th></tr></thead>
        <tbody>`;
                        s.lowStockProducts.forEach(p => {
                            html += `<tr><td>${p.name}</td><td>${p.stock}</td><td>${p.min}</td></tr>`;
                        });
                        html += `</tbody></table>`;
                    }
                }

                // Incidents
                if (reportData.metrics.incidents) {
                    const i = reportData.metrics.incidents;
                    html += `
    <h2>⚠️ Incidents</h2>
    <div class="metric-card">
        <div class="metric-label">Total des incidents</div>
        <div class="metric-value">${i.total}</div>
    </div>
    <div class="metric-card">
        <div class="metric-label">Taux de résolution</div>
        <div class="metric-value">${i.resolutionRate}%</div>
    </div>`;
                }

                html += `
    <div class="footer">
        <p>Rapport généré automatiquement par ${CORE.getCompanyName()}</p>
    </div>
</body>
</html>`;
                return html;
            };

            const html = getHtmlContent();
            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
        },

        showAuditTrail() {
            const auditLog = CORE.getAuditLog();
            const stats = CORE.getAuditStats();

            let content = `
                <div class="space-y-4 max-h-[700px] overflow-y-auto">
                    <!-- Statistics -->
                    <div class="grid grid-cols-4 gap-3">
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-xl text-center">
                            <div class="text-lg font-black text-blue-600">${stats.totalActions}</div>
                            <div class="text-xs text-blue-600">Total actions</div>
                        </div>
                        <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-xl text-center">
                            <div class="text-lg font-black text-emerald-600">${stats.actionsLast24h}</div>
                            <div class="text-xs text-emerald-600">Last 24h</div>
                        </div>
                        <div class="p-3 bg-amber-50 border border-amber-200 rounded-xl text-center">
                            <div class="text-lg font-black text-amber-600">${stats.actionsLast7d}</div>
                            <div class="text-xs text-amber-600">Last 7 days</div>
                        </div>
                        <div class="p-3 bg-red-50 border border-red-200 rounded-xl text-center">
                            <div class="text-lg font-black text-red-600">${stats.reversedActions}</div>
                            <div class="text-xs text-red-600">Reversed</div>
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="flex gap-2">
                        <input type="text" id="audit_search" placeholder="🔍 Rechercher une action..." class="flex-1 px-3 py-2 border border-slate-200 rounded-xl text-sm"
                            onkeyup="GestionnaireModule.filterAuditLog(this.value)">
                    </div>

                    <!-- Audit Log Entries -->
                    <div id="audit_entries" class="space-y-2">
            `;

            if (auditLog.length === 0) {
                content += `<div class="p-4 text-center text-slate-500">Aucune action enregistrée</div>`;
            } else {
                auditLog.forEach(entry => {
                    const date = new Date(entry.timestamp);
                    const timeStr = date.toLocaleString('fr-FR');
                    const isReversed = entry.status === 'reversed';
                    const canReverse = entry.reversible && entry.status === 'completed';

                    let actionColor = 'bg-blue-50 border-blue-200';
                    if (entry.action.includes('DELETE')) actionColor = 'bg-red-50 border-red-200';
                    else if (entry.action.includes('CREATE')) actionColor = 'bg-emerald-50 border-emerald-200';
                    else if (entry.action.includes('UPDATE')) actionColor = 'bg-amber-50 border-amber-200';
                    else if (entry.action.includes('REVERSE')) actionColor = 'bg-purple-50 border-purple-200';

                    content += `
                        <div class="p-3 border rounded-xl ${actionColor} ${isReversed ? 'opacity-50' : ''}">
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex-1 min-w-0">
                                    <div class="font-black text-slate-900 text-sm">${entry.action}</div>
                                    <div class="text-xs text-slate-600 mt-1">
                                        <div>👤 ${entry.userName} (${entry.userRole})</div>
                                        <div>🕐 ${timeStr}</div>
                                    </div>
                                    ${Object.keys(entry.details || {}).length > 0 ? `
                                        <div class="mt-2 p-2 bg-white bg-opacity-50 rounded text-xs text-slate-700">
                                            ${Object.entries(entry.details).map(([k, v]) =>
                                                `<div><strong>${k}:</strong> ${typeof v === 'object' ? JSON.stringify(v) : v}</div>`
                                            ).join('')}
                                        </div>
                                    ` : ''}
                                    ${isReversed ? `<div class="mt-2 text-xs font-black text-purple-600">✓ Annulé</div>` : ''}
                                </div>
                                ${canReverse ? `
                                    <button onclick="GestionnaireModule.reverseAuditAction('${entry.id}')" class="px-3 py-1 bg-red-500 text-white rounded text-xs font-black hover:bg-red-600 transition whitespace-nowrap">
                                        Annuler
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            content += `
                    </div>
                </div>
            `;

            UI.modal('📋 Journal d\'Audit Complet', content, [
                { label: 'Fermer', onclick: 'UI.closeModal()' },
                { label: '📥 Exporter l\'audit', onclick: 'GestionnaireModule.exportAuditLog()', class: 'px-4 py-2 bg-slate-600 text-white font-black rounded-xl hover:bg-slate-700 transition text-sm' }
            ]);
        },

        filterAuditLog(searchTerm) {
            const filtered = searchTerm ? CORE.searchAuditLog(searchTerm) : CORE.getAuditLog();
            const entriesContainer = document.getElementById('audit_entries');

            if (!entriesContainer) return;

            let html = '';
            if (filtered.length === 0) {
                html = `<div class="p-4 text-center text-slate-500">Aucune action trouvée</div>`;
            } else {
                filtered.forEach(entry => {
                    const date = new Date(entry.timestamp);
                    const timeStr = date.toLocaleString('fr-FR');
                    const isReversed = entry.status === 'reversed';
                    const canReverse = entry.reversible && entry.status === 'completed';

                    let actionColor = 'bg-blue-50 border-blue-200';
                    if (entry.action.includes('DELETE')) actionColor = 'bg-red-50 border-red-200';
                    else if (entry.action.includes('CREATE')) actionColor = 'bg-emerald-50 border-emerald-200';
                    else if (entry.action.includes('UPDATE')) actionColor = 'bg-amber-50 border-amber-200';
                    else if (entry.action.includes('REVERSE')) actionColor = 'bg-purple-50 border-purple-200';

                    html += `
                        <div class="p-3 border rounded-xl ${actionColor} ${isReversed ? 'opacity-50' : ''}">
                            <div class="flex items-start justify-between gap-2">
                                <div class="flex-1 min-w-0">
                                    <div class="font-black text-slate-900 text-sm">${entry.action}</div>
                                    <div class="text-xs text-slate-600 mt-1">
                                        <div>👤 ${entry.userName} (${entry.userRole})</div>
                                        <div>🕐 ${timeStr}</div>
                                    </div>
                                    ${Object.keys(entry.details || {}).length > 0 ? `
                                        <div class="mt-2 p-2 bg-white bg-opacity-50 rounded text-xs text-slate-700">
                                            ${Object.entries(entry.details).map(([k, v]) =>
                                                `<div><strong>${k}:</strong> ${typeof v === 'object' ? JSON.stringify(v) : v}</div>`
                                            ).join('')}
                                        </div>
                                    ` : ''}
                                    ${isReversed ? `<div class="mt-2 text-xs font-black text-purple-600">✓ Annulé</div>` : ''}
                                </div>
                                ${canReverse ? `
                                    <button onclick="GestionnaireModule.reverseAuditAction('${entry.id}')" class="px-3 py-1 bg-red-500 text-white rounded text-xs font-black hover:bg-red-600 transition whitespace-nowrap">
                                        Annuler
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            entriesContainer.innerHTML = html;
        },

        reverseAuditAction(auditId) {
            if (!confirm('Êtes-vous sûr de vouloir annuler cette action?')) return;

            const result = CORE.reverseAuditAction(auditId);
            if (result.success) {
                UI.toast('Action annulée avec succès', 'success');
                this.showAuditTrail();
            } else {
                UI.toast(result.message, 'error');
            }
        },

        exportAuditLog() {
            const auditLog = CORE.getAuditLog();
            const csv = ['Timestamp,User,Role,Action,Details,Status'].concat(
                auditLog.map(entry => {
                    const details = Object.entries(entry.details || {})
                        .map(([k, v]) => `${k}:${v}`)
                        .join('|');
                    return `"${entry.timestamp}","${entry.userName}","${entry.userRole}","${entry.action}","${details}","${entry.status}"`;
                })
            ).join('\n');

            const filename = `audit_log_${new Date().toISOString().split('T')[0]}.csv`;
            CORE.downloadFile(csv, filename, 'text/csv;charset=utf-8;');
            UI.toast('Audit log exporté', 'success');
        },

        renderFinance() {
            const view = this.state.financeView || 'overview';

            return view === 'overview' ? this.renderFinanceGestionnaire() :
                   view === 'transactions' ? this.renderFinanceTransactionsGestionnaire() :
                   view === 'income' ? this.renderFinanceIncomeGestionnaire() :
                   view === 'expenses' ? this.renderFinanceExpensesGestionnaire() :
                   this.renderFinanceGestionnaire();
        },

        renderFinanceTransactionsGestionnaire() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.state.currentUser?.pos;
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'Mon POS';
            const dateFrom = CORE.state.financeDateFrom || '';
            const dateTo = CORE.state.financeDateTo || '';

            let allTxs = CORE.getVisibleTransactions().filter(t => t.posId == userPos) || [];
            if (dateFrom) allTxs = allTxs.filter(t => new Date(t.createdAt) >= new Date(dateFrom));
            if (dateTo) allTxs = allTxs.filter(t => new Date(t.createdAt) <= new Date(dateTo));
            allTxs = allTxs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="GestionnaireModule.state.currentView = 'finance'; GestionnaireModule.state.financeView = '${v}'; App.rerender()" class="px-3 py-2 rounded-lg font-bold text-xs transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-cyan-500 to-teal-600 text-white shadow-lg shadow-cyan-500/30' : 'bg-slate-400/10 text-slate-400 hover:bg-slate-400/20 border border-slate-400/30'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-5">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-teal-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-cyan-500/30">
                                    <i data-lucide="list" class="w-6 h-6"></i>
                                </div>
                                Transactions - ${posName}
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Liste complète des transactions financières</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aperçu', 'layout-grid')}
                            ${navBtn('transactions', 'Transactions', 'list', true)}
                            ${navBtn('income', 'Revenus', 'trending-up')}
                            ${navBtn('expenses', 'Dépenses', 'trending-down')}
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="p-6 border-b border-slate-100">
                            <div class="flex flex-wrap items-center gap-4">
                                <div class="flex-1 min-w-[150px]">
                                    <input type="date" value="${dateFrom}"
                                        onchange="CORE.state.financeDateFrom = this.value; App.rerender()"
                                        class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none font-medium" placeholder="Du">
                                </div>
                                <div class="flex-1 min-w-[150px]">
                                    <input type="date" value="${dateTo}"
                                        onchange="CORE.state.financeDateTo = this.value; App.rerender()"
                                        class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none font-medium" placeholder="Au">
                                </div>
                                <button onclick="CORE.state.financeDateFrom=''; CORE.state.financeDateTo=''; App.rerender()" class="px-4 py-2.5 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-200 transition">
                                    Réinitialiser
                                </button>
                            </div>
                        </div>

                        ${allTxs.length === 0 ? `
                            <div class="p-12 text-center">
                                <div class="text-5xl mb-2">📭</div>
                                <p class="text-slate-500 font-medium">Aucune transaction enregistrée</p>
                            </div>
                        ` : `
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-slate-50 border-b border-slate-100">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-black text-slate-900 uppercase">Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-black text-slate-900 uppercase">Catégorie</th>
                                            <th class="px-6 py-3 text-left text-xs font-black text-slate-900 uppercase">Description</th>
                                            <th class="px-6 py-3 text-right text-xs font-black text-slate-900 uppercase">Montant</th>
                                            <th class="px-6 py-3 text-center text-xs font-black text-slate-900 uppercase">Type</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${allTxs.map(t => `
                                            <tr class="border-b border-slate-100 hover:bg-slate-50">
                                                <td class="px-6 py-3 text-sm font-bold text-slate-900">${CORE.formatDate(t.createdAt)}</td>
                                                <td class="px-6 py-3 text-sm font-bold text-slate-700">${t.category || 'Autre'}</td>
                                                <td class="px-6 py-3 text-sm text-slate-600">${t.note || '-'}</td>
                                                <td class="px-6 py-3 text-sm font-black text-right ${t.type === 'income' ? 'text-emerald-600' : 'text-red-600'}">${t.type === 'income' ? '+' : '-'}${CORE.formatPrice(t.amount)}</td>
                                                <td class="px-6 py-3 text-center text-xs font-black">
                                                    <span class="px-2 py-1 rounded-full text-white ${t.type === 'income' ? 'bg-emerald-500' : 'bg-red-500'}">${t.type === 'income' ? 'Revenu' : 'Dépense'}</span>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>
                </div>
            `;
        },

        renderFinanceIncomeGestionnaire() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.state.currentUser?.pos;
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'Mon POS';
            const dateFrom = CORE.state.financeDateFrom || '';
            const dateTo = CORE.state.financeDateTo || '';

            let incomeTxs = CORE.getVisibleTransactions().filter(t => t.posId == userPos && t.type === 'income') || [];
            if (dateFrom) incomeTxs = incomeTxs.filter(t => new Date(t.createdAt) >= new Date(dateFrom));
            if (dateTo) incomeTxs = incomeTxs.filter(t => new Date(t.createdAt) <= new Date(dateTo));

            const incomeByCategory = {};
            incomeTxs.forEach(t => {
                const cat = t.category || 'autre';
                incomeByCategory[cat] = (incomeByCategory[cat] || 0) + (t.amount || 0);
            });
            const totalIncome = Object.values(incomeByCategory).reduce((a, b) => a + b, 0);

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="GestionnaireModule.state.currentView = 'finance'; GestionnaireModule.state.financeView = '${v}'; App.rerender()" class="px-3 py-2 rounded-lg font-bold text-xs transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-cyan-500 to-teal-600 text-white shadow-lg shadow-cyan-500/30' : 'bg-slate-400/10 text-slate-400 hover:bg-slate-400/20 border border-slate-400/30'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-5">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-green-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-emerald-500/30">
                                    <i data-lucide="trending-up" class="w-6 h-6"></i>
                                </div>
                                Revenus - ${posName}
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Total: <span class="font-black text-emerald-600">${CORE.formatPrice(totalIncome)}</span></p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aperçu', 'layout-grid')}
                            ${navBtn('transactions', 'Transactions', 'list')}
                            ${navBtn('income', 'Revenus', 'trending-up', true)}
                            ${navBtn('expenses', 'Dépenses', 'trending-down')}
                            <button onclick="GestionnaireModule.showNewIncomeModal()" class="px-4 py-2.5 bg-emerald-600 text-white rounded-xl font-bold text-sm hover:bg-emerald-700 transition flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> Nouveau revenu
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="text-lg font-black text-slate-900 mb-4">Répartition par Catégorie</h3>
                            <div class="space-y-3">
                                ${Object.entries(incomeByCategory).sort((a, b) => b[1] - a[1]).map(([cat, amount]) => {
                                    const percent = totalIncome > 0 ? Math.round((amount / totalIncome) * 100) : 0;
                                    return `
                                        <div class="p-3 rounded-xl bg-emerald-50 border border-emerald-200">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="font-bold text-slate-900">${cat}</span>
                                                <span class="text-xs font-black text-emerald-600">${percent}%</span>
                                            </div>
                                            <div class="w-full bg-emerald-200 rounded-full h-2">
                                                <div class="bg-emerald-500 h-2 rounded-full" style="width: ${percent}%"></div>
                                            </div>
                                            <div class="text-sm font-black text-slate-900 mt-2">${CORE.formatPrice(amount)}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="text-lg font-black text-slate-900 mb-4">Derniers Revenus</h3>
                            <div class="space-y-2">
                                ${incomeTxs.slice(0, 10).map(t => `
                                    <div class="p-3 rounded-xl bg-emerald-50 border border-emerald-200 flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-slate-900">${t.category}</div>
                                            <div class="text-xs text-slate-500">${CORE.formatDate(t.createdAt)}</div>
                                        </div>
                                        <div class="font-black text-emerald-600">${CORE.formatPrice(t.amount)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        renderFinanceExpensesGestionnaire() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.state.currentUser?.pos;
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'Mon POS';
            const dateFrom = CORE.state.financeDateFrom || '';
            const dateTo = CORE.state.financeDateTo || '';

            let expenseTxs = CORE.getVisibleTransactions().filter(t => t.posId == userPos && t.type === 'expense') || [];
            if (dateFrom) expenseTxs = expenseTxs.filter(t => new Date(t.createdAt) >= new Date(dateFrom));
            if (dateTo) expenseTxs = expenseTxs.filter(t => new Date(t.createdAt) <= new Date(dateTo));

            const expenseByCategory = {};
            expenseTxs.forEach(t => {
                const cat = t.category || 'autre';
                expenseByCategory[cat] = (expenseByCategory[cat] || 0) + (t.amount || 0);
            });
            const totalExpense = Object.values(expenseByCategory).reduce((a, b) => a + b, 0);

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="GestionnaireModule.state.currentView = 'finance'; GestionnaireModule.state.financeView = '${v}'; App.rerender()" class="px-3 py-2 rounded-lg font-bold text-xs transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-cyan-500 to-teal-600 text-white shadow-lg shadow-cyan-500/30' : 'bg-slate-400/10 text-slate-400 hover:bg-slate-400/20 border border-slate-400/30'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-5">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-red-500/30">
                                    <i data-lucide="trending-down" class="w-6 h-6"></i>
                                </div>
                                Dépenses - ${posName}
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Total: <span class="font-black text-red-600">${CORE.formatPrice(totalExpense)}</span></p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aperçu', 'layout-grid')}
                            ${navBtn('transactions', 'Transactions', 'list')}
                            ${navBtn('income', 'Revenus', 'trending-up')}
                            ${navBtn('expenses', 'Dépenses', 'trending-down', true)}
                            <button onclick="GestionnaireModule.showNewExpenseModal()" class="px-4 py-2.5 bg-red-600 text-white rounded-xl font-bold text-sm hover:bg-red-700 transition flex items-center gap-2">
                                <i data-lucide="minus-circle" class="w-4 h-4"></i> Nouvelle dépense
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="text-lg font-black text-slate-900 mb-4">Répartition par Catégorie</h3>
                            <div class="space-y-3">
                                ${Object.entries(expenseByCategory).sort((a, b) => b[1] - a[1]).map(([cat, amount]) => {
                                    const percent = totalExpense > 0 ? Math.round((amount / totalExpense) * 100) : 0;
                                    return `
                                        <div class="p-3 rounded-xl bg-red-50 border border-red-200">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="font-bold text-slate-900">${cat}</span>
                                                <span class="text-xs font-black text-red-600">${percent}%</span>
                                            </div>
                                            <div class="w-full bg-red-200 rounded-full h-2">
                                                <div class="bg-red-500 h-2 rounded-full" style="width: ${percent}%"></div>
                                            </div>
                                            <div class="text-sm font-black text-slate-900 mt-2">${CORE.formatPrice(amount)}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="text-lg font-black text-slate-900 mb-4">Dernières Dépenses</h3>
                            <div class="space-y-2">
                                ${expenseTxs.slice(0, 10).map(t => `
                                    <div class="p-3 rounded-xl bg-red-50 border border-red-200 flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-slate-900">${t.category}</div>
                                            <div class="text-xs text-slate-500">${CORE.formatDate(t.createdAt)}</div>
                                        </div>
                                        <div class="font-black text-red-600">${CORE.formatPrice(t.amount)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        renderFinanceGestionnaire() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.state.currentUser?.pos;
            const posData = CORE.getPOS(userPos);
            const posName = posData?.name || 'Mon POS';
            const dateFrom = CORE.state.financeDateFrom || '';
            const dateTo = CORE.state.financeDateTo || '';

            // Métriques financières du POS assigné au gestionnaire
            const metrics = CORE.getFinancialMetrics(uid, dateFrom || null, dateTo || null, userPos);
            const cashFlow = CORE.getCashFlowByPeriod(uid, 'daily', userPos);
            const lastDays = Object.entries(cashFlow).slice(-7).map(([date, flow]) => ({
                date,
                ...flow
            }));

            // Transactions filtrées par POS
            let allTxs = CORE.getVisibleTransactions().filter(t => t.posId == userPos) || [];
            const incomeTxs = allTxs.filter(t => t.type === 'income');
            const expenseTxs = allTxs.filter(t => t.type === 'expense');

            // Répartition par méthode de paiement
            const orders = CORE.getVisibleOrders().filter(o => o.posId == userPos);
            const paymentMethods = {
                cash: orders.filter(o => o.paymentMethod === 'cash').reduce((s, o) => s + (o.total || 0), 0),
                mobile: orders.filter(o => o.paymentMethod === 'mobile').reduce((s, o) => s + (o.total || 0), 0),
                card: orders.filter(o => o.paymentMethod === 'card').reduce((s, o) => s + (o.total || 0), 0),
                cod: orders.filter(o => o.paymentMethod === 'cod').reduce((s, o) => s + (o.total || 0), 0)
            };

            // Top dépenses
            const expenseByCategory = {};
            expenseTxs.forEach(t => {
                const cat = t.category || 'autre';
                expenseByCategory[cat] = (expenseByCategory[cat] || 0) + (t.amount || 0);
            });
            const topExpenseCategories = Object.entries(expenseByCategory)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            // Dernières transactions
            const recentTxs = [...allTxs].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);

            const navBtn = (v, label, icon, active = false) => `
                <button onclick="GestionnaireModule.state.currentView = 'finance'; GestionnaireModule.state.financeView = '${v}'; App.rerender()" class="px-3 py-2 rounded-lg font-bold text-xs transition-all duration-200 flex items-center gap-2 ${active ? 'bg-gradient-to-r from-cyan-500 to-teal-600 text-white shadow-lg shadow-cyan-500/30' : 'bg-slate-400/10 text-slate-400 hover:bg-slate-400/20 border border-slate-400/30'}">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>${label}
                </button>`;

            return `
                <div class="fade-in space-y-5">
                    <!-- Header -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-teal-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-cyan-500/30">
                                    <i data-lucide="wallet" class="w-6 h-6"></i>
                                </div>
                                Finance - ${posName}
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Suivi financier de votre point de vente assigné</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${navBtn('overview', 'Aperçu', 'layout-grid', true)}
                            ${navBtn('transactions', 'Transactions', 'list')}
                            ${navBtn('income', 'Revenus', 'trending-up')}
                            ${navBtn('expenses', 'Dépenses', 'trending-down')}
                        </div>
                    </div>

                    <!-- Filtres Date -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <div class="flex flex-wrap items-end gap-4">
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Du</label>
                                <input type="date" value="${dateFrom}"
                                    onchange="CORE.state.financeDateFrom = this.value; App.rerender()"
                                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none font-medium">
                            </div>
                            <div class="flex-1 min-w-[150px]">
                                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Au</label>
                                <input type="date" value="${dateTo}"
                                    onchange="CORE.state.financeDateTo = this.value; App.rerender()"
                                    class="w-full px-4 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-cyan-500 outline-none font-medium">
                            </div>
                            <button onclick="CORE.state.financeDateFrom=''; CORE.state.financeDateTo=''; App.rerender()" class="px-4 py-2.5 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-200 transition">
                                Réinitialiser
                            </button>
                        </div>
                    </div>

                    <!-- KPIs Principaux -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-cyan-500 to-teal-600 rounded-2xl p-5 text-white shadow-lg shadow-cyan-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-up" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Revenus</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(metrics.totalIncome)}</div>
                                <div class="text-xs opacity-70 mt-2">${incomeTxs.length} transactions</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl p-5 text-white shadow-lg shadow-red-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-down" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Dépenses</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(metrics.totalExpenses)}</div>
                                <div class="text-xs opacity-70 mt-2">${expenseTxs.length} sorties</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-5 text-white shadow-lg shadow-blue-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="bar-chart-3" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Bénéfice</span>
                                </div>
                                <div class="text-3xl font-black">${metrics.netProfit >= 0 ? '+' : ''}${CORE.formatPrice(metrics.netProfit)}</div>
                                <div class="text-xs opacity-70 mt-2">Marge: ${metrics.profitMargin}%</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-slate-500 to-slate-600 rounded-2xl p-5 text-white shadow-lg shadow-slate-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="package" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Total Cdes</span>
                                </div>
                                <div class="text-3xl font-black">${orders.length}</div>
                                <div class="text-xs opacity-70 mt-2">Montant: ${CORE.formatPrice(orders.reduce((s, o) => s + (o.total || 0), 0))}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Contenu principal -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Gauche: Méthodes de paiement -->
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                <h3 class="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">
                                    <i data-lucide="credit-card" class="w-5 h-5 text-cyan-500"></i>
                                    Répartition par Paiement
                                </h3>
                                <div class="space-y-3">
                                    ${[
                                        { method: 'cash', label: '💵 Espèces', color: 'emerald' },
                                        { method: 'mobile', label: '📱 Mobile Money', color: 'blue' },
                                        { method: 'card', label: '💳 Carte', color: 'purple' },
                                        { method: 'cod', label: '📦 À la Livraison', color: 'amber' }
                                    ].map(({ method, label, color }) => {
                                        const amount = paymentMethods[method] || 0;
                                        const percent = orders.length > 0 ? Math.round((amount / (orders.reduce((s, o) => s + (o.total || 0), 0) || 1)) * 100) : 0;
                                        return `
                                            <div class="p-4 rounded-xl bg-${color}-50 border border-${color}-200">
                                                <div class="flex items-center justify-between mb-2">
                                                    <span class="font-bold text-slate-900">${label}</span>
                                                    <span class="text-xs font-black text-${color}-600">${percent}%</span>
                                                </div>
                                                <div class="w-full bg-${color}-200 rounded-full h-2">
                                                    <div class="bg-${color}-500 h-2 rounded-full" style="width: ${percent}%"></div>
                                                </div>
                                                <div class="text-sm font-black text-slate-900 mt-2">${CORE.formatPrice(amount)}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>

                            <!-- Dernières Transactions -->
                            <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                <h3 class="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">
                                    <i data-lucide="history" class="w-5 h-5 text-teal-500"></i>
                                    Dernières Transactions
                                </h3>
                                <div class="space-y-2">
                                    ${recentTxs.length === 0 ? `
                                        <div class="text-center text-slate-500 text-sm py-6">Aucune transaction récente</div>
                                    ` : recentTxs.map(t => `
                                        <div class="p-3 rounded-xl bg-slate-50 border border-slate-200 flex items-center justify-between">
                                            <div>
                                                <div class="font-black text-slate-900 text-sm">${t.category || 'Autre'}</div>
                                                <div class="text-xs text-slate-500">${CORE.formatDate(t.createdAt)}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-black text-slate-900">${t.type === 'income' ? '+' : '-'}${CORE.formatPrice(t.amount)}</div>
                                                <div class="text-xs font-bold ${t.type === 'income' ? 'text-emerald-600' : 'text-red-600'}">${t.type === 'income' ? 'Revenu' : 'Dépense'}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Droite: Top Dépenses -->
                        <div class="space-y-6">
                            <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                <h3 class="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">
                                    <i data-lucide="pie-chart" class="w-5 h-5 text-red-500"></i>
                                    Top Dépenses
                                </h3>
                                <div class="space-y-2">
                                    ${topExpenseCategories.length === 0 ? `
                                        <div class="text-center text-slate-500 text-sm py-6">Aucune dépense enregistrée</div>
                                    ` : topExpenseCategories.map(([cat, amount]) => `
                                        <div class="p-3 rounded-xl bg-red-50 border border-red-200">
                                            <div class="flex items-center justify-between mb-1">
                                                <span class="font-bold text-slate-900 text-sm">${cat}</span>
                                                <span class="text-xs font-black text-red-600">${CORE.formatPrice(amount)}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Infos POS -->
                            <div class="bg-gradient-to-br from-cyan-50 to-teal-50 rounded-2xl border border-cyan-200 p-6">
                                <h3 class="text-lg font-black text-slate-900 mb-4">📍 Point de Vente</h3>
                                <div class="space-y-2 text-sm">
                                    <div><span class="font-bold text-slate-600">Nom:</span> <span class="font-black text-slate-900">${posName}</span></div>
                                    <div><span class="font-bold text-slate-600">Commandes:</span> <span class="font-black text-slate-900">${orders.length}</span></div>
                                    <div><span class="font-bold text-slate-600">Revenus:</span> <span class="font-black text-emerald-600">${CORE.formatPrice(metrics.totalIncome)}</span></div>
                                    <div><span class="font-bold text-slate-600">Dépenses:</span> <span class="font-black text-red-600">${CORE.formatPrice(metrics.totalExpenses)}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        renderSettings() {
            const currentLang = I18n.current || 'fr';
            const currentTheme = this.state?.theme || 'light';
            const user = CORE.state.currentUser;

            return `
                <div class="space-y-6 fade-in">
                    <!-- Header gradient -->
                    <div class="bg-gradient-to-br from-cyan-500 via-cyan-600 to-blue-600 p-6 rounded-2xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
                        <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full translate-y-1/2 -translate-x-1/2"></div>
                        <div class="relative flex items-center gap-4">
                            <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center shadow-xl">
                                <i data-lucide="settings" class="w-8 h-8 text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-black text-white">Param\u00E8tres</h2>
                                <p class="text-cyan-100 text-sm">Gestionnaire: ${user?.name || ''}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Langue (Tiroir) -->
                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                        <button onclick="document.getElementById('gestionnaire-language-drawer').classList.toggle('hidden'); document.getElementById('gestionnaire-language-chevron').classList.toggle('rotate-180')" class="w-full flex items-center justify-between p-5 hover:bg-slate-50 transition-all">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="globe" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left">
                                    <div class="font-black text-slate-900">${t('settings.language')}</div>
                                    <p class="text-xs text-slate-500">${[{code:'fr',flag:'🇫🇷',name:'Français'},{code:'en',flag:'🇬🇧',name:'English'},{code:'es',flag:'🇪🇸',name:'Español'},{code:'pt',flag:'🇵🇹',name:'Português'},{code:'de',flag:'🇩🇪',name:'Deutsch'},{code:'it',flag:'🇮🇹',name:'Italiano'},{code:'ar',flag:'🇸🇦',name:'العربية'},{code:'zh',flag:'🇨🇳',name:'中文'},{code:'ru',flag:'🇷🇺',name:'Русский'}].find(l => l.code === currentLang)?.flag || '🌍'} ${[{code:'fr',flag:'🇫🇷',name:'Français'},{code:'en',flag:'🇬🇧',name:'English'},{code:'es',flag:'🇪🇸',name:'Español'},{code:'pt',flag:'🇵🇹',name:'Português'},{code:'de',flag:'🇩🇪',name:'Deutsch'},{code:'it',flag:'🇮🇹',name:'Italiano'},{code:'ar',flag:'🇸🇦',name:'العربية'},{code:'zh',flag:'🇨🇳',name:'中文'},{code:'ru',flag:'🇷🇺',name:'Русский'}].find(l => l.code === currentLang)?.name || 'Français'}</p>
                                </div>
                            </div>
                            <i id="gestionnaire-language-chevron" data-lucide="chevron-down" class="w-5 h-5 text-slate-400 transition-transform duration-300"></i>
                        </button>
                        <div id="gestionnaire-language-drawer" class="hidden border-t border-slate-200 bg-slate-50 p-5">
                            <p class="text-xs text-slate-500 mb-3">${t('settings.chooseLanguage')}</p>
                            <div class="grid grid-cols-5 gap-2">
                                ${[
                                    { code: 'fr', flag: '🇫🇷', name: 'Français' },
                                    { code: 'en', flag: '🇬🇧', name: 'English' },
                                    { code: 'es', flag: '🇪🇸', name: 'Español' },
                                    { code: 'pt', flag: '🇵🇹', name: 'Português' },
                                    { code: 'de', flag: '🇩🇪', name: 'Deutsch' },
                                    { code: 'it', flag: '🇮🇹', name: 'Italiano' },
                                    { code: 'ar', flag: '🇸🇦', name: 'العربية' },
                                    { code: 'zh', flag: '🇨🇳', name: '中文' },
                                    { code: 'ru', flag: '🇷🇺', name: 'Русский' }
                                ].map(lang => `
                                    <button onclick="GestionnaireModule.setLanguage('${lang.code}')" class="p-2.5 rounded-xl border-2 transition-all hover:scale-110 flex flex-col items-center gap-1 ${currentLang === lang.code ? 'border-cyan-500 bg-cyan-50 shadow-lg scale-105' : 'border-slate-200 hover:border-slate-300 bg-white'}">
                                        <span class="text-2xl">${lang.flag}</span>
                                        <span class="text-[9px] font-bold text-slate-600">${lang.name.slice(0, 4)}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Th\u00E8me -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center shadow-lg">
                                <i data-lucide="palette" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-slate-900">${t('settings.theme')}</div>
                                <div class="text-xs text-slate-500">Personnalisez l'apparence</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="GestionnaireModule.setTheme('light'); App.rerender()" class="p-4 rounded-2xl border-2 transition flex flex-col items-center justify-center gap-2 ${currentTheme === 'light' ? 'border-cyan-500 bg-cyan-50 shadow-lg shadow-cyan-100' : 'border-slate-200 hover:border-slate-300'}">
                                <i data-lucide="sun" class="w-6 h-6 ${currentTheme === 'light' ? 'text-cyan-600' : 'text-slate-400'}"></i>
                                <span class="text-xs font-black ${currentTheme === 'light' ? 'text-cyan-700' : 'text-slate-600'}">Clair</span>
                            </button>
                            <button onclick="GestionnaireModule.setTheme('dark'); App.rerender()" class="p-4 rounded-2xl border-2 transition flex flex-col items-center justify-center gap-2 ${currentTheme === 'dark' ? 'border-cyan-500 bg-cyan-50 shadow-lg shadow-cyan-100' : 'border-slate-200 hover:border-slate-300'}">
                                <i data-lucide="moon" class="w-6 h-6 ${currentTheme === 'dark' ? 'text-cyan-600' : 'text-slate-400'}"></i>
                                <span class="text-xs font-black ${currentTheme === 'dark' ? 'text-cyan-700' : 'text-slate-600'}">Sombre</span>
                            </button>
                            <button onclick="GestionnaireModule.setTheme('auto'); App.rerender()" class="p-4 rounded-2xl border-2 transition flex flex-col items-center justify-center gap-2 ${currentTheme === 'auto' ? 'border-cyan-500 bg-cyan-50 shadow-lg shadow-cyan-100' : 'border-slate-200 hover:border-slate-300'}">
                                <i data-lucide="monitor" class="w-6 h-6 ${currentTheme === 'auto' ? 'text-cyan-600' : 'text-slate-400'}"></i>
                                <span class="text-xs font-black ${currentTheme === 'auto' ? 'text-cyan-700' : 'text-slate-600'}">Auto</span>
                            </button>
                        </div>
                    </div>

                    <!-- Notifications -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-rose-500 to-red-500 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="bell" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <div class="font-black text-slate-900">Notifications</div>
                                    <div class="text-xs text-slate-500">${this.state.notificationsEnabled ? 'Activ\u00E9es' : 'D\u00E9sactiv\u00E9es'}</div>
                                </div>
                            </div>
                            <button onclick="GestionnaireModule.toggleNotifications(); App.rerender()" class="px-4 py-2 rounded-xl text-xs font-black transition ${this.state.notificationsEnabled ? 'bg-cyan-50 text-cyan-700 border border-cyan-200 hover:bg-cyan-100' : 'bg-slate-100 text-slate-500 border border-slate-200 hover:bg-slate-200'}">
                                ${this.state.notificationsEnabled ? 'D\u00E9sactiver' : 'Activer'}
                            </button>
                        </div>
                    </div>

                    <!-- SLA & KPIs -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm cursor-pointer hover:shadow-md transition" onclick="GestionnaireModule.showSlaConfigModal()">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="activity" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <div class="font-black text-slate-900">SLA & KPIs</div>
                                    <div class="text-xs text-slate-500">Configurer les seuils d'alerte</div>
                                </div>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i>
                        </div>
                    </div>

                    <!-- S\u00E9curit\u00E9 -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl flex items-center justify-center shadow-lg">
                                <i data-lucide="shield" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-slate-900">S\u00E9curit\u00E9</div>
                                <div class="text-xs text-slate-500">Mot de passe et confidentialit\u00E9</div>
                            </div>
                        </div>
                        <button onclick="GestionnaireModule.showChangePersonalPasswordModal()" class="w-full p-4 rounded-xl bg-sky-50 border border-sky-200 hover:bg-sky-100 transition flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i data-lucide="key" class="w-5 h-5 text-sky-600"></i>
                                <div class="text-left">
                                    <div class="text-sm font-black text-sky-700">Changer votre mot de passe</div>
                                    <div class="text-xs text-sky-600">Modifiez votre mot de passe personnel</div>
                                </div>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-sky-400"></i>
                        </button>
                    </div>

                    <!-- Zone de danger -->
                    <div class="bg-red-50 rounded-2xl border border-red-200 overflow-hidden">
                        <div class="p-5 border-b border-red-200 font-black text-red-700 flex items-center gap-2">
                            <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                            <span>Zone de danger</span>
                        </div>
                        <div class="p-5 space-y-3">
                            <button onclick="CORE.showDeleteMyAccountModal()" class="w-full py-3 rounded-xl bg-white border-2 border-red-300 text-red-700 font-black hover:bg-red-100 transition flex items-center justify-center gap-2">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                                <span>Supprimer mon compte</span>
                            </button>
                            <button onclick="App.logout()" class="w-full py-3 rounded-xl bg-red-600 text-white font-black hover:bg-red-700 transition flex items-center justify-center gap-2">
                                <i data-lucide="log-out" class="w-5 h-5"></i>
                                <span>D\u00E9connexion</span>
                            </button>
                        </div>
                    </div>

                    <!-- Multi-comptes -->
                    ${window.AccountSwitcher ? AccountSwitcher.getHTML() : '<div id="account-switcher-section"></div>'}
                </div>`;
        },

                render() {
            const view = this.state.currentView;
            this.loadThemePreference();
            this.checkCriticalEvents();

            let content;
            try {
                content = view === 'settings' ? this.renderSettings() :
                          view === 'dashboard' ? this.renderDashboard() :
                          view === 'stocks' ? this.renderStocks() :
                          view === 'deliveries' ? this.renderDeliveries() :
                          view === 'team' ? this.renderTeam() :
                          view === 'planning' ? this.renderPlanning() :
                          view === 'reports' ? this.renderReports() :
                          view === 'reconciliation' ? this.renderReconciliation() :
                          view === 'finance' ? this.renderFinance() :
                          view === 'auditlog' ? this.renderAuditLog() :
                          view === 'incidents' ? this.renderIncidentCenter() :
                          view === 'deliverymen' ? this.renderIndependentDeliveryMenApproval() :
                          `<div class="p-10 text-center text-slate-400 font-medium">Vue en construction</div>`;
            } catch(renderErr) {
                console.error('[GestionnaireModule] render error for view:', view, renderErr);
                content = `<div class="p-10 text-center"><div class="text-red-500 font-black text-lg">Erreur de rendu: ${view}</div><div class="text-slate-500 mt-2">${renderErr.message}</div><button onclick="GestionnaireModule.state.currentView='dashboard';App.rerender()" class="mt-4 px-4 py-2 bg-sky-600 text-white rounded-xl font-bold">Retour Dashboard</button></div>`;
            }

            return `
                <div class="flex h-screen bg-slate-100">
                    <aside class="w-72 bg-gradient-to-b from-cyan-900 via-slate-900 to-slate-950 text-white flex flex-col no-print relative overflow-hidden">
                        <!-- Effets de fond -->
                        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,rgba(6,182,212,0.2),transparent_50%)] pointer-events-none"></div>
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-cyan-400 via-cyan-500 to-teal-500"></div>

                        <!-- Header -->
                        <div class="p-6 flex items-center gap-4 flex-shrink-0 relative">
                            <div class="w-12 h-12 bg-gradient-to-br from-cyan-400 to-teal-500 rounded-2xl flex items-center justify-center shadow-lg shadow-cyan-500/30 ring-2 ring-white/10">
                                <i data-lucide="package" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h1 class="font-black text-xl tracking-tight">RAYA<span class="text-cyan-400">.log</span></h1>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Gestionnaire</p>
                            </div>
                        </div>

                        <!-- Navigation -->
                        <nav class="flex-1 px-4 py-2 space-y-1 overflow-y-auto">
                            ${this.renderNavItem('dashboard','layout-dashboard','Tableau de bord', CORE.getUnreadNotificationCount())}
                            ${this.renderNavItem('stocks','box','Gestion stocks', (typeof GestionnaireModule !== 'undefined' && GestionnaireModule.getPendingIncomingTransfers ? GestionnaireModule.getPendingIncomingTransfers().length : 0))}
                            ${this.renderNavItem('deliveries','truck','Suivi livraisons', (CORE.getVisibleDeliveries ? CORE.getVisibleDeliveries().filter(d => d.status === 'pending' || d.status === 'assigned').length : 0))}
                            ${this.renderNavItem('deliverymen','user-check','Livreurs Indép.', CORE.getPendingDeliveryMen(CORE.state.currentUser?.pos || CORE.state.currentUser?.storeId).length)}
                            ${this.renderNavItem('team','users','Équipe')}
                            ${this.renderNavItem('planning','calendar','Planification')}
                            ${this.renderNavItem('finance','wallet','Finance')}
                            ${this.renderNavItem('reports','file-bar-chart','Rapports')}
                            ${this.renderNavItem('reconciliation','check-circle','Réconciliation')}
                            ${this.renderNavItem('auditlog','history','Journal d\'audit')}
                            ${this.renderNavItem('incidents','alert-circle','Centre d\'Incidents')}
                        </nav>

                        <!-- Footer -->
                        <div class="p-4 border-t border-white/5 relative">
                            <button onclick="GestionnaireModule.navigateTo('settings')" class="w-full flex items-center gap-3 px-4 py-3 bg-white/5 hover:bg-white/10 rounded-xl transition-all duration-200 group">
                                <i data-lucide="settings" class="w-5 h-5 text-slate-400 group-hover:text-cyan-400 group-hover:rotate-90 transition-all duration-300"></i>
                                <span class="text-sm font-bold text-slate-300 group-hover:text-white">Paramètres</span>
                            </button>
                        </div>
                    </aside>

                    <main class="flex-1 overflow-auto bg-slate-50">
                        <header class="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-20">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-xl font-black text-slate-900">Logistique & Stocks</h2>
                                    <p class="text-sm text-slate-500">Gestionnaire: ${CORE.state.currentUser?.name}</p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <button onclick="GestionnaireModule.showNotificationHistory()" class="relative px-3 py-2 rounded-xl hover:bg-slate-100 transition">
                                        <i data-lucide="bell" class="w-5 h-5 text-slate-600"></i>
                                        ${(() => { const histCount = this.state.notificationHistory.length; const transferCount = this.getTransferNotificationsCount ? this.getTransferNotificationsCount() : 0; const totalBadge = histCount + transferCount; return totalBadge > 0 ? `<span class="absolute top-0 right-0 w-5 h-5 bg-red-500 text-white text-[10px] font-black rounded-full flex items-center justify-center">${Math.min(totalBadge, 9)}${totalBadge > 9 ? '+' : ''}</span>` : ''; })()}
                                    </button>
                                    <div class="flex items-center gap-2 px-3 py-1.5 bg-amber-50 rounded-full">
                                        <span class="w-2 h-2 bg-amber-500 rounded-full pulse-dot"></span>
                                        <span class="text-sm text-amber-700 font-black">CORE connecté</span>
                                    </div>
                                </div>
                            </div>
                        </header>
                        <div class="p-6">${content}</div>
                    </main>

                    ${this.renderNotificationCenter()}
                </div>`;
        },

        renderTeam() {
            const posId = CORE.state.currentUser?.pos;
            const pos = CORE.getPOS(posId);
            const vendeurs = CORE.getVisibleUsers().filter(u => u.role === 'vendeur' && u.pos === posId);
            const _regTeamLiv = CORE.getVisibleUsers().filter(u => u.role === 'livreur' && u.pos === posId);
            const _indepTeamLiv = (CORE.db.independentDeliveryMen || []).filter(dm => dm.posId == posId && dm.approvalStatus === 'approved' && dm.status === 'active').map(dm => ({ id: dm.id, name: dm.name + ' (Indépendant)', phone: dm.phone || '', vehicle: dm.vehicle || '', pos: posId, role: 'livreur', active: true, isIndependent: true }));
            const livreurs = [..._regTeamLiv, ..._indepTeamLiv];
            const kpis = this.getTeamKPIs(posId);
            const alerts = this.evaluateSLA(kpis);

            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">👥 Équipe du POS</h2>
                            <p class="text-slate-500 font-medium">${pos ? pos.name : 'POS inconnu'} • Gestion vendeurs et livreurs</p>
                        </div>
                        <button onclick="GestionnaireModule.showSettingsModal()" class="px-3 py-2 bg-slate-900 text-white rounded-xl font-black hover:bg-slate-800 transition text-sm">Configurer SLA</button>
                    </div>

                    ${alerts.length > 0 ? `
                    <div class="p-4 rounded-2xl border ${alerts.some(a=>a.severity==='red')?'border-red-200 bg-red-50':'border-amber-200 bg-amber-50'}">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="alert-triangle" class="w-4 h-4 ${alerts.some(a=>a.severity==='red')?'text-red-600':'text-amber-600'}"></i>
                            <span class="font-black ${alerts.some(a=>a.severity==='red')?'text-red-700':'text-amber-700'}">Alertes SLA</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                            ${alerts.map(a => `<div class="text-sm"><span class="font-black">${a.label}:</span> <span class="${a.severity==='red'?'text-red-700':'text-amber-700'}">${a.value}</span> • Seuil: ${a.threshold}</div>`).join('')}
                        </div>
                    </div>` : ''}

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">Taux livraison (délais)</div>
                            <div class="text-3xl font-black ${kpis.onTimeRate >= this.state.slaThresholds.minOnTimeRate ? 'text-emerald-600' : 'text-red-600'} mt-2">${kpis.onTimeRate}%</div>
                            <p class="text-[11px] text-slate-400 mt-1">Max ${this.state.slaThresholds.maxDeliveryMinutes} min</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">Dépôts journaliers</div>
                            <div class="text-3xl font-black ${kpis.dailyDeposits >= this.state.slaThresholds.minDailyDeposits ? 'text-emerald-600' : 'text-red-600'} mt-2">${CORE.formatPrice(kpis.dailyDeposits)}</div>
                            <p class="text-[11px] text-slate-400 mt-1">Seuil min ${CORE.formatPrice(this.state.slaThresholds.minDailyDeposits)}</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                            <div class="text-slate-500 text-xs font-black uppercase tracking-wider">Commandes en attente</div>
                            <div class="text-3xl font-black ${kpis.pendingOrders <= this.state.slaThresholds.maxPendingOrders ? 'text-slate-900' : 'text-amber-600'} mt-2">${kpis.pendingOrders}</div>
                            <p class="text-[11px] text-slate-400 mt-1">Max ${this.state.slaThresholds.maxPendingOrders}</p>
                        </div>
                    </div>

                    <!-- Vendeurs -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-emerald-50">
                            <div>
                                <h3 class="font-black text-slate-900 text-lg">💰 Vendeurs</h3>
                                <p class="text-xs text-slate-500 mt-1">${vendeurs.length} vendeur(s) assigné(s)</p>
                            </div>
                        </div>
                        <div class="p-4 space-y-3">
                            ${vendeurs.length === 0 ? `<div class="p-10 text-center text-slate-400 font-medium">Aucun vendeur assigné à ce POS</div>` : ''}
                            ${vendeurs.map(v => `
                                <div class="p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 transition flex items-start justify-between">
                                    <div class="flex items-start gap-3">
                                        <div class="w-12 h-12 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-xl flex items-center justify-center text-white font-black text-lg">${v.avatar || v.name.charAt(0).toUpperCase()}</div>
                                        <div>
                                            <div class="font-black text-slate-900">${v.name}</div>
                                            <div class="text-xs text-slate-500 mt-1">${v.phone || 'Pas de téléphone'}</div>
                                            <div class="text-xs text-slate-400">${v.city ? CORE.getCity(v.city)?.name : 'Ville non définie'}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        ${v.active ? `<span class="px-3 py-1 bg-emerald-100 text-emerald-700 text-xs font-black rounded-full">Actif</span>` : `<span class="px-3 py-1 bg-slate-100 text-slate-600 text-xs font-black rounded-full">Inactif</span>`}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Livreurs -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-blue-50">
                            <div>
                                <h3 class="font-black text-slate-900 text-lg">🚚 Livreurs</h3>
                                <p class="text-xs text-slate-500 mt-1">${livreurs.length} livreur(s) assigné(s)</p>
                            </div>
                        </div>
                        <div class="p-4 space-y-3">
                            ${livreurs.length === 0 ? `<div class="p-10 text-center text-slate-400 font-medium">Aucun livreur assigné à ce POS</div>` : ''}
                            ${livreurs.map(l => `
                                <div class="p-4 rounded-2xl border border-slate-200 hover:bg-slate-50 transition flex items-start justify-between">
                                    <div class="flex items-start gap-3">
                                        <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl flex items-center justify-center text-white font-black text-lg">${l.avatar || l.name.charAt(0).toUpperCase()}</div>
                                        <div>
                                            <div class="font-black text-slate-900">${l.name}</div>
                                            <div class="text-xs text-slate-500 mt-1">${l.phone || 'Pas de téléphone'}</div>
                                            <div class="text-xs text-slate-400">${l.vehicle || 'Véhicule non spécifié'}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs font-black text-slate-600 mb-1">Note: ${l.rating || '—'}</div>
                                        ${l.active ? `<span class="px-3 py-1 bg-emerald-100 text-emerald-700 text-xs font-black rounded-full">Actif</span>` : `<span class="px-3 py-1 bg-slate-100 text-slate-600 text-xs font-black rounded-full">Inactif</span>`}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
        },

        renderReconciliation() {
            const posId = CORE.state.currentUser?.pos;
            const pos = CORE.getPOS(posId);
            const dateFrom = CORE.state.reconcDateFrom || '';
            const dateTo = CORE.state.reconcDateTo || '';

            const summary = CORE.getReconciliationSummary(posId, dateFrom || null, dateTo || null);
            const reconciliations = CORE.getDepositReconciliation(posId, dateFrom || null, dateTo || null);

            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-start justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">✓ Réconciliation des Dépôts</h2>
                            <p class="text-slate-500 font-medium">Contrôle automatisé des écarts dépôts vs encaissements</p>
                        </div>
                    </div>

                    <!-- Filtres de date -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 flex gap-4 items-end flex-wrap">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Du</label>
                            <input type="date" value="${dateFrom}" onchange="CORE.state.reconcDateFrom = this.value; GestionnaireModule.state.currentView = 'reconciliation'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl">
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-xs font-black text-slate-600 uppercase mb-2">Au</label>
                            <input type="date" value="${dateTo}" onchange="CORE.state.reconcDateTo = this.value; GestionnaireModule.state.currentView = 'reconciliation'; App.rerender()" class="w-full px-4 py-2 border border-slate-200 rounded-xl">
                        </div>
                        <button onclick="CORE.state.reconcDateFrom = ''; CORE.state.reconcDateTo = ''; GestionnaireModule.state.currentView = 'reconciliation'; App.rerender()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-black hover:bg-slate-200 transition text-sm">Réinitialiser</button>
                    </div>

                    <!-- Résumé des anomalies -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-3xl border border-slate-200 p-6">
                            <div class="text-slate-700 text-xs font-black uppercase tracking-wider mb-2">Total Dépôts</div>
                            <div class="text-3xl font-black text-slate-900">${summary.totalDeposits}</div>
                            <div class="text-xs text-slate-600 mt-1">${CORE.formatPrice(summary.totalDeclared)}</div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-3xl border border-emerald-200 p-6">
                            <div class="text-emerald-700 text-xs font-black uppercase tracking-wider mb-2">Réconciliés ✓</div>
                            <div class="text-3xl font-black text-emerald-600">${summary.anomalies.ok}</div>
                            <div class="text-xs text-emerald-600 mt-1">${summary.anomalies.ok === summary.totalDeposits ? 'Tous OK!' : 'En cours'}</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-3xl border border-amber-200 p-6">
                            <div class="text-amber-700 text-xs font-black uppercase tracking-wider mb-2">Écarts Détectés</div>
                            <div class="text-3xl font-black text-amber-600">${summary.anomalies.overDeclared + summary.anomalies.underDeclared}</div>
                            <div class="text-xs text-amber-600 mt-1">Montants incorrects</div>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-3xl border border-red-200 p-6">
                            <div class="text-red-700 text-xs font-black uppercase tracking-wider mb-2">Critiques 🔴</div>
                            <div class="text-3xl font-black text-red-600">${summary.anomalies.criticalAmount}</div>
                            <div class="text-xs text-red-600 mt-1">>1000 FCFA</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-3xl border border-blue-200 p-6">
                            <div class="text-blue-700 text-xs font-black uppercase tracking-wider mb-2">Mismatch Cdes</div>
                            <div class="text-3xl font-black text-blue-600">${summary.anomalies.orderMismatch}</div>
                            <div class="text-xs text-blue-600 mt-1">Commandes manquantes</div>
                        </div>
                    </div>

                    <!-- Recommandations -->
                    ${summary.recommendations.length > 0 ? `
                    <div class="bg-white rounded-3xl border border-slate-200 p-6">
                        <h3 class="text-lg font-black text-slate-900 mb-4">🎯 Recommandations</h3>
                        <div class="space-y-2">
                            ${summary.recommendations.map(rec => `
                                <div class="p-3 rounded-xl bg-slate-50 text-sm text-slate-700"><strong>${rec.substring(0, 2)}</strong> ${rec.substring(2)}</div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Détail des dépôts -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="text-xl font-black text-slate-900">Analyse Détaillée</h3>
                            ${reconciliations.some(r => r.anomalyType !== 'OK') ? `
                                <button onclick="GestionnaireModule.validateAllDeposits()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition text-sm">✓ Valider Tous</button>
                            ` : ''}
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 border-b border-slate-100">
                                    <tr>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Dépôt</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Déclaré</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Réel</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Écart</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Cdes</th>
                                        <th class="px-6 py-3 text-left font-black text-slate-900">Statut</th>
                                        <th class="px-6 py-3 text-center font-black text-slate-900">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${reconciliations.map(r => `
                                        <tr class="border-b border-slate-100 hover:bg-slate-50">
                                            <td class="px-6 py-4">
                                                <div class="font-black text-slate-900">${r.livreurName}</div>
                                                <div class="text-xs text-slate-500">${CORE.formatDate(r.timestamp)}</div>
                                            </td>
                                            <td class="px-6 py-4 font-black text-slate-900">${CORE.formatPrice(r.declaredAmount)}</td>
                                            <td class="px-6 py-4 font-black text-slate-900">${CORE.formatPrice(r.actualRevenue)}</td>
                                            <td class="px-6 py-4">
                                                <div class="font-black ${r.discrepancy > 0 ? 'text-red-600' : r.discrepancy < 0 ? 'text-orange-600' : 'text-emerald-600'}">${r.discrepancy > 0 ? '+' : ''}${CORE.formatPrice(r.discrepancy)}</div>
                                                <div class="text-xs text-slate-500">${r.discrepancyPercent}%</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="font-black text-slate-900">${r.actualCount}/${r.declaredCount}</div>
                                                ${r.orderMismatch !== 0 ? `<div class="text-xs text-red-600">⚠️ Mismatch: ${r.orderMismatch}</div>` : ''}
                                            </td>
                                            <td class="px-6 py-4">
                                                ${(() => {
                                                    const statusMap = {
                                                        'OK': '<span class="px-3 py-1 bg-emerald-100 text-emerald-700 text-xs font-black rounded-full">OK ✓</span>',
                                                        'OVER_DECLARED': '<span class="px-3 py-1 bg-red-100 text-red-700 text-xs font-black rounded-full">Suraugmenté</span>',
                                                        'UNDER_DECLARED': '<span class="px-3 py-1 bg-orange-100 text-orange-700 text-xs font-black rounded-full">Sous-déclaré</span>',
                                                        'CRITICAL_AMOUNT': '<span class="px-3 py-1 bg-red-100 text-red-700 text-xs font-black rounded-full">🔴 Critique</span>',
                                                        'ORDER_MISMATCH': '<span class="px-3 py-1 bg-blue-100 text-blue-700 text-xs font-black rounded-full">Mismatch Cdes</span>'
                                                    };
                                                    return statusMap[r.anomalyType] || '<span class="text-slate-500">—</span>';
                                                })()}
                                            </td>
                                            <td class="px-6 py-4 text-center">
                                                ${r.anomalyType === 'OK' ? `
                                                    <span class="text-emerald-600 font-black">✓</span>
                                                ` : `
                                                    <button onclick="GestionnaireModule.showReconciliationDetails(${r.depositId})" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg font-black text-xs hover:bg-blue-100 transition">Détails</button>
                                                `}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Résumé des montants -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-slate-600 text-xs font-black uppercase mb-2">Total Déclaré</div>
                            <div class="text-3xl font-black text-slate-900">${CORE.formatPrice(summary.totalDeclared)}</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-slate-600 text-xs font-black uppercase mb-2">Total Réel</div>
                            <div class="text-3xl font-black text-emerald-600">${CORE.formatPrice(summary.totalActual)}</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-slate-600 text-xs font-black uppercase mb-2">Écart Total</div>
                            <div class="text-3xl font-black ${summary.totalDiscrepancy > 0 ? 'text-red-600' : 'text-emerald-600'}">${summary.totalDiscrepancy > 0 ? '+' : ''}${CORE.formatPrice(summary.totalDiscrepancy)}</div>
                        </div>
                    </div>
                </div>`;
        },

        renderPlanning() {
            const posId = CORE.state.currentUser?.pos;
            const pos = CORE.getPOS(posId);
            const vendeurs = CORE.getVisibleUsers().filter(u => u.role === 'vendeur' && u.pos === posId);
            const livreurs = CORE.getVisibleUsers().filter(u => u.role === 'livreur' && u.pos === posId);
            const allUsers = [...vendeurs, ...livreurs];
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());

            // Afficher une semaine (7 jours)
            const days = Array.from({length: 7}, (_, i) => {
                const d = new Date(weekStart);
                d.setDate(d.getDate() + i);
                return d;
            });

            return `
                <div class="fade-in space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">📅 Planification Équipe</h2>
                            <p class="text-slate-500 font-medium">${pos ? pos.name : 'POS inconnu'} • Calendrier des shifts et disponibilités</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="GestionnaireModule.showAddShiftModal()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition text-sm">+ Shift</button>
                            <button onclick="GestionnaireModule.showTimeOffModal()" class="px-4 py-2 bg-amber-600 text-white rounded-xl font-black hover:bg-amber-700 transition text-sm">Congés</button>
                        </div>
                    </div>

                    <!-- Calendrier des shifts -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100">
                            <h3 class="font-black text-slate-900">Semaine du ${weekStart.toLocaleDateString('fr-FR', {day:'numeric', month:'short', year:'numeric'})}</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-black text-slate-600">Personne</th>
                                        ${days.map(d => `<th class="px-4 py-3 text-center font-black text-slate-600">${d.toLocaleDateString('fr-FR', {weekday:'short', day:'numeric'})}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${allUsers.map(u => `
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-4 py-4 font-black text-slate-900">${u.name}</td>
                                            ${days.map(day => {
                                                const shifts = CORE.getShiftsByDate(posId, day).filter(s => s.userId === u.id);
                                                const timeOff = CORE.getUserTimeOff(u.id, day.toISOString().split('T')[0], day.toISOString().split('T')[0]);
                                                const hasTimeOff = timeOff.length > 0;
                                                const shiftText = shifts.length > 0 ? shifts.map(s => { const t = CORE.getShiftTemplate(s.templateId); return t ? t.name.substring(0,3) : '—'; }).join(',') : '';
                                                return `<td class="px-4 py-4 text-center"><div class="px-2 py-1 rounded-lg ${hasTimeOff ? 'bg-red-100 text-red-700 font-black text-xs' : shiftText ? 'bg-blue-100 text-blue-700 font-black text-xs' : 'text-slate-400'}">${hasTimeOff ? '❌' : shiftText || 'é'}</div></td>`;
                                            }).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Capacité par créneau -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100">
                            <h3 class="font-black text-slate-900">Capacité par Créneau (Aujourd'hui)</h3>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${Object.entries(CORE.getCapacityBySlot(posId, today)).map(([slotName, cap]) => `
                                <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                                    <div class="font-black text-slate-900 mb-2">${slotName}</div>
                                    <div class="text-xs text-slate-600 mb-3">${cap.template.startTime} - ${cap.template.endTime}</div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="text-lg font-black text-emerald-600">${cap.assigned}/${cap.capacity}</div>
                                        <div class="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
                                            <div class="h-full bg-emerald-600" data-width="${Math.min(100, (cap.assigned/cap.capacity)*100)}"></div>
                                        </div>
                                    </div>
                                    <button onclick="GestionnaireModule.quickReplacement('${slotName}', ${posId}, '${today.toISOString().split('T')[0]}')" class="w-full mt-2 px-3 py-2 bg-slate-900 text-white rounded-lg font-black text-xs hover:bg-slate-800 transition">Remplacement rapide</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
        },

        // ===== OPTIMISATION ROUTAGE LIVREURS =====
        showRouteOptimization() {
            const livreurs = CORE.getVisibleUsers().filter(u => u.role === 'livreur' && u.active);
            const pendingOrders = CORE.getVisibleOrders().filter(o => o.status === 'pending');

            UI.modal('🚚 Optimisation Routage Livreurs', `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <!-- Sélection livreur et commandes -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-black text-slate-900 mb-2">Sélectionner livreur</label>
                            <select id="route_livreur" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-black text-sm">
                                <option value="">-- Choisir un livreur --</option>
                                ${livreurs.map(l => `<option value="${l.id}">${l.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-black text-slate-900 mb-2">Commandes à router (${pendingOrders.length})</label>
                            <input type="number" id="route_order_count" value="${pendingOrders.length}" min="1" class="w-full px-3 py-2 border border-slate-300 rounded-lg font-black text-sm" readonly>
                        </div>
                    </div>

                    <!-- Aperçu des commandes -->
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <div class="font-black text-slate-900 mb-3">📦 Commandes en attente</div>
                        <div class="max-h-48 overflow-y-auto space-y-2">
                            ${pendingOrders.length > 0 ? pendingOrders.slice(0, 10).map(o => `
                                <div class="p-2 bg-white rounded border border-slate-200 text-sm">
                                    <div class="flex justify-between">
                                        <span class="font-black">${o.clientName}</span>
                                        <span class="text-xs text-slate-500">${CORE.formatPrice(o.total)}</span>
                                    </div>
                                    <div class="text-xs text-slate-600">📍 ${o.deliveryAddress}</div>
                                </div>
                            `).join('') : `<div class="text-slate-400 text-sm">Aucune commande en attente</div>`}
                        </div>
                    </div>

                    <!-- Options de clustering -->
                    <div class="p-4 bg-blue-50 rounded-2xl border border-blue-200">
                        <div class="font-black text-blue-900 mb-3">⚙️ Paramètres d'optimisation</div>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm font-black text-blue-800">Nombre de clusters</label>
                                <input type="number" id="route_clusters" value="${Math.ceil(pendingOrders.length / 8)}" min="1" max="10" class="w-full px-3 py-2 border border-blue-300 rounded-lg font-black text-sm mt-1">
                                <div class="text-xs text-blue-600 mt-1">Groupes géographiques d'adresses</div>
                            </div>
                        </div>
                    </div>

                    <!-- Résultats (sera rempli après optimisation) -->
                    <div id="route_results" class="hidden p-4 bg-emerald-50 rounded-2xl border border-emerald-200">
                        <div class="font-black text-emerald-900 mb-3">✓ Route Optimisée</div>
                        <div id="route_results_content"></div>
                    </div>

                    <!-- Stats de l'optimisation -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <div class="text-xs font-black text-slate-600">Distance totale</div>
                            <div class="text-lg font-black text-slate-900 mt-2" id="route_distance">-</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <div class="text-xs font-black text-slate-600">Temps estimé</div>
                            <div class="text-lg font-black text-slate-900 mt-2" id="route_time">-</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <div class="text-xs font-black text-slate-600">Coût estimé</div>
                            <div class="text-lg font-black text-slate-900 mt-2" id="route_cost">-</div>
                        </div>
                    </div>
                </div>
            `, [
                {
                    label: '🔄 Optimiser Route',
                    onclick: `
                        const livreurId = parseId(document.getElementById('route_livreur').value);
                        const clusters = parseInt(document.getElementById('route_clusters').value);
                        if (!livreurId) {
                            UI.toast('Sélectionnez un livreur', 'warning');
                            return;
                        }

                        const orders = CORE.getVisibleOrders().filter(o => o.status === 'pending');
                        if (orders.length === 0) {
                            UI.toast('Aucune commande en attente', 'warning');
                            return;
                        }

                        const route = RoutageModule.createOptimizedRoute(livreurId, orders);
                        if (route) {
                            document.getElementById('route_distance').textContent = route.totalDistance.toFixed(1) + ' km';
                            document.getElementById('route_time').textContent = route.estimatedTime + ' min';
                            document.getElementById('route_cost').textContent = CORE.formatPrice(route.estimatedCost);
                            document.getElementById('route_results').classList.remove('hidden');
                            document.getElementById('route_results_content').innerHTML = RoutageModule.visualizeRoute(route);
                            UI.toast('✓ Route optimisée avec succès!', 'success');
                        } else {
                            UI.toast('Erreur lors de l\\'optimisation', 'error');
                        }
                    `,
                    class: 'px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700'
                },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showLivreurRoutes() {
            const livreurs = CORE.getVisibleUsers().filter(u => u.role === 'livreur' && u.active);

            UI.modal('🚚 Routes Planifiées - Vue Manager', `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    ${livreurs.map(livreur => {
                        const routes = RoutageModule.getRoutesByLivreur(livreur.id, CORE.todayKey());
                        return `
                            <div class="p-4 border border-slate-200 rounded-2xl">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="font-black text-slate-900">${livreur.name}</div>
                                    <span class="px-3 py-1 rounded-full text-xs font-black ${
                                        routes.length > 0
                                        ? 'bg-emerald-100 text-emerald-700'
                                        : 'bg-slate-100 text-slate-600'
                                    }">
                                        ${routes.length} route(s)
                                    </span>
                                </div>
                                ${routes.length > 0 ? routes.map(route => `
                                    <div class="mb-3 p-3 bg-slate-50 rounded-lg border border-slate-200">
                                        <div class="flex justify-between mb-2">
                                            <span class="font-black text-sm">${route.status === 'completed' ? '✅' : route.status === 'in_progress' ? '🚚' : '📅'} ${route.status}</span>
                                            <span class="text-xs font-black text-slate-600">${route.stops.length} arrêts • ${route.totalDistance.toFixed(1)} km</span>
                                        </div>
                                        <button onclick="RoutageModule.showRouteDetails(${route.id})" class="text-xs font-black text-blue-600 hover:underline">
                                            Voir détails →
                                        </button>
                                    </div>
                                `).join('') : `<div class="text-sm text-slate-400">Aucune route programmée</div>`}
                            </div>
                        `;
                    }).join('')}
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showPaymentsDashboard() {
            const payments = CORE.db.mobilePayments || [];
            const history = CORE.db.paymentHistory || [];

            // Revenue by provider
            const revenueByProvider = {};
            const successByProvider = {};
            const countByProvider = {};
            payments.forEach(p => {
                if (!revenueByProvider[p.provider]) {
                    revenueByProvider[p.provider] = 0;
                    successByProvider[p.provider] = 0;
                    countByProvider[p.provider] = 0;
                }
                revenueByProvider[p.provider] += p.amount || 0;
                countByProvider[p.provider]++;
                if (p.status === 'completed') successByProvider[p.provider]++;
            });

            // Top clients by spending
            const clientSpending = {};
            payments.filter(p => p.status === 'completed').forEach(p => {
                if (!clientSpending[p.clientId]) clientSpending[p.clientId] = 0;
                clientSpending[p.clientId] += p.amount || 0;
            });
            const topClients = Object.entries(clientSpending)
                .map(([cid, amount]) => ({ clientId: cid, amount }))
                .sort((a, b) => b.amount - a.amount)
                .slice(0, 5);

            // Payment success rate
            const totalPayments = payments.length;
            const completedPayments = payments.filter(p => p.status === 'completed').length;
            const successRate = totalPayments > 0 ? Math.round((completedPayments / totalPayments) * 100) : 0;

            // Total revenue
            const totalRevenue = payments
                .filter(p => p.status === 'completed')
                .reduce((sum, p) => sum + (p.amount || 0), 0);

            const content = `
                <div class="space-y-6">
                    <!-- KPI Cards -->
                    <div class="grid grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                            <div class="text-xs font-semibold text-green-700 uppercase tracking-wide">Chiffre Affaires</div>
                            <div class="text-2xl font-bold text-green-900 mt-2">${totalRevenue.toLocaleString()} FCFA</div>
                            <div class="text-xs text-green-600 mt-1">Depuis le début</div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                            <div class="text-xs font-semibold text-blue-700 uppercase tracking-wide">Taux Succès</div>
                            <div class="text-2xl font-bold text-blue-900 mt-2">${successRate}%</div>
                            <div class="text-xs text-blue-600 mt-1">${completedPayments} / ${totalPayments} paiements</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200">
                            <div class="text-xs font-semibold text-purple-700 uppercase tracking-wide">Paiements</div>
                            <div class="text-2xl font-bold text-purple-900 mt-2">${totalPayments}</div>
                            <div class="text-xs text-purple-600 mt-1">${completedPayments} complétés</div>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border border-orange-200">
                            <div class="text-xs font-semibold text-orange-700 uppercase tracking-wide">Ticket Moyen</div>
                            <div class="text-2xl font-bold text-orange-900 mt-2">${totalPayments > 0 ? Math.round(totalRevenue / totalPayments).toLocaleString() : '0'} FCFA</div>
                            <div class="text-xs text-orange-600 mt-1">Par paiement</div>
                        </div>
                    </div>

                    <!-- Revenue by Provider -->
                    <div class="bg-white rounded-lg border border-slate-200 p-4">
                        <h3 class="font-bold text-slate-900 mb-4">💳 Revenus par Fournisseur</h3>
                        <div class="space-y-3">
                            ${['MTN Money', 'Airtel Money', 'Orange Money'].map(provider => {
                                const key = provider.split(' ')[0].toUpperCase();
                                const amount = revenueByProvider[key] || 0;
                                const count = countByProvider[key] || 0;
                                const success = successByProvider[key] || 0;
                                const rate = count > 0 ? Math.round((success / count) * 100) : 0;
                                const color = key === 'MTN' ? 'yellow' : key === 'AIRTEL' ? 'red' : 'orange';
                                return `
                                    <div class="flex items-center justify-between p-3 bg-${color}-50 rounded border border-${color}-200">
                                        <div>
                                            <div class="font-semibold text-slate-900">${provider}</div>
                                            <div class="text-xs text-slate-600">${count} paiements (${rate}% succès)</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-${color}-900">${amount.toLocaleString()} FCFA</div>
                                            <div class="text-xs text-${color}-700">${success} complétés</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Top Clients by Spending -->
                    <div class="bg-white rounded-lg border border-slate-200 p-4">
                        <h3 class="font-bold text-slate-900 mb-4">👥 Top 5 Clients (Dépenses)</h3>
                        ${topClients.length > 0 ? `
                            <div class="space-y-2">
                                ${topClients.map((client, idx) => {
                                    const clientObj = CORE.getVisibleClients().find(c => c.id === client.clientId);
                                    const clientName = clientObj?.name || 'Client inconnu';
                                    return `
                                        <div class="flex items-center justify-between p-2 hover:bg-slate-50 rounded">
                                            <div class="flex items-center space-x-2">
                                                <div class="w-6 h-6 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white text-xs font-bold">${idx + 1}</div>
                                                <div class="text-sm font-medium text-slate-900">${clientName}</div>
                                            </div>
                                            <div class="text-sm font-bold text-green-600">${client.amount.toLocaleString()} FCFA</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `<div class="text-sm text-slate-400">Aucun paiement complété</div>`}
                    </div>

                    <!-- Recent Payments -->
                    <div class="bg-white rounded-lg border border-slate-200 p-4">
                        <h3 class="font-bold text-slate-900 mb-4">📋 Paiements Récents</h3>
                        ${payments.length > 0 ? `
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="border-b border-slate-200">
                                            <th class="text-left py-2 px-2 font-semibold text-slate-600">Client</th>
                                            <th class="text-left py-2 px-2 font-semibold text-slate-600">Fournisseur</th>
                                            <th class="text-right py-2 px-2 font-semibold text-slate-600">Montant</th>
                                            <th class="text-left py-2 px-2 font-semibold text-slate-600">Statut</th>
                                            <th class="text-left py-2 px-2 font-semibold text-slate-600">Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${payments.slice(0, 10).map(p => {
                                            const clientObj = CORE.getVisibleClients().find(c => c.id === p.clientId);
                                            const clientName = clientObj?.name || 'Client inconnu';
                                            const statusColor = p.status === 'completed' ? 'green' : p.status === 'failed' ? 'red' : 'yellow';
                                            const statusLabel = p.status === 'completed' ? '✓ Complété' : p.status === 'failed' ? '✗ échoué' : '⏳ En attente';
                                            return `
                                                <tr class="border-b border-slate-100 hover:bg-slate-50">
                                                    <td class="py-2 px-2 text-slate-900">${clientName}</td>
                                                    <td class="py-2 px-2 text-slate-700">${p.provider}</td>
                                                    <td class="py-2 px-2 text-right font-semibold text-slate-900">${(p.amount || 0).toLocaleString()} FCFA</td>
                                                    <td class="py-2 px-2"><span class="px-2 py-1 rounded text-xs font-semibold bg-${statusColor}-100 text-${statusColor}-700">${statusLabel}</span></td>
                                                    <td class="py-2 px-2 text-slate-600 text-xs">${new Date(p.createdAt).toLocaleDateString('fr-FR')}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `<div class="text-sm text-slate-400">Aucun paiement enregistré</div>`}
                    </div>
                </div>
            `;

            UI.modal(content, [
                { label: 'Exporter', onclick: `ManagerModule.exportPaymentsReport()` },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], 'Tableau de Bord des Paiements Mobiles');
        },

        exportPaymentsReport() {
            const payments = CORE.db.mobilePayments || [];
            const headers = ['Date', 'Client', 'Fournisseur', 'Montant', 'Statut'];
            const rows = payments.map(p => {
                const clientObj = CORE.getVisibleClients().find(c => c.id === p.clientId);
                return [
                    new Date(p.createdAt).toLocaleDateString('fr-FR'),
                    clientObj?.name || 'Client inconnu',
                    p.provider,
                    (p.amount || 0).toLocaleString() + ' FCFA',
                    p.status === 'completed' ? '✓ Complété' : p.status === 'failed' ? '✗ échoué' : '⏳ En attente'
                ];
            });

            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `paiements_mobiles_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            UI.toast('Rapport exporté avec succès', 'success');
        }
    };

    // =========================================================
    // MODULE: VALIDATION MULTI-NIVEAUX
    // =========================================================
    const ValidationModule = {

        // ===== INITIALISER RÈGLES PAR DÉFAUT =====
        initializeRules() {
            if (!CORE.db.validationRules || CORE.db.validationRules.length === 0) {
                CORE.db.validationRules = [
                    { id: Utils.uid('RULE'), entityType: 'order', threshold: 500000, action: 'require_approval', level: 'manager', enabled: true, description: 'Commandes > 500k' },
                    { id: Utils.uid('RULE'), entityType: 'return', threshold: 3, action: 'require_justification', level: 'manager', enabled: true, description: 'Retours > 3 articles' }
                ];
                CORE.save();
            }
        },

        // ===== VÉRIFIER SI VALIDATION REQUISE =====
        checkValidationRequired(entityType, amount, quantity = 0) {
            const rules = CORE.db.validationRules.filter(r => r.entityType === entityType && r.enabled);
            for (let rule of rules) {
                if (entityType === 'order' && amount > rule.threshold) {
                    return { required: true, rule };
                }
                if (entityType === 'return' && quantity > rule.threshold) {
                    return { required: true, rule };
                }
            }
            return { required: false };
        },

        // ===== SOUMETTRE COMMANDE POUR APPROBATION =====
        submitOrderForApproval(orderId) {
            const order = CORE.getVisibleOrders().find(o => o.id === orderId);
            if (!order) return false;

            const vendor = CORE.db.vendors?.find(v => v.id === order.vendorId);
            const approval = {
                id: Utils.uid('APPR'),
                orderId: orderId,
                vendorId: order.vendorId,
                vendorName: vendor?.name || 'Vendeur inconnu',
                amount: order.totalAmount || 0,
                status: 'pending',
                managerId: null,
                approverName: null,
                approvedAt: null,
                rejectionReason: null,
                createdAt: new Date().toISOString()
            };

            CORE.db.orderApprovals.push(approval);
            CORE.markDirty('orderApprovals');
            this.logAuditTrail('order', orderId, 'submitted', CORE.state.currentUser?.id, CORE.state.currentUser?.name, 'Soumise pour approbation', { amount: order.totalAmount });

            CORE.save();
            return approval.id;
        },

        // ===== APPROUVER COMMANDE =====
        approveOrder(approvalId, comments = '') {
            const approval = CORE.db.orderApprovals.find(a => a.id === approvalId);
            if (!approval) return false;

            approval.status = 'approved';
            approval.managerId = CORE.state.currentUser?.id;
            approval.approverName = CORE.state.currentUser?.name;
            approval.approvedAt = new Date().toISOString();

            const order = CORE.getVisibleOrders().find(o => o.id === approval.orderId);
            if (order) {
                order.approvalStatus = 'approved';
                order.approvedBy = CORE.state.currentUser?.name;
                order.approvedAt = new Date().toISOString();
            }

            CORE.markDirty('orderApprovals');
            this.logAuditTrail('order', approval.orderId, 'approved', CORE.state.currentUser?.id, CORE.state.currentUser?.name, comments || 'Approuvée', {});

            CORE.save();
            UI.toast(`✓ Commande approuvée (${CORE.formatPrice(approval.amount)})`, 'success');
            return true;
        },

        // ===== REJETER COMMANDE =====
        rejectOrder(approvalId, reason = '') {
            const approval = CORE.db.orderApprovals.find(a => a.id === approvalId);
            if (!approval) return false;

            approval.status = 'rejected';
            approval.managerId = CORE.state.currentUser?.id;
            approval.approverName = CORE.state.currentUser?.name;
            approval.rejectionReason = reason;

            const order = CORE.getVisibleOrders().find(o => o.id === approval.orderId);
            if (order) {
                order.approvalStatus = 'rejected';
                order.rejectionReason = reason;
            }

            CORE.markDirty('orderApprovals');
            this.logAuditTrail('order', approval.orderId, 'rejected', CORE.state.currentUser?.id, CORE.state.currentUser?.name, reason || 'Rejetée', {});

            CORE.save();
            UI.toast(`✗ Commande rejetée`, 'error');
            return true;
        },

        // ===== SOUMETTRE RETOUR POUR JUSTIFICATION =====
        submitReturnForJustification(returnId, reason, description, itemCount) {
            const returnObj = CORE.db.returns?.find(r => r.id === returnId);
            if (!returnObj) return false;

            const justification = {
                id: Utils.uid('JUST'),
                returnId: returnId,
                orderId: returnObj.orderId,
                itemCount: itemCount,
                reason: reason,
                description: description,
                status: 'pending',
                reviewedBy: null,
                reviewedAt: null,
                notes: '',
                attachments: [],
                createdAt: new Date().toISOString()
            };

            CORE.db.returnJustifications.push(justification);
            CORE.markDirty('returnJustifications');
            this.logAuditTrail('return', returnId, 'submitted', CORE.state.currentUser?.id, CORE.state.currentUser?.name, `Justification soumise: ${reason}`, { itemCount, reason });

            CORE.save();
            return justification.id;
        },

        // ===== APPROUVER RETOUR =====
        approveReturn(justificationId, notes = '') {
            const justification = CORE.db.returnJustifications.find(j => j.id === justificationId);
            if (!justification) return false;

            justification.status = 'approved';
            justification.reviewedBy = CORE.state.currentUser?.name;
            justification.reviewedAt = new Date().toISOString();
            justification.notes = notes;

            const returnObj = CORE.db.returns?.find(r => r.id === justification.returnId);
            if (returnObj) {
                returnObj.justificationStatus = 'approved';
                returnObj.approvedBy = CORE.state.currentUser?.name;
            }

            this.logAuditTrail('return', justification.returnId, 'approved', CORE.state.currentUser?.id, CORE.state.currentUser?.name, notes || 'Justification approuvée', {});

            CORE.save();
            UI.toast(`✓ Retour approuvé (${justification.itemCount} articles)`, 'success');
            return true;
        },

        // ===== REJETER RETOUR =====
        rejectReturn(justificationId, reason = '') {
            const justification = CORE.db.returnJustifications.find(j => j.id === justificationId);
            if (!justification) return false;

            justification.status = 'rejected';
            justification.reviewedBy = CORE.state.currentUser?.name;
            justification.reviewedAt = new Date().toISOString();
            justification.notes = reason;

            const returnObj = CORE.db.returns?.find(r => r.id === justification.returnId);
            if (returnObj) {
                returnObj.justificationStatus = 'rejected';
            }

            this.logAuditTrail('return', justification.returnId, 'rejected', CORE.state.currentUser?.id, CORE.state.currentUser?.name, reason || 'Justification rejetée', {});

            CORE.save();
            UI.toast(`✗ Retour rejeté`, 'error');
            return true;
        },

        // ===== LOG AUDIT TRAIL =====
        logAuditTrail(entityType, entityId, action, userId, userName, reason, metadata = {}) {
            const auditEntry = {
                id: Utils.uid('AUDIT'),
                entityType: entityType,
                entityId: entityId,
                action: action,
                userId: userId,
                userName: userName,
                userRole: CORE.state.currentUser?.role,
                timestamp: new Date().toISOString(),
                reason: reason,
                metadata: metadata
            };

            CORE.db.approvalAuditTrail.push(auditEntry);
        },

        // ===== RÉCUPÉRER APPROBATIONS EN ATTENTE =====
        getPendingApprovals() {
            return CORE.db.orderApprovals.filter(a => a.status === 'pending');
        },

        // ===== RÉCUPÉRER JUSTIFICATIONS EN ATTENTE =====
        getPendingJustifications() {
            return CORE.db.returnJustifications.filter(j => j.status === 'pending');
        },

        // ===== AFFICHER MODAL APPROBATIONS MANAGER =====
        showApprovalsModal() {
            const approvals = this.getPendingApprovals();
            const approved = CORE.db.orderApprovals.filter(a => a.status === 'approved').length;
            const rejected = CORE.db.orderApprovals.filter(a => a.status === 'rejected').length;

            const content = `
                <div class="space-y-6">
                    <!-- Stats -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-amber-50 rounded-lg p-4 border border-amber-200">
                            <div class="text-xs font-bold text-amber-700 uppercase">En attente</div>
                            <div class="text-3xl font-black text-amber-900 mt-2">${approvals.length}</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                            <div class="text-xs font-bold text-green-700 uppercase">Approuvées</div>
                            <div class="text-3xl font-black text-green-900 mt-2">${approved}</div>
                        </div>
                        <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                            <div class="text-xs font-bold text-red-700 uppercase">Rejetées</div>
                            <div class="text-3xl font-black text-red-900 mt-2">${rejected}</div>
                        </div>
                    </div>

                    <!-- Approbations en attente -->
                    <div class="bg-white rounded-lg border border-slate-200 p-4">
                        <h3 class="font-bold text-slate-900 mb-4">📋 Approbations en Attente</h3>
                        ${approvals.length === 0 ? `
                            <div class="text-center text-slate-400 py-8">✓ Aucune approbation en attente</div>
                        ` : `
                            <div class="space-y-3">
                                ${approvals.map(a => `
                                    <div class="border border-slate-200 rounded-lg p-4 hover:shadow-md transition">
                                        <div class="flex items-start justify-between mb-3">
                                            <div>
                                                <div class="font-bold text-slate-900">${a.vendorName}</div>
                                                <div class="text-xs text-slate-500">Commande: ${a.orderId}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-lg font-black text-slate-900">${CORE.formatPrice(a.amount)}</div>
                                                <div class="text-xs text-amber-600 font-bold">⏳ Depuis ${new Date(a.createdAt).toLocaleDateString('fr-FR')}</div>
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="ValidationModule.showApprovalDetail('${a.id}')" class="flex-1 px-3 py-2 bg-blue-500 text-white rounded text-xs font-bold hover:bg-blue-600">📋 Détails</button>
                                            <button onclick="ValidationModule.showApproveModal('${a.id}')" class="flex-1 px-3 py-2 bg-green-600 text-white rounded text-xs font-bold hover:bg-green-700">✓ Approuver</button>
                                            <button onclick="ValidationModule.showRejectModal('${a.id}')" class="flex-1 px-3 py-2 bg-red-600 text-white rounded text-xs font-bold hover:bg-red-700">✗ Rejeter</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>

                    <!-- Historique -->
                    <div class="bg-white rounded-lg border border-slate-200 p-4">
                        <h3 class="font-bold text-slate-900 mb-4">📊 Historique Validations</h3>
                        <div class="space-y-2">
                            ${CORE.db.orderApprovals.slice(0, 10).map(a => {
                                const statusBadge = a.status === 'approved' ? '✓ Approuvée' : a.status === 'rejected' ? '✗ Rejetée' : '⏳ En attente';
                                const statusColor = a.status === 'approved' ? 'green' : a.status === 'rejected' ? 'red' : 'amber';
                                return `
                                    <div class="flex items-center justify-between p-2 hover:bg-slate-50">
                                        <div>
                                            <div class="text-sm font-medium text-slate-900">${a.vendorName}</div>
                                            <div class="text-xs text-slate-500">${new Date(a.createdAt).toLocaleDateString('fr-FR')}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-bold text-slate-900">${CORE.formatPrice(a.amount)}</div>
                                            <span class="px-2 py-1 rounded text-xs font-bold bg-${statusColor}-100 text-${statusColor}-700">${statusBadge}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;

            UI.modal(content, [
                { label: 'Audit Trail', onclick: 'ValidationModule.showAuditTrail()' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], '✓ Gestion des Approbations');
        },

        // ===== AFFICHER MODAL JUSTIFICATIONS RETOURS =====
        showJustificationsModal() {
            const justifications = this.getPendingJustifications();
            const approved = CORE.db.returnJustifications.filter(j => j.status === 'approved').length;
            const rejected = CORE.db.returnJustifications.filter(j => j.status === 'rejected').length;

            const content = `
                <div class="space-y-6">
                    <!-- Stats -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-amber-50 rounded-lg p-4 border border-amber-200">
                            <div class="text-xs font-bold text-amber-700 uppercase">En attente</div>
                            <div class="text-3xl font-black text-amber-900 mt-2">${justifications.length}</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                            <div class="text-xs font-bold text-green-700 uppercase">Approuvées</div>
                            <div class="text-3xl font-black text-green-900 mt-2">${approved}</div>
                        </div>
                        <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                            <div class="text-xs font-bold text-red-700 uppercase">Rejetées</div>
                            <div class="text-3xl font-black text-red-900 mt-2">${rejected}</div>
                        </div>
                    </div>

                    <!-- Justifications en attente -->
                    <div class="bg-white rounded-lg border border-slate-200 p-4">
                        <h3 class="font-bold text-slate-900 mb-4">📋 Justifications en Attente</h3>
                        ${justifications.length === 0 ? `
                            <div class="text-center text-slate-400 py-8">✓ Aucune justification en attente</div>
                        ` : `
                            <div class="space-y-3">
                                ${justifications.map(j => `
                                    <div class="border border-slate-200 rounded-lg p-4 hover:shadow-md transition">
                                        <div class="flex items-start justify-between mb-2">
                                            <div>
                                                <div class="font-bold text-slate-900">Retour: ${j.returnId}</div>
                                                <div class="text-xs text-slate-500">Commande: ${j.orderId} | ${j.itemCount} articles</div>
                                                <div class="text-sm text-slate-700 mt-1"><strong>Raison:</strong> ${j.reason}</div>
                                                <div class="text-sm text-slate-600 mt-1">${j.description}</div>
                                            </div>
                                        </div>
                                        <div class="flex gap-2 mt-3">
                                            <button onclick="ValidationModule.showJustificationDetail('${j.id}')" class="flex-1 px-3 py-2 bg-blue-500 text-white rounded text-xs font-bold hover:bg-blue-600">📋 Détails</button>
                                            <button onclick="ValidationModule.showApproveReturnModal('${j.id}')" class="flex-1 px-3 py-2 bg-green-600 text-white rounded text-xs font-bold hover:bg-green-700">✓ Approuver</button>
                                            <button onclick="ValidationModule.showRejectReturnModal('${j.id}')" class="flex-1 px-3 py-2 bg-red-600 text-white rounded text-xs font-bold hover:bg-red-700">✗ Rejeter</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;

            UI.modal(content, [
                { label: 'Audit Trail', onclick: 'ValidationModule.showAuditTrail()' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], '✓ Gestion des Justifications');
        },

        // ===== AFFICHER MODAL APPROBATION =====
        showApproveModal(approvalId) {
            const approval = CORE.db.orderApprovals.find(a => a.id === approvalId);
            if (!approval) return;

            const content = `
                <div class="space-y-4">
                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <div class="text-sm text-blue-700"><strong>Vendeur:</strong> ${approval.vendorName}</div>
                        <div class="text-sm text-blue-700 mt-1"><strong>Montant:</strong> ${CORE.formatPrice(approval.amount)}</div>
                        <div class="text-sm text-blue-700 mt-1"><strong>Commande:</strong> ${approval.orderId}</div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-900 mb-2">Commentaire (optionnel)</label>
                        <textarea id="approval-comments" class="w-full px-4 py-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-green-500 bg-slate-50" rows="4" placeholder="Ajoutez un commentaire..."></textarea>
                    </div>

                    <div class="bg-green-50 rounded-lg p-4 border border-green-200 text-sm text-green-700">
                        ✓ Cette approbation sera enregistrée dans l'audit trail
                    </div>
                </div>
            `;

            UI.modal(content, [
                { label: '✓ Approuver', onclick: `ValidationModule.approveOrder('${approvalId}', document.getElementById('approval-comments')?.value || '')` },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ], '✓ Approuver Commande');
        },

        // ===== AFFICHER MODAL REJET =====
        showRejectModal(approvalId) {
            const approval = CORE.db.orderApprovals.find(a => a.id === approvalId);
            if (!approval) return;

            const content = `
                <div class="space-y-4">
                    <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                        <div class="text-sm text-red-700"><strong>Vendeur:</strong> ${approval.vendorName}</div>
                        <div class="text-sm text-red-700 mt-1"><strong>Montant:</strong> ${CORE.formatPrice(approval.amount)}</div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-900 mb-2">Raison du rejet</label>
                        <textarea id="reject-reason" class="w-full px-4 py-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-red-500 bg-slate-50" rows="4" placeholder="Expliquez pourquoi vous rejetez cette commande..."></textarea>
                    </div>

                    <div class="bg-red-50 rounded-lg p-4 border border-red-200 text-sm text-red-700">
                        ✗ Le vendeur sera notifié du rejet
                    </div>
                </div>
            `;

            UI.modal(content, [
                { label: '✗ Rejeter', onclick: `ValidationModule.rejectOrder('${approvalId}', document.getElementById('reject-reason')?.value || '')` },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ], '✗ Rejeter Commande');
        },

        // ===== AFFICHER MODAL APPROBATION RETOUR =====
        showApproveReturnModal(justificationId) {
            const justification = CORE.db.returnJustifications.find(j => j.id === justificationId);
            if (!justification) return;

            const content = `
                <div class="space-y-4">
                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <div class="text-sm text-blue-700"><strong>Retour:</strong> ${justification.returnId}</div>
                        <div class="text-sm text-blue-700 mt-1"><strong>Articles:</strong> ${justification.itemCount}</div>
                        <div class="text-sm text-blue-700 mt-1"><strong>Raison:</strong> ${justification.reason}</div>
                        <div class="text-sm text-blue-700 mt-1"><strong>Description:</strong> ${justification.description}</div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-900 mb-2">Notes (optionnel)</label>
                        <textarea id="return-approve-notes" class="w-full px-4 py-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-green-500 bg-slate-50" rows="4" placeholder="Ajoutez vos notes..."></textarea>
                    </div>
                </div>
            `;

            UI.modal(content, [
                { label: '✓ Approuver', onclick: `ValidationModule.approveReturn('${justificationId}', document.getElementById('return-approve-notes')?.value || '')` },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ], '✓ Approuver Retour');
        },

        // ===== AFFICHER MODAL REJET RETOUR =====
        showRejectReturnModal(justificationId) {
            const justification = CORE.db.returnJustifications.find(j => j.id === justificationId);
            if (!justification) return;

            const content = `
                <div class="space-y-4">
                    <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                        <div class="text-sm text-red-700"><strong>Retour:</strong> ${justification.returnId}</div>
                        <div class="text-sm text-red-700 mt-1"><strong>Articles:</strong> ${justification.itemCount}</div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-900 mb-2">Raison du rejet</label>
                        <textarea id="return-reject-reason" class="w-full px-4 py-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-red-500 bg-slate-50" rows="4" placeholder="Expliquez pourquoi vous rejetez ce retour..."></textarea>
                    </div>
                </div>
            `;

            UI.modal(content, [
                { label: '✗ Rejeter', onclick: `ValidationModule.rejectReturn('${justificationId}', document.getElementById('return-reject-reason')?.value || '')` },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ], '✗ Rejeter Retour');
        },

        // ===== AFFICHER AUDIT TRAIL COMPLET =====
        showAuditTrail() {
            const entries = CORE.db.approvalAuditTrail.slice(-50);
            const content = `
                <div class="bg-white rounded-lg border border-slate-200">
                    <div class="p-4 border-b border-slate-200">
                        <h3 class="font-bold text-slate-900">📊 Audit Trail (dernières 50 actions)</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-slate-200 bg-slate-50">
                                    <th class="text-left py-2 px-3 font-bold text-slate-600">Date/Heure</th>
                                    <th class="text-left py-2 px-3 font-bold text-slate-600">Action</th>
                                    <th class="text-left py-2 px-3 font-bold text-slate-600">Utilisateur</th>
                                    <th class="text-left py-2 px-3 font-bold text-slate-600">Raison/Commentaire</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${entries.map(e => {
                                    const actionLabel = {
                                        'submitted': '📋 Soumise',
                                        'approved': '✓ Approuvée',
                                        'rejected': '✗ Rejetée',
                                        'created': '➕ Créée'
                                    }[e.action] || e.action;
                                    return `
                                        <tr class="border-b border-slate-100 hover:bg-slate-50">
                                            <td class="py-2 px-3 text-xs text-slate-600">${new Date(e.timestamp).toLocaleString('fr-FR')}</td>
                                            <td class="py-2 px-3"><strong>${e.entityType}</strong> - ${actionLabel}</td>
                                            <td class="py-2 px-3 text-slate-700">${e.userName} (${e.userRole})</td>
                                            <td class="py-2 px-3 text-slate-600">${e.reason}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            UI.modal(content, [
                { label: 'Export', onclick: 'ValidationModule.exportAuditTrail()' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], '📊 Audit Trail Complet');
        },

        // ===== EXPORTER AUDIT TRAIL =====
        exportAuditTrail() {
            const entries = CORE.db.approvalAuditTrail;
            const headers = ['Date', 'Heure', 'Type', 'Action', 'ID Entité', 'Utilisateur', 'Rôle', 'Raison'];
            const rows = entries.map(e => {
                const dt = new Date(e.timestamp);
                return [
                    dt.toLocaleDateString('fr-FR'),
                    dt.toLocaleTimeString('fr-FR'),
                    e.entityType,
                    e.action,
                    e.entityId,
                    e.userName,
                    e.userRole,
                    e.reason
                ];
            });

            const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `audit_trail_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            UI.toast('Audit trail exporté', 'success');
        },

        showApprovalDetail(id) { UI.toast('Détails approbation #' + id, 'info'); },
        showJustificationDetail(id) { UI.toast('Détails justification #' + id, 'info'); }
    };

    // =========================================================
    // MODULE: LIVREUR
    // =========================================================
    const LivreurModule = {
        state: {
            currentView: 'dashboard',
            isOnService: true,
            theme: 'light',
            historyFilters: { status: '', dateFrom: '', dateTo: '', clientName: '', searchQuery: '' },
            preferences: { notificationsEnabled: true, soundEnabled: true, soundVolume: 0.8 },
            // Notification polling
            lastKnownDeliveryIds: [],
            pollingInterval: null,
            // GPS tracking
            currentPosition: null,
            watchId: null
        },

        // =====================
        // NOTIFICATION POLLING (30s)
        // =====================
        startPolling() {
            if (this.state.pollingInterval) return;

            // Initialiser les IDs connus
            this.state.lastKnownDeliveryIds = this.getMyDeliveries().map(d => d.id);

            this.state.pollingInterval = setInterval(() => {
                this.checkNewDeliveries();
            }, 30000); // 30 secondes

            console.log('[LivreurModule] Polling démarré (30s)');
        },

        stopPolling() {
            if (this.state.pollingInterval) {
                clearInterval(this.state.pollingInterval);
                this.state.pollingInterval = null;
                console.log('[LivreurModule] Polling arrêté');
            }
        },

        checkNewDeliveries() {
            // Vérifier nouvelles courses assignées
            const currentDeliveries = this.getMyDeliveries();
            const currentIds = currentDeliveries.map(d => d.id);
            const newDeliveries = currentDeliveries.filter(d => !this.state.lastKnownDeliveryIds.includes(d.id));

            if (newDeliveries.length > 0) {
                // Nouvelles courses assignées !
                newDeliveries.forEach(d => {
                    this.showNewDeliveryNotification(d);
                });

                // Jouer le son si activé
                if (this.state.preferences.soundEnabled) {
                    UI.playNotificationSound();
                }
            }

            this.state.lastKnownDeliveryIds = currentIds;

            // Vérifier aussi les nouvelles courses disponibles (non assignées)
            const pendingDeliveries = this.getPendingDeliveries();
            const pendingIds = pendingDeliveries.map(d => d.id);
            const lastKnownPendingIds = this.state.lastKnownPendingIds || [];
            const newPending = pendingDeliveries.filter(d => !lastKnownPendingIds.includes(d.id));

            if (newPending.length > 0) {
                // Nouvelles courses disponibles !
                this.showNewPendingNotification(newPending.length);

                if (this.state.preferences.soundEnabled) {
                    UI.playNotificationSound();
                }

                // Rafraîchir l'affichage
                App.rerender();
            }

            this.state.lastKnownPendingIds = pendingIds;
        },

        // Notification pour nouvelles courses disponibles
        showNewPendingNotification(count) {
            const notifContainer = document.getElementById('livreur-notifications') || this.createNotificationContainer();

            const notifId = 'notif-pending-' + Date.now();
            const notifHtml = `
                <div id="${notifId}" class="bg-gradient-to-r from-amber-500 to-orange-500 text-white p-4 rounded-2xl shadow-2xl mb-3 slide-up cursor-pointer" onclick="LivreurModule.navigateTo('dashboard'); document.getElementById('${notifId}').remove();">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <span class="text-2xl">📦</span>
                        </div>
                        <div class="flex-1">
                            <div class="font-black">${count} nouvelle(s) course(s) disponible(s) !</div>
                            <div class="text-sm text-white/90">Cliquez pour voir et accepter</div>
                        </div>
                        <button onclick="event.stopPropagation(); document.getElementById('${notifId}').remove();" class="text-xs text-white/70 hover:text-white">✕</button>
                    </div>
                </div>`;

            notifContainer.insertAdjacentHTML('beforeend', notifHtml);

            // Auto-fermeture après 10 secondes
            setTimeout(() => {
                const el = document.getElementById(notifId);
                if (el) el.remove();
            }, 10000);
        },

        showNewDeliveryNotification(delivery) {
            // Notification visuelle persistante
            const notifContainer = document.getElementById('livreur-notifications') || this.createNotificationContainer();

            const notifId = 'notif-' + delivery.id;
            const notifHtml = `
                <div id="${notifId}" class="bg-gradient-to-r from-emerald-500 to-teal-500 text-white p-4 rounded-2xl shadow-2xl mb-3 slide-up cursor-pointer" onclick="LivreurModule.viewDeliveryDetail(${delivery.id}); document.getElementById('${notifId}').remove();">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                            <span class="text-2xl">🚚</span>
                        </div>
                        <div class="flex-1">
                            <div class="font-black">Nouvelle course !</div>
                            <div class="text-sm text-white/90">${delivery.orderRef} • ${delivery.clientName}</div>
                            <div class="text-xs text-white/70 mt-1">${delivery.address || 'Adresse non spécifiée'}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-black text-lg">${CORE.formatPrice(delivery.amount)}</div>
                            <button onclick="event.stopPropagation(); document.getElementById('${notifId}').remove();" class="text-xs text-white/70 hover:text-white mt-1">✕ Fermer</button>
                        </div>
                    </div>
                </div>
            `;

            notifContainer.insertAdjacentHTML('beforeend', notifHtml);

            // Auto-disparition après 15 secondes
            setTimeout(() => {
                const el = document.getElementById(notifId);
                if (el) el.remove();
            }, 15000);
        },

        createNotificationContainer() {
            const container = document.createElement('div');
            container.id = 'livreur-notifications';
            container.className = 'fixed top-20 left-4 right-4 z-[100] pointer-events-auto';
            document.body.appendChild(container);
            return container;
        },

        // =====================
        // GPS TRACKING
        // =====================
        startGPSTracking() {
            if (!navigator.geolocation) {
                console.warn('[LivreurModule] Géolocalisation non supportée');
                return;
            }

            this.state.watchId = navigator.geolocation.watchPosition(
                (position) => {
                    this.state.currentPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };
                    this.updatePositionInDB();
                },
                (error) => {
                    console.error('[LivreurModule] Erreur GPS:', error);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 5000
                }
            );

            console.log('[LivreurModule] GPS tracking démarré');
        },

        stopGPSTracking() {
            if (this.state.watchId) {
                navigator.geolocation.clearWatch(this.state.watchId);
                this.state.watchId = null;
                console.log('[LivreurModule] GPS tracking arrêté');
            }
        },

        updatePositionInDB() {
            const uid = CORE.state.currentUser?.id;
            if (!uid || !this.state.currentPosition) return;

            // Stocker la position dans la DB pour que le vendeur puisse la voir
            CORE.db.livreurPositions = CORE.db.livreurPositions || {};
            CORE.db.livreurPositions[uid] = {
                ...this.state.currentPosition,
                livreurId: uid,
                livreurName: CORE.state.currentUser?.name,
                isOnService: this.state.isOnService
            };

            // Sauvegarder (optionnel - peut être lourd si fréquent)
            // CORE.save();
        },

        // =====================
        // ESTIMATION TEMPS LIVRAISON
        // =====================
        estimateDeliveryTime(delivery) {
            if (!delivery || !delivery.address) return null;

            // Estimation basée sur la distance (si disponible)
            const distance = delivery.estimatedDistance || 5; // km par défaut
            const avgSpeed = 25; // km/h en ville
            const prepTime = 10; // minutes de préparation

            const travelTime = Math.round((distance / avgSpeed) * 60);
            const totalTime = prepTime + travelTime;

            return {
                prepTime,
                travelTime,
                totalTime,
                estimatedArrival: new Date(Date.now() + totalTime * 60000).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })
            };
        },

        // =====================
        // INITIALISATION
        // =====================
        init() {
            this.loadThemePreference();
            this.loadPreferences();
            this.startPolling();

            if (this.state.isOnService) {
                this.startGPSTracking();
            }
        },

        cleanup() {
            this.stopPolling();
            this.stopGPSTracking();
        },

        loadPreferences() {
            try {
                const saved = localStorage.getItem('livreur_preferences');
                if (saved) {
                    this.state.preferences = { ...this.state.preferences, ...JSON.parse(saved) };
                }
            } catch(e) {}
        },

        getMyDeliveries() {
            const uid = CORE.state.currentUser?.id;
            const userPos = CORE.state.currentUser?.pos;
            return CORE.getVisibleDeliveries().filter(d =>
                d.livreurId === uid &&
                (String(d.posId) === String(userPos) || !d.posId || !userPos)
            ).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
        },

        // Livraisons en attente d'assignation (non assignées) du POS du livreur
        getPendingDeliveries() {
            const userPos = CORE.state.currentUser?.pos;
            if (!userPos) return [];
            // Inclure toutes les livraisons en attente du POS (non assignées ou status réservation)
            return CORE.getVisibleDeliveries().filter(d =>
                !d.livreurId &&
                String(d.posId) === String(userPos) &&
                (d.status === 'en_attente' || d.status === 'reservation')
            ).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
        },

        // Auto-accepter une livraison en attente
        acceptPendingDelivery(deliveryId) {
            const uid = CORE.state.currentUser?.id;
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return UI.toast('Livraison introuvable', 'error');
            if (d.livreurId) return UI.toast('Cette livraison a déjà été prise', 'warning');

            CORE.update('deliveries', d.id, {
                livreurId: uid,
                status: 'en_attente',
                assignedAt: new Date().toISOString()
            });

            CORE.logActivity('accept', 'delivery', d.id, {
                entityName: `Commande ${d.orderRef}`,
                description: `Livraison acceptée par le livreur`,
                before: { livreurId: null },
                after: { livreurId: uid }
            });

            UI.toast(`✓ Livraison ${d.orderRef} acceptée!`, 'success');
            App.rerender();
        },

        getFilteredDeliveries() {
            let all = this.getMyDeliveries();
            const f = this.state.historyFilters;

            // Filtre statut
            if (f.status) {
                all = all.filter(d => d.status === f.status);
            }

            // Filtre date depuis
            if (f.dateFrom) {
                const fromDate = new Date(f.dateFrom);
                all = all.filter(d => new Date(d.createdAt) >= fromDate);
            }

            // Filtre date jusqu'à
            if (f.dateTo) {
                const toDate = new Date(f.dateTo);
                toDate.setHours(23, 59, 59, 999);
                all = all.filter(d => new Date(d.createdAt) <= toDate);
            }

            // Filtre client
            if (f.clientName) {
                all = all.filter(d => d.clientName.toLowerCase().includes(f.clientName.toLowerCase()));
            }

            // Filtre recherche globale
            if (f.searchQuery) {
                const q = f.searchQuery.toLowerCase();
                all = all.filter(d =>
                    d.orderRef.toLowerCase().includes(q) ||
                    d.clientName.toLowerCase().includes(q) ||
                    (d.address || '').toLowerCase().includes(q) ||
                    (d.clientPhone || '').toLowerCase().includes(q)
                );
            }

            return all;
        },

        navigateTo(view) {
            this.state.currentView = view;
            if (view !== 'historique') {
                this.state.historyFilters = { status: '', dateFrom: '', dateTo: '', clientName: '', searchQuery: '' };
            }
            App.rerender();
        },
        toggleService() { this.state.isOnService = !this.state.isOnService; UI.toast(this.state.isOnService ? 'En service' : 'Hors service', 'info'); App.rerender(); },

        setTheme(theme) {
            this.state.theme = theme;
            localStorage.setItem('livreur_theme', theme);
            this.applyTheme();
            UI.toast(`Thème: ${theme === 'light' ? '☀️ Clair' : theme === 'dark' ? '🌙 Sombre' : '🔄 Auto'}`, 'success');
            App.rerender();
        },

        applyTheme() {
            const html = document.documentElement;
            const theme = this.state.theme;

            // Retirer les autres classes de thème
            html.classList.remove('livreur-dark', 'vendeur-dark');
            html.style.filter = 'none';

            if (theme === 'dark') {
                html.classList.add('livreur-dark');
            } else if (theme === 'auto') {
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (isDark) {
                    html.classList.add('livreur-dark');
                }
            }
            // 'light' = pas de classe, thème par défaut
        },

        loadThemePreference() {
            const saved = localStorage.getItem('livreur_theme');
            if (saved) {
                this.state.theme = saved;
                this.applyTheme();
            }
        },

        savePreferences() {
            try {
                localStorage.setItem('livreur_preferences', JSON.stringify(this.state.preferences));
                CORE.save();
            } catch(e) {
                console.error('Error saving livreur preferences:', e);
            }
        },

        // Support & À propos
        showFAQModal() {
            UI.modal('❓ Foire Aux Questions', `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                        <div class="font-black text-emerald-800 mb-2">Comment recevoir des livraisons ?</div>
                        <div class="text-sm text-emerald-700">Activez votre statut "En service" depuis le tableau de bord. Vous recevrez automatiquement les nouvelles courses assignées par les vendeurs.</div>
                    </div>
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="font-black text-blue-800 mb-2">Comment valider une livraison ?</div>
                        <div class="text-sm text-blue-700">Une fois chez le client, utilisez le bouton "Valider livraison" et ajoutez une photo de preuve ou une signature du client pour confirmer.</div>
                    </div>
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                        <div class="font-black text-amber-800 mb-2">Que faire en cas de problème ?</div>
                        <div class="text-sm text-amber-700">Signalez le problème via le bouton "Signaler problème" sur la livraison. Décrivez la situation et contactez le vendeur si nécessaire.</div>
                    </div>
                    <div class="p-4 bg-purple-50 border border-purple-200 rounded-2xl">
                        <div class="font-black text-purple-800 mb-2">Comment voir mes gains ?</div>
                        <div class="text-sm text-purple-700">Consultez l'onglet "Historique" pour voir toutes vos livraisons et le total de vos commissions.</div>
                    </div>
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="font-black text-slate-800 mb-2">Comment utiliser la navigation GPS ?</div>
                        <div class="text-sm text-slate-700">Cliquez sur "Naviguer" sur une livraison pour ouvrir l'adresse dans Google Maps ou votre application de navigation préférée.</div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-lg' });
            setTimeout(() => lucide.createIcons(), 50);
        },

        showSupportModal() {
            const pdv = CORE.db.pointsDeVente?.find(p => p.id === CORE.state.activePDV);
            const pdvPhone = pdv?.telephone || 'Non disponible';
            const pdvEmail = pdv?.email || 'support@raya.com';

            UI.modal('📞 Contacter le Support', `
                <div class="space-y-4">
                    <div class="p-5 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl text-white text-center">
                        <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="headphones" class="w-8 h-8"></i>
                        </div>
                        <div class="font-black text-xl">Besoin d'aide ?</div>
                        <div class="text-sm text-white/80">Notre équipe est là pour vous aider</div>
                    </div>

                    <div class="space-y-3">
                        <a href="tel:${pdvPhone.replace(/\s/g, '')}" class="flex items-center gap-4 p-4 bg-blue-50 border border-blue-200 rounded-2xl hover:bg-blue-100 transition">
                            <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                                <i data-lucide="phone" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-blue-800">Appeler la boutique</div>
                                <div class="text-sm text-blue-600">${pdvPhone}</div>
                            </div>
                        </a>

                        <a href="mailto:${pdvEmail}" class="flex items-center gap-4 p-4 bg-purple-50 border border-purple-200 rounded-2xl hover:bg-purple-100 transition">
                            <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center">
                                <i data-lucide="mail" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <div class="font-black text-purple-800">Envoyer un email</div>
                                <div class="text-sm text-purple-600">${pdvEmail}</div>
                            </div>
                        </a>

                        <a href="https://wa.me/${CORE.formatPhoneForWhatsApp(pdvPhone)}" target="_blank" class="flex items-center gap-4 p-4 bg-green-50 border border-green-200 rounded-2xl hover:bg-green-100 transition">
                            <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                            </div>
                            <div>
                                <div class="font-black text-green-800">WhatsApp</div>
                                <div class="text-sm text-green-600">Envoyer un message</div>
                            </div>
                        </a>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-md' });
            setTimeout(() => lucide.createIcons(), 50);
        },

        showVersionModal() {
            UI.modal(`ℹ️ À propos de ${CORE.getCompanyName()}`, `
                <div class="text-center space-y-6">
                    <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-3xl shadow-lg">
                        <span class="text-4xl font-black text-white">${CORE.getCompanyName().charAt(0)}</span>
                    </div>

                    <div>
                        <div class="text-2xl font-black text-slate-900">${CORE.getCompanyName()}</div>
                        <div class="text-sm text-slate-500">Système de gestion de boutique</div>
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase mb-2">Version</div>
                        <div class="text-xl font-black text-emerald-600">${CORE.config.version || '1.0.0'}</div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 text-xs">
                        <div class="p-3 bg-blue-50 rounded-xl">
                            <div class="font-black text-blue-800">Interface</div>
                            <div class="text-blue-600">Livreur Mobile</div>
                        </div>
                        <div class="p-3 bg-purple-50 rounded-xl">
                            <div class="font-black text-purple-800">Plateforme</div>
                            <div class="text-purple-600">Web Progressive</div>
                        </div>
                    </div>

                    <div class="text-xs text-slate-400">
                        © ${new Date().getFullYear()} RAYA - Tous droits réservés
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-sm' });
            setTimeout(() => lucide.createIcons(), 50);
        },

        loadPreferences() {
            try {
                const saved = localStorage.getItem('livreur_preferences');
                if (saved) {
                    this.state.preferences = { ...this.state.preferences, ...JSON.parse(saved) };
                }
            } catch(e) {
                console.error('Error loading livreur preferences:', e);
            }
        },

        getStats() {
            const all = this.getMyDeliveries();
            const done = all.filter(d => d.status === 'livree').length;
            const inProgress = all.filter(d => d.status === 'en_cours').length;
            const gainsJour = all.filter(d => (d.createdAt || '').startsWith(Utils.todayKey()) && d.status === 'livree').reduce((a,d)=>a+(d.commission||Math.round(d.amount*0.05)||0),0);
            return { done, inProgress, gainsJour };
        },

        getHistoryStats() {
            const filtered = this.getFilteredDeliveries();
            const totalLivrees = filtered.filter(d => d.status === 'livree').length;
            const totalProblemes = filtered.filter(d => d.status === 'probleme').length;
            const totalGains = filtered.filter(d => d.status === 'livree').reduce((a,d)=>a+(d.commission||Math.round(d.amount*0.05)||0),0);
            const totalChiffre = filtered.reduce((a,d)=>a+(d.amount||0),0);
            const moyennParLivraison = totalLivrees > 0 ? Math.round(totalChiffre / totalLivrees) : 0;

            return {
                total: filtered.length,
                livrees: totalLivrees,
                problemes: totalProblemes,
                gains: totalGains,
                chiffre: totalChiffre,
                moyenne: moyennParLivraison,
                tauxReussite: filtered.length > 0 ? Math.round((totalLivrees / filtered.length) * 100) : 0
            };
        },

        updateFilter(key, value) {
            this.state.historyFilters[key] = value;
            App.rerender();
        },

        updateLivreurSearch(value) {
            // Mettre à jour le state
            this.state.historyFilters.searchQuery = value;

            // Annuler le timer précédent
            if (this.searchQueryTimer) clearTimeout(this.searchQueryTimer);

            // Attendre 500ms avant de rerender
            this.searchQueryTimer = setTimeout(() => {
                const input = document.getElementById('livreur-search-input');
                const cursorPos = input?.selectionStart || 0;

                App.rerender();

                setTimeout(() => {
                    const newInput = document.getElementById('livreur-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateLivreurClientSearch(value) {
            // Mettre à jour le state
            this.state.historyFilters.clientName = value;

            // Annuler le timer précédent
            if (this.clientNameTimer) clearTimeout(this.clientNameTimer);

            // Attendre 500ms avant de rerender
            this.clientNameTimer = setTimeout(() => {
                const input = document.getElementById('livreur-client-search-input');
                const cursorPos = input?.selectionStart || 0;

                App.rerender();

                setTimeout(() => {
                    const newInput = document.getElementById('livreur-client-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        // État temporaire pour les photos de validation
        validationPhotos: [],
        signatureData: null,
        signatureCanvas: null,
        isDrawing: false,
        currentValidationSettings: null,

        // Afficher le modal de validation avec photos et signature
        showDeliveryValidationModal(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;

            // Récupérer les paramètres de validation du POS
            const posId = d.posId || d.vendeurId;
            const settings = CORE.getDeliveryValidationSettings(posId);
            this.currentValidationSettings = settings;

            // Réinitialiser les photos et signature
            this.validationPhotos = d.proofPhotos || [];
            this.signatureData = d.proofSignature || null;

            // Déterminer les instructions selon les paramètres
            let instructionText = '';
            let instructionIcon = 'camera';
            if (!settings.requirePhoto && !settings.requireSignature) {
                instructionText = 'Aucune preuve requise - Vous pouvez valider directement ou ajouter des preuves optionnellement';
                instructionIcon = 'check-circle';
            } else if (settings.requireBoth) {
                instructionText = `Ajoutez au moins ${settings.minPhotos || 1} photo(s) <strong>ET</strong> la signature du client pour valider`;
                instructionIcon = 'shield-check';
            } else if (settings.requirePhoto && settings.requireSignature) {
                instructionText = `Ajoutez ${settings.minPhotos || 1} photo(s) <strong>OU</strong> la signature du client pour valider`;
                instructionIcon = 'camera';
            } else if (settings.requirePhoto) {
                instructionText = `Ajoutez au moins ${settings.minPhotos || 1} photo(s) comme preuve de livraison`;
                instructionIcon = 'camera';
            } else if (settings.requireSignature) {
                instructionText = 'Obtenez la signature du client pour valider la livraison';
                instructionIcon = 'pen-tool';
            }

            // Masquer les sections non requises
            const showPhotoSection = settings.requirePhoto || settings.requireBoth || (!settings.requirePhoto && !settings.requireSignature);
            const showSignatureSection = settings.requireSignature || settings.requireBoth || (!settings.requirePhoto && !settings.requireSignature);

            UI.modal('📸 Valider la livraison', `
                <div class="space-y-4">
                    <!-- Info livraison -->
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-black text-slate-900">${d.orderRef}</div>
                                <div class="text-xs text-slate-500">${d.clientName || 'Client'}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Instructions dynamiques selon les paramètres -->
                    <div class="p-4 bg-blue-50 rounded-2xl border border-blue-200">
                        <div class="flex items-start gap-3">
                            <i data-lucide="${instructionIcon}" class="w-5 h-5 text-blue-600 mt-0.5"></i>
                            <div>
                                <div class="font-bold text-blue-900">Preuves de livraison</div>
                                <div class="text-xs text-blue-700 mt-1">${instructionText}</div>
                            </div>
                        </div>
                    </div>

                    ${showPhotoSection ? `
                    <!-- Zone photos -->
                    <div class="space-y-3">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">📷 Photos de preuve ${settings.requirePhoto ? '<span class="text-red-500">*</span>' : '(optionnel)'}</div>

                        <!-- Aperçu des photos -->
                        <div id="validation-photos-preview" class="grid grid-cols-3 gap-2">
                            ${this.validationPhotos.map((photo, idx) => `
                                <div class="relative aspect-square rounded-xl overflow-hidden border-2 border-emerald-400">
                                    <img src="${photo}" class="w-full h-full object-cover">
                                    <button onclick="LivreurModule.removeValidationPhoto(${idx})" class="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600">
                                        <i data-lucide="x" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            `).join('')}

                            ${this.validationPhotos.length < 5 ? `
                                <label class="aspect-square rounded-xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center cursor-pointer hover:border-emerald-500 hover:bg-emerald-50 transition">
                                    <i data-lucide="camera" class="w-8 h-8 text-slate-400"></i>
                                    <span class="text-xs text-slate-500 mt-1">Ajouter</span>
                                    <input type="file" accept="image/*" capture="environment" class="hidden" onchange="LivreurModule.handlePhotoUpload(event)">
                                </label>
                            ` : ''}
                        </div>

                        <div class="text-xs text-slate-400 text-center">${this.validationPhotos.length}/${settings.maxPhotos || 5} photos ${settings.requirePhoto && settings.minPhotos > 1 ? '(min ' + settings.minPhotos + ')' : ''}</div>
                    </div>
                    ` : ''}

                    ${showSignatureSection ? `
                    <!-- Zone signature -->
                    <div class="space-y-3 border-t border-slate-200 pt-4">
                        <div class="flex items-center justify-between">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">✍️ Signature client ${settings.requireSignature ? '<span class="text-red-500">*</span>' : '(optionnel)'}</div>
                            <button onclick="LivreurModule.clearSignature()" class="text-xs text-red-500 hover:text-red-700 font-bold flex items-center gap-1">
                                <i data-lucide="trash-2" class="w-3 h-3"></i> Effacer
                            </button>
                        </div>

                        <div class="relative border-2 border-slate-200 rounded-xl overflow-hidden bg-white" style="touch-action: none;">
                            <canvas id="signature-canvas" class="w-full cursor-crosshair" style="height: 150px;"></canvas>
                            <div id="signature-placeholder" class="absolute inset-0 flex items-center justify-center pointer-events-none ${this.signatureData ? 'hidden' : ''}">
                                <span class="text-slate-300 text-sm">Signez ici avec le doigt ou la souris</span>
                            </div>
                        </div>

                        <div id="signature-status" class="text-xs text-center ${this.signatureData ? 'text-emerald-600' : 'text-slate-400'}">
                            ${this.signatureData ? '✓ Signature enregistrée' : 'Pas de signature'}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Note optionnelle -->
                    <div>
                        <label class="block text-xs font-black text-slate-500 uppercase tracking-wider mb-2">Note (optionnelle)</label>
                        <textarea id="delivery_validation_note" rows="2" class="w-full px-4 py-3 rounded-xl border border-slate-200 text-sm resize-none" placeholder="Ex: Colis remis à la réception..."></textarea>
                    </div>

                    <!-- Avertissement dynamique selon les paramètres -->
                    ${(settings.requirePhoto || settings.requireSignature || settings.requireBoth) ? `
                    <div id="validation-warning" class="${this.getValidationStatus(settings) ? 'hidden' : ''} p-3 bg-amber-50 rounded-xl border border-amber-200 text-xs text-amber-800">
                        <i data-lucide="alert-triangle" class="w-4 h-4 inline mr-1"></i>
                        ${this.getValidationWarningMessage(settings)}
                    </div>
                    ` : ''}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: '✓ Confirmer la livraison', onclick: `LivreurModule.confirmDeliveryWithPhotos(${d.id})`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 disabled:opacity-50' }
            ]);

            // Initialiser le canvas de signature après l'affichage du modal (si visible)
            if (showSignatureSection) {
                setTimeout(() => this.initSignatureCanvas(), 100);
            }
        },

        // Obtenir le statut de validation actuel
        getValidationStatus(settings) {
            if (!settings) settings = this.currentValidationSettings || {};
            const hasPhotos = this.validationPhotos && this.validationPhotos.length > 0;
            const hasEnoughPhotos = this.validationPhotos && this.validationPhotos.length >= (settings.minPhotos || 1);
            const hasSignature = !!this.signatureData;

            if (!settings.requirePhoto && !settings.requireSignature) return true;
            if (settings.requireBoth) return hasEnoughPhotos && hasSignature;
            if (settings.requirePhoto && !settings.requireSignature) return hasEnoughPhotos;
            if (settings.requireSignature && !settings.requirePhoto) return hasSignature;
            return hasPhotos || hasSignature;
        },

        // Obtenir le message d'avertissement
        getValidationWarningMessage(settings) {
            if (!settings) settings = this.currentValidationSettings || {};
            if (settings.requireBoth) {
                return `Veuillez ajouter ${settings.minPhotos || 1} photo(s) ET la signature du client`;
            }
            if (settings.requirePhoto && !settings.requireSignature) {
                return `Veuillez ajouter au moins ${settings.minPhotos || 1} photo(s)`;
            }
            if (settings.requireSignature && !settings.requirePhoto) {
                return 'La signature du client est requise';
            }
            return 'Veuillez ajouter une photo OU la signature du client';
        },

        // Initialiser le canvas de signature
        initSignatureCanvas() {
            const canvas = document.getElementById('signature-canvas');
            if (!canvas) return;

            // Ajuster la taille du canvas
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = 150;

            const ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#1e293b';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            this.signatureCanvas = canvas;

            // Si une signature existe déjà, la charger
            if (this.signatureData) {
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, 0, 0);
                };
                img.src = this.signatureData;
            }

            // Événements souris
            canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
            canvas.addEventListener('mousemove', (e) => this.draw(e));
            canvas.addEventListener('mouseup', () => this.stopDrawing());
            canvas.addEventListener('mouseleave', () => this.stopDrawing());

            // Événements tactiles
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                this.startDrawing(e.touches[0]);
            });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                this.draw(e.touches[0]);
            });
            canvas.addEventListener('touchend', () => this.stopDrawing());
        },

        // Commencer à dessiner
        startDrawing(e) {
            this.isDrawing = true;
            const canvas = this.signatureCanvas;
            if (!canvas) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const ctx = canvas.getContext('2d');
            ctx.beginPath();
            ctx.moveTo(x, y);

            // Masquer le placeholder
            const placeholder = document.getElementById('signature-placeholder');
            if (placeholder) placeholder.classList.add('hidden');
        },

        // Dessiner
        draw(e) {
            if (!this.isDrawing || !this.signatureCanvas) return;

            const canvas = this.signatureCanvas;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const ctx = canvas.getContext('2d');
            ctx.lineTo(x, y);
            ctx.stroke();
        },

        // Arrêter de dessiner et sauvegarder
        stopDrawing() {
            if (!this.isDrawing) return;
            this.isDrawing = false;

            // Sauvegarder la signature
            if (this.signatureCanvas) {
                // Vérifier si le canvas contient quelque chose
                const ctx = this.signatureCanvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, this.signatureCanvas.width, this.signatureCanvas.height);
                const hasDrawing = imageData.data.some((value, index) => index % 4 === 3 && value > 0);

                if (hasDrawing) {
                    this.signatureData = this.signatureCanvas.toDataURL('image/png');
                    this.updateValidationWarning();

                    // Mettre à jour le statut
                    const status = document.getElementById('signature-status');
                    if (status) {
                        status.textContent = '✓ Signature enregistrée';
                        status.classList.remove('text-slate-400');
                        status.classList.add('text-emerald-600');
                    }
                }
            }
        },

        // Effacer la signature
        clearSignature() {
            if (this.signatureCanvas) {
                const ctx = this.signatureCanvas.getContext('2d');
                ctx.clearRect(0, 0, this.signatureCanvas.width, this.signatureCanvas.height);
            }
            this.signatureData = null;

            // Afficher le placeholder
            const placeholder = document.getElementById('signature-placeholder');
            if (placeholder) placeholder.classList.remove('hidden');

            // Mettre à jour le statut
            const status = document.getElementById('signature-status');
            if (status) {
                status.textContent = 'Pas de signature';
                status.classList.remove('text-emerald-600');
                status.classList.add('text-slate-400');
            }

            this.updateValidationWarning();
        },

        // Mettre à jour l'avertissement de validation
        updateValidationWarning() {
            const warning = document.getElementById('validation-warning');
            if (warning) {
                const settings = this.currentValidationSettings || {};
                if (this.getValidationStatus(settings)) {
                    warning.classList.add('hidden');
                } else {
                    warning.classList.remove('hidden');
                }
            }
        },

        // Gérer l'upload de photo
        handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Vérifier le type
            if (!file.type.startsWith('image/')) {
                UI.toast('Veuillez sélectionner une image', 'error');
                return;
            }

            // Vérifier la taille (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                UI.toast('Image trop grande (max 5MB)', 'error');
                return;
            }

            // Lire et compresser l'image
            const reader = new FileReader();
            reader.onload = (e) => {
                // Compresser l'image
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const maxSize = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > height && width > maxSize) {
                        height = (height * maxSize) / width;
                        width = maxSize;
                    } else if (height > maxSize) {
                        width = (width * maxSize) / height;
                        height = maxSize;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convertir en base64 compressé
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);

                    // Ajouter à la liste
                    if (this.validationPhotos.length < 5) {
                        this.validationPhotos.push(compressedDataUrl);
                        this.refreshPhotoPreview();
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        },

        // Supprimer une photo
        removeValidationPhoto(index) {
            this.validationPhotos.splice(index, 1);
            this.refreshPhotoPreview();
        },

        // Rafraîchir l'aperçu des photos
        refreshPhotoPreview() {
            const container = document.getElementById('validation-photos-preview');
            const warning = document.getElementById('validation-warning');

            if (container) {
                container.innerHTML = `
                    ${this.validationPhotos.map((photo, idx) => `
                        <div class="relative aspect-square rounded-xl overflow-hidden border-2 border-emerald-400">
                            <img src="${photo}" class="w-full h-full object-cover">
                            <button onclick="LivreurModule.removeValidationPhoto(${idx})" class="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                    `).join('')}

                    ${this.validationPhotos.length < 5 ? `
                        <label class="aspect-square rounded-xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center cursor-pointer hover:border-emerald-500 hover:bg-emerald-50 transition">
                            <i data-lucide="camera" class="w-8 h-8 text-slate-400"></i>
                            <span class="text-xs text-slate-500 mt-1">Ajouter</span>
                            <input type="file" accept="image/*" capture="environment" class="hidden" onchange="LivreurModule.handlePhotoUpload(event)">
                        </label>
                    ` : ''}
                `;
                lucide.createIcons();
            }

            // Mettre à jour le compteur
            const counter = container?.parentElement?.querySelector('.text-slate-400');
            if (counter) {
                counter.textContent = `${this.validationPhotos.length}/5 photos`;
            }

            // Afficher/masquer l'avertissement
            this.updateValidationWarning();
        },

        // Confirmer la livraison avec les photos et/ou signature
        confirmDeliveryWithPhotos(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;

            // Utiliser les paramètres de validation du POS
            const validation = CORE.canValidateDelivery(deliveryId, this.validationPhotos, this.signatureData);
            if (!validation.valid) {
                UI.toast(validation.message, 'error');
                return;
            }

            const note = UI.val('delivery_validation_note')?.trim() || null;

            // Calculer la commission
            const calculatedCommission = d.commission || CORE.calculateDeliveryCommission(d);

            // Mettre à jour la livraison avec les photos et la signature
            CORE.update('deliveries', d.id, {
                status: 'livree',
                proofPhotos: this.validationPhotos.length > 0 ? this.validationPhotos : null,
                proofSignature: this.signatureData || null,
                proofNote: note,
                proofTimestamp: new Date().toISOString(),
                commission: calculatedCommission,
                deliveredAt: new Date().toISOString()
            });

            // Sync order
            const o = CORE.getVisibleOrders().find(x => x.id === d.orderId);
            if (o) {
                // COD: l'argent est avec le livreur, paymentStatus reste 'pending' jusqu'au dépôt en caisse
                const orderUpdates = { status: 'delivered' };
                if (o.paymentMethod !== 'cod') {
                    orderUpdates.paymentStatus = o.paymentStatus || 'paid';
                }
                const updatedOrder = CORE.update('orders', o.id, orderUpdates);

                // Ledger: enregistrer encaissement SEULEMENT si non-COD
                if (o.paymentMethod !== 'cod') {
                    CORE.ensureSaleTransaction(updatedOrder);
                }

                // Ledger: commission livreur
                const updatedDelivery = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
                CORE.ensureCommissionTransaction({ ...updatedDelivery, status: 'livree' });
            }

            // Déterminer le message selon le type de preuve
            let proofType = '';
            if (this.validationPhotos.length > 0 && this.signatureData) {
                proofType = 'photo et signature';
            } else if (this.signatureData) {
                proofType = 'signature';
            } else if (this.validationPhotos.length > 0) {
                proofType = 'photo';
            }

            // Réinitialiser
            this.validationPhotos = [];
            this.signatureData = null;
            this.signatureCanvas = null;
            this.currentValidationSettings = null;

            UI.closeModal();
            UI.toast(`✓ Livraison validée${proofType ? ` avec preuve ${proofType}` : ''}!`, 'success');
            CORE.logActivity('complete', 'delivery', d.id, {
                entityName: `Commande ${d.orderRef}`,
                description: `Livraison validée avec preuve ${proofType || 'standard'}`,
                after: { status: 'livree', commission: calculatedCommission }
            });

            // Force immediate cloud sync so vendeur sees the update
            CORE.save(true);
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() && navigator.onLine) {
                API.syncDirtyToCloud().catch(function(e) { console.warn('[DELIVERY] Cloud sync after validation failed:', e.message); });
            }

            App.rerender();
        },

        setDeliveryStatus(deliveryId, status) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;

            // Si on veut marquer comme livrée, ouvrir le modal de validation avec photos
            if (status === 'livree') {
                this.showDeliveryValidationModal(deliveryId);
                return;
            }

            // Si la livraison est complétée, mettre à jour la commission si pas déjà définie
            if (status === 'livree' && !d.commission) {
                const calculatedCommission = CORE.calculateDeliveryCommission(d);
                CORE.update('deliveries', d.id, { status, commission: calculatedCommission, deliveredAt: new Date().toISOString() });
            } else {
                CORE.update('deliveries', d.id, { status, deliveredAt: status === 'livree' ? new Date().toISOString() : (d.deliveredAt || null) });
            }

            // Sync order
            const o = CORE.getVisibleOrders().find(x => x.id === d.orderId);
            if (o) {
                if (status === 'en_cours') {
                    if (o.status !== 'delivered') CORE.update('orders', o.id, { status: 'delivering' });
                }
                if (status === 'livree') {
                    // COD: l'argent est avec le livreur, paymentStatus reste 'pending' jusqu'au dépôt en caisse
                    const orderUpdates2 = { status: 'delivered' };
                    if (o.paymentMethod !== 'cod') {
                        orderUpdates2.paymentStatus = o.paymentStatus || 'paid';
                    }
                    const updatedOrder = CORE.update('orders', o.id, orderUpdates2);

                    // Ledger: enregistrer encaissement SEULEMENT si non-COD
                    if (o.paymentMethod !== 'cod') {
                        CORE.ensureSaleTransaction(updatedOrder);
                    }

                    // Ledger: commission livreur (mise à jour avec la commission calculée)
                    const updatedDelivery = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
                    CORE.ensureCommissionTransaction({ ...updatedDelivery, status: 'livree' });
                }
                if (status === 'probleme') {
                    if (o.status !== 'delivered') CORE.update('orders', o.id, { status: 'delivering' });
                }
            }

            UI.toast(`Course: ${status}`, 'success');
            CORE.logActivity('status_change', 'delivery', deliveryId, {
                entityName: `Commande ${d.orderRef}`,
                description: `Statut livraison changé: ${status}`,
                before: { status: d.status },
                after: { status }
            });

            // Force immediate cloud sync so vendeur sees the update
            CORE.save(true);
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() && navigator.onLine) {
                API.syncDirtyToCloud().catch(function(e) { console.warn('[DELIVERY] Cloud sync after status change failed:', e.message); });
            }

            App.rerender();
        },

        viewDeliveryDetail(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;

            const order = CORE.getVisibleOrders().find(o => o.id === d.orderId);
            const livreur = CORE.getUser(d.livreurId);

            let itemsHtml = '<div class="text-sm text-slate-500">Pas d\'articles</div>';
            if (order && order.items && order.items.length > 0) {
                itemsHtml = order.items.map(item => `
                    <div class="p-3 rounded-xl border border-slate-200 bg-slate-50">
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex-1">
                                <div class="font-bold text-slate-900">${item.name}</div>
                                <div class="text-xs text-slate-500 mt-1">Code produit: #${item.productId}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-black text-slate-900">${item.qty}×</div>
                                <div class="text-xs text-slate-500">${CORE.formatPrice(item.price)}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            let statusBadge = '';
            if (d.status === 'livree') {
                statusBadge = UI.badge('✓ Livrée', 'emerald');
            } else if (d.status === 'en_cours') {
                statusBadge = UI.badge('En cours', 'amber');
            } else if (d.status === 'en_attente') {
                statusBadge = UI.badge('En attente', 'slate');
            } else if (d.status === 'probleme') {
                statusBadge = UI.badge('Problème', 'red');
            } else if (d.status === 'reservation') {
                statusBadge = UI.badge('Réservation', 'blue');
            }

            return UI.modal(`Bon de livraison ${d.orderRef}`, `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <!-- En-tête avec statut -->
                    <div class="flex items-center justify-between p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div>
                            <div class="text-xs text-slate-500 font-black uppercase">Numéro de bon</div>
                            <div class="text-lg font-black text-slate-900">${d.orderRef}</div>
                        </div>
                        <div class="text-right">
                            ${statusBadge}
                        </div>
                    </div>

                    <!-- Informations client -->
                    <div class="border border-slate-200 rounded-2xl overflow-hidden">
                        <div class="p-3 bg-slate-50 border-b border-slate-200 font-black text-xs text-slate-700 uppercase">Client</div>
                        <div class="p-4 space-y-3">
                            <div>
                                <div class="text-xs text-slate-500 font-bold">Nom</div>
                                <div class="font-black text-slate-900">${d.clientName || '—'}</div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-500 font-bold">Téléphone</div>
                                <div class="flex items-center justify-between gap-3 mt-1">
                                    <div class="font-bold text-slate-900">${d.clientPhone || '—'}</div>
                                    ${d.clientPhone ? `
                                        <a href="tel:${d.clientPhone}" class="px-3 py-2 bg-emerald-600 text-white text-xs font-black rounded-lg hover:bg-emerald-700 transition flex items-center gap-2 whitespace-nowrap">
                                            <i data-lucide="phone" class="w-4 h-4"></i>
                                            <span>Appeler</span>
                                        </a>
                                    ` : ''}
                                </div>
                            </div>
                            <div>
                                <div class="text-xs text-slate-500 font-bold">Adresse de livraison</div>
                                <div class="font-bold text-slate-900 mt-1">${d.address || '—'}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Détails de livraison -->
                    <div class="border border-slate-200 rounded-2xl overflow-hidden">
                        <div class="p-3 bg-slate-50 border-b border-slate-200 font-black text-xs text-slate-700 uppercase">Détails de livraison</div>
                        <div class="p-4 space-y-3">
                            ${d.deliveryDate ? `
                                <div>
                                    <div class="text-xs text-slate-500 font-bold">Date prévue</div>
                                    <div class="font-bold text-slate-900">${new Date(d.deliveryDate).toLocaleDateString('fr-FR')}</div>
                                </div>
                            ` : ''}
                            ${d.deliveryTime ? `
                                <div>
                                    <div class="text-xs text-slate-500 font-bold">Heure prévue</div>
                                    <div class="font-bold text-slate-900">${d.deliveryTime}</div>
                                </div>
                            ` : ''}
                            <div>
                                <div class="text-xs text-slate-500 font-bold">Date de création</div>
                                <div class="font-bold text-slate-900">${CORE.formatDate(d.createdAt)}</div>
                            </div>
                            ${d.status === 'livree' ? `
                                <div>
                                    <div class="text-xs text-slate-500 font-bold">Date de livraison</div>
                                    <div class="font-bold text-emerald-700">${d.completedAt ? CORE.formatDate(d.completedAt) : 'Non enregistrée'}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Montants et paiement -->
                    ${order ? `
                        <div class="border border-slate-200 rounded-2xl overflow-hidden">
                            <div class="p-3 bg-slate-50 border-b border-slate-200 font-black text-xs text-slate-700 uppercase">Montants</div>
                            <div class="p-4 space-y-2">
                                <div class="flex items-center justify-between">
                                    <div class="text-sm text-slate-600">Sous-total</div>
                                    <div class="font-black text-slate-900">${CORE.formatPrice(order.subtotal || 0)}</div>
                                </div>
                                ${order.deliveryFee > 0 ? `
                                    <div class="flex items-center justify-between">
                                        <div class="text-sm text-slate-600">Frais de livraison</div>
                                        <div class="font-black text-slate-900">${CORE.formatPrice(order.deliveryFee || 0)}</div>
                                    </div>
                                ` : ''}
                                <div class="border-t border-slate-200 pt-2 flex items-center justify-between">
                                    <div class="font-black text-slate-700">Total</div>
                                    <div class="text-xl font-black text-emerald-600">${CORE.formatPrice(order.total || 0)}</div>
                                </div>
                                <div class="mt-3 p-3 bg-blue-50 border border-blue-100 rounded-xl">
                                    <div class="text-xs text-blue-700 font-bold">Méthode de paiement</div>
                                    <div class="font-black text-blue-900 mt-1">${CORE.paymentMethodLabel(order.paymentMethod || 'Inconnue')}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Articles -->
                    ${order ? `
                        <div class="border border-slate-200 rounded-2xl overflow-hidden">
                            <div class="p-3 bg-slate-50 border-b border-slate-200 font-black text-xs text-slate-700 uppercase">Articles (${order.items ? order.items.length : 0})</div>
                            <div class="p-4 space-y-2">
                                ${itemsHtml}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Informations du livreur -->
                    ${livreur ? `
                        <div class="border border-slate-200 rounded-2xl overflow-hidden">
                            <div class="p-3 bg-slate-50 border-b border-slate-200 font-black text-xs text-slate-700 uppercase">Livreur</div>
                            <div class="p-4 space-y-2">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 gradient-livreur rounded-xl flex items-center justify-center text-white font-black text-sm">${livreur.avatar}</div>
                                    <div>
                                        <div class="font-black text-slate-900">${livreur.name}</div>
                                        <div class="text-xs text-slate-500">${livreur.vehicle || 'Véhicule non spécifié'}</div>
                                    </div>
                                </div>
                                ${livreur.phone ? `
                                    <div class="text-xs text-slate-500 mt-2">Téléphone: <span class="font-bold text-slate-900">${livreur.phone}</span></div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Commission -->
                    <div class="p-3 bg-amber-50 border border-amber-200 rounded-xl">
                        <div class="text-xs text-amber-700 font-bold">Commission</div>
                        <div class="text-lg font-black text-amber-900 mt-1">${CORE.formatPrice(d.commission || Math.round(d.amount * 0.05))}</div>
                    </div>

                    <!-- Photos de preuve (si livrée) -->
                    ${d.proofPhotos && d.proofPhotos.length > 0 ? `
                        <div class="border border-emerald-200 rounded-2xl overflow-hidden">
                            <div class="p-3 bg-emerald-50 border-b border-emerald-200 font-black text-xs text-emerald-700 uppercase flex items-center gap-2">
                                <i data-lucide="camera" class="w-4 h-4"></i>
                                Photos de preuve (${d.proofPhotos.length})
                            </div>
                            <div class="p-4">
                                <div class="grid grid-cols-3 gap-2">
                                    ${d.proofPhotos.map((photo, idx) => `
                                        <div class="aspect-square rounded-xl overflow-hidden border border-emerald-200 cursor-pointer" onclick="LivreurModule.viewProofPhoto('${photo.replace(/'/g, "\\'")}')">
                                            <img src="${photo}" class="w-full h-full object-cover hover:scale-110 transition">
                                        </div>
                                    `).join('')}
                                </div>
                                ${d.proofNote ? `
                                    <div class="mt-3 p-3 bg-slate-50 rounded-xl text-xs text-slate-600">
                                        <span class="font-bold">Note:</span> ${d.proofNote}
                                    </div>
                                ` : ''}
                                ${d.proofTimestamp ? `
                                    <div class="mt-2 text-xs text-slate-400 text-right">
                                        Validé le ${new Date(d.proofTimestamp).toLocaleString('fr-FR')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `, (() => {
                const buttons = [];
                if (d.status !== 'livree') {
                    buttons.push({ label: 'En cours', onclick: `LivreurModule.setDeliveryStatus(${d.id},'en_cours'); UI.closeModal();`, class: 'px-4 py-2 rounded-xl bg-amber-500 text-white font-black hover:bg-amber-600' });
                    buttons.push({ label: '📸 Valider', onclick: `UI.closeModal(); LivreurModule.showDeliveryValidationModal(${d.id});`, class: 'px-4 py-2 rounded-xl bg-emerald-600 text-white font-black hover:bg-emerald-700' });
                    buttons.push({ label: 'Problème', onclick: `LivreurModule.setDeliveryStatus(${d.id},'probleme'); UI.closeModal();`, class: 'px-4 py-2 rounded-xl bg-red-600 text-white font-black hover:bg-red-700' });
                }
                buttons.push({ label: 'Fermer', onclick: 'UI.closeModal()', class: 'px-4 py-2 rounded-xl bg-slate-200 text-slate-700 font-black hover:bg-slate-300' });
                return buttons;
            })());
        },

        // Voir une photo de preuve en plein écran
        viewProofPhoto(photoSrc) {
            UI.modal('📷 Photo de preuve', `
                <div class="flex items-center justify-center">
                    <img src="${photoSrc}" class="max-w-full max-h-[70vh] rounded-2xl shadow-lg">
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-3xl' });
        },

        renderNavItem(view, icon, label) {
            const active = this.state.currentView === view;
            return `
                <button onclick="LivreurModule.navigateTo(\'${view}\')" class="flex flex-col items-center gap-1 px-3 py-2 rounded-2xl transition ${active ? 'text-slate-900' : 'text-slate-400 hover:text-slate-700'}">
                    <i data-lucide="${icon}" class="w-6 h-6"></i>
                    <span class="text-[10px] font-black">${label}</span>
                </button>`;
        },

        renderDashboard() {
            const stats = this.getStats();
            const inProgress = this.getMyDeliveries().filter(d => d.status === 'en_cours');
            const pendingDeliveries = this.getPendingDeliveries();

            return `
                <div class="space-y-4 fade-in">
                    <div class="gradient-livreur p-6 rounded-3xl text-white shadow-xl shadow-red-200 relative overflow-hidden">
                        <div class="relative z-10">
                            <div class="text-white/80 text-sm font-medium mb-1">Gains du jour</div>
                            <div class="text-4xl font-black">${CORE.formatPrice(stats.gainsJour)}</div>
                            <div class="mt-4 flex gap-2">
                                <span class="bg-white/20 backdrop-blur px-3 py-1 rounded-lg text-xs font-black">Livrées: ${stats.done}</span>
                                <span class="bg-white/20 backdrop-blur px-3 py-1 rounded-lg text-xs font-black">En cours: ${stats.inProgress}</span>
                            </div>
                        </div>
                        <div class="absolute right-0 bottom-0 opacity-10"><i data-lucide="trending-up" class="w-32 h-32"></i></div>
                    </div>

                    ${pendingDeliveries.length > 0 ? `
                    <!-- Livraisons disponibles à accepter -->
                    <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-3xl border-2 border-amber-300 overflow-hidden shadow-lg">
                        <div class="p-5 border-b border-amber-200 flex items-center justify-between bg-amber-100/50">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">📦</span>
                                <h3 class="font-black text-amber-900">Courses disponibles</h3>
                                <span class="px-2 py-1 bg-amber-500 text-white text-xs font-black rounded-full">${pendingDeliveries.length}</span>
                            </div>
                            <span class="text-xs font-bold text-amber-700">Cliquez pour accepter</span>
                        </div>
                        <div class="p-4 space-y-3">
                            ${pendingDeliveries.slice(0, 5).map(d => this.renderPendingDeliveryCard(d)).join('')}
                            ${pendingDeliveries.length > 5 ? `
                                <div class="text-center text-xs text-amber-700 font-bold">
                                    +${pendingDeliveries.length - 5} autre(s) course(s) disponible(s)
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <h3 class="font-black text-slate-900">En cours</h3>
                            <button onclick="LivreurModule.navigateTo('livraisons')" class="text-xs font-black text-red-600">Voir tout</button>
                        </div>
                        <div class="p-4">
                            ${inProgress.length === 0 ? `<div class="p-6 text-center text-slate-400 font-medium">Aucune course active</div>` : ''}
                            ${inProgress.slice(0,2).map(d => this.renderDeliveryCard(d)).join('')}
                        </div>
                    </div>
                </div>`;
        },

        // Carte pour une livraison en attente (non assignée)
        renderPendingDeliveryCard(d) {
            const hasTime = d.deliveryTime ? `<span class="text-xs text-amber-700 font-bold"><i data-lucide="clock" class="w-3 h-3 inline"></i> ${d.deliveryTime}</span>` : '';

            return `
                <div class="bg-white border-2 border-amber-200 rounded-2xl p-4 hover:border-amber-400 hover:shadow-lg transition-all cursor-pointer" onclick="LivreurModule.showAcceptDeliveryModal(${d.id})">
                    <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0 flex-1">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-xs font-black text-amber-800 bg-amber-200 px-2.5 py-1 rounded-lg">${d.orderRef}</span>
                                ${hasTime}
                            </div>
                            <div class="mt-2 font-black text-slate-900 truncate">${d.clientName}</div>
                            <div class="text-xs text-slate-500 flex items-center gap-1 mt-1 truncate"><i data-lucide="map-pin" class="w-3 h-3 flex-shrink-0"></i>${d.address}</div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <div class="font-black text-emerald-600 text-lg">${CORE.formatPrice(d.amount)}</div>
                            <div class="text-xs text-amber-700 font-bold mt-1">~${CORE.formatPrice(Math.round(d.amount * 0.05))}</div>
                            <button onclick="event.stopPropagation(); LivreurModule.acceptPendingDelivery(${d.id})" class="mt-2 px-4 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700 transition shadow-lg shadow-emerald-200">
                                ✓ Accepter
                            </button>
                        </div>
                    </div>
                </div>`;
        },

        // Modal de confirmation d'acceptation
        showAcceptDeliveryModal(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;

            const order = CORE.getVisibleOrders().find(o => o.id === d.orderId);
            const itemsCount = order?.items?.length || 0;
            const itemsList = order?.items?.map(it => `<li class="flex justify-between text-sm"><span>${it.qty}× ${it.name}</span><span class="font-bold">${CORE.formatPrice(it.qty * it.price)}</span></li>`).join('') || '';

            UI.modal('📦 Accepter cette course ?', `
                <div class="space-y-4">
                    <div class="p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl border border-amber-200">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <div class="text-xs font-black text-amber-800 bg-amber-200 px-2 py-1 rounded-lg inline-block">${d.orderRef}</div>
                                <div class="mt-2 font-black text-slate-900">${d.clientName}</div>
                                <div class="text-xs text-slate-500 mt-1">${d.clientPhone || ''}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                                <div class="text-xs text-amber-700 font-bold">Commission: ~${CORE.formatPrice(Math.round(d.amount * 0.05))}</div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <div class="flex items-start gap-2">
                            <i data-lucide="map-pin" class="w-4 h-4 text-slate-500 mt-0.5 flex-shrink-0"></i>
                            <div class="text-sm text-slate-700">${d.address}</div>
                        </div>
                        ${d.deliveryTime ? `
                            <div class="flex items-center gap-2 mt-2">
                                <i data-lucide="clock" class="w-4 h-4 text-amber-600"></i>
                                <span class="text-sm font-bold text-amber-700">Livraison à ${d.deliveryTime}</span>
                            </div>
                        ` : ''}
                    </div>

                    ${itemsCount > 0 ? `
                        <div class="p-4 bg-white rounded-2xl border border-slate-200">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-2">Articles (${itemsCount})</div>
                            <ul class="space-y-1">${itemsList}</ul>
                        </div>
                    ` : ''}

                    <div class="p-4 bg-blue-50 rounded-2xl border border-blue-200">
                        <div class="flex items-start gap-2">
                            <i data-lucide="info" class="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0"></i>
                            <div class="text-xs text-blue-800">
                                En acceptant cette course, elle sera assignée à votre compte et vous devrez la livrer.
                            </div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: '✓ Accepter cette course', onclick: `LivreurModule.acceptPendingDelivery(${d.id}); UI.closeModal()`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' }
            ]);
        },

        renderDeliveryCard(d) {
            const badge = d.status === 'livree' ? UI.badge('✓ Livrée', 'emerald') : d.status === 'probleme' ? UI.badge('⚠ Problème','red') : d.status === 'en_attente' ? UI.badge('En attente', 'slate') : UI.badge('En cours','amber');
            const order = CORE.getVisibleOrders().find(o => o.id === d.orderId);
            const itemsCount = order?.items?.length || 0;
            const hasTime = d.deliveryTime ? `<span class="text-xs text-slate-500"><i data-lucide="clock" class="w-3 h-3 inline"></i> ${d.deliveryTime}</span>` : '';
            const hasPhotos = d.proofPhotos && d.proofPhotos.length > 0;
            const hasSignature = !!d.proofSignature;
            const hasProof = hasPhotos || hasSignature;

            // Badge de preuve
            let proofBadge = '';
            if (hasPhotos && hasSignature) {
                proofBadge = `<span class="text-xs font-bold text-emerald-700 bg-emerald-50 px-2 py-1 rounded-lg flex items-center gap-1"><i data-lucide="camera" class="w-3 h-3"></i>${d.proofPhotos.length} + ✍️</span>`;
            } else if (hasPhotos) {
                proofBadge = `<span class="text-xs font-bold text-emerald-700 bg-emerald-50 px-2 py-1 rounded-lg flex items-center gap-1"><i data-lucide="camera" class="w-3 h-3"></i> ${d.proofPhotos.length}</span>`;
            } else if (hasSignature) {
                proofBadge = `<span class="text-xs font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded-lg flex items-center gap-1">✍️ Signé</span>`;
            }

            return `
                <div class="bg-white border border-slate-200 rounded-3xl p-4 mb-3 hover:shadow-lg transition-shadow cursor-pointer" onclick="LivreurModule.viewDeliveryDetail(${d.id})">
                    <div class="flex items-start justify-between gap-4">
                        <div class="min-w-0 flex-1">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-xs font-black text-slate-700 bg-slate-100 px-2.5 py-1 rounded-lg">${d.orderRef}</span>
                                ${badge}
                                ${proofBadge}
                            </div>
                            <div class="mt-2 font-black text-slate-900 truncate text-lg">${d.clientName}</div>
                            <div class="text-xs text-slate-500 flex items-center gap-1 mt-1"><i data-lucide="map-pin" class="w-3 h-3"></i>${d.address}</div>
                            <div class="mt-2 flex items-center gap-3">
                                ${hasTime}
                                ${itemsCount > 0 ? `<span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-lg"><i data-lucide="package" class="w-3 h-3 inline"></i> ${itemsCount} article${itemsCount > 1 ? 's' : ''}</span>` : ''}
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <div class="font-black text-emerald-600 text-lg">${CORE.formatPrice(d.amount)}</div>
                            <div class="text-xs text-amber-700 font-bold mt-1">Commission: ${CORE.formatPrice(d.commission || Math.round(d.amount * 0.05))}</div>
                            <div class="mt-3 flex flex-col gap-2 items-end">
                                ${hasProof ? `
                                    <button onclick="event.stopPropagation(); LivreurModule.showProofPhotosGallery(${d.id})" class="px-3 py-1.5 rounded-lg bg-emerald-50 text-emerald-700 text-[10px] font-black hover:bg-emerald-100 transition flex items-center gap-1 border border-emerald-200">
                                        <i data-lucide="eye" class="w-3 h-3"></i> Voir preuves
                                    </button>
                                ` : ''}
                                ${d.status === 'livree' ? `
                                    <button onclick="event.stopPropagation(); LivreurModule.printDeliveryReceipt(${d.id})" class="px-3 py-1.5 rounded-lg bg-blue-50 text-blue-700 text-[10px] font-black hover:bg-blue-100 transition flex items-center gap-1 border border-blue-200">
                                        <i data-lucide="printer" class="w-3 h-3"></i> Reçu
                                    </button>
                                ` : ''}
                                ${d.status !== 'livree' ? `
                                    <button onclick="event.stopPropagation(); LivreurModule.setDeliveryStatus(${d.id},\'en_cours\')" class="px-3 py-1.5 rounded-lg bg-amber-500 text-white text-[10px] font-black hover:bg-amber-600 transition">En cours</button>
                                    <button onclick="event.stopPropagation(); LivreurModule.setDeliveryStatus(${d.id},\'livree\')" class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white text-[10px] font-black hover:bg-emerald-700 transition">📸 Valider</button>
                                ` : ''}
                                ${String(d.livreurId || '').startsWith('idm_') ? '' : `<button onclick="event.stopPropagation(); LivreurModule.openChat(${d.id})" class="px-2 py-1.5 rounded-lg bg-indigo-50 text-indigo-600 text-[10px] font-black hover:bg-indigo-100 flex items-center gap-1 transition"><i data-lucide="message-circle" class="w-3 h-3"></i> Chat</button>`}
                            </div>
                        </div>
                    </div>
                </div>`;
        },

        // Afficher la galerie des photos de preuve et signature
        showProofPhotosGallery(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d || ((!d.proofPhotos || d.proofPhotos.length === 0) && !d.proofSignature)) {
                UI.toast('Aucune preuve de livraison', 'info');
                return;
            }

            const hasPhotos = d.proofPhotos && d.proofPhotos.length > 0;
            const hasSignature = !!d.proofSignature;

            UI.modal(`📷 Preuves - ${d.orderRef}`, `
                <div class="space-y-4">
                    <!-- Info livraison -->
                    <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-black text-emerald-900">${d.clientName || 'Client'}</div>
                                <div class="text-xs text-emerald-700">${d.address || ''}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                                <div class="text-xs text-emerald-600">✓ Livrée</div>
                            </div>
                        </div>
                    </div>

                    ${hasPhotos ? `
                        <!-- Galerie photos -->
                        <div>
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-2">📷 Photos de preuve (${d.proofPhotos.length})</div>
                            <div class="grid grid-cols-2 gap-3">
                                ${d.proofPhotos.map((photo, idx) => `
                                    <div class="aspect-square rounded-2xl overflow-hidden border-2 border-emerald-300 cursor-pointer hover:border-emerald-500 transition" onclick="LivreurModule.viewSingleProofPhoto(${d.id}, ${idx})">
                                        <img src="${photo}" class="w-full h-full object-cover hover:scale-105 transition">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${hasSignature ? `
                        <!-- Signature client -->
                        <div>
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-2">✍️ Signature client</div>
                            <div class="p-4 bg-white rounded-2xl border-2 border-blue-200 cursor-pointer hover:border-blue-400 transition" onclick="LivreurModule.viewSignatureFullscreen(${d.id})">
                                <img src="${d.proofSignature}" class="w-full max-h-40 object-contain" alt="Signature du client">
                            </div>
                        </div>
                    ` : ''}

                    <!-- Note -->
                    ${d.proofNote ? `
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="text-xs font-bold text-slate-500 uppercase mb-1">Note du livreur</div>
                            <div class="text-sm text-slate-700">${d.proofNote}</div>
                        </div>
                    ` : ''}

                    <!-- Horodatage -->
                    <div class="text-center text-xs text-slate-400">
                        Validé le ${d.proofTimestamp ? new Date(d.proofTimestamp).toLocaleString('fr-FR') : (d.deliveredAt ? new Date(d.deliveredAt).toLocaleString('fr-FR') : '—')}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-lg' });
        },

        // Voir la signature en plein écran
        viewSignatureFullscreen(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d || !d.proofSignature) return;

            UI.modal('✍️ Signature client', `
                <div class="flex flex-col items-center gap-4">
                    <div class="p-6 bg-white rounded-2xl border-2 border-slate-200 shadow-lg">
                        <img src="${d.proofSignature}" class="max-w-full max-h-[50vh]" alt="Signature du client">
                    </div>
                    <div class="text-sm text-slate-600">
                        Signature pour la commande <span class="font-bold">${d.orderRef}</span>
                    </div>
                    <div class="text-xs text-slate-400">
                        ${d.proofTimestamp ? new Date(d.proofTimestamp).toLocaleString('fr-FR') : ''}
                    </div>
                </div>
            `, [
                { label: 'Retour', onclick: `LivreurModule.showProofPhotosGallery(${deliveryId})` },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-md' });
        },

        // Voir une photo en plein écran
        viewSingleProofPhoto(deliveryId, photoIndex) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d || !d.proofPhotos || !d.proofPhotos[photoIndex]) return;

            const photo = d.proofPhotos[photoIndex];
            const total = d.proofPhotos.length;

            UI.modal(`📷 Photo ${photoIndex + 1}/${total}`, `
                <div class="flex flex-col items-center gap-4">
                    <img src="${photo}" class="max-w-full max-h-[65vh] rounded-2xl shadow-lg">
                    <div class="flex items-center gap-3">
                        ${photoIndex > 0 ? `
                            <button onclick="LivreurModule.viewSingleProofPhoto(${deliveryId}, ${photoIndex - 1})" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-700 font-black hover:bg-slate-300 transition">
                                ← Précédente
                            </button>
                        ` : ''}
                        ${photoIndex < total - 1 ? `
                            <button onclick="LivreurModule.viewSingleProofPhoto(${deliveryId}, ${photoIndex + 1})" class="px-4 py-2 rounded-xl bg-slate-200 text-slate-700 font-black hover:bg-slate-300 transition">
                                Suivante →
                            </button>
                        ` : ''}
                    </div>
                </div>
            `, [
                { label: 'Retour galerie', onclick: `LivreurModule.showProofPhotosGallery(${deliveryId})` },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ], { maxWidth: 'max-w-3xl' });
        },

        // Imprimer un reçu de livraison
        printDeliveryReceipt(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;

            const order = CORE.getVisibleOrders().find(o => o.id === d.orderId);
            const livreur = CORE.getUser(d.livreurId);
            const pos = d.posId ? CORE.getPOS(d.posId) : null;
            const items = order?.items || [];

            // Récupérer les paramètres personnalisés du vendeur
            const vendeurId = d.vendeurId || order?.vendeurId;
            const settings = vendeurId ? CORE.getReceiptSettings(vendeurId) : {};

            const companyName = settings.companyName || CORE.getCompanyName();
            const subtitle = settings.subtitle || 'Reçu de Livraison';
            const shopPhone = settings.phone || '';
            const shopAddress = settings.address || '';
            const showLogo = settings.showLogo !== false;
            const showItems = settings.showItems !== false;
            const showSignature = settings.showSignature !== false;
            const showCommission = settings.showCommission || false;
            const showProofPhotos = settings.showProofPhotos || false;
            const thankMessage = settings.thankMessage || 'Merci pour votre confiance!';
            const footerNote = settings.footerNote || '';

            const deliveredDate = d.deliveredAt ? new Date(d.deliveredAt).toLocaleString('fr-FR') : new Date().toLocaleString('fr-FR');
            const commission = d.commission || Math.round(d.amount * 0.05);
            const hasProofPhotos = d.proofPhotos && d.proofPhotos.length > 0;

            // Générer le HTML du reçu avec les paramètres personnalisés
            const receiptHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Reçu ${d.orderRef}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body {
                            font-family: 'Courier New', monospace;
                            font-size: 12px;
                            padding: 10px;
                            max-width: 300px;
                            margin: 0 auto;
                        }
                        .header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
                        .logo { font-size: 18px; font-weight: bold; }
                        .subtitle { font-size: 10px; color: #666; }
                        .shop-info { font-size: 9px; color: #888; margin-top: 3px; }
                        .section { margin: 10px 0; padding: 8px 0; border-bottom: 1px dashed #ccc; }
                        .row { display: flex; justify-content: space-between; margin: 3px 0; }
                        .label { color: #666; }
                        .value { font-weight: bold; text-align: right; }
                        .items { margin: 10px 0; }
                        .item { display: flex; justify-content: space-between; padding: 3px 0; font-size: 11px; }
                        .item-name { flex: 1; }
                        .item-qty { width: 40px; text-align: center; }
                        .item-price { width: 70px; text-align: right; }
                        .total { font-size: 16px; font-weight: bold; text-align: center; padding: 10px; background: #f0f0f0; margin: 10px 0; }
                        .footer { text-align: center; font-size: 10px; color: #666; margin-top: 15px; padding-top: 10px; border-top: 2px dashed #000; }
                        .signature { margin-top: 20px; padding-top: 30px; border-top: 1px solid #000; text-align: center; font-size: 10px; }
                        .status { background: #10b981; color: white; padding: 5px 10px; display: inline-block; border-radius: 4px; font-weight: bold; }
                        .proof-photos { text-align: center; font-size: 10px; color: #10b981; padding: 8px 0; border-bottom: 1px dashed #ccc; }
                        .footer-note { font-size: 9px; color: #888; margin-top: 5px; font-style: italic; }
                        @media print {
                            body { max-width: 80mm; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        ${showLogo ? '<div class="logo">🚚</div>' : ''}
                        <div class="logo">${companyName}</div>
                        <div class="subtitle">${subtitle}</div>
                        ${pos ? `<div class="subtitle">${pos.name}</div>` : ''}
                        ${shopPhone ? `<div class="shop-info">📞 ${shopPhone}</div>` : ''}
                        ${shopAddress ? `<div class="shop-info">📍 ${shopAddress}</div>` : ''}
                    </div>

                    <div class="section">
                        <div class="row">
                            <span class="label">N° Bon:</span>
                            <span class="value">${d.orderRef}</span>
                        </div>
                        <div class="row">
                            <span class="label">Date:</span>
                            <span class="value">${deliveredDate}</span>
                        </div>
                        <div class="row">
                            <span class="label">Statut:</span>
                            <span class="status">✓ LIVRéE</span>
                        </div>
                    </div>

                    <div class="section">
                        <div class="row">
                            <span class="label">Client:</span>
                            <span class="value">${d.clientName || '—'}</span>
                        </div>
                        <div class="row">
                            <span class="label">Tél:</span>
                            <span class="value">${d.clientPhone || '—'}</span>
                        </div>
                        <div class="row">
                            <span class="label">Adresse:</span>
                        </div>
                        <div style="font-size: 11px; margin-top: 3px;">${d.address || '—'}</div>
                    </div>

                    ${showItems && items.length > 0 ? `
                        <div class="section">
                            <div style="font-weight: bold; margin-bottom: 5px;">Articles (${items.length})</div>
                            <div class="items">
                                ${items.map(item => `
                                    <div class="item">
                                        <span class="item-name">${item.name}</span>
                                        <span class="item-qty">x${item.qty}</span>
                                        <span class="item-price">${CORE.formatPrice(item.qty * item.price)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="total">
                        TOTAL: ${CORE.formatPrice(d.amount)}
                    </div>

                    <div class="section">
                        <div class="row">
                            <span class="label">Livreur:</span>
                            <span class="value">${livreur?.name || '—'}</span>
                        </div>
                        ${showCommission ? `
                            <div class="row">
                                <span class="label">Commission:</span>
                                <span class="value">${CORE.formatPrice(commission)}</span>
                            </div>
                        ` : ''}
                    </div>

                    ${showProofPhotos && hasProofPhotos ? `
                        <div class="proof-photos">
                            📷 ${d.proofPhotos.length} photo(s) de preuve jointe(s)
                        </div>
                    ` : ''}

                    ${showSignature ? `
                        <div class="signature">
                            <div>Signature client</div>
                            <div style="margin-top: 25px; border-bottom: 1px solid #000; width: 150px; margin-left: auto; margin-right: auto;"></div>
                        </div>
                    ` : ''}

                    <div class="footer">
                        <div>${thankMessage}</div>
                        ${footerNote ? `<div class="footer-note">${footerNote}</div>` : ''}
                        <div style="margin-top: 5px;">${companyName}</div>
                        <div>${new Date().toLocaleDateString('fr-FR')}</div>
                    </div>

                    <div class="no-print" style="margin-top: 20px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 30px; font-size: 14px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            🖨️ Imprimer
                        </button>
                        <button onclick="window.close()" style="padding: 10px 30px; font-size: 14px; background: #64748b; color: white; border: none; border-radius: 8px; cursor: pointer; margin-left: 10px;">
                            Fermer
                        </button>
                    </div>
                </body>
                </html>
            `;

            // Ouvrir dans une nouvelle fenêtre pour impression
            const printWindow = window.open('', '_blank', 'width=400,height=600');
            printWindow.document.write(receiptHtml);
            printWindow.document.close();
        },

        openChat(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;
            CORE.db.messages = CORE.db.messages || [];
            const currentUser = CORE.state.currentUser;

            const renderMessages = () => {
                const msgs = CORE.db.messages.filter(m => m.deliveryId === deliveryId).sort((a,b) => new Date(a.createdAt) - new Date(b.createdAt));
                if (msgs.length === 0) return '<div class="text-center text-slate-400 text-sm py-10">Aucun message.</div>';
                return msgs.map(m => {
                    const isMe = m.senderId === currentUser.id;
                    return `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[80%]">
                                <div class="px-4 py-2 rounded-2xl text-sm ${isMe ? 'bg-emerald-600 text-white rounded-tr-none' : 'bg-white border border-slate-200 text-slate-800 rounded-tl-none'}">${m.text}</div>
                                <div class="text-[10px] text-slate-400 mt-1 ${isMe ? 'text-right' : 'text-left'}">${isMe ? 'Moi' : m.senderName} • ${CORE.formatTime(m.createdAt)}</div>
                            </div>
                        </div>`;
                }).join('');
            };

            UI.modal(`Chat: ${d.orderRef}`, `
                <div class="flex flex-col h-[50vh]">
                    <div class="p-3 bg-slate-50 border-b border-slate-200 text-xs text-slate-500 flex justify-between">
                        <span>Client: <b>${d.clientName}</b></span>
                        <span>${d.clientPhone}</span>
                    </div>
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3">${renderMessages()}</div>
                    <div class="mt-4 flex gap-2">
                        <input id="chat-input" class="flex-1 px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-emerald-500 bg-slate-50 focus:bg-white transition" placeholder="Message..." onkeypress="if(event.key==='Enter') LivreurModule.sendChat(${deliveryId})">
                        <button onclick="LivreurModule.sendChat(${deliveryId})" class="px-4 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition"><i data-lucide="send" class="w-5 h-5"></i></button>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
            setTimeout(() => { const el = document.getElementById('chat-messages'); if(el) el.scrollTop = el.scrollHeight; }, 50);
        },

        sendChat(deliveryId) {
            const input = document.getElementById('chat-input');
            const text = input ? input.value.trim() : '';
            if (!text) return;
            CORE.db.messages = CORE.db.messages || [];
            CORE.db.messages.push({ id: CORE.uid(), deliveryId, senderId: CORE.state.currentUser?.id, senderName: CORE.state.currentUser?.name, role: CORE.state.currentUser?.role, text, createdAt: new Date().toISOString() });
            CORE.markDirty('messages');
            CORE.save();

            // 🔊 Jouer le son de notification pour le message
            UI.playGenericNotificationSound('info');

            this.openChat(deliveryId); // Refresh
        },

        renderDeliveries() {
            const all = this.getMyDeliveries();
            const pending = this.getPendingDeliveries();
            const myWaiting = all.filter(d => d.status === 'en_attente');
            const myInProgress = all.filter(d => d.status === 'en_cours');
            const myCompleted = all.filter(d => d.status === 'livree');

            return `
                <div class="space-y-4 fade-in">
                    <div class="flex items-end justify-between">
                        <div>
                            <h2 class="text-xl font-black text-slate-900">Mes courses</h2>
                            <p class="text-sm text-slate-500 font-medium">Toutes vos livraisons</p>
                        </div>
                        <button onclick="LivreurModule.toggleService()" class="px-4 py-2 rounded-full text-xs font-black transition ${this.state.isOnService ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-200 text-slate-600'}">
                            ${this.state.isOnService ? '● EN SERVICE' : '○ HORS SERVICE'}
                        </button>
                    </div>

                    ${pending.length > 0 ? `
                    <!-- Courses disponibles à prendre -->
                    <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-3xl border-2 border-amber-300 overflow-hidden">
                        <div class="p-4 border-b border-amber-200 flex items-center justify-between bg-amber-100/50">
                            <div class="flex items-center gap-2">
                                <span class="text-xl">📦</span>
                                <span class="font-black text-amber-900">Courses disponibles</span>
                                <span class="px-2 py-0.5 bg-amber-500 text-white text-xs font-black rounded-full">${pending.length}</span>
                            </div>
                        </div>
                        <div class="p-4 space-y-3">
                            ${pending.map(d => this.renderPendingDeliveryCard(d)).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${myWaiting.length > 0 ? `
                    <!-- Mes courses en attente (assignées mais pas démarrées) -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">⏳</span>
                                <span class="font-black text-slate-800">En attente</span>
                                <span class="px-2 py-0.5 bg-slate-500 text-white text-xs font-black rounded-full">${myWaiting.length}</span>
                            </div>
                        </div>
                        <div class="p-4">
                            ${myWaiting.map(d => this.renderDeliveryCard(d)).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${myInProgress.length > 0 ? `
                    <!-- Mes courses en cours -->
                    <div class="bg-white rounded-3xl border-2 border-amber-400 overflow-hidden">
                        <div class="p-4 border-b border-amber-200 flex items-center justify-between bg-amber-50">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">🚚</span>
                                <span class="font-black text-amber-900">En cours</span>
                                <span class="px-2 py-0.5 bg-amber-500 text-white text-xs font-black rounded-full">${myInProgress.length}</span>
                            </div>
                        </div>
                        <div class="p-4">
                            ${myInProgress.map(d => this.renderDeliveryCard(d)).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${myCompleted.length > 0 ? `
                    <!-- Mes courses livrées -->
                    <div class="bg-white rounded-3xl border border-emerald-200 overflow-hidden">
                        <div class="p-4 border-b border-emerald-100 flex items-center justify-between bg-emerald-50">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">✓</span>
                                <span class="font-black text-emerald-800">Livrées</span>
                                <span class="px-2 py-0.5 bg-emerald-500 text-white text-xs font-black rounded-full">${myCompleted.length}</span>
                            </div>
                            <button onclick="LivreurModule.navigateTo('historique')" class="text-xs font-bold text-emerald-600">Voir tout</button>
                        </div>
                        <div class="p-4">
                            ${myCompleted.slice(0, 3).map(d => this.renderDeliveryCard(d)).join('')}
                            ${myCompleted.length > 3 ? `<div class="text-center text-xs text-slate-500 mt-2">+${myCompleted.length - 3} autre(s)</div>` : ''}
                        </div>
                    </div>
                    ` : ''}

                    ${all.length === 0 && pending.length === 0 ? `
                    <div class="bg-white rounded-3xl border border-slate-200 p-8 text-center">
                        <div class="text-4xl mb-3">📭</div>
                        <div class="font-black text-slate-700">Aucune course</div>
                        <div class="text-sm text-slate-500 mt-1">Les nouvelles courses apparaîtront ici</div>
                    </div>
                    ` : ''}
                </div>`;
        },

        renderMap() {
            const active = this.getMyDeliveries().find(d => d.status === 'en_cours') || this.getMyDeliveries()[0] || null;
            const destination = (active?.address || `${CORE.getCity(CORE.state.currentUser?.city || 1)?.name || 'Brazzaville'}, Congo`).trim();
            const label = active ? `${active.orderRef} • ${active.clientName}` : 'Destination';
            const payload = Maps.encode({ destination, label });
            const hasKey = (CORE.config.googleMapsApiKey || '').trim().length > 0;

            return `
                <div class="relative h-[calc(100vh-160px)] rounded-3xl overflow-hidden border border-slate-200 bg-white fade-in">
                    ${hasKey ? `
                        <div class="absolute inset-0" data-gmap="${payload}">
                            <div class="w-full h-full" data-gmap-canvas></div>
                        </div>
                    ` : `
                        <iframe class="absolute inset-0 w-full h-full" loading="lazy" referrerpolicy="no-referrer-when-downgrade" src="${Maps.embedUrl(destination)}"></iframe>
                    `}

                    <div class="absolute bottom-4 left-4 right-4 bg-white/95 p-4 rounded-2xl shadow-2xl flex items-center gap-4 slide-up">
                        <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center"><i data-lucide="map" class="w-6 h-6 text-slate-700"></i></div>
                        <div class="flex-1 min-w-0">
                            <div class="font-black text-slate-900 truncate">${active ? active.clientName : 'Carte'}</div>
                            <div class="text-xs text-slate-500 truncate">${destination}</div>
                        </div>
                        <button onclick="Maps.openDirectionsB64(\'${payload}\')" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700 transition">Itinéraire</button>
                    </div>
                </div>`;
        },

        renderWallet() {
            const uid = CORE.state.currentUser?.id;
            const all = this.getMyDeliveries().filter(d => d.status === 'livree');
            const balance = all.reduce((a,d)=>a+(d.commission||Math.round(d.amount*0.05)||0),0);

            // Dépôts enregistrés par le vendeur pour ce livreur
            const deposits = (CORE.db.deposits || []).filter(d => d.livreurId === uid);
            const totalDeposits = deposits.reduce((sum, d) => sum + d.amount, 0);

            return `
                <div class="space-y-4 fade-in">
                    <!-- Solde et dépôts -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Commissions</div>
                            <div class="text-2xl font-black text-emerald-600 mt-2">${CORE.formatPrice(balance)}</div>
                            <div class="mt-2 text-[10px] text-slate-500">Estimé 5% des livraisons</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Dépôts</div>
                            <div class="text-2xl font-black text-blue-600 mt-2">${CORE.formatPrice(totalDeposits)}</div>
                            <div class="mt-2 text-[10px] text-slate-500">${deposits.length} dépôt(s)</div>
                        </div>
                    </div>

                    ${deposits.length > 0 ? `
                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                            <div class="p-5 border-b border-slate-100 font-black">Dépôts enregistrés</div>
                            <div class="p-4 space-y-2">
                                ${deposits.slice(0,10).map(d => `
                                    <div class="flex items-center justify-between p-4 rounded-2xl border border-slate-100 hover:bg-slate-50">
                                        <div>
                                            <div class="font-black text-slate-900">Dépôt du ${CORE.formatDate(d.timestamp)}</div>
                                            <div class="text-xs text-slate-500 mt-1">Par: ${d.vendeurName}</div>
                                            ${d.ordersCount > 0 ? `<div class="text-xs text-blue-600 mt-1">📦 ${d.ordersCount} commande(s)</div>` : ''}
                                            ${d.notes ? `<div class="text-xs text-slate-500 mt-1">📝 ${d.notes}</div>` : ''}
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-blue-600 text-lg">${CORE.formatPrice(d.amount)}</div>
                                            <div class="text-[10px] text-slate-400">
                                                ${d.status === 'enregistre' ? 'Enregistré' : d.status === 'approuve' ? 'Approuvé' : d.status}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 font-black">Commissions des livraisons</div>
                        <div class="p-4 space-y-2">
                            ${all.length === 0 ? `<div class="p-8 text-center text-slate-400 font-medium">Aucune commission</div>` : ''}
                            ${all.slice(0,10).map(d => `
                                <div class="flex items-center justify-between p-4 rounded-2xl border border-slate-100 hover:bg-slate-50">
                                    <div>
                                        <div class="font-black text-slate-900">${d.orderRef}</div>
                                        <div class="text-xs text-slate-500">${CORE.formatDate(d.createdAt)}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-black text-emerald-600">+ ${CORE.formatPrice(d.commission||Math.round(d.amount*0.05)||0)}</div>
                                        <div class="text-[10px] text-slate-400">commission</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
        },

        renderHistory() {
            const filtered = this.getFilteredDeliveries();
            const stats = this.getHistoryStats();
            const f = this.state.historyFilters;

            return `
                <div class="space-y-4 fade-in">
                    <div>
                        <h2 class="text-xl font-black text-slate-900">Historique des livraisons</h2>
                        <p class="text-sm text-slate-500 font-medium">Consultez tous vos bons de livraison.</p>
                    </div>

                    <!-- Statistiques filtrées -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="bg-white rounded-2xl border border-slate-200 p-4">
                            <div class="text-xs font-black text-slate-500 uppercase">Total</div>
                            <div class="text-2xl font-black text-slate-900 mt-1">${stats.total}</div>
                        </div>
                        <div class="bg-white rounded-2xl border border-slate-200 p-4">
                            <div class="text-xs font-black text-slate-500 uppercase">Livrées</div>
                            <div class="text-2xl font-black text-emerald-600 mt-1">${stats.livrees}</div>
                        </div>
                        <div class="bg-white rounded-2xl border border-slate-200 p-4">
                            <div class="text-xs font-black text-slate-500 uppercase">Problèmes</div>
                            <div class="text-2xl font-black text-red-600 mt-1">${stats.problemes}</div>
                        </div>
                        <div class="bg-white rounded-2xl border border-slate-200 p-4">
                            <div class="text-xs font-black text-slate-500 uppercase">Taux</div>
                            <div class="text-2xl font-black text-blue-600 mt-1">${stats.tauxReussite}%</div>
                        </div>
                    </div>

                    <!-- Chiffre et gains -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl border border-blue-200 p-4">
                            <div class="text-xs font-black text-blue-700 uppercase">Chiffre</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${CORE.formatPrice(stats.chiffre)}</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-2xl border border-amber-200 p-4">
                            <div class="text-xs font-black text-amber-700 uppercase">Commissions</div>
                            <div class="text-2xl font-black text-amber-900 mt-1">${CORE.formatPrice(stats.gains)}</div>
                        </div>
                    </div>

                    <!-- Filtres -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 font-black text-slate-700">Filtres</div>
                        <div class="p-5 space-y-4">
                            <!-- Recherche globale -->
                            <div>
                                <label class="text-xs font-black text-slate-700 uppercase">Recherche</label>
                                <input id="livreur-search-input" type="text" placeholder="Bon, client, adresse, téléphone..."
                                    value="${f.searchQuery}"
                                    onkeyup="LivreurModule.updateLivreurSearch(this.value)"
                                    style="direction: ltr; text-align: left;" autocomplete="off"
                                    class="w-full mt-2 px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-red-500 bg-slate-50 focus:bg-white transition">
                            </div>

                            <!-- Ligne 1: Statut et Client -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs font-black text-slate-700 uppercase">Statut</label>
                                    <select onchange="LivreurModule.updateFilter('status', this.value)" class="w-full mt-2 px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-red-500 bg-slate-50 focus:bg-white transition">
                                        <option value="">Tous</option>
                                        <option value="livree" ${f.status === 'livree' ? 'selected' : ''}>Livrées</option>
                                        <option value="en_cours" ${f.status === 'en_cours' ? 'selected' : ''}>En cours</option>
                                        <option value="en_attente" ${f.status === 'en_attente' ? 'selected' : ''}>En attente</option>
                                        <option value="probleme" ${f.status === 'probleme' ? 'selected' : ''}>Problème</option>
                                        <option value="reservation" ${f.status === 'reservation' ? 'selected' : ''}>Réservation</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-black text-slate-700 uppercase">Client</label>
                                    <input id="livreur-client-search-input" type="text" placeholder="Nom du client..."
                                        value="${f.clientName}"
                                        onkeyup="LivreurModule.updateLivreurClientSearch(this.value)"
                                        style="direction: ltr; text-align: left;" autocomplete="off"
                                        class="w-full mt-2 px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-red-500 bg-slate-50 focus:bg-white transition">
                                </div>
                            </div>

                            <!-- Ligne 2: Dates -->
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs font-black text-slate-700 uppercase">Date depuis</label>
                                    <input type="date"
                                        value="${f.dateFrom}"
                                        onchange="LivreurModule.updateFilter('dateFrom', this.value)"
                                        class="w-full mt-2 px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-red-500 bg-slate-50 focus:bg-white transition">
                                </div>
                                <div>
                                    <label class="text-xs font-black text-slate-700 uppercase">Date jusqu'à</label>
                                    <input type="date"
                                        value="${f.dateTo}"
                                        onchange="LivreurModule.updateFilter('dateTo', this.value)"
                                        class="w-full mt-2 px-4 py-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-red-500 bg-slate-50 focus:bg-white transition">
                                </div>
                            </div>

                            <!-- Bouton réinitialiser -->
                            <button onclick="LivreurModule.state.historyFilters = { status: '', dateFrom: '', dateTo: '', clientName: '', searchQuery: '' }; App.rerender();" class="w-full py-2 px-4 rounded-xl bg-slate-100 text-slate-700 font-black hover:bg-slate-200 transition">
                                Réinitialiser les filtres
                            </button>
                        </div>
                    </div>

                    <!-- Résultats -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
                            <div class="font-black text-slate-700">${filtered.length} résultat(s)</div>
                        </div>
                        <div class="p-4">
                            ${filtered.length === 0 ? `
                                <div class="p-12 text-center">
                                    <div class="text-slate-400 text-sm font-medium mb-2">Aucun résultat</div>
                                    <div class="text-xs text-slate-400">Essayez de modifier vos filtres</div>
                                </div>
                            ` : ''}
                            ${filtered.map(d => this.renderDeliveryCard(d)).join('')}
                        </div>
                    </div>
                </div>`;
        },

        renderProfile() {
            const u = CORE.state.currentUser;
            return `
                <div class="space-y-4 fade-in">
                    <div class="bg-white rounded-3xl border border-slate-200 p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 gradient-livreur rounded-2xl flex items-center justify-center text-white font-black text-xl">${u.avatar}</div>
                            <div>
                                <div class="text-xl font-black text-slate-900">${u.name}</div>
                                <div class="text-xs text-slate-500 font-bold uppercase tracking-wider">Livreur</div>
                            </div>
                        </div>
                        <div class="mt-6 grid grid-cols-2 gap-3">
                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                                <div class="text-xs text-slate-500 font-black uppercase">Véhicule</div>
                                <div class="font-black text-slate-900">${u.vehicle || '—'}</div>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                                <div class="text-xs text-slate-500 font-black uppercase">Note</div>
                                <div class="font-black text-slate-900">${u.rating || '—'}</div>
                            </div>
                        </div>
                        <button onclick="App.logout()" class="mt-5 w-full py-3 rounded-2xl bg-slate-900 text-white font-black hover:bg-slate-800 transition">Déconnexion</button>
                    </div>
                </div>`;
        },

        renderSettings() {
            const u = CORE.state.currentUser;
            const currentTheme = this.state?.theme || 'light';
            const currentLang = I18n.current || 'fr';
            return `
                <div class="space-y-6 fade-in">
                    <!-- Header gradient -->
                    <div class="bg-gradient-to-br from-emerald-500 via-emerald-600 to-teal-600 p-6 rounded-2xl relative overflow-hidden">
                        <div class="absolute inset-0 opacity-30" style="background-image: url('data:image/svg+xml,%3Csvg width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cg fill=\"none\" fill-rule=\"evenodd\"%3E%3Cg fill=\"%23ffffff\" fill-opacity=\"0.05\"%3E%3Cpath d=\"M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\"%2F%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E')"></div>
                        <div class="relative flex items-center gap-4">
                            <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-3xl font-black text-white border-2 border-white/30 shadow-xl">
                                ${u.avatar || u.name.charAt(0).toUpperCase()}
                            </div>
                            <div class="flex-1">
                                <h2 class="text-2xl font-black text-white drop-shadow-lg">${u.name}</h2>
                                <p class="text-emerald-100 font-medium text-sm">Livreur</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="px-2 py-0.5 bg-white/20 backdrop-blur-sm rounded-full text-xs font-bold text-white">${u.vehicle || 'Moto'}</span>
                                    <span class="px-2 py-0.5 bg-white/20 backdrop-blur-sm rounded-full text-xs font-bold text-white flex items-center gap-1">
                                        <span class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span> En ligne
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profil -->
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="p-5 border-b border-slate-100 font-black text-slate-700 flex items-center gap-2">
                            <i data-lucide="user" class="w-5 h-5"></i>
                            <span>Profil</span>
                        </div>
                        <div class="p-5 space-y-4">
                            <div>
                                <label class="text-xs font-black text-slate-700 uppercase mb-2 block">Nom complet</label>
                                <input type="text" value="${u.name}" readonly class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 text-slate-700 font-bold">
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-700 uppercase mb-2 block">T\u00E9l\u00E9phone</label>
                                <input type="text" value="${u.phone || 'Non d\u00E9fini'}" readonly class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 text-slate-700 font-bold">
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-700 uppercase mb-2 block">V\u00E9hicule</label>
                                <input type="text" value="${u.vehicle || 'Non d\u00E9fini'}" readonly class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 text-slate-700 font-bold">
                            </div>
                        </div>
                    </div>

                    <!-- Langue (Tiroir) -->
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <button onclick="document.getElementById('livreur-language-drawer').classList.toggle('hidden'); document.getElementById('livreur-language-chevron').classList.toggle('rotate-180')" class="w-full flex items-center justify-between p-5 hover:bg-slate-50 transition-all">
                            <div class="flex items-center gap-2">
                                <i data-lucide="globe" class="w-5 h-5 text-emerald-600"></i>
                                <div class="text-left">
                                    <span class="font-black text-slate-700">${t('settings.language')}</span>
                                    <p class="text-xs text-slate-500">${[{code:'fr',flag:'🇫🇷',name:'Français'},{code:'en',flag:'🇬🇧',name:'English'},{code:'es',flag:'🇪🇸',name:'Español'},{code:'pt',flag:'🇵🇹',name:'Português'},{code:'de',flag:'🇩🇪',name:'Deutsch'},{code:'it',flag:'🇮🇹',name:'Italiano'},{code:'ar',flag:'🇸🇦',name:'العربية'},{code:'zh',flag:'🇨🇳',name:'中文'},{code:'ru',flag:'🇷🇺',name:'Русский'}].find(l => l.code === currentLang)?.flag || '🌍'} ${[{code:'fr',flag:'🇫🇷',name:'Français'},{code:'en',flag:'🇬🇧',name:'English'},{code:'es',flag:'🇪🇸',name:'Español'},{code:'pt',flag:'🇵🇹',name:'Português'},{code:'de',flag:'🇩🇪',name:'Deutsch'},{code:'it',flag:'🇮🇹',name:'Italiano'},{code:'ar',flag:'🇸🇦',name:'العربية'},{code:'zh',flag:'🇨🇳',name:'中文'},{code:'ru',flag:'🇷🇺',name:'Русский'}].find(l => l.code === currentLang)?.name || 'Français'}</p>
                                </div>
                            </div>
                            <i id="livreur-language-chevron" data-lucide="chevron-down" class="w-5 h-5 text-slate-400 transition-transform duration-300"></i>
                        </button>
                        <div id="livreur-language-drawer" class="hidden border-t border-slate-200 bg-slate-50 p-5">
                            <p class="text-xs text-slate-500 mb-3">${t('settings.chooseLanguage')}</p>
                            <div class="grid grid-cols-5 gap-2">
                                ${[
                                    { code: 'fr', flag: '🇫🇷' },
                                    { code: 'en', flag: '🇬🇧' },
                                    { code: 'es', flag: '🇪🇸' },
                                    { code: 'pt', flag: '🇵🇹' },
                                    { code: 'de', flag: '🇩🇪' },
                                    { code: 'it', flag: '🇮🇹' },
                                    { code: 'ar', flag: '🇸🇦' },
                                    { code: 'zh', flag: '🇨🇳' },
                                    { code: 'ru', flag: '🇷🇺' }
                                ].map(lang => `
                                    <button onclick="LivreurModule.setLanguage && LivreurModule.setLanguage('${lang.code}') || (I18n.setLanguage('${lang.code}'), UI.toast('Langue changée', 'success'), App.rerender())" class="p-2.5 rounded-xl border-2 transition-all text-2xl hover:scale-110 ${currentLang === lang.code ? 'border-emerald-500 bg-emerald-50 shadow-lg' : 'border-slate-200 hover:border-slate-300 bg-white'}">
                                        ${lang.flag}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- S\u00E9curit\u00E9 -->
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="p-5 border-b border-slate-100 font-black text-slate-700 flex items-center gap-2">
                            <i data-lucide="lock" class="w-5 h-5"></i>
                            <span>S\u00E9curit\u00E9</span>
                        </div>
                        <div class="p-5 space-y-3">
                            <div>
                                <label class="text-xs font-black text-slate-700 uppercase mb-2 block">Identifiant</label>
                                <input type="text" value="${u.username || 'N/A'}" readonly class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 text-slate-700 font-bold cursor-not-allowed">
                                <div class="text-xs text-slate-500 mt-1">L'identifiant ne peut pas \u00EAtre modifi\u00E9</div>
                            </div>
                            <button onclick="LivreurModule.showChangePersonalPasswordModal()" class="w-full p-4 rounded-xl bg-amber-50 border border-amber-200 hover:bg-amber-100 transition flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="key" class="w-5 h-5 text-amber-600"></i>
                                    <div class="text-left">
                                        <div class="text-sm font-black text-amber-700">Changer votre mot de passe</div>
                                        <div class="text-xs text-amber-600">Modifiez votre mot de passe de connexion</div>
                                    </div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-amber-400"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Notifications & Son -->
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="p-5 border-b border-slate-100 font-black text-slate-700 flex items-center gap-2">
                            <i data-lucide="bell" class="w-5 h-5"></i>
                            <span>Notifications</span>
                        </div>
                        <div class="p-5 space-y-4">
                            <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center border border-slate-200">
                                        <i data-lucide="bell" class="w-5 h-5 text-slate-600"></i>
                                    </div>
                                    <div>
                                        <div class="font-black text-slate-900 text-sm">Notifications</div>
                                        <div class="text-xs text-slate-500">${this.state.preferences.notificationsEnabled ? 'Activ\u00E9es' : 'D\u00E9sactiv\u00E9es'}</div>
                                    </div>
                                </div>
                                <button onclick="LivreurModule.state.preferences.notificationsEnabled = !LivreurModule.state.preferences.notificationsEnabled; LivreurModule.savePreferences(); App.rerender()" class="text-xs font-black ${this.state.preferences.notificationsEnabled ? 'text-emerald-600' : 'text-slate-400'} hover:opacity-75">
                                    ${this.state.preferences.notificationsEnabled ? 'D\u00E9sactiver' : 'Activer'}
                                </button>
                            </div>
                            <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center border border-slate-200">
                                        <i data-lucide="volume-2" class="w-5 h-5 text-slate-600"></i>
                                    </div>
                                    <div>
                                        <div class="font-black text-slate-900 text-sm">Sons des Notifications</div>
                                        <div class="text-xs text-slate-500">${this.state.preferences.soundEnabled ? 'Activ\u00E9s' : 'D\u00E9sactiv\u00E9s'}</div>
                                    </div>
                                </div>
                                <button onclick="LivreurModule.state.preferences.soundEnabled = !LivreurModule.state.preferences.soundEnabled; LivreurModule.savePreferences(); App.rerender()" class="text-xs font-black ${this.state.preferences.soundEnabled ? 'text-emerald-600' : 'text-slate-400'} hover:opacity-75">
                                    ${this.state.preferences.soundEnabled ? 'D\u00E9sactiver' : 'Activer'}
                                </button>
                            </div>

                            ${this.state.preferences.soundEnabled ? `
                            <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
                                <div class="text-xs font-black text-slate-700 mb-3">Volume: <span class="text-emerald-600">${Math.round(this.state.preferences.soundVolume * 100)}%</span></div>
                                <input type="range" min="0" max="1" step="0.1" value="${this.state.preferences.soundVolume}"
                                    onchange="LivreurModule.state.preferences.soundVolume = parseFloat(this.value); LivreurModule.savePreferences(); UI.playGenericNotificationSound('info'); App.rerender()"
                                    class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-emerald-600">
                                <div class="flex justify-between text-[10px] text-slate-500 mt-2">
                                    <span>Muet</span>
                                    <span>Maximum</span>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Th\u00E8me -->
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="p-5 border-b border-slate-100 font-black text-slate-700 flex items-center gap-2">
                            <i data-lucide="palette" class="w-5 h-5"></i>
                            <span>Apparence</span>
                        </div>
                        <div class="p-5">
                            <div class="grid grid-cols-3 gap-3">
                                <button onclick="LivreurModule.setTheme('light')" class="p-4 rounded-2xl border-2 transition flex flex-col items-center justify-center gap-2 ${currentTheme === 'light' ? 'border-emerald-500 bg-emerald-50 shadow-lg shadow-emerald-100' : 'border-slate-200 hover:border-slate-300'}">
                                    <i data-lucide="sun" class="w-6 h-6 ${currentTheme === 'light' ? 'text-emerald-600' : 'text-slate-400'}"></i>
                                    <span class="text-xs font-black ${currentTheme === 'light' ? 'text-emerald-700' : 'text-slate-600'}">Clair</span>
                                </button>
                                <button onclick="LivreurModule.setTheme('dark')" class="p-4 rounded-2xl border-2 transition flex flex-col items-center justify-center gap-2 ${currentTheme === 'dark' ? 'border-emerald-500 bg-emerald-50 shadow-lg shadow-emerald-100' : 'border-slate-200 hover:border-slate-300'}">
                                    <i data-lucide="moon" class="w-6 h-6 ${currentTheme === 'dark' ? 'text-emerald-600' : 'text-slate-400'}"></i>
                                    <span class="text-xs font-black ${currentTheme === 'dark' ? 'text-emerald-700' : 'text-slate-600'}">Sombre</span>
                                </button>
                                <button onclick="LivreurModule.setTheme('auto')" class="p-4 rounded-2xl border-2 transition flex flex-col items-center justify-center gap-2 ${currentTheme === 'auto' ? 'border-emerald-500 bg-emerald-50 shadow-lg shadow-emerald-100' : 'border-slate-200 hover:border-slate-300'}">
                                    <i data-lucide="monitor" class="w-6 h-6 ${currentTheme === 'auto' ? 'text-emerald-600' : 'text-slate-400'}"></i>
                                    <span class="text-xs font-black ${currentTheme === 'auto' ? 'text-emerald-700' : 'text-slate-600'}">Auto</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Support & \u00C0 propos -->
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="p-5 border-b border-slate-100 font-black text-slate-700 flex items-center gap-2">
                            <i data-lucide="help-circle" class="w-5 h-5"></i>
                            <span>Support & \u00C0 propos</span>
                        </div>
                        <div class="p-5 space-y-3">
                            <button onclick="LivreurModule.showFAQModal()" class="w-full text-left p-4 rounded-xl border border-slate-200 hover:bg-slate-50 transition flex items-center justify-between">
                                <div>
                                    <div class="font-black text-slate-900 text-sm">FAQ</div>
                                    <div class="text-xs text-slate-500">Questions fr\u00E9quemment pos\u00E9es</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i>
                            </button>
                            <button onclick="LivreurModule.showSupportModal()" class="w-full text-left p-4 rounded-xl border border-slate-200 hover:bg-slate-50 transition flex items-center justify-between">
                                <div>
                                    <div class="font-black text-slate-900 text-sm">Contacter le support</div>
                                    <div class="text-xs text-slate-500">T\u00E9l\u00E9phone, Email, WhatsApp</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i>
                            </button>
                            <button onclick="LivreurModule.showVersionModal()" class="w-full text-left p-4 rounded-xl border border-slate-200 hover:bg-slate-50 transition flex items-center justify-between">
                                <div>
                                    <div class="font-black text-slate-900 text-sm">\u00C0 propos</div>
                                    <div class="text-xs text-slate-500">Version ${CORE.config.version}</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Zone de danger -->
                    <div class="bg-red-50 rounded-2xl border border-red-200 overflow-hidden">
                        <div class="p-5 border-b border-red-200 font-black text-red-700 flex items-center gap-2">
                            <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                            <span>Zone de danger</span>
                        </div>
                        <div class="p-5 space-y-3">
                            <button onclick="CORE.showDeleteMyAccountModal()" class="w-full py-3 rounded-xl bg-white border-2 border-red-300 text-red-700 font-black hover:bg-red-100 transition flex items-center justify-center gap-2">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                                <span>Supprimer mon compte</span>
                            </button>
                            <button onclick="App.logout()" class="w-full py-3 rounded-xl bg-red-600 text-white font-black hover:bg-red-700 transition flex items-center justify-center gap-2">
                                <i data-lucide="log-out" class="w-5 h-5"></i>
                                <span>D\u00E9connexion</span>
                            </button>
                        </div>
                    </div>

                    <!-- Multi-comptes -->
                    ${window.AccountSwitcher ? AccountSwitcher.getHTML() : '<div id="account-switcher-section"></div>'}
                </div>`;
        },

        renderProfile() {
        },

        showChangePersonalPasswordModal() {
            UI.modal('🔒 Changer votre mot de passe', `
                <div class="space-y-4">
                    <div class="p-4 bg-red-50 border border-red-200 rounded-2xl flex items-center gap-3">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-red-600 flex-shrink-0"></i>
                        <div class="text-sm text-red-800 font-medium">Utilisez un mot de passe fort (min 6 caractères)</div>
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Ancien mot de passe</label>
                        <input type="password" id="old_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-red-500 outline-none" placeholder="Entrez votre ancien mot de passe">
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Nouveau mot de passe</label>
                        <input type="password" id="new_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-red-500 outline-none" placeholder="Entrez un nouveau mot de passe">
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Confirmation du nouveau mot de passe</label>
                        <input type="password" id="confirm_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-red-500 outline-none" placeholder="Confirmez le nouveau mot de passe">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Changer le mot de passe', onclick: 'LivreurModule.savePersonalPasswordChange()', class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700' }
            ]);
        },

        async savePersonalPasswordChange() {
            const oldPwd = UI.val('old_pwd');
            const newPwd = UI.val('new_pwd');
            const confirmPwd = UI.val('confirm_pwd');
            const user = CORE.state.currentUser;

            if (!oldPwd || !newPwd || !confirmPwd) {
                UI.toast('Tous les champs sont obligatoires', 'error');
                return;
            }

            if (newPwd.length < 6) {
                UI.toast('Le nouveau mot de passe doit contenir au moins 6 caractères', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                UI.toast('Les mots de passe ne correspondent pas', 'error');
                return;
            }

            const oldPwdHash = await Utils.md5(oldPwd);
            if (user.passwordHash) {
                if (oldPwdHash !== user.passwordHash) {
                    UI.toast('Ancien mot de passe incorrect', 'error');
                    return;
                }
            } else if (user.password) {
                if (oldPwd !== user.password) {
                    UI.toast('Ancien mot de passe incorrect', 'error');
                    return;
                }
            } else {
                UI.toast('Impossible de vérifier le mot de passe', 'error');
                return;
            }

            const newPwdHash = await Utils.md5(newPwd);
            user.passwordHash = newPwdHash;

            const userIndex = CORE.getVisibleUsers().findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
                CORE.db.users[userIndex] = user;
                CORE.save();
                UI.closeModal();
                UI.toast('✓ Mot de passe changé avec succès', 'success');
                App.rerender();
            } else {
                UI.toast('Erreur lors de la mise à jour de l\'utilisateur', 'error');
            }
        },

        renderActivityLog() {
            const userId = CORE.state.currentUser?.id;
            const filterType = this.state.activityFilter || 'all';

            let logs = [...(CORE.db.activityLogs || []), ...(CORE.db.auditLogs || [])];
            const seen = new Set();
            logs = logs.filter(l => { const k = l.id + '_' + l.timestamp; if (seen.has(k)) return false; seen.add(k); return true; });
            logs = logs.filter(l => l.userId == userId);
            if (filterType !== 'all') logs = logs.filter(l => l.action === filterType || l.entity === filterType);
            logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const today = new Date().toDateString();
            const todayLogs = logs.filter(l => new Date(l.timestamp).toDateString() === today);
            const actions = [...new Set(logs.map(l => l.action).filter(Boolean))];

            const actionIcons = { 'accept': '🤝', 'complete': '✅', 'status_change': '🔄', 'create': '➕', 'update': '✏️', 'delete': '🗑️', 'deposit': '💰' };
            const actionColors = { 'accept': 'purple', 'complete': 'emerald', 'status_change': 'cyan', 'create': 'emerald', 'update': 'blue', 'delete': 'red', 'deposit': 'amber' };

            return `
                <div class="fade-in space-y-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-xl font-black text-slate-900">📋 Mon Activité</h2>
                            <p class="text-slate-500 text-xs font-medium">Historique de mes actions</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-black text-red-500">${todayLogs.length}</div>
                            <div class="text-[10px] text-slate-500">aujourd'hui</div>
                        </div>
                    </div>

                    <div class="flex gap-2 overflow-x-auto pb-2">
                        <button onclick="LivreurModule.state.activityFilter='all';App.rerender()" class="px-3 py-1.5 rounded-full text-xs font-black whitespace-nowrap ${filterType === 'all' ? 'gradient-livreur text-white' : 'bg-white border border-slate-200 text-slate-600'}">
                            Tout (${logs.length})
                        </button>
                        ${actions.slice(0, 5).map(a => `
                            <button onclick="LivreurModule.state.activityFilter='${a}';App.rerender()" class="px-3 py-1.5 rounded-full text-xs font-black whitespace-nowrap ${filterType === a ? 'gradient-livreur text-white' : 'bg-white border border-slate-200 text-slate-600'}">
                                ${actionIcons[a] || '📝'} ${a}
                            </button>
                        `).join('')}
                    </div>

                    <div class="space-y-2">
                        ${logs.length === 0 ? '<div class="text-center py-12 text-slate-400"><div class="text-4xl mb-3">📭</div><div class="font-bold">Aucune activité enregistrée</div></div>' : logs.slice(0, 80).map(l => {
                            const color = actionColors[l.action] || 'slate';
                            return `
                            <div class="bg-white rounded-2xl border border-slate-200 p-3 hover:shadow-sm transition">
                                <div class="flex items-start justify-between gap-2">
                                    <div class="flex items-start gap-2.5">
                                        <div class="w-8 h-8 rounded-lg bg-${color}-100 flex items-center justify-center text-sm flex-shrink-0">${actionIcons[l.action] || '📝'}</div>
                                        <div>
                                            <div class="font-black text-slate-900 text-sm">${l.entityName || l.details || l.action || '—'}</div>
                                            <div class="text-[10px] text-slate-500 mt-0.5">${l.entity || ''} ${l.entityId ? '#' + l.entityId : ''}</div>
                                        </div>
                                    </div>
                                    <div class="text-right flex-shrink-0">
                                        <span class="px-2 py-0.5 rounded-full text-[10px] font-black bg-${color}-100 text-${color}-700">${l.action || '—'}</span>
                                        <div class="text-[10px] text-slate-400 mt-1">${CORE.formatDate(l.timestamp)}</div>
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
        },

        render() {
            const u = CORE.state.currentUser;
            const view = this.state.currentView;
            this.loadThemePreference(); // Charger le thème préféré
            const content = view === 'dashboard' ? this.renderDashboard() :
                            view === 'livraisons' ? this.renderDeliveries() :
                            view === 'historique' ? this.renderHistory() :
                            view === 'map' ? this.renderMap() :
                            view === 'wallet' ? this.renderWallet() :
                            view === 'settings' ? this.renderSettings() :
                            view === 'profile' ? this.renderProfile() :
                            view === 'activite' ? this.renderActivityLog() :
                            this.renderDashboard();

            return `
                <div class="flex flex-col h-screen bg-slate-100">
                    <header class="bg-white border-b border-slate-200 px-5 py-4 flex justify-between items-center sticky top-0 z-30 shadow-sm pt-safe">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 gradient-livreur rounded-2xl flex items-center justify-center text-white font-black">${u.avatar}</div>
                            <div>
                                <h1 class="font-black text-slate-800 text-sm">RAYA LIVREUR</h1>
                                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">${u.name}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="LivreurModule.navigateTo('activite')" class="p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition" title="Journal d'activité">
                                <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                            </button>
                            <button onclick="LivreurModule.navigateTo('settings')" class="p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition" title="Paramètres">
                                <i data-lucide="settings" class="w-5 h-5"></i>
                            </button>
                            <button onclick="LivreurModule.toggleService()" class="px-3 py-1.5 rounded-full text-xs font-black transition ${this.state.isOnService ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-200 text-slate-500'}">
                                ${this.state.isOnService ? '● EN SERVICE' : '○ HORS SERVICE'}
                            </button>
                        </div>
                    </header>

                    <main class="flex-1 overflow-auto p-4 pb-safe">${content}</main>

                    <nav class="bg-white border-t border-slate-200 px-2 py-2 flex items-center justify-around pb-safe no-print">
                        ${this.renderNavItem('dashboard', 'home', 'Accueil')}
                        ${this.renderNavItem('livraisons', 'package', 'Courses')}
                        <button onclick="LivreurModule.navigateTo('map')" class="relative -top-6 w-16 h-16 rounded-full gradient-livreur flex items-center justify-center text-white shadow-xl shadow-red-300 transform transition active:scale-95">
                            <i data-lucide="map" class="w-8 h-8"></i>
                        </button>
                        ${this.renderNavItem('historique', 'history', 'Historique')}
                        ${this.renderNavItem('wallet', 'wallet', 'Solde')}
                    </nav>
                </div>`;
        }
    }

    ;

    // =========================================================
    // MODULE: PAIEMENTS MOBILES (MTN, Airtel, Orange)
    // =========================================================
    const PaymentModule = {
        // ===== GÉNÉRATION CODES QR =====
        generateQRCode(text) {
            // Utiliser une API externe (QR Code generator)
            // Format: https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=
            const encoded = encodeURIComponent(text);
            return `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encoded}`;
        },

        // ===== GÉNÉRATION PAYLOAD PAIEMENT =====
        generatePaymentPayload(order, provider) {
            const amount = order.total || 0;
            const reference = `ORD-${order.id}-${Date.now()}`;

            // Format selon le provider
            let payload = '';
            switch(provider) {
                case 'mtn':
                    // MTN Money Format
                    payload = `MTN|${order.clientPhone}|${amount}|${reference}|${order.clientName}`;
                    break;
                case 'airtel':
                    // Airtel Money Format
                    payload = `AIRTEL|${order.clientPhone}|${amount}|${reference}`;
                    break;
                case 'orange':
                    // Orange Money Format
                    payload = `ORANGE|${order.clientPhone}|${amount}|${reference}|${order.id}`;
                    break;
            }
            return payload;
        },

        // ===== CRÉATION PAIEMENT MOBILE =====
        initiatePayment(orderId, provider, clientPhone = null) {
            const order = CORE.getVisibleOrders().find(o => o.id === orderId);
            if (!order) return null;

            const phone = clientPhone || order.clientPhone;
            if (!phone) {
                console.error('Numéro de téléphone requis pour le paiement');
                return null;
            }

            const payload = this.generatePaymentPayload({ ...order, clientPhone: phone }, provider);
            const qrCodeUrl = this.generateQRCode(payload);

            const payment = {
                id: Utils.uid('PAY'),
                orderId: orderId,
                clientId: order.clientId,
                clientName: order.clientName,
                clientPhone: phone,
                amount: order.total,
                currency: 'XAF',
                provider: provider,
                transactionId: null,
                status: 'pending',
                qrCode: payload,
                qrCodeUrl: qrCodeUrl,
                invoicePDF: null,
                invoiceEmail: null,
                createdAt: new Date().toISOString(),
                completedAt: null,
                errorMessage: null,
                metadata: {
                    orderId: order.id,
                    itemCount: (order.items || []).length,
                    deliveryAddress: order.deliveryAddress
                }
            };

            CORE.db.mobilePayments.push(payment);
            CORE.save();
            return payment;
        },

        // ===== GÉNÉRER FACTURE PDF =====
        generateInvoicePDF(paymentId) {
            const payment = CORE.db.mobilePayments.find(p => p.id === paymentId);
            if (!payment) return null;

            const order = CORE.getVisibleOrders().find(o => o.id === payment.orderId);
            if (!order) return null;

            const invoiceNumber = `INV-${payment.orderId}-${Date.now().toString().slice(-6)}`;

            // Simuler génération PDF (dans un vrai système: utiliser pdfkit ou similaire)
            const pdfContent = `
                FACTURE DE COMMANDE
                ==================

                Numéro: ${invoiceNumber}
                Date: ${new Date(payment.createdAt).toLocaleDateString('fr-FR')}

                CLIENT
                ------
                Nom: ${payment.clientName}
                Téléphone: ${payment.clientPhone}

                COMMANDE #${order.id}
                -------------------
                Livraison à: ${order.deliveryAddress}

                DÉTAILS ARTICLES
                ----------------
                ${(order.items || []).map(item => `
                ${item.name} x${item.quantity} = ${CORE.formatPrice(item.price * item.quantity)}
                `).join('\n')}

                MONTANT
                -------
                Sous-total: ${CORE.formatPrice(order.subtotal || order.total)}
                Frais livraison: ${CORE.formatPrice(order.deliveryFee || 0)}
                Taxes: ${CORE.formatPrice(order.tax || 0)}
                ---
                TOTAL: ${CORE.formatPrice(order.total)}

                MODE DE PAIEMENT
                ----------------
                ${payment.provider.toUpperCase()}

                Statut: ${payment.status.toUpperCase()}
                Transaction ID: ${payment.transactionId || 'Pendante'}

                Merci de votre commande!
            `;

            // Convertir en base64 (simulation)
            const pdfBase64 = btoa(pdfContent);
            const pdfUrl = `data:application/pdf;base64,${pdfBase64}`;

            const invoice = {
                id: Utils.uid('INV'),
                paymentId: paymentId,
                orderId: payment.orderId,
                invoiceNumber: invoiceNumber,
                clientName: payment.clientName,
                clientEmail: order.clientEmail,
                clientPhone: payment.clientPhone,
                items: order.items || [],
                subtotal: order.subtotal || order.total,
                tax: order.tax || 0,
                total: order.total,
                pdfUrl: pdfUrl,
                sentAt: null,
                downloadedAt: null,
                createdAt: new Date().toISOString()
            };

            CORE.db.paymentInvoices.push(invoice);
            CORE.save();
            return invoice;
        },

        // ===== ENVOYER FACTURE PAR EMAIL =====
        sendInvoiceByEmail(invoiceId, recipientEmail = null) {
            const invoice = CORE.db.paymentInvoices.find(i => i.id === invoiceId);
            if (!invoice) return false;

            const email = recipientEmail || invoice.clientEmail;
            if (!email) {
                console.error('Email requis pour envoyer la facture');
                return false;
            }

            // Simulation d'envoi email
            console.log(`📧 EMAIL FACTURE ENVOYÉ: ${invoice.invoiceNumber} → ${email}`);
            console.log(`Fichier: invoice-${invoice.invoiceNumber}.pdf`);

            // Dans un vrai système:
            // ApiService.sendEmail(email, {
            //     subject: `Facture de commande #${invoice.orderId}`,
            //     body: `Veuillez trouver ci-joint votre facture...`,
            //     attachment: invoice.pdfUrl
            // })

            invoice.sentAt = new Date().toISOString();
            CORE.save();
            return true;
        },

        // ===== CONFIRMER PAIEMENT =====
        confirmPayment(paymentId, transactionId = null) {
            const payment = CORE.db.mobilePayments.find(p => p.id === paymentId);
            if (!payment) return false;

            payment.status = 'success';
            payment.transactionId = transactionId || `TXN-${Date.now()}`;
            payment.completedAt = new Date().toISOString();

            // Mettre à jour la commande
            const order = CORE.getVisibleOrders().find(o => o.id === payment.orderId);
            if (order) {
                order.status = 'paid';
                order.paymentMethod = payment.provider;
                order.paymentDate = new Date().toISOString();
                order.transactionId = payment.transactionId;
            }

            // Générer facture
            const invoice = this.generateInvoicePDF(paymentId);
            if (invoice && order?.clientEmail) {
                this.sendInvoiceByEmail(invoice.id, order.clientEmail);
            }

            // Mettre à jour historique paiements
            this.updatePaymentHistory(payment.clientId, payment.provider, payment.amount);

            CORE.save();
            return true;
        },

        // ===== ANNULER PAIEMENT =====
        cancelPayment(paymentId, errorMessage = null) {
            const payment = CORE.db.mobilePayments.find(p => p.id === paymentId);
            if (!payment) return false;

            payment.status = 'failed';
            payment.errorMessage = errorMessage || 'Paiement annulé par l\'utilisateur';

            CORE.save();
            return true;
        },

        // ===== METTRE À JOUR HISTORIQUE PAIEMENTS =====
        updatePaymentHistory(clientId, provider, amount) {
            let history = CORE.db.paymentHistory.find(h => h.clientId === clientId);

            if (!history) {
                const client = CORE.getVisibleClients().find(c => c.id === clientId);
                history = {
                    id: Utils.uid('PAYHIST'),
                    clientId: clientId,
                    clientName: client?.name || 'Client',
                    totalPaid: 0,
                    paymentCount: 0,
                    methods: { mtn: 0, airtel: 0, orange: 0, cash: 0 },
                    lastPaymentDate: null,
                    lastPaymentMethod: null,
                    averageAmount: 0
                };
                CORE.db.paymentHistory.push(history);
            }

            history.totalPaid += amount;
            history.paymentCount += 1;
            history.methods[provider] = (history.methods[provider] || 0) + 1;
            history.lastPaymentDate = new Date().toISOString();
            history.lastPaymentMethod = provider;
            history.averageAmount = Math.round(history.totalPaid / history.paymentCount);

            return history;
        },

        // ===== RÉCUPÉRER PAIEMENTS PAR STATUT =====
        getPaymentsByStatus(status) {
            return CORE.db.mobilePayments.filter(p => p.status === status);
        },

        // ===== RÉCUPÉRER PAIEMENTS PAR CLIENT =====
        getClientPayments(clientId) {
            return CORE.db.mobilePayments.filter(p => p.clientId === clientId);
        },

        // ===== RÉCUPÉRER PAIEMENTS PAR PROVIDER =====
        getPaymentsByProvider(provider) {
            return CORE.db.mobilePayments.filter(p => p.provider === provider);
        },

        // ===== STATISTIQUES PAIEMENTS =====
        getPaymentStats() {
            const allPayments = CORE.db.mobilePayments;
            const successfulPayments = allPayments.filter(p => p.status === 'success');

            const stats = {
                totalPayments: allPayments.length,
                successfulPayments: successfulPayments.length,
                pendingPayments: allPayments.filter(p => p.status === 'pending').length,
                failedPayments: allPayments.filter(p => p.status === 'failed').length,
                successRate: allPayments.length > 0 ? Math.round((successfulPayments.length / allPayments.length) * 100) : 0,
                totalRevenue: successfulPayments.reduce((s, p) => s + (p.amount || 0), 0),
                byProvider: {
                    mtn: successfulPayments.filter(p => p.provider === 'mtn').reduce((s, p) => s + (p.amount || 0), 0),
                    airtel: successfulPayments.filter(p => p.provider === 'airtel').reduce((s, p) => s + (p.amount || 0), 0),
                    orange: successfulPayments.filter(p => p.provider === 'orange').reduce((s, p) => s + (p.amount || 0), 0)
                },
                averageAmount: successfulPayments.length > 0 ? Math.round(successfulPayments.reduce((s, p) => s + (p.amount || 0), 0) / successfulPayments.length) : 0
            };

            return stats;
        },

        // ===== MODAL INITIATION PAIEMENT =====
        showPaymentModal(orderId) {
            const order = CORE.getVisibleOrders().find(o => o.id === orderId);
            if (!order) return;

            const providers = CORE.db.mobileMoneProviders.filter(p => p.enabled);

            UI.modal('💳 Paiement Mobile', `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <!-- Résumé commande -->
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <div class="font-black text-slate-900 mb-2">Commande #${order.id}</div>
                        <div class="text-sm text-slate-600 mb-3">${order.clientName}</div>
                        <div class="text-2xl font-black text-emerald-600">${CORE.formatPrice(order.total)}</div>
                    </div>

                    <!-- Sélection provider -->
                    <div class="p-4 bg-blue-50 rounded-2xl border border-blue-200">
                        <div class="font-black text-blue-900 mb-3">Choisir un opérateur</div>
                        <div class="space-y-2">
                            ${providers.map(provider => `
                                <button onclick="PaymentModule.initiatePaymentUI(${orderId}, '${provider.id}')" class="w-full p-4 rounded-lg border border-blue-200 bg-white hover:bg-blue-50 transition text-left">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">${provider.logo}</span>
                                        <div>
                                            <div class="font-black text-slate-900">${provider.name}</div>
                                            <div class="text-xs text-slate-600">${provider.description}</div>
                                        </div>
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Info importantes -->
                    <div class="p-4 bg-amber-50 rounded-2xl border border-amber-200">
                        <div class="font-black text-amber-900 mb-3">⚠️ Informations importantes</div>
                        <ul class="text-sm text-amber-800 space-y-2">
                            <li>✓ Vous allez recevoir un code QR à scanner</li>
                            <li>✓ Ouvrez l'app du fournisseur sélectionné</li>
                            <li>✓ Scannez le code QR ou entrez les détails</li>
                            <li>✓ La facture sera envoyée par email</li>
                        </ul>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        // ===== AFFICHER DÉTAILS PAIEMENT AVEC QR CODE =====
        initiatePaymentUI(orderId, provider) {
            const payment = this.initiatePayment(orderId, provider);
            if (!payment) {
                UI.toast('Erreur lors de l\'initiation du paiement', 'error');
                return;
            }

            UI.modal(`💳 Paiement ${payment.provider.toUpperCase()}`, `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <!-- Code QR -->
                    <div class="p-6 bg-white rounded-2xl border border-slate-200 text-center">
                        <div class="font-black text-slate-900 mb-4">Scannez ce code QR</div>
                        <img src="${payment.qrCodeUrl}" alt="QR Code" class="w-64 h-64 mx-auto rounded-lg border-4 border-slate-200">
                        <div class="mt-4 text-sm text-slate-600">
                            <div class="font-black">Montant: ${CORE.formatPrice(payment.amount)}</div>
                            <div class="text-xs text-slate-500 mt-1">Téléphone: ${payment.clientPhone}</div>
                        </div>
                    </div>

                    <!-- Informations texte (fallback) -->
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <div class="font-black text-slate-900 mb-3">Paiement Manuel</div>
                        <div class="space-y-3 text-sm">
                            <div class="p-3 bg-white rounded border border-slate-200">
                                <div class="text-xs font-black text-slate-600">NUMÉRO TÉLÉPHONE</div>
                                <div class="text-base font-black text-slate-900 mt-1">${payment.clientPhone}</div>
                            </div>
                            <div class="p-3 bg-white rounded border border-slate-200">
                                <div class="text-xs font-black text-slate-600">MONTANT</div>
                                <div class="text-base font-black text-slate-900 mt-1">${CORE.formatPrice(payment.amount)}</div>
                            </div>
                            <div class="p-3 bg-white rounded border border-slate-200">
                                <div class="text-xs font-black text-slate-600">RÉFÉRENCE</div>
                                <div class="text-base font-black text-slate-900 mt-1">ORD-${payment.orderId}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Statut paiement -->
                    <div class="p-4 bg-blue-50 rounded-2xl border border-blue-200">
                        <div class="font-black text-blue-900 mb-3">✓ Statut</div>
                        <div class="text-sm text-blue-800">
                            En attente de confirmation...
                            <div class="mt-2 text-xs text-blue-600">ID Paiement: ${payment.id}</div>
                        </div>
                    </div>
                </div>
            `, [
                {
                    label: '✓ Paiement Reçu',
                    onclick: `PaymentModule.confirmPayment('${payment.id}'); UI.toast('✓ Paiement confirmé!', 'success'); UI.closeModal(); App.rerender();`,
                    class: 'px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700'
                },
                {
                    label: '✗ Annuler',
                    onclick: `PaymentModule.cancelPayment('${payment.id}'); UI.toast('Paiement annulé', 'warning'); UI.closeModal();`,
                    class: 'px-4 py-2 bg-red-600 text-white font-black rounded-xl hover:bg-red-700'
                }
            ]);
        },

        // ===== AFFICHER HISTORIQUE PAIEMENTS =====
        showPaymentHistory(clientId = null) {
            let payments = CORE.db.mobilePayments;
            if (clientId) payments = payments.filter(p => p.clientId === clientId);

            const stats = this.getPaymentStats();

            UI.modal('💳 Historique Paiements Mobiles', `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <!-- Statistiques -->
                    <div class="grid grid-cols-4 gap-4">
                        <div class="p-3 bg-emerald-50 rounded-lg border border-emerald-200">
                            <div class="text-xs font-black text-emerald-600">Totaux</div>
                            <div class="text-lg font-black text-emerald-700 mt-1">${stats.totalPayments}</div>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="text-xs font-black text-blue-600">Réussis</div>
                            <div class="text-lg font-black text-blue-700 mt-1">${stats.successfulPayments}</div>
                        </div>
                        <div class="p-3 bg-amber-50 rounded-lg border border-amber-200">
                            <div class="text-xs font-black text-amber-600">En attente</div>
                            <div class="text-lg font-black text-amber-700 mt-1">${stats.pendingPayments}</div>
                        </div>
                        <div class="p-3 bg-red-50 rounded-lg border border-red-200">
                            <div class="text-xs font-black text-red-600">Échoués</div>
                            <div class="text-lg font-black text-red-700 mt-1">${stats.failedPayments}</div>
                        </div>
                    </div>

                    <!-- Revenus par provider -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <div class="font-black text-yellow-900">📱 MTN Money</div>
                            <div class="text-lg font-black text-yellow-700 mt-2">${CORE.formatPrice(stats.byProvider.mtn)}</div>
                        </div>
                        <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                            <div class="font-black text-red-900">📱 Airtel Money</div>
                            <div class="text-lg font-black text-red-700 mt-2">${CORE.formatPrice(stats.byProvider.airtel)}</div>
                        </div>
                        <div class="p-4 bg-orange-50 rounded-lg border border-orange-200">
                            <div class="font-black text-orange-900">📱 Orange Money</div>
                            <div class="text-lg font-black text-orange-700 mt-2">${CORE.formatPrice(stats.byProvider.orange)}</div>
                        </div>
                    </div>

                    <!-- Revenus totaux -->
                    <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-200">
                        <div class="text-xs font-black text-emerald-600">REVENU TOTAL PAIEMENTS MOBILES</div>
                        <div class="text-3xl font-black text-emerald-700 mt-2">${CORE.formatPrice(stats.totalRevenue)}</div>
                        <div class="text-xs text-emerald-600 mt-2">Taux de réussite: ${stats.successRate}% • Montant moyen: ${CORE.formatPrice(stats.averageAmount)}</div>
                    </div>

                    <!-- Liste paiements -->
                    <div class="max-h-96 overflow-y-auto space-y-2">
                        ${payments.length > 0 ? payments.slice(-20).reverse().map(p => `
                            <div class="p-3 rounded-lg border border-slate-200 bg-slate-50 hover:bg-slate-100">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="font-black text-slate-900">${p.clientName}</div>
                                        <div class="text-xs text-slate-600">📱 ${p.provider} • ${CORE.formatPrice(p.amount)}</div>
                                    </div>
                                    <span class="px-2 py-1 rounded-full text-xs font-black ${
                                        p.status === 'success' ? 'bg-emerald-100 text-emerald-700' :
                                        p.status === 'pending' ? 'bg-amber-100 text-amber-700' :
                                        'bg-red-100 text-red-700'
                                    }">
                                        ${p.status}
                                    </span>
                                </div>
                                <div class="text-xs text-slate-500 mt-1">${new Date(p.createdAt).toLocaleString('fr-FR')}</div>
                            </div>
                        `).join('') : `<div class="text-center text-slate-400">Aucun paiement</div>`}
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        }
    };

    // =========================================================
    // MODULE: OPTIMISATION ROUTAGE LIVREURS
    // =========================================================
    const RoutageModule = {
        // ===== CALCUL DE DISTANCE (Formule Haversine) =====
        calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Rayon Terre en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        },

        // ===== CLUSTERING D'ADRESSES (K-MEANS SIMPLE) =====
        clusterAddresses(orders, numberOfClusters = 3) {
            if (orders.length === 0) return [];
            if (orders.length <= numberOfClusters) {
                return orders.map((o, i) => ({ ...o, clusterId: i }));
            }

            // Extraire coordonnées
            const points = orders.map(o => ({
                id: o.id,
                lat: o.deliveryLat || -4.263,
                lng: o.deliveryLng || 15.243,
                order: o
            }));

            // Initialiser centroides aléatoires
            let centroids = [];
            for (let i = 0; i < numberOfClusters; i++) {
                const randomPoint = points[Math.floor(Math.random() * points.length)];
                centroids.push({ lat: randomPoint.lat, lng: randomPoint.lng });
            }

            // K-Means itération (3 passes)
            for (let iter = 0; iter < 3; iter++) {
                // Assigner chaque point au centroïde le plus proche
                const clusters = Array(numberOfClusters).fill(null).map(() => []);
                for (const point of points) {
                    let minDist = Infinity;
                    let closestCluster = 0;
                    for (let i = 0; i < centroids.length; i++) {
                        const dist = this.calculateDistance(point.lat, point.lng, centroids[i].lat, centroids[i].lng);
                        if (dist < minDist) {
                            minDist = dist;
                            closestCluster = i;
                        }
                    }
                    clusters[closestCluster].push(point);
                }

                // Recalculer centroides
                for (let i = 0; i < centroids.length; i++) {
                    if (clusters[i].length > 0) {
                        const avgLat = clusters[i].reduce((s, p) => s + p.lat, 0) / clusters[i].length;
                        const avgLng = clusters[i].reduce((s, p) => s + p.lng, 0) / clusters[i].length;
                        centroids[i] = { lat: avgLat, lng: avgLng };
                    }
                }
            }

            // Assigner final avec clusterId
            const result = [];
            for (const point of points) {
                let minDist = Infinity;
                let closestCluster = 0;
                for (let i = 0; i < centroids.length; i++) {
                    const dist = this.calculateDistance(point.lat, point.lng, centroids[i].lat, centroids[i].lng);
                    if (dist < minDist) {
                        minDist = dist;
                        closestCluster = i;
                    }
                }
                result.push({ ...point.order, clusterId: closestCluster, clusterCenter: centroids[closestCluster] });
            }

            return result;
        },

        // ===== OPTIMISATION TSP (NEAREST NEIGHBOR) =====
        optimizeRoute(orders, startPoint = null) {
            if (orders.length === 0) return { route: [], totalDistance: 0, totalTime: 0 };
            if (orders.length === 1) {
                return {
                    route: orders,
                    totalDistance: 0,
                    totalTime: 15 // 15 min pour 1 livraison
                };
            }

            // Point de départ (centre-ville par défaut)
            const start = startPoint || { lat: -4.263359, lng: 15.242885, name: 'Dépôt' };

            // Nearest neighbor algorithm
            let current = start;
            let remaining = [...orders];
            let route = [];
            let totalDistance = 0;
            let sequence = 0;

            while (remaining.length > 0) {
                let nearest = null;
                let nearestDist = Infinity;
                let nearestIdx = -1;

                for (let i = 0; i < remaining.length; i++) {
                    const order = remaining[i];
                    const dist = this.calculateDistance(
                        current.lat, current.lng,
                        order.deliveryLat || -4.263, order.deliveryLng || 15.243
                    );
                    if (dist < nearestDist) {
                        nearestDist = dist;
                        nearest = order;
                        nearestIdx = i;
                    }
                }

                if (nearest) {
                    totalDistance += nearestDist;
                    route.push({ ...nearest, sequence: sequence++, distanceFromPrevious: nearestDist });
                    current = { lat: nearest.deliveryLat, lng: nearest.deliveryLng };
                    remaining.splice(nearestIdx, 1);
                }
            }

            // Estimer temps total (2 min par km + 5 min par arrêt)
            const timePerKm = 2;
            const timePerStop = 5;
            const totalTime = Math.ceil((totalDistance * timePerKm) + (route.length * timePerStop));

            return { route, totalDistance, totalTime };
        },

        // ===== CALCUL COÛTS DE ROUTE =====
        calculateRouteCost(route, livreur = null) {
            const costPerKm = 500; // 500 FCFA par km
            const baseDeliveryFee = 1000; // Frais fixes par livraison
            const totalDistance = route.totalDistance || 0;
            const deliveryCount = (route.route || []).length;

            const costByDistance = totalDistance * costPerKm;
            const costByDelivery = deliveryCount * baseDeliveryFee;
            const totalCost = costByDistance + costByDelivery;

            // Commission si livreur
            const commission = livreur && livreur.commissionPercent
                ? (totalCost * livreur.commissionPercent / 100)
                : 0;

            return {
                costPerKm,
                costByDistance,
                costByDelivery,
                totalCost,
                deliveryCount,
                commission,
                netCost: totalCost - commission
            };
        },

        // ===== CRÉATION ROUTE OPTIMISÉE =====
        createOptimizedRoute(livreurId, orders, date = new Date().toISOString().split('T')[0]) {
            const livreur = CORE.getVisibleUsers().find(u => u.id === livreurId);
            if (!livreur || livreur.role !== 'livreur') return null;

            // Étape 1: Clustering
            const clusteredOrders = this.clusterAddresses(orders, Math.ceil(orders.length / 8));

            // Étape 2: Grouper par cluster
            const clusters = {};
            for (const order of clusteredOrders) {
                if (!clusters[order.clusterId]) clusters[order.clusterId] = [];
                clusters[order.clusterId].push(order);
            }

            // Étape 3: Optimiser chaque cluster
            const optimizedClusters = [];
            for (const clusterId in clusters) {
                const optimized = this.optimizeRoute(clusters[clusterId]);
                optimizedClusters.push({
                    clusterId: parseInt(clusterId),
                    ...optimized
                });
            }

            // Étape 4: Trier clusters par distance au dépôt
            optimizedClusters.sort((a, b) => {
                const centerA = a.route[0]?.clusterCenter || { lat: -4.263, lng: 15.243 };
                const centerB = b.route[0]?.clusterCenter || { lat: -4.263, lng: 15.243 };
                const distA = this.calculateDistance(-4.263359, 15.242885, centerA.lat, centerA.lng);
                const distB = this.calculateDistance(-4.263359, 15.242885, centerB.lat, centerB.lng);
                return distA - distB;
            });

            // Étape 5: Fusionner en une seule route
            const finalRoute = [];
            let totalDistance = 0, totalTime = 0;
            for (const cluster of optimizedClusters) {
                finalRoute.push(...cluster.route);
                totalDistance += cluster.totalDistance;
                totalTime += cluster.totalTime;
            }

            // Étape 6: Calculer coûts
            const costData = this.calculateRouteCost({ route: finalRoute, totalDistance, totalTime });

            // Étape 7: Créer objet route
            const route = {
                id: Utils.uid('ROUTE'),
                livreurId,
                livreurName: livreur.name,
                date,
                startTime: '08:00',
                endTime: null,
                status: 'planned',
                stops: finalRoute.map((order, idx) => ({
                    id: Utils.uid('STOP'),
                    routeId: null, // Sera assigné après
                    orderId: order.id,
                    clientId: order.clientId,
                    clientName: order.clientName,
                    address: order.deliveryAddress,
                    lat: order.deliveryLat,
                    lng: order.deliveryLng,
                    sequence: idx,
                    status: 'pending',
                    arrivalTime: null,
                    departureTime: null,
                    notes: ''
                })),
                totalDistance,
                estimatedTime: totalTime,
                estimatedCost: costData.totalCost,
                actualTime: null,
                actualCost: null,
                completedAt: null,
                costBreakdown: costData,
                createdAt: new Date().toISOString()
            };

            // Mettre à jour stopIds
            route.stops.forEach(s => s.routeId = route.id);

            // Sauvegarder
            CORE.db.deliveryRoutes.push(route);
            CORE.save();

            return route;
        },

        // ===== AFFICHAGE ROUTE SUR CARTE =====
        visualizeRoute(route) {
            if (!route || !route.stops) return '';

            const stops = route.stops || [];
            const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6'];

            return `
                <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-md">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-black text-slate-900 text-lg">🗺️ Route de ${route.livreurName}</h3>
                        <div class="text-xs font-black text-slate-600">
                            📊 ${stops.length} arrêts • 📏 ${route.totalDistance.toFixed(1)} km • ⏱️ ${route.estimatedTime} min
                        </div>
                    </div>

                    <!-- Stats rapides -->
                    <div class="grid grid-cols-4 gap-3 mb-6">
                        <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="text-xs font-black text-blue-600">Distance</div>
                            <div class="text-xl font-black text-blue-700">${route.totalDistance.toFixed(1)} km</div>
                        </div>
                        <div class="p-3 bg-emerald-50 rounded-lg border border-emerald-200">
                            <div class="text-xs font-black text-emerald-600">Temps estimé</div>
                            <div class="text-xl font-black text-emerald-700">${route.estimatedTime} min</div>
                        </div>
                        <div class="p-3 bg-amber-50 rounded-lg border border-amber-200">
                            <div class="text-xs font-black text-amber-600">Coût route</div>
                            <div class="text-xl font-black text-amber-700">${CORE.formatPrice(route.estimatedCost)}</div>
                        </div>
                        <div class="p-3 bg-purple-50 rounded-lg border border-purple-200">
                            <div class="text-xs font-black text-purple-600">Arrêts</div>
                            <div class="text-xl font-black text-purple-700">${stops.length}</div>
                        </div>
                    </div>

                    <!-- Liste des arrêts -->
                    <div class="space-y-2">
                        ${stops.map((stop, idx) => `
                            <div class="flex items-start gap-3 p-3 rounded-lg border border-slate-200 bg-slate-50 hover:bg-slate-100 transition">
                                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-white border-2 font-black text-xs flex items-center justify-center" style="border-color: ${colors[idx % colors.length]}; color: ${colors[idx % colors.length]};">
                                    ${idx + 1}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-black text-slate-900">${stop.clientName || 'Client'}</div>
                                    <div class="text-xs text-slate-600">📍 ${stop.address || 'Adresse non spécifiée'}</div>
                                    ${idx < stops.length - 1 ? `
                                        <div class="text-xs text-slate-500 mt-1">
                                            🚗 ${(route.totalDistance / stops.length).toFixed(1)} km jusqu'à l'arrêt suivant
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="text-xs font-black text-slate-600">
                                    <span class="px-2 py-1 rounded-full" style="background: ${colors[idx % colors.length]}; color: white;">
                                        ${stop.status === 'pending' ? '⏳' : stop.status === 'delivered' ? '✓' : '?'} ${stop.status}
                                    </span>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Actions -->
                    <div class="mt-6 flex gap-2">
                        <button onclick="RoutageModule.startRoute(${route.id})" class="flex-1 px-4 py-2 bg-emerald-600 text-white font-black rounded-lg hover:bg-emerald-700">
                            🚀 Lancer route
                        </button>
                        <button onclick="RoutageModule.showRouteDetails(${route.id})" class="flex-1 px-4 py-2 bg-blue-600 text-white font-black rounded-lg hover:bg-blue-700">
                            📋 Détails
                        </button>
                        <button onclick="RoutageModule.exportRoute(${route.id})" class="flex-1 px-4 py-2 bg-slate-600 text-white font-black rounded-lg hover:bg-slate-700">
                            📥 Export
                        </button>
                    </div>
                </div>
            `;
        },

        // ===== GESTION ROUTE =====
        startRoute(routeId) {
            const route = CORE.db.deliveryRoutes.find(r => r.id === routeId);
            if (!route) return;
            route.status = 'in_progress';
            route.startTime = new Date().toTimeString().split(' ')[0];
            CORE.save();
            UI.toast(`✓ Route lancée pour ${route.livreurName}`, 'success');
            App.rerender();
        },

        completeRoute(routeId, actualTime = null, actualCost = null) {
            const route = CORE.db.deliveryRoutes.find(r => r.id === routeId);
            if (!route) return;
            route.status = 'completed';
            route.actualTime = actualTime || route.estimatedTime;
            route.actualCost = actualCost || route.estimatedCost;
            route.completedAt = new Date().toISOString();
            CORE.save();
            UI.toast(`✓ Route complétée en ${route.actualTime} min`, 'success');
        },

        getRouteById(routeId) {
            return CORE.db.deliveryRoutes.find(r => r.id === routeId);
        },

        getRoutesByLivreur(livreurId, date = null) {
            return CORE.db.deliveryRoutes.filter(r => {
                if (r.livreurId !== livreurId) return false;
                if (date && r.date !== date) return false;
                return true;
            });
        },

        showRouteDetails(routeId) {
            const route = this.getRouteById(routeId);
            if (!route) return;

            const costData = route.costBreakdown || this.calculateRouteCost({ route: route.stops, totalDistance: route.totalDistance });

            UI.modal(`📋 Détails Route - ${route.livreurName}`, `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="text-xs font-black text-slate-600">STATUT</div>
                            <div class="text-lg font-black text-slate-900 mt-2">
                                ${route.status === 'planned' ? '📅 Planifiée' : route.status === 'in_progress' ? '🚚 En cours' : '✅ Complétée'}
                            </div>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <div class="text-xs font-black text-slate-600">DATE</div>
                            <div class="text-lg font-black text-slate-900 mt-2">${route.date}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-blue-50 rounded-2xl border border-blue-200">
                            <div class="text-xs font-black text-blue-600">DISTANCE</div>
                            <div class="text-lg font-black text-blue-700 mt-2">${route.totalDistance.toFixed(1)} km</div>
                        </div>
                        <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-200">
                            <div class="text-xs font-black text-emerald-600">TEMPS</div>
                            <div class="text-lg font-black text-emerald-700 mt-2">${route.estimatedTime} min</div>
                        </div>
                    </div>

                    <div class="p-4 bg-amber-50 rounded-2xl border border-amber-200">
                        <div class="text-xs font-black text-amber-600 mb-3">DÉCOMPOSITION COÛTS</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Coût distance (${costData.costPerKm}/km):</span>
                                <span class="font-black">${CORE.formatPrice(costData.costByDistance)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Frais livraisons (${costData.deliveryCount}):</span>
                                <span class="font-black">${CORE.formatPrice(costData.costByDelivery)}</span>
                            </div>
                            <div class="border-t border-amber-300 pt-2 mt-2 flex justify-between font-black text-amber-700">
                                <span>Total route:</span>
                                <span>${CORE.formatPrice(costData.totalCost)}</span>
                            </div>
                        </div>
                    </div>

                    <div class="max-h-96 overflow-y-auto p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <div class="font-black text-slate-900 mb-3">Arrêts (${route.stops.length})</div>
                        <div class="space-y-2">
                            ${route.stops.map((stop, idx) => `
                                <div class="p-2 bg-white rounded border border-slate-200 text-sm">
                                    <div class="font-black text-slate-900">${idx + 1}. ${stop.clientName}</div>
                                    <div class="text-xs text-slate-600">📍 ${stop.address}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        exportRoute(routeId) {
            const route = this.getRouteById(routeId);
            if (!route) return;

            let csv = 'Séquence,Client,Adresse,Latitude,Longitude,Statut\n';
            for (const stop of route.stops) {
                csv += `${stop.sequence + 1},"${stop.clientName}","${stop.address}",${stop.lat},${stop.lng},"${stop.status}"\n`;
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `route-${route.livreurName}-${route.date}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            UI.toast('✓ Route exportée en CSV', 'success');
        }
    };

    // =========================================================
    // MODULE: ALERTES INTELLIGENTES CONFIGURABLES
    // =========================================================
    const AlertesModule = {
        // ===== GESTION DES PRÉFÉRENCES D'ALERTES =====
        getAlertPreferences(userId) {
            const prefs = (CORE.db.alertPreferences || []).find(p => p.userId === userId);
            if (prefs) return prefs;

            // Créer les préférences par défaut pour ce utilisateur
            const user = CORE.getVisibleUsers().find(u => u.id === userId);
            const defaultPrefs = {
                id: Utils.uid('ALERTPREF'),
                userId,
                userRole: user?.role || 'vendeur',
                alerts: {
                    stock_low: { enabled: true, level: 'attention', sendEmail: false, sendSms: false },
                    stock_critical: { enabled: true, level: 'critique', sendEmail: true, sendSms: false },
                    order_pending: { enabled: true, level: 'attention', sendEmail: false, sendSms: false },
                    inactive_livreur: { enabled: true, level: 'info', sendEmail: false, sendSms: false },
                    critical_incident: { enabled: true, level: 'critique', sendEmail: true, sendSms: true },
                    low_revenue: { enabled: true, level: 'info', sendEmail: false, sendSms: false }
                },
                emailAddress: user?.email || '',
                phoneNumber: user?.phone || '',
                createdAt: new Date().toISOString()
            };
            CORE.db.alertPreferences.push(defaultPrefs);
            return defaultPrefs;
        },

        updateAlertPreference(userId, alertType, enabled, level, sendEmail = false, sendSms = false) {
            const prefs = this.getAlertPreferences(userId);
            if (!prefs.alerts[alertType]) {
                prefs.alerts[alertType] = {};
            }
            prefs.alerts[alertType] = { enabled, level, sendEmail, sendSms };
            CORE.save();
            return prefs;
        },

        // ===== MODE SILENCE PROGRAMMABLE =====
        setSilenceSchedule(userId, name, startTime, endTime, daysOfWeek = []) {
            const schedule = {
                id: Utils.uid('SILENCE'),
                userId,
                name,
                startTime, // "22:00"
                endTime,   // "08:00"
                daysOfWeek: daysOfWeek.length > 0 ? daysOfWeek : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                active: true,
                exceptions: [],
                createdAt: new Date().toISOString()
            };
            CORE.db.silenceSchedules.push(schedule);
            CORE.save();
            return schedule;
        },

        getSilenceSchedules(userId) {
            return (CORE.db.silenceSchedules || []).filter(s => s.userId === userId && s.active);
        },

        isInSilenceWindow(userId) {
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            const dayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][now.getDay()];

            const schedules = this.getSilenceSchedules(userId);
            for (const schedule of schedules) {
                if (!schedule.daysOfWeek.includes(dayName)) continue;

                const [startH, startM] = schedule.startTime.split(':');
                const [endH, endM] = schedule.endTime.split(':');
                const startTs = parseInt(startH) * 60 + parseInt(startM);
                const endTs = parseInt(endH) * 60 + parseInt(endM);
                const currentTs = now.getHours() * 60 + now.getMinutes();

                if (startTs <= endTs) {
                    if (currentTs >= startTs && currentTs <= endTs) return true;
                } else { // Mode nuit (ex: 22:00 à 08:00)
                    if (currentTs >= startTs || currentTs <= endTs) return true;
                }
            }
            return false;
        },

        // ===== GÉNÉRATION ET ENVOI D'ALERTES =====
        generateAlert(userId, type, level, title, message, details = {}) {
            const alert = {
                id: Utils.uid('ALERT'),
                timestamp: new Date().toISOString(),
                userId,
                userRole: CORE.getVisibleUsers().find(u => u.id === userId)?.role || 'vendeur',
                type, // stock_low, order_pending, inactive_livreur, critical_incident, low_revenue
                level, // info, attention, critique
                title,
                message,
                details,
                triggered: true,
                sent: false,
                read: false,
                readAt: null,
                actionTaken: false,
                notes: ''
            };

            CORE.db.alertHistory.push(alert);
            CORE.save();
            return alert;
        },

        shouldNotifyUser(userId, alertType, level) {
            // Vérifier 1: Utilisateur a-t-il activé ce type d'alerte?
            const prefs = this.getAlertPreferences(userId);
            if (!prefs.alerts[alertType]?.enabled) return false;

            // Vérifier 2: Est-on dans une fenêtre de silence?
            if (this.isInSilenceWindow(userId)) {
                // Ne pas envoyer les alertes "info", mais envoyer les "critique"
                if (level !== 'critique') return false;
            }

            return true;
        },

        sendAlertNotification(userId, alert) {
            if (!this.shouldNotifyUser(userId, alert.type, alert.level)) return false;

            const prefs = this.getAlertPreferences(userId);
            const alertConfig = prefs.alerts[alert.type];

            // Marquer comme envoyée
            alert.sent = true;
            alert.sentAt = new Date().toISOString();

            // Envoyer Email si activé
            if (alertConfig?.sendEmail && prefs.emailAddress) {
                console.log(`📧 EMAIL: ${alert.title} → ${prefs.emailAddress}`);
                // Dans un vrai système: ApiService.sendEmail(prefs.emailAddress, alert.title, alert.message)
            }

            // Envoyer SMS si activé
            if (alertConfig?.sendSms && prefs.phoneNumber) {
                console.log(`📱 SMS: ${alert.title} → ${prefs.phoneNumber}`);
                // Dans un vrai système: ApiService.sendSms(prefs.phoneNumber, alert.message)
            }

            // Toast dans l'UI
            const emoji = { info: '🔵', attention: '🟡', critique: '🔴' }[alert.level] || '🔵';
            console.log(`${emoji} ${alert.title}: ${alert.message}`);

            CORE.save();
            return true;
        },

        // ===== VÉRIFICATION DES RÈGLES D'ALERTES =====
        checkAlertRules(userRole) {
            const rules = (CORE.db.alertRules || []).filter(r =>
                r.enabled && (r.role === userRole || r.role === 'multi')
            );

            const alerts = [];
            for (const rule of rules) {
                const alert = this.evaluateRule(rule);
                if (alert) alerts.push(alert);
            }
            return alerts;
        },

        evaluateRule(rule) {
            const { type, condition, level, message } = rule;
            let triggered = false;
            let alertMessage = message;

            switch (type) {
                case 'stock_low':
                case 'stock_critical':
                    const lowStockProducts = CORE.getVisibleProducts().filter(p => {
                        const minStock = condition.value || 10;
                        return p.stock < minStock && p.active;
                    });
                    if (lowStockProducts.length > 0) {
                        triggered = true;
                        alertMessage = `${lowStockProducts.length} produit(s) en stock faible`;
                    }
                    break;

                case 'pending_orders':
                    const pendingOrders = CORE.getVisibleOrders().filter(o =>
                        o.status === 'pending' &&
                        (new Date() - new Date(o.createdAt)) > condition.time
                    );
                    if (pendingOrders.length > 0) {
                        triggered = true;
                        alertMessage = `${pendingOrders.length} commande(s) en attente depuis longtemps`;
                    }
                    break;

                case 'inactive_livreur':
                    const inactiveLivreurs = CORE.getVisibleUsers().filter(u =>
                        u.role === 'livreur' &&
                        u.active &&
                        (!u.lastActivity || (new Date() - new Date(u.lastActivity)) > condition.value)
                    );
                    if (inactiveLivreurs.length > 0) {
                        triggered = true;
                        alertMessage = `${inactiveLivreurs.length} livreur(s) inactif(s)`;
                    }
                    break;

                case 'critical_incident':
                    const incidents = (CORE.db.incidents || []).filter(i =>
                        i.severity === 'haute' && i.status === 'ouvert'
                    );
                    if (incidents.length > 0) {
                        triggered = true;
                        alertMessage = `${incidents.length} incident(s) critique(s) ouvert(s)`;
                    }
                    break;

                case 'low_revenue':
                    // Calculer revenu 30 jours
                    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                    const recentOrders = CORE.getVisibleOrders().filter(o =>
                        new Date(o.createdAt) >= thirtyDaysAgo
                    );
                    const revenue30d = recentOrders.reduce((sum, o) => sum + (o.total || 0), 0);
                    if (revenue30d < condition.value) {
                        triggered = true;
                        alertMessage = `Revenu 30j faible: ${CORE.formatPrice(revenue30d)}`;
                    }
                    break;
            }

            if (!triggered) return null;

            return {
                type,
                level,
                title: rule.message.split(':')[0] || type,
                message: alertMessage
            };
        },

        // ===== MONITORING CONTINU =====
        startAlertMonitoring() {
            if (this.monitoringInterval) return;

            this.monitoringInterval = setInterval(() => {
                const user = CORE.state.currentUser;
                if (!user) return;

                const alerts = this.checkAlertRules(user.role);
                for (const alert of alerts) {
                    const fullAlert = this.generateAlert(
                        user.id,
                        alert.type,
                        alert.level,
                        alert.title,
                        alert.message
                    );
                    this.sendAlertNotification(user.id, fullAlert);
                }
            }, 60000); // Vérifier toutes les minutes
        },

        stopAlertMonitoring() {
            if (this.monitoringInterval) {
                clearInterval(this.monitoringInterval);
                this.monitoringInterval = null;
            }
        },

        // ===== UTILITAIRES SUPPLÉMENTAIRES =====
        updateContactInfo(userId, type, value) {
            const prefs = this.getAlertPreferences(userId);
            if (type === 'email') {
                prefs.emailAddress = value;
            } else if (type === 'phone') {
                prefs.phoneNumber = value;
            }
            CORE.save();
            UI.toast('✓ Coordonnées mises à jour', 'success');
        },

        deleteSilenceSchedule(scheduleId) {
            const idx = CORE.db.silenceSchedules.findIndex(s => s.id === scheduleId);
            if (idx !== -1) {
                CORE.db.silenceSchedules.splice(idx, 1);
                CORE.save();
                UI.toast('✓ Mode silence supprimé', 'success');
            }
        },

        showAddSilenceSchedule(userId) {
            UI.modal('🤐 Ajouter un mode silence', `
                <div class="space-y-4">
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <label class="block text-sm font-black text-slate-900 mb-2">Nom du mode</label>
                        <input type="text" id="silence_name" placeholder="Ex: Nuit, Réunion, Jour off..." class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm font-black">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <label class="block text-sm font-black text-slate-900 mb-2">Heure début</label>
                            <input type="time" id="silence_start" value="22:00" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm font-black">
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                            <label class="block text-sm font-black text-slate-900 mb-2">Heure fin</label>
                            <input type="time" id="silence_end" value="08:00" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm font-black">
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-200">
                        <label class="block text-sm font-black text-slate-900 mb-3">Jours d'application</label>
                        <div class="grid grid-cols-4 gap-2">
                            ${['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(day => `
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" value="${day}" class="silence_days" ${['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].includes(day) ? 'checked' : ''}>
                                    <span class="text-xs font-black">${day}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Créer', onclick: `
                    const name = document.getElementById('silence_name').value || 'Mode silence';
                    const start = document.getElementById('silence_start').value;
                    const end = document.getElementById('silence_end').value;
                    const days = Array.from(document.querySelectorAll('.silence_days:checked')).map(el => el.value);
                    AlertesModule.setSilenceSchedule(${userId}, name, start, end, days.length > 0 ? days : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']);
                    UI.toast('✓ Mode silence créé', 'success');
                    UI.closeModal();
                    App.rerender();
                `, class: 'px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        getAlertHistory(userId, limit = 20) {
            return (CORE.db.alertHistory || [])
                .filter(a => a.userId === userId)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, limit);
        },

        getUnreadAlerts(userId) {
            return (CORE.db.alertHistory || []).filter(a => a.userId === userId && !a.read);
        },

        markAlertAsRead(alertId) {
            const alert = (CORE.db.alertHistory || []).find(a => a.id === alertId);
            if (alert) {
                alert.read = true;
                alert.readAt = new Date().toISOString();
                CORE.save();
            }
        },

        showPOSModal() {
            if (!CORE.hasPermission('managePos')) {
                return UI.toast('Accès refusé', 'error');
            }
            // Afficher directement la vue de gestion des POS
            UI.modal('Gestion des Points de Vente', this.renderPOS(), [{label:'Fermer', onclick:'UI.closeModal()'}], 'max-w-6xl');
        },

        showTransferModal() {
            const currentUser = CORE.state.currentUser || {};
            const hasAssignedPos = currentUser.role === 'gestionnaire' && (currentUser.pos || currentUser.storeId);
            const forcedPosId = hasAssignedPos ? (currentUser.pos || currentUser.storeId) : null;

            if (!forcedPosId) {
                UI.toast('Aucun POS assigné', 'error');
                return;
            }

            const pos = CORE.getPOS(forcedPosId);
            const products = CORE.getVisibleProducts().filter(p => this.productBelongsToPos(p, forcedPosId));

            if (products.length === 0) {
                UI.toast('Aucun produit disponible pour ce POS', 'warning');
                return;
            }

            // Analyse des produits critiques pour ce POS
            const posStock = {};
            products.forEach(p => {
                posStock[p.id] = CORE.getProductStock(p.id, forcedPosId) || 0;
            });

            // Suggestions basées sur les stocks bas
            const suggestions = [];
            products.forEach(p => {
                const minStock = p.minStock || 0;
                if (minStock <= 0) return;
                const stock = posStock[p.id] || 0;
                const target = Math.max(minStock * 2, minStock + 20);
                const deficit = target - stock;
                if (deficit <= 0) return;
                suggestions.push({
                    productId: p.id,
                    productName: p.name,
                    stock,
                    minStock,
                    suggestedQty: deficit,
                    severity: stock <= Math.max(1, minStock * 0.5) ? 'critical' : 'low'
                });
            });

            suggestions.sort((a, b) => {
                if (a.severity !== b.severity) return a.severity === 'critical' ? -1 : 1;
                return (a.stock / (a.minStock + 1)) - (b.stock / (b.minStock + 1));
            });

            const topSuggestions = suggestions.slice(0, 5);
            const defaultProduct = products[0];
            const defaultSuggestion = topSuggestions[0] || null;

            const html = `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="p-4 rounded-2xl bg-blue-50 border border-blue-200">
                            <div class="text-xs font-black text-blue-600 uppercase">Stock POS</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${products.reduce((sum, p) => sum + (posStock[p.id] || 0), 0)}</div>
                            <div class="text-[11px] text-blue-700">Unités à ${pos.name}</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-200">
                            <div class="text-xs font-black text-emerald-600 uppercase">Valeur estimée</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${CORE.formatPrice(products.reduce((sum, p) => sum + ((posStock[p.id] || 0) * (p.price || 0)), 0))}</div>
                            <div class="text-[11px] text-emerald-700">Stock valorisé</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-amber-50 border border-amber-200">
                            <div class="text-xs font-black text-amber-600 uppercase">Produits critiques</div>
                            <div class="text-2xl font-black text-amber-900 mt-1">${products.filter(p => (posStock[p.id] || 0) <= (p.minStock || 0)).length}</div>
                            <div class="text-[11px] text-amber-700">À surveiller</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                        <div class="space-y-4">
                            <div class="p-5 bg-white rounded-3xl border border-slate-200 space-y-4">
                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Produit à transférer vers ${pos.name}</label>
                                    <select id="transfer_product" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-teal-500">
                                        ${products.map(p => `
                                            <option value="${p.id}" ${p.id === defaultProduct.id ? 'selected' : ''}>
                                                ${p.name} • Stock actuel: ${posStock[p.id] || 0}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-3 text-center text-sm">
                                    <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                        <div class="text-xs font-bold text-slate-500 uppercase">Stock actuel</div>
                                        <div id="transfer_summary_stock" class="text-xl font-black text-slate-900">0</div>
                                    </div>
                                    <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                        <div class="text-xs font-bold text-slate-500 uppercase">Stock min.</div>
                                        <div id="transfer_summary_min" class="text-xl font-black text-slate-900">0</div>
                                    </div>
                                </div>

                                <div class="p-3 rounded-2xl bg-emerald-50 border border-emerald-200">
                                    <div class="flex items-center justify-between text-sm font-bold text-emerald-700">
                                        <span>Suggestion de réappro</span>
                                        <span id="transfer_summary_suggested">0 unités</span>
                                    </div>
                                </div>

                                <div class="flex flex-wrap gap-2">
                                    <button data-transfer-set="suggested" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700 transition">Appliquer suggestion</button>
                                    <button data-transfer-set="min" class="px-3 py-2 rounded-xl bg-blue-600 text-white text-xs font-black hover:bg-blue-700 transition">Atteindre Min</button>
                                    <button data-transfer-set="+25" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300 transition">+25</button>
                                    <button data-transfer-set="+50" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300 transition">+50</button>
                                    <button data-transfer-set="clear" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-100 transition">Réinitialiser</button>
                                </div>

                                <div class="grid grid-cols-2 gap-3 items-end">
                                    <div>
                                        <label class="block text-xs font-black text-slate-500 uppercase mb-2">Quantité à recevoir</label>
                                        <input id="transfer_qty" type="number" min="0" value="0" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-black text-lg text-center bg-white focus:ring-2 focus:ring-teal-500">
                                        <div id="transfer_warning" class="mt-2 text-xs font-bold text-red-600 hidden">⚠️ Vérifiez le stock disponible</div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-black text-slate-500 uppercase mb-2">Référence</label>
                                        <input id="transfer_ref" type="text" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-slate-50" placeholder="Auto-généré" readonly>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Note interne (optionnelle)</label>
                                    <textarea id="transfer_note" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-white" rows="2" placeholder="Ex: Réassort saisonnier..."></textarea>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Numéro de suivi (optionnel)</label>
                                    <input id="transfer_tracking" type="text" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-white" placeholder="Ex: TRANSFERT-2026-001">
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Arrivée estimée</label>
                                    <input id="transfer_eta" type="datetime-local" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-white">
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="p-5 bg-white rounded-3xl border border-slate-200">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="font-black text-slate-900 text-sm">🎯 Produits à surveiller</div>
                                    <span class="text-xs text-slate-500 font-bold">${topSuggestions.length} alertes</span>
                                </div>
                                ${topSuggestions.length === 0 ? `
                                    <div class="p-4 rounded-2xl bg-slate-50 text-sm text-slate-500 text-center">
                                        Aucune alerte détectée pour ce POS.
                                    </div>
                                ` : `
                                    <div class="space-y-2">
                                        ${topSuggestions.map(s => `
                                            <div class="p-3 rounded-2xl border ${s.severity === 'critical' ? 'border-red-200 bg-red-50' : 'border-amber-200 bg-amber-50'} flex items-center justify-between gap-3">
                                                <div>
                                                    <div class="font-black text-slate-900 text-sm">${s.productName}</div>
                                                    <div class="text-xs text-slate-600">Stock: ${s.stock}/${s.minStock}</div>
                                                    <div class="text-xs font-bold text-slate-500">Suggestion: ${s.suggestedQty} unités</div>
                                                </div>
                                                <button data-transfer-suggestion data-product-id="${s.productId}" data-suggested-qty="${s.suggestedQty}" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-xs font-black hover:bg-slate-800 transition whitespace-nowrap">Appliquer</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>

                            <div class="p-5 bg-white rounded-3xl border border-slate-200">
                                <div class="font-black text-slate-900 text-sm mb-3">📊 Résumé du transfert</div>
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                        <span class="text-slate-600">Produit sélectionné</span>
                                        <span id="summary_product" class="font-black text-slate-900">-</span>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                        <span class="text-slate-600">Quantité</span>
                                        <span id="summary_qty" class="font-black text-slate-900">0 unités</span>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                        <span class="text-slate-600">Valeur estimée</span>
                                        <span id="summary_value" class="font-black text-slate-900">0 XAF</span>
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-emerald-50 border border-emerald-200 rounded-xl">
                                        <span class="font-bold text-emerald-700">Stock après transfert</span>
                                        <span id="summary_stock_after" class="font-black text-emerald-900">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            UI.modal(`🔄 Recevoir des articles - ${pos.name}`, html, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer transfert', onclick: 'GestionnaireModule.executeTransfer()', class: 'px-5 py-2.5 bg-teal-600 text-white font-black rounded-xl hover:bg-teal-700 transition' }
            ]);

            setTimeout(() => {
                const modalEl = document.querySelector('#modalContainer .slide-up');
                if (modalEl) {
                    modalEl.classList.remove('max-w-lg');
                    modalEl.classList.add('max-w-5xl');
                }

                const productSelect = document.getElementById('transfer_product');
                const qtyInput = document.getElementById('transfer_qty');
                const refInput = document.getElementById('transfer_ref');
                const summaryStock = document.getElementById('transfer_summary_stock');
                const summaryMin = document.getElementById('transfer_summary_min');
                const summarySuggested = document.getElementById('transfer_summary_suggested');
                const summaryProduct = document.getElementById('summary_product');
                const summaryQty = document.getElementById('summary_qty');
                const summaryValue = document.getElementById('summary_value');
                const summaryStockAfter = document.getElementById('summary_stock_after');
                const warning = document.getElementById('transfer_warning');

                const updateSummary = () => {
                    const productId = parseInt(productSelect.value, 10);
                    const product = CORE.getProduct(productId) || {};
                    const qty = parseInt(qtyInput.value || 0, 10);
                    const currentStock = posStock[productId] || 0;
                    const minStock = product.minStock || 0;
                    const suggestedQty = Math.max(0, Math.max(minStock * 2, minStock + 20) - currentStock);

                    summaryStock.textContent = currentStock;
                    summaryMin.textContent = minStock;
                    summarySuggested.textContent = `${suggestedQty} unités`;
                    summaryProduct.textContent = product.name || '-';
                    summaryQty.textContent = `${qty} unités`;
                    summaryValue.textContent = CORE.formatPrice(qty * (product.price || 0));
                    summaryStockAfter.textContent = `${currentStock + qty} unités`;

                    warning.classList.toggle('hidden', qty >= 0);
                };

                productSelect?.addEventListener('change', updateSummary);
                qtyInput?.addEventListener('input', updateSummary);

                // Boutons de suggestion
                document.querySelectorAll('[data-transfer-set]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = parseInt(productSelect.value, 10);
                        const product = CORE.getProduct(productId) || {};
                        const currentStock = posStock[productId] || 0;
                        const minStock = product.minStock || 0;
                        const action = btn.getAttribute('data-transfer-set');

                        if (action === 'suggested') {
                            const suggested = Math.max(minStock * 2, minStock + 20) - currentStock;
                            qtyInput.value = Math.max(0, suggested);
                        } else if (action === 'min') {
                            qtyInput.value = Math.max(0, minStock - currentStock);
                        } else if (action === 'clear') {
                            qtyInput.value = 0;
                        } else if (action.startsWith('+')) {
                            const add = parseInt(action.substring(1), 10);
                            qtyInput.value = parseInt(qtyInput.value || 0, 10) + add;
                        }
                        updateSummary();
                    });
                });

                // Boutons de suggestion rapide
                document.querySelectorAll('[data-transfer-suggestion]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const productId = btn.getAttribute('data-product-id');
                        const suggestedQty = btn.getAttribute('data-suggested-qty');
                        productSelect.value = productId;
                        qtyInput.value = suggestedQty;
                        updateSummary();
                    });
                });

                updateSummary();
            }, 100);
        },

        executeTransfer() {
            const currentUser = CORE.state.currentUser || {};
            const forcedPosId = currentUser.pos || currentUser.storeId;
            const pos = CORE.getPOS(forcedPosId);

            const productId = parseInt(document.getElementById('transfer_product')?.value || 0, 10);
            const qty = Math.abs(parseInt(document.getElementById('transfer_qty')?.value || 0, 10));
            const note = document.getElementById('transfer_note')?.value || '';
            const tracking = document.getElementById('transfer_tracking')?.value || '';
            const eta = document.getElementById('transfer_eta')?.value || '';

            if (!productId || !qty) {
                UI.toast('Sélectionnez un produit et une quantité', 'warning');
                return;
            }

            const product = CORE.getProduct(productId);
            if (!product) {
                UI.toast('Produit introuvable', 'error');
                return;
            }

            // Actually update posStocks for the destination POS
            const currentStock = CORE.getProductStock(productId, forcedPosId) || 0;
            CORE.setProductStock(productId, forcedPosId, currentStock + qty);

            // Enregistrer le transfert entrant au POS
            CORE.recordStockMovement({
                productId: product.id,
                type: 'in',
                qty: qty,
                note: `Transfert reçu${note ? ': ' + note : ''}`,
                posId: forcedPosId,
                meta: {
                    source: 'gestionnaire_transfer',
                    direction: 'in',
                    fromOrigin: 'depot',
                    originName: 'Dépôt principal',
                    destinationName: pos?.name || 'POS',
                    toPosId: forcedPosId,
                    tracking: tracking,
                    eta: eta,
                    userId: currentUser.id
                }
            });

            CORE.markDirty('products');
            CORE.markDirty('stockMovements');
            CORE.save();
            this.invalidateCache(['products', 'stocks']);
            UI.closeModal();
            UI.toast(`✅ ${qty} unités de ${product.name} reçues à ${pos?.name || 'POS'}`, 'success');
            App.rerender();
        },

        productBelongsToPos(product, posId) {
            if (!posId) return true;
            if (!product) return false;
            const strPosId = String(posId);

            // BUG FIX (v37): Check posStocks FIRST — if this POS has ANY posStocks entry,
            // the product belongs here. The mere existence of the entry proves assignment
            // (even if stock=0 or timestamps were stripped by cloud sync).
            const _stockMap = product.posStocks || {};
            const _transferEntry = _stockMap[strPosId] ?? _stockMap[posId] ?? null;
            if (_transferEntry) return true;

            // Si produit est verrouillé à un POS spécifique
            if (product.lockedToPosId && String(product.lockedToPosId) !== strPosId) {
                return false;
            }

            // Si le produit a un posId défini, il appartient EXCLUSIVEMENT à ce POS
            if (product.posId !== null && product.posId !== undefined) {
                if (String(product.posId) === strPosId) return true;
                return false;
            }

            // Pour les produits sans posId (produits globaux/main warehouse)
            if (product.isMainWarehouse) return false;
            return false;
        },

        // ============ GESTION DÉPENSES ET REVENUS ============
        showNewExpenseModal() {
            const expenseCategories = [
                { value: 'stock', label: '📦 Achat de stock/produits' },
                { value: 'transport', label: '🚚 Frais de transport' },
                { value: 'salaire', label: '💼 Salaires' },
                { value: 'loyer', label: '🏢 Loyer/Local' },
                { value: 'electricite', label: '⚡ électricité/Eau' },
                { value: 'telephone', label: '📱 Téléphone/Internet' },
                { value: 'maintenance', label: '🔧 Maintenance/Réparation' },
                { value: 'hygieneEntretien', label: '🧹 Hygiène/Entretien' },
                { value: 'publicite', label: '📢 Publicité/Marketing' },
                { value: 'assurance', label: '🛡️ Assurance' },
                { value: 'taxe', label: '💰 Taxes/Impôts' },
                { value: 'banque', label: '🏦 Frais bancaires' },
                { value: 'deplacement', label: '🚗 Déplacement/Carburant' },
                { value: 'formation', label: '📚 Formation/Cours' },
                { value: 'equipement', label: '🛠️ Équipement/Matériel' },
                { value: 'autre', label: '📋 Autre' }
            ];

            UI.modal('Nouvelle Dépense', `
                <div class="space-y-4">
                    <div class="p-4 bg-red-50 border border-red-200 rounded-xl">
                        <div class="flex items-center gap-2 text-red-700 font-bold">
                            <i data-lucide="alert-circle" class="w-5 h-5"></i>
                            Enregistrer une sortie d'argent
                        </div>
                        <div class="text-xs text-red-600 mt-1">Cette dépense sera enregistrée pour votre POS</div>
                    </div>
                    ${UI.input('ge_amount', 'Montant (XAF)', 'number', '', 'ex: 50000', true)}
                    ${UI.select('ge_category', 'Catégorie', expenseCategories, 'stock', true)}
                    ${UI.textarea('ge_note', 'Description / Justification', '', 'Détails de la dépense...', 3)}
                    ${UI.input('ge_ref', 'Référence (optionnel)', 'text', '', 'N° facture, reçu...')}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer la dépense', onclick: 'GestionnaireModule.saveExpense()', class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);
            setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 50);
        },

        saveExpense() {
            const amount = parseFloat(UI.val('ge_amount')) || 0;
            const category = UI.val('ge_category') || 'autre';
            const note = UI.val('ge_note').trim();
            const ref = UI.val('ge_ref').trim();

            if (amount <= 0) return UI.toast('Montant invalide', 'warning');

            const categoryLabels = {
                'stock': 'Achat de stock/produits', 'transport': 'Frais de transport', 'salaire': 'Salaires',
                'loyer': 'Loyer/Local', 'electricite': 'Électricité/Eau', 'telephone': 'Téléphone/Internet',
                'maintenance': 'Maintenance/Réparation', 'hygieneEntretien': 'Hygiène/Entretien',
                'publicite': 'Publicité/Marketing', 'assurance': 'Assurance', 'taxe': 'Taxes/Impôts',
                'banque': 'Frais bancaires', 'deplacement': 'Déplacement/Carburant', 'formation': 'Formation/Cours',
                'equipement': 'Équipement/Matériel', 'autre': 'Autre'
            };

            CORE.db.financialTransactions = CORE.db.financialTransactions || [];
            // P3-7: Use CORE.create() for CRDT stamps + cloud sync
            const expenseEntry = CORE.create('financialTransactions', {
                userId: CORE.state.currentUser?.id,
                userName: CORE.state.currentUser?.name || 'Gestionnaire',
                posId: CORE.state.currentUser?.pos,
                type: 'expense',
                amount,
                category: categoryLabels[category] || category,
                note,
                reference: ref
            });
            CORE.logAudit('create', 'expense', expenseEntry.id, categoryLabels[category] || category, { description: `Dépense: ${CORE.formatPrice(amount)} - ${categoryLabels[category] || category}`, amount });
            UI.closeModal();
            UI.toast('Dépense enregistrée avec succès', 'success');
            App.rerender();
        },

        showNewIncomeModal() {
            const incomeCategories = [
                { value: 'vente', label: '🛒 Vente directe' },
                { value: 'depot_caisse', label: '💵 Dépôt en caisse' },
                { value: 'service', label: '🔧 Service rendu' },
                { value: 'remboursement', label: '↩️ Remboursement reçu' },
                { value: 'depot_livreur', label: '📥 Dépôt livreur' },
                { value: 'investissement', label: '💼 Investissement/Capital' },
                { value: 'pret', label: '🏦 Prêt reçu' },
                { value: 'autre', label: '📋 Autre' }
            ];

            UI.modal('Nouveau Revenu / Dépôt', `
                <div class="space-y-4">
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                        <div class="flex items-center gap-2 text-emerald-700 font-bold">
                            <i data-lucide="trending-up" class="w-5 h-5"></i>
                            Enregistrer une entrée d'argent
                        </div>
                        <div class="text-xs text-emerald-600 mt-1">Ce revenu sera enregistré pour votre POS</div>
                    </div>
                    ${UI.input('gi_amount', 'Montant (XAF)', 'number', '', 'ex: 100000', true)}
                    ${UI.select('gi_category', 'Source / Catégorie', incomeCategories, 'depot_caisse', true)}
                    ${UI.textarea('gi_note', 'Description', '', 'Détails du revenu...', 3)}
                    ${UI.input('gi_ref', 'Référence (optionnel)', 'text', '', 'N° reçu, facture...')}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer le revenu', onclick: 'GestionnaireModule.saveNewIncome()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
            setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 50);
        },

        saveNewIncome() {
            const amount = parseFloat(UI.val('gi_amount')) || 0;
            const category = UI.val('gi_category') || 'autre';
            const note = UI.val('gi_note').trim();
            const ref = UI.val('gi_ref').trim();

            if (amount <= 0) return UI.toast('Montant invalide', 'warning');

            CORE.db.financialTransactions = CORE.db.financialTransactions || [];
            // P3-7: Use CORE.create() for CRDT stamps + cloud sync
            const incomeEntry = CORE.create('financialTransactions', {
                userId: CORE.state.currentUser?.id,
                userName: CORE.state.currentUser?.name || 'Gestionnaire',
                posId: CORE.state.currentUser?.pos,
                type: 'income',
                amount,
                category,
                note,
                reference: ref
            });
            CORE.logAudit('create', 'income', incomeEntry.id, category, { description: `Revenu: ${CORE.formatPrice(amount)} - ${category}`, amount });
            UI.closeModal();
            UI.toast('Revenu enregistré avec succès', 'success');
            App.rerender();
        }
    };

    // =========================================================
    // MODULE: MANAGER
    // =========================================================
    const ManagerModule = {
        state: {
            currentView: 'dashboard',
            theme: 'light',
            accentColor: 'blue',
            preferences: { notificationsEnabled: true, soundEnabled: true, soundVolume: 0.8 },
            inventoryTab: 'products', // products | movements
            inventorySearch: '',
            inventoryPosId: '', // Filter by POS
            movementsType: 'all',
            movementsSearch: '',

            // Inventory pagination
            inventoryPage: 1,
            inventoryPerPage: 50,
            inventoryCategoryFilter: 'all',
            inventoryStatusFilter: 'all',
            inventorySortBy: 'name',

            // Main stock pagination
            mainStockPage: 1,
            mainStockPerPage: 50,

            // Finance
            financeTab: 'overview', // overview | transactions | cod | commissions
            financeFrom: '',
            financeTo: '',
            financeSearch: '',
            financeType: 'all', // all | income | expense
            financeCategory: 'all',
            financeMethod: 'all',
            financeCityId: '',
            financePosId: '',

            // Team (Manager)
            teamSearch: '',
            teamRole: 'all', // all | gestionnaire | vendeur | livreur
            teamPosId: 'all',
            teamPage: 1,
            teamPerPage: 20,
            teamViewMode: 'list',
            teamSortBy: 'name',
            teamSortOrder: 'asc'
        },

        navigateTo(view) { this.state.currentView = view; App.rerender(); },

        // productBelongsToPos — checks if a product belongs to a specific POS
        productBelongsToPos(product, posId) {
            if (!posId) return true;
            if (!product) return false;
            const strPosId = String(posId);
            // BUG FIX (v37): If posStocks entry EXISTS for this POS, product belongs here.
            const _stockMap = product.posStocks || {};
            const _transferEntry = _stockMap[strPosId] ?? _stockMap[posId] ?? null;
            if (_transferEntry) return true;
            if (product.lockedToPosId && String(product.lockedToPosId) !== strPosId) return false;
            if (product.posId !== null && product.posId !== undefined) {
                if (String(product.posId) === strPosId) return true;
                return false;
            }
            if (product.isMainWarehouse) return false;
            return false;
        },

        // Afficher les détails d'une livraison avec preuves (Manager)
        showDeliveryDetail(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return UI.toast('Livraison introuvable', 'error');
            const livreur = d.livreurId ? CORE.getUser(d.livreurId) : null;
            const pos = d.posId ? CORE.getPOS(d.posId) : null;
            const badge = d.status === 'livree' ? UI.badge('Livrée','emerald') :
                          d.status === 'probleme' ? UI.badge('Problème','red') :
                          d.status === 'en_attente' ? UI.badge('À assigner','blue') :
                          d.status === 'annulee' ? UI.badge('Annulée','slate') : UI.badge('En cours','amber');

            const hasProofPhotos = d.proofPhotos && d.proofPhotos.length > 0;
            const hasProofSignature = !!d.proofSignature;
            const hasProof = hasProofPhotos || hasProofSignature;

            UI.modal(`📦 Livraison ${d.orderRef}`, `
                <div class="space-y-4 max-h-[75vh] overflow-y-auto">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Statut</div>
                            <div class="mt-1">${badge}</div>
                        </div>
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-right">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Montant</div>
                            <div class="mt-1 text-2xl font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Client</div>
                        <div class="mt-1 font-black text-slate-900">${d.clientName || '—'}</div>
                        <div class="text-xs text-slate-600">${d.clientPhone || ''}</div>
                        <div class="mt-2 text-xs text-slate-600"><b>Adresse:</b> ${d.address || '—'}</div>
                        ${d.deliveryTime ? `<div class="mt-1 text-xs text-slate-600"><b>Heure:</b> ${d.deliveryTime}</div>` : ''}
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Livreur</div>
                        <div class="mt-1 font-black">${livreur?.name || 'Non assigné'}</div>
                        <div class="text-xs text-slate-600">${livreur?.phone || ''}</div>
                    </div>

                    ${pos ? `
                    <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-2xl">
                        <div class="text-xs font-black text-indigo-500 uppercase tracking-wider">Point de vente</div>
                        <div class="mt-1 font-black text-indigo-900">${pos.name}</div>
                        <div class="text-xs text-indigo-600">${CORE.getCity(pos.cityId)?.name || ''}</div>
                    </div>
                    ` : ''}

                    ${hasProof ? `
                    <!-- PREUVES DE LIVRAISON -->
                    <div class="p-4 bg-gradient-to-r from-emerald-50 to-teal-50 border-2 border-emerald-300 rounded-2xl">
                        <div class="text-xs font-black text-emerald-700 uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i data-lucide="camera" class="w-4 h-4"></i>
                            📷 Preuves de livraison
                        </div>

                        ${hasProofPhotos ? `
                        <div class="mb-3">
                            <div class="text-xs font-bold text-emerald-600 mb-2">Photos (${d.proofPhotos.length})</div>
                            <div class="grid grid-cols-3 gap-2">
                                ${d.proofPhotos.map((photo, idx) => `
                                    <div class="aspect-square rounded-xl overflow-hidden border-2 border-emerald-300 cursor-pointer hover:border-emerald-500 transition shadow-md" onclick="window.open('${photo.replace(/'/g, "\\'")}', '_blank')">
                                        <img src="${photo}" class="w-full h-full object-cover hover:scale-105 transition" alt="Preuve ${idx + 1}">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${hasProofSignature ? `
                        <div>
                            <div class="text-xs font-bold text-emerald-600 mb-2">✍️ Signature client</div>
                            <div class="p-3 bg-white rounded-xl border-2 border-blue-200 cursor-pointer hover:border-blue-400 transition" onclick="window.open('${d.proofSignature.replace(/'/g, "\\'")}', '_blank')">
                                <img src="${d.proofSignature}" class="w-full max-h-24 object-contain" alt="Signature">
                            </div>
                        </div>
                        ` : ''}

                        ${d.proofNote ? `
                        <div class="mt-3 p-3 bg-white rounded-xl border border-emerald-200">
                            <div class="text-xs font-bold text-slate-500 mb-1">Note du livreur</div>
                            <div class="text-sm text-slate-700">${d.proofNote}</div>
                        </div>
                        ` : ''}

                        <div class="text-center text-xs text-emerald-600 mt-3">
                            Validée le ${d.proofTimestamp ? new Date(d.proofTimestamp).toLocaleString('fr-FR') : (d.deliveredAt ? new Date(d.deliveredAt).toLocaleString('fr-FR') : '—')}
                        </div>
                    </div>
                    ` : (d.status === 'livree' ? `
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-center">
                        <div class="text-slate-400 text-sm">📷 Aucune preuve de livraison disponible</div>
                    </div>
                    ` : '')}

                    ${d.recallReason ? `<div class="p-4 bg-amber-50 border border-amber-100 rounded-2xl text-xs text-amber-800"><b>Rappel:</b> ${d.recallReason}</div>` : ''}
                    ${d.recalledAt ? `<div class="text-xs text-slate-500">Rappelée: ${CORE.formatDate(d.recalledAt)}</div>` : ''}
                    <div class="text-xs text-slate-500">Créée: ${CORE.formatDate(d.createdAt)}</div>
                    ${d.deliveredAt ? `<div class="text-xs text-emerald-600">Livrée: ${CORE.formatDate(d.deliveredAt)}</div>` : ''}
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        setTheme(theme) {
            this.state.theme = theme;
            localStorage.setItem('manager_theme', theme);

            // Appliquer le thème directement (style WhatsApp comme Vendeur)
            const html = document.documentElement;
            const body = document.body;

            html.classList.remove('manager-dark', 'manager-light', 'manager-auto');
            if (body) body.classList.remove('manager-dark', 'manager-light', 'manager-auto');
            html.style.filter = 'none';

            if (theme === 'dark') {
                html.classList.add('manager-dark');
                if (body) body.classList.add('manager-dark');
                html.style.backgroundColor = '#111b21';
            } else if (theme === 'light') {
                html.classList.add('manager-light');
                if (body) body.classList.add('manager-light');
                html.style.backgroundColor = '#ffffff';
            } else if (theme === 'auto') {
                html.classList.add('manager-auto');
                if (body) body.classList.add('manager-auto');
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.backgroundColor = isDark ? '#111b21' : '#ffffff';
                if (isDark) {
                    html.classList.add('manager-dark');
                    if (body) body.classList.add('manager-dark');
                }
            }

            UI.toast('Thème: ' + (theme === 'light' ? 'Clair' : theme === 'dark' ? 'Sombre' : 'Auto'), 'success');
            App.rerender();
        },

        applyTheme() {
            const html = document.documentElement;
            const body = document.body;
            const theme = this.state.theme;

            html.classList.remove('manager-dark', 'manager-light', 'manager-auto');
            if (body) body.classList.remove('manager-dark', 'manager-light', 'manager-auto');
            html.style.filter = 'none';

            if (theme === 'dark') {
                html.classList.add('manager-dark');
                if (body) body.classList.add('manager-dark');
                html.style.backgroundColor = '#111b21';
            } else if (theme === 'light') {
                html.classList.add('manager-light');
                if (body) body.classList.add('manager-light');
                html.style.backgroundColor = '#ffffff';
            } else if (theme === 'auto') {
                html.classList.add('manager-auto');
                if (body) body.classList.add('manager-auto');
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.backgroundColor = isDark ? '#111b21' : '#ffffff';
                if (isDark) {
                    html.classList.add('manager-dark');
                    if (body) body.classList.add('manager-dark');
                }
            }
        },

        loadThemePreference() {
            const saved = localStorage.getItem('manager_theme');
            if (saved) {
                this.state.theme = saved;
                this.applyTheme();
            }
        },

        getMetrics() {
            const posId = CORE.state.currentUser?.pos || 1;
            const orders = (CORE.getVisibleOrders() || []).filter(o => o.posId === posId);
            const revenue = orders.filter(o => o.status === 'delivered').reduce((a,o)=>a+(o.total||0),0);
            const pending = orders.filter(o => o.status === 'pending').length;
            const lowStock = (CORE.getVisibleProducts() || []).filter(p => !p.isMainWarehouse && p.stock <= p.minStock).length;
            return { revenue, ordersCount: orders.length, pending, lowStock };
        },

        getKPIs() {
            const posId = CORE.state.currentUser?.pos || 1;
            const orders = (CORE.getVisibleOrders() || []).filter(o => o.posId === posId);
            const completedOrders = orders.filter(o => o.status === 'delivered');
            const revenue = completedOrders.reduce((a,o)=>a+(o.total||0),0);
            const conversionRate = orders.length > 0 ? ((completedOrders.length / orders.length) * 100).toFixed(1) : 0;
            const avgBasket = completedOrders.length > 0 ? (revenue / completedOrders.length).toFixed(2) : 0;

            return {
                totalOrders: orders.length,
                completedOrders: completedOrders.length,
                revenue: revenue,
                conversionRate: conversionRate,
                avgBasket: avgBasket,
                avgDeliveryTime: 2.5 // jours
            };
        },

        getWeeklyComparison() {
            const posId = CORE.state.currentUser?.pos || 1;
            const now = new Date();
            const currentWeekStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
            const previousWeekStart = new Date(currentWeekStart.getTime() - 7 * 24 * 60 * 60 * 1000);
            const previousWeekEnd = new Date(currentWeekStart.getTime() - 1);

            const visibleOrders = CORE.getVisibleOrders() || [];

            const currentOrders = visibleOrders.filter(o => {
                const d = new Date(o.createdAt);
                return o.posId === posId && d >= currentWeekStart && o.status === 'delivered';
            });

            const previousOrders = visibleOrders.filter(o => {
                const d = new Date(o.createdAt);
                return o.posId === posId && d >= previousWeekStart && d <= previousWeekEnd && o.status === 'delivered';
            });

            const currentRevenue = currentOrders.reduce((a,o)=>a+(o.total||0),0);
            const previousRevenue = previousOrders.reduce((a,o)=>a+(o.total||0),0);
            const revenueChange = previousRevenue > 0 ? (((currentRevenue - previousRevenue) / previousRevenue) * 100).toFixed(1) : 0;
            const ordersChange = previousOrders.length > 0 ? (((currentOrders.length - previousOrders.length) / previousOrders.length) * 100).toFixed(1) : 0;

            return {
                currentRevenue, previousRevenue, revenueChange,
                currentOrders: currentOrders.length, previousOrders: previousOrders.length, ordersChange
            };
        },

        getDailyTrends(days = 7) {
            const posId = CORE.state.currentUser?.pos || 1;
            const trends = [];
            const today = new Date();

            const visibleOrders = CORE.getVisibleOrders() || [];

            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth(), today.getDate() - i);
                const dayStart = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const dayEnd = new Date(dayStart.getTime() + 24 * 60 * 60 * 1000);

                const dayOrders = visibleOrders.filter(o => {
                    const d = new Date(o.createdAt);
                    return o.posId === posId && d >= dayStart && d < dayEnd && o.status === 'delivered';
                });

                const revenue = dayOrders.reduce((a,o)=>a+(o.total||0),0);
                trends.push({
                    date: date.toLocaleDateString('fr-FR', {weekday: 'short', month: 'short', day: 'numeric'}),
                    revenue: revenue,
                    orders: dayOrders.length,
                    avgOrder: dayOrders.length > 0 ? (revenue / dayOrders.length).toFixed(0) : 0
                });
            }
            return trends;
        },

        getHourlyDistribution() {
            const posId = CORE.state.currentUser?.pos || 1;
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);

            const visibleOrders = CORE.getVisibleOrders() || [];

            const hourlyData = Array(24).fill(0);
            const orders = visibleOrders.filter(o => {
                const d = new Date(o.createdAt);
                return o.posId === posId && d >= startOfDay;
            });

            orders.forEach(o => {
                const hour = new Date(o.createdAt).getHours();
                hourlyData[hour]++;
            });

            return hourlyData;
        },

        getTopPerformers() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

            // Vendeurs
            const vendeurs = (CORE.getVisibleUsers() || []).filter(u => u.active && u.role === 'vendeur');
            const vendeurPerf = vendeurs.map(v => {
                const orders = (CORE.getVisibleOrders() || []).filter(o => o.vendeurId === v.id && new Date(o.createdAt) >= thirtyDaysAgo);
                const revenue = orders.reduce((s, o) => s + (o.total || 0), 0);
                return { ...v, orders: orders.length, revenue };
            }).sort((a, b) => b.revenue - a.revenue);

            // Livreurs
            const livreurs = (CORE.getVisibleUsers() || []).filter(u => u.active && u.role === 'livreur');
            const livreurPerf = livreurs.map(l => {
                const deliveries = (CORE.getVisibleDeliveries() || []).filter(d => d.livreurId === l.id && new Date(d.completedAt || d.createdAt) >= thirtyDaysAgo);
                const completed = deliveries.filter(d => d.status === 'livree').length;
                const failed = deliveries.filter(d => ['failed', 'returned'].includes(d.status)).length;
                const successRate = deliveries.length > 0 ? Math.round((completed / deliveries.length) * 100) : 0;
                return { ...l, deliveries: deliveries.length, completed, failed, successRate };
            }).sort((a, b) => b.completed - a.completed);

            return { vendeurs: vendeurPerf.slice(0, 5), livreurs: livreurPerf.slice(0, 5) };
        },

        getCategoryBreakdown() {
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            const posId = CORE.state.currentUser?.pos || 1;

            const orders = (CORE.getVisibleOrders() || []).filter(o =>
                o.posId === posId &&
                new Date(o.createdAt) >= thirtyDaysAgo &&
                o.status === 'delivered'
            );

            const catMap = {};
            orders.forEach(o => {
                (o.items || []).forEach(item => {
                    const product = (CORE.getVisibleProducts() || []).find(p => p.id === item.productId);
                    const catId = product?.categoryId || 0;
                    const cat = (CORE.db.categories || []).find(c => c.id === catId);
                    const catName = cat?.name || 'Autre';

                    if (!catMap[catName]) catMap[catName] = { qty: 0, revenue: 0 };
                    catMap[catName].qty += item.qty || 0;
                    catMap[catName].revenue += (item.qty || 0) * (item.price || 0);
                });
            });

            return Object.entries(catMap)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => b.revenue - a.revenue);
        },

        renderAnalyticsDashboard() {
            const kpis = this.getKPIs();
            const weekly = this.getWeeklyComparison();
            const trends7 = this.getDailyTrends(7);
            const trends30 = this.getDailyTrends(30);
            const hourly = this.getHourlyDistribution();
            const performers = this.getTopPerformers();
            const categories = this.getCategoryBreakdown();

            // Top produits (30 derniers jours)
            const days = 30;
            const today = new Date();
            const past = new Date(today.getFullYear(), today.getMonth(), today.getDate() - days);
            const visibleOrders = CORE.getVisibleOrders() || [];
            const visibleProducts = CORE.getVisibleProducts() || [];
            const recentDelivered = visibleOrders.filter(o => o.status === 'delivered' && new Date(o.createdAt) >= past);
            const prodMap = {};
            recentDelivered.forEach(o => {
                const items = o.items || [];
                items.forEach(it => {
                    const name = it.name || 'Produit';
                    prodMap[name] = prodMap[name] || { qty: 0, revenue: 0 };
                    prodMap[name].qty += (it.qty || 0);
                    prodMap[name].revenue += (it.qty || 0) * (it.price || 0);
                });
            });
            const topProducts = Object.entries(prodMap).map(([name, v]) => ({ name, qty: v.qty, revenue: v.revenue })).sort((a,b)=>b.revenue - a.revenue).slice(0,5);

            const lowStock = visibleProducts.filter(p => p.stock <= p.minStock).slice(0,5);

            // Sparkline avec zone remplie pour revenue 7j
            const rev7 = trends7.map(t => t.revenue);
            const maxRev7 = Math.max(...rev7, 1);
            const points7 = rev7.map((v,i)=>`${i*(100/(rev7.length-1))},${100 - Math.round((v/maxRev7)*100)}`).join(' ');
            const areaPoints7 = `0,100 ${points7} 100,100`;

            // Orders sparkline
            const ord7 = trends7.map(t => t.orders);
            const maxOrd7 = Math.max(...ord7,1);
            const pointsOrd7 = ord7.map((v,i)=>`${i*(100/(ord7.length-1))},${100 - Math.round((v/maxOrd7)*100)}`).join(' ');
            const areaPointsOrd7 = `0,100 ${pointsOrd7} 100,100`;

            // Barres horaires
            const maxHourly = Math.max(...hourly, 1);
            const peakHour = hourly.indexOf(maxHourly);

            // Couleurs catégories
            const catColors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];

            // Objectif mensuel (exemple basé sur moyenne)
            const avgDailyRev = kpis.revenue / 30;
            const monthlyTarget = avgDailyRev * 30 * 1.1; // +10% objectif
            const progressPercent = Math.min(100, Math.round((kpis.revenue / monthlyTarget) * 100));

            return `
                <div class="max-w-7xl mx-auto space-y-6 fade-in p-6">
                    <!-- Header -->
                    <header class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">📊 Tableau de Bord Analytique</h2>
                            <p class="text-slate-500 font-medium">Analyse approfondie des performances • ${new Date().toLocaleDateString('fr-FR')}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <select onchange="ManagerModule.analyticsPeriod = this.value; App.rerender();" class="px-4 py-2 border border-slate-200 rounded-xl font-bold text-sm bg-white">
                                <option value="7">7 derniers jours</option>
                                <option value="30" selected>30 derniers jours</option>
                                <option value="90">90 derniers jours</option>
                            </select>
                            <button onclick="App.rerender()" class="px-4 py-2 bg-slate-900 text-white font-bold rounded-xl hover:bg-slate-800">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </header>

                    <!-- Objectif Mensuel -->
                    <div class="bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-2xl p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <div class="text-white/80 font-bold text-sm">🎯 Objectif Mensuel</div>
                                <div class="text-3xl font-black">${CORE.formatPrice(kpis.revenue)} <span class="text-lg text-white/70">/ ${CORE.formatPrice(monthlyTarget)}</span></div>
                            </div>
                            <div class="text-right">
                                <div class="text-5xl font-black">${progressPercent}%</div>
                                <div class="text-white/70 text-sm">${progressPercent >= 100 ? '🎉 Objectif atteint!' : progressPercent >= 80 ? '🔥 Presque!' : 'En progression'}</div>
                            </div>
                        </div>
                        <div class="w-full h-4 bg-white/20 rounded-full overflow-hidden">
                            <div class="h-full bg-white rounded-full transition-all duration-1000" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>

                    <!-- KPIs Principaux -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm hover:shadow-md transition">
                            <div class="flex items-center justify-between">
                                <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="trending-up" class="w-6 h-6 text-emerald-600"></i>
                                </div>
                                <span class="px-2 py-1 text-xs font-bold rounded-lg ${weekly.revenueChange >= 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
                                    ${weekly.revenueChange >= 0 ? '↑' : '↓'} ${Math.abs(weekly.revenueChange)}%
                                </span>
                            </div>
                            <div class="mt-3">
                                <div class="text-2xl font-black text-slate-900">${CORE.formatPrice(kpis.revenue)}</div>
                                <div class="text-xs font-bold text-slate-500 uppercase">Chiffre d'affaires</div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm hover:shadow-md transition">
                            <div class="flex items-center justify-between">
                                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="shopping-cart" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <span class="px-2 py-1 text-xs font-bold rounded-lg ${weekly.ordersChange >= 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
                                    ${weekly.ordersChange >= 0 ? '↑' : '↓'} ${Math.abs(weekly.ordersChange)}%
                                </span>
                            </div>
                            <div class="mt-3">
                                <div class="text-2xl font-black text-slate-900">${kpis.totalOrders}</div>
                                <div class="text-xs font-bold text-slate-500 uppercase">Commandes</div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm hover:shadow-md transition">
                            <div class="flex items-center justify-between">
                                <div class="w-12 h-12 bg-amber-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="receipt" class="w-6 h-6 text-amber-600"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="text-2xl font-black text-slate-900">${CORE.formatPrice(kpis.avgBasket)}</div>
                                <div class="text-xs font-bold text-slate-500 uppercase">Panier moyen</div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm hover:shadow-md transition">
                            <div class="flex items-center justify-between">
                                <div class="w-12 h-12 bg-violet-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="percent" class="w-6 h-6 text-violet-600"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="text-2xl font-black text-slate-900">${kpis.conversionRate}%</div>
                                <div class="text-xs font-bold text-slate-500 uppercase">Taux conversion</div>
                            </div>
                        </div>
                    </div>

                    <!-- Graphiques principaux -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Graphique Revenu 7j -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <div class="font-black text-slate-900">💰 Évolution du revenu</div>
                                    <div class="text-xs text-slate-500">7 derniers jours</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xl font-black text-emerald-600">${CORE.formatPrice(rev7.reduce((a,b)=>a+b,0))}</div>
                                    <div class="text-xs text-slate-400">Total période</div>
                                </div>
                            </div>
                            <div class="relative">
                                <svg viewBox="0 0 100 60" class="w-full h-32">
                                    <defs>
                                        <linearGradient id="revGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style="stop-color:#10b981;stop-opacity:0.3"/>
                                            <stop offset="100%" style="stop-color:#10b981;stop-opacity:0"/>
                                        </linearGradient>
                                    </defs>
                                    <polygon fill="url(#revGradient)" points="${areaPoints7.split(' ').map(p => { const [x,y] = p.split(','); return `${x},${Math.min(60, y * 0.6)}`; }).join(' ')}"/>
                                    <polyline fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" points="${points7.split(' ').map(p => { const [x,y] = p.split(','); return `${x},${y * 0.6}`; }).join(' ')}"/>
                                    ${rev7.map((v, i) => `<circle cx="${i*(100/(rev7.length-1))}" cy="${(100 - Math.round((v/maxRev7)*100)) * 0.6}" r="3" fill="#10b981"/>`).join('')}
                                </svg>
                                <div class="flex justify-between text-[10px] text-slate-400 mt-2">
                                    ${trends7.map(t => `<span>${t.date.split(' ')[0]}</span>`).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Graphique Commandes 7j -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <div class="font-black text-slate-900">📦 Volume de commandes</div>
                                    <div class="text-xs text-slate-500">7 derniers jours</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xl font-black text-blue-600">${ord7.reduce((a,b)=>a+b,0)}</div>
                                    <div class="text-xs text-slate-400">Total commandes</div>
                                </div>
                            </div>
                            <div class="relative">
                                <svg viewBox="0 0 100 60" class="w-full h-32">
                                    <defs>
                                        <linearGradient id="ordGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                            <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.3"/>
                                            <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0"/>
                                        </linearGradient>
                                    </defs>
                                    <polygon fill="url(#ordGradient)" points="${areaPointsOrd7.split(' ').map(p => { const [x,y] = p.split(','); return `${x},${Math.min(60, y * 0.6)}`; }).join(' ')}"/>
                                    <polyline fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" points="${pointsOrd7.split(' ').map(p => { const [x,y] = p.split(','); return `${x},${y * 0.6}`; }).join(' ')}"/>
                                    ${ord7.map((v, i) => `<circle cx="${i*(100/(ord7.length-1))}" cy="${(100 - Math.round((v/maxOrd7)*100)) * 0.6}" r="3" fill="#3b82f6"/>`).join('')}
                                </svg>
                                <div class="flex justify-between text-[10px] text-slate-400 mt-2">
                                    ${trends7.map(t => `<span>${t.date.split(' ')[0]}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Distribution horaire + Catégories -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Heures de pointe -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <div class="font-black text-slate-900">⏰ Heures de pointe</div>
                                    <div class="text-xs text-slate-500">Distribution des ventes par heure</div>
                                </div>
                                <div class="px-3 py-1 bg-amber-100 text-amber-700 rounded-lg text-xs font-bold">
                                    Peak: ${peakHour}h00
                                </div>
                            </div>
                            <div class="flex items-end gap-1 h-24">
                                ${hourly.slice(6, 22).map((count, i) => {
                                    const hour = i + 6;
                                    const height = maxHourly > 0 ? (count / maxHourly) * 100 : 0;
                                    const isPeak = hour === peakHour;
                                    return `
                                        <div class="flex-1 flex flex-col items-center gap-1">
                                            <div class="w-full ${isPeak ? 'bg-amber-500' : 'bg-slate-200'} rounded-t transition-all hover:bg-amber-400" style="height: ${Math.max(4, height)}%" title="${hour}h: ${count} commandes"></div>
                                            <span class="text-[8px] text-slate-400">${hour}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Répartition par catégorie -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <div class="font-black text-slate-900">📊 Ventes par catégorie</div>
                                    <div class="text-xs text-slate-500">Top catégories (30j)</div>
                                </div>
                            </div>
                            <div class="space-y-3">
                                ${categories.slice(0, 5).map((cat, i) => {
                                    const maxCatRev = categories[0]?.revenue || 1;
                                    const width = Math.round((cat.revenue / maxCatRev) * 100);
                                    return `
                                        <div>
                                            <div class="flex items-center justify-between text-sm mb-1">
                                                <span class="font-bold text-slate-700">${cat.name}</span>
                                                <span class="font-black text-slate-900">${CORE.formatPrice(cat.revenue)}</span>
                                            </div>
                                            <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                                                <div class="h-full rounded-full" style="width: ${width}%; background: ${catColors[i % catColors.length]}"></div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                                ${categories.length === 0 ? '<div class="text-center text-slate-400 py-4">Aucune donnée</div>' : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Performance Équipe -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Top Vendeurs -->
                        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-4 bg-gradient-to-r from-emerald-500 to-teal-600 text-white">
                                <div class="font-black">🏆 Top Vendeurs</div>
                                <div class="text-xs text-emerald-100">Classement par chiffre d'affaires (30j)</div>
                            </div>
                            <div class="p-4 space-y-3">
                                ${performers.vendeurs.length === 0 ? '<div class="text-center text-slate-400 py-4">Aucun vendeur</div>' : performers.vendeurs.map((v, i) => `
                                    <div class="flex items-center gap-3 p-3 ${i === 0 ? 'bg-amber-50 border border-amber-200' : 'bg-slate-50'} rounded-xl">
                                        <div class="w-8 h-8 rounded-full ${i === 0 ? 'bg-amber-500' : i === 1 ? 'bg-slate-400' : i === 2 ? 'bg-amber-700' : 'bg-slate-300'} flex items-center justify-center text-white font-black text-sm">
                                            ${i < 3 ? ['🥇','🥈','🥉'][i] : i + 1}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-slate-900 truncate">${v.name}</div>
                                            <div class="text-xs text-slate-500">${v.orders} commandes</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-emerald-600">${CORE.formatPrice(v.revenue)}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Top Livreurs -->
                        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
                                <div class="font-black">🚴 Top Livreurs</div>
                                <div class="text-xs text-blue-100">Classement par livraisons réussies (30j)</div>
                            </div>
                            <div class="p-4 space-y-3">
                                ${performers.livreurs.length === 0 ? '<div class="text-center text-slate-400 py-4">Aucun livreur</div>' : performers.livreurs.map((l, i) => `
                                    <div class="flex items-center gap-3 p-3 ${i === 0 ? 'bg-blue-50 border border-blue-200' : 'bg-slate-50'} rounded-xl">
                                        <div class="w-8 h-8 rounded-full ${i === 0 ? 'bg-blue-500' : i === 1 ? 'bg-slate-400' : i === 2 ? 'bg-blue-700' : 'bg-slate-300'} flex items-center justify-center text-white font-black text-sm">
                                            ${i < 3 ? ['🥇','🥈','🥉'][i] : i + 1}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-slate-900 truncate">${l.name}</div>
                                            <div class="text-xs text-slate-500">${l.deliveries} livraisons</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-blue-600">${l.completed}</div>
                                            <div class="text-xs ${l.successRate >= 90 ? 'text-emerald-500' : l.successRate >= 70 ? 'text-amber-500' : 'text-red-500'}">${l.successRate}% réussite</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Top produits + Stock bas -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div class="font-black text-slate-900">🔥 Top produits (30j)</div>
                                <div class="text-xs text-slate-400">Par revenu généré</div>
                            </div>
                            <div class="space-y-3">
                                ${topProducts.length === 0 ? '<div class="text-center text-slate-400 py-4">Aucune vente</div>' : topProducts.map((p, i) => `
                                    <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl">
                                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center text-white font-black text-sm">${i + 1}</div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-slate-900 truncate">${p.name}</div>
                                            <div class="text-xs text-slate-500">${p.qty} vendus</div>
                                        </div>
                                        <div class="font-black text-slate-900">${CORE.formatPrice(p.revenue)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                            <div class="flex items-center justify-between mb-4">
                                <div class="font-black text-slate-900">⚠️ Alertes stock</div>
                                <div class="px-2 py-1 bg-red-100 text-red-700 rounded-lg text-xs font-bold">${lowStock.length} produits</div>
                            </div>
                            <div class="space-y-3">
                                ${lowStock.length === 0 ? '<div class="text-center text-emerald-500 py-4">✅ Tous les stocks sont OK!</div>' : lowStock.map(p => `
                                    <div class="flex items-center justify-between p-3 bg-red-50 border border-red-200 rounded-xl">
                                        <div>
                                            <div class="font-bold text-red-900">${p.name}</div>
                                            <div class="text-xs text-red-600">Min: ${p.minStock}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-2xl font-black ${p.stock <= 0 ? 'text-red-600' : 'text-amber-600'}">${p.stock}</div>
                                            <div class="text-[10px] text-red-500">${p.stock <= 0 ? 'RUPTURE' : 'Faible'}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Comparaison semaine -->
                    <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl p-6 text-white">
                        <div class="font-black text-lg mb-4">📈 Comparaison Hebdomadaire</div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-white/10 rounded-xl p-4">
                                <div class="text-white/70 text-xs font-bold">Revenu cette semaine</div>
                                <div class="text-2xl font-black mt-1">${CORE.formatPrice(weekly.currentRevenue)}</div>
                            </div>
                            <div class="bg-white/10 rounded-xl p-4">
                                <div class="text-white/70 text-xs font-bold">Semaine précédente</div>
                                <div class="text-2xl font-black mt-1">${CORE.formatPrice(weekly.previousRevenue)}</div>
                            </div>
                            <div class="bg-white/10 rounded-xl p-4">
                                <div class="text-white/70 text-xs font-bold">Évolution revenu</div>
                                <div class="text-2xl font-black mt-1 ${weekly.revenueChange >= 0 ? 'text-emerald-400' : 'text-red-400'}">${weekly.revenueChange >= 0 ? '+' : ''}${weekly.revenueChange}%</div>
                            </div>
                            <div class="bg-white/10 rounded-xl p-4">
                                <div class="text-white/70 text-xs font-bold">Évolution commandes</div>
                                <div class="text-2xl font-black mt-1 ${weekly.ordersChange >= 0 ? 'text-emerald-400' : 'text-red-400'}">${weekly.ordersChange >= 0 ? '+' : ''}${weekly.ordersChange}%</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },


        renderDashboard() {
            // Dashboard MULTI-POS pour Manager
            const allPos = CORE.db.pointsOfSale || [];
            const selectedPosId = CORE.state.currentUser?.pos || null;

            const visibleOrders = CORE.getVisibleOrders() || [];
            const visibleProducts = CORE.getVisibleProducts() || [];
            const visibleUsers = CORE.getVisibleUsers() || [];
            const visibleDeliveries = CORE.getVisibleDeliveries() || [];

            // Calculer métriques pour CHAQUE POS
            const posMetrics = allPos.map(pos => {
                const orders = visibleOrders.filter(o => o.posId === pos.id);
                const deliveredOrders = orders.filter(o => o.status === 'delivered');
                const revenue = deliveredOrders.reduce((a,o)=>a+(o.total||0),0);
                const products = visibleProducts.filter(p => p.posId === pos.id);
                const lowStock = products.filter(p => p.stock <= p.minStock).length;
                const staff = visibleUsers.filter(u => u.pos === pos.id && u.active);

                return {
                    pos,
                    orders: orders.length,
                    revenue,
                    lowStock,
                    staff: staff.length,
                    gestionnaire: staff.find(u => u.role === 'gestionnaire'),
                    vendeur: staff.find(u => u.role === 'vendeur'),
                    livreur: staff.find(u => u.role === 'livreur')
                };
            });

            // Totaux consolidés
            const totalRevenue = posMetrics.reduce((a,m)=>a+m.revenue,0);
            const totalOrders = posMetrics.reduce((a,m)=>a+m.orders,0);
            const totalLowStock = posMetrics.reduce((a,m)=>a+m.lowStock,0);
            const avgBasket = totalOrders > 0 ? (totalRevenue / totalOrders) : 0;

            // Statistiques supplémentaires
            const totalProducts = visibleProducts.filter(p => !p.isMainWarehouse).length;
            const deliveriesInProgress = visibleDeliveries.filter(d => d.status === 'en_cours').length || 0;
            const deliveriesToAssign = visibleDeliveries.filter(d => d.status === 'en_attente').length || 0;
            const pendingOrders = visibleOrders.filter(o => ['pending','confirmed'].includes(o.status)).length;

            // Répartition des commandes par statut
            const ordersByStatus = {
                delivered: visibleOrders.filter(o => o.status === 'delivered').length,
                pending: visibleOrders.filter(o => o.status === 'pending').length,
                confirmed: visibleOrders.filter(o => o.status === 'confirmed').length,
                delivering: visibleOrders.filter(o => o.status === 'delivering').length,
                cancelled: visibleOrders.filter(o => o.status === 'cancelled').length
            };
            const totalOrdersForChart = Object.values(ordersByStatus).reduce((a,b)=>a+b,0) || 1;

            // Tendances 7 derniers jours
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().slice(0, 10);
                const dayOrders = visibleOrders.filter(o => o.createdAt?.slice(0, 10) === dateStr && o.status === 'delivered');
                const dayRevenue = dayOrders.reduce((a, o) => a + (o.total || 0), 0);
                last7Days.push({ day: date.toLocaleDateString('fr-FR', { weekday: 'short' }).slice(0, 3), date: dateStr, revenue: dayRevenue, count: dayOrders.length });
            }
            const maxDayRevenue = Math.max(...last7Days.map(d => d.revenue), 1);

            // Alertes critiques
            const criticalAlerts = [];
            if (totalLowStock > 0) criticalAlerts.push({ color: 'red', icon: 'alert-triangle', msg: `${totalLowStock} produit(s) en stock critique`, action: "ManagerModule.navigateTo('inventory')" });
            if (pendingOrders > 5) criticalAlerts.push({ color: 'amber', icon: 'clock', msg: `${pendingOrders} commandes en attente`, action: "ManagerModule.navigateTo('orders')" });
            if (deliveriesToAssign > 0) criticalAlerts.push({ color: 'blue', icon: 'user-plus', msg: `${deliveriesToAssign} livraison(s) à assigner`, action: "ManagerModule.navigateTo('deliveries')" });

            // Top 3 POS par CA
            const topPOS = [...posMetrics].sort((a,b) => b.revenue - a.revenue).slice(0, 3);

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <!-- Header avec date et actions -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                                    <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                                </div>
                                Tableau de Bord Manager
                            </h2>
                            <p class="text-slate-500 font-medium mt-2 flex items-center gap-2">
                                <i data-lucide="calendar" class="w-4 h-4"></i>
                                ${new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                <span class="text-slate-300">•</span>
                                <span class="text-indigo-600 font-bold">${allPos.length} points de vente</span>
                            </p>
                        </div>
                        <div class="flex flex-wrap items-center gap-2">
                            <button onclick="App.rerender()" class="px-4 py-2.5 bg-white border border-slate-200 text-slate-700 font-bold rounded-xl hover:bg-slate-50 transition flex items-center gap-2 shadow-sm">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Actualiser
                            </button>
                            <button onclick="ManagerModule.navigateTo('mainStock')" class="px-4 py-2.5 bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-black rounded-xl hover:from-purple-600 hover:to-indigo-700 transition flex items-center gap-2 shadow-lg shadow-purple-500/30">
                                <i data-lucide="warehouse" class="w-4 h-4"></i> Dépôt Principal
                            </button>
                        </div>
                    </div>

                    <!-- Alertes critiques -->
                    ${criticalAlerts.length > 0 ? `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            ${criticalAlerts.map(alert => `
                                <button onclick="${alert.action}" class="p-4 rounded-2xl border-2 border-${alert.color}-300 bg-gradient-to-br from-${alert.color}-50 to-${alert.color}-100 flex items-center gap-3 hover:shadow-lg transition-all hover:scale-[1.02] text-left w-full group">
                                    <div class="w-12 h-12 bg-${alert.color}-200 rounded-xl flex items-center justify-center flex-shrink-0 shadow-sm group-hover:scale-110 transition">
                                        <i data-lucide="${alert.icon}" class="w-6 h-6 text-${alert.color}-700"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-black text-${alert.color}-900 text-sm">${alert.msg}</div>
                                        <div class="text-xs text-${alert.color}-700 flex items-center gap-1 mt-0.5">
                                            <i data-lucide="arrow-right" class="w-3 h-3"></i> Cliquer pour gérer
                                        </div>
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- KPIs Principaux avec gradients -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-5 text-white shadow-lg shadow-emerald-500/30 relative overflow-hidden group hover:scale-[1.02] transition cursor-pointer" onclick="ManagerModule.navigateTo('orders')">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8 group-hover:scale-125 transition"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-up" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">CA Total</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(totalRevenue)}</div>
                                <div class="text-xs opacity-70 mt-2">Panier moyen: ${CORE.formatPrice(Math.round(avgBasket))}</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-5 text-white shadow-lg shadow-blue-500/30 relative overflow-hidden group hover:scale-[1.02] transition cursor-pointer" onclick="ManagerModule.navigateTo('orders')">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8 group-hover:scale-125 transition"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="shopping-cart" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Commandes</span>
                                </div>
                                <div class="text-3xl font-black">${totalOrders}</div>
                                <div class="text-xs opacity-70 mt-2">${ordersByStatus.delivered} livrées • ${pendingOrders} en cours</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-violet-600 rounded-2xl p-5 text-white shadow-lg shadow-purple-500/30 relative overflow-hidden group hover:scale-[1.02] transition cursor-pointer" onclick="ManagerModule.navigateTo('inventory')">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8 group-hover:scale-125 transition"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="package" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Produits</span>
                                </div>
                                <div class="text-3xl font-black">${totalProducts}</div>
                                <div class="text-xs opacity-70 mt-2">${allPos.length} points de vente</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br ${totalLowStock > 0 ? 'from-red-500 to-red-600 shadow-red-500/30' : 'from-slate-500 to-slate-600 shadow-slate-500/30'} rounded-2xl p-5 text-white shadow-lg relative overflow-hidden group hover:scale-[1.02] transition cursor-pointer" onclick="ManagerModule.navigateTo('inventory')">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8 group-hover:scale-125 transition"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="alert-triangle" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Alertes Stock</span>
                                </div>
                                <div class="text-3xl font-black">${totalLowStock}</div>
                                <div class="text-xs opacity-70 mt-2">${totalLowStock > 0 ? 'Produits critiques!' : 'Tout est OK'}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions Rapides et Tendances -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Actions Rapides -->
                        <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-5 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white">
                                <h3 class="font-black text-slate-900 flex items-center gap-2">
                                    <i data-lucide="zap" class="w-5 h-5 text-amber-500"></i>
                                    Actions Rapides
                                </h3>
                            </div>
                            <div class="p-4 space-y-2">
                                <button onclick="ManagerModule.navigateTo('inventory')" class="w-full p-4 rounded-2xl bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-100 hover:border-purple-300 transition flex items-center gap-3 group">
                                    <div class="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center text-white shadow-sm group-hover:scale-110 transition">
                                        <i data-lucide="package" class="w-5 h-5"></i>
                                    </div>
                                    <div class="flex-1 text-left">
                                        <div class="font-black text-purple-900">Inventaire POS</div>
                                        <div class="text-xs text-purple-600">Gérer les stocks par point de vente</div>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-5 h-5 text-purple-400 group-hover:translate-x-1 transition"></i>
                                </button>
                                <button onclick="ManagerModule.navigateTo('mainStock')" class="w-full p-4 rounded-2xl bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-100 hover:border-amber-300 transition flex items-center gap-3 group">
                                    <div class="w-10 h-10 bg-amber-500 rounded-xl flex items-center justify-center text-white shadow-sm group-hover:scale-110 transition">
                                        <i data-lucide="warehouse" class="w-5 h-5"></i>
                                    </div>
                                    <div class="flex-1 text-left">
                                        <div class="font-black text-amber-900">Dépôt Principal</div>
                                        <div class="text-xs text-amber-600">Stock central et transferts</div>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-5 h-5 text-amber-400 group-hover:translate-x-1 transition"></i>
                                </button>
                                <button onclick="ManagerModule.navigateTo('orders')" class="w-full p-4 rounded-2xl bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 hover:border-blue-300 transition flex items-center gap-3 group">
                                    <div class="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center text-white shadow-sm group-hover:scale-110 transition">
                                        <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                                    </div>
                                    <div class="flex-1 text-left">
                                        <div class="font-black text-blue-900">Commandes</div>
                                        <div class="text-xs text-blue-600">${pendingOrders} en attente de traitement</div>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-5 h-5 text-blue-400 group-hover:translate-x-1 transition"></i>
                                </button>
                                <button onclick="ManagerModule.navigateTo('deliveries')" class="w-full p-4 rounded-2xl bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-100 hover:border-emerald-300 transition flex items-center gap-3 group">
                                    <div class="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center text-white shadow-sm group-hover:scale-110 transition">
                                        <i data-lucide="truck" class="w-5 h-5"></i>
                                    </div>
                                    <div class="flex-1 text-left">
                                        <div class="font-black text-emerald-900">Livraisons</div>
                                        <div class="text-xs text-emerald-600">${deliveriesInProgress} en cours • ${deliveriesToAssign} à assigner</div>
                                    </div>
                                    <i data-lucide="chevron-right" class="w-5 h-5 text-emerald-400 group-hover:translate-x-1 transition"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Tendances CA 7 jours -->
                        <div class="lg:col-span-2 bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-gradient-to-r from-slate-50 to-white">
                                <div>
                                    <h3 class="font-black text-slate-900 flex items-center gap-2">
                                        <i data-lucide="bar-chart-3" class="w-5 h-5 text-indigo-500"></i>
                                        Tendance CA (7 jours)
                                    </h3>
                                    <div class="text-xs text-slate-500 mt-0.5">Évolution du chiffre d'affaires quotidien</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-black text-slate-900">${CORE.formatPrice(last7Days.reduce((a,d) => a + d.revenue, 0))}</div>
                                    <div class="text-xs text-slate-500">Total 7 jours</div>
                                </div>
                            </div>
                            <div class="p-5 space-y-3">
                                ${last7Days.map((d, i) => {
                                    const percent = (d.revenue / maxDayRevenue) * 100;
                                    const isToday = i === last7Days.length - 1;
                                    return `
                                        <div class="flex items-center gap-3 ${isToday ? 'bg-indigo-50 -mx-2 px-2 py-2 rounded-xl' : ''}">
                                            <span class="text-xs font-black ${isToday ? 'text-indigo-700' : 'text-slate-600'} w-12 uppercase">${d.day}</span>
                                            <div class="flex-1 h-8 bg-slate-100 rounded-lg overflow-hidden relative">
                                                <div class="absolute inset-y-0 left-0 ${isToday ? 'bg-gradient-to-r from-indigo-500 to-purple-500' : 'bg-gradient-to-r from-slate-400 to-slate-500'} rounded-lg transition-all" style="width: ${percent}%"></div>
                                                <div class="absolute inset-0 flex items-center ${percent > 30 ? 'justify-start pl-3' : 'justify-end pr-3'}">
                                                    <span class="text-xs font-black ${percent > 50 ? 'text-white' : 'text-slate-600'}">${d.count} cmd</span>
                                                </div>
                                            </div>
                                            <span class="text-sm font-black ${isToday ? 'text-indigo-700' : 'text-slate-900'} w-28 text-right">${CORE.formatPrice(d.revenue)}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Graphique répartition + Top POS -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Répartition des commandes -->
                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-5 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white">
                                <h3 class="font-black text-slate-900 flex items-center gap-2">
                                    <i data-lucide="pie-chart" class="w-5 h-5 text-violet-500"></i>
                                    Répartition Commandes
                                </h3>
                            </div>
                            <div class="p-5">
                                <!-- Donut Chart -->
                                <div class="relative w-36 h-36 mx-auto mb-5">
                                    <svg viewBox="0 0 100 100" class="transform -rotate-90">
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#f1f5f9" stroke-width="12"/>
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#10b981" stroke-width="12"
                                            stroke-dasharray="${(ordersByStatus.delivered / totalOrdersForChart) * 251.2} 251.2" stroke-linecap="round"/>
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#f59e0b" stroke-width="12"
                                            stroke-dasharray="${(ordersByStatus.pending / totalOrdersForChart) * 251.2} 251.2"
                                            stroke-dashoffset="${-(ordersByStatus.delivered / totalOrdersForChart) * 251.2}" stroke-linecap="round"/>
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#6366f1" stroke-width="12"
                                            stroke-dasharray="${(ordersByStatus.confirmed / totalOrdersForChart) * 251.2} 251.2"
                                            stroke-dashoffset="${-((ordersByStatus.delivered + ordersByStatus.pending) / totalOrdersForChart) * 251.2}" stroke-linecap="round"/>
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#ef4444" stroke-width="12"
                                            stroke-dasharray="${(ordersByStatus.cancelled / totalOrdersForChart) * 251.2} 251.2"
                                            stroke-dashoffset="${-((ordersByStatus.delivered + ordersByStatus.pending + ordersByStatus.confirmed) / totalOrdersForChart) * 251.2}" stroke-linecap="round"/>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center flex-col">
                                        <div class="text-2xl font-black text-slate-900">${totalOrders}</div>
                                        <div class="text-xs text-slate-500">Total</div>
                                    </div>
                                </div>
                                <div class="space-y-1.5 text-sm">
                                    <div class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50">
                                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-emerald-500"></div><span class="text-slate-700">Livrées</span></div>
                                        <span class="font-black text-slate-900">${ordersByStatus.delivered}</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50">
                                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-amber-500"></div><span class="text-slate-700">En attente</span></div>
                                        <span class="font-black text-slate-900">${ordersByStatus.pending}</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50">
                                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-indigo-500"></div><span class="text-slate-700">Confirmées</span></div>
                                        <span class="font-black text-slate-900">${ordersByStatus.confirmed}</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50">
                                        <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-red-500"></div><span class="text-slate-700">Annulées</span></div>
                                        <span class="font-black text-slate-900">${ordersByStatus.cancelled}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Top 3 POS -->
                        <div class="lg:col-span-2 bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-gradient-to-r from-slate-50 to-white">
                                <h3 class="font-black text-slate-900 flex items-center gap-2">
                                    <i data-lucide="trophy" class="w-5 h-5 text-amber-500"></i>
                                    Top Points de Vente
                                </h3>
                                <div class="text-xs text-slate-500">${allPos.length} POS au total</div>
                            </div>
                            <div class="p-4 space-y-3">
                                ${topPOS.length === 0 ? `<div class="p-8 text-center text-slate-400">Aucun POS configuré</div>` : ''}
                                ${topPOS.map((m, i) => {
                                    const medals = ['🥇', '🥈', '🥉'];
                                    const bgColors = ['bg-gradient-to-r from-amber-50 to-yellow-50 border-amber-200', 'bg-gradient-to-r from-slate-50 to-gray-50 border-slate-200', 'bg-gradient-to-r from-orange-50 to-amber-50 border-orange-200'];
                                    return `
                                        <div class="p-4 rounded-2xl border ${bgColors[i]} flex items-center gap-4 hover:shadow-md transition group">
                                            <div class="text-3xl">${medals[i]}</div>
                                            <div class="flex-1">
                                                <div class="font-black text-slate-900 text-lg">${m.pos.name}</div>
                                                <div class="text-sm text-slate-500">${CORE.getCity(m.pos.cityId)?.name || 'N/A'} • ${m.orders} commandes • ${m.staff} staff</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-black text-xl text-emerald-600">${CORE.formatPrice(m.revenue)}</div>
                                                <div class="text-xs text-slate-500">${m.lowStock > 0 ? `<span class="text-red-600 font-bold">${m.lowStock} alertes</span>` : 'Stock OK'}</div>
                                            </div>
                                            <button onclick="ManagerModule.showPosDetailsModal(${m.pos.id})" class="p-2 rounded-xl bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-slate-900 transition opacity-0 group-hover:opacity-100">
                                                <i data-lucide="external-link" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Cartes POS Comparatives -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-black text-slate-900 flex items-center gap-2">
                                <i data-lucide="store" class="w-5 h-5 text-indigo-500"></i>
                                Tous les Points de Vente
                            </h3>
                            <div class="text-sm text-slate-500">${allPos.length} locations actives</div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                            ${posMetrics.map((m, idx) => {
                                return `
                                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm hover:shadow-lg transition group">
                                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-4 text-white">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <h4 class="text-lg font-black">${m.pos.name}</h4>
                                                    <div class="text-xs text-indigo-200">${CORE.getCity(m.pos.cityId)?.name || 'N/A'}</div>
                                                </div>
                                                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                                                    <i data-lucide="store" class="w-5 h-5"></i>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="p-4 space-y-4">
                                            <!-- Stats -->
                                            <div class="grid grid-cols-3 gap-2">
                                                <div class="p-2.5 rounded-xl bg-emerald-50 text-center">
                                                    <div class="text-lg font-black text-emerald-600">${m.revenue > 0 ? (m.revenue/1000).toFixed(0) : '0'}K</div>
                                                    <div class="text-[10px] font-bold text-emerald-700 uppercase">CA</div>
                                                </div>
                                                <div class="p-2.5 rounded-xl bg-blue-50 text-center">
                                                    <div class="text-lg font-black text-blue-600">${m.orders}</div>
                                                    <div class="text-[10px] font-bold text-blue-700 uppercase">Cmd</div>
                                                </div>
                                                <div class="p-2.5 rounded-xl ${m.lowStock > 0 ? 'bg-red-50' : 'bg-slate-50'} text-center">
                                                    <div class="text-lg font-black ${m.lowStock > 0 ? 'text-red-600' : 'text-slate-600'}">${m.lowStock}</div>
                                                    <div class="text-[10px] font-bold ${m.lowStock > 0 ? 'text-red-700' : 'text-slate-600'} uppercase">Alertes</div>
                                                </div>
                                            </div>

                                            <!-- Team -->
                                            <div class="flex items-center justify-between text-xs">
                                                <span class="text-slate-500">Équipe:</span>
                                                <div class="flex items-center gap-2">
                                                    <span class="${m.gestionnaire ? 'text-emerald-600' : 'text-slate-400'}">${m.gestionnaire ? '✓' : 'é'} Gest.</span>
                                                    <span class="${m.vendeur ? 'text-emerald-600' : 'text-slate-400'}">${m.vendeur ? '✓' : 'é'} Vend.</span>
                                                    <span class="${m.livreur ? 'text-emerald-600' : 'text-slate-400'}">${m.livreur ? '✓' : 'é'} Livr.</span>
                                                </div>
                                            </div>

                                            <!-- Actions -->
                                            <div class="flex gap-2">
                                                <button onclick="ManagerModule.showPosDetailsModal(${m.pos.id})" class="flex-1 px-3 py-2 bg-indigo-600 text-white rounded-xl text-xs font-black hover:bg-indigo-700 transition flex items-center justify-center gap-1">
                                                    <i data-lucide="eye" class="w-3 h-3"></i> Détails
                                                </button>
                                                <button onclick="ManagerModule.showStockTransferModal(${m.pos.id})" class="flex-1 px-3 py-2 bg-purple-600 text-white rounded-xl text-xs font-black hover:bg-purple-700 transition flex items-center justify-center gap-1">
                                                    <i data-lucide="arrow-right-left" class="w-3 h-3"></i> Transfert
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Produits Critiques Tous POS -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between bg-gradient-to-r from-red-50 to-orange-50">
                            <h3 class="font-black text-red-900 flex items-center gap-2">
                                <i data-lucide="alert-triangle" class="w-5 h-5 text-red-500"></i>
                                Produits Critiques (Tous POS)
                            </h3>
                            <button onclick="ManagerModule.navigateTo('inventory')" class="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-xs font-black hover:bg-red-200 transition flex items-center gap-1">
                                Voir inventaire <i data-lucide="arrow-right" class="w-3 h-3"></i>
                            </button>
                        </div>
                        <div class="p-5">
                            ${visibleProducts.filter(p => !p.isMainWarehouse && p.stock <= p.minStock).slice(0, 8).length === 0 ?
                                `<div class="text-center py-8 text-slate-400 flex flex-col items-center gap-2">
                                    <i data-lucide="check-circle" class="w-12 h-12 text-emerald-300"></i>
                                    <span class="font-bold">Aucun produit critique</span>
                                    <span class="text-sm">Tous vos stocks sont à niveau</span>
                                </div>` :
                                `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                                    ${visibleProducts.filter(p => !p.isMainWarehouse && p.stock <= p.minStock).slice(0, 8).map(p => {
                                        const pos = CORE.getPOS(p.posId);
                                        const stockPercent = p.minStock > 0 ? Math.round((p.stock / p.minStock) * 100) : 0;
                                        const isCritical = stockPercent <= 25;
                                        return `
                                            <div class="p-4 rounded-2xl ${isCritical ? 'bg-red-50 border-2 border-red-200' : 'bg-amber-50 border border-amber-200'} group hover:shadow-md transition">
                                                <div class="flex items-start justify-between gap-2 mb-2">
                                                    <div class="font-black ${isCritical ? 'text-red-900' : 'text-amber-900'} text-sm leading-tight">${p.name}</div>
                                                    ${isCritical ? '<span class="px-1.5 py-0.5 bg-red-600 text-white text-[10px] font-black rounded">URGENT</span>' : ''}
                                                </div>
                                                <div class="text-xs ${isCritical ? 'text-red-700' : 'text-amber-700'} mb-2">${pos?.name || 'N/A'}</div>
                                                <div class="flex items-center gap-2 mb-3">
                                                    <div class="flex-1 h-2 bg-white rounded-full overflow-hidden">
                                                        <div class="h-full ${isCritical ? 'bg-red-500' : 'bg-amber-500'} rounded-full" style="width: ${stockPercent}%"></div>
                                                    </div>
                                                    <span class="text-xs font-bold ${isCritical ? 'text-red-700' : 'text-amber-700'}">${p.stock}/${p.minStock}</span>
                                                </div>
                                                <button onclick="ManagerModule.showRestockModal(${p.id})" class="w-full px-3 py-1.5 ${isCritical ? 'bg-red-600 hover:bg-red-700' : 'bg-amber-600 hover:bg-amber-700'} text-white rounded-lg text-xs font-black transition">Réapprovisionner</button>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>`
                            }
                        </div>
                    </div>
                </div>`;
        },

        // =====================
        // STOCK CONTROL CENTER (Manager)
        // =====================
        downloadCSVFallback(filename, rows) {
            const escape = (v) => {
                const s = String(v ?? '');
                if (s.includes('"') || s.includes(',') || s.includes('\n')) return `"${s.replace(/"/g,'""')}"`;
                return s;
            };
            const csv = rows.map(r => r.map(escape).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        },
        exportInventoryCSV() {
            const rows = [
                ['id','name','category','price','stock','minStock','active','barcode','value'],
                ...CORE.getProductsExcludingMain().map(p => [
                    p.id,
                    p.name,
                    CORE.getCategory(p.categoryId)?.name || '',
                    p.price,
                    p.stock,
                    p.minStock,
                    p.active ? '1' : '0',
                    p.barcode || '',
                    Number(p.price||0) * Number(p.stock||0)
                ])
            ];
            // Reuse PDG downloader (fallback safe)
            (PDGModule?.downloadCSV || this.downloadCSVFallback)(`raya_manager_inventory_${Utils.todayKey()}.csv`, rows);
        },

        exportMainStockCSV() {
            const rows = [
                ['id','name','category','price','stock','minStock','active','barcode','value'],
                ...CORE.getMainWarehouseProducts().map(p => [
                    p.id,
                    p.name,
                    CORE.getCategory(p.categoryId)?.name || '',
                    p.price,
                    p.stock || 0,
                    p.minStock,
                    p.active ? '1' : '0',
                    p.barcode || '',
                    Number(p.price||0) * Number(p.stock||0)
                ])
            ];
            (PDGModule?.downloadCSV || this.downloadCSVFallback)(`raya_depot_principal_${Utils.todayKey()}.csv`, rows);
        },

        exportRestockingRecommendations() {
            const products = CORE.getProductsExcludingMain() || [];
            const lowStockProducts = products.filter(p => p.stock <= p.minStock);

            const rows = [
                ['Produit', 'Stock Actuel', 'Stock Minimum', 'Stock Critique', '% du Minimum', 'À Commander (×2)', 'Coût Unitaire', 'Coût Total', 'Fournisseur', 'Catégorie', 'Urgence'],
                ...lowStockProducts.map(p => {
                    const stockPercent = p.minStock ? Math.round((p.stock / p.minStock) * 100) : 0;
                    const toOrder = Math.round((p.minStock || 0) * 2) - (p.stock || 0);
                    const itemCost = toOrder * (p.price || 0);
                    const isCritical = (p.stock || 0) <= (p.minStock * 0.5);
                    const supplier = CORE.db.suppliers?.find(s => s.id === p.supplierId);
                    const category = CORE.db.categories?.find(c => c.id === p.categoryId);

                    return [
                        p.name,
                        p.stock || 0,
                        p.minStock || 0,
                        Math.round((p.minStock || 0) * 0.5),
                        stockPercent + '%',
                        toOrder,
                        p.price || 0,
                        itemCost,
                        supplier?.name || 'Non spécifié',
                        category?.name || 'Non spécifiée',
                        isCritical ? 'URGENT' : 'Normal'
                    ];
                }).sort((a, b) => {
                    // Trier par urgence puis par % du minimum
                    if (a[10] === 'URGENT' && b[10] !== 'URGENT') return -1;
                    if (a[10] !== 'URGENT' && b[10] === 'URGENT') return 1;
                    return parseInt(a[4]) - parseInt(b[4]);
                })
            ];

            (PDGModule?.downloadCSV || this.downloadCSVFallback)(`raya_recommendations_reappro_${Utils.todayKey()}.csv`, rows);
            UI.toast('Recommandations exportées', 'success');
        },

        exportMovementsCSV() {
            const movs = this.getMovementsFiltered();
            const rows = [
                ['id','productId','productName','type','qty','ref','note','userName','createdAt'],
                ...movs.map(m => [m.id, m.productId, m.productName, m.type, m.qty, m.ref || '', m.note || '', m.userName || '', m.createdAt])
            ];
            (PDGModule?.downloadCSV || this.downloadCSVFallback)(`raya_manager_stock_movements_${Utils.todayKey()}.csv`, rows);
        },

        getProductsFiltered(paginate = true) {
            const q = (document.getElementById('manager-inventory-search-input')?.value || this.state.inventorySearch || '').toLowerCase().trim();
            const currentUser = CORE.state.currentUser || {};
            const forcedPosId = currentUser.role === 'gestionnaire' ? (currentUser.pos || currentUser.storeId) : null;
            const posId = forcedPosId ?? (this.state.inventoryPosId || null);
            const categoryFilter = this.state.inventoryCategoryFilter || 'all';
            const statusFilter = this.state.inventoryStatusFilter || 'all';
            const sortBy = this.state.inventorySortBy || 'name';
            const page = this.state.inventoryPage || 1;
            const perPage = this.state.inventoryPerPage || 50;

            let products = [...(CORE.getVisibleProducts() || [])];
            if (posId) {
                products = products.filter(p => this.productBelongsToPos(p, posId));
            }
            if (q) products = products.filter(p =>
                (p.name || '').toLowerCase().includes(q) ||
                String(p.barcode || '').toLowerCase().includes(q) ||
                String(p.id).includes(q)
            );
            // Category filter
            if (categoryFilter !== 'all') {
                products = products.filter(p => p.categoryId == categoryFilter);
            }
            // Status filter
            if (statusFilter !== 'all') {
                products = products.filter(p => {
                    const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                    const minStock = p.minStock || 0;
                    if (statusFilter === 'critical') return stock <= minStock * 0.5;
                    if (statusFilter === 'low') return stock <= minStock && stock > minStock * 0.5;
                    if (statusFilter === 'ok') return stock > minStock;
                    if (statusFilter === 'outofstock') return stock === 0;
                    return true;
                });
            }

            // Sort by selected criteria
            products.sort((a, b) => {
                const aStock = posId ? CORE.getProductStock(a.id, posId) : (a.stock || 0);
                const bStock = posId ? CORE.getProductStock(b.id, posId) : (b.stock || 0);
                switch (sortBy) {
                    case 'stock_asc': return aStock - bStock;
                    case 'stock_desc': return bStock - aStock;
                    case 'price_asc': return (a.price || 0) - (b.price || 0);
                    case 'price_desc': return (b.price || 0) - (a.price || 0);
                    case 'critical': return (aStock - (a.minStock || 0)) - (bStock - (b.minStock || 0));
                    case 'name_desc': return (b.name || '').localeCompare(a.name || '');
                    default: return (a.name || '').localeCompare(b.name || '');
                }
            });

            // Return all if not paginating
            if (!paginate) return products;

            // Paginate
            const totalFiltered = products.length;
            const totalPages = Math.ceil(totalFiltered / perPage);
            const currentPage = Math.min(page, totalPages || 1);
            const startIdx = (currentPage - 1) * perPage;
            return products.slice(startIdx, startIdx + perPage);
        },

        getProductsStats() {
            const currentUser = CORE.state.currentUser || {};
            const forcedPosId = currentUser.role === 'gestionnaire' ? (currentUser.pos || currentUser.storeId) : null;
            const posId = forcedPosId ?? (this.state.inventoryPosId || null);
            const page = this.state.inventoryPage || 1;
            const perPage = this.state.inventoryPerPage || 50;
            const allFiltered = this.getProductsFiltered(false);
            const totalFiltered = allFiltered.length;
            const totalPages = Math.ceil(totalFiltered / perPage);
            const currentPage = Math.min(page, totalPages || 1);
            const startIdx = (currentPage - 1) * perPage;

            // Generate pagination buttons
            const paginationPages = [];
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationPages.push(i);
                } else if (paginationPages[paginationPages.length - 1] !== '...') {
                    paginationPages.push('...');
                }
            }

            return { totalFiltered, totalPages, currentPage, startIdx, perPage, paginationPages, posId };
        },

        getMovementsFiltered() {
            const q = (document.getElementById('manager-movements-search-input')?.value || '').toLowerCase().trim();
            const t = this.state.movementsType;
            const currentUser = CORE.state.currentUser || {};
            const forcedPosId = currentUser.role === 'gestionnaire' ? (currentUser.pos || currentUser.storeId) : null;
            const posId = forcedPosId ?? (this.state.inventoryPosId || null);
            let movs = [...CORE.getVisibleStockMovements()];
            if (t !== 'all') movs = movs.filter(m => m.type === t);
            if (posId) movs = movs.filter(m => m.posId === posId);
            if (q) movs = movs.filter(m =>
                (m.productName || '').toLowerCase().includes(q) ||
                (m.ref || '').toLowerCase().includes(q) ||
                (m.userName || '').toLowerCase().includes(q)
            );
            return movs;
        },

        showNewProductModal(forcedPos = null) {
            const currentUser = CORE.state.currentUser || {};
            const categories = (CORE.db.categories || []).map(c => ({value: c.id, label: c.name}));
            const posList = (CORE.db.pointsOfSale || []).map(p => ({value: p.id, label: p.name}));
            console.log('[NewProduct] Modal opening, forcedPos:', forcedPos, 'categories:', categories.length, 'posList:', posList.length, 'role:', currentUser.role, 'pos:', currentUser.pos);

            // Si gestionnaire assigné à un POS, forcer ce POS et le rendre non-modifiable
            const hasAssignedPos = currentUser.role === 'gestionnaire' && currentUser.pos;
            const assignedPos = hasAssignedPos ? CORE.getPOS(currentUser.pos) : null;

            // Charger les données sauvegardées s'il y en a
            const saved = window._savedProductFormData || {};

            UI.modal('Nouveau produit', `
                <div class="space-y-4 max-h-[700px] overflow-y-auto">
                    <div class="space-y-4">
                        ${UI.input('mp_name','Nom','text',saved.name || '','ex: Farine de manioc 1kg',true)}

                        <div class="space-y-2">
                            <label class="block text-sm font-black text-slate-900">Catégorie *</label>
                            <div class="flex gap-2">
                                ${UI.select('mp_cat','', categories, saved.categoryId || '', true)}
                                <button onclick="ManagerModule.showNewCategoryModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-black hover:bg-blue-700 transition whitespace-nowrap">+ Nouvelle</button>
                            </div>
                        </div>

                            <div class="space-y-2">
                            <label class="block text-sm font-black text-slate-900">Point de Vente (POS) ${hasAssignedPos ? '(Verrouillé)' : '*'}</label>
                            ${hasAssignedPos ? `
                                <div class="px-4 py-2.5 bg-cyan-100 border-2 border-cyan-300 rounded-xl font-black text-cyan-900 flex items-center gap-2">
                                    <i data-lucide="lock" class="w-4 h-4"></i>
                                    ${assignedPos?.name || `POS ${currentUser.pos}`}
                                </div>
                                <input type="hidden" id="mp_pos" value="${currentUser.pos}">
                                <div class="text-xs text-cyan-600">Vous êtes affecté à ce POS uniquement. Les produits créés ici ne seront visibles que dans ce POS.</div>
                            ` : `
                                ${UI.select('mp_pos','', [{value:'main',label:'🏭 Dépôt Principal (stock central)'}, ...posList], (forcedPos === 'main' ? 'main' : (saved.posId || '')), true)}
                                <div class="text-xs text-slate-500">Sélectionnez le POS où ce produit sera disponible (ou 'Dépôt Principal')</div>
                            `}
                        </div>

                        ${UI.input('mp_price','Prix','number',saved.price || '0','ex: 1500',true)}
                        ${UI.input('mp_stock','Stock initial','number',saved.stock || '0','ex: 100',true)}
                        ${UI.input('mp_min','Stock minimum','number',saved.minStock || '0','ex: 20',true)}
                        ${UI.input('mp_barcode','Code-barres','text',saved.barcode || '','facultatif',false)}
                        ${UI.select('mp_active','État',[{value:'1',label:'Actif'},{value:'0',label:'Inactif'}],saved.active || '1',true)}

                        <div id="mp_preview" class="p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-emerald-200 rounded-xl hidden">
                            <div class="font-black text-emerald-900 mb-3">✓ Aperéu du produit:</div>
                            <div class="space-y-2">
                                <div class="p-3 bg-white rounded border border-emerald-200">
                                    <div class="text-xs text-slate-500 font-bold">Stock initial</div>
                                    <div class="font-black text-lg text-slate-900" id="mp_preview_stock">0</div>
                                </div>
                                <div class="p-3 bg-white rounded border border-emerald-200">
                                    <div class="text-xs text-slate-500 font-bold">Stock minimum</div>
                                    <div class="font-black text-lg text-slate-900" id="mp_preview_min">0</div>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-blue-50 border border-blue-300 rounded-2xl">
                            <div class="font-black text-blue-900 mb-2">📸 Ajouter des images</div>
                            <div class="p-4 bg-blue-50 border-2 border-dashed border-blue-300 rounded-2xl text-center cursor-pointer hover:bg-blue-100 transition" onclick="document.getElementById('file_input_new_product').click()">
                                <i data-lucide="upload-cloud" class="w-8 h-8 text-blue-600 mx-auto mb-2"></i>
                                <div class="font-black text-blue-900 text-sm">Cliquez pour uploader</div>
                                <div class="text-xs text-blue-600">ou glissez-déposez les images</div>
                                <input id="file_input_new_product" type="file" accept="image/*" multiple style="display:none" onchange="ManagerModule.handleNewProductImages(event)">
                            </div>
                            <div id="mp_images_preview" class="mt-2 text-xs text-blue-600">${ManagerModule.newProductImages && ManagerModule.newProductImages.length > 0 ? ManagerModule.newProductImages.length + ' image(s) sélectionnée(s)' : 'Aucune image ajoutée'}</div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal(); ManagerModule.newProductImages = []; window._savedProductFormData = {};' },
                { label: 'Créer', onclick: 'ManagerModule.createProduct()', class: 'px-5 py-2.5 bg-sky-600 text-white font-black rounded-xl hover:bg-sky-700 transition' }
            ]);

            // Ajouter des événements pour sauvegarder les données
            setTimeout(() => {
                const inputs = document.querySelectorAll('#mp_name, #mp_price, #mp_stock, #mp_min, #mp_barcode, #mp_cat, #mp_active');

                const updatePreview = () => {
                    const stock = parseInt(UI.val('mp_stock') || '0', 10);
                    const minStock = parseInt(UI.val('mp_min') || '0', 10);
                    const preview = document.getElementById('mp_preview');

                    if (stock > 0 || minStock > 0) {
                        preview.classList.remove('hidden');
                        document.getElementById('mp_preview_stock').textContent = stock;
                        document.getElementById('mp_preview_min').textContent = minStock;
                    } else {
                        preview.classList.add('hidden');
                    }
                };

                inputs.forEach(input => {
                    input.addEventListener('change', () => {
                        updatePreview();
                        window._savedProductFormData = {
                            name: document.getElementById('mp_name')?.value || '',
                            price: document.getElementById('mp_price')?.value || '0',
                            stock: document.getElementById('mp_stock')?.value || '0',
                            minStock: document.getElementById('mp_min')?.value || '0',
                            barcode: document.getElementById('mp_barcode')?.value || '',
                            categoryId: document.getElementById('mp_cat')?.value || '',
                            active: document.getElementById('mp_active')?.value || '1'
                        };
                    });
                    input.addEventListener('input', updatePreview);
                });

                updatePreview();
            }, 50);
        },

        showNewCategoryModal() {
            // IMPORTANT: Sauvegarder les données du formulaire AVANT d'ouvrir le modal catégorie
            // Car UI.modal va remplacer le contenu et les champs ne seront plus accessibles
            window._savedProductFormData = {
                name: document.getElementById('mp_name')?.value || '',
                price: document.getElementById('mp_price')?.value || '0',
                stock: document.getElementById('mp_stock')?.value || '0',
                minStock: document.getElementById('mp_min')?.value || '0',
                barcode: document.getElementById('mp_barcode')?.value || '',
                categoryId: document.getElementById('mp_cat')?.value || '',
                posId: document.getElementById('mp_pos')?.value || '',
                active: document.getElementById('mp_active')?.value || '1'
            };

            UI.modal('Nouvelle catégorie', `
                <div class="space-y-4">
                    ${UI.input('nc_name','Nom de la catégorie','text','','ex: Fruits & Légumes',true)}
                    ${UI.input('nc_icon','Icône','text','','ex: apple, package, box, etc.',false)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'ManagerModule.cancelNewCategory()' },
                { label: 'Créer et retour', onclick: 'ManagerModule.createAndSelectCategory()', class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        cancelNewCategory() {
            UI.closeModal();
            setTimeout(() => ManagerModule.showNewProductModal(), 100);
        },

        createAndSelectCategory() {
            const name = UI.val('nc_name').trim();
            const icon = UI.val('nc_icon').trim() || 'package';
            if (!name) return UI.toast('Nom requis', 'warning');

            const newCat = CORE.create('categories', { name, icon });

            // Mettre à jour pour sélectionner la nouvelle catégorie
            window._savedProductFormData = window._savedProductFormData || {};
            window._savedProductFormData.categoryId = newCat.id;

            UI.toast(`Catégorie "${name}" créée`, 'success');
            UI.closeModal();

            // Réouvrir le modal de produit
            setTimeout(() => {
                ManagerModule.showNewProductModal();

                // Forcer la restauration après que le modal soit rendu
                setTimeout(() => {
                    const saved = window._savedProductFormData;
                    if (saved && document.getElementById('mp_name')) {
                        document.getElementById('mp_name').value = saved.name || '';
                        document.getElementById('mp_price').value = saved.price || '0';
                        document.getElementById('mp_stock').value = saved.stock || '0';
                        document.getElementById('mp_min').value = saved.minStock || '0';
                        document.getElementById('mp_barcode').value = saved.barcode || '';
                        if (saved.posId) document.getElementById('mp_pos').value = saved.posId;
                        if (saved.active) document.getElementById('mp_active').value = saved.active;
                        document.getElementById('mp_cat').value = newCat.id;
                    }
                }, 100);
            }, 100);
        },

        createProduct() {
          try {
            const currentUser = CORE.state.currentUser || {};
            const name = UI.val('mp_name').trim();
            // Support both numeric and UUID category IDs from cloud sync
            const rawCatVal = UI.val('mp_cat') || '';
            const categoryId = /^\d+$/.test(rawCatVal) ? parseInt(rawCatVal, 10) : rawCatVal;
            // FORCER le POS si gestionnaire assigné à un POS
            const hasAssignedPos = currentUser.role === 'gestionnaire' && currentUser.pos;
            const rawPosVal = hasAssignedPos ? String(currentUser.pos) : String(UI.val('mp_pos') || '');
            const isMainWarehouse = rawPosVal === 'main';
            // Support both numeric and UUID POS IDs
            const posId = isMainWarehouse ? null : (hasAssignedPos ? currentUser.pos : (/^\d+$/.test(rawPosVal) ? parseInt(rawPosVal, 10) : rawPosVal));
            const price = Number(UI.val('mp_price') || 0);
            const stock = Number(UI.val('mp_stock') || 0);
            const minStock = Number(UI.val('mp_min') || 0);
            const barcode = UI.val('mp_barcode').trim();
            const active = UI.val('mp_active') === '1';

            console.log('[CreateProduct] name:', name, 'rawCatVal:', rawCatVal, 'categoryId:', categoryId, 'rawPosVal:', rawPosVal, 'isMainWarehouse:', isMainWarehouse, 'posId:', posId, 'stock:', stock);

            if (!name) return UI.toast('Le nom du produit est requis', 'warning');
            if (!categoryId) return UI.toast('Veuillez sélectionner une catégorie (créez-en une si la liste est vide)', 'warning');
            if (!posId && !isMainWarehouse) return UI.toast('Veuillez sélectionner un Point de Vente', 'warning');
            if (price < 0 || stock < 0 || minStock < 0) return UI.toast('Valeurs invalides', 'warning');

            // Créer le produit avec posId strict
            const createdData = {
                name, categoryId, price, stock, minStock,
                image: null, barcode: barcode || null, active,
                posStocks: {},
                lockedToPosId: hasAssignedPos ? posId : null
            };
            if (isMainWarehouse) {
                createdData.isMainWarehouse = true;
                createdData.posId = null;
                createdData.storeId = null;
            } else {
                createdData.posId = posId;
                createdData.storeId = posId;
            }

            const created = CORE.create('products', createdData);

            // Initialiser le stock pour ce POS si applicable
            if (!isMainWarehouse && posId) {
                created.posStocks[String(posId)] = { stock, price, lastUpdated: new Date().toISOString() };
                CORE.save(); // Persister posStocks
            }

            CORE.recordStockMovement({ productId: created.id, type: 'in', qty: stock, note: 'Stock initial (création produit)', ref: `PRD-${created.id}`, posId: posId || null });

            // Upload images if any
            if (ManagerModule.newProductImages && ManagerModule.newProductImages.length > 0) {
                let imageCount = 0;
                ManagerModule.newProductImages.forEach((base64, idx) => {
                    const uploadedImg = CORE.uploadProductImage(created.id, base64, `Image_${idx+1}`);
                    if (uploadedImg) imageCount++;

                    // Set the first image as the product's main image
                    if (idx === 0 && uploadedImg) {
                        created.image = uploadedImg.url;
                        CORE.save();
                    }
                });
                if (imageCount > 0) {
                    UI.toast(`${imageCount} image(s) uploadée(s)`, 'success');
                }
            }

            ManagerModule.newProductImages = [];

            // Audit logging
            CORE.logAudit('create', 'product', created.id, name, { description: `Produit créé: ${name} (prix: ${price}, stock: ${stock}, POS: ${isMainWarehouse ? 'Dépôt Principal' : CORE.getPOS(posId)?.name || posId})` });

            UI.closeModal();
            console.log('[CreateProduct] ✅ Product created successfully: id=', created.id, 'name=', name, 'isMainWarehouse=', isMainWarehouse, 'posId=', posId, 'stock=', stock, 'totalProducts=', CORE.db.products.length);
            UI.toast(isMainWarehouse ? 'Produit créé au Dépôt Principal ✅' : `Produit créé au POS ${CORE.getPOS(posId)?.name || ''} ✅`, 'success');

            // Re-render avec un petit délai pour assurer que tout est sauvegardé
            setTimeout(() => {
                App.rerender();
            }, 100);
          } catch(err) {
            console.error('[CreateProduct] ❌ Error creating product:', err);
            UI.toast('Erreur lors de la création: ' + err.message, 'error');
          }
        },

        newProductImages: [],
        newVariantImages: [],

        showEditProductModal(productId) {
            const p = CORE.getProduct(productId);
            if (!p) return;
            const variants = CORE.getProductVariants(productId);
            const images = CORE.getProductImages(productId);

            UI.modal(`Modifier: ${p.name}`, `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    ${UI.input('ep_name','Nom','text', p.name || '', '', true)}
                    ${UI.select('ep_cat','Catégorie', CORE.db.categories.map(c => ({value: c.id, label: c.name})), p.categoryId, true)}
                    ${UI.input('ep_price','Prix','number', p.price ?? 0, '', true)}
                    ${UI.input('ep_min','Stock minimum','number', p.minStock ?? 0, '', true)}
                    ${UI.input('ep_image','Image principale (URL)','text', p.image || '', '', false)}
                    ${UI.input('ep_barcode','Code-barres','text', p.barcode || '', '', false)}
                    ${UI.select('ep_active','État',[{value:'1',label:'Actif'},{value:'0',label:'Inactif'}], p.active ? '1':'0', true)}
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">Stock actuel: <b>${p.stock}</b></div>

                    <div class="p-4 bg-blue-50 border border-blue-300 rounded-2xl">
                        <div class="font-black text-blue-900 mb-2">📸 Galerie d'images (${images.length})</div>
                        ${images.length > 0 ? `
                            <div class="space-y-2 mb-3 max-h-48 overflow-y-auto">
                                ${images.map((img, idx) => `
                                    <div class="flex items-center gap-2 p-2 bg-white rounded border border-blue-200">
                                        <img src="${img.url}" alt="Image ${idx+1}" class="w-10 h-10 object-cover rounded">
                                        <div class="flex-1 text-xs">
                                            <div class="text-blue-900 font-bold">${img.filename || 'Image ' + (idx+1)}</div>
                                            ${img.isPrimary ? '<span class="text-[10px] bg-yellow-200 text-yellow-800 px-1 rounded font-black">★ Principale</span>' : ''}
                                        </div>
                                        <div class="flex gap-1">
                                            ${!img.isPrimary ? `<button onclick="ManagerModule.setPrimaryProductImage('${img.id}', ${productId})" class="px-2 py-1 bg-yellow-500 text-white text-xs rounded hover:bg-yellow-600 transition font-black" title="Définir comme principale">★</button>` : ''}
                                            <button onclick="ManagerModule.replaceProductImage('${img.id}', ${productId})" class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition font-black" title="Remplacer">↻</button>
                                            <button onclick="ManagerModule.deleteProductImage('${img.id}', ${productId})" class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition font-black" title="Supprimer">✕</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div class="text-xs text-blue-700 mb-3">Aucune image encore</div>'}
                        <button onclick="ManagerModule.showImageUploadModal(${productId})" class="w-full py-2 px-3 bg-blue-600 text-white rounded-lg font-black text-sm hover:bg-blue-700 transition">
                            + Ajouter/Gérer images
                        </button>
                    </div>

                    ${variants.length > 0 ? `
                        <div class="p-4 bg-purple-50 border border-purple-200 rounded-2xl">
                            <div class="font-black text-purple-900 mb-2">Variantes (${variants.length})</div>
                            <div class="space-y-1 text-xs text-purple-800">
                                ${variants.map(v => `<div>• ${(v.attributes || []).map(a => a.name + ': ' + a.value).join(', ') || v.sku || 'Variante'} — ${CORE.formatPrice(v.price)} (stock: ${v.stock})</div>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Variantes', onclick: `ManagerModule.showVariantsModal(${p.id})`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' },
                { label: 'Enregistrer', onclick: `ManagerModule.saveProduct(${p.id})`, class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        showImageUploadModal(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return UI.toast('Produit introuvable', 'error');

            UI.modal(`Gérer les images: ${product.name}`, `
                <div class="space-y-4">
                    <div id="manager_image_preview"></div>

                    <div class="p-4 bg-blue-50 border-2 border-dashed border-blue-300 rounded-2xl text-center cursor-pointer hover:bg-blue-100 transition" onclick="document.getElementById('file_input_manager').click()">
                        <i data-lucide="upload-cloud" class="w-8 h-8 text-blue-600 mx-auto mb-2"></i>
                        <div class="font-black text-blue-900">Cliquez pour uploader une image</div>
                        <div class="text-xs text-blue-600">ou glissez-déposez</div>
                        <input id="file_input_manager" type="file" accept="image/*" multiple style="display:none" onchange="ManagerModule.handleImageSelect(event, ${productId})">
                    </div>

                    <div class="text-xs text-slate-600 bg-slate-50 p-3 rounded-lg">
                        Ou entrez une URL d'image:
                    </div>
                    <div class="flex gap-2">
                        <input id="image_url_manager" type="text" placeholder="https://..." class="flex-1 px-3 py-2 border border-slate-200 rounded-lg">
                        <button onclick="ManagerModule.addImageFromURL(${productId})" class="px-4 py-2 bg-green-600 text-white rounded-lg font-black hover:bg-green-700 transition">+ Ajouter</button>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        handleImageSelect(event, productId) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            // Collect images to display in preview
            const previewContainer = document.getElementById('manager_image_preview');
            if (!previewContainer) return;

            let uploadedCount = 0;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64 = e.target.result;
                    CORE.uploadProductImage(productId, base64, file.name);
                    uploadedCount++;

                    // Update preview directly
                    if (previewContainer) {
                        previewContainer.innerHTML = `
                            <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-lg">
                                <div class="font-black text-emerald-700">✓ ${uploadedCount} image(s) uploadée(s)</div>
                                <div class="text-xs text-emerald-600 mt-1">Images ajoutées au produit</div>
                            </div>
                        `;
                    }

                    UI.toast(`Image "${file.name}" uploadée`, 'success');
                };
                reader.readAsDataURL(file);
            });
        },

        addImageFromURL(productId) {
            const url = document.getElementById('image_url_manager')?.value?.trim();
            if (!url) return UI.toast('URL requise', 'warning');

            CORE.uploadProductImage(productId, url, 'Image from URL');
            document.getElementById('image_url_manager').value = '';

            const previewContainer = document.getElementById('manager_image_preview');
            if (previewContainer) {
                const images = CORE.getProductImages(productId);
                previewContainer.innerHTML = `
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-lg">
                        <div class="font-black text-emerald-700">✓ Image ajoutée (Total: ${images.length})</div>
                        <div class="text-xs text-emerald-600 mt-1">Images dans le produit</div>
                    </div>
                `;
            }
            UI.toast('Image ajoutée avec succès', 'success');
        },

        deleteProductImage(imageId, productId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette image ?')) return;

            const idx = CORE.db.productImages.findIndex(img => img.id === imageId);
            if (idx !== -1) {
                const wasDeleted = CORE.db.productImages.splice(idx, 1);

                if (wasDeleted[0].isPrimary && CORE.db.productImages.length > 0) {
                    const sameProduct = CORE.db.productImages.filter(img => img.productId === productId);
                    if (sameProduct.length > 0) {
                        sameProduct[0].isPrimary = true;
                    }
                }

                CORE.save();
                UI.toast('Image supprimée', 'success');
                ManagerModule.showEditProductModal(productId);
            }
        },

        setPrimaryProductImage(imageId, productId) {
            const image = CORE.db.productImages.find(img => img.id === imageId);
            if (!image) return UI.toast('Image introuvable', 'error');

            CORE.db.productImages.forEach(img => {
                if (img.productId === productId && img.isPrimary) {
                    img.isPrimary = false;
                }
            });

            image.isPrimary = true;

            const p = CORE.getProduct(productId);
            if (p) {
                CORE.update('products', productId, { image: image.url });
            }

            CORE.save();
            UI.toast('Image définie comme principale', 'success');
            ManagerModule.showEditProductModal(productId);
        },

        replaceProductImage(imageId, productId) {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const base64 = event.target.result;

                    const image = CORE.db.productImages.find(img => img.id === imageId);
                    if (image) {
                        image.url = base64;
                        image.filename = file.name;
                        image.filesize = Math.round((base64.length * 3) / 4);
                        image.uploadedAt = new Date().toISOString();
                        image.uploadedBy = CORE.state.currentUser?.id;
                        image.uploadedByName = CORE.state.currentUser?.name;

                        if (image.isPrimary) {
                            const p = CORE.getProduct(productId);
                            if (p) {
                                CORE.update('products', productId, { image: base64 });
                            }
                        }

                        CORE.save();
                        UI.toast('Image remplacée avec succès', 'success');
                        ManagerModule.showEditProductModal(productId);
                    }
                };
                reader.readAsDataURL(file);
            };
            fileInput.click();
        },

        handleNewProductImages(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (!ManagerModule.newProductImages) ManagerModule.newProductImages = [];
                    ManagerModule.newProductImages.push(e.target.result);

                    // Mettre à jour le DOM du modal directement
                    const previewContainer = document.getElementById('mp_images_preview');
                    if (previewContainer) {
                        const html = ManagerModule.newProductImages.map((img, idx) => `
                            <div class="relative">
                                <img src="${img}" alt="Preview ${idx+1}" class="w-16 h-16 object-cover rounded-lg border border-blue-300">
                                <button onclick="ManagerModule.removeNewProductImage(${idx})" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition">×</button>
                            </div>
                        `).join('');

                        previewContainer.innerHTML = `
                            <div class="text-xs font-bold text-blue-900 mb-2">${ManagerModule.newProductImages.length} image(s) ajoutée(s)</div>
                            <div class="flex flex-wrap gap-2">${html}</div>
                        `;
                    }
                };
                reader.readAsDataURL(file);
            });
        },

        removeNewProductImage(idx) {
            if (ManagerModule.newProductImages) {
                ManagerModule.newProductImages.splice(idx, 1);

                // Mettre à jour le DOM du modal directement
                const previewContainer = document.getElementById('mp_images_preview');
                if (previewContainer) {
                    if (ManagerModule.newProductImages.length > 0) {
                        const html = ManagerModule.newProductImages.map((img, i) => `
                            <div class="relative">
                                <img src="${img}" alt="Preview ${i+1}" class="w-16 h-16 object-cover rounded-lg border border-blue-300">
                                <button onclick="ManagerModule.removeNewProductImage(${i})" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition">×</button>
                            </div>
                        `).join('');

                        previewContainer.innerHTML = `
                            <div class="text-xs font-bold text-blue-900 mb-2">${ManagerModule.newProductImages.length} image(s) ajoutée(s)</div>
                            <div class="flex flex-wrap gap-2">${html}</div>
                        `;
                    } else {
                        previewContainer.innerHTML = '<div class="mt-2 text-xs text-blue-600">Aucune image ajoutée</div>';
                    }
                }
            }
        },

        saveProduct(productId) {
            const p = CORE.getProduct(productId);
            if (!p) return;
            const name = UI.val('ep_name').trim();
            const categoryId = parseInt(UI.val('ep_cat') || '0', 10);
            const price = Number(UI.val('ep_price') || 0);
            const minStock = Number(UI.val('ep_min') || 0);
            const image = UI.val('ep_image').trim();
            const barcode = UI.val('ep_barcode').trim();
            const active = UI.val('ep_active') === '1';
            if (!name || !categoryId) return UI.toast('Nom et catégorie requis', 'warning');
            if (price < 0 || minStock < 0) return UI.toast('Valeurs invalides', 'warning');

            // Mettre à jour image principale si fournie
            const finalImage = image ? image : (p.image || null);

            const beforeState = { name: p.name, price: p.price, minStock: p.minStock, active: p.active };
            CORE.update('products', p.id, { name, categoryId, price, minStock, image: finalImage, barcode: barcode || null, active });
            CORE.logAudit('update', 'product', p.id, name, { description: `Produit modifié: ${name}` }, beforeState, { name, price, minStock, active });
            UI.closeModal();
            UI.toast('Produit mis à jour avec succès', 'success');
            App.rerender();
        },

        showProductInfoModal(productId) {
            const p = CORE.getProduct(productId);
            if (!p) return;
            const category = CORE.getCategory(p.categoryId);
            const isLow = p.stock <= p.minStock;

            // Chercher l'image principale dans la galerie si pas d'image URL
            let displayImage = p.image;
            if (!displayImage) {
                const images = CORE.getProductImages(productId);
                const primaryImage = images.find(img => img.isPrimary);
                if (primaryImage) {
                    displayImage = primaryImage.url;
                } else if (images.length > 0) {
                    displayImage = images[0].url;
                }
            }

            UI.modal(p.name + ' - Détails complets', `
                <div class="space-y-4 max-h-[600px] overflow-y-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            ${displayImage ? `<img src="${displayImage}" alt="${p.name}" class="w-full h-48 object-cover rounded-2xl border border-slate-200 mb-4">` : '<div class="w-full h-48 bg-slate-100 rounded-2xl border border-slate-200 flex items-center justify-center text-slate-400"><i data-lucide="image-off" class="w-12 h-12"></i></div>'}
                            <div class="space-y-2 text-sm">
                                <div><span class="font-black text-slate-700">Catégorie:</span> ${category?.name || '—'}</div>
                                <div><span class="font-black text-slate-700">Code-barres:</span> ${p.barcode || '—'}</div>
                                <div><span class="font-black text-slate-700">État:</span> ${p.active ? '<span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded text-xs font-black">Actif</span>' : '<span class="px-2 py-1 bg-slate-100 text-slate-700 rounded text-xs font-black">Inactif</span>'}</div>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                                <div class="text-xs font-black text-blue-600 uppercase">Prix</div>
                                <div class="text-2xl font-black text-blue-900 mt-1">${CORE.formatPrice(p.price)}</div>
                            </div>
                            <div class="p-4 bg-${isLow ? 'red' : 'emerald'}-50 border border-${isLow ? 'red' : 'emerald'}-200 rounded-2xl">
                                <div class="text-xs font-black text-${isLow ? 'red' : 'emerald'}-600 uppercase">Stock actuel</div>
                                <div class="text-2xl font-black text-${isLow ? 'red' : 'emerald'}-900 mt-1">${p.stock}</div>
                                ${isLow ? `<div class="text-xs text-red-700 mt-1">⚠️ Sous le minimum (${p.minStock})</div>` : `<div class="text-xs text-emerald-700 mt-1">✓ Au-dessus du minimum (${p.minStock})</div>`}
                            </div>
                        </div>
                    </div>
                    <div class="border-t border-slate-200 pt-4 grid grid-cols-3 gap-2 text-center text-xs">
                        <div>
                            <div class="text-slate-500">Créé</div>
                            <div class="font-bold text-slate-900">${CORE.formatDate(p.createdAt).split(' ')[0]}</div>
                        </div>
                        <div>
                            <div class="text-slate-500">Valorisation</div>
                            <div class="font-bold text-slate-900">${CORE.formatPrice((p.price || 0) * (p.stock || 0))}</div>
                        </div>
                        <div>
                            <div class="text-slate-500">Min requis</div>
                            <div class="font-bold text-slate-900">${CORE.formatPrice((p.price || 0) * (p.minStock || 0))}</div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' },
                { label: 'Éditer', onclick: 'ManagerModule.showEditProductModal(\'' + p.id + '\')', class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        showVariantsModal(productId) {
            const p = CORE.getProduct(productId);
            if (!p) return;
            const variants = CORE.getProductVariants(productId);
            UI.modal(`Variantes Avancées: ${p.name}`, `
                <div class="space-y-4">
                    <div class="space-y-2 max-h-[500px] overflow-y-auto">
                        ${variants.length === 0 ? `<div class="text-center text-slate-400 py-8">Aucune variante</div>` : ''}
                        ${variants.map(v => {
                            const attrs = v.attributes && v.attributes.length ? v.attributes : [];
                            const attrDisplay = attrs.map(a => `<span class="inline-block px-2 py-1 bg-blue-100 text-blue-700 rounded-lg text-xs">${a.name}: <strong>${a.value}</strong></span>`).join(' ');
                            return `
                            <div class="p-4 rounded-2xl border-2 border-slate-200 bg-gradient-to-r from-slate-50 to-blue-50 hover:border-blue-300 transition">
                                <div class="flex items-start justify-between gap-3 mb-2">
                                    <div class="flex-1">
                                        <div class="font-black text-slate-900">SKU: <code class="bg-slate-200 px-2 py-1 rounded text-xs">${v.sku || 'AUTO'}</code></div>
                                        <div class="text-sm text-slate-600 mt-1 space-x-1">${attrDisplay}</div>
                                    </div>
                                    <div class="text-right text-sm">
                                        <div class="font-bold text-emerald-600">${CORE.formatPrice(v.price || 0)}</div>
                                        <div class="text-slate-500">Stock: <strong class="${v.stock < 10 ? 'text-red-600' : 'text-emerald-600'}">${v.stock}</strong></div>
                                    </div>
                                </div>
                                ${v.weight ? `<div class="text-xs text-slate-500">Poids: ${v.weight}</div>` : ''}
                                ${v.temperature ? `<div class="text-xs text-slate-500">Température: ${v.temperature}</div>` : ''}
                                <div class="flex gap-2 mt-2">
                                    <button onclick="ManagerModule.editVariant('${v.id}')" class="px-3 py-1.5 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-200 text-xs font-bold transition">Éditer</button>
                                    <button onclick="ManagerModule.deleteVariant('${v.id}')" class="px-3 py-1.5 rounded-lg bg-red-100 text-red-600 hover:bg-red-200 text-xs font-bold transition">Supprimer</button>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                    <div class="border-t border-slate-300 pt-4">
                        <button onclick="ManagerModule.showAddVariantForm(${productId})" class="w-full px-4 py-3 rounded-xl bg-emerald-600 text-white font-black hover:bg-emerald-700 transition">+ Nouvelle Variante</button>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showAddVariantForm(productId) {
            const p = CORE.getProduct(productId);
            if (!p) return;

            // Charger les données sauvegardées s'il y en a
            const saved = window._savedVariantFormData || {};

            // Si ce n'est pas la première fois, garder les attributs
            if (!window.tempVariantAttrs) {
                window.tempVariantAttrs = saved.attributes || [];
            }
            if (!ManagerModule.newVariantImages) {
                ManagerModule.newVariantImages = saved.images || [];
            }

            UI.modal(`Ajouter Variante: ${p.name}`, `
                <div class="space-y-4 max-h-[700px] overflow-y-auto">
                    ${UI.input('var_sku_new','SKU','text',saved.sku || '','auto-généré si vide',false)}
                    <div class="space-y-3">
                        <div class="font-black text-slate-900">Attributs (${window.tempVariantAttrs.length})</div>
                        <div id="var_attrs_list_new" class="space-y-2">
                            ${window.tempVariantAttrs.map((a, i) => `
                                <div class="p-3 rounded-lg bg-blue-50 border border-blue-200 flex items-center justify-between">
                                    <div class="font-bold text-slate-900">${a.name}: <span class="text-blue-600">${a.value}</span></div>
                                    <button onclick="ManagerModule.removeAttributeFromVariant(${i})" class="text-red-600 hover:text-red-800">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="ManagerModule.showAddAttributeSelector(${productId})" class="text-sm px-3 py-2 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-200 transition">+ Ajouter Attribut</button>
                    </div>
                    <div class="border-t border-slate-200 pt-4 space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            ${UI.input('var_price_new','Prix (XAF)','number',saved.price || '0','requis',false)}
                            ${UI.input('var_stock_new','Stock','number',saved.stock || '0','requis',false)}
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            ${UI.input('var_weight_new','Poids (ex: 500g)','text',saved.weight || '','optionnel',false)}
                            ${UI.input('var_temp_new','Température (ex: 0-4°C)','text',saved.temperature || '','optionnel',false)}
                        </div>
                    </div>

                    <div class="p-4 bg-green-50 border border-green-300 rounded-2xl">
                        <div class="font-black text-green-900 mb-2">📸 Ajouter une image pour cette variante</div>
                        <div class="p-4 bg-green-50 border-2 border-dashed border-green-300 rounded-2xl text-center cursor-pointer hover:bg-green-100 transition" onclick="document.getElementById('file_input_variant').click()">
                            <i data-lucide="upload-cloud" class="w-8 h-8 text-green-600 mx-auto mb-2"></i>
                            <div class="font-black text-green-900 text-sm">Cliquez pour uploader</div>
                            <div class="text-xs text-green-600">ou glissez-déposez l'image</div>
                            <input id="file_input_variant" type="file" accept="image/*" style="display:none" onchange="ManagerModule.handleVariantImage(event)">
                        </div>
                        <div id="mv_image_preview" class="mt-2 text-xs text-green-600">${ManagerModule.newVariantImages && ManagerModule.newVariantImages.length > 0 ? '✓ Image sélectionnée' : 'Aucune image sélectionnée'}</div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal(); ManagerModule.newVariantImages = []; window.tempVariantAttrs = []; window._savedVariantFormData = {};' },
                { label: 'Créer Variante', onclick: `ManagerModule.addVariantAdvanced(${productId})`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);

            // Ajouter des événements pour sauvegarder les données
            setTimeout(() => {
                const inputs = document.querySelectorAll('#var_sku_new, #var_price_new, #var_stock_new, #var_weight_new, #var_temp_new');
                inputs.forEach(input => {
                    input.addEventListener('change', () => {
                        window._savedVariantFormData = {
                            sku: document.getElementById('var_sku_new')?.value || '',
                            price: document.getElementById('var_price_new')?.value || '0',
                            stock: document.getElementById('var_stock_new')?.value || '0',
                            weight: document.getElementById('var_weight_new')?.value || '',
                            temperature: document.getElementById('var_temp_new')?.value || '',
                            attributes: window.tempVariantAttrs || [],
                            images: ManagerModule.newVariantImages || []
                        };
                    });
                });
            }, 50);
        },

        handleVariantImage(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const file = files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                ManagerModule.newVariantImages = [e.target.result];

                // Mettre à jour le DOM du modal directement
                const previewContainer = document.getElementById('mv_image_preview');
                if (previewContainer) {
                    previewContainer.innerHTML = `
                        <div class="text-xs font-bold text-green-900 mb-2">Image sélectionnée</div>
                        <div class="relative inline-block">
                            <img src="${e.target.result}" alt="Preview" class="h-24 object-cover rounded-lg border border-green-300">
                            <button onclick="ManagerModule.removeVariantImage()" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition">×</button>
                        </div>
                    `;
                }
            };
            reader.readAsDataURL(file);
        },

        removeVariantImage() {
            ManagerModule.newVariantImages = [];

            // Mettre à jour le DOM du modal directement
            const previewContainer = document.getElementById('mv_image_preview');
            if (previewContainer) {
                previewContainer.innerHTML = '<div class="mt-2 text-xs text-green-600">Aucune image sélectionnée</div>';
            }
        },

        showAddAttributeSelector(productId) {
            window.tempVariantProductId = productId; // Store for later use

            // Sauvegarder les données avant de changer de modal
            window._savedVariantFormData = {
                sku: document.getElementById('var_sku_new')?.value || '',
                price: document.getElementById('var_price_new')?.value || '0',
                stock: document.getElementById('var_stock_new')?.value || '0',
                weight: document.getElementById('var_weight_new')?.value || '',
                temperature: document.getElementById('var_temp_new')?.value || '',
                attributes: window.tempVariantAttrs || [],
                images: ManagerModule.newVariantImages || []
            };

            const attrTypes = CORE.db.productAttributeTypes || [];
            const existingAttrs = window.tempVariantAttrs || [];
            const availableAttrs = attrTypes.filter(at => !existingAttrs.find(ea => ea.name === at.label));

            let html = '<div class="space-y-2">';

            // Attributs pré-définis
            availableAttrs.forEach(attr => {
                html += `
                    <div class="p-3 rounded-lg border border-slate-200 cursor-pointer hover:bg-slate-50 transition" onclick="ManagerModule.addAttributeToVariant(\'${attr.label}\', \'${attr.type}\')">
                        <div class="font-bold text-slate-900">${attr.label}</div>
                        <div class="text-xs text-slate-500">Type: ${attr.type}</div>
                    </div>
                `;
            });

            // Option pour attribut personnalisé
            html += `
                <div class="p-3 rounded-lg border border-blue-300 bg-blue-50 cursor-pointer hover:bg-blue-100 transition" onclick="ManagerModule.addCustomAttribute()">
                    <div class="font-bold text-blue-900">+ Attribut Personnalisé</div>
                    <div class="text-xs text-blue-600">Ajouter un attribut non répertorié</div>
                </div>
            `;

            html += '</div>';

            UI.modal('Sélectionner un Attribut', html, [
                { label: 'Retour', onclick: `ManagerModule.showAddVariantForm(${productId})` }
            ]);
        },

        addCustomAttribute() {
            // Sauvegarder les données avant de changer de modal
            window._savedVariantFormData = {
                sku: document.getElementById('var_sku_new')?.value || '',
                price: document.getElementById('var_price_new')?.value || '0',
                stock: document.getElementById('var_stock_new')?.value || '0',
                weight: document.getElementById('var_weight_new')?.value || '',
                temperature: document.getElementById('var_temp_new')?.value || '',
                attributes: window.tempVariantAttrs || [],
                images: ManagerModule.newVariantImages || []
            };

            UI.modal('Ajouter un Attribut Personnalisé', `
                <div class="space-y-3">
                    <input id="custom_attr_name" type="text" placeholder="Nom de l'attribut (ex: Matériau, Marque, Degré alcool)" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                    <input id="custom_attr_value" type="text" placeholder="Valeur (ex: Coton, Premium, 12%)" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Ajouter', onclick: 'ManagerModule.confirmCustomAttribute()', class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        confirmCustomAttribute() {
            const name = UI.val('custom_attr_name')?.trim();
            const value = UI.val('custom_attr_value')?.trim();

            if (!name || !value) {
                return UI.toast('Nom et valeur obligatoires', 'warning');
            }

            window.tempVariantAttrs = window.tempVariantAttrs || [];
            window.tempVariantAttrs.push({ name: name, value: value });

            // Afficher les attributs ajoutés
            const list = document.getElementById('var_attrs_list_new');
            if (list) {
                const attrHtml = window.tempVariantAttrs.map((a, i) => `
                    <div class="p-3 rounded-lg bg-blue-50 border border-blue-200 flex items-center justify-between">
                        <div class="font-bold text-slate-900">${a.name}: <span class="text-blue-600">${a.value}</span></div>
                        <button onclick="ManagerModule.removeAttributeFromVariant(${i})" class="text-red-600 hover:text-red-800">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                `).join('');
                list.innerHTML = attrHtml;
                lucide.createIcons();
            }

            // Retourner au modal de sélection d'attribut au lieu de fermer complètement
            ManagerModule.showAddAttributeSelector(window.tempVariantProductId);
            UI.toast('Attribut personnalisé ajouté', 'success');
        },

        addAttributeToVariant(attrName, attrType) {
            let valueInput = '';
            let suggestions = '';

            // Suggestions pré-remplies mais saisie libre
            if (attrName === 'Couleur') {
                suggestions = 'Ex: Rouge, Bleu, Vert, Jaune, Noir, Blanc, etc.';
            } else if (attrName === 'Taille') {
                suggestions = 'Ex: XS, S, M, L, XL, XXL, ou toute autre valeur';
            } else if (attrName === 'Température') {
                suggestions = 'Ex: Ambiant, Frais (0-4°C), Congelé (-18°C), ou toute autre valeur';
            } else {
                suggestions = 'Ex: valeur personnalisée';
            }

            valueInput = `<input id="attr_val_${attrName}" type="text" placeholder="${suggestions}" class="px-3 py-2 rounded-lg border border-slate-200 w-full" />`;

            UI.modal(`Valeur pour ${attrName}`, valueInput, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Ajouter', onclick: `ManagerModule.confirmAttributeValue('${attrName}')`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        confirmAttributeValue(attrName) {
            const val = UI.val(`attr_val_${attrName}`);
            if (!val) return UI.toast('Valeur requise', 'warning');

            window.tempVariantAttrs = window.tempVariantAttrs || [];
            window.tempVariantAttrs.push({ name: attrName, value: val });

            // Afficher les attributs ajoutés
            const list = document.getElementById('var_attrs_list_new');
            if (list) {
                const attrHtml = window.tempVariantAttrs.map((a, i) => `
                    <div class="p-3 rounded-lg bg-blue-50 border border-blue-200 flex items-center justify-between">
                        <div class="font-bold text-slate-900">${a.name}: <span class="text-blue-600">${a.value}</span></div>
                        <button onclick="ManagerModule.removeAttributeFromVariant(${i})" class="text-red-600 hover:text-red-800">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                `).join('');
                list.innerHTML = attrHtml;
                lucide.createIcons();
            }

            // Retourner au modal de sélection d'attribut au lieu de fermer complètement
            ManagerModule.showAddAttributeSelector(window.tempVariantProductId);
            UI.toast('Attribut ajouté', 'success');
        },

        removeAttributeFromVariant(index) {
            if (!window.tempVariantAttrs) return;
            window.tempVariantAttrs.splice(index, 1);

            // Sauvegarder les attributs restants
            window._savedVariantFormData = {
                sku: document.getElementById('var_sku_new')?.value || '',
                price: document.getElementById('var_price_new')?.value || '0',
                stock: document.getElementById('var_stock_new')?.value || '0',
                weight: document.getElementById('var_weight_new')?.value || '',
                temperature: document.getElementById('var_temp_new')?.value || '',
                attributes: window.tempVariantAttrs || [],
                images: ManagerModule.newVariantImages || []
            };

            const list = document.getElementById('var_attrs_list_new');
            if (list) {
                const attrHtml = window.tempVariantAttrs.map((a, i) => `
                    <div class="p-3 rounded-lg bg-blue-50 border border-blue-200 flex items-center justify-between">
                        <div class="font-bold text-slate-900">${a.name}: <span class="text-blue-600">${a.value}</span></div>
                        <button onclick="ManagerModule.removeAttributeFromVariant(${i})" class="text-red-600 hover:text-red-800">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                `).join('');
                list.innerHTML = attrHtml;
                lucide.createIcons();
            }
        },

        addVariantAdvanced(productId) {
            const price = Number(UI.val('var_price_new') || 0);
            const stock = Number(UI.val('var_stock_new') || 0);
            const sku = UI.val('var_sku_new').trim() || `SKU-${Date.now()}`;
            const weight = UI.val('var_weight_new').trim();
            const temperature = UI.val('var_temp_new').trim();
            const attributes = window.tempVariantAttrs || [];

            if (attributes.length === 0) return UI.toast('Au moins 1 attribut requis', 'warning');
            if (price <= 0) return UI.toast('Prix doit être > 0', 'warning');
            if (stock < 0) return UI.toast('Stock invalide', 'warning');

            const variant = CORE.create('productVariants', {
                productId,
                attributes,
                sku,
                price,
                stock,
                weight: weight || null,
                temperature: temperature || null,
                image: null
            });

            // Upload image if any
            if (ManagerModule.newVariantImages && ManagerModule.newVariantImages.length > 0) {
                const base64 = ManagerModule.newVariantImages[0];
                const uploadedImg = CORE.uploadProductImage(productId, base64, `Variant_${sku}`);
                if (uploadedImg) {
                    variant.image = uploadedImg.url;
                    CORE.update('productVariants', variant.id, { image: uploadedImg.url });
                    UI.toast('Image de variante uploadée', 'success');
                }
            }

            window.tempVariantAttrs = [];
            ManagerModule.newVariantImages = [];
            UI.toast('Variante créée avec succès', 'success');
            ManagerModule.showVariantsModal(productId);
        },

        editVariant(variantId) {
            const variant = CORE.db.productVariants.find(v => v.id === variantId);
            if (!variant) return UI.toast('Variante introuvable', 'error');

            window.tempVariantAttrs = JSON.parse(JSON.stringify(variant.attributes || []));

            const p = CORE.getProduct(variant.productId);
            UI.modal(`Éditer Variante: ${p?.name}`, `
                <div class="space-y-4">
                    ${UI.input('var_sku_edit','SKU','text',variant.sku || '','',false)}
                    <div class="space-y-3">
                        <div class="font-black text-slate-900">Attributs</div>
                        <div id="var_attrs_list_edit" class="space-y-2">
                            ${(variant.attributes || []).map((a, i) => `
                                <div class="p-3 rounded-lg bg-blue-50 border border-blue-200 flex items-center justify-between">
                                    <div class="font-bold text-slate-900">${a.name}: <span class="text-blue-600">${a.value}</span></div>
                                    <button onclick="ManagerModule.removeAttributeFromVariant(${i})" class="text-red-600 hover:text-red-800">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="border-t border-slate-200 pt-4 space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            ${UI.input('var_price_edit','Prix (XAF)','number',variant.price || '0','',false)}
                            ${UI.input('var_stock_edit','Stock','number',variant.stock || '0','',false)}
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            ${UI.input('var_weight_edit','Poids','text',variant.weight || '','',false)}
                            ${UI.input('var_temp_edit','Température','text',variant.temperature || '','',false)}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Sauvegarder', onclick: `ManagerModule.saveVariantEdit('${variantId}')`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        saveVariantEdit(variantId) {
            const price = Number(UI.val('var_price_edit') || 0);
            const stock = Number(UI.val('var_stock_edit') || 0);
            const sku = UI.val('var_sku_edit').trim();
            const weight = UI.val('var_weight_edit').trim();
            const temperature = UI.val('var_temp_edit').trim();
            const attributes = window.tempVariantAttrs || [];

            if (price <= 0) return UI.toast('Prix invalide', 'warning');
            if (stock < 0) return UI.toast('Stock invalide', 'warning');

            CORE.update('productVariants', variantId, {
                attributes,
                sku: sku || `SKU-${variantId}`,
                price,
                stock,
                weight: weight || null,
                temperature: temperature || null
            });

            const variant = CORE.db.productVariants.find(v => v.id === variantId);
            window.tempVariantAttrs = [];
            UI.toast('Variante mise à jour', 'success');
            ManagerModule.showVariantsModal(variant.productId);
        },

        deleteVariant(variantId) {
            if (!confirm('Supprimer cette variante ?')) return;
            const variant = CORE.db.productVariants.find(v => v.id === variantId);
            if (!variant) return;
            CORE.delete('productVariants', variantId);
            UI.toast('Variante supprimée', 'success');
            ManagerModule.showVariantsModal(variant.productId);
        },

        showAdvancedStockModal(productId) {
            const p = CORE.getProduct(productId);
            if (!p) return;
            const posId = this.state.inventoryPosId || null;
            const currentStock = posId ? CORE.getProductStock(productId, posId) : (p.stock || 0);
            const variants = CORE.getProductVariants(productId);

            UI.modal(`Mouvement stock: ${p.name}`, `
                <div class="space-y-4">
                    ${posId ? `<div class="p-3 bg-blue-50 border border-blue-200 rounded-xl text-xs font-bold text-blue-900">POS sélectionné: Stock indépendant pour cette location</div>` : ''}
                    <div class="flex gap-2 mb-4">
                        <button onclick="document.getElementById('tab_main').style.display='block'; document.getElementById('tab_variants').style.display='none'; this.classList.add('bg-slate-900','text-white'); this.nextElementSibling.classList.remove('bg-slate-900','text-white')" class="flex-1 px-3 py-2 rounded-xl font-black bg-slate-900 text-white transition">Produit</button>
                        <button onclick="document.getElementById('tab_main').style.display='none'; document.getElementById('tab_variants').style.display='block'; this.classList.add('bg-slate-900','text-white'); this.previousElementSibling.classList.remove('bg-slate-900','text-white')" class="flex-1 px-3 py-2 rounded-xl font-black bg-slate-100 text-slate-700 hover:bg-slate-200 transition">Variantes (${variants.length})</button>
                    </div>

                    <div id="tab_main" style="display:block" class="space-y-4">
                        ${UI.select('ms_type','Type',[
                            {value:'in',label:'Entrée (réappro)'} ,
                            {value:'out',label:'Sortie'},
                            {value:'adjust',label:'Ajuster (fixer le stock)'}
                        ], 'in', true)}
                        ${UI.input('ms_qty','Quantité','number','1','ex: 10',true)}
                        ${UI.input('ms_ref','Référence','text','', 'ex: BL-2026-001', false)}
                        ${UI.textarea('ms_note','Note','','facultatif',3)}
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">Stock actuel: <b>${currentStock}</b> • Min: <b>${p.minStock}</b></div>
                    </div>

                    <div id="tab_variants" style="display:none" class="space-y-3">
                        ${variants.length === 0 ? `
                            <div class="p-4 bg-slate-50 text-center rounded-xl text-slate-600 text-sm">
                                Aucune variante. <a href="javascript:GestionnaireModule.showManageVariantsModal(${productId})" class="text-blue-600 font-black">Créer une variante</a>
                            </div>
                        ` : `
                            ${variants.map((v, idx) => {
                                const status = CORE.getVariantStockStatus(v);
                                return `
                                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                                        <div class="flex items-center justify-between mb-3">
                                            <div>
                                                <div class="text-xs text-slate-500">SKU: ${v.sku}</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-sm font-black">${v.stock}</div>
                                                <div class="text-xs text-${status.color}-600 font-bold">${status.label}</div>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <input type="number" id="var_qty_${idx}" value="0" min="0" placeholder="Qté" class="px-2 py-1 border border-slate-200 rounded text-sm font-medium">
                                            <select id="var_type_${idx}" class="px-2 py-1 border border-slate-200 rounded text-sm font-medium">
                                                <option value="set">Définir stock</option>
                                                <option value="in">Ajouter</option>
                                                <option value="out">Retirer</option>
                                            </select>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        `}
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Appliquer', onclick: `ManagerModule.applyAdvancedStock(${productId})`, class: 'px-5 py-2.5 bg-sky-600 text-white font-black rounded-xl hover:bg-sky-700 transition' }
            ]);
        },

        applyAdvancedStock(productId) {
            const p = CORE.getProduct(productId);
            if (!p) return;
            const posId = this.state.inventoryPosId || null;
            const variants = CORE.getProductVariants(productId);

            // Appliquer à la variante si tab_variants est visible
            const tabVariants = document.getElementById('tab_variants');
            if (tabVariants && tabVariants.style.display !== 'none' && variants.length > 0) {
                let anyApplied = false;
                variants.forEach((v, idx) => {
                    const qtyInput = document.getElementById(`var_qty_${idx}`);
                    const typeSelect = document.getElementById(`var_type_${idx}`);

                    if (qtyInput && typeSelect) {
                        const qty = parseInt(qtyInput.value || '0', 10);
                        const type = typeSelect.value;

                        if (qty > 0) {
                            let newStock = v.stock;
                            if (type === 'set') newStock = qty;
                            else if (type === 'in') newStock = v.stock + qty;
                            else if (type === 'out') newStock = Math.max(0, v.stock - qty);

                            CORE.updateProductVariant(v.id, { stock: newStock });
                            anyApplied = true;
                        }
                    }
                });

                if (anyApplied) {
                    UI.closeModal();
                    UI.toast('Stock variantes mis à jour', 'success');
                    App.rerender();
                    return;
                }
            }

            // Sinon appliquer au produit principal
            const type = UI.val('ms_type');
            const qtyRaw = UI.val('ms_qty');
            const qty = Math.abs(parseInt(qtyRaw || '0', 10));
            const ref = UI.val('ms_ref').trim();
            const note = UI.val('ms_note').trim();
            if (!qty && type !== 'adjust') return UI.toast('Quantité invalide', 'warning');

            const currentStock = posId ? CORE.getProductStock(productId, posId) : (p.stock || 0);
            let next = currentStock;
            if (type === 'in') next = currentStock + qty;
            if (type === 'out') next = currentStock - qty;
            if (type === 'adjust') next = Number(qtyRaw || 0);
            if (next < 0) return UI.toast('Stock ne peut pas être négatif', 'error');

            // Update per-POS stock if POS is selected
            if (posId) {
                CORE.setProductStock(productId, posId, next);
            } else {
                CORE.update('products', p.id, { stock: next });
            }

            CORE.recordStockMovement({
                productId: p.id,
                type,
                qty: type === 'adjust' ? next : qty,
                ref: ref || null,
                note: note || 'Mouvement stock (Manager)',
                posId: posId || null
            });
            UI.closeModal();
            UI.toast('Stock mis à jour', 'success');
            App.rerender();
        },

        showMainProductModal(productId) {
            // Modal pour éditer un produit du dépôt principal
            const product = CORE.getProduct(productId);
            if (!product) return;

            const categories = CORE.db.categories.map(c => ({ value: c.id, label: c.name }));

            const html = `
                <div class="space-y-4">
                    ${UI.input('mp_name', 'Nom du produit', 'text', product.name, '', true)}
                    ${UI.select('mp_category', 'Catégorie', categories, product.categoryId, true)}
                    ${UI.input('mp_price', 'Prix', 'number', product.price, '0', true)}
                    ${UI.input('mp_stock', 'Stock (Dépôt Principal)', 'number', product.stock || 0, '0', true)}
                    ${UI.input('mp_minstock', 'Stock Minimum', 'number', product.minStock || 0, '0', true)}
                    ${UI.input('mp_barcode', 'Code-barre', 'text', product.barcode || '', '', false)}
                </div>
            `;

            UI.modal(`📦 Éditer: ${product.name}`, html, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Sauvegarder', onclick: `ManagerModule.saveMainProductModal(${productId})`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        saveMainProductModal(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return;

            // P3-1: Input validation before save
            const name = UI.val('mp_name')?.trim();
            if (!name) return UI.toast('Le nom du produit est obligatoire', 'warning');
            const price = parseFloat(UI.val('mp_price')) || 0;
            if (price <= 0) return UI.toast('Le prix doit être supérieur à 0', 'warning');
            const stock = parseInt(UI.val('mp_stock'), 10);
            if (isNaN(stock) || stock < 0) return UI.toast('Le stock doit être un nombre positif', 'warning');

            product.name = name;
            product.categoryId = parseInt(UI.val('mp_category'), 10);
            product.price = price;
            product.stock = stock;
            product.minStock = parseInt(UI.val('mp_minstock'), 10) || 0;
            product.barcode = UI.val('mp_barcode');

            CORE.save();
            UI.closeModal();
            UI.toast('Produit mis à jour', 'success');
            App.rerender();
        },

        showNewCategoryQuickModal() {
            UI.modal('➕ Créer une Catégorie', `
                <div class="space-y-4">
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
                        Créez rapidement une nouvelle catégorie de produits
                    </div>
                    ${UI.input('quick_cat_name', 'Nom de la catégorie', 'text', '', 'ex: Électronique, Vêtements', true)}
                    ${UI.textarea('quick_cat_desc', 'Description', 'Brève description (optionnel)', 100, false)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Créer', onclick: 'ManagerModule.createCategoryQuick()', class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        createCategoryQuick() {
            const name = UI.val('quick_cat_name')?.trim();
            const desc = UI.val('quick_cat_desc')?.trim() || '';

            if (!name) return UI.toast('Nom requis', 'warning');

            const newCategory = CORE.create('categories', {
                name: name,
                description: desc,
                active: true,
                createdAt: new Date().toISOString()
            });

            UI.closeModal();
            UI.toast(`✅ Catégorie "${name}" créée!`, 'success');

            // Actualiser le modal de réappro
            setTimeout(() => {
                ManagerModule.showBulkRestockModal();
            }, 300);
        },

        showNewSupplierQuickModal() {
            UI.modal('➕ Créer un Fournisseur', `
                <div class="space-y-4">
                    <div class="p-3 bg-green-50 border border-green-200 rounded-lg text-sm text-green-800">
                        Créez rapidement un nouveau fournisseur/usine
                    </div>
                    ${UI.input('quick_supp_name', 'Nom du fournisseur', 'text', '', 'ex: Acme Corp, Usine XYZ', true)}
                    ${UI.input('quick_supp_contact', 'Contact', 'text', '', 'ex: email@fournisseur.com', false)}
                    ${UI.input('quick_supp_phone', 'Téléphone', 'tel', '', 'ex: +212 6XX XXX XXX', false)}
                    ${UI.input('quick_supp_country', 'Pays', 'text', '', 'ex: Maroc, Chine', false)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Créer', onclick: 'ManagerModule.createSupplierQuick()', class: 'px-5 py-2.5 bg-green-600 text-white font-black rounded-xl hover:bg-green-700 transition' }
            ]);
        },

        createSupplierQuick() {
            const name = UI.val('quick_supp_name')?.trim();
            const contact = UI.val('quick_supp_contact')?.trim() || '';
            const phone = UI.val('quick_supp_phone')?.trim() || '';
            const country = UI.val('quick_supp_country')?.trim() || '';

            if (!name) return UI.toast('Nom requis', 'warning');

            const newSupplier = CORE.create('suppliers', {
                name: name,
                email: contact,
                phone: phone,
                country: country,
                active: true,
                createdAt: new Date().toISOString()
            });

            UI.closeModal();
            UI.toast(`✅ Fournisseur "${name}" créé!`, 'success');

            // Actualiser le modal de réappro
            setTimeout(() => {
                ManagerModule.showBulkRestockModal();
            }, 300);
        },

        showBulkRestockModal() {
            const products = CORE.getVisibleProducts() || [];
            const posId = this.state.inventoryPosId || null;
            const pos = posId ? CORE.getPOS(posId) : null;
            const categories = [...new Set(products.map(p => p.categoryId).filter(Boolean))];
            const suppliers = CORE.db.suppliers || [];

            // Déterminer les produits à faible stock
            const lowStockProducts = products.filter(p => {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                return stock <= p.minStock && p.active !== false;
            }).sort((a, b) => {
                const ratioA = (a.stock || 0) / (a.minStock || 1);
                const ratioB = (b.stock || 0) / (b.minStock || 1);
                return ratioA - ratioB;
            });

            const criticalStockProducts = products.filter(p => {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                return stock <= (p.minStock * 0.5);
            });

            const outOfStockProducts = products.filter(p => {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                return stock === 0;
            });

            // Calculer les statistiques
            let totalToOrder = 0;
            let totalCost = 0;
            lowStockProducts.forEach(p => {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                const qty = Math.round((p.minStock || 0) * 2) - stock;
                totalToOrder += qty > 0 ? qty : 0;
                totalCost += qty > 0 ? qty * (p.price || 0) : 0;
            });

            // Statistiques par fournisseur
            const supplierStats = {};
            lowStockProducts.forEach(p => {
                const suppId = p.supplierId || 'none';
                if (!supplierStats[suppId]) {
                    const supplier = suppliers.find(s => s.id === suppId);
                    supplierStats[suppId] = { name: supplier?.name || 'Sans fournisseur', count: 0, qty: 0, cost: 0 };
                }
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                const qty = Math.max(0, Math.round((p.minStock || 0) * 2) - stock);
                supplierStats[suppId].count++;
                supplierStats[suppId].qty += qty;
                supplierStats[suppId].cost += qty * (p.price || 0);
            });

            // Statistiques par catégorie
            const categoryStats = {};
            lowStockProducts.forEach(p => {
                const catId = p.categoryId || 'none';
                if (!categoryStats[catId]) {
                    const cat = CORE.getCategory(catId);
                    categoryStats[catId] = { name: cat?.name || 'Non catégorisé', count: 0 };
                }
                categoryStats[catId].count++;
            });

            // Initialiser la sélection
            if (!window._bulkRestockSelection) {
                window._bulkRestockSelection = lowStockProducts.map(p => p.id);
            }

            const categoryOptions = categories.map(cId => {
                const cat = CORE.db.categories?.find(c => c.id === cId);
                const count = lowStockProducts.filter(p => p.categoryId === cId).length;
                return {value: cId, label: (cat?.name || 'Sans catégorie') + ` (${count})`};
            }).filter(o => o.label.includes('(') && !o.label.includes('(0)'));

            const supplierOptions = suppliers.map(s => {
                const count = lowStockProducts.filter(p => p.supplierId === s.id).length;
                return {value: s.id, label: s.name + ` (${count})`};
            }).filter(o => !o.label.includes('(0)'));

            const stockLevelOptions = [
                {value: 'all', label: `Tous les niveaux (${lowStockProducts.length})`},
                {value: 'critical', label: `?? Critique =50% (${criticalStockProducts.length})`},
                {value: 'outofstock', label: `❌ Rupture totale (${outOfStockProducts.length})`}
            ];

            UI.modal('🔄 Réapprovisionnement en Masse', `
                <div class="space-y-5 max-h-[85vh] overflow-y-auto">
                    <!-- En-tête avec infos POS -->
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-5 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-xl font-black">📦 Réappro Intelligente</div>
                                <div class="text-indigo-200 text-sm mt-1">${pos ? pos.name : 'Tous les points de vente'}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-black">${lowStockProducts.length}</div>
                                <div class="text-indigo-200 text-xs">produits en alerte</div>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs Principaux -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border border-blue-200">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                                    <i data-lucide="check-square" class="w-4 h-4 text-white"></i>
                                </div>
                                <span class="text-xs font-black text-blue-600 uppercase">Sélectionnés</span>
                            </div>
                            <div id="bulk_selected_count" class="text-3xl font-black text-blue-900">${window._bulkRestockSelection.length}</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-xl border border-amber-200">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 bg-amber-500 rounded-lg flex items-center justify-center">
                                    <i data-lucide="package-plus" class="w-4 h-4 text-white"></i>
                                </div>
                                <span class="text-xs font-black text-amber-600 uppercase">À Commander</span>
                            </div>
                            <div id="bulk_order_display" class="text-3xl font-black text-amber-900">${totalToOrder}</div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-xl border border-emerald-200">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center">
                                    <i data-lucide="wallet" class="w-4 h-4 text-white"></i>
                                </div>
                                <span class="text-xs font-black text-emerald-600 uppercase">Budget Estimé</span>
                            </div>
                            <div id="bulk_cost_display" class="text-2xl font-black text-emerald-900">${CORE.formatPrice(totalCost)}</div>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-xl border border-red-200">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center">
                                    <i data-lucide="alert-octagon" class="w-4 h-4 text-white"></i>
                                </div>
                                <span class="text-xs font-black text-red-600 uppercase">Critiques</span>
                            </div>
                            <div class="text-3xl font-black text-red-900">${criticalStockProducts.length}</div>
                        </div>
                    </div>

                    <!-- Répartition par fournisseur -->
                    ${Object.keys(supplierStats).length > 0 ? `
                    <div class="bg-white rounded-xl border border-slate-200 p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="font-black text-slate-900 flex items-center gap-2">
                                <i data-lucide="truck" class="w-5 h-5 text-slate-600"></i>
                                Répartition par Fournisseur
                            </div>
                            <span class="text-xs text-slate-500">${Object.keys(supplierStats).length} fournisseur(s)</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            ${Object.entries(supplierStats).sort((a, b) => b[1].cost - a[1].cost).slice(0, 6).map(([id, stat]) => `
                                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition cursor-pointer" onclick="document.getElementById('bulk_supplier').value='${id !== 'none' ? id : ''}';document.getElementById('bulk_supplier').dispatchEvent(new Event('change'))">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center text-white text-xs font-black">${stat.count}</div>
                                        <div>
                                            <div class="font-bold text-slate-900 text-sm">${stat.name}</div>
                                            <div class="text-xs text-slate-500">${stat.qty} unités</div>
                                        </div>
                                    </div>
                                    <div class="font-black text-emerald-600 text-sm">${CORE.formatPrice(stat.cost)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Filtres avancés -->
                    <div class="bg-slate-50 rounded-xl border border-slate-200 p-4">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="filter" class="w-5 h-5 text-slate-600"></i>
                            <span class="font-black text-slate-900">Filtres & Recherche</span>
                        </div>

                        <!-- Recherche -->
                        <div class="relative mb-4">
                            <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                            <input type="text" id="bulk_product_search" placeholder="Rechercher par nom, code, code-barres..." class="pl-10 pr-4 py-3 w-full rounded-xl border border-slate-200 font-medium bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        </div>

                        <!-- Grille de filtres -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-black text-slate-600 uppercase mb-2 block">Catégorie</label>
                                <select id="bulk_category" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 text-sm font-bold bg-white">
                                    <option value="">📁 Toutes les catégories</option>
                                    ${categoryOptions.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600 uppercase mb-2 block">Fournisseur</label>
                                <select id="bulk_supplier" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 text-sm font-bold bg-white">
                                    <option value="">🏭 Tous les fournisseurs</option>
                                    ${supplierOptions.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600 uppercase mb-2 block">Niveau Stock</label>
                                <select id="bulk_stock_level" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 text-sm font-bold bg-white">
                                    ${stockLevelOptions.map(o => `<option value="${o.value}">${o.label}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Paramètres de réapprovisionnement -->
                    <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-200 p-4">
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="settings" class="w-5 h-5 text-amber-600"></i>
                            <span class="font-black text-slate-900">Paramètres de Réappro</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="text-xs font-black text-slate-600 uppercase mb-2 block">Multiplicateur Stock Min</label>
                                <div class="flex items-center gap-2">
                                    <button onclick="let i=document.getElementById('bulk_multiplier');i.value=Math.max(1,parseFloat(i.value)-0.5);i.dispatchEvent(new Event('input'))" class="w-10 h-10 bg-white border border-slate-200 rounded-xl font-black text-lg hover:bg-slate-50">-</button>
                                    <input type="number" id="bulk_multiplier" value="2" min="1" max="10" step="0.5" class="flex-1 px-4 py-2.5 rounded-xl border border-slate-200 font-black text-center text-lg bg-white" oninput="ManagerModule.updateBulkRestockPreview()">
                                    <button onclick="let i=document.getElementById('bulk_multiplier');i.value=Math.min(10,parseFloat(i.value)+0.5);i.dispatchEvent(new Event('input'))" class="w-10 h-10 bg-white border border-slate-200 rounded-xl font-black text-lg hover:bg-slate-50">+</button>
                                </div>
                                <div class="text-xs text-amber-600 mt-1 text-center">Stock cible = Min × <span id="mult_display">2</span></div>
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600 uppercase mb-2 block">Référence Commande</label>
                                <input type="text" id="bulk_ref" placeholder="Auto-généré si vide" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-white">
                            </div>
                            <div>
                                <label class="text-xs font-black text-slate-600 uppercase mb-2 block">Options</label>
                                <label class="flex items-center gap-3 p-3 bg-white rounded-xl border border-slate-200 cursor-pointer hover:bg-slate-50">
                                    <input type="checkbox" id="bulk_auto_purchase" checked class="w-5 h-5 rounded">
                                    <div>
                                        <div class="font-bold text-slate-900 text-sm">Auto-créer commandes</div>
                                        <div class="text-xs text-slate-500">Génère les bons de commande</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Liste des produits -->
                    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                            <div class="font-black text-slate-900 flex items-center gap-2">
                                <i data-lucide="list-checks" class="w-5 h-5"></i>
                                Sélection des Produits
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="ManagerModule.bulkSelectAll(true)" class="px-3 py-1.5 bg-emerald-100 text-emerald-700 rounded-lg text-xs font-black hover:bg-emerald-200 transition flex items-center gap-1">
                                    <i data-lucide="check-check" class="w-3 h-3"></i> Tout
                                </button>
                                <button onclick="ManagerModule.bulkSelectAll(false)" class="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-xs font-black hover:bg-red-200 transition flex items-center gap-1">
                                    <i data-lucide="x" class="w-3 h-3"></i> Aucun
                                </button>
                                <button onclick="ManagerModule.bulkSelectCritical()" class="px-3 py-1.5 bg-amber-100 text-amber-700 rounded-lg text-xs font-black hover:bg-amber-200 transition flex items-center gap-1">
                                    <i data-lucide="alert-triangle" class="w-3 h-3"></i> Critiques
                                </button>
                            </div>
                        </div>

                        <div id="bulk_product_list" class="divide-y divide-slate-100 max-h-[400px] overflow-y-auto">
                            ${lowStockProducts.length === 0 ? `
                                <div class="p-8 text-center text-slate-400">
                                    <i data-lucide="package-check" class="w-16 h-16 mx-auto mb-4 opacity-30"></i>
                                    <div class="font-bold text-lg">Tous les stocks sont OK! 🎉</div>
                                    <div class="text-sm">Aucun produit sous le seuil minimum</div>
                                </div>
                            ` : lowStockProducts.map(p => {
                                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                                const supplier = suppliers.find(s => s.id === p.supplierId);
                                const category = CORE.getCategory(p.categoryId);
                                const minStock = p.minStock || 0;
                                const nextStock = Math.round(minStock * 2);
                                const toOrder = Math.max(0, nextStock - stock);
                                const estimatedCost = toOrder * (p.price || 0);
                                const stockPercent = minStock > 0 ? Math.round((stock / minStock) * 100) : 0;
                                const isCritical = stockPercent <= 50;
                                const isOutOfStock = stock === 0;

                                return `
                                    <div class="p-4 hover:bg-slate-50 transition group" data-product-item="${p.id}" data-product-name="${(p.name || '').toLowerCase()}" data-product-code="${(p.code || '').toLowerCase()}" data-product-barcode="${(p.barcode || '').toLowerCase()}" data-category="${p.categoryId || ''}" data-supplier="${p.supplierId || ''}" data-stock-percent="${stockPercent}">
                                        <div class="flex items-start gap-4">
                                            <div class="pt-1">
                                                <input type="checkbox" data-bulk-check data-product-id="${p.id}" data-order-qty="${toOrder}" data-order-cost="${estimatedCost}" data-is-critical="${isCritical}" ${window._bulkRestockSelection?.includes(p.id) ? 'checked' : ''} class="w-5 h-5 rounded-lg border-2 border-slate-300 checked:bg-indigo-600 checked:border-indigo-600 cursor-pointer">
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="font-black text-slate-900">${p.name}</span>
                                                    ${isOutOfStock ? '<span class="px-2 py-0.5 bg-red-600 text-white rounded text-xs font-black">RUPTURE</span>' :
                                                      isCritical ? '<span class="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs font-black">CRITIQUE</span>' :
                                                      '<span class="px-2 py-0.5 bg-amber-100 text-amber-700 rounded text-xs font-black">BAS</span>'}
                                                </div>
                                                <div class="flex flex-wrap gap-2 text-xs">
                                                    ${p.barcode ? `<span class="px-2 py-1 bg-slate-100 rounded text-slate-600">📊 ${p.barcode}</span>` : ''}
                                                    ${category ? `<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded font-bold">${category.name}</span>` : ''}
                                                    ${supplier ? `<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded font-bold">🏭 ${supplier.name}</span>` : ''}
                                                </div>
                                            </div>
                                            <div class="text-right flex-shrink-0">
                                                <div class="flex items-center gap-3 mb-2">
                                                    <div class="text-center">
                                                        <div class="text-xs text-slate-500">Actuel</div>
                                                        <div class="text-xl font-black ${isCritical ? 'text-red-600' : 'text-amber-600'}">${stock}</div>
                                                    </div>
                                                    <div class="text-slate-300">→</div>
                                                    <div class="text-center">
                                                        <div class="text-xs text-slate-500">Cible</div>
                                                        <div class="text-xl font-black text-emerald-600" data-target-stock="${nextStock}">${nextStock}</div>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <div class="w-24 h-2 bg-slate-200 rounded-full overflow-hidden">
                                                        <div class="h-full ${isCritical ? 'bg-red-500' : 'bg-amber-500'} rounded-full" style="width: ${Math.min(100, stockPercent)}%"></div>
                                                    </div>
                                                    <span class="text-xs font-black ${isCritical ? 'text-red-600' : 'text-amber-600'}">${stockPercent}%</span>
                                                </div>
                                            </div>
                                            <div class="flex-shrink-0 w-28 text-right">
                                                <div class="px-3 py-2 bg-emerald-100 rounded-xl">
                                                    <div class="text-xs text-emerald-600 font-bold">À commander</div>
                                                    <div class="text-lg font-black text-emerald-700" data-order-qty-display>+${toOrder}</div>
                                                </div>
                                                <div class="text-xs text-slate-500 mt-1">${CORE.formatPrice(estimatedCost)}</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>

                        ${lowStockProducts.length > 20 ? `
                        <div class="p-3 bg-slate-50 border-t border-slate-100 text-center text-xs text-slate-500">
                            Affichage de ${Math.min(lowStockProducts.length, 50)} produits sur ${lowStockProducts.length}
                        </div>
                        ` : ''}
                    </div>

                    <!-- Résumé final -->
                    <div class="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-2xl p-5 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-black text-lg">📋 Résumé de la Commande</div>
                                <div class="text-emerald-100 text-sm mt-1">Vérifiez avant de valider</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-emerald-200 uppercase">Coût total estimé</div>
                                <div id="bulk_total_summary" class="text-3xl font-black">${CORE.formatPrice(totalCost)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal(); window._bulkRestockSelection = null;' },
                { label: '🚀 Appliquer Réapprovisionnement', onclick: 'ManagerModule.applyBulkRestock()', class: 'px-6 py-3 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-black rounded-xl hover:from-emerald-600 hover:to-teal-700 transition shadow-lg' }
            ]);

            // Ajouter les event listeners pour mettre à jour la sélection
            setTimeout(() => {
                // Mise à jour du compteur et coût total en temps réel
                const updateStats = () => {
                    const mult = parseFloat(document.getElementById('bulk_multiplier')?.value || 2);
                    const selected = Array.from(document.querySelectorAll('[data-bulk-check]:checked'));

                    let totalQty = 0;
                    let totalCost = 0;

                    selected.forEach(c => {
                        const productId = parseInt(c.dataset.productId);
                        const product = products.find(p => p.id === productId);
                        if (product) {
                            const stock = posId ? CORE.getProductStock(product.id, posId) : (product.stock || 0);
                            const targetStock = Math.round((product.minStock || 0) * mult);
                            const qty = Math.max(0, targetStock - stock);
                            totalQty += qty;
                            totalCost += qty * (product.price || 0);
                        }
                    });

                    const selectedCountEl = document.getElementById('bulk_selected_count');
                    if (selectedCountEl) selectedCountEl.textContent = selected.length;

                    const orderDiv = document.getElementById('bulk_order_display');
                    if (orderDiv) orderDiv.textContent = totalQty;

                    const costDiv = document.getElementById('bulk_cost_display');
                    if (costDiv) costDiv.textContent = CORE.formatPrice(totalCost);

                    const summaryDiv = document.getElementById('bulk_total_summary');
                    if (summaryDiv) summaryDiv.textContent = CORE.formatPrice(totalCost);

                    const multDisplay = document.getElementById('mult_display');
                    if (multDisplay) multDisplay.textContent = mult;

                    // Sauvegarder la sélection
                    window._bulkRestockSelection = selected.map(c => parseInt(c.dataset.productId));
                };

                // Event listener pour les checkboxes
                document.querySelectorAll('[data-bulk-check]').forEach(checkbox => {
                    checkbox.addEventListener('change', updateStats);
                });

                // Event listener pour le multiplicateur
                const multInput = document.getElementById('bulk_multiplier');
                if (multInput) {
                    multInput.addEventListener('input', () => {
                        const mult = parseFloat(multInput.value || 2);
                        // Mettre à jour les quantités affichées pour chaque produit
                        document.querySelectorAll('[data-product-item]').forEach(item => {
                            const productId = parseInt(item.dataset.productItem);
                            const product = products.find(p => p.id === productId);
                            if (product) {
                                const stock = posId ? CORE.getProductStock(product.id, posId) : (product.stock || 0);
                                const targetStock = Math.round((product.minStock || 0) * mult);
                                const qty = Math.max(0, targetStock - stock);
                                const cost = qty * (product.price || 0);

                                const qtyDisplay = item.querySelector('[data-order-qty-display]');
                                if (qtyDisplay) qtyDisplay.textContent = '+' + qty;

                                const targetDisplay = item.querySelector('[data-target-stock]');
                                if (targetDisplay) targetDisplay.textContent = targetStock;

                                const checkbox = item.querySelector('[data-bulk-check]');
                                if (checkbox) {
                                    checkbox.dataset.orderQty = qty;
                                    checkbox.dataset.orderCost = cost;
                                }
                            }
                        });
                        updateStats();
                    });
                }

                // Recherche en temps réel
                const searchInput = document.getElementById('bulk_product_search');
                const categorySelect = document.getElementById('bulk_category');
                const supplierSelect = document.getElementById('bulk_supplier');
                const stockLevelSelect = document.getElementById('bulk_stock_level');

                // Fonction pour appliquer tous les filtres
                const applyFilters = () => {
                    const query = (searchInput?.value || '').toLowerCase();
                    const catId = categorySelect?.value || '';
                    const suppId = supplierSelect?.value || '';
                    const stockLevel = stockLevelSelect?.value || 'all';

                    document.querySelectorAll('[data-product-item]').forEach(item => {
                        const stockPercent = parseInt(item.dataset.stockPercent || 100);
                        const isOutOfStock = stockPercent === 0;
                        const isCritical = stockPercent <= 50;

                        const matchesSearch = !query ||
                            (item.dataset.productName || '').includes(query) ||
                            (item.dataset.productCode || '').includes(query) ||
                            (item.dataset.productBarcode || '').includes(query);

                        const matchesCategory = !catId || item.dataset.category === catId;
                        const matchesSupplier = !suppId || item.dataset.supplier === suppId;

                        let matchesStockLevel = true;
                        if (stockLevel === 'critical') matchesStockLevel = isCritical;
                        else if (stockLevel === 'outofstock') matchesStockLevel = isOutOfStock;

                        const show = matchesSearch && matchesCategory && matchesSupplier && matchesStockLevel;
                        item.style.display = show ? '' : 'none';
                    });
                };

                if (searchInput) searchInput.addEventListener('input', applyFilters);
                if (categorySelect) categorySelect.addEventListener('change', applyFilters);
                if (supplierSelect) supplierSelect.addEventListener('change', applyFilters);
                if (stockLevelSelect) stockLevelSelect.addEventListener('change', applyFilters);

                // Appel initial pour mettre à jour les stats
                updateStats();
                lucide.createIcons();
            }, 50);
        },

        // Fonctions helper pour la sélection en masse
        bulkSelectAll(selectAll) {
            document.querySelectorAll('[data-product-item]').forEach(item => {
                if (item.style.display !== 'none') {
                    const checkbox = item.querySelector('[data-bulk-check]');
                    if (checkbox) {
                        checkbox.checked = selectAll;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                }
            });
        },

        bulkSelectCritical() {
            document.querySelectorAll('[data-product-item]').forEach(item => {
                if (item.style.display !== 'none') {
                    const checkbox = item.querySelector('[data-bulk-check]');
                    const isCritical = checkbox?.dataset.isCritical === 'true';
                    if (checkbox) {
                        checkbox.checked = isCritical;
                        checkbox.dispatchEvent(new Event('change'));
                    }
                }
            });
        },

        updateBulkRestockPreview() {
            const multInput = document.getElementById('bulk_multiplier');
            if (multInput) {
                multInput.dispatchEvent(new Event('input'));
            }
        },

        applyBulkRestock() {
            const mult = Utils.clamp(parseFloat(UI.val('bulk_multiplier') || '2'), 1, 50);
            const ref = UI.val('bulk_ref').trim() || `BULK-${Utils.uid('BL')}`;
            const autoPurchase = document.getElementById('bulk_auto_purchase')?.checked;
            const posId = this.state.inventoryPosId || null;

            // Récupérer les produits sélectionnés
            const selectedIds = Array.from(document.querySelectorAll('[data-bulk-check]:checked')).map(c => parseInt(c.dataset.productId));
            if (selectedIds.length === 0) return UI.toast('Aucun produit sélectionné', 'warning');

            const products = CORE.getVisibleProducts() || [];
            const targets = products.filter(p => selectedIds.includes(p.id));

            let totalQuantity = 0;
            let totalCost = 0;
            const orders = [];

            targets.forEach(p => {
                const currentStock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                const targetStock = Math.max(currentStock, Math.round(Number(p.minStock || 0) * mult));
                const delta = targetStock - currentStock;
                if (delta > 0) {
                    // Update per-POS stock if selected
                    if (posId) {
                        CORE.setProductStock(p.id, posId, targetStock);
                    } else {
                        CORE.update('products', p.id, { stock: targetStock });
                    }

                    CORE.recordStockMovement({
                        productId: p.id,
                        type: 'in',
                        qty: delta,
                        ref,
                        note: `Réappro masse (×${mult})`,
                        posId: posId || null
                    });

                    totalQuantity += delta;
                    const itemCost = delta * (p.price || 0);
                    totalCost += itemCost;

                    // Préparer les données pour les commandes d'achat
                    if (autoPurchase && p.supplierId) {
                        orders.push({
                            productId: p.id,
                            supplierId: p.supplierId,
                            qty: delta,
                            unitPrice: p.price || 0,
                            totalCost: itemCost
                        });
                    }
                }
            });

            // Créer les commandes d'achat si demandé
            if (autoPurchase && orders.length > 0) {
                orders.forEach(order => {
                    const poRef = `PO-${Utils.uid('PO').substring(0,6)}`;
                    const po = CORE.create('purchaseOrders', {
                        reference: poRef,
                        supplierId: order.supplierId,
                        productId: order.productId,
                        qty: order.qty,
                        unitPrice: order.unitPrice,
                        transportPrice: 0,
                        totalCost: order.totalCost,
                        status: 'pending',
                        note: `Auto-générée via réappro masse (${ref})`,
                        createdAt: new Date().toISOString()
                    });

                    // Créer l'enregistrement de dépense
                    const supplier = CORE.db.suppliers?.find(s => s.id === order.supplierId);
                    const product = CORE.getVisibleProducts().find(p => p.id === order.productId);
                    CORE.create('expenses', {
                        reference: poRef,
                        type: 'purchase_order',
                        description: `Réappro masse - ${product?.name || 'Produit'} chez ${supplier?.name || 'Fournisseur'}`,
                        amount: order.totalCost,
                        supplier: supplier?.name || 'Non spécifié',
                        category: 'réapprovisionnement',
                        status: 'pending',
                        purchaseOrderId: po.id,
                        createdAt: new Date().toISOString()
                    });
                });
            }

            UI.closeModal();
            window._bulkRestockSelection = null;
            UI.toast(`✅ ${targets.length} produits réapprovionnés | ${totalQuantity} unités | ${CORE.formatPrice(totalCost)}`, 'success');
            App.rerender();
        },

        analyzeRestockingPatterns(posId = null) {
            const rawProducts = CORE.getVisibleProducts() || [];
            const rawMovements = CORE.getVisibleStockMovements() || [];
            const rawPurchaseOrders = CORE.db.purchaseOrders || [];

            const numericPosId = posId === null || posId === undefined ? null : Number(posId);
            const targetPosId = numericPosId === null || Number.isNaN(numericPosId) ? null : numericPosId;

            const products = rawProducts.filter(product => this.productBelongsToPos(product, targetPosId));

            const touchesPos = (movement) => {
                if (!targetPosId) return true;
                const basePos = Number(movement.posId);
                const fromPos = Number(movement.fromPosId);
                const toPos = Number(movement.toPosId);
                return basePos === targetPosId || fromPos === targetPosId || toPos === targetPosId;
            };

            const relevantMovements = rawMovements.filter(touchesPos);

            const purchaseOrders = rawPurchaseOrders.filter(po => {
                if (!targetPosId) return true;
                if (po.posId === undefined || po.posId === null) return false;
                return Number(po.posId) === targetPosId;
            });

            const getStock = (product) => targetPosId ? CORE.getProductStock(product.id, targetPosId) : Number(product.stock || 0);
            const getPrice = (product) => targetPosId ? CORE.getProductPrice(product.id, targetPosId) : Number(product.price || 0);
            const getMin = (product) => Number(product.minStock || 0);

            const totalStock = products.reduce((sum, p) => sum + getStock(p), 0);

            const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
            const thirtyDaysAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;

            const movementDate = (movement) => new Date(movement.createdAt || movement.timestamp || movement.loggedAt || movement.date || Date.now());
            const movementQty = (movement) => Number(movement.qty ?? movement.quantity ?? 0);

            const recentMovementsIn = relevantMovements
                .filter(m => m.type === 'in' && movementDate(m).getTime() >= sevenDaysAgo)
                .reduce((sum, m) => sum + movementQty(m), 0);

            const recentMovementsOut = relevantMovements
                .filter(m => m.type === 'out' && movementDate(m).getTime() >= sevenDaysAgo)
                .reduce((sum, m) => sum + movementQty(m), 0);

            const topMovingProducts = products
                .map(product => {
                    const windowMovements = relevantMovements.filter(m => m.productId === product.id && movementDate(m).getTime() >= thirtyDaysAgo);
                    const inQty = windowMovements.filter(m => m.type === 'in').reduce((sum, m) => sum + movementQty(m), 0);
                    const outQty = windowMovements.filter(m => m.type === 'out').reduce((sum, m) => sum + movementQty(m), 0);
                    const currentStock = getStock(product);
                    return {
                        product,
                        inQty,
                        outQty,
                        netFlow: outQty - inQty,
                        turns: currentStock > 0 ? outQty / currentStock : outQty,
                        currentStock
                    };
                })
                .sort((a, b) => (b.turns || 0) - (a.turns || 0))
                .slice(0, 10);

            const totalInventoryValue = products.reduce((sum, product) => sum + getStock(product) * getPrice(product), 0);

            const analysis = {
                totalProducts: products.length,
                lowStockProducts: products.filter(p => getStock(p) <= getMin(p)).length,
                criticalStockProducts: products.filter(p => getStock(p) <= (getMin(p) * 0.5)).length,
                overStockProducts: products.filter(p => getStock(p) > (getMin(p) * 3)).length,
                averageStockLevel: products.length > 0 ? Math.round(totalStock / products.length) : 0,
                totalInventoryValue,
                recentMovementsIn,
                recentMovementsOut,
                topMovingProducts,
                supplierStats: (CORE.db.suppliers || []).map(supplier => {
                    const supplierProducts = products.filter(p => p.supplierId === supplier.id);
                    const supplierOrders = purchaseOrders.filter(po => po.supplierId === supplier.id);
                    return {
                        supplier,
                        productsCount: supplierProducts.length,
                        pendingOrders: supplierOrders.filter(po => po.status !== 'received').length,
                        totalSpent: supplierOrders.reduce((sum, po) => sum + (po.totalCost || 0), 0)
                    };
                })
            };

            return analysis;
        },

        showStockTransferModal(sourcePosId) {
            const products = CORE.getVisibleProducts() || [];
            const posList = CORE.db.pointsOfSale || [];

            if (posList.length < 2) {
                return UI.toast('Vous devez avoir au moins 2 POS pour transférer du stock', 'warning');
            }

            // Déterminer le POS source (celui qui initie le transfert)
            let sourcePos = null;
            const currentUserPosId = CORE.state.currentUser?.pos;
            if (sourcePosId) {
                sourcePos = CORE.getPOS(sourcePosId) || null;
            }
            if (!sourcePos && currentUserPosId) {
                sourcePos = CORE.getPOS(currentUserPosId) || null;
            }
            if (!sourcePos) {
                sourcePos = posList[0];
            }

            // Calculer les stats globales
            const stockStats = {};
            posList.forEach(pos => {
                const posProducts = products.filter(p => CORE.getProductStock(p.id, pos.id) > 0);
                const totalStock = posProducts.reduce((sum, p) => sum + (CORE.getProductStock(p.id, pos.id) || 0), 0);
                const totalValue = posProducts.reduce((sum, p) => sum + ((CORE.getProductStock(p.id, pos.id) || 0) * (p.price || 0)), 0);
                const criticalCount = posProducts.filter(p => (CORE.getProductStock(p.id, pos.id) || 0) <= (p.minStock || 0)).length;
                stockStats[pos.id] = { totalStock, totalValue, criticalCount, productCount: posProducts.length };
            });

            // Suggestions intelligentes filtrées pour ce POS source
            const suggestions = [];
            posList.forEach((destPos) => {
                if (sourcePos.id === destPos.id) return;
                products.forEach(p => {
                    const srcStock = CORE.getProductStock(p.id, sourcePos.id) || 0;
                    const dstStock = CORE.getProductStock(p.id, destPos.id) || 0;
                    const minStock = p.minStock || 0;
                    const destTarget = Math.max(minStock * 2, minStock + 20);
                    const destDeficit = Math.max(0, destTarget - dstStock);

                    if (srcStock <= 0 || destDeficit <= 0) return;

                    const suggestedQty = Math.min(srcStock, destDeficit);
                    suggestions.push({
                        productId: p.id,
                        productName: p.name,
                        sourcePosId: sourcePos.id,
                        sourcePosName: sourcePos.name,
                        destPosId: destPos.id,
                        destPosName: destPos.name,
                        sourceStock: srcStock,
                        destStock: dstStock,
                        minStock,
                        suggestedQty,
                        severity: dstStock <= Math.max(1, minStock * 0.5) ? 'critical' : 'low'
                    });
                });
            });

            suggestions.sort((a, b) => {
                if (a.severity !== b.severity) return a.severity === 'critical' ? -1 : 1;
                return b.suggestedQty - a.suggestedQty;
            });

            const topSuggestions = suggestions.slice(0, 5);
            const defaultSourcePos = sourcePos;
            const defaultDestPos = posList.find(p => p.id !== defaultSourcePos.id) || posList[0];
            const defaultProduct = products[0];
            const defaultSuggestion = topSuggestions[0] || null;

            const html = `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="p-4 rounded-2xl bg-blue-50 border border-blue-200">
                            <div class="text-xs font-black text-blue-600 uppercase">Stock total en POS</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${products.reduce((sum, p) => sum + (CORE.getProductStock(p.id, defaultSourcePos.id) || 0), 0).toLocaleString('fr-FR')}</div>
                            <div class="text-[11px] text-blue-700">Unités disponibles</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-200">
                            <div class="text-xs font-black text-emerald-600 uppercase">Valeur estimée</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${CORE.formatPrice(products.reduce((sum, p) => sum + ((CORE.getProductStock(p.id, defaultSourcePos.id) || 0) * (p.price || 0)), 0))}</div>
                            <div class="text-[11px] text-emerald-700">Stock valorisé</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-amber-50 border border-amber-200">
                            <div class="text-xs font-black text-amber-600 uppercase">Opportunités</div>
                            <div class="text-2xl font-black text-amber-900 mt-1">${suggestions.length}</div>
                            <div class="text-[11px] text-amber-700">Transferts suggérés</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                        <div class="space-y-4">
                            <div class="p-5 bg-white rounded-3xl border border-slate-200 space-y-4">
                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">POS Source (qui cède)</label>
                                    <select id="tf_source_pos" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-blue-500">
                                        ${posList.map(pos => `
                                            <option value="${pos.id}" ${pos.id === defaultSourcePos.id ? 'selected' : ''}>
                                                ${pos.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Produit à transférer</label>
                                    <select id="tf_product" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-blue-500">
                                        ${products.filter(p => (CORE.getProductStock(p.id, defaultSourcePos.id) || 0) > 0).map(p => `
                                            <option value="${p.id}" ${p.id === defaultProduct?.id ? 'selected' : ''}>
                                                ${p.name} • Stock: ${CORE.getProductStock(p.id, defaultSourcePos.id) || 0}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">POS Destination (qui reçoit)</label>
                                    <select id="tf_dest_pos" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-blue-500">
                                        ${posList.filter(pos => pos.id !== defaultSourcePos.id).map(pos => `
                                            <option value="${pos.id}" ${pos.id === defaultDestPos.id ? 'selected' : ''}>
                                                ${pos.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-3 text-center text-sm">
                                    <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                        <div class="text-xs font-bold text-slate-500 uppercase">Stock source</div>
                                        <div id="tf_summary_source" class="text-xl font-black text-slate-900">0</div>
                                    </div>
                                    <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                        <div class="text-xs font-bold text-slate-500 uppercase">Stock dest.</div>
                                        <div id="tf_summary_dest" class="text-xl font-black text-slate-900">0</div>
                                    </div>
                                </div>

                                <div class="p-3 rounded-2xl bg-emerald-50 border border-emerald-200">
                                    <div class="flex items-center justify-between text-sm font-bold text-emerald-700">
                                        <span>Stock source après transfert</span>
                                        <span id="tf_summary_after">0</span>
                                    </div>
                                </div>

                                <div class="flex flex-wrap gap-2">
                                    <button data-tf-set="suggested" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700 transition">Suggestion IA</button>
                                    <button data-tf-set="half" class="px-3 py-2 rounded-xl bg-blue-600 text-white text-xs font-black hover:bg-blue-700 transition">50%</button>
                                    <button data-tf-set="+25" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300 transition">+25</button>
                                    <button data-tf-set="+50" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300 transition">+50</button>
                                    <button data-tf-set="clear" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-100 transition">Réinitialiser</button>
                                </div>

                                <div class="grid grid-cols-2 gap-3 items-end">
                                    <div>
                                        <label class="block text-xs font-black text-slate-500 uppercase mb-2">Quantité à transférer</label>
                                        <input id="tf_qty" type="number" min="0" value="0" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-black text-lg text-center bg-white focus:ring-2 focus:ring-purple-500">
                                        <div id="tf_warning" class="mt-2 text-xs font-bold text-red-600 hidden">⚠️ Stock insuffisant</div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-black text-slate-500 uppercase mb-2">Référence</label>
                                        <input id="tf_ref" type="text" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-slate-50" placeholder="Auto-généré" readonly>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Motif du transfert</label>
                                    <textarea id="tf_reason" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-white" rows="2" placeholder="Ex: Rééquilibrage stocks, réappro..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div class="p-5 bg-white rounded-3xl border border-slate-200">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="font-black text-slate-900 text-sm">🎯 Transferts suggérés</div>
                                    <span class="text-xs text-slate-500 font-bold">${topSuggestions.length} opportunités</span>
                                </div>
                                ${topSuggestions.length === 0 ? `
                                    <div class="p-4 rounded-2xl bg-slate-50 text-sm text-slate-500 text-center">
                                        Aucune opportunité de transfert détectée.
                                    </div>
                                ` : `
                                    <div class="space-y-2">
                                        ${topSuggestions.map(s => `
                                            <div class="p-3 rounded-2xl border ${s.severity === 'critical' ? 'border-red-200 bg-red-50' : 'border-amber-200 bg-amber-50'} flex items-center justify-between gap-3">
                                                <div>
                                                    <div class="font-black text-slate-900 text-sm">${s.productName}</div>
                                                    <div class="text-xs text-slate-600">${s.sourcePosName} → ${s.destPosName}</div>
                                                    <div class="text-xs font-bold text-slate-500">Suggestion: ${s.suggestedQty} unités</div>
                                                </div>
                                                <button data-tf-suggestion data-source-id="${s.sourcePosId}" data-dest-id="${s.destPosId}" data-product-id="${s.productId}" data-suggested-qty="${s.suggestedQty}" class="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-xs font-black hover:bg-slate-800 transition">Appliquer</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>

                            <div class="p-5 bg-white rounded-3xl border border-slate-200">
                                <div class="font-black text-slate-900 text-sm mb-3">📊 POS Destinations possibles</div>
                                <div class="space-y-2 text-sm">
                                    ${posList.filter(pos => pos.id !== defaultSourcePos.id).map(pos => {
                                        const stats = stockStats[pos.id] || {};
                                        return `
                                            <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                                <div class="flex items-center justify-between mb-1">
                                                    <span class="font-black text-slate-900">${pos.name}</span>
                                                    <span class="text-xs font-bold text-slate-600">${stats.totalStock || 0} unités</span>
                                                </div>
                                                <div class="text-xs text-slate-600">${stats.productCount} produits • ${stats.criticalCount} critique(s)</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            UI.modal('🔄 Transférer Stock entre POS', html, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Transférer', onclick: 'ManagerModule.executeStockTransfer()', class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition' }
            ]);

            setTimeout(() => {
                const modalEl = document.querySelector('#modalContainer .slide-up');
                if (modalEl) {
                    modalEl.classList.remove('max-w-lg');
                    modalEl.classList.add('max-w-5xl');
                }

                const sourcePosSelect = document.getElementById('tf_source_pos');
                const destPosSelect = document.getElementById('tf_dest_pos');
                const productSelect = document.getElementById('tf_product');
                const qtyInput = document.getElementById('tf_qty');
                const refInput = document.getElementById('tf_ref');
                const summarySource = document.getElementById('tf_summary_source');
                const summaryDest = document.getElementById('tf_summary_dest');
                const summaryAfter = document.getElementById('tf_summary_after');
                const warning = document.getElementById('tf_warning');

                const updateSummary = () => {
                    const productId = parseInt(productSelect.value, 10);
                    const sourceId = parseInt(sourcePosSelect.value, 10);
                    const destId = parseInt(destPosSelect.value, 10);
                    const qty = parseInt(qtyInput.value || 0, 10);

                    const sourceStock = CORE.getProductStock(productId, sourceId) || 0;
                    const destStock = CORE.getProductStock(productId, destId) || 0;
                    const newSourceStock = Math.max(0, sourceStock - qty);

                    summarySource.textContent = sourceStock;
                    summaryDest.textContent = destStock;
                    summaryAfter.textContent = `${newSourceStock} unités`;

                    warning.classList.toggle('hidden', qty <= sourceStock);
                };

                const updateDestPos = () => {
                    const sourceId = parseInt(sourcePosSelect.value, 10);

                    // Rebuild destination options excluding selected source
                    const currentDestId = parseInt(destPosSelect.value, 10);
                    destPosSelect.innerHTML = '';
                    (CORE.db.pointsOfSale || []).filter(pos => pos.id !== sourceId).forEach(pos => {
                        const opt = document.createElement('option');
                        opt.value = pos.id;
                        opt.textContent = pos.name;
                        if (pos.id === currentDestId) opt.selected = true;
                        destPosSelect.appendChild(opt);
                    });

                    // Rebuild product list for new source POS
                    const currentProductId = parseInt(productSelect.value, 10);
                    productSelect.innerHTML = '';
                    CORE.getVisibleProducts().filter(p => !p.isMainWarehouse && (CORE.getProductStock(p.id, sourceId) || 0) > 0).forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = `${p.name} • Stock: ${CORE.getProductStock(p.id, sourceId) || 0}`;
                        if (p.id === currentProductId) opt.selected = true;
                        productSelect.appendChild(opt);
                    });

                    updateSummary();
                };

                sourcePosSelect?.addEventListener('change', updateDestPos);
                destPosSelect?.addEventListener('change', updateSummary);
                productSelect?.addEventListener('change', updateSummary);
                qtyInput?.addEventListener('input', updateSummary);

                // Boutons d'action rapide
                document.querySelectorAll('[data-tf-set]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const action = btn.getAttribute('data-tf-set');
                        const sourceId = parseInt(sourcePosSelect.value, 10);
                        const productId = parseInt(productSelect.value, 10);
                        const sourceStock = CORE.getProductStock(productId, sourceId) || 0;

                        if (action === 'suggested') {
                            qtyInput.value = Math.floor(sourceStock * 0.5);
                        } else if (action === 'half') {
                            qtyInput.value = Math.floor(sourceStock / 2);
                        } else if (action === 'clear') {
                            qtyInput.value = 0;
                        } else if (action.startsWith('+')) {
                            const add = parseInt(action.substring(1), 10);
                            qtyInput.value = parseInt(qtyInput.value || 0, 10) + add;
                        }
                        updateSummary();
                    });
                });

                // Boutons de suggestion rapide
                document.querySelectorAll('[data-tf-suggestion]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const sourceId = btn.getAttribute('data-source-id');
                        const destId = btn.getAttribute('data-dest-id');
                        const productId = btn.getAttribute('data-product-id');
                        const suggestedQty = btn.getAttribute('data-suggested-qty');

                        sourcePosSelect.value = sourceId;
                        destPosSelect.value = destId;
                        productSelect.value = productId;
                        qtyInput.value = suggestedQty;
                        updateSummary();
                    });
                });

                updateSummary();
            }, 100);
        },

        executeStockTransfer() {
            const productId = UI.val('tf_product') || '';
            const sourcePosId = UI.val('tf_source_pos') || '';
            const destPosId = UI.val('tf_dest_pos') || '';
            const qty = parseInt(UI.val('tf_qty') || '0', 10);
            const reason = UI.val('tf_reason').trim();

            // Validations
            if (!productId) return UI.toast('Sélectionnez un produit', 'warning');
            if (!sourcePosId || !destPosId) return UI.toast('Sélectionnez les deux POS', 'warning');
            if (String(sourcePosId) === String(destPosId)) return UI.toast('Les POS source et destination doivent être différents', 'warning');
            if (qty <= 0) return UI.toast('La quantité doit être supérieure à 0', 'warning');

            const product = CORE.getProduct(productId);
            const sourcePos = CORE.getPOS(sourcePosId);
            const destPos = CORE.getPOS(destPosId);

            if (!product || !sourcePos || !destPos) {
                return UI.toast('Données invalides', 'error');
            }

            // Vérifier le stock source
            const sourceStock = CORE.getProductStock(productId, sourcePosId) || 0;
            if (sourceStock < qty) {
                return UI.toast(`Stock insuffisant (disponible: ${sourceStock})`, 'error');
            }

            // Créer un transfert en attente (le POS destinataire doit confirmer la réception)
            const transferRef = `TRANSFER-${Utils.uid('TR').substring(0, 8)}`;
            const notePrefix = reason ? `${reason} - ` : '';

            // Déduire le stock source immédiatement (réservé pour transfert)
            const newSourceStock = sourceStock - qty;
            CORE.setProductStock(productId, sourcePosId, newSourceStock);

            // NE PAS ajouter le stock au POS destination — c'est le gestionnaire qui confirme la réception

            // Mouvement sortie au POS source (réservation)
            CORE.recordStockMovement({
                productId: productId,
                type: 'out',
                qty: qty,
                ref: transferRef,
                note: `${notePrefix}Transfert en attente vers ${destPos.name}`,
                posId: sourcePosId
            });

            // Créer le transfert avec status 'pending'
            CORE.db.stockTransfers = CORE.db.stockTransfers || [];
            CORE.db.stockTransfers.push({
                id: transferRef,
                productId: product._apiId || productId,
                productName: product.name,
                productSku: product.barcode || product.sku || null,
                productPrice: product.price || 0,
                productCategory: product.category || product.categoryId || null,
                qty: qty,
                sourcePosId: sourcePosId,
                sourcePosName: sourcePos.name,
                destPosId: destPosId,
                destPosName: destPos.name,
                reason: reason || 'Transfert inter-POS (Manager)',
                status: 'pending', // En attente de confirmation par le gestionnaire destinataire
                createdBy: CORE.state.currentUser?.id,
                createdByName: CORE.state.currentUser?.name || 'Manager',
                createdAt: new Date().toISOString(),
                receivedAt: null,
                receivedBy: null,
                receivedByName: null
            });

            // Créer une notification pour le POS destinataire
            CORE.db.notifications = CORE.db.notifications || [];
            CORE.db.notifications.push({
                id: 'NOTIF-' + CORE.uid(),
                type: 'transfer_incoming',
                title: '📦 Transfert entrant',
                message: `${qty} x ${product.name} en provenance de ${sourcePos.name}`,
                details: `Envoyé par ${CORE.state.currentUser?.name || 'Manager'}`,
                transferId: transferRef,
                posId: destPosId,
                createdAt: new Date().toISOString(),
                read: false
            });

            CORE.markDirty('products');
            CORE.markDirty('stockMovements');
            CORE.markDirty('stockTransfers');
            CORE.markDirty('notifications');
            CORE.save(true);

            // SYNC FIX: Force immediate cloud push for cross-browser transfer visibility
            clearTimeout(CORE._cloudPushTimer);
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() && navigator.onLine) {
                CORE._cloudPushTimer = setTimeout(() => CORE._doCloudPush(0), 500);
            }

            UI.closeModal();
            UI.toast(`📤 Transfert envoyé! ${qty} ${product.name} en attente de réception par ${destPos.name}`, 'success');
            App.rerender();
        },

        // ===== SYSTÈME DE SUGGESTIONS INTELLIGENTES AVANCÉ =====

        // Afficher les détails du réapprovisionnement groupé pour un POS
        showGroupedTransferDetails(posId) {
            const pos = CORE.getPOS(parseInt(posId));
            if (!pos) return UI.toast('POS introuvable', 'error');

            const products = CORE.getVisibleProducts().filter(p => p.active);
            const groupedData = [];
            let totalValue = 0, totalItems = 0;

            products.forEach(p => {
                const depotStock = p.stock || 0;
                if (depotStock <= 0) return;

                const minStock = p.minStock || 0;
                const posStock = CORE.getProductStock(p.id, parseInt(posId)) || 0;
                const velocity = this.calculateSalesVelocity(p.id, parseInt(posId));
                const stockout = this.predictStockout(posStock, velocity);

                if (stockout.risk === 'critical' || stockout.risk === 'high' || posStock <= minStock) {
                    const target = Math.max(minStock * 2, Math.ceil(velocity * 14));
                    const deficit = target - posStock;
                    if (deficit > 0) {
                        const suggestedQty = Math.min(depotStock, deficit);
                        const value = suggestedQty * (p.price || 0);
                        groupedData.push({
                            productId: p.id,
                            productName: p.name,
                            posStock,
                            minStock,
                            depotStock,
                            suggestedQty,
                            velocity: velocity.toFixed(1),
                            stockout,
                            value
                        });
                        totalValue += value;
                        totalItems += suggestedQty;
                    }
                }
            });

            if (groupedData.length === 0) {
                return UI.toast('Aucun produit à transférer pour ce POS', 'info');
            }

            const html = `
                <div class="space-y-4">
                    <div class="p-4 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-xs opacity-80">Réapprovisionnement groupé</div>
                                <div class="text-xl font-black">${pos.name}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-black">${totalItems}</div>
                                <div class="text-xs opacity-80">unités • ${CORE.formatPrice(totalValue)}</div>
                            </div>
                        </div>
                    </div>

                    <div class="max-h-96 overflow-y-auto space-y-2">
                        ${groupedData.map(item => `
                            <div class="p-3 rounded-xl border ${item.stockout.risk === 'critical' ? 'border-red-300 bg-red-50' : item.stockout.risk === 'high' ? 'border-orange-300 bg-orange-50' : 'border-slate-200 bg-white'} flex items-center justify-between gap-3">
                                <div class="flex-1">
                                    <div class="font-black text-slate-900">${item.productName}</div>
                                    <div class="text-xs text-slate-600">
                                        Stock: ${item.posStock}/${item.minStock} •
                                        Dépôt: ${item.depotStock} •
                                        Vélocité: ${item.velocity}/j
                                    </div>
                                    <div class="text-[11px] font-bold ${item.stockout.risk === 'critical' ? 'text-red-600' : item.stockout.risk === 'high' ? 'text-orange-600' : 'text-slate-500'}">
                                        ${item.stockout.label}
                                    </div>
                                </div>
                                <div class="text-center">
                                    <div class="px-3 py-2 bg-slate-900 text-white rounded-xl">
                                        <div class="text-lg font-black">${item.suggestedQty}</div>
                                        <div class="text-[10px] opacity-70">à transférer</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-emerald-800">💡 Conseil IA</span>
                            <span class="text-sm text-emerald-700">Couvre ~14 jours de ventes</span>
                        </div>
                    </div>
                </div>
            `;

            UI.modal(`📦 Détail Réappro. - ${pos.name}`, html, [
                { label: 'Fermer', onclick: 'UI.closeModal()' },
                { label: 'Transférer Tout', onclick: `ManagerModule.executeGroupedTransfer(${posId})`, class: 'px-5 py-2.5 bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-black rounded-xl hover:from-purple-700 hover:to-indigo-700 transition' }
            ]);
        },

        // Exécuter un transfert groupé pour un POS
        executeGroupedTransfer(posId) {
            const pos = CORE.getPOS(parseInt(posId));
            if (!pos) return UI.toast('POS introuvable', 'error');

            const products = CORE.getVisibleProducts().filter(p => p.active);
            let transferCount = 0;
            let totalQty = 0;

            products.forEach(p => {
                const depotStock = p.stock || 0;
                if (depotStock <= 0) return;

                const minStock = p.minStock || 0;
                const posStock = CORE.getProductStock(p.id, parseInt(posId)) || 0;
                const velocity = this.calculateSalesVelocity(p.id, parseInt(posId));
                const stockout = this.predictStockout(posStock, velocity);

                if (stockout.risk === 'critical' || stockout.risk === 'high' || posStock <= minStock) {
                    const target = Math.max(minStock * 2, Math.ceil(velocity * 14));
                    const deficit = target - posStock;
                    if (deficit > 0) {
                        const qty = Math.min(depotStock, deficit);

                        // Déduire le stock du dépôt principal
                        p.stock = depotStock - qty;

                        // Créer le bon de transfert
                        const receipt = CORE.createTransferReceipt({
                            productId: p._apiId || p.id,
                            productName: p.name,
                            productSku: p.barcode || null,
                            productPrice: p.price || 0,
                            productCategory: p.category || p.categoryId || null,
                            quantity: qty,
                            fromPosId: 'main_depot',
                            fromPosName: 'Dépôt principal',
                            toPosId: parseInt(posId),
                            toPosName: pos.name,
                            note: `Réappro. groupé automatique - ${pos.name}`,
                            reference: `GRP-${Utils.uid('GT').slice(0, 6)}`,
                            meta: {
                                source: 'grouped_transfer',
                                velocity: velocity,
                                stockoutRisk: stockout.risk,
                                transferType: 'main_depot_transfer',
                                createdFrom: 'manager_grouped_transfer'
                            }
                        });

                        if (receipt) {
                            // Enregistrer le mouvement de stock
                            CORE.recordStockMovement({
                                type: 'main_depot_transfer',
                                productId: p.id,
                                quantity: qty,
                                posId: null,
                                fromPosId: null,
                                toPosId: parseInt(posId),
                                notes: `Réappro. groupé - ${pos.name}`,
                                reason: 'main_depot_transfer',
                                document: receipt.reference,
                                timestamp: new Date().toISOString(),
                                meta: {
                                    source: 'grouped_transfer',
                                    receiptId: receipt.id,
                                    direction: 'out',
                                    status: 'pending'
                                }
                            });

                            transferCount++;
                            totalQty += qty;
                        }
                    }
                }
            });

            CORE.markDirty('products');
            CORE.markDirty('stockMovements');
            CORE.markDirty('transferReceipts');
            CORE.save();
            UI.closeModal();

            if (transferCount > 0) {
                UI.toast(`✓ ${transferCount} transfert(s) créé(s) à ${totalQty} unités vers ${pos.name}`, 'success');
                App.rerender();
            } else {
                UI.toast('Aucun transfert effectué', 'warning');
            }
        },

        // 1. Calcul de la vélocité des ventes (unités vendues par jour)
        calculateSalesVelocity(productId, posId, days = 14) {
            const sales = (CORE.db.sales || []).filter(s => {
                if (!s.posId || s.posId !== posId) return false;
                const saleDate = new Date(s.date || s.createdAt);
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - days);
                return saleDate >= cutoff;
            });

            let totalQty = 0;
            sales.forEach(sale => {
                (sale.items || []).forEach(item => {
                    if (item.productId === productId) {
                        totalQty += item.qty || item.quantity || 1;
                    }
                });
            });

            return totalQty / days; // Unités par jour
        },

        // 2. Détection de tendance saisonnière
        detectSeasonalTrend(productId, posId) {
            const now = new Date();
            const currentMonth = now.getMonth();
            const sales = CORE.db.sales || [];

            // Comparer les ventes du même mois l'année dernière
            const thisMonthSales = sales.filter(s => {
                const d = new Date(s.date || s.createdAt);
                return d.getMonth() === currentMonth && s.posId === posId;
            });

            let currentQty = 0, historicalQty = 0;
            const thisYear = now.getFullYear();

            thisMonthSales.forEach(sale => {
                const year = new Date(sale.date || sale.createdAt).getFullYear();
                (sale.items || []).forEach(item => {
                    if (item.productId === productId) {
                        const qty = item.qty || item.quantity || 1;
                        if (year === thisYear) currentQty += qty;
                        else historicalQty += qty;
                    }
                });
            });

            if (historicalQty === 0) return { trend: 'stable', factor: 1 };

            const growthFactor = currentQty / historicalQty;
            if (growthFactor > 1.3) return { trend: 'up', factor: growthFactor, icon: '📈' };
            if (growthFactor < 0.7) return { trend: 'down', factor: growthFactor, icon: '📉' };
            return { trend: 'stable', factor: 1, icon: '➡️' };
        },

        // 3. Calcul du score de priorité combiné
        calculatePriorityScore(params) {
            const { posStock, minStock, velocity, daysUntilStockout, financialImpact, depotStock, suggestedQty } = params;

            // Score d'urgence (0-40 points)
            let urgencyScore = 0;
            if (posStock === 0) urgencyScore = 40;
            else if (posStock <= minStock * 0.25) urgencyScore = 35;
            else if (posStock <= minStock * 0.5) urgencyScore = 25;
            else if (posStock <= minStock) urgencyScore = 15;

            // Score de vélocité (0-25 points)
            let velocityScore = Math.min(25, velocity * 5);

            // Score de rupture imminente (0-20 points)
            let stockoutScore = 0;
            if (daysUntilStockout <= 1) stockoutScore = 20;
            else if (daysUntilStockout <= 3) stockoutScore = 15;
            else if (daysUntilStockout <= 7) stockoutScore = 10;
            else if (daysUntilStockout <= 14) stockoutScore = 5;

            // Score d'impact financier (0-15 points)
            let financialScore = Math.min(15, financialImpact / 10000);

            return Math.round(urgencyScore + velocityScore + stockoutScore + financialScore);
        },

        // 4. Prédiction de rupture de stock
        predictStockout(posStock, velocity) {
            if (velocity <= 0) return { days: Infinity, risk: 'low', label: 'Stable' };
            const daysUntilStockout = posStock / velocity;

            if (daysUntilStockout <= 1) return { days: daysUntilStockout, risk: 'critical', label: '⚠️ Rupture imminente!' };
            if (daysUntilStockout <= 3) return { days: daysUntilStockout, risk: 'high', label: '🔴 Critique (< 3j)' };
            if (daysUntilStockout <= 7) return { days: daysUntilStockout, risk: 'medium', label: '🟠 À surveiller (< 7j)' };
            if (daysUntilStockout <= 14) return { days: daysUntilStockout, risk: 'low', label: '🟡 Attention (< 14j)' };
            return { days: daysUntilStockout, risk: 'safe', label: '🟢 OK' };
        },

        // 5. Génération de suggestions groupées par POS
        generateGroupedSuggestions(posList, products) {
            const grouped = {};

            posList.forEach(pos => {
                const posProducts = [];
                let totalValue = 0;
                let criticalCount = 0;

                products.forEach(p => {
                    const depotStock = p.stock || 0;
                    if (depotStock <= 0) return;

                    const minStock = p.minStock || 0;
                    const posStock = CORE.getProductStock(p.id, pos.id) || 0;
                    const velocity = this.calculateSalesVelocity(p.id, pos.id);
                    const stockout = this.predictStockout(posStock, velocity);

                    if (stockout.risk === 'critical' || stockout.risk === 'high' || posStock <= minStock) {
                        const target = Math.max(minStock * 2, Math.ceil(velocity * 14)); // 2 semaines de stock
                        const deficit = target - posStock;
                        if (deficit > 0) {
                            const suggestedQty = Math.min(depotStock, deficit);
                            posProducts.push({
                                productId: p.id,
                                productName: p.name,
                                suggestedQty,
                                velocity,
                                stockout
                            });
                            totalValue += suggestedQty * (p.price || 0);
                            if (stockout.risk === 'critical' || stockout.risk === 'high') criticalCount++;
                        }
                    }
                });

                if (posProducts.length > 0) {
                    grouped[pos.id] = {
                        posId: pos.id,
                        posName: pos.name,
                        products: posProducts,
                        totalValue,
                        criticalCount,
                        totalItems: posProducts.reduce((sum, p) => sum + p.suggestedQty, 0)
                    };
                }
            });

            return grouped;
        },

        // Génère la raison principale de la suggestion
        getSuggestionReason(stockout, velocity, posStock, minStock, seasonalTrend) {
            if (stockout.risk === 'critical') return '🚨 Rupture imminente détectée';
            if (stockout.risk === 'high') return '⚠️ Stock critique < 3 jours';
            if (velocity >= 5) return '🔥 Forte demande détectée';
            if (seasonalTrend.trend === 'up') return '📈 Tendance saisonnière haussière';
            if (posStock <= minStock * 0.5) return '📉 Stock sous 50% du minimum';
            if (posStock <= minStock) return '⚡ Sous le seuil minimum';
            return '📊 Réapprovisionnement préventif';
        },

        showMainTransferModal() {
            const products = CORE.getVisibleProducts().filter(p => p.active);
            if (products.length === 0) {
                UI.toast('Aucun produit actif au dépôt principal', 'warning');
                return;
            }

            const posList = CORE.db.pointsOfSale || [];
            if (posList.length === 0) {
                UI.toast('Ajoutez un point de vente avant de réaliser un transfert', 'warning');
                return;
            }

            ManagerModule._mainTransferMedia = [];

            const depotTotals = products.reduce((acc, p) => {
                acc.units += p.stock || 0;
                acc.value += (p.stock || 0) * (p.price || 0);
                return acc;
            }, { units: 0, value: 0 });

            const lowDepot = products.filter(p => (p.stock || 0) <= (p.minStock || 0)).length;

            // ===== GÉNÉRATION DES SUGGESTIONS INTELLIGENTES =====
            const suggestions = [];
            const groupedSuggestions = this.generateGroupedSuggestions(posList, products);

            posList.forEach(pos => {
                products.forEach(p => {
                    const depotStock = p.stock || 0;
                    if (depotStock <= 0) return;
                    const minStock = p.minStock || 0;
                    const posStock = CORE.getProductStock(p.id, pos.id) || 0;

                    // Calculs avancés
                    const velocity = this.calculateSalesVelocity(p.id, pos.id);
                    const seasonalTrend = this.detectSeasonalTrend(p.id, pos.id);
                    const stockout = this.predictStockout(posStock, velocity);

                    // Objectif intelligent basé sur vélocité + tendance saisonnière
                    const velocityTarget = Math.ceil(velocity * 14 * seasonalTrend.factor); // 2 semaines ajustées
                    const target = Math.max(minStock * 2, velocityTarget, minStock + 20);
                    const deficit = target - posStock;

                    if (deficit <= 0) return;

                    const suggestedQty = Math.min(depotStock, deficit);
                    const financialImpact = suggestedQty * (p.price || 0);

                    // Score de priorité combiné
                    const priorityScore = this.calculatePriorityScore({
                        posStock, minStock, velocity,
                        daysUntilStockout: stockout.days,
                        financialImpact, depotStock, suggestedQty
                    });

                    // Déterminer la sévérité basée sur le score
                    let severity = 'low';
                    if (priorityScore >= 60 || stockout.risk === 'critical') severity = 'critical';
                    else if (priorityScore >= 40 || stockout.risk === 'high') severity = 'high';
                    else if (priorityScore >= 25 || stockout.risk === 'medium') severity = 'medium';

                    suggestions.push({
                        productId: p.id,
                        productName: p.name,
                        posId: pos.id,
                        posName: pos.name,
                        posStock,
                        minStock,
                        depotStock,
                        suggestedQty,
                        severity,
                        // Données enrichies
                        velocity: velocity.toFixed(1),
                        velocityLabel: velocity >= 5 ? '🔥 Forte' : velocity >= 2 ? '📊 Moyenne' : '📉 Faible',
                        stockout,
                        daysUntilStockout: stockout.days === Infinity ? '8' : Math.round(stockout.days),
                        seasonalTrend,
                        priorityScore,
                        financialImpact,
                        reason: this.getSuggestionReason(stockout, velocity, posStock, minStock, seasonalTrend)
                    });
                });
            });

            // Tri par score de priorité décroissant
            suggestions.sort((a, b) => b.priorityScore - a.priorityScore);

            const topSuggestions = suggestions.slice(0, 5);

            // Statistiques des suggestions
            const totalCritical = suggestions.filter(s => s.severity === 'critical').length;
            const totalHigh = suggestions.filter(s => s.severity === 'high').length;
            const avgVelocity = suggestions.length > 0
                ? (suggestions.reduce((sum, s) => sum + parseFloat(s.velocity), 0) / suggestions.length).toFixed(1)
                : 0;
            const defaultSuggestion = topSuggestions[0] || null;
            const defaultProductId = defaultSuggestion ? defaultSuggestion.productId : products[0].id;
            const defaultPosId = defaultSuggestion ? defaultSuggestion.posId : posList[0].id;

            const recentTransfers = CORE.getVisibleStockMovements()
                .filter(m => m.meta?.source === 'manager_transfer')
                .sort((a, b) => new Date(b.timestamp || b.createdAt || 0) - new Date(a.timestamp || a.createdAt || 0))
                .slice(0, 5);

            const outboundTransfers = recentTransfers.filter(m => m.meta?.direction === 'out');
            const transferHistory = outboundTransfers.length > 0 ? outboundTransfers : recentTransfers;

            const html = `
                <div class="space-y-6 max-h-[85vh] overflow-y-auto">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="p-4 rounded-2xl bg-blue-50 border border-blue-200">
                            <div class="text-xs font-black text-blue-600 uppercase">Stock disponible</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${depotTotals.units.toLocaleString('fr-FR')}</div>
                            <div class="text-[11px] text-blue-700">Unités au dépôt principal</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-200">
                            <div class="text-xs font-black text-emerald-600 uppercase">Valeur estimée</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${CORE.formatPrice(depotTotals.value)}</div>
                            <div class="text-[11px] text-emerald-700">Stock valorisé</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-amber-50 border border-amber-200">
                            <div class="text-xs font-black text-amber-600 uppercase">Produits critiques</div>
                            <div class="text-2xl font-black text-amber-900 mt-1">${lowDepot}</div>
                            <div class="text-[11px] text-amber-700">À surveiller au dépôt</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                        <div class="space-y-4">
                            <div class="p-5 bg-white rounded-3xl border border-slate-200 space-y-4">
                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Produit dépôt</label>
                                    <select id="main_transfer_product" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-blue-500">
                                        ${products.map(p => `
                                            <option value="${p.id}" ${p.id === defaultProductId ? 'selected' : ''}>
                                                ${p.name} • Stock: ${p.stock || 0}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Destination (POS)</label>
                                    <select id="main_transfer_pos" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-bold bg-slate-50 focus:ring-2 focus:ring-blue-500">
                                        ${posList.map(pos => `
                                            <option value="${pos.id}" ${pos.id === defaultPosId ? 'selected' : ''}>
                                                ${pos.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div class="grid grid-cols-2 gap-3 text-center text-sm">
                                    <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                        <div class="text-xs font-bold text-slate-500 uppercase">Stock dépôt</div>
                                        <div id="main_transfer_summary_depot" class="text-xl font-black text-slate-900">0</div>
                                    </div>
                                    <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                        <div class="text-xs font-bold text-slate-500 uppercase">Stock POS</div>
                                        <div id="main_transfer_summary_pos" class="text-xl font-black text-slate-900">0</div>
                                    </div>
                                    <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                        <div class="text-xs font-bold text-slate-500 uppercase">Stock min.</div>
                                        <div id="main_transfer_summary_min" class="text-xl font-black text-slate-900">0</div>
                                    </div>
                                    <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200">
                                        <div class="text-xs font-bold text-slate-500 uppercase">Suggestion</div>
                                        <div id="main_transfer_summary_recommended" data-recommended="0" class="text-xl font-black text-emerald-600">0</div>
                                    </div>
                                </div>

                                <div class="p-3 rounded-2xl bg-emerald-50 border border-emerald-200">
                                    <div class="flex items-center justify-between text-sm font-bold text-emerald-700">
                                        <span>Couverture après transfert</span>
                                        <span id="main_transfer_summary_coverage">0%</span>
                                    </div>
                                    <div class="text-xs text-emerald-600 mt-1" id="main_transfer_summary_value">0 XAF</div>
                                </div>

                                <div class="flex flex-wrap gap-2">
                                    <button data-main-transfer-set="recommended" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700 transition">Suggestion IA</button>
                                    <button data-main-transfer-set="min" class="px-3 py-2 rounded-xl bg-blue-600 text-white text-xs font-black hover:bg-blue-700 transition">Atteindre Min</button>
                                    <button data-main-transfer-set="+25" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300 transition">+25</button>
                                    <button data-main-transfer-set="+50" class="px-3 py-2 rounded-xl bg-slate-200 text-slate-700 text-xs font-black hover:bg-slate-300 transition">+50</button>
                                    <button data-main-transfer-set="clear" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-100 transition">Réinitialiser</button>
                                </div>

                                <div class="grid grid-cols-2 gap-3 items-end">
                                    <div>
                                        <label class="block text-xs font-black text-slate-500 uppercase mb-2">Quantité à transférer</label>
                                        <input id="main_transfer_qty" type="number" min="0" value="0" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-black text-lg text-center bg-white focus:ring-2 focus:ring-purple-500">
                                        <div id="main_transfer_warning" class="mt-2 text-xs font-bold text-red-600 hidden">⚠️ Stock dépôt insuffisant</div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-black text-slate-500 uppercase mb-2">Référence (auto)</label>
                                        <input id="main_transfer_ref" type="text" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-slate-50" placeholder="Auto-généré lors du transfert" readonly>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Note interne (optionnelle)</label>
                                    <textarea id="main_transfer_note" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-white" rows="2" placeholder="Ex: Réassort saisonnier, campagne promo..."></textarea>
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Numéro de suivi (optionnel)</label>
                                    <input id="main_transfer_tracking" type="text" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-white" placeholder="Ex: TRANSF-2026-0001">
                                </div>

                                <div>
                                    <label class="block text-xs font-black text-slate-500 uppercase mb-2">Arrivée estimée (optionnel)</label>
                                    <input id="main_transfer_eta" type="datetime-local" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 font-medium bg-white">
                                </div>

                                <div class="space-y-2">
                                    <label class="block text-xs font-black text-slate-500 uppercase">Pièces jointes (photos / vidéos)</label>
                                    <div id="main_transfer_media_trigger" class="rounded-2xl border border-dashed border-slate-300 bg-slate-50 px-4 py-6 text-center cursor-pointer hover:border-purple-400 hover:bg-white transition">
                                        <div class="text-sm font-bold text-slate-600">Glisser-déposer ou cliquer pour importer</div>
                                        <div class="text-[11px] text-slate-400">Formats: JPG, PNG, MP4 • 6 fichiers max • 10 Mo chacun</div>
                                    </div>
                                    <input id="main_transfer_media_input" type="file" class="hidden" accept="image/*,video/*" multiple>
                                    <div id="main_transfer_media_preview" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <!-- En-tête des suggestions avec statistiques -->
                            <div class="p-4 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl text-white">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="font-black text-sm">🧠 Analyse Intelligente</div>
                                    <span class="px-2 py-1 bg-white/20 rounded-lg text-xs font-bold">${suggestions.length} suggestions</span>
                                </div>
                                <div class="grid grid-cols-3 gap-2 text-center mt-3">
                                    <div class="p-2 bg-white/10 rounded-xl">
                                        <div class="text-lg font-black">${totalCritical}</div>
                                        <div class="text-[10px] opacity-80">Critiques</div>
                                    </div>
                                    <div class="p-2 bg-white/10 rounded-xl">
                                        <div class="text-lg font-black">${totalHigh}</div>
                                        <div class="text-[10px] opacity-80">Urgents</div>
                                    </div>
                                    <div class="p-2 bg-white/10 rounded-xl">
                                        <div class="text-lg font-black">${avgVelocity}/j</div>
                                        <div class="text-[10px] opacity-80">Vélocité moy.</div>
                                    </div>
                                </div>
                            </div>

                            <div class="p-5 bg-white rounded-3xl border border-slate-200">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="font-black text-slate-900 text-sm">🎯 Top 5 Suggestions Prioritaires</div>
                                    <span class="text-xs text-slate-500 font-bold">Score IA</span>
                                </div>
                                ${topSuggestions.length === 0 ? `
                                    <div class="p-4 rounded-2xl bg-slate-50 text-sm text-slate-500 text-center">
                                        ✅ Aucune alerte critique détectée. Tous les POS sont bien approvisionnés.
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${topSuggestions.map((s, idx) => {
                                            const severityColors = {
                                                critical: 'border-red-300 bg-gradient-to-r from-red-50 to-red-100',
                                                high: 'border-orange-300 bg-gradient-to-r from-orange-50 to-amber-50',
                                                medium: 'border-yellow-300 bg-gradient-to-r from-yellow-50 to-amber-50',
                                                low: 'border-blue-200 bg-gradient-to-r from-blue-50 to-slate-50'
                                            };
                                            const severityBadge = {
                                                critical: '<span class="px-2 py-0.5 bg-red-600 text-white text-[10px] font-black rounded-full">CRITIQUE</span>',
                                                high: '<span class="px-2 py-0.5 bg-orange-500 text-white text-[10px] font-black rounded-full">URGENT</span>',
                                                medium: '<span class="px-2 py-0.5 bg-yellow-500 text-white text-[10px] font-black rounded-full">ATTENTION</span>',
                                                low: '<span class="px-2 py-0.5 bg-blue-500 text-white text-[10px] font-black rounded-full">PRÉVENTIF</span>'
                                            };
                                            return `
                                            <div class="p-4 rounded-2xl border-2 ${severityColors[s.severity] || severityColors.low} hover:shadow-lg transition-all cursor-pointer" onclick="document.querySelector('[data-main-transfer-suggestion][data-product-id=&quot;${s.productId}&quot;][data-pos-id=&quot;${s.posId}&quot;]')?.click()">
                                                <div class="flex items-start justify-between gap-3">
                                                    <div class="flex-1">
                                                        <div class="flex items-center gap-2 mb-1">
                                                            <span class="text-lg font-black">#${idx + 1}</span>
                                                            <span class="font-black text-slate-900">${s.productName}</span>
                                                            ${severityBadge[s.severity] || ''}
                                                        </div>
                                                        <div class="text-xs text-slate-600 mb-2">📍 ${s.posName}</div>

                                                        <!-- Métriques avancées -->
                                                        <div class="grid grid-cols-2 gap-2 mb-2">
                                                            <div class="flex items-center gap-1 text-xs">
                                                                <span class="text-slate-500">📦 Stock:</span>
                                                                <span class="font-black ${s.posStock <= s.minStock ? 'text-red-600' : 'text-slate-900'}">${s.posStock}/${s.minStock}</span>
                                                            </div>
                                                            <div class="flex items-center gap-1 text-xs">
                                                                <span class="text-slate-500">⏱️ Rupture:</span>
                                                                <span class="font-black ${s.stockout.risk === 'critical' ? 'text-red-600' : s.stockout.risk === 'high' ? 'text-orange-600' : 'text-slate-900'}">${s.daysUntilStockout === '8' ? 'N/A' : s.daysUntilStockout + 'j'}</span>
                                                            </div>
                                                            <div class="flex items-center gap-1 text-xs">
                                                                <span class="text-slate-500">📈 Vélocité:</span>
                                                                <span class="font-black">${s.velocity}/j ${s.velocityLabel}</span>
                                                            </div>
                                                            <div class="flex items-center gap-1 text-xs">
                                                                <span class="text-slate-500">📊 Tendance:</span>
                                                                <span class="font-black">${s.seasonalTrend.icon || '➡️'} ${s.seasonalTrend.trend === 'up' ? 'Hausse' : s.seasonalTrend.trend === 'down' ? 'Baisse' : 'Stable'}</span>
                                                            </div>
                                                        </div>

                                                        <!-- Raison de la suggestion -->
                                                        <div class="px-2 py-1 bg-white/70 rounded-lg text-[11px] font-bold text-slate-700 inline-block">
                                                            ${s.reason}
                                                        </div>
                                                    </div>

                                                    <div class="text-right flex flex-col items-end gap-2">
                                                        <!-- Score de priorité -->
                                                        <div class="w-12 h-12 rounded-full bg-gradient-to-br ${s.priorityScore >= 60 ? 'from-red-500 to-red-700' : s.priorityScore >= 40 ? 'from-orange-500 to-amber-600' : s.priorityScore >= 25 ? 'from-yellow-500 to-amber-500' : 'from-blue-500 to-indigo-600'} flex items-center justify-center shadow-lg">
                                                            <span class="text-white font-black text-sm">${s.priorityScore}</span>
                                                        </div>
                                                        <div class="text-[10px] text-slate-500 font-bold">Score</div>

                                                        <!-- Quantité suggérée -->
                                                        <div class="mt-1 px-3 py-1.5 bg-slate-900 text-white rounded-lg">
                                                            <div class="text-xs font-bold opacity-70">Suggéré</div>
                                                            <div class="text-lg font-black">${s.suggestedQty}</div>
                                                        </div>

                                                        <button data-main-transfer-suggestion data-product-id="${s.productId}" data-pos-id="${s.posId}" data-suggested-qty="${s.suggestedQty}" class="mt-1 px-4 py-2 rounded-xl bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-xs font-black hover:from-purple-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl">
                                                            ⚡ Appliquer
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                        }).join('')}
                                    </div>
                                `}
                            </div>

                            <div class="p-5 bg-white rounded-3xl border border-slate-200">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="font-black text-slate-900 text-sm">📦 Réappro. Groupé par POS</div>
                                    <span class="text-xs text-slate-500 font-bold">${Object.keys(groupedSuggestions).length} POS</span>
                                </div>
                                ${Object.keys(groupedSuggestions).length === 0 ? `
                                    <div class="p-4 rounded-2xl bg-slate-50 text-sm text-slate-500 text-center">
                                        Aucun réapprovisionnement groupé nécessaire.
                                    </div>
                                ` : `
                                    <div class="space-y-2 max-h-48 overflow-y-auto">
                                        ${Object.values(groupedSuggestions).sort((a, b) => b.criticalCount - a.criticalCount).slice(0, 4).map(g => `
                                            <div class="p-3 rounded-2xl border ${g.criticalCount > 0 ? 'border-red-200 bg-gradient-to-r from-red-50 to-orange-50' : 'border-slate-200 bg-slate-50'} hover:shadow-md transition cursor-pointer" onclick="ManagerModule.showGroupedTransferDetails('${g.posId}')">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <div class="font-black text-slate-900">${g.posName}</div>
                                                        <div class="text-xs text-slate-600">${g.products.length} produits • ${g.totalItems} unités</div>
                                                        ${g.criticalCount > 0 ? `<span class="text-[10px] font-black text-red-600">⚠️ ${g.criticalCount} critique(s)</span>` : ''}
                                                    </div>
                                                    <div class="text-right">
                                                        <div class="text-xs font-black text-slate-900">${CORE.formatPrice(g.totalValue)}</div>
                                                        <div class="text-[10px] text-slate-500">Valeur totale</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>

                            <div class="p-5 bg-white rounded-3xl border border-slate-200">
                                <div class="font-black text-slate-900 text-sm mb-3">🕒 Derniers transferts</div>
                                ${transferHistory.length === 0 ? `
                                    <div class="p-4 rounded-2xl bg-slate-50 text-sm text-slate-500 text-center">
                                        Aucun transfert enregistré récemment.
                                    </div>
                                ` : `
                                    <div class="space-y-2 text-sm">
                                        ${transferHistory.map(t => {
                                            const destPos = CORE.getPOS(t.meta?.toPosId || t.toPosId || t.posId);
                                            const destination = destPos ? destPos.name : (t.meta?.destinationName || 'POS');
                                            const qty = t.qty || t.quantity || 0;
                                            const when = new Date(t.timestamp || t.createdAt || Date.now()).toLocaleString('fr-FR');
                                            return `
                                                <div class="p-3 rounded-2xl bg-slate-50 border border-slate-200 flex items-center justify-between gap-3">
                                                    <div>
                                                        <div class="font-black text-slate-900">${t.productName || 'Produit'}</div>
                                                        <div class="text-xs text-slate-600">${qty} unités • ${destination}</div>
                                                    </div>
                                                    <div class="text-[11px] text-slate-400 font-bold text-right">${when}</div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            UI.modal('🔄 Approvisionner un POS depuis le Dépôt Principal', html, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Transférer', onclick: 'ManagerModule.executeMainTransfer()', class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition' }
            ]);

            setTimeout(() => {
                const modalEl = document.querySelector('#modalContainer .slide-up');
                if (modalEl) {
                    modalEl.classList.remove('max-w-lg');
                    modalEl.classList.add('max-w-5xl');
                }

                const productSelect = document.getElementById('main_transfer_product');
                const posSelect = document.getElementById('main_transfer_pos');
                const qtyInput = document.getElementById('main_transfer_qty');
                const refInput = document.getElementById('main_transfer_ref');
                const summaryDepot = document.getElementById('main_transfer_summary_depot');
                const summaryPos = document.getElementById('main_transfer_summary_pos');
                const summaryMin = document.getElementById('main_transfer_summary_min');
                const summaryRecommended = document.getElementById('main_transfer_summary_recommended');
                const summaryCoverage = document.getElementById('main_transfer_summary_coverage');
                const summaryValue = document.getElementById('main_transfer_summary_value');
                const warning = document.getElementById('main_transfer_warning');
                    const mediaInput = document.getElementById('main_transfer_media_input');
                    const mediaTrigger = document.getElementById('main_transfer_media_trigger');
                    const mediaPreview = document.getElementById('main_transfer_media_preview');
                    const attachments = [];
                    ManagerModule._mainTransferMedia = attachments;

                    const MAX_MEDIA_FILES = 6;
                    const MAX_MEDIA_SIZE = 10 * 1024 * 1024;

                    const renderMediaPreview = () => {
                        if (!mediaPreview) return;
                        if (attachments.length === 0) {
                            mediaPreview.innerHTML = '<div class="px-4 py-3 rounded-xl bg-slate-100 text-xs font-bold text-slate-400 text-center">Aucun média ajouté</div>';
                            return;
                        }

                        mediaPreview.innerHTML = attachments.map(att => `
                            <div class="relative group border border-slate-200 rounded-xl overflow-hidden">
                                ${att.type === 'video'
                                    ? `<video src="${att.dataUrl}" class="w-full h-24 object-cover" muted loop></video>`
                                    : `<img src="${att.dataUrl}" alt="${att.name}" class="w-full h-24 object-cover">`}
                                <button type="button" data-remove-media="${att.id}" class="absolute top-2 right-2 bg-white/80 backdrop-blur px-2 py-1 rounded-lg text-[11px] font-black text-slate-600 hover:bg-red-500 hover:text-white transition">Retirer</button>
                                <div class="px-3 py-2 bg-white text-[11px] font-bold text-slate-500 truncate">${att.name}</div>
                            </div>
                        `).join('');

                        mediaPreview.querySelectorAll('[data-remove-media]').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const id = btn.getAttribute('data-remove-media');
                                const index = attachments.findIndex(item => item.id === id);
                                if (index !== -1) {
                                    attachments.splice(index, 1);
                                    ManagerModule._mainTransferMedia = attachments;
                                    renderMediaPreview();
                                }
                            });
                        });
                    };

                    const addAttachment = (file) => {
                        if (!file) return;
                        const isMedia = file.type?.startsWith('image') || file.type?.startsWith('video');
                        if (!isMedia) {
                            UI.toast('Format non pris en charge', 'warning');
                            return;
                        }
                        if (file.size > MAX_MEDIA_SIZE) {
                            UI.toast('Fichier trop volumineux (10 Mo max)', 'warning');
                            return;
                        }
                        if (attachments.length >= MAX_MEDIA_FILES) {
                            UI.toast('Limite de 6 fichiers atteinte', 'warning');
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = () => {
                            const isVideo = (file.type || '').startsWith('video');
                            attachments.push({
                                id: Utils.uid('MEDIA'),
                                name: file.name,
                                type: isVideo ? 'video' : 'image',
                                mimeType: file.type || (isVideo ? 'video/mp4' : 'image/jpeg'),
                                size: file.size,
                                dataUrl: reader.result
                            });
                            ManagerModule._mainTransferMedia = attachments;
                            renderMediaPreview();
                        };
                        reader.readAsDataURL(file);
                    };

                    const handleFiles = (fileList) => {
                        if (!fileList) return;
                        Array.from(fileList).some(file => {
                            if (attachments.length >= MAX_MEDIA_FILES) return true;
                            addAttachment(file);
                            return false;
                        });
                    };

                    mediaTrigger?.addEventListener('click', () => mediaInput?.click());
                    mediaTrigger?.addEventListener('dragover', event => {
                        event.preventDefault();
                        mediaTrigger.classList.add('border-purple-400', 'bg-white');
                    });
                    mediaTrigger?.addEventListener('dragleave', () => {
                        mediaTrigger.classList.remove('border-purple-400', 'bg-white');
                    });
                    mediaTrigger?.addEventListener('drop', event => {
                        event.preventDefault();
                        mediaTrigger.classList.remove('border-purple-400', 'bg-white');
                        handleFiles(event.dataTransfer?.files || []);
                    });
                    mediaInput?.addEventListener('change', event => {
                        handleFiles(event.target?.files || []);
                        mediaInput.value = '';
                    });

                    renderMediaPreview();

                const formatNumber = (n) => Number(n || 0).toLocaleString('fr-FR');

                const updateSummary = (opts = {}) => {
                    const productId = parseInt(productSelect.value, 10) || defaultProductId;
                    const posId = parseInt(posSelect.value, 10) || defaultPosId;
                    const product = CORE.getProduct(productId) || {};
                    const depotStock = product.stock || 0;
                    const minStock = product.minStock || 0;
                    const posStock = CORE.getProductStock(productId, posId) || 0;
                    const target = Math.max(minStock * 2, minStock + 20);
                    const recommended = Math.max(0, target - posStock);
                    const currentQty = Math.max(0, Number(qtyInput.value || 0));
                    const safeQty = Math.min(currentQty, depotStock);

                    if (!opts.keepQty && (qtyInput.value === '' || qtyInput.dataset.autoFill === 'true')) {
                        qtyInput.value = Math.min(depotStock, recommended);
                        qtyInput.dataset.autoFill = 'true';
                    } else if (safeQty !== currentQty) {
                        qtyInput.value = safeQty;
                    }

                    const finalQty = Math.max(0, Number(qtyInput.value || 0));
                    const afterPosStock = posStock + finalQty;
                    const coverage = minStock > 0 ? Math.round((afterPosStock / minStock) * 100) : 0;
                    const transferValue = CORE.formatPrice(finalQty * (product.price || 0));

                    summaryDepot.textContent = formatNumber(depotStock);
                    summaryPos.textContent = formatNumber(posStock);
                    summaryMin.textContent = formatNumber(minStock);
                    summaryRecommended.textContent = formatNumber(recommended);
                    summaryRecommended.dataset.recommended = recommended;
                    summaryCoverage.textContent = `${coverage}%`;
                    summaryValue.textContent = transferValue;
                    warning.classList.toggle('hidden', finalQty <= depotStock);

                    if (!refInput.value) {
                        refInput.value = `MAIN-${Utils.uid('MT').slice(0, 6)}`;
                    }

                    return { productId, posId, depotStock, posStock, minStock, recommended };
                };

                qtyInput.dataset.autoFill = 'true';

                productSelect.addEventListener('change', () => {
                    qtyInput.dataset.autoFill = 'true';
                    updateSummary({ keepQty: false });
                });

                posSelect.addEventListener('change', () => {
                    qtyInput.dataset.autoFill = 'true';
                    updateSummary({ keepQty: false });
                });

                qtyInput.addEventListener('input', () => {
                    qtyInput.dataset.autoFill = 'false';
                    updateSummary({ keepQty: true });
                });

                document.querySelectorAll('[data-main-transfer-set]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const action = btn.dataset.mainTransferSet;
                        const { depotStock, posStock, minStock, recommended } = updateSummary({ keepQty: true });
                        let nextQty = Number(qtyInput.value || 0);

                        if (action === 'recommended') {
                            nextQty = Math.min(depotStock, recommended);
                        } else if (action === 'min') {
                            nextQty = Math.max(0, Math.min(depotStock, Math.max(0, minStock - posStock)));
                        } else if (action === 'clear') {
                            nextQty = 0;
                        } else {
                            const delta = Number(action.replace('+', '')) || 0;
                            nextQty = Math.max(0, Math.min(depotStock, nextQty + delta));
                        }

                        qtyInput.value = Math.round(nextQty);
                        qtyInput.dataset.autoFill = 'false';
                        updateSummary({ keepQty: true });
                    });
                });

                document.querySelectorAll('[data-main-transfer-suggestion]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const productId = btn.dataset.productId;
                        const posId = btn.dataset.posId;
                        const suggestedQty = Number(btn.dataset.suggestedQty || 0);
                        if (productId) productSelect.value = String(productId);
                        if (posId) posSelect.value = String(posId);
                        qtyInput.value = suggestedQty;
                        qtyInput.dataset.autoFill = 'false';
                        updateSummary({ keepQty: true });
                    });
                });

                updateSummary({ keepQty: false });
                lucide?.createIcons?.();
            }, 60);
        },

        executeMainTransfer() {
            const productSelect = document.getElementById('main_transfer_product');
            const posSelect = document.getElementById('main_transfer_pos');
            const qtyInput = document.getElementById('main_transfer_qty');
            const noteInput = document.getElementById('main_transfer_note');
            const trackingInput = document.getElementById('main_transfer_tracking');
            const etaInput = document.getElementById('main_transfer_eta');
            const refInput = document.getElementById('main_transfer_ref');
            const recommendedEl = document.getElementById('main_transfer_summary_recommended');

            const productId = parseInt(productSelect?.value || '', 10);
            const posId = parseInt(posSelect?.value || '', 10);
            const qty = Math.max(0, Number(qtyInput?.value || 0));
            const note = (noteInput?.value || '').trim();
            const reference = (refInput?.value || '').trim() || `MAIN-${Utils.uid('MT').slice(0, 6)}`;
            const trackingNumber = (trackingInput?.value || '').trim();
            const etaRaw = (etaInput?.value || '').trim();
            const recommended = Number(recommendedEl?.dataset?.recommended || 0);
            const media = Array.isArray(ManagerModule._mainTransferMedia)
                ? ManagerModule._mainTransferMedia.map(item => ({
                    id: item.id,
                    name: item.name,
                    type: item.type,
                    mimeType: item.mimeType,
                    size: item.size,
                    dataUrl: item.dataUrl
                }))
                : [];

            if (!productId || !posId) {
                UI.toast('Sélectionnez un produit et un POS', 'warning');
                return;
            }

            if (qty <= 0) {
                UI.toast('Quantité invalide', 'warning');
                return;
            }

            const product = CORE.getProduct(productId);
            const pos = CORE.getPOS(posId);
            if (!product || !pos) {
                UI.toast('Produit ou POS introuvable', 'error');
                return;
            }

            const depotStock = product.stock || 0;
            if (qty > depotStock) {
                UI.toast('Stock dépôt insuffisant', 'error');
                return;
            }

            // Mettre à jour les stocks
            product.stock = depotStock - qty;

            if (!product.posStocks) product.posStocks = {};
            if (!product.posStocks[posId]) {
                product.posStocks[posId] = {
                    stock: 0,
                    lastUpdated: new Date().toISOString()
                };
            }

            const timestamp = new Date().toISOString();
            product.posStocks[posId].lastUpdated = timestamp;

            const cloneMedia = () => media.map(item => ({ ...item }));

            const movementMeta = {
                source: 'manager_transfer',
                direction: 'out',
                toPosId: posId,
                reference,
                recommended,
                destinationName: pos.name,
                attachments: cloneMedia()
            };

            if (trackingNumber) {
                movementMeta.trackingNumber = trackingNumber;
            }

            if (etaRaw) {
                const etaDate = new Date(etaRaw);
                if (!Number.isNaN(etaDate.getTime())) {
                    movementMeta.estimatedArrivalAt = etaDate.toISOString();
                }
            }

            const receipt = CORE.createTransferReceipt({
                reference,
                productId: product._apiId || product.id,
                productName: product.name,
                productSku: product.barcode || null,
                productPrice: product.price || 0,
                productCategory: product.category || null,
                quantity: qty,
                fromPosId: 'main_depot',
                fromPosName: 'Dépôt principal',
                toPosId: posId,
                toPosName: pos.name,
                note,
                attachments: cloneMedia(),
                trackingNumber,
                estimatedArrivalAt: movementMeta.estimatedArrivalAt || null,
                recommended,
                meta: {
                    transferType: 'main_depot_transfer',
                    createdFrom: 'manager_main_transfer'
                }
            });

            const baseMovementMeta = {
                ...movementMeta,
                receiptId: receipt?.id || null,
                status: 'pending'
            };

            const outboundMovement = CORE.recordStockMovement({
                type: 'main_depot_transfer',
                productId,
                quantity: qty,
                posId: null,
                fromPosId: null,
                toPosId: posId,
                notes: note,
                reason: 'main_depot_transfer',
                document: reference,
                timestamp,
                meta: baseMovementMeta
            });

            if (outboundMovement) {
                outboundMovement.status = 'pending';
                outboundMovement.meta = baseMovementMeta;
                outboundMovement.timestamp = timestamp;
                outboundMovement.createdAt = timestamp;
            }

            const inboundMeta = {
                ...baseMovementMeta,
                direction: 'in',
                attachments: cloneMedia()
            };

            const inboundMovement = CORE.recordStockMovement({
                type: 'main_depot_transfer',
                productId,
                quantity: qty,
                posId,
                fromPosId: null,
                toPosId: posId,
                notes: note,
                reason: 'main_depot_transfer',
                document: reference,
                timestamp,
                meta: inboundMeta
            });

            if (inboundMovement) {
                inboundMovement.status = 'pending';
                inboundMovement.meta = inboundMeta;
                inboundMovement.timestamp = timestamp;
                inboundMovement.createdAt = timestamp;
            }

            if (receipt) {
                receipt.meta = {
                    ...(receipt.meta || {}),
                    movements: {
                        outboundId: outboundMovement?.id || null,
                        inboundId: inboundMovement?.id || null
                    }
                };
                receipt.updatedAt = timestamp;
            }

            // FIX: Set product.updatedAt so _smartMerge preserves the stock change
            product.updatedAt = timestamp;

            CORE.markDirty('products');
            CORE.markDirty('stockMovements');
            CORE.markDirty('transferReceipts');
            // FIX: Use save(true) for IMMEDIATE localStorage write (not debounced)
            // Previously used save() which debounces 1s — refresh before write = data loss
            CORE.save(true);

            // FIX: Force immediate cloud push (500ms) so destination POS sees the transfer
            // Without this, cloud push is debounced 3s and stock reverts on refresh
            clearTimeout(CORE._cloudPushTimer);
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() && navigator.onLine) {
                CORE._cloudPushTimer = setTimeout(() => CORE._doCloudPush(0), 500);
            }

            UI.closeModal();
            UI.toast(`✓ ${qty} ${product.name} transféré(s) du dépôt principal à ${pos.name}`, 'success');
            ManagerModule._mainTransferMedia = [];
            App.rerender();
        },

        showStockDashboard() {
            const currentUser = CORE.state.currentUser || {};
            const currentView = this.state.currentView;
            // FILTRE POS STRICT: Si gestionnaire assigné à un POS (ex: Centre-Ville), NE MONTRER QUE CE POS
            const hasAssignedPos = currentUser.role === 'gestionnaire' && currentUser.pos;
            const forcedPosId = hasAssignedPos ? currentUser.pos : null;
            // Ignorer inventoryPosId si gestionnaire a un POS assigné (empêcher le changement de POS)
            const statePosCandidate = hasAssignedPos ? null : (this.state.inventoryPosId || null);
            const selectedPosId = statePosCandidate || null;
            const activePosId = forcedPosId ?? selectedPosId;
            const products = CORE.getVisibleProducts() || [];
            // Ne pas autoriser main-stock si gestionnaire a un POS assigné
            const isMainDepot = currentView === 'main-stock' && !hasAssignedPos;

            if (isMainDepot) {
                let totalQuantity = 0;
                let totalStockValue = 0;
                const lowStockProducts = [];
                const ruptures = [];
                const recommendations = [];

                products.forEach(p => {
                    const stock = p.stock || 0;
                    const price = p.price || 0;
                    totalQuantity += stock;
                    totalStockValue += stock * price;

                    if (stock === 0) {
                        ruptures.push({ productName: p.name });
                    }

                    if (stock <= (p.minStock || 0)) {
                        lowStockProducts.push({ product: p, stock });
                        const target = Math.round((p.minStock || 0) * 2);
                        const toOrder = Math.max(0, target - stock);
                        if (toOrder > 0) {
                            recommendations.push({
                                productName: p.name,
                                toOrder,
                                cost: toOrder * price
                            });
                        }
                    }
                });

                const topCritical = lowStockProducts
                    .sort((a, b) => {
                        const aMin = a.product.minStock || 1;
                        const bMin = b.product.minStock || 1;
                        return (a.stock / aMin) - (b.stock / bMin);
                    })
                    .slice(0, 12);

                const html = `
                    <div class="max-h-[85vh] overflow-y-auto space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                            <div class="p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl border border-blue-200">
                                <div class="text-xs font-black text-blue-600 uppercase">Total Articles</div>
                                <div class="text-3xl font-black text-blue-900 mt-2">${totalQuantity}</div>
                                <div class="text-xs text-blue-700 mt-1">en réserve centrale</div>
                            </div>
                            <div class="p-4 bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-2xl border border-emerald-200">
                                <div class="text-xs font-black text-emerald-600 uppercase">Valeur Stock</div>
                                <div class="text-2xl font-black text-emerald-900 mt-2">${CORE.formatPrice(totalStockValue)}</div>
                                <div class="text-xs text-emerald-700 mt-1">dépôt principal</div>
                            </div>
                            <div class="p-4 bg-gradient-to-br from-amber-50 to-amber-100 rounded-2xl border border-amber-200">
                                <div class="text-xs font-black text-amber-600 uppercase">Stock Bas</div>
                                <div class="text-3xl font-black text-amber-900 mt-2">${lowStockProducts.length}</div>
                                <div class="text-xs text-amber-700 mt-1">produits sous le minimum</div>
                            </div>
                            <div class="p-4 bg-gradient-to-br from-red-50 to-red-100 rounded-2xl border border-red-200">
                                <div class="text-xs font-black text-red-600 uppercase">Ruptures</div>
                                <div class="text-3xl font-black text-red-900 mt-2">${ruptures.length}</div>
                                <div class="text-xs text-red-700 mt-1">produits indisponibles</div>
                            </div>
                        </div>

                        ${topCritical.length > 0 ? `
                        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                            <div class="p-4 bg-slate-50 border-b border-slate-200">
                                <h3 class="font-black text-slate-900 text-lg">🚨 Priorités du dépôt principal</h3>
                                <p class="text-xs text-slate-500 mt-1">Produits à réapprovisionner en priorité</p>
                            </div>
                            <div class="overflow-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-600 uppercase">
                                        <tr>
                                            <th class="px-4 py-3 text-left">Produit</th>
                                            <th class="px-4 py-3 text-center">Stock</th>
                                            <th class="px-4 py-3 text-center">Min</th>
                                            <th class="px-4 py-3 text-center">Couverture</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        ${topCritical.map(item => {
                                            const min = item.product.minStock || 0;
                                            const coverage = min > 0 ? Math.round((item.stock / min) * 100) : 100;
                                            return `
                                                <tr class="hover:bg-slate-50">
                                                    <td class="px-4 py-3 font-black text-slate-900">${item.product.name}</td>
                                                    <td class="px-4 py-3 text-center font-bold text-slate-700">${item.stock}</td>
                                                    <td class="px-4 py-3 text-center font-bold text-slate-700">${min}</td>
                                                    <td class="px-4 py-3 text-center">
                                                        <span class="px-2 py-1 rounded text-xs font-bold ${coverage <= 50 ? 'bg-red-100 text-red-700' : coverage <= 80 ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}">${coverage}%</span>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : ''}

                        ${recommendations.length > 0 ? `
                        <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4">
                            <h3 class="font-black text-amber-900 text-lg mb-3">💡 Recommandations d'approvisionnement interne</h3>
                            <div class="space-y-2">
                                ${recommendations.slice(0, 10).map(r => `
                                    <div class="flex items-start justify-between p-3 bg-white rounded-lg border border-amber-100">
                                        <div class="flex-1">
                                            <div class="font-black text-slate-900">${r.productName}</div>
                                            <div class="text-xs text-amber-700 mt-1">Commander ${r.toOrder} unités</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-amber-900">${CORE.formatPrice(r.cost)}</div>
                                            <div class="text-xs text-amber-600">coût estimé</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${ruptures.length > 0 ? `
                        <div class="bg-red-50 border border-red-200 rounded-2xl p-4">
                            <h3 class="font-black text-red-900 text-lg mb-3">⚠️ Produits en rupture au dépôt principal</h3>
                            <div class="space-y-2">
                                ${ruptures.slice(0, 12).map(r => `
                                    <div class="p-3 bg-white rounded-lg border border-red-100 font-black text-red-800">
                                        ${r.productName || 'Produit'}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;

                UI.modal('📈 Dashboard Stock - Dépôt Principal', html, [{ label: 'Fermer', onclick: 'UI.closeModal()' }], 'max-w-4xl');
                return;
            }

            if (!activePosId) {
                UI.toast('Sélectionnez un POS pour afficher son dashboard', 'info');
                return;
            }

            const pos = CORE.getPOS(activePosId);
            if (!pos) {
                UI.toast('POS introuvable', 'error');
                return;
            }

            const productsForPos = products.filter(p => this.productBelongsToPos(p, activePosId));

            let totalQuantity = 0;
            let totalStockValue = 0;
            const lowStockProducts = [];
            const ruptures = [];
            const recommendations = [];

            productsForPos.forEach(p => {
                const stock = CORE.getProductStock(p.id, activePosId) || 0;
                const price = CORE.getProductPrice(p.id, activePosId) || (p.price || 0);
                totalQuantity += stock;
                totalStockValue += stock * price;

                if (stock === 0) {
                    ruptures.push({ productName: p.name });
                }

                const min = p.minStock || 0;
                if (stock <= min) {
                    lowStockProducts.push({ product: p, stock, min });
                    const target = Math.round(min * 2);
                    const toOrder = Math.max(0, target - stock);
                    if (toOrder > 0) {
                        recommendations.push({
                            productName: p.name,
                            toOrder,
                            cost: toOrder * price
                        });
                    }
                }
            });

            const topCritical = lowStockProducts
                .sort((a, b) => {
                    const aRatio = a.min > 0 ? (a.stock / a.min) : 1;
                    const bRatio = b.min > 0 ? (b.stock / b.min) : 1;
                    return aRatio - bRatio;
                })
                .slice(0, 12);

            const html = `
                <div class="max-h-[85vh] overflow-y-auto space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div class="p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl border border-blue-200">
                            <div class="text-xs font-black text-blue-600 uppercase">Articles POS</div>
                            <div class="text-3xl font-black text-blue-900 mt-2">${totalQuantity}</div>
                            <div class="text-xs text-blue-700 mt-1">${pos.name}</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-2xl border border-emerald-200">
                            <div class="text-xs font-black text-emerald-600 uppercase">Valeur Stock</div>
                            <div class="text-2xl font-black text-emerald-900 mt-2">${CORE.formatPrice(totalStockValue)}</div>
                            <div class="text-xs text-emerald-700 mt-1">évaluée au POS</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-amber-50 to-amber-100 rounded-2xl border border-amber-200">
                            <div class="text-xs font-black text-amber-600 uppercase">Stock Bas</div>
                            <div class="text-3xl font-black text-amber-900 mt-2">${lowStockProducts.length}</div>
                            <div class="text-xs text-amber-700 mt-1">produits à surveiller</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-red-50 to-red-100 rounded-2xl border border-red-200">
                            <div class="text-xs font-black text-red-600 uppercase">Ruptures</div>
                            <div class="text-3xl font-black text-red-900 mt-2">${ruptures.length}</div>
                            <div class="text-xs text-red-700 mt-1">produits indisponibles</div>
                        </div>
                    </div>

                    ${topCritical.length > 0 ? `
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b border-slate-200">
                            <h3 class="font-black text-slate-900 text-lg">🚨 Produits critiques pour ${pos.name}</h3>
                            <p class="text-xs text-slate-500 mt-1">Triés par couverture la plus faible</p>
                        </div>
                        <div class="overflow-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 text-xs font-black text-slate-600 uppercase">
                                    <tr>
                                        <th class="px-4 py-3 text-left">Produit</th>
                                        <th class="px-4 py-3 text-center">Stock</th>
                                        <th class="px-4 py-3 text-center">Min</th>
                                        <th class="px-4 py-3 text-center">Couverture</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${topCritical.map(item => {
                                        const coverage = item.min > 0 ? Math.round((item.stock / item.min) * 100) : 100;
                                        return `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-4 py-3 font-black text-slate-900">${item.product.name}</td>
                                                <td class="px-4 py-3 text-center font-bold ${item.stock === 0 ? 'text-red-600' : 'text-slate-700'}">${item.stock}</td>
                                                <td class="px-4 py-3 text-center font-bold text-slate-700">${item.min}</td>
                                                <td class="px-4 py-3 text-center">
                                                    <span class="px-2 py-1 rounded text-xs font-bold ${coverage <= 50 ? 'bg-red-100 text-red-700' : coverage <= 80 ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}">${coverage}%</span>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}

                    ${recommendations.length > 0 ? `
                    <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4">
                        <h3 class="font-black text-amber-900 text-lg mb-3">💡 Recommandations d'approvisionnement pour ${pos.name}</h3>
                        <div class="space-y-2">
                            ${recommendations.slice(0, 10).map(r => `
                                <div class="flex items-start justify-between p-3 bg-white rounded-lg border border-amber-100">
                                    <div class="flex-1">
                                        <div class="font-black text-slate-900">${r.productName}</div>
                                        <div class="text-xs text-amber-700 mt-1">Commander ${r.toOrder} unités</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-black text-amber-900">${CORE.formatPrice(r.cost)}</div>
                                        <div class="text-xs text-amber-600">coût estimé</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${ruptures.length > 0 ? `
                    <div class="bg-red-50 border border-red-200 rounded-2xl p-4">
                        <h3 class="font-black text-red-900 text-lg mb-3">❌ Ruptures détectées à ${pos.name}</h3>
                        <div class="space-y-2">
                            ${ruptures.slice(0, 12).map(r => `
                                <div class="p-3 bg-white rounded-lg border border-red-100 font-black text-red-800">
                                    ${r.productName || 'Produit'}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            UI.modal(`📈 Dashboard Stock - ${pos.name}`, html, [{ label: 'Fermer', onclick: 'UI.closeModal()' }], 'max-w-4xl');
        },

        showPosStatusIndicators() {
            const currentUser = CORE.state.currentUser || {};
            const currentView = this.state.currentView;
            // FILTRE POS STRICT: Si gestionnaire assigné à un POS (ex: Centre-Ville), NE MONTRER QUE CE POS
            const hasAssignedPos = currentUser.role === 'gestionnaire' && currentUser.pos;
            const forcedPosId = hasAssignedPos ? currentUser.pos : null;
            // Ignorer inventoryPosId si gestionnaire a un POS assigné (empêcher le changement de POS)
            const statePosCandidate = hasAssignedPos ? null : (this.state.inventoryPosId || null);
            const selectedPosId = statePosCandidate || null;
            const activePosId = forcedPosId ?? selectedPosId;
            const products = CORE.getVisibleProducts() || [];
            // Ne pas autoriser main-stock si gestionnaire a un POS assigné
            const isMainDepot = currentView === 'main-stock' && !hasAssignedPos;

            if (isMainDepot) {
                let totalStock = 0;
                let lowStockCount = 0;
                let ruptureCount = 0;
                const lowStockProducts = [];

                products.forEach(p => {
                    const stock = p.stock || 0;
                    totalStock += stock;

                    if (stock === 0) {
                        ruptureCount++;
                    } else if (stock <= (p.minStock || 0)) {
                        lowStockCount++;
                    }

                    if (stock <= (p.minStock || 0)) {
                        lowStockProducts.push({
                            name: p.name,
                            stock,
                            min: p.minStock || 0
                        });
                    }
                });

                const topLow = lowStockProducts
                    .sort((a, b) => {
                        const aRatio = a.min > 0 ? (a.stock / a.min) : 1;
                        const bRatio = b.min > 0 ? (b.stock / b.min) : 1;
                        return aRatio - bRatio;
                    })
                    .slice(0, 15);

                const html = `
                    <div class="max-h-[85vh] overflow-y-auto space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                                <div class="text-xs font-black text-emerald-600 uppercase">Articles en stock</div>
                                <div class="text-3xl font-black text-emerald-900 mt-2">${totalStock}</div>
                                <div class="text-xs text-emerald-700 mt-1">dépôt principal</div>
                            </div>
                            <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                                <div class="text-xs font-black text-amber-600 uppercase">Stock bas</div>
                                <div class="text-3xl font-black text-amber-900 mt-2">${lowStockCount}</div>
                                <div class="text-xs text-amber-700 mt-1">produits à surveiller</div>
                            </div>
                            <div class="p-4 bg-red-50 border border-red-200 rounded-2xl">
                                <div class="text-xs font-black text-red-600 uppercase">Ruptures</div>
                                <div class="text-3xl font-black text-red-900 mt-2">${ruptureCount}</div>
                                <div class="text-xs text-red-700 mt-1">produits indisponibles</div>
                            </div>
                        </div>

                        ${topLow.length > 0 ? `
                        <div class="bg-white border border-slate-200 rounded-2xl overflow-hidden">
                            <div class="p-4 bg-slate-50 border-b border-slate-200">
                                <h3 class="font-black text-slate-900 text-lg">🔎 Produits sensibles</h3>
                                <p class="text-xs text-slate-500 mt-1">Basés sur les seuils du dépôt principal</p>
                            </div>
                            <div class="overflow-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-600 uppercase">
                                        <tr>
                                            <th class="px-4 py-3 text-left">Produit</th>
                                            <th class="px-4 py-3 text-center">Stock</th>
                                            <th class="px-4 py-3 text-center">Min</th>
                                            <th class="px-4 py-3 text-center">Couverture</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        ${topLow.map(item => {
                                            const coverage = item.min > 0 ? Math.round((item.stock / item.min) * 100) : 100;
                                            return `
                                                <tr class="hover:bg-slate-50">
                                                    <td class="px-4 py-3 font-black text-slate-900">${item.name}</td>
                                                    <td class="px-4 py-3 text-center font-bold ${item.stock === 0 ? 'text-red-600' : 'text-slate-700'}">${item.stock}</td>
                                                    <td class="px-4 py-3 text-center font-bold text-slate-700">${item.min}</td>
                                                    <td class="px-4 py-3 text-center">
                                                        <span class="px-2 py-1 rounded text-xs font-bold ${coverage <= 50 ? 'bg-red-100 text-red-700' : coverage <= 80 ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}">${coverage}%</span>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : ''}

                        ${ruptureCount === 0 ? `
                        <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-4 text-emerald-800 font-black">
                            ✅ Aucun produit en rupture dans le dépôt principal.
                        </div>
                        ` : ''}
                    </div>
                `;

                UI.modal('🎯 Indicateurs - Dépôt Principal', html, [{ label: 'Fermer', onclick: 'UI.closeModal()' }], 'max-w-3xl');
                return;
            }

            if (!activePosId) {
                UI.toast('Sélectionnez un POS pour afficher ses indicateurs', 'info');
                return;
            }

            const pos = CORE.getPOS(activePosId);
            if (!pos) {
                UI.toast('POS introuvable', 'error');
                return;
            }

            let totalStock = 0;
            let lowStockCount = 0;
            let ruptureCount = 0;
            const lowStockProducts = [];
            const ruptureProducts = [];

            products.forEach(p => {
                const stock = CORE.getProductStock(p.id, activePosId) || 0;
                totalStock += stock;

                if (stock === 0) {
                    ruptureCount++;
                    ruptureProducts.push(p.name);
                } else if (stock <= (p.minStock || 0)) {
                    lowStockCount++;
                }

                if (stock <= (p.minStock || 0)) {
                    lowStockProducts.push({
                        name: p.name,
                        stock,
                        min: p.minStock || 0
                    });
                }
            });

            const topLow = lowStockProducts
                .sort((a, b) => {
                    const aRatio = a.min > 0 ? (a.stock / a.min) : 1;
                    const bRatio = b.min > 0 ? (b.stock / b.min) : 1;
                    return aRatio - bRatio;
                })
                .slice(0, 15);

            const html = `
                <div class="max-h-[85vh] overflow-y-auto space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                            <div class="text-xs font-black text-emerald-600 uppercase">Articles en stock</div>
                            <div class="text-3xl font-black text-emerald-900 mt-2">${totalStock}</div>
                            <div class="text-xs text-emerald-700 mt-1">${pos.name}</div>
                        </div>
                        <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                            <div class="text-xs font-black text-amber-600 uppercase">Stock bas</div>
                            <div class="text-3xl font-black text-amber-900 mt-2">${lowStockCount}</div>
                            <div class="text-xs text-amber-700 mt-1">produits à surveiller</div>
                        </div>
                        <div class="p-4 bg-red-50 border border-red-200 rounded-2xl">
                            <div class="text-xs font-black text-red-600 uppercase">Ruptures</div>
                            <div class="text-3xl font-black text-red-900 mt-2">${ruptureCount}</div>
                            <div class="text-xs text-red-700 mt-1">articles indisponibles</div>
                        </div>
                    </div>

                    ${topLow.length > 0 ? `
                    <div class="bg-white border border-slate-200 rounded-2xl overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b border-slate-200">
                            <h3 class="font-black text-slate-900 text-lg">🔎 Produits critiques pour ${pos.name}</h3>
                            <p class="text-xs text-slate-500 mt-1">Basés sur les seuils du POS</p>
                        </div>
                        <div class="overflow-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 text-xs font-black text-slate-600 uppercase">
                                    <tr>
                                        <th class="px-4 py-3 text-left">Produit</th>
                                        <th class="px-4 py-3 text-center">Stock</th>
                                        <th class="px-4 py-3 text-center">Min</th>
                                        <th class="px-4 py-3 text-center">Couverture</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${topLow.map(item => {
                                        const coverage = item.min > 0 ? Math.round((item.stock / item.min) * 100) : 100;
                                        return `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-4 py-3 font-black text-slate-900">${item.name}</td>
                                                <td class="px-4 py-3 text-center font-bold ${item.stock === 0 ? 'text-red-600' : 'text-slate-700'}">${item.stock}</td>
                                                <td class="px-4 py-3 text-center font-bold text-slate-700">${item.min}</td>
                                                <td class="px-4 py-3 text-center">
                                                    <span class="px-2 py-1 rounded text-xs font-bold ${coverage <= 50 ? 'bg-red-100 text-red-700' : coverage <= 80 ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'}">${coverage}%</span>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    ` : ''}

                    ${ruptureProducts.length > 0 ? `
                    <div class="bg-red-50 border border-red-200 rounded-2xl p-4">
                        <h3 class="font-black text-red-900 text-lg mb-3">❌ Produits en rupture</h3>
                        <div class="space-y-2">
                            ${ruptureProducts.map(name => `
                                <div class="p-3 bg-white rounded-lg border border-red-100 font-black text-red-800">
                                    ${name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : `
                    <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-4 text-emerald-800 font-black">
                        ✅ Aucun produit en rupture pour ${pos.name}.
                    </div>
                    `}
                </div>
            `;

            UI.modal(`🎯 Indicateurs POS - ${pos.name}`, html, [{ label: 'Fermer', onclick: 'UI.closeModal()' }], 'max-w-3xl');
        },

        showTransferHistory() {
            const currentUser = CORE.state.currentUser || {};
            // FILTRE POS STRICT: Si gestionnaire assigné à un POS (ex: Centre-Ville), NE MONTRER QUE CE POS
            const hasAssignedPos = currentUser.role === 'gestionnaire' && currentUser.pos;
            const forcedPosId = hasAssignedPos ? currentUser.pos : null;

            const movements = CORE.getVisibleStockMovements() || [];
            const transfersRaw = movements.filter(m => {
                const hasBothPos = m.fromPosId !== null && m.fromPosId !== undefined && m.toPosId !== null && m.toPosId !== undefined;
                const managerDepotTransfer = m.meta?.source === 'manager_transfer' && m.toPosId !== null && m.toPosId !== undefined;
                const isRelevant = hasBothPos || managerDepotTransfer;

                // Appliquer le filtre POS strict si gestionnaire a un POS assigné
                if (forcedPosId && isRelevant) {
                    // Ne montrer que les transferts qui impliquent ce POS (entrant ou sortant)
                    return (m.fromPosId === forcedPosId || m.toPosId === forcedPosId);
                }
                return isRelevant;
            });

            if (transfersRaw.length === 0) {
                return UI.toast('Aucun transfert enregistré', 'info');
            }

            const MAIN_DEPOT_KEY = 'main_depot';
            const MAIN_DEPOT_NAME = 'Dépôt principal';

            const transfers = transfersRaw.map(t => {
                const fromPosName = t.fromPosName
                    || t.meta?.originName
                    || (t.fromPosId ? (CORE.getPOS(t.fromPosId)?.name || `POS ${t.fromPosId}`) : (t.meta?.source === 'manager_transfer' ? MAIN_DEPOT_NAME : '—'));
                const toPosName = t.toPosName
                    || t.meta?.destinationName
                    || (t.toPosId ? (CORE.getPOS(t.toPosId)?.name || `POS ${t.toPosId}`) : '—');

                return {
                    ...t,
                    fromPosName,
                    toPosName
                };
            });

            // Trier par date décroissante
            const sortedTransfers = [...transfers].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // Statistiques globales
            const stats = {
                totalTransfers: transfers.length,
                totalQuantity: transfers.reduce((sum, t) => sum + (t.quantity || 0), 0),
                totalValue: transfers.reduce((sum, t) => sum + (t.totalValue || 0), 0),
                uniqueProducts: new Set(transfers.map(t => t.productId)).size,
                uniqueUsers: new Set(transfers.map(t => t.userId)).size
            };

            // Analyse par POS (transferts sortants)
            const posSources = {};
            const posDestinations = {};

            transfers.forEach(t => {
                // Transferts sortants
                const sourceKey = (t.fromPosId !== null && t.fromPosId !== undefined) ? t.fromPosId : MAIN_DEPOT_KEY;
                if (!posSources[sourceKey]) {
                    posSources[sourceKey] = { qty: 0, value: 0, count: 0, name: t.fromPosName || (sourceKey === MAIN_DEPOT_KEY ? MAIN_DEPOT_NAME : `POS ${sourceKey}`) };
                }
                posSources[sourceKey].qty += t.quantity || 0;
                posSources[sourceKey].value += t.totalValue || 0;
                posSources[sourceKey].count += 1;

                // Transferts entrants
                const destKey = (t.toPosId !== null && t.toPosId !== undefined) ? t.toPosId : MAIN_DEPOT_KEY;
                if (!posDestinations[destKey]) {
                    posDestinations[destKey] = { qty: 0, value: 0, count: 0, name: t.toPosName || (destKey === MAIN_DEPOT_KEY ? MAIN_DEPOT_NAME : `POS ${destKey}`) };
                }
                posDestinations[destKey].qty += t.quantity || 0;
                posDestinations[destKey].value += t.totalValue || 0;
                posDestinations[destKey].count += 1;
            });

            // Produits les plus transférés
            const productTransfers = {};
            transfers.forEach(t => {
                if (!productTransfers[t.productId]) {
                    productTransfers[t.productId] = { name: t.productName, qty: 0, count: 0 };
                }
                productTransfers[t.productId].qty += t.quantity || 0;
                productTransfers[t.productId].count += 1;
            });

            const topProducts = Object.entries(productTransfers)
                .map(([id, data]) => ({ id, ...data }))
                .sort((a, b) => b.qty - a.qty)
                .slice(0, 5);

            const html = `
                <div class="max-h-[85vh] overflow-y-auto space-y-6">
                    <!-- KPIs Globaux -->
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                        <div class="p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl border border-blue-200">
                            <div class="text-xs font-black text-blue-600 uppercase">Total Transferts</div>
                            <div class="text-3xl font-black text-blue-900 mt-2">${stats.totalTransfers}</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl border border-purple-200">
                            <div class="text-xs font-black text-purple-600 uppercase">Articles Transférés</div>
                            <div class="text-3xl font-black text-purple-900 mt-2">${stats.totalQuantity}</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-2xl border border-emerald-200">
                            <div class="text-xs font-black text-emerald-600 uppercase">Valeur Transférée</div>
                            <div class="text-2xl font-black text-emerald-900 mt-2">${CORE.formatPrice(stats.totalValue)}</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-2xl border border-indigo-200">
                            <div class="text-xs font-black text-indigo-600 uppercase">Produits</div>
                            <div class="text-3xl font-black text-indigo-900 mt-2">${stats.uniqueProducts}</div>
                        </div>
                        <div class="p-4 bg-gradient-to-br from-pink-50 to-pink-100 rounded-2xl border border-pink-200">
                            <div class="text-xs font-black text-pink-600 uppercase">Utilisateurs</div>
                            <div class="text-3xl font-black text-pink-900 mt-2">${stats.uniqueUsers}</div>
                        </div>
                    </div>

                    <!-- Produits les plus transférés -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5">
                        <h3 class="font-black text-slate-900 text-lg mb-4">🏆 Top 5 Produits Transférés</h3>
                        <div class="space-y-2">
                            ${topProducts.map((p, i) => `
                                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl hover:bg-slate-100">
                                    <div class="flex items-center gap-3 flex-1">
                                        <div class="w-8 h-8 rounded-full ${
                                            i === 0 ? 'bg-yellow-100 text-yellow-700' :
                                            i === 1 ? 'bg-gray-100 text-gray-700' :
                                            i === 2 ? 'bg-orange-100 text-orange-700' :
                                            'bg-slate-200 text-slate-600'
                                        } flex items-center justify-center font-black text-sm">
                                            ${i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : i + 1}
                                        </div>
                                        <div class="min-w-0 flex-1">
                                            <div class="font-black text-slate-900">${p.name}</div>
                                            <div class="text-xs text-slate-500">${p.count} transfert(s)</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-black text-slate-900">${p.qty} unités</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Journal détaillé des transferts -->
                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                        <div class="p-5 bg-slate-50 border-b border-slate-200">
                            <h3 class="font-black text-slate-900 text-lg">📋 Journal Complet des Transferts</h3>
                            <p class="text-xs text-slate-500 mt-1">${transfers.length} transfert(s) enregistré(s)</p>
                        </div>
                        <div class="overflow-auto max-h-96">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 sticky top-0 text-xs font-black text-slate-600 uppercase">
                                    <tr>
                                        <th class="px-4 py-3 text-left">Date</th>
                                        <th class="px-4 py-3 text-left">Produit</th>
                                        <th class="px-4 py-3 text-center">Qtité</th>
                                        <th class="px-4 py-3 text-left">De POS</th>
                                        <th class="px-4 py-3 text-left">Vers POS</th>
                                        <th class="px-4 py-3 text-left">Motif</th>
                                        <th class="px-4 py-3 text-left">Utilisateur</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${sortedTransfers.map(t => `
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-4 py-3 font-bold text-slate-700 whitespace-nowrap">
                                                ${new Date(t.timestamp).toLocaleDateString('fr-FR', { year: 'numeric', month: '2-digit', day: '2-digit' })}
                                                <br>
                                                <span class="text-xs text-slate-500">${new Date(t.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</span>
                                            </td>
                                            <td class="px-4 py-3">
                                                <div class="font-bold text-slate-900">${t.productName}</div>
                                                <div class="text-xs text-slate-500">${t.productSku}</div>
                                            </td>
                                            <td class="px-4 py-3 text-center font-black text-slate-900">${t.quantity}</td>
                                            <td class="px-4 py-3">
                                                <span class="px-2 py-1 bg-red-100 text-red-700 rounded font-bold text-xs">${t.fromPosName}</span>
                                            </td>
                                            <td class="px-4 py-3">
                                                <span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded font-bold text-xs">${t.toPosName}</span>
                                            </td>
                                            <td class="px-4 py-3 text-sm">${t.reason || t.notes || '—'}</td>
                                            <td class="px-4 py-3 text-sm font-bold text-slate-700">${t.userName}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Analyse par POS -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- POS Sources (transferts sortants) -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-5">
                            <h3 class="font-black text-slate-900 text-lg mb-4">📤 Transferts Sortants par POS</h3>
                            <div class="space-y-3">
                                        ${Object.entries(posSources).map(([posId, data]) => {
                                    const pos = Number.isNaN(Number(posId)) ? null : CORE.getPOS(Number(posId));
                                    const displayName = data.name || pos?.name || (posId === MAIN_DEPOT_KEY ? MAIN_DEPOT_NAME : `POS ${posId}`);
                                    return `
                                        <div class="p-3 bg-gradient-to-r from-red-50 to-red-100 rounded-xl border border-red-200">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="font-black text-slate-900">${displayName}</div>
                                                <span class="px-2 py-1 bg-red-200 text-red-800 rounded font-bold text-xs">${data.count} transfert(s)</span>
                                            </div>
                                            <div class="grid grid-cols-2 gap-2 text-sm">
                                                <div class="p-2 bg-white rounded">
                                                    <div class="text-xs text-slate-500">Quantité</div>
                                                    <div class="font-black text-slate-900">${data.qty}</div>
                                                </div>
                                                <div class="p-2 bg-white rounded">
                                                    <div class="text-xs text-slate-500">Valeur</div>
                                                    <div class="font-black text-slate-900">${CORE.formatPrice(data.value)}</div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- POS Destinations (transferts entrants) -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-5">
                            <h3 class="font-black text-slate-900 text-lg mb-4">📥 Transferts Entrants par POS</h3>
                            <div class="space-y-3">
                                        ${Object.entries(posDestinations).map(([posId, data]) => {
                                    const pos = Number.isNaN(Number(posId)) ? null : CORE.getPOS(Number(posId));
                                    const displayName = data.name || pos?.name || (posId === MAIN_DEPOT_KEY ? MAIN_DEPOT_NAME : `POS ${posId}`);
                                    return `
                                        <div class="p-3 bg-gradient-to-r from-emerald-50 to-emerald-100 rounded-xl border border-emerald-200">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="font-black text-slate-900">${displayName}</div>
                                                <span class="px-2 py-1 bg-emerald-200 text-emerald-800 rounded font-bold text-xs">${data.count} transfert(s)</span>
                                            </div>
                                            <div class="grid grid-cols-2 gap-2 text-sm">
                                                <div class="p-2 bg-white rounded">
                                                    <div class="text-xs text-slate-500">Quantité</div>
                                                    <div class="font-black text-slate-900">${data.qty}</div>
                                                </div>
                                                <div class="p-2 bg-white rounded">
                                                    <div class="text-xs text-slate-500">Valeur</div>
                                                    <div class="font-black text-slate-900">${CORE.formatPrice(data.value)}</div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            UI.modal('📋 Historique des Transferts de Stock', html, [{ label: 'Fermer', onclick: 'UI.closeModal()' }], 'max-w-5xl');
        },

        showRestockingAnalysis() {
            const currentUser = CORE.state.currentUser || {};
            // FILTRE POS STRICT: Si gestionnaire assigné à un POS (ex: Centre-Ville), NE MONTRER QUE CE POS
            const hasAssignedPos = currentUser.role === 'gestionnaire' && currentUser.pos;
            const forcedPosId = hasAssignedPos ? currentUser.pos : null;
            const currentView = this.state.currentView;
            // Ignorer inventoryPosId si gestionnaire a un POS assigné
            const rawStatePos = hasAssignedPos ? null : (this.state.inventoryPosId || null);
            const selectedPosId = rawStatePos || null;
            // Ne pas autoriser main-stock si gestionnaire a un POS assigné
            const activePosId = hasAssignedPos ? forcedPosId : (currentView === 'main-stock' ? null : (forcedPosId ?? selectedPosId));
            const pos = activePosId ? CORE.getPOS(activePosId) : null;
            const contextLabel = pos ? pos.name : (currentView === 'main-stock' && !hasAssignedPos ? 'Dépôt principal' : 'Tous les POS');

            const analysis = this.analyzeRestockingPatterns(activePosId);

            let html = `
                <div class="max-h-[80vh] overflow-y-auto space-y-6">
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm font-bold text-slate-600">
                        Contexte d'analyse: <span class="text-slate-900">${contextLabel}</span>
                    </div>
                    <!-- Aperçu global -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="p-4 bg-blue-50 rounded-xl border border-blue-200 text-center">
                            <div class="text-xs font-black text-blue-600 uppercase">Total Produits</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${analysis.totalProducts}</div>
                        </div>
                        <div class="p-4 bg-amber-50 rounded-xl border border-amber-200 text-center">
                            <div class="text-xs font-black text-amber-600 uppercase">Stock Bas</div>
                            <div class="text-2xl font-black text-amber-900 mt-1">${analysis.lowStockProducts}</div>
                        </div>
                        <div class="p-4 bg-red-50 rounded-xl border border-red-200 text-center">
                            <div class="text-xs font-black text-red-600 uppercase">Critique</div>
                            <div class="text-2xl font-black text-red-900 mt-1">${analysis.criticalStockProducts}</div>
                        </div>
                        <div class="p-4 bg-emerald-50 rounded-xl border border-emerald-200 text-center">
                            <div class="text-xs font-black text-emerald-600 uppercase">Over-Stock</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${analysis.overStockProducts}</div>
                        </div>
                    </div>

                    <!-- Statistiques clés -->
                    <div class="bg-gradient-to-r from-slate-50 to-slate-100 p-5 rounded-xl border border-slate-200 space-y-3">
                        <div class="font-black text-slate-900">📊 Statistiques Clés</div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-3 bg-white rounded-lg border border-slate-200">
                                <div class="text-xs text-slate-600 font-bold">Stock Moyen</div>
                                <div class="text-xl font-black text-slate-900 mt-1">${analysis.averageStockLevel} unités</div>
                            </div>
                            <div class="p-3 bg-white rounded-lg border border-slate-200">
                                <div class="text-xs text-slate-600 font-bold">Valeur Inventaire</div>
                                <div class="text-xl font-black text-slate-900 mt-1">${CORE.formatPrice(analysis.totalInventoryValue)}</div>
                            </div>
                            <div class="p-3 bg-white rounded-lg border border-slate-200">
                                <div class="text-xs text-slate-600 font-bold">Entrées (7j)</div>
                                <div class="text-xl font-black text-emerald-600 mt-1">+${analysis.recentMovementsIn}</div>
                            </div>
                            <div class="p-3 bg-white rounded-lg border border-slate-200">
                                <div class="text-xs text-slate-600 font-bold">Sorties (7j)</div>
                                <div class="text-xl font-black text-red-600 mt-1">-${analysis.recentMovementsOut}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Top produits en rotation -->
                    ${analysis.topMovingProducts.length > 0 ? `
                        <div class="bg-white border border-slate-200 rounded-xl p-5 space-y-3">
                            <div class="font-black text-slate-900">🔄 Top 10 Produits en Rotation (30j)</div>
                            <div class="space-y-2">
                                ${analysis.topMovingProducts.map((item, idx) => `
                                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center justify-between">
                                        <div class="flex-1">
                                            <div class="font-bold text-slate-900">${idx+1}. ${item.product.name}</div>
                                            <div class="text-xs text-slate-500 mt-1">
                                                <span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-bold mr-2">↓ ${item.outQty} sorties</span>
                                                <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">↑ ${item.inQty} entrées</span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-amber-600">${item.turns.toFixed(2)} rotations</div>
                                            <div class="text-xs text-slate-500">Stock: ${item.currentStock}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Analyse fournisseurs -->
                    ${analysis.supplierStats.length > 0 ? `
                        <div class="bg-white border border-slate-200 rounded-xl p-5 space-y-3">
                            <div class="font-black text-slate-900">🏭 Analyse Fournisseurs</div>
                            <div class="space-y-2">
                                ${analysis.supplierStats.filter(s => s.productsCount > 0).map(stat => `
                                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-200">
                                        <div class="flex items-center justify-between">
                                            <div>
                                                <div class="font-bold text-slate-900">${stat.supplier.name}</div>
                                                <div class="text-xs text-slate-500 mt-1">
                                                    <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded mr-2">📦 ${stat.productsCount} produits</span>
                                                    <span class="px-2 py-1 bg-amber-100 text-amber-700 rounded">${stat.pendingOrders} en attente</span>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-black">${CORE.formatPrice(stat.totalSpent)}</div>
                                                <div class="text-xs text-slate-500">Total dépensé</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            UI.modal('📊 Analyse Avancée du Réapprovisionnement', html, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        renderInventory(options = {}) {
            const { forcePosId = null, hidePosSelector = false } = options;
            const tab = this.state.inventoryTab;
            const currentUser = CORE.state.currentUser || {};
            const resolvedForcedPosId = forcePosId !== null && forcePosId !== undefined
                ? forcePosId
                : (currentUser.role === 'gestionnaire' ? (currentUser.pos || currentUser.storeId) : null);
            // BUG FIX: Don't use parseInt — IDs can be UUIDs
            const forcedPosId = resolvedForcedPosId !== null && resolvedForcedPosId !== undefined
                ? resolvedForcedPosId
                : null;
            if (forcedPosId) {
                this.state.inventoryPosId = String(forcedPosId);
            }
            const posId = forcedPosId ?? (this.state.inventoryPosId || null);
            const pos = posId ? CORE.getPOS(posId) : null;
            const allowPosSwitch = !forcedPosId && !hidePosSelector;
            const allPos = CORE.db.pointsOfSale || [];
            const visiblePosList = allowPosSwitch ? (pos ? [pos] : allPos) : (pos ? [pos] : []);

            // Filter products by POS if selected
            const matchesSelectedPos = (product) => ManagerModule.productBelongsToPos(product, posId);

            const filteredProducts = CORE.getVisibleProducts().filter(matchesSelectedPos);

            const products = this.getProductsFiltered();
            const movs = this.getMovementsFiltered();

            // Calculate inventory value using per-POS stock if selected
            const invValue = filteredProducts.reduce((a,p)=> {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                const price = posId ? CORE.getProductPrice(p.id, posId) : (p.price || 0);
                return a + price * stock;
            }, 0);

            // Count low/critical stock items using per-POS values
            const lowCount = filteredProducts.filter(p => {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                return stock <= p.minStock;
            }).length;

            const criticalCount = filteredProducts.filter(p => {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                return stock <= (p.minStock * 0.5);
            }).length;

            // Calculs pour le dashboard de réappro using per-POS stock
            const allProducts = filteredProducts || [];
            const lowStockProducts = allProducts.filter(p => {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                return stock <= p.minStock;
            });
            let totalToReorder = 0;
            let totalReorderCost = 0;
            let topCriticalProducts = [];

            lowStockProducts.forEach(p => {
                const stock = posId ? CORE.getProductStock(p.id, posId) : (p.stock || 0);
                const qty = Math.round((p.minStock || 0) * 2) - stock;
                if (qty > 0) {
                    totalToReorder += qty;
                    totalReorderCost += qty * (p.price || 0);
                }
            });

            topCriticalProducts = lowStockProducts
                .sort((a, b) => {
                    const aStock = posId ? CORE.getProductStock(a.id, posId) : (a.stock || 0);
                    const bStock = posId ? CORE.getProductStock(b.id, posId) : (b.stock || 0);
                    return ((aStock || 0) / (a.minStock || 1)) - ((bStock || 0) / (b.minStock || 1));
                })
                .slice(0, 5);

            const posOptions = allowPosSwitch
                ? [{value:'',label:'Tous les POS'}, ...allPos.map(p=>({value:p.id,label:p.name}))]
                : (pos ? [{ value: pos.id, label: pos.name }] : []);

            // PRE-COMPUTE all heavy template sections to avoid deep stack nesting in template literals
            // (prevents "Maximum call stack size exceeded" on mobile browsers)

            // 1. POS selector options
            var posOptionsHtml = posOptions.map(function(p) {
                return '<option value="' + p.value + '" ' + (ManagerModule.state.inventoryPosId === String(p.value) ? 'selected' : '') + '>' + p.label + '</option>';
            }).join('');

            // 2. Critical products alert section
            var criticalAlertsHtml = '';
            if (topCriticalProducts.length > 0) {
                var alertItems = [];
                for (var ci = 0; ci < topCriticalProducts.length; ci++) {
                    var cp = topCriticalProducts[ci];
                    var cpStock = posId ? CORE.getProductStock(cp.id, posId) : (cp.stock || 0);
                    var cpPercent = cp.minStock ? Math.round((cpStock / cp.minStock) * 100) : 0;
                    var cpToOrder = Math.round((cp.minStock || 0) * 2) - cpStock;
                    alertItems.push('<div class="flex items-center justify-between bg-white p-3 rounded-lg"><div class="flex-1"><div class="font-bold text-slate-900">' + cp.name + '</div><div class="text-xs text-slate-500">Stock: ' + cpStock + ' / Min: ' + (cp.minStock || 0) + '</div></div><div class="flex items-center gap-3"><div class="text-right"><div class="font-black text-red-600">' + cpPercent + '%</div><div class="text-xs text-slate-500">+' + cpToOrder + ' unités</div></div><div class="w-12 h-12 rounded-full ' + (cpPercent <= 25 ? 'bg-red-100 text-red-600' : 'bg-amber-100 text-amber-600') + ' flex items-center justify-center font-black">' + cpPercent + '%</div></div></div>');
                }
                criticalAlertsHtml = '<div class="bg-gradient-to-r from-red-50 to-amber-50 border border-red-200 rounded-2xl p-5"><div class="font-black text-slate-900 mb-4">⚡ Produits en Alerte Critique</div><div class="space-y-2">' + alertItems.join('') + '</div></div>';
            }

            // 3. Category filter options
            var categoryOptionsHtml = (CORE.db.categories || []).map(function(c) {
                return '<option value="' + c.id + '" ' + (ManagerModule.state.inventoryCategoryFilter == c.id ? 'selected' : '') + '>' + (c.name || '') + '</option>';
            }).join('');

            // 4. Product table rows (pre-computed)
            var productRowsHtml = '';
            if (products.length === 0) {
                productRowsHtml = '<tr><td colspan="8" class="px-6 py-12 text-center text-slate-400 font-medium">Aucun produit trouvé<div class="mt-4"><button onclick="ManagerModule.showNewProductModal()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-bold text-sm">+ Ajouter un produit</button></div></td></tr>';
            } else {
                var rowPosId = this.state.inventoryPosId || null;
                var rows = [];
                for (var ri = 0; ri < products.length; ri++) {
                    var p = products[ri];
                    var pStock = rowPosId ? CORE.getProductStock(p.id, rowPosId) : (p.stock || 0);
                    var pPrice = rowPosId ? CORE.getProductPrice(p.id, rowPosId) : (p.price || 0);
                    var pIsLow = pStock <= p.minStock;
                    // Stocks par POS
                    var posStockParts = [];
                    for (var vi = 0; vi < visiblePosList.length; vi++) {
                        var vp = visiblePosList[vi];
                        var vpStock = CORE.getProductStock(p.id, vp.id) || 0;
                        var vpIsCritical = vpStock <= (p.minStock * 0.5);
                        var vpIsLow = vpStock <= p.minStock && !vpIsCritical;
                        var vpBadge = 'bg-slate-100 text-slate-600';
                        if (vpIsCritical) vpBadge = 'bg-red-100 text-red-700 font-bold';
                        else if (vpIsLow) vpBadge = 'bg-amber-100 text-amber-700 font-bold';
                        posStockParts.push('<span class="px-2 py-1 rounded text-xs font-bold ' + vpBadge + '">' + vp.name.substring(0,8) + ': ' + vpStock + '</span>');
                    }
                    var catName = (CORE.getCategory(p.categoryId) || {}).name || '—';
                    var activeBadge = p.active ? UI.badge('Actif','emerald') : UI.badge('Inactif','slate');
                    var lowBadge = pIsLow ? '<span class="ml-2">' + UI.badge('Critique','red') + '</span>' : '';
                    rows.push('<tr class="hover:bg-slate-50"><td class="px-6 py-4"><div class="font-black text-slate-900">' + (p.name || '') + '</div><div class="text-[10px] text-slate-400">#' + (p.barcode || p.id) + '</div></td><td class="px-6 py-4"><span class="px-3 py-1 bg-slate-100 rounded-lg text-xs font-bold text-slate-600">' + catName + '</span></td><td class="px-6 py-4 text-right font-black">' + CORE.formatPrice(pPrice) + '</td><td class="px-6 py-4"><div class="flex flex-wrap gap-1">' + posStockParts.join(' ') + '</div></td><td class="px-6 py-4 text-center font-black ' + (pIsLow ? 'text-red-600' : 'text-slate-900') + '">' + pStock + '</td><td class="px-6 py-4 text-center font-black text-slate-700">' + (p.minStock || 0) + '</td><td class="px-6 py-4">' + activeBadge + ' ' + lowBadge + '</td><td class="px-6 py-4 text-right"><div class="flex items-center justify-end gap-2"><button onclick="ManagerModule.showProductInfoModal(\'' + p.id + '\')" class="px-3 py-2 rounded-xl bg-blue-600 text-white text-xs font-black hover:bg-blue-700" title="Détails produit">Info</button><button onclick="ManagerModule.showAdvancedStockModal(\'' + p.id + '\')" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-xs font-black hover:bg-emerald-700">Stock</button><button onclick="ManagerModule.showEditProductModal(\'' + p.id + '\')" class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs font-black hover:bg-slate-50">Éditer</button></div></td></tr>');
                }
                productRowsHtml = rows.join('');
            }

            // 5. Pagination HTML (pre-computed, no IIFE in template)
            var paginationHtml = '';
            try {
                var stats = this.getProductsStats();
                if (stats.totalPages <= 1) {
                    paginationHtml = stats.totalFiltered > 0 ? '<div class="p-4 text-center text-sm text-slate-500 border-t border-slate-100">' + stats.totalFiltered + ' produit(s)</div>' : '';
                } else {
                    var pageBtns = stats.paginationPages.map(function(pg) {
                        if (pg === '...') return '<span class="px-2 text-slate-400">...</span>';
                        return '<button onclick="ManagerModule.state.inventoryPage=' + pg + ';App.rerender()" class="px-3 py-2 rounded-lg ' + (pg === stats.currentPage ? 'bg-sky-600 text-white' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm">' + pg + '</button>';
                    }).join('');
                    var prevDis = stats.currentPage === 1;
                    var nextDis = stats.currentPage === stats.totalPages;
                    var disCls = 'bg-slate-100 text-slate-400 cursor-not-allowed';
                    var actCls = 'bg-slate-100 hover:bg-slate-200 text-slate-700';
                    paginationHtml = '<div class="p-4 border-t border-slate-100 flex flex-wrap items-center justify-between gap-4"><div class="text-sm text-slate-600 font-medium">' + (stats.totalFiltered === 0 ? 'Aucun produit' : 'Affichage ' + (stats.startIdx + 1) + '-' + Math.min(stats.startIdx + stats.perPage, stats.totalFiltered) + ' sur ' + stats.totalFiltered) + '</div><div class="flex items-center gap-2"><span class="text-xs text-slate-500">Par page:</span><select onchange="ManagerModule.state.inventoryPerPage=parseInt(this.value);ManagerModule.state.inventoryPage=1;App.rerender()" class="px-2 py-1 rounded-lg border border-slate-200 bg-white text-sm font-bold"><option value="25" ' + (stats.perPage === 25 ? 'selected' : '') + '>25</option><option value="50" ' + (stats.perPage === 50 ? 'selected' : '') + '>50</option><option value="100" ' + (stats.perPage === 100 ? 'selected' : '') + '>100</option><option value="200" ' + (stats.perPage === 200 ? 'selected' : '') + '>200</option></select></div><div class="flex items-center gap-2"><button onclick="ManagerModule.state.inventoryPage=1;App.rerender()" class="px-3 py-2 rounded-lg ' + (prevDis ? disCls : actCls) + ' font-bold text-sm" ' + (prevDis ? 'disabled' : '') + '><i data-lucide="chevrons-left" class="w-4 h-4"></i></button><button onclick="ManagerModule.state.inventoryPage=Math.max(1,ManagerModule.state.inventoryPage-1);App.rerender()" class="px-3 py-2 rounded-lg ' + (prevDis ? disCls : actCls) + ' font-bold text-sm" ' + (prevDis ? 'disabled' : '') + '><i data-lucide="chevron-left" class="w-4 h-4"></i></button>' + pageBtns + '<button onclick="ManagerModule.state.inventoryPage=Math.min(' + stats.totalPages + ',ManagerModule.state.inventoryPage+1);App.rerender()" class="px-3 py-2 rounded-lg ' + (nextDis ? disCls : actCls) + ' font-bold text-sm" ' + (nextDis ? 'disabled' : '') + '><i data-lucide="chevron-right" class="w-4 h-4"></i></button><button onclick="ManagerModule.state.inventoryPage=' + stats.totalPages + ';App.rerender()" class="px-3 py-2 rounded-lg ' + (nextDis ? disCls : actCls) + ' font-bold text-sm" ' + (nextDis ? 'disabled' : '') + '><i data-lucide="chevrons-right" class="w-4 h-4"></i></button></div></div>';
                }
            } catch(pe) { console.warn('[Inventory] Pagination error:', pe); }

            // 6. Movements table rows (pre-computed)
            var movRowsHtml = '';
            if (movs.length === 0) {
                movRowsHtml = '<tr><td colspan="6" class="px-6 py-12 text-center text-slate-400 font-medium">Aucun mouvement</td></tr>';
            } else {
                var mRows = [];
                for (var mi = 0; mi < movs.length; mi++) {
                    var m = movs[mi];
                    var mTypeBadge = UI.badge(m.type, m.type==='out'?'red':m.type==='in'?'emerald':'blue');
                    mRows.push('<tr class="hover:bg-slate-50"><td class="px-6 py-4"><div class="font-black text-slate-900">' + (m.productName || '—') + '</div><div class="text-[10px] text-slate-400">#' + (m.productId || '') + '</div></td><td class="px-6 py-4">' + mTypeBadge + '</td><td class="px-6 py-4 text-right font-black ' + (m.type==='out'?'text-red-600':'text-slate-900') + '">' + (m.type==='out' ? '-' : '+') + m.qty + '</td><td class="px-6 py-4 text-sm font-bold text-slate-700">' + (m.ref || '—') + '</td><td class="px-6 py-4 text-sm text-slate-600">' + (m.userName || 'System') + '</td><td class="px-6 py-4 text-right text-xs text-slate-500">' + CORE.formatDate(m.createdAt) + '</td></tr>');
                }
                movRowsHtml = mRows.join('');
            }

            // 7. Movement type filter options
            var movTypeOptions = [{value:'all',label:'Tous'},{value:'in',label:'Entrées'},{value:'out',label:'Sorties'},{value:'adjust',label:'Ajustements'}].map(function(o) {
                return '<option value="' + o.value + '" ' + (o.value===ManagerModule.state.movementsType?'selected':'') + '>' + o.label + '</option>';
            }).join('');

            // Now build the final template with minimal nesting (all heavy parts pre-computed)
            var posHeader = pos ? ': ' + pos.name : ' (tous)';
            var posSelectorHtml = allowPosSwitch ? '<select onchange="ManagerModule.state.inventoryPosId=this.value;App.rerender()" class="px-4 py-2.5 bg-white border border-slate-200 rounded-xl font-bold">' + posOptionsHtml + '</select>' : (pos ? '<div class="px-4 py-2.5 bg-slate-100 border border-slate-200 rounded-xl font-black text-sm text-slate-700">' + pos.name + '</div>' : '');
            var exportAction = tab==='products' ? 'ManagerModule.exportInventoryCSV()' : 'ManagerModule.exportMovementsCSV()';

            var productsTabActive = tab==='products' ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-700 hover:bg-slate-200';
            var movementsTabActive = tab==='movements' ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-700 hover:bg-slate-200';
            var catFilterSelected = this.state.inventoryCategoryFilter === 'all' ? 'selected' : '';
            var statusFilterSelected = this.state.inventoryStatusFilter || 'all';
            var sortByVal = this.state.inventorySortBy || 'name';

            var filtersHtml = tab === 'products' ?
                '<div class="flex flex-wrap gap-2 items-center"><div class="relative"><i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i><input id="manager-inventory-search-input" type="text" value="' + (this.state.inventorySearch || '') + '" onkeyup="ManagerModule.updateInventorySearch(this.value)" placeholder="Rechercher produit..." class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium w-[200px]" style="direction: ltr; text-align: left;" autocomplete="off"></div><select onchange="ManagerModule.state.inventoryCategoryFilter=this.value;ManagerModule.state.inventoryPage=1;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold"><option value="all" ' + catFilterSelected + '>Toutes catégories</option>' + categoryOptionsHtml + '</select><select onchange="ManagerModule.state.inventoryStatusFilter=this.value;ManagerModule.state.inventoryPage=1;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold"><option value="all" ' + (statusFilterSelected === 'all' ? 'selected' : '') + '>Tous les stocks</option><option value="ok" ' + (statusFilterSelected === 'ok' ? 'selected' : '') + '>✅ Stock OK</option><option value="low" ' + (statusFilterSelected === 'low' ? 'selected' : '') + '>⚠️ Stock bas</option><option value="critical" ' + (statusFilterSelected === 'critical' ? 'selected' : '') + '>🔴 Critique</option><option value="outofstock" ' + (statusFilterSelected === 'outofstock' ? 'selected' : '') + '>❌ Rupture</option></select><select onchange="ManagerModule.state.inventorySortBy=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold"><option value="name" ' + (sortByVal === 'name' ? 'selected' : '') + '>Nom A-Z</option><option value="name_desc" ' + (sortByVal === 'name_desc' ? 'selected' : '') + '>Nom Z-A</option><option value="stock_asc" ' + (sortByVal === 'stock_asc' ? 'selected' : '') + '>Stock ↑</option><option value="stock_desc" ' + (sortByVal === 'stock_desc' ? 'selected' : '') + '>Stock ↓</option><option value="critical" ' + (sortByVal === 'critical' ? 'selected' : '') + '>+ Critiques</option></select></div>'
                : '<div class="flex gap-2 flex-wrap"><div class="relative"><i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i><input id="manager-movements-search-input" type="text" value="' + (this.state.movementsSearch || '') + '" onkeyup="ManagerModule.updateMovementsSearch(this.value)" placeholder="Produit, ref, user..." class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium w-[260px] max-w-full" style="direction: ltr; text-align: left;" autocomplete="off"></div><select onchange="ManagerModule.state.movementsType=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">' + movTypeOptions + '</select></div>';

            var tabContentHtml = tab === 'products' ?
                '<div class="overflow-auto"><table class="w-full text-left min-w-[1050px]"><thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider"><tr><th class="px-6 py-4">Produit</th><th class="px-6 py-4">Catégorie</th><th class="px-6 py-4 text-right">Prix</th><th class="px-6 py-4">Stock par POS</th><th class="px-6 py-4 text-center">Stock</th><th class="px-6 py-4 text-center">Min</th><th class="px-6 py-4">État</th><th class="px-6 py-4 text-right">Actions</th></tr></thead><tbody class="divide-y divide-slate-50">' + productRowsHtml + '</tbody></table></div>' + paginationHtml
                : '<div class="overflow-auto"><table class="w-full text-left min-w-[1050px]"><thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider"><tr><th class="px-6 py-4">Produit</th><th class="px-6 py-4">Type</th><th class="px-6 py-4 text-right">Qté</th><th class="px-6 py-4">Réf</th><th class="px-6 py-4">Utilisateur</th><th class="px-6 py-4 text-right">Date</th></tr></thead><tbody class="divide-y divide-slate-50">' + movRowsHtml + '</tbody></table></div>';

            return '<div class="fade-in max-w-7xl mx-auto space-y-6">' +
                '<div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4"><div><h2 class="text-2xl font-black text-slate-900">Stock Control Center</h2><p class="text-slate-500 font-medium">Gestion avancée répartie par POS' + posHeader + '.</p></div><div class="flex flex-wrap gap-2 items-center">' + posSelectorHtml + '<button onclick="ManagerModule.showNewProductModal()" class="px-4 py-2.5 bg-sky-600 text-white font-black rounded-xl hover:bg-sky-700 transition">Nouveau produit</button><button onclick="ManagerModule.showStockDashboard()" class="px-4 py-2.5 bg-indigo-600 text-white font-black rounded-xl hover:bg-indigo-700 transition">📈 Dashboard</button><button onclick="ManagerModule.showPosStatusIndicators()" class="px-4 py-2.5 bg-cyan-600 text-white font-black rounded-xl hover:bg-cyan-700 transition">🎯 Indicateurs</button><button onclick="ManagerModule.showTransferHistory()" class="px-4 py-2.5 bg-teal-600 text-white font-black rounded-xl hover:bg-teal-700 transition">📋 Historique</button><button onclick="ManagerModule.showBulkRestockModal()" class="px-4 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition">Réappro masse</button><button onclick="ManagerModule.showStockTransferModal(\'' + (posId || '') + '\')" class="px-4 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition">🔄 Transférer</button><button onclick="ManagerModule.showRestockingAnalysis()" class="px-4 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition">📊 Analyse</button><button onclick="ManagerModule.exportRestockingRecommendations()" class="px-4 py-2.5 bg-amber-600 text-white font-black rounded-xl hover:bg-amber-700 transition">Recommandations</button><button onclick="' + exportAction + '" class="px-4 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition">Exporter CSV</button></div></div>' +
                '<div class="grid grid-cols-1 md:grid-cols-4 gap-4"><div class="bg-gradient-to-br from-blue-50 to-blue-100 p-5 rounded-2xl border border-blue-200"><div class="flex items-center justify-between"><div><div class="text-xs font-black text-blue-600 uppercase">Stock Bas</div><div class="text-3xl font-black text-blue-900 mt-2">' + lowCount + '</div></div><div class="text-5xl opacity-20">📦</div></div></div><div class="bg-gradient-to-br from-red-50 to-red-100 p-5 rounded-2xl border border-red-200"><div class="flex items-center justify-between"><div><div class="text-xs font-black text-red-600 uppercase">Critique</div><div class="text-3xl font-black text-red-900 mt-2">' + criticalCount + '</div></div><div class="text-5xl opacity-20">⚠️</div></div></div><div class="bg-gradient-to-br from-amber-50 to-amber-100 p-5 rounded-2xl border border-amber-200"><div class="flex items-center justify-between"><div><div class="text-xs font-black text-amber-600 uppercase">À Commander</div><div class="text-3xl font-black text-amber-900 mt-2">' + totalToReorder + '</div></div><div class="text-5xl opacity-20">🛒</div></div></div><div class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-5 rounded-2xl border border-emerald-200"><div class="flex items-center justify-between"><div><div class="text-xs font-black text-emerald-600 uppercase">Coût Réappro</div><div class="text-2xl font-black text-emerald-900 mt-2">' + CORE.formatPrice(totalReorderCost) + '</div></div><div class="text-5xl opacity-20">💰</div></div></div></div>' +
                criticalAlertsHtml +
                '<div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div class="bg-white p-6 rounded-3xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase tracking-wider">Valorisation stock</div><div class="mt-2 text-3xl font-black text-slate-900">' + CORE.formatPrice(invValue) + '</div></div><div class="bg-white p-6 rounded-3xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase tracking-wider">Produits</div><div class="mt-2 text-3xl font-black text-slate-900">' + filteredProducts.length + '</div></div><div class="bg-white p-6 rounded-3xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase tracking-wider">Alertes</div><div class="mt-2 text-3xl font-black text-red-600">' + lowCount + '</div></div></div>' +
                '<div class="bg-white rounded-3xl border border-slate-200 overflow-hidden"><div class="p-4 border-b border-slate-100 flex flex-col md:flex-row md:items-center justify-between gap-3"><div class="flex items-center gap-2"><button onclick="ManagerModule.state.inventoryTab=\'products\';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ' + productsTabActive + '">Produits</button><button onclick="ManagerModule.state.inventoryTab=\'movements\';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ' + movementsTabActive + '">Mouvements</button></div>' + filtersHtml + '</div>' + tabContentHtml + '</div>' +
            '</div>';
        },

        renderMainStockControlCenter() { console.log('[MainStock] renderMainStockControlCenter called, products:', (CORE.db.products || []).length, 'hasMainWarehouse:', (CORE.db.products || []).some(p => p.isMainWarehouse));
            // DÉPÔT PRINCIPAL - Stock master indépendant de tous les POS
            // Si aucun produit n'a isMainWarehouse, afficher TOUS les produits actifs
            const hasMainWarehouseProducts = (CORE.db.products || []).some(p => p.isMainWarehouse && p.active !== false);
            const searchQuery = (this.state.inventorySearch || '').toLowerCase().trim();
            const categoryFilter = this.state.mainStockCategoryFilter || 'all';
            const stockFilter = this.state.mainStockStatusFilter || 'all';
            const sortBy = this.state.mainStockSortBy || 'name';
            const sortDir = this.state.mainStockSortDir || 'asc';
            const page = this.state.mainStockPage || 1;
            const perPage = this.state.mainStockPerPage || 50;

            let mainWarehouseProducts = (CORE.db.products || []).filter(p => {
                if (hasMainWarehouseProducts) { if (!p.isMainWarehouse || p.active === false) return false; } else { if (p.active === false) return false; }
                if (searchQuery && !(p.name || '').toLowerCase().includes(searchQuery) && !(p.barcode || '').toLowerCase().includes(searchQuery)) return false;
                if (categoryFilter !== 'all' && p.categoryId != categoryFilter) return false;

                const stock = p.stock || 0;
                const minStock = p.minStock || 0;
                if (stockFilter === 'critical' && stock > minStock * 0.5) return false;
                if (stockFilter === 'low' && (stock > minStock || stock <= minStock * 0.5)) return false;
                if (stockFilter === 'ok' && stock <= minStock) return false;
                if (stockFilter === 'outofstock' && stock > 0) return false;

                return true;
            });

            // Tri
            mainWarehouseProducts.sort((a, b) => {
                let valA, valB;
                switch (sortBy) {
                    case 'stock': valA = a.stock || 0; valB = b.stock || 0; break;
                    case 'value': valA = (a.stock || 0) * (a.price || 0); valB = (b.stock || 0) * (b.price || 0); break;
                    case 'price': valA = a.price || 0; valB = b.price || 0; break;
                    default: valA = (a.name || '').toLowerCase(); valB = (b.name || '').toLowerCase();
                }
                if (sortDir === 'desc') return valA > valB ? -1 : 1;
                return valA < valB ? -1 : 1;
            });

            // Pagination
            const totalFiltered = mainWarehouseProducts.length;
            const totalPages = Math.ceil(totalFiltered / perPage);
            const currentPage = Math.min(page, totalPages || 1);
            const startIdx = (currentPage - 1) * perPage;
            const paginatedProducts = mainWarehouseProducts.slice(startIdx, startIdx + perPage);

            // Generate pagination buttons
            const paginationPages = [];
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationPages.push(i);
                } else if (paginationPages[paginationPages.length - 1] !== '...') {
                    paginationPages.push('...');
                }
            }

            const allMainProducts = hasMainWarehouseProducts
                ? (CORE.db.products || []).filter(p => p.isMainWarehouse && p.active !== false)
                : (CORE.db.products || []).filter(p => p.active !== false);
            const mainStockMetrics = {
                totalProducts: allMainProducts.length,
                totalUnits: allMainProducts.reduce((sum, p) => sum + (p.stock || 0), 0),
                totalValue: allMainProducts.reduce((sum, p) => sum + (p.stock || 0) * (p.price || 0), 0),
                lowStockCount: allMainProducts.filter(p => (p.stock || 0) <= (p.minStock || 0) && (p.stock || 0) > (p.minStock || 0) * 0.5).length,
                criticalCount: allMainProducts.filter(p => (p.stock || 0) <= ((p.minStock || 0) * 0.5) && (p.stock || 0) > 0).length,
                outOfStockCount: allMainProducts.filter(p => (p.stock || 0) === 0).length,
                okCount: allMainProducts.filter(p => (p.stock || 0) > (p.minStock || 0)).length
            };

            // Mouvements récents (7 derniers jours)
            const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const recentMovements = CORE.getVisibleStockMovements()
                .filter(m => {
                    const mDate = new Date(m.createdAt || m.timestamp || m.date || 0);
                    return hasMainWarehouseProducts ? (m.isMainWarehouse && mDate >= sevenDaysAgo) : (mDate >= sevenDaysAgo);
                })
                .sort((a, b) => new Date(b.createdAt || b.timestamp || b.date || 0) - new Date(a.createdAt || a.timestamp || a.date || 0))
                .slice(0, 10);

            // Transferts en attente
            const pendingTransfers = (CORE.db.stockTransfers || []).filter(t => t.status === 'pending').length;

            // Catégories pour filtre
            const categories = CORE.db.categories || [];

            // Top produits par valeur
            const topByValue = [...allMainProducts].sort((a, b) =>
                ((b.stock || 0) * (b.price || 0)) - ((a.stock || 0) * (a.price || 0))
            ).slice(0, 5);

            // Alertes prioritaires
            const urgentAlerts = allMainProducts
                .filter(p => (p.stock || 0) === 0 || (p.stock || 0) <= (p.minStock || 0) * 0.5)
                .slice(0, 5);

            return `
                <div class="fade-in max-w-full mx-auto space-y-6 p-4 lg:p-6">
                    <!-- Header avec actions rapides -->
                    <div class="bg-gradient-to-r from-slate-800 via-slate-900 to-slate-800 rounded-3xl p-6 text-white shadow-xl">
                        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                            <div>
                                <h2 class="text-3xl font-black flex items-center gap-3">
                                    <span class="w-12 h-12 bg-white/10 rounded-2xl flex items-center justify-center">🏭</span>
                                    Stock Control Center
                                </h2>
                                <p class="text-slate-300 mt-2 font-medium">Dépôt Principal • Gestion centralisée du stock master</p>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="ManagerModule.showNewProductModal('main')" class="px-4 py-2.5 bg-emerald-500 text-white font-bold rounded-xl hover:bg-emerald-600 transition flex items-center gap-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i> Nouveau
                                </button>
                                <button onclick="ManagerModule.showMainTransferModal()" class="px-4 py-2.5 bg-purple-500 text-white font-bold rounded-xl hover:bg-purple-600 transition flex items-center gap-2">
                                    <i data-lucide="arrow-right-left" class="w-4 h-4"></i> Transférer
                                </button>
                                <button onclick="ManagerModule.showBulkRestockModal()" class="px-4 py-2.5 bg-blue-500 text-white font-bold rounded-xl hover:bg-blue-600 transition flex items-center gap-2">
                                    <i data-lucide="package-plus" class="w-4 h-4"></i> Réappro
                                </button>
                                <div class="relative">
                                    <button onclick="this.nextElementSibling.classList.toggle('hidden')" class="px-4 py-2.5 bg-white/10 text-white font-bold rounded-xl hover:bg-white/20 transition flex items-center gap-2">
                                        <i data-lucide="more-horizontal" class="w-4 h-4"></i> Plus
                                    </button>
                                    <div class="hidden absolute right-0 top-full mt-2 bg-white rounded-xl shadow-2xl border border-slate-200 py-2 z-50 min-w-[200px]">
                                        <button onclick="ManagerModule.showStockDashboard(); this.parentElement.classList.add('hidden')" class="w-full px-4 py-2 text-left text-sm font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                            <i data-lucide="bar-chart-3" class="w-4 h-4"></i> Dashboard
                                        </button>
                                        <button onclick="ManagerModule.showRestockingAnalysis(); this.parentElement.classList.add('hidden')" class="w-full px-4 py-2 text-left text-sm font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                            <i data-lucide="brain" class="w-4 h-4"></i> Analyse IA
                                        </button>
                                        <button onclick="ManagerModule.showTransferHistory(); this.parentElement.classList.add('hidden')" class="w-full px-4 py-2 text-left text-sm font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                            <i data-lucide="history" class="w-4 h-4"></i> Historique
                                        </button>
                                        <button onclick="ManagerModule.showPosStatusIndicators(); this.parentElement.classList.add('hidden')" class="w-full px-4 py-2 text-left text-sm font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                            <i data-lucide="target" class="w-4 h-4"></i> Indicateurs POS
                                        </button>
                                        <hr class="my-2 border-slate-100">
                                        <button onclick="ManagerModule.exportRestockingRecommendations(); this.parentElement.classList.add('hidden')" class="w-full px-4 py-2 text-left text-sm font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                            <i data-lucide="file-text" class="w-4 h-4"></i> Recommandations
                                        </button>
                                        <button onclick="ManagerModule.exportMainStockCSV(); this.parentElement.classList.add('hidden')" class="w-full px-4 py-2 text-left text-sm font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-2">
                                            <i data-lucide="download" class="w-4 h-4"></i> Exporter CSV
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                        <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm hover:shadow-md transition cursor-pointer" onclick="ManagerModule.state.mainStockStatusFilter='all';App.rerender()">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="box" class="w-5 h-5 text-blue-600"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-black text-slate-900">${mainStockMetrics.totalProducts}</div>
                                    <div class="text-xs font-bold text-slate-500">Produits</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm hover:shadow-md transition">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="layers" class="w-5 h-5 text-indigo-600"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-black text-slate-900">${mainStockMetrics.totalUnits.toLocaleString()}</div>
                                    <div class="text-xs font-bold text-slate-500">Unités</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm hover:shadow-md transition">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="banknote" class="w-5 h-5 text-emerald-600"></i>
                                </div>
                                <div>
                                    <div class="text-lg font-black text-slate-900">${CORE.formatPrice(mainStockMetrics.totalValue)}</div>
                                    <div class="text-xs font-bold text-slate-500">Valeur</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-emerald-200 p-4 shadow-sm hover:shadow-md transition cursor-pointer ${stockFilter === 'ok' ? 'ring-2 ring-emerald-500' : ''}" onclick="ManagerModule.state.mainStockStatusFilter='ok';App.rerender()">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="check-circle" class="w-5 h-5 text-emerald-600"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-black text-emerald-600">${mainStockMetrics.okCount}</div>
                                    <div class="text-xs font-bold text-slate-500">OK</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-amber-200 p-4 shadow-sm hover:shadow-md transition cursor-pointer ${stockFilter === 'low' ? 'ring-2 ring-amber-500' : ''}" onclick="ManagerModule.state.mainStockStatusFilter='low';App.rerender()">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-black text-amber-600">${mainStockMetrics.lowStockCount}</div>
                                    <div class="text-xs font-bold text-slate-500">Bas</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-orange-200 p-4 shadow-sm hover:shadow-md transition cursor-pointer ${stockFilter === 'critical' ? 'ring-2 ring-orange-500' : ''}" onclick="ManagerModule.state.mainStockStatusFilter='critical';App.rerender()">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="alert-octagon" class="w-5 h-5 text-orange-600"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-black text-orange-600">${mainStockMetrics.criticalCount}</div>
                                    <div class="text-xs font-bold text-slate-500">Critique</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl border border-red-200 p-4 shadow-sm hover:shadow-md transition cursor-pointer ${stockFilter === 'outofstock' ? 'ring-2 ring-red-500' : ''}" onclick="ManagerModule.state.mainStockStatusFilter='outofstock';App.rerender()">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-red-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="x-circle" class="w-5 h-5 text-red-600"></i>
                                </div>
                                <div>
                                    <div class="text-2xl font-black text-red-600">${mainStockMetrics.outOfStockCount}</div>
                                    <div class="text-xs font-bold text-slate-500">Rupture</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Grid principal: Alertes + Top Valeur + Mouvements -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Alertes Urgentes -->
                        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-4 bg-gradient-to-r from-red-500 to-orange-500 text-white">
                                <div class="font-black flex items-center gap-2">
                                    <i data-lucide="bell-ring" class="w-5 h-5"></i> Alertes Urgentes
                                </div>
                                <div class="text-xs text-red-100 mt-1">Produits nécessitant une action immédiate</div>
                            </div>
                            <div class="p-4 space-y-3 max-h-64 overflow-auto">
                                ${urgentAlerts.length === 0 ? `
                                    <div class="text-center py-6">
                                        <div class="text-4xl mb-2">✅</div>
                                        <div class="text-sm font-bold text-emerald-600">Aucune alerte</div>
                                        <div class="text-xs text-slate-500">Tous les stocks sont corrects</div>
                                    </div>
                                ` : urgentAlerts.map(p => `
                                    <div class="flex items-center gap-3 p-3 ${(p.stock || 0) === 0 ? 'bg-red-50 border border-red-200' : 'bg-orange-50 border border-orange-200'} rounded-xl">
                                        <div class="w-10 h-10 rounded-xl ${(p.stock || 0) === 0 ? 'bg-red-500' : 'bg-orange-500'} flex items-center justify-center text-white font-black">
                                            ${(p.stock || 0) === 0 ? '!' : p.stock}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-slate-900 truncate">${p.name}</div>
                                            <div class="text-xs ${(p.stock || 0) === 0 ? 'text-red-600' : 'text-orange-600'} font-bold">
                                                ${(p.stock || 0) === 0 ? '🔴 RUPTURE' : '⚠️ Stock critique'}
                                            </div>
                                        </div>
                                        <button onclick="ManagerModule.quickRestock('${p.id}')" class="px-3 py-1.5 bg-white border border-slate-200 rounded-lg text-xs font-bold hover:bg-slate-50">
                                            +Stock
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Top par Valeur -->
                        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-4 bg-gradient-to-r from-emerald-500 to-teal-500 text-white">
                                <div class="font-black flex items-center gap-2">
                                    <i data-lucide="trophy" class="w-5 h-5"></i> Top Valorisation
                                </div>
                                <div class="text-xs text-emerald-100 mt-1">Produits à plus haute valeur en stock</div>
                            </div>
                            <div class="p-4 space-y-3">
                                ${topByValue.map((p, i) => {
                                    const value = (p.stock || 0) * (p.price || 0);
                                    return `
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-lg ${i === 0 ? 'bg-amber-500' : i === 1 ? 'bg-slate-400' : i === 2 ? 'bg-amber-700' : 'bg-slate-200'} flex items-center justify-center text-white font-black text-sm">
                                                ${i + 1}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="font-bold text-slate-900 truncate text-sm">${p.name}</div>
                                                <div class="text-xs text-slate-500">${p.stock || 0} unités</div>
                                            </div>
                                            <div class="font-black text-emerald-600 text-sm">${CORE.formatPrice(value)}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Mouvements Récents -->
                        <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-4 bg-gradient-to-r from-blue-500 to-indigo-500 text-white flex items-center justify-between">
                                <div>
                                    <div class="font-black flex items-center gap-2">
                                        <i data-lucide="activity" class="w-5 h-5"></i> Activité Récente
                                    </div>
                                    <div class="text-xs text-blue-100 mt-1">7 derniers jours</div>
                                </div>
                                ${pendingTransfers > 0 ? `
                                    <div class="px-3 py-1 bg-white/20 rounded-lg text-xs font-bold">
                                        ${pendingTransfers} transfert(s) en attente
                                    </div>
                                ` : ''}
                            </div>
                            <div class="p-4 space-y-2 max-h-64 overflow-auto">
                                ${recentMovements.length === 0 ? `
                                    <div class="text-center py-6 text-slate-400">
                                        <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                                        <div class="text-sm">Aucun mouvement récent</div>
                                    </div>
                                ` : recentMovements.map(m => {
                                    const mQty = m.qty ?? m.quantity ?? 0;
                                    const mDate = m.createdAt || m.timestamp || m.date;
                                    const isIn = m.type === 'in' || m.type === 'main_depot_transfer';
                                    const isOut = m.type === 'out';
                                    return `
                                    <div class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded-lg">
                                        <div class="w-8 h-8 rounded-lg ${isIn ? 'bg-emerald-100 text-emerald-600' : isOut ? 'bg-red-100 text-red-600' : 'bg-blue-100 text-blue-600'} flex items-center justify-center">
                                            <i data-lucide="${isIn ? 'arrow-down' : isOut ? 'arrow-up' : 'arrow-right-left'}" class="w-4 h-4"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-slate-900 truncate text-sm">${m.productName || 'Produit'}</div>
                                            <div class="text-xs text-slate-500">${CORE.formatDate(mDate)}</div>
                                        </div>
                                        <div class="font-black ${isIn ? 'text-emerald-600' : isOut ? 'text-red-600' : 'text-blue-600'} text-sm">
                                            ${isIn ? '+' : isOut ? '-' : '±'}${mQty}
                                        </div>
                                    </div>
                                `; }).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Tableau Stock avec filtres avancés -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                        <!-- Barre de filtres -->
                        <div class="p-4 border-b border-slate-100 bg-slate-50">
                            <div class="flex flex-col lg:flex-row lg:items-center gap-4">
                                <!-- Recherche -->
                                <div class="relative flex-1">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input id="main-stock-search" type="text" value="${this.state.inventorySearch || ''}"
                                        onkeyup="ManagerModule.state.inventorySearch=this.value;ManagerModule.state.mainStockPage=1;App.rerender()"
                                        placeholder="Rechercher par nom ou code-barres..."
                                        class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium focus:ring-2 focus:ring-blue-500 outline-none" autocomplete="off">
                                </div>

                                <!-- Filtre catégorie -->
                                <select onchange="ManagerModule.state.mainStockCategoryFilter=this.value;ManagerModule.state.mainStockPage=1;App.rerender()"
                                    class="px-4 py-2.5 rounded-xl border border-slate-200 bg-white font-bold text-sm">
                                    <option value="all" ${categoryFilter === 'all' ? 'selected' : ''}>Toutes catégories</option>
                                    ${categories.map(c => `<option value="${c.id}" ${categoryFilter == c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                </select>

                                <!-- Filtre statut -->
                                <select onchange="ManagerModule.state.mainStockStatusFilter=this.value;ManagerModule.state.mainStockPage=1;App.rerender()"
                                    class="px-4 py-2.5 rounded-xl border border-slate-200 bg-white font-bold text-sm">
                                    <option value="all" ${stockFilter === 'all' ? 'selected' : ''}>Tous les statuts</option>
                                    <option value="ok" ${stockFilter === 'ok' ? 'selected' : ''}>✅ Stock OK</option>
                                    <option value="low" ${stockFilter === 'low' ? 'selected' : ''}>⚠️ Stock bas</option>
                                    <option value="critical" ${stockFilter === 'critical' ? 'selected' : ''}>🔶 Critique</option>
                                    <option value="outofstock" ${stockFilter === 'outofstock' ? 'selected' : ''}>🔴 Rupture</option>
                                </select>

                                <!-- Tri -->
                                <select onchange="ManagerModule.state.mainStockSortBy=this.value;App.rerender()"
                                    class="px-4 py-2.5 rounded-xl border border-slate-200 bg-white font-bold text-sm">
                                    <option value="name" ${sortBy === 'name' ? 'selected' : ''}>Trier par nom</option>
                                    <option value="stock" ${sortBy === 'stock' ? 'selected' : ''}>Trier par stock</option>
                                    <option value="value" ${sortBy === 'value' ? 'selected' : ''}>Trier par valeur</option>
                                    <option value="price" ${sortBy === 'price' ? 'selected' : ''}>Trier par prix</option>
                                </select>

                                <button onclick="ManagerModule.state.mainStockSortDir = ManagerModule.state.mainStockSortDir === 'asc' ? 'desc' : 'asc'; App.rerender()"
                                    class="p-2.5 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 transition" title="Inverser le tri">
                                    <i data-lucide="${sortDir === 'asc' ? 'arrow-up' : 'arrow-down'}" class="w-4 h-4 text-slate-600"></i>
                                </button>

                                ${(searchQuery || categoryFilter !== 'all' || stockFilter !== 'all') ? `
                                    <button onclick="ManagerModule.state.inventorySearch='';ManagerModule.state.mainStockCategoryFilter='all';ManagerModule.state.mainStockStatusFilter='all';ManagerModule.state.mainStockPage=1;App.rerender()"
                                        class="px-4 py-2.5 bg-slate-200 text-slate-700 font-bold rounded-xl hover:bg-slate-300 transition flex items-center gap-2">
                                        <i data-lucide="x" class="w-4 h-4"></i> Réinitialiser
                                    </button>
                                ` : ''}
                            </div>

                            <div class="flex items-center justify-between mt-3">
                                <div class="text-sm font-bold text-slate-600">
                                    ${totalFiltered} produit(s) trouvés sur ${mainStockMetrics.totalProducts}
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="ManagerModule.selectAllMainProducts()" class="text-xs font-bold text-blue-600 hover:underline">Tout sélectionner</button>
                                    <span class="text-slate-300">|</span>
                                    <button onclick="ManagerModule.bulkUpdateSelectedProducts()" class="text-xs font-bold text-emerald-600 hover:underline">Modifier la sélection</button>
                                </div>
                            </div>
                        </div>

                        <!-- Tableau -->
                        <div class="overflow-auto">
                            <table class="w-full text-left min-w-[1000px]">
                                <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3 w-10">
                                            <input type="checkbox" id="select-all-main" onchange="ManagerModule.toggleSelectAllMain(this.checked)" class="w-4 h-4 rounded border-slate-300">
                                        </th>
                                        <th class="px-4 py-3">Produit</th>
                                        <th class="px-4 py-3">Catégorie</th>
                                        <th class="px-4 py-3 text-right">Prix</th>
                                        <th class="px-4 py-3 text-center">Stock</th>
                                        <th class="px-4 py-3 text-center">Min</th>
                                        <th class="px-4 py-3 text-center">Jauge</th>
                                        <th class="px-4 py-3 text-right">Valeur</th>
                                        <th class="px-4 py-3 text-center">État</th>
                                        <th class="px-4 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${paginatedProducts.length === 0 ? `
                                        <tr>
                                            <td colspan="10" class="px-6 py-12 text-center">
                                                <div class="text-slate-400">
                                                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                                                    <div class="font-bold">Aucun produit trouvé</div>
                                                    <div class="text-sm mt-1">Total en base: ${(CORE.db.products || []).length} produit(s) • Actifs: ${(CORE.db.products || []).filter(p => p.active !== false).length}</div>
                                                    <div class="text-xs mt-2 text-slate-300">Filtres: statut=${stockFilter}, catégorie=${categoryFilter}, recherche="${searchQuery}"</div>
                                                    <div class="flex justify-center gap-2 mt-4">
                                                        <button onclick="ManagerModule.state.inventorySearch='';ManagerModule.state.mainStockCategoryFilter='all';ManagerModule.state.mainStockStatusFilter='all';ManagerModule.state.mainStockPage=1;App.rerender()" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-xl font-bold text-sm">Réinitialiser filtres</button>
                                                        <button onclick="if(typeof API!=='undefined'&&API.syncAllFromCloud){UI.toast('Synchronisation...','info');API.syncAllFromCloud(true).then(()=>{App.rerender();UI.toast('Sync terminée','success')}).catch(e=>UI.toast('Erreur sync: '+e.message,'error'))}" class="px-4 py-2 bg-blue-600 text-white rounded-xl font-bold text-sm">☁️ Synchroniser</button>
                                                        <button onclick="ManagerModule.showNewProductModal('main')" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-bold text-sm">+ Ajouter un produit</button>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    ` : ''}
                                    ${paginatedProducts.map(p => {
                                        const stock = p.stock || 0;
                                        const minStock = p.minStock || 1;
                                        const isLow = stock <= minStock && stock > minStock * 0.5;
                                        const isCritical = stock <= minStock * 0.5 && stock > 0;
                                        const isOut = stock === 0;
                                        const value = stock * (p.price || 0);
                                        const cat = CORE.getCategory(p.categoryId);
                                        const gaugePercent = Math.min(100, Math.round((stock / Math.max(minStock * 2, 1)) * 100));
                                        const gaugeColor = isOut ? 'bg-red-500' : isCritical ? 'bg-orange-500' : isLow ? 'bg-amber-500' : 'bg-emerald-500';

                                        return `
                                            <tr class="hover:bg-blue-50/50 transition group">
                                                <td class="px-4 py-3">
                                                    <input type="checkbox" data-product-id="${p.id}" class="main-product-checkbox w-4 h-4 rounded border-slate-300">
                                                </td>
                                                <td class="px-4 py-3">
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center text-lg">
                                                            ${p.image ? `<img src="${p.image}" class="w-10 h-10 rounded-xl object-cover">` : '📦'}
                                                        </div>
                                                        <div>
                                                            <div class="font-black text-slate-900">${p.name}</div>
                                                            <div class="text-xs text-slate-500">${p.barcode || 'Sans code-barres'}</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3">
                                                    <span class="px-3 py-1 bg-slate-100 rounded-lg text-xs font-bold text-slate-600">${cat?.name || 'N/A'}</span>
                                                </td>
                                                <td class="px-4 py-3 text-right font-bold">${CORE.formatPrice(p.price || 0)}</td>
                                                <td class="px-4 py-3 text-center">
                                                    <div class="inline-flex items-center gap-1">
                                                        <button onclick="ManagerModule.adjustMainStock('${p.id}', -1)" class="w-6 h-6 rounded bg-slate-200 hover:bg-red-200 transition text-slate-600 font-bold">-</button>
                                                        <input type="number" value="${stock}"
                                                            onchange="CORE.setProductStock('${p.id}', null, this.value); App.rerender()"
                                                            class="w-16 text-center bg-white border border-slate-200 rounded px-2 py-1 font-black focus:ring-2 focus:ring-blue-500 outline-none" min="0">
                                                        <button onclick="ManagerModule.adjustMainStock('${p.id}', 1)" class="w-6 h-6 rounded bg-slate-200 hover:bg-emerald-200 transition text-slate-600 font-bold">+</button>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3 text-center text-sm text-slate-500">${minStock}</td>
                                                <td class="px-4 py-3">
                                                    <div class="w-24 mx-auto">
                                                        <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
                                                            <div class="h-full ${gaugeColor} transition-all" style="width: ${gaugePercent}%"></div>
                                                        </div>
                                                        <div class="text-[10px] text-center text-slate-400 mt-1">${gaugePercent}%</div>
                                                    </div>
                                                </td>
                                                <td class="px-4 py-3 text-right font-bold text-slate-700">${CORE.formatPrice(value)}</td>
                                                <td class="px-4 py-3 text-center">
                                                    ${isOut ? `<span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-black animate-pulse">🔴 Rupture</span>`
                                                    : isCritical ? `<span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-black">⚠️ Critique</span>`
                                                    : isLow ? `<span class="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-black">📉 Bas</span>`
                                                    : `<span class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-xs font-black">✅ OK</span>`}
                                                </td>
                                                <td class="px-4 py-3">
                                                    <div class="flex items-center justify-end gap-1 opacity-60 group-hover:opacity-100 transition">
                                                        <button onclick="ManagerModule.quickRestock('${p.id}')" class="p-2 rounded-lg hover:bg-emerald-100 text-emerald-600 transition" title="Réapprovisionner">
                                                            <i data-lucide="package-plus" class="w-4 h-4"></i>
                                                        </button>
                                                        <button onclick="ManagerModule.quickTransfer('${p.id}')" class="p-2 rounded-lg hover:bg-purple-100 text-purple-600 transition" title="Transférer vers POS">
                                                            <i data-lucide="send" class="w-4 h-4"></i>
                                                        </button>
                                                        <button onclick="ManagerModule.showMainProductModal('${p.id}')" class="p-2 rounded-lg hover:bg-blue-100 text-blue-600 transition" title="Détails">
                                                            <i data-lucide="info" class="w-4 h-4"></i>
                                                        </button>
                                                        <button onclick="ManagerModule.showEditProductModal('${p.id}')" class="p-2 rounded-lg hover:bg-slate-100 text-slate-600 transition" title="Modifier">
                                                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>

                        <!-- Footer avec pagination/stats -->
                        <div class="p-4 border-t border-slate-100 bg-slate-50">
                            <div class="flex flex-wrap items-center justify-between gap-4">
                                <div class="text-sm text-slate-600 font-medium">
                                    ${totalFiltered === 0 ? 'Aucun produit' : `Affichage ${startIdx + 1}-${Math.min(startIdx + perPage, totalFiltered)} sur ${totalFiltered} produit(s)`}
                                    <span class="text-slate-400 ml-2">• Valeur: <span class="font-black text-slate-900">${CORE.formatPrice(paginatedProducts.reduce((s, p) => s + (p.stock || 0) * (p.price || 0), 0))}</span></span>
                                </div>

                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-slate-500">Par page:</span>
                                    <select onchange="ManagerModule.state.mainStockPerPage=parseInt(this.value);ManagerModule.state.mainStockPage=1;App.rerender()" class="px-2 py-1 rounded-lg border border-slate-200 bg-white text-sm font-bold">
                                        <option value="25" ${perPage === 25 ? 'selected' : ''}>25</option>
                                        <option value="50" ${perPage === 50 ? 'selected' : ''}>50</option>
                                        <option value="100" ${perPage === 100 ? 'selected' : ''}>100</option>
                                        <option value="200" ${perPage === 200 ? 'selected' : ''}>200</option>
                                    </select>
                                </div>

                                ${totalPages > 1 ? `
                                <div class="flex items-center gap-2">
                                    <button onclick="ManagerModule.state.mainStockPage=1;App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === 1 ? 'disabled' : ''}><i data-lucide="chevrons-left" class="w-4 h-4"></i></button>
                                    <button onclick="ManagerModule.state.mainStockPage=Math.max(1,ManagerModule.state.mainStockPage-1);App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === 1 ? 'disabled' : ''}><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                                    ${paginationPages.map(p => p === '...' ? '<span class="px-2 text-slate-400">...</span>' : '<button onclick="ManagerModule.state.mainStockPage=' + p + ';App.rerender()" class="px-3 py-2 rounded-lg ' + (p === currentPage ? 'bg-slate-900 text-white' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm">' + p + '</button>').join('')}
                                    <button onclick="ManagerModule.state.mainStockPage=Math.min(${totalPages},ManagerModule.state.mainStockPage+1);App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === totalPages ? 'disabled' : ''}><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                                    <button onclick="ManagerModule.state.mainStockPage=${totalPages};App.rerender()" class="px-3 py-2 rounded-lg ${currentPage === totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${currentPage === totalPages ? 'disabled' : ''}><i data-lucide="chevrons-right" class="w-4 h-4"></i></button>
                                </div>
                                ` : ''}

                                <div class="flex items-center gap-2">
                                    <button onclick="ManagerModule.printMainStockReport()" class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-sm font-bold hover:bg-slate-50 flex items-center gap-2">
                                        <i data-lucide="printer" class="w-4 h-4"></i> Imprimer
                                    </button>
                                    <button onclick="ManagerModule.exportMainStockCSV()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm font-bold hover:bg-emerald-700 flex items-center gap-2">
                                        <i data-lucide="download" class="w-4 h-4"></i> Export CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        // Fonctions auxiliaires pour le Stock Control Center
        adjustMainStock(productId, delta) {
            const product = CORE.getVisibleProducts().find(p => String(p.id) === String(productId));
            if (!product) return;
            const newStock = Math.max(0, (product.stock || 0) + delta);
            CORE.setProductStock(productId, null, newStock);
            App.rerender();
        },

        quickRestock(productId) {
            const product = CORE.getVisibleProducts().find(p => String(p.id) === String(productId));
            if (!product) return;

            UI.modal(`Réapprovisionner: ${product.name}`, `
                <div class="space-y-4">
                    <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-xl">
                        <div class="w-16 h-16 bg-slate-200 rounded-xl flex items-center justify-center text-2xl">📦</div>
                        <div>
                            <div class="font-black text-slate-900">${product.name}</div>
                            <div class="text-sm text-slate-500">Stock actuel: <span class="font-black ${(product.stock || 0) <= (product.minStock || 0) ? 'text-red-600' : 'text-emerald-600'}">${product.stock || 0}</span> | Min: ${product.minStock || 0}</div>
                        </div>
                    </div>
                    ${UI.input('restock_qty', 'Quantité à ajouter', 'number', '', 'Ex: 50', true)}
                    ${UI.input('restock_ref', 'Référence/Bon de commande', 'text', '', 'Ex: BC-2024-001', false)}
                    ${UI.textarea('restock_note', 'Note', '', 'Optionnel', 2)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Ajouter au stock', onclick: `ManagerModule.executeQuickRestock('${productId}')`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' }
            ]);
        },

        executeQuickRestock(productId) {
            const qty = parseInt(UI.val('restock_qty'), 10);
            if (!qty || qty <= 0) return UI.toast('Quantité invalide', 'warning');

            const ref = UI.val('restock_ref').trim() || `RESTOCK-${Date.now()}`;
            const note = UI.val('restock_note').trim();

            const product = CORE.getVisibleProducts().find(p => String(p.id) === String(productId));
            if (!product) return;

            const newStock = (product.stock || 0) + qty;
            CORE.setProductStock(productId, null, newStock);

            // Enregistrer le mouvement
            CORE.db.stockMovements = CORE.db.stockMovements || [];
            CORE.db.stockMovements.push({
                id: CORE.uid(),
                productId,
                productName: product.name,
                type: 'in',
                qty,
                ref,
                note,
                isMainWarehouse: true,
                userName: CORE.state.currentUser?.name || 'System',
                createdAt: new Date().toISOString()
            });
            CORE.save();

            UI.closeModal();
            UI.toast(`+${qty} unités ajoutées à ${product.name}`, 'success');
            App.rerender();
        },

        quickTransfer(productId) {
            const product = CORE.getVisibleProducts().find(p => String(p.id) === String(productId));
            if (!product) return;

            const posList = CORE.db.pointsOfSale || [];

            UI.modal(`Transférer: ${product.name}`, `
                <div class="space-y-4">
                    <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-xl">
                        <div class="w-16 h-16 bg-slate-200 rounded-xl flex items-center justify-center text-2xl">📦</div>
                        <div>
                            <div class="font-black text-slate-900">${product.name}</div>
                            <div class="text-sm text-slate-500">Stock dépôt: <span class="font-black text-blue-600">${product.stock || 0}</span></div>
                        </div>
                    </div>
                    ${UI.select('transfer_pos', 'Point de vente destination', posList.map(p => ({value: p.id, label: p.name})), '', true)}
                    ${UI.input('transfer_qty', 'Quantité à transférer', 'number', '', 'Ex: 20', true)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Transférer', onclick: `ManagerModule.executeQuickTransfer('${productId}')`, class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700' }
            ]);
        },

        executeQuickTransfer(productId) {
            const posId = UI.val('transfer_pos');
            const qty = parseInt(UI.val('transfer_qty'), 10);

            if (!posId) return UI.toast('Sélectionnez un point de vente', 'warning');
            if (!qty || qty <= 0) return UI.toast('Quantité invalide', 'warning');

            const product = CORE.getVisibleProducts().find(p => String(p.id) === String(productId));
            if (!product) return;

            if ((product.stock || 0) < qty) return UI.toast('Stock insuffisant au dépôt', 'error');

            const pos = CORE.getPOS(posId);
            const timestamp = new Date().toISOString();

            // Réduire stock dépôt
            product.stock = Math.max(0, (product.stock || 0) - qty);
            product.updatedAt = timestamp;
            CORE._productIndex = null;

            // Créer un transferReceipt (pending) — le gestionnaire doit confirmer la réception
            const receipt = CORE.createTransferReceipt({
                reference: `QT-${Utils.uid('QT').slice(0, 6)}`,
                productId: product._apiId || product.id,
                productName: product.name,
                productSku: product.barcode || null,
                productPrice: product.price || 0,
                productCategory: product.category || null,
                quantity: qty,
                fromPosId: 'main_depot',
                fromPosName: 'Dépôt principal',
                toPosId: parseInt(posId, 10) || posId,
                toPosName: pos?.name || 'POS',
                note: 'Transfert rapide depuis dépôt',
                meta: {
                    transferType: 'quick_transfer',
                    createdFrom: 'manager_quick_transfer'
                }
            });

            // Enregistrer le mouvement de sortie du dépôt
            CORE.recordStockMovement({
                type: 'main_depot_transfer',
                productId: product.id,
                quantity: qty,
                posId: null,
                fromPosId: null,
                toPosId: posId,
                notes: 'Transfert rapide vers ' + (pos?.name || 'POS'),
                reason: 'main_depot_transfer',
                document: receipt?.reference || '',
                timestamp,
                meta: {
                    source: 'manager_quick_transfer',
                    direction: 'out',
                    toPosId: posId,
                    receiptId: receipt?.id || null
                }
            });

            CORE.markDirty('products');
            CORE.markDirty('stockMovements');
            CORE.markDirty('transferReceipts');
            CORE.save(true);

            // Force immediate cloud push
            clearTimeout(CORE._cloudPushTimer);
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() && navigator.onLine) {
                CORE._cloudPushTimer = setTimeout(() => CORE._doCloudPush(0), 500);
            }

            UI.closeModal();
            UI.toast(`${qty} unités envoyées vers ${pos?.name || 'POS'} — en attente de réception`, 'success');
            App.rerender();
        },

        toggleSelectAllMain(checked) {
            document.querySelectorAll('.main-product-checkbox').forEach(cb => cb.checked = checked);
        },

        selectAllMainProducts() {
            document.querySelectorAll('.main-product-checkbox').forEach(cb => cb.checked = true);
            const selectAll = document.getElementById('select-all-main');
            if (selectAll) selectAll.checked = true;
        },

        bulkUpdateSelectedProducts() {
            const selected = Array.from(document.querySelectorAll('.main-product-checkbox:checked')).map(cb => parseInt(cb.dataset.productId, 10));
            if (selected.length === 0) return UI.toast('Aucun produit sélectionné', 'warning');

            UI.modal(`Modifier ${selected.length} produit(s)`, `
                <div class="space-y-4">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl">
                        <div class="font-bold text-blue-800">${selected.length} produit(s) sélectionné(s)</div>
                        <div class="text-sm text-blue-600">Les modifications s'appliqueront à tous</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        ${UI.input('bulk_add_stock', 'Ajouter au stock', 'number', '', '+10', false)}
                        ${UI.input('bulk_set_min', 'Nouveau stock min', 'number', '', 'Ex: 5', false)}
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Appliquer', onclick: `ManagerModule.executeBulkUpdate([${selected.join(',')}])`, class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700' }
            ]);
        },

        executeBulkUpdate(productIds) {
            const addStock = parseInt(UI.val('bulk_add_stock'), 10) || 0;
            const newMin = UI.val('bulk_set_min').trim() ? parseInt(UI.val('bulk_set_min'), 10) : null;

            let updated = 0;
            productIds.forEach(id => {
                const product = CORE.getVisibleProducts().find(p => p.id === id);
                if (product) {
                    if (addStock !== 0) {
                        product.stock = Math.max(0, (product.stock || 0) + addStock);
                    }
                    if (newMin !== null) {
                        product.minStock = newMin;
                    }
                    updated++;
                }
            });

            CORE.save();
            UI.closeModal();
            UI.toast(`${updated} produit(s) mis à jour`, 'success');
            App.rerender();
        },

        printMainStockReport() {
            const products = CORE.getVisibleProducts().filter(p => p.isMainWarehouse && p.active);
            const totalValue = products.reduce((s, p) => s + (p.stock || 0) * (p.price || 0), 0);

            const printContent = `
                <html>
                <head>
                    <title>Rapport Stock Dépôt Principal</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #1e293b; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; }
                        th { background: #f1f5f9; font-weight: bold; }
                        .low { background: #fef3c7; }
                        .critical { background: #fee2e2; }
                        .total { font-weight: bold; background: #f1f5f9; }
                    </style>
                </head>
                <body>
                    <h1>🏭 Rapport Stock - Dépôt Principal</h1>
                    <p>Date: ${new Date().toLocaleDateString('fr-FR')} | ${products.length} produits | Valeur totale: ${CORE.formatPrice(totalValue)}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Produit</th>
                                <th>Code</th>
                                <th>Stock</th>
                                <th>Min</th>
                                <th>Prix</th>
                                <th>Valeur</th>
                                <th>État</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${products.map(p => {
                                const isLow = (p.stock || 0) <= (p.minStock || 0);
                                const isCritical = (p.stock || 0) <= (p.minStock || 0) * 0.5;
                                return `
                                    <tr class="${isCritical ? 'critical' : isLow ? 'low' : ''}">
                                        <td>${p.name}</td>
                                        <td>${p.barcode || '-'}</td>
                                        <td>${p.stock || 0}</td>
                                        <td>${p.minStock || 0}</td>
                                        <td>${CORE.formatPrice(p.price || 0)}</td>
                                        <td>${CORE.formatPrice((p.stock || 0) * (p.price || 0))}</td>
                                        <td>${isCritical ? '🔴 Critique' : isLow ? '⚠️ Bas' : '✅ OK'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        },

        renderPOS() {
            const grouped = (CORE.db.pointsOfSale || []).map(p => ({
                ...p,
                city: CORE.getCity(p.cityId)?.name,
                orders: CORE.getVisibleOrders().filter(o => o.posId === p.id).length
            }));
            return `
                <div class="fade-in max-w-6xl mx-auto space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">Points de vente</h2>
                            <p class="text-slate-500 font-medium">Visibilité par site.</p>
                        </div>
                        <button onclick="ManagerModule.showAddPOSModal()" class="px-6 py-3 bg-sky-600 text-white font-black rounded-xl hover:bg-sky-700 transition flex items-center gap-2">
                            <i data-lucide="plus" class="w-5 h-5"></i> Nouveau POS
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${grouped.map(p => `
                            <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-6 card-hover relative">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">${p.city}</div>
                                        <div class="text-xl font-black text-slate-900 mt-1">${p.name}</div>
                                        <div class="mt-2 text-sm text-slate-500 font-medium">Employés: <span class="font-black">${p.employees}</span> • Commandes: <span class="font-black">${p.orders}</span></div>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <div class="w-12 h-12 bg-sky-50 text-sky-600 rounded-2xl flex items-center justify-center"><i data-lucide="store" class="w-6 h-6"></i></div>
                                        <button onclick="ManagerModule.state.inventoryPosId='${p.id}'; ManagerModule.state.inventoryTab='products'; ManagerModule.navigateTo('inventory'); UI.closeModal();" class="p-2.5 rounded-xl hover:bg-emerald-50 transition text-emerald-600 hover:text-emerald-700" title="Stock de ce POS">
                                            <i data-lucide="package" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="ManagerModule.showEditPOSModal(${p.id})" class="p-2.5 rounded-xl hover:bg-slate-100 transition text-slate-600 hover:text-slate-900" title="Éditer">
                                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="ManagerModule.deletePOS(${p.id})" class="p-2.5 rounded-xl hover:bg-red-50 transition text-red-600 hover:bg-red-100" title="Supprimer">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        },

        showAddPOSModal() {
            const cities = CORE.db.cities.map(c => ({value: c.id, label: c.name}));
            // add an explicit option to create a new city inline
            cities.push({ value: 'new', label: '➕ Ajouter une nouvelle ville...' });
            UI.modal('Nouveau Point de Vente', `
                <div class="space-y-4">
                    ${UI.input('pos_name', 'Nom du POS', 'text', '', 'ex: Brazzaville Centre', true)}

                    <!-- Sélection ville avec option manuelle -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Ville <span class="text-red-500">*</span></label>
                        <div class="flex gap-2">
                            <select id="pos_city" class="flex-1 px-4 py-3 rounded-xl border border-slate-200 font-medium focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="">-- Sélectionner une ville --</option>
                                ${cities.map(c => `<option value="${c.value}">${c.label}</option>`).join('')}
                            </select>
                            <button type="button" onclick="ManagerModule.toggleNewCityInput()" class="px-4 py-3 bg-emerald-100 text-emerald-700 font-bold rounded-xl hover:bg-emerald-200 transition" title="Saisir manuellement">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Champ de saisie manuelle ville -->
                    <div id="pos_city_new_wrap" class="hidden">
                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-sm font-bold text-emerald-700">🆕 Nouvelle ville</label>
                                <button type="button" onclick="ManagerModule.cancelNewCity()" class="text-xs text-red-600 hover:underline">Annuler</button>
                            </div>
                            <input type="text" id="pos_city_new" placeholder="Saisir le nom de la nouvelle ville..." class="w-full px-4 py-3 rounded-xl border border-emerald-300 font-medium focus:ring-2 focus:ring-emerald-500 outline-none bg-white">
                            <div class="text-xs text-emerald-600 mt-2">💡 Cette ville sera ajoutée automatiquement à la liste</div>
                        </div>
                    </div>

                    ${UI.input('pos_employees', 'Nombre d\'employés', 'number', '1', 'ex: 5', true)}
                    ${UI.input('pos_phone', 'Téléphone', 'tel', '', CORE.getPhonePlaceholder(), false)}
                    ${UI.textarea('pos_address', 'Adresse', '', 'ex: 123 Rue Principale', 2)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Créer', onclick: 'ManagerModule.savePOS()', class: 'px-5 py-2.5 bg-sky-600 text-white font-black rounded-xl hover:bg-sky-700 transition' }
            ]);

            // bind change handler to toggle new-city input
            setTimeout(() => {
                const sel = document.getElementById('pos_city');
                if (!sel) return;
                sel.addEventListener('change', e => ManagerModule._onPOSCityChange(e.target.value));
                ManagerModule._onPOSCityChange(sel.value);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }, 60);
        },

        toggleNewCityInput() {
            const wrap = document.getElementById('pos_city_new_wrap');
            const select = document.getElementById('pos_city');
            const input = document.getElementById('pos_city_new');

            if (wrap.classList.contains('hidden')) {
                wrap.classList.remove('hidden');
                select.value = 'new';
                select.disabled = true;
                if (input) input.focus();
            } else {
                wrap.classList.add('hidden');
                select.disabled = false;
                select.value = '';
                if (input) input.value = '';
            }
        },

        cancelNewCity() {
            const wrap = document.getElementById('pos_city_new_wrap');
            const select = document.getElementById('pos_city');
            const input = document.getElementById('pos_city_new');

            wrap.classList.add('hidden');
            select.disabled = false;
            select.value = '';
            if (input) input.value = '';
        },

        showEditPOSModal(posId) {
            const pos = CORE.getPOS(posId);
            if (!pos) return UI.toast('POS non trouvé', 'error');
            const cities = CORE.db.cities.map(c => ({value: c.id, label: c.name}));
            cities.push({ value: 'new', label: '➕ Ajouter une nouvelle ville...' });
            UI.modal(`Modifier: ${pos.name}`, `
                <div class="space-y-4">
                    ${UI.input('pos_name', 'Nom du POS', 'text', pos.name, '', true)}

                    <!-- Sélection ville avec option manuelle -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Ville <span class="text-red-500">*</span></label>
                        <div class="flex gap-2">
                            <select id="pos_city" class="flex-1 px-4 py-3 rounded-xl border border-slate-200 font-medium focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="">-- Sélectionner une ville --</option>
                                ${cities.map(c => `<option value="${c.value}" ${c.value == pos.cityId ? 'selected' : ''}>${c.label}</option>`).join('')}
                            </select>
                            <button type="button" onclick="ManagerModule.toggleNewCityInput()" class="px-4 py-3 bg-emerald-100 text-emerald-700 font-bold rounded-xl hover:bg-emerald-200 transition" title="Saisir manuellement">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Champ de saisie manuelle ville -->
                    <div id="pos_city_new_wrap" class="hidden">
                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-sm font-bold text-emerald-700">🆕 Nouvelle ville</label>
                                <button type="button" onclick="ManagerModule.cancelNewCity()" class="text-xs text-red-600 hover:underline">Annuler</button>
                            </div>
                            <input type="text" id="pos_city_new" placeholder="Saisir le nom de la nouvelle ville..." class="w-full px-4 py-3 rounded-xl border border-emerald-300 font-medium focus:ring-2 focus:ring-emerald-500 outline-none bg-white">
                            <div class="text-xs text-emerald-600 mt-2">💡 Cette ville sera ajoutée automatiquement à la liste</div>
                        </div>
                    </div>

                    ${UI.input('pos_employees', 'Nombre d\'employés', 'number', pos.employees || '1', '', true)}
                    ${UI.input('pos_phone', 'Téléphone', 'tel', pos.phone || '', '', false)}
                    ${UI.textarea('pos_address', 'Adresse', pos.address || '', '', 2)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: `ManagerModule.updatePOS(${posId})`, class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);

            setTimeout(() => {
                const sel = document.getElementById('pos_city');
                if (!sel) return;
                sel.addEventListener('change', e => ManagerModule._onPOSCityChange(e.target.value));
                ManagerModule._onPOSCityChange(sel.value);
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }, 60);
        },

        _onPOSCityChange(rawVal) {
            const wrap = document.getElementById('pos_city_new_wrap');
            const input = document.getElementById('pos_city_new');
            if (!wrap || !input) return;
            if (String(rawVal) === 'new') {
                wrap.classList.remove('hidden');
                input.required = true;
            } else {
                wrap.classList.add('hidden');
                input.required = false;
            }
        },

        savePOS() {
            const name = UI.val('pos_name').trim();
            const rawCityVal = UI.val('pos_city');
            let cityId = null;
            const employees = parseInt(UI.val('pos_employees'), 10) || 1;
            const phone = UI.val('pos_phone').trim() || null;
            const address = UI.val('pos_address').trim() || null;

            if (!name) return UI.toast('Le nom du POS est requis', 'warning');

            // handle inline new-city creation
            if (String(rawCityVal) === 'new') {
                const newCityName = UI.val('pos_city_new').trim();
                if (!newCityName) return UI.toast('Veuillez saisir le nom de la nouvelle ville', 'warning');
                CORE.db.cities = CORE.db.cities || [];
                const newCity = { id: CORE.uid(), name: newCityName };
                CORE.db.cities.push(newCity);
                CORE.save();
                cityId = newCity.id;
            } else {
                cityId = parseInt(rawCityVal, 10);
            }

            if (!cityId) return UI.toast('Veuillez sélectionner une ville', 'warning');

            // Créer une demande d'approbation au lieu de créer directement
            CORE.db.posCreationRequests = CORE.db.posCreationRequests || [];
            const request = {
                id: CORE.uid(),
                type: 'creation',
                posData: {
                    name,
                    cityId,
                    employees,
                    phone,
                    address
                },
                requestedBy: CORE.state.currentUser?.name || 'Utilisateur',
                requestedById: CORE.state.currentUser?.id,
                createdAt: new Date().toISOString(),
                status: 'pending',
                approvedBy: null,
                approvalDate: null,
                rejectionReason: null
            };
            CORE.db.posCreationRequests.push(request);
            CORE.markDirty('posCreationRequests');
            CORE.logAudit('create', 'pos_request', request.id, name, { description: `Demande création POS: ${name}` });
            CORE.save();
            UI.closeModal();
            UI.toast('Demande de création de POS envoyée au PDG pour approbation', 'info');
            CORE.notify('info', `Demande de création POS: ${name}`, { requestId: request.id });
            App.rerender();
        },

        updatePOS(posId) {
            const name = UI.val('pos_name').trim();
            const rawCityVal = UI.val('pos_city');
            let cityId = null;
            const employees = parseInt(UI.val('pos_employees'), 10) || 1;
            const phone = UI.val('pos_phone').trim() || null;
            const address = UI.val('pos_address').trim() || null;

            if (!name) return UI.toast('Le nom du POS est requis', 'warning');

            // handle inline new-city creation during update
            if (String(rawCityVal) === 'new') {
                const newCityName = UI.val('pos_city_new').trim();
                if (!newCityName) return UI.toast('Veuillez saisir le nom de la nouvelle ville', 'warning');
                CORE.db.cities = CORE.db.cities || [];
                const newCity = { id: CORE.uid(), name: newCityName };
                CORE.db.cities.push(newCity);
                CORE.save();
                cityId = newCity.id;
            } else {
                cityId = parseInt(rawCityVal, 10);
            }

            if (!cityId) return UI.toast('Veuillez sélectionner une ville', 'warning');

            CORE.update('pointsOfSale', posId, {
                name,
                cityId,
                employees,
                phone,
                address
            });

            UI.closeModal();
            UI.toast('Point de vente mis à jour', 'success');
            App.rerender();
        },

        deletePOS(posId) {
            const pos = CORE.getPOS(posId);
            if (!pos) return UI.toast('POS non trouvé', 'error');

            // Vérifier si des commandes sont liées à ce POS
            const linkedOrders = CORE.getVisibleOrders().filter(o => o.posId === posId);
            if (linkedOrders.length > 0) {
                return UI.toast(`Impossible de supprimer: ${linkedOrders.length} commande(s) associée(s)`, 'warning');
            }

            const linkedUsers = CORE.getVisibleUsers().filter(u => u.pos === posId);
            if (linkedUsers.length > 0) {
                return UI.toast(`Impossible de supprimer: ${linkedUsers.length} utilisateur(s) assigné(s)`, 'warning');
            }

            UI.confirm({
                title: 'Demander la suppression du POS',
                message: `Vous êtes sur le point de demander la suppression de "${pos.name}". Le PDG doit approuver cette demande.`,
                confirmLabel: 'Demander suppression',
                confirmClass: 'bg-amber-600 hover:bg-amber-700 text-white',
                onConfirm: function() {
                    // Créer une demande de suppression de POS
                    CORE.db.posCreationRequests = CORE.db.posCreationRequests || [];
                    const request = {
                        id: CORE.uid(),
                        type: 'deletion',
                        posId: posId,
                        posName: pos.name,
                        requestedBy: CORE.state.currentUser?.name || 'Utilisateur',
                        requestedById: CORE.state.currentUser?.id,
                        createdAt: new Date().toISOString(),
                        status: 'pending',
                        approvedBy: null,
                        approvalDate: null,
                        rejectionReason: null
                    };
                    CORE.db.posCreationRequests.push(request);
                    CORE.markDirty('posCreationRequests');
                    CORE.save();
                    UI.closeModal();
                    UI.toast(`Demande de suppression envoyée au PDG pour approbation`, 'info');
                    CORE.notify('info', `Demande de suppression POS: ${pos.name}`, { posId });
                    App.rerender();
                }
            });
        },

        // =====================
        // FINANCES (Manager)
        // =====================
        getFinanceScope() {
            // Manager scope: by default, current user's city/POS (if defined)
            const defaultCityId = CORE.state.currentUser?.city || '';
            const defaultPosId = CORE.state.currentUser?.pos || '';
            const cityId = this.state.financeCityId !== '' ? parseInt(this.state.financeCityId, 10) : defaultCityId;
            const posId = this.state.financePosId !== '' ? parseInt(this.state.financePosId, 10) : defaultPosId;
            return { cityId: cityId || null, posId: posId || null };
        },

        getFinanceDateRange() {
            const from = (this.state.financeFrom || '').trim();
            const to = (this.state.financeTo || '').trim();
            const fromDate = from ? new Date(from + 'T00:00:00') : null;
            const toDate = to ? new Date(to + 'T23:59:59') : null;
            return { fromDate, toDate };
        },

        getTransactionsFiltered() {
            const q = (document.getElementById('manager-finance-search-input')?.value || '').toLowerCase().trim();
            const type = this.state.financeType;
            const category = this.state.financeCategory;
            const method = this.state.financeMethod;
            const { cityId, posId } = this.getFinanceScope();
            const { fromDate, toDate } = this.getFinanceDateRange();

            let txs = [...CORE.getVisibleTransactions()];

            // Scope
            if (cityId) txs = txs.filter(t => String(t.cityId || '') === String(cityId));
            if (posId) txs = txs.filter(t => String(t.posId || '') === String(posId));

            // Date
            if (fromDate) txs = txs.filter(t => new Date(t.createdAt) >= fromDate);
            if (toDate) txs = txs.filter(t => new Date(t.createdAt) <= toDate);

            // Filters
            if (type !== 'all') txs = txs.filter(t => t.type === type);
            if (category !== 'all') txs = txs.filter(t => t.category === category);
            if (method !== 'all') txs = txs.filter(t => t.method === method);

            if (q) {
                txs = txs.filter(t =>
                    (t.ref || '').toLowerCase().includes(q) ||
                    (t.note || '').toLowerCase().includes(q) ||
                    (t.userName || '').toLowerCase().includes(q) ||
                    String(t.amount || '').includes(q)
                );
            }

            return txs.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
        },

        getCODOutstanding() {
            // COD not yet paid in scope
            const { cityId, posId } = this.getFinanceScope();
            let orders = CORE.getVisibleOrders().filter(o => o.paymentMethod === 'cod' && o.paymentStatus !== 'paid');
            if (cityId) orders = orders.filter(o => String(o.cityId || '') === String(cityId));
            if (posId) orders = orders.filter(o => String(o.posId || '') === String(posId));
            const amount = orders.reduce((a,o)=>a + Number(o.total||0), 0);
            return { count: orders.length, amount, orders };
        },

        getCommissionsDue() {
            const { cityId, posId } = this.getFinanceScope();
            let txs = CORE.getVisibleTransactions().filter(t => t.category === 'commission');
            if (cityId) txs = txs.filter(t => String(t.cityId || '') === String(cityId));
            if (posId) txs = txs.filter(t => String(t.posId || '') === String(posId));
            const due = txs.filter(t => !t.settled);
            const amount = due.reduce((a,t)=>a + Number(t.amount||0), 0);
            return { dueCount: due.length, dueAmount: amount, due };
        },

        getFinanceSummary() {
            const txs = this.getTransactionsFiltered();
            const income = txs.filter(t => t.type === 'income').reduce((a,t)=>a+Number(t.amount||0),0);
            const expense = txs.filter(t => t.type === 'expense').reduce((a,t)=>a+Number(t.amount||0),0);
            const net = income - expense;

            const byMethod = (m) => txs.filter(t => t.type === 'income' && t.category === 'sale' && t.method === m).reduce((a,t)=>a+Number(t.amount||0),0);
            const cash = byMethod('cash');
            const mobile = byMethod('mobile');
            const cod = byMethod('cod');

            const codOutstanding = this.getCODOutstanding();
            const commissions = this.getCommissionsDue();
            return { income, expense, net, cash, mobile, cod, codOutstanding, commissions };
        },

        exportFinanceCSV() {
            const txs = this.getTransactionsFiltered();
            const rows = [
                ['id','type','category','amount','method','ref','note','orderId','deliveryId','posId','cityId','settled','createdAt','userName'],
                ...txs.map(t => [
                    t.id,
                    t.type,
                    t.category,
                    t.amount,
                    t.method || '',
                    t.ref || '',
                    t.note || '',
                    t.orderId || '',
                    t.deliveryId || '',
                    t.posId || '',
                    t.cityId || '',
                    t.settled ? '1' : '0',
                    t.createdAt,
                    t.userName || ''
                ])
            ];
            (PDGModule?.downloadCSV || this.downloadCSVFallback)(`raya_finance_manager_${Utils.todayKey()}.csv`, rows);
        },

        showNewExpenseModal() {
            const expenseCategories = [
                { value: 'stock', label: '📦 Achat de stock/produits' },
                { value: 'transport', label: '🚚 Frais de transport' },
                { value: 'salaire', label: '💼 Salaires' },
                { value: 'loyer', label: '🏢 Loyer/Local' },
                { value: 'electricite', label: '⚡ électricité/Eau' },
                { value: 'telephone', label: '📱 Téléphone/Internet' },
                { value: 'maintenance', label: '🔧 Maintenance/Réparation' },
                { value: 'hygieneEntretien', label: '🧹 Hygiène/Entretien' },
                { value: 'publicite', label: '📢 Publicité/Marketing' },
                { value: 'assurance', label: '🛡️ Assurance' },
                { value: 'taxe', label: '💰 Taxes/Impôts' },
                { value: 'banque', label: '🏦 Frais bancaires' },
                { value: 'deplacement', label: '🚗 Déplacement/Carburant' },
                { value: 'formation', label: '📚 Formation/Cours' },
                { value: 'equipement', label: '🛠️ Équipement/Matériel' },
                { value: 'autre', label: '📋 Autre' }
            ];

            UI.modal('Nouvelle dépense', `
                <div class="space-y-4">
                    ${UI.input('fx_amount','Montant','number','0','ex: 25000',true)}
                    ${UI.select('fx_category', 'Motif / Catégorie', expenseCategories, 'stock', true)}
                    ${UI.select('fx_method','Méthode',[
                        {value:'cash',label:'Cash'},
                        {value:'mobile',label:'Mobile Money'},
                        {value:'internal',label:'Interne'}
                    ], 'cash', true)}
                    ${UI.input('fx_ref','Référence','text','', 'ex: FACT-2026-001', false)}
                    ${UI.textarea('fx_note','Détails additionnels','', 'ex: précisions supplémentaires...', 3)}
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">Conseil: utilisez une référence pour retrouver facilement la dépense.</div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'ManagerModule.saveNewExpense()', class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        saveNewExpense() {
            const amount = Number(UI.val('fx_amount') || 0);
            const category = UI.val('fx_category') || 'autre';
            const method = UI.val('fx_method') || 'cash';
            const ref = UI.val('fx_ref').trim() || null;
            const note = UI.val('fx_note').trim();

            const categoryLabels = {
                'stock': 'Achat de stock/produits',
                'transport': 'Frais de transport',
                'salaire': 'Salaires',
                'loyer': 'Loyer/Local',
                'electricite': 'Électricité/Eau',
                'telephone': 'Téléphone/Internet',
                'maintenance': 'Maintenance/Réparation',
                'hygieneEntretien': 'Hygiène/Entretien',
                'publicite': 'Publicité/Marketing',
                'assurance': 'Assurance',
                'taxe': 'Taxes/Impôts',
                'banque': 'Frais bancaires',
                'deplacement': 'Déplacement/Carburant',
                'formation': 'Formation/Cours',
                'equipement': 'Équipement/Matériel',
                'autre': 'Autre'
            };

            const categoryLabel = categoryLabels[category] || category;
            const fullNote = `[${categoryLabel}]${note ? ' ' + note : ''}`;

            if (!amount || amount <= 0) return UI.toast('Montant invalide', 'warning');
            if (!category) return UI.toast('Veuillez sélectionner une catégorie', 'warning');

            const { cityId, posId } = this.getFinanceScope();
            CORE.recordFinancialTransaction({
                type: 'expense',
                category: 'expense',
                amount,
                method,
                ref,
                note: fullNote,
                cityId,
                posId,
                settled: true
            });
            UI.closeModal();
            UI.toast('Dépense enregistrée', 'success');
            App.rerender();
        },

        showNewIncomeModal() {
            const incomeCategories = [
                { id: 'vente_directe', icon: '🛒', label: 'Vente directe', desc: 'Vente comptoir/magasin' },
                { id: 'vente_en_gros', icon: '📦', label: 'Vente en gros', desc: 'Vente B2B/grossiste' },
                { id: 'service', icon: '🔧', label: 'Prestation de service', desc: 'Services rendus' },
                { id: 'livraison', icon: '🚚', label: 'Frais de livraison', desc: 'Revenus livraisons' },
                { id: 'commission', icon: '💎', label: 'Commission reçue', desc: 'Commissions gagnées' },
                { id: 'remboursement', icon: '↩️', label: 'Remboursement reçu', desc: 'Retour fournisseur' },
                { id: 'location', icon: '🏠', label: 'Location/Sous-location', desc: 'Revenus locatifs' },
                { id: 'partenariat', icon: '🤝', label: 'Partenariat', desc: 'Revenus partenaires' },
                { id: 'interet', icon: '📈', label: 'Intérêts/Dividendes', desc: 'Revenus financiers' },
                { id: 'autre', icon: '📋', label: 'Autre revenu', desc: 'Autres entrées' }
            ];

            const categoryGrid = incomeCategories.map(cat => `
                <div onclick="document.querySelectorAll('.income-cat-card').forEach(c=>c.classList.remove('ring-2','ring-emerald-500','bg-emerald-50'));this.classList.add('ring-2','ring-emerald-500','bg-emerald-50');document.getElementById('mgr_income_category').value='${cat.id}'"
                     class="income-cat-card cursor-pointer p-3 border border-slate-200 rounded-xl hover:border-emerald-300 hover:bg-emerald-50/50 transition-all group">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">${cat.icon}</span>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-slate-800 text-sm group-hover:text-emerald-700">${cat.label}</div>
                            <div class="text-xs text-slate-500">${cat.desc}</div>
                        </div>
                    </div>
                </div>
            `).join('');

            UI.modal(`
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i>
                    </div>
                    <span class="text-xl font-black text-slate-900">Nouveau Revenu</span>
                </div>
            `, `
                <div class="space-y-5">
                    <input type="hidden" id="mgr_income_category" value="">

                    <!-- Catégories -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-3">Catégorie de revenu</label>
                        <div class="grid grid-cols-2 gap-2 max-h-64 overflow-y-auto pr-1">${categoryGrid}</div>
                    </div>

                    <!-- Montant -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Montant *</label>
                            <div class="relative">
                                <input type="number" id="mgr_income_amount" placeholder="0" min="0" step="100"
                                       class="w-full px-4 py-3 pl-12 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 font-bold text-lg">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">F</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Méthode de paiement</label>
                            <select id="mgr_income_method" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 font-medium">
                                <option value="cash">💵 Espèces</option>
                                <option value="mobile">📱 Mobile Money</option>
                                <option value="bank">🏦 Virement bancaire</option>
                                <option value="cheque">📝 Chèque</option>
                                <option value="card">💳 Carte bancaire</option>
                            </select>
                        </div>
                    </div>

                    <!-- Référence et Note -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Référence</label>
                            <input type="text" id="mgr_income_ref" placeholder="ex: FACT-001"
                                   class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Note</label>
                            <input type="text" id="mgr_income_note" placeholder="Description optionnelle"
                                   class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                        </div>
                    </div>

                    <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-xl text-xs text-emerald-700 flex items-start gap-2">
                        <i data-lucide="info" class="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                        <span>Sélectionnez une catégorie et entrez le montant du revenu. La référence facilite le suivi.</span>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer le revenu', onclick: 'ManagerModule.saveNewIncome()', class: 'px-5 py-2.5 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-black rounded-xl hover:from-emerald-600 hover:to-emerald-700 transition shadow-lg' }
            ]);
            setTimeout(() => lucide.createIcons(), 100);
        },

        saveNewIncome() {
            const category = document.getElementById('mgr_income_category')?.value;
            const amount = Number(document.getElementById('mgr_income_amount')?.value || 0);
            const method = document.getElementById('mgr_income_method')?.value || 'cash';
            const ref = document.getElementById('mgr_income_ref')?.value?.trim() || null;
            const note = document.getElementById('mgr_income_note')?.value?.trim() || '';

            if (!category) return UI.toast('Veuillez sélectionner une catégorie', 'warning');
            if (!amount || amount <= 0) return UI.toast('Montant invalide', 'warning');

            const categoryLabels = {
                'vente_directe': 'Vente directe',
                'vente_en_gros': 'Vente en gros',
                'service': 'Prestation de service',
                'livraison': 'Frais de livraison',
                'commission': 'Commission reçue',
                'remboursement': 'Remboursement reçu',
                'location': 'Location/Sous-location',
                'partenariat': 'Partenariat',
                'interet': 'Intérêts/Dividendes',
                'autre': 'Autre revenu'
            };

            const categoryLabel = categoryLabels[category] || category;
            const fullNote = `[${categoryLabel}]${note ? ' ' + note : ''}`;

            const { cityId, posId } = this.getFinanceScope();
            CORE.recordFinancialTransaction({
                type: 'income',
                category: category,
                amount,
                method,
                ref,
                note: fullNote,
                cityId,
                posId,
                settled: true
            });
            CORE.logAudit('create', 'income', Date.now(), categoryLabel, { description: `Revenu: ${CORE.formatPrice(amount)} - ${categoryLabel}`, amount });

            UI.closeModal();
            UI.toast(`Revenu de ${CORE.formatPrice(amount)} enregistré (${categoryLabel})`, 'success');
            App.rerender();
        },

        markCODCollected(orderId) {
            const o = CORE.getVisibleOrders().find(x => x.id === orderId);
            if (!o) return;
            if (o.paymentMethod !== 'cod') return UI.toast('Ce n’est pas une commande COD', 'warning');

            const updated = CORE.update('orders', o.id, { paymentStatus: 'paid' });
            CORE.ensureSaleTransaction(updated);
            UI.toast('COD marqué comme encaissé', 'success');
            App.rerender();
        },

        markTransactionSettled(txId) {
            const tx = CORE.getVisibleTransactions().find(t => t.id === txId);
            if (!tx) return;
            if (tx.settled) return UI.toast('Déjà réglé', 'info');
            CORE.update('financialTransactions', tx.id, { settled: true, settledAt: new Date().toISOString() });
            UI.toast('Transaction réglée', 'success');
            App.rerender();
        },

        renderFinance() {
            const tab = this.state.financeTab;
            const summary = this.getFinanceSummary();
            const txs = this.getTransactionsFiltered();
            const cod = this.getCODOutstanding();
            const commissions = this.getCommissionsDue();

            const scope = this.getFinanceScope();
            const cityOptions = [{value:'',label:'Toutes villes'}, ...(CORE.db.cities || []).map(c=>({value:c.id,label:c.name}))];
            const posOptions = [{value:'',label:'Tous POS'}, ...(CORE.db.pointsOfSale || []).map(p=>({value:p.id,label:p.name}))];

            const categories = [
                { value:'all', label:'Toutes catégories' },
                { value:'sale', label:'Ventes' },
                { value:'expense', label:'Dépenses' },
                { value:'commission', label:'Commissions' }
            ];

            const methods = [
                { value:'all', label:'Toutes méthodes' },
                { value:'cash', label:'Cash' },
                { value:'mobile', label:'Mobile Money' },
                { value:'cod', label:'Paiement à la livraison' },
                { value:'internal', label:'Interne' }
            ];

            // Top dépenses par catégorie
            const expenseByCategory = {};
            txs.filter(t => t.type === 'expense').forEach(t => {
                const cat = t.category || 'autre';
                expenseByCategory[cat] = (expenseByCategory[cat] || 0) + (t.amount || 0);
            });
            const topExpenseCategories = Object.entries(expenseByCategory).sort((a, b) => b[1] - a[1]).slice(0, 5);

            // Répartition par méthode de paiement
            const paymentMethods = {
                cash: summary.cash || 0,
                mobile: summary.mobile || 0,
                cod: summary.cod || 0,
                card: summary.card || 0
            };
            const totalPayments = Object.values(paymentMethods).reduce((a, b) => a + b, 0) || 1;

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <!-- Header avec gradient et navigation -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                                    <i data-lucide="wallet" class="w-6 h-6"></i>
                                </div>
                                Finance Control Center
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Encaissements, COD, commissions, dépenses et journal</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="ManagerModule.showNewIncomeModal()" class="px-4 py-2.5 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-black rounded-xl hover:from-emerald-600 hover:to-emerald-700 transition shadow-lg shadow-emerald-500/30 flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> Nouveau revenu
                            </button>
                            <button onclick="ManagerModule.showNewExpenseModal()" class="px-4 py-2.5 bg-red-500 text-white font-black rounded-xl hover:bg-red-600 transition flex items-center gap-2">
                                <i data-lucide="minus-circle" class="w-4 h-4"></i> Nouvelle dépense
                            </button>
                            <button onclick="ManagerModule.exportFinanceCSV()" class="px-4 py-2.5 bg-white border border-slate-200 text-slate-700 font-black rounded-xl hover:bg-slate-50 transition flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> Exporter
                            </button>
                        </div>
                    </div>

                    <!-- KPIs Principaux avec gradients -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-5 text-white shadow-lg shadow-emerald-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-up" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Encaissements</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(summary.income)}</div>
                                <div class="text-xs opacity-70 mt-2">Cash ${CORE.formatPrice(summary.cash)} • Mobile ${CORE.formatPrice(summary.mobile)}</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl p-5 text-white shadow-lg shadow-red-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-down" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Dépenses</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(summary.expense)}</div>
                                <div class="text-xs opacity-70 mt-2">Inclut commissions & charges</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-5 text-white shadow-lg shadow-blue-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="bar-chart-3" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Bénéfice Net</span>
                                </div>
                                <div class="text-3xl font-black">${summary.net >= 0 ? '+' : ''}${CORE.formatPrice(summary.net)}</div>
                                <div class="text-xs opacity-70 mt-2">Encaissements - dépenses</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-5 text-white shadow-lg shadow-amber-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="truck" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">COD à encaisser</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(cod.amount)}</div>
                                <div class="text-xs opacity-70 mt-2">${cod.count} commande(s) en attente</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <div class="flex flex-wrap gap-2">
                                <button onclick="ManagerModule.state.financeTab='overview';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='overview'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Vue</button>
                                <button onclick="ManagerModule.state.financeTab='transactions';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='transactions'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Journal</button>
                                <button onclick="ManagerModule.state.financeTab='cod';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='cod'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">COD</button>
                                <button onclick="ManagerModule.state.financeTab='commissions';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='commissions'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Commissions</button>
                            </div>

                            <div class="flex flex-wrap gap-2">
                                <select onchange="ManagerModule.state.financeCityId=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${cityOptions.map(o => `<option value="${o.value}" ${String(o.value)===String(this.state.financeCityId)?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                                <select onchange="ManagerModule.state.financePosId=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${posOptions.map(o => `<option value="${o.value}" ${String(o.value)===String(this.state.financePosId)?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                                <input type="date" value="${this.state.financeFrom ? this.formatDateForInput(this.state.financeFrom) : ''}" onchange="ManagerModule.state.financeFrom=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                                <input type="date" value="${this.state.financeTo ? this.formatDateForInput(this.state.financeTo) : ''}" onchange="ManagerModule.state.financeTo=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                            </div>
                        </div>

                        ${tab === 'overview' ? `
                            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <!-- Colonne gauche: Commissions + Répartition paiements -->
                                <div class="lg:col-span-2 space-y-6">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="bg-slate-50 border border-slate-200 rounded-3xl p-5">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Commissions à payer</div>
                                                    <div class="mt-2 text-2xl font-black text-red-600">${CORE.formatPrice(commissions.dueAmount)}</div>
                                                    <div class="text-xs text-slate-500">${commissions.dueCount} course(s)</div>
                                                </div>
                                                <div class="w-12 h-12 bg-red-100 rounded-2xl flex items-center justify-center text-red-600"><i data-lucide="hand-coins" class="w-6 h-6"></i></div>
                                            </div>
                                        </div>
                                        <div class="bg-slate-50 border border-slate-200 rounded-3xl p-5">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Transactions</div>
                                                    <div class="mt-2 text-2xl font-black text-slate-900">${txs.length}</div>
                                                    <div class="text-xs text-slate-500">Périmètre: ${scope.cityId ? CORE.getCity(scope.cityId)?.name : 'Global'}</div>
                                                </div>
                                                <div class="w-12 h-12 bg-slate-200 rounded-2xl flex items-center justify-center text-slate-700"><i data-lucide="list" class="w-6 h-6"></i></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Répartition par méthode de paiement -->
                                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                        <h3 class="text-lg font-black text-slate-900 flex items-center gap-2 mb-6">
                                            <i data-lucide="credit-card" class="w-5 h-5 text-blue-500"></i>
                                            Répartition par Méthode de Paiement
                                        </h3>
                                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                            <div class="text-center p-4 bg-slate-50 rounded-xl">
                                                <div class="w-12 h-12 bg-slate-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                                    <i data-lucide="banknote" class="w-6 h-6 text-slate-600"></i>
                                                </div>
                                                <div class="text-lg font-black text-slate-900">${CORE.formatPrice(paymentMethods.cash)}</div>
                                                <div class="text-xs text-slate-500 font-bold">Cash</div>
                                                <div class="text-[10px] text-slate-400">${Math.round((paymentMethods.cash / totalPayments) * 100)}%</div>
                                            </div>
                                            <div class="text-center p-4 bg-blue-50 rounded-xl">
                                                <div class="w-12 h-12 bg-blue-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                                    <i data-lucide="smartphone" class="w-6 h-6 text-blue-600"></i>
                                                </div>
                                                <div class="text-lg font-black text-blue-900">${CORE.formatPrice(paymentMethods.mobile)}</div>
                                                <div class="text-xs text-blue-700 font-bold">Mobile Money</div>
                                                <div class="text-[10px] text-blue-500">${Math.round((paymentMethods.mobile / totalPayments) * 100)}%</div>
                                            </div>
                                            <div class="text-center p-4 bg-amber-50 rounded-xl">
                                                <div class="w-12 h-12 bg-amber-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                                    <i data-lucide="truck" class="w-6 h-6 text-amber-600"></i>
                                                </div>
                                                <div class="text-lg font-black text-amber-900">${CORE.formatPrice(paymentMethods.cod)}</div>
                                                <div class="text-xs text-amber-700 font-bold">COD</div>
                                                <div class="text-[10px] text-amber-500">${Math.round((paymentMethods.cod / totalPayments) * 100)}%</div>
                                            </div>
                                            <div class="text-center p-4 bg-indigo-50 rounded-xl">
                                                <div class="w-12 h-12 bg-indigo-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                                    <i data-lucide="credit-card" class="w-6 h-6 text-indigo-600"></i>
                                                </div>
                                                <div class="text-lg font-black text-indigo-900">${CORE.formatPrice(paymentMethods.card || 0)}</div>
                                                <div class="text-xs text-indigo-700 font-bold">Carte</div>
                                                <div class="text-[10px] text-indigo-500">${Math.round(((paymentMethods.card || 0) / totalPayments) * 100)}%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Colonne droite: Actions rapides + Top dépenses -->
                                <div class="space-y-6">
                                    <!-- Actions rapides -->
                                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 text-white">
                                        <h3 class="text-lg font-black mb-4 flex items-center gap-2">
                                            <i data-lucide="zap" class="w-5 h-5 text-amber-400"></i>
                                            Actions Rapides
                                        </h3>
                                        <div class="space-y-3">
                                            <button onclick="ManagerModule.showNewExpenseModal()" class="w-full px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                                <i data-lucide="minus-circle" class="w-5 h-5"></i>
                                                Enregistrer une dépense
                                            </button>
                                            <button onclick="ManagerModule.state.financeTab='cod';App.rerender()" class="w-full px-4 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                                <i data-lucide="truck" class="w-5 h-5"></i>
                                                Gérer COD en attente
                                            </button>
                                            <button onclick="ManagerModule.state.financeTab='commissions';App.rerender()" class="w-full px-4 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                                <i data-lucide="hand-coins" class="w-5 h-5"></i>
                                                Payer commissions
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Top dépenses par catégorie -->
                                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                        <h3 class="text-lg font-black text-slate-900 flex items-center gap-2 mb-4">
                                            <i data-lucide="pie-chart" class="w-5 h-5 text-red-500"></i>
                                            Top Dépenses
                                        </h3>
                                        ${topExpenseCategories.length === 0 ? '<div class="text-center py-4 text-slate-400 text-sm">Aucune dépense enregistrée</div>' :
                                            '<div class="space-y-3">' + topExpenseCategories.map(([cat, amount], i) => {
                                                const colors = ['bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-yellow-500', 'bg-lime-500'];
                                                const maxAmount = topExpenseCategories[0][1] || 1;
                                                return '<div class="flex items-center gap-3"><div class="w-8 h-8 ' + colors[i] + ' rounded-lg flex items-center justify-center text-white text-xs font-black">' + (i + 1) + '</div><div class="flex-1"><div class="flex justify-between mb-1"><span class="text-sm font-bold text-slate-700 capitalize">' + cat + '</span><span class="text-sm font-black text-red-600">' + CORE.formatPrice(amount) + '</span></div><div class="h-2 bg-slate-100 rounded-full overflow-hidden"><div class="' + colors[i] + ' h-full rounded-full" style="width: ' + ((amount / maxAmount) * 100) + '%"></div></div></div></div>';
                                            }).join('') + '</div>'
                                        }
                                        <button onclick="ManagerModule.state.financeTab='transactions';ManagerModule.state.financeType='expense';App.rerender()" class="w-full mt-4 px-4 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-200 transition">
                                            Voir toutes les dépenses →
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${tab === 'transactions' ? `
                            <div class="p-4 border-t border-slate-100 flex flex-wrap gap-2 items-center">
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input id="manager-finance-search-input" type="text" value="${this.state.financeSearch}" onkeyup="ManagerModule.updateFinanceSearch(this.value)" placeholder="Recherche (ref, note, montant...)" class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium w-[280px] max-w-full" style="direction: ltr; text-align: left;" autocomplete="off">
                                </div>
                                <select onchange="ManagerModule.state.financeType=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${[
                                        {value:'all',label:'Tous types'},
                                        {value:'income',label:'Encaissements'},
                                        {value:'expense',label:'Dépenses'}
                                    ].map(o=>`<option value="${o.value}" ${o.value===this.state.financeType?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                                <select onchange="ManagerModule.state.financeCategory=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${categories.map(o=>`<option value="${o.value}" ${o.value===this.state.financeCategory?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                                <select onchange="ManagerModule.state.financeMethod=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${methods.map(o=>`<option value="${o.value}" ${o.value===this.state.financeMethod?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                            </div>

                            <div class="overflow-auto">
                                <table class="w-full text-left min-w-[1100px]">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">Type</th>
                                            <th class="px-6 py-4">Catégorie</th>
                                            <th class="px-6 py-4 text-right">Montant</th>
                                            <th class="px-6 py-4">Méthode</th>
                                            <th class="px-6 py-4">Référence / Note</th>
                                            <th class="px-6 py-4">Statut</th>
                                            <th class="px-6 py-4 text-right">Date</th>
                                            <th class="px-6 py-4 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${txs.length===0 ? `<tr><td colspan="8" class="px-6 py-12 text-center text-slate-400 font-medium">Aucune transaction</td></tr>` : ''}
                                        ${txs.map(t => {
                                            const amount = CORE.formatPrice(t.amount);
                                            const sign = t.type==='income' ? '+' : '-';
                                            const color = t.type==='income' ? 'text-emerald-600' : 'text-red-600';
                                            const statusBadge = t.settled ? UI.badge('Réglé','emerald') : UI.badge('À régler','amber');
                                            return `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-6 py-4 font-black text-slate-900">${t.type}</td>
                                                <td class="px-6 py-4">${UI.badge(t.category, t.category==='sale'?'emerald':t.category==='commission'?'amber':t.category==='expense'?'red':'slate')}</td>
                                                <td class="px-6 py-4 text-right font-black ${color}">${sign} ${amount}</td>
                                                <td class="px-6 py-4 font-bold">${CORE.paymentMethodLabel(t.method)}</td>
                                                <td class="px-6 py-4">
                                                    <div class="font-black text-slate-900">${t.ref || '—'}</div>
                                                    <div class="text-xs text-slate-500">${t.note || ''}</div>
                                                </td>
                                                <td class="px-6 py-4">${statusBadge}</td>
                                                <td class="px-6 py-4 text-right text-xs text-slate-500">${CORE.formatDate(t.createdAt)}</td>
                                                <td class="px-6 py-4 text-right">
                                                    ${(!t.settled && t.category==='commission') ? `<button onclick="ManagerModule.markTransactionSettled(${t.id})" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-black hover:bg-slate-800">Marquer payé</button>` : '<span class="text-xs text-slate-400">—</span>'}
                                                </td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                        ${tab === 'cod' ? `
                            <div class="p-4">
                                <div class="p-4 bg-amber-50 border border-amber-100 rounded-2xl text-sm text-amber-800">
                                    <b>COD à encaisser:</b> commandes en paiement à la livraison dont le paiement n’est pas encore marqué "Payé".
                                </div>
                            </div>
                            <div class="overflow-auto">
                                <table class="w-full text-left min-w-[980px]">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">Réf</th>
                                            <th class="px-6 py-4">Client</th>
                                            <th class="px-6 py-4">Statut cmd</th>
                                            <th class="px-6 py-4">Statut paiement</th>
                                            <th class="px-6 py-4 text-right">Montant</th>
                                            <th class="px-6 py-4 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${cod.orders.length===0 ? `<tr><td colspan="6" class="px-6 py-12 text-center text-slate-400 font-medium">Aucun COD en attente</td></tr>` : ''}
                                        ${cod.orders.map(o => `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-6 py-4 font-black text-slate-900">${o.reference}</td>
                                                <td class="px-6 py-4">
                                                    <div class="font-bold">${o.clientName || '—'}</div>
                                                    <div class="text-xs text-slate-500">${o.clientPhone || ''}</div>
                                                </td>
                                                <td class="px-6 py-4">${UI.badge(o.status, o.status==='delivered'?'emerald':o.status==='delivering'?'amber':'slate')}</td>
                                                <td class="px-6 py-4">${UI.badge(CORE.paymentStatusLabel(o.paymentStatus), o.paymentStatus==='paid'?'emerald':'amber')}</td>
                                                <td class="px-6 py-4 text-right font-black text-amber-700">${CORE.formatPrice(o.total)}</td>
                                                <td class="px-6 py-4 text-right">
                                                    <button onclick="ManagerModule.markCODCollected(${o.id})" class="px-3 py-2 rounded-xl bg-amber-500 text-white text-xs font-black hover:bg-amber-600">Marquer encaissé</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                        ${tab === 'commissions' ? `
                            <div class="p-4">
                                <div class="p-4 bg-red-50 border border-red-100 rounded-2xl text-sm text-red-800">
                                    <b>Commissions:</b> dépenses de type "commission" (souvent à régler au livreur).
                                </div>
                            </div>
                            <div class="overflow-auto">
                                <table class="w-full text-left min-w-[980px]">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">Réf</th>
                                            <th class="px-6 py-4">Livreur</th>
                                            <th class="px-6 py-4">Statut</th>
                                            <th class="px-6 py-4 text-right">Montant</th>
                                            <th class="px-6 py-4 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${commissions.due.length===0 ? `<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400 font-medium">Aucune commission à payer</td></tr>` : ''}
                                        ${commissions.due.map(t => {
                                            const del = t.deliveryId ? CORE.getVisibleDeliveries().find(d => d.id === t.deliveryId) : null;
                                            const livreur = del?.livreurId ? CORE.getUser(del.livreurId) : null;
                                            return `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-6 py-4 font-black text-slate-900">${t.ref || '—'}</td>
                                                <td class="px-6 py-4 font-bold">${livreur?.name || '—'}</td>
                                                <td class="px-6 py-4">${UI.badge('À payer','amber')}</td>
                                                <td class="px-6 py-4 text-right font-black text-red-600">${CORE.formatPrice(t.amount)}</td>
                                                <td class="px-6 py-4 text-right"><button onclick="ManagerModule.markTransactionSettled(${t.id})" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-black hover:bg-slate-800">Marquer payé</button></td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                    </div>
                </div>
            `;
        },

        // =====================
        // TEAM / RH (Manager)
        // =====================
        getTeamFiltered(paginate = true) {
            const q = (this.state.teamSearch || '').toLowerCase().trim();
            const role = this.state.teamRole || 'all';
            const posId = this.state.teamPosId || 'all';
            const sortBy = this.state.teamSortBy || 'name';
            const sortOrder = this.state.teamSortOrder || 'asc';

            let users = CORE.getVisibleUsers().filter(u => ['gestionnaire','vendeur','livreur'].includes(u.role));

            // Filtre par rôle
            if (role !== 'all') users = users.filter(u => u.role === role);

            // Filtre par POS
            if (posId !== 'all') users = users.filter(u => String(u.pos || u.posId) === String(posId));

            // Filtre par recherche
            if (q) users = users.filter(u =>
                (u.name || '').toLowerCase().includes(q) ||
                (u.phone || '').toLowerCase().includes(q) ||
                (u.username || '').toLowerCase().includes(q) ||
                String(u.id).includes(q)
            );

            // Tri
            users.sort((a, b) => {
                let cmp = 0;
                if (sortBy === 'name') cmp = (a.name || '').localeCompare(b.name || '');
                else if (sortBy === 'role') cmp = (a.role || '').localeCompare(b.role || '');
                else if (sortBy === 'pos') {
                    const posA = (CORE.db.pointsOfSale || []).find(p => p.id === (a.pos || a.posId))?.name || '';
                    const posB = (CORE.db.pointsOfSale || []).find(p => p.id === (b.pos || b.posId))?.name || '';
                    cmp = posA.localeCompare(posB);
                }
                return sortOrder === 'desc' ? -cmp : cmp;
            });

            if (!paginate) return users;

            // Pagination
            const page = this.state.teamPage || 1;
            const perPage = this.state.teamPerPage || 20;
            const start = (page - 1) * perPage;
            return users.slice(start, start + perPage);
        },

        getTeamStats() {
            const allUsers = this.getTeamFiltered(false);
            const totalFiltered = allUsers.length;
            const totalUsers = CORE.getVisibleUsers().filter(u => ['gestionnaire','vendeur','livreur'].includes(u.role)).length;
            const page = this.state.teamPage || 1;
            const perPage = this.state.teamPerPage || 20;
            const totalPages = Math.ceil(totalFiltered / perPage) || 1;

            // Stats par POS
            const posList = CORE.db.pointsOfSale || [];
            const usersByPos = {};
            CORE.getVisibleUsers().filter(u => ['gestionnaire','vendeur','livreur'].includes(u.role)).forEach(u => {
                const pid = u.pos || u.posId || 0;
                usersByPos[pid] = (usersByPos[pid] || 0) + 1;
            });

            // Stats par rôle
            const usersByRole = {};
            CORE.getVisibleUsers().filter(u => ['gestionnaire','vendeur','livreur'].includes(u.role)).forEach(u => {
                usersByRole[u.role] = (usersByRole[u.role] || 0) + 1;
            });

            return { totalFiltered, totalUsers, page, perPage, totalPages, usersByPos, usersByRole, posList };
        },

        getTeamGroupedByPos() {
            const users = this.getTeamFiltered(false);
            const posList = CORE.db.pointsOfSale || [];
            const grouped = {};

            posList.forEach(pos => {
                grouped[pos.id] = { pos, users: [] };
            });
            grouped[0] = { pos: { id: 0, name: 'Non assigné' }, users: [] };

            users.forEach(u => {
                const pid = u.pos || u.posId || 0;
                if (!grouped[pid]) {
                    grouped[pid] = { pos: { id: pid, name: 'POS #' + pid }, users: [] };
                }
                grouped[pid].users.push(u);
            });

            return Object.values(grouped).filter(g => g.users.length > 0).sort((a, b) => (a.pos.name || '').localeCompare(b.pos.name || ''));
        },

        updateTeamSearch(value) {
            this.state.teamSearch = value;
            this.state.teamPage = 1;
            if (this.teamSearchTimer) clearTimeout(this.teamSearchTimer);
            this.teamSearchTimer = setTimeout(() => {
                const input = document.getElementById('manager-team-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('manager-team-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 400);
        },

        updateInventorySearch(value) {
            this.state.inventorySearch = value;
            this.state.inventoryPage = 1; // Reset to page 1 on search
            if (this.inventorySearchTimer) clearTimeout(this.inventorySearchTimer);
            this.inventorySearchTimer = setTimeout(() => {
                const input = document.getElementById('manager-inventory-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('manager-inventory-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateMovementsSearch(value) {
            this.state.movementsSearch = value;
            if (this.movementsSearchTimer) clearTimeout(this.movementsSearchTimer);
            this.movementsSearchTimer = setTimeout(() => {
                const input = document.getElementById('manager-movements-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('manager-movements-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateFinanceSearch(value) {
            this.state.financeSearch = value;
            if (this.financeSearchTimer) clearTimeout(this.financeSearchTimer);
            this.financeSearchTimer = setTimeout(() => {
                const input = document.getElementById('manager-finance-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('manager-finance-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        // [Dead duplicate updateTeamSearch removed — first version with teamPage reset is used]

        roleLabel(role) {
            const map = { gestionnaire: 'Gestionnaire', vendeur: 'Vendeur', livreur: 'Livreur' };
            return map[role] || role;
        },

        exportTeamList() {
            const allUsers = this.getTeamFiltered(false);
            const posList = CORE.db.pointsOfSale || [];

            let csvContent = 'sep=,\n';
            csvContent += 'ID,Nom,Username,Role,Telephone,Point de Vente,Statut,Date Creation\n';

            allUsers.forEach(u => {
                const pos = posList.find(p => p.id === (u.pos || u.posId));
                csvContent += `${u.id},"${u.name || ''}","${u.username || ''}","${u.role || ''}","${u.phone || ''}","${pos?.name || 'Non assigne'}","${u.active !== false ? 'Actif' : 'Inactif'}","${u.createdAt || '—'}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'equipe_manager_' + new Date().getTime() + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('Liste exportee (' + allUsers.length + ' membres)', 'success');
        },

        // ========== DASHBOARD MULTI-POS - FONCTIONS SUPPORT ==========

        showPosDetailsModal(posId) {
            const pos = CORE.getPOS(posId);
            if (!pos) return UI.toast('POS non trouvé', 'error');

            const staff = CORE.getVisibleUsers().filter(u => u.pos === posId && u.active);
            const orders = CORE.getVisibleOrders().filter(o => o.posId === posId);
            const revenue = orders.filter(o => o.status === 'delivered').reduce((a,o)=>a+(o.total||0),0);
            const products = CORE.getVisibleProducts().filter(p => p.posId === posId);
            const lowStock = products.filter(p => p.stock <= p.minStock).length;

            UI.modal(`📍 Détails: ${pos.name}`, `
                <div class="space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-200">
                            <div class="text-xs font-bold text-emerald-700 uppercase">Chiffre d'affaires</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${CORE.formatPrice(revenue)}</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-blue-50 border border-blue-200">
                            <div class="text-xs font-bold text-blue-700 uppercase">Commandes</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${orders.length}</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-purple-50 border border-purple-200">
                            <div class="text-xs font-bold text-purple-700 uppercase">Produits</div>
                            <div class="text-2xl font-black text-purple-900 mt-1">${products.length}</div>
                        </div>
                        <div class="p-4 rounded-2xl ${lowStock > 0 ? 'bg-red-50 border border-red-200' : 'bg-slate-50 border border-slate-200'}">
                            <div class="text-xs font-bold ${lowStock > 0 ? 'text-red-700' : 'text-slate-700'} uppercase">Critiques</div>
                            <div class="text-2xl font-black ${lowStock > 0 ? 'text-red-900' : 'text-slate-900'} mt-1">${lowStock}</div>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <h4 class="font-black text-slate-900 mb-3">👥 Équipe</h4>
                        <div class="space-y-2">
                            ${staff.map(u => `
                                <div class="p-3 rounded-xl border border-slate-200 flex items-center justify-between">
                                    <div>
                                        <div class="font-bold text-slate-900">${u.name}</div>
                                        <div class="text-xs text-slate-500 capitalize">${this.roleLabel(u.role)}</div>
                                    </div>
                                    <span class="px-2 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-700">✓ Actif</span>
                                </div>
                            `).join('')}
                            ${staff.length === 0 ? '<div class="text-slate-500 italic text-sm">Aucun personnel assigné</div>' : ''}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' },
                { label: 'Gérer Stock', onclick: `ManagerModule.showStockTransferModal(${posId})`, class: 'px-4 py-2 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700' }
            ]);
        },



        showRestockModal(productId) {
            const product = CORE.getProduct(productId);
            if (!product) return UI.toast('Produit non trouvé', 'error');

            UI.modal(`📦 Restock: ${product.name}`, `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-3 rounded-xl bg-slate-50 text-center">
                            <div class="text-xs text-slate-600 font-bold">Stock actuel</div>
                            <div class="text-2xl font-black text-slate-900">${product.stock}</div>
                        </div>
                        <div class="p-3 rounded-xl bg-slate-50 text-center">
                            <div class="text-xs text-slate-600 font-bold">Minimum</div>
                            <div class="text-2xl font-black text-slate-900">${product.minStock}</div>
                        </div>
                    </div>

                    <label class="block text-sm font-black text-slate-900">Nouvelle quantité</label>
                    <input type="number" id="restock_qty" value="${product.stock}" min="0" class="w-full px-4 py-2 border border-slate-200 rounded-xl bg-white font-bold">

                    <label class="block text-sm font-black text-slate-900 mt-3">Motif</label>
                    <textarea id="restock_reason" placeholder="Ex: Achat fournisseur, correction, etc." class="w-full px-4 py-2 border border-slate-200 rounded-xl bg-white font-bold" rows="2"></textarea>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Mettre à jour', onclick: `ManagerModule.updateStockQty(${productId})`, class: 'px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' }
            ]);
        },

        updateStockQty(productId) {
            const newQty = parseInt(UI.val('restock_qty') || '0', 10);
            const reason = UI.val('restock_reason').trim();
            const product = CORE.getProduct(productId);

            if (!product) return UI.toast('Produit non trouvé', 'error');
            if (newQty < 0) return UI.toast('Quantité invalide', 'warning');

            const posId = this.state.inventoryPosId || null;
            const currentStock = posId ? CORE.getProductStock(productId, posId) : (product.stock || 0);
            const diff = newQty - currentStock;
            const moveType = diff > 0 ? 'in' : 'out';

            // Update per-POS stock if POS is selected, otherwise update global stock
            if (posId) {
                CORE.setProductStock(productId, posId, newQty);
            } else {
                product.stock = newQty;
            }

            CORE.recordStockMovement({
                productId,
                type: moveType,
                qty: Math.abs(diff),
                note: reason || `Ajustement stock ${moveType === 'in' ? 'positif' : 'négatif'}`,
                ref: `ADJUST-${productId}`,
                posId: posId || null
            });

            CORE.save();
            UI.closeModal();
            UI.toast('✓ Stock mis à jour', 'success');
            App.rerender();
        },

        showNewUserModal() {
            UI.modal('Créer un compte', `
                <div class="space-y-4">
                    ${UI.input('mu_name','Nom complet','text','','Ex: Aline Mavoungou',true)}
                    ${UI.select('mu_role','Rôle',[
                        {value:'gestionnaire',label:'Gestionnaire'},
                        {value:'vendeur',label:'Vendeur'},
                        {value:'livreur',label:'Livreur'}
                    ], 'vendeur', true)}
                    ${UI.input('mu_phone','Téléphone','tel','', CORE.getPhonePlaceholder(), false)}
                    ${UI.input('mu_avatar','Avatar (2 lettres)','text','', 'Ex: AM', false)}
                    <div class="grid grid-cols-2 gap-3">
                        ${UI.select('mu_city','Ville', CORE.db.cities.map(c=>({value:c.id,label:c.name})), CORE.state.currentUser?.city || 1)}
                        ${UI.select('mu_pos','Point de vente', (CORE.db.pointsOfSale || []).map(p=>({value:p.id,label:p.name})), CORE.state.currentUser?.pos || 1)}
                    </div>
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">
                        Notes: la ville/POS sont utiles pour les vendeurs/gestionnaires. Pour les livreurs, c'est optionnel.
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Créer', onclick: 'ManagerModule.createUser()', class: 'px-5 py-2.5 bg-sky-600 text-white font-black rounded-xl hover:bg-sky-700 transition' }
            ]);
        },

        createUser() {
            const name = UI.val('mu_name').trim();
            const role = UI.val('mu_role');
            const phone = UI.val('mu_phone').trim();
            const avatarRaw = UI.val('mu_avatar').trim();
            const city = parseInt(UI.val('mu_city') || '0', 10) || null;
            const pos = parseInt(UI.val('mu_pos') || '0', 10) || null;

            if (!name || !role) return UI.toast('Nom et rôle requis', 'warning');
            if (!['gestionnaire','vendeur','livreur'].includes(role)) return UI.toast('Rôle invalide', 'error');

            const avatar = (avatarRaw || name.split(' ').map(x=>x[0]).slice(0,2).join('')).toUpperCase().slice(0,2);

            const created = CORE.create('users', {
                name,
                role,
                avatar,
                phone: phone || null,
                active: true,
                city: city || null,
                pos: pos || null,
                // champs livreur
                vehicle: role === 'livreur' ? 'moto' : null,
                rating: role === 'livreur' ? 5.0 : null,
                deliveryCount: role === 'livreur' ? 0 : null
            });

            CORE.logAudit('create', 'user', created.id, name, { description: `Utilisateur créé: ${name} (${role})`, role });
            CORE.notify('info', `Nouveau compte créé: ${created.name} (${created.role})`, { userId: created.id });
            UI.closeModal();
            UI.toast('Compte créé', 'success');
            App.rerender();
        },

        showEditUserModal(userId) {
            const u = CORE.getUser(userId);
            if (!u) return;
            if (!['gestionnaire','vendeur','livreur'].includes(u.role)) return UI.toast('Ce compte n’est pas géré ici', 'warning');

            UI.modal(`Modifier: ${u.name}`, `
                <div class="space-y-4">
                    ${UI.input('eu_name','Nom complet','text', u.name || '', '', true)}
                    ${UI.select('eu_role','Rôle',[
                        {value:'gestionnaire',label:'Gestionnaire'},
                        {value:'vendeur',label:'Vendeur'},
                        {value:'livreur',label:'Livreur'}
                    ], u.role, true)}
                    ${UI.input('eu_phone','Téléphone','tel', u.phone || '', CORE.getPhonePlaceholder(), false)}
                    ${UI.input('eu_avatar','Avatar (2 lettres)','text', u.avatar || '', '', false)}

                    <div class="grid grid-cols-2 gap-3">
                        ${UI.select('eu_city','Ville', CORE.db.cities.map(c=>({value:c.id,label:c.name})), u.city || '')}
                        ${UI.select('eu_pos','Point de vente', (CORE.db.pointsOfSale || []).map(p=>({value:p.id,label:p.name})), u.pos || '')}
                    </div>

                    ${u.role === 'livreur' ? `
                        <div class="grid grid-cols-2 gap-3">
                            ${UI.select('eu_vehicle','Véhicule',[{value:'moto',label:'Moto'},{value:'voiture',label:'Voiture'},{value:'velo',label:'Vélo'},{value:'',label:'—'}], u.vehicle || '')}
                            ${UI.input('eu_rating','Note (0-5)','number', u.rating ?? '', 'ex: 4.8')}
                        </div>
                    ` : ''}

                    ${UI.select('eu_active','Statut',[{value:'1',label:'Actif'},{value:'0',label:'Inactif'}], u.active ? '1':'0', true)}

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-xs text-slate-600">
                        Astuce: désactiver un compte empêche la connexion sur l'écran de login (vous verrez toujours le compte ici).
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: `ManagerModule.saveUser(${u.id})`, class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        async saveUser(userId) {
            const u = CORE.getUser(userId);
            if (!u) return;

            const name = UI.val('eu_name').trim();
            const role = UI.val('eu_role');
            const phone = UI.val('eu_phone').trim();
            const avatarRaw = UI.val('eu_avatar').trim();
            const city = parseInt(UI.val('eu_city') || '0', 10) || null;
            const pos = parseInt(UI.val('eu_pos') || '0', 10) || null;
            const active = UI.val('eu_active') === '1';

            if (!name || !role) return UI.toast('Nom et rôle requis', 'warning');
            if (!['gestionnaire','vendeur','livreur'].includes(role)) return UI.toast('Rôle invalide', 'error');

            const avatar = (avatarRaw || name.split(' ').map(x=>x[0]).slice(0,2).join('')).toUpperCase().slice(0,2);

            const updates = {
                name,
                role,
                phone: phone || null,
                avatar,
                city: city || null,
                pos: pos || null,
                active
            };

            if (role === 'livreur') {
                const vehicle = UI.val('eu_vehicle')?.trim() || null;
                const ratingRaw = UI.val('eu_rating');
                const rating = ratingRaw === '' ? null : Utils.clamp(parseFloat(ratingRaw), 0, 5);
                updates.vehicle = vehicle;
                updates.rating = rating;
                if (u.deliveryCount == null) updates.deliveryCount = 0;
            } else {
                // Nettoyage si on change de rôle
                updates.vehicle = null;
                updates.rating = null;
                updates.deliveryCount = null;
            }

            const beforeUser = { name: u.name, role: u.role, active: u.active, pos: u.pos, phone: u.phone };
            CORE.update('users', u.id, updates);

            // Propager dans l'index global
            CORE._syncGlobalFromTenant();

            const changes = [];
            if (name !== beforeUser.name) changes.push(`nom: "${beforeUser.name}" → "${name}"`);
            if (role !== beforeUser.role) changes.push(`rôle: "${beforeUser.role}" → "${role}"`);
            if (active !== beforeUser.active) changes.push(`statut: ${beforeUser.active ? 'actif' : 'inactif'} → ${active ? 'actif' : 'inactif'}`);
            if (pos !== beforeUser.pos) changes.push(`POS: ${beforeUser.pos || 'é'} → ${pos || 'é'}`);

            CORE.logAudit('update', 'user', u.id, name, { description: `Utilisateur modifié: ${changes.join(', ') || name + ' (' + role + ')'}` }, beforeUser, { name, role, active, pos, phone });
            CORE.notify('info', `Compte modifié: ${name} (${role})`, { userId: u.id });
            CORE.markDirty('users');

            // Synchroniser avec le backend cloud
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated()) {
                try {
                    await API.request('/sync/users', { method: 'PUT', body: { data: CORE.db.users || [] } });
                    console.log('[PDG] Cloud users synced after edit');
                } catch(e) {
                    console.warn('[PDG] Cloud sync after edit failed:', e.message);
                }
            }

            UI.closeModal();
            UI.toast('Compte mis à jour', 'success');
            App.rerender();
        },

        async toggleUserActive(userId) {
            const u = CORE.getUser(userId);
            if (!u) return;
            if (!['gestionnaire','vendeur','livreur'].includes(u.role)) return;
            const newActive = !u.active;
            const backendUserId = u._apiId || u.apiId || u.backendId || userId;
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated()) {
                try {
                    const endpoint = newActive ? '/users/' + backendUserId + '/reactivate' : '/users/' + backendUserId + '/deactivate';
                    await API.request(endpoint, { method: 'PATCH' });
                } catch(e) { console.warn('[GEST] toggleUserActive backend failed:', e.message); }
            }
            CORE.update('users', u.id, { active: newActive });
            UI.toast(newActive ? 'Compte activé' : 'Compte désactivé', 'info');
            App.rerender();
        },

        // [Dead duplicate renderTeam removed — was overriding the real version below]

        renderTeam() {
            const users = this.getTeamFiltered();
            const stats = this.getTeamStats();
            const viewMode = this.state.teamViewMode || 'list';
            const posList = CORE.db.pointsOfSale || [];
            const canManageUsers = CORE.getSystemSetting('manager_manage_users', false);

            const roles = [
                { value: 'all', label: 'Tous les rôles' },
                { value: 'gestionnaire', label: 'Gestionnaires' },
                { value: 'vendeur', label: 'Vendeurs' },
                { value: 'livreur', label: 'Livreurs' }
            ];

            const sortOptions = [
                { value: 'name', label: 'Nom' },
                { value: 'role', label: 'Rôle' },
                { value: 'pos', label: 'Point de vente' }
            ];

            const perPageOptions = [10, 20, 50, 100];

            // Rendu de la pagination
            const renderPagination = () => {
                if (stats.totalPages <= 1) return '';
                const pages = [];
                const maxVisible = 5;
                let start = Math.max(1, stats.page - Math.floor(maxVisible / 2));
                let end = Math.min(stats.totalPages, start + maxVisible - 1);
                if (end - start < maxVisible - 1) start = Math.max(1, end - maxVisible + 1);

                for (let i = start; i <= end; i++) {
                    pages.push(i);
                }

                return '<div class="flex items-center justify-center gap-2 mt-6">' +
                    '<button onclick="ManagerModule.state.teamPage = 1; App.rerender()" class="px-3 py-2 rounded-xl ' + (stats.page === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm transition" ' + (stats.page === 1 ? 'disabled' : '') + '><i data-lucide="chevrons-left" class="w-4 h-4"></i></button>' +
                    '<button onclick="ManagerModule.state.teamPage = Math.max(1, ManagerModule.state.teamPage - 1); App.rerender()" class="px-3 py-2 rounded-xl ' + (stats.page === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm transition" ' + (stats.page === 1 ? 'disabled' : '') + '><i data-lucide="chevron-left" class="w-4 h-4"></i></button>' +
                    pages.map(p => '<button onclick="ManagerModule.state.teamPage = ' + p + '; App.rerender()" class="px-3 py-2 rounded-xl ' + (p === stats.page ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm transition">' + p + '</button>').join('') +
                    '<button onclick="ManagerModule.state.teamPage = Math.min(' + stats.totalPages + ', ManagerModule.state.teamPage + 1); App.rerender()" class="px-3 py-2 rounded-xl ' + (stats.page === stats.totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm transition" ' + (stats.page === stats.totalPages ? 'disabled' : '') + '><i data-lucide="chevron-right" class="w-4 h-4"></i></button>' +
                    '<button onclick="ManagerModule.state.teamPage = ' + stats.totalPages + '; App.rerender()" class="px-3 py-2 rounded-xl ' + (stats.page === stats.totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm transition" ' + (stats.page === stats.totalPages ? 'disabled' : '') + '><i data-lucide="chevrons-right" class="w-4 h-4"></i></button>' +
                '</div>';
            };

            // Rendu d'un utilisateur en carte
            const renderUserCard = (u) => {
                const roleColors = { gestionnaire: 'from-cyan-500 to-cyan-600', vendeur: 'from-emerald-500 to-emerald-600', livreur: 'from-amber-500 to-amber-600' };
                const roleColor = roleColors[u.role] || 'from-slate-500 to-slate-600';
                const pos = posList.find(p => p.id === (u.pos || u.posId));
                const hasImage = u.profileImage && u.profileImage.trim();

                return '<div class="group p-4 rounded-2xl bg-white border border-slate-200 hover:border-blue-300 hover:shadow-lg hover:shadow-blue-500/10 transition-all cursor-pointer" onclick="ManagerModule.showUserDetailsModal(' + u.id + ')">' +
                    '<div class="flex items-start gap-4">' +
                        (hasImage ?
                            '<img src="' + u.profileImage + '" class="w-14 h-14 rounded-2xl object-cover shadow-lg ring-2 ring-white">' :
                            '<div class="w-14 h-14 bg-gradient-to-br ' + roleColor + ' rounded-2xl flex items-center justify-center text-white font-black text-lg shadow-lg">' + (u.avatar || (u.name||'?').slice(0,2).toUpperCase()) + '</div>'
                        ) +
                        '<div class="min-w-0 flex-1">' +
                            '<div class="flex items-center justify-between gap-2">' +
                                '<div class="font-black text-slate-900 truncate group-hover:text-blue-600 transition">' + u.name + '</div>' +
                                (u.active !== false ?
                                    '<span class="px-2 py-0.5 rounded-full text-[10px] font-black bg-emerald-100 text-emerald-700">Actif</span>' :
                                    '<span class="px-2 py-0.5 rounded-full text-[10px] font-black bg-slate-100 text-slate-500">Inactif</span>'
                                ) +
                            '</div>' +
                            '<div class="flex flex-wrap items-center gap-2 mt-1.5">' +
                                '<span class="text-[10px] text-white font-black uppercase tracking-wider bg-gradient-to-r ' + roleColor + ' px-2 py-0.5 rounded-lg shadow-sm">' + u.role + '</span>' +
                                (pos ? '<span class="text-[10px] text-blue-700 font-bold bg-blue-50 px-2 py-0.5 rounded-lg"><i data-lucide="store" class="w-3 h-3 inline -mt-0.5"></i> ' + pos.name + '</span>' : '') +
                            '</div>' +
                            (u.phone ? '<div class="mt-2 text-xs text-slate-500 flex items-center gap-1.5"><i data-lucide="phone" class="w-3.5 h-3.5"></i> ' + u.phone + '</div>' : '') +
                        '</div>' +
                    '</div>' +
                    '<div class="flex items-center gap-2 mt-3 pt-3 border-t border-slate-100">' +
                        '<button onclick="event.stopPropagation(); ManagerModule.showEditUserModal(' + u.id + ')" class="flex-1 px-3 py-2 bg-slate-100 hover:bg-blue-100 hover:text-blue-700 text-slate-700 text-xs font-bold rounded-xl transition flex items-center justify-center gap-1"><i data-lucide="edit-3" class="w-3.5 h-3.5"></i> Modifier</button>' +
                        '<button onclick="event.stopPropagation(); ManagerModule.toggleUserActive(' + u.id + ')" class="px-3 py-2 ' + (u.active ? 'bg-red-100 hover:bg-red-200 text-red-700' : 'bg-emerald-100 hover:bg-emerald-200 text-emerald-700') + ' text-xs font-bold rounded-xl transition"><i data-lucide="' + (u.active ? 'user-x' : 'user-check') + '" class="w-3.5 h-3.5"></i></button>' +
                    '</div>' +
                '</div>';
            };

            // Vue groupée par POS
            const renderGroupedView = () => {
                const grouped = this.getTeamGroupedByPos();
                return grouped.map(g =>
                    '<div class="mb-8">' +
                        '<div class="flex items-center gap-3 mb-4 px-1">' +
                            '<div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/30"><i data-lucide="store" class="w-6 h-6 text-white"></i></div>' +
                            '<div>' +
                                '<div class="font-black text-lg text-slate-900">' + g.pos.name + '</div>' +
                                '<div class="text-sm text-slate-500 font-medium">' + g.users.length + ' membre' + (g.users.length > 1 ? 's' : '') + '</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">' +
                            g.users.map(u => renderUserCard(u)).join('') +
                        '</div>' +
                    '</div>'
                ).join('') || '<div class="text-center py-12 text-slate-400">Aucun membre trouvé</div>';
            };

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <!-- Header avec gradient -->
                    <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                                    <i data-lucide="users" class="w-6 h-6"></i>
                                </div>
                                Gestion de l'Équipe
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">${stats.totalUsers} collaborateurs • ${posList.length} points de vente</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="ManagerModule.showAddUserModal()" class="px-4 py-2.5 ${canManageUsers ? 'bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 shadow-lg shadow-emerald-500/30' : 'bg-slate-400 cursor-not-allowed'} text-white rounded-xl font-black transition flex items-center gap-2" ${!canManageUsers ? 'disabled title="Permission requise"' : ''}>
                                <i data-lucide="user-plus" class="w-4 h-4"></i> Ajouter
                            </button>
                            <button onclick="ManagerModule.showUsersManagementModal()" class="px-4 py-2.5 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-xl font-black hover:from-blue-600 hover:to-indigo-700 transition shadow-lg shadow-blue-500/30 flex items-center gap-2">
                                <i data-lucide="settings" class="w-4 h-4"></i> Gérer
                            </button>
                            <button onclick="ManagerModule.exportTeamList()" class="px-4 py-2.5 bg-white border border-slate-200 text-slate-700 rounded-xl font-black hover:bg-slate-50 transition flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> Export
                            </button>
                            <button onclick="PDGModule.showInviteEmployeeModal()" class="px-4 py-2 bg-purple-600 text-white rounded-xl font-black hover:bg-purple-700 transition flex items-center gap-2">
                                <i data-lucide="mail-plus" class="w-4 h-4"></i> Inviter
                            </button>
                        </div>
                    </div>

                    <!-- Statistiques par rôle avec gradients -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-5 text-white shadow-lg relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-6 -mt-6"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="users" class="w-5 h-5 opacity-70"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-70">Total</span>
                                </div>
                                <div class="text-3xl font-black">${stats.totalUsers}</div>
                                <div class="text-xs opacity-60 mt-1">${stats.totalFiltered} affichés</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-2xl p-5 text-white shadow-lg shadow-cyan-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-6 -mt-6"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="briefcase" class="w-5 h-5 opacity-70"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-70">Gestionnaires</span>
                                </div>
                                <div class="text-3xl font-black">${stats.usersByRole['gestionnaire'] || 0}</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-5 text-white shadow-lg shadow-emerald-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-6 -mt-6"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="shopping-bag" class="w-5 h-5 opacity-70"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-70">Vendeurs</span>
                                </div>
                                <div class="text-3xl font-black">${stats.usersByRole['vendeur'] || 0}</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-5 text-white shadow-lg shadow-amber-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -mr-6 -mt-6"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-2">
                                    <i data-lucide="truck" class="w-5 h-5 opacity-70"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-70">Livreurs</span>
                                </div>
                                <div class="text-3xl font-black">${stats.usersByRole['livreur'] || 0}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Conteneur principal avec filtres -->
                    <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                        <!-- Barre de filtres -->
                        <div class="p-5 border-b border-slate-100 space-y-4">
                            <!-- Ligne 1: Recherche et filtres -->
                            <div class="flex flex-wrap gap-3">
                                <div class="relative flex-1 min-w-[220px]">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-4 top-1/2 -translate-y-1/2"></i>
                                    <input id="manager-team-search-input" type="text" value="${this.state.teamSearch || ''}" onkeyup="ManagerModule.updateTeamSearch(this.value)" placeholder="Rechercher par nom, téléphone, ID..." class="w-full pl-11 pr-4 py-3 rounded-xl border border-slate-200 bg-white font-medium focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" autocomplete="off">
                                </div>
                                <select onchange="ManagerModule.state.teamRole=this.value; ManagerModule.state.teamPage=1; App.rerender()" class="px-4 py-3 rounded-xl border border-slate-200 bg-white font-bold min-w-[150px] focus:ring-2 focus:ring-blue-500">
                                    ${roles.map(r => `<option value="${r.value}" ${r.value===(this.state.teamRole||'all')?'selected':''}>${r.label}</option>`).join('')}
                                </select>
                                <select onchange="ManagerModule.state.teamPosId=this.value; ManagerModule.state.teamPage=1; App.rerender()" class="px-4 py-3 rounded-xl border border-slate-200 bg-white font-bold min-w-[170px] focus:ring-2 focus:ring-blue-500">
                                    <option value="all" ${(this.state.teamPosId||'all') === 'all' ? 'selected' : ''}>Tous les POS</option>
                                    ${posList.map(p => `<option value="${p.id}" ${String(this.state.teamPosId) === String(p.id) ? 'selected' : ''}>${p.name}</option>`).join('')}
                                </select>
                            </div>

                            <!-- Ligne 2: Vue et tri -->
                            <div class="flex flex-wrap items-center justify-between gap-3">
                                <div class="flex items-center gap-3">
                                    <!-- Toggle vue liste/groupée -->
                                    <div class="flex bg-slate-100 rounded-xl p-1">
                                        <button onclick="ManagerModule.state.teamViewMode='list'; App.rerender()" class="px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 ${viewMode === 'list' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                                            <i data-lucide="layout-list" class="w-4 h-4"></i> Liste
                                        </button>
                                        <button onclick="ManagerModule.state.teamViewMode='grouped'; App.rerender()" class="px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 ${viewMode === 'grouped' ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                                            <i data-lucide="layout-grid" class="w-4 h-4"></i> Par POS
                                        </button>
                                    </div>

                                    <!-- Tri -->
                                    <select onchange="ManagerModule.state.teamSortBy=this.value; App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-bold">
                                        ${sortOptions.map(s => `<option value="${s.value}" ${s.value === (this.state.teamSortBy || 'name') ? 'selected' : ''}>Trier: ${s.label}</option>`).join('')}
                                    </select>
                                    <button onclick="ManagerModule.state.teamSortOrder = ManagerModule.state.teamSortOrder === 'asc' ? 'desc' : 'asc'; App.rerender()" class="p-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 transition" title="Inverser l'ordre">
                                        <i data-lucide="${(this.state.teamSortOrder || 'asc') === 'asc' ? 'arrow-up-narrow-wide' : 'arrow-down-wide-narrow'}" class="w-4 h-4 text-slate-600"></i>
                                    </button>
                                </div>

                                <div class="flex items-center gap-3 text-sm">
                                    <span class="text-slate-600 font-bold">${stats.totalFiltered} résultat${stats.totalFiltered > 1 ? 's' : ''}</span>
                                    <span class="text-slate-300">|</span>
                                    <select onchange="ManagerModule.state.teamPerPage=parseInt(this.value); ManagerModule.state.teamPage=1; App.rerender()" class="px-2 py-1.5 rounded-lg border border-slate-200 bg-white text-sm font-bold">
                                        ${perPageOptions.map(n => `<option value="${n}" ${n === (stats.perPage || 20) ? 'selected' : ''}>${n} / page</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Contenu de la liste -->
                        <div class="p-5">
                            ${viewMode === 'grouped' ? renderGroupedView() : `
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    ${users.length === 0 ? '<div class="p-12 text-center text-slate-400 font-medium md:col-span-2 lg:col-span-3"><i data-lucide="users" class="w-12 h-12 mx-auto mb-3 opacity-30"></i><p>Aucun membre trouvé</p></div>' : ''}
                                    ${users.map(u => renderUserCard(u)).join('')}
                                </div>
                                ${renderPagination()}
                            `}
                        </div>
                    </div>
                </div>
            `;
        },

        renderCommandes() {
            const suppliers = CORE.db.suppliers || [];
            const purchaseOrders = CORE.db.purchaseOrders || [];
            const products = CORE.getVisibleProducts() || [];

            const stats = {
                total: purchaseOrders.length,
                pending: purchaseOrders.filter(o => ['pending','confirmed'].includes(o.status)).length,
                received: purchaseOrders.filter(o => o.status === 'received').length,
                totalCost: purchaseOrders.reduce((a,o) => a + (o.totalCost||0), 0)
            };

            let html = '<div class="max-w-7xl mx-auto space-y-6 fade-in"><h2 class="text-3xl font-black text-slate-900">📦 Gestion des Commandes de Réapprovisionnement</h2>';
            html += '<button onclick="ManagerModule.showNewPurchaseOrderModal()" class="px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700">+ Nouvelle commande</button>';

            html += '<div class="grid grid-cols-1 md:grid-cols-4 gap-4">';
            html += '<div class="bg-white p-4 rounded-2xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase">Total</div><div class="mt-2 text-2xl font-black">' + stats.total + '</div></div>';
            html += '<div class="bg-white p-4 rounded-2xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase">En attente</div><div class="mt-2 text-2xl font-black text-amber-600">' + stats.pending + '</div></div>';
            html += '<div class="bg-white p-4 rounded-2xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase">Livrées</div><div class="mt-2 text-2xl font-black text-emerald-600">' + stats.received + '</div></div>';
            html += '<div class="bg-white p-4 rounded-2xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase">Total dépensé</div><div class="mt-2 text-2xl font-black">' + CORE.formatPrice(stats.totalCost) + '</div></div>';
            html += '</div>';

            html += '<div class="bg-white border border-slate-200 rounded-3xl overflow-hidden"><table class="w-full"><thead class="bg-slate-100"><tr><th class="px-4 py-3 text-left font-black">Ref</th><th class="px-4 py-3 text-left font-black">Fournisseur</th><th class="px-4 py-3 text-left font-black">Produit</th><th class="px-4 py-3 text-left font-black">Montant</th><th class="px-4 py-3 text-left font-black">Statut</th><th class="px-4 py-3 text-left font-black">Date</th><th class="px-4 py-3 text-left font-black">Actions</th></tr></thead><tbody>';

            const recent = purchaseOrders.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 20);
            recent.forEach(o => {
                const supplier = suppliers.find(s => s.id === o.supplierId);
                const product = products.find(p => p.id === o.productId);
                html += '<tr class="border-t border-slate-200 hover:bg-slate-50"><td class="px-4 py-3 font-bold">' + (o.reference || o.id) + '</td>';
                html += '<td class="px-4 py-3 font-bold">' + (supplier?.name || '—') + '</td>';
                html += '<td class="px-4 py-3">' + (product?.name || '—') + ' (×' + o.qty + ')</td>';
                html += '<td class="px-4 py-3 font-black">' + CORE.formatPrice(o.totalCost || 0) + '</td>';
                html += '<td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-bold ' + (o.status === 'received' ? 'bg-emerald-100 text-emerald-700' : o.status === 'confirmed' ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700') + '">' + (o.status === 'pending' ? 'Attente' : o.status === 'confirmed' ? 'Confirmée' : 'Livrée') + '</span></td>';
                html += '<td class="px-4 py-3 text-xs text-slate-500">' + CORE.formatDate(o.createdAt) + '</td>';
                html += '<td class="px-4 py-3"><button onclick="ManagerModule.validatePurchaseOrderArrival(' + o.id + ')" class="' + (o.status === 'received' ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-emerald-500 text-white hover:bg-emerald-600') + ' px-3 py-1 rounded text-xs font-bold">' + (o.status === 'received' ? '✓ Reçu' : 'Valider arrivée') + '</button></td></tr>';
            });

            html += '</tbody></table></div></div>';
            return html;
        },

        showNewPurchaseOrderModal(savedData = null) {
            const suppliers = CORE.db.suppliers || [];
            const products = CORE.getVisibleProducts() || [];

            const supplierOptions = suppliers.map(s => ({value: s.id, label: s.name}));
            const productOptions = products.map(p => ({value: p.id, label: p.name + ' (Stock: ' + (p.stock||0) + ')'}));
            const transportModes = [{value: 'routier', label: 'Routier'}, {value: 'aerien', label: 'Aérien'}, {value: 'maritime', label: 'Maritime'}, {value: 'ferroviaire', label: 'Ferroviaire'}];

            // Utiliser les données sauvegardées si présentes
            const d = savedData || {};

            UI.modal('Nouvelle commande de réapprovisionnement', `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <!-- Fournisseur/Usine avec bouton + Nouveau -->
                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">Fournisseur/Usine *</label>
                        <div class="flex gap-2">
                            <select id="po_supplier" class="flex-1 px-4 py-2.5 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-emerald-500">
                                <option value="">-- Sélectionner --</option>
                                ${supplierOptions.map(s => '<option value="' + s.value + '"' + (String(s.value) === String(d.supplierId || '') ? ' selected' : '') + '>' + s.label + '</option>').join('')}
                            </select>
                            <button onclick="ManagerModule.showNewSupplierForPO()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition whitespace-nowrap">+ Nouveau</button>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">Produit existant</label>
                        <select id="po_product" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                            <option value="">-- Sélectionner un produit --</option>
                            ${productOptions.map(p => '<option value="' + p.value + '"' + (String(p.value) === String(d.productId || '') ? ' selected' : '') + '>' + p.label + '</option>').join('')}
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">OU Créer un nouveau produit</label>
                        <input type="text" id="po_newProductName" value="${d.newProductName || ''}" placeholder="Nom du produit" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white">
                        <input type="text" id="po_newProductCode" value="${d.newProductCode || ''}" placeholder="Code produit" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white">
                        <textarea id="po_newProductDesc" placeholder="Description du produit" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white" rows="2">${d.newProductDesc || ''}</textarea>
                    </div>

                    ${UI.input('po_qty', 'Quantité', 'number', d.qty || '10', 'ex: 50', true)}
                    ${UI.input('po_kilos', 'Kilos', 'number', d.kilos || '0', 'ex: 100', false)}
                    ${UI.input('po_cbm', 'CBM (m³)', 'number', d.cbm || '0', 'ex: 2.5', false)}
                    ${UI.input('po_unitPrice', 'Prix unitaire', 'number', d.unitPrice || '0', 'ex: 1500', true)}
                    ${UI.input('po_transportPrice', 'Prix de transport', 'number', d.transportPrice || '0', 'ex: 5000', false)}
                    ${UI.input('po_totalPrice', 'Total à payer au fournisseur', 'number', d.totalPrice || '0', 'ex: 10500 (optionnel)', false)}
                    ${UI.select('po_transportMode', 'Mode de transport', transportModes, d.transportMode || '')}
                    ${UI.input('po_transportAgency', 'Agence de transport', 'text', d.transportAgency || '', 'ex: DHL, FedEx, UPS', false)}
                    ${UI.input('po_trackingNumber', 'Numéro de suivi du colis', 'text', d.trackingNumber || '', 'ex: TRK123456789', false)}
                    ${UI.input('po_deliveryDate', 'Date de livraison prévue', 'date', d.deliveryDate || '', '', false)}
                    ${UI.input('po_reminderDays', 'Période de rappel (jours avant arrivée)', 'number', d.reminderDays || '3', 'ex: 3, 5, 7', false)}

                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">Image du colis</label>
                        <input type="file" id="po_image" accept="image/*" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">Vidéo</label>
                        <input type="file" id="po_video" accept="video/*" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white">
                    </div>
                    ${UI.textarea('po_note', 'Notes', d.note || 'Ex: Urgent, qualité premium', 300, false)}
                </div>
            `, [
                {label: 'Annuler', onclick: 'UI.closeModal()'},
                {label: 'Créer', onclick: 'ManagerModule.createPurchaseOrder()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700'}
            ]);
        },

        showNewSupplierForPO() {
            // Sauvegarder les données du formulaire
            window._pendingPOFormData = {
                module: 'manager',
                supplierId: UI.val('po_supplier') || '',
                productId: UI.val('po_product') || '',
                newProductName: document.getElementById('po_newProductName')?.value || '',
                newProductCode: document.getElementById('po_newProductCode')?.value || '',
                newProductDesc: document.getElementById('po_newProductDesc')?.value || '',
                qty: UI.val('po_qty') || '10',
                kilos: UI.val('po_kilos') || '0',
                cbm: UI.val('po_cbm') || '0',
                unitPrice: UI.val('po_unitPrice') || '0',
                transportPrice: UI.val('po_transportPrice') || '0',
                totalPrice: UI.val('po_totalPrice') || '0',
                transportMode: UI.val('po_transportMode') || '',
                transportAgency: UI.val('po_transportAgency') || '',
                trackingNumber: UI.val('po_trackingNumber') || '',
                deliveryDate: UI.val('po_deliveryDate') || '',
                reminderDays: UI.val('po_reminderDays') || '3',
                note: UI.val('po_note') || ''
            };

            UI.modal('➕ Nouveau Fournisseur/Usine', `
                <div class="space-y-4">
                    <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-xl text-sm text-emerald-800">
                        Créez un nouveau fournisseur ou usine pour vos commandes de réapprovisionnement
                    </div>
                    ${UI.input('new_supplier_name', 'Nom du fournisseur/usine *', 'text', '', 'ex: Usine Textile Guangzhou', true)}
                    ${UI.input('new_supplier_contact', 'Email de contact', 'email', '', 'ex: contact@fournisseur.com', false)}
                    ${UI.input('new_supplier_phone', 'Téléphone', 'tel', '', 'ex: +86 123 456 7890', false)}
                    ${UI.input('new_supplier_country', 'Pays', 'text', '', 'ex: Chine, Maroc, Turquie', false)}
                    ${UI.input('new_supplier_address', 'Adresse', 'text', '', 'ex: Zone industrielle...', false)}
                    ${UI.textarea('new_supplier_notes', 'Notes', '', 2, false)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'ManagerModule.restorePOModal()' },
                { label: 'Créer le fournisseur', onclick: 'ManagerModule.saveNewSupplierForPO()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        saveNewSupplierForPO() {
            const name = UI.val('new_supplier_name')?.trim();
            if (!name) return UI.toast('Le nom du fournisseur est requis', 'warning');

            // Vérifier si existe déjà
            const exists = (CORE.db.suppliers || []).some(s => s.name.toLowerCase() === name.toLowerCase());
            if (exists) return UI.toast('Ce fournisseur existe déjà', 'warning');

            const newSupplier = CORE.create('suppliers', {
                name: name,
                email: UI.val('new_supplier_contact')?.trim() || '',
                phone: UI.val('new_supplier_phone')?.trim() || '',
                country: UI.val('new_supplier_country')?.trim() || '',
                address: UI.val('new_supplier_address')?.trim() || '',
                notes: UI.val('new_supplier_notes')?.trim() || '',
                active: true,
                createdAt: new Date().toISOString()
            });

            UI.toast(`✅ Fournisseur "${name}" créé!`, 'success');

            // Restaurer le modal avec le nouveau fournisseur sélectionné
            const savedData = window._pendingPOFormData || {};
            savedData.supplierId = newSupplier.id;
            window._pendingPOFormData = null;

            this.showNewPurchaseOrderModal(savedData);
        },

        restorePOModal() {
            const savedData = window._pendingPOFormData || {};
            window._pendingPOFormData = null;

            if (savedData.module === 'pdg') {
                PDGModule.showNewPurchaseOrderModal(savedData);
            } else {
                this.showNewPurchaseOrderModal(savedData);
            }
        },

        createPurchaseOrder() {
            const supplierId = UI.val('po_supplier');
            let productId = UI.val('po_product');
            const newProductName = document.getElementById('po_newProductName')?.value || '';
            const newProductCode = document.getElementById('po_newProductCode')?.value || '';
            const newProductDesc = document.getElementById('po_newProductDesc')?.value || '';
            const qty = parseInt(UI.val('po_qty')) || 0;
            const kilos = parseFloat(UI.val('po_kilos')) || 0;
            const cbm = parseFloat(UI.val('po_cbm')) || 0;
            const unitPrice = parseFloat(UI.val('po_unitPrice')) || 0;
            const transportPrice = parseFloat(UI.val('po_transportPrice')) || 0;
            const customTotalPrice = parseFloat(UI.val('po_totalPrice')) || 0;
            const reminderDays = parseInt(UI.val('po_reminderDays')) || 0;

            if (!supplierId) return UI.toast('Fournisseur requis', 'error');
            if (!productId && !newProductName) return UI.toast('Sélectionnez un produit ou créez un nouveau', 'error');
            if (qty <= 0) return UI.toast('Quantité invalide', 'error');

            // Créer le nouveau produit si nécessaire
            if (newProductName && !productId) {
                const newProduct = CORE.create('products', {
                    name: newProductName,
                    code: newProductCode || 'PROD-' + Utils.uid().substring(0,6),
                    description: newProductDesc,
                    stock: qty,
                    price: unitPrice,
                    active: true,
                    createdAt: new Date().toISOString()
                });
                productId = newProduct.id;
            }

            // Calculer le total : utiliser customTotalPrice si fourni, sinon calculer automatiquement
            const totalCost = customTotalPrice > 0 ? customTotalPrice : (qty * unitPrice) + transportPrice;

            const imageFile = document.getElementById('po_image')?.files?.[0];
            const videoFile = document.getElementById('po_video')?.files?.[0];
            let imageBase64 = null;
            let videoBase64 = null;

            const createOrder = () => {
                const reference = 'PO-' + Utils.uid('PO').substring(0,6);
                const po = CORE.create('purchaseOrders', {
                    reference,
                    supplierId: parseInt(supplierId),
                    productId: parseInt(productId),
                    qty,
                    kilos,
                    cbm,
                    unitPrice,
                    transportPrice,
                    transportMode: UI.val('po_transportMode') || null,
                    transportAgency: UI.val('po_transportAgency') || null,
                    totalCost,
                    status: 'pending',
                    trackingNumber: UI.val('po_trackingNumber') || null,
                    deliveryDate: UI.val('po_deliveryDate') || null,
                    reminderDays,
                    image: imageBase64,
                    video: videoBase64,
                    note: UI.val('po_note') || '',
                    createdAt: new Date().toISOString()
                });

                // Enregistrer la dépense automatiquement
                const supplier = CORE.db.suppliers?.find(s => s.id === parseInt(supplierId));
                const product = CORE.getVisibleProducts().find(p => p.id === parseInt(productId));
                CORE.create('expenses', {
                    reference: reference,
                    type: 'purchase_order',
                    description: `Commande ${reference} - ${product?.name || 'Produit'} chez ${supplier?.name || 'Fournisseur'}`,
                    amount: totalCost,
                    supplier: supplier?.name || 'Non spécifié',
                    category: 'réapprovisionnement',
                    status: 'pending',
                    purchaseOrderId: po.id,
                    createdAt: new Date().toISOString()
                });

                UI.closeModal();
                UI.toast('Commande créée: ' + reference, 'success');
                CORE.notify('success', `Nouvelle commande créée: ${reference} chez ${supplier?.name || 'Fournisseur'} - ${CORE.formatPrice(totalCost)}`, { purchaseOrderId: po.id });
                App.rerender();
            };

            let pendingFiles = 0;
            if (imageFile) pendingFiles++;
            if (videoFile) pendingFiles++;

            if (pendingFiles === 0) {
                createOrder();
                return;
            }

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageBase64 = e.target.result;
                    pendingFiles--;
                    if (pendingFiles === 0) createOrder();
                };
                reader.readAsDataURL(imageFile);
            }

            if (videoFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    videoBase64 = e.target.result;
                    pendingFiles--;
                    if (pendingFiles === 0) createOrder();
                };
                reader.readAsDataURL(videoFile);
            }
        },

        renderToolbox() {
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const posId = CORE.state.currentUser?.pos;

            // === DONNÉES EN TEMPS RÉEL ===
            const todayOrders = CORE.getVisibleOrders().filter(o => {
                const d = new Date(o.createdAt);
                return o.posId === posId && d >= startOfDay;
            });
            const pendingOrders = todayOrders.filter(o => ['pending', 'confirmed'].includes(o.status));
            const todayRevenue = todayOrders.filter(o => o.status === 'completed').reduce((s, o) => s + (o.totalAmount || 0), 0);

            const allDeliveries = CORE.getVisibleDeliveries() || [];
            const pendingDeliveries = allDeliveries.filter(d => d.status === 'pending');
            const inProgressDeliveries = allDeliveries.filter(d => ['assigned', 'en_route', 'picked_up'].includes(d.status));
            const lateDeliveries = allDeliveries.filter(d => {
                if (!['assigned', 'en_route'].includes(d.status)) return false;
                const assigned = new Date(d.assignedAt || d.createdAt);
                return (now - assigned) > 45 * 60 * 1000; // > 45 min
            });

            const livreurs = CORE.getVisibleUsers().filter(u => u.active && u.role === 'livreur');
            const vendeurs = CORE.getVisibleUsers().filter(u => u.active && u.role === 'vendeur');
            const busyLivreurs = livreurs.filter(l => inProgressDeliveries.some(d => d.livreurId === l.id));
            const freeLivreurs = livreurs.filter(l => !inProgressDeliveries.some(d => d.livreurId === l.id));

            const lowStockProducts = CORE.getVisibleProducts().filter(p => {
                const posStock = (p.stockByPos || {})[posId] || p.stock || 0;
                return posStock <= (p.minStock || 5) && posStock > 0;
            });
            const outOfStock = CORE.getVisibleProducts().filter(p => {
                const posStock = (p.stockByPos || {})[posId] || p.stock || 0;
                return posStock <= 0;
            });

            const openIncidents = (CORE.db.incidents || []).filter(i => !i.resolved && i.posId === posId);
            const urgentIncidents = openIncidents.filter(i => i.priority === 'high' || i.priority === 'critical');

            const pendingTransfersReceipts = (CORE.db.transferReceipts || []).filter(t => t.status === 'pending' && String(t.toPosId) === String(posId));
            const pendingTransfersStock = (CORE.db.stockTransfers || []).filter(t => t.status === 'pending' && (String(t.destPosId) === String(posId) || String(t.sourcePosId) === String(posId)));
            const pendingTransfersTotal = pendingTransfersReceipts.length + pendingTransfersStock.length;

            // === ALERTES PRIORITAIRES ===
            const alerts = [];
            if (lateDeliveries.length > 0) alerts.push({ type: 'critical', icon: '🚨', text: `${lateDeliveries.length} livraison(s) en retard (>45min)`, action: 'ManagerModule.showLateDeliveriesModal()' });
            if (urgentIncidents.length > 0) alerts.push({ type: 'critical', icon: '⚠️', text: `${urgentIncidents.length} incident(s) urgent(s) non résolu(s)`, action: 'ManagerModule.showUrgentIncidentsModal()' });
            if (outOfStock.length > 0) alerts.push({ type: 'warning', icon: '📦', text: `${outOfStock.length} produit(s) en rupture de stock`, action: 'ManagerModule.showOutOfStockModal()' });
            if (pendingDeliveries.length > 5) alerts.push({ type: 'warning', icon: '⏳', text: `${pendingDeliveries.length} livraisons en attente d'assignation`, action: 'ManagerModule.showQuickAssignModal()' });
            if (freeLivreurs.length === 0 && pendingDeliveries.length > 0) alerts.push({ type: 'warning', icon: '👷', text: 'Tous les livreurs sont occupés!', action: null });
            if (pendingTransfersTotal > 0) alerts.push({ type: 'info', icon: '📥', text: `${pendingTransfersTotal} transfert(s) de stock en attente`, action: 'ManagerModule.showPendingTransfersModal()' });

            // === TÂCHES DU JOUR ===
            const tasks = this.getDailyTasks();

            // === PERFORMANCE LIVREURS ===
            const livreurPerf = livreurs.map(l => {
                const hisDeliveries = allDeliveries.filter(d => d.livreurId === l.id);
                const todayDel = hisDeliveries.filter(d => new Date(d.completedAt || d.createdAt) >= startOfDay);
                const completed = todayDel.filter(d => d.status === 'livree').length;
                const failed = todayDel.filter(d => ['failed', 'returned'].includes(d.status)).length;
                const inProgress = inProgressDeliveries.filter(d => d.livreurId === l.id).length;
                const avgTime = this.calculateAvgDeliveryTime(l.id);
                return { ...l, completed, failed, inProgress, avgTime, score: completed * 10 - failed * 5 };
            }).sort((a, b) => b.score - a.score);

            // === SUGGESTIONS INTELLIGENTES ===
            const suggestions = this.generateSmartSuggestions({ pendingDeliveries, freeLivreurs, lowStockProducts, lateDeliveries, todayOrders, livreurPerf });

            return `
                <div class="max-w-7xl mx-auto space-y-6 fade-in p-6">
                    <!-- Header -->
                    <header class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">🎯 Centre de Commande</h2>
                            <p class="text-slate-500 font-medium">Pilotez votre journée efficacement • ${now.toLocaleDateString('fr-FR')} ${now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}</p>
                        </div>
                        <button onclick="App.rerender()" class="px-4 py-2 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition flex items-center gap-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i> Actualiser
                        </button>
                    </header>

                    <!-- KPIs temps réel -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-4 text-white">
                            <div class="text-blue-200 text-xs font-bold">Commandes</div>
                            <div class="text-3xl font-black">${todayOrders.length}</div>
                            <div class="text-xs text-blue-200">${pendingOrders.length} en attente</div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-4 text-white">
                            <div class="text-emerald-200 text-xs font-bold">Revenu jour</div>
                            <div class="text-2xl font-black">${CORE.formatPrice(todayRevenue)}</div>
                            <div class="text-xs text-emerald-200">confirmé</div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl p-4 text-white">
                            <div class="text-amber-200 text-xs font-bold">Livraisons</div>
                            <div class="text-3xl font-black">${inProgressDeliveries.length}</div>
                            <div class="text-xs text-amber-200">${pendingDeliveries.length} à assigner</div>
                        </div>
                        <div class="bg-gradient-to-br from-violet-500 to-purple-600 rounded-2xl p-4 text-white">
                            <div class="text-violet-200 text-xs font-bold">Livreurs</div>
                            <div class="text-3xl font-black">${freeLivreurs.length}/${livreurs.length}</div>
                            <div class="text-xs text-violet-200">disponibles</div>
                        </div>
                        <div class="bg-gradient-to-br ${lowStockProducts.length > 5 ? 'from-red-500 to-red-600' : 'from-slate-500 to-slate-600'} rounded-2xl p-4 text-white">
                            <div class="text-slate-200 text-xs font-bold">Stock faible</div>
                            <div class="text-3xl font-black">${lowStockProducts.length}</div>
                            <div class="text-xs text-slate-200">${outOfStock.length} ruptures</div>
                        </div>
                        <div class="bg-gradient-to-br ${openIncidents.length > 0 ? 'from-rose-500 to-pink-600' : 'from-teal-500 to-teal-600'} rounded-2xl p-4 text-white">
                            <div class="text-rose-200 text-xs font-bold">Incidents</div>
                            <div class="text-3xl font-black">${openIncidents.length}</div>
                            <div class="text-xs text-rose-200">${urgentIncidents.length} urgents</div>
                        </div>
                    </div>

                    ${alerts.length > 0 ? `
                    <!-- Alertes prioritaires -->
                    <div class="bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-200 rounded-2xl p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center animate-pulse">
                                <i data-lucide="alert-triangle" class="w-4 h-4 text-white"></i>
                            </div>
                            <h3 class="font-black text-red-900">🚨 Alertes prioritaires (${alerts.length})</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            ${alerts.map(a => `
                                <div class="flex items-center justify-between p-3 ${a.type === 'critical' ? 'bg-red-100 border-red-300' : a.type === 'warning' ? 'bg-amber-100 border-amber-300' : 'bg-blue-100 border-blue-300'} border rounded-xl">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xl">${a.icon}</span>
                                        <span class="font-bold text-sm ${a.type === 'critical' ? 'text-red-800' : a.type === 'warning' ? 'text-amber-800' : 'text-blue-800'}">${a.text}</span>
                                    </div>
                                    ${a.action ? `<button onclick="${a.action}" class="px-3 py-1 ${a.type === 'critical' ? 'bg-red-600' : a.type === 'warning' ? 'bg-amber-600' : 'bg-blue-600'} text-white text-xs font-black rounded-lg">Traiter</button>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : `
                    <div class="bg-gradient-to-r from-emerald-50 to-teal-50 border-2 border-emerald-200 rounded-2xl p-4 flex items-center gap-3">
                        <div class="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center">
                            <i data-lucide="check-circle" class="w-5 h-5 text-white"></i>
                        </div>
                        <div>
                            <div class="font-black text-emerald-900">✨ Tout va bien!</div>
                            <div class="text-sm text-emerald-700">Aucune alerte prioritaire pour le moment</div>
                        </div>
                    </div>
                    `}

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Colonne 1: Tâches du jour -->
                        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-4 bg-gradient-to-r from-indigo-500 to-purple-600 text-white">
                                <div class="flex items-center justify-between">
                                    <div class="font-black">📋 Tâches du jour</div>
                                    <div class="text-xs bg-white/20 px-2 py-1 rounded-lg">${tasks.filter(t => t.done).length}/${tasks.length}</div>
                                </div>
                            </div>
                            <div class="p-4 space-y-2 max-h-80 overflow-y-auto">
                                ${tasks.map((task, i) => `
                                    <div class="flex items-center gap-3 p-3 ${task.done ? 'bg-emerald-50 border-emerald-200' : 'bg-slate-50 border-slate-200'} border rounded-xl cursor-pointer hover:shadow-sm transition" onclick="ManagerModule.toggleTask(${i})">
                                        <div class="w-6 h-6 rounded-full ${task.done ? 'bg-emerald-500' : 'border-2 border-slate-300'} flex items-center justify-center">
                                            ${task.done ? '<i data-lucide="check" class="w-4 h-4 text-white"></i>' : ''}
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-bold text-sm ${task.done ? 'text-emerald-700 line-through' : 'text-slate-900'}">${task.text}</div>
                                            ${task.hint ? `<div class="text-xs text-slate-500">${task.hint}</div>` : ''}
                                        </div>
                                        ${task.action ? `<button onclick="event.stopPropagation(); ${task.action}" class="px-2 py-1 bg-indigo-600 text-white text-xs font-bold rounded-lg">Go</button>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            <div class="p-3 border-t border-slate-100">
                                <button onclick="ManagerModule.addCustomTask()" class="w-full py-2 border-2 border-dashed border-slate-300 text-slate-500 font-bold rounded-xl hover:border-indigo-400 hover:text-indigo-600 transition">
                                    + Ajouter une tâche
                                </button>
                            </div>
                        </div>

                        <!-- Colonne 2: Performance équipe -->
                        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-4 bg-gradient-to-r from-emerald-500 to-teal-600 text-white">
                                <div class="flex items-center justify-between">
                                    <div class="font-black">🏆 Performance livreurs</div>
                                    <div class="text-xs bg-white/20 px-2 py-1 rounded-lg">Aujourd'hui</div>
                                </div>
                            </div>
                            <div class="p-4 space-y-2 max-h-80 overflow-y-auto">
                                ${livreurPerf.length === 0 ? `
                                    <div class="text-center py-6 text-slate-400">
                                        <i data-lucide="users" class="w-10 h-10 mx-auto mb-2 opacity-50"></i>
                                        <div class="text-sm">Aucun livreur actif</div>
                                    </div>
                                ` : livreurPerf.map((l, i) => `
                                    <div class="flex items-center gap-3 p-3 ${l.inProgress > 0 ? 'bg-amber-50 border-amber-200' : 'bg-slate-50 border-slate-200'} border rounded-xl">
                                        <div class="w-8 h-8 rounded-full ${i === 0 ? 'bg-yellow-400' : i === 1 ? 'bg-slate-300' : i === 2 ? 'bg-amber-600' : 'bg-slate-200'} flex items-center justify-center font-black text-sm ${i < 3 ? 'text-white' : 'text-slate-600'}">
                                            ${i < 3 ? ['🥇','🥈','🥉'][i] : i + 1}
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="font-bold text-sm text-slate-900 truncate">${l.name}</div>
                                            <div class="text-xs text-slate-500">${l.inProgress > 0 ? `🚴 ${l.inProgress} en cours` : '✅ Disponible'}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-emerald-600">${l.completed}</div>
                                            <div class="text-[10px] text-slate-400">livrées</div>
                                        </div>
                                        ${l.failed > 0 ? `<div class="text-right"><div class="font-black text-red-500">${l.failed}</div><div class="text-[10px] text-slate-400">échecs</div></div>` : ''}
                                        ${l.avgTime ? `<div class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-lg">${l.avgTime}min</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Colonne 3: Suggestions intelligentes -->
                        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="p-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white">
                                <div class="flex items-center justify-between">
                                    <div class="font-black">💡 Suggestions IA</div>
                                    <div class="text-xs bg-white/20 px-2 py-1 rounded-lg">${suggestions.length} actions</div>
                                </div>
                            </div>
                            <div class="p-4 space-y-2 max-h-80 overflow-y-auto">
                                ${suggestions.length === 0 ? `
                                    <div class="text-center py-6 text-slate-400">
                                        <div class="text-4xl mb-2">🎉</div>
                                        <div class="text-sm">Tout est optimal!</div>
                                    </div>
                                ` : suggestions.map(s => `
                                    <div class="p-3 ${s.priority === 'high' ? 'bg-red-50 border-red-200' : s.priority === 'medium' ? 'bg-amber-50 border-amber-200' : 'bg-blue-50 border-blue-200'} border rounded-xl">
                                        <div class="flex items-start gap-2">
                                            <span class="text-lg">${s.icon}</span>
                                            <div class="flex-1">
                                                <div class="font-bold text-sm text-slate-900">${s.title}</div>
                                                <div class="text-xs text-slate-600 mt-1">${s.description}</div>
                                                ${s.action ? `<button onclick="${s.action}" class="mt-2 px-3 py-1 bg-slate-900 text-white text-xs font-bold rounded-lg hover:bg-slate-800">${s.actionLabel || 'Appliquer'}</button>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Actions rapides -->
                    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4">
                        <h3 class="font-black text-slate-900 mb-4">⚡ Actions rapides</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                            <button onclick="ManagerModule.showQuickAssignModal()" class="p-4 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-xl transition text-center group">
                                <div class="w-10 h-10 bg-blue-500 rounded-xl mx-auto mb-2 flex items-center justify-center group-hover:scale-110 transition">
                                    <i data-lucide="user-plus" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="font-bold text-sm text-slate-900">Assigner</div>
                                <div class="text-xs text-blue-600">${pendingDeliveries.length} en attente</div>
                            </button>
                            <button onclick="ManagerModule.showQuickRecallModal()" class="p-4 bg-amber-50 hover:bg-amber-100 border border-amber-200 rounded-xl transition text-center group">
                                <div class="w-10 h-10 bg-amber-500 rounded-xl mx-auto mb-2 flex items-center justify-center group-hover:scale-110 transition">
                                    <i data-lucide="rotate-ccw" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="font-bold text-sm text-slate-900">Rappeler</div>
                                <div class="text-xs text-amber-600">${inProgressDeliveries.length} en cours</div>
                            </button>
                            <button onclick="ManagerModule.showLowStockModal()" class="p-4 bg-red-50 hover:bg-red-100 border border-red-200 rounded-xl transition text-center group">
                                <div class="w-10 h-10 bg-red-500 rounded-xl mx-auto mb-2 flex items-center justify-center group-hover:scale-110 transition">
                                    <i data-lucide="package-x" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="font-bold text-sm text-slate-900">Stock</div>
                                <div class="text-xs text-red-600">${lowStockProducts.length + outOfStock.length} alertes</div>
                            </button>
                            <button onclick="ManagerModule.showTeamStatusModal()" class="p-4 bg-purple-50 hover:bg-purple-100 border border-purple-200 rounded-xl transition text-center group">
                                <div class="w-10 h-10 bg-purple-500 rounded-xl mx-auto mb-2 flex items-center justify-center group-hover:scale-110 transition">
                                    <i data-lucide="users" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="font-bold text-sm text-slate-900">Équipe</div>
                                <div class="text-xs text-purple-600">${livreurs.length + vendeurs.length} actifs</div>
                            </button>
                            <button onclick="ManagerModule.showDailySummaryModal()" class="p-4 bg-teal-50 hover:bg-teal-100 border border-teal-200 rounded-xl transition text-center group">
                                <div class="w-10 h-10 bg-teal-500 rounded-xl mx-auto mb-2 flex items-center justify-center group-hover:scale-110 transition">
                                    <i data-lucide="bar-chart-3" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="font-bold text-sm text-slate-900">Bilan</div>
                                <div class="text-xs text-teal-600">Résumé jour</div>
                            </button>
                            <button onclick="ManagerModule.showQuickContactModal()" class="p-4 bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 rounded-xl transition text-center group">
                                <div class="w-10 h-10 bg-emerald-500 rounded-xl mx-auto mb-2 flex items-center justify-center group-hover:scale-110 transition">
                                    <i data-lucide="phone" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="font-bold text-sm text-slate-900">Contacter</div>
                                <div class="text-xs text-emerald-600">Appel rapide</div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        },

        // === FONCTIONS UTILITAIRES CENTRE DE COMMANDE ===
        getDailyTasks() {
            const stored = localStorage.getItem('manager_daily_tasks_' + new Date().toDateString());
            let tasks = stored ? JSON.parse(stored) : null;

            if (!tasks) {
                const posId = CORE.state.currentUser?.pos;
                const pendingDeliveries = CORE.getVisibleDeliveries().filter(d => d.status === 'pending').length;
                const lowStock = CORE.getVisibleProducts().filter(p => ((p.stockByPos || {})[posId] || p.stock || 0) <= (p.minStock || 5)).length;

                tasks = [
                    { text: 'Vérifier les commandes en attente', hint: `${pendingDeliveries} livraisons à assigner`, done: false, action: "ManagerModule.showQuickAssignModal()" },
                    { text: 'Contrôler les stocks bas', hint: `${lowStock} produits en alerte`, done: false, action: "ManagerModule.showLowStockModal()" },
                    { text: 'Vérifier la disponibilité livreurs', hint: 'Qui est disponible?', done: false, action: "ManagerModule.showTeamStatusModal()" },
                    { text: 'Répondre aux incidents ouverts', done: false },
                    { text: 'Faire le point équipe (10h)', done: false },
                    { text: 'Vérifier caisse/paiements', done: false, action: "ManagerModule.setCurrentView('payments')" },
                    { text: 'Bilan mi-journée (14h)', done: false, action: "ManagerModule.showDailySummaryModal()" },
                    { text: 'Clôture journée', done: false }
                ];
            }
            return tasks;
        },

        toggleTask(index) {
            const tasks = this.getDailyTasks();
            if (tasks[index]) {
                tasks[index].done = !tasks[index].done;
                localStorage.setItem('manager_daily_tasks_' + new Date().toDateString(), JSON.stringify(tasks));
                App.rerender();
            }
        },

        addCustomTask() {
            UI.modal('➕ Ajouter une tâche', `
                <input id="custom_task" type="text" placeholder="Description de la tâche..." class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium">
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Ajouter', onclick: 'ManagerModule.saveCustomTask()', class: 'bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-black hover:bg-indigo-700' }
            ]);
        },

        saveCustomTask() {
            const text = UI.val('custom_task');
            if (!text) return UI.toast('Entrez une tâche', 'warning');

            const tasks = this.getDailyTasks();
            tasks.push({ text, done: false, custom: true });
            localStorage.setItem('manager_daily_tasks_' + new Date().toDateString(), JSON.stringify(tasks));
            UI.closeModal();
            UI.toast('Tâche ajoutée', 'success');
            App.rerender();
        },

        calculateAvgDeliveryTime(livreurId) {
            const completed = CORE.getVisibleDeliveries().filter(d =>
                d.livreurId === livreurId &&
                d.status === 'livree' &&
                d.assignedAt &&
                d.completedAt
            ).slice(-10);

            if (completed.length === 0) return null;

            const avgMs = completed.reduce((sum, d) => {
                return sum + (new Date(d.completedAt) - new Date(d.assignedAt));
            }, 0) / completed.length;

            return Math.round(avgMs / 60000);
        },

        generateSmartSuggestions({ pendingDeliveries, freeLivreurs, lowStockProducts, lateDeliveries, todayOrders, livreurPerf }) {
            const suggestions = [];

            // Suggestion: Assigner les livraisons en attente aux livreurs libres
            if (pendingDeliveries.length > 0 && freeLivreurs.length > 0) {
                const bestLivreur = livreurPerf.find(l => !l.inProgress);
                suggestions.push({
                    icon: '🎯',
                    title: 'Optimiser les assignations',
                    description: `${pendingDeliveries.length} livraison(s) peuvent être assignées à ${freeLivreurs.length} livreur(s) disponible(s). ${bestLivreur ? `Recommandé: ${bestLivreur.name}` : ''}`,
                    priority: 'high',
                    action: 'ManagerModule.showQuickAssignModal()',
                    actionLabel: 'Assigner'
                });
            }

            // Suggestion: Réassigner les livraisons en retard
            if (lateDeliveries.length > 0) {
                suggestions.push({
                    icon: '⚡',
                    title: 'Réassigner livraisons en retard',
                    description: `${lateDeliveries.length} livraison(s) sont en retard. Envisagez de les réassigner à un livreur plus proche.`,
                    priority: 'high',
                    action: 'ManagerModule.showLateDeliveriesModal()',
                    actionLabel: 'Voir'
                });
            }

            // Suggestion: Réapprovisionner le stock
            if (lowStockProducts.length > 3) {
                suggestions.push({
                    icon: '📦',
                    title: 'Commander du stock',
                    description: `${lowStockProducts.length} produits sont en stock faible. Passez une commande fournisseur.`,
                    priority: 'medium',
                    action: 'ManagerModule.showLowStockModal()',
                    actionLabel: 'Voir produits'
                });
            }

            // Suggestion: Heure de pointe
            const hour = new Date().getHours();
            if (hour >= 11 && hour <= 13 && pendingDeliveries.length > 3) {
                suggestions.push({
                    icon: '🔥',
                    title: 'Rush du midi détecté!',
                    description: 'Période de forte activité. Assurez-vous que tous les livreurs sont mobilisés.',
                    priority: 'medium'
                });
            }

            // Suggestion: Performance livreur
            const underperformer = livreurPerf.find(l => l.failed > 2);
            if (underperformer) {
                suggestions.push({
                    icon: '👤',
                    title: `Vérifier ${underperformer.name}`,
                    description: `${underperformer.failed} échecs aujourd'hui. Un suivi pourrait être nécessaire.`,
                    priority: 'low'
                });
            }

            // Suggestion: Bonne performance
            if (todayOrders.length > 20 && livreurPerf.every(l => l.failed === 0)) {
                suggestions.push({
                    icon: '🌟',
                    title: 'Excellente journée!',
                    description: `${todayOrders.length} commandes traitées sans échec. Félicitez votre équipe!`,
                    priority: 'low'
                });
            }

            return suggestions;
        },

        showLateDeliveriesModal() {
            const now = new Date();
            const lateDeliveries = CORE.getVisibleDeliveries().filter(d => {
                if (!['assigned', 'en_route'].includes(d.status)) return false;
                const assigned = new Date(d.assignedAt || d.createdAt);
                return (now - assigned) > 45 * 60 * 1000;
            });

            UI.modal('🚨 Livraisons en retard', `
                <div class="space-y-3 max-h-96 overflow-y-auto">
                    ${lateDeliveries.map(d => {
                        const delay = Math.round((now - new Date(d.assignedAt || d.createdAt)) / 60000);
                        return `
                        <div class="p-4 bg-red-50 border border-red-200 rounded-xl">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-black text-red-900">${d.orderRef}</div>
                                    <div class="text-sm text-red-700">Livreur: ${d.livreurName || 'N/A'}</div>
                                    <div class="text-sm text-red-600">Client: ${d.customerName || 'N/A'}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-black text-red-600">${delay}min</div>
                                    <div class="text-xs text-red-500">de retard</div>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button onclick="ManagerModule.callUser(${d.livreurId})" class="flex-1 py-2 bg-amber-500 text-white font-bold rounded-lg text-sm">📞 Appeler</button>
                                <button onclick="ManagerModule.reassignDelivery(${d.id})" class="flex-1 py-2 bg-red-600 text-white font-bold rounded-lg text-sm">🔄 Réassigner</button>
                            </div>
                        </div>
                        `;
                    }).join('')}
                    ${lateDeliveries.length === 0 ? '<div class="text-center py-6 text-slate-400">Aucune livraison en retard 🎉</div>' : ''}
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showUrgentIncidentsModal() {
            const posId = CORE.state.currentUser?.pos;
            const urgentIncidents = (CORE.db.incidents || []).filter(i =>
                !i.resolved && i.posId === posId && (i.priority === 'high' || i.priority === 'critical')
            );

            UI.modal('⚠️ Incidents urgents', `
                <div class="space-y-3 max-h-96 overflow-y-auto">
                    ${urgentIncidents.map(i => `
                        <div class="p-4 bg-amber-50 border border-amber-200 rounded-xl">
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-black text-amber-900">${i.title || i.type}</div>
                                <span class="px-2 py-1 ${i.priority === 'critical' ? 'bg-red-500' : 'bg-amber-500'} text-white text-xs font-bold rounded-lg">${i.priority}</span>
                            </div>
                            <div class="text-sm text-amber-700">${i.description || ''}</div>
                            <div class="text-xs text-amber-600 mt-2">Créé: ${new Date(i.createdAt).toLocaleString('fr-FR')}</div>
                        </div>
                    `).join('')}
                    ${urgentIncidents.length === 0 ? '<div class="text-center py-6 text-slate-400">Aucun incident urgent 🎉</div>' : ''}
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showOutOfStockModal() {
            const posId = CORE.state.currentUser?.pos;
            const outOfStock = CORE.getVisibleProducts().filter(p => {
                const posStock = (p.stockByPos || {})[posId] || p.stock || 0;
                return posStock <= 0;
            });

            UI.modal('📦 Ruptures de stock', `
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    ${outOfStock.map(p => `
                        <div class="flex items-center justify-between p-3 bg-red-50 border border-red-200 rounded-xl">
                            <div>
                                <div class="font-bold text-red-900">${p.name}</div>
                                <div class="text-xs text-red-600">${p.category || 'Sans catégorie'}</div>
                            </div>
                            <span class="px-3 py-1 bg-red-600 text-white text-xs font-black rounded-lg">RUPTURE</span>
                        </div>
                    `).join('')}
                    ${outOfStock.length === 0 ? '<div class="text-center py-6 text-slate-400">Aucune rupture de stock 🎉</div>' : ''}
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showLowStockModal() {
            const posId = CORE.state.currentUser?.pos;
            const products = CORE.getVisibleProducts().filter(p => {
                const posStock = (p.stockByPos || {})[posId] || p.stock || 0;
                return posStock <= (p.minStock || 5);
            }).sort((a, b) => {
                const stockA = (a.stockByPos || {})[posId] || a.stock || 0;
                const stockB = (b.stockByPos || {})[posId] || b.stock || 0;
                return stockA - stockB;
            });

            UI.modal('📦 Alertes stock', `
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    ${products.map(p => {
                        const stock = (p.stockByPos || {})[posId] || p.stock || 0;
                        const isOut = stock <= 0;
                        return `
                        <div class="flex items-center justify-between p-3 ${isOut ? 'bg-red-50 border-red-200' : 'bg-amber-50 border-amber-200'} border rounded-xl">
                            <div>
                                <div class="font-bold ${isOut ? 'text-red-900' : 'text-amber-900'}">${p.name}</div>
                                <div class="text-xs ${isOut ? 'text-red-600' : 'text-amber-600'}">${p.category || 'Sans catégorie'}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-black text-lg ${isOut ? 'text-red-600' : 'text-amber-600'}">${stock}</div>
                                <div class="text-xs text-slate-500">min: ${p.minStock || 5}</div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                    ${products.length === 0 ? '<div class="text-center py-6 text-slate-400">Stock optimal! 🎉</div>' : ''}
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showTeamStatusModal() {
            const livreurs = CORE.getVisibleUsers().filter(u => u.active && u.role === 'livreur');
            const vendeurs = CORE.getVisibleUsers().filter(u => u.active && u.role === 'vendeur');
            const inProgress = CORE.getVisibleDeliveries().filter(d => ['assigned', 'en_route', 'picked_up'].includes(d.status));

            UI.modal('👥 Statut équipe', `
                <div class="space-y-4">
                    <div>
                        <div class="text-xs font-black text-slate-600 uppercase mb-2">🚴 Livreurs (${livreurs.length})</div>
                        <div class="space-y-2">
                            ${livreurs.map(l => {
                                const busy = inProgress.filter(d => d.livreurId === l.id);
                                return `
                                <div class="flex items-center justify-between p-3 ${busy.length > 0 ? 'bg-amber-50 border-amber-200' : 'bg-emerald-50 border-emerald-200'} border rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full ${busy.length > 0 ? 'bg-amber-500' : 'bg-emerald-500'} flex items-center justify-center text-white font-bold">
                                            ${l.name.slice(0, 2).toUpperCase()}
                                        </div>
                                        <div>
                                            <div class="font-bold text-slate-900">${l.name}</div>
                                            <div class="text-xs ${busy.length > 0 ? 'text-amber-600' : 'text-emerald-600'}">
                                                ${busy.length > 0 ? `🚴 ${busy.length} livraison(s) en cours` : '✅ Disponible'}
                                            </div>
                                        </div>
                                    </div>
                                    <button onclick="ManagerModule.callUser(${l.id})" class="px-3 py-1 bg-slate-900 text-white text-xs font-bold rounded-lg">📞</button>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    <div>
                        <div class="text-xs font-black text-slate-600 uppercase mb-2">🛒 Vendeurs (${vendeurs.length})</div>
                        <div class="space-y-2">
                            ${vendeurs.map(v => `
                                <div class="flex items-center justify-between p-3 bg-blue-50 border border-blue-200 rounded-xl">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">
                                            ${v.name.slice(0, 2).toUpperCase()}
                                        </div>
                                        <div class="font-bold text-slate-900">${v.name}</div>
                                    </div>
                                    <button onclick="ManagerModule.callUser(${v.id})" class="px-3 py-1 bg-slate-900 text-white text-xs font-bold rounded-lg">📞</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showDailySummaryModal() {
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const posId = CORE.state.currentUser?.pos;

            const todayOrders = CORE.getVisibleOrders().filter(o => {
                const d = new Date(o.createdAt);
                return o.posId === posId && d >= startOfDay;
            });
            const completedOrders = todayOrders.filter(o => o.status === 'completed');
            const revenue = completedOrders.reduce((s, o) => s + (o.totalAmount || 0), 0);

            const todayDeliveries = CORE.getVisibleDeliveries().filter(d => {
                const dt = new Date(d.completedAt || d.createdAt);
                return dt >= startOfDay;
            });
            const delivered = todayDeliveries.filter(d => d.status === 'livree').length;
            const failed = todayDeliveries.filter(d => ['failed', 'returned'].includes(d.status)).length;

            const successRate = todayDeliveries.length > 0 ? Math.round((delivered / todayDeliveries.length) * 100) : 0;

            UI.modal('📊 Bilan de la journée', `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl text-center">
                            <div class="text-3xl font-black text-blue-600">${todayOrders.length}</div>
                            <div class="text-xs text-blue-700 font-bold">Commandes</div>
                        </div>
                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl text-center">
                            <div class="text-2xl font-black text-emerald-600">${CORE.formatPrice(revenue)}</div>
                            <div class="text-xs text-emerald-700 font-bold">Revenu</div>
                        </div>
                        <div class="p-4 bg-teal-50 border border-teal-200 rounded-xl text-center">
                            <div class="text-3xl font-black text-teal-600">${delivered}</div>
                            <div class="text-xs text-teal-700 font-bold">Livrées</div>
                        </div>
                        <div class="p-4 ${failed > 0 ? 'bg-red-50 border-red-200' : 'bg-slate-50 border-slate-200'} border rounded-xl text-center">
                            <div class="text-3xl font-black ${failed > 0 ? 'text-red-600' : 'text-slate-400'}">${failed}</div>
                            <div class="text-xs ${failed > 0 ? 'text-red-700' : 'text-slate-500'} font-bold">Échecs</div>
                        </div>
                    </div>
                    <div class="p-4 bg-gradient-to-r from-violet-50 to-purple-50 border border-violet-200 rounded-xl">
                        <div class="text-center">
                            <div class="text-4xl font-black text-violet-600">${successRate}%</div>
                            <div class="text-sm text-violet-700 font-bold">Taux de réussite livraison</div>
                            <div class="w-full h-3 bg-violet-200 rounded-full mt-3 overflow-hidden">
                                <div class="h-full bg-violet-600 rounded-full" style="width: ${successRate}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showQuickContactModal() {
            const users = CORE.getVisibleUsers().filter(u => u.active && u.phone);

            UI.modal('📞 Contact rapide', `
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    <input type="text" id="contact_search" placeholder="Rechercher..." class="w-full px-4 py-2 border border-slate-200 rounded-xl mb-3" oninput="ManagerModule.filterContacts(this.value)">
                    <div id="contacts_list" class="space-y-2">
                        ${users.map(u => `
                            <div class="contact-item flex items-center justify-between p-3 bg-slate-50 border border-slate-200 rounded-xl hover:bg-slate-100 transition" data-name="${u.name.toLowerCase()}">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-slate-300 flex items-center justify-center text-slate-700 font-bold">
                                        ${u.name.slice(0, 2).toUpperCase()}
                                    </div>
                                    <div>
                                        <div class="font-bold text-slate-900">${u.name}</div>
                                        <div class="text-xs text-slate-500">${u.role} • ${u.phone}</div>
                                    </div>
                                </div>
                                <button onclick="ManagerModule.callUser(${u.id}); UI.closeModal();" class="px-4 py-2 bg-emerald-600 text-white text-sm font-bold rounded-lg hover:bg-emerald-700">
                                    📞 Appeler
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        filterContacts(query) {
            const items = document.querySelectorAll('.contact-item');
            items.forEach(item => {
                const name = item.dataset.name || '';
                item.style.display = name.includes(query.toLowerCase()) ? '' : 'none';
            });
        },

        async showPendingTransfersModal() {
            // Pull fresh transfer + product data from cloud before displaying
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() && navigator.onLine) {
                try {
                    UI.toast('Chargement des transferts...', 'info', 2000);
                    const [fresh, freshProducts] = await Promise.all([
                        API.request('/sync/stockTransfers?light=1', { method: 'GET', timeout: 8000 }).catch(e => null),
                        API.request('/sync/products?light=1', { method: 'GET', timeout: 8000 }).catch(e => null)
                    ]);
                    if (fresh && Array.isArray(fresh.data)) {
                        CORE.db.stockTransfers = API._smartMerge(CORE.db.stockTransfers || [], fresh.data);
                    }
                    if (freshProducts && Array.isArray(freshProducts.data)) {
                        CORE.db.products = API._smartMerge(CORE.db.products || [], freshProducts.data);
                    }
                    CORE.save();
                } catch(e) {
                    console.warn('[TRANSFERS] Manager cloud pull failed:', e.message);
                }
            }
            const posId = CORE.state.currentUser?.pos;
            // Transferts inter-POS entrants (stockTransfers)
            const incomingTransfers = (CORE.db.stockTransfers || []).filter(t =>
                t.status === 'pending' && String(t.destPosId) === String(posId)
            );
            // Transferts inter-POS sortants encore en attente
            const outgoingTransfers = (CORE.db.stockTransfers || []).filter(t =>
                t.status === 'pending' && String(t.sourcePosId) === String(posId)
            );
            // Transferts depot (transferReceipts)
            const depotTransfers = (CORE.db.transferReceipts || []).filter(t =>
                t.status === 'pending' && String(t.toPosId) === String(posId)
            );

            UI.modal('📦 Transferts en attente', `
                <div class="space-y-5 max-h-[80vh] overflow-y-auto">
                    <!-- Entrants -->
                    <div class="bg-white rounded-2xl border border-emerald-200 p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-lg">📥</span>
                            <span class="font-black text-slate-900">Transferts entrants à réceptionner</span>
                            <span class="px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded-full text-xs font-black">${incomingTransfers.length + depotTransfers.length}</span>
                        </div>
                        ${incomingTransfers.length === 0 && depotTransfers.length === 0 ? '<div class="text-center py-4 text-slate-400 text-sm">Aucun transfert entrant en attente</div>' : ''}
                        ${incomingTransfers.map(t => `
                            <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-xl mb-2">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="font-black text-emerald-900">${t.productName || 'Produit'}</div>
                                        <div class="text-sm text-emerald-700">De: ${t.sourcePosName || 'POS'} • ${t.qty} unité(s)</div>
                                        <div class="text-xs text-emerald-600 mt-1">${t.reason || ''}</div>
                                    </div>
                                    <div class="flex flex-col items-end gap-2">
                                        <div class="text-xs text-emerald-500">${new Date(t.createdAt).toLocaleDateString('fr-FR')}</div>
                                        <button onclick="ManagerModule.receiveTransfer('${t.id}','stockTransfers')" class="px-3 py-1.5 bg-emerald-600 text-white font-black rounded-lg text-xs hover:bg-emerald-700 transition">✅ Réceptionner</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                        ${depotTransfers.map(t => `
                            <div class="p-3 bg-blue-50 border border-blue-200 rounded-xl mb-2">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="font-black text-blue-900">${t.productName || t.id}</div>
                                        <div class="text-sm text-blue-700">De: ${t.fromPosName || 'Dépôt'} • ${t.quantity || 0} unité(s)</div>
                                    </div>
                                    <div class="flex flex-col items-end gap-2">
                                        <div class="text-xs text-blue-500">${new Date(t.createdAt).toLocaleDateString('fr-FR')}</div>
                                        <button onclick="ManagerModule.receiveTransfer('${t.id}','transferReceipts')" class="px-3 py-1.5 bg-blue-600 text-white font-black rounded-lg text-xs hover:bg-blue-700 transition">✅ Réceptionner</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <!-- Sortants -->
                    <div class="bg-white rounded-2xl border border-orange-200 p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-lg">📤</span>
                            <span class="font-black text-slate-900">Transferts envoyés (en attente de réception)</span>
                            <span class="px-2 py-0.5 bg-orange-100 text-orange-700 rounded-full text-xs font-black">${outgoingTransfers.length}</span>
                        </div>
                        ${outgoingTransfers.length === 0 ? '<div class="text-center py-4 text-slate-400 text-sm">Aucun transfert sortant en attente</div>' : ''}
                        ${outgoingTransfers.map(t => `
                            <div class="p-3 bg-orange-50 border border-orange-200 rounded-xl mb-2">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="font-black text-orange-900">${t.productName || 'Produit'}</div>
                                        <div class="text-sm text-orange-700">Vers: ${t.destPosName || 'POS'} • ${t.qty} unité(s)</div>
                                        <div class="text-xs text-orange-600 mt-1">Envoyé par ${t.createdByName || 'Manager'}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-orange-500">${new Date(t.createdAt).toLocaleDateString('fr-FR')}</div>
                                        <span class="px-2 py-0.5 bg-amber-100 text-amber-700 rounded-full text-xs font-bold">EN ATTENTE</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        // ========== RÉCEPTION DES TRANSFERTS (Manager) ==========
        // Delegates to GestionnaireModule's proven reception flow if available,
        // otherwise implements inline reception with full product auto-creation support.
        receiveTransfer(transferId, source) {
            // Try to delegate to GestionnaireModule which has full reception UI with media upload
            if (typeof GestionnaireModule !== 'undefined' && GestionnaireModule.showReceiveTransferModal) {
                UI.closeModal();
                return GestionnaireModule.showReceiveTransferModal(transferId);
            }
            // Fallback: inline reception (if GestionnaireModule not loaded)
            let transfer = null;
            if (source === 'transferReceipts') {
                transfer = (CORE.db.transferReceipts || []).find(t => t.id === transferId);
                if (transfer) {
                    transfer = { ...transfer, sourcePosId: transfer.fromPosId, sourcePosName: transfer.fromPosName || 'Dépôt principal', destPosId: transfer.toPosId, destPosName: transfer.toPosName, qty: transfer.quantity || transfer.qty, _source: 'transferReceipts' };
                }
            } else {
                transfer = (CORE.db.stockTransfers || []).find(t => t.id === transferId);
                if (transfer) transfer = { ...transfer, _source: 'stockTransfers' };
            }
            if (!transfer) return UI.toast('Transfert introuvable', 'error');

            UI.modal('✅ Confirmer la réception', `
                <div class="space-y-4">
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                        <div class="font-black text-emerald-900 text-lg">${transfer.productName || 'Produit'}</div>
                        <div class="text-2xl font-black text-emerald-600 mt-1">${transfer.qty} unité(s)</div>
                        <div class="text-sm text-emerald-700 mt-2">De: <strong>${transfer.sourcePosName || 'Dépôt'}</strong></div>
                    </div>
                    <div>
                        <label class="block text-sm font-black text-slate-700 mb-1">📝 Note de réception (optionnel)</label>
                        <textarea id="reception_note" rows="2" class="w-full px-3 py-2 border border-slate-200 rounded-xl text-sm" placeholder="Ex: Colis en bon état..."></textarea>
                    </div>
                    <div class="p-3 bg-amber-50 border border-amber-200 rounded-xl text-sm text-amber-700">
                        <strong>⚠ Important:</strong> En validant, le stock sera ajouté à votre inventaire.
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Confirmer la réception', onclick: "ManagerModule._executeReception('" + transferId + "','" + source + "')", class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700' }
            ]);
        },

        async _executeReception(transferId, source) {
            // Pull latest products from cloud first
            try {
                if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() && navigator.onLine) {
                    const freshProducts = await API.request('/sync/products?light=1', { method: 'GET', timeout: 8000 });
                    if (freshProducts && Array.isArray(freshProducts.data)) {
                        CORE.db.products = API._smartMerge(CORE.db.products || [], freshProducts.data);
                        CORE._productIndex = null;
                        console.log('[MANAGER-RECEPTION] Pulled ' + freshProducts.data.length + ' products from cloud');
                    }
                }
            } catch(e) { console.warn('[MANAGER-RECEPTION] Cloud pull failed:', e.message); }

            // Find the actual transfer record (not a copy)
            let transfer, transferSource;
            if (source === 'transferReceipts') {
                transfer = (CORE.db.transferReceipts || []).find(t => t.id === transferId);
                transferSource = 'transferReceipts';
            } else {
                transfer = (CORE.db.stockTransfers || []).find(t => t.id === transferId);
                transferSource = 'stockTransfers';
            }
            if (!transfer) { UI.closeModal(); return UI.toast('Transfert introuvable', 'error'); }

            // Normalize fields
            const productId = transfer.productId;
            const destPosId = transferSource === 'transferReceipts' ? transfer.toPosId : transfer.destPosId;
            const sourcePosName = transferSource === 'transferReceipts' ? (transfer.fromPosName || 'Dépôt') : (transfer.sourcePosName || 'POS');
            const qty = Number(transferSource === 'transferReceipts' ? (transfer.quantity || transfer.qty) : transfer.qty) || 0;
            const note = document.getElementById('reception_note')?.value?.trim() || '';

            // Multi-criteria product search (same as GestionnaireModule)
            const allProducts = CORE.db.products || [];
            const pidStr = String(productId);
            let product = allProducts.find(p => p.id == productId)
                || allProducts.find(p => String(p.id) === pidStr)
                || allProducts.find(p => p._origLocalId != null && String(p._origLocalId) === pidStr)
                || allProducts.find(p => p._apiId != null && String(p._apiId) === pidStr)
                || allProducts.find(p => p.barcode && transfer.productSku && p.barcode === transfer.productSku)
                || allProducts.find(p => transfer.productName && p.name === transfer.productName);

            console.log('[MANAGER-RECEPTION] Recherche produit:', { productId, pidStr, found: !!product, productFoundId: product?.id, productFoundName: product?.name });

            // Auto-create product if not found
            if (!product) {
                const destPosStocks = {};
                destPosStocks[destPosId] = { stock: 0, price: transfer.productPrice || 0, lastUpdated: new Date().toISOString() };
                (CORE.db.pointsOfSale || []).forEach(loc => {
                    if (!destPosStocks[loc.id]) destPosStocks[loc.id] = { stock: 0, price: transfer.productPrice || 0 };
                });
                product = CORE.create('products', {
                    name: transfer.productName || 'Produit transféré',
                    price: transfer.productPrice || 0,
                    costPrice: transfer.productPrice || 0,
                    categoryId: transfer.productCategory || null,
                    category: transfer.productCategory || null,
                    barcode: transfer.productSku || null,
                    sku: transfer.productSku || null,
                    description: 'Produit créé automatiquement lors du transfert depuis ' + sourcePosName,
                    stock: 0,
                    minStock: 5,
                    posStocks: destPosStocks,
                    posId: destPosId,
                    storeId: destPosId,
                    active: true,
                    createdViaTransfer: true,
                    originalTransferId: transferId,
                    originalProductId: productId,
                    _apiId: (typeof productId === 'string' && /^[0-9a-f]{8}-/i.test(productId)) ? productId : null
                });
                CORE._productIndex = null;
                console.log('[MANAGER-RECEPTION] Nouveau produit créé (id=' + product.id + '):', product.name);
                UI.toast('ℹ️ Nouveau produit créé: ' + product.name, 'info');
            }

            // Update transfer status
            transfer.status = 'accepted';
            transfer.receivedBy = CORE.state.currentUser?.id;
            transfer.receivedByName = CORE.state.currentUser?.name || 'Manager';
            transfer.receivedAt = new Date().toISOString();
            transfer.receptionNote = note;

            // BUG FIX (v34): Clear lockedToPosId for transferred products
            if (product.lockedToPosId && String(product.lockedToPosId) !== String(destPosId)) {
                console.log('[MANAGER-RECEPTION] Clearing lockedToPosId=' + product.lockedToPosId + ' for product ' + product.id + ' received at POS ' + destPosId);
                product.lockedToPosId = null;
            }

            // Add stock to destination POS
            if (!product.posStocks) product.posStocks = {};
            if (!product.posStocks[destPosId]) product.posStocks[destPosId] = { stock: 0, price: product.price || 0 };
            const currentStock = Number(product.posStocks[destPosId].stock) || 0;
            const newStock = currentStock + qty;
            product.posStocks[destPosId].stock = newStock;
            product.posStocks[destPosId].lastUpdated = new Date().toISOString();
            product.posStocks[destPosId].lastTransfer = new Date().toISOString();

            // Decrement pendingIncoming
            if (product.posStocks[destPosId].pendingIncoming) {
                product.posStocks[destPosId].pendingIncoming = Math.max(0, Number(product.posStocks[destPosId].pendingIncoming) - qty);
            }

            // Update master stock if product belongs to this POS
            if (product.posId && String(product.posId) === String(destPosId)) {
                product.stock = newStock;
            }
            product.updatedAt = new Date().toISOString();
            CORE._productIndex = null;

            console.log('[MANAGER-RECEPTION] Stock mis à jour:', { produit: product.name, posId: destPosId, avant: currentStock, après: newStock, qty });

            // Record stock movement
            CORE.db.stockMovements = CORE.db.stockMovements || [];
            CORE.db.stockMovements.push({
                id: 'MOV-' + CORE.uid(),
                productId: product.id,
                productName: product.name,
                type: 'transfer_in',
                quantity: qty, qty: qty,
                ref: transferId,
                note: 'Réception transfert depuis ' + sourcePosName + (note ? ' - ' + note : ''),
                posId: destPosId,
                createdBy: CORE.state.currentUser?.id,
                createdByName: CORE.state.currentUser?.name,
                createdAt: new Date().toISOString(),
                status: 'completed'
            });

            CORE.markDirty('products');
            CORE.markDirty(transferSource);
            CORE.markDirty('stockMovements');
            CORE.save(true);

            // BUG FIX (v36): Verify the product is actually visible after save
            var _verifyProduct2 = (CORE.db.products || []).find(function(p) { return p.id === product.id; });
            if (_verifyProduct2) {
                var _vps2 = _verifyProduct2.posStocks || {};
                var _hasDestStock2 = _vps2[destPosId] || _vps2[String(destPosId)];
                console.log('[MANAGER-RECEPTION] ✅ Verification:', {
                    productId: _verifyProduct2.id, productName: _verifyProduct2.name,
                    destPosId: destPosId, hasDestStock: !!_hasDestStock2,
                    destStock: _hasDestStock2 ? _hasDestStock2.stock : 'N/A',
                    posStocksKeys: Object.keys(_vps2),
                    userPos: CORE.state.currentUser?.pos
                });
                var _canSee2 = CORE.canAccess('product', _verifyProduct2);
                if (!_canSee2) {
                    console.error('[MANAGER-RECEPTION] ❌ Product NOT VISIBLE! Applying emergency fix...');
                    var _userPosStr2 = String(CORE.state.currentUser?.pos || CORE.state.currentUser?.storeId || '');
                    if (_userPosStr2 && !_vps2[_userPosStr2]) {
                        _verifyProduct2.posStocks[_userPosStr2] = { stock: newStock, price: _verifyProduct2.price || 0, lastUpdated: new Date().toISOString(), lastTransfer: new Date().toISOString() };
                        _verifyProduct2.updatedAt = new Date().toISOString();
                        CORE._productIndex = null;
                        CORE.save(true);
                    }
                }
            }

            // SYNC FIX: Force immediate cloud push
            clearTimeout(CORE._cloudPushTimer);
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() && navigator.onLine) {
                CORE._cloudPushTimer = setTimeout(() => CORE._doCloudPush(0), 500);
            }

            UI.closeModal();
            UI.toast('✅ Transfert réceptionné: +' + qty + ' ' + product.name, 'success');
            App.rerender();
        },

        reassignDelivery(deliveryId) {
            const delivery = CORE.getVisibleDeliveries().find(d => d.id === deliveryId);
            // Include both regular and independent livreurs
            const allLivreurs = delivery?.posId ? CORE.getAvailableLivreursByPOS(delivery.posId, false) : CORE.getVisibleUsers().filter(u => u.active && u.role === 'livreur');

            UI.modal('🔄 Réassigner la livraison', `
                <div class="space-y-4">
                    <div class="p-3 bg-amber-50 border border-amber-200 rounded-xl">
                        <div class="font-bold text-amber-900">${delivery?.orderRef || 'N/A'}</div>
                        <div class="text-sm text-amber-700">Actuellement: ${delivery?.livreurName || CORE.getUser(delivery?.livreurId)?.name || 'N/A'}</div>
                    </div>
                    <select id="new_livreur" class="w-full px-4 py-3 border border-slate-200 rounded-xl font-medium">
                        <option value="">— Choisir nouveau livreur —</option>
                        ${allLivreurs.filter(l => l.id !== delivery?.livreurId).map(l => `<option value="${l.id}">${l.name}${l.isIndependent ? ' ⭐' : ''}</option>`).join('')}
                    </select>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Réassigner', onclick: `ManagerModule.executeReassign(${deliveryId})`, class: 'bg-amber-600 text-white px-5 py-2.5 rounded-xl font-black hover:bg-amber-700' }
            ]);
        },

        executeReassign(deliveryId) {
            const newLivreurId = parseId(UI.val('new_livreur'));
            if (!newLivreurId) return UI.toast('Sélectionnez un livreur', 'warning');

            CORE.quickAssignDelivery(deliveryId, newLivreurId);
            UI.closeModal();
            UI.toast('Livraison réassignée', 'success');
            App.rerender();
        },

        showQuickAssignModal() {
            const posId = CORE.state.currentUser?.pos;
            const users = posId ? CORE.getAvailableLivreursByPOS(posId, false) : CORE.getVisibleUsers().filter(u => u.active && u.role === 'livreur');
            const deliveries = CORE.getVisibleDeliveries().filter(d => d.status === 'pending').slice(0, 10);

            UI.modal('👤 Assigner une livraison', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Sélectionner livraison</label>
                        <select id="quick_delivery" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                            <option value="">— Choisir —</option>
                            ${deliveries.map(d => `<option value="${d.id}">${d.orderRef} • ${d.customername || 'Client'}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Assigné à</label>
                        <select id="quick_livreur" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                            <option value="">— Choisir —</option>
                            ${users.map(u => `<option value="${u.id}">${u.name} • ${u.phone || 'N/A'}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Assigner', onclick: 'ManagerModule.executeQuickAssign()', class: 'px-5 py-2.5 bg-blue-600 text-white font-black rounded-xl hover:bg-blue-700 transition' }
            ]);
        },

        executeQuickAssign() {
            const deliveryId = parseId(UI.val('quick_delivery'));
            const userId = parseId(UI.val('quick_livreur'));

            if (!deliveryId || !userId) {
                return UI.toast('Sélectionnez livraison et livreur', 'warning');
            }

            CORE.quickAssignDelivery(deliveryId, userId);
            UI.closeModal();
            UI.toast('Livraison assignée avec succès', 'success');
            App.rerender();
        },

        showQuickRecallModal() {
            const deliveries = CORE.getVisibleDeliveries().filter(d => d.status === 'assigned').slice(0, 10);

            UI.modal('📞 Rappeler une livraison', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Sélectionner livraison</label>
                        <select id="recall_delivery" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                            <option value="">— Choisir —</option>
                            ${deliveries.map(d => `<option value="${d.id}">${d.orderRef} • Assignée à ${d.livreurName}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Raison du rappel</label>
                        <textarea id="recall_reason" placeholder="Décrivez la raison du rappel..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm" rows="3"></textarea>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Rappeler', onclick: 'ManagerModule.executeQuickRecall()', class: 'px-5 py-2.5 bg-amber-600 text-white font-black rounded-xl hover:bg-amber-700 transition' }
            ]);
        },

        executeQuickRecall() {
            const deliveryId = parseInt(UI.val('recall_delivery'));
            const reason = UI.val('recall_reason');

            if (!deliveryId) {
                return UI.toast('Sélectionnez une livraison', 'warning');
            }

            CORE.quickRecallDelivery(deliveryId, reason);
            UI.closeModal();
            UI.toast('Livraison rappelée', 'success');
            App.rerender();
        },

        showNotifyTeamModal() {
            const users = CORE.getVisibleUsers().filter(u => u.active && (u.role === 'livreur' || u.role === 'vendeur'));

            UI.modal('📢 Notifier l\'équipe', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Type de notification</label>
                        <select id="notif_type" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                            <option value="info">ℹ️ Information</option>
                            <option value="warning">⚠️ Avertissement</option>
                            <option value="alert">🚨 Alerte urgente</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Titre</label>
                        <input id="notif_title" type="text" placeholder="Ex: Nouvelle promotion..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Message</label>
                        <textarea id="notif_message" placeholder="Contenu du message..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm" rows="4"></textarea>
                    </div>
                    <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100">
                        <input type="checkbox" id="notif_all" checked>
                        <label for="notif_all" class="text-sm font-black text-slate-700 cursor-pointer">Envoyer à toute l'équipe</label>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Envoyer', onclick: 'ManagerModule.executeSendNotification()', class: 'px-5 py-2.5 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition' }
            ]);
        },

        executeSendNotification() {
            const type = UI.val('notif_type');
            const title = UI.val('notif_title');
            const message = UI.val('notif_message');

            if (!title || !message) {
                return UI.toast('Titre et message requis', 'warning');
            }

            const users = CORE.getVisibleUsers().filter(u => u.active && (u.role === 'livreur' || u.role === 'vendeur'));
            users.forEach(u => {
                CORE.notifyUser(u.id, title, message, type);
            });

            UI.closeModal();
            UI.toast(`Notification envoyée à ${users.length} utilisateurs`, 'success');
            App.rerender();
        },

        showTaxesReportModal() {
            const users = CORE.getVisibleUsers().filter(u => u.active && (u.role === 'vendeur' || u.role === 'livreur'));

            UI.modal('📊 Rapport Taxes', `
                <div class="space-y-4">
                    <div class="text-xs text-slate-600 font-bold bg-slate-50 p-3 rounded-xl">
                        Sélectionnez un utilisateur pour voir son rapport fiscal détaillé
                    </div>
                    <select id="taxes_user" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                        <option value="">— Choisir utilisateur —</option>
                        ${users.map(u => `<option value="${u.id}">${u.name} (${u.role})</option>`).join('')}
                    </select>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Générer rapport', onclick: 'ManagerModule.generateTaxesReport()', class: 'px-5 py-2.5 bg-red-600 text-white font-black rounded-xl hover:bg-red-700 transition' }
            ]);
        },

        generateTaxesReport() {
            const userId = parseInt(UI.val('taxes_user'));
            if (!userId) return UI.toast('Sélectionnez un utilisateur', 'warning');

            const report = CORE.openTaxesReport(userId);
            if (!report) return UI.toast('Rapport non disponible', 'error');

            const headers = ['ID', 'Date', 'Type', 'Montant', 'Note'];
            const rows = report.transactions.map(t => [
                t.id,
                new Date(t.createdAt).toLocaleString('fr-FR'),
                t.type,
                `${t.amount} FCFA`,
                t.note || '—'
            ]);

            let csv = headers.join(',') + '\\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(',') + '\\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `taxes_${report.userName}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            UI.closeModal();
            UI.toast('Rapport taxes généré et téléchargé', 'success');
        },

        showEditTemplatesModal() {
            const templates = CORE.getMessageTemplates();
            const categorized = {
                'delivery': templates.filter(t => t.category === 'delivery'),
                'reminder': templates.filter(t => t.category === 'reminder'),
                'alert': templates.filter(t => t.category === 'alert'),
                'resolution': templates.filter(t => t.category === 'resolution')
            };

            UI.modal('✏️ Gérer modèles de messages', `
                <div class="space-y-6">
                    ${Object.entries(categorized).map(([cat, tmpls]) => `
                        <div>
                            <div class="text-sm font-black text-slate-600 uppercase mb-3">${cat === 'delivery' ? '📦 Livraisons' : cat === 'reminder' ? '⏰ Rappels' : cat === 'alert' ? '⚠️ Alertes' : '✅ Résolutions'}</div>
                            <div class="space-y-2">
                                ${tmpls.map(t => `
                                    <div class="p-3 bg-slate-50 rounded-xl border border-slate-100 group hover:bg-slate-100 transition">
                                        <div class="flex items-start justify-between">
                                            <div>
                                                <div class="font-bold text-slate-900">${t.name}</div>
                                                <div class="text-xs text-slate-600 mt-1">${t.content}</div>
                                            </div>
                                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                                                <button onclick="ManagerModule.editTemplate('${t.id}')" class="px-2 py-1 bg-blue-600 text-white text-xs font-bold rounded">Éditer</button>
                                                <button onclick="ManagerModule.deleteTemplate('${t.id}')" class="px-2 py-1 bg-red-600 text-white text-xs font-bold rounded">Supprimer</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                    <button onclick="ManagerModule.showNewTemplateModal()" class="w-full py-3 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition">
                        ➕ Ajouter modéle
                    </button>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showSendMessageModal(templateId) {
            const template = CORE.db.messageTemplates.find(t => t.id === templateId);
            const users = CORE.getVisibleUsers().filter(u => u.active && u.phone);

            UI.modal(`📨 Envoyer: ${template?.name}`, `
                <div class="space-y-4">
                    <div class="p-3 bg-slate-50 rounded-xl border border-slate-100">
                        <div class="text-xs font-black text-slate-600 uppercase mb-2">Aperçu du message</div>
                        <div class="text-sm text-slate-700">${template?.content}</div>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Destinataire</label>
                        <select id="msg_recipient" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                            <option value="">— Choisir —</option>
                            ${users.map(u => `<option value="${u.id}">${u.name} (${u.phone})</option>`).join('')}
                        </select>
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Envoyer', onclick: `ManagerModule.executeSendMessage('${templateId}')`, class: 'px-5 py-2.5 bg-green-600 text-white font-black rounded-xl hover:bg-green-700 transition' }
            ]);
        },

        executeSendMessage(templateId) {
            const recipientId = parseInt(UI.val('msg_recipient'));
            if (!recipientId) return UI.toast('Sélectionnez un destinataire', 'warning');

            CORE.sendMessage(recipientId, templateId, {});
            UI.closeModal();
            UI.toast('Message envoyé', 'success');
            App.rerender();
        },

        callUser(userId) {
            const user = CORE.getUser(userId);
            if (!user || !user.phone) {
                return UI.toast('Numéro non disponible', 'error');
            }

            CORE.initiateCall(userId, 'Appel depuis la Boîte à Outils');
            UI.toast(`Appel à ${user.name} via ${user.phone}`, 'success');
        },

        showNewTemplateModal() {
            UI.modal('➕ Ajouter modéle de message', `
                <div class="space-y-4">
                    <input id="new_tpl_name" type="text" placeholder="Nom du modèle..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                    <select id="new_tpl_type" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                        <option value="sms">SMS</option>
                        <option value="whatsapp">WhatsApp</option>
                    </select>
                    <select id="new_tpl_cat" class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium">
                        <option value="delivery">Livraison</option>
                        <option value="reminder">Rappel</option>
                        <option value="alert">Alerte</option>
                        <option value="resolution">Résolution</option>
                    </select>
                    <textarea id="new_tpl_content" placeholder="Contenu (utilisez {{variable}} pour les variables)..." class="w-full px-3 py-2 border border-slate-200 rounded-xl font-medium text-sm" rows="4"></textarea>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Créer', onclick: 'ManagerModule.createNewTemplate()', class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        createNewTemplate() {
            const name = UI.val('new_tpl_name');
            const type = UI.val('new_tpl_type');
            const category = UI.val('new_tpl_cat');
            const content = UI.val('new_tpl_content');

            if (!name || !type || !category || !content) {
                return UI.toast('Tous les champs sont requis', 'warning');
            }

            CORE.saveMessageTemplate({ name, type, category, content, variables: [] });
            UI.closeModal();
            UI.toast('Modèle créé', 'success');
            App.rerender();
        },

        editTemplate(templateId) {
            UI.toast('Édition en construction', 'info');
        },

        deleteTemplate(templateId) {
            if (!confirm('Supprimer ce modèle?')) return;
            CORE.db.messageTemplates = CORE.db.messageTemplates.filter(t => t.id !== templateId);
            CORE.save();
            UI.toast('Modèle supprimé', 'success');
            App.rerender();
        },

        showSettingsModal() {
            this.navigateTo('settings'); App.rerender();
            setTimeout(() => { if (window.AccountSwitcher) AccountSwitcher.renderSection(); }, 200);
        },

        switchSettingsTab(tabName) {
            this.state.settingsTab = tabName;
            // Hide all content
            ['general', 'appearance', 'profile'].forEach(tab => {
                const cont = document.getElementById('mgr-content-' + tab);
                const tabBtn = document.getElementById('mgr-tab-' + tab);
                if (cont) { cont.className = 'hidden'; }
                if (tabBtn) {
                    tabBtn.className = 'flex-1 px-4 py-3 text-xs font-bold rounded-xl flex items-center justify-center gap-2 transition-all text-slate-500 hover:text-slate-700 hover:bg-slate-50';
                }
            });
            // Show selected
            const selectedContent = document.getElementById('mgr-content-' + tabName);
            const selectedTab = document.getElementById('mgr-tab-' + tabName);
            if (selectedContent) { selectedContent.className = tabName === 'general' ? 'space-y-4' : tabName === 'appearance' ? 'space-y-4' : 'space-y-4'; }
            if (selectedTab) {
                selectedTab.className = 'flex-1 px-4 py-3 text-xs font-bold rounded-xl flex items-center justify-center gap-2 transition-all bg-sky-50 text-sky-700 shadow-sm border border-sky-200';
            }
            setTimeout(() => lucide.createIcons(), 50);
        },

        saveMyInfoFromSettings() {
            const user = CORE.state.currentUser;
            const phone = document.getElementById('mgr-edit-phone')?.value?.trim() || '';
            const vehicle = document.getElementById('mgr-edit-vehicle')?.value || 'voiture';
            const city = parseInt(document.getElementById('mgr-edit-city')?.value) || 1;
            const pos = parseInt(document.getElementById('mgr-edit-pos')?.value) || 1;
            const bio = document.getElementById('mgr-edit-bio')?.value?.trim() || '';

            if (!phone) return UI.toast('Le téléphone est requis', 'warning');

            user.phone = phone;
            user.vehicle = vehicle;
            user.city = city;
            user.pos = pos;
            user.bio = bio;

            CORE.save();
            UI.toast('✓ Vos informations ont été mises à jour', 'success');
            App.rerender();
        },

        setAccentColor(color) {
            this.state.accentColor = color;
            localStorage.setItem('manager_accent_color', color);
            UI.toast('Couleur d\'accent mise à jour', 'success');
            this.showSettingsModal();
        },

        showEditMyInfoModal() {
            const user = CORE.state.currentUser;
            const cities = CORE.db.cities || [];
            const pos = CORE.db.pointsOfSale || [];

            UI.modal('Éditer Mes Informations', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Téléphone</label>
                        <input type="tel" id="edit-phone" value="${user.phone || ''}" placeholder="Ex: ${CORE.getPhonePlaceholder()}" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Véhicule</label>
                        <select id="edit-vehicle" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                            <option value="moto" ${user.vehicle === 'moto' ? 'selected' : ''}>Moto</option>
                            <option value="voiture" ${user.vehicle === 'voiture' ? 'selected' : ''}>Voiture</option>
                            <option value="camion" ${user.vehicle === 'camion' ? 'selected' : ''}>Camion</option>
                            <option value="velo" ${user.vehicle === 'velo' ? 'selected' : ''}>Vélo</option>
                            <option value="autre" ${user.vehicle === 'autre' ? 'selected' : ''}>Autre</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Ville</label>
                        <select id="edit-city" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                            ${cities.map(c => `<option value="${c.id}" ${user.city === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Point de Vente</label>
                        <select id="edit-pos" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                            ${pos.map(p => `<option value="${p.id}" ${user.pos === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Bio/Description</label>
                        <textarea id="edit-bio" placeholder="Décrivez votre rôle..." class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none h-24">${user.bio || ''}</textarea>
                    </div>
                </div>
            `, [
                { label: 'Enregistrer', onclick: 'ManagerModule.saveMyInfo()', class: 'px-5 py-2.5 bg-cyan-600 text-white font-black rounded-xl hover:bg-cyan-700' },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        saveMyInfo() {
            const user = CORE.state.currentUser;
            const phone = document.getElementById('edit-phone')?.value?.trim() || '';
            const vehicle = document.getElementById('edit-vehicle')?.value || 'voiture';
            const city = parseInt(document.getElementById('edit-city')?.value) || 1;
            const pos = parseInt(document.getElementById('edit-pos')?.value) || 1;
            const bio = document.getElementById('edit-bio')?.value?.trim() || '';

            if (!phone) return UI.toast('Le téléphone est requis', 'warning');
            if (!user) return UI.toast('Utilisateur non trouvé', 'error');

            user.phone = phone;
            user.vehicle = vehicle;
            user.city = city;
            user.pos = pos;
            user.bio = bio;

            CORE.save();
            UI.toast('Vos informations ont été mises à jour', 'success');
            UI.closeModal();
            ManagerModule.showSettingsModal();
            App.rerender();
        },

        renderSettings() {
            const user = CORE.state.currentUser;
            const cities = CORE.db.cities || [];
            const pos = CORE.db.pointsOfSale || [];
            const currentTheme = this.state?.theme || 'light';
            const activeTab = this.state?.settingsTab || 'general';

            return `
                <div class="space-y-6 fade-in">
                    <!-- Header gradient -->
                    <div class="bg-gradient-to-br from-blue-600 via-sky-600 to-cyan-700 p-6 rounded-2xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
                        <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full translate-y-1/2 -translate-x-1/2"></div>
                        <div class="relative flex items-center gap-4">
                            <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center shadow-xl">
                                <i data-lucide="settings" class="w-8 h-8 text-white"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-black text-white">Centre de Contr\u00F4le</h2>
                                <p class="text-sky-200 text-sm">Personnalisez votre exp\u00E9rience</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs de navigation -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-2 shadow-sm">
                        <div class="flex gap-1">
                            <button onclick="ManagerModule.switchSettingsTab('general')" id="mgr-tab-general" class="flex-1 px-4 py-3 text-xs font-bold rounded-xl flex items-center justify-center gap-2 transition-all ${activeTab === 'general' ? 'bg-sky-50 text-sky-700 shadow-sm border border-sky-200' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'}">
                                <i data-lucide="sliders" class="w-4 h-4"></i>
                                G\u00E9n\u00E9ral
                            </button>
                            <button onclick="ManagerModule.switchSettingsTab('appearance')" id="mgr-tab-appearance" class="flex-1 px-4 py-3 text-xs font-bold rounded-xl flex items-center justify-center gap-2 transition-all ${activeTab === 'appearance' ? 'bg-sky-50 text-sky-700 shadow-sm border border-sky-200' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'}">
                                <i data-lucide="palette" class="w-4 h-4"></i>
                                Apparence
                            </button>
                            <button onclick="ManagerModule.switchSettingsTab('profile')" id="mgr-tab-profile" class="flex-1 px-4 py-3 text-xs font-bold rounded-xl flex items-center justify-center gap-2 transition-all ${activeTab === 'profile' ? 'bg-sky-50 text-sky-700 shadow-sm border border-sky-200' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'}">
                                <i data-lucide="user" class="w-4 h-4"></i>
                                Profil
                            </button>
                        </div>
                    </div>

                    <!-- Tab: G\u00E9n\u00E9ral -->
                    <div id="mgr-content-general" class="${activeTab === 'general' ? 'space-y-4' : 'hidden'}">
                        <!-- Imprimante -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-slate-600 to-gray-700 rounded-xl flex items-center justify-center shadow-lg">
                                        <i data-lucide="printer" class="w-6 h-6 text-white"></i>
                                    </div>
                                    <div>
                                        <div class="font-black text-slate-800">Imprimante</div>
                                        <div class="text-xs text-slate-500">Non connect\u00E9e</div>
                                    </div>
                                </div>
                                <button onclick="UI.toast('Recherche imprimante...', 'info')" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-xl text-xs font-black hover:bg-slate-300 transition">
                                    Configurer
                                </button>
                            </div>
                        </div>

                        <!-- Notifications -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-rose-500 to-pink-600 rounded-xl flex items-center justify-center shadow-lg shadow-rose-200">
                                        <i data-lucide="bell" class="w-6 h-6 text-white"></i>
                                    </div>
                                    <div>
                                        <div class="font-black text-slate-800">Notifications</div>
                                        <div class="text-xs text-slate-500">Alertes en temps r\u00E9el</div>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" checked class="sr-only peer">
                                    <div class="w-14 h-7 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all after:shadow-md peer-checked:bg-sky-500"></div>
                                </label>
                            </div>
                        </div>

                        <!-- Version -->
                        <div class="bg-gradient-to-r from-blue-900 to-sky-900 text-white p-5 rounded-2xl shadow-sm">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-white/10 rounded-xl flex items-center justify-center text-xl font-black">${CORE.getCompanyName().charAt(0)}</div>
                                    <div>
                                        <div class="font-black">${CORE.getCompanyName()}</div>
                                        <div class="text-xs text-sky-300">Version ${CORE.config.version}</div>
                                    </div>
                                </div>
                                <span class="px-3 py-1 bg-emerald-500/20 text-emerald-400 rounded-full text-xs font-bold">\u00C0 jour</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Apparence -->
                    <div id="mgr-content-appearance" class="${activeTab === 'appearance' ? 'space-y-4' : 'hidden'}">
                        <!-- Th\u00E8me -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center shadow-lg shadow-purple-200">
                                    <i data-lucide="sun-moon" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-slate-800">Th\u00E8me</h3>
                                    <p class="text-xs text-slate-500">Personnalisez l'apparence</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <button onclick="ManagerModule.setTheme('light')" class="group p-4 rounded-2xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${currentTheme === 'light' ? 'border-sky-400 shadow-xl shadow-sky-100 scale-105' : 'border-slate-200 hover:border-slate-300 hover:shadow-lg'}">
                                    <div class="w-14 h-14 bg-gradient-to-br from-amber-400 to-orange-500 rounded-xl flex items-center justify-center text-2xl shadow-lg ${currentTheme === 'light' ? 'ring-4 ring-sky-200' : ''}">\u2600\uFE0F</div>
                                    <div class="text-center">
                                        <div class="font-black text-sm text-slate-800">Clair</div>
                                        <div class="text-[10px] text-slate-500">Interface lumineuse</div>
                                    </div>
                                </button>
                                <button onclick="ManagerModule.setTheme('dark')" class="group p-4 rounded-2xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${currentTheme === 'dark' ? 'border-sky-400 shadow-xl shadow-sky-100 scale-105' : 'border-slate-200 hover:border-slate-300 hover:shadow-lg'}">
                                    <div class="w-14 h-14 bg-gradient-to-br from-slate-700 to-slate-900 rounded-xl flex items-center justify-center text-2xl shadow-lg ${currentTheme === 'dark' ? 'ring-4 ring-sky-200' : ''}">\uD83C\uDF19</div>
                                    <div class="text-center">
                                        <div class="font-black text-sm text-slate-800">Sombre</div>
                                        <div class="text-[10px] text-slate-500">Mode nuit</div>
                                    </div>
                                </button>
                                <button onclick="ManagerModule.setTheme('auto')" class="group p-4 rounded-2xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${currentTheme === 'auto' ? 'border-sky-400 shadow-xl shadow-sky-100 scale-105' : 'border-slate-200 hover:border-slate-300 hover:shadow-lg'}">
                                    <div class="w-14 h-14 bg-gradient-to-br from-sky-500 to-blue-600 rounded-xl flex items-center justify-center text-2xl shadow-lg ${currentTheme === 'auto' ? 'ring-4 ring-sky-200' : ''}">\uD83D\uDD04</div>
                                    <div class="text-center">
                                        <div class="font-black text-sm text-slate-800">Auto</div>
                                        <div class="text-[10px] text-slate-500">Suit le syst\u00E8me</div>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- Couleur d'accent -->
                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-200">
                                    <i data-lucide="paintbrush" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-black text-slate-800">Couleur d'accent</h4>
                                    <p class="text-xs text-slate-500">Choisissez votre couleur pr\u00E9f\u00E9r\u00E9e</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-6 gap-3">
                                <button onclick="ManagerModule.setAccentColor('blue')" class="w-12 h-12 rounded-xl transition-all hover:scale-110 ${this.state.accentColor === 'blue' ? 'ring-4 ring-offset-2 ring-slate-400' : ''}" style="background: #3b82f6"></button>
                                <button onclick="ManagerModule.setAccentColor('sky')" class="w-12 h-12 rounded-xl transition-all hover:scale-110 ${this.state.accentColor === 'sky' ? 'ring-4 ring-offset-2 ring-slate-400' : ''}" style="background: #0ea5e9"></button>
                                <button onclick="ManagerModule.setAccentColor('teal')" class="w-12 h-12 rounded-xl transition-all hover:scale-110 ${this.state.accentColor === 'teal' ? 'ring-4 ring-offset-2 ring-slate-400' : ''}" style="background: #14b8a6"></button>
                                <button onclick="ManagerModule.setAccentColor('emerald')" class="w-12 h-12 rounded-xl transition-all hover:scale-110 ${this.state.accentColor === 'emerald' ? 'ring-4 ring-offset-2 ring-slate-400' : ''}" style="background: #10b981"></button>
                                <button onclick="ManagerModule.setAccentColor('violet')" class="w-12 h-12 rounded-xl transition-all hover:scale-110 ${this.state.accentColor === 'violet' ? 'ring-4 ring-offset-2 ring-slate-400' : ''}" style="background: #8b5cf6"></button>
                                <button onclick="ManagerModule.setAccentColor('rose')" class="w-12 h-12 rounded-xl transition-all hover:scale-110 ${this.state.accentColor === 'rose' ? 'ring-4 ring-offset-2 ring-slate-400' : ''}" style="background: #f43f5e"></button>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Profil -->
                    <div id="mgr-content-profile" class="${activeTab === 'profile' ? 'space-y-4' : 'hidden'}">
                        <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                            <div class="flex items-center gap-3 mb-5">
                                <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-200">
                                    <i data-lucide="user-circle" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-slate-800">Mes Informations</h3>
                                    <p class="text-xs text-slate-500">Modifiez vos donn\u00E9es personnelles</p>
                                </div>
                            </div>

                            <div class="space-y-4 p-4 rounded-2xl bg-gradient-to-br from-cyan-50 to-blue-50 border border-cyan-200">
                                <div>
                                    <label class="block text-xs font-black text-slate-600 uppercase mb-2">T\u00E9l\u00E9phone</label>
                                    <input type="tel" id="mgr-edit-phone" value="${user?.phone || ''}" placeholder="Ex: ${CORE.getPhonePlaceholder()}" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none bg-white">
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-slate-600 uppercase mb-2">V\u00E9hicule</label>
                                    <select id="mgr-edit-vehicle" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none bg-white">
                                        <option value="moto" ${user?.vehicle === 'moto' ? 'selected' : ''}>Moto</option>
                                        <option value="voiture" ${user?.vehicle === 'voiture' ? 'selected' : ''}>Voiture</option>
                                        <option value="camion" ${user?.vehicle === 'camion' ? 'selected' : ''}>Camion</option>
                                        <option value="velo" ${user?.vehicle === 'velo' ? 'selected' : ''}>V\u00E9lo</option>
                                        <option value="autre" ${user?.vehicle === 'autre' ? 'selected' : ''}>Autre</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-slate-600 uppercase mb-2">Ville</label>
                                    <select id="mgr-edit-city" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none bg-white">
                                        ${cities.map(c => `<option value="${c.id}" ${user?.city === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-slate-600 uppercase mb-2">Point de Vente</label>
                                    <select id="mgr-edit-pos" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none bg-white">
                                        ${pos.map(p => `<option value="${p.id}" ${user?.pos === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-slate-600 uppercase mb-2">Bio/Description</label>
                                    <textarea id="mgr-edit-bio" placeholder="D\u00E9crivez votre r\u00F4le..." class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:ring-2 focus:ring-cyan-500 focus:outline-none h-24 bg-white">${user?.bio || ''}</textarea>
                                </div>

                                <button onclick="ManagerModule.saveMyInfoFromSettings()" class="w-full py-3 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-black rounded-xl hover:shadow-lg hover:shadow-cyan-200 transition-all flex items-center justify-center gap-2">
                                    <i data-lucide="save" class="w-4 h-4"></i>
                                    Enregistrer les modifications
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- S\u00E9curit\u00E9 -->
                    <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl flex items-center justify-center shadow-lg">
                                <i data-lucide="shield" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h3 class="font-black text-slate-800">S\u00E9curit\u00E9</h3>
                                <p class="text-xs text-slate-500">Mot de passe et confidentialit\u00E9</p>
                            </div>
                        </div>
                        <button onclick="ManagerModule.showChangePersonalPasswordModal()" class="w-full p-4 rounded-xl bg-sky-50 border border-sky-200 hover:bg-sky-100 transition flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i data-lucide="key" class="w-5 h-5 text-sky-600"></i>
                                <div class="text-left">
                                    <div class="text-sm font-black text-sky-700">Changer votre mot de passe</div>
                                    <div class="text-xs text-sky-600">Modifiez votre mot de passe personnel</div>
                                </div>
                            </div>
                            <i data-lucide="chevron-right" class="w-5 h-5 text-sky-400"></i>
                        </button>
                    </div>

                    <!-- Zone de danger -->
                    <div class="bg-red-50 rounded-2xl border border-red-200 overflow-hidden">
                        <div class="p-5 border-b border-red-200 font-black text-red-700 flex items-center gap-2">
                            <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                            <span>Zone de danger</span>
                        </div>
                        <div class="p-5 space-y-3">
                            <button onclick="CORE.showDeleteMyAccountModal()" class="w-full py-3 rounded-xl bg-white border-2 border-red-300 text-red-700 font-black hover:bg-red-100 transition flex items-center justify-center gap-2">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                                <span>Supprimer mon compte</span>
                            </button>
                            <button onclick="App.logout()" class="w-full py-3 rounded-xl bg-red-600 text-white font-black hover:bg-red-700 transition flex items-center justify-center gap-2">
                                <i data-lucide="log-out" class="w-5 h-5"></i>
                                <span>D\u00E9connexion</span>
                            </button>
                        </div>
                    </div>

                    <!-- Multi-comptes -->
                    ${window.AccountSwitcher ? AccountSwitcher.getHTML() : '<div id="account-switcher-section"></div>'}
                </div>`;
        },

                render() {
            const view = this.state.currentView;
            this.loadThemePreference();
            let content;
            try {
                content = view === 'settings' ? this.renderSettings() :
                          view === 'dashboard' ? this.renderDashboard() :
                          view === 'analytics' ? this.renderAnalyticsDashboard() :
                          view === 'pos' ? this.renderPOS() :
                          view === 'inventory' ? this.renderInventory() :
                          view === 'main-stock' ? this.renderMainStockControlCenter() :
                          view === 'finance' ? this.renderFinance() :
                          view === 'team' ? this.renderTeam() :
                          view === 'commandes' ? this.renderCommandes() :
                          view === 'isolation' ? this.renderIsolationPanel() :
                          view === 'toolbox' ? this.renderToolbox() :
                          this.renderDashboard();
            } catch(e) {
                console.error('[ManagerModule] render error for view:', view, e);
                content = `<div class="p-8"><div class="bg-red-50 border-2 border-red-300 rounded-2xl p-6"><h3 class="text-lg font-black text-red-700">Erreur de rendu: ${view}</h3><p class="text-red-600 mt-2 text-sm font-mono">${String(e.message || e).replace(/</g, '&lt;')}</p><button onclick="ManagerModule.navigateTo('dashboard')" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-xl font-bold">Retour Dashboard</button></div></div>`;
            }

            return `
                <div class="flex h-screen bg-slate-50 overflow-hidden">
                    <aside class="w-72 bg-gradient-to-b from-blue-950 via-slate-900 to-slate-950 text-white flex flex-col no-print relative overflow-hidden">
                        <!-- Effets de fond -->
                        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_left,rgba(59,130,246,0.15),transparent_50%)] pointer-events-none"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_bottom_right,rgba(99,102,241,0.1),transparent_50%)] pointer-events-none"></div>
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 via-indigo-500 to-purple-500"></div>

                        <!-- Header -->
                        <div class="p-6 flex-shrink-0 relative">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 via-indigo-500 to-purple-500 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/30 ring-2 ring-white/10">
                                    <i data-lucide="crown" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <h1 class="font-black text-xl tracking-tight">RAYA<span class="text-blue-400">.manager</span></h1>
                                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">${CORE.state.currentUser.name}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation -->
                        <nav class="flex-1 px-4 py-2 space-y-1 overflow-y-auto">
                            ${this.renderNav('dashboard','layout-grid','Dashboard', CORE.getUnreadNotificationCount())}
                            ${this.renderNav('analytics','bar-chart-3','Analytique')}
                            ${this.renderNav('pos','store','Points de vente')}
                            ${this.renderNav('inventory','box','Stocks (Pro)')}
                            ${this.renderNav('main-stock','warehouse','🏭 Stock Dépôt Principal', (CORE.db.transferReceipts || []).filter(t => t.status === 'pending').length)}
                            ${this.renderNav('commandes','shopping-cart','Commandes (Ventes)', (CORE.db.orders || []).filter(o => o.status === 'pending' || o.status === 'new').length)}
                            ${this.renderNav('finance','wallet','Finances')}
                            ${this.renderNav('team','users','Équipe')}
                            ${this.renderNav('toolbox','command','Centre Commande')}
                        </nav>

                        <!-- Footer -->
                        <div class="p-4 border-t border-white/5 relative">
                            <button onclick="ManagerModule.navigateTo('settings')" class="w-full flex items-center gap-3 px-4 py-3 bg-white/5 hover:bg-white/10 rounded-xl transition-all duration-200 group">
                                <i data-lucide="settings" class="w-5 h-5 text-slate-400 group-hover:text-blue-400 group-hover:rotate-90 transition-all duration-300"></i>
                                <span class="text-sm font-bold text-slate-300 group-hover:text-white">Paramètres</span>
                            </button>
                        </div>
                    </aside>

                    <main class="flex-1 overflow-auto p-4 md:p-8">${content}</main>
                </div>`;
        },

        renderNav(view, icon, label, badge = 0) {
            const active = this.state.currentView === view;
            return `
                <button onclick="ManagerModule.navigateTo('${view}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group ${active ? 'bg-gradient-to-r from-blue-500/20 to-indigo-500/10 text-blue-400 border-l-2 border-blue-400' : 'text-slate-400 hover:bg-white/5 hover:text-white'}">
                    <div class="w-9 h-9 rounded-xl ${active ? 'bg-blue-500/20' : 'bg-white/5 group-hover:bg-white/10'} flex items-center justify-center transition-all duration-200 relative">
                        <i data-lucide="${icon}" class="w-5 h-5 ${active ? 'drop-shadow-[0_0_8px_rgba(59,130,246,0.5)]' : ''}"></i>
                        ${badge > 0 ? `<span class="absolute -top-1 -right-1 min-w-[18px] h-[18px] bg-red-500 text-white text-[10px] font-black rounded-full flex items-center justify-center animate-pulse shadow-lg shadow-red-500/40">${badge > 9 ? '9+' : badge}</span>` : ''}
                    </div>
                    <span class="font-bold text-sm">${label}</span>
                    ${active ? '<div class="ml-auto w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>' : ''}
                </button>`;
        },

        validatePurchaseOrderArrival(orderId) {
            const order = CORE.db.purchaseOrders?.find(o => o.id === orderId);
            if (!order) {
                UI.toast('Commande introuvable', 'error');
                return;
            }
            if (order.status === 'received') {
                UI.toast('Commande déjà reçue', 'info');
                return;
            }

            // Afficher modal pour saisir le montant réellement dépensé du transport
            UI.modal('Montant du transport réellement dépensé',
                '<div class="space-y-4">' +
                UI.input('va_transportAmount', 'Montant du transport', 'number', order.transportPrice || 0, 'ex: 5000', true) +
                '</div>',
                [
                    {label: 'Annuler', onclick: 'UI.closeModal()'},
                    {label: 'Confirmer arrivée', onclick: 'ManagerModule.confirmArrivalWithTransport(' + orderId + ')', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700'}
                ]
            );
        },

        confirmArrivalWithTransport(orderId) {
            const order = CORE.db.purchaseOrders?.find(o => o.id === orderId);
            if (!order) {
                UI.toast('Commande introuvable', 'error');
                return;
            }

            const transportAmount = parseFloat(UI.val('va_transportAmount')) || 0;
            if (transportAmount < 0) {
                UI.toast('Montant invalide', 'warning');
                return;
            }

            // Marquer la commande comme reçue
            order.status = 'received';
            order.actualTransportCost = transportAmount;
            CORE.update('purchaseOrders', order.id, order);

            // Mettre à jour la dépense principale
            const expense = CORE.db.expenses?.find(e => e.purchaseOrderId === orderId && e.type === 'purchase_order');
            if (expense) {
                expense.status = 'completed';
                CORE.update('expenses', expense.id, expense);
            }

            // Créer une dépense pour le transport si un montant a été saisi
            if (transportAmount > 0) {
                const supplier = CORE.db.suppliers?.find(s => s.id === order.supplierId);
                CORE.create('expenses', {
                    reference: order.reference + '-TRANSPORT',
                    type: 'transport',
                    description: `Frais de transport réels - ${order.reference} de ${supplier?.name || 'Fournisseur'}`,
                    amount: transportAmount,
                    supplier: supplier?.name || 'Non spécifié',
                    category: 'transport',
                    status: 'completed',
                    purchaseOrderId: orderId,
                    createdAt: new Date().toISOString()
                });
            }

            // Notification d'arrivée validée
            const supplier = CORE.db.suppliers?.find(s => s.id === order.supplierId);
            const product = CORE.getVisibleProducts().find(p => p.id === order.productId);
            CORE.notify('success', `Colis reçu: ${order.reference} (${product?.name || 'Produit'}) - Transport réel: ${CORE.formatPrice(transportAmount)}`, { purchaseOrderId: orderId });

            UI.closeModal();
            UI.toast('✓ Arrivée du colis validée avec frais de transport: ' + CORE.formatPrice(transportAmount), 'success');
            this.navigateTo('commandes');
        },

        renderIsolationPanel() {
            const report = CORE.validatePOSIsolation();
            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-8 rounded-2xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-black mb-2">🔐 Isolation & Sécurité</h1>
                                <p class="text-white/80">Vérification que chaque POS est COMPLÈTEMENT isolé</p>
                            </div>
                            <div class="text-5xl">${report.isolationStatus === 'FULLY_ISOLATED' ? '✅' : '⚠️'}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Points de Vente</div>
                            <div class="text-3xl font-black text-slate-900">${report.posCount}</div>
                        </div>
                        <div class="bg-${report.isolationStatus === 'FULLY_ISOLATED' ? 'emerald' : 'amber'}-50 p-6 rounded-2xl border border-${report.isolationStatus === 'FULLY_ISOLATED' ? 'emerald' : 'amber'}-200">
                            <div class="text-xs font-black text-${report.isolationStatus === 'FULLY_ISOLATED' ? 'emerald' : 'amber'}-600 uppercase mb-1">État Isolation</div>
                            <div class="text-xl font-black text-${report.isolationStatus === 'FULLY_ISOLATED' ? 'emerald' : 'amber'}-900">${report.isolationStatus === 'FULLY_ISOLATED' ? 'ISOLÉ' : 'À CORRIGER'}</div>
                        </div>
                        <div class="bg-${report.issueCount === 0 ? 'emerald' : 'red'}-50 p-6 rounded-2xl border border-${report.issueCount === 0 ? 'emerald' : 'red'}-200">
                            <div class="text-xs font-black text-${report.issueCount === 0 ? 'emerald' : 'red'}-600 uppercase mb-1">Problèmes</div>
                            <div class="text-3xl font-black text-${report.issueCount === 0 ? 'emerald' : 'red'}-900">${report.issueCount}</div>
                        </div>
                    </div>

                    <div class="bg-white border border-slate-200 rounded-2xl p-6">
                        <h2 class="text-lg font-black text-slate-900 mb-4">📊 Rapport Détaillé</h2>
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            ${report.issues.map(issue => `
                                <div class="flex items-start gap-3 text-sm">
                                    <span class="font-black text-lg mt-0.5">${issue.includes('✅') ? '✅' : issue.includes('❌') ? '❌' : '⚠️'}</span>
                                    <span class="text-slate-700">${issue}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-white border border-slate-200 rounded-2xl p-6">
                        <h2 class="text-lg font-black text-slate-900 mb-4">📈 Données par POS</h2>
                        <div class="space-y-4">
                            ${Object.entries(report.summary).map(([key, data]) => `
                                <div class="p-4 bg-gradient-to-r from-slate-50 to-slate-100 rounded-xl border border-slate-200">
                                    <div class="font-black text-slate-900 mb-2">${data.name}</div>
                                    <div class="grid grid-cols-3 md:grid-cols-6 gap-2 text-xs">
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Clients</div>
                                            <div class="font-black text-lg text-slate-900">${data.clients}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Commandes</div>
                                            <div class="font-black text-lg text-slate-900">${data.orders}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Livraisons</div>
                                            <div class="font-black text-lg text-slate-900">${data.deliveries}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Transactions</div>
                                            <div class="font-black text-lg text-slate-900">${data.transactions}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Notif</div>
                                            <div class="font-black text-lg text-slate-900">${data.notifications}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Mvmts</div>
                                            <div class="font-black text-lg text-slate-900">${data.stockMovements}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-indigo-50 border-2 border-indigo-200 rounded-2xl p-6">
                        <div class="font-black text-indigo-900 mb-4">⚙️ Actions</div>
                        <div class="space-y-2">
                            <button onclick="ManagerModule.performIsolationValidation()" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-xl font-black hover:bg-indigo-700 transition">
                                🔍 Valider Isolation Complète
                            </button>
                            <button onclick="if(confirm('Cela va forcer le respect complet de l\'isolation. Continuer ?')) { ManagerModule.performForcedIsolation(); }" class="w-full px-4 py-3 bg-orange-600 text-white rounded-xl font-black hover:bg-orange-700 transition">
                                🔒 Forcer Isolation (DANGER!)
                            </button>
                        </div>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4 text-xs text-blue-800">
                        <div class="font-black mb-2">ℹ️ À propos de l'isolation</div>
                        <p>Chaque Point de Vente doit être COMPLÈTEMENT ISOLÉ. Aucun client, commande, livraison ou notification ne doit être partagé entre les POS. Cette page vérifie que chaque POS dispose d'une structure de données indépendante.</p>
                    </div>
                </div>
            `;
        },

        performIsolationValidation() {
            const report = CORE.validatePOSIsolation();
            const isFull = report.isolationStatus === 'FULLY_ISOLATED';

            UI.modal('Rapport d\'Isolation', `
                <div class="space-y-4">
                    <div class="p-4 rounded-xl ${isFull ? 'bg-emerald-50 border border-emerald-200' : 'bg-amber-50 border border-amber-200'}">
                        <div class="font-black ${isFull ? 'text-emerald-900' : 'text-amber-900'}">
                            ${isFull ? '✅ Isolation Complète Confirmée!' : '⚠️ Isolation Incomplète'}
                        </div>
                        <div class="text-sm ${isFull ? 'text-emerald-800' : 'text-amber-800'} mt-2">
                            ${isFull ? 'Tous les POS sont correctement isolés.' : `${report.issueCount} problème(s) détecté(s).`}
                        </div>
                    </div>
                    <div class="text-xs text-slate-600 max-h-48 overflow-y-auto space-y-2">
                        ${report.issues.map(i => `<div>${i}</div>`).join('')}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        performForcedIsolation() {
            const report = CORE.enforceISOLATION();
            UI.toast('🔒 Isolation forcée appliquée!', 'success');
            UI.modal('Isolation Forcée Appliquée', `
                <div class="space-y-4">
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                        <div class="font-black text-emerald-900">✅ Isolation Complète Appliquée!</div>
                        <div class="text-sm text-emerald-800 mt-2">Tous les POS ont été forcés à l'isolation complète.</div>
                    </div>
                    <div class="text-xs text-slate-600">
                        <div class="font-black mb-2">Résumé:</div>
                        <div>Timestamp: ${report.timestamp}</div>
                        <div>POS: ${report.posCount}</div>
                        <div>État: ${report.isolationStatus}</div>
                    </div>
                </div>
            `, [
                { label: 'OK', onclick: 'UI.closeModal(); ManagerModule.navigateTo("isolation");' }
            ]);
            setTimeout(() => App.rerender(), 500);
        },

        showChangePersonalPasswordModal() {
            UI.modal('🔒 Changer votre mot de passe', `
                <div class="space-y-4">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl flex items-center gap-3">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-amber-600 flex-shrink-0"></i>
                        <div class="text-sm text-amber-800 font-medium">Utilisez un mot de passe fort (min 6 caractères)</div>
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Ancien mot de passe</label>
                        <input type="password" id="old_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Entrez votre ancien mot de passe">
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Nouveau mot de passe</label>
                        <input type="password" id="new_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Entrez un nouveau mot de passe">
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Confirmation du nouveau mot de passe</label>
                        <input type="password" id="confirm_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Confirmez le nouveau mot de passe">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Changer le mot de passe', onclick: 'GestionnaireModule.savePersonalPasswordChange()', class: 'px-5 py-2.5 bg-amber-600 text-white font-black rounded-xl hover:bg-amber-700' }
            ]);
        },

        async savePersonalPasswordChange() {
            const oldPwd = UI.val('old_pwd');
            const newPwd = UI.val('new_pwd');
            const confirmPwd = UI.val('confirm_pwd');
            const user = CORE.state.currentUser;

            if (!oldPwd || !newPwd || !confirmPwd) {
                UI.toast('Tous les champs sont obligatoires', 'error');
                return;
            }

            if (newPwd.length < 6) {
                UI.toast('Le nouveau mot de passe doit contenir au moins 6 caractères', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                UI.toast('Les mots de passe ne correspondent pas', 'error');
                return;
            }

            const oldPwdHash = await Utils.md5(oldPwd);
            if (user.passwordHash) {
                if (oldPwdHash !== user.passwordHash) {
                    UI.toast('Ancien mot de passe incorrect', 'error');
                    return;
                }
            } else if (user.password) {
                if (oldPwd !== user.password) {
                    UI.toast('Ancien mot de passe incorrect', 'error');
                    return;
                }
            } else {
                UI.toast('Impossible de vérifier le mot de passe', 'error');
                return;
            }

            const newPwdHash = await Utils.md5(newPwd);
            user.passwordHash = newPwdHash;

            const userIndex = CORE.getVisibleUsers().findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
                CORE.db.users[userIndex] = user;
                CORE.save();
                UI.closeModal();
                UI.toast('✓ Mot de passe changé avec succès', 'success');
                App.rerender();
            } else {
                UI.toast('Erreur lors de la mise à jour de l\'utilisateur', 'error');
            }
        }
    }


    // =========================================================
    // MODULE: PDG (Command Center)
    // =========================================================
    const PDGModule = {
        state: {
            currentView: 'overview',
            theme: 'light',
            notificationsEnabled: true,
            preferences: { notificationsEnabled: true, soundEnabled: true, soundVolume: 0.8 },
            ordersSearch: '',
            ordersStatus: 'all',
            deliveriesSearch: '',
            deliveriesStatus: 'all',
            stockSearch: '',
            teamSearch: '',
            teamRole: 'all',
            activityTab: 'notifications',
            inventoryPosId: '',

            // Finance (PDG)
            financeTab: 'overview',
            financeFrom: '',
            financeTo: '',
            financeSearch: '',
            financeType: 'all',
            financeCategory: 'all',
            financeMethod: 'all',
            financeCityId: '',
            financePosId: '',

            // Audit Trail
            auditFilterUser: '',
            auditFilterAction: '',
            auditFilterEntity: '',
            auditSortOrder: 'desc',

            // Team (Équipe)
            teamPage: 1,
            teamPerPage: 20,
            teamPosId: 'all',
            teamViewMode: 'list', // 'list' ou 'grouped'
            teamSortBy: 'name', // 'name', 'role', 'pos'
            teamSortOrder: 'asc',

            // Stock (Produits)
            stockPage: 1,
            stockPerPage: 50,
            stockPosId: 'all',
            stockCategoryId: 'all',
            stockStatus: 'all', // 'all', 'low', 'ok', 'out'
            stockSortBy: 'name', // 'name', 'stock', 'price', 'value', 'category'
            stockSortOrder: 'asc',
            stockViewMode: 'table' // 'table' ou 'cards'
        },

        getViewTitle() {
            const titles = {
                'overview': 'Pilotage global',
                'orders': 'Commandes clients',
                'commandes': 'Commandes fournisseurs',
                'deliveries': 'Livraisons',
                'inventory': 'Inventaire',
                'main-stock': 'Stock Central',
                'stock': 'Gestion des Stocks',
                'pos': 'Points de Vente',
                'finance': 'Finances',
                'team': '\u00c9quipe',
                'activity': 'Activit\u00e9',
                'reports': 'Rapports avanc\u00e9s',
                'audit': "Journal d'audit",
                'settings': 'Paramètres'
            };
            return titles[this.state.currentView] || 'Pilotage global';
        },

        navigateTo(view) {
            console.log('[PDG] navigateTo:', view);
            this.state.currentView = view;
            try { App.rerender(); } catch(e) { console.error('[PDG] rerender crashed:', e); alert('Erreur rendu: ' + e.message); }
        },

        setTheme(theme) {
            this.state.theme = theme;
            localStorage.setItem('pdg_theme', theme);

            // Appliquer le thème directement (style WhatsApp comme Vendeur)
            const html = document.documentElement;
            const body = document.body;

            html.classList.remove('pdg-dark', 'pdg-light', 'pdg-auto');
            if (body) body.classList.remove('pdg-dark', 'pdg-light', 'pdg-auto');
            html.style.filter = 'none';

            if (theme === 'dark') {
                html.classList.add('pdg-dark');
                if (body) body.classList.add('pdg-dark');
                html.style.backgroundColor = '#111b21';
            } else if (theme === 'light') {
                html.classList.add('pdg-light');
                if (body) body.classList.add('pdg-light');
                html.style.backgroundColor = '#ffffff';
            } else if (theme === 'auto') {
                html.classList.add('pdg-auto');
                if (body) body.classList.add('pdg-auto');
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.backgroundColor = isDark ? '#111b21' : '#ffffff';
                if (isDark) {
                    html.classList.add('pdg-dark');
                    if (body) body.classList.add('pdg-dark');
                }
            }

            UI.toast('Thème: ' + (theme === 'light' ? 'Clair' : theme === 'dark' ? 'Sombre' : 'Auto'), 'success');
            App.rerender();
        },

        setLanguage(code) {
            I18n.setLanguage(code);
            if (VendeurModule?.state?.preferences) VendeurModule.state.preferences.language = code;
            UI.closeModal();
            const langNames = { fr: 'Français', en: 'English', es: 'Español', ar: 'العربية', pt: 'Português', zh: '中文', tr: 'Türkçe', de: 'Deutsch', ru: 'Русский' };
            UI.toast(`✓ Langue: ${langNames[code] || code.toUpperCase()}`, 'success');
            App.rerender();
            this.showSettingsModal();
        },

        saveCompanyName() {
            const name = UI.val('pdg_company_name');
            if (!name || !name.trim()) {
                return UI.toast('Le nom de l\'entreprise ne peut pas être vide', 'warning');
            }

            if (CORE.setCompanyName(name)) {
                UI.toast(`✓ Nom de l'entreprise mis à jour: ${name.trim()}`, 'success');
                UI.closeModal();
                App.rerender();
            } else {
                UI.toast('Erreur lors de la mise à jour', 'error');
            }
        },

        applyTheme() {
            const html = document.documentElement;
            const body = document.body;
            const theme = this.state.theme;

            html.classList.remove('pdg-dark', 'pdg-light', 'pdg-auto');
            if (body) body.classList.remove('pdg-dark', 'pdg-light', 'pdg-auto');
            html.style.filter = 'none';

            if (theme === 'dark') {
                html.classList.add('pdg-dark');
                if (body) body.classList.add('pdg-dark');
                html.style.backgroundColor = '#111b21';
            } else if (theme === 'light') {
                html.classList.add('pdg-light');
                if (body) body.classList.add('pdg-light');
                html.style.backgroundColor = '#ffffff';
            } else if (theme === 'auto') {
                html.classList.add('pdg-auto');
                if (body) body.classList.add('pdg-auto');
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                html.style.backgroundColor = isDark ? '#111b21' : '#ffffff';
                if (isDark) {
                    html.classList.add('pdg-dark');
                    if (body) body.classList.add('pdg-dark');
                }
            }
        },

        loadThemePreference() {
            const saved = localStorage.getItem('pdg_theme');
            if (saved) {
                this.state.theme = saved;
                this.applyTheme();
            }
        },

        // =====================
        // APPROBATIONS (PDG)
        // =====================
        getPendingPOSRequests() {
            return (CORE.db.posCreationRequests || []).filter(r => r.status === 'pending').sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
        },

        approvePOSRequest(requestId) {
            const requests = CORE.db.posCreationRequests || [];
            const request = requests.find(r => r.id === requestId);
            if (!request) return UI.toast('Demande non trouvée', 'error');

            if (request.type === 'creation') {
                // Approuver la création
                const newPOS = CORE.create('pointsOfSale', request.posData);

                // ===== ISOLATION COMPLÈTE: INITIALISER LES DONNÉES ISOLÉES =====
                // Auto-initialise la structure isolée pour ce nouveau POS
                CORE.initializePOSData(newPOS.id, { forceReset: true });

                request.status = 'approved';
                request.approvedBy = CORE.state.currentUser?.name || 'PDG';
                request.approvalDate = new Date().toISOString();
                CORE.save();
                CORE.notify('success', `Création de "${request.posData.name}" approuvée`, { requestId });
                UI.toast(`POS "${request.posData.name}" créé avec approbation ✅ Données isolées initialisées`, 'success');
            } else if (request.type === 'deletion') {
                // Approuver la suppression
                const posId = request.posId;
                CORE.delete('pointsOfSale', posId);

                // ===== ISOLATION COMPLÈTE: SUPPRIMER LES DONNÉES ISOLÉES =====
                // Supprime les données isolées du POS supprimé
                if (CORE.db.posDataByLocation && CORE.db.posDataByLocation[posId]) {
                    delete CORE.db.posDataByLocation[posId];
                }

                request.status = 'approved';
                request.approvedBy = CORE.state.currentUser?.name || 'PDG';
                request.approvalDate = new Date().toISOString();
                CORE.save();
                CORE.notify('success', `Suppression de "${request.posName}" approuvée`, { posId: posId });
                UI.toast(`POS "${request.posName}" supprimé avec approbation ✅ Données isolées supprimées`, 'success');
            }
            App.rerender();
        },

        rejectPOSRequest(requestId) {
            const reason = prompt('Motif du rejet:');
            if (!reason) return;

            const requests = CORE.db.posCreationRequests || [];
            const request = requests.find(r => r.id === requestId);
            if (!request) return UI.toast('Demande non trouvée', 'error');

            request.status = 'rejected';
            request.approvedBy = CORE.state.currentUser?.name || 'PDG';
            request.approvalDate = new Date().toISOString();
            request.rejectionReason = reason;

            CORE.save();
            const label = request.type === 'creation' ? `Création de "${request.posData.name}"` : `Suppression de "${request.posName}"`;
            CORE.notify('warning', `Demande rejetée: ${label}`, { requestId });
            UI.toast('Demande rejetée', 'info');
            App.rerender();
        },

        renderApprovalsModal() {
            const pending = this.getPendingPOSRequests();
            return `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    ${pending.length === 0 ? `<div class="p-8 text-center text-slate-400 font-medium">Aucune demande en attente</div>` : ''}
                    ${pending.map(req => {
                        const isCreation = req.type === 'creation';
                        const title = isCreation ? `Création de: <span class="text-emerald-600">${req.posData.name}</span>` : `Suppression de: <span class="text-amber-600">${req.posName}</span>`;
                        const borderColor = isCreation ? 'border-emerald-200 bg-emerald-50' : 'border-amber-200 bg-amber-50';
                        const textColor = isCreation ? 'text-emerald-900' : 'text-amber-900';
                        return `
                        <div class="p-4 rounded-2xl border ${borderColor}">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1">
                                    <div class="font-black ${textColor}">${title}</div>
                                    ${isCreation ? `
                                        <div class="text-xs text-slate-600 mt-1">
                                            Ville: <span class="font-bold">${CORE.getCity(req.posData.cityId)?.name || 'N/A'}</span><br>
                                            Employés: <span class="font-bold">${req.posData.employees}</span><br>
                                            Demandé par: <span class="font-bold">${req.requestedBy}</span><br>
                                            Le: <span class="font-bold">${CORE.formatDate(req.createdAt)}</span>
                                        </div>
                                    ` : `
                                        <div class="text-xs text-slate-600 mt-1">
                                            Demandé par: <span class="font-bold">${req.requestedBy}</span><br>
                                            Le: <span class="font-bold">${CORE.formatDate(req.createdAt)}</span>
                                        </div>
                                    `}
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="PDGModule.rejectPOSRequest(${req.id})" class="px-3 py-2 bg-red-600 text-white rounded-lg text-xs font-black hover:bg-red-700">Rejeter</button>
                                    <button onclick="PDGModule.approvePOSRequest(${req.id})" class="px-3 py-2 bg-emerald-600 text-white rounded-lg text-xs font-black hover:bg-emerald-700">Approuver</button>
                                </div>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
        },

        // Garder les anciennes méthodes pour compatibilité
        getPendingDeleteRequests() {
            return this.getPendingPOSRequests().filter(r => r.type === 'deletion');
        },

        approvePOSDeleteRequest(requestId) {
            return this.approvePOSRequest(requestId);
        },

        rejectPOSDeleteRequest(requestId) {
            return this.rejectPOSRequest(requestId);
        },

        // =====================
        // GESTION DES POS (PDG)
        // =====================
        renderPOS() {
            const grouped = (CORE.db.pointsOfSale || []).map(p => ({
                ...p,
                city: CORE.getCity(p.cityId)?.name,
                orders: CORE.getVisibleOrders().filter(o => o.posId === p.id).length
            }));
            return `
                <div class="fade-in max-w-6xl mx-auto space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">Points de vente</h2>
                            <p class="text-slate-500 font-medium">Gestion complète des POS.</p>
                        </div>
                        <button onclick="PDGModule.showAddPOSModal()" class="px-6 py-3 bg-indigo-600 text-white font-black rounded-xl hover:bg-indigo-700 transition flex items-center gap-2">
                            <i data-lucide="plus" class="w-5 h-5"></i> Nouveau POS
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        ${grouped.map(p => `
                            <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-6 card-hover relative">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">${p.city}</div>
                                        <div class="text-xl font-black text-slate-900 mt-1">${p.name}</div>
                                        <div class="mt-2 text-sm text-slate-500 font-medium">Employés: <span class="font-black">${p.employees}</span> • Commandes: <span class="font-black">${p.orders}</span></div>
                                    </div>
                                    <div class="flex items-start gap-2">
                                        <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center"><i data-lucide="store" class="w-6 h-6"></i></div>
                                        <button onclick="PDGModule.openPosInventory(${p.id})" class="p-2.5 rounded-xl hover:bg-emerald-50 transition text-emerald-600 hover:text-emerald-700" title="Stock de ce POS">
                                            <i data-lucide="package" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="PDGModule.showEditPOSModal(${p.id})" class="p-2.5 rounded-xl hover:bg-slate-100 transition text-slate-600 hover:text-slate-900" title="Éditer">
                                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="PDGModule.deletePOS(${p.id})" class="p-2.5 rounded-xl hover:bg-red-50 transition text-red-600 hover:bg-red-100" title="Supprimer">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
        },

        openPosInventory(posId) {
            const pos = CORE.getPOS(posId);
            if (!pos) {
                UI.toast('POS non trouvé', 'error');
                return;
            }

            this.state.inventoryPosId = String(posId);
            ManagerModule.state.inventoryPosId = String(posId);
            ManagerModule.state.inventoryTab = 'products';
            ManagerModule.state.inventorySearch = '';
            ManagerModule.state.movementsSearch = '';
            ManagerModule.state.movementsType = 'all';

            this.state.currentView = 'inventory';
            App.rerender();
        },

        showAddPOSModal() {
            const cities = CORE.db.cities.map(c => ({value: c.id, label: c.name}));
            UI.modal('Nouveau Point de Vente', `
                <div class="space-y-4">
                    ${UI.input('pos_name', 'Nom du POS', 'text', '', 'ex: Brazzaville Centre', true)}

                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-900">Ville *</label>
                        <div class="flex gap-2">
                            <select id="pos_city" class="flex-1 px-4 py-2.5 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- Sélectionner une ville --</option>
                                ${cities.map(c => `<option value="${c.value}" ${String(c.value) === String(CORE.state.currentUser?.city || '') ? 'selected' : ''}>${c.label}</option>`).join('')}
                            </select>
                            <button onclick="PDGModule.showNewCityModal('add')" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition whitespace-nowrap">+ Nouvelle</button>
                        </div>
                    </div>

                    ${UI.input('pos_employees', 'Nombre d\'employés', 'number', '1', 'ex: 5', true)}
                    ${UI.input('pos_phone', 'Téléphone', 'tel', '', CORE.getPhonePlaceholder(), false)}
                    ${UI.textarea('pos_address', 'Adresse', '', 'ex: 123 Rue Principale', 2)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Créer', onclick: 'PDGModule.savePOS()', class: 'px-5 py-2.5 bg-indigo-600 text-white font-black rounded-xl hover:bg-indigo-700 transition' }
            ]);
        },

        showEditPOSModal(posId) {
            const pos = CORE.getPOS(posId);
            if (!pos) return UI.toast('POS non trouvé', 'error');
            const cities = CORE.db.cities.map(c => ({value: c.id, label: c.name}));
            UI.modal(`Modifier: ${pos.name}`, `
                <div class="space-y-4">
                    ${UI.input('pos_name', 'Nom du POS', 'text', pos.name, '', true)}

                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-900">Ville *</label>
                        <div class="flex gap-2">
                            <select id="pos_city" class="flex-1 px-4 py-2.5 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- Sélectionner une ville --</option>
                                ${cities.map(c => `<option value="${c.value}" ${String(c.value) === String(pos.cityId || '') ? 'selected' : ''}>${c.label}</option>`).join('')}
                            </select>
                            <button onclick="PDGModule.showNewCityModal('edit', ${posId})" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition whitespace-nowrap">+ Nouvelle</button>
                        </div>
                    </div>

                    ${UI.input('pos_employees', 'Nombre d\'employés', 'number', pos.employees || '1', '', true)}
                    ${UI.input('pos_phone', 'Téléphone', 'tel', pos.phone || '', '', false)}
                    ${UI.textarea('pos_address', 'Adresse', pos.address || '', '', 2)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: `PDGModule.updatePOS(${posId})`, class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        savePOS() {
            const name = UI.val('pos_name').trim();
            const cityId = parseInt(UI.val('pos_city'), 10);
            const employees = parseInt(UI.val('pos_employees'), 10) || 1;
            const phone = UI.val('pos_phone').trim() || null;
            const address = UI.val('pos_address').trim() || null;

            if (!name) return UI.toast('Le nom du POS est requis', 'warning');
            if (!cityId) return UI.toast('Veuillez sélectionner une ville', 'warning');

            const createdPOS = CORE.create('pointsOfSale', {
                name,
                cityId,
                employees,
                phone,
                address
            });
            CORE.initializePOSData(createdPOS.id, { forceReset: true });
            CORE.logAudit('create', 'pos', createdPOS.id, name, { description: `Point de vente créé: ${name}` });

            UI.closeModal();
            UI.toast('Point de vente créé avec succès', 'success');
            App.rerender();
        },

        updatePOS(posId) {
            const name = UI.val('pos_name').trim();
            const cityId = parseInt(UI.val('pos_city'), 10);
            const employees = parseInt(UI.val('pos_employees'), 10) || 1;
            const phone = UI.val('pos_phone').trim() || null;
            const address = UI.val('pos_address').trim() || null;

            if (!name) return UI.toast('Le nom du POS est requis', 'warning');
            if (!cityId) return UI.toast('Veuillez sélectionner une ville', 'warning');

            CORE.update('pointsOfSale', posId, {
                name,
                cityId,
                employees,
                phone,
                address
            });
            CORE.logAudit('update', 'pos', posId, name, { description: `Point de vente modifié: ${name}` });

            UI.closeModal();
            UI.toast('Point de vente mis à jour', 'success');
            App.rerender();
        },

        deletePOS(posId) {
            const pos = CORE.getPOS(posId);
            if (!pos) return UI.toast('POS non trouvé', 'error');

            // Vérifier si des commandes sont liées à ce POS
            const linkedOrders = CORE.getVisibleOrders().filter(o => o.posId === posId);
            if (linkedOrders.length > 0) {
                return UI.toast(`Impossible de supprimer: ${linkedOrders.length} commande(s) associée(s)`, 'warning');
            }

            const linkedUsers = CORE.getVisibleUsers().filter(u => u.pos === posId);
            if (linkedUsers.length > 0) {
                return UI.toast(`Impossible de supprimer: ${linkedUsers.length} utilisateur(s) assigné(s)`, 'warning');
            }

            UI.confirm({
                title: 'Supprimer le POS',
                message: `Êtes-vous sûr de vouloir supprimer définitivement "${pos.name}" ?`,
                confirmLabel: 'Supprimer',
                confirmClass: 'bg-red-600 hover:bg-red-700 text-white',
                onConfirm: function() {
                    CORE.delete('pointsOfSale', posId);
                    UI.closeModal();
                    UI.toast(`POS "${pos.name}" supprimé avec succès`, 'success');
                    CORE.notify('info', `POS supprimé: ${pos.name}`, { posId });
                    App.rerender();
                }
            });
        },

        showNewCityModal(context = 'add', posId = null) {
            // Sauvegarder les données du formulaire POS en cours
            window._pendingPOSFormData = {
                context: context,
                posId: posId,
                name: UI.val('pos_name') || '',
                employees: UI.val('pos_employees') || '1',
                phone: UI.val('pos_phone') || '',
                address: UI.val('pos_address') || ''
            };

            UI.modal('Nouvelle Ville', `
                <div class="space-y-4">
                    <p class="text-sm text-slate-500">Ajoutez une nouvelle ville à la liste des villes disponibles.</p>
                    ${UI.input('new_city_name', 'Nom de la ville', 'text', '', 'ex: Pointe-Noire, Dolisie...', true)}
                    ${UI.input('new_city_country', 'Pays', 'text', 'Congo', 'ex: Congo', false)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'PDGModule.restorePOSModal()' },
                { label: 'Créer la ville', onclick: 'PDGModule.saveNewCity()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        saveNewCity() {
            const cityName = UI.val('new_city_name').trim();
            const country = UI.val('new_city_country').trim() || 'Congo';

            if (!cityName) {
                return UI.toast('Le nom de la ville est requis', 'warning');
            }

            // Vérifier si la ville existe déjà
            const exists = CORE.db.cities.some(c => c.name.toLowerCase() === cityName.toLowerCase());
            if (exists) {
                return UI.toast('Cette ville existe déjà', 'warning');
            }

            // Créer la nouvelle ville
            const newCity = CORE.create('cities', {
                name: cityName,
                country: country
            });

            UI.toast(`Ville "${cityName}" créée avec succès`, 'success');

            // Restaurer le modal POS avec la nouvelle ville sélectionnée
            this.restorePOSModal(newCity.id);
        },

        restorePOSModal(newCityId = null) {
            const data = window._pendingPOSFormData || {};
            const cities = CORE.db.cities.map(c => ({value: c.id, label: c.name}));
            const selectedCity = newCityId || '';

            if (data.context === 'edit' && data.posId) {
                // Restaurer le modal d'édition
                const pos = CORE.getPOS(data.posId);
                UI.modal(`Modifier: ${pos?.name || 'POS'}`, `
                    <div class="space-y-4">
                        ${UI.input('pos_name', 'Nom du POS', 'text', data.name || pos?.name || '', '', true)}

                        <div class="space-y-2">
                            <label class="block text-sm font-black text-slate-900">Ville *</label>
                            <div class="flex gap-2">
                                <select id="pos_city" class="flex-1 px-4 py-2.5 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">-- Sélectionner une ville --</option>
                                    ${cities.map(c => `<option value="${c.value}" ${String(c.value) === String(selectedCity || pos?.cityId || '') ? 'selected' : ''}>${c.label}</option>`).join('')}
                                </select>
                                <button onclick="PDGModule.showNewCityModal('edit', ${data.posId})" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition whitespace-nowrap">+ Nouvelle</button>
                            </div>
                        </div>

                        ${UI.input('pos_employees', 'Nombre d\'employés', 'number', data.employees || pos?.employees || '1', '', true)}
                        ${UI.input('pos_phone', 'Téléphone', 'tel', data.phone || pos?.phone || '', '', false)}
                        ${UI.textarea('pos_address', 'Adresse', data.address || pos?.address || '', '', 2)}
                    </div>
                `, [
                    { label: 'Annuler', onclick: 'UI.closeModal()' },
                    { label: 'Enregistrer', onclick: `PDGModule.updatePOS(${data.posId})`, class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
                ]);
            } else {
                // Restaurer le modal de création
                UI.modal('Nouveau Point de Vente', `
                    <div class="space-y-4">
                        ${UI.input('pos_name', 'Nom du POS', 'text', data.name || '', 'ex: Brazzaville Centre', true)}

                        <div class="space-y-2">
                            <label class="block text-sm font-black text-slate-900">Ville *</label>
                            <div class="flex gap-2">
                                <select id="pos_city" class="flex-1 px-4 py-2.5 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="">-- Sélectionner une ville --</option>
                                    ${cities.map(c => `<option value="${c.value}" ${String(c.value) === String(selectedCity) ? 'selected' : ''}>${c.label}</option>`).join('')}
                                </select>
                                <button onclick="PDGModule.showNewCityModal('add')" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition whitespace-nowrap">+ Nouvelle</button>
                            </div>
                        </div>

                        ${UI.input('pos_employees', 'Nombre d\'employés', 'number', data.employees || '1', 'ex: 5', true)}
                        ${UI.input('pos_phone', 'Téléphone', 'tel', data.phone || '', CORE.getPhonePlaceholder(), false)}
                        ${UI.textarea('pos_address', 'Adresse', data.address || '', 'ex: 123 Rue Principale', 2)}
                    </div>
                `, [
                    { label: 'Annuler', onclick: 'UI.closeModal()' },
                    { label: 'Créer', onclick: 'PDGModule.savePOS()', class: 'px-5 py-2.5 bg-indigo-600 text-white font-black rounded-xl hover:bg-indigo-700 transition' }
                ]);
            }

            window._pendingPOSFormData = null;
        },

        // ---------- Helpers
        getGlobalRevenue() {
            return CORE.getVisibleOrders().filter(o => o.status === 'delivered').reduce((a,o)=>a+(o.total||0),0);
        },

        getInventoryValue() {
            return CORE.getVisibleProducts().reduce((a,p)=>a + (Number(p.price||0) * Number(p.stock||0)), 0);
        },

        getKpis() {
            const orders = CORE.getVisibleOrders();
            const deliveredRevenue = this.getGlobalRevenue();
            const pendingOrders = orders.filter(o => ['pending','confirmed','delivering'].includes(o.status)).length;
            const cancelledOrders = orders.filter(o => o.status === 'cancelled').length;
            const deliveries = CORE.getVisibleDeliveries();
            const deliveriesInProgress = deliveries.filter(d => d.status === 'en_cours').length;
            const deliveriesToAssign = deliveries.filter(d => d.status === 'en_attente').length;
            const products = CORE.getVisibleProducts();
            const stockAlerts = products.filter(p => (p.stock||0) <= (p.minStock||0)).length;
            const outOfStock = products.filter(p => (p.stock||0) === 0).length;
            const inventoryValue = this.getInventoryValue();

            // === KPIs TEMPS-RÉEL: Aujourd'hui ===
            const now = new Date();
            const todayStr = now.toDateString();
            const todayOrders = orders.filter(o => o.createdAt && new Date(o.createdAt).toDateString() === todayStr);
            const todayDelivered = todayOrders.filter(o => o.status === 'delivered');
            const todayCA = todayDelivered.reduce((a,o) => a + (o.total||0), 0);
            const todayOrdersCount = todayOrders.length;

            // Marge brute estimée (si costPrice disponible)
            const todayMargin = todayDelivered.reduce((a,o) => {
                return a + (o.items||[]).reduce((s,it) => {
                    const p = CORE.getProduct && CORE.getProduct(it.productId);
                    const cost = p && p.costPrice ? p.costPrice : (it.price||0) * 0.6;
                    return s + ((it.price||0) - cost) * (it.quantity||1);
                }, 0);
            }, 0);

            // Panier moyen aujourd'hui
            const todayAvgTicket = todayDelivered.length > 0 ? todayCA / todayDelivered.length : 0;

            // Taux de conversion (livrées / total)
            const conversionRate = orders.length > 0 ? ((orders.filter(o=>o.status==='delivered').length / orders.length) * 100).toFixed(1) : 0;

            // CA par heure aujourd'hui (pour graphique temps-réel)
            const hourlyCA = [];
            for (let h = 0; h < 24; h++) {
                const hourOrders = todayDelivered.filter(o => new Date(o.createdAt).getHours() === h);
                hourlyCA.push({ hour: h, ca: hourOrders.reduce((a,o)=>a+(o.total||0),0), count: hourOrders.length });
            }

            // Top produit du jour
            const productSalesMap = {};
            todayDelivered.forEach(o => (o.items||[]).forEach(it => {
                const key = it.productId || it.name;
                if (!productSalesMap[key]) productSalesMap[key] = { qty: 0, revenue: 0, name: (CORE.getProduct && CORE.getProduct(it.productId))?.name || it.name || 'Inconnu' };
                productSalesMap[key].qty += it.quantity || 1;
                productSalesMap[key].revenue += (it.price||0) * (it.quantity||1);
            }));
            const topProductToday = Object.values(productSalesMap).sort((a,b)=>b.revenue-a.revenue)[0] || null;

            // Stock critique détaillé
            const criticalProducts = products.filter(p => (p.stock||0) <= (p.minStock||5)).sort((a,b) => (a.stock||0) - (b.stock||0)).slice(0, 10);

            return {
                deliveredRevenue, ordersTotal: orders.length, pendingOrders, cancelledOrders,
                deliveriesInProgress, deliveriesToAssign, stockAlerts, outOfStock, inventoryValue,
                // Temps-réel
                todayCA, todayOrdersCount, todayMargin, todayAvgTicket, conversionRate,
                hourlyCA, topProductToday, criticalProducts
            };
        },

        cityStats() {
            return CORE.db.cities.map(c => {
                const posIds = (CORE.db.pointsOfSale || []).filter(p => p.cityId === c.id).map(p => p.id);
                const orders = CORE.getVisibleOrders().filter(o => posIds.includes(o.posId));
                const revenue = orders.filter(o => o.status === 'delivered').reduce((a,o)=>a+(o.total||0),0);
                const deliveries = CORE.getVisibleDeliveries().filter(d => {
                    const o = CORE.getVisibleOrders().find(x => x.id === d.orderId);
                    return o && posIds.includes(o.posId);
                });
                return {
                    city: c,
                    posCount: posIds.length,
                    ordersCount: orders.length,
                    revenue,
                    deliveriesInProgress: deliveries.filter(d => d.status === 'en_cours').length
                };
            }).sort((a,b)=>b.revenue - a.revenue);
        },

        // ---------- Export
        downloadCSV(filename, rows) {
            const escape = (v) => {
                const s = String(v ?? '');
                if (s.includes('"') || s.includes(',') || s.includes('\n')) return `"${s.replace(/"/g,'""')}"`;
                return s;
            };
            const csv = rows.map(r => r.map(escape).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        },

        exportOrdersCSV() {
            const orders = this.getOrdersFiltered();
            const rows = [
                ['id','reference','status','total','paymentMethod','paymentStatus','pos','city','seller','createdAt'],
                ...orders.map(o => [
                    o.id,
                    o.reference,
                    o.status,
                    o.total,
                    o.paymentMethod,
                    o.paymentStatus,
                    CORE.getPOS(o.posId)?.name || '',
                    CORE.getCity(o.cityId)?.name || '',
                    CORE.getUser(o.sellerId)?.name || '',
                    o.createdAt
                ])
            ];
            this.downloadCSV(`raya_orders_${Utils.todayKey()}.csv`, rows);
        },

        exportDeliveriesCSV() {
            const deliveries = this.getDeliveriesFiltered();
            const rows = [
                ['id','orderRef','status','amount','livreur','client','phone','address','createdAt','recalledAt'],
                ...deliveries.map(d => [
                    d.id,
                    d.orderRef,
                    d.status,
                    d.amount,
                    CORE.getUser(d.livreurId)?.name || '',
                    d.clientName,
                    d.clientPhone,
                    d.address,
                    d.createdAt,
                    d.recalledAt || ''
                ])
            ];
            this.downloadCSV(`raya_deliveries_${Utils.todayKey()}.csv`, rows);
        },

        exportStockCSV() {
            const products = this.getStockFiltered();
            const rows = [
                ['id','name','category','price','stock','minStock','value'],
                ...products.map(p => [
                    p.id,
                    p.name,
                    CORE.getCategory(p.categoryId)?.name || '',
                    p.price,
                    p.stock,
                    p.minStock,
                    Number(p.price||0) * Number(p.stock||0)
                ])
            ];
            this.downloadCSV(`raya_stock_${Utils.todayKey()}.csv`, rows);
        },

        // ---------- Filters
        getOrdersFiltered() {
            const q = (document.getElementById('pdg-orders-search-input')?.value || '').toLowerCase().trim();
            const st = this.state.ordersStatus;
            let orders = [...CORE.getVisibleOrders()].sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
            if (st !== 'all') orders = orders.filter(o => o.status === st);
            if (q) {
                orders = orders.filter(o =>
                    (o.reference || '').toLowerCase().includes(q) ||
                    (o.clientName || '').toLowerCase().includes(q) ||
                    (CORE.getPOS(o.posId)?.name || '').toLowerCase().includes(q)
                );
            }
            return orders;
        },

        getDeliveriesFiltered() {
            const q = (document.getElementById('pdg-deliveries-search-input')?.value || '').toLowerCase().trim();
            const st = this.state.deliveriesStatus;
            let deliveries = [...CORE.getVisibleDeliveries()].sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
            if (st !== 'all') deliveries = deliveries.filter(d => d.status === st);
            if (q) {
                deliveries = deliveries.filter(d =>
                    (d.orderRef || '').toLowerCase().includes(q) ||
                    (d.clientName || '').toLowerCase().includes(q) ||
                    (CORE.getUser(d.livreurId)?.name || '').toLowerCase().includes(q)
                );
            }
            return deliveries;
        },

        getStockFiltered(paginate = true) {
            const q = (document.getElementById('pdg-stock-search-input')?.value || '').toLowerCase().trim();
            const posId = this.state.stockPosId;
            const categoryId = this.state.stockCategoryId;
            const status = this.state.stockStatus || 'all';
            const sortBy = this.state.stockSortBy || 'name';
            const sortOrder = this.state.stockSortOrder || 'asc';

            let products = [...CORE.getVisibleProducts()];

            // Filtre par POS
            if (posId && posId !== 'all') {
                const strPosId = String(posId);
                products = products.filter(p => String(p.posId) === strPosId || String(p.pos) === strPosId);
            }

            // Filtre par catégorie
            if (categoryId && categoryId !== 'all') {
                const strCatId = String(categoryId);
                products = products.filter(p => String(p.categoryId) === strCatId || String(p.category) === strCatId);
            }

            // Filtre par statut stock
            if (status === 'low') {
                products = products.filter(p => p.stock > 0 && p.stock <= p.minStock);
            } else if (status === 'out') {
                products = products.filter(p => p.stock <= 0);
            } else if (status === 'ok') {
                products = products.filter(p => p.stock > p.minStock);
            }

            // Filtre par recherche
            if (q) {
                products = products.filter(p =>
                    (p.name || '').toLowerCase().includes(q) ||
                    (p.barcode || '').toLowerCase().includes(q) ||
                    (p.sku || '').toLowerCase().includes(q) ||
                    String(p.id).includes(q)
                );
            }

            // Tri
            products.sort((a, b) => {
                let valA, valB;
                if (sortBy === 'name') {
                    valA = (a.name || '').toLowerCase();
                    valB = (b.name || '').toLowerCase();
                } else if (sortBy === 'stock') {
                    valA = a.stock || 0;
                    valB = b.stock || 0;
                } else if (sortBy === 'price') {
                    valA = a.price || 0;
                    valB = b.price || 0;
                } else if (sortBy === 'value') {
                    valA = (a.price || 0) * (a.stock || 0);
                    valB = (b.price || 0) * (b.stock || 0);
                } else if (sortBy === 'category') {
                    valA = CORE.getCategory(a.categoryId)?.name || '';
                    valB = CORE.getCategory(b.categoryId)?.name || '';
                } else if (sortBy === 'alert') {
                    valA = (a.stock || 0) - (a.minStock || 0);
                    valB = (b.stock || 0) - (b.minStock || 0);
                }
                if (typeof valA === 'string') {
                    if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                } else {
                    return sortOrder === 'asc' ? valA - valB : valB - valA;
                }
                return 0;
            });

            // Retourner tous les produits si pas de pagination (pour statistiques)
            if (!paginate) return products;

            // Pagination
            const page = this.state.stockPage || 1;
            const perPage = this.state.stockPerPage || 50;
            const start = (page - 1) * perPage;
            return products.slice(start, start + perPage);
        },

        getStockStats() {
            const allProducts = this.getStockFiltered(false);
            const totalFiltered = allProducts.length;
            const totalProducts = CORE.getVisibleProducts().length;
            const page = this.state.stockPage || 1;
            const perPage = this.state.stockPerPage || 50;
            const totalPages = Math.ceil(totalFiltered / perPage);

            // Valorisation
            const totalValue = allProducts.reduce((sum, p) => sum + ((p.price || 0) * (p.stock || 0)), 0);
            const totalStock = allProducts.reduce((sum, p) => sum + (p.stock || 0), 0);

            // Stats par statut
            const lowStock = allProducts.filter(p => p.stock > 0 && p.stock <= p.minStock).length;
            const outOfStock = allProducts.filter(p => p.stock <= 0).length;
            const okStock = allProducts.filter(p => p.stock > p.minStock).length;

            // Stats par catégorie
            const categories = CORE.db.categories || [];
            const productsByCategory = {};
            allProducts.forEach(p => {
                const catId = p.categoryId || 0;
                productsByCategory[catId] = (productsByCategory[catId] || 0) + 1;
            });

            // Stats par POS
            const posList = CORE.db.pointsOfSale || [];
            const productsByPos = {};
            CORE.getVisibleProducts().forEach(p => {
                const pid = p.posId || p.pos || 0;
                productsByPos[pid] = (productsByPos[pid] || 0) + 1;
            });

            return {
                totalFiltered, totalProducts, page, perPage, totalPages,
                totalValue, totalStock, lowStock, outOfStock, okStock,
                productsByCategory, productsByPos, categories, posList
            };
        },

        updateStockSearch(value) {
            this.state.stockSearch = value;
            this.state.stockPage = 1;
            if (this.stockSearchTimer) clearTimeout(this.stockSearchTimer);
            this.stockSearchTimer = setTimeout(() => {
                const input = document.getElementById('pdg-stock-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('pdg-stock-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 400);
        },

        getTeamFiltered(paginate = true) {
            const q = (document.getElementById('pdg-team-search-input')?.value || '').toLowerCase().trim();
            const role = this.state.teamRole;
            const posId = this.state.teamPosId;
            const sortBy = this.state.teamSortBy || 'name';
            const sortOrder = this.state.teamSortOrder || 'asc';

            let users = [...CORE.getVisibleUsers()];

            // Filtre par rôle
            if (role !== 'all') users = users.filter(u => u.role === role);

            // Filtre par POS
            if (posId && posId !== 'all') {
                const posIdNum = parseInt(posId);
                users = users.filter(u => u.pos === posIdNum || u.posId === posIdNum);
            }

            // Filtre par recherche
            if (q) users = users.filter(u =>
                (u.name || '').toLowerCase().includes(q) ||
                (u.phone || '').toLowerCase().includes(q) ||
                (u.username || '').toLowerCase().includes(q)
            );

            // Tri
            users.sort((a, b) => {
                let valA, valB;
                if (sortBy === 'name') {
                    valA = (a.name || '').toLowerCase();
                    valB = (b.name || '').toLowerCase();
                } else if (sortBy === 'role') {
                    valA = a.role || '';
                    valB = b.role || '';
                } else if (sortBy === 'pos') {
                    valA = a.pos || a.posId || 0;
                    valB = b.pos || b.posId || 0;
                }
                if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                return 0;
            });

            // Retourner tous les utilisateurs si pas de pagination (pour statistiques)
            if (!paginate) return users;

            // Pagination
            const page = this.state.teamPage || 1;
            const perPage = this.state.teamPerPage || 20;
            const start = (page - 1) * perPage;
            return users.slice(start, start + perPage);
        },

        getTeamStats() {
            const allUsers = this.getTeamFiltered(false);
            const totalFiltered = allUsers.length;
            const totalUsers = CORE.getVisibleUsers().length;
            const page = this.state.teamPage || 1;
            const perPage = this.state.teamPerPage || 20;
            const totalPages = Math.ceil(totalFiltered / perPage);

            // Stats par POS
            const posList = CORE.db.pointsOfSale || [];
            const usersByPos = {};
            CORE.getVisibleUsers().forEach(u => {
                const pid = u.pos || u.posId || 0;
                usersByPos[pid] = (usersByPos[pid] || 0) + 1;
            });

            // Stats par rôle
            const usersByRole = {};
            CORE.getVisibleUsers().forEach(u => {
                usersByRole[u.role] = (usersByRole[u.role] || 0) + 1;
            });

            return { totalFiltered, totalUsers, page, perPage, totalPages, usersByPos, usersByRole, posList };
        },

        getTeamGroupedByPos() {
            const users = this.getTeamFiltered(false);
            const posList = CORE.db.pointsOfSale || [];
            const grouped = {};

            // Initialiser les groupes
            posList.forEach(pos => {
                grouped[pos.id] = { pos, users: [] };
            });
            grouped[0] = { pos: { id: 0, name: 'Non assigné' }, users: [] };

            // Grouper les utilisateurs
            users.forEach(u => {
                const pid = u.pos || u.posId || 0;
                if (!grouped[pid]) {
                    grouped[pid] = { pos: { id: pid, name: 'POS #' + pid }, users: [] };
                }
                grouped[pid].users.push(u);
            });

            // Filtrer les groupes vides et trier
            return Object.values(grouped).filter(g => g.users.length > 0).sort((a, b) => (a.pos.name || '').localeCompare(b.pos.name || ''));
        },

        updateFinanceSearch(value) {
            this.state.financeSearch = value;
            if (this.financeSearchTimer) clearTimeout(this.financeSearchTimer);
            this.financeSearchTimer = setTimeout(() => {
                const input = document.getElementById('pdg-finance-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('pdg-finance-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateOrdersSearch(value) {
            this.state.ordersSearch = value;
            if (this.ordersSearchTimer) clearTimeout(this.ordersSearchTimer);
            this.ordersSearchTimer = setTimeout(() => {
                const input = document.getElementById('pdg-orders-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('pdg-orders-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateDeliveriesSearch(value) {
            this.state.deliveriesSearch = value;
            if (this.deliveriesSearchTimer) clearTimeout(this.deliveriesSearchTimer);
            this.deliveriesSearchTimer = setTimeout(() => {
                const input = document.getElementById('pdg-deliveries-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('pdg-deliveries-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateStockSearch(value) {
            this.state.stockSearch = value;
            if (this.stockSearchTimer) clearTimeout(this.stockSearchTimer);
            this.stockSearchTimer = setTimeout(() => {
                const input = document.getElementById('pdg-stock-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('pdg-stock-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        updateTeamSearch(value) {
            this.state.teamSearch = value;
            this.state.teamPage = 1; // Réinitialiser la pagination lors de la recherche
            if (this.teamSearchTimer) clearTimeout(this.teamSearchTimer);
            this.teamSearchTimer = setTimeout(() => {
                const input = document.getElementById('pdg-team-search-input');
                const cursorPos = input?.selectionStart || 0;
                App.rerender();
                setTimeout(() => {
                    const newInput = document.getElementById('pdg-team-search-input');
                    if (newInput) {
                        newInput.focus();
                        newInput.setSelectionRange(cursorPos, cursorPos);
                    }
                }, 0);
            }, 500);
        },

        showUserDetail(userId) {
            // Redirige vers la modal de détails utilisateur existante
            this.showUserDetailsModal(userId);
        },

        exportTeamList() {
            const allUsers = this.getTeamFiltered(false);
            const posList = CORE.db.pointsOfSale || [];

            let csvContent = 'sep=,\n';
            csvContent += 'ID,Nom,Username,Rôle,Téléphone,Point de Vente,Statut,Date Création\n';

            allUsers.forEach(u => {
                const pos = posList.find(p => p.id === (u.pos || u.posId));
                csvContent += `${u.id},"${u.name || ''}","${u.username || ''}","${u.role || ''}","${u.phone || ''}","${pos?.name || 'Non assigné'}","${u.active !== false ? 'Actif' : 'Inactif'}","${u.createdAt || '—'}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'equipe_' + new Date().getTime() + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('Liste de l\'équipe exportée (' + allUsers.length + ' membres)', 'success');
        },

        showProductDetail(productId) {
            const p = CORE.getVisibleProducts().find(x => x.id === productId);
            if (!p) return UI.toast('Produit introuvable', 'error');

            const category = CORE.getCategory(p.categoryId);
            const posList = CORE.db.pointsOfSale || [];
            const pos = posList.find(pos => pos.id === (p.posId || p.pos));
            const isLow = p.stock > 0 && p.stock <= p.minStock;
            const isOut = p.stock <= 0;
            const value = (p.price || 0) * (p.stock || 0);

            // Historique des mouvements de stock pour ce produit
            const movements = CORE.getVisibleStockMovements()
                .filter(m => m.productId === productId)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 10);

            UI.modal(`📦 ${p.name}`, `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <!-- Infos principales -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="p-4 bg-slate-50 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase">Stock actuel</div>
                            <div class="text-2xl font-black ${isOut ? 'text-red-600' : isLow ? 'text-amber-600' : 'text-emerald-600'}">${p.stock}</div>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase">Seuil min</div>
                            <div class="text-2xl font-black text-slate-900">${p.minStock || 0}</div>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase">Prix</div>
                            <div class="text-2xl font-black text-slate-900">${CORE.formatPrice(p.price)}</div>
                        </div>
                        <div class="p-4 bg-emerald-50 rounded-2xl">
                            <div class="text-xs font-black text-emerald-600 uppercase">Valeur stock</div>
                            <div class="text-2xl font-black text-emerald-700">${CORE.formatPrice(value)}</div>
                        </div>
                    </div>

                    <!-- Détails -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-3 bg-slate-50 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase">Catégorie</div>
                            <div class="font-bold text-slate-900">${category?.name || '—'}</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase">Point de vente</div>
                            <div class="font-bold text-slate-900">${pos?.name || 'Dépôt principal'}</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase">Code-barres</div>
                            <div class="font-bold text-slate-900">${p.barcode || '—'}</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase">SKU</div>
                            <div class="font-bold text-slate-900">${p.sku || '—'}</div>
                        </div>
                    </div>

                    ${p.description ? `
                        <div class="p-3 bg-slate-50 rounded-xl">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Description</div>
                            <div class="text-sm text-slate-700">${p.description}</div>
                        </div>
                    ` : ''}

                    <!-- Statut -->
                    <div class="p-4 ${isOut ? 'bg-red-50 border-red-200' : isLow ? 'bg-amber-50 border-amber-200' : 'bg-emerald-50 border-emerald-200'} border rounded-2xl flex items-center justify-between">
                        <div>
                            <div class="text-xs font-black ${isOut ? 'text-red-600' : isLow ? 'text-amber-600' : 'text-emerald-600'} uppercase">État du stock</div>
                            <div class="font-black ${isOut ? 'text-red-700' : isLow ? 'text-amber-700' : 'text-emerald-700'}">${isOut ? 'Rupture de stock' : isLow ? 'Stock bas - Réapprovisionnement nécessaire' : 'Stock suffisant'}</div>
                        </div>
                        ${isOut ? UI.badge('RUPTURE','red') : isLow ? UI.badge('BAS','amber') : UI.badge('OK','emerald')}
                    </div>

                    <!-- Derniers mouvements -->
                    ${movements.length > 0 ? `
                        <div class="border border-slate-200 rounded-2xl overflow-hidden">
                            <div class="p-3 bg-slate-100 border-b border-slate-200">
                                <div class="font-black text-slate-700">📊 Derniers mouvements (${movements.length})</div>
                            </div>
                            <div class="divide-y divide-slate-100 max-h-[200px] overflow-y-auto">
                                ${movements.map(m => `
                                    <div class="p-3 flex items-center justify-between">
                                        <div>
                                            <div class="font-bold text-slate-900">${m.type === 'in' ? '📥 Entrée' : m.type === 'out' ? '📤 Sortie' : '🔄 Ajustement'}</div>
                                            <div class="text-xs text-slate-500">${m.note || '—'} • ${CORE.formatDate(m.createdAt)}</div>
                                        </div>
                                        <div class="font-black ${m.type === 'out' ? 'text-red-600' : 'text-emerald-600'}">${m.type === 'out' ? '-' : '+'}${m.qty}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        // ---------- Details modals
        showOrderDetail(orderId) {
            const o = CORE.getVisibleOrders().find(x => x.id === orderId);
            if (!o) return;
            UI.modal(`Commande ${o.reference}`, `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Statut</div>
                            <div class="mt-1">${UI.badge(o.status, o.status==='delivered'?'emerald':o.status==='pending'?'amber':o.status==='cancelled'?'red':'slate')}</div>
                        </div>
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-right">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Total</div>
                            <div class="mt-1 text-2xl font-black text-emerald-600">${CORE.formatPrice(o.total)}</div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Client</div>
                        <div class="mt-1 font-black text-slate-900">${o.clientName || '—'}</div>
                        <div class="text-xs text-slate-600">${o.clientPhone || ''}</div>
                        <div class="mt-2 text-xs text-slate-600"><b>Adresse:</b> ${o.clientAddress || '—'}</div>
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-2">Articles</div>
                        <div class="space-y-2">
                            ${(o.items || []).map(it => `
                                <div class="flex justify-between text-sm">
                                    <div class="font-bold text-slate-800">${it.qty}× ${it.name}</div>
                                    <div class="font-black">${CORE.formatPrice(it.qty * it.price)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider mb-2">Paiement</div>
                        <div class="flex items-center justify-between">
                            <div class="text-sm font-bold">Méthode</div>
                            <div class="text-sm font-black">${CORE.paymentMethodLabel(o.paymentMethod)}</div>
                        </div>
                        <div class="flex items-center justify-between mt-2">
                            <div class="text-sm font-bold">Statut</div>
                            <div>${UI.badge(CORE.paymentStatusLabel(o.paymentStatus), o.paymentStatus==='paid'?'emerald':'amber')}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Point de vente</div>
                            <div class="mt-1 font-black">${CORE.getPOS(o.posId)?.name || '—'}</div>
                            <div class="text-xs text-slate-600">Ville: ${CORE.getCity(o.cityId)?.name || '—'}</div>
                        </div>
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Vendeur</div>
                            <div class="mt-1 font-black">${CORE.getUser(o.sellerId)?.name || '—'}</div>
                            <div class="text-xs text-slate-600">Créée: ${CORE.formatDate(o.createdAt)}</div>
                        </div>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showDeliveryDetail(deliveryId) {
            const d = CORE.getVisibleDeliveries().find(x => x.id === deliveryId);
            if (!d) return;
            const livreur = d.livreurId ? CORE.getUser(d.livreurId) : null;
            const pos = d.posId ? CORE.getPOS(d.posId) : null;
            const badge = d.status === 'livree' ? UI.badge('Livrée','emerald') :
                          d.status === 'probleme' ? UI.badge('Problème','red') :
                          d.status === 'en_attente' ? UI.badge('À assigner','blue') :
                          d.status === 'annulee' ? UI.badge('Annulée','slate') : UI.badge('En cours','amber');

            const hasProofPhotos = d.proofPhotos && d.proofPhotos.length > 0;
            const hasProofSignature = !!d.proofSignature;
            const hasProof = hasProofPhotos || hasProofSignature;

            UI.modal(`📦 Livraison ${d.orderRef}`, `
                <div class="space-y-4 max-h-[75vh] overflow-y-auto">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Statut</div>
                            <div class="mt-1">${badge}</div>
                        </div>
                        <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-right">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Montant</div>
                            <div class="mt-1 text-2xl font-black text-emerald-600">${CORE.formatPrice(d.amount)}</div>
                        </div>
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Client</div>
                        <div class="mt-1 font-black text-slate-900">${d.clientName || '—'}</div>
                        <div class="text-xs text-slate-600">${d.clientPhone || ''}</div>
                        <div class="mt-2 text-xs text-slate-600"><b>Adresse:</b> ${d.address || '—'}</div>
                        ${d.deliveryTime ? `<div class="mt-1 text-xs text-slate-600"><b>Heure:</b> ${d.deliveryTime}</div>` : ''}
                    </div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Livreur</div>
                        <div class="mt-1 font-black">${livreur?.name || '—'}</div>
                        <div class="text-xs text-slate-600">${livreur?.phone || ''}</div>
                    </div>

                    ${pos ? `
                    <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-2xl">
                        <div class="text-xs font-black text-indigo-500 uppercase tracking-wider">Point de vente</div>
                        <div class="mt-1 font-black text-indigo-900">${pos.name}</div>
                        <div class="text-xs text-indigo-600">${CORE.getCity(pos.cityId)?.name || ''}</div>
                    </div>
                    ` : ''}

                    ${hasProof ? `
                    <!-- PREUVES DE LIVRAISON -->
                    <div class="p-4 bg-gradient-to-r from-emerald-50 to-teal-50 border-2 border-emerald-300 rounded-2xl">
                        <div class="text-xs font-black text-emerald-700 uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i data-lucide="camera" class="w-4 h-4"></i>
                            📷 Preuves de livraison
                        </div>

                        ${hasProofPhotos ? `
                        <div class="mb-3">
                            <div class="text-xs font-bold text-emerald-600 mb-2">Photos (${d.proofPhotos.length})</div>
                            <div class="grid grid-cols-3 gap-2">
                                ${d.proofPhotos.map((photo, idx) => `
                                    <div class="aspect-square rounded-xl overflow-hidden border-2 border-emerald-300 cursor-pointer hover:border-emerald-500 transition shadow-md" onclick="window.open('${photo.replace(/'/g, "\\'")}', '_blank')">
                                        <img src="${photo}" class="w-full h-full object-cover hover:scale-105 transition" alt="Preuve ${idx + 1}">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${hasProofSignature ? `
                        <div>
                            <div class="text-xs font-bold text-emerald-600 mb-2">✍️ Signature client</div>
                            <div class="p-3 bg-white rounded-xl border-2 border-blue-200 cursor-pointer hover:border-blue-400 transition" onclick="window.open('${d.proofSignature.replace(/'/g, "\\'")}', '_blank')">
                                <img src="${d.proofSignature}" class="w-full max-h-24 object-contain" alt="Signature">
                            </div>
                        </div>
                        ` : ''}

                        ${d.proofNote ? `
                        <div class="mt-3 p-3 bg-white rounded-xl border border-emerald-200">
                            <div class="text-xs font-bold text-slate-500 mb-1">Note du livreur</div>
                            <div class="text-sm text-slate-700">${d.proofNote}</div>
                        </div>
                        ` : ''}

                        <div class="text-center text-xs text-emerald-600 mt-3">
                            Validée le ${d.proofTimestamp ? new Date(d.proofTimestamp).toLocaleString('fr-FR') : (d.deliveredAt ? new Date(d.deliveredAt).toLocaleString('fr-FR') : '—')}
                        </div>
                    </div>
                    ` : (d.status === 'livree' ? `
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl text-center">
                        <div class="text-slate-400 text-sm">📷 Aucune preuve de livraison disponible</div>
                    </div>
                    ` : '')}

                    ${d.recallReason ? `<div class="p-4 bg-amber-50 border border-amber-100 rounded-2xl text-xs text-amber-800"><b>Rappel:</b> ${d.recallReason}</div>` : ''}
                    ${d.recalledAt ? `<div class="text-xs text-slate-500">Rappelée: ${CORE.formatDate(d.recalledAt)}</div>` : ''}
                    <div class="text-xs text-slate-500">Créée: ${CORE.formatDate(d.createdAt)}</div>
                    ${d.deliveredAt ? `<div class="text-xs text-emerald-600">Livrée: ${CORE.formatDate(d.deliveredAt)}</div>` : ''}
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        // =====================
        // FINANCES (PDG)
        // =====================
        getFinanceScope() {
            const cityId = this.state.financeCityId !== '' ? parseInt(this.state.financeCityId, 10) : null;
            const posId = this.state.financePosId !== '' ? parseInt(this.state.financePosId, 10) : null;
            return { cityId: cityId || null, posId: posId || null };
        },

        getFinanceDateRange() {
            const from = (this.state.financeFrom || '').trim();
            const to = (this.state.financeTo || '').trim();
            const fromDate = from ? new Date(from + 'T00:00:00') : null;
            const toDate = to ? new Date(to + 'T23:59:59') : null;
            return { fromDate, toDate };
        },

        getTransactionsFiltered() {
            const q = (document.getElementById('pdg-finance-search-input')?.value || '').toLowerCase().trim();
            const type = this.state.financeType;
            const category = this.state.financeCategory;
            const method = this.state.financeMethod;
            const { cityId, posId } = this.getFinanceScope();
            const { fromDate, toDate } = this.getFinanceDateRange();

            let txs = [...CORE.getVisibleTransactions()];

            if (cityId) txs = txs.filter(t => String(t.cityId || '') === String(cityId));
            if (posId) txs = txs.filter(t => String(t.posId || '') === String(posId));

            if (fromDate) txs = txs.filter(t => new Date(t.createdAt) >= fromDate);
            if (toDate) txs = txs.filter(t => new Date(t.createdAt) <= toDate);

            if (type !== 'all') txs = txs.filter(t => t.type === type);
            if (category !== 'all') txs = txs.filter(t => t.category === category);
            if (method !== 'all') txs = txs.filter(t => t.method === method);

            if (q) {
                txs = txs.filter(t =>
                    (t.ref || '').toLowerCase().includes(q) ||
                    (t.note || '').toLowerCase().includes(q) ||
                    (t.userName || '').toLowerCase().includes(q) ||
                    String(t.amount || '').includes(q)
                );
            }

            return txs.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
        },

        getCODOutstanding() {
            const { cityId, posId } = this.getFinanceScope();
            let orders = CORE.getVisibleOrders().filter(o => o.paymentMethod === 'cod' && o.paymentStatus !== 'paid');
            if (cityId) orders = orders.filter(o => String(o.cityId || '') === String(cityId));
            if (posId) orders = orders.filter(o => String(o.posId || '') === String(posId));
            const amount = orders.reduce((a,o)=>a + Number(o.total||0), 0);
            return { count: orders.length, amount, orders };
        },

        getCommissionsDue() {
            const { cityId, posId } = this.getFinanceScope();
            let txs = CORE.getVisibleTransactions().filter(t => t.category === 'commission');
            if (cityId) txs = txs.filter(t => String(t.cityId || '') === String(cityId));
            if (posId) txs = txs.filter(t => String(t.posId || '') === String(posId));
            const due = txs.filter(t => !t.settled);
            const amount = due.reduce((a,t)=>a + Number(t.amount||0), 0);
            return { dueCount: due.length, dueAmount: amount, due };
        },

        getFinanceSummary() {
            const txs = this.getTransactionsFiltered();
            const income = txs.filter(t => t.type === 'income').reduce((a,t)=>a+Number(t.amount||0),0);
            const expense = txs.filter(t => t.type === 'expense').reduce((a,t)=>a+Number(t.amount||0),0);
            const net = income - expense;

            const byMethod = (m) => txs.filter(t => t.type === 'income' && t.category === 'sale' && t.method === m).reduce((a,t)=>a+Number(t.amount||0),0);
            const cash = byMethod('cash');
            const mobile = byMethod('mobile');
            const cod = byMethod('cod');

            const codOutstanding = this.getCODOutstanding();
            const commissions = this.getCommissionsDue();
            return { income, expense, net, cash, mobile, cod, codOutstanding, commissions };
        },

        exportFinanceCSV() {
            const txs = this.getTransactionsFiltered();
            const rows = [
                ['id','type','category','amount','method','ref','note','orderId','deliveryId','posId','cityId','settled','createdAt','userName'],
                ...txs.map(t => [
                    t.id,
                    t.type,
                    t.category,
                    t.amount,
                    t.method || '',
                    t.ref || '',
                    t.note || '',
                    t.orderId || '',
                    t.deliveryId || '',
                    t.posId || '',
                    t.cityId || '',
                    t.settled ? '1' : '0',
                    t.createdAt,
                    t.userName || ''
                ])
            ];
            this.downloadCSV(`raya_finance_pdg_${Utils.todayKey()}.csv`, rows);
        },

        showNewExpenseModal() {
            const expenseCategories = [
                { value: 'stock', label: '📦 Achat de stock/produits' },
                { value: 'transport', label: '🚚 Frais de transport' },
                { value: 'salaire', label: '💼 Salaires' },
                { value: 'loyer', label: '🏢 Loyer/Local' },
                { value: 'electricite', label: '⚡ électricité/Eau' },
                { value: 'telephone', label: '📱 Téléphone/Internet' },
                { value: 'maintenance', label: '🔧 Maintenance/Réparation' },
                { value: 'hygieneEntretien', label: '🧹 Hygiène/Entretien' },
                { value: 'publicite', label: '📢 Publicité/Marketing' },
                { value: 'assurance', label: '🛡️ Assurance' },
                { value: 'taxe', label: '💰 Taxes/Impôts' },
                { value: 'banque', label: '🏦 Frais bancaires' },
                { value: 'deplacement', label: '🚗 Déplacement/Carburant' },
                { value: 'formation', label: '📚 Formation/Cours' },
                { value: 'equipement', label: '🛠️ Équipement/Matériel' },
                { value: 'autre', label: '📋 Autre' }
            ];

            UI.modal('Nouvelle dépense (Global)', `
                <div class="space-y-4">
                    ${UI.input('pfx_amount','Montant','number','0','ex: 25000',true)}
                    ${UI.select('pfx_category', 'Motif / Catégorie', expenseCategories, 'stock', true)}
                    ${UI.select('pfx_method','Méthode',[
                        {value:'cash',label:'Cash'},
                        {value:'mobile',label:'Mobile Money'},
                        {value:'internal',label:'Interne'}
                    ], 'cash', true)}
                    ${UI.select('pfx_city','Ville', [{value:'',label:'—'}].concat(CORE.db.cities.map(c=>({value:c.id,label:c.name}))), this.state.financeCityId || '')}
                    ${UI.select('pfx_pos','POS', [{value:'',label:'—'}].concat((CORE.db.pointsOfSale || []).map(p=>({value:p.id,label:p.name}))), this.state.financePosId || '')}
                    ${UI.input('pfx_ref','Référence','text','', 'ex: FACT-2026-001', false)}
                    ${UI.textarea('pfx_note','Détails additionnels','', 'ex: précisions supplémentaires...', 3)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Enregistrer', onclick: 'PDGModule.saveNewExpense()', class: 'px-5 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition' }
            ]);
        },

        saveNewExpense() {
            const amount = Number(UI.val('pfx_amount') || 0);
            const category = UI.val('pfx_category') || 'autre';
            const method = UI.val('pfx_method') || 'cash';
            const ref = UI.val('pfx_ref').trim() || null;
            const note = UI.val('pfx_note').trim();

            const categoryLabels = {
                'stock': 'Achat de stock/produits',
                'transport': 'Frais de transport',
                'salaire': 'Salaires',
                'loyer': 'Loyer/Local',
                'electricite': 'Électricité/Eau',
                'telephone': 'Téléphone/Internet',
                'maintenance': 'Maintenance/Réparation',
                'hygieneEntretien': 'Hygiène/Entretien',
                'publicite': 'Publicité/Marketing',
                'assurance': 'Assurance',
                'taxe': 'Taxes/Impôts',
                'banque': 'Frais bancaires',
                'deplacement': 'Déplacement/Carburant',
                'formation': 'Formation/Cours',
                'equipement': 'Équipement/Matériel',
                'autre': 'Autre',
                'income_vente': 'Vente directe',
                'income_depot': 'Dépôt en caisse'
            };

            const categoryLabel = categoryLabels[category] || category;
            const fullNote = `[${categoryLabel}]${note ? ' ' + note : ''}`;

            const cityId = parseInt(UI.val('pfx_city') || '0', 10) || null;
            const posId = parseInt(UI.val('pfx_pos') || '0', 10) || null;
            if (!amount || amount <= 0) return UI.toast('Montant invalide', 'warning');
            if (!category) return UI.toast('Veuillez sélectionner une catégorie', 'warning');

            CORE.recordFinancialTransaction({
                type: 'expense',
                category: 'expense',
                amount,
                method,
                ref,
                note: fullNote,
                cityId,
                posId,
                settled: true
            });
            UI.closeModal();
            UI.toast('Dépense enregistrée', 'success');
            App.rerender();
        },

        showNewIncomeModal() {
            const incomeCategories = [
                { value: 'vente', label: '🛒 Vente directe', desc: 'Vente réalisée en magasin' },
                { value: 'depot_caisse', label: '💵 Dépôt en caisse', desc: 'Ajout de fonds à la caisse' },
                { value: 'service', label: '🔧 Service rendu', desc: 'Prestation de service facturée' },
                { value: 'remboursement_fournisseur', label: '↩️ Remboursement fournisseur', desc: 'Retour ou avoir fournisseur' },
                { value: 'investissement', label: '💼 Investissement/Capital', desc: 'Apport de capital ou financement' },
                { value: 'pret_recu', label: '🏦 Prêt reçu', desc: 'Prêt bancaire ou personnel' },
                { value: 'depot_livreur', label: '📥 Dépôt livreur', desc: 'Remise espèces par livreur' },
                { value: 'commission_recue', label: '💰 Commission reçue', desc: 'Commission sur vente ou parrainage' },
                { value: 'location', label: '🏠 Revenus location', desc: 'Loyer ou sous-location' },
                { value: 'autre_revenu', label: '📋 Autre revenu', desc: 'Autre source de revenu' }
            ];

            const paymentMethods = [
                { value: 'cash', label: '💵 Espèces' },
                { value: 'mobile', label: '📱 Mobile Money' },
                { value: 'bank', label: '🏦 Virement bancaire' },
                { value: 'cheque', label: '📝 Chèque' },
                { value: 'card', label: '💳 Carte bancaire' }
            ];

            const posOptions = (CORE.db.pointsOfSale || []).map(p => ({value: p.id, label: p.name}));
            const cityOptions = CORE.db.cities.map(c => ({value: c.id, label: c.name}));

            UI.modal('Nouveau Revenu', `
                <div class="space-y-5">
                    <!-- Header avec indication visuelle -->
                    <div class="p-4 bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200 rounded-2xl">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center text-white shadow-lg shadow-emerald-500/30">
                                <i data-lucide="trending-up" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <div class="font-black text-emerald-800">Enregistrer une entrée d'argent</div>
                                <div class="text-xs text-emerald-600">Ce revenu sera comptabilisé dans le journal financier</div>
                            </div>
                        </div>
                    </div>

                    <!-- Montant (champ principal) -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Montant <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input type="number" id="incomeAmount" class="w-full px-4 py-3 pr-20 text-xl font-black border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/20 transition" min="0" step="0.01" placeholder="0.00">
                            <div class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold">${CORE.db.settings?.currency || 'MAD'}</div>
                        </div>
                    </div>

                    <!-- Catégorie avec cartes cliquables -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Catégorie <span class="text-red-500">*</span></label>
                        <div class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto pr-1" id="incomeCategoryGrid">
                            ${incomeCategories.map((c, i) => `
                                <div onclick="document.querySelectorAll('#incomeCategoryGrid > div').forEach(d => d.classList.remove('ring-2','ring-emerald-500','bg-emerald-50')); this.classList.add('ring-2','ring-emerald-500','bg-emerald-50'); document.getElementById('incomeCategoryValue').value='${c.value}';"
                                     class="p-3 border-2 border-slate-200 rounded-xl cursor-pointer hover:border-emerald-300 hover:bg-emerald-50/50 transition ${i === 0 ? 'ring-2 ring-emerald-500 bg-emerald-50' : ''}">
                                    <div class="font-bold text-sm">${c.label}</div>
                                    <div class="text-xs text-slate-500 mt-0.5">${c.desc}</div>
                                </div>
                            `).join('')}
                        </div>
                        <input type="hidden" id="incomeCategoryValue" value="vente">
                    </div>

                    <!-- Point de vente et Méthode -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Point de vente <span class="text-red-500">*</span></label>
                            <select id="incomePosId" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/20 transition font-medium">
                                ${posOptions.map(p => `<option value="${p.value}">${p.label}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Méthode de paiement</label>
                            <select id="incomeMethod" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/20 transition font-medium">
                                ${paymentMethods.map(m => `<option value="${m.value}">${m.label}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <!-- Description et Référence -->
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Description</label>
                        <textarea id="incomeDescription" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/20 transition font-medium resize-none" rows="2" placeholder="Détails du revenu (optionnel)..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Référence</label>
                        <input type="text" id="incomeReference" class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-xl focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/20 transition font-medium" placeholder="N° reçu, facture, bordereau... (optionnel)">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()', class: 'px-5 py-2.5 border border-slate-300 text-slate-700 font-bold rounded-xl hover:bg-slate-50 transition' },
                { label: '💾 Enregistrer le revenu', onclick: 'PDGModule.saveNewIncome()', class: 'px-6 py-2.5 bg-gradient-to-r from-emerald-500 to-green-600 text-white font-black rounded-xl hover:from-emerald-600 hover:to-green-700 shadow-lg shadow-emerald-500/30 transition' }
            ]);
            setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 50);
        },

        saveNewIncome() {
            const posId = document.getElementById('incomePosId')?.value;
            const category = document.getElementById('incomeCategoryValue')?.value || 'vente';
            const amount = parseFloat(document.getElementById('incomeAmount')?.value) || 0;
            const description = document.getElementById('incomeDescription')?.value?.trim() || '';
            const method = document.getElementById('incomeMethod')?.value || 'cash';
            const reference = document.getElementById('incomeReference')?.value?.trim() || '';

            if (!posId) return UI.toast('Sélectionnez un point de vente', 'warning');
            if (amount <= 0) return UI.toast('Montant invalide', 'warning');

            const categoryLabels = {
                'vente': 'Vente directe',
                'depot_caisse': 'Dépôt en caisse',
                'service': 'Service rendu',
                'remboursement_fournisseur': 'Remboursement fournisseur',
                'investissement': 'Investissement/Capital',
                'pret_recu': 'Prêt reçu',
                'depot_livreur': 'Dépôt livreur',
                'commission_recue': 'Commission reçue',
                'location': 'Revenus location',
                'autre_revenu': 'Autre revenu'
            };

            const tx = {
                id: CORE.generateId(),
                type: 'income',
                category: category,
                amount: amount,
                method: method,
                description: description || categoryLabels[category] || category,
                note: `[${categoryLabels[category] || category}]${description ? ' ' + description : ''}`,
                reference: reference,
                posId: posId,
                date: new Date().toISOString(),
                createdAt: new Date().toISOString(),
                createdBy: App.currentUser?.id,
                userName: App.currentUser?.name || 'PDG'
            };

            CORE.db.financialTransactions = CORE.db.financialTransactions || [];
            CORE.db.financialTransactions.push(tx);
            CORE.logAudit('create', 'income', tx.id, categoryLabels[category] || category, { description: `Revenu PDG: ${CORE.formatPrice(amount)} - ${categoryLabels[category] || category}`, amount });
            CORE.save();
            UI.closeModal();
            UI.toast('✅ Revenu de ' + CORE.formatPrice(amount) + ' enregistré', 'success');
            App.rerender();
        },

        markCODCollected(orderId) {
            const o = CORE.getVisibleOrders().find(x => x.id === orderId);
            if (!o) return;
            if (o.paymentMethod !== 'cod') return UI.toast('Ce n’est pas une commande COD', 'warning');
            const updated = CORE.update('orders', o.id, { paymentStatus: 'paid' });
            CORE.ensureSaleTransaction(updated);
            UI.toast('COD marqué comme encaissé', 'success');
            App.rerender();
        },

        markTransactionSettled(txId) {
            const tx = CORE.getVisibleTransactions().find(t => t.id === txId);
            if (!tx) return;
            if (tx.settled) return UI.toast('Déjà réglé', 'info');
            CORE.update('financialTransactions', tx.id, { settled: true, settledAt: new Date().toISOString() });
            UI.toast('Transaction réglée', 'success');
            App.rerender();
        },

        renderFinance() {
            const tab = this.state.financeTab;
            const summary = this.getFinanceSummary();
            const txs = this.getTransactionsFiltered();
            const cod = this.getCODOutstanding();
            const commissions = this.getCommissionsDue();
            const scope = this.getFinanceScope();

            const cityOptions = [{value:'',label:'Toutes villes'}, ...CORE.db.cities.map(c=>({value:c.id,label:c.name}))];
            const posOptions = [{value:'',label:'Tous POS'}, ...(CORE.db.pointsOfSale || []).map(p=>({value:p.id,label:p.name}))];

            const categories = [
                { value:'all', label:'Toutes catégories' },
                { value:'sale', label:'Ventes' },
                { value:'expense', label:'Dépenses' },
                { value:'commission', label:'Commissions' }
            ];
            const methods = [
                { value:'all', label:'Toutes méthodes' },
                { value:'cash', label:'Cash' },
                { value:'mobile', label:'Mobile Money' },
                { value:'cod', label:'Paiement à la livraison' },
                { value:'internal', label:'Interne' }
            ];

            // Calculer les données pour le graphique cash-flow
            const cashFlowData = this.getCashFlowLast7Days ? this.getCashFlowLast7Days() : [];

            // Top dépenses par catégorie
            const expenseByCategory = {};
            txs.filter(t => t.type === 'expense').forEach(t => {
                const cat = t.category || 'autre';
                expenseByCategory[cat] = (expenseByCategory[cat] || 0) + (t.amount || 0);
            });
            const topExpenseCategories = Object.entries(expenseByCategory).sort((a, b) => b[1] - a[1]).slice(0, 5);

            // Répartition par méthode de paiement
            const paymentMethods = {
                cash: summary.cash || 0,
                mobile: summary.mobile || 0,
                cod: summary.cod || 0,
                card: summary.card || 0
            };
            const totalPayments = Object.values(paymentMethods).reduce((a, b) => a + b, 0) || 1;

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <!-- Header avec gradient et navigation -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900 flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                                    <i data-lucide="wallet" class="w-6 h-6"></i>
                                </div>
                                Finance Command Center
                            </h2>
                            <p class="text-slate-500 font-medium mt-2">Vue globale: encaissements, COD, commissions, dépenses & journal</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="PDGModule.showNewExpenseModal()" class="px-4 py-2.5 bg-red-500 text-white font-black rounded-xl hover:bg-red-600 transition flex items-center gap-2">
                                <i data-lucide="minus-circle" class="w-4 h-4"></i> Nouvelle dépense
                            </button>
                            <button onclick="PDGModule.showNewIncomeModal()" class="px-4 py-2.5 bg-emerald-500 text-white font-black rounded-xl hover:bg-emerald-600 transition flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> Nouveau revenu
                            </button>
                            <button onclick="PDGModule.exportFinanceCSV()" class="px-4 py-2.5 bg-white border border-slate-200 text-slate-700 font-black rounded-xl hover:bg-slate-50 transition flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> Exporter
                            </button>
                        </div>
                    </div>

                    <!-- KPIs Principaux avec gradients -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-5 text-white shadow-lg shadow-emerald-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-up" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Encaissements</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(summary.income)}</div>
                                <div class="text-xs opacity-70 mt-2">Cash ${CORE.formatPrice(summary.cash)} • Mobile ${CORE.formatPrice(summary.mobile)}</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl p-5 text-white shadow-lg shadow-red-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="trending-down" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Dépenses</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(summary.expense)}</div>
                                <div class="text-xs opacity-70 mt-2">Inclut commissions & charges</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-5 text-white shadow-lg shadow-blue-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="bar-chart-3" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">Bénéfice Net</span>
                                </div>
                                <div class="text-3xl font-black">${summary.net >= 0 ? '+' : ''}${CORE.formatPrice(summary.net)}</div>
                                <div class="text-xs opacity-70 mt-2">Encaissements - dépenses</div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-5 text-white shadow-lg shadow-amber-500/30 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -mr-8 -mt-8"></div>
                            <div class="relative">
                                <div class="flex items-center gap-2 mb-3">
                                    <i data-lucide="truck" class="w-5 h-5 opacity-80"></i>
                                    <span class="text-xs font-bold uppercase tracking-wider opacity-80">COD à encaisser</span>
                                </div>
                                <div class="text-3xl font-black">${CORE.formatPrice(cod.amount)}</div>
                                <div class="text-xs opacity-70 mt-2">${cod.count} commande(s) en attente</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <div class="flex flex-wrap gap-2">
                                <button onclick="PDGModule.state.financeTab='overview';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='overview'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Vue</button>
                                <button onclick="PDGModule.state.financeTab='transactions';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='transactions'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Journal</button>
                                <button onclick="PDGModule.state.financeTab='cod';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='cod'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">COD</button>
                                <button onclick="PDGModule.state.financeTab='commissions';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab==='commissions'?'bg-slate-900 text-white':'bg-slate-100 text-slate-700 hover:bg-slate-200'}">Commissions</button>
                            </div>

                            <div class="flex flex-wrap gap-2">
                                <select onchange="PDGModule.state.financeCityId=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${cityOptions.map(o => `<option value="${o.value}" ${String(o.value)===String(this.state.financeCityId)?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                                <select onchange="PDGModule.state.financePosId=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${posOptions.map(o => `<option value="${o.value}" ${String(o.value)===String(this.state.financePosId)?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                                <input type="date" value="${this.state.financeFrom ? this.formatDateForInput(this.state.financeFrom) : ''}" onchange="PDGModule.state.financeFrom=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                                <input type="date" value="${this.state.financeTo ? this.formatDateForInput(this.state.financeTo) : ''}" onchange="PDGModule.state.financeTo=this.value;App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white font-bold">
                            </div>
                        </div>

                        ${tab === 'overview' ? `
                            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <!-- Colonne gauche: Commissions + Répartition paiements -->
                                <div class="lg:col-span-2 space-y-6">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="bg-slate-50 border border-slate-200 rounded-3xl p-5">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Commissions à payer</div>
                                                    <div class="mt-2 text-2xl font-black text-red-600">${CORE.formatPrice(commissions.dueAmount)}</div>
                                                    <div class="text-xs text-slate-500">${commissions.dueCount} course(s)</div>
                                                </div>
                                                <div class="w-12 h-12 bg-red-100 rounded-2xl flex items-center justify-center text-red-600"><i data-lucide="hand-coins" class="w-6 h-6"></i></div>
                                            </div>
                                        </div>
                                        <div class="bg-slate-50 border border-slate-200 rounded-3xl p-5">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <div class="text-xs font-black text-slate-500 uppercase tracking-wider">Transactions</div>
                                                    <div class="mt-2 text-2xl font-black text-slate-900">${txs.length}</div>
                                                    <div class="text-xs text-slate-500">Périmètre: ${scope.cityId ? CORE.getCity(scope.cityId)?.name : 'Global'}</div>
                                                </div>
                                                <div class="w-12 h-12 bg-slate-200 rounded-2xl flex items-center justify-center text-slate-700"><i data-lucide="list" class="w-6 h-6"></i></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Répartition par méthode de paiement -->
                                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                        <h3 class="text-lg font-black text-slate-900 flex items-center gap-2 mb-6">
                                            <i data-lucide="credit-card" class="w-5 h-5 text-blue-500"></i>
                                            Répartition par Méthode de Paiement
                                        </h3>
                                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                            <div class="text-center p-4 bg-slate-50 rounded-xl">
                                                <div class="w-12 h-12 bg-slate-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                                    <i data-lucide="banknote" class="w-6 h-6 text-slate-600"></i>
                                                </div>
                                                <div class="text-lg font-black text-slate-900">${CORE.formatPrice(paymentMethods.cash)}</div>
                                                <div class="text-xs text-slate-500 font-bold">Cash</div>
                                                <div class="text-[10px] text-slate-400">${Math.round((paymentMethods.cash / totalPayments) * 100)}%</div>
                                            </div>
                                            <div class="text-center p-4 bg-blue-50 rounded-xl">
                                                <div class="w-12 h-12 bg-blue-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                                    <i data-lucide="smartphone" class="w-6 h-6 text-blue-600"></i>
                                                </div>
                                                <div class="text-lg font-black text-blue-900">${CORE.formatPrice(paymentMethods.mobile)}</div>
                                                <div class="text-xs text-blue-700 font-bold">Mobile Money</div>
                                                <div class="text-[10px] text-blue-500">${Math.round((paymentMethods.mobile / totalPayments) * 100)}%</div>
                                            </div>
                                            <div class="text-center p-4 bg-amber-50 rounded-xl">
                                                <div class="w-12 h-12 bg-amber-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                                    <i data-lucide="truck" class="w-6 h-6 text-amber-600"></i>
                                                </div>
                                                <div class="text-lg font-black text-amber-900">${CORE.formatPrice(paymentMethods.cod)}</div>
                                                <div class="text-xs text-amber-700 font-bold">COD</div>
                                                <div class="text-[10px] text-amber-500">${Math.round((paymentMethods.cod / totalPayments) * 100)}%</div>
                                            </div>
                                            <div class="text-center p-4 bg-indigo-50 rounded-xl">
                                                <div class="w-12 h-12 bg-indigo-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                                    <i data-lucide="credit-card" class="w-6 h-6 text-indigo-600"></i>
                                                </div>
                                                <div class="text-lg font-black text-indigo-900">${CORE.formatPrice(paymentMethods.card || 0)}</div>
                                                <div class="text-xs text-indigo-700 font-bold">Carte</div>
                                                <div class="text-[10px] text-indigo-500">${Math.round(((paymentMethods.card || 0) / totalPayments) * 100)}%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Colonne droite: Actions rapides + Top dépenses -->
                                <div class="space-y-6">
                                    <!-- Actions rapides -->
                                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 text-white">
                                        <h3 class="text-lg font-black mb-4 flex items-center gap-2">
                                            <i data-lucide="zap" class="w-5 h-5 text-amber-400"></i>
                                            Actions Rapides
                                        </h3>
                                        <div class="space-y-3">
                                            <button onclick="PDGModule.showNewExpenseModal()" class="w-full px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                                <i data-lucide="minus-circle" class="w-5 h-5"></i>
                                                Enregistrer une dépense
                                            </button>
                                            <button onclick="PDGModule.state.financeTab='cod';App.rerender()" class="w-full px-4 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                                <i data-lucide="truck" class="w-5 h-5"></i>
                                                Gérer COD en attente
                                            </button>
                                            <button onclick="PDGModule.state.financeTab='commissions';App.rerender()" class="w-full px-4 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-xl font-bold text-sm transition flex items-center gap-3">
                                                <i data-lucide="hand-coins" class="w-5 h-5"></i>
                                                Payer commissions
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Top dépenses par catégorie -->
                                    <div class="bg-white rounded-2xl border border-slate-200 p-6 shadow-sm">
                                        <h3 class="text-lg font-black text-slate-900 flex items-center gap-2 mb-4">
                                            <i data-lucide="pie-chart" class="w-5 h-5 text-red-500"></i>
                                            Top Dépenses
                                        </h3>
                                        ${topExpenseCategories.length === 0 ? '<div class="text-center py-4 text-slate-400 text-sm">Aucune dépense enregistrée</div>' :
                                            '<div class="space-y-3">' + topExpenseCategories.map(([cat, amount], i) => {
                                                const colors = ['bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-yellow-500', 'bg-lime-500'];
                                                const maxAmount = topExpenseCategories[0][1] || 1;
                                                return '<div class="flex items-center gap-3"><div class="w-8 h-8 ' + colors[i] + ' rounded-lg flex items-center justify-center text-white text-xs font-black">' + (i + 1) + '</div><div class="flex-1"><div class="flex justify-between mb-1"><span class="text-sm font-bold text-slate-700 capitalize">' + cat + '</span><span class="text-sm font-black text-red-600">' + CORE.formatPrice(amount) + '</span></div><div class="h-2 bg-slate-100 rounded-full overflow-hidden"><div class="' + colors[i] + ' h-full rounded-full" style="width: ' + ((amount / maxAmount) * 100) + '%"></div></div></div></div>';
                                            }).join('') + '</div>'
                                        }
                                        <button onclick="PDGModule.state.financeTab='transactions';PDGModule.state.financeType='expense';App.rerender()" class="w-full mt-4 px-4 py-2 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm hover:bg-slate-200 transition">
                                            Voir toutes les dépenses →
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${tab === 'transactions' ? `
                            <div class="p-4 border-t border-slate-100 flex flex-wrap gap-2 items-center">
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input id="pdg-finance-search-input" type="text" value="${this.state.financeSearch}" onkeyup="PDGModule.updateFinanceSearch(this.value)" placeholder="Recherche (ref, note, montant...)" class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium w-[280px] max-w-full" style="direction: ltr; text-align: left;" autocomplete="off">
                                </div>
                                <select onchange="PDGModule.state.financeType=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${[
                                        {value:'all',label:'Tous types'},
                                        {value:'income',label:'Encaissements'},
                                        {value:'expense',label:'Dépenses'}
                                    ].map(o=>`<option value="${o.value}" ${o.value===this.state.financeType?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                                <select onchange="PDGModule.state.financeCategory=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${categories.map(o=>`<option value="${o.value}" ${o.value===this.state.financeCategory?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                                <select onchange="PDGModule.state.financeMethod=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${methods.map(o=>`<option value="${o.value}" ${o.value===this.state.financeMethod?'selected':''}>${o.label}</option>`).join('')}
                                </select>
                            </div>

                            <div class="overflow-auto">
                                <table class="w-full text-left min-w-[1100px]">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">Type</th>
                                            <th class="px-6 py-4">Catégorie</th>
                                            <th class="px-6 py-4 text-right">Montant</th>
                                            <th class="px-6 py-4">Méthode</th>
                                            <th class="px-6 py-4">Référence / Note</th>
                                            <th class="px-6 py-4">Statut</th>
                                            <th class="px-6 py-4 text-right">Date</th>
                                            <th class="px-6 py-4 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${txs.length===0 ? `<tr><td colspan="8" class="px-6 py-12 text-center text-slate-400 font-medium">Aucune transaction</td></tr>` : ''}
                                        ${txs.map(t => {
                                            const amount = CORE.formatPrice(t.amount);
                                            const sign = t.type==='income' ? '+' : '-';
                                            const color = t.type==='income' ? 'text-emerald-600' : 'text-red-600';
                                            const statusBadge = t.settled ? UI.badge('Réglé','emerald') : UI.badge('À régler','amber');
                                            return `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-6 py-4 font-black text-slate-900">${t.type}</td>
                                                <td class="px-6 py-4">${UI.badge(t.category, t.category==='sale'?'emerald':t.category==='commission'?'amber':t.category==='expense'?'red':'slate')}</td>
                                                <td class="px-6 py-4 text-right font-black ${color}">${sign} ${amount}</td>
                                                <td class="px-6 py-4 font-bold">${CORE.paymentMethodLabel(t.method)}</td>
                                                <td class="px-6 py-4">
                                                    <div class="font-black text-slate-900">${t.ref || '—'}</div>
                                                    <div class="text-xs text-slate-500">${t.note || ''}</div>
                                                </td>
                                                <td class="px-6 py-4">${statusBadge}</td>
                                                <td class="px-6 py-4 text-right text-xs text-slate-500">${CORE.formatDate(t.createdAt)}</td>
                                                <td class="px-6 py-4 text-right">
                                                    ${(!t.settled && t.category==='commission') ? `<button onclick="PDGModule.markTransactionSettled(${t.id})" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-black hover:bg-slate-800">Marquer payé</button>` : '<span class="text-xs text-slate-400">—</span>'}
                                                </td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                        ${tab === 'cod' ? `
                            <div class="p-4">
                                <div class="p-4 bg-amber-50 border border-amber-100 rounded-2xl text-sm text-amber-800">
                                    <b>COD à encaisser:</b> commandes en paiement à la livraison dont le paiement n’est pas encore marqué "Payé".
                                </div>
                            </div>
                            <div class="overflow-auto">
                                <table class="w-full text-left min-w-[980px]">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">Réf</th>
                                            <th class="px-6 py-4">Client</th>
                                            <th class="px-6 py-4">POS</th>
                                            <th class="px-6 py-4">Statut cmd</th>
                                            <th class="px-6 py-4">Statut paiement</th>
                                            <th class="px-6 py-4 text-right">Montant</th>
                                            <th class="px-6 py-4 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${cod.orders.length===0 ? `<tr><td colspan="7" class="px-6 py-12 text-center text-slate-400 font-medium">Aucun COD en attente</td></tr>` : ''}
                                        ${cod.orders.map(o => `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-6 py-4 font-black text-slate-900">${o.reference}</td>
                                                <td class="px-6 py-4">
                                                    <div class="font-bold">${o.clientName || '—'}</div>
                                                    <div class="text-xs text-slate-500">${o.clientPhone || ''}</div>
                                                </td>
                                                <td class="px-6 py-4 font-bold">${CORE.getPOS(o.posId)?.name || '—'}</td>
                                                <td class="px-6 py-4">${UI.badge(o.status, o.status==='delivered'?'emerald':o.status==='delivering'?'amber':'slate')}</td>
                                                <td class="px-6 py-4">${UI.badge(CORE.paymentStatusLabel(o.paymentStatus), o.paymentStatus==='paid'?'emerald':'amber')}</td>
                                                <td class="px-6 py-4 text-right font-black text-amber-700">${CORE.formatPrice(o.total)}</td>
                                                <td class="px-6 py-4 text-right">
                                                    <button onclick="PDGModule.markCODCollected(${o.id})" class="px-3 py-2 rounded-xl bg-amber-500 text-white text-xs font-black hover:bg-amber-600">Marquer encaissé</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                        ${tab === 'commissions' ? `
                            <div class="p-4">
                                <div class="p-4 bg-red-50 border border-red-100 rounded-2xl text-sm text-red-800">
                                    <b>Commissions:</b> dépenses de type "commission" (souvent à régler au livreur).
                                </div>
                            </div>
                            <div class="overflow-auto">
                                <table class="w-full text-left min-w-[980px]">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        <tr>
                                            <th class="px-6 py-4">Réf</th>
                                            <th class="px-6 py-4">Livreur</th>
                                            <th class="px-6 py-4">Statut</th>
                                            <th class="px-6 py-4 text-right">Montant</th>
                                            <th class="px-6 py-4 text-right">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${commissions.due.length===0 ? `<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400 font-medium">Aucune commission à payer</td></tr>` : ''}
                                        ${commissions.due.map(t => {
                                            const del = t.deliveryId ? CORE.getVisibleDeliveries().find(d => d.id === t.deliveryId) : null;
                                            const livreur = del?.livreurId ? CORE.getUser(del.livreurId) : null;
                                            return `
                                            <tr class="hover:bg-slate-50">
                                                <td class="px-6 py-4 font-black text-slate-900">${t.ref || '—'}</td>
                                                <td class="px-6 py-4 font-bold">${livreur?.name || '—'}</td>
                                                <td class="px-6 py-4">${UI.badge('À payer','amber')}</td>
                                                <td class="px-6 py-4 text-right font-black text-red-600">${CORE.formatPrice(t.amount)}</td>
                                                <td class="px-6 py-4 text-right"><button onclick="PDGModule.markTransactionSettled(${t.id})" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-black hover:bg-slate-800">Marquer payé</button></td>
                                            </tr>`;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                    </div>
                </div>
            `;
        },

        // ---------- Views
        renderKpiCard(label, value, icon, accent = 'text-indigo-600', bg = 'bg-indigo-50', trend = null, trendValue = null) {
            return `
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm card-hover relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-32 h-32 ${bg} rounded-full -mr-16 -mt-16 opacity-50 group-hover:opacity-75 transition-opacity"></div>
                    <div class="relative">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-14 h-14 ${bg} ${accent} rounded-2xl flex items-center justify-center shadow-sm">
                                <i data-lucide="${icon}" class="w-7 h-7"></i>
                            </div>
                            ${trend ? `
                                <div class="px-2.5 py-1 rounded-lg ${trend === 'up' ? 'bg-emerald-100 text-emerald-700' : trend === 'down' ? 'bg-red-100 text-red-700' : 'bg-slate-100 text-slate-600'} text-xs font-black flex items-center gap-1">
                                    <i data-lucide="${trend === 'up' ? 'trending-up' : trend === 'down' ? 'trending-down' : 'minus'}" class="w-3 h-3"></i>
                                    ${trendValue || ''}
                                </div>
                            ` : ''}
                        </div>
                        <div class="text-3xl font-black text-slate-900 mb-1">${value}</div>
                        <div class="text-sm text-slate-500 font-bold uppercase tracking-wider">${label}</div>
                    </div>
                </div>`;
        },

        // Nouveau: Calculer les tendances réelles basées sur les données
        calculateTrends() {
            const today = new Date();
            const todayStr = today.toDateString();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toDateString();

            // CA aujourd'hui vs hier
            const todayOrders = CORE.getVisibleOrders().filter(o => o.status === 'delivered' && o.createdAt && new Date(o.createdAt).toDateString() === todayStr);
            const yesterdayOrders = CORE.getVisibleOrders().filter(o => o.status === 'delivered' && o.createdAt && new Date(o.createdAt).toDateString() === yesterdayStr);
            const todayRevenue = todayOrders.reduce((a, o) => a + (o.total || 0), 0);
            const yesterdayRevenue = yesterdayOrders.reduce((a, o) => a + (o.total || 0), 0);

            // Commandes aujourd'hui vs hier
            const todayOrdersCount = CORE.getVisibleOrders().filter(o => o.createdAt && new Date(o.createdAt).toDateString() === todayStr).length;
            const yesterdayOrdersCount = CORE.getVisibleOrders().filter(o => o.createdAt && new Date(o.createdAt).toDateString() === yesterdayStr).length;

            // Calcul des 7 derniers jours de CA
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                const dayOrders = CORE.getVisibleOrders().filter(o => o.status === 'delivered' && o.createdAt && new Date(o.createdAt).toDateString() === d.toDateString());
                last7Days.push({
                    date: d,
                    day: ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'][d.getDay()],
                    revenue: dayOrders.reduce((a, o) => a + (o.total || 0), 0),
                    count: dayOrders.length
                });
            }

            const calculateChange = (current, previous) => {
                if (previous === 0) return current > 0 ? { trend: 'up', value: '+100%' } : { trend: 'neutral', value: '0%' };
                const change = ((current - previous) / previous * 100).toFixed(1);
                return {
                    trend: change > 0 ? 'up' : change < 0 ? 'down' : 'neutral',
                    value: `${change > 0 ? '+' : ''}${change}%`
                };
            };

            return {
                revenue: calculateChange(todayRevenue, yesterdayRevenue),
                orders: calculateChange(todayOrdersCount, yesterdayOrdersCount),
                todayRevenue,
                todayOrdersCount,
                last7Days,
                avgDaily: last7Days.reduce((a, d) => a + d.revenue, 0) / 7
            };
        },

        // Nouveau: Santé du système
        getSystemHealth() {
            const metrics = [];
            const products = CORE.getVisibleProducts() || [];
            const orders = CORE.getVisibleOrders() || [];
            const users = CORE.getVisibleUsers() || [];
            const deliveries = CORE.getVisibleDeliveries() || [];

            // Stock santé
            const lowStock = products.filter(p => p.stock <= p.minStock).length;
            const outOfStock = products.filter(p => p.stock === 0).length;
            const stockHealth = products.length > 0 ? Math.round(((products.length - lowStock) / products.length) * 100) : 100;
            metrics.push({ label: 'Stock', value: stockHealth, color: stockHealth > 80 ? 'emerald' : stockHealth > 50 ? 'amber' : 'red', icon: 'package', detail: `${lowStock} alertes, ${outOfStock} ruptures` });

            // Livraisons santé
            const problematicDeliveries = deliveries.filter(d => d.status === 'probleme').length;
            const pendingDeliveries = deliveries.filter(d => d.status === 'en_attente').length;
            const totalActiveDeliveries = deliveries.filter(d => !['livree', 'annulee'].includes(d.status)).length;
            const deliveryHealth = totalActiveDeliveries > 0 ? Math.round(((totalActiveDeliveries - problematicDeliveries) / totalActiveDeliveries) * 100) : 100;
            metrics.push({ label: 'Livraisons', value: deliveryHealth, color: deliveryHealth > 80 ? 'emerald' : deliveryHealth > 50 ? 'amber' : 'red', icon: 'truck', detail: `${pendingDeliveries} en attente, ${problematicDeliveries} problèmes` });

            // Utilisateurs actifs
            const activeUsers = users.filter(u => u.active).length;
            const userHealth = users.length > 0 ? Math.round((activeUsers / users.length) * 100) : 100;
            metrics.push({ label: 'Équipe', value: userHealth, color: userHealth > 80 ? 'emerald' : userHealth > 50 ? 'amber' : 'red', icon: 'users', detail: `${activeUsers}/${users.length} actifs` });

            // Taux de conversion commandes livrées
            const deliveredOrders = orders.filter(o => o.status === 'delivered').length;
            const conversionRate = orders.length > 0 ? Math.round((deliveredOrders / orders.length) * 100) : 100;
            metrics.push({ label: 'Conversion', value: conversionRate, color: conversionRate > 70 ? 'emerald' : conversionRate > 40 ? 'amber' : 'red', icon: 'target', detail: `${deliveredOrders}/${orders.length} livrées` });

            const avgHealth = Math.round(metrics.reduce((a, m) => a + m.value, 0) / metrics.length);

            return { metrics, avgHealth };
        },

        renderOverview() {
            const k = this.getKpis();
            const cityStats = this.cityStats();
            const pendingDeleteRequests = this.getPendingPOSRequests();
            const trends = this.calculateTrends();
            const systemHealth = this.getSystemHealth();

            // Alertes urgentes
            const criticalAlerts = [];
            if (k.stockAlerts > 0) criticalAlerts.push({ type: 'stock', count: k.stockAlerts, color: 'red', icon: 'alert-circle', msg: `${k.stockAlerts} article(s) en stock critique`, action: "PDGModule.navigateTo('stock')" });
            if (k.pendingOrders > 0) criticalAlerts.push({ type: 'orders', count: k.pendingOrders, color: 'amber', icon: 'clock', msg: `${k.pendingOrders} commandes en attente`, action: "PDGModule.navigateTo('orders')" });
            if (k.deliveriesToAssign > 0) criticalAlerts.push({ type: 'deliveries', count: k.deliveriesToAssign, color: 'blue', icon: 'user-plus', msg: `${k.deliveriesToAssign} livraisons à assigner`, action: "PDGModule.navigateTo('deliveries')" });
            const inactiveUsers = CORE.getVisibleUsers().filter(u => !u.active).length;
            if (inactiveUsers > 0) criticalAlerts.push({ type: 'users', count: inactiveUsers, color: 'slate', icon: 'user-x', msg: `${inactiveUsers} utilisateur(s) inactif(s)`, action: "PDGModule.navigateTo('team')" });

            const topPOS = (CORE.db.pointsOfSale || []).map(p => {
                const orders = CORE.getVisibleOrders().filter(o => o.posId === p.id);
                const delivered = orders.filter(o => o.status === 'delivered');
                const revenue = delivered.reduce((a,o)=>a+(o.total||0),0);
                const avgTicket = delivered.length > 0 ? revenue / delivered.length : 0;
                return { pos: p, revenue, orders: orders.length, delivered: delivered.length, avgTicket };
            }).sort((a,b)=>b.revenue-a.revenue).slice(0,5);

            const lastOrders = [...CORE.getVisibleOrders()].sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).slice(0,5);
            const lastDeliveries = [...CORE.getVisibleDeliveries()].sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).slice(0,5);

            // Statistiques utilisateurs
            const activeUsers = CORE.getVisibleUsers().filter(u => u.active).length;
            const totalUsers = CORE.getVisibleUsers().length;

            // Répartition des commandes par statut
            const ordersByStatus = {
                delivered: CORE.getVisibleOrders().filter(o => o.status === 'delivered').length,
                pending: CORE.getVisibleOrders().filter(o => o.status === 'pending').length,
                confirmed: CORE.getVisibleOrders().filter(o => o.status === 'confirmed').length,
                cancelled: CORE.getVisibleOrders().filter(o => o.status === 'cancelled').length
            };
            const totalOrdersForChart = Object.values(ordersByStatus).reduce((a,b)=>a+b,0) || 1;

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <!-- HEADER AVEC DATE ET REFRESH -->
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h1 class="text-3xl font-black text-slate-900">Tableau de Bord PDG</h1>
                            <p class="text-slate-500 font-medium mt-1">
                                <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>
                                ${new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                <span class="ml-2 text-xs text-slate-400">${new Date().toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'})}</span>
                            </p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="px-3 py-1.5 rounded-full bg-emerald-50 text-emerald-700 text-xs font-black flex items-center gap-1">
                                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span> Temps réel
                            </div>
                            <button onclick="App.rerender()" class="px-4 py-2.5 bg-slate-100 text-slate-700 rounded-xl font-bold hover:bg-slate-200 transition flex items-center gap-2">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Actualiser
                            </button>
                            <button onclick="PDGModule.navigateTo('settings')" class="px-4 py-2.5 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition flex items-center gap-2">
                                <i data-lucide="settings" class="w-4 h-4"></i> Paramètres
                            </button>
                        </div>
                    </div>

                    ${pendingDeleteRequests.length > 0 ? `
                        <div class="p-5 rounded-3xl border-2 border-amber-300 bg-gradient-to-r from-amber-50 to-orange-50 shadow-sm">
                            <div class="flex items-center justify-between flex-wrap gap-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-14 h-14 bg-amber-100 rounded-2xl flex items-center justify-center text-amber-600 shadow-sm">
                                        <i data-lucide="bell-ring" class="w-7 h-7"></i>
                                    </div>
                                    <div>
                                        <div class="font-black text-amber-900 text-lg">Demandes d'approbation en attente</div>
                                        <div class="text-sm text-amber-800">${pendingDeleteRequests.length} demande(s) de POS requièrent votre attention</div>
                                    </div>
                                </div>
                                <button onclick="UI.modal('Demandes de POS', PDGModule.renderApprovalsModal(), [{label:'Fermer', onclick:'UI.closeModal()'}])" class="px-5 py-3 bg-amber-600 text-white font-black rounded-xl hover:bg-amber-700 transition shadow-sm flex items-center gap-2">
                                    <i data-lucide="eye" class="w-4 h-4"></i> Voir demandes
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    <!-- === PENDING EMPLOYEES BANNER (auto-loaded) === -->
                    ${(App._pendingEmployeeTotal || 0) > 0 ? `
                        <div class="p-5 rounded-3xl border-2 border-purple-300 bg-gradient-to-r from-purple-50 to-violet-50 shadow-sm animate-pulse-slow">
                            <div class="flex items-center justify-between flex-wrap gap-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-14 h-14 bg-purple-100 rounded-2xl flex items-center justify-center text-purple-600 shadow-sm">
                                        <i data-lucide="user-plus" class="w-7 h-7"></i>
                                    </div>
                                    <div>
                                        <div class="font-black text-purple-900 text-lg">👥 ${App._pendingEmployeeTotal} employé(s) en attente de validation</div>
                                        <div class="text-sm text-purple-700">Des employés ont utilisé un code d'invitation et attendent votre approbation</div>
                                    </div>
                                </div>
                                <button onclick="PDGModule._invitationTab='pending'; PDGModule.showInviteEmployeeModal ? PDGModule.showInviteEmployeeModal() : PDGModule.loadInvitationData();" class="px-5 py-3 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition shadow-sm flex items-center gap-2">
                                    <i data-lucide="check-circle" class="w-4 h-4"></i> Valider les demandes
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    <!-- === ALERTES STOCK CRITIQUES (STICKY BANNER) === -->
                    ${k.outOfStock > 0 || k.stockAlerts > 0 ? `
                        <div class="p-4 rounded-2xl border-2 ${k.outOfStock > 0 ? 'border-red-400 bg-gradient-to-r from-red-50 to-red-100' : 'border-amber-300 bg-gradient-to-r from-amber-50 to-yellow-50'} shadow-sm">
                            <div class="flex items-center justify-between flex-wrap gap-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 ${k.outOfStock > 0 ? 'bg-red-200 text-red-700' : 'bg-amber-200 text-amber-700'} rounded-xl flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                                    </div>
                                    <div>
                                        <div class="font-black ${k.outOfStock > 0 ? 'text-red-900' : 'text-amber-900'}">
                                            ${k.outOfStock > 0 ? k.outOfStock + ' RUPTURE(S) DE STOCK' : ''}
                                            ${k.outOfStock > 0 && k.stockAlerts > k.outOfStock ? ' + ' : ''}
                                            ${k.stockAlerts > k.outOfStock ? (k.stockAlerts - k.outOfStock) + ' article(s) en stock critique' : ''}
                                        </div>
                                        <div class="text-xs ${k.outOfStock > 0 ? 'text-red-700' : 'text-amber-700'} mt-1 flex flex-wrap gap-1">
                                            ${k.criticalProducts.slice(0,5).map(p => '<span class=\"px-2 py-0.5 rounded-full ' + ((p.stock||0)===0 ? 'bg-red-200 text-red-800' : 'bg-amber-200 text-amber-800') + ' text-xs font-bold\">' + p.name + ' (' + (p.stock||0) + ')</span>').join('')}
                                            ${k.criticalProducts.length > 5 ? '<span class=\"text-xs font-bold\">+' + (k.criticalProducts.length-5) + ' autres</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                                <button onclick="PDGModule.navigateTo('stock')" class="px-4 py-2 ${k.outOfStock > 0 ? 'bg-red-600 hover:bg-red-700' : 'bg-amber-600 hover:bg-amber-700'} text-white font-black rounded-xl transition flex items-center gap-2 text-sm">
                                    <i data-lucide="package" class="w-4 h-4"></i> Gérer le stock
                                </button>
                            </div>
                        </div>
                    ` : ''}

                    <!-- ALERTES CRITIQUES -->
                    ${criticalAlerts.length > 0 ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            ${criticalAlerts.map(alert => `
                                <button onclick="${alert.action}" class="p-4 rounded-2xl border-2 border-${alert.color}-300 bg-gradient-to-br from-${alert.color}-50 to-${alert.color}-100 flex items-center gap-3 hover:shadow-md transition-all hover:scale-[1.02] text-left w-full">
                                    <div class="w-12 h-12 bg-${alert.color}-200 rounded-xl flex items-center justify-center flex-shrink-0 shadow-sm">
                                        <i data-lucide="${alert.icon}" class="w-6 h-6 text-${alert.color}-700"></i>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-black text-${alert.color}-900 text-sm truncate">${alert.msg}</div>
                                        <div class="text-xs text-${alert.color}-700 flex items-center gap-1 mt-0.5">
                                            <i data-lucide="arrow-right" class="w-3 h-3"></i> Cliquer pour voir
                                        </div>
                                    </div>
                                </button>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- === CA AUJOURD'HUI — TEMPS RÉEL === -->
                    <div class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_20%_50%,rgba(255,255,255,0.1),transparent_50%)]"></div>
                        <div class="relative">
                            <div class="flex items-center gap-2 mb-4">
                                <span class="w-2.5 h-2.5 rounded-full bg-emerald-400 animate-pulse"></span>
                                <span class="text-sm font-bold text-white/80 uppercase tracking-wider">Performance Aujourd'hui</span>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                                <div>
                                    <div class="text-xs text-white/60 font-bold uppercase">CA du jour</div>
                                    <div class="text-3xl font-black">${CORE.formatPrice(k.todayCA)}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-white/60 font-bold uppercase">Commandes</div>
                                    <div class="text-3xl font-black">${k.todayOrdersCount}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-white/60 font-bold uppercase">Marge brute</div>
                                    <div class="text-3xl font-black">${CORE.formatPrice(Math.round(k.todayMargin))}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-white/60 font-bold uppercase">Panier moyen</div>
                                    <div class="text-3xl font-black">${CORE.formatPrice(Math.round(k.todayAvgTicket))}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-white/60 font-bold uppercase">Top produit</div>
                                    <div class="text-lg font-black truncate">${k.topProductToday ? k.topProductToday.name : '—'}</div>
                                    ${k.topProductToday ? '<div class=\"text-xs text-white/70\">' + k.topProductToday.qty + ' vendus • ' + CORE.formatPrice(k.topProductToday.revenue) + '</div>' : ''}
                                </div>
                            </div>
                            <!-- Graphique CA par heure -->
                            <div class="mt-6 flex items-end gap-0.5 h-16">
                                ${k.hourlyCA.map((h,i) => {
                                    const maxCA = Math.max(...k.hourlyCA.map(x=>x.ca), 1);
                                    const pct = Math.max((h.ca / maxCA) * 100, 2);
                                    const currentHour = new Date().getHours();
                                    return '<div class=\"flex-1 rounded-t-sm transition-all ' + (i===currentHour ? 'bg-white' : h.ca > 0 ? 'bg-white/40' : 'bg-white/10') + '\" style=\"height:' + pct + '%\" title=\"' + h.hour + 'h: ' + CORE.formatPrice(h.ca) + ' (' + h.count + ' cmd)\"></div>';
                                }).join('')}
                            </div>
                            <div class="flex justify-between mt-1">
                                <span class="text-[9px] text-white/40">0h</span>
                                <span class="text-[9px] text-white/40">6h</span>
                                <span class="text-[9px] text-white/40">12h</span>
                                <span class="text-[9px] text-white/40">18h</span>
                                <span class="text-[9px] text-white/40">23h</span>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs PRINCIPAUX -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                        ${this.renderKpiCard('CA Total', CORE.formatPrice(k.deliveredRevenue), 'wallet', 'text-emerald-600', 'bg-emerald-50', trends.revenue.trend, trends.revenue.value)}
                        ${this.renderKpiCard('Commandes', k.ordersTotal, 'shopping-cart', 'text-indigo-600', 'bg-indigo-50', trends.orders.trend, trends.orders.value)}
                        ${this.renderKpiCard('Conversion', k.conversionRate + '%', 'target', 'text-cyan-600', 'bg-cyan-50')}
                        ${this.renderKpiCard('Valeur stock', CORE.formatPrice(k.inventoryValue), 'package', 'text-amber-600', 'bg-amber-50')}
                        ${this.renderKpiCard('Points de vente', CORE.db.pointsOfSale?.length || 0, 'store', 'text-violet-600', 'bg-violet-50')}
                    </div>

                    <!-- SANTÉ DU SYSTÈME -->
                    <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-3xl p-6 text-white shadow-xl">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                            <div>
                                <h3 class="text-xl font-black flex items-center gap-2">
                                    <i data-lucide="activity" class="w-6 h-6 text-emerald-400"></i>
                                    Santé du Système
                                </h3>
                                <p class="text-slate-400 text-sm">Vue d'ensemble de la performance opérationnelle</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="text-right">
                                    <div class="text-4xl font-black ${systemHealth.avgHealth > 80 ? 'text-emerald-400' : systemHealth.avgHealth > 50 ? 'text-amber-400' : 'text-red-400'}">${systemHealth.avgHealth}%</div>
                                    <div class="text-xs text-slate-400 uppercase tracking-wider">Score Global</div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            ${systemHealth.metrics.map(m => `
                                <div class="bg-slate-800/50 backdrop-blur rounded-2xl p-4 border border-slate-700">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="w-10 h-10 bg-${m.color}-500/20 rounded-xl flex items-center justify-center">
                                            <i data-lucide="${m.icon}" class="w-5 h-5 text-${m.color}-400"></i>
                                        </div>
                                        <div class="font-black text-white">${m.label}</div>
                                    </div>
                                    <div class="relative h-2 bg-slate-700 rounded-full overflow-hidden mb-2">
                                        <div class="absolute inset-y-0 left-0 bg-gradient-to-r from-${m.color}-500 to-${m.color}-400 rounded-full transition-all" style="width: ${m.value}%"></div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs text-slate-400">${m.detail}</span>
                                        <span class="text-sm font-black text-${m.color}-400">${m.value}%</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- ACTIONS RAPIDES -->
                    <section class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-black text-slate-900 flex items-center gap-2">
                                <i data-lucide="zap" class="w-5 h-5 text-amber-500"></i> Actions rapides
                            </h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Gestion POS -->
                            <button onclick="PDGModule.showPOSModal()" class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all hover:scale-[1.02] text-left text-white group">
                                <div class="w-12 h-12 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                    <i data-lucide="store" class="w-6 h-6"></i>
                                </div>
                                <div class="font-black text-lg">Gestion POS</div>
                                <div class="text-indigo-200 text-sm mt-1">Gérer les points de vente</div>
                                <div class="mt-4 flex items-end justify-between">
                                    <div class="text-3xl font-black">${CORE.db.pointsOfSale?.length || 0}</div>
                                    <i data-lucide="arrow-right" class="w-5 h-5 opacity-50 group-hover:opacity-100 group-hover:translate-x-1 transition-all"></i>
                                </div>
                            </button>

                            <!-- Finances -->
                            <button onclick="PDGModule.navigateTo('finance')" class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all hover:scale-[1.02] text-left text-white group">
                                <div class="w-12 h-12 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                    <i data-lucide="wallet" class="w-6 h-6"></i>
                                </div>
                                <div class="font-black text-lg">Finances</div>
                                <div class="text-emerald-200 text-sm mt-1">Vue financière complète</div>
                                <div class="mt-4 flex items-end justify-between">
                                    <div class="text-2xl font-black">${CORE.formatPrice(k.deliveredRevenue)}</div>
                                    <i data-lucide="arrow-right" class="w-5 h-5 opacity-50 group-hover:opacity-100 group-hover:translate-x-1 transition-all"></i>
                                </div>
                            </button>

                            <!-- Équipe -->
                            <button onclick="PDGModule.navigateTo('team')" class="bg-gradient-to-br from-violet-500 to-violet-600 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all hover:scale-[1.02] text-left text-white group">
                                <div class="w-12 h-12 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                    <i data-lucide="users" class="w-6 h-6"></i>
                                </div>
                                <div class="font-black text-lg">Équipe</div>
                                <div class="text-violet-200 text-sm mt-1">Gérer les utilisateurs</div>
                                <div class="mt-4 flex items-end justify-between">
                                    <div class="text-3xl font-black">${activeUsers}<span class="text-lg text-violet-200">/${totalUsers}</span></div>
                                    <i data-lucide="arrow-right" class="w-5 h-5 opacity-50 group-hover:opacity-100 group-hover:translate-x-1 transition-all"></i>
                                </div>
                            </button>

                            <!-- Stock -->
                            <button onclick="PDGModule.navigateTo('stock')" class="bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all hover:scale-[1.02] text-left text-white group">
                                <div class="w-12 h-12 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                                    <i data-lucide="package" class="w-6 h-6"></i>
                                </div>
                                <div class="font-black text-lg">Stock Global</div>
                                <div class="text-amber-200 text-sm mt-1">Inventaire et alertes</div>
                                <div class="mt-4 flex items-end justify-between">
                                    <div class="text-3xl font-black">${k.stockAlerts} <span class="text-lg text-amber-200">alertes</span></div>
                                    <i data-lucide="arrow-right" class="w-5 h-5 opacity-50 group-hover:opacity-100 group-hover:translate-x-1 transition-all"></i>
                                </div>
                            </button>
                        </div>
                    </section>

                    <!-- GRAPHIQUES ET STATS -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Graphique CA 7 jours -->
                        <div class="lg:col-span-2 bg-white rounded-3xl border border-slate-200 p-6 shadow-sm">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h3 class="font-black text-slate-900 text-lg">📊 Tendance CA (7 derniers jours)</h3>
                                    <div class="text-sm text-slate-500">Évolution du chiffre d'affaires quotidien</div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="px-3 py-1.5 rounded-full ${trends.revenue.trend === 'up' ? 'bg-emerald-50 text-emerald-700' : trends.revenue.trend === 'down' ? 'bg-red-50 text-red-700' : 'bg-slate-50 text-slate-600'} text-xs font-black flex items-center gap-1">
                                        <i data-lucide="${trends.revenue.trend === 'up' ? 'trending-up' : trends.revenue.trend === 'down' ? 'trending-down' : 'minus'}" class="w-4 h-4"></i>
                                        ${trends.revenue.value}
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-3">
                                ${trends.last7Days.map((d, i) => {
                                    const maxVal = Math.max(...trends.last7Days.map(x => x.revenue), 1);
                                    const percent = (d.revenue / maxVal) * 100;
                                    const isToday = i === trends.last7Days.length - 1;
                                    return `
                                        <div class="flex items-center gap-3 ${isToday ? 'bg-indigo-50 -mx-2 px-2 py-2 rounded-xl' : ''}">
                                            <span class="text-xs font-black ${isToday ? 'text-indigo-700' : 'text-slate-600'} w-10">${d.day}</span>
                                            <div class="flex-1 h-8 bg-slate-100 rounded-lg overflow-hidden relative">
                                                <div class="absolute inset-y-0 left-0 bg-gradient-to-r ${isToday ? 'from-indigo-500 to-indigo-600' : 'from-slate-400 to-slate-500'} rounded-lg transition-all duration-500" style="width: ${percent}%"></div>
                                                <div class="absolute inset-0 flex items-center justify-end pr-3">
                                                    <span class="text-xs font-black ${percent > 50 ? 'text-white' : 'text-slate-700'}">${d.count} cmd</span>
                                                </div>
                                            </div>
                                            <span class="text-sm font-black ${isToday ? 'text-indigo-700' : 'text-slate-900'} w-24 text-right">${CORE.formatPrice(d.revenue)}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-100 flex items-center justify-between">
                                <div class="text-sm text-slate-500">Moyenne journalière</div>
                                <div class="font-black text-slate-900">${CORE.formatPrice(Math.round(trends.avgDaily))}</div>
                            </div>
                        </div>

                        <!-- Répartition des commandes -->
                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-6 border-b border-slate-100">
                                <h3 class="font-black text-slate-900">📦 Répartition commandes</h3>
                                <div class="text-sm text-slate-500">Par statut</div>
                            </div>
                            <div class="p-6">
                                <!-- Donut Chart Visual -->
                                <div class="relative w-40 h-40 mx-auto mb-6">
                                    <svg viewBox="0 0 100 100" class="transform -rotate-90">
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#f1f5f9" stroke-width="12"/>
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#10b981" stroke-width="12"
                                            stroke-dasharray="${(ordersByStatus.delivered / totalOrdersForChart) * 251.2} 251.2" stroke-linecap="round"/>
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#f59e0b" stroke-width="12"
                                            stroke-dasharray="${(ordersByStatus.pending / totalOrdersForChart) * 251.2} 251.2"
                                            stroke-dashoffset="${-(ordersByStatus.delivered / totalOrdersForChart) * 251.2}" stroke-linecap="round"/>
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#6366f1" stroke-width="12"
                                            stroke-dasharray="${(ordersByStatus.confirmed / totalOrdersForChart) * 251.2} 251.2"
                                            stroke-dashoffset="${-((ordersByStatus.delivered + ordersByStatus.pending) / totalOrdersForChart) * 251.2}" stroke-linecap="round"/>
                                        <circle cx="50" cy="50" r="40" fill="none" stroke="#ef4444" stroke-width="12"
                                            stroke-dasharray="${(ordersByStatus.cancelled / totalOrdersForChart) * 251.2} 251.2"
                                            stroke-dashoffset="${-((ordersByStatus.delivered + ordersByStatus.pending + ordersByStatus.confirmed) / totalOrdersForChart) * 251.2}" stroke-linecap="round"/>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center flex-col">
                                        <div class="text-2xl font-black text-slate-900">${k.ordersTotal}</div>
                                        <div class="text-xs text-slate-500">Total</div>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between p-2 rounded-xl hover:bg-slate-50">
                                        <div class="flex items-center gap-2">
                                            <div class="w-3 h-3 rounded-full bg-emerald-500"></div>
                                            <span class="text-sm font-medium text-slate-700">Livrées</span>
                                        </div>
                                        <span class="font-black text-slate-900">${ordersByStatus.delivered}</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 rounded-xl hover:bg-slate-50">
                                        <div class="flex items-center gap-2">
                                            <div class="w-3 h-3 rounded-full bg-amber-500"></div>
                                            <span class="text-sm font-medium text-slate-700">En attente</span>
                                        </div>
                                        <span class="font-black text-slate-900">${ordersByStatus.pending}</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 rounded-xl hover:bg-slate-50">
                                        <div class="flex items-center gap-2">
                                            <div class="w-3 h-3 rounded-full bg-indigo-500"></div>
                                            <span class="text-sm font-medium text-slate-700">Confirmées</span>
                                        </div>
                                        <span class="font-black text-slate-900">${ordersByStatus.confirmed}</span>
                                    </div>
                                    <div class="flex items-center justify-between p-2 rounded-xl hover:bg-slate-50">
                                        <div class="flex items-center gap-2">
                                            <div class="w-3 h-3 rounded-full bg-red-500"></div>
                                            <span class="text-sm font-medium text-slate-700">Annulées</span>
                                        </div>
                                        <span class="font-black text-slate-900">${ordersByStatus.cancelled}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PERFORMANCE PAR VILLE & TOP POS -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                                <div>
                                    <h3 class="font-black text-slate-900">🏙️ Performance par ville</h3>
                                    <p class="text-sm text-slate-500">Classement par chiffre d'affaires</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="PDGModule.navigateTo('finance')" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-xs font-black hover:bg-slate-200 transition">Finances</button>
                                    <button onclick="PDGModule.navigateTo('orders')" class="px-3 py-1.5 rounded-lg bg-indigo-100 text-indigo-700 text-xs font-black hover:bg-indigo-200 transition">Commandes</button>
                                </div>
                            </div>
                            <div class="p-4 space-y-2">
                                ${cityStats.length === 0 ? `<div class="p-8 text-center text-slate-400">Aucune ville configurée</div>` : ''}
                                ${cityStats.map((s, i) => {
                                    const maxRevenue = Math.max(...cityStats.map(x => x.revenue), 1);
                                    const percent = (s.revenue / maxRevenue) * 100;
                                    return `
                                    <div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 transition flex items-center gap-4 group">
                                        <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl flex items-center justify-center font-black text-white text-lg shadow-sm">${i + 1}</div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2">
                                                <div class="font-black text-slate-900">${s.city.name}</div>
                                                <span class="text-xs text-slate-400">${s.posCount} POS</span>
                                            </div>
                                            <div class="mt-1.5 h-2 bg-slate-100 rounded-full overflow-hidden">
                                                <div class="h-full bg-gradient-to-r from-indigo-500 to-indigo-400 rounded-full transition-all" style="width: ${percent}%"></div>
                                            </div>
                                            <div class="text-xs text-slate-500 mt-1">${s.ordersCount} commandes • ${s.deliveriesInProgress} livraisons en cours</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-lg text-slate-900">${CORE.formatPrice(s.revenue)}</div>
                                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">CA Total</div>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                                <div>
                                    <h3 class="font-black text-slate-900">🏆 Top 5 POS</h3>
                                    <p class="text-sm text-slate-500">Meilleurs points de vente</p>
                                </div>
                            </div>
                            <div class="p-4 space-y-2">
                                ${topPOS.length === 0 ? `<div class="p-8 text-center text-slate-400">Aucun POS</div>` : ''}
                                ${topPOS.map((x, i) => `
                                    <button onclick="PDGModule.openPosInventory(${x.pos.id})" class="w-full text-left p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 transition group">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 ${i === 0 ? 'bg-amber-100 text-amber-700' : i === 1 ? 'bg-slate-200 text-slate-700' : i === 2 ? 'bg-orange-100 text-orange-700' : 'bg-slate-100 text-slate-600'} rounded-lg flex items-center justify-center font-black text-sm">
                                                ${i + 1}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="font-black text-slate-900 truncate">${x.pos.name}</div>
                                                <div class="text-xs text-slate-500">${CORE.getCity(x.pos.cityId)?.name || ''} • ${x.delivered}/${x.orders} livrées</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-black text-emerald-600">${CORE.formatPrice(x.revenue)}</div>
                                                <div class="text-[10px] text-slate-400">Moy: ${CORE.formatPrice(Math.round(x.avgTicket))}</div>
                                            </div>
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- DERNIÈRES ACTIVITÉS -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
                                        <i data-lucide="shopping-cart" class="w-5 h-5 text-indigo-600"></i>
                                    </div>
                                    <h3 class="font-black text-slate-900">Dernières commandes</h3>
                                </div>
                                <button onclick="PDGModule.navigateTo('orders')" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-xs font-black hover:bg-slate-200 transition flex items-center gap-1">
                                    Tout voir <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                </button>
                            </div>
                            <div class="divide-y divide-slate-50">
                                ${lastOrders.length === 0 ? `<div class="p-8 text-center text-slate-400">Aucune commande</div>` : ''}
                                ${lastOrders.map(o => `
                                    <button onclick="PDGModule.showOrderDetail(${o.id})" class="w-full text-left p-4 hover:bg-slate-50 flex items-center justify-between transition">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center">
                                                <i data-lucide="receipt" class="w-5 h-5 text-slate-600"></i>
                                            </div>
                                            <div>
                                                <div class="font-black text-slate-900">${o.reference}</div>
                                                <div class="text-xs text-slate-500">${CORE.getPOS(o.posId)?.name || '—'} • ${CORE.formatDate(o.createdAt)}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black">${CORE.formatPrice(o.total)}</div>
                                            ${UI.badge(o.status, o.status==='delivered'?'emerald':o.status==='pending'?'amber':o.status==='cancelled'?'red':'slate')}
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center">
                                        <i data-lucide="truck" class="w-5 h-5 text-amber-600"></i>
                                    </div>
                                    <h3 class="font-black text-slate-900">Dernières livraisons</h3>
                                </div>
                                <button onclick="PDGModule.navigateTo('deliveries')" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-xs font-black hover:bg-slate-200 transition flex items-center gap-1">
                                    Tout voir <i data-lucide="arrow-right" class="w-3 h-3"></i>
                                </button>
                            </div>
                            <div class="divide-y divide-slate-50">
                                ${lastDeliveries.length === 0 ? `<div class="p-8 text-center text-slate-400">Aucune livraison</div>` : ''}
                                ${lastDeliveries.map(d => {
                                    const badge = d.status === 'livree' ? UI.badge('Livrée','emerald') : d.status === 'en_attente' ? UI.badge('À assigner','blue') : d.status === 'probleme' ? UI.badge('Problème','red') : UI.badge('En cours','amber');
                                    return `
                                    <button onclick="PDGModule.showDeliveryDetail(${d.id})" class="w-full text-left p-4 hover:bg-slate-50 flex items-center justify-between transition">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center">
                                                <i data-lucide="package" class="w-5 h-5 text-slate-600"></i>
                                            </div>
                                            <div>
                                                <div class="font-black text-slate-900">${d.orderRef}</div>
                                                <div class="text-xs text-slate-500">${d.clientName} • ${CORE.getUser(d.livreurId)?.name || 'Non assigné'}</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black">${CORE.formatPrice(d.amount)}</div>
                                            ${badge}
                                        </div>
                                    </button>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        renderOrders() {
            const orders = this.getOrdersFiltered();
            const statuses = [
                { value: 'all', label: 'Tous statuts' },
                { value: 'pending', label: 'Pending' },
                { value: 'delivered', label: 'Delivered' },
                { value: 'cancelled', label: 'Cancelled' }
            ];

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">Commandes (Global)</h2>
                            <p class="text-slate-500 font-medium">Recherche, filtre, export et détails.</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="PDGModule.exportOrdersCSV()" class="px-4 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition">Exporter CSV</button>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex flex-col md:flex-row md:items-center gap-3 justify-between">
                            <div class="text-sm font-black text-slate-700">${orders.length} résultat(s)</div>
                            <div class="flex gap-3">
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input id="pdg-orders-search-input" type="text" value="${this.state.ordersSearch}" onkeyup="PDGModule.updateOrdersSearch(this.value)" placeholder="Ref, client, POS..." class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium" style="direction: ltr; text-align: left;" autocomplete="off">
                                </div>
                                <select onchange="PDGModule.state.ordersStatus=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${statuses.map(s => `<option value="${s.value}" ${s.value===this.state.ordersStatus?'selected':''}>${s.label}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="overflow-auto">
                            <table class="w-full text-left min-w-[980px]">
                                <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4">Référence</th>
                                        <th class="px-6 py-4">Client</th>
                                        <th class="px-6 py-4">POS</th>
                                        <th class="px-6 py-4">Ville</th>
                                        <th class="px-6 py-4">Paiement</th>
                                        <th class="px-6 py-4 text-right">Total</th>
                                        <th class="px-6 py-4">Statut</th>
                                        <th class="px-6 py-4">Créée</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${orders.length === 0 ? `<tr><td colspan="8" class="px-6 py-10 text-center text-slate-400">Aucune commande</td></tr>` : ''}
                                    ${orders.map(o => `
                                        <tr class="hover:bg-slate-50 cursor-pointer" onclick="PDGModule.showOrderDetail(${o.id})">
                                            <td class="px-6 py-4 font-black text-slate-900">${o.reference}</td>
                                            <td class="px-6 py-4">
                                                <div class="font-bold text-slate-900">${o.clientName || '—'}</div>
                                                <div class="text-xs text-slate-500">${o.clientPhone || ''}</div>
                                            </td>
                                            <td class="px-6 py-4 font-bold">${CORE.getPOS(o.posId)?.name || '—'}</td>
                                            <td class="px-6 py-4 text-slate-600">${CORE.getCity(o.cityId)?.name || '—'}</td>
                                            <td class="px-6 py-4">
                                                <div class="text-sm font-black">${CORE.paymentMethodLabel(o.paymentMethod)}</div>
                                                <div class="text-xs">${UI.badge(CORE.paymentStatusLabel(o.paymentStatus), o.paymentStatus==='paid'?'emerald':'amber')}</div>
                                            </td>
                                            <td class="px-6 py-4 text-right font-black">${CORE.formatPrice(o.total)}</td>
                                            <td class="px-6 py-4">${UI.badge(o.status, o.status==='delivered'?'emerald':o.status==='pending'?'amber':o.status==='cancelled'?'red':'slate')}</td>
                                            <td class="px-6 py-4 text-xs text-slate-500">${CORE.formatDate(o.createdAt)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        },

        renderDeliveries() {
            const deliveries = this.getDeliveriesFiltered();
            const statuses = [
                { value: 'all', label: 'Tous statuts' },
                { value: 'en_cours', label: 'En cours' },
                { value: 'en_attente', label: 'À assigner' },
                { value: 'livree', label: 'Livrée' },
                { value: 'probleme', label: 'Problème' },
                { value: 'annulee', label: 'Annulée' }
            ];

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">Livraisons (Global)</h2>
                            <p class="text-slate-500 font-medium">Suivi, statuts, rappels, export.</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="PDGModule.exportDeliveriesCSV()" class="px-4 py-2.5 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition">Exporter CSV</button>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 flex flex-col md:flex-row md:items-center gap-3 justify-between">
                            <div class="text-sm font-black text-slate-700">${deliveries.length} résultat(s)</div>
                            <div class="flex gap-3">
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input id="pdg-deliveries-search-input" type="text" value="${this.state.deliveriesSearch}" onkeyup="PDGModule.updateDeliveriesSearch(this.value)" placeholder="Ref, client, livreur..." class="pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium" style="direction: ltr; text-align: left;" autocomplete="off">
                                </div>
                                <select onchange="PDGModule.state.deliveriesStatus=this.value;App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold">
                                    ${statuses.map(s => `<option value="${s.value}" ${s.value===this.state.deliveriesStatus?'selected':''}>${s.label}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="overflow-auto">
                            <table class="w-full text-left min-w-[980px]">
                                <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                    <tr>
                                        <th class="px-6 py-4">Commande</th>
                                        <th class="px-6 py-4">Client</th>
                                        <th class="px-6 py-4">Livreur</th>
                                        <th class="px-6 py-4">Statut</th>
                                        <th class="px-6 py-4 text-right">Montant</th>
                                        <th class="px-6 py-4">Créée</th>
                                        <th class="px-6 py-4">Rappel</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    ${deliveries.length === 0 ? `<tr><td colspan="7" class="px-6 py-10 text-center text-slate-400">Aucune livraison</td></tr>` : ''}
                                    ${deliveries.map(d => {
                                        const badge = d.status === 'livree' ? UI.badge('Livrée','emerald') : d.status === 'en_attente' ? UI.badge('À assigner','blue') : d.status === 'probleme' ? UI.badge('Problème','red') : d.status === 'annulee' ? UI.badge('Annulée','slate') : UI.badge('En cours','amber');
                                        return `
                                        <tr class="hover:bg-slate-50 cursor-pointer" onclick="PDGModule.showDeliveryDetail(${d.id})">
                                            <td class="px-6 py-4 font-black text-slate-900">${d.orderRef}</td>
                                            <td class="px-6 py-4">
                                                <div class="font-bold">${d.clientName || '—'}</div>
                                                <div class="text-xs text-slate-500">${d.address || ''}</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="font-bold">${CORE.getUser(d.livreurId)?.name || '—'}</div>
                                                <div class="text-xs text-slate-500">${CORE.getUser(d.livreurId)?.phone || ''}</div>
                                            </td>
                                            <td class="px-6 py-4">${badge}</td>
                                            <td class="px-6 py-4 text-right font-black">${CORE.formatPrice(d.amount)}</td>
                                            <td class="px-6 py-4 text-xs text-slate-500">${CORE.formatDate(d.createdAt)}</td>
                                            <td class="px-6 py-4 text-xs text-slate-500">${d.recalledAt ? CORE.formatDate(d.recalledAt) : '—'}</td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        },

        renderStock() {
            const products = this.getStockFiltered();
            const stats = this.getStockStats();
            const viewMode = this.state.stockViewMode || 'table';
            const posList = CORE.db.pointsOfSale || [];
            const categories = CORE.db.categories || [];

            const statusOptions = [
                { value: 'all', label: 'Tous les statuts' },
                { value: 'ok', label: '✅ Stock OK' },
                { value: 'low', label: '⚠️ Stock bas' },
                { value: 'out', label: '❌ Rupture' }
            ];

            const sortOptions = [
                { value: 'name', label: 'Nom' },
                { value: 'stock', label: 'Quantité' },
                { value: 'price', label: 'Prix' },
                { value: 'value', label: 'Valeur' },
                { value: 'category', label: 'Catégorie' },
                { value: 'alert', label: 'Niveau alerte' }
            ];

            const perPageOptions = [25, 50, 100, 200];

            // Rendu de la pagination
            const renderPagination = () => {
                if (stats.totalPages <= 1) return '';
                const pages = [];
                const maxVisible = 7;
                let start = Math.max(1, stats.page - Math.floor(maxVisible / 2));
                let end = Math.min(stats.totalPages, start + maxVisible - 1);
                if (end - start < maxVisible - 1) start = Math.max(1, end - maxVisible + 1);

                for (let i = start; i <= end; i++) pages.push(i);

                return `<div class="flex items-center justify-center gap-2 p-4 border-t border-slate-100">
                    <button onclick="PDGModule.state.stockPage = 1; App.rerender()" class="px-3 py-2 rounded-lg ${stats.page === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${stats.page === 1 ? 'disabled' : ''}><i data-lucide="chevrons-left" class="w-4 h-4"></i></button>
                    <button onclick="PDGModule.state.stockPage = Math.max(1, PDGModule.state.stockPage - 1); App.rerender()" class="px-3 py-2 rounded-lg ${stats.page === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${stats.page === 1 ? 'disabled' : ''}><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    ${pages.map(p => `<button onclick="PDGModule.state.stockPage = ${p}; App.rerender()" class="px-3 py-2 rounded-lg ${p === stats.page ? 'bg-indigo-600 text-white' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm">${p}</button>`).join('')}
                    <button onclick="PDGModule.state.stockPage = Math.min(${stats.totalPages}, PDGModule.state.stockPage + 1); App.rerender()" class="px-3 py-2 rounded-lg ${stats.page === stats.totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${stats.page === stats.totalPages ? 'disabled' : ''}><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                    <button onclick="PDGModule.state.stockPage = ${stats.totalPages}; App.rerender()" class="px-3 py-2 rounded-lg ${stats.page === stats.totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-sm" ${stats.page === stats.totalPages ? 'disabled' : ''}><i data-lucide="chevrons-right" class="w-4 h-4"></i></button>
                    <span class="ml-4 text-sm text-slate-500">Page ${stats.page} / ${stats.totalPages}</span>
                </div>`;
            };

            // Rendu d'une ligne de table de produit
            const renderProductRow = (p) => {
                const isLow = p.stock > 0 && p.stock <= p.minStock;
                const isOut = p.stock <= 0;
                const value = Number(p.price||0) * Number(p.stock||0);
                const pos = posList.find(pos => pos.id === (p.posId || p.pos));
                const statusBadge = isOut ? UI.badge('Rupture','red') : isLow ? UI.badge('Bas','amber') : UI.badge('OK','emerald');

                return `<tr class="hover:bg-slate-50 cursor-pointer" onclick="PDGModule.showProductDetail('${p.id}')">
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-slate-100 flex items-center justify-center text-slate-600 font-bold text-xs">${(p.name || '?').slice(0,2).toUpperCase()}</div>
                            <div>
                                <div class="font-black text-slate-900">${p.name}</div>
                                <div class="text-[10px] text-slate-400">#${p.barcode || p.sku || p.id}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3"><span class="px-2 py-1 bg-slate-100 rounded-lg text-xs font-bold text-slate-600">${CORE.getCategory(p.categoryId)?.name || '—'}</span></td>
                    <td class="px-4 py-3"><span class="text-[10px] text-indigo-600 font-bold bg-indigo-50 px-2 py-1 rounded">${pos?.name || 'Global'}</span></td>
                    <td class="px-4 py-3 text-right font-black">${CORE.formatPrice(p.price)}</td>
                    <td class="px-4 py-3 text-center font-black ${isOut ? 'text-red-600' : isLow ? 'text-amber-600' : 'text-slate-900'}">${p.stock}</td>
                    <td class="px-4 py-3 text-center text-slate-500">${p.minStock}</td>
                    <td class="px-4 py-3 text-right font-black">${CORE.formatPrice(value)}</td>
                    <td class="px-4 py-3">${statusBadge}</td>
                </tr>`;
            };

            // Rendu d'une carte de produit (vue cards)
            const renderProductCard = (p) => {
                const isLow = p.stock > 0 && p.stock <= p.minStock;
                const isOut = p.stock <= 0;
                const value = Number(p.price||0) * Number(p.stock||0);
                const pos = posList.find(pos => pos.id === (p.posId || p.pos));
                const borderColor = isOut ? 'border-red-200 bg-red-50/30' : isLow ? 'border-amber-200 bg-amber-50/30' : 'border-slate-100';

                return `<div class="p-4 rounded-2xl border ${borderColor} hover:shadow-md transition cursor-pointer" onclick="PDGModule.showProductDetail(${p.id})">
                    <div class="flex items-start justify-between gap-2 mb-3">
                        <div class="font-black text-slate-900 truncate">${p.name}</div>
                        ${isOut ? UI.badge('Rupture','red') : isLow ? UI.badge('Bas','amber') : UI.badge('OK','emerald')}
                    </div>
                    <div class="text-xs text-slate-500 mb-2">${CORE.getCategory(p.categoryId)?.name || '—'} ${pos ? '• ' + pos.name : ''}</div>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="p-2 bg-white rounded-xl">
                            <div class="text-[10px] text-slate-400 uppercase">Stock</div>
                            <div class="font-black ${isOut ? 'text-red-600' : isLow ? 'text-amber-600' : 'text-slate-900'}">${p.stock}</div>
                        </div>
                        <div class="p-2 bg-white rounded-xl">
                            <div class="text-[10px] text-slate-400 uppercase">Prix</div>
                            <div class="font-black text-slate-900">${CORE.formatPrice(p.price)}</div>
                        </div>
                        <div class="p-2 bg-white rounded-xl">
                            <div class="text-[10px] text-slate-400 uppercase">Valeur</div>
                            <div class="font-black text-emerald-600">${CORE.formatPrice(value)}</div>
                        </div>
                    </div>
                </div>`;
            };

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">📦 Stock Global</h2>
                            <p class="text-slate-500 font-medium">${stats.totalProducts} produits au total • ${posList.length} points de vente</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="PDGModule.showAddProductModal && PDGModule.showAddProductModal()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Nouveau produit
                            </button>
                            <button onclick="PDGModule.exportStockCSV()" class="px-4 py-2 bg-slate-900 text-white font-black rounded-xl hover:bg-slate-800 transition flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> Export CSV
                            </button>
                        </div>
                    </div>

                    <!-- Statistiques rapides -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        <div class="p-4 bg-white rounded-2xl border border-slate-200">
                            <div class="text-slate-500 text-xs font-black uppercase">Valorisation</div>
                            <div class="text-xl font-black text-slate-900 mt-1">${CORE.formatPrice(stats.totalValue)}</div>
                        </div>
                        <div class="p-4 bg-white rounded-2xl border border-slate-200">
                            <div class="text-slate-500 text-xs font-black uppercase">Total Stock</div>
                            <div class="text-xl font-black text-slate-900 mt-1">${stats.totalStock.toLocaleString()}</div>
                        </div>
                        <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                            <div class="text-emerald-600 text-xs font-black uppercase">Stock OK</div>
                            <div class="text-xl font-black text-emerald-700 mt-1">${stats.okStock}</div>
                        </div>
                        <div class="p-4 bg-amber-50 rounded-2xl border border-amber-100">
                            <div class="text-amber-600 text-xs font-black uppercase">Stock bas</div>
                            <div class="text-xl font-black text-amber-700 mt-1">${stats.lowStock}</div>
                        </div>
                        <div class="p-4 bg-red-50 rounded-2xl border border-red-100">
                            <div class="text-red-600 text-xs font-black uppercase">Ruptures</div>
                            <div class="text-xl font-black text-red-700 mt-1">${stats.outOfStock}</div>
                        </div>
                        <div class="p-4 bg-indigo-50 rounded-2xl border border-indigo-100">
                            <div class="text-indigo-600 text-xs font-black uppercase">Catégories</div>
                            <div class="text-xl font-black text-indigo-700 mt-1">${categories.length}</div>
                        </div>
                    </div>

                    <!-- Filtres avancés -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 space-y-4">
                            <!-- Ligne 1: Recherche et filtres principaux -->
                            <div class="flex flex-wrap gap-3">
                                <div class="relative flex-1 min-w-[200px]">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input id="pdg-stock-search-input" type="text" value="${this.state.stockSearch || ''}" onkeyup="PDGModule.updateStockSearch(this.value)" placeholder="Rechercher par nom, code-barres, SKU..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium" autocomplete="off">
                                </div>
                                <select onchange="PDGModule.state.stockPosId=this.value; PDGModule.state.stockPage=1; App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold min-w-[150px]">
                                    <option value="all" ${this.state.stockPosId === 'all' ? 'selected' : ''}>Tous les POS</option>
                                    <option value="0" ${this.state.stockPosId === '0' ? 'selected' : ''}>🏭 Dépôt principal</option>
                                    ${posList.map(p => `<option value="${p.id}" ${String(this.state.stockPosId) === String(p.id) ? 'selected' : ''}>${p.name}</option>`).join('')}
                                </select>
                                <select onchange="PDGModule.state.stockCategoryId=this.value; PDGModule.state.stockPage=1; App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold min-w-[150px]">
                                    <option value="all" ${this.state.stockCategoryId === 'all' ? 'selected' : ''}>Toutes catégories</option>
                                    ${categories.map(c => `<option value="${c.id}" ${String(this.state.stockCategoryId) === String(c.id) ? 'selected' : ''}>${c.name}</option>`).join('')}
                                </select>
                                <select onchange="PDGModule.state.stockStatus=this.value; PDGModule.state.stockPage=1; App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold min-w-[150px]">
                                    ${statusOptions.map(s => `<option value="${s.value}" ${s.value === (this.state.stockStatus || 'all') ? 'selected' : ''}>${s.label}</option>`).join('')}
                                </select>
                            </div>

                            <!-- Ligne 2: Options de vue et tri -->
                            <div class="flex flex-wrap items-center justify-between gap-3">
                                <div class="flex items-center gap-3">
                                    <!-- Toggle vue table/cards -->
                                    <div class="flex bg-slate-100 rounded-xl p-1">
                                        <button onclick="PDGModule.state.stockViewMode='table'; App.rerender()" class="px-3 py-1.5 rounded-lg text-sm font-bold transition ${viewMode === 'table' ? 'bg-white text-slate-900 shadow' : 'text-slate-500 hover:text-slate-700'}">
                                            <i data-lucide="table" class="w-4 h-4 inline-block"></i> Table
                                        </button>
                                        <button onclick="PDGModule.state.stockViewMode='cards'; App.rerender()" class="px-3 py-1.5 rounded-lg text-sm font-bold transition ${viewMode === 'cards' ? 'bg-white text-slate-900 shadow' : 'text-slate-500 hover:text-slate-700'}">
                                            <i data-lucide="layout-grid" class="w-4 h-4 inline-block"></i> Cartes
                                        </button>
                                    </div>

                                    <!-- Tri -->
                                    <select onchange="PDGModule.state.stockSortBy=this.value; App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-bold">
                                        ${sortOptions.map(s => `<option value="${s.value}" ${s.value === (this.state.stockSortBy || 'name') ? 'selected' : ''}>Trier: ${s.label}</option>`).join('')}
                                    </select>
                                    <button onclick="PDGModule.state.stockSortOrder = PDGModule.state.stockSortOrder === 'asc' ? 'desc' : 'asc'; App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 transition" title="Inverser l'ordre">
                                        <i data-lucide="${(this.state.stockSortOrder || 'asc') === 'asc' ? 'arrow-up' : 'arrow-down'}" class="w-4 h-4 text-slate-600"></i>
                                    </button>
                                </div>

                                <div class="flex items-center gap-3 text-sm text-slate-600">
                                    <span class="font-bold">${stats.totalFiltered} produit(s)</span>
                                    <span>•</span>
                                    <select onchange="PDGModule.state.stockPerPage=parseInt(this.value); PDGModule.state.stockPage=1; App.rerender()" class="px-2 py-1 rounded-lg border border-slate-200 bg-white text-sm font-bold">
                                        ${perPageOptions.map(n => `<option value="${n}" ${n === stats.perPage ? 'selected' : ''}>${n} par page</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Contenu -->
                        ${viewMode === 'cards' ? `
                            <div class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                                ${products.length === 0 ? '<div class="col-span-full p-10 text-center text-slate-400">Aucun produit trouvé</div>' : ''}
                                ${products.map(p => renderProductCard(p)).join('')}
                            </div>
                        ` : `
                            <div class="overflow-auto">
                                <table class="w-full text-left min-w-[1100px]">
                                    <thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase tracking-wider">
                                        <tr>
                                            <th class="px-4 py-4">Produit</th>
                                            <th class="px-4 py-4">Catégorie</th>
                                            <th class="px-4 py-4">POS</th>
                                            <th class="px-4 py-4 text-right">Prix</th>
                                            <th class="px-4 py-4 text-center">Stock</th>
                                            <th class="px-4 py-4 text-center">Min</th>
                                            <th class="px-4 py-4 text-right">Valeur</th>
                                            <th class="px-4 py-4">État</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-50">
                                        ${products.length === 0 ? '<tr><td colspan="8" class="px-6 py-10 text-center text-slate-400">Aucun produit trouvé</td></tr>' : ''}
                                        ${products.map(p => renderProductRow(p)).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}

                        ${renderPagination()}
                    </div>
                </div>
            `;
        },

        renderTeam() {
            const users = this.getTeamFiltered();
            const stats = this.getTeamStats();
            const viewMode = this.state.teamViewMode || 'list';
            const posList = CORE.db.pointsOfSale || [];

            const roles = [
                { value: 'all', label: 'Tous rôles' },
                { value: 'pdg', label: 'PDG' },
                { value: 'manager', label: 'Manager' },
                { value: 'gestionnaire', label: 'Gestionnaire' },
                { value: 'vendeur', label: 'Vendeur' },
                { value: 'livreur', label: 'Livreur' }
            ];

            const sortOptions = [
                { value: 'name', label: 'Nom' },
                { value: 'role', label: 'Rôle' },
                { value: 'pos', label: 'Point de vente' }
            ];

            const perPageOptions = [10, 20, 50, 100];

            // Rendu de la pagination
            const renderPagination = () => {
                if (stats.totalPages <= 1) return '';
                const pages = [];
                const maxVisible = 5;
                let start = Math.max(1, stats.page - Math.floor(maxVisible / 2));
                let end = Math.min(stats.totalPages, start + maxVisible - 1);
                if (end - start < maxVisible - 1) start = Math.max(1, end - maxVisible + 1);

                for (let i = start; i <= end; i++) {
                    pages.push(i);
                }

                return '<div class="flex items-center justify-center gap-2 mt-4">' +
                    '<button onclick="PDGModule.state.teamPage = 1; App.rerender()" class="px-3 py-2 rounded-lg ' + (stats.page === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm" ' + (stats.page === 1 ? 'disabled' : '') + '><i data-lucide="chevrons-left" class="w-4 h-4"></i></button>' +
                    '<button onclick="PDGModule.state.teamPage = Math.max(1, PDGModule.state.teamPage - 1); App.rerender()" class="px-3 py-2 rounded-lg ' + (stats.page === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm" ' + (stats.page === 1 ? 'disabled' : '') + '><i data-lucide="chevron-left" class="w-4 h-4"></i></button>' +
                    pages.map(p => '<button onclick="PDGModule.state.teamPage = ' + p + '; App.rerender()" class="px-3 py-2 rounded-lg ' + (p === stats.page ? 'bg-indigo-600 text-white' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm">' + p + '</button>').join('') +
                    '<button onclick="PDGModule.state.teamPage = Math.min(' + stats.totalPages + ', PDGModule.state.teamPage + 1); App.rerender()" class="px-3 py-2 rounded-lg ' + (stats.page === stats.totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm" ' + (stats.page === stats.totalPages ? 'disabled' : '') + '><i data-lucide="chevron-right" class="w-4 h-4"></i></button>' +
                    '<button onclick="PDGModule.state.teamPage = ' + stats.totalPages + '; App.rerender()" class="px-3 py-2 rounded-lg ' + (stats.page === stats.totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-700') + ' font-bold text-sm" ' + (stats.page === stats.totalPages ? 'disabled' : '') + '><i data-lucide="chevrons-right" class="w-4 h-4"></i></button>' +
                '</div>';
            };

            // Rendu d'un utilisateur
            const renderUserCard = (u) => {
                const roleColor = u.role === 'pdg' ? 'gradient-pdg' : u.role === 'manager' ? 'gradient-manager' : u.role === 'gestionnaire' ? 'gradient-gestionnaire' : u.role === 'vendeur' ? 'gradient-vendeur' : 'gradient-livreur';
                const pos = posList.find(p => p.id === (u.pos || u.posId));
                return '<div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 hover:border-slate-200 transition flex items-start gap-3 cursor-pointer" onclick="PDGModule.showUserDetail(' + u.id + ')">' +
                    '<div class="w-12 h-12 ' + roleColor + ' rounded-2xl flex items-center justify-center text-white font-black shadow-lg">' + (u.avatar || (u.name||'?').slice(0,2).toUpperCase()) + '</div>' +
                    '<div class="min-w-0 flex-1">' +
                        '<div class="flex items-center justify-between gap-2">' +
                            '<div class="font-black text-slate-900 truncate">' + u.name + '</div>' +
                            (u.active !== false ? UI.badge('Actif','emerald') : UI.badge('Inactif','slate')) +
                        '</div>' +
                        '<div class="flex items-center gap-2 mt-1">' +
                            '<span class="text-[10px] text-slate-500 font-bold uppercase tracking-wider bg-slate-100 px-2 py-0.5 rounded">' + u.role + '</span>' +
                            (pos ? '<span class="text-[10px] text-indigo-600 font-bold bg-indigo-50 px-2 py-0.5 rounded">' + pos.name + '</span>' : '') +
                        '</div>' +
                        (u.phone ? '<div class="mt-2 text-xs text-slate-600 flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ' + u.phone + '</div>' : '') +
                    '</div>' +
                '</div>';
            };

            // Vue groupée par POS
            const renderGroupedView = () => {
                const grouped = this.getTeamGroupedByPos();
                return grouped.map(g =>
                    '<div class="mb-6">' +
                        '<div class="flex items-center gap-3 mb-3 px-2">' +
                            '<div class="w-10 h-10 rounded-xl bg-indigo-100 flex items-center justify-center"><i data-lucide="store" class="w-5 h-5 text-indigo-600"></i></div>' +
                            '<div>' +
                                '<div class="font-black text-slate-900">' + g.pos.name + '</div>' +
                                '<div class="text-xs text-slate-500">' + g.users.length + ' membre(s)</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">' +
                            g.users.map(u => renderUserCard(u)).join('') +
                        '</div>' +
                    '</div>'
                ).join('');
            };

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-black text-slate-900">👥 Équipe Globale</h2>
                            <p class="text-slate-500 font-medium">${stats.totalUsers} utilisateurs au total • ${posList.length} points de vente</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="PDGModule.showAddUserModal()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition flex items-center gap-2">
                                <i data-lucide="user-plus" class="w-4 h-4"></i> Ajouter
                            </button>
                            <button onclick="PDGModule.showUsersManagementModal()" class="px-4 py-2 bg-blue-600 text-white rounded-xl font-black hover:bg-blue-700 transition flex items-center gap-2">
                                <i data-lucide="settings" class="w-4 h-4"></i> Gérer
                            </button>
                            <button onclick="PDGModule.exportTeamList()" class="px-4 py-2 bg-slate-600 text-white rounded-xl font-black hover:bg-slate-700 transition flex items-center gap-2">
                                <i data-lucide="download" class="w-4 h-4"></i> Export
                            </button>
                            <button onclick="PDGModule.showInviteEmployeeModal()" class="px-4 py-2 bg-purple-600 text-white rounded-xl font-black hover:bg-purple-700 transition flex items-center gap-2">
                                <i data-lucide="mail-plus" class="w-4 h-4"></i> Inviter
                            </button>
                        </div>
                    </div>

                    <!-- Statistiques rapides par rôle -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                        ${Object.entries(stats.usersByRole).map(([role, count]) => {
                            const colors = { pdg: 'purple', manager: 'blue', gestionnaire: 'cyan', vendeur: 'emerald', livreur: 'amber' };
                            const color = colors[role] || 'slate';
                            return '<div class="p-4 bg-' + color + '-50 rounded-2xl border border-' + color + '-100">' +
                                '<div class="text-' + color + '-600 text-xs font-black uppercase tracking-wider">' + role + '</div>' +
                                '<div class="text-2xl font-black text-' + color + '-700 mt-1">' + count + '</div>' +
                            '</div>';
                        }).join('')}
                    </div>

                    <!-- Filtres avancés -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-5 border-b border-slate-100 space-y-4">
                            <!-- Ligne 1: Recherche et filtres principaux -->
                            <div class="flex flex-wrap gap-3">
                                <div class="relative flex-1 min-w-[200px]">
                                    <i data-lucide="search" class="w-4 h-4 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input id="pdg-team-search-input" type="text" value="${PDGModule.state.teamSearch || ''}" onkeyup="PDGModule.updateTeamSearch(this.value)" placeholder="Rechercher par nom, téléphone..." class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-white font-medium" autocomplete="off">
                                </div>
                                <select onchange="PDGModule.state.teamRole=this.value; PDGModule.state.teamPage=1; App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold min-w-[140px]">
                                    ${roles.map(r => `<option value="${r.value}" ${r.value===PDGModule.state.teamRole?'selected':''}>${r.label}</option>`).join('')}
                                </select>
                                <select onchange="PDGModule.state.teamPosId=this.value; PDGModule.state.teamPage=1; App.rerender()" class="px-3 py-2.5 rounded-xl border border-slate-200 bg-white font-bold min-w-[160px]">
                                    <option value="all" ${PDGModule.state.teamPosId === 'all' ? 'selected' : ''}>Tous les POS</option>
                                    ${posList.map(p => `<option value="${p.id}" ${String(PDGModule.state.teamPosId) === String(p.id) ? 'selected' : ''}>${p.name}</option>`).join('')}
                                </select>
                            </div>

                            <!-- Ligne 2: Options de vue et tri -->
                            <div class="flex flex-wrap items-center justify-between gap-3">
                                <div class="flex items-center gap-3">
                                    <!-- Toggle vue liste/groupée -->
                                    <div class="flex bg-slate-100 rounded-xl p-1">
                                        <button onclick="PDGModule.state.teamViewMode='list'; App.rerender()" class="px-3 py-1.5 rounded-lg text-sm font-bold transition ${viewMode === 'list' ? 'bg-white text-slate-900 shadow' : 'text-slate-500 hover:text-slate-700'}">
                                            <i data-lucide="list" class="w-4 h-4 inline-block"></i> Liste
                                        </button>
                                        <button onclick="PDGModule.state.teamViewMode='grouped'; App.rerender()" class="px-3 py-1.5 rounded-lg text-sm font-bold transition ${viewMode === 'grouped' ? 'bg-white text-slate-900 shadow' : 'text-slate-500 hover:text-slate-700'}">
                                            <i data-lucide="layout-grid" class="w-4 h-4 inline-block"></i> Par POS
                                        </button>
                                    </div>

                                    <!-- Tri -->
                                    <select onchange="PDGModule.state.teamSortBy=this.value; App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-bold">
                                        ${sortOptions.map(s => `<option value="${s.value}" ${s.value === (PDGModule.state.teamSortBy || 'name') ? 'selected' : ''}>Trier: ${s.label}</option>`).join('')}
                                    </select>
                                    <button onclick="PDGModule.state.teamSortOrder = PDGModule.state.teamSortOrder === 'asc' ? 'desc' : 'asc'; App.rerender()" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 transition" title="Inverser l'ordre">
                                        <i data-lucide="${(PDGModule.state.teamSortOrder || 'asc') === 'asc' ? 'arrow-up' : 'arrow-down'}" class="w-4 h-4 text-slate-600"></i>
                                    </button>
                                </div>

                                <div class="flex items-center gap-3 text-sm text-slate-600">
                                    <span class="font-bold">${stats.totalFiltered} résultat(s)</span>
                                    <span>•</span>
                                    <select onchange="PDGModule.state.teamPerPage=parseInt(this.value); PDGModule.state.teamPage=1; App.rerender()" class="px-2 py-1 rounded-lg border border-slate-200 bg-white text-sm font-bold">
                                        ${perPageOptions.map(n => `<option value="${n}" ${n === stats.perPage ? 'selected' : ''}>${n} par page</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Contenu -->
                        <div class="p-4">
                            ${viewMode === 'grouped' ? renderGroupedView() : `
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                    ${users.length === 0 ? '<div class="p-10 text-center text-slate-400 font-medium md:col-span-2 lg:col-span-3">Aucun membre trouvé</div>' : ''}
                                    ${users.map(u => renderUserCard(u)).join('')}
                                </div>
                                ${renderPagination()}
                            `}
                        </div>
                    </div>
                </div>
            `;
        },

        renderCommandes() {
            const suppliers = CORE.db.suppliers || [];
            const purchaseOrders = CORE.db.purchaseOrders || [];
            const products = CORE.getVisibleProducts() || [];

            const stats = {
                total: purchaseOrders.length,
                pending: purchaseOrders.filter(o => ['pending','confirmed'].includes(o.status)).length,
                received: purchaseOrders.filter(o => o.status === 'received').length,
                totalCost: purchaseOrders.reduce((a,o) => a + (o.totalCost||0), 0)
            };

            let html = '<div class="max-w-7xl mx-auto space-y-6 fade-in"><h2 class="text-3xl font-black text-slate-900">📦 Gestion Globale des Commandes de Réapprovisionnement</h2>';
            html += '<button onclick="PDGModule.showNewPurchaseOrderModal()" class="px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700">+ Nouvelle commande</button>';

            html += '<div class="grid grid-cols-1 md:grid-cols-4 gap-4">';
            html += '<div class="bg-white p-4 rounded-2xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase">Total</div><div class="mt-2 text-2xl font-black">' + stats.total + '</div></div>';
            html += '<div class="bg-white p-4 rounded-2xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase">En attente</div><div class="mt-2 text-2xl font-black text-amber-600">' + stats.pending + '</div></div>';
            html += '<div class="bg-white p-4 rounded-2xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase">Livrées</div><div class="mt-2 text-2xl font-black text-emerald-600">' + stats.received + '</div></div>';
            html += '<div class="bg-white p-4 rounded-2xl border border-slate-200"><div class="text-xs font-black text-slate-500 uppercase">Total dépensé</div><div class="mt-2 text-2xl font-black">' + CORE.formatPrice(stats.totalCost) + '</div></div>';
            html += '</div>';

            html += '<div class="bg-white border border-slate-200 rounded-3xl overflow-hidden"><table class="w-full"><thead class="bg-slate-100"><tr><th class="px-4 py-3 text-left font-black">Ref</th><th class="px-4 py-3 text-left font-black">Fournisseur</th><th class="px-4 py-3 text-left font-black">Produit</th><th class="px-4 py-3 text-left font-black">Quantité</th><th class="px-4 py-3 text-left font-black">Montant</th><th class="px-4 py-3 text-left font-black">Statut</th><th class="px-4 py-3 text-left font-black">Date</th><th class="px-4 py-3 text-left font-black">Actions</th></tr></thead><tbody>';

            const recent = purchaseOrders.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 30);
            recent.forEach(o => {
                const supplier = suppliers.find(s => s.id === o.supplierId);
                const product = products.find(p => p.id === o.productId);
                html += '<tr class="border-t border-slate-200 hover:bg-slate-50"><td class="px-4 py-3 font-bold">' + (o.reference || o.id) + '</td>';
                html += '<td class="px-4 py-3 font-bold">' + (supplier?.name || '—') + '</td>';
                html += '<td class="px-4 py-3">' + (product?.name || '—') + '</td>';
                html += '<td class="px-4 py-3 text-center font-bold">' + o.qty + '</td>';
                html += '<td class="px-4 py-3 font-black">' + CORE.formatPrice(o.totalCost || 0) + '</td>';
                html += '<td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-bold ' + (o.status === 'received' ? 'bg-emerald-100 text-emerald-700' : o.status === 'confirmed' ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700') + '">' + (o.status === 'pending' ? 'Attente' : o.status === 'confirmed' ? 'Confirmée' : 'Livrée') + '</span></td>';
                html += '<td class="px-4 py-3 text-xs text-slate-500">' + CORE.formatDate(o.createdAt) + '</td>';
                html += '<td class="px-4 py-3"><button onclick="PDGModule.validatePurchaseOrderArrival(' + o.id + ')" class="' + (o.status === 'received' ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-emerald-500 text-white hover:bg-emerald-600') + ' px-3 py-1 rounded text-xs font-bold">' + (o.status === 'received' ? '✓ Reçu' : 'Valider arrivée') + '</button></td></tr>';
            });

            html += '</tbody></table></div></div>';
            return html;
        },

        showNewPurchaseOrderModal(savedData = null) {
            const suppliers = CORE.db.suppliers || [];
            const products = CORE.getVisibleProducts() || [];

            const supplierOptions = suppliers.map(s => ({value: s.id, label: s.name}));
            const productOptions = products.map(p => ({value: p.id, label: p.name + ' (Stock: ' + (p.stock||0) + ')'}));
            const transportModes = [{value: 'routier', label: 'Routier'}, {value: 'aerien', label: 'Aérien'}, {value: 'maritime', label: 'Maritime'}, {value: 'ferroviaire', label: 'Ferroviaire'}];

            // Utiliser les données sauvegardées si présentes
            const d = savedData || {};

            UI.modal('Nouvelle commande de réapprovisionnement', `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <!-- Fournisseur/Usine avec bouton + Nouveau -->
                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">Fournisseur/Usine *</label>
                        <div class="flex gap-2">
                            <select id="po_supplier" class="flex-1 px-4 py-2.5 border border-slate-200 rounded-xl font-medium focus:ring-2 focus:ring-emerald-500">
                                <option value="">-- Sélectionner --</option>
                                ${supplierOptions.map(s => '<option value="' + s.value + '"' + (String(s.value) === String(d.supplierId || '') ? ' selected' : '') + '>' + s.label + '</option>').join('')}
                            </select>
                            <button onclick="PDGModule.showNewSupplierForPO()" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition whitespace-nowrap">+ Nouveau</button>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">Produit existant</label>
                        <select id="po_product" class="w-full px-3 py-2 rounded-lg border border-slate-200">
                            <option value="">-- Sélectionner un produit --</option>
                            ${productOptions.map(p => '<option value="' + p.value + '"' + (String(p.value) === String(d.productId || '') ? ' selected' : '') + '>' + p.label + '</option>').join('')}
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">OU Créer un nouveau produit</label>
                        <input type="text" id="po_newProductName" value="${d.newProductName || ''}" placeholder="Nom du produit" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white">
                        <input type="text" id="po_newProductCode" value="${d.newProductCode || ''}" placeholder="Code produit" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white">
                        <textarea id="po_newProductDesc" placeholder="Description du produit" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white" rows="2">${d.newProductDesc || ''}</textarea>
                    </div>

                    ${UI.input('po_qty', 'Quantité', 'number', d.qty || '10', 'ex: 50', true)}
                    ${UI.input('po_kilos', 'Kilos', 'number', d.kilos || '0', 'ex: 100', false)}
                    ${UI.input('po_cbm', 'CBM (m³)', 'number', d.cbm || '0', 'ex: 2.5', false)}
                    ${UI.input('po_unitPrice', 'Prix unitaire', 'number', d.unitPrice || '0', 'ex: 1500', true)}
                    ${UI.input('po_transportPrice', 'Prix de transport', 'number', d.transportPrice || '0', 'ex: 5000', false)}
                    ${UI.input('po_totalPrice', 'Total à payer au fournisseur', 'number', d.totalPrice || '0', 'ex: 10500 (optionnel)', false)}
                    ${UI.select('po_transportMode', 'Mode de transport', transportModes, d.transportMode || '')}
                    ${UI.input('po_transportAgency', 'Agence de transport', 'text', d.transportAgency || '', 'ex: DHL, FedEx, UPS', false)}
                    ${UI.input('po_trackingNumber', 'Numéro de suivi du colis', 'text', d.trackingNumber || '', 'ex: TRK123456789', false)}
                    ${UI.input('po_deliveryDate', 'Date de livraison prévue', 'date', d.deliveryDate || '', '', false)}
                    ${UI.input('po_reminderDays', 'Période de rappel (jours avant arrivée)', 'number', d.reminderDays || '3', 'ex: 3, 5, 7', false)}

                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">Image du colis</label>
                        <input type="file" id="po_image" accept="image/*" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white">
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-black text-slate-700">Vidéo</label>
                        <input type="file" id="po_video" accept="video/*" class="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white">
                    </div>
                    ${UI.textarea('po_note', 'Notes', d.note || 'Ex: Urgent, qualité premium', 300, false)}
                </div>
            `, [
                {label: 'Annuler', onclick: 'UI.closeModal()'},
                {label: 'Créer', onclick: 'PDGModule.createPurchaseOrder()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700'}
            ]);
        },

        showNewSupplierForPO() {
            // Sauvegarder les données du formulaire
            window._pendingPOFormData = {
                module: 'pdg',
                supplierId: UI.val('po_supplier') || '',
                productId: UI.val('po_product') || '',
                newProductName: document.getElementById('po_newProductName')?.value || '',
                newProductCode: document.getElementById('po_newProductCode')?.value || '',
                newProductDesc: document.getElementById('po_newProductDesc')?.value || '',
                qty: UI.val('po_qty') || '10',
                kilos: UI.val('po_kilos') || '0',
                cbm: UI.val('po_cbm') || '0',
                unitPrice: UI.val('po_unitPrice') || '0',
                transportPrice: UI.val('po_transportPrice') || '0',
                totalPrice: UI.val('po_totalPrice') || '0',
                transportMode: UI.val('po_transportMode') || '',
                transportAgency: UI.val('po_transportAgency') || '',
                trackingNumber: UI.val('po_trackingNumber') || '',
                deliveryDate: UI.val('po_deliveryDate') || '',
                reminderDays: UI.val('po_reminderDays') || '3',
                note: UI.val('po_note') || ''
            };

            UI.modal('➕ Nouveau Fournisseur/Usine', `
                <div class="space-y-4">
                    <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-xl text-sm text-emerald-800">
                        Créez un nouveau fournisseur ou usine pour vos commandes de réapprovisionnement
                    </div>
                    ${UI.input('new_supplier_name', 'Nom du fournisseur/usine *', 'text', '', 'ex: Usine Textile Guangzhou', true)}
                    ${UI.input('new_supplier_contact', 'Email de contact', 'email', '', 'ex: contact@fournisseur.com', false)}
                    ${UI.input('new_supplier_phone', 'Téléphone', 'tel', '', 'ex: +86 123 456 7890', false)}
                    ${UI.input('new_supplier_country', 'Pays', 'text', '', 'ex: Chine, Maroc, Turquie', false)}
                    ${UI.input('new_supplier_address', 'Adresse', 'text', '', 'ex: Zone industrielle...', false)}
                    ${UI.textarea('new_supplier_notes', 'Notes', '', 2, false)}
                </div>
            `, [
                { label: 'Annuler', onclick: 'PDGModule.restorePOModal()' },
                { label: 'Créer le fournisseur', onclick: 'PDGModule.saveNewSupplierForPO()', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);
        },

        saveNewSupplierForPO() {
            const name = UI.val('new_supplier_name')?.trim();
            if (!name) return UI.toast('Le nom du fournisseur est requis', 'warning');

            // Vérifier si existe déjà
            const exists = (CORE.db.suppliers || []).some(s => s.name.toLowerCase() === name.toLowerCase());
            if (exists) return UI.toast('Ce fournisseur existe déjà', 'warning');

            const newSupplier = CORE.create('suppliers', {
                name: name,
                email: UI.val('new_supplier_contact')?.trim() || '',
                phone: UI.val('new_supplier_phone')?.trim() || '',
                country: UI.val('new_supplier_country')?.trim() || '',
                address: UI.val('new_supplier_address')?.trim() || '',
                notes: UI.val('new_supplier_notes')?.trim() || '',
                active: true,
                createdAt: new Date().toISOString()
            });

            UI.toast(`✅ Fournisseur "${name}" créé!`, 'success');

            // Restaurer le modal avec le nouveau fournisseur sélectionné
            const savedData = window._pendingPOFormData || {};
            savedData.supplierId = newSupplier.id;
            window._pendingPOFormData = null;

            this.showNewPurchaseOrderModal(savedData);
        },

        restorePOModal() {
            const savedData = window._pendingPOFormData || {};
            window._pendingPOFormData = null;
            this.showNewPurchaseOrderModal(savedData);
        },

        createPurchaseOrder() {
            const supplierId = UI.val('po_supplier');
            let productId = UI.val('po_product');
            const newProductName = document.getElementById('po_newProductName')?.value || '';
            const newProductCode = document.getElementById('po_newProductCode')?.value || '';
            const newProductDesc = document.getElementById('po_newProductDesc')?.value || '';
            const qty = parseInt(UI.val('po_qty')) || 0;
            const kilos = parseFloat(UI.val('po_kilos')) || 0;
            const cbm = parseFloat(UI.val('po_cbm')) || 0;
            const unitPrice = parseFloat(UI.val('po_unitPrice')) || 0;
            const transportPrice = parseFloat(UI.val('po_transportPrice')) || 0;
            const customTotalPrice = parseFloat(UI.val('po_totalPrice')) || 0;
            const reminderDays = parseInt(UI.val('po_reminderDays')) || 0;

            if (!supplierId) return UI.toast('Fournisseur requis', 'error');
            if (!productId && !newProductName) return UI.toast('Sélectionnez un produit ou créez un nouveau', 'error');
            if (qty <= 0) return UI.toast('Quantité invalide', 'error');

            // Créer le nouveau produit si nécessaire
            if (newProductName && !productId) {
                const newProduct = CORE.create('products', {
                    name: newProductName,
                    code: newProductCode || 'PROD-' + Utils.uid().substring(0,6),
                    description: newProductDesc,
                    stock: qty,
                    price: unitPrice,
                    active: true,
                    createdAt: new Date().toISOString()
                });
                productId = newProduct.id;
            }

            // Calculer le total : utiliser customTotalPrice si fourni, sinon calculer automatiquement
            const totalCost = customTotalPrice > 0 ? customTotalPrice : (qty * unitPrice) + transportPrice;

            const imageFile = document.getElementById('po_image')?.files?.[0];
            const videoFile = document.getElementById('po_video')?.files?.[0];
            let imageBase64 = null;
            let videoBase64 = null;

            const createOrder = () => {
                const reference = 'PO-' + Utils.uid('PO').substring(0,6);
                const po = CORE.create('purchaseOrders', {
                    reference,
                    supplierId: parseInt(supplierId),
                    productId: parseInt(productId),
                    qty,
                    kilos,
                    cbm,
                    unitPrice,
                    transportPrice,
                    transportMode: UI.val('po_transportMode') || null,
                    transportAgency: UI.val('po_transportAgency') || null,
                    totalCost,
                    status: 'pending',
                    trackingNumber: UI.val('po_trackingNumber') || null,
                    deliveryDate: UI.val('po_deliveryDate') || null,
                    reminderDays,
                    image: imageBase64,
                    video: videoBase64,
                    note: UI.val('po_note') || '',
                    createdAt: new Date().toISOString()
                });

                // Enregistrer la dépense automatiquement
                const supplier = CORE.db.suppliers?.find(s => s.id === parseInt(supplierId));
                const product = CORE.getVisibleProducts().find(p => p.id === parseInt(productId));
                CORE.create('expenses', {
                    reference: reference,
                    type: 'purchase_order',
                    description: `Commande ${reference} - ${product?.name || 'Produit'} chez ${supplier?.name || 'Fournisseur'}`,
                    amount: totalCost,
                    supplier: supplier?.name || 'Non spécifié',
                    category: 'réapprovisionnement',
                    status: 'pending',
                    purchaseOrderId: po.id,
                    createdAt: new Date().toISOString()
                });

                UI.closeModal();
                UI.toast('Commande créée: ' + reference, 'success');
                CORE.notify('success', `Nouvelle commande créée: ${reference} chez ${supplier?.name || 'Fournisseur'} - ${CORE.formatPrice(totalCost)}`, { purchaseOrderId: po.id });
                App.rerender();
            };

            let pendingFiles = 0;
            if (imageFile) pendingFiles++;
            if (videoFile) pendingFiles++;

            if (pendingFiles === 0) {
                createOrder();
                return;
            }

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageBase64 = e.target.result;
                    pendingFiles--;
                    if (pendingFiles === 0) createOrder();
                };
                reader.readAsDataURL(imageFile);
            }

            if (videoFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    videoBase64 = e.target.result;
                    pendingFiles--;
                    if (pendingFiles === 0) createOrder();
                };
                reader.readAsDataURL(videoFile);
            }
        },

        renderActivity() {
            const tab = this.state.activityTab;
            const notifications = CORE.db.notifications.slice(0, 50);
            const movements = CORE.getVisibleStockMovements().slice(0, 50);

            const tabs = [
                { value: 'notifications', label: `Notifications (${CORE.db.notifications.length})` },
                { value: 'stock', label: `Mouvements stock (${CORE.getVisibleStockMovements().length})` }
            ];

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div>
                        <h2 class="text-2xl font-black text-slate-900">Activité</h2>
                        <p class="text-slate-500 font-medium">Journal d'événements : notifications et mouvements de stock.</p>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-4 border-b border-slate-100 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                            ${tabs.map(t => `
                                <button onclick="PDGModule.state.activityTab=\'${t.value}\';App.rerender()" class="px-4 py-2 rounded-xl font-black text-sm ${tab===t.value ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">${t.label}</button>
                            `).join('')}
                            </div>
                            ${tab === 'notifications' && notifications.length > 0 ? `
                                <button onclick="if(confirm('Effacer toutes les notifications ?')){CORE.db.notifications=[];CORE.save();App.rerender()}" class="px-3 py-1.5 text-xs bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition font-black">Tout effacer</button>
                            ` : ''}
                        </div>

                        <div class="p-4">
                            ${tab === 'notifications' ? `
                                <div class="space-y-2">
                                    ${notifications.length === 0 ? `<div class="p-10 text-center text-slate-400">Aucune notification</div>` : ''}
                                    ${notifications.map(n => {
                                        const badge = n.type === 'error' ? UI.badge('Erreur','red') : n.type === 'warning' ? UI.badge('Alerte','amber') : n.type === 'info' ? UI.badge('Info','blue') : UI.badge('OK','emerald');
                                        return `
                                        <div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50">
                                            <div class="flex items-start justify-between gap-3">
                                                <div>
                                                    <div class="font-black text-slate-900">${n.message}</div>
                                                    <div class="text-xs text-slate-500">${CORE.formatDate(n.createdAt)}</div>
                                                </div>
                                                ${badge}
                                            </div>
                                        </div>`;
                                    }).join('')}
                                </div>
                            ` : `
                                <div class="space-y-2">
                                    ${movements.length === 0 ? `<div class="p-10 text-center text-slate-400">Aucun mouvement</div>` : ''}
                                    ${movements.map(m => `
                                        <div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50">
                                            <div class="flex items-start justify-between gap-3">
                                                <div>
                                                    <div class="font-black text-slate-900">${m.productName || '—'}</div>
                                                    <div class="text-xs text-slate-500">${m.userName || 'System'} • ${CORE.formatDate(m.createdAt)}</div>
                                                    ${m.note ? `<div class="mt-1 text-xs text-slate-600">${m.note}</div>` : ''}
                                                </div>
                                                <div class="text-right">
                                                    ${UI.badge(m.type, m.type==='out'?'red':m.type==='in'?'emerald':'blue')}
                                                    <div class="mt-2 font-black ${m.type==='out'?'text-red-600':'text-slate-900'}">${m.type==='out' ? '-' : '+'}${m.qty}</div>
                                                    ${m.ref ? `<div class="text-[10px] text-slate-400">${m.ref}</div>` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        },

        renderAuditTrail() {
            const filterUser = this.state.auditFilterUser || '';
            const filterAction = this.state.auditFilterAction || '';
            const filterEntity = this.state.auditFilterEntity || '';
            const sortOrder = this.state.auditSortOrder || 'desc';

            // Filtrer les logs d'audit
            let logs = CORE.db.auditLogs || [];
            if (filterUser) logs = logs.filter(l => l.userId.toString() === filterUser);
            if (filterAction) logs = logs.filter(l => l.action === filterAction);
            if (filterEntity) logs = logs.filter(l => l.entity === filterEntity);

            // Trier
            if (sortOrder === 'asc') {
                logs = logs.reverse();
            }

            // Statistiques
            const totalActions = CORE.db.auditLogs?.length || 0;
            const userCount = [...new Set(CORE.db.auditLogs?.map(l => l.userId) || [])].length;
            const today = new Date().toDateString();
            const actionsToday = CORE.db.auditLogs?.filter(l => new Date(l.timestamp).toDateString() === today).length || 0;

            // Actions uniques
            const uniqueActions = [...new Set(CORE.db.auditLogs?.map(l => l.action) || [])];
            const uniqueEntities = [...new Set(CORE.db.auditLogs?.map(l => l.entity) || [])];
            const uniqueUsers = CORE.getVisibleUsers() || [];

            // Icônes pour les actions
            const getActionIcon = (action) => {
                const icons = {
                    'create': 'plus-circle',
                    'update': 'edit-2',
                    'delete': 'trash-2',
                    'approve': 'check-circle',
                    'reject': 'x-circle',
                    'assign': 'user-plus',
                    'complete': 'check-square',
                    'cancel': 'x-square'
                };
                return icons[action] || 'activity';
            };

            const getActionColor = (action) => {
                const colors = {
                    'create': 'emerald',
                    'update': 'blue',
                    'delete': 'red',
                    'approve': 'emerald',
                    'reject': 'red',
                    'assign': 'amber',
                    'complete': 'emerald',
                    'cancel': 'slate'
                };
                return colors[action] || 'slate';
            };

            const getStatusIcon = (status) => {
                const icons = {
                    'success': 'check',
                    'error': 'x',
                    'pending': 'clock',
                    'warning': 'alert-circle',
                    'cancelled': 'ban'
                };
                return icons[status] || 'info';
            };

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">🔐 Audit Trail Complet</h2>
                            <p class="text-slate-500 font-medium">Historique détaillé de toutes les actions des utilisateurs</p>
                        </div>
                        <button onclick="PDGModule.exportAuditLog()" class="px-4 py-2 rounded-xl bg-indigo-50 text-indigo-600 font-black hover:bg-indigo-100 transition flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i> Exporter
                        </button>
                    </div>

                    <!-- Statistiques -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-slate-700 text-xs font-black uppercase tracking-wider mb-2">Total Actions</div>
                            <div class="text-3xl font-black text-slate-900">${totalActions}</div>
                            <div class="text-xs text-slate-500 mt-2">Depuis le début</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-indigo-700 text-xs font-black uppercase tracking-wider mb-2">Actions Aujourd'hui</div>
                            <div class="text-3xl font-black text-indigo-600">${actionsToday}</div>
                            <div class="text-xs text-indigo-500 mt-2">Derniers 24h</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-emerald-700 text-xs font-black uppercase tracking-wider mb-2">Utilisateurs Actifs</div>
                            <div class="text-3xl font-black text-emerald-600">${userCount}</div>
                            <div class="text-xs text-emerald-500 mt-2">Ayant effectué des actions</div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 p-6">
                            <div class="text-amber-700 text-xs font-black uppercase tracking-wider mb-2">Types d'Actions</div>
                            <div class="text-3xl font-black text-amber-600">${uniqueActions.length}</div>
                            <div class="text-xs text-amber-500 mt-2">${uniqueActions.join(', ')}</div>
                        </div>
                    </div>

                    <!-- Filtres -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Utilisateur</label>
                                <select onchange="PDGModule.state.auditFilterUser = this.value; App.rerender()" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                                    <option value="">Tous les utilisateurs</option>
                                    ${uniqueUsers.map(u => `<option value="${u.id}" ${filterUser === u.id.toString() ? 'selected' : ''}>${u.name} (${u.role})</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Action</label>
                                <select onchange="PDGModule.state.auditFilterAction = this.value; App.rerender()" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                                    <option value="">Toutes les actions</option>
                                    ${uniqueActions.map(a => `<option value="${a}" ${filterAction === a ? 'selected' : ''}>${a.charAt(0).toUpperCase() + a.slice(1)}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Entité</label>
                                <select onchange="PDGModule.state.auditFilterEntity = this.value; App.rerender()" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                                    <option value="">Toutes les entités</option>
                                    ${uniqueEntities.map(e => `<option value="${e}" ${filterEntity === e ? 'selected' : ''}>${e.charAt(0).toUpperCase() + e.slice(1)}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Ordre</label>
                                <select onchange="PDGModule.state.auditSortOrder = this.value; App.rerender()" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                                    <option value="desc" ${sortOrder === 'desc' ? 'selected' : ''}>Plus récent d'abord</option>
                                    <option value="asc" ${sortOrder === 'asc' ? 'selected' : ''}>Plus ancien d'abord</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="PDGModule.state.auditFilterUser = ''; PDGModule.state.auditFilterAction = ''; PDGModule.state.auditFilterEntity = ''; PDGModule.state.auditSortOrder = 'desc'; App.rerender()" class="text-xs font-black text-slate-600 hover:text-slate-900">Réinitialiser les filtres</button>
                    </div>

                    <!-- Historique -->
                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                        <div class="p-6 border-b border-slate-100">
                            <h3 class="font-black text-slate-900">Journal d'Audit (${logs.length} résultats)</h3>
                        </div>
                        <div class="divide-y divide-slate-100 max-h-[600px] overflow-y-auto">
                            ${logs.length === 0 ? `
                                <div class="p-8 text-center text-slate-400">
                                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 opacity-30"></i>
                                    <div>Aucune action trouvée</div>
                                </div>
                            ` : logs.map(log => `
                                <div class="p-4 hover:bg-slate-50 transition cursor-pointer" onclick="PDGModule.showAuditLogDetail(${log.id})">
                                    <div class="flex items-start gap-4">
                                        <div class="w-12 h-12 rounded-2xl flex items-center justify-center flex-shrink-0 bg-${getActionColor(log.action)}-50">
                                            <i data-lucide="${getActionIcon(log.action)}" class="w-6 h-6 text-${getActionColor(log.action)}-600"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="font-black text-slate-900">${log.action.toUpperCase()}</span>
                                                <span class="text-xs font-black text-slate-600 uppercase">${log.entity}</span>
                                                ${log.entityName ? `<span class="text-xs font-black text-slate-700">"${log.entityName}"</span>` : ''}
                                            </div>
                                            <div class="text-xs text-slate-500 space-y-1">
                                                <div><strong>${log.userName}</strong> (${log.userRole}) - ${new Date(log.timestamp).toLocaleString('fr-FR')}</div>
                                                ${log.details?.description ? `<div>${log.details.description}</div>` : ''}
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2 flex-shrink-0">
                                            ${UI.badge(log.status === 'success' ? 'OK' : log.status.toUpperCase(), log.status === 'success' ? 'emerald' : log.status === 'error' ? 'red' : log.status === 'pending' ? 'amber' : 'slate')}
                                            <span class="text-[10px] text-slate-400">${log.id}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        },

        showAuditLogDetail(logId) {
            const log = CORE.db.auditLogs?.find(l => l.id === logId);
            if (!log) return UI.toast('Log introuvable', 'error');

            UI.modal('Détail de l\'Action d\'Audit', `
                <div class="space-y-4 max-h-[60vh] overflow-y-auto">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 bg-slate-50 rounded-2xl border border-slate-100">
                            <div class="text-xs font-black text-slate-600 uppercase">Utilisateur</div>
                            <div class="font-black text-slate-900">${log.userName}</div>
                            <div class="text-xs text-slate-500">${log.userRole}</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-2xl border border-slate-100">
                            <div class="text-xs font-black text-slate-600 uppercase">Action</div>
                            <div class="font-black text-slate-900">${log.action}</div>
                            <div class="text-xs text-slate-500">${log.entity}</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-2xl border border-slate-100">
                            <div class="text-xs font-black text-slate-600 uppercase">Horodatage</div>
                            <div class="font-black text-slate-900">${new Date(log.timestamp).toLocaleString('fr-FR')}</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-2xl border border-slate-100">
                            <div class="text-xs font-black text-slate-600 uppercase">Statut</div>
                            <div class="font-black text-slate-900">${log.status}</div>
                        </div>
                    </div>

                    ${log.entityName ? `
                        <div class="p-3 bg-blue-50 rounded-2xl border border-blue-100">
                            <div class="text-xs font-black text-blue-600 uppercase">Entité</div>
                            <div class="font-black text-blue-900">${log.entityName} (ID: ${log.entityId})</div>
                        </div>
                    ` : ''}

                    ${Object.keys(log.details || {}).length > 0 ? `
                        <div class="p-4 bg-amber-50 rounded-2xl border border-amber-100">
                            <div class="text-xs font-black text-amber-600 uppercase mb-2">Détails</div>
                            <div class="space-y-1 text-sm">
                                ${Object.entries(log.details).map(([k, v]) => `
                                    <div class="flex justify-between">
                                        <span class="font-black">${k}:</span>
                                        <span class="text-amber-900">${typeof v === 'object' ? JSON.stringify(v) : v}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${log.before ? `
                        <div class="p-4 bg-red-50 rounded-2xl border border-red-100">
                            <div class="text-xs font-black text-red-600 uppercase mb-2">Avant</div>
                            <pre class="text-[10px] overflow-x-auto text-red-900">${JSON.stringify(JSON.parse(log.before), null, 2)}</pre>
                        </div>
                    ` : ''}

                    ${log.after ? `
                        <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                            <div class="text-xs font-black text-emerald-600 uppercase mb-2">Après</div>
                            <pre class="text-[10px] overflow-x-auto text-emerald-900">${JSON.stringify(JSON.parse(log.after), null, 2)}</pre>
                        </div>
                    ` : ''}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        exportAuditLog() {
            const logs = CORE.db.auditLogs || [];
            let csvContent = 'sep=,\n';
            csvContent += 'ID,Horodatage,Utilisateur,Rôle,Action,Entité,Entité ID,Entité Nom,Statut\n';

            logs.forEach(log => {
                csvContent += `${log.id},"${new Date(log.timestamp).toLocaleString('fr-FR')}","${log.userName}","${log.userRole}","${log.action}","${log.entity}",${log.entityId},"${log.entityName || '—'}","${log.status}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'audit_log_' + new Date().getTime() + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('Journal d\'audit exporté avec succès', 'success');
        },

        renderAdvancedReports() {
            const reportType = this.state.reportType || 'sales';
            const periodType = this.state.periodType || 'month';
            const selectedPeriod = this.state.selectedPeriod || new Date().toISOString().split('T')[0];
            const comparePeriod = this.state.comparePeriod || null;

            // Calculer les dates selon la période
            const getDateRange = (dateStr, type) => {
                const d = new Date(dateStr);
                if (type === 'day') {
                    return { from: dateStr, to: dateStr };
                } else if (type === 'week') {
                    const start = new Date(d);
                    start.setDate(d.getDate() - d.getDay());
                    const end = new Date(start);
                    end.setDate(start.getDate() + 6);
                    return { from: start.toISOString().split('T')[0], to: end.toISOString().split('T')[0] };
                } else if (type === 'month') {
                    return { from: d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-01', to: new Date(d.getFullYear(), d.getMonth() + 1, 0).toISOString().split('T')[0] };
                } else if (type === 'year') {
                    return { from: d.getFullYear() + '-01-01', to: d.getFullYear() + '-12-31' };
                }
            };

            const currentRange = getDateRange(selectedPeriod, periodType);
            let previousRange = null;
            if (comparePeriod) {
                previousRange = getDateRange(comparePeriod, periodType);
            }

            // Fonction pour filtrer les données par période
            const getDataInRange = (data, from, to) => {
                return data.filter(item => {
                    const date = new Date(item.createdAt || item.date).toISOString().split('T')[0];
                    return date >= from && date <= to;
                });
            };

            const currentOrders = getDataInRange(CORE.getVisibleOrders(), currentRange.from, currentRange.to);
            const currentDeliveries = getDataInRange(CORE.getVisibleDeliveries(), currentRange.from, currentRange.to);
            const previousOrders = previousRange ? getDataInRange(CORE.getVisibleOrders(), previousRange.from, previousRange.to) : [];
            const previousDeliveries = previousRange ? getDataInRange(CORE.getVisibleDeliveries(), previousRange.from, previousRange.to) : [];

            // Calculs des KPIs
            const calcKpis = (orders, deliveries) => {
                const totalOrders = orders.length;
                const totalRevenue = orders.filter(o => o.status === 'delivered').reduce((a, o) => a + (o.total || 0), 0);
                const deliveredCount = deliveries.filter(d => d.status === 'livree').length;
                const deliveryRate = deliveries.length > 0 ? (deliveredCount / deliveries.length * 100).toFixed(1) : 0;
                const avgOrderValue = totalOrders > 0 ? (totalRevenue / totalOrders).toFixed(2) : 0;
                const totalItems = orders.reduce((a, o) => a + (o.items?.length || 0), 0);
                return { totalOrders, totalRevenue, deliveredCount, deliveryRate, avgOrderValue, totalItems };
            };

            const currentKpis = calcKpis(currentOrders, currentDeliveries);
            const previousKpis = comparePeriod ? calcKpis(previousOrders, previousDeliveries) : null;

            // Comparaison
            const getComparison = (current, previous) => {
                if (!previous || previous === 0) return { value: 0, trend: 'equal' };
                const diff = ((current - previous) / previous * 100).toFixed(1);
                return { value: diff, trend: diff > 0 ? 'up' : diff < 0 ? 'down' : 'equal' };
            };

            const comparisons = previousKpis ? {
                revenue: getComparison(currentKpis.totalRevenue, previousKpis.totalRevenue),
                orders: getComparison(currentKpis.totalOrders, previousKpis.totalOrders),
                delivery: getComparison(parseFloat(currentKpis.deliveryRate), parseFloat(previousKpis.deliveryRate)),
                avg: getComparison(parseFloat(currentKpis.avgOrderValue), parseFloat(previousKpis.avgOrderValue))
            } : null;

            // Top villes
            const topCities = CORE.db.cities.map(city => {
                const cityOrders = currentOrders.filter(o => {
                    const pos = CORE.getPOS(o.posId);
                    return pos && pos.cityId === city.id;
                });
                const revenue = cityOrders.filter(o => o.status === 'delivered').reduce((a, o) => a + (o.total || 0), 0);
                return { city, orders: cityOrders.length, revenue };
            }).sort((a, b) => b.revenue - a.revenue).slice(0, 5);

            // Top POS
            const topPos = (CORE.db.pointsOfSale || []).map(pos => {
                const posOrders = currentOrders.filter(o => o.posId === pos.id);
                const revenue = posOrders.filter(o => o.status === 'delivered').reduce((a, o) => a + (o.total || 0), 0);
                return { pos, orders: posOrders.length, revenue };
            }).sort((a, b) => b.revenue - a.revenue).slice(0, 10);

            // Statut des livraisons
            const deliveryStats = {
                livree: currentDeliveries.filter(d => d.status === 'livree').length,
                en_cours: currentDeliveries.filter(d => d.status === 'en_cours').length,
                en_attente: currentDeliveries.filter(d => d.status === 'en_attente').length,
                probleme: currentDeliveries.filter(d => d.status === 'probleme').length
            };

            // Top produits
            const productSales = {};
            currentOrders.forEach(order => {
                (order.items || []).forEach(item => {
                    if (!productSales[item.productId]) {
                        productSales[item.productId] = { qty: 0, revenue: 0, product: CORE.getProduct(item.productId) };
                    }
                    productSales[item.productId].qty += item.quantity || 1;
                    productSales[item.productId].revenue += (item.price || 0) * (item.quantity || 1);
                });
            });
            const topProducts = Object.values(productSales).sort((a, b) => b.revenue - a.revenue).slice(0, 10);

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-3xl font-black text-slate-900">📊 Rapports Analytiques Avancés</h2>
                            <p class="text-slate-500 font-medium">Analysez vos performances avec des filtres personnalisés</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="PDGModule.exportReportPDF()" class="px-4 py-2 rounded-xl bg-red-50 text-red-600 font-black hover:bg-red-100 transition flex items-center gap-2">
                                <i data-lucide="file-pdf" class="w-4 h-4"></i> PDF
                            </button>
                            <button onclick="PDGModule.exportReportExcel()" class="px-4 py-2 rounded-xl bg-emerald-50 text-emerald-600 font-black hover:bg-emerald-100 transition flex items-center gap-2">
                                <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Excel
                            </button>
                        </div>
                    </div>

                    <!-- Filtres et Options de Rapport -->
                    <div class="bg-white rounded-3xl border border-slate-200 p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Type de Rapport</label>
                                <select onchange="PDGModule.state.reportType = this.value; App.rerender()" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                                    <option value="sales" ${reportType === 'sales' ? 'selected' : ''}>Ventes</option>
                                    <option value="deliveries" ${reportType === 'deliveries' ? 'selected' : ''}>Livraisons</option>
                                    <option value="inventory" ${reportType === 'inventory' ? 'selected' : ''}>Inventaire</option>
                                    <option value="summary" ${reportType === 'summary' ? 'selected' : ''}>Résumé Général</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Période</label>
                                <select onchange="PDGModule.state.periodType = this.value; App.rerender()" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                                    <option value="day" ${periodType === 'day' ? 'selected' : ''}>Jour</option>
                                    <option value="week" ${periodType === 'week' ? 'selected' : ''}>Semaine</option>
                                    <option value="month" ${periodType === 'month' ? 'selected' : ''}>Mois</option>
                                    <option value="year" ${periodType === 'year' ? 'selected' : ''}>Année</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">${periodType === 'day' ? 'Date' : periodType === 'week' ? 'Début semaine' : periodType === 'month' ? 'Mois' : 'Année'}</label>
                                <input type="${periodType === 'month' ? 'month' : periodType === 'year' ? 'number' : 'date'}" value="${periodType === 'month' ? selectedPeriod.substring(0, 7) : periodType === 'year' ? selectedPeriod.substring(0, 4) : selectedPeriod}" onchange="PDGModule.state.selectedPeriod = this.value; App.rerender()" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-xs font-black text-slate-600 uppercase mb-2">Comparer avec</label>
                                <button onclick="PDGModule.showComparisonPeriodModal()" class="w-full px-3 py-2 border border-slate-200 rounded-xl text-left text-slate-700 font-black hover:bg-slate-50">
                                    ${comparePeriod ? comparePeriod : 'Sélectionner...'}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- KPIs Principaux avec Comparaison -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-3xl border border-indigo-200 p-6">
                            <div class="text-indigo-700 text-xs font-black uppercase tracking-wider mb-2">Revenu Total</div>
                            <div class="text-3xl font-black text-indigo-600">${CORE.formatPrice(currentKpis.totalRevenue)}</div>
                            ${comparisons ? `<div class="text-xs mt-2 ${comparisons.revenue.value >= 0 ? 'text-emerald-600' : 'text-red-600'}"><i data-lucide="${comparisons.revenue.trend === 'up' ? 'trending-up' : comparisons.revenue.trend === 'down' ? 'trending-down' : 'minus'}" class="w-3 h-3 inline mr-1"></i>${comparisons.revenue.value > 0 ? '+' : ''}${comparisons.revenue.value}%</div>` : ''}
                        </div>
                        <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-3xl border border-slate-200 p-6">
                            <div class="text-slate-700 text-xs font-black uppercase tracking-wider mb-2">Commandes</div>
                            <div class="text-3xl font-black text-slate-600">${currentKpis.totalOrders}</div>
                            ${comparisons ? `<div class="text-xs mt-2 ${comparisons.orders.value >= 0 ? 'text-emerald-600' : 'text-red-600'}"><i data-lucide="${comparisons.orders.trend === 'up' ? 'trending-up' : comparisons.orders.trend === 'down' ? 'trending-down' : 'minus'}" class="w-3 h-3 inline mr-1"></i>${comparisons.orders.value > 0 ? '+' : ''}${comparisons.orders.value}%</div>` : ''}
                        </div>
                        <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-3xl border border-emerald-200 p-6">
                            <div class="text-emerald-700 text-xs font-black uppercase tracking-wider mb-2">Taux de Livraison</div>
                            <div class="text-3xl font-black text-emerald-600">${currentKpis.deliveryRate}%</div>
                            ${comparisons ? `<div class="text-xs mt-2 ${comparisons.delivery.value >= 0 ? 'text-emerald-600' : 'text-red-600'}"><i data-lucide="${comparisons.delivery.trend === 'up' ? 'trending-up' : comparisons.delivery.trend === 'down' ? 'trending-down' : 'minus'}" class="w-3 h-3 inline mr-1"></i>${comparisons.delivery.value > 0 ? '+' : ''}${comparisons.delivery.value}%</div>` : ''}
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-3xl border border-purple-200 p-6">
                            <div class="text-purple-700 text-xs font-black uppercase tracking-wider mb-2">Panier Moyen</div>
                            <div class="text-3xl font-black text-purple-600">${CORE.formatPrice(currentKpis.avgOrderValue)}</div>
                            ${comparisons ? `<div class="text-xs mt-2 ${comparisons.avg.value >= 0 ? 'text-emerald-600' : 'text-red-600'}"><i data-lucide="${comparisons.avg.trend === 'up' ? 'trending-up' : comparisons.avg.trend === 'down' ? 'trending-down' : 'minus'}" class="w-3 h-3 inline mr-1"></i>${comparisons.avg.value > 0 ? '+' : ''}${comparisons.avg.value}%</div>` : ''}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Top Villes -->
                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                            <div class="p-6 border-b border-slate-100">
                                <h3 class="font-black text-slate-900 flex items-center gap-2">
                                    <i data-lucide="map-pin" class="w-5 h-5 text-indigo-600"></i>
                                    Top Villes par CA
                                </h3>
                            </div>
                            <div class="p-4 space-y-2">
                                ${topCities.map((item, i) => `
                                    <div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 flex items-center justify-between">
                                        <div class="flex items-center gap-3 flex-1">
                                            <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center font-black text-indigo-600 text-sm">${i + 1}</div>
                                            <div class="min-w-0">
                                                <div class="font-black text-slate-900">${item.city.name}</div>
                                                <div class="text-xs text-slate-500">${item.orders} commandes</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-slate-900">${CORE.formatPrice(item.revenue)}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Statut Livraisons -->
                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                            <div class="p-6 border-b border-slate-100">
                                <h3 class="font-black text-slate-900 flex items-center gap-2">
                                    <i data-lucide="truck" class="w-5 h-5 text-emerald-600"></i>
                                    Statut des Livraisons
                                </h3>
                            </div>
                            <div class="p-6 space-y-4">
                                ${[
                                    { status: 'livree', label: 'Livrées', color: 'emerald', icon: 'check-circle' },
                                    { status: 'en_cours', label: 'En cours', color: 'amber', icon: 'activity' },
                                    { status: 'en_attente', label: 'En attente', color: 'blue', icon: 'clock' },
                                    { status: 'probleme', label: 'Problèmes', color: 'red', icon: 'alert-circle' }
                                ].map(item => `
                                    <div>
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-2 text-sm font-black text-slate-900">
                                                <i data-lucide="${item.icon}" class="w-4 h-4 text-${item.color}-600"></i>
                                                ${item.label}
                                            </div>
                                            <span class="text-sm font-black text-${item.color}-600">${deliveryStats[item.status]}</span>
                                        </div>
                                        <div class="h-2 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-${item.color}-500" data-percent="${currentDeliveries.length > 0 ? (deliveryStats[item.status] / currentDeliveries.length * 100) : 0}"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Top POS et Produits -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                            <div class="p-6 border-b border-slate-100">
                                <h3 class="font-black text-slate-900 flex items-center gap-2">
                                    <i data-lucide="shopping-bag" class="w-5 h-5 text-slate-600"></i>
                                    Top 10 POS par CA
                                </h3>
                            </div>
                            <div class="p-4 space-y-2 max-h-96 overflow-y-auto">
                                ${topPos.map((item, i) => `
                                    <div class="p-3 rounded-2xl border border-slate-100 hover:bg-slate-50 flex items-center justify-between">
                                        <div class="flex items-center gap-3 flex-1">
                                            <div class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center font-black text-slate-600 text-xs">${i + 1}</div>
                                            <div class="min-w-0">
                                                <div class="font-black text-slate-900 text-sm">${item.pos.name}</div>
                                                <div class="text-xs text-slate-500">${item.orders} cmd</div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="font-black text-sm">${CORE.formatPrice(item.revenue)}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">
                            <div class="p-6 border-b border-slate-100">
                                <h3 class="font-black text-slate-900 flex items-center gap-2">
                                    <i data-lucide="package" class="w-5 h-5 text-purple-600"></i>
                                    Top 10 Produits
                                </h3>
                            </div>
                            <div class="p-4 space-y-2 max-h-96 overflow-y-auto">
                                ${topProducts.map((item, i) => `
                                    <div class="p-3 rounded-2xl border border-slate-100 hover:bg-slate-50">
                                        <div class="flex items-center justify-between mb-1">
                                            <div class="flex items-center gap-2 flex-1">
                                                <div class="w-6 h-6 rounded-full bg-purple-100 flex items-center justify-center font-black text-purple-600 text-xs">${i + 1}</div>
                                                <div class="font-black text-slate-900 text-sm truncate">${item.product?.name || 'Inconnu'}</div>
                                            </div>
                                            <div class="text-right ml-2">
                                                <div class="font-black text-sm">${CORE.formatPrice(item.revenue)}</div>
                                                <div class="text-[10px] text-slate-500">${item.qty} u.</div>
                                            </div>
                                        </div>
                                        <div class="h-1 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-purple-500" data-width="${topProducts.length > 0 ? (item.revenue / Math.max(...topProducts.map(p => p.revenue)) * 100) : 0}"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        showComparisonPeriodModal() {
            UI.modal('Sélectionner la période de comparaison', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Période</label>
                        <select id="comparisonPeriodType" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                            <option value="day">Jour</option>
                            <option value="week">Semaine</option>
                            <option value="month" selected>Mois</option>
                            <option value="year">Année</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Date</label>
                        <input type="date" id="comparisonDate" class="w-full px-3 py-2 border border-slate-200 rounded-xl">
                    </div>
                </div>
            `, [
                { label: 'Confirmer', onclick: 'PDGModule.setComparisonPeriod()' },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        setComparisonPeriod() {
            const date = document.getElementById('comparisonDate').value;
            if (!date) {
                UI.toast('Sélectionnez une date', 'error');
                return;
            }
            this.state.comparePeriod = date;
            UI.closeModal();
            App.rerender();
        },

        exportReportPDF() {
            const reportType = this.state.reportType || 'sales';
            const periodType = this.state.periodType || 'month';
            const selectedPeriod = this.state.selectedPeriod || new Date().toISOString().split('T')[0];
            const k = this.getKpis();
            const companyName = (typeof CORE.getCompanyName === 'function' ? CORE.getCompanyName() : '') || 'RAYA';

            const printWindow = window.open('', '', 'width=900,height=700');
            printWindow.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Rapport ${reportType} - ${companyName}</title>
            <style>
                *{margin:0;padding:0;box-sizing:border-box}
                body{font-family:'Segoe UI',Arial,sans-serif;padding:40px;color:#1e293b;font-size:13px}
                .header{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:3px solid #6366f1;padding-bottom:20px;margin-bottom:30px}
                .logo{font-size:28px;font-weight:900;color:#6366f1}
                .meta{text-align:right;color:#64748b;font-size:11px}
                .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:30px}
                .kpi{background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:16px;text-align:center}
                .kpi-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#64748b;font-weight:700}
                .kpi-value{font-size:24px;font-weight:900;color:#1e293b;margin-top:4px}
                h2{font-size:16px;font-weight:800;margin:24px 0 12px;color:#334155;border-left:4px solid #6366f1;padding-left:12px}
                table{width:100%;border-collapse:collapse;margin-bottom:20px;font-size:12px}
                th{background:#6366f1;color:white;padding:10px 12px;text-align:left;font-weight:700;font-size:11px;text-transform:uppercase}
                td{padding:8px 12px;border-bottom:1px solid #e2e8f0}
                tr:nth-child(even){background:#f8fafc}
                tr:hover{background:#eff6ff}
                .footer{margin-top:40px;padding-top:16px;border-top:2px solid #e2e8f0;text-align:center;color:#94a3b8;font-size:10px}
                .amount{text-align:right;font-weight:700}
                .badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700}
                .badge-success{background:#dcfce7;color:#166534}
                .badge-warning{background:#fef9c3;color:#854d0e}
                .badge-danger{background:#fce7f3;color:#9f1239}
                @media print{body{padding:20px}}
            </style></head><body>`);

            printWindow.document.write(`
                <div class="header">
                    <div><div class="logo">${companyName}</div><div style="color:#64748b;font-size:12px;margin-top:4px">Rapport ${reportType === 'sales' ? 'des Ventes' : reportType === 'deliveries' ? 'des Livraisons' : reportType === 'inventory' ? "d'Inventaire" : 'Général'}</div></div>
                    <div class="meta">
                        <div><strong>Période:</strong> ${periodType} — ${selectedPeriod}</div>
                        <div><strong>Généré le:</strong> ${new Date().toLocaleString('fr-FR')}</div>
                        <div><strong>Par:</strong> ${CORE.state.currentUser?.name || 'PDG'}</div>
                    </div>
                </div>
                <div class="kpi-grid">
                    <div class="kpi"><div class="kpi-label">CA Total</div><div class="kpi-value">${CORE.formatPrice(k.deliveredRevenue)}</div></div>
                    <div class="kpi"><div class="kpi-label">Commandes</div><div class="kpi-value">${k.ordersTotal}</div></div>
                    <div class="kpi"><div class="kpi-label">Conversion</div><div class="kpi-value">${k.conversionRate}%</div></div>
                    <div class="kpi"><div class="kpi-label">Valeur Stock</div><div class="kpi-value">${CORE.formatPrice(k.inventoryValue)}</div></div>
                </div>
            `);

            const statusBadge = (s) => {
                const map = {delivered:'success',livree:'success',pending:'warning',en_attente:'warning',en_cours:'warning',cancelled:'danger',probleme:'danger'};
                return '<span class="badge badge-' + (map[s]||'warning') + '">' + s + '</span>';
            };

            if (reportType === 'sales' || reportType === 'summary') {
                const orders = CORE.getVisibleOrders().slice(0, 200);
                printWindow.document.write('<h2>Détail des Commandes (' + orders.length + ')</h2>');
                printWindow.document.write('<table><tr><th>Réf</th><th>Date</th><th>Client</th><th>POS</th><th>Statut</th><th>Paiement</th><th class="amount">Montant</th></tr>');
                orders.forEach(o => {
                    printWindow.document.write('<tr><td>' + (o.reference||o.id) + '</td><td>' + CORE.formatDate(o.createdAt) + '</td><td>' + (CORE.getClient && CORE.getClient(o.clientId)?.name || '—') + '</td><td>' + (CORE.getPOS(o.posId)?.name || '—') + '</td><td>' + statusBadge(o.status) + '</td><td>' + (o.paymentMethod||'—') + '</td><td class="amount">' + CORE.formatPrice(o.total||0) + '</td></tr>');
                });
                printWindow.document.write('</table>');
            }

            if (reportType === 'deliveries' || reportType === 'summary') {
                const deliveries = CORE.getVisibleDeliveries().slice(0, 200);
                printWindow.document.write('<h2>Détail des Livraisons (' + deliveries.length + ')</h2>');
                printWindow.document.write('<table><tr><th>ID</th><th>Date</th><th>Client</th><th>Livreur</th><th>Statut</th><th class="amount">Montant</th></tr>');
                deliveries.forEach(d => {
                    printWindow.document.write('<tr><td>' + d.id + '</td><td>' + CORE.formatDate(d.createdAt) + '</td><td>' + (d.clientName||'—') + '</td><td>' + (CORE.getUser(d.livreurId)?.name || '—') + '</td><td>' + statusBadge(d.status) + '</td><td class="amount">' + CORE.formatPrice(d.amount||0) + '</td></tr>');
                });
                printWindow.document.write('</table>');
            }

            if (reportType === 'inventory' || reportType === 'summary') {
                const products = CORE.getVisibleProducts();
                printWindow.document.write('<h2>Inventaire (' + products.length + ' produits)</h2>');
                printWindow.document.write('<table><tr><th>Produit</th><th>Catégorie</th><th>Stock</th><th>Min</th><th>Alerte</th><th class="amount">Prix</th><th class="amount">Valeur</th></tr>');
                products.forEach(p => {
                    const alert = (p.stock||0) <= (p.minStock||0) ? ((p.stock||0)===0 ? '<span class="badge badge-danger">RUPTURE</span>' : '<span class="badge badge-warning">BAS</span>') : '<span class="badge badge-success">OK</span>';
                    const cat = (CORE.db.categories||[]).find(c => c.id === p.categoryId);
                    printWindow.document.write('<tr><td><strong>' + p.name + '</strong></td><td>' + (cat?.name || '—') + '</td><td>' + (p.stock||0) + '</td><td>' + (p.minStock||0) + '</td><td>' + alert + '</td><td class="amount">' + CORE.formatPrice(p.price||0) + '</td><td class="amount">' + CORE.formatPrice((p.price||0)*(p.stock||0)) + '</td></tr>');
                });
                printWindow.document.write('</table>');
            }

            printWindow.document.write('<div class="footer">Rapport généré automatiquement par ' + companyName + ' — RAYA Manager &copy; ' + new Date().getFullYear() + '</div>');
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 500);
            UI.toast('Rapport PDF prêt pour impression', 'success');
        },

        exportReportExcel() {
            const reportType = this.state.reportType || 'sales';
            const periodType = this.state.periodType || 'month';
            const selectedPeriod = this.state.selectedPeriod || new Date().toISOString().split('T')[0];
            const companyName = (typeof CORE.getCompanyName === 'function' ? CORE.getCompanyName() : '') || 'RAYA';
            const k = this.getKpis();

            let csvContent = '\uFEFF'; // UTF-8 BOM for Excel
            csvContent += 'sep=;\n';
            csvContent += companyName + ' - Rapport ' + reportType.toUpperCase() + '\n';
            csvContent += 'Période;' + periodType + ' - ' + selectedPeriod + '\n';
            csvContent += 'Date export;' + new Date().toLocaleString('fr-FR') + '\n';
            csvContent += 'Généré par;' + (CORE.state.currentUser?.name || 'PDG') + '\n\n';

            // KPIs résumé
            csvContent += 'RÉSUMÉ\n';
            csvContent += 'CA Total;' + (k.deliveredRevenue||0) + '\n';
            csvContent += 'Commandes;' + k.ordersTotal + '\n';
            csvContent += 'Conversion;' + k.conversionRate + '%\n';
            csvContent += 'Valeur Stock;' + (k.inventoryValue||0) + '\n';
            csvContent += 'Ruptures;' + (k.outOfStock||0) + '\n';
            csvContent += 'Alertes Stock;' + k.stockAlerts + '\n\n';

            if (reportType === 'sales' || reportType === 'summary') {
                csvContent += 'COMMANDES\n';
                csvContent += 'Référence;Date;Client;POS;Ville;Vendeur;Statut;Paiement;Montant\n';
                CORE.getVisibleOrders().forEach(o => {
                    csvContent += '"' + (o.reference||o.id) + '";"' + CORE.formatDate(o.createdAt) + '";"' + (CORE.getClient && CORE.getClient(o.clientId)?.name || '') + '";"' + (CORE.getPOS(o.posId)?.name || '') + '";"' + (CORE.getCity(o.cityId)?.name || '') + '";"' + (CORE.getUser(o.sellerId)?.name || '') + '";"' + o.status + '";"' + (o.paymentMethod||'') + '";' + (o.total||0) + '\n';
                });
                csvContent += '\n';
            }

            if (reportType === 'deliveries' || reportType === 'summary') {
                csvContent += 'LIVRAISONS\n';
                csvContent += 'ID;Date;Client;Téléphone;Adresse;Livreur;Statut;Montant\n';
                CORE.getVisibleDeliveries().forEach(d => {
                    csvContent += d.id + ';"' + CORE.formatDate(d.createdAt) + '";"' + (d.clientName||'') + '";"' + (d.clientPhone||'') + '";"' + (d.address||'') + '";"' + (CORE.getUser(d.livreurId)?.name || '') + '";"' + d.status + '";' + (d.amount||0) + '\n';
                });
                csvContent += '\n';
            }

            if (reportType === 'inventory' || reportType === 'summary') {
                csvContent += 'INVENTAIRE\n';
                csvContent += 'Produit;Catégorie;Stock;Min;Alerte;Prix Unitaire;Valeur Stock\n';
                CORE.getVisibleProducts().forEach(p => {
                    const cat = (CORE.db.categories||[]).find(c => c.id === p.categoryId);
                    const alert = (p.stock||0) === 0 ? 'RUPTURE' : (p.stock||0) <= (p.minStock||0) ? 'BAS' : 'OK';
                    csvContent += '"' + p.name + '";"' + (cat?.name || '') + '";' + (p.stock||0) + ';' + (p.minStock||0) + ';"' + alert + '";' + (p.price||0) + ';' + ((p.price||0)*(p.stock||0)) + '\n';
                });
                csvContent += '\n';
            }

            // Performance par POS
            if (reportType === 'summary') {
                csvContent += 'PERFORMANCE PAR POS\n';
                csvContent += 'Point de Vente;Ville;Commandes;Livrées;CA;Panier Moyen\n';
                (CORE.db.pointsOfSale||[]).forEach(pos => {
                    const posOrders = CORE.getVisibleOrders().filter(o => o.posId === pos.id);
                    const delivered = posOrders.filter(o => o.status === 'delivered');
                    const revenue = delivered.reduce((a,o)=>a+(o.total||0), 0);
                    const avg = delivered.length > 0 ? Math.round(revenue/delivered.length) : 0;
                    csvContent += '"' + pos.name + '";"' + (CORE.getCity(pos.cityId)?.name||'') + '";' + posOrders.length + ';' + delivered.length + ';' + revenue + ';' + avg + '\n';
                });
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = companyName.replace(/\s/g,'_') + '_rapport_' + reportType + '_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(link);
            link.click();
            link.remove();
            UI.toast('Rapport Excel téléchargé', 'success');
        },

        // ---------------------------------------------------------------
        // GESTION MULTI-MAGASIN — Vue comparative de tous les POS
        // ---------------------------------------------------------------
        renderMultiStore() {
            const posList = CORE.db.pointsOfSale || [];
            const allOrders = CORE.getVisibleOrders();
            const allDeliveries = CORE.getVisibleDeliveries();
            const allProducts = CORE.getVisibleProducts();
            const todayStr = new Date().toDateString();
            const storeFilter = this.state.storeFilter || 'all';

            const storeStats = posList.map(pos => {
                const posOrders = allOrders.filter(o => o.posId === pos.id);
                const delivered = posOrders.filter(o => o.status === 'delivered');
                const pending = posOrders.filter(o => ['pending','confirmed'].includes(o.status));
                const revenue = delivered.reduce((a,o) => a + (o.total||0), 0);
                const todayOrders = posOrders.filter(o => o.createdAt && new Date(o.createdAt).toDateString() === todayStr);
                const todayRevenue = todayOrders.filter(o => o.status === 'delivered').reduce((a,o) => a + (o.total||0), 0);
                const posDeliveries = allDeliveries.filter(d => d.posId === pos.id);
                const deliveredCount = posDeliveries.filter(d => d.status === 'livree').length;
                const deliveryRate = posDeliveries.length > 0 ? Math.round((deliveredCount / posDeliveries.length) * 100) : 0;
                const posProducts = allProducts.filter(p => p.posId === pos.id);
                const stockAlerts = posProducts.filter(p => (p.stock||0) <= (p.minStock||0)).length;
                const outOfStock = posProducts.filter(p => (p.stock||0) === 0).length;
                const stockValue = posProducts.reduce((a,p) => a + (p.price||0) * (p.stock||0), 0);
                const sellers = (CORE.getVisibleUsers() || []).filter(u => u.posId === pos.id || u.pos === pos.id);
                const avgTicket = delivered.length > 0 ? Math.round(revenue / delivered.length) : 0;
                const city = CORE.getCity(pos.cityId);
                return { pos, city, revenue, todayRevenue, ordersTotal: posOrders.length, delivered: delivered.length, pending: pending.length, todayOrdersCount: todayOrders.length, deliveryRate, stockAlerts, outOfStock, stockValue, productsCount: posProducts.length, sellersCount: sellers.length, avgTicket };
            }).sort((a,b) => b.revenue - a.revenue);

            const totals = { revenue: storeStats.reduce((a,s) => a+s.revenue, 0), todayRevenue: storeStats.reduce((a,s) => a+s.todayRevenue, 0), orders: storeStats.reduce((a,s) => a+s.ordersTotal, 0), todayOrders: storeStats.reduce((a,s) => a+s.todayOrdersCount, 0), stockAlerts: storeStats.reduce((a,s) => a+s.stockAlerts, 0), outOfStock: storeStats.reduce((a,s) => a+s.outOfStock, 0), stockValue: storeStats.reduce((a,s) => a+s.stockValue, 0) };
            const selectedStore = storeFilter !== 'all' ? storeStats.find(s => String(s.pos.id) === String(storeFilter)) : null;

            return `
                <div class="fade-in max-w-7xl mx-auto space-y-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h1 class="text-3xl font-black text-slate-900 flex items-center gap-3"><i data-lucide="building-2" class="w-8 h-8 text-indigo-600"></i> Gestion Multi-Magasins</h1>
                            <p class="text-slate-500 font-medium mt-1">${posList.length} point(s) de vente</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <select onchange="PDGModule.state.storeFilter = this.value; App.rerender()" class="px-4 py-2.5 border border-slate-200 rounded-xl font-bold text-sm">
                                <option value="all" ${storeFilter === 'all' ? 'selected' : ''}>Tous les magasins</option>
                                ${posList.map(p => '<option value="' + p.id + '" ' + (String(storeFilter) === String(p.id) ? 'selected' : '') + '>' + p.name + '</option>').join('')}
                            </select>
                            <button onclick="PDGModule.exportStoresReport()" class="px-4 py-2.5 bg-emerald-50 text-emerald-700 rounded-xl font-bold hover:bg-emerald-100 transition flex items-center gap-2 text-sm">
                                <i data-lucide="download" class="w-4 h-4"></i> Exporter
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
                        <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-2xl p-4 text-white"><div class="text-xs text-white/70 font-bold uppercase">Magasins</div><div class="text-2xl font-black mt-1">${posList.length}</div></div>
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-4 text-white"><div class="text-xs text-white/70 font-bold uppercase">CA Total</div><div class="text-xl font-black mt-1">${CORE.formatPrice(totals.revenue)}</div></div>
                        <div class="bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-2xl p-4 text-white"><div class="text-xs text-white/70 font-bold uppercase">CA Aujourd'hui</div><div class="text-xl font-black mt-1">${CORE.formatPrice(totals.todayRevenue)}</div></div>
                        <div class="bg-gradient-to-br from-violet-500 to-violet-600 rounded-2xl p-4 text-white"><div class="text-xs text-white/70 font-bold uppercase">Commandes</div><div class="text-2xl font-black mt-1">${totals.orders}</div></div>
                        <div class="bg-gradient-to-br from-amber-500 to-amber-600 rounded-2xl p-4 text-white"><div class="text-xs text-white/70 font-bold uppercase">Aujourd'hui</div><div class="text-2xl font-black mt-1">${totals.todayOrders} cmd</div></div>
                        <div class="bg-gradient-to-br from-red-500 to-pink-500 rounded-2xl p-4 text-white"><div class="text-xs text-white/70 font-bold uppercase">Ruptures</div><div class="text-2xl font-black mt-1">${totals.outOfStock}</div></div>
                        <div class="bg-gradient-to-br from-slate-700 to-slate-800 rounded-2xl p-4 text-white"><div class="text-xs text-white/70 font-bold uppercase">Valeur Stock</div><div class="text-xl font-black mt-1">${CORE.formatPrice(totals.stockValue)}</div></div>
                    </div>

                    ${selectedStore ? this._renderStoreDetail(selectedStore) : ''}

                    <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="p-6 border-b border-slate-100"><h3 class="font-black text-slate-900 text-lg flex items-center gap-2"><i data-lucide="bar-chart-3" class="w-5 h-5 text-indigo-600"></i> Comparatif des Magasins</h3></div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead><tr class="bg-slate-50 border-b border-slate-200">
                                    <th class="text-left px-4 py-3 font-black text-slate-600 text-xs uppercase">#</th>
                                    <th class="text-left px-4 py-3 font-black text-slate-600 text-xs uppercase">Magasin</th>
                                    <th class="text-left px-4 py-3 font-black text-slate-600 text-xs uppercase">Ville</th>
                                    <th class="text-right px-4 py-3 font-black text-slate-600 text-xs uppercase">CA Total</th>
                                    <th class="text-right px-4 py-3 font-black text-slate-600 text-xs uppercase">CA Jour</th>
                                    <th class="text-right px-4 py-3 font-black text-slate-600 text-xs uppercase">Cmd</th>
                                    <th class="text-right px-4 py-3 font-black text-slate-600 text-xs uppercase">Panier</th>
                                    <th class="text-center px-4 py-3 font-black text-slate-600 text-xs uppercase">Livraison</th>
                                    <th class="text-center px-4 py-3 font-black text-slate-600 text-xs uppercase">Stock</th>
                                    <th class="text-center px-4 py-3 font-black text-slate-600 text-xs uppercase">Action</th>
                                </tr></thead>
                                <tbody>
                                    ${storeStats.map((s, i) => {
                                        const share = totals.revenue > 0 ? ((s.revenue / totals.revenue) * 100).toFixed(1) : 0;
                                        return '<tr class="border-b border-slate-100 hover:bg-slate-50 transition">' +
                                            '<td class="px-4 py-3"><div class="w-7 h-7 ' + (i===0?'bg-amber-100 text-amber-700':i===1?'bg-slate-200 text-slate-700':'bg-slate-100 text-slate-500') + ' rounded-lg flex items-center justify-center font-black text-xs">' + (i+1) + '</div></td>' +
                                            '<td class="px-4 py-3"><div class="font-black text-slate-900">' + s.pos.name + '</div><div class="text-xs text-slate-400">' + share + '% du CA</div></td>' +
                                            '<td class="px-4 py-3 text-slate-600">' + (s.city?.name || '') + '</td>' +
                                            '<td class="px-4 py-3 text-right font-black text-emerald-600">' + CORE.formatPrice(s.revenue) + '</td>' +
                                            '<td class="px-4 py-3 text-right font-bold text-indigo-600">' + CORE.formatPrice(s.todayRevenue) + '</td>' +
                                            '<td class="px-4 py-3 text-right"><span class="font-black">' + s.ordersTotal + '</span>' + (s.todayOrdersCount > 0 ? '<span class="text-xs text-indigo-500 ml-1">+' + s.todayOrdersCount + '</span>' : '') + '</td>' +
                                            '<td class="px-4 py-3 text-right font-bold text-slate-700">' + CORE.formatPrice(s.avgTicket) + '</td>' +
                                            '<td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded-full text-xs font-bold ' + (s.deliveryRate>=80?'bg-emerald-100 text-emerald-700':s.deliveryRate>=50?'bg-amber-100 text-amber-700':'bg-red-100 text-red-700') + '">' + s.deliveryRate + '%</span></td>' +
                                            '<td class="px-4 py-3 text-center">' + (s.outOfStock > 0 ? '<span class="px-2 py-1 rounded-full bg-red-100 text-red-700 text-xs font-bold">' + s.outOfStock + ' rupt.</span>' : s.stockAlerts > 0 ? '<span class="px-2 py-1 rounded-full bg-amber-100 text-amber-700 text-xs font-bold">' + s.stockAlerts + '</span>' : '<span class="px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 text-xs font-bold">OK</span>') + '</td>' +
                                            '<td class="px-4 py-3 text-center"><button onclick="PDGModule.state.storeFilter=\'' + s.pos.id + '\'; App.rerender()" class="px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-lg text-xs font-bold hover:bg-indigo-100 transition">Détails</button></td>' +
                                        '</tr>';
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="font-black text-slate-900 mb-4 flex items-center gap-2"><i data-lucide="trending-up" class="w-5 h-5 text-emerald-600"></i> Répartition du CA</h3>
                            <div class="space-y-3">
                                ${storeStats.slice(0,8).map((s, i) => {
                                    const maxRev = Math.max(...storeStats.map(x => x.revenue), 1);
                                    const pct = (s.revenue / maxRev) * 100;
                                    const colors = ['from-indigo-500 to-indigo-600','from-emerald-500 to-emerald-600','from-violet-500 to-violet-600','from-amber-500 to-amber-600','from-cyan-500 to-cyan-600','from-pink-500 to-pink-600','from-slate-500 to-slate-600','from-rose-500 to-rose-600'];
                                    return '<div class="flex items-center gap-3"><span class="text-xs font-black text-slate-500 w-24 truncate">' + s.pos.name + '</span><div class="flex-1 h-7 bg-slate-100 rounded-lg overflow-hidden relative"><div class="absolute inset-y-0 left-0 bg-gradient-to-r ' + colors[i%colors.length] + ' rounded-lg" style="width:' + pct + '%"></div><div class="absolute inset-0 flex items-center justify-end pr-2"><span class="text-[10px] font-black ' + (pct>40?'text-white':'text-slate-600') + '">' + CORE.formatPrice(s.revenue) + '</span></div></div></div>';
                                }).join('')}
                            </div>
                        </div>
                        <div class="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="font-black text-slate-900 mb-4 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-5 h-5 text-amber-500"></i> Alertes par Magasin</h3>
                            <div class="space-y-2">
                                ${storeStats.filter(s => s.stockAlerts > 0 || s.outOfStock > 0).length === 0 ? '<div class="text-center text-slate-400 py-8"><i data-lucide="check-circle" class="w-12 h-12 mx-auto mb-2 text-emerald-400"></i><div class="font-bold">Aucune alerte</div></div>' : ''}
                                ${storeStats.filter(s => s.outOfStock > 0).map(s => '<div class="p-3 rounded-xl border border-red-200 bg-red-50 flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-red-200 rounded-lg flex items-center justify-center"><i data-lucide="package-x" class="w-4 h-4 text-red-700"></i></div><div><div class="font-black text-red-900 text-sm">' + s.pos.name + '</div><div class="text-xs text-red-700">' + s.outOfStock + ' rupture(s)</div></div></div><button onclick="PDGModule.state.storeFilter=\'' + s.pos.id + '\'; App.rerender()" class="text-xs font-bold text-red-700 hover:underline">Voir</button></div>').join('')}
                                ${storeStats.filter(s => s.stockAlerts > s.outOfStock).map(s => '<div class="p-3 rounded-xl border border-amber-200 bg-amber-50 flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-amber-200 rounded-lg flex items-center justify-center"><i data-lucide="alert-triangle" class="w-4 h-4 text-amber-700"></i></div><div><div class="font-black text-amber-900 text-sm">' + s.pos.name + '</div><div class="text-xs text-amber-700">' + (s.stockAlerts-s.outOfStock) + ' article(s) bas</div></div></div><button onclick="PDGModule.state.storeFilter=\'' + s.pos.id + '\'; App.rerender()" class="text-xs font-bold text-amber-700 hover:underline">Voir</button></div>').join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },

        _renderStoreDetail(s) {
            const products = CORE.getVisibleProducts().filter(p => p.posId === s.pos.id);
            const lowStockProducts = products.filter(p => (p.stock||0) <= (p.minStock||0)).sort((a,b) => (a.stock||0)-(b.stock||0));
            return `
                <div class="bg-white rounded-3xl border-2 border-indigo-200 p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg"><i data-lucide="store" class="w-7 h-7 text-white"></i></div>
                            <div>
                                <h3 class="text-xl font-black text-slate-900">${s.pos.name}</h3>
                                <p class="text-sm text-slate-500">${s.city?.name || ''} ${s.pos.telephone ? '• ' + s.pos.telephone : ''} ${s.pos.address ? '• ' + s.pos.address : ''}</p>
                            </div>
                        </div>
                        <button onclick="PDGModule.state.storeFilter='all'; App.rerender()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-xl font-bold hover:bg-slate-200 transition text-sm flex items-center gap-2"><i data-lucide="x" class="w-4 h-4"></i> Fermer</button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3 mb-6">
                        <div class="bg-emerald-50 rounded-xl p-3 text-center"><div class="text-[10px] text-emerald-600 font-bold uppercase">CA Total</div><div class="text-lg font-black text-emerald-700">${CORE.formatPrice(s.revenue)}</div></div>
                        <div class="bg-indigo-50 rounded-xl p-3 text-center"><div class="text-[10px] text-indigo-600 font-bold uppercase">CA Jour</div><div class="text-lg font-black text-indigo-700">${CORE.formatPrice(s.todayRevenue)}</div></div>
                        <div class="bg-violet-50 rounded-xl p-3 text-center"><div class="text-[10px] text-violet-600 font-bold uppercase">Commandes</div><div class="text-lg font-black text-violet-700">${s.ordersTotal}</div></div>
                        <div class="bg-cyan-50 rounded-xl p-3 text-center"><div class="text-[10px] text-cyan-600 font-bold uppercase">Panier Moy</div><div class="text-lg font-black text-cyan-700">${CORE.formatPrice(s.avgTicket)}</div></div>
                        <div class="bg-amber-50 rounded-xl p-3 text-center"><div class="text-[10px] text-amber-600 font-bold uppercase">Livraison</div><div class="text-lg font-black text-amber-700">${s.deliveryRate}%</div></div>
                        <div class="${s.outOfStock > 0 ? 'bg-red-50' : 'bg-slate-50'} rounded-xl p-3 text-center"><div class="text-[10px] ${s.outOfStock > 0 ? 'text-red-600' : 'text-slate-600'} font-bold uppercase">Ruptures</div><div class="text-lg font-black ${s.outOfStock > 0 ? 'text-red-700' : 'text-slate-700'}">${s.outOfStock}</div></div>
                        <div class="bg-slate-50 rounded-xl p-3 text-center"><div class="text-[10px] text-slate-600 font-bold uppercase">Produits</div><div class="text-lg font-black text-slate-700">${s.productsCount}</div></div>
                        <div class="bg-purple-50 rounded-xl p-3 text-center"><div class="text-[10px] text-purple-600 font-bold uppercase">Équipe</div><div class="text-lg font-black text-purple-700">${s.sellersCount}</div></div>
                    </div>
                    ${lowStockProducts.length > 0 ? '<div><h4 class="font-black text-sm text-slate-700 mb-2 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-4 h-4 text-amber-500"></i> Produits en alerte (' + lowStockProducts.length + ')</h4><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">' + lowStockProducts.slice(0,6).map(p => '<div class="p-3 rounded-xl border ' + ((p.stock||0)===0?'border-red-200 bg-red-50':'border-amber-200 bg-amber-50') + ' flex items-center justify-between"><div><div class="font-bold text-sm text-slate-900">' + p.name + '</div><div class="text-xs text-slate-500">' + CORE.formatPrice(p.price||0) + '</div></div><div class="text-right"><div class="text-lg font-black ' + ((p.stock||0)===0?'text-red-600':'text-amber-600') + '">' + (p.stock||0) + '</div><div class="text-[10px] text-slate-400">min: ' + (p.minStock||0) + '</div></div></div>').join('') + '</div></div>' : ''}
                </div>
            `;
        },

        exportStoresReport() {
            const posList = CORE.db.pointsOfSale || [];
            const allOrders = CORE.getVisibleOrders();
            const allProducts = CORE.getVisibleProducts();
            const companyName = (typeof CORE.getCompanyName === 'function' ? CORE.getCompanyName() : '') || 'RAYA';
            let csv = '\uFEFF' + 'sep=;\n' + companyName + ' - Rapport Multi-Magasins\nDate;' + new Date().toLocaleString('fr-FR') + '\n\n';
            csv += 'Magasin;Ville;CA Total;Commandes;Panier Moyen;Taux Livraison;Ruptures;Alertes Stock;Produits\n';
            posList.forEach(pos => {
                const posOrders = allOrders.filter(o => o.posId === pos.id);
                const delivered = posOrders.filter(o => o.status === 'delivered');
                const revenue = delivered.reduce((a,o)=>a+(o.total||0), 0);
                const posProducts = allProducts.filter(p => p.posId === pos.id);
                const outOfStock = posProducts.filter(p => (p.stock||0)===0).length;
                const stockAlerts = posProducts.filter(p => (p.stock||0)<=(p.minStock||0)).length;
                const avg = delivered.length > 0 ? Math.round(revenue/delivered.length) : 0;
                const deliv = CORE.getVisibleDeliveries().filter(d => d.posId === pos.id);
                const delivRate = deliv.length > 0 ? Math.round(deliv.filter(d=>d.status==='livree').length/deliv.length*100) : 0;
                csv += '"' + pos.name + '";"' + (CORE.getCity(pos.cityId)?.name||'') + '";' + revenue + ';' + posOrders.length + ';' + avg + ';' + delivRate + '%;' + outOfStock + ';' + stockAlerts + ';' + posProducts.length + '\n';
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = companyName.replace(/\s/g,'_') + '_multi_magasins_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(link);
            link.click();
            link.remove();
            UI.toast('Rapport multi-magasins exporté', 'success');
        },

        renderContent() {
            const v = this.state.currentView;
            try {
                if (v === 'overview') return this.renderOverview();
                if (v === 'orders') return this.renderOrders();
                if (v === 'deliveries') return this.renderDeliveries();
                if (v === 'inventory') return ManagerModule.renderInventory();
                if (v === 'main-stock') { console.log('[PDG] Calling ManagerModule.renderMainStockControlCenter...'); const result = ManagerModule.renderMainStockControlCenter(); console.log('[PDG] renderMainStockControlCenter returned, length:', (result||'').length); return result; }
                if (v === 'stock') return this.renderStock();
                if (v === 'pos') return this.renderPOS();
                if (v === 'finance') return this.renderFinance();
                if (v === 'team') return this.renderTeam();
                if (v === 'activity') return this.renderActivity();
                if (v === 'commandes') return this.renderCommandes();
                if (v === 'reports') return this.renderAdvancedReports();
                if (v === 'audit') return this.renderAuditTrail();
                if (v === 'stores') return this.renderMultiStore();
                if (v === 'settings') return this.renderSettings();
                return this.renderOverview();
            } catch(err) {
                console.error('PDG renderContent error for view:', v, err);
                return `<div class="p-8 text-center"><div class="text-6xl mb-4">âš ï¸</div><h2 class="text-xl font-black text-red-600 mb-2">Erreur de rendu</h2><p class="text-slate-600 mb-4">Vue "${v}" erreur: ${err.message}</p><button onclick="PDGModule.navigateTo('overview')" class="px-6 py-3 bg-slate-900 text-white rounded-xl font-bold">Retour</button></div>`;
            }
        },

        /**
         * ISOLATION COMPLÈTE: Panel de vérification et d'enforcement de l'isolation
         */
        renderIsolationPanel() {
            const report = CORE.validatePOSIsolation();
            return `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-8 rounded-2xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-black mb-2">🔐 Isolation & Sécurité</h1>
                                <p class="text-white/80">Vérification que chaque POS est COMPLÈTEMENT isolé</p>
                            </div>
                            <div class="text-5xl">${report.isolationStatus === 'FULLY_ISOLATED' ? '✅' : '⚠️'}</div>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                            <div class="text-xs font-black text-slate-500 uppercase mb-1">Points de Vente</div>
                            <div class="text-3xl font-black text-slate-900">${report.posCount}</div>
                        </div>
                        <div class="bg-${report.isolationStatus === 'FULLY_ISOLATED' ? 'emerald' : 'amber'}-50 p-6 rounded-2xl border border-${report.isolationStatus === 'FULLY_ISOLATED' ? 'emerald' : 'amber'}-200">
                            <div class="text-xs font-black text-${report.isolationStatus === 'FULLY_ISOLATED' ? 'emerald' : 'amber'}-600 uppercase mb-1">État Isolation</div>
                            <div class="text-xl font-black text-${report.isolationStatus === 'FULLY_ISOLATED' ? 'emerald' : 'amber'}-900">${report.isolationStatus === 'FULLY_ISOLATED' ? 'ISOLÉ' : 'À CORRIGER'}</div>
                        </div>
                        <div class="bg-${report.issueCount === 0 ? 'emerald' : 'red'}-50 p-6 rounded-2xl border border-${report.issueCount === 0 ? 'emerald' : 'red'}-200">
                            <div class="text-xs font-black text-${report.issueCount === 0 ? 'emerald' : 'red'}-600 uppercase mb-1">Problèmes</div>
                            <div class="text-3xl font-black text-${report.issueCount === 0 ? 'emerald' : 'red'}-900">${report.issueCount}</div>
                        </div>
                    </div>

                    <!-- Rapport Détaillé -->
                    <div class="bg-white border border-slate-200 rounded-2xl p-6">
                        <h2 class="text-lg font-black text-slate-900 mb-4">📊 Rapport Détaillé</h2>
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            ${report.issues.map(issue => `
                                <div class="flex items-start gap-3 text-sm">
                                    <span class="font-black text-lg mt-0.5">${issue.includes('✅') ? '✅' : issue.includes('❌') ? '❌' : '⚠️'}</span>
                                    <span class="text-slate-700">${issue}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Données par POS -->
                    <div class="bg-white border border-slate-200 rounded-2xl p-6">
                        <h2 class="text-lg font-black text-slate-900 mb-4">📈 Données par POS</h2>
                        <div class="space-y-4">
                            ${Object.entries(report.summary).map(([key, data]) => `
                                <div class="p-4 bg-gradient-to-r from-slate-50 to-slate-100 rounded-xl border border-slate-200">
                                    <div class="font-black text-slate-900 mb-2">${data.name}</div>
                                    <div class="grid grid-cols-3 md:grid-cols-6 gap-2 text-xs">
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Clients</div>
                                            <div class="font-black text-lg text-slate-900">${data.clients}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Commandes</div>
                                            <div class="font-black text-lg text-slate-900">${data.orders}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Livraisons</div>
                                            <div class="font-black text-lg text-slate-900">${data.deliveries}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Transactions</div>
                                            <div class="font-black text-lg text-slate-900">${data.transactions}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Notif</div>
                                            <div class="font-black text-lg text-slate-900">${data.notifications}</div>
                                        </div>
                                        <div class="bg-white p-2 rounded-lg text-center">
                                            <div class="text-slate-500">Mvmts</div>
                                            <div class="font-black text-lg text-slate-900">${data.stockMovements}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="bg-indigo-50 border-2 border-indigo-200 rounded-2xl p-6">
                        <div class="font-black text-indigo-900 mb-4">⚙️ Actions</div>
                        <div class="space-y-2">
                            <button onclick="PDGModule.performIsolationValidation()" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-xl font-black hover:bg-indigo-700 transition">
                                🔍 Valider Isolation Complète
                            </button>
                            <button onclick="if(confirm('Cela va forcer le respect complet de l\'isolation. Continuer ?')) { PDGModule.performForcedIsolation(); }" class="w-full px-4 py-3 bg-orange-600 text-white rounded-xl font-black hover:bg-orange-700 transition">
                                🔒 Forcer Isolation (DANGER!)
                            </button>
                        </div>
                    </div>

                    <!-- Info -->
                    <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4 text-xs text-blue-800">
                        <div class="font-black mb-2">ℹ️ À propos de l'isolation</div>
                        <p>Chaque Point de Vente doit être COMPLÈTEMENT ISOLÉ. Aucun client, commande, livraison ou notification ne doit être partagé entre les POS. Cette page vérifie que chaque POS dispose d'une structure de données indépendante.</p>
                    </div>
                </div>
            `;
        },

        /**
         * ISOLATION: Valide et affiche un rapport d'isolation
         */
        performIsolationValidation() {
            const report = CORE.validatePOSIsolation();
            const isFull = report.isolationStatus === 'FULLY_ISOLATED';

            UI.modal('Rapport d\'Isolation', `
                <div class="space-y-4">
                    <div class="p-4 rounded-xl ${isFull ? 'bg-emerald-50 border border-emerald-200' : 'bg-amber-50 border border-amber-200'}">
                        <div class="font-black ${isFull ? 'text-emerald-900' : 'text-amber-900'}">
                            ${isFull ? '✅ Isolation Complète Confirmée!' : '⚠️ Isolation Incomplète'}
                        </div>
                        <div class="text-sm ${isFull ? 'text-emerald-800' : 'text-amber-800'} mt-2">
                            ${isFull ? 'Tous les POS sont correctement isolés.' : `${report.issueCount} problème(s) détecté(s).`}
                        </div>
                    </div>
                    <div class="text-xs text-slate-600 max-h-48 overflow-y-auto space-y-2">
                        ${report.issues.map(i => `<div>${i}</div>`).join('')}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        /**
         * ISOLATION: Force l'application complète de l'isolation
         */
        performForcedIsolation() {
            const report = CORE.enforceISOLATION();
            UI.toast('🔒 Isolation forcée appliquée!', 'success');
            UI.modal('Isolation Forcée Appliquée', `
                <div class="space-y-4">
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                        <div class="font-black text-emerald-900">✅ Isolation Complète Appliquée!</div>
                        <div class="text-sm text-emerald-800 mt-2">Tous les POS ont été forcés à l'isolation complète.</div>
                    </div>
                    <div class="text-xs text-slate-600">
                        <div class="font-black mb-2">Résumé:</div>
                        <div>Timestamp: ${report.timestamp}</div>
                        <div>POS: ${report.posCount}</div>
                        <div>État: ${report.isolationStatus}</div>
                    </div>
                </div>
            `, [
                { label: 'OK', onclick: 'UI.closeModal(); PDGModule.navigateTo("isolation");' }
            ]);
            setTimeout(() => App.rerender(), 500);
        },

        renderNavItem(view, icon, label, badge = 0) {
            const active = this.state.currentView === view;
            return `
                <button onclick="PDGModule.navigateTo('${view}')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 group ${active ? 'bg-gradient-to-r from-violet-500/20 to-purple-500/10 text-purple-300 border-l-2 border-purple-400' : 'text-slate-400 hover:bg-white/5 hover:text-white'}">
                    <div class="w-9 h-9 rounded-xl ${active ? 'bg-purple-500/20' : 'bg-white/5 group-hover:bg-white/10'} flex items-center justify-center transition-all duration-200 relative">
                        <i data-lucide="${icon}" class="w-5 h-5 ${active ? 'drop-shadow-[0_0_8px_rgba(139,92,246,0.5)]' : ''}"></i>
                        ${badge > 0 ? `<span class="absolute -top-1 -right-1 min-w-[18px] h-[18px] bg-red-500 text-white text-[10px] font-black rounded-full flex items-center justify-center animate-pulse shadow-lg shadow-red-500/40">${badge > 9 ? '9+' : badge}</span>` : ''}
                    </div>
                    <span class="font-bold text-sm">${label}</span>
                    ${active ? '<div class="ml-auto w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div>' : ''}
                </button>`;
        },

        showRolesManagementModal() {
            const roles = CORE.db.roles || [];
            const customRoles = roles.filter(r => r.isCustom);
            const defaultRoles = roles.filter(r => !r.isCustom);

            UI.modal('Gestion des Rôles', `
                <div class="space-y-6 max-h-[70vh] overflow-y-auto">
                    <!-- Créer un nouveau rôle -->
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                        <div class="font-black text-emerald-900 mb-3">➕ Créer un Rôle Personnalisé</div>
                        <div class="space-y-3">
                            <input type="text" id="newRoleName" placeholder="Nom du rôle" class="w-full px-3 py-2 border border-emerald-300 rounded-xl">
                            <textarea id="newRoleDesc" placeholder="Description" class="w-full px-3 py-2 border border-emerald-300 rounded-xl" rows="2"></textarea>
                            <button onclick="PDGModule.createNewCustomRole()" class="w-full px-3 py-2 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700">Créer le rôle</button>
                        </div>
                    </div>

                    <!-- Rôles par défaut -->
                    <div>
                        <div class="text-xs font-black text-slate-600 uppercase mb-2">Rôles par Défaut (${defaultRoles.length})</div>
                        ${defaultRoles.map(role => `
                            <div class="p-4 rounded-2xl border border-slate-100 hover:bg-slate-50 mb-2">
                                <div class="flex items-start justify-between mb-2">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="${role.icon}" class="w-5 h-5 text-${role.color}-600"></i>
                                            <span class="font-black text-slate-900">${role.name}</span>
                                        </div>
                                        <div class="text-xs text-slate-500">${role.description}</div>
                                    </div>
                                </div>
                                <div class="text-xs font-black text-slate-600 mb-2">Permissions: ${role.permissions?.length || 0}</div>
                                <button onclick="PDGModule.showRoleDetailsModal('${role.id}')" class="text-xs font-black text-indigo-600 hover:text-indigo-700">Voir détails</button>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Rôles personnalisés -->
                    ${customRoles.length > 0 ? `
                        <div>
                            <div class="text-xs font-black text-slate-600 uppercase mb-2">Rôles Personnalisés (${customRoles.length})</div>
                            ${customRoles.map(role => `
                                <div class="p-4 rounded-2xl border-2 border-purple-200 bg-purple-50 mb-2">
                                    <div class="flex items-start justify-between mb-2">
                                        <div>
                                            <div class="flex items-center gap-2">
                                                <i data-lucide="${role.icon}" class="w-5 h-5 text-purple-600"></i>
                                                <span class="font-black text-slate-900">${role.name}</span>
                                            </div>
                                            <div class="text-xs text-slate-500">${role.description}</div>
                                        </div>
                                        <i data-lucide="star" class="w-4 h-4 text-purple-600"></i>
                                    </div>
                                    <div class="text-xs font-black text-slate-600 mb-2">Permissions: ${role.permissions?.length || 0}</div>
                                    <div class="flex gap-2">
                                        <button onclick="PDGModule.showRoleDetailsModal('${role.id}')" class="text-xs font-black text-indigo-600 hover:text-indigo-700">Modifier</button>
                                        <button onclick="if(confirm('Supprimer ce rôle ?')) { CORE.deleteCustomRole('${role.id}'); PDGModule.showRolesManagementModal(); }" class="text-xs font-black text-red-600 hover:text-red-700">Supprimer</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showRoleDetailsModal(roleId) {
            const role = CORE.db.roles?.find(r => r.id === roleId);
            if (!role) return UI.toast('Rôle introuvable', 'error');

            const allPermissions = CORE.db.permissions || [];
            const categories = [...new Set(allPermissions.map(p => p.category))];

            UI.modal('Détails - ' + role.name, `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <div class="text-xs font-black text-slate-600">Nom</div>
                                <div class="font-black text-slate-900">${role.name}</div>
                            </div>
                            <div>
                                <div class="text-xs font-black text-slate-600">Type</div>
                                <div class="font-black text-slate-900">${role.isCustom ? '⭐ Personnalisé' : '🔧 Défaut'}</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="text-xs font-black text-slate-600 uppercase mb-3">Permissions</div>
                        <div class="space-y-4">
                            ${categories.map(cat => `
                                <div class="p-4 rounded-2xl border border-slate-200">
                                    <div class="font-black text-slate-900 mb-3">${cat.charAt(0).toUpperCase() + cat.slice(1)}</div>
                                    <div class="space-y-2">
                                        ${allPermissions.filter(p => p.category === cat).map(perm => {
                                            const hasPermission = role.permissions?.includes(perm.id) || role.permissions?.includes('all');
                                            return `
                                                <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50">
                                                    <input type="checkbox" ${hasPermission ? 'checked' : ''} ${role.id === 'pdg' ? 'disabled' : ''} onchange="PDGModule.togglePermissionForRole('${roleId}', '${perm.id}', this.checked)" class="w-4 h-4 rounded">
                                                    <div class="flex-1 min-w-0">
                                                        <div class="text-sm font-black text-slate-900">${perm.label}</div>
                                                    </div>
                                                </label>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        togglePermissionForRole(roleId, permissionId, hasPermission) {
            const role = CORE.db.roles?.find(r => r.id === roleId);
            if (!role || role.id === 'pdg') return UI.toast('Impossible de modifier ce rôle', 'error');

            if (hasPermission) {
                if (!role.permissions.includes(permissionId)) {
                    role.permissions.push(permissionId);
                }
            } else {
                role.permissions = role.permissions.filter(p => p !== permissionId);
            }

            CORE.save();
            CORE.logAudit('update', 'role', roleId, role.name,
                { permission: permissionId, action: hasPermission ? 'ajoutée' : 'retirée' },
                null,
                { permissions: role.permissions }
            );
            UI.toast(`Permission ${hasPermission ? 'ajoutée' : 'retirée'}`, 'info');
        },

        createNewCustomRole() {
            const name = document.getElementById('newRoleName').value;
            const desc = document.getElementById('newRoleDesc').value;

            if (!name.trim()) {
                UI.toast('Veuillez entrer un nom', 'error');
                return;
            }

            const customRole = CORE.createCustomRole(name, desc || 'Rôle personnalisé', [], 'purple', 'shield');
            if (customRole) {
                UI.toast(`Rôle "${name}" créé avec succès`, 'success');
                PDGModule.showRoleDetailsModal(customRole.id);
            }
        },

        showPermissionsManagerModal() {
            const managerRole = CORE.db.roles?.find(r => r.id === 'manager');
            if (!managerRole) return UI.toast('Rôle Manager non trouvé', 'error');

            const allPermissions = CORE.db.permissions || [];
            const categories = [...new Set(allPermissions.map(p => p.category))];

            UI.modal('Permissions Manager - Modification en Temps Réel', `
                <div class="space-y-6 max-h-[70vh] overflow-y-auto">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="font-black text-blue-900 mb-2">ℹ️ Modifications en temps réel</div>
                        <div class="text-xs text-blue-700">Les permissions du Manager seront mises à jour immédiatement et enregistrées dans l'audit.</div>
                    </div>

                    <div>
                        <div class="text-xs font-black text-slate-600 uppercase mb-3">Permissions du Manager</div>
                        <div class="space-y-4">
                            ${categories.map(cat => {
                                const permsInCat = allPermissions.filter(p => p.category === cat);
                                return `
                                    <div class="p-4 rounded-2xl border border-slate-200">
                                        <div class="font-black text-slate-900 mb-3 flex items-center gap-2">
                                            <div class="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center text-sm">${permsInCat.length}</div>
                                            ${cat.charAt(0).toUpperCase() + cat.slice(1)}
                                        </div>
                                        <div class="space-y-2">
                                            ${permsInCat.map(perm => {
                                                const hasPermission = managerRole.permissions?.includes(perm.id);
                                                return `
                                                    <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50">
                                                        <input type="checkbox" ${hasPermission ? 'checked' : ''} onchange="PDGModule.updateManagerPermissionRealtime('${perm.id}', this.checked)" class="w-4 h-4 rounded">
                                                        <div class="flex-1 min-w-0">
                                                            <div class="text-sm font-black text-slate-900">${perm.label}</div>
                                                            <div class="text-[10px] text-slate-500">${perm.entity} - ${perm.action}</div>
                                                        </div>
                                                        <i data-lucide="${perm.icon}" class="w-4 h-4 text-slate-400 flex-shrink-0"></i>
                                                    </label>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl">
                        <div class="font-black text-amber-900 mb-2">⚠️ Actions rapides</div>
                        <div class="flex gap-2">
                            <button onclick="PDGModule.grantAllManagerPermissions()" class="flex-1 px-3 py-2 bg-emerald-600 text-white rounded-lg text-xs font-black hover:bg-emerald-700">Accorder tout</button>
                            <button onclick="PDGModule.revokeAllManagerPermissions()" class="flex-1 px-3 py-2 bg-red-600 text-white rounded-lg text-xs font-black hover:bg-red-700">Révoquer tout</button>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        updateManagerPermissionRealtime(permissionId, granted) {
            const managerRole = CORE.db.roles?.find(r => r.id === 'manager');
            if (!managerRole) return;

            if (granted) {
                if (!managerRole.permissions.includes(permissionId)) {
                    managerRole.permissions.push(permissionId);
                }
            } else {
                managerRole.permissions = managerRole.permissions.filter(p => p !== permissionId);
            }

            CORE.save();
            CORE.logAudit('update', 'role_permission', 'manager', 'Manager',
                { permission: permissionId, granted: granted },
                null,
                null
            );

            UI.toast(`Permission Manager ${granted ? 'ajoutée' : 'retirée'}: ${permissionId}`, 'info');
        },

        grantAllManagerPermissions() {
            const managerRole = CORE.db.roles?.find(r => r.id === 'manager');
            if (!managerRole) return;

            const allPermissions = CORE.db.permissions?.map(p => p.id) || [];
            managerRole.permissions = [...new Set([...managerRole.permissions, ...allPermissions])];

            CORE.save();
            CORE.logAudit('update', 'role', 'manager', 'Manager',
                { action: 'Tous les permissions accordées' },
                null,
                { permissions: managerRole.permissions }
            );

            UI.toast('✓ Toutes les permissions accordées au Manager', 'success');
            PDGModule.showPermissionsManagerModal();
        },

        showAlertThresholdsModal() {
            const thresholds = CORE.db.alertThresholds || [];

            UI.modal('Configuration des Seuils d\'Alerte', `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-2xl">
                        <div class="font-black text-indigo-900 mb-2">⚙️ Seuils de déclenchement</div>
                        <div class="text-xs text-indigo-700">Configurez les seuils qui déclenchent les alertes automatiques dans le système.</div>
                    </div>

                    ${thresholds.map(threshold => `
                        <div class="p-4 border-2 rounded-2xl ${threshold.enabled ? 'border-emerald-300 bg-emerald-50' : 'border-slate-200 bg-slate-50'}">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <div class="font-black text-slate-900">${threshold.name}</div>
                                    <div class="text-xs text-slate-600 mt-1">${threshold.description}</div>
                                </div>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" ${threshold.enabled ? 'checked' : ''} onchange="CORE.toggleAlertThreshold('${threshold.id}', this.checked); PDGModule.showAlertThresholdsModal();" class="w-4 h-4 rounded">
                                    <span class="text-xs font-black">${threshold.enabled ? '✓ Actif' : 'Inactif'}</span>
                                </label>
                            </div>

                            ${threshold.threshold !== undefined ? `
                                <div class="flex items-center gap-3 p-3 bg-white rounded-xl border border-slate-200">
                                    <label class="flex-1">
                                        <div class="text-xs font-black text-slate-600 mb-1">Seuil: ${threshold.threshold}${threshold.id.includes('rate') ? '%' : ''}</div>
                                        <input type="number" value="${Math.max(1, parseInt(threshold.threshold) || 1)}" min="1" max="1000"
                                            onchange="CORE.updateAlertThreshold('${threshold.id}', parseInt(this.value)); CORE.save();"
                                            class="w-full px-2 py-1 border border-slate-300 rounded-lg text-xs font-black text-slate-900" />
                                    </label>
                                </div>
                            ` : ''}

                            <div class="flex items-center gap-2 mt-3">
                                <span class="text-[10px] font-black px-2 py-1 rounded-full ${
                                    threshold.severity === 'critical' ? 'bg-red-200 text-red-800' :
                                    threshold.severity === 'high' ? 'bg-orange-200 text-orange-800' :
                                    threshold.severity === 'medium' ? 'bg-amber-200 text-amber-800' :
                                    'bg-blue-200 text-blue-800'
                                }">
                                    Sévérité: ${threshold.severity.toUpperCase()}
                                </span>
                            </div>
                        </div>
                    `).join('')}

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="font-black text-slate-900 text-sm mb-3">📊 Notifications Active</div>
                        <div class="text-sm text-slate-700">
                            <strong>${CORE.getUnreadNotificationCount()}</strong> notifications non lues
                        </div>
                        <div class="mt-3">
                            <button onclick="PDGModule.showNotificationHistoryModal()" class="w-full px-3 py-2 bg-slate-900 text-white rounded-lg text-xs font-black hover:bg-slate-800 transition">
                                📜 Voir l'historique
                            </button>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        getNotificationFilters() {
            if (!this.state.notificationFilters) {
                this.state.notificationFilters = NotificationUtils.defaultFilters();
            }
            return NotificationUtils.ensureFilters(this.state.notificationFilters);
        },

        updateNotificationFilter(key, value) {
            const current = this.getNotificationFilters();
            this.state.notificationFilters = { ...current, [key]: value };
            this.refreshNotificationHistoryModal();
        },

        toggleUnreadFilter() {
            const current = this.getNotificationFilters();
            this.state.notificationFilters = { ...current, showUnread: !current.showUnread };
            this.refreshNotificationHistoryModal();
        },

        resetNotificationFilters() {
            this.state.notificationFilters = NotificationUtils.defaultFilters();
            this.refreshNotificationHistoryModal();
        },

        markAllNotificationsRead() {
            (CORE.db.notifications || []).forEach(n => {
                n.read = true;
                n.readAt = new Date().toISOString();
            });
            CORE.save();
            this.refreshNotificationHistoryModal();
            App.rerender();
        },

        toggleNotificationRead(id) {
            const notif = (CORE.db.notifications || []).find(n => n.id === id);
            if (!notif) return;
            const next = !notif.read;
            notif.read = next;
            notif.readAt = next ? new Date().toISOString() : null;
            CORE.save();
            this.refreshNotificationHistoryModal();
            App.rerender();
        },

        removeNotification(id) {
            const before = (CORE.db.notifications || []).length;
            CORE.db.notifications = (CORE.db.notifications || []).filter(n => n.id !== id);
            if (CORE.db.notifications.length !== before) {
                CORE.save();
                UI.toast('Notification archivée', 'success');
                this.refreshNotificationHistoryModal();
                App.rerender();
            }
        },

        refreshNotificationHistoryModal() {
            const container = document.querySelector('#modalContainer .modal-content');
            if (!container) return;
            UI.updateModalContent(this.renderNotificationHistoryContent());
        },

        renderNotificationHistoryContent() {
            const filters = this.getNotificationFilters();
            const allHistory = CORE.getNotificationHistory(300);
            const filtered = NotificationUtils.applyFilters(allHistory, filters);
            const grouped = NotificationUtils.groupByDate(filtered);
            const counts = NotificationUtils.countBySeverity(allHistory);
            const typeOptions = NotificationUtils.getTypeOptions(allHistory);
            const unreadCount = CORE.getUnreadNotificationCount();

            const severityOptions = [
                { key: 'all', label: 'Toutes', chip: 'bg-slate-200 text-slate-700' },
                { key: 'critical', label: 'Critiques' },
                { key: 'high', label: 'Prioritaires' },
                { key: 'medium', label: 'Modérées' },
                { key: 'low', label: 'Faibles' },
                { key: 'info', label: 'Info' }
            ];

            const periodOptions = [
                { key: '24h', label: '24h' },
                { key: '7d', label: '7j' },
                { key: '30d', label: '30j' },
                { key: 'all', label: 'Tout' }
            ];

            return `
                <div class="space-y-5">
                    <div class="bg-slate-50 border border-slate-200 rounded-2xl p-4 space-y-4">
                        <div class="flex flex-wrap items-center justify-between gap-3">
                            <div>
                                <div class="text-sm font-black text-slate-900">${filtered.length} élément${filtered.length > 1 ? 's' : ''} affiché${filtered.length > 1 ? 's' : ''}</div>
                                <div class="text-xs text-slate-500">${allHistory.length} notifications totales • ${unreadCount} non lues</div>
                            </div>
                            <div class="flex flex-wrap gap-2 text-xs font-black">
                                <button class="px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-100 transition" onclick="PDGModule.resetNotificationFilters()">Réinitialiser</button>
                                <button class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition" onclick="PDGModule.markAllNotificationsRead()">Tout marquer lu</button>
                            </div>
                        </div>

                        <div class="grid gap-3">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div class="relative flex gap-2">
                                    <input type="search" id="pdg-notif-search" value="${NotificationUtils.escape(filters.search)}" onkeypress="if(event.key==='Enter'){PDGModule.updateNotificationFilter('search', this.value)}" placeholder="Rechercher par titre, message ou type" class="flex-1 px-4 py-2.5 rounded-xl border border-slate-200 bg-white text-sm focus:ring-2 focus:ring-emerald-500 focus:border-transparent" />
                                    <button onclick="PDGModule.updateNotificationFilter('search', document.getElementById('pdg-notif-search').value)" class="px-3 py-2 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition"><i data-lucide="search" class="w-4 h-4"></i></button>
                                </div>
                                <div class="flex items-center gap-2">
                                    ${periodOptions.map(option => `
                                        <button class="px-3 py-2 rounded-lg text-xs font-black border ${filters.period === option.key ? 'bg-slate-900 text-white border-slate-900' : 'bg-white border-slate-200 hover:bg-slate-100'}" onclick="PDGModule.updateNotificationFilter('period', '${option.key}')">${option.label}</button>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="flex flex-wrap items-center gap-2">
                                ${severityOptions.map(option => {
                                    const meta = option.key !== 'all' ? NotificationUtils.getSeverityMeta(option.key) : null;
                                    const isActive = filters.severity === option.key;
                                    const base = option.key === 'all' ? option.chip : meta?.chip;
                                    return `<button class="px-3 py-1.5 rounded-full text-[11px] font-black border ${isActive ? (option.key === 'all' ? 'border-slate-900 bg-slate-900 text-white' : 'border-transparent ' + base) : 'border-slate-200 bg-white text-slate-600'}" onclick=\"PDGModule.updateNotificationFilter('severity','${option.key}')\">${option.label} (${counts[option.key] ?? 0})</button>`;
                                }).join('')}
                                <button class="px-3 py-1.5 rounded-full text-[11px] font-black border ${filters.showUnread ? 'bg-amber-500 border-transparent text-white' : 'bg-white border-slate-200 text-slate-600'}" onclick="PDGModule.toggleUnreadFilter()">${filters.showUnread ? 'Non lues uniquement' : 'Inclure non lues'}</button>
                            </div>

                            ${typeOptions.length > 0 ? `
                                <div>
                                    <label class="text-[11px] uppercase font-black text-slate-500 tracking-wide mb-1 block">Type</label>
                                    <select class="w-full md:w-auto px-3 py-2 border border-slate-200 rounded-lg text-sm font-black bg-white" onchange="PDGModule.updateNotificationFilter('type', this.value)">
                                        <option value="all" ${filters.type === 'all' ? 'selected' : ''}>Tous les types</option>
                                        ${typeOptions.map(type => `<option value="${NotificationUtils.escape(type)}" ${filters.type.toLowerCase() === type.toLowerCase() ? 'selected' : ''}>${NotificationUtils.escape(NotificationUtils.getTypeLabel(type))}</option>`).join('')}
                                    </select>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    ${filtered.length === 0 ? `
                        <div class="p-10 text-center border border-dashed border-slate-200 rounded-2xl bg-white">
                            <div class="text-4xl mb-2">🎉</div>
                            <div class="font-black text-slate-700">Aucune notification à afficher</div>
                            <div class="text-xs text-slate-500 mt-1">Modifiez vos filtres pour élargir la recherche.</div>
                        </div>
                    ` : `
                        <div class="space-y-6">
                            ${grouped.map(group => `
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between text-xs font-black text-slate-500 uppercase tracking-wide">
                                        <span>${group.label}</span>
                                        <span>${group.items.length} notification${group.items.length > 1 ? 's' : ''}</span>
                                    </div>
                                    <div class="space-y-3">
                                        ${group.items.map(item => {
                                            const meta = NotificationUtils.getSeverityMeta(item.severity);
                                            const ts = NotificationUtils.getTimestamp(item);
                                            const relative = NotificationUtils.formatRelative(ts);
                                            const readClass = item.read ? 'opacity-85' : 'ring-2 ring-offset-2 ring-slate-300';
                                            return `
                                                <div class="p-4 rounded-2xl transition ${meta.panel} ${readClass}">
                                                    <div class="flex flex-col gap-3">
                                                        <div class="flex items-start gap-3">
                                                            <span class="w-2 h-2 mt-1 rounded-full ${meta.dot}"></span>
                                                            <div class="flex-1">
                                                                <div class="flex flex-wrap items-start gap-2 justify-between">
                                                                    <div>
                                                                        <div class="text-sm font-black text-slate-900">${NotificationUtils.escape(item.title)}</div>
                                                                        ${item.message ? `<div class="text-xs text-slate-600 mt-1">${NotificationUtils.escape(item.message)}</div>` : ''}
                                                                    </div>
                                                                    <div class="flex flex-wrap gap-2">
                                                                        <button class="text-[10px] font-black px-2 py-1 rounded-full border border-transparent ${item.read ? 'bg-white text-slate-500 border-slate-200' : 'bg-slate-900 text-white'}" onclick="PDGModule.toggleNotificationRead(${item.id})">${item.read ? 'Marquer non lu' : 'Marquer lu'}</button>
                                                                        <button class="text-[10px] font-black px-2 py-1 rounded-full border border-transparent bg-white text-slate-500 border-slate-200 hover:bg-slate-100" onclick="PDGModule.removeNotification(${item.id})">Archiver</button>
                                                                    </div>
                                                                </div>
                                                                <div class="flex flex-wrap items-center gap-2 mt-3 text-[10px] font-black text-slate-500">
                                                                    <span class="px-2 py-1 rounded-full ${meta.badge}">${meta.label}</span>
                                                                    <span class="px-2 py-1 rounded-full bg-slate-200 text-slate-700">${NotificationUtils.escape(NotificationUtils.getTypeLabel(item.type))}</span>
                                                                    ${item.relatedTo ? `<span class="px-2 py-1 rounded-full bg-slate-100 text-slate-500 border border-slate-200">${NotificationUtils.escape(NotificationUtils.getTypeLabel(item.relatedTo))}${item.relatedId ? ' #' + NotificationUtils.escape(item.relatedId) : ''}</span>` : ''}
                                                                    <span>${relative}</span>
                                                                    ${ts ? `<span class="text-slate-400">${CORE.formatDate(ts)}</span>` : ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        },

        showNotificationHistoryModal() {
            UI.modal('Historique des Notifications', this.renderNotificationHistoryContent(), [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showBudgetManagementModal() {
            const budgets = CORE.db.budgets || [];
            const categories = ['salaires', 'operationnel', 'marketing', 'logistics', 'maintenance', 'other'];
            const categoryLabels = {
                'salaires': '💼 Salaires',
                'operationnel': '⚙️ Opérationnel',
                'marketing': '📢 Marketing',
                'logistics': '🚚 Logistique',
                'maintenance': '🔧 Maintenance',
                'other': '📋 Autre'
            };

            UI.modal('Gestion des Budgets', `
                <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                        <div class="font-black text-emerald-900 mb-3">➕ Créer un Nouveau Budget</div>
                        <div class="space-y-3">
                            <input type="text" id="budgetName" placeholder="Nom du budget (ex: Salaires Q1)" class="w-full px-3 py-2 border border-emerald-300 rounded-xl">
                            <select id="budgetCategory" class="w-full px-3 py-2 border border-emerald-300 rounded-xl font-black">
                                <option value="">Sélectionner une catégorie</option>
                                ${categories.map(cat => `<option value="${cat}">${categoryLabels[cat]}</option>`).join('')}
                            </select>
                            <input type="number" id="budgetAmount" placeholder="Montant (XAF)" min="0" class="w-full px-3 py-2 border border-emerald-300 rounded-xl">
                            <input type="date" id="budgetStartDate" class="w-full px-3 py-2 border border-emerald-300 rounded-xl">
                            <input type="date" id="budgetEndDate" class="w-full px-3 py-2 border border-emerald-300 rounded-xl">
                            <textarea id="budgetNotes" placeholder="Notes (optionnel)" class="w-full px-3 py-2 border border-emerald-300 rounded-xl h-16"></textarea>
                            <button onclick="PDGModule.createNewBudget()" class="w-full px-3 py-2 bg-emerald-600 text-white rounded-lg text-xs font-black hover:bg-emerald-700">Créer le budget</button>
                        </div>
                    </div>

                    <div class="h-px bg-slate-200"></div>

                    <div>
                        <div class="text-xs font-black text-slate-600 uppercase mb-3">📊 Budgets Actifs (${budgets.length})</div>
                        ${budgets.length === 0 ? `
                            <div class="p-8 text-center rounded-2xl border-2 border-dashed border-slate-200 bg-slate-50">
                                <div class="text-2xl mb-2">📋</div>
                                <div class="font-black text-slate-600">Aucun budget</div>
                                <div class="text-xs text-slate-500 mt-1">Créez votre premier budget ci-dessus</div>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${budgets.map(budget => {
                                    const status = CORE.getBudgetStatus(budget.id);
                                    const isOver = status.status === 'over';
                                    const isWarning = status.status === 'warning';
                                    return `
                                        <div class="p-4 rounded-2xl border-l-4 ${
                                            isOver ? 'border-l-red-600 bg-red-50 border border-red-200' :
                                            isWarning ? 'border-l-amber-600 bg-amber-50 border border-amber-200' :
                                            'border-l-emerald-600 bg-emerald-50 border border-emerald-200'
                                        }">
                                            <div class="flex items-start justify-between mb-2">
                                                <div>
                                                    <div class="font-black text-slate-900">${budget.name}</div>
                                                    <div class="text-xs text-slate-600 mt-1">${categoryLabels[budget.category]}</div>
                                                </div>
                                                <button onclick="if(confirm('Supprimer ce budget ?')) { CORE.db.budgets = CORE.db.budgets.filter(b => b.id !== ${budget.id}); CORE.save(); PDGModule.showBudgetManagementModal(); }" class="text-xs font-black text-red-600 hover:text-red-700">✕</button>
                                            </div>
                                            <div class="space-y-2">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-sm font-black text-slate-900">${status.spent.toFixed(2)} XAF / ${budget.amount.toFixed(2)} XAF</span>
                                                    <span class="text-xs font-black px-2 py-1 rounded-full ${
                                                        isOver ? 'bg-red-300 text-red-900' :
                                                        isWarning ? 'bg-amber-300 text-amber-900' :
                                                        'bg-emerald-300 text-emerald-900'
                                                    }">${status.percentageUsed}%</span>
                                                </div>
                                                <div class="w-full h-2 bg-slate-300 rounded-full overflow-hidden">
                                                    <div class="h-full ${
                                                        isOver ? 'bg-red-600' :
                                                        isWarning ? 'bg-amber-600' :
                                                        'bg-emerald-600'
                                                    }" data-width="${Math.min(status.percentageUsed, 100)}"></div>
                                                </div>
                                                <div class="text-[10px] text-slate-600">
                                                    Restant: <strong>${Math.max(0, status.remaining).toFixed(2)} XAF</strong>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        createNewBudget() {
            const name = document.getElementById('budgetName').value.trim();
            const category = document.getElementById('budgetCategory').value;
            const amount = parseFloat(document.getElementById('budgetAmount').value);
            const startDate = document.getElementById('budgetStartDate').value;
            const endDate = document.getElementById('budgetEndDate').value;
            const notes = document.getElementById('budgetNotes').value.trim();

            if (!name || !category || !amount || !startDate || !endDate) {
                return UI.toast('Veuillez remplir tous les champs requis', 'warning');
            }

            if (new Date(startDate) >= new Date(endDate)) {
                return UI.toast('La date de fin doit être après la date de début', 'warning');
            }

            CORE.createBudget(name, category, amount, startDate, endDate, notes);
            UI.toast(`Budget "${name}" créé avec succès`, 'success');
            PDGModule.showBudgetManagementModal();
        },

        showFinancialDashboardModal() {
            const health = CORE.getFinancialHealth();
            const budgetComparison = health.budgetComparison;
            const metrics = health.metrics;

            const healthColor = health.status === 'excellent' ? 'emerald' :
                               health.status === 'bon' ? 'blue' :
                               health.status === 'moyen' ? 'amber' : 'red';

            UI.modal('Tableau de Bord Financier', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <!-- Health Score -->
                    <div class="p-6 rounded-2xl bg-gradient-to-r from-${healthColor}-50 to-${healthColor}-100 border border-${healthColor}-200">
                        <div class="text-center">
                            <div class="text-5xl font-black text-${healthColor}-900 mb-2">${health.healthScore}%</div>
                            <div class="font-black text-${healthColor}-900">Santé Financière: ${health.status.toUpperCase()}</div>
                            <div class="text-xs text-${healthColor}-700 mt-1">
                                ${health.status === 'excellent' ? '🎉 Excellent état financier' :
                                  health.status === 'bon' ? '✓ état financier satisfaisant' :
                                  health.status === 'moyen' ? '⚠️ État financier à surveiller' :
                                  '🚨 État financier critique'}
                            </div>
                        </div>
                    </div>

                    <!-- Revenue vs Costs -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-200">
                            <div class="text-[10px] font-black text-emerald-700 uppercase">Revenu Total</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${metrics.totalRevenue.toFixed(0)}</div>
                            <div class="text-xs text-emerald-600 mt-1">${metrics.ordersCount} commandes</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-red-50 border border-red-200">
                            <div class="text-[10px] font-black text-red-700 uppercase">Coûts Totaux</div>
                            <div class="text-2xl font-black text-red-900 mt-1">${metrics.totalCosts.toFixed(0)}</div>
                            <div class="text-xs text-red-600 mt-1">Tous types confondus</div>
                        </div>
                    </div>

                    <!-- Profitability Metrics -->
                    <div class="grid grid-cols-3 gap-3">
                        <div class="p-3 rounded-2xl bg-blue-50 border border-blue-200 text-center">
                            <div class="text-[10px] font-black text-blue-700">Bénéfice Brut</div>
                            <div class="text-xl font-black text-blue-900 mt-1">${metrics.grossProfit.toFixed(0)}</div>
                        </div>
                        <div class="p-3 rounded-2xl bg-indigo-50 border border-indigo-200 text-center">
                            <div class="text-[10px] font-black text-indigo-700">Bénéfice Net</div>
                            <div class="text-xl font-black text-indigo-900 mt-1">${metrics.netProfit.toFixed(0)}</div>
                        </div>
                        <div class="p-3 rounded-2xl bg-purple-50 border border-purple-200 text-center">
                            <div class="text-[10px] font-black text-purple-700">ROI</div>
                            <div class="text-xl font-black text-purple-900 mt-1">${metrics.roi}%</div>
                        </div>
                    </div>

                    <!-- Profit Margin -->
                    <div class="p-4 rounded-2xl bg-cyan-50 border border-cyan-200">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-black text-cyan-900">Marge Bénéficiaire</div>
                            <div class="text-2xl font-black text-cyan-900">${metrics.profitMargin}%</div>
                        </div>
                        <div class="w-full h-3 bg-cyan-300 rounded-full overflow-hidden">
                            <div class="h-full bg-cyan-700" data-width="${Math.min(metrics.profitMargin, 100)}"></div>
                        </div>
                        <div class="text-[10px] text-cyan-700 mt-2">Cible: 30%</div>
                    </div>

                    <!-- Cost Breakdown -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-3">📊 Répartition des Coûts</div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-red-600"></div>
                                    <span class="text-sm text-slate-700">Coût des Produits</span>
                                </div>
                                <span class="font-black text-slate-900">${metrics.productCosts.toFixed(0)} XAF (${((metrics.productCosts / metrics.totalCosts) * 100).toFixed(1)}%)</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-orange-600"></div>
                                    <span class="text-sm text-slate-700">Coût de Livraison</span>
                                </div>
                                <span class="font-black text-slate-900">${metrics.deliveryCosts.toFixed(0)} XAF (${((metrics.deliveryCosts / metrics.totalCosts) * 100).toFixed(1)}%)</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-amber-600"></div>
                                    <span class="text-sm text-slate-700">Dépenses Opérationnelles</span>
                                </div>
                                <span class="font-black text-slate-900">${metrics.operatingExpenses.toFixed(0)} XAF (${((metrics.operatingExpenses / metrics.totalCosts) * 100).toFixed(1)}%)</span>
                            </div>
                        </div>
                    </div>

                    <!-- Budget vs Reality -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-3">💰 Budget vs Réalité</div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-slate-700">Budget Total</span>
                                <span class="font-black text-slate-900">${budgetComparison.totalBudgeted.toFixed(0)} XAF</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-slate-700">Dépenses Réelles</span>
                                <span class="font-black text-slate-900">${budgetComparison.totalSpent.toFixed(0)} XAF</span>
                            </div>
                            <div class="h-px bg-slate-300"></div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-black text-slate-900">% d'Utilisation</span>
                                <span class="font-black text-slate-900">${budgetComparison.overallPercentage}%</span>
                            </div>
                            <div class="w-full h-3 bg-slate-300 rounded-full overflow-hidden">
                                <div class="h-full bg-slate-900" data-width="${Math.min(budgetComparison.overallPercentage, 100)}"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Key Indicators -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-3">📈 Indicateurs Clés</div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="p-2 rounded-lg bg-white border border-slate-200">
                                <div class="text-slate-600">Panier Moyen</div>
                                <div class="font-black text-slate-900">${(metrics.totalRevenue / Math.max(metrics.ordersCount, 1)).toFixed(0)} XAF</div>
                            </div>
                            <div class="p-2 rounded-lg bg-white border border-slate-200">
                                <div class="text-slate-600">Coût/Revenu</div>
                                <div class="font-black text-slate-900">${((metrics.totalCosts / metrics.totalRevenue) * 100).toFixed(1)}%</div>
                            </div>
                            <div class="p-2 rounded-lg bg-white border border-slate-200">
                                <div class="text-slate-600">Livraisons</div>
                                <div class="font-black text-slate-900">${metrics.deliveriesCount}</div>
                            </div>
                            <div class="p-2 rounded-lg bg-white border border-slate-200">
                                <div class="text-slate-600">Coût/Livraison</div>
                                <div class="font-black text-slate-900">${(metrics.deliveryCosts / Math.max(metrics.deliveriesCount, 1)).toFixed(0)} XAF</div>
                            </div>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Gérer Budgets', onclick: 'UI.closeModal(); PDGModule.showBudgetManagementModal();' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showProfitabilityAnalysisModal() {
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const startOfLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const endOfLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);

            const currentMetrics = CORE.calculateFinancialMetrics(startOfMonth.toISOString(), endOfMonth.toISOString());
            const lastMetrics = CORE.calculateFinancialMetrics(startOfLastMonth.toISOString(), endOfLastMonth.toISOString());

            // Calculate trends
            const revenueTrend = lastMetrics.totalRevenue > 0 ?
                (((currentMetrics.totalRevenue - lastMetrics.totalRevenue) / lastMetrics.totalRevenue) * 100).toFixed(1) : 0;
            const profitTrend = lastMetrics.netProfit > 0 ?
                (((currentMetrics.netProfit - lastMetrics.netProfit) / lastMetrics.netProfit) * 100).toFixed(1) : 0;
            const marginTrend = (currentMetrics.profitMargin - lastMetrics.profitMargin).toFixed(1);

            UI.modal('Analyse de Rentabilité', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <!-- Comparison Cards -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 rounded-2xl bg-gradient-to-br from-emerald-50 to-emerald-100 border border-emerald-200">
                            <div class="text-[10px] font-black text-emerald-700 uppercase mb-1">Revenu Ce Mois</div>
                            <div class="text-2xl font-black text-emerald-900">${currentMetrics.totalRevenue.toFixed(0)}</div>
                            <div class="text-xs text-emerald-700 mt-2">
                                <span class="font-black">${revenueTrend > 0 ? '↑' : '↓'} ${Math.abs(revenueTrend)}%</span> vs mois dernier
                            </div>
                        </div>
                        <div class="p-4 rounded-2xl bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200">
                            <div class="text-[10px] font-black text-blue-700 uppercase mb-1">Bénéfice Net Ce Mois</div>
                            <div class="text-2xl font-black text-blue-900">${currentMetrics.netProfit.toFixed(0)}</div>
                            <div class="text-xs text-blue-700 mt-2">
                                <span class="font-black">${profitTrend > 0 ? '↑' : '↓'} ${Math.abs(profitTrend)}%</span> vs mois dernier
                            </div>
                        </div>
                    </div>

                    <!-- Margin Analysis -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-4">📊 Analyse des Marges</div>
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-slate-700">Marge Brute (Ce Mois)</span>
                                    <span class="font-black text-slate-900">${((currentMetrics.grossProfit / currentMetrics.totalRevenue) * 100).toFixed(1)}%</span>
                                </div>
                                <div class="w-full h-2 bg-slate-300 rounded-full overflow-hidden">
                                    <div class="h-full bg-emerald-600" data-width="${((currentMetrics.grossProfit / currentMetrics.totalRevenue) * 100).toFixed(1)}"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-slate-700">Marge Nette (Ce Mois)</span>
                                    <span class="font-black text-slate-900">${currentMetrics.profitMargin}%</span>
                                </div>
                                <div class="w-full h-2 bg-slate-300 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-600" data-width="${currentMetrics.profitMargin}"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-slate-700">Évolution Marge (vs mois dernier)</span>
                                    <span class="font-black text-slate-900">${marginTrend > 0 ? '+' : ''}${marginTrend}%</span>
                                </div>
                                <div class="text-xs text-slate-600">Marge actuelle: ${currentMetrics.profitMargin}% | Mois dernier: ${lastMetrics.profitMargin}%</div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Breakdown -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-3 rounded-2xl bg-red-50 border border-red-200">
                            <div class="text-[10px] font-black text-red-700 uppercase">Coût Produits</div>
                            <div class="text-lg font-black text-red-900 mt-1">${currentMetrics.productCosts.toFixed(0)}</div>
                            <div class="text-[10px] text-red-600 mt-1">${((currentMetrics.productCosts / currentMetrics.totalRevenue) * 100).toFixed(1)}% du revenu</div>
                        </div>
                        <div class="p-3 rounded-2xl bg-orange-50 border border-orange-200">
                            <div class="text-[10px] font-black text-orange-700 uppercase">Coût Livraison</div>
                            <div class="text-lg font-black text-orange-900 mt-1">${currentMetrics.deliveryCosts.toFixed(0)}</div>
                            <div class="text-[10px] text-orange-600 mt-1">${((currentMetrics.deliveryCosts / currentMetrics.totalRevenue) * 100).toFixed(1)}% du revenu</div>
                        </div>
                        <div class="p-3 rounded-2xl bg-amber-50 border border-amber-200">
                            <div class="text-[10px] font-black text-amber-700 uppercase">Dépenses Opérationnelles</div>
                            <div class="text-lg font-black text-amber-900 mt-1">${currentMetrics.operatingExpenses.toFixed(0)}</div>
                            <div class="text-[10px] text-amber-600 mt-1">${((currentMetrics.operatingExpenses / currentMetrics.totalRevenue) * 100).toFixed(1)}% du revenu</div>
                        </div>
                        <div class="p-3 rounded-2xl bg-purple-50 border border-purple-200">
                            <div class="text-[10px] font-black text-purple-700 uppercase">ROI</div>
                            <div class="text-lg font-black text-purple-900 mt-1">${currentMetrics.roi}%</div>
                            <div class="text-[10px] text-purple-600 mt-1">Retour sur investissement</div>
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div class="p-4 rounded-2xl border border-indigo-200 bg-indigo-50">
                        <div class="font-black text-indigo-900 mb-3">💡 Recommandations</div>
                        <div class="space-y-2 text-sm text-indigo-800">
                            ${currentMetrics.productCosts / currentMetrics.totalRevenue > 0.6 ?
                                '<div>🎯 Réduire le coût des produits (actuellement > 60% du revenu)</div>' : ''}
                            ${currentMetrics.deliveryCosts / currentMetrics.totalRevenue > 0.2 ?
                                '<div>🚚 Optimiser les coûts de livraison (actuellement > 20% du revenu)</div>' : ''}
                            ${currentMetrics.profitMargin < 20 ?
                                '<div>📈 Augmenter les prix ou réduire les coûts (marge < 20%)</div>' : ''}
                            ${currentMetrics.profitMargin > 30 ?
                                '<div>✅ Excellent ! Marge bénéficiaire supérieure à 30%</div>' : ''}
                            ${revenueTrend < -10 ?
                                '<div>⚠️ Attention: Revenu en baisse par rapport au mois dernier</div>' : ''}
                            ${profitTrend < -15 ?
                                '<div>🚨 Préoccupation: Bénéfice net en baisse importante</div>' : ''}
                        </div>
                    </div>

                    <!-- Comparison Table -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-3">📋 Comparaison Mensuelle</div>
                        <table class="w-full text-xs">
                            <thead>
                                <tr class="border-b border-slate-300">
                                    <th class="text-left py-2 font-black text-slate-700">Métrique</th>
                                    <th class="text-right py-2 font-black text-slate-700">Ce Mois</th>
                                    <th class="text-right py-2 font-black text-slate-700">Mois Dernier</th>
                                    <th class="text-right py-2 font-black text-slate-700">Variation</th>
                                </tr>
                            </thead>
                            <tbody class="space-y-2">
                                <tr class="border-b border-slate-200">
                                    <td class="py-2 text-slate-700">Revenu Total</td>
                                    <td class="text-right font-black text-slate-900">${currentMetrics.totalRevenue.toFixed(0)}</td>
                                    <td class="text-right font-black text-slate-900">${lastMetrics.totalRevenue.toFixed(0)}</td>
                                    <td class="text-right font-black ${revenueTrend > 0 ? 'text-emerald-600' : 'text-red-600'}">${revenueTrend > 0 ? '+' : ''}${revenueTrend}%</td>
                                </tr>
                                <tr class="border-b border-slate-200">
                                    <td class="py-2 text-slate-700">Coûts Totaux</td>
                                    <td class="text-right font-black text-slate-900">${currentMetrics.totalCosts.toFixed(0)}</td>
                                    <td class="text-right font-black text-slate-900">${lastMetrics.totalCosts.toFixed(0)}</td>
                                    <td class="text-right font-black text-slate-900">${((((currentMetrics.totalCosts - lastMetrics.totalCosts) / lastMetrics.totalCosts) * 100).toFixed(1))}%</td>
                                </tr>
                                <tr class="border-b border-slate-200">
                                    <td class="py-2 text-slate-700">Bénéfice Net</td>
                                    <td class="text-right font-black text-slate-900">${currentMetrics.netProfit.toFixed(0)}</td>
                                    <td class="text-right font-black text-slate-900">${lastMetrics.netProfit.toFixed(0)}</td>
                                    <td class="text-right font-black ${profitTrend > 0 ? 'text-emerald-600' : 'text-red-600'}">${profitTrend > 0 ? '+' : ''}${profitTrend}%</td>
                                </tr>
                                <tr>
                                    <td class="py-2 text-slate-700">Marge Nette</td>
                                    <td class="text-right font-black text-slate-900">${currentMetrics.profitMargin}%</td>
                                    <td class="text-right font-black text-slate-900">${lastMetrics.profitMargin}%</td>
                                    <td class="text-right font-black ${marginTrend > 0 ? 'text-emerald-600' : 'text-red-600'}">${marginTrend > 0 ? '+' : ''}${marginTrend}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `, [
                { label: 'Tableau de Bord', onclick: 'UI.closeModal(); PDGModule.showFinancialDashboardModal();' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showAdvancedSystemModal() {
            const config = CORE.getSystemConfig();
            const diagnostics = CORE.getDiagnostics();
            const backups = CORE.getBackups();
            const logs = CORE.getSystemLogs(50);

            UI.modal('Paramètres Système Avancés', `
                <div class="space-y-4 max-h-[85vh] overflow-y-auto">
                    <!-- System Information -->
                    <div class="grid grid-cols-3 gap-3">
                        <div class="p-3 rounded-2xl bg-blue-50 border border-blue-200 text-center">
                            <div class="text-[10px] font-black text-blue-700 uppercase">Version</div>
                            <div class="text-lg font-black text-blue-900 mt-1">${config.appVersion}</div>
                        </div>
                        <div class="p-3 rounded-2xl bg-purple-50 border border-purple-200 text-center">
                            <div class="text-[10px] font-black text-purple-700 uppercase">BD Size</div>
                            <div class="text-lg font-black text-purple-900 mt-1">${diagnostics.databaseSize} MB</div>
                        </div>
                        <div class="p-3 rounded-2xl bg-emerald-50 border border-emerald-200 text-center">
                            <div class="text-[10px] font-black text-emerald-700 uppercase">Utilisateurs</div>
                            <div class="text-lg font-black text-emerald-900 mt-1">${diagnostics.activeUsers}/${diagnostics.totalUsers}</div>
                        </div>
                    </div>

                    <!-- Configuration -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-3">⚙️ Configuration Générale</div>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-2 hover:bg-white rounded-lg">
                                <span class="text-sm text-slate-700">Maintenance Mode</span>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" ${config.maintenanceMode ? 'checked' : ''} onchange="CORE.updateSystemConfig('maintenanceMode', this.checked); PDGModule.showAdvancedSystemModal();" class="w-4 h-4 rounded">
                                </label>
                            </div>
                            <div class="flex items-center justify-between p-2 hover:bg-white rounded-lg">
                                <span class="text-sm text-slate-700">Sauvegarde Automatique</span>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" ${config.backupAutomatic ? 'checked' : ''} onchange="CORE.updateSystemConfig('backupAutomatic', this.checked); PDGModule.showAdvancedSystemModal();" class="w-4 h-4 rounded">
                                </label>
                            </div>
                            <div class="flex items-center justify-between p-2 hover:bg-white rounded-lg">
                                <span class="text-sm text-slate-700">API Logs</span>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" ${config.enableApiLogs ? 'checked' : ''} onchange="CORE.updateSystemConfig('enableApiLogs', this.checked); PDGModule.showAdvancedSystemModal();" class="w-4 h-4 rounded">
                                </label>
                            </div>
                            <div class="flex items-center justify-between p-2 hover:bg-white rounded-lg">
                                <span class="text-sm text-slate-700">Deux Facteurs Auth</span>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" ${config.enableTwoFactor ? 'checked' : ''} onchange="CORE.updateSystemConfig('enableTwoFactor', this.checked); PDGModule.showAdvancedSystemModal();" class="w-4 h-4 rounded">
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Backups Management -->
                    <div class="p-4 rounded-2xl border border-emerald-200 bg-emerald-50">
                        <div class="font-black text-emerald-900 mb-3">💾 Sauvegardes (${backups.length})</div>
                        <div class="space-y-3">
                            <button onclick="CORE.createBackup('Sauvegarde manuelle'); PDGModule.showAdvancedSystemModal();" class="w-full px-3 py-2 bg-emerald-600 text-white rounded-lg text-xs font-black hover:bg-emerald-700">
                                + Créer une sauvegarde
                            </button>
                            ${backups.length === 0 ? `
                                <div class="p-4 text-center text-slate-600 text-sm">Aucune sauvegarde</div>
                            ` : `
                                <div class="space-y-2 max-h-[200px] overflow-y-auto">
                                    ${backups.slice(0, 10).map(backup => `
                                        <div class="p-3 bg-white rounded-lg border border-emerald-100 flex items-center justify-between">
                                            <div>
                                                <div class="font-black text-sm text-slate-900">${backup.name}</div>
                                                <div class="text-xs text-slate-600">${new Date(backup.date).toLocaleString('fr-FR')} • ${backup.size} MB</div>
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="if(confirm('Restaurer cette sauvegarde ?')) { const res = CORE.restoreBackup(${backup.id}); UI.toast(res.message, res.success ? 'success' : 'error'); PDGModule.showAdvancedSystemModal(); }" class="px-2 py-1 bg-blue-600 text-white text-xs rounded font-black hover:bg-blue-700">Restaurer</button>
                                                <button onclick="if(confirm('Supprimer cette sauvegarde ?')) { CORE.deleteBackup(${backup.id}); PDGModule.showAdvancedSystemModal(); }" class="px-2 py-1 bg-red-600 text-white text-xs rounded font-black hover:bg-red-700">Supprimer</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>

                    <!-- Diagnostics -->
                    <div class="p-4 rounded-2xl border border-blue-200 bg-blue-50">
                        <div class="font-black text-blue-900 mb-3">📊 Diagnostics</div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="p-2 bg-white rounded-lg">
                                <div class="text-blue-600">Commandes Total</div>
                                <div class="font-black text-blue-900">${diagnostics.totalOrders}</div>
                            </div>
                            <div class="p-2 bg-white rounded-lg">
                                <div class="text-blue-600">Livraisons</div>
                                <div class="font-black text-blue-900">${diagnostics.totalDeliveries}</div>
                            </div>
                            <div class="p-2 bg-white rounded-lg">
                                <div class="text-blue-600">Produits</div>
                                <div class="font-black text-blue-900">${diagnostics.totalProducts}</div>
                            </div>
                            <div class="p-2 bg-white rounded-lg">
                                <div class="text-blue-600">Logs Syst</div>
                                <div class="font-black text-blue-900">${diagnostics.logsCount}</div>
                            </div>
                        </div>
                    </div>

                    <!-- System Logs -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-3">📋 Logs Système (${logs.length})</div>
                        <div class="space-y-2 max-h-[300px] overflow-y-auto">
                            ${logs.length === 0 ? `
                                <div class="p-4 text-center text-slate-600 text-sm">Aucun log</div>
                            ` : `
                                ${logs.map(log => `
                                    <div class="p-2 rounded-lg border-l-4 ${
                                        log.level === 'critical' ? 'border-l-red-600 bg-red-50' :
                                        log.level === 'error' ? 'border-l-orange-600 bg-orange-50' :
                                        log.level === 'warning' ? 'border-l-amber-600 bg-amber-50' :
                                        'border-l-blue-600 bg-blue-50'
                                    }">
                                        <div class="flex items-start justify-between">
                                            <div class="flex-1">
                                                <div class="text-xs font-black text-slate-900">${log.message}</div>
                                                <div class="text-[10px] text-slate-600 mt-0.5">${new Date(log.timestamp).toLocaleString('fr-FR')}</div>
                                            </div>
                                            <span class="text-[10px] font-black px-2 py-0.5 rounded ${
                                                log.level === 'critical' ? 'bg-red-300 text-red-900' :
                                                log.level === 'error' ? 'bg-orange-300 text-orange-900' :
                                                log.level === 'warning' ? 'bg-amber-300 text-amber-900' :
                                                'bg-blue-300 text-blue-900'
                                            }">${log.level}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            `}
                        </div>
                    </div>

                    <!-- Maintenance Actions -->
                    <div class="p-4 rounded-2xl border border-purple-200 bg-purple-50">
                        <div class="font-black text-purple-900 mb-3">🔧 Maintenance</div>
                        <div class="space-y-2">
                            <button onclick="CORE.cleanupSystem(); UI.toast('Nettoyage système exécuté', 'success'); PDGModule.showAdvancedSystemModal();" class="w-full px-3 py-2 bg-purple-600 text-white rounded-lg text-xs font-black hover:bg-purple-700">
                                🧹 Nettoyer les données anciennes
                            </button>
                            <button onclick="CORE.logSystemEvent('manual_check', 'Vérification système manuelle', 'info'); const diag = CORE.getDiagnostics(); UI.toast('BD: ' + diag.databaseSize + 'MB | Logs: ' + diag.logsCount, 'success');" class="w-full px-3 py-2 bg-purple-600 text-white rounded-lg text-xs font-black hover:bg-purple-700">
                                ✓ Vérifier l'intégrité système
                            </button>
                            <button onclick="const data = CORE.exportSystemData(); console.log(data); UI.toast('Données exportées (voir console)', 'success');" class="w-full px-3 py-2 bg-purple-600 text-white rounded-lg text-xs font-black hover:bg-purple-700">
                                ⬇️ Exporter les données
                            </button>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showSystemDashboardModal() {
            const diagnostics = CORE.getDiagnostics();
            const config = CORE.getSystemConfig();
            const logs = CORE.getSystemLogs(10);
            const backups = CORE.getBackups().slice(0, 5);

            // Calculate system health
            let healthScore = 100;
            if (diagnostics.databaseSize > 500) healthScore -= 10;
            if (diagnostics.logsCount > 5000) healthScore -= 10;
            if (logs.some(l => l.level === 'error' || l.level === 'critical')) healthScore -= 20;

            const healthStatus = healthScore >= 80 ? 'Excellent' : (healthScore >= 60 ? 'Bon' : 'À surveiller');
            const healthColor = healthScore >= 80 ? 'emerald' : (healthScore >= 60 ? 'blue' : 'amber');

            UI.modal('Tableau de Bord Système', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <!-- Health Score -->
                    <div class="p-6 rounded-2xl bg-gradient-to-r from-${healthColor}-50 to-${healthColor}-100 border border-${healthColor}-200 text-center">
                        <div class="text-4xl font-black text-${healthColor}-900 mb-2">${healthScore}%</div>
                        <div class="font-black text-${healthColor}-900">Santé Système: ${healthStatus}</div>
                    </div>

                    <!-- Key Metrics -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 rounded-2xl bg-emerald-50 border border-emerald-200">
                            <div class="text-[10px] font-black text-emerald-700 uppercase">BD Taille</div>
                            <div class="text-2xl font-black text-emerald-900 mt-1">${diagnostics.databaseSize}</div>
                            <div class="text-xs text-emerald-600 mt-1">MB</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-blue-50 border border-blue-200">
                            <div class="text-[10px] font-black text-blue-700 uppercase">Utilisateurs Actifs</div>
                            <div class="text-2xl font-black text-blue-900 mt-1">${diagnostics.activeUsers}</div>
                            <div class="text-xs text-blue-600 mt-1">sur ${diagnostics.totalUsers}</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-purple-50 border border-purple-200">
                            <div class="text-[10px] font-black text-purple-700 uppercase">Sauvegardes</div>
                            <div class="text-2xl font-black text-purple-900 mt-1">${diagnostics.backupsCount}</div>
                            <div class="text-xs text-purple-600 mt-1">créées</div>
                        </div>
                        <div class="p-4 rounded-2xl bg-indigo-50 border border-indigo-200">
                            <div class="text-[10px] font-black text-indigo-700 uppercase">Logs Syst</div>
                            <div class="text-2xl font-black text-indigo-900 mt-1">${diagnostics.logsCount}</div>
                            <div class="text-xs text-indigo-600 mt-1">enregistrements</div>
                        </div>
                    </div>

                    <!-- Data Statistics -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-3">📈 Statistiques</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-700">Total Commandes</span>
                                <span class="font-black text-slate-900">${diagnostics.totalOrders}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-700">Total Livraisons</span>
                                <span class="font-black text-slate-900">${diagnostics.totalDeliveries}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-700">Total Produits</span>
                                <span class="font-black text-slate-900">${diagnostics.totalProducts}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-700">Logs d'Audit</span>
                                <span class="font-black text-slate-900">${diagnostics.auditLogsCount}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Events -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <div class="font-black text-slate-900 mb-3">🔔 Derniers Événements</div>
                        <div class="space-y-2 max-h-[200px] overflow-y-auto">
                            ${logs.length === 0 ? `
                                <div class="p-4 text-center text-slate-600 text-sm">Aucun événement</div>
                            ` : `
                                ${logs.map(log => `
                                    <div class="text-xs p-2 rounded-lg border-l-2 ${
                                        log.level === 'error' ? 'border-l-red-600 bg-red-50' :
                                        log.level === 'warning' ? 'border-l-amber-600 bg-amber-50' :
                                        'border-l-blue-600 bg-blue-50'
                                    }">
                                        <div class="font-black text-slate-900">${log.message}</div>
                                        <div class="text-[10px] text-slate-600">${new Date(log.timestamp).toLocaleTimeString('fr-FR')}</div>
                                    </div>
                                `).join('')}
                            `}
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
                        <button onclick="UI.closeModal(); PDGModule.showAdvancedSystemModal();" class="w-full px-3 py-2 bg-slate-900 text-white rounded-lg text-xs font-black hover:bg-slate-800">
                            ⚙️ Paramètres Avancés
                        </button>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showSuspensionManagementModal() {
            const suspendedUsers = CORE.getSuspendedUsers();
            const activeSuspensions = CORE.getActiveSuspensions();

            let content = '<div class="space-y-4 max-h-[80vh] overflow-y-auto">';
            content += '<div class="grid grid-cols-3 gap-3">';
            content += '<div class="p-3 rounded-2xl bg-orange-50 border border-orange-200 text-center">';
            content += '<div class="text-[10px] font-black text-orange-700 uppercase">Suspensions Actives</div>';
            content += '<div class="text-2xl font-black text-orange-900 mt-1">' + activeSuspensions.length + '</div>';
            content += '</div>';
            content += '<div class="p-3 rounded-2xl bg-red-50 border border-red-200 text-center">';
            content += '<div class="text-[10px] font-black text-red-700 uppercase">Utilisateurs Suspendus</div>';
            content += '<div class="text-2xl font-black text-red-900 mt-1">' + suspendedUsers.length + '</div>';
            content += '</div>';
            content += '<div class="p-3 rounded-2xl bg-purple-50 border border-purple-200 text-center">';
            content += '<div class="text-[10px] font-black text-purple-700 uppercase">Utilisateurs Totaux</div>';
            content += '<div class="text-2xl font-black text-purple-900 mt-1">' + CORE.getVisibleUsers().length + '</div>';
            content += '</div>';
            content += '</div>';
            content += '</div>';

            UI.modal('Gestion des Suspensions', content, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showSuspensionHistoryModal() {
            const history = CORE.getSuspensionHistory(null, 100);
            UI.modal('Historique Global des Suspensions', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="font-black text-blue-900 mb-2">📋 Historique Complet</div>
                        <div class="text-xs text-blue-700">${history.length} événements enregistrés</div>
                    </div>

                    ${history.length === 0 ? `
                        <div class="p-8 text-center rounded-2xl border-2 border-dashed border-slate-200 bg-slate-50">
                            <div class="text-2xl mb-2">📋</div>
                            <div class="font-black text-slate-600">Aucun historique</div>
                            <div class="text-xs text-slate-500 mt-1">Aucune suspension enregistrée</div>
                        </div>
                    ` : `
                        <div class="space-y-2">
                            ${history.map(entry => {
                                const isSuspended = entry.action === 'suspended';
                                return `
                                    <div class="p-3 rounded-lg border-l-4 ${
                                        isSuspended ? 'border-l-orange-600 bg-orange-50 border border-orange-200' :
                                        'border-l-emerald-600 bg-emerald-50 border border-emerald-200'
                                    }">
                                        <div class="flex items-start justify-between mb-1">
                                            <div>
                                                <div class="text-sm font-black text-slate-900">
                                                    ${isSuspended ? '🔒' : '✓'} ${entry.suspension?.userName || 'Utilisateur'}
                                                </div>
                                                <div class="text-xs text-slate-600 mt-0.5">
                                                    ${isSuspended ? 'Suspendu' : 'Réactivé'} le ${new Date(entry.timestamp).toLocaleDateString('fr-FR')} à ${new Date(entry.timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}
                                                </div>
                                            </div>
                                            <span class="text-[10px] font-black px-2 py-1 rounded-full ${
                                                isSuspended ? 'bg-orange-300 text-orange-900' : 'bg-emerald-300 text-emerald-900'
                                            }">${isSuspended ? 'SUSPENSION' : 'RÉACTIVATION'}</span>
                                        </div>
                                        <div class="text-xs text-slate-600 mt-1">
                                            <strong>Par:</strong> ${entry.performedByName || 'Système'}
                                        </div>
                                        ${isSuspended && entry.suspension?.reason ? `
                                            <div class="text-xs text-slate-700 mt-1 p-2 bg-white rounded border border-slate-200">
                                                <strong>Raison:</strong> ${entry.suspension.reason}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `, [
                { label: 'Gestion Suspensions', onclick: 'UI.closeModal(); PDGModule.showSuspensionManagementModal();' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showUserSuspensionHistoryModal(userId) {
            const user = CORE.getUser(userId);
            const userHistory = CORE.getSuspensionHistory(userId, 50);

            UI.modal(`Historique de Suspension - ${user?.name}`, `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <div class="text-[10px] font-black text-slate-600 uppercase">Nom</div>
                                <div class="font-black text-slate-900">${user?.name}</div>
                            </div>
                            <div>
                                <div class="text-[10px] font-black text-slate-600 uppercase">Identifiant</div>
                                <div class="font-black text-slate-900">${user?.username}</div>
                            </div>
                            <div>
                                <div class="text-[10px] font-black text-slate-600 uppercase">Rôle</div>
                                <div class="font-black text-slate-900">${user?.role}</div>
                            </div>
                            <div>
                                <div class="text-[10px] font-black text-slate-600 uppercase">Statut</div>
                                <div class="font-black ${user?.suspended ? 'text-red-900' : 'text-emerald-900'}">
                                    ${user?.suspended ? '🔒 Suspendu' : '✓ Actif'}
                                </div>
                            </div>
                        </div>
                    </div>

                    ${userHistory.length === 0 ? `
                        <div class="p-8 text-center rounded-2xl border-2 border-dashed border-slate-200 bg-slate-50">
                            <div class="text-2xl mb-2">✓</div>
                            <div class="font-black text-slate-600">Aucun historique</div>
                            <div class="text-xs text-slate-500 mt-1">Cet utilisateur n'a pas d'historique de suspension</div>
                        </div>
                    ` : `
                        <div class="space-y-3">
                            <div class="text-xs font-black text-slate-600 uppercase">Événements (${userHistory.length})</div>
                            ${userHistory.map(entry => {
                                const isSuspended = entry.action === 'suspended';
                                return `
                                    <div class="p-3 rounded-2xl border-l-4 ${
                                        isSuspended ? 'border-l-orange-600 bg-orange-50 border border-orange-200' :
                                        'border-l-emerald-600 bg-emerald-50 border border-emerald-200'
                                    }">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="font-black text-slate-900">
                                                ${isSuspended ? '🔒 Suspension' : '✓ Réactivation'}
                                            </div>
                                            <span class="text-[10px] font-black px-2 py-1 rounded-full ${
                                                isSuspended ? 'bg-orange-300 text-orange-900' : 'bg-emerald-300 text-emerald-900'
                                            }">${new Date(entry.timestamp).toLocaleDateString('fr-FR')}</span>
                                        </div>
                                        <div class="text-xs text-slate-600 space-y-1">
                                            <div>
                                                <strong>Heure:</strong> ${new Date(entry.timestamp).toLocaleTimeString('fr-FR')}
                                            </div>
                                            <div>
                                                <strong>Par:</strong> ${entry.performedByName || 'Système'}
                                            </div>
                                            ${isSuspended && entry.suspension?.reason ? `
                                                <div class="mt-2 p-2 bg-white rounded border border-slate-200">
                                                    <strong>Raison:</strong> ${entry.suspension.reason}
                                                </div>
                                            ` : ''}
                                            ${isSuspended && entry.suspension?.duration ? `
                                                <div>
                                                    <strong>Durée:</strong> ${entry.suspension.duration} jours
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `, [
                { label: 'Retour', onclick: 'UI.closeModal(); PDGModule.showSuspensionManagementModal();' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showSuspendUserModal(userId) {
            const user = CORE.getUser(userId);
            if (!user) {
                UI.toast('Utilisateur non trouvé', 'error');
                return;
            }

            let selectedDuration = 7;
            let customDuration = '';

            UI.modal(`Suspendre l'Utilisateur - ${user.name}`, `
                <div class="space-y-4">
                    <!-- Informations utilisateur -->
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-2xl">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <div class="text-[10px] font-black text-slate-600 uppercase">Nom</div>
                                <div class="font-black text-slate-900">${user.name}</div>
                            </div>
                            <div>
                                <div class="text-[10px] font-black text-slate-600 uppercase">Identifiant</div>
                                <div class="font-black text-slate-900">${user.username}</div>
                            </div>
                            <div>
                                <div class="text-[10px] font-black text-slate-600 uppercase">Rôle</div>
                                <div class="font-black text-slate-900">${user.role}</div>
                            </div>
                            <div>
                                <div class="text-[10px] font-black text-slate-600 uppercase">Email</div>
                                <div class="font-black text-slate-900">${user.email || '-'}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Avertissement -->
                    <div class="p-4 bg-orange-50 border-2 border-orange-300 rounded-2xl flex gap-3">
                        <div class="text-orange-600 text-xl flex-shrink-0">⚠️</div>
                        <div>
                            <div class="font-black text-orange-900">Suspension temporaire</div>
                            <div class="text-xs text-orange-700 mt-1">
                                L'utilisateur sera suspendu et ne pourra pas accéder à son compte pendant la durée spécifiée.
                                Il peut être réactivé à tout moment.
                            </div>
                        </div>
                    </div>

                    <!-- Raison de suspension -->
                    <div>
                        <label class="block text-xs font-black text-slate-700 mb-2">
                            📋 Raison de la suspension <span class="text-red-600">*</span>
                        </label>
                        <textarea
                            id="suspensionReason"
                            placeholder="Entrez la raison de la suspension..."
                            class="w-full p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                            rows="3"
                        ></textarea>
                    </div>

                    <!-- Durée de suspension -->
                    <div>
                        <label class="block text-xs font-black text-slate-700 mb-2">
                            ⏱️ Durée de suspension
                        </label>
                        <div class="space-y-3">
                            <!-- Options prédéfinies -->
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="
                                    document.getElementById('customDurationDiv').style.display = 'none';
                                    document.getElementById('suspensionDurationSelect').value = '1';
                                    Array.from(document.querySelectorAll('.duration-btn')).forEach(btn => btn.classList.remove('ring-2', 'ring-orange-500'));
                                    event.target.closest('button').classList.add('ring-2', 'ring-orange-500');
                                " class="duration-btn p-3 rounded-xl border-2 border-slate-200 hover:border-slate-300 font-black text-sm transition">
                                    1 jour
                                </button>
                                <button onclick="
                                    document.getElementById('customDurationDiv').style.display = 'none';
                                    document.getElementById('suspensionDurationSelect').value = '3';
                                    Array.from(document.querySelectorAll('.duration-btn')).forEach(btn => btn.classList.remove('ring-2', 'ring-orange-500'));
                                    event.target.closest('button').classList.add('ring-2', 'ring-orange-500');
                                " class="duration-btn p-3 rounded-xl border-2 border-slate-200 hover:border-slate-300 font-black text-sm transition">
                                    3 jours
                                </button>
                                <button onclick="
                                    document.getElementById('customDurationDiv').style.display = 'none';
                                    document.getElementById('suspensionDurationSelect').value = '7';
                                    Array.from(document.querySelectorAll('.duration-btn')).forEach(btn => btn.classList.remove('ring-2', 'ring-orange-500'));
                                    event.target.closest('button').classList.add('ring-2', 'ring-orange-500');
                                " class="duration-btn p-3 rounded-xl border-2 border-slate-200 hover:border-slate-300 font-black text-sm transition ring-2 ring-orange-500">
                                    7 jours
                                </button>
                                <button onclick="
                                    document.getElementById('customDurationDiv').style.display = 'none';
                                    document.getElementById('suspensionDurationSelect').value = '14';
                                    Array.from(document.querySelectorAll('.duration-btn')).forEach(btn => btn.classList.remove('ring-2', 'ring-orange-500'));
                                    event.target.closest('button').classList.add('ring-2', 'ring-orange-500');
                                " class="duration-btn p-3 rounded-xl border-2 border-slate-200 hover:border-slate-300 font-black text-sm transition">
                                    14 jours
                                </button>
                                <button onclick="
                                    document.getElementById('customDurationDiv').style.display = 'none';
                                    document.getElementById('suspensionDurationSelect').value = '30';
                                    Array.from(document.querySelectorAll('.duration-btn')).forEach(btn => btn.classList.remove('ring-2', 'ring-orange-500'));
                                    event.target.closest('button').classList.add('ring-2', 'ring-orange-500');
                                " class="duration-btn p-3 rounded-xl border-2 border-slate-200 hover:border-slate-300 font-black text-sm transition">
                                    30 jours
                                </button>
                                <button onclick="
                                    document.getElementById('customDurationDiv').style.display = 'block';
                                    Array.from(document.querySelectorAll('.duration-btn')).forEach(btn => btn.classList.remove('ring-2', 'ring-orange-500'));
                                    event.target.closest('button').classList.add('ring-2', 'ring-orange-500');
                                " class="duration-btn p-3 rounded-xl border-2 border-slate-200 hover:border-slate-300 font-black text-sm transition">
                                    Personnalisé
                                </button>
                            </div>

                            <!-- Sélecteur caché -->
                            <select id="suspensionDurationSelect" style="display: none;">
                                <option value="1">1 jour</option>
                                <option value="3">3 jours</option>
                                <option value="7" selected>7 jours</option>
                                <option value="14">14 jours</option>
                                <option value="30">30 jours</option>
                            </select>

                            <!-- Entrée personnalisée -->
                            <div id="customDurationDiv" style="display: none;">
                                <div class="flex gap-2">
                                    <input
                                        type="number"
                                        id="customDurationInput"
                                        placeholder="Nombre de jours"
                                        class="flex-1 p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                        min="1"
                                        max="365"
                                    >
                                    <span class="flex items-center font-black text-slate-600">jours</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Aperçu -->
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-2xl text-xs text-blue-800 font-black">
                        <div>📅 Date de reprise prévue:</div>
                        <div id="expectedResumeDate" class="text-lg text-blue-900 mt-1">
                            ${new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString('fr-FR')}
                        </div>
                    </div>
                </div>
            `, [
                {
                    label: 'Suspendre',
                    onclick: 'PDGModule.confirmSuspendUser(' + userId + ')'
                },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        confirmSuspendUser(userId) {
            const reason = document.getElementById('suspensionReason').value.trim();
            if (!reason) {
                UI.toast('Veuillez entrer une raison de suspension', 'warning');
                return;
            }
            let duration = parseInt(document.getElementById('suspensionDurationSelect').value) || 7;
            if (document.getElementById('customDurationDiv').style.display !== 'none') {
                const customVal = parseInt(document.getElementById('customDurationInput').value);
                if (customVal && customVal > 0) {
                    duration = customVal;
                }
            }
            CORE.suspendUser(userId, reason, duration);
            UI.closeModal();
            UI.toast('✓ Utilisateur suspendu avec succès', 'success');
            setTimeout(() => PDGModule.showSuspensionManagementModal(), 500);
        },

        showImportExportModal() {
            UI.modal('Import/Export de Données', `
                <div class="space-y-4">
                    <!-- Section Import -->
                    <div class="border border-blue-200 rounded-2xl overflow-hidden">
                        <div class="p-4 bg-blue-50 border-b border-blue-200 font-black text-blue-900 flex items-center gap-2">
                            <i data-lucide="upload" class="w-5 h-5"></i>
                            <span>Import de Données</span>
                        </div>
                        <div class="p-4 space-y-3">
                            <button onclick="PDGModule.showImportUsersModal()" class="w-full p-3 rounded-2xl bg-blue-50 border border-blue-200 hover:bg-blue-100 transition flex items-center gap-3">
                                <i data-lucide="users" class="w-5 h-5 text-blue-600"></i>
                                <div class="text-left flex-1">
                                    <div class="text-xs font-black text-blue-700">Importer Utilisateurs (CSV)</div>
                                    <div class="text-[10px] text-blue-600">Ajouter des utilisateurs en masse</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-blue-400"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Section Export -->
                    <div class="border border-emerald-200 rounded-2xl overflow-hidden">
                        <div class="p-4 bg-emerald-50 border-b border-emerald-200 font-black text-emerald-900 flex items-center gap-2">
                            <i data-lucide="download" class="w-5 h-5"></i>
                            <span>Export de Données</span>
                        </div>
                        <div class="p-4 space-y-3">
                            <button onclick="PDGModule.exportUserData()" class="w-full p-3 rounded-2xl bg-emerald-50 border border-emerald-200 hover:bg-emerald-100 transition flex items-center gap-3">
                                <i data-lucide="users" class="w-5 h-5 text-emerald-600"></i>
                                <div class="text-left flex-1">
                                    <div class="text-xs font-black text-emerald-700">Exporter Utilisateurs (CSV)</div>
                                    <div class="text-[10px] text-emerald-600">${CORE.getVisibleUsers().length} utilisateur(s)</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-emerald-400"></i>
                            </button>
                            <button onclick="PDGModule.exportOrderData()" class="w-full p-3 rounded-2xl bg-emerald-50 border border-emerald-200 hover:bg-emerald-100 transition flex items-center gap-3">
                                <i data-lucide="shopping-cart" class="w-5 h-5 text-emerald-600"></i>
                                <div class="text-left flex-1">
                                    <div class="text-xs font-black text-emerald-700">Exporter Commandes (CSV)</div>
                                    <div class="text-[10px] text-emerald-600">${CORE.getVisibleOrders().length} commande(s)</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-emerald-400"></i>
                            </button>
                            <button onclick="PDGModule.exportAuditData()" class="w-full p-3 rounded-2xl bg-emerald-50 border border-emerald-200 hover:bg-emerald-100 transition flex items-center gap-3">
                                <i data-lucide="shield-check" class="w-5 h-5 text-emerald-600"></i>
                                <div class="text-left flex-1">
                                    <div class="text-xs font-black text-emerald-700">Exporter Audit (CSV)</div>
                                    <div class="text-[10px] text-emerald-600">${(CORE.db.auditTrail || []).length} entrée(s)</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-emerald-400"></i>
                            </button>
                            <button onclick="PDGModule.exportAllDataJSON()" class="w-full p-3 rounded-2xl bg-purple-50 border border-purple-200 hover:bg-purple-100 transition flex items-center gap-3">
                                <i data-lucide="package" class="w-5 h-5 text-purple-600"></i>
                                <div class="text-left flex-1">
                                    <div class="text-xs font-black text-purple-700">Exporter Complète (JSON)</div>
                                    <div class="text-[10px] text-purple-600">Sauvegarde complète de toutes les données</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-purple-400"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Historique -->
                    <div class="border border-slate-200 rounded-2xl overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b border-slate-200 font-black text-slate-900 flex items-center gap-2">
                            <i data-lucide="history" class="w-5 h-5"></i>
                            <span>Historique Import/Export</span>
                        </div>
                        <div class="p-4">
                            <button onclick="PDGModule.showImportExportHistoryModal()" class="w-full p-3 rounded-2xl bg-slate-50 border border-slate-200 hover:bg-slate-100 transition flex items-center gap-3">
                                <i data-lucide="list" class="w-5 h-5 text-slate-600"></i>
                                <div class="text-left flex-1">
                                    <div class="text-xs font-black text-slate-700">Voir l'historique</div>
                                    <div class="text-[10px] text-slate-600">${(CORE.db.importExportHistory || []).length} opération(s)</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showImportUsersModal() {
            UI.modal('Importer Utilisateurs (CSV)', `
                <div class="space-y-4">
                    <!-- Instructions -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-2xl">
                        <div class="font-black text-blue-900 mb-2">📋 Format requis</div>
                        <div class="text-xs text-blue-700 space-y-1">
                            <div>Colonnes obligatoires: <strong>name, username, email, password, role</strong></div>
                            <div>Rôles disponibles: <strong>pdg, manager, gestionnaire, vendeur, livreur</strong></div>
                            <div>Format: CSV (séparé par des virgules)</div>
                        </div>
                    </div>

                    <!-- Exemple -->
                    <details class="p-4 bg-slate-50 border border-slate-200 rounded-2xl cursor-pointer">
                        <summary class="font-black text-slate-900">Exemple de format</summary>
                        <div class="mt-3 p-3 bg-white border border-slate-300 rounded text-xs font-mono text-slate-600 overflow-x-auto">
name,username,email,password,role,deliveryCenter
Jean Dupont,jdupont,jean@example.com,pass123,vendeur,
Marie Martin,mmartin,marie@example.com,pass456,gestionnaire,Centre-1
                        </div>
                    </details>

                    <!-- Zone de textarea -->
                    <div>
                        <label class="block text-xs font-black text-slate-700 mb-2">Données CSV</label>
                        <textarea
                            id="csvInput"
                            placeholder="Collez vos données CSV ici..."
                            class="w-full p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            rows="8"
                        ></textarea>
                    </div>

                    <!-- Résultat du test -->
                    <div id="dryRunResult"></div>
                </div>
            `, [
                {
                    label: 'Test (Dry Run)',
                    onclick: 'PDGModule.runDryRun()'
                },
                {
                    label: 'Importer',
                    onclick: 'PDGModule.runImport()'
                },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        runDryRun() {
            const csvInput = document.getElementById('csvInput').value.trim();
            if (!csvInput) {
                UI.toast('Veuillez entrer des données CSV', 'warning');
                return;
            }

            const result = CORE.importUsersFromCSV(csvInput, true);
            const resultDiv = document.getElementById('dryRunResult');

            if (result.success) {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                        <div class="font-black text-emerald-900">✓ Test réussi</div>
                        <div class="text-xs text-emerald-700 mt-2">
                            <div>Lignes à importer: ${result.successCount}</div>
                            <div>Vous pouvez procéder à l'import</div>
                        </div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-2xl">
                        <div class="font-black text-red-900">✗ Test échoué</div>
                        <div class="text-xs text-red-700 mt-2">${result.message}</div>
                        <div class="mt-2 text-xs text-red-600">${result.errors?.slice(0, 3).join('<br>')}</div>
                    </div>
                `;
            }
        },

        runImport() {
            const csvInput = document.getElementById('csvInput').value.trim();
            if (!csvInput) {
                UI.toast('Veuillez entrer des données CSV', 'warning');
                return;
            }

            if (!confirm('Êtes-vous sûr ? Cette action importera les utilisateurs.')) return;

            const result = CORE.importUsersFromCSV(csvInput, false);
            UI.closeModal();

            if (result.success) {
                UI.toast(`✓ ${result.successCount} utilisateur(s) importé(s)`, 'success');
            } else {
                UI.toast(`⚠ Import partiel: ${result.message}`, 'warning');
            }

            setTimeout(() => PDGModule.showImportExportModal(), 500);
        },

        exportUserData() {
            const csv = CORE.exportUsersToCSV();
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `users_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('✓ Utilisateurs exportés avec succès', 'success');
        },

        exportOrderData() {
            const csv = CORE.exportOrdersToCSV();
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `orders_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('✓ Commandes exportées avec succès', 'success');
        },

        exportAuditData() {
            const csv = CORE.exportAuditToCSV();
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `audit_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('✓ Audit exporté avec succès', 'success');
        },

        exportAllDataJSON() {
            const json = CORE.exportDataAsJSON('all');
            const blob = new Blob([json], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `backup_complete_${new Date().getTime()}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            UI.toast('✓ Sauvegarde complète créée avec succès', 'success');
        },

        showImportExportHistoryModal() {
            const history = CORE.getImportExportHistory(100);

            UI.modal('Historique Import/Export', `
                <div class="space-y-4 max-h-[80vh] overflow-y-auto">
                    ${history.length === 0 ? `
                        <div class="p-8 text-center rounded-2xl border-2 border-dashed border-slate-200 bg-slate-50">
                            <div class="text-2xl mb-2">📂</div>
                            <div class="font-black text-slate-600">Aucun historique</div>
                            <div class="text-xs text-slate-500 mt-1">Aucune opération d'import/export enregistrée</div>
                        </div>
                    ` : history.map(entry => {
                        const isImport = entry.type === 'import';
                        const isSuccess = entry.status === 'success';
                        const icon = isImport ? '📤' : '📥';
                        const label = isImport ? 'Import' : 'Export';
                        const borderClass = isImport ? 'border-l-blue-600 bg-blue-50 border border-blue-200' : 'border-l-emerald-600 bg-emerald-50 border border-emerald-200';
                        const statusClass = isSuccess ? 'bg-emerald-300 text-emerald-900' : 'bg-red-300 text-red-900';
                        const statusText = isSuccess ? '✓ Succès' : '✗ Erreur';
                        const date = new Date(entry.timestamp).toLocaleDateString('fr-FR');
                        const time = new Date(entry.timestamp).toLocaleTimeString('fr-FR');

                        return `
                            <div class="p-4 rounded-2xl border-l-4 ${borderClass}">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-lg">${icon}</span>
                                        <div class="font-black text-slate-900">${label} - ${entry.entity}</div>
                                    </div>
                                    <span class="text-[10px] font-black px-2 py-1 rounded-full ${statusClass}">${statusText}</span>
                                </div>
                                <div class="text-xs text-slate-600 space-y-1">
                                    <div><strong>Date:</strong> ${date}</div>
                                    <div><strong>Heure:</strong> ${time}</div>
                                    <div><strong>Par:</strong> ${entry.performedByName || 'Système'}</div>
                                    <div><strong>Fichier:</strong> ${entry.fileName}</div>
                                    <div><strong>Lignes:</strong> ${entry.rowsProcessed}</div>
                                    ${entry.details?.successCount ? `<div><strong>Réussi:</strong> ${entry.details.successCount}</div>` : ''}
                                    ${entry.details?.errorCount ? `<div><strong>Erreurs:</strong> ${entry.details.errorCount}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        revokeAllManagerPermissions() {
            if (!confirm('Êtes-vous sûr ? Cela réduira les permissions du Manager.')) return;

            const managerRole = CORE.db.roles?.find(r => r.id === 'manager');
            if (!managerRole) return;

            const oldPerms = [...managerRole.permissions];
            managerRole.permissions = [];

            CORE.save();
            CORE.logAudit('update', 'role', 'manager', 'Manager',
                { action: 'Toutes les permissions révoquées' },
                { permissions: oldPerms },
                { permissions: [] }
            );

            UI.toast('✗ Toutes les permissions du Manager ont été révoquées', 'warning');
            PDGModule.showPermissionsManagerModal();
        },

        showSettingsModal() {
            this.navigateTo('settings'); App.rerender();
            setTimeout(() => { if (window.AccountSwitcher) AccountSwitcher.renderSection(); }, 200);
        },

        renderSettings() {
            const pendingApprovals = (CORE.db.userAdditionRequests || []).filter(r => r.status === 'pending').length;
            const alertsCount = (CORE.db.alertThresholds || []).filter(t => t.enabled).length;
            const unreadNotifs = CORE.getUnreadNotificationCount();

            return `
                <div class="space-y-6 fade-in">
                <div class="space-y-4">
                    <!-- Header gradient -->
                    <div class="relative px-8 py-8 bg-gradient-to-br from-slate-800 via-slate-900 to-zinc-900 rounded-3xl overflow-hidden shadow-2xl">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-amber-500/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
                        <div class="absolute bottom-0 left-0 w-24 h-24 bg-amber-400/5 rounded-full translate-y-1/2 -translate-x-1/2"></div>
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-amber-400 via-amber-500 to-amber-600"></div>
                        <div class="relative flex items-center gap-4">
                            <div class="w-16 h-16 bg-gradient-to-br from-amber-400 to-amber-600 rounded-2xl flex items-center justify-center shadow-xl shadow-amber-500/30">
                                <i data-lucide="crown" class="w-7 h-7 text-slate-900"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-black text-white">Centre de Contrôle <span class="text-amber-400">PDG</span></h2>
                                <p class="text-slate-400 text-sm">Configuration complète du système</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs de navigation -->
                    <div class="flex flex-wrap bg-white rounded-2xl shadow-lg border border-slate-200 p-1.5 gap-1">
                        <button onclick="PDGModule.switchSettingsTab('general')" id="pdg-tab-general" class="flex-1 min-w-[100px] px-4 py-3 text-sm font-bold text-amber-700 bg-amber-50 rounded-xl flex items-center justify-center gap-2 transition">
                            <i data-lucide="sliders" class="w-4 h-4"></i>
                            <span >Général</span>
                        </button>
                        <button onclick="PDGModule.switchSettingsTab('users')" id="pdg-tab-users" class="flex-1 min-w-[100px] px-4 py-3 text-sm font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 rounded-xl flex items-center justify-center gap-2 transition">
                            <i data-lucide="users" class="w-4 h-4"></i>
                            <span >Utilisateurs</span>
                            ${pendingApprovals > 0 ? '<span class="w-5 h-5 bg-amber-500 text-white text-[10px] font-black rounded-full flex items-center justify-center">' + pendingApprovals + '</span>' : ''}
                        </button>
                        <button onclick="PDGModule.switchSettingsTab('finance')" id="pdg-tab-finance" class="flex-1 min-w-[100px] px-4 py-3 text-sm font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 rounded-xl flex items-center justify-center gap-2 transition">
                            <i data-lucide="wallet" class="w-4 h-4"></i>
                            <span >Finances</span>
                        </button>
                        <button onclick="PDGModule.switchSettingsTab('system')" id="pdg-tab-system" class="flex-1 min-w-[100px] px-4 py-3 text-sm font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 rounded-xl flex items-center justify-center gap-2 transition">
                            <i data-lucide="cpu" class="w-4 h-4"></i>
                            <span >Système</span>
                        </button>
                        <button onclick="PDGModule.switchSettingsTab('security')" id="pdg-tab-security" class="flex-1 min-w-[100px] px-4 py-3 text-sm font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 rounded-xl flex items-center justify-center gap-2 transition">
                            <i data-lucide="shield" class="w-4 h-4"></i>
                            <span >Sécurité</span>
                        </button>
                    </div>

                    <!-- Contenu des tabs -->
                    <div class="max-h-[55vh] overflow-y-auto pr-1">

                        <!-- Tab: Général -->
                        <div id="pdg-content-general" class="space-y-5">
                            <!-- Identité Entreprise -->
                            <div>
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-11 h-11 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg shadow-amber-300 ring-2 ring-amber-400/30">
                                        <i data-lucide="building-2" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-black text-slate-800">Identité Entreprise</h3>
                                        <p class="text-xs text-slate-500">Nom affiché partout dans l'application</p>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-600 mb-2">Nom de l'entreprise</label>
                                        <div class="flex gap-2">
                                            <input type="text" id="pdg_company_name" value="${CORE.getCompanyName()}"
                                                placeholder="Ex: Ma Boutique, RAYA Store..."
                                                class="flex-1 px-4 py-3 border-2 border-amber-200 rounded-xl text-lg font-black text-slate-800 focus:ring-2 focus:ring-amber-300 focus:border-amber-400 transition">
                                            <button onclick="PDGModule.saveCompanyName()" class="px-4 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-black rounded-xl hover:shadow-lg hover:shadow-amber-200 transition flex items-center gap-2">
                                                <i data-lucide="save" class="w-4 h-4"></i>
                                                Enregistrer
                                            </button>
                                        </div>
                                        <div class="text-[10px] text-slate-400 mt-1">Ce nom apparaîtra sur les tickets, factures, et dans toute l'interface</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Thème -->
                            <div>
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-11 h-11 bg-gradient-to-br from-slate-700 to-slate-900 rounded-xl flex items-center justify-center shadow-lg shadow-slate-300 ring-2 ring-amber-400/30">
                                        <i data-lucide="palette" class="w-5 h-5 text-amber-400"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-black text-slate-800">Apparence</h3>
                                        <p class="text-xs text-slate-500">Personnalisez votre interface</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-3">
                                    <button onclick="PDGModule.setTheme('light')" class="group p-4 rounded-2xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${this.state.theme === 'light' ? 'border-amber-400 shadow-xl shadow-amber-100 scale-105' : 'border-slate-200 hover:border-slate-300 hover:shadow-lg'}">
                                        <div class="w-14 h-14 bg-gradient-to-br from-amber-400 to-orange-500 rounded-xl flex items-center justify-center text-2xl shadow-lg ${this.state.theme === 'light' ? 'ring-4 ring-amber-200' : ''}">☀️</div>
                                        <div class="text-center">
                                            <div class="font-black text-sm text-slate-800">Clair</div>
                                            <div class="text-[10px] text-slate-500">Interface lumineuse</div>
                                        </div>
                                        ${this.state.theme === 'light' ? '<div class="w-6 h-6 bg-amber-500 rounded-full flex items-center justify-center"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>' : ''}
                                    </button>
                                    <button onclick="PDGModule.setTheme('dark')" class="group p-4 rounded-2xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${this.state.theme === 'dark' ? 'border-amber-400 shadow-xl shadow-amber-100 scale-105' : 'border-slate-200 hover:border-slate-300 hover:shadow-lg'}">
                                        <div class="w-14 h-14 bg-gradient-to-br from-slate-700 to-slate-900 rounded-xl flex items-center justify-center text-2xl shadow-lg ${this.state.theme === 'dark' ? 'ring-4 ring-amber-200' : ''}">🌙</div>
                                        <div class="text-center">
                                            <div class="font-black text-sm text-slate-800">Sombre</div>
                                            <div class="text-[10px] text-slate-500">Mode nuit</div>
                                        </div>
                                        ${this.state.theme === 'dark' ? '<div class="w-6 h-6 bg-amber-500 rounded-full flex items-center justify-center"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>' : ''}
                                    </button>
                                    <button onclick="PDGModule.setTheme('auto')" class="group p-4 rounded-2xl border-2 transition-all duration-300 flex flex-col items-center gap-2 ${this.state.theme === 'auto' ? 'border-amber-400 shadow-xl shadow-amber-100 scale-105' : 'border-slate-200 hover:border-slate-300 hover:shadow-lg'}">
                                        <div class="w-14 h-14 bg-gradient-to-br from-slate-600 to-zinc-800 rounded-xl flex items-center justify-center text-2xl shadow-lg ${this.state.theme === 'auto' ? 'ring-4 ring-amber-200' : ''}">🔄</div>
                                        <div class="text-center">
                                            <div class="font-black text-sm text-slate-800">Auto</div>
                                            <div class="text-[10px] text-slate-500">Suit le système</div>
                                        </div>
                                        ${this.state.theme === 'auto' ? '<div class="w-6 h-6 bg-amber-500 rounded-full flex items-center justify-center"><i data-lucide="check" class="w-4 h-4 text-white"></i></div>' : ''}
                                    </button>
                                </div>
                            </div>

                            <!-- Langue (Tiroir) -->
                            <div class="rounded-2xl border border-slate-200 overflow-hidden">
                                <button onclick="document.getElementById('pdg-language-drawer').classList.toggle('hidden'); document.getElementById('pdg-language-chevron').classList.toggle('rotate-180')" class="w-full flex items-center justify-between p-4 bg-white hover:bg-slate-50 transition-all">
                                    <div class="flex items-center gap-3">
                                        <div class="w-11 h-11 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl flex items-center justify-center shadow-lg shadow-blue-300 ring-2 ring-blue-400/30">
                                            <i data-lucide="globe" class="w-5 h-5 text-white"></i>
                                        </div>
                                        <div class="text-left">
                                            <h3 class="font-black text-slate-800">${t('settings.language')}</h3>
                                            <p class="text-xs text-slate-500">${[{code:'fr',flag:'🇫🇷',name:'Français'},{code:'en',flag:'🇬🇧',name:'English'},{code:'es',flag:'🇪🇸',name:'Español'},{code:'pt',flag:'🇵🇹',name:'Português'},{code:'de',flag:'🇩🇪',name:'Deutsch'},{code:'it',flag:'🇮🇹',name:'Italiano'},{code:'ar',flag:'🇸🇦',name:'العربية'},{code:'zh',flag:'🇨🇳',name:'中文'},{code:'ru',flag:'🇷🇺',name:'Русский'}].find(l => l.code === (I18n.current || 'fr'))?.flag || '🌍'} ${[{code:'fr',flag:'🇫🇷',name:'Français'},{code:'en',flag:'🇬🇧',name:'English'},{code:'es',flag:'🇪🇸',name:'Español'},{code:'pt',flag:'🇵🇹',name:'Português'},{code:'de',flag:'🇩🇪',name:'Deutsch'},{code:'it',flag:'🇮🇹',name:'Italiano'},{code:'ar',flag:'🇸🇦',name:'العربية'},{code:'zh',flag:'🇨🇳',name:'中文'},{code:'ru',flag:'🇷🇺',name:'Русский'}].find(l => l.code === (I18n.current || 'fr'))?.name || 'Français'}</p>
                                        </div>
                                    </div>
                                    <i id="pdg-language-chevron" data-lucide="chevron-down" class="w-5 h-5 text-slate-400 transition-transform duration-300"></i>
                                </button>
                                <div id="pdg-language-drawer" class="hidden border-t border-slate-200 bg-slate-50 p-4">
                                    <p class="text-xs text-slate-500 mb-3">${t('settings.chooseLanguage')}</p>
                                    <div class="grid grid-cols-9 gap-2">
                                        ${[
                                            { code: 'fr', flag: '🇫🇷' },
                                            { code: 'en', flag: '🇬🇧' },
                                            { code: 'es', flag: '🇪🇸' },
                                            { code: 'pt', flag: '🇵🇹' },
                                            { code: 'de', flag: '🇩🇪' },
                                            { code: 'it', flag: '🇮🇹' },
                                            { code: 'ar', flag: '🇸🇦' },
                                            { code: 'zh', flag: '🇨🇳' },
                                            { code: 'ru', flag: '🇷🇺' }
                                        ].map(lang => `
                                            <button onclick="PDGModule.setLanguage('${lang.code}')" class="p-2 rounded-xl border-2 transition-all text-2xl hover:scale-110 ${(I18n.current || 'fr') === lang.code ? 'border-amber-500 bg-amber-50 shadow-lg scale-110 ring-2 ring-amber-300' : 'border-slate-200 hover:border-amber-300 bg-white'}">
                                                ${lang.flag}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>

                            <!-- Notifications -->
                            <div class="p-4 rounded-2xl bg-gradient-to-r from-slate-100 to-zinc-100 border border-slate-300">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-11 h-11 bg-gradient-to-br from-slate-700 to-slate-900 rounded-xl flex items-center justify-center shadow-lg">
                                            <i data-lucide="bell" class="w-5 h-5 text-amber-400"></i>
                                        </div>
                                        <div>
                                            <div class="font-black text-slate-800">Notifications Push</div>
                                            <div class="text-xs text-slate-500">Alertes en temps réel</div>
                                        </div>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" ${this.state.notificationsEnabled ? 'checked' : ''} onchange="PDGModule.toggleNotifications()" class="sr-only peer">
                                        <div class="w-14 h-7 bg-slate-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all after:shadow-md peer-checked:bg-amber-500"></div>
                                    </label>
                                </div>
                            </div>

                            <!-- Imprimante -->
                            <div class="p-4 rounded-2xl bg-gradient-to-r from-slate-50 to-slate-100 border border-slate-200">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-11 h-11 bg-gradient-to-br from-slate-600 to-slate-800 rounded-xl flex items-center justify-center shadow-lg">
                                            <i data-lucide="printer" class="w-5 h-5 text-white"></i>
                                        </div>
                                        <div>
                                            <div class="font-black text-slate-800">Imprimante</div>
                                            <div class="text-xs text-slate-500">Non connectée</div>
                                        </div>
                                    </div>
                                    <button onclick="UI.toast('Recherche imprimante...', 'info')" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-xl text-xs font-black hover:bg-slate-300 transition">
                                        Configurer
                                    </button>
                                </div>
                            </div>

                            <!-- Version -->
                            <div class="p-4 rounded-2xl bg-gradient-to-r from-slate-800 to-zinc-900 text-white">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-11 h-11 bg-gradient-to-br from-amber-400 to-amber-600 rounded-xl flex items-center justify-center text-xl font-black text-slate-900 shadow-lg shadow-amber-500/30">R</div>
                                        <div>
                                            <div class="font-black">RAYA <span class="text-amber-400">OS</span></div>
                                            <div class="text-xs text-slate-400">Version ${CORE.config.version}</div>
                                        </div>
                                    </div>
                                    <span class="px-3 py-1 bg-amber-500/20 text-amber-400 rounded-full text-xs font-bold">À jour</span>
                                </div>
                            </div>
                        </div>

                        <!-- Tab: Utilisateurs -->
                        <div id="pdg-content-users" class="space-y-4 hidden">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-11 h-11 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-200">
                                    <i data-lucide="users" class="w-5 h-5 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-slate-800">Gestion des Utilisateurs</h3>
                                    <p class="text-xs text-slate-500">Contrôlez les accès et permissions</p>
                                </div>
                            </div>

                            <button onclick="PDGModule.showUsersManagementModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="user-cog" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-blue-800">Gérer les Utilisateurs</div>
                                    <div class="text-xs text-blue-600">Modifier identifiants et mots de passe</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-blue-400"></i>
                            </button>

                            <button onclick="PDGModule.showUserApprovalModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4 ${pendingApprovals > 0 ? 'ring-2 ring-amber-400 ring-offset-2' : ''}">
                                <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg relative">
                                    <i data-lucide="user-check" class="w-6 h-6 text-white"></i>
                                    ${pendingApprovals > 0 ? '<span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-[10px] font-black rounded-full flex items-center justify-center animate-pulse">' + pendingApprovals + '</span>' : ''}
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-amber-800">Approbation d'Utilisateurs</div>
                                    <div class="text-xs text-amber-600">${pendingApprovals > 0 ? pendingApprovals + ' demandes en attente' : 'Aucune demande en attente'}</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-amber-400"></i>
                            </button>

                            <button onclick="PDGModule.showRolesManagementModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-violet-50 to-purple-50 border border-violet-200 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="shield" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-violet-800">Gérer les Rôles</div>
                                    <div class="text-xs text-violet-600">${(CORE.db.roles || []).length} rôles • ${(CORE.db.roles || []).filter(r => r.isCustom).length} personnalisés</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-violet-400"></i>
                            </button>

                            <button onclick="PDGModule.showPermissionsManagerModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-indigo-50 to-blue-50 border border-indigo-200 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="lock" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-indigo-800">Permissions Manager</div>
                                    <div class="text-xs text-indigo-600">Modifier les permissions en temps réel</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-indigo-400"></i>
                            </button>
                        </div>

                        <!-- Tab: Finances -->
                        <div id="pdg-content-finance" class="space-y-4 hidden">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-11 h-11 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-200">
                                    <i data-lucide="wallet" class="w-5 h-5 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-slate-800">Finances & Budget</h3>
                                    <p class="text-xs text-slate-500">Vue consolidée des finances</p>
                                </div>
                            </div>

                            <button onclick="PDGModule.showFinancialDashboardModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="chart-line" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-emerald-800">Tableau de Bord Financier</div>
                                    <div class="text-xs text-emerald-600">Analytics et rapports financiers</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-emerald-400"></i>
                            </button>

                            <button onclick="PDGModule.showProfitabilityAnalysisModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-teal-50 to-cyan-50 border border-teal-200 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="trending-up" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-teal-800">Analyse de Rentabilité</div>
                                    <div class="text-xs text-teal-600">Bilan financier et marges</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-teal-400"></i>
                            </button>

                            <button onclick="PDGModule.showBudgetManagementModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="target" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-green-800">Gestion des Budgets</div>
                                    <div class="text-xs text-green-600">${(CORE.db.budgets || []).length} budgets créés</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-green-400"></i>
                            </button>
                        </div>

                        <!-- Tab: Système -->
                        <div id="pdg-content-system" class="space-y-4 hidden">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-11 h-11 bg-gradient-to-br from-slate-600 to-slate-800 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="cpu" class="w-5 h-5 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-slate-800">Système & Maintenance</h3>
                                    <p class="text-xs text-slate-500">Configuration avancée</p>
                                </div>
                            </div>

                            <button onclick="PDGModule.showSystemDashboardModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-slate-100 to-gray-100 border border-slate-300 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-slate-600 to-gray-700 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="activity" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-slate-800">Tableau de Bord Système</div>
                                    <div class="text-xs text-slate-600">Santé et diagnostics</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i>
                            </button>

                            <button onclick="PDGModule.showAdvancedSystemModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-gray-100 to-slate-100 border border-gray-300 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-gray-600 to-slate-700 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="settings" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-slate-800">Paramètres Avancés</div>
                                    <div class="text-xs text-slate-600">${(CORE.db.backups || []).length} sauvegardes • ${(CORE.db.systemLogs || []).length} logs</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i>
                            </button>

                            <button onclick="PDGModule.showImportExportModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-indigo-100 to-blue-100 border border-indigo-300 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-indigo-600 to-blue-700 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="database" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-indigo-800">Import/Export de Données</div>
                                    <div class="text-xs text-indigo-600">${(CORE.db.importExportHistory || []).length} opérations enregistrées</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-indigo-400"></i>
                            </button>

                            <!-- Alertes -->
                            <div class="p-4 rounded-2xl bg-gradient-to-r from-rose-100 to-red-100 border border-rose-300">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="w-11 h-11 bg-gradient-to-br from-rose-500 to-red-600 rounded-xl flex items-center justify-center shadow-lg">
                                        <i data-lucide="bell-ring" class="w-5 h-5 text-white"></i>
                                    </div>
                                    <div>
                                        <h4 class="font-black text-rose-800">Alertes & Seuils</h4>
                                        <p class="text-xs text-rose-600">${alertsCount} seuils actifs • ${unreadNotifs} non lues</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="PDGModule.showAlertThresholdsModal()" class="p-3 bg-white rounded-xl border border-rose-200 text-rose-700 font-bold text-xs hover:bg-rose-50 transition flex items-center justify-center gap-2">
                                        <i data-lucide="sliders-vertical" class="w-4 h-4"></i>
                                        Configurer Seuils
                                    </button>
                                    <button onclick="PDGModule.showNotificationHistoryModal()" class="p-3 bg-white rounded-xl border border-rose-200 text-rose-700 font-bold text-xs hover:bg-rose-50 transition flex items-center justify-center gap-2">
                                        <i data-lucide="history" class="w-4 h-4"></i>
                                        Historique
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Tab: Sécurité -->
                        <div id="pdg-content-security" class="space-y-4 hidden">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-11 h-11 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-200">
                                    <i data-lucide="shield-check" class="w-5 h-5 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-black text-slate-800">Sécurité & Permissions</h3>
                                    <p class="text-xs text-slate-500">Contrôle des accès Manager</p>
                                </div>
                            </div>

                            <!-- Permissions Manager -->
                            <div class="space-y-3">
                                <div class="p-4 rounded-2xl bg-gradient-to-r from-purple-50 to-violet-50 border border-purple-200">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-violet-600 rounded-lg flex items-center justify-center">
                                                <i data-lucide="eye" class="w-5 h-5 text-white"></i>
                                            </div>
                                            <div>
                                                <div class="font-black text-slate-800 text-sm">Manager voit vos données</div>
                                                <div class="text-xs text-slate-500">Accès à vos identifiants</div>
                                            </div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" ${CORE.getSystemSetting('pdg_manager_access', false) ? 'checked' : ''} onchange="PDGModule.toggleManagerAccess()" class="sr-only peer">
                                            <div class="w-14 h-7 bg-slate-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all after:shadow-md peer-checked:bg-purple-500"></div>
                                        </label>
                                    </div>
                                </div>

                                <div class="p-4 rounded-2xl bg-gradient-to-r from-indigo-50 to-blue-50 border border-indigo-200">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-blue-600 rounded-lg flex items-center justify-center">
                                                <i data-lucide="user-plus" class="w-5 h-5 text-white"></i>
                                            </div>
                                            <div>
                                                <div class="font-black text-slate-800 text-sm">Manager gère utilisateurs</div>
                                                <div class="text-xs text-slate-500">Créer/supprimer des comptes</div>
                                            </div>
                                        </div>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" ${CORE.getSystemSetting('manager_manage_users', false) ? 'checked' : ''} onchange="PDGModule.toggleManagerUserManagement()" class="sr-only peer">
                                            <div class="w-14 h-7 bg-slate-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all after:shadow-md peer-checked:bg-indigo-500"></div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Mot de passe -->
                            <button onclick="PDGModule.showChangePersonalPasswordModal()" class="w-full p-4 rounded-2xl bg-gradient-to-r from-cyan-50 to-teal-50 border border-cyan-200 hover:shadow-lg hover:scale-[1.02] transition-all flex items-center gap-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-teal-600 rounded-xl flex items-center justify-center shadow-lg">
                                    <i data-lucide="key" class="w-6 h-6 text-white"></i>
                                </div>
                                <div class="text-left flex-1">
                                    <div class="font-black text-cyan-800">Changer votre mot de passe</div>
                                    <div class="text-xs text-cyan-600">Modifiez votre mot de passe personnel</div>
                                </div>
                                <i data-lucide="chevron-right" class="w-5 h-5 text-cyan-400"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Footer actions -->

                    <!-- Zone Dangereuse PDG -->
                    <div class="p-4 rounded-2xl bg-gradient-to-r from-red-100 to-rose-100 border-2 border-red-300 mt-4">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-11 h-11 bg-gradient-to-br from-red-600 to-red-800 rounded-xl flex items-center justify-center shadow-lg">
                                <i data-lucide="trash-2" class="w-5 h-5 text-white"></i>
                            </div>
                            <div>
                                <h4 class="font-black text-red-800">Zone Dangereuse</h4>
                                <p class="text-xs text-red-600">Actions irréversibles</p>
                            </div>
                        </div>
                        <button onclick="PDGModule.showDeleteAccountModal()" class="w-full p-3 bg-red-600 hover:bg-red-700 text-white font-black text-sm rounded-xl transition flex items-center justify-center gap-2 shadow-lg shadow-red-200">
                            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                            Supprimer définitivement ce compte
                        </button>
                        <p class="text-[10px] text-red-500 mt-2 text-center">Cette action supprimera toutes les données de l'entreprise de manière irréversible</p>
                    </div>

                    <div class="pt-6 flex justify-between items-center">
                        <button onclick="App.logout()" class="px-5 py-3 bg-red-50 text-red-600 rounded-xl font-bold text-sm hover:bg-red-100 transition flex items-center gap-2">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            Déconnexion
                        </button>
                        <button onclick="PDGModule.navigateTo('overview'); UI.toast('✓ Paramétres enregistrès', 'success')" class="px-6 py-3 bg-gradient-to-r from-slate-800 to-zinc-900 text-white rounded-xl font-bold text-sm hover:shadow-lg hover:shadow-amber-200 transition-all flex items-center gap-2 ring-2 ring-amber-400/50">
                            <i data-lucide="arrow-left" class="w-4 h-4 text-amber-400"></i>
                            Retour au tableau de bord
                        </button>
                    </div>

                    <!-- Multi-comptes -->
                    ${window.AccountSwitcher ? AccountSwitcher.getHTML() : '<div id="account-switcher-section"></div>'}
                </div>

                </div>
            `;
        },

        switchSettingsTab(tabName) {
            // Hide all content
            ['general', 'users', 'finance', 'system', 'security'].forEach(tab => {
                const content = document.getElementById('pdg-content-' + tab);
                const tabBtn = document.getElementById('pdg-tab-' + tab);
                if (content) content.classList.add('hidden');
                if (tabBtn) {
                    tabBtn.className = 'flex-1 min-w-[100px] px-4 py-3 text-sm font-bold text-slate-500 hover:text-slate-700 hover:bg-slate-50 rounded-xl flex items-center justify-center gap-2 transition';
                }
            });

            // Show selected
            const selectedContent = document.getElementById('pdg-content-' + tabName);
            const selectedTab = document.getElementById('pdg-tab-' + tabName);
            if (selectedContent) selectedContent.classList.remove('hidden');
            if (selectedTab) {
                selectedTab.className = 'flex-1 min-w-[100px] px-4 py-3 text-sm font-bold text-amber-700 bg-amber-50 rounded-xl flex items-center justify-center gap-2 transition';
            }

            setTimeout(() => lucide.createIcons(), 50);
        },

        toggleManagerAccess() {
            const current = CORE.getSystemSetting('pdg_manager_access', false);
            CORE.setSystemSetting('pdg_manager_access', !current);
            UI.toast(!current ? 'Manager peut maintenant voir vos données' : 'Manager ne peut plus voir vos données', 'info');
            App.rerender();
        },

        toggleManagerUserManagement() {
            const current = CORE.getSystemSetting('manager_manage_users', false);
            CORE.setSystemSetting('manager_manage_users', !current);
            UI.toast(!current ? 'Manager peut maintenant ajouter/retirer des utilisateurs' : 'Manager ne peut plus ajouter/retirer des utilisateurs', 'info');
            App.rerender();
        },

        showUserApprovalModal() {
            const requests = (CORE.db.userAdditionRequests || []).filter(r => r.status === 'pending');

            if (requests.length === 0) {
                UI.toast('Aucune demande en attente', 'info');
                return;
            }

            UI.modal('Approbation des Demandes d\'Utilisateurs', `
                <div class="space-y-4 max-h-[60vh] overflow-y-auto">
                    ${requests.map(req => `
                        <div class="p-4 rounded-2xl border border-slate-200 bg-white">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <div class="font-black text-slate-900">${req.name}</div>
                                    <div class="text-xs text-slate-600 space-y-1 mt-1">
                                        <div>Identifiant: <span class="font-mono text-emerald-600">${req.username}</span></div>
                                        <div>Rôle: <span class="font-bold">${req.role}</span></div>
                                        <div>Demandé par: <span class="font-bold">${req.requestedByName}</span></div>
                                        <div>Date: <span class="text-xs">${new Date(req.requestedAt).toLocaleString('fr-FR')}</span></div>
                                    </div>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-black bg-amber-100 text-amber-700">
                                    ⏳ En attente
                                </span>
                            </div>
                            <div class="flex gap-2 pt-3 border-t border-slate-200">
                                <button onclick="PDGModule.approveUserRequest(${req.id})" class="flex-1 px-3 py-2 bg-emerald-600 text-white rounded-lg text-xs font-black hover:bg-emerald-700 transition">
                                    ✓ Approuver
                                </button>
                                <button onclick="PDGModule.rejectUserRequest(${req.id})" class="flex-1 px-3 py-2 bg-red-600 text-white rounded-lg text-xs font-black hover:bg-red-700 transition">
                                    ✗ Ne pas Autoriser
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        approveUserRequest(requestId) {
            const request = CORE.db.userAdditionRequests?.find(r => r.id === requestId);
            if (!request) return UI.toast('Demande introuvable', 'error');

            // Créer l'utilisateur
            const newUser = {
                id: Math.max(...CORE.getVisibleUsers().map(u => u.id), 0) + 1,
                name: request.name,
                username: request.username,
                password: request.password,
                passwordHash: request.passwordHash,
                role: request.role,
                avatar: request.avatar,
                active: true,
                joinedDate: new Date().toISOString(),
                companyId: CORE.tenantId || 'default',
                accountId: CORE.tenantId || 'default',
                posId: null
            };

            const currentUser = CORE.state.currentUser;
            request.status = 'approved';
            request.approvedBy = currentUser.id;
            request.approvedByName = currentUser.name;
            request.approvedAt = new Date().toISOString();

            CORE.db.users.push(newUser);

            // Audit Log
            CORE.logAudit(
                'approve',
                'userAdditionRequest',
                requestId,
                `Approbation utilisateur: ${request.name}`,
                { requestedBy: request.requestedByName, role: request.role, reason: 'Approuvé par PDG' },
                null,
                newUser
            );

            CORE.save();
            UI.toast(`${request.name} a été approuvé et créé avec succès`, 'success');
            PDGModule.showUserApprovalModal();
            App.rerender();
        },

        rejectUserRequest(requestId) {
            const reason = prompt('Raison du rejet:');
            if (reason === null) return; // Annulé

            const request = CORE.db.userAdditionRequests?.find(r => r.id === requestId);
            if (!request) return UI.toast('Demande introuvable', 'error');

            const currentUser = CORE.state.currentUser;
            request.status = 'rejected';
            request.rejectionReason = reason || 'Aucune raison fournie';
            request.approvedBy = currentUser.id;
            request.approvedByName = currentUser.name;
            request.approvedAt = new Date().toISOString();

            // Audit Log
            CORE.logAudit(
                'reject',
                'userAdditionRequest',
                requestId,
                `Rejet utilisateur: ${request.name}`,
                { requestedBy: request.requestedByName, role: request.role, rejectionReason: reason || 'Aucune raison fournie' },
                null,
                null,
                'success'
            );

            CORE.save();
            UI.toast(`Demande de ${request.name} rejetée`, 'info');
            PDGModule.showUserApprovalModal();
            App.rerender();
        },

        toggleNotifications() {
            this.state.notificationsEnabled = !this.state.notificationsEnabled;
            UI.toast(this.state.notificationsEnabled ? '✓ Notifications activées' : '✗ Notifications désactivées', 'info');
            App.rerender();
        },

        validatePurchaseOrderArrival(orderId) {
            const order = CORE.db.purchaseOrders?.find(o => o.id === orderId);
            if (!order) {
                UI.toast('Commande introuvable', 'error');
                return;
            }
            if (order.status === 'received') {
                UI.toast('Commande déjà reçue', 'info');
                return;
            }

            // Afficher modal pour saisir le montant réellement dépensé du transport
            UI.modal('Montant du transport réellement dépensé',
                '<div class="space-y-4">' +
                UI.input('va_transportAmount', 'Montant du transport', 'number', order.transportPrice || 0, 'ex: 5000', true) +
                '</div>',
                [
                    {label: 'Annuler', onclick: 'UI.closeModal()'},
                    {label: 'Confirmer arrivée', onclick: 'PDGModule.confirmArrivalWithTransport(' + orderId + ')', class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700'}
                ]
            );
        },

        confirmArrivalWithTransport(orderId) {
            const order = CORE.db.purchaseOrders?.find(o => o.id === orderId);
            if (!order) {
                UI.toast('Commande introuvable', 'error');
                return;
            }

            const transportAmount = parseFloat(UI.val('va_transportAmount')) || 0;
            if (transportAmount < 0) {
                UI.toast('Montant invalide', 'warning');
                return;
            }

            // Marquer la commande comme reçue
            order.status = 'received';
            order.actualTransportCost = transportAmount;
            CORE.update('purchaseOrders', order.id, order);

            // Mettre à jour la dépense principale
            const expense = CORE.db.expenses?.find(e => e.purchaseOrderId === orderId && e.type === 'purchase_order');
            if (expense) {
                expense.status = 'completed';
                CORE.update('expenses', expense.id, expense);
            }

            // Créer une dépense pour le transport si un montant a été saisi
            if (transportAmount > 0) {
                const supplier = CORE.db.suppliers?.find(s => s.id === order.supplierId);
                CORE.create('expenses', {
                    reference: order.reference + '-TRANSPORT',
                    type: 'transport',
                    description: `Frais de transport réels - ${order.reference} de ${supplier?.name || 'Fournisseur'}`,
                    amount: transportAmount,
                    supplier: supplier?.name || 'Non spécifié',
                    category: 'transport',
                    status: 'completed',
                    purchaseOrderId: orderId,
                    createdAt: new Date().toISOString()
                });
            }

            // Notification d'arrivée validée
            const supplier = CORE.db.suppliers?.find(s => s.id === order.supplierId);
            const product = CORE.getVisibleProducts().find(p => p.id === order.productId);
            CORE.notify('success', `Colis reçu: ${order.reference} (${product?.name || 'Produit'}) - Transport réel: ${CORE.formatPrice(transportAmount)}`, { purchaseOrderId: orderId });

            UI.closeModal();
            UI.toast('✓ Arrivée du colis validée avec frais de transport: ' + CORE.formatPrice(transportAmount), 'success');
            this.navigateTo('commandes');
        },

        render() {
            const k = this.getKpis();
            this.loadThemePreference();
            CORE.checkStockLevels();

            // === AUTO-REFRESH TEMPS RÉEL (60s) ===
            if (!this._autoRefreshTimer) {
                this._autoRefreshTimer = setInterval(() => {
                    if (this.state.currentView === 'overview' && document.visibilityState === 'visible') {
                        console.log('[DASHBOARD] Auto-refresh temps réel');
                        try { App.rerender(); } catch(e) {}
                    }
                }, 60000);
            }

            // === STOCK ALERT TOASTS (une fois par session) ===
            if (!this._stockAlertsShown && k.outOfStock > 0) {
                this._stockAlertsShown = true;
                setTimeout(() => {
                    UI.toast(k.outOfStock + ' produit(s) en RUPTURE DE STOCK !', 'error');
                    if (k.criticalProducts && k.criticalProducts.filter(p => (p.stock||0) === 0).length > 0) {
                        var names = k.criticalProducts.filter(p => (p.stock||0) === 0).slice(0,3).map(p => p.name).join(', ');
                        setTimeout(() => UI.toast('Ruptures: ' + names, 'warning'), 1500);
                    }
                }, 500);
            }

            return `
                <div class="flex h-screen bg-slate-50 overflow-hidden">
                    <aside class="w-80 bg-gradient-to-b from-indigo-950 via-purple-950 to-slate-950 text-white flex flex-col no-print relative overflow-hidden">
                        <!-- Effets de fond premium -->
                        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top,rgba(139,92,246,0.2),transparent_50%)] pointer-events-none"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_bottom_left,rgba(236,72,153,0.1),transparent_50%)] pointer-events-none"></div>
                        <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-violet-500 via-purple-500 to-pink-500"></div>

                        <!-- Header Premium -->
                        <div class="p-6 flex-shrink-0 relative">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 bg-gradient-to-br from-violet-500 via-purple-500 to-pink-500 rounded-2xl flex items-center justify-center shadow-xl shadow-purple-500/40 ring-2 ring-white/20 relative">
                                    <span class="text-white font-black text-2xl">R</span>
                                    <div class="absolute -top-1 -right-1 w-4 h-4 bg-gradient-to-r from-amber-400 to-yellow-500 rounded-full flex items-center justify-center shadow-lg">
                                        <i data-lucide="crown" class="w-2.5 h-2.5 text-amber-900"></i>
                                    </div>
                                </div>
                                <div>
                                    <h1 class="font-black text-2xl tracking-tight">RAYA<span class="bg-gradient-to-r from-violet-400 to-pink-400 bg-clip-text text-transparent">.pdg</span></h1>
                                    <p class="text-[10px] text-purple-300/70 font-bold uppercase tracking-widest">Command Center</p>
                                </div>
                            </div>

                            <!-- Stats cards -->
                            <div class="mt-6 grid grid-cols-2 gap-3">
                                <div class="p-4 rounded-2xl bg-gradient-to-br from-white/10 to-white/5 border border-white/10 backdrop-blur-sm hover:from-white/15 hover:to-white/10 transition-all duration-300 group">
                                    <div class="text-[10px] text-purple-300/70 font-black uppercase tracking-wider">En cours</div>
                                    <div class="text-2xl font-black bg-gradient-to-r from-emerald-400 to-cyan-400 bg-clip-text text-transparent">${k.deliveriesInProgress}</div>
                                </div>
                                <div class="p-4 rounded-2xl bg-gradient-to-br from-white/10 to-white/5 border border-white/10 backdrop-blur-sm hover:from-white/15 hover:to-white/10 transition-all duration-300 group">
                                    <div class="text-[10px] text-purple-300/70 font-black uppercase tracking-wider">À assigner</div>
                                    <div class="text-2xl font-black bg-gradient-to-r from-amber-400 to-orange-400 bg-clip-text text-transparent">${k.deliveriesToAssign}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation -->
                        <nav class="flex-1 px-4 py-2 space-y-1 overflow-y-auto scrollbar-thin scrollbar-thumb-purple-500/30 scrollbar-track-transparent">
                            ${this.renderNavItem('overview','layout-dashboard','Aperçu', CORE.getUnreadNotificationCount())}
                            ${this.renderNavItem('orders','receipt','Commandes (ventes)', (CORE.db.orders || []).filter(o => o.status === 'pending' || o.status === 'new').length)}
                            ${this.renderNavItem('commandes','shopping-cart','Gestion réappro')}
                            ${this.renderNavItem('main-stock','warehouse','🏭 Stock Dépôt Principal', (CORE.db.transferReceipts || []).filter(t => t.status === 'pending').length)}
                            ${this.renderNavItem('deliveries','truck','Livraisons', (CORE.getVisibleDeliveries ? CORE.getVisibleDeliveries().filter(d => d.status === 'pending' || d.status === 'assigned').length : 0))}
                            ${this.renderNavItem('stock','box','Stock')}
                            ${this.renderNavItem('pos','store','Points de vente')}
                            ${this.renderNavItem('finance','wallet','Finances')}
                            ${this.renderNavItem('reports','bar-chart-3','Rapports')}
                            ${this.renderNavItem('stores','building-2','Multi-Magasins')}
                            ${this.renderNavItem('audit','shield-alert','Audit Trail')}
                            ${this.renderNavItem('team','users','Équipe')}
                            <button onclick="PDGModule.showNotificationHistoryModal()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 text-slate-400 hover:bg-white/10 hover:text-white relative group">
                                <div class="w-9 h-9 rounded-xl bg-white/5 group-hover:bg-white/10 flex items-center justify-center transition-all duration-200">
                                    <i data-lucide="bell" class="w-5 h-5"></i>
                                </div>
                                <span class="font-bold text-sm">Notifications</span>
                                ${CORE.getUnreadNotificationCount() > 0 ? `<span class="ml-auto px-2.5 py-1 bg-gradient-to-r from-red-500 to-pink-500 text-white text-xs font-black rounded-full shadow-lg shadow-red-500/30 animate-pulse">${CORE.getUnreadNotificationCount()}</span>` : ''}
                            </button>
                        </nav>

                        <!-- Footer -->
                        <div class="p-4 border-t border-white/5 relative">
                            <button onclick="PDGModule.navigateTo('settings')" class="w-full flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-white/5 to-white/10 hover:from-white/10 hover:to-white/15 rounded-xl transition-all duration-200 group">
                                <i data-lucide="settings" class="w-5 h-5 text-slate-400 group-hover:text-purple-400 group-hover:rotate-90 transition-all duration-300"></i>
                                <span class="text-sm font-bold text-slate-300 group-hover:text-white">Paramètres</span>
                            </button>
                        </div>
                    </aside>

                    <main class="flex-1 overflow-auto">
                        ${this.state.currentView === 'overview' ? `<header class="bg-white border-b border-slate-200 px-8 py-5 sticky top-0 z-20">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                <div>
                                    <h2 class="text-xl font-black text-slate-900">${this.getViewTitle()}</h2>
                                    <p class="text-sm text-slate-500">PDG: ${CORE.state.currentUser?.name} • ${CORE.state.isOnline ? 'En ligne' : 'Hors ligne'}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="px-3 py-1.5 rounded-full bg-slate-100 text-xs font-black text-slate-600">CA: ${CORE.formatPrice(this.getGlobalRevenue())}</div>
                                    <div class="px-3 py-1.5 rounded-full bg-slate-100 text-xs font-black text-slate-600">Stock: ${CORE.formatPrice(this.getInventoryValue())}</div>
                                </div>
                            </div>
                        </header>` : ''}

                        <div class="p-8">${this.renderContent()}</div>
                    </main>
                </div>
            `;
        },

        // =====================
        // GESTION DES UTILISATEURS (PDG)
        // =====================
        showUsersManagementModal() {
            const users = CORE.getVisibleUsers() || [];
            UI.modal('Gestion des Utilisateurs', `
                <div class="mb-4">
                    <button onclick="PDGModule.showAddUserModal()" class="w-full px-4 py-3 bg-emerald-600 text-white rounded-xl text-sm font-black hover:bg-emerald-700 transition">
                        + Ajouter un utilisateur
                    </button>
                </div>
                <div class="space-y-4 max-h-[50vh] overflow-y-auto">
                    ${users.map(u => `
                        <div class="p-4 rounded-2xl border border-slate-200 bg-white">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex items-center gap-3 flex-1">
                                    ${u.profileImage ? `<img src="${u.profileImage}" class="w-12 h-12 rounded-xl object-cover" onerror="this.style.display='none'">` : `<div class="w-12 h-12 gradient-${u.role} rounded-xl flex items-center justify-center text-white font-black text-sm">${u.avatar}</div>`}
                                    <div class="flex-1">
                                        <div class="font-black text-slate-900">${Utils.escapeHtml(u.name)}</div>
                                        <div class="text-xs text-slate-500 space-y-1">
                                            <div>Role: <span class="font-bold text-slate-700">${Utils.escapeHtml(u.role)}</span></div>
                                            <div>Identifiant: <span class="font-mono text-emerald-600">${Utils.escapeHtml(u.username || 'N/A')}</span></div>
                                            <div>Mot de passe: <span class="font-mono text-cyan-600">••••••••</span></div>
                                            <div>Statut: <span class="font-bold ${u.active ? 'text-emerald-600' : 'text-red-600'}">${u.active ? 'Actif' : 'Inactif'}</span></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <button onclick="PDGModule.showUserDetailsModal('${u.id}')" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-xs font-black hover:bg-indigo-700 transition">
                                        📋 Détails
                                    </button>
                                    <button onclick="PDGModule.showEditUserModal('${u.id}')" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-black hover:bg-blue-700 transition">
                                        Modifier
                                    </button>
                                    <button onclick="PDGModule.toggleUserActive('${u.id}')" class="px-3 py-2 ${u.active ? 'bg-red-600 hover:bg-red-700' : 'bg-emerald-600 hover:bg-emerald-700'} text-white rounded-lg text-xs font-black transition">
                                        ${u.active ? 'Désactiver' : 'Activer'}
                                    </button>
                                    ${!u.suspended ? `
                                        <button onclick="PDGModule.showSuspendUserModal('${u.id}')" class="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-black hover:bg-orange-700 transition">
                                            🔒 Suspendre
                                        </button>
                                    ` : `
                                        <button onclick="const res = CORE.resumeUser('${u.id}'); UI.toast(res.message, res.success ? 'success' : 'error'); PDGModule.showUsersManagementModal();" class="px-3 py-2 bg-emerald-600 text-white rounded-lg text-xs font-black hover:bg-emerald-700 transition">
                                            ✓ Réactiver
                                        </button>
                                    `}
                                    <button onclick="PDGModule.showChangePasswordModal('${u.id}')" class="px-3 py-2 bg-amber-600 text-white rounded-lg text-xs font-black hover:bg-amber-700 transition">
                                        Mot de passe
                                    </button>
                                    <button onclick="PDGModule.deleteUser('${u.id}')" class="px-3 py-2 bg-red-500 text-white rounded-lg text-xs font-black hover:bg-red-600 transition">
                                        🗑️ Supprimer
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showUserDetailsModal(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouvé', 'error');

            const roleColors = {
                'pdg': 'text-purple-700 bg-purple-50',
                'manager': 'text-blue-700 bg-blue-50',
                'gestionnaire': 'text-slate-700 bg-slate-50',
                'vendeur': 'text-emerald-700 bg-emerald-50',
                'livreur': 'text-orange-700 bg-orange-50'
            };

            const roleColor = roleColors[user.role] || 'text-slate-700 bg-slate-50';

            UI.modal(`Détails: ${user.name}`, `
                <div class="space-y-4 max-h-[60vh] overflow-y-auto">
                    <div class="flex items-start gap-4 pb-4 border-b border-slate-200">
                        <div>
                            ${user.profileImage && typeof user.profileImage === 'string' && user.profileImage.trim() && (user.profileImage.startsWith('data:') || user.profileImage.startsWith('http')) ? `<img src="${user.profileImage}" class="w-20 h-20 rounded-xl object-cover" onerror="this.style.display='none'">` : ''}<div class="${user.profileImage && typeof user.profileImage === 'string' && user.profileImage.trim() && (user.profileImage.startsWith('data:') || user.profileImage.startsWith('http')) ? 'hidden' : 'w-20 h-20'} gradient-${user.role} rounded-xl flex items-center justify-center text-white font-black text-2xl">${user.avatar}</div>
                        </div>
                        <div class="flex-1">
                            <div class="font-black text-lg text-slate-900">${user.name}</div>
                            <div class="text-xs font-bold ${roleColor} px-3 py-1 rounded-full inline-block mt-2">${user.role.toUpperCase()}</div>
                            <div class="text-xs text-slate-600 mt-2">ID: ${user.id}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-3 rounded-lg bg-slate-50">
                            <div class="text-xs font-black text-slate-600 uppercase">Identifiant</div>
                            <div class="text-sm font-mono text-slate-900 mt-1">${user.username || 'N/A'}</div>
                        </div>
                        <div class="p-3 rounded-lg bg-slate-50">
                            <div class="text-xs font-black text-slate-600 uppercase">Mot de passe</div>
                            <div class="text-sm font-mono text-slate-900 mt-1">${user.password || 'N/A'}</div>
                        </div>
                    </div>

                    <div class="p-3 rounded-lg bg-emerald-50 border border-emerald-200">
                        <div class="text-xs font-black text-emerald-700 uppercase">Statut</div>
                        <div class="text-sm font-bold text-emerald-900 mt-1">${user.active ? '✓ Actif' : '✗ Inactif'}</div>
                    </div>

                    ${user.city ? `<div class="p-3 rounded-lg bg-cyan-50 border border-cyan-200">
                        <div class="text-xs font-black text-cyan-700 uppercase">Ville</div>
                        <div class="text-sm text-cyan-900 mt-1">${(() => {
                            const city = CORE.db.cities?.find(c => c.id === user.city);
                            return city ? city.name : 'N/A';
                        })()}</div>
                    </div>` : ''}

                    ${user.pos ? `<div class="p-3 rounded-lg bg-lime-50 border border-lime-200">
                        <div class="text-xs font-black text-lime-700 uppercase">Point de Vente</div>
                        <div class="text-sm text-lime-900 mt-1">${(() => {
                            const pos = CORE.db.pointsOfSale?.find(p => p.id === user.pos);
                            return pos ? pos.name : 'N/A';
                        })()}</div>
                    </div>` : ''}

                    ${user.bio ? `<div class="p-3 rounded-lg bg-blue-50 border border-blue-200">
                        <div class="text-xs font-black text-blue-700 uppercase">Bio</div>
                        <div class="text-sm text-blue-900 mt-1">${user.bio}</div>
                    </div>` : ''}

                    ${user.specialties ? `<div class="p-3 rounded-lg bg-indigo-50 border border-indigo-200">
                        <div class="text-xs font-black text-indigo-700 uppercase">Spécialités</div>
                        <div class="text-sm text-indigo-900 mt-1">${user.specialties.join(', ')}</div>
                    </div>` : ''}

                    ${user.rating || user.totalSales || user.salesCount ? `<div class="grid grid-cols-3 gap-3">
                        ${user.rating ? `<div class="p-3 rounded-lg bg-yellow-50">
                            <div class="text-xs font-black text-yellow-700 uppercase">Note</div>
                            <div class="text-lg font-black text-yellow-900 mt-1">⭐ ${user.rating}</div>
                        </div>` : ''}
                        ${user.totalSales ? `<div class="p-3 rounded-lg bg-purple-50">
                            <div class="text-xs font-black text-purple-700 uppercase">Ventes</div>
                            <div class="text-sm text-purple-900 mt-1">${CORE.formatPrice(user.totalSales)}</div>
                        </div>` : ''}
                        ${user.salesCount ? `<div class="p-3 rounded-lg bg-pink-50">
                            <div class="text-xs font-black text-pink-700 uppercase">Nb Ventes</div>
                            <div class="text-lg font-black text-pink-900 mt-1">${user.salesCount}</div>
                        </div>` : ''}
                    </div>` : ''}

                    ${user.badge ? `<div class="p-3 rounded-lg bg-yellow-50 border border-yellow-200">
                        <div class="text-xs font-black text-yellow-700 uppercase">Badge</div>
                        <div class="text-sm text-yellow-900 mt-1">${(() => {
                            const badge = CORE.db.vendorBadges?.find(b => b.id === user.badge);
                            return badge ? badge.label : user.badge;
                        })()}</div>
                    </div>` : ''}

                    ${user.deliveryCount ? `<div class="p-3 rounded-lg bg-orange-50 border border-orange-200">
                        <div class="text-xs font-black text-orange-700 uppercase">Livraisons effectuées</div>
                        <div class="text-sm font-black text-orange-900 mt-1">${user.deliveryCount}</div>
                    </div>` : ''}

                    ${user.phone ? `<div class="p-3 rounded-lg bg-teal-50 border border-teal-200">
                        <div class="text-xs font-black text-teal-700 uppercase">Téléphone</div>
                        <div class="text-sm text-teal-900 mt-1">${user.phone}</div>
                    </div>` : ''}

                    ${user.vehicle ? `<div class="p-3 rounded-lg bg-red-50 border border-red-200">
                        <div class="text-xs font-black text-red-700 uppercase">Véhicule</div>
                        <div class="text-sm text-red-900 mt-1">${user.vehicle}</div>
                    </div>` : ''}

                    ${user.joinedDate ? `<div class="p-3 rounded-lg bg-gray-50 border border-gray-200">
                        <div class="text-xs font-black text-gray-700 uppercase">Date d'adhésion</div>
                        <div class="text-sm text-gray-900 mt-1">${user.joinedDate}</div>
                    </div>` : ''}
                </div>
            `, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        },

        showEditUserModal(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouvé', 'error');

            UI.modal(`Modifier: ${user.name}`, `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Identifiant</label>
                        <input type="text" id="edit-username" value="${user.username || ''}" placeholder="Identifiant" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Rôle</label>
                        <select id="edit-role" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="pdg" ${user.role === 'pdg' ? 'selected' : ''}>PDG</option>
                            <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>Manager</option>
                            <option value="gestionnaire" ${user.role === 'gestionnaire' ? 'selected' : ''}>Gestionnaire</option>
                            <option value="vendeur" ${user.role === 'vendeur' ? 'selected' : ''}>Vendeur</option>
                            <option value="livreur" ${user.role === 'livreur' ? 'selected' : ''}>Livreur</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 p-4 bg-red-50 border border-red-200 rounded-2xl">
                    <div class="text-xs font-black text-red-700 mb-3">🔐 Réinitialiser le mot de passe</div>
                    <button class="w-full px-4 py-2 bg-red-600 text-white rounded-lg text-xs font-black hover:bg-red-700 transition" data-user-id="${userId}" data-action="resetPassword">
                        Réinitialiser le mot de passe
                    </button>
                </div>
            `, [
                { label: 'Enregistrer', onclick: `PDGModule.saveEditUser(${userId})` },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);

            // Bind actions inside modal content (avoid inline onclick template issues)
            setTimeout(() => {
                const resetBtn = document.querySelector(`#modalContainer [data-action="resetPassword"][data-user-id="${userId}"]`);
                if (resetBtn) resetBtn.onclick = () => PDGModule.resetUserPassword(userId);
            }, 0);
        },

        saveEditUser(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouvé', 'error');

            const newUsername = document.getElementById('edit-username')?.value?.trim();
            const newRole = document.getElementById('edit-role')?.value;

            if (!newUsername) return UI.toast('L\'identifiant est requis', 'warning');

            // Vérifier que l'identifiant n'existe pas ailleurs
            const exists = CORE.getVisibleUsers().some(u => u.id !== userId && u.username === newUsername);
            if (exists) return UI.toast('Cet identifiant existe déjà', 'error');

            user.username = newUsername;
            user.role = newRole || user.role;

            CORE.save();
            UI.toast('Utilisateur modifié avec succès', 'success');
            UI.closeModal();
            this.showUsersManagementModal();
        },

        async resetUserPassword(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouvé', 'error');

            // Réinitialiser à un mot de passe par défaut : "123456"
            const hash = await Utils.md5('123456');
            user.password = '123456';
            user.passwordHash = hash;

            // Propager dans l'index global
            CORE._syncGlobalFromTenant();
            CORE.save();
            CORE.markDirty('users');
            CORE.logAudit('update', 'user', userId, user.name, { description: `Mot de passe réinitialisé à la valeur par défaut (PDG)` });

            // Sync cloud
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated()) {
                try {
                    await API.request('/sync/users', { method: 'PUT', body: { data: CORE.db.users || [] } });
                    console.log('[PDG] Cloud users synced after password reset');
                } catch(e) { console.warn('[PDG] Cloud sync password reset failed:', e.message); }
            }

            UI.toast(`✓ Mot de passe de ${user.name} réinitialisé à "123456"`, 'success');
            UI.closeModal();
            this.showUsersManagementModal();
        },

        // P2-10: Delegate to ManagerModule (identical modal — avoids 50-line duplication)
        // Note: PDG has full access, no role check needed (ManagerModule checks but PDG always passes)
        showChangePasswordModal(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouvé', 'error');
            UI.modal(`Changer le mot de passe: ${Utils.escapeHtml(user.name)}`, `
                <div class="space-y-4 bg-blue-50 border border-blue-200 rounded-2xl p-4 mb-4">
                    <div class="text-sm text-blue-800">
                        <div class="font-black mb-2">⚠️ Attention</div>
                        <div>Un nouveau mot de passe temporaire sera généré. L'utilisateur devra le changer à sa prochaine connexion.</div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-black text-slate-600 uppercase mb-2">Nouveau mot de passe</label>
                    <input type="password" id="change-password-input" placeholder="Entrez le nouveau mot de passe" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-amber-500 focus:outline-none">
                    <div class="text-xs text-slate-500 mt-2">Minimum 6 caractères requis</div>
                </div>
            `, [
                { label: 'Changer le mot de passe', onclick: `PDGModule.savePasswordChange(${userId})` },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);
        },

        // Delegates to ManagerModule.savePasswordChange (same logic, keeps PDG context via this binding)
        async savePasswordChange(userId) {
            return ManagerModule.savePasswordChange.call(this, userId);
        },

        async toggleUserActive(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouvé', 'error');

            const newActive = !user.active;
            const backendUserId = user._apiId || user.apiId || user.backendId || userId;
            // Call backend
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated()) {
                try {
                    const endpoint = newActive ? '/users/' + backendUserId + '/reactivate' : '/users/' + backendUserId + '/deactivate';
                    await API.request(endpoint, { method: 'PATCH' });
                    console.log('[PDG] toggleUserActive backend OK:', backendUserId, newActive ? 'reactivated' : 'deactivated');
                } catch(e) {
                    console.warn('[PDG] toggleUserActive backend failed:', e.message);
                }
            }
            user.active = newActive;
            CORE.save();
            UI.toast(`${user.name} est maintenant ${user.active ? 'actif' : 'inactif'}`, 'info');
            this.showUsersManagementModal();
        },

        showAddUserModal() {
            UI.modal('Ajouter un nouvel utilisateur', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Nom complet</label>
                        <input type="text" id="add-name" placeholder="Nom de l'utilisateur" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Identifiant</label>
                        <input type="text" id="add-username" placeholder="Identifiant unique" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Mot de passe initial</label>
                        <input type="password" id="add-password" placeholder="Mot de passe temporaire" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                        <div class="text-xs text-slate-500 mt-2">Minimum 6 caractères</div>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Image de profil</label>
                        <div class="flex items-center gap-3">
                            <input type="file" id="add-profile-image" accept="image/*" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none text-sm">
                            <div id="profile-preview" class="w-12 h-12 rounded-lg bg-slate-200 flex items-center justify-center text-sm font-black text-slate-600 flex-shrink-0">--</div>
                        </div>
                        <div class="text-xs text-slate-500 mt-2">JPG, PNG ou GIF (max 2MB)</div>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Rôle</label>
                        <select id="add-role" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                            <option value="gestionnaire">Gestionnaire</option>
                            <option value="vendeur">Vendeur</option>
                            <option value="livreur">Livreur</option>
                            <option value="manager">Manager</option>
                            <option value="pdg">PDG</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-600 uppercase mb-2">Avatar (2 caractères - optionnel)</label>
                        <input type="text" id="add-avatar" placeholder="Ex: JD" maxlength="2" class="w-full px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                        <div class="text-xs text-slate-500 mt-2">Utilisé si pas d'image de profil</div>
                    </div>
                </div>
            `, [
                { label: 'Créer l\'utilisateur', onclick: 'PDGModule.saveNewUser()' },
                { label: 'Annuler', onclick: 'UI.closeModal()' }
            ]);

            // Event listener pour l'aperçu de l'image
            setTimeout(() => {
                const fileInput = document.getElementById('add-profile-image');
                if (fileInput) {
                    fileInput.addEventListener('change', function(e) {
                        if (e.target.files[0]) {
                            const reader = new FileReader();
                            reader.onload = function(event) {
                                const preview = document.getElementById('profile-preview');
                                if (preview) {
                                    preview.innerHTML = '';
                                    const img = document.createElement('img');
                                    img.src = event.target.result;
                                    img.className = 'w-full h-full object-cover rounded-lg';
                                    preview.appendChild(img);
                                }
                            };
                            reader.readAsDataURL(e.target.files[0]);
                        }
                    });
                }
            }, 100);
        },

        saveNewUser() {
            const name = document.getElementById('add-name')?.value?.trim() || '';
            const username = document.getElementById('add-username')?.value?.trim() || '';
            const password = document.getElementById('add-password')?.value || '';
            const role = document.getElementById('add-role')?.value || 'gestionnaire';
            const avatar = document.getElementById('add-avatar')?.value?.trim().toUpperCase() || 'XX';
            const profileImageInput = document.getElementById('add-profile-image');

            if (!name || !username || !password) return UI.toast('Tous les champs sont requis', 'warning');
            if (password.length < 6) return UI.toast('Le mot de passe doit avoir au minimum 6 caractères', 'warning');

            // Vérifier que l'identifiant n'existe pas (local + global)
            const existsLocal = CORE.getVisibleUsers().some(u => u.username === username);
            const existsGlobal = CORE.isUsernameTaken ? CORE.isUsernameTaken(username) : false;
            if (existsLocal || existsGlobal) return UI.toast('Cet identifiant existe déjà', 'error');

            // Traiter l'image de profil si présente
            if (profileImageInput && profileImageInput.files && profileImageInput.files[0]) {
                const file = profileImageInput.files[0];

                // Vérifier la taille (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    return UI.toast('L\'image doit faire moins de 2MB', 'error');
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const profileImage = e.target.result; // base64 string

                    // Hacher le mot de passe
                    Utils.md5(password).then(hash => {
                        const newUser = {
                            id: Math.max(...CORE.getVisibleUsers().map(u => u.id), 0) + 1,
                            name,
                            username,
                            password,
                            passwordHash: hash,
                            role,
                            avatar,
                            profileImage,
                            active: true,
                            companyId: CORE.tenantId || 'default',
                            accountId: CORE.tenantId || 'default',
                            posId: null
                        };

                        CORE.db.users.push(newUser);
                        // Clear _deletedUserIds when creating a new user (prevents old deletion filters blocking)
                        if (CORE._deletedUserIds && Object.keys(CORE._deletedUserIds).length > 0) {
                            CORE._deletedUserIds = {};
                            try { localStorage.setItem('_deletedUserIds', '{}'); } catch(e) {}
                        }
                        CORE.save();
                        CORE.markDirty('users');
                        if (typeof RayaAPI !== 'undefined' && RayaAPI.isAuthenticated()) {
                            API.registerUserSilent({ email: username, password, firstName: name.split(' ')[0], lastName: name.split(' ').slice(1).join(' '), role: role.toUpperCase(), tenantId: RayaAPI.tenantId }).then(function(res) {
                                if (res && res.user && res.user.id) { newUser._apiId = res.user.id; CORE.save(); console.log('[PDG] User registered, apiId:', res.user.id); }
                            }).catch(e => console.warn('[API] User register:', e));
                            // Push users collection to cloud sync
                            API.request('/sync/users', { method: 'PUT', body: { data: CORE.db.users || [] } }).then(function() {
                                console.log('[PDG] Cloud users synced after new user creation');
                            }).catch(function(e) { console.warn('[PDG] Cloud sync after user creation failed:', e.message); });
                        }
                        UI.toast(`${name} a été créé avec succès`, 'success');
                        UI.closeModal();
                        this.showUsersManagementModal();
                    });
                };
                reader.readAsDataURL(file);
            } else {
                // Pas d'image de profil, créer l'utilisateur sans
                Utils.md5(password).then(hash => {
                    const newUser = {
                        id: Math.max(...CORE.getVisibleUsers().map(u => u.id), 0) + 1,
                        name,
                        username,
                        password,
                        passwordHash: hash,
                        role,
                        avatar,
                        active: true,
                        companyId: CORE.tenantId || 'default',
                        accountId: CORE.tenantId || 'default',
                        posId: null
                    };

                    CORE.db.users.push(newUser);
                    // Clear _deletedUserIds when creating a new user (prevents old deletion filters blocking)
                    if (CORE._deletedUserIds && Object.keys(CORE._deletedUserIds).length > 0) {
                        CORE._deletedUserIds = {};
                        try { localStorage.setItem('_deletedUserIds', '{}'); } catch(e) {}
                    }
                    CORE.save();
                    CORE.markDirty('users');
                    if (typeof RayaAPI !== 'undefined' && RayaAPI.isAuthenticated()) {
                        API.registerUserSilent({ email: username, password, firstName: name.split(' ')[0], lastName: name.split(' ').slice(1).join(' '), role: role.toUpperCase(), tenantId: RayaAPI.tenantId }).then(function(res) {
                            if (res && res.user && res.user.id) { newUser._apiId = res.user.id; CORE.save(); console.log('[PDG] User registered, apiId:', res.user.id); }
                        }).catch(e => console.warn('[API] User register:', e));
                        // Push users collection to cloud sync
                        API.request('/sync/users', { method: 'PUT', body: { data: CORE.db.users || [] } }).then(function() {
                            console.log('[PDG] Cloud users synced after new user creation (no image)');
                        }).catch(function(e) { console.warn('[PDG] Cloud sync after user creation failed:', e.message); });
                    }
                    UI.toast(`${name} a été créé avec succès`, 'success');
                    UI.closeModal();
                    this.showUsersManagementModal();
                });
            }
        },

        async deleteUser(userId) {
            const user = CORE.getUser(userId);
            if (!user) return UI.toast('Utilisateur non trouvé', 'error');

            if (!confirm(`Êtes-vous sûr de vouloir supprimer ${user.name} ?`)) return;

            const backendUserId = user._apiId || user.apiId || user.backendId || userId;
            console.log('[PDG] deleteUser called, userId:', userId, 'backendUserId:', backendUserId);

            // 1. Backend: remove membership (this also deactivates the user account)
            let backendOk = false;
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated()) {
                try {
                    await API.request('/user-tenants/members/' + backendUserId, { method: 'DELETE' });
                    console.log('[PDG] Backend membership removed + user deactivated for', backendUserId);
                    backendOk = true;
                } catch(e) {
                    console.warn('[PDG] Backend remove membership failed:', e.message);
                    // Fallback: try to deactivate user directly
                    try {
                        await API.request('/users/' + backendUserId + '/deactivate', { method: 'PATCH' });
                        console.log('[PDG] Backend user deactivated via fallback:', backendUserId);
                        backendOk = true;
                    } catch(e2) {
                        console.error('[PDG] Both backend calls failed:', e.message, e2.message);
                    }
                }
            } else {
                console.warn('[PDG] Not authenticated, skipping backend calls');
            }

            // 2. Remove locally + mark as deleted so sync won't re-add
            if (!CORE._deletedUserIds) CORE._deletedUserIds = {};
            CORE._deletedUserIds[backendUserId] = true;
            CORE._deletedUserIds[userId] = true;
            CORE._deletedUserIds[String(backendUserId)] = true;
            CORE._deletedUserIds[String(userId)] = true;
            try { localStorage.setItem('_deletedUserIds', JSON.stringify(CORE._deletedUserIds)); } catch(e) {}

            // Remove from local DB
            CORE.db.users = (CORE.db.users || []).filter(u =>
                String(u.id) !== String(userId) && String(u.id) !== String(backendUserId) &&
                String(u._apiId || '') !== String(userId) && String(u._apiId || '') !== String(backendUserId)
            );
            CORE.logAudit('delete', 'user', userId, user.name, { description: `Utilisateur supprimé: ${user.name} (${user.role})` });
            CORE.save();

            // 3. Push updated users list to cloud so the deleted user is also removed from cloud data
            if (backendOk && typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated()) {
                try {
                    await API.request('/sync/users', { method: 'PUT', body: { data: CORE.db.users || [] } });
                    console.log('[PDG] Cloud users collection updated after deletion');
                } catch(syncErr) {
                    console.warn('[PDG] Cloud sync after delete failed:', syncErr.message);
                }
            }

            UI.toast(`${user.name} a été supprimé` + (backendOk ? '' : ' (local seulement)'), backendOk ? 'success' : 'warning');
            UI.closeModal();
            App.rerender();
        },

        showDeleteAccountModal() {
            const currentUser = CORE.state.currentUser;
            if (!currentUser) return UI.toast('Utilisateur non connecté', 'error');

            const companyName = CORE.db.company?.name || 'Mon Entreprise';

            UI.modal('⚠️ Supprimer définitivement ce compte', `
                <div style="text-align:center; padding:20px;">
                    <div style="font-size:60px; margin-bottom:15px;">🗑️</div>
                    <h3 style="color:#e74c3c; margin-bottom:10px;">Suppression irréversible</h3>
                    <p style="color:#666; margin-bottom:20px;">
                        Vous êtes sur le point de supprimer définitivement le compte
                        <strong>${companyName}</strong> et toutes ses données.
                    </p>
                    <div style="background:#fff3f3; border:2px solid #e74c3c; border-radius:12px; padding:15px; margin-bottom:20px; text-align:left;">
                        <p style="font-weight:bold; color:#e74c3c; margin-bottom:10px;">⚠️ Cette action supprimera :</p>
                        <ul style="color:#555; list-style:disc; padding-left:20px; line-height:1.8;">
                            <li>Tous les produits et stocks</li>
                            <li>Toutes les ventes et factures</li>
                            <li>Tous les employés et comptes</li>
                            <li>Toutes les données cloud synchronisées</li>
                            <li>Le profil de l'entreprise</li>
                        </ul>
                    </div>
                    <div style="margin-bottom:15px;">
                        <label style="display:block; font-weight:bold; margin-bottom:5px; color:#333;">
                            Tapez <span style="color:#e74c3c;">SUPPRIMER</span> pour confirmer :
                        </label>
                        <input type="text" id="deleteConfirmText"
                            placeholder="Tapez SUPPRIMER"
                            style="width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:16px; text-align:center;"
                        />
                    </div>
                    <div style="margin-bottom:20px;">
                        <label style="display:block; font-weight:bold; margin-bottom:5px; color:#333;">
                            Votre mot de passe :
                        </label>
                        <input type="password" id="deleteConfirmPassword"
                            placeholder="Entrez votre mot de passe"
                            style="width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:16px;"
                        />
                    </div>
                    <button onclick="PDGModule.confirmDeleteAccount()"
                        style="width:100%; padding:14px; background:linear-gradient(135deg,#e74c3c,#c0392b); color:#fff; border:none; border-radius:10px; font-size:16px; font-weight:bold; cursor:pointer;">
                        🗑️ Supprimer définitivement
                    </button>
                </div>
            `);
        },

        async confirmDeleteAccount() {
            const confirmText = document.getElementById('deleteConfirmText')?.value?.trim();
            const password = document.getElementById('deleteConfirmPassword')?.value;
            const currentUser = CORE.state.currentUser;

            if (!currentUser) return UI.toast('Erreur: utilisateur non trouvé', 'error');

            if (confirmText !== 'SUPPRIMER') {
                return UI.toast('Veuillez taper SUPPRIMER exactement', 'error');
            }

            if (!password) {
                return UI.toast('Veuillez entrer votre mot de passe', 'error');
            }

            // Verify password via backend login attempt
            const email = currentUser.email;
            if (!email) return UI.toast('Email du compte introuvable', 'error');

            UI.toast('Vérification du mot de passe...', 'info');
            try {
                await API.request('/auth/login', { method: 'POST', body: { email, password } });
            } catch(e) {
                return UI.toast('Mot de passe incorrect', 'error');
            }

            // Password verified — proceed with deletion
            UI.toast('Suppression en cours...', 'info');

            const tenantId = API.tenantId || CORE.tenantId || CORE.db.systemConfig?.companyId;
            const userId = currentUser._apiId || currentUser.apiId || currentUser.id;

            // 1. Delete tenant on backend (sets INACTIVE)
            if (tenantId && CORE.state.isOnline && API.isAuthenticated && API.isAuthenticated()) {
                try {
                    await API.request('/tenants/' + tenantId, { method: 'DELETE' });
                    console.log('[DELETE-ACCOUNT] Tenant', tenantId, 'deactivated on backend');
                } catch(e) {
                    console.warn('[DELETE-ACCOUNT] Backend tenant delete failed:', e.message);
                }

                // 2. Deactivate user account so login is impossible even if tenant check fails
                if (userId) {
                    try {
                        await API.request('/users/' + userId + '/deactivate', { method: 'PATCH' });
                        console.log('[DELETE-ACCOUNT] User', userId, 'deactivated on backend');
                    } catch(e) {
                        console.warn('[DELETE-ACCOUNT] Backend user deactivate failed:', e.message);
                    }
                }

                // 3. Revoke session
                try {
                    const sessionId = localStorage.getItem('raya_session_id');
                    await API.request('/auth/logout', { method: 'POST', body: sessionId ? { sessionId } : {} });
                } catch(e) { console.warn('[DELETE-ACCOUNT] Backend logout failed:', e.message); }
            }

            // 3. Clear ALL auth tokens
            try { localStorage.removeItem('raya_token'); } catch(e){}
            try { localStorage.removeItem('raya_refresh_token'); } catch(e){}
            try { localStorage.removeItem('raya_session_id'); } catch(e){}
            try { localStorage.removeItem('raya_creds_v2'); } catch(e){}
            try { localStorage.removeItem('raya_creds'); } catch(e){}
            try { API.clearTokens(); } catch(e){ console.warn('[DELETE-ACCOUNT] API.clearTokens failed:', e); }

            // 4. Delete all local data
            UI.closeModal();
            UI.toast('✅ Compte supprimé définitivement. Au revoir...', 'success');
            setTimeout(() => {
                CORE.reset();
                // Hide mobile nav elements
                try {
                    var h = document.querySelector('.mobile-hamburger'); if (h) h.style.display = 'none';
                    var o = document.querySelector('.mobile-sidebar-overlay'); if (o) o.style.display = 'none';
                    var b = document.querySelector('.mobile-bottom-nav'); if (b) b.style.display = 'none';
                } catch(e){}
                App.renderOnboarding();
            }, 1500);
        },

        showInviteEmployeeModal() {
            // Redirect to full invitation management page
            PDGModule._invitationTab = PDGModule._invitationTab || 'create';
            PDGModule._invitations = [];
            PDGModule._joinRequests = [];
            PDGModule._invitationLoading = false;
            PDGModule._lastInviteResultHTML = null;
            App.mount(PDGModule.renderInvitationManagement());
            PDGModule.loadInvitationData();
            setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 80);
        },

        async loadInvitationData() {
            if (!API.isAuthenticated || !API.isAuthenticated()) return;
            PDGModule._invitationLoading = true;
            try {
                const [invitations, joinRequests, pendingMembers] = await Promise.all([
                    API.listInvitations().catch(() => []),
                    API.listJoinRequests().catch(() => []),
                    API.request('/user-tenants/members/pending', { method: 'GET' }).catch(() => [])
                ]);
                PDGModule._invitations = Array.isArray(invitations) ? invitations : (invitations?.data || invitations?.invitations || []);
                PDGModule._joinRequests = Array.isArray(joinRequests) ? joinRequests : (joinRequests?.data || joinRequests?.requests || []);
                PDGModule._pendingMembers = Array.isArray(pendingMembers) ? pendingMembers : [];
                const pendingMembersList = PDGModule._pendingMembers || [];
                const pendingMemberUserIds = new Set(
                    pendingMembersList
                        .map(function(m) { return String(m.userId || m.user_id || ''); })
                        .filter(function(id) { return !!id; })
                );
                const pendingMemberEmails = new Set(
                    pendingMembersList
                        .map(function(m) { return String(m.email || m.userEmail || '').toLowerCase().trim(); })
                        .filter(function(email) { return !!email; })
                );
                const activeUsers = (CORE.db.users || []).filter(function(u) { return u && u.active !== false && !u.pendingApproval; });
                const activeUserIds = new Set(
                    activeUsers
                        .map(function(u) { return String(u._apiId || u.id || ''); })
                        .filter(function(id) { return !!id; })
                );
                const activeUserEmails = new Set(
                    activeUsers
                        .map(function(u) { return String(u.email || u.username || '').toLowerCase().trim(); })
                        .filter(function(email) { return !!email; })
                );
                const dedupPendingRequests = (PDGModule._joinRequests || []).filter(function(r) {
                    if (r.status !== 'PENDING') return false;
                    const requestUserId = String(r.userId || r.user_id || '');
                    if (requestUserId && pendingMemberUserIds.has(requestUserId)) return false;
                    const requestEmail = String(r.userEmail || r.email || '').toLowerCase().trim();
                    if (requestEmail && pendingMemberEmails.has(requestEmail)) return false;
                    if (requestUserId && activeUserIds.has(requestUserId)) return false;
                    if (requestEmail && activeUserEmails.has(requestEmail)) return false;
                    return true;
                });
                const pendingCount = dedupPendingRequests.length + pendingMembersList.length;
                if (pendingCount > 0 && (PDGModule._invitationTab === 'create' || !PDGModule._invitationTab)) {
                    PDGModule._invitationTab = 'pending';
                }
            } catch(e) { console.warn('[INVITE] Load failed:', e); }
            PDGModule._invitationLoading = false;
            App.mount(PDGModule.renderInvitationManagement());
            setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 80);
        },

        switchInvitationTab(tab) {
            PDGModule._invitationTab = tab;
            if (tab === 'create') PDGModule._lastInviteResultHTML = null;
            App.mount(PDGModule.renderInvitationManagement());
            setTimeout(() => { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 80);
        },

        renderInvitationManagement() {
            const tab = PDGModule._invitationTab || 'create';
            const invitations = PDGModule._invitations || [];
            const joinRequests = PDGModule._joinRequests || [];
            const pendingMembers = PDGModule._pendingMembers || [];
            const pendingMemberUserIds = new Set(
                pendingMembers
                    .map(function(m) { return String(m.userId || m.user_id || ''); })
                    .filter(function(id) { return !!id; })
            );
            const pendingRequests = joinRequests.filter(function(r) {
                if (r.status !== 'PENDING') return false;
                const requestUserId = String(r.userId || r.user_id || '');
                return requestUserId ? !pendingMemberUserIds.has(requestUserId) : true;
            });
            const totalPending = pendingRequests.length + pendingMembers.length;
            const pendingBadge = totalPending > 0 ? '<span class="ml-1.5 px-2 py-0.5 text-xs font-black bg-red-500 text-white rounded-full">' + totalPending + '</span>' : '';

            const tabs = [
                { id: 'create', icon: 'plus-circle', label: 'Nouvelle invitation' },
                { id: 'history', icon: 'history', label: 'Invitations envoyées (' + invitations.length + ')' },
                { id: 'pending', icon: 'user-check', label: 'Demandes en attente' + pendingBadge },
            ];

            const tabBar = tabs.map(t => {
                const active = tab === t.id;
                return '<button onclick="PDGModule.switchInvitationTab(\'' + t.id + '\')" class="flex items-center gap-2 px-4 py-2.5 rounded-xl font-bold text-sm transition ' + (active ? 'bg-purple-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100 border border-slate-200') + '"><i data-lucide="' + t.icon + '" class="w-4 h-4"></i>' + t.label + '</button>';
            }).join('');

            let content = '';
            if (tab === 'create') content = PDGModule._renderCreateInvitation();
            else if (tab === 'history') content = PDGModule._renderInvitationHistory();
            else if (tab === 'pending') content = PDGModule._renderPendingRequests();

            return '<div class="fade-in max-w-5xl mx-auto space-y-6 pb-8">' +
                '<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">' +
                    '<div><h2 class="text-2xl font-black text-slate-900">📨 Gestion des Invitations</h2>' +
                    '<p class="text-slate-500 font-medium">Invitez des employés, générez des liens et gérez les demandes d\'accès</p></div>' +
                    '<button onclick="PDGModule.showTeamSection ? PDGModule.showTeamSection() : App.rerender()" class="px-4 py-2 bg-slate-200 text-slate-700 font-bold rounded-xl hover:bg-slate-300 transition flex items-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Retour</button>' +
                '</div>' +
                '<div class="flex flex-wrap gap-2">' + tabBar + '</div>' +
                '<div>' + content + '</div>' +
            '</div>';
        },

        _renderCreateInvitation() {
            const posList = CORE.db.pointsOfSale || [];
            const posOptions = posList.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('');
            return '<div class="bg-white rounded-3xl border border-slate-200 p-6 space-y-5">' +
                '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">' +
                    '<!-- Left: Form -->' +
                    '<div class="space-y-4">' +
                        '<h3 class="text-lg font-black text-slate-800 flex items-center gap-2"><i data-lucide="user-plus" class="w-5 h-5 text-purple-600"></i> Créer une invitation</h3>' +
                        '<div class="p-3 bg-purple-50 border border-purple-200 rounded-xl text-sm text-purple-700"><i data-lucide="info" class="w-4 h-4 inline mr-1"></i> L\'employé recevra un <b>code</b> et/ou un <b>lien</b> pour rejoindre votre entreprise.</div>' +
                        '<div><label class="block text-xs font-black text-slate-600 uppercase mb-1">Type d\'invitation</label>' +
                            '<select id="invite-type" onchange="PDGModule._toggleInviteType()" class="w-full px-4 py-2.5 rounded-xl border border-slate-300 font-medium">' +
                                '<option value="code">📟 Code uniquement</option>' +
                                '<option value="link">🔗 Lien partageable</option>' +
                                '<option value="bulk">👥 Multi-usage (équipe)</option>' +
                            '</select></div>' +
                        '<div id="invite-email-row"><label class="block text-xs font-black text-slate-600 uppercase mb-1">Email (optionnel)</label>' +
                            '<input type="email" id="invite-email" placeholder="employe@exemple.com" class="w-full px-4 py-2.5 rounded-xl border border-slate-300 font-medium"></div>' +
                        '<div><label class="block text-xs font-black text-slate-600 uppercase mb-1">Rôle attribué</label>' +
                            '<select id="invite-role" class="w-full px-4 py-2.5 rounded-xl border border-slate-300 font-medium">' +
                                '<option value="VENDEUR">🛒 Vendeur</option><option value="LIVREUR">🚚 Livreur</option><option value="GESTIONNAIRE">📊 Gestionnaire</option><option value="MANAGER">👔 Manager</option>' +
                            '</select></div>' +
                        '<div><label class="block text-xs font-black text-slate-600 uppercase mb-1">Point de vente (optionnel)</label>' +
                            '<select id="invite-pos" class="w-full px-4 py-2.5 rounded-xl border border-slate-300 font-medium"><option value="">-- Tous les magasins --</option>' + posOptions + '</select></div>' +
                        '<div id="invite-bulk-options" style="display:none" class="grid grid-cols-2 gap-3">' +
                            '<div><label class="block text-xs font-black text-slate-600 uppercase mb-1">Nb max d\'utilisations</label>' +
                                '<input type="number" id="invite-max-uses" value="10" min="1" max="100" class="w-full px-4 py-2.5 rounded-xl border border-slate-300 font-medium"></div>' +
                            '<div><label class="block text-xs font-black text-slate-600 uppercase mb-1">Expire dans (jours)</label>' +
                                '<input type="number" id="invite-expires-days" value="7" min="1" max="90" class="w-full px-4 py-2.5 rounded-xl border border-slate-300 font-medium"></div>' +
                        '</div>' +
                        '<div><label class="block text-xs font-black text-slate-600 uppercase mb-1">Message personnalisé</label>' +
                            '<textarea id="invite-message" rows="2" placeholder="Bienvenue dans notre équipe !" class="w-full px-4 py-2.5 rounded-xl border border-slate-300 font-medium resize-none"></textarea></div>' +
                        '<button onclick="PDGModule.generateInviteCode()" class="w-full px-4 py-3 bg-purple-600 text-white font-black rounded-xl hover:bg-purple-700 transition text-base flex items-center justify-center gap-2"><i data-lucide="send" class="w-5 h-5"></i> Générer l\'invitation</button>' +
                    '</div>' +
                    '<!-- Right: Result -->' +
                    '<div id="invite-result-panel" class="flex items-center justify-center">' +
                        (PDGModule._lastInviteResultHTML || '<div class="text-center text-slate-400 py-12"><i data-lucide="mailbox" class="w-16 h-16 mx-auto mb-3 opacity-40"></i><p class="font-bold">Le résultat de l\'invitation apparaîtra ici</p></div>') +
                    '</div>' +
                '</div>' +
            '</div>';
        },

        _toggleInviteType() {
            const type = document.getElementById('invite-type')?.value;
            const bulkOpts = document.getElementById('invite-bulk-options');
            const emailRow = document.getElementById('invite-email-row');
            if (bulkOpts) bulkOpts.style.display = type === 'bulk' ? 'grid' : 'none';
            if (emailRow) emailRow.style.display = type === 'bulk' ? 'none' : 'block';
        },

        _renderInvitationHistory() {
            const invitations = PDGModule._invitations || [];
            if (PDGModule._invitationLoading) return '<div class="bg-white rounded-3xl border border-slate-200 p-12 text-center"><div class="animate-spin w-8 h-8 border-4 border-purple-600 border-t-transparent rounded-full mx-auto mb-3"></div><p class="text-slate-500 font-bold">Chargement...</p></div>';
            if (invitations.length === 0) return '<div class="bg-white rounded-3xl border border-slate-200 p-12 text-center"><i data-lucide="inbox" class="w-16 h-16 text-slate-300 mx-auto mb-3"></i><p class="text-slate-500 font-bold text-lg">Aucune invitation envoyée</p><p class="text-slate-400 mt-1">Créez votre première invitation dans l\'onglet "Nouvelle invitation"</p></div>';

            const statusColors = { PENDING: 'bg-amber-100 text-amber-800', ACCEPTED: 'bg-emerald-100 text-emerald-800', EXPIRED: 'bg-slate-100 text-slate-500', CANCELLED: 'bg-red-100 text-red-700' };
            const statusLabels = { PENDING: '⏳ En attente', ACCEPTED: '✅ Acceptée', EXPIRED: '⌛ Expirée', CANCELLED: '❌ Annulée' };
            const typeLabels = { CODE: '📟 Code', EMAIL: '📧 Email', LINK: '🔗 Lien', QR: '📱 QR', PHONE: '📞 Tél' };

            const rows = invitations.map(inv => {
                const st = inv.status || 'PENDING';
                const type = inv.invitationType || inv.invitation_type || 'CODE';
                const code = inv.invitationCode || inv.invitation_code || '-';
                const role = inv.role || 'VENDEUR';
                const email = inv.email || '-';
                const uses = (inv.currentUses || inv.current_uses || 0) + '/' + (inv.maxUses || inv.max_uses || 1);
                const date = inv.createdAt || inv.created_at;
                const dateStr = date ? new Date(date).toLocaleDateString('fr-FR', {day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}) : '-';
                const expiresAt = inv.expiresAt || inv.expires_at;
                const expiresStr = expiresAt ? new Date(expiresAt).toLocaleDateString('fr-FR', {day:'2-digit',month:'short'}) : '-';
                const canCancel = st === 'PENDING';
                const cancelBtn = canCancel ? '<button onclick="PDGModule.cancelInvitation(\'' + inv.id + '\')" class="text-xs text-red-500 hover:text-red-700 font-bold">Annuler</button>' : '';
                const copyBtn = st === 'PENDING' ? '<button onclick="PDGModule.copyInviteCode(\'' + code + '\')" class="text-xs text-purple-600 hover:text-purple-800 font-bold">Copier</button>' : '';
                const linkBtn = (st === 'PENDING' && inv.invitationToken) ? '<button onclick="PDGModule.copyInviteLink(\'' + (inv.invitationToken || inv.invitation_token) + '\')" class="text-xs text-sky-600 hover:text-sky-800 font-bold">📋 Lien</button>' : '';

                return '<tr class="border-b border-slate-100 hover:bg-slate-50">' +
                    '<td class="px-4 py-3"><span class="font-mono font-black text-sm select-all">' + code + '</span></td>' +
                    '<td class="px-4 py-3"><span class="px-2 py-1 rounded-lg text-xs font-bold ' + (statusColors[st] || 'bg-slate-100') + '">' + (statusLabels[st] || st) + '</span></td>' +
                    '<td class="px-4 py-3 text-sm">' + (typeLabels[type] || type) + '</td>' +
                    '<td class="px-4 py-3 text-sm font-bold">' + role + '</td>' +
                    '<td class="px-4 py-3 text-sm text-slate-500">' + email + '</td>' +
                    '<td class="px-4 py-3 text-sm font-mono">' + uses + '</td>' +
                    '<td class="px-4 py-3 text-xs text-slate-400">' + dateStr + '</td>' +
                    '<td class="px-4 py-3 text-xs text-slate-400">' + expiresStr + '</td>' +
                    '<td class="px-4 py-3"><div class="flex gap-2">' + copyBtn + linkBtn + cancelBtn + '</div></td>' +
                '</tr>';
            }).join('');

            return '<div class="bg-white rounded-3xl border border-slate-200 overflow-hidden">' +
                '<div class="p-4 border-b border-slate-100 flex items-center justify-between">' +
                    '<h3 class="font-black text-slate-800 flex items-center gap-2"><i data-lucide="list" class="w-5 h-5"></i> Historique des invitations</h3>' +
                    '<button onclick="PDGModule.loadInvitationData()" class="text-sm text-purple-600 font-bold hover:text-purple-800 flex items-center gap-1"><i data-lucide="refresh-cw" class="w-4 h-4"></i> Actualiser</button>' +
                '</div>' +
                '<div class="overflow-x-auto"><table class="w-full text-left min-w-[900px]">' +
                    '<thead class="bg-slate-50 text-xs font-black text-slate-400 uppercase"><tr>' +
                        '<th class="px-4 py-3">Code</th><th class="px-4 py-3">Statut</th><th class="px-4 py-3">Type</th><th class="px-4 py-3">Rôle</th><th class="px-4 py-3">Email</th><th class="px-4 py-3">Utilisations</th><th class="px-4 py-3">Créée le</th><th class="px-4 py-3">Expire</th><th class="px-4 py-3">Actions</th>' +
                    '</tr></thead>' +
                    '<tbody>' + rows + '</tbody>' +
                '</table></div></div>';
        },

        _renderPendingRequests() {
            const requests = PDGModule._joinRequests || [];
            const pendingMembers = PDGModule._pendingMembers || [];
            const pendingMemberUserIds = new Set(
                pendingMembers
                    .map(function(m) { return String(m.userId || m.user_id || ''); })
                    .filter(function(id) { return !!id; })
            );
            const pendingMemberEmails = new Set(
                pendingMembers
                    .map(function(m) { return String(m.email || m.userEmail || '').toLowerCase().trim(); })
                    .filter(function(email) { return !!email; })
            );
            const activeUsers = (CORE.db.users || []).filter(function(u) { return u && u.active !== false && !u.pendingApproval; });
            const activeUserIds = new Set(
                activeUsers
                    .map(function(u) { return String(u._apiId || u.id || ''); })
                    .filter(function(id) { return !!id; })
            );
            const activeUserEmails = new Set(
                activeUsers
                    .map(function(u) { return String(u.email || u.username || '').toLowerCase().trim(); })
                    .filter(function(email) { return !!email; })
            );
            const pending = requests.filter(function(r) {
                if (r.status !== 'PENDING') return false;
                const requestUserId = String(r.userId || r.user_id || '');
                if (requestUserId && pendingMemberUserIds.has(requestUserId)) return false;
                const requestEmail = String(r.userEmail || r.email || '').toLowerCase().trim();
                if (requestEmail && pendingMemberEmails.has(requestEmail)) return false;
                if (requestUserId && activeUserIds.has(requestUserId)) return false;
                if (requestEmail && activeUserEmails.has(requestEmail)) return false;
                return true;
            });
            const history = requests.filter(r => r.status !== 'PENDING');

            if (PDGModule._invitationLoading) return '<div class="bg-white rounded-3xl border border-slate-200 p-12 text-center"><div class="animate-spin w-8 h-8 border-4 border-purple-600 border-t-transparent rounded-full mx-auto mb-3"></div><p class="text-slate-500 font-bold">Chargement...</p></div>';

            // --- PENDING MEMBERSHIPS (employees who used invitation code) ---
            const posList = CORE.db.pointsOfSale || [];
            const posOptionsHtml = posList.map(function(p) { return '<option value="' + p.id + '">' + (p.name || 'POS ' + p.id) + '</option>'; }).join('');
            const memberCards = pendingMembers.length === 0
                ? ''
                : '<div class="mb-6"><h4 class="font-black text-slate-800 mb-3 flex items-center gap-2"><i data-lucide="user-plus" class="w-5 h-5 text-purple-600"></i> Employés en attente de validation <span class="text-sm font-mono text-amber-600">(' + pendingMembers.length + ')</span></h4>' +
                '<div class="space-y-3">' + pendingMembers.map(m => {
                    const name = (m.firstName || '') + ' ' + (m.lastName || '');
                    const displayName = name.trim() || m.email || m.user_id?.substring(0,8) || 'Inconnu';
                    const email = m.email || '-';
                    const role = m.role || 'VENDEUR';
                    const userId = m.user_id || m.userId;
                    const memberStoreId = m.storeId || m.store_id || '';
                    const dateStr = m.created_at ? new Date(m.created_at).toLocaleDateString('fr-FR', {day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}) : '-';
                    return '<div class="p-4 bg-purple-50 border border-purple-200 rounded-2xl space-y-3">' +
                        '<div class="flex items-start justify-between">' +
                            '<div><div class="font-black text-slate-900 text-lg">' + displayName + '</div>' +
                            '<div class="text-sm text-slate-500">📧 ' + email + '</div></div>' +
                            '<div class="text-right"><span class="px-2 py-1 rounded-lg text-xs font-bold bg-purple-200 text-purple-800">Via invitation • ' + role + '</span>' +
                            '<div class="text-xs text-slate-400 mt-1">' + dateStr + '</div></div>' +
                        '</div>' +
                        '<div class="grid grid-cols-2 gap-2">' +
                            '<select id="approve-member-role-' + userId + '" class="px-3 py-2 rounded-xl border border-slate-300 text-sm font-bold">' +
                                '<option value="VENDEUR" ' + (role==='VENDEUR'?'selected':'') + '>🛒 Vendeur</option>' +
                                '<option value="LIVREUR" ' + (role==='LIVREUR'?'selected':'') + '>🚚 Livreur</option>' +
                                '<option value="GESTIONNAIRE" ' + (role==='GESTIONNAIRE'?'selected':'') + '>📊 Gestionnaire</option>' +
                                '<option value="MANAGER" ' + (role==='MANAGER'?'selected':'') + '>👔 Manager</option>' +
                            '</select>' +
                            '<select id="approve-member-pos-' + userId + '" class="px-3 py-2 rounded-xl border border-slate-300 text-sm font-bold">' +
                                '<option value="">🏪 Choisir POS *</option>' + posOptionsHtml.replace('value="' + memberStoreId + '"', 'value="' + memberStoreId + '" selected') +
                            '</select>' +
                        '</div>' +
                        '<div class="flex gap-2">' +
                            '<button onclick="PDGModule.approveMember(\'' + userId + '\')" class="flex-1 px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition flex items-center justify-center gap-1"><i data-lucide="check" class="w-4 h-4"></i> Valider</button>' +
                            '<button onclick="PDGModule.rejectMember(\'' + userId + '\')" class="px-4 py-2 bg-red-500 text-white font-black rounded-xl hover:bg-red-600 transition flex items-center gap-1"><i data-lucide="x" class="w-4 h-4"></i> Refuser</button>' +
                        '</div>' +
                    '</div>';
                }).join('') + '</div></div>';

            // --- PENDING JOIN REQUESTS (manual requests) ---
            const pendingCards = pending.length === 0
                ? ''
                : '<div class="mb-6"><h4 class="font-black text-slate-800 mb-3 flex items-center gap-2"><i data-lucide="user-check" class="w-5 h-5 text-amber-600"></i> Demandes d\'adhésion <span class="text-sm font-mono text-amber-600">(' + pending.length + ')</span></h4>' +
                '<div class="space-y-3">' + pending.map(r => {
                    const name = r.userName || r.userEmail || r.userId?.substring(0,8) || 'Inconnu';
                    const email = r.userEmail || '-';
                    const role = r.requestedRole || r.requested_role || 'VENDEUR';
                    const msg = r.message || '';
                    const reqStoreId = r.storeId || r.store_id || '';
                    const date = r.createdAt || r.created_at;
                    const dateStr = date ? new Date(date).toLocaleDateString('fr-FR', {day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}) : '-';
                    return '<div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl space-y-3">' +
                        '<div class="flex items-start justify-between">' +
                            '<div><div class="font-black text-slate-900 text-lg">' + name + '</div>' +
                            '<div class="text-sm text-slate-500">' + email + '</div>' +
                            (msg ? '<div class="mt-1 text-sm text-slate-600 italic">"' + msg + '"</div>' : '') + '</div>' +
                            '<div class="text-right"><span class="px-2 py-1 rounded-lg text-xs font-bold bg-amber-200 text-amber-800">Rôle demandé: ' + role + '</span>' +
                            '<div class="text-xs text-slate-400 mt-1">' + dateStr + '</div></div>' +
                        '</div>' +
                        '<div class="grid grid-cols-2 gap-2">' +
                            '<select id="approve-role-' + r.id + '" class="px-3 py-2 rounded-xl border border-slate-300 text-sm font-bold">' +
                                '<option value="VENDEUR" ' + (role==='VENDEUR'?'selected':'') + '>🛒 Vendeur</option>' +
                                '<option value="LIVREUR" ' + (role==='LIVREUR'?'selected':'') + '>🚚 Livreur</option>' +
                                '<option value="GESTIONNAIRE" ' + (role==='GESTIONNAIRE'?'selected':'') + '>📊 Gestionnaire</option>' +
                                '<option value="MANAGER" ' + (role==='MANAGER'?'selected':'') + '>👔 Manager</option>' +
                            '</select>' +
                            '<select id="approve-pos-' + r.id + '" class="px-3 py-2 rounded-xl border border-slate-300 text-sm font-bold">' +
                                '<option value="">🏪 Choisir POS *</option>' + posOptionsHtml.replace('value="' + reqStoreId + '"', 'value="' + reqStoreId + '" selected') +
                            '</select>' +
                        '</div>' +
                        '<div class="flex gap-2">' +
                            '<button onclick="PDGModule.approveRequest(\'' + r.id + '\')" class="flex-1 px-4 py-2 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition flex items-center justify-center gap-1"><i data-lucide="check" class="w-4 h-4"></i> Approuver</button>' +
                            '<button onclick="PDGModule.rejectRequest(\'' + r.id + '\')" class="px-4 py-2 bg-red-500 text-white font-black rounded-xl hover:bg-red-600 transition flex items-center gap-1"><i data-lucide="x" class="w-4 h-4"></i> Rejeter</button>' +
                        '</div>' +
                    '</div>';
                }).join('') + '</div></div>';

            const emptyState = (pendingMembers.length === 0 && pending.length === 0)
                ? '<div class="p-8 text-center text-slate-400"><i data-lucide="check-circle" class="w-12 h-12 mx-auto mb-2 opacity-40"></i><p class="font-bold">Aucune demande en attente</p><p class="text-sm mt-1">Les employés qui utilisent un code d\'invitation apparaîtront ici</p></div>'
                : '';

            return '<div class="space-y-4">' +
                '<div class="bg-white rounded-3xl border border-slate-200 p-6">' +
                    '<div class="flex items-center justify-between mb-4">' +
                        '<h3 class="font-black text-slate-800 flex items-center gap-2"><i data-lucide="user-check" class="w-5 h-5 text-amber-600"></i> Validation des employés <span class="text-sm font-mono text-amber-600">(' + (pendingMembers.length + pending.length) + ')</span></h3>' +
                        '<button onclick="PDGModule.loadInvitationData()" class="text-sm text-purple-600 font-bold hover:text-purple-800 flex items-center gap-1"><i data-lucide="refresh-cw" class="w-4 h-4"></i> Actualiser</button>' +
                    '</div>' +
                    emptyState +
                    memberCards +
                    pendingCards +
                '</div>' +
            '</div>';
        },

        copyInviteCode(code) {
            navigator.clipboard?.writeText(code);
            UI.toast('Code copié : ' + code, 'success');
        },

        copyInviteLink(token) {
            const baseUrl = window.location.origin + window.location.pathname;
            const link = baseUrl + '?invite=' + token;
            navigator.clipboard?.writeText(link);
            UI.toast('Lien d\'invitation copié !', 'success');
        },

        async cancelInvitation(id) {
            if (!confirm('Annuler cette invitation ?')) return;
            try {
                await API.request('/invitations/' + id, { method: 'DELETE' });
                UI.toast('Invitation annulée', 'success');
                // Optimistic update: remove invitation from local list
                if (PDGModule._invitations) {
                    PDGModule._invitations = PDGModule._invitations.filter(function(inv) {
                        return String(inv.id) !== String(id);
                    });
                }
                // Immediate re-render with updated data
                App.mount(PDGModule.renderInvitationManagement());
                setTimeout(function() { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 80);
                // Also refetch from API after a delay for consistency
                setTimeout(function() { PDGModule.loadInvitationData(); }, 1500);
            } catch(e) {
                UI.toast('Erreur: ' + (e.message || e), 'error');
            }
        },

        async approveRequest(id) {
            const roleEl = document.getElementById('approve-role-' + id);
            const role = roleEl ? roleEl.value : 'VENDEUR';
            const posEl = document.getElementById('approve-pos-' + id);
            const storeId = posEl ? posEl.value : '';
            if (!storeId) {
                UI.toast('⚠️ Veuillez sélectionner un POS (Point de Vente) avant d\'approuver', 'warning');
                return;
            }
            try {
                await API.request('/invitations/requests/' + id + '/approve', { method: 'POST', body: { role, storeId: storeId } });
                UI.toast('Demande approuvée !', 'success');
                // Find the request to get the userId and update local user
                var req = (PDGModule._joinRequests || []).find(function(r) { return String(r.id) === String(id); });
                if (req) {
                    var reqUserId = req.userId || req.user_id;
                    if (reqUserId) {
                        var localUser = (CORE.db.users || []).find(function(u) { return String(u.id) === String(reqUserId) || String(u._apiId) === String(reqUserId); });
                        if (localUser) {
                            localUser.pos = String(storeId);
                            localUser.posId = String(storeId);
                            localUser.storeId = storeId;
                            localUser.role = role.toLowerCase();
                            localUser.active = true;
                            localUser.pendingApproval = false;
                            CORE.markDirty('users');
                            CORE.save();
                        }
                    }
                }
                // Optimistic update: mark request as APPROVED locally
                if (PDGModule._joinRequests) {
                    PDGModule._joinRequests = PDGModule._joinRequests.map(function(r) {
                        return String(r.id) === String(id) ? Object.assign({}, r, { status: 'APPROVED' }) : r;
                    });
                }
                // Immediate re-render with updated data
                App.mount(PDGModule.renderInvitationManagement());
                setTimeout(function() { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 80);
                // Also refetch from API after a delay for consistency
                setTimeout(function() { PDGModule.loadInvitationData(); }, 1500);
                // Push users to cloud
                if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated()) {
                    API.request('/sync/users', { method: 'PUT', body: { data: CORE.db.users || [] } }).catch(function(e) { console.warn('[PDG] Cloud sync users after approve failed:', e.message); });
                }
            } catch(e) {
                UI.toast('Erreur: ' + (e.message || e), 'error');
            }
        },

        async rejectRequest(id) {
            const reason = prompt('Raison du refus (optionnel) :');
            try {
                await API.request('/invitations/requests/' + id + '/reject', { method: 'POST', body: { reason: reason || '' } });
                UI.toast('Demande rejetée', 'info');
                // Optimistic update: mark request as REJECTED locally
                if (PDGModule._joinRequests) {
                    PDGModule._joinRequests = PDGModule._joinRequests.map(function(r) {
                        return String(r.id) === String(id) ? Object.assign({}, r, { status: 'REJECTED' }) : r;
                    });
                }
                // Immediate re-render with updated data
                App.mount(PDGModule.renderInvitationManagement());
                setTimeout(function() { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 80);
                // Also refetch from API after a delay for consistency
                setTimeout(function() { PDGModule.loadInvitationData(); }, 1500);
            } catch(e) {
                UI.toast('Erreur: ' + (e.message || e), 'error');
            }
        },

        async approveMember(userId) {
            const roleEl = document.getElementById('approve-member-role-' + userId);
            const role = roleEl ? roleEl.value : 'VENDEUR';
            const posEl = document.getElementById('approve-member-pos-' + userId);
            const storeId = posEl ? posEl.value : '';
            if (!storeId) {
                UI.toast('⚠️ Veuillez sélectionner un POS (Point de Vente) avant de valider', 'warning');
                return;
            }
            try {
                await API.request('/user-tenants/members/' + userId + '/approve', { method: 'PATCH', body: { role, storeId: storeId } });
                UI.toast('✅ Employé validé avec le rôle ' + role + ' !', 'success');
                // Update local user's POS
                var localUser = (CORE.db.users || []).find(function(u) { return String(u.id) === String(userId) || String(u._apiId) === String(userId); });
                if (localUser) {
                    localUser.pos = String(storeId);
                    localUser.posId = String(storeId);
                    localUser.storeId = storeId;
                    localUser.role = role.toLowerCase();
                    localUser.active = true;
                    localUser.pendingApproval = false;
                    CORE.markDirty('users');
                    CORE.save();
                }

                // Cleanup duplicated pending join requests for this same user/email (if any)
                try {
                    var approvedEmail = String((localUser && localUser.email) || '').toLowerCase().trim();
                    var pendingReqs = await API.request('/invitations/requests?status=PENDING', { method: 'GET' });
                    var pendingList = Array.isArray(pendingReqs) ? pendingReqs : (pendingReqs?.data || pendingReqs?.requests || []);
                    var sameUserPending = pendingList.filter(function(r) {
                        var rid = String(r.userId || r.user_id || '');
                        var remail = String(r.userEmail || r.email || '').toLowerCase().trim();
                        if (rid && rid === String(userId)) return true;
                        if (approvedEmail && remail && remail === approvedEmail) return true;
                        return false;
                    });
                    for (var sr = 0; sr < sameUserPending.length; sr++) {
                        var reqId = sameUserPending[sr].id;
                        if (!reqId) continue;
                        try {
                            await API.request('/invitations/requests/' + reqId + '/approve', { method: 'POST', body: { role: role, storeId: storeId } });
                        } catch(_e) { console.warn('[INVITE] Auto-approve request failed:', _e.message || _e); }
                    }
                } catch(_cleanupErr) { console.warn('[INVITE] Cleanup auto-approve failed:', _cleanupErr.message || _cleanupErr); }

                // Optimistic update: remove member from pending list
                if (PDGModule._pendingMembers) {
                    PDGModule._pendingMembers = PDGModule._pendingMembers.filter(function(m) {
                        return String(m.user_id || m.userId) !== String(userId);
                    });
                }
                // Immediate re-render with updated data
                App.mount(PDGModule.renderInvitationManagement());
                setTimeout(function() { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 80);
                // Also refetch from API after a delay for consistency
                setTimeout(function() { PDGModule.loadInvitationData(); }, 1500);
                // Push users to cloud
                if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated()) {
                    API.request('/sync/users', { method: 'PUT', body: { data: CORE.db.users || [] } }).catch(function(e) { console.warn('[PDG] Cloud sync users after approve failed:', e.message); });
                }
            } catch(e) {
                UI.toast('Erreur: ' + (e.message || e), 'error');
            }
        },

        async rejectMember(userId) {
            if (!confirm('Refuser cet employé ? Il ne pourra pas accéder à l\'application.')) return;
            try {
                await API.request('/user-tenants/members/' + userId + '/reject', { method: 'PATCH' });
                UI.toast('Employé refusé', 'info');
                // Optimistic update: remove member from pending list
                if (PDGModule._pendingMembers) {
                    PDGModule._pendingMembers = PDGModule._pendingMembers.filter(function(m) {
                        return String(m.user_id || m.userId) !== String(userId);
                    });
                }
                // Immediate re-render with updated data
                App.mount(PDGModule.renderInvitationManagement());
                setTimeout(function() { if (typeof lucide !== 'undefined') lucide.createIcons(); }, 80);
                // Also refetch from API after a delay for consistency
                setTimeout(function() { PDGModule.loadInvitationData(); }, 1500);
            } catch(e) {
                UI.toast('Erreur: ' + (e.message || e), 'error');
            }
        },

        async generateInviteCode() {
            const type = document.getElementById('invite-type')?.value || 'code';
            const email = document.getElementById('invite-email')?.value?.trim() || '';
            const role = document.getElementById('invite-role')?.value || 'VENDEUR';
            const storeId = document.getElementById('invite-pos')?.value || '';
            const message = document.getElementById('invite-message')?.value?.trim() || '';

            const panel = document.getElementById('invite-result-panel');
            if (panel) panel.innerHTML = '<div class="text-center py-8"><div class="animate-spin w-8 h-8 border-4 border-purple-600 border-t-transparent rounded-full mx-auto mb-3"></div><p class="text-slate-500 font-bold">Génération en cours...</p></div>';

            try {
                let result;
                if (type === 'bulk') {
                    const maxUses = parseInt(document.getElementById('invite-max-uses')?.value) || 10;
                    const expiresInDays = parseInt(document.getElementById('invite-expires-days')?.value) || 7;
                    result = await API.createBulkInvitation(role, maxUses, expiresInDays);
                } else {
                    const data = { role };
                    if (type === 'link') data.invitationType = 'LINK';
                    else data.invitationType = 'CODE';
                    if (email) data.email = email;
                    if (storeId) data.storeId = storeId;
                    if (message) data.message = message;
                    result = await API.createInvitation(data);
                }

                const invitation = result?.invitation || result?.data || result;
                const code = invitation?.invitationCode || invitation?.invitation_code || invitation?.code || '';
                const token = invitation?.invitationToken || invitation?.invitation_token || '';

                // Also save locally
                if (!CORE.db.invitations) CORE.db.invitations = [];
                CORE.db.invitations.push({
                    id: invitation?.id || CORE.uid(),
                    code: code,
                    email: email,
                    role: role,
                    storeId: storeId,
                    message: message,
                    createdBy: CORE.state.currentUser?.id || null,
                    createdAt: new Date().toISOString(),
                    used: false
                });
                CORE.save();

                const baseUrl = window.location.origin + window.location.pathname;
                const inviteLink = token ? (baseUrl + '?invite=' + token) : '';

                let resultHTML = '<div class="space-y-4">' +
                    '<div class="p-4 bg-emerald-50 border border-emerald-200 rounded-2xl text-center">' +
                        '<div class="text-emerald-700 font-black text-sm mb-1">✅ Invitation créée avec succès !</div>' +
                    '</div>';

                if (code) {
                    resultHTML += '<div class="p-4 bg-white border-2 border-dashed border-purple-300 rounded-2xl text-center">' +
                        '<div class="text-xs font-black text-slate-500 uppercase mb-2">Code d\'invitation</div>' +
                        '<div class="text-3xl font-black text-purple-700 font-mono tracking-widest select-all cursor-pointer" onclick="PDGModule.copyInviteCode(\'' + code + '\')">' + code + '</div>' +
                        '<div class="text-xs text-slate-400 mt-2">Cliquez pour copier</div>' +
                    '</div>';
                }

                if (inviteLink) {
                    resultHTML += '<div class="p-4 bg-sky-50 border border-sky-200 rounded-2xl">' +
                        '<div class="text-xs font-black text-slate-500 uppercase mb-2">🔗 Lien d\'invitation</div>' +
                        '<div class="flex items-center gap-2">' +
                            '<input type="text" readonly value="' + inviteLink + '" class="flex-1 px-3 py-2 rounded-lg border border-sky-200 text-xs font-mono bg-white text-sky-700 select-all">' +
                            '<button onclick="PDGModule.copyInviteLink(\'' + token + '\')" class="px-4 py-2 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700 transition text-sm flex-shrink-0">📋 Copier</button>' +
                        '</div>' +
                        '<div class="text-xs text-sky-600 mt-2">Partagez ce lien par SMS, WhatsApp, ou email</div>' +
                    '</div>';
                }

                if (type === 'bulk') {
                    const maxUses = invitation?.maxUses || invitation?.max_uses || 10;
                    resultHTML += '<div class="p-3 bg-amber-50 border border-amber-200 rounded-xl text-sm text-amber-700">' +
                        '<b>👥 Multi-usage:</b> Ce code peut être utilisé par <b>' + maxUses + ' personnes</b></div>';
                }

                resultHTML += '<div class="flex gap-2">' +
                    '<button onclick="PDGModule.switchInvitationTab(\'create\')" class="flex-1 px-4 py-2 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700 transition">+ Nouvelle invitation</button>' +
                    '<button onclick="PDGModule.switchInvitationTab(\'history\')" class="flex-1 px-4 py-2 bg-slate-200 text-slate-700 font-bold rounded-xl hover:bg-slate-300 transition">Voir l\'historique</button>' +
                '</div></div>';

                if (panel) panel.innerHTML = resultHTML;

                // Save result so re-renders don't wipe it
                PDGModule._lastInviteResultHTML = resultHTML;

                UI.toast('Invitation créée : ' + code, 'success');

                // Refresh invitation data in background WITHOUT re-rendering the create tab
                try {
                    const [invitations, joinRequests, pendingMembers] = await Promise.all([
                        API.listInvitations().catch(() => []),
                        API.listJoinRequests().catch(() => []),
                        API.request('/user-tenants/members/pending', { method: 'GET' }).catch(() => [])
                    ]);
                    PDGModule._invitations = Array.isArray(invitations) ? invitations : (invitations?.data || invitations?.invitations || []);
                    PDGModule._joinRequests = Array.isArray(joinRequests) ? joinRequests : (joinRequests?.data || joinRequests?.requests || []);
                    PDGModule._pendingMembers = Array.isArray(pendingMembers) ? pendingMembers : [];
                } catch(e) { console.warn('[INVITE] Failed to refresh invitation data:', e.message || e); }
            } catch(e) {
                console.error('[INVITE] Error:', e);
                let errorMsg = e.message || 'Erreur inconnue';
                try { const parsed = JSON.parse(errorMsg); errorMsg = parsed.message || errorMsg; } catch(pe) {}
                if (e._sessionExpired) {
                    errorMsg = 'Votre session a expiré. Veuillez vous reconnecter.';
                }
                if (panel) panel.innerHTML = '<div class="space-y-3">' +
                    '<div class="p-4 bg-red-50 border border-red-200 rounded-2xl text-center">' +
                        '<div class="text-red-700 font-black text-sm mb-1">❌ Erreur lors de la création</div>' +
                        '<div class="text-red-600 text-sm">' + errorMsg + '</div>' +
                    '</div>' +
                    '<button onclick="PDGModule.generateInviteCode()" class="w-full px-4 py-2 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700 transition">🔄 Réessayer</button>' +
                '</div>';
                UI.toast('Erreur: ' + errorMsg, 'error');
            }
        },

        showChangePersonalPasswordModal() {
            UI.modal('🔒 Changer votre mot de passe', `
                <div class="space-y-4">
                    <div class="p-4 bg-amber-50 border border-amber-200 rounded-2xl flex items-center gap-3">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-amber-600 flex-shrink-0"></i>
                        <div class="text-sm text-amber-800 font-medium">Utilisez un mot de passe fort (min 6 caractères)</div>
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Ancien mot de passe</label>
                        <input type="password" id="old_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-cyan-500 outline-none" placeholder="Entrez votre ancien mot de passe">
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Nouveau mot de passe</label>
                        <input type="password" id="new_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-cyan-500 outline-none" placeholder="Entrez un nouveau mot de passe">
                    </div>

                    <div>
                        <label class="block text-xs font-black text-slate-700 uppercase mb-2">Confirmation du nouveau mot de passe</label>
                        <input type="password" id="confirm_pwd" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-cyan-500 outline-none" placeholder="Confirmez le nouveau mot de passe">
                    </div>
                </div>
            `, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Changer le mot de passe', onclick: 'PDGModule.savePersonalPasswordChange()', class: 'px-5 py-2.5 bg-cyan-600 text-white font-black rounded-xl hover:bg-cyan-700' }
            ]);
        },

        async savePersonalPasswordChange() {
            const oldPwd = UI.val('old_pwd');
            const newPwd = UI.val('new_pwd');
            const confirmPwd = UI.val('confirm_pwd');
            const user = CORE.state.currentUser;

            if (!oldPwd || !newPwd || !confirmPwd) {
                UI.toast('Tous les champs sont obligatoires', 'error');
                return;
            }

            if (newPwd.length < 6) {
                UI.toast('Le nouveau mot de passe doit contenir au moins 6 caractères', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                UI.toast('Les mots de passe ne correspondent pas', 'error');
                return;
            }

            const oldPwdHash = await Utils.md5(oldPwd);
            if (user.passwordHash) {
                if (oldPwdHash !== user.passwordHash) {
                    UI.toast('Ancien mot de passe incorrect', 'error');
                    return;
                }
            } else if (user.password) {
                if (oldPwd !== user.password) {
                    UI.toast('Ancien mot de passe incorrect', 'error');
                    return;
                }
            } else {
                UI.toast('Impossible de vérifier le mot de passe', 'error');
                return;
            }

            const newPwdHash = await Utils.md5(newPwd);
            user.passwordHash = newPwdHash;

            const userIndex = CORE.getVisibleUsers().findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
                CORE.db.users[userIndex] = user;
                CORE.save();
                UI.closeModal();
                UI.toast('✓ Mot de passe changé avec succès', 'success');
                App.rerender();
            } else {
                UI.toast('Erreur lors de la mise à jour de l\'utilisateur', 'error');
            }
        }
    };

    // =========================================================
    // API SERVICE LAYER — RAYA Backend (NestJS + Railway)
    // =========================================================
    const _API_DEFAULT_URL = 'https://raya-backend-production.up.railway.app/api';
    const API = {

        // Backend NestJS Railway - RAYA Production

        baseUrl: localStorage.getItem('raya_api_url') || _API_DEFAULT_URL,

        setBaseUrl(url) {

            this.baseUrl = url;

            localStorage.setItem('raya_api_url', url);

        },

        getToken() {
            return localStorage.getItem('raya_token');
        },

        setToken(token) {
            if (token) localStorage.setItem('raya_token', token);
            else try { localStorage.removeItem('raya_token'); } catch(e) {}
        },

        setRefreshToken(rt) {
            if (rt) localStorage.setItem('raya_refresh_token', rt);
        },

        getRefreshToken() {
            return localStorage.getItem('raya_refresh_token') || localStorage.getItem('raya_refresh');
        },

        // Store credentials (encrypted) for auto-re-login when all tokens expire
        storeCredentials(email, password) {
            try {
                var payload = JSON.stringify({ e: email, p: password, t: Date.now() });
                var encoded = btoa(unescape(encodeURIComponent(payload)));
                localStorage.setItem('raya_creds_v2', encoded);
            } catch(e) { /* ignore */ }
        },
        getStoredCredentials() {
            try {
                var encoded = localStorage.getItem('raya_creds_v2');
                if (!encoded) return null;
                var payload = JSON.parse(decodeURIComponent(escape(atob(encoded))));
                return { email: payload.e, password: payload.p };
            } catch(e) { return null; }
        },

        // Token age tracking for proactive refresh
        _tokenSetAt: 0,

        async _refreshAccessToken() {
            try {
                var base = this.baseUrl || _API_DEFAULT_URL;
                var normalizedBase = base.endsWith('/api') ? base : base.replace(/\/+$/, '') + '/api';
                var rt = this.getRefreshToken();
                // Send refresh token BOTH in body (cross-origin fallback) AND via cookie
                var res = await fetch(normalizedBase + '/auth/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ refreshToken: rt || undefined })
                });
                if (!res.ok) {
                    console.warn('[API] Refresh failed with status', res.status);
                    return false;
                }
                var data = await res.json();
                if (data.accessToken) {
                    this.setToken(data.accessToken);
                    if (data.refreshToken) this.setRefreshToken(data.refreshToken);
                    this._tokenSetAt = Date.now();
                    console.log('[API] Token refreshed ✓');
                    return true;
                }
                return false;
            } catch(e) { console.warn('[API] Token refresh failed:', e.message); return false; }
        },

        // Auto-re-login with stored credentials as last resort
        async _reLoginWithStoredCreds() {
            var creds = this.getStoredCredentials();
            if (!creds || !creds.email || !creds.password) {
                console.log('[API] No stored credentials for auto-re-login');
                return false;
            }
            try {
                console.log('[API] Attempting auto-re-login for', creds.email);
                var base = this.baseUrl || _API_DEFAULT_URL;
                var normalizedBase = base.endsWith('/api') ? base : base.replace(/\/+$/, '') + '/api';
                var res = await fetch(normalizedBase + '/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email: creds.email, password: creds.password })
                });
                if (!res.ok) return false;
                var data = await res.json();
                if (data.accessToken) {
                    this.setToken(data.accessToken);
                    if (data.refreshToken) this.setRefreshToken(data.refreshToken);
                    this._tokenSetAt = Date.now();
                    console.log('[API] Auto-re-login successful ✓');
                    return true;
                }
                return false;
            } catch(e) {
                console.warn('[API] Auto-re-login failed:', e.message);
                return false;
            }
        },

        // Proactive token refresh — call before expiry (every 45 min for 1h tokens)
        _proactiveRefreshInterval: null,
        startProactiveRefresh() {
            if (this._proactiveRefreshInterval) clearInterval(this._proactiveRefreshInterval);
            this._tokenSetAt = Date.now();
            this._proactiveRefreshInterval = setInterval(async () => {
                if (!this.isAuthenticated() || !navigator.onLine || document.visibilityState !== 'visible') return;
                var tokenAge = Date.now() - (this._tokenSetAt || 0);
                // Refresh after 45 minutes (before 1h expiry)
                if (tokenAge > 45 * 60 * 1000) {
                    console.log('[API] Proactive token refresh (age: ' + Math.round(tokenAge/60000) + 'min)...');
                    var refreshed = await this._refreshAccessToken();
                    if (!refreshed) {
                        refreshed = await this._reLoginWithStoredCreds();
                    }
                    if (!refreshed) {
                        console.warn('[API] Proactive refresh failed — auth may expire soon');
                        this._notifyAuthExpiring();
                    }
                }
            }, 10 * 60 * 1000); // PERF: Check every 10 min (was 5 min) — only when tab visible
        },

        _authWarningShown: false,
        _notifyAuthExpiring() {
            if (this._authWarningShown) return;
            this._authWarningShown = true;
            if (typeof UI !== 'undefined' && UI.toast) {
                UI.toast('⚠ Session expirée à Veuillez vous reconnecter', 'error', 10000);
            }
            // Reset flag after 5 minutes so it can warn again
            setTimeout(() => { this._authWarningShown = false; }, 300000);
        },

        // KEEPALIVE: Ping backend every 10 min to prevent Railway cold-start
        // PERF: Increased from 4min to 10min. Railway Pro tier doesn't sleep. Free tier sleeps after 15min.
        _keepaliveInterval: null,
        startKeepalive() {
            if (this._keepaliveInterval) return; // already running
            var baseUrl = (this.baseUrl || _API_DEFAULT_URL).replace(/\/api\/?$/, '');
            this._keepaliveInterval = setInterval(function() {
                if (!navigator.onLine || document.visibilityState !== 'visible') return;
                fetch(baseUrl + '/api/health', { method: 'GET', mode: 'cors' })
                    .then(function(r) { console.log('[KEEPALIVE] ping ' + r.status); })
                    .catch(function() { /* silent */ });
            }, 15 * 60 * 1000); // PERF: every 15 minutes (was 10 min) — Railway Pro doesn't sleep
            // Also do an immediate ping on start
            fetch(baseUrl + '/api/health', { method: 'GET', mode: 'cors' }).catch(function(){});
            console.log('[KEEPALIVE] Started — pinging every 10min');
        },
        stopKeepalive() {
            if (this._keepaliveInterval) { clearInterval(this._keepaliveInterval); this._keepaliveInterval = null; }
        },

        _sleep(ms) {
            return new Promise(function(resolve) { setTimeout(resolve, ms); });
        },

        async request(path, options = {}) {
            const base = this.baseUrl || _API_DEFAULT_URL;
            const normalizedBase = base.endsWith('/api') ? base : base.replace(/\/+$/, '') + '/api';
            const url = `${normalizedBase}${path}`;
            const headers = Object.assign({ 'Content-Type': 'application/json' }, options.headers || {});
            const token = this.getToken();
            if (token) headers.Authorization = `Bearer ${token}`;
            const method = options.method || 'GET';
            const attempt = options._attempt || 0;
            const maxRetries = (typeof options.retries === 'number')
                ? options.retries
                : (method === 'GET' ? 2 : ((path.includes('/auth/login') || path.includes('/auth/refresh')) ? 1 : 0));
            const isRetriableStatus = function(status) {
                return status === 429 || status === 502 || status === 503 || status === 504;
            };
            const nextBackoffMs = function(n) {
                var baseMs = 500 * Math.pow(2, n);
                var jitter = Math.floor(Math.random() * 200);
                return Math.min(5000, baseMs + jitter);
            };

            // PERF: AbortController with timeout — don't hang forever on slow/dead backends
            var timeoutMs = options.timeout || (options.method === 'GET' ? 15000 : 45000);
            var controller = new AbortController();
            var timeoutId = setTimeout(function() { controller.abort(); }, timeoutMs);
            var _reqT0 = performance.now();

            var res;
            try {
                res = await fetch(url, {
                    method,
                    headers,
                    credentials: 'include',
                    body: options.body ? JSON.stringify(options.body) : undefined,
                    signal: controller.signal
                });
            } catch(fetchErr) {
                clearTimeout(timeoutId);
                var elapsed = (performance.now() - _reqT0).toFixed(0);
                if (fetchErr.name === 'AbortError') {
                    console.warn('[API] ⏱ TIMEOUT on ' + path + ' after ' + elapsed + 'ms');
                    if (attempt < maxRetries) {
                        var timeoutBackoff = nextBackoffMs(attempt);
                        console.warn('[API] retry ' + (attempt + 1) + '/' + maxRetries + ' for ' + path + ' in ' + timeoutBackoff + 'ms (timeout)');
                        await this._sleep(timeoutBackoff);
                        return this.request(path, Object.assign({}, options, { _attempt: attempt + 1 }));
                    }
                    var tErr = new Error('Timeout: le serveur ne répond pas (' + (timeoutMs/1000) + 's)');
                    tErr.status = 0;
                    tErr._timeout = true;
                    throw tErr;
                }
                console.warn('[API] Network error on ' + path + ' after ' + elapsed + 'ms:', fetchErr.message);
                if (attempt < maxRetries) {
                    var networkBackoff = nextBackoffMs(attempt);
                    console.warn('[API] retry ' + (attempt + 1) + '/' + maxRetries + ' for ' + path + ' in ' + networkBackoff + 'ms (network)');
                    await this._sleep(networkBackoff);
                    return this.request(path, Object.assign({}, options, { _attempt: attempt + 1 }));
                }
                throw fetchErr;
            }
            clearTimeout(timeoutId);
            console.log('[API-PERF] ' + method + ' ' + path + ': ' + (performance.now() - _reqT0).toFixed(0) + 'ms → ' + res.status);

            // === AUTO-REFRESH ON 401 ===
            if (res.status === 401 && !options._retried && !path.includes('/auth/')) {
                console.log('[API] 401 on ' + path + ', attempting token refresh...');
                var refreshed = await this._refreshAccessToken();
                if (!refreshed) {
                    console.log('[API] Refresh failed, trying auto-re-login...');
                    refreshed = await this._reLoginWithStoredCreds();
                }
                if (refreshed) {
                    // Retry original request with new token
                    options._retried = true;
                    return this.request(path, options);
                }
                // Both refresh and re-login failed — notify user clearly
                console.warn('[API] Authentication expired, cannot recover');
                this.clearTokens();
                if (typeof UI !== 'undefined' && UI.toast) {
                    UI.toast('⚠ Votre session a expiré. Veuillez vous reconnecter.', 'error', 15000);
                }
                // Throw immediately so callers can handle the error gracefully
                var authErr = new Error('Session expirée. Veuillez vous reconnecter.');
                authErr.status = 401;
                authErr._sessionExpired = true;
                throw authErr;
            }

            if (!res.ok) {
                if (isRetriableStatus(res.status) && attempt < maxRetries) {
                    var statusBackoff = nextBackoffMs(attempt);
                    console.warn('[API] retry ' + (attempt + 1) + '/' + maxRetries + ' for ' + path + ' in ' + statusBackoff + 'ms (status ' + res.status + ')');
                    await this._sleep(statusBackoff);
                    return this.request(path, Object.assign({}, options, { _attempt: attempt + 1 }));
                }
                const errText = await res.text();
                // P2: Preserve HTTP status on error for conflict handling
                var err = new Error(errText || `API error ${res.status}`);
                err.status = res.status;
                try { err.data = JSON.parse(errText); } catch(e) {}
                throw err;
            }
            const contentType = res.headers.get('content-type') || '';
            return contentType.includes('application/json') ? res.json() : res.text();
        },

        async login(email, password) {
            var result = await this.request('/auth/login', { method: 'POST', body: { email, password } });
            if (result && result.accessToken) {
                this.setToken(result.accessToken);
                if (result.refreshToken) this.setRefreshToken(result.refreshToken);
                this._tokenSetAt = Date.now();
                // Store credentials for auto-re-login fallback
                this.storeCredentials(email, password);
                // Start proactive token refresh timer + keepalive
                this.startProactiveRefresh();
                this.startKeepalive();
            }
            return result;
        },

        getMe() {

            return this.request('/users/me', { method: 'GET' });

        },

        async register(data) {
            // data: { email, password, firstName, lastName, tenantId, role }
            var result = await this.request('/auth/register', { method: 'POST', body: data });
            if (result && result.accessToken) {
                this.setToken(result.accessToken);
                if (result.refreshToken) this.setRefreshToken(result.refreshToken);
                this._tokenSetAt = Date.now();
                if (data.email && data.password) this.storeCredentials(data.email, data.password);
                this.startProactiveRefresh();
            }
            return result;
        },

        // Bootstrap: cr�er le premier tenant + admin avec code d'activation

        async bootstrap(data) {
            // data: { activationCode, tenantName, email, password, firstName, lastName, currency, timezone }
            var result = await this.request('/auth/bootstrap', { method: 'POST', body: data });
            if (result && result.accessToken) {
                this.setToken(result.accessToken);
                if (result.refreshToken) this.setRefreshToken(result.refreshToken);
                this._tokenSetAt = Date.now();
                if (data.email && data.password) this.storeCredentials(data.email, data.password);
                this.startProactiveRefresh();
            }
            return result;
        },

        // Valider un code d'invitation (public)

        validateInvitation(code) {

            return this.request(`/invitations/validate/${encodeURIComponent(code)}`, { method: 'GET' });

        },

        // Créer une invitation (nécessite auth)
        createInvitation(data) {
            // data: { role, email?, phone?, storeId?, message?, expiresAt? }
            return this.request('/invitations', { method: 'POST', body: data });
        },

        // Créer un code d'invitation multi-usage (QR, lien)
        createBulkInvitation(role, maxUses, expiresInDays) {
            return this.request('/invitations/bulk', { method: 'POST', body: { role, maxUses: maxUses || 10, expiresInDays: expiresInDays || 7 } });
        },

        // Lister les invitations du tenant
        listInvitations(status) {
            const q = status ? `?status=${status}` : '';
            return this.request('/invitations' + q, { method: 'GET' });
        },

        createTenant(name, ownerName, ownerEmail) {

            // Le backend attend email ET ownerEmail

            return this.request('/tenants', { method: 'POST', body: { name, ownerName, email: ownerEmail, ownerEmail } });

        },

        joinByCode(code) {

            return this.request('/invitations/join', { method: 'POST', body: { code } });

        },

        sendOtp(contact) {

            return this.request('/auth/otp/send', { method: 'POST', body: { contact } });

        },

        verifyOtp(contact, code) {

            return this.request('/auth/otp/verify', { method: 'POST', body: { contact, code } });

        },

        listJoinRequests() {

            return this.request('/invitations/requests', { method: 'GET' });

        },

        approveJoinRequest(id, data = {}) {

            return this.request(`/invitations/requests/${id}/approve`, { method: 'POST', body: data });

        },

        rejectJoinRequest(id, data = {}) {

            return this.request(`/invitations/requests/${id}/reject`, { method: 'POST', body: data });

        },

        cancelInvitation(id) {

            return this.request(`/invitations/${id}`, { method: 'DELETE' });

        },



        // ==================== CATEGORIES ====================

        getCategories(query = {}) {

            const params = new URLSearchParams(query).toString();

            return this.request(`/categories${params ? '?' + params : ''}`, { method: 'GET' });

        },

        createCategory(data) {

            return this.request('/categories', { method: 'POST', body: data });

        },

        updateCategory(id, data) {

            return this.request(`/categories/${id}`, { method: 'PATCH', body: data });

        },

        deleteCategory(id) {

            return this.request(`/categories/${id}`, { method: 'DELETE' });

        },



        // ==================== PRODUCTS ====================

        getProducts(query = {}) {

            const params = new URLSearchParams(query).toString();

            return this.request(`/products${params ? '?' + params : ''}`, { method: 'GET' });

        },

        getProduct(id) {

            return this.request(`/products/${id}`, { method: 'GET' });

        },

        getProductBySku(sku) {

            return this.request(`/products/sku/${sku}`, { method: 'GET' });

        },

        getProductByBarcode(barcode) {

            return this.request(`/products/barcode/${barcode}`, { method: 'GET' });

        },

        getProductStats() {

            return this.request('/products/stats', { method: 'GET' });

        },

        getLowStockProducts() {

            return this.request('/products/low-stock', { method: 'GET' });

        },

        createProduct(data) {

            return this.request('/products', { method: 'POST', body: data });

        },

        updateProduct(id, data) {

            return this.request(`/products/${id}`, { method: 'PATCH', body: data });

        },

        updateProductStock(id, quantity) {

            return this.request(`/products/${id}/stock`, { method: 'PATCH', body: { quantity } });

        },

        adjustProductStock(id, adjustment) {

            return this.request(`/products/${id}/stock/adjust`, { method: 'PATCH', body: { adjustment } });

        },

        deleteProduct(id) {

            return this.request(`/products/${id}`, { method: 'DELETE' });

        },



        // ==================== ORDERS ====================

        getOrders(query = {}) {

            const params = new URLSearchParams(query).toString();

            return this.request(`/orders${params ? '?' + params : ''}`, { method: 'GET' });

        },

        getOrder(id) {

            return this.request(`/orders/${id}`, { method: 'GET' });

        },

        getOrderByNumber(orderNumber) {

            return this.request(`/orders/number/${orderNumber}`, { method: 'GET' });

        },

        getOrderStats(dateFrom, dateTo) {

            const params = new URLSearchParams();

            if (dateFrom) params.set('dateFrom', dateFrom);

            if (dateTo) params.set('dateTo', dateTo);

            const qs = params.toString();

            return this.request(`/orders/stats${qs ? '?' + qs : ''}`, { method: 'GET' });

        },

        createOrder(data) {

            return this.request('/orders', { method: 'POST', body: data });

        },

        updateOrder(id, data) {

            return this.request(`/orders/${id}`, { method: 'PATCH', body: data });

        },

        updateOrderStatus(id, status) {

            return this.request(`/orders/${id}/status`, { method: 'PATCH', body: { status } });

        },

        addOrderPayment(id, paymentData) {

            return this.request(`/orders/${id}/payment`, { method: 'POST', body: paymentData });

        },

        cancelOrder(id) {

            return this.request(`/orders/${id}/cancel`, { method: 'POST' });

        },



        // ==================== INVENTORY ====================

        getInventory(query = {}) {

            const params = new URLSearchParams(query).toString();

            return this.request(`/inventory${params ? '?' + params : ''}`, { method: 'GET' });

        },

        getInventoryMovements(query = {}) {

            const params = new URLSearchParams(query).toString();

            return this.request(`/inventory/movements${params ? '?' + params : ''}`, { method: 'GET' });

        },

        createStockMovement(data) {

            return this.request('/inventory/movements', { method: 'POST', body: data });

        },

        transferStock(data) {

            return this.request('/inventory/transfer', { method: 'POST', body: data });

        },



        // ==================== CUSTOMERS ====================

        getCustomers(query = {}) {

            const params = new URLSearchParams(query).toString();

            return this.request(`/customers${params ? '?' + params : ''}`, { method: 'GET' });

        },

        getCustomer(id) {

            return this.request(`/customers/${id}`, { method: 'GET' });

        },

        createCustomer(data) {

            return this.request('/customers', { method: 'POST', body: data });

        },

        updateCustomer(id, data) {

            return this.request(`/customers/${id}`, { method: 'PATCH', body: data });

        },

        deleteCustomer(id) {

            return this.request(`/customers/${id}`, { method: 'DELETE' });

        },



        // ==================== STORES (POINTS OF SALE) ====================

        getStores() {

            return this.request('/tenants/stores', { method: 'GET' });

        },

        createStore(data) {

            return this.request('/tenants/stores', { method: 'POST', body: data });

        },

        updateStore(id, data) {

            return this.request(`/tenants/stores/${id}`, { method: 'PATCH', body: data });

        },



        // ==================== USERS ====================

        getUsers() {

            return this.request('/users', { method: 'GET' });

        },

        getUser(id) {

            return this.request(`/users/${id}`, { method: 'GET' });

        },

        updateUser(id, data) {

            return this.request(`/users/${id}`, { method: 'PATCH', body: data });

        },

        deleteUser(id) {

            return this.request(`/users/${id}`, { method: 'DELETE' });

        },



        // ==================== REPORTS / ANALYTICS ====================

        getDashboardStats() {

            return this.request('/analytics/dashboard', { method: 'GET' });

        },

        getSalesReport(dateFrom, dateTo) {

            const params = new URLSearchParams();

            if (dateFrom) params.set('dateFrom', dateFrom);

            if (dateTo) params.set('dateTo', dateTo);

            return this.request(`/reports/sales?${params.toString()}`, { method: 'GET' });

        },



        // ==================== SYNC ====================

        async syncAll() {

            const results = { categories: null, products: null, orders: null, customers: null, error: null };

            try {

                const [cats, prods, orders, customers] = await Promise.all([

                    this.getCategories().catch(e => ({ error: e.message })),

                    this.getProducts().catch(e => ({ error: e.message })),

                    this.getOrders().catch(e => ({ error: e.message })),

                    this.getCustomers().catch(e => ({ error: e.message }))

                ]);

                results.categories = cats;

                results.products = prods;

                results.orders = orders;

                results.customers = customers;

            } catch (e) {

                results.error = e.message;

            }

            return results;

        }

,

        // === Compatibility methods for CORE sync ===
        isAuthenticated() {
            return !!this.getToken();
        },

        clearTokens() {
            localStorage.removeItem('raya_token');
            localStorage.removeItem('raya_refresh_token');
            localStorage.removeItem('raya_refresh');          // React SPA legacy key
            localStorage.removeItem('raya_creds_v2');
            localStorage.removeItem('raya_creds');           // legacy cleanup
            localStorage.removeItem('raya_api_tokens');
            if (this._proactiveRefreshInterval) {
                clearInterval(this._proactiveRefreshInterval);
                this._proactiveRefreshInterval = null;
            }
        },

        get accessToken() { return this.getToken(); },
        get tenantId() { return localStorage.getItem('raya_tenant_id') || ''; },
        set tenantId(v) { localStorage.setItem('raya_tenant_id', v || ''); },
        get user() {
            try { return JSON.parse(localStorage.getItem('raya_user') || 'null'); } catch(e) { return null; }
        },
        set user(v) { localStorage.setItem('raya_user', JSON.stringify(v)); },

        registerUser(data) {
            return this.register(data);
        },
        registerUserSilent(data) {
            return this.register(data).catch(e => console.warn('[API] Silent register:', e.message));
        },

        collectionMap: {
            products: '/products',
            orders: '/orders',
            clients: '/customers',
            users: '/users',
            categories: '/categories',
            stores: '/stores',
            stockMovements: '/inventory/movements',
            deliveries: '/deliveries',
            financialTransactions: '/transactions'
        },

        async syncFromApi() {
            if (!this.isAuthenticated() || !navigator.onLine) return false;
            try {
                console.log('[SYNC] Starting full sync from API...');
                var results = await Promise.allSettled([
                    this.getProducts().catch(function(e) { return { data: [] }; }),
                    this.getOrders().catch(function(e) { return []; }),
                    this.getCustomers().catch(function(e) { return []; }),
                    this.getUsers().catch(function(e) { return []; }),
                    this.getCategories().catch(function(e) { return []; }),
                    this.getInventoryMovements().catch(function(e) { return []; }),
                    this.getStores().catch(function(e) { return []; })
                ]);
                var products = results[0], orders = results[1], customers = results[2], users = results[3], categories = results[4], stockMovs = results[5], stores = results[6];

                // P6: Upgraded _mergeCollection with intelligent field-level merge
                function _mergeCollection(localArr, apiArr) {
                    // Safety: if API returns empty but local has data, keep local (protects against API errors)
                    if ((!apiArr || apiArr.length === 0) && localArr && localArr.length > 0) {
                        console.log('[SYNC] API returned 0 items but local has', localArr.length, '— keeping local data');
                        return localArr;
                    }
                    var merged = [];
                    var localByApiId = {};
                    var apiIdSet = {};
                    for (var n = 0; n < localArr.length; n++) {
                        if (localArr[n]._apiId) localByApiId[String(localArr[n]._apiId)] = localArr[n];
                    }
                    for (var m = 0; m < apiArr.length; m++) {
                        var apiItem = apiArr[m];
                        apiIdSet[String(apiItem._apiId || apiItem.id)] = true;
                        var localItem = apiItem._apiId ? localByApiId[String(apiItem._apiId)] : null;
                        if (localItem) {
                            // Both exist — use intelligent field merge (API = winner, but local unique fields kept)
                            merged.push(API._fieldMerge(localItem, apiItem));
                        } else {
                            merged.push(apiItem);
                        }
                    }
                    // Keep local-only (unsynced) items AND local items not returned by API (stale but preserve)
                    for (var k = 0; k < localArr.length; k++) {
                        if (!localArr[k]._apiId && !localArr[k]._apiSynced) {
                            merged.push(localArr[k]);
                        } else if (localArr[k]._apiId && !apiIdSet[String(localArr[k]._apiId)]) {
                            // Item was previously synced but API no longer returns it — keep locally
                            merged.push(localArr[k]);
                        }
                    }
                    return merged;
                }

                var tid = this.tenantId || CORE.tenantId || 'default';

                if (products.status === 'fulfilled' && products.value && products.value.data) {
                    var apiProducts = products.value.data.map(function(p) { return {
                        id: p.id, _apiId: p.id, _apiSynced: true, name: p.name, sku: p.sku, barcode: p.barcode,
                        categoryId: p.categoryId, category: p.categoryId, price: p.sellingPrice, purchasePrice: p.purchasePrice,
                        stock: p.stockQuantity, minStock: p.minStockLevel, unit: p.unit,
                        image: p.imageUrl, active: p.isActive !== false,
                        posId: p.posId ?? p.storeId ?? p.pointOfSaleId ?? p.store_id ?? p.store?.id ?? null,
                        storeId: p.storeId ?? p.posId ?? p.pointOfSaleId ?? p.store_id ?? p.store?.id ?? null,
                        tenantId: tid, companyId: tid
                    }; });
                    CORE.db.products = _mergeCollection(CORE.db.products || [], apiProducts);
                    console.log('[SYNC] Products:', CORE.db.products.length);
                }
                if (orders.status === 'fulfilled' && Array.isArray(orders.value)) {
                    var apiOrders = orders.value.map(function(o) { return {
                        id: o.id, _apiId: o.id, _apiSynced: true, orderNumber: o.orderNumber,
                        customerName: o.customerName, status: o.status, items: o.items || [],
                        total: o.totalAmount, paymentMethod: o.paymentMethod,
                        createdAt: o.createdAt, tenantId: tid, companyId: tid
                    }; });
                    CORE.db.orders = _mergeCollection(CORE.db.orders || [], apiOrders);
                    console.log('[SYNC] Orders:', CORE.db.orders.length);
                }
                if (customers.status === 'fulfilled' && Array.isArray(customers.value)) {
                    var apiClients = customers.value.map(function(c) { return {
                        id: c.id, _apiId: c.id, _apiSynced: true,
                        name: (c.firstName || '') + ' ' + (c.lastName || ''),
                        email: c.email, phone: c.phone, address: c.address, city: c.city,
                        tenantId: tid, companyId: tid
                    }; });
                    CORE.db.clients = _mergeCollection(CORE.db.clients || [], apiClients);
                    console.log('[SYNC] Clients:', CORE.db.clients.length);
                }
                var usersArr = null;
                if (users.status === 'fulfilled') {
                    if (Array.isArray(users.value)) usersArr = users.value;
                    else if (users.value && Array.isArray(users.value.data)) usersArr = users.value.data;
                }
                if (usersArr) {
                    // Load persisted deleted user IDs from localStorage
                    if (!CORE._deletedUserIds) {
                        try { CORE._deletedUserIds = JSON.parse(localStorage.getItem('_deletedUserIds') || '{}'); } catch(e) { CORE._deletedUserIds = {}; }
                    }
                    var deletedIds = CORE._deletedUserIds || {};
                    var apiUsers = usersArr.filter(function(u) { return !deletedIds[u.id] && !deletedIds[String(u.id)]; }).map(function(u) {
                        var uPosRaw = u.storeId || u.store_id || u.posId || u.pos || u.pointOfSaleId || u.point_of_sale_id || null;
                        return {
                        id: u.id, _apiId: u.id, _apiSynced: true,
                        name: (u.firstName || '') + ' ' + (u.lastName || ''),
                        username: u.username, email: u.email,
                        role: (u.role || 'vendeur').toLowerCase(), active: u.status === 'active' || u.isActive !== false,
                        tenantId: tid, companyId: tid,
                        storeId: uPosRaw,
                        posId: uPosRaw,
                        pos: uPosRaw ? String(uPosRaw) : null
                    }; });
                    var merged = _mergeCollection(CORE.db.users || [], apiUsers);
                    // Dedup merged users by email to prevent duplicates (prefer _apiId version)
                    var seenEmails = {};
                    var dedupedUsers = [];
                    for (var di = 0; di < merged.length; di++) {
                        var du = merged[di];
                        var dkey = (du.email || du.username || '').toLowerCase().trim();
                        if (!dkey) { dedupedUsers.push(du); continue; }
                        if (seenEmails[dkey] !== undefined) {
                            // Duplicate found — keep the one with _apiId
                            if (du._apiId && !dedupedUsers[seenEmails[dkey]]._apiId) {
                                dedupedUsers[seenEmails[dkey]] = du; // replace old with better one
                            }
                            // else skip this duplicate
                        } else {
                            seenEmails[dkey] = dedupedUsers.length;
                            dedupedUsers.push(du);
                        }
                    }
                    CORE.db.users = dedupedUsers;
                    console.log('[SYNC] Users:', CORE.db.users.length);
                }
                if (categories.status === 'fulfilled' && Array.isArray(categories.value)) {
                    CORE.db.categories = categories.value.map(function(c) { return {
                        id: c.id, _apiId: c.id, name: c.name, description: c.description,
                        icon: c.iconName, color: c.colorCode, active: c.isActive !== false
                    }; });
                    console.log('[SYNC] Categories:', CORE.db.categories.length);
                }
                if (stockMovs && stockMovs.status === 'fulfilled' && Array.isArray(stockMovs.value)) {
                    var apiMovs = stockMovs.value.map(function(m) { return {
                        id: m.id, _apiId: m.id, _apiSynced: true,
                        type: m.type || m.movementType, quantity: m.quantity,
                        productId: m.productId, productName: m.productName,
                        fromWarehouse: m.fromWarehouse, toWarehouse: m.toWarehouse,
                        reason: m.reason || m.notes, date: m.createdAt || m.date,
                        userId: m.userId, tenantId: tid, companyId: tid
                    }; });
                    CORE.db.stockMovements = _mergeCollection(CORE.db.stockMovements || [], apiMovs);
                    console.log('[SYNC] StockMovements:', CORE.db.stockMovements.length);
                }
                if (stores && stores.status === 'fulfilled' && Array.isArray(stores.value)) {
                    var apiStores = stores.value.map(function(s) { return {
                        id: s.id, _apiId: s.id, _apiSynced: true,
                        name: s.name, address: s.address, phone: s.phone,
                        isActive: s.isActive !== false, tenantId: tid, companyId: tid
                    }; });
                    CORE.db.stores = _mergeCollection(CORE.db.stores || [], apiStores);
                    // Synchroniser aussi dans pointsOfSale pour compatibilité
                    CORE.db.pointsOfSale = _mergeCollection(CORE.db.pointsOfSale || [], apiStores);
                    console.log('[SYNC] Stores:', CORE.db.stores.length);
                }

                CORE.state.lastSync = new Date().toISOString();
                CORE.save();
                console.log('[SYNC] Complete!');
                return true;
            } catch(err) {
                console.error('[SYNC] Error:', err);
                return false;
            }
        },

        async pushToApi(collection, action, localItem) {
            if (!this.isAuthenticated() || !navigator.onLine) return;
            var endpoint = this.collectionMap[collection];
            if (!endpoint) return;
            try {
                var apiData = this._toApiFormat(collection, localItem);
                if (!apiData) return;
                if (action === 'create') {
                    var result = await this.request(endpoint, { method: 'POST', body: apiData });
                    if (result && result.id) {
                        var idx = (CORE.db[collection] || []).findIndex(function(i) { return i.id === localItem.id; });
                        if (idx !== -1) CORE.db[collection][idx]._apiId = result.id;
                    }
                } else if (action === 'update' && localItem._apiId) {
                    await this.request(endpoint + '/' + localItem._apiId, { method: 'PATCH', body: apiData });
                } else if (action === 'delete' && localItem._apiId) {
                    await this.request(endpoint + '/' + localItem._apiId, { method: 'DELETE' });
                }
            } catch(err) {
                console.warn('[API] Push failed (' + action + ' ' + collection + '):', err.message || err);
            }
        },

        async pushAllToApi() {
            if (!this.isAuthenticated()) return;
            console.log('[API] Push all to API...');
            var collections = ['products', 'orders', 'clients', 'categories', 'users', 'stockMovements', 'stores'];
            for (var ci = 0; ci < collections.length; ci++) {
                var col = collections[ci];
                var items = CORE.db[col] || [];
                for (var ii = 0; ii < items.length; ii++) {
                    if (!items[ii]._apiId && !items[ii]._apiSynced) {
                        await this.pushToApi(col, 'create', items[ii]);
                    }
                }
            }
            CORE.save();
        },

        _toApiFormat(collection, item) {
            if (collection === 'products') return {
                name: item.name, sku: item.sku || item.ref || 'SKU-' + Date.now(),
                barcode: item.barcode, categoryId: item.category || item.categoryId,
                purchasePrice: item.purchasePrice || item.costPrice,
                sellingPrice: item.price || item.prixVente,
                stockQuantity: item.stock || 0, minStockLevel: item.minStock,
                unit: item.unit, imageUrl: item.image, isActive: item.active !== false,
                description: item.description,
                storeId: item.storeId ?? item.posId ?? item.pointOfSaleId ?? item.pos ?? null
            };
            if (collection === 'orders') return {
                customerName: item.customerName || item.clientName,
                customerPhone: item.customerPhone || item.clientPhone,
                items: (item.items || []).map(function(i) { return {
                    productId: String(i._apiId || i.productId || i.id),
                    quantity: i.quantity || i.qty || 1, discountPercent: i.discount || 0
                }; }),
                paymentMethod: (item.paymentMethod || 'CASH').toUpperCase(),
                discountAmount: item.discount || 0, notes: item.notes
            };
            if (collection === 'clients') {
                var parts = (item.name || '').split(' ');
                return {
                    firstName: item.firstName || parts[0] || 'Client',
                    lastName: item.lastName || parts.slice(1).join(' ') || '',
                    email: item.email, phone: item.phone || item.tel,
                    address: item.address, city: item.city,
                    customerType: (item.customerType || 'INDIVIDUAL').toUpperCase(),
                    notes: item.notes
                };
            }
            if (collection === 'categories') return {
                name: item.name, description: item.description,
                iconName: item.icon, colorCode: item.color,
                isActive: item.active !== false
            };
            if (collection === 'users') return {
                firstName: (item.name || '').split(' ')[0] || item.username,
                lastName: (item.name || '').split(' ').slice(1).join(' ') || '',
                email: item.email || item.username, username: item.username,
                role: (item.role || 'VENDEUR').toUpperCase(),
                isActive: item.active !== false
            };
            if (collection === 'stockMovements') return {
                type: item.type, quantity: item.quantity,
                productId: item.productId, reason: item.reason,
                fromWarehouse: item.fromWarehouse, toWarehouse: item.toWarehouse,
                notes: item.notes || item.reason
            };
            if (collection === 'stores') return {
                name: item.name, address: item.address,
                phone: item.phone, isActive: item.isActive !== false
            };
            return item;
        },

        // ===== GENERIC FULL SYNC â€” ALL COLLECTIONS (98 total) =====
        // P2: Version tracking for optimistic locking
        _cloudVersions: {},
        getCloudVersions(collections) {
            if (!collections) return this._cloudVersions;
            var result = {};
            for (var i = 0; i < collections.length; i++) {
                var col = collections[i];
                if (typeof this._cloudVersions[col] === 'number') {
                    result[col] = this._cloudVersions[col];
                }
            }
            return result;
        },
        updateCloudVersions(versions) {
            if (!versions || typeof versions !== 'object') return;
            var keys = Object.keys(versions);
            for (var i = 0; i < keys.length; i++) {
                this._cloudVersions[keys[i]] = versions[keys[i]];
            }
        },
        _allSyncCollections: [
            // Core business
            'products', 'orders', 'clients', 'categories', 'users', 'stores',
            'stockMovements', 'financialTransactions', 'deliveries', 'returns',
            'pointsOfSale', 'pointsDeVente', 'pos', 'shifts', 'notes', 'notifications', 'deposits',
            'purchaseOrders', 'productVariants', 'tags', 'permissions',
            'sales', 'expenses', 'suppliers', 'vendors',
            // Config & settings
            'config', 'settings', 'systemConfig', 'roles',
            'alertRules', 'alertThresholds', 'customIncidentTypes',
            'shiftTemplates', 'productAttributeTypes', 'promoCodes',
            // Company & invitations
            'companies', 'company', 'invitations', 'joinRequests',
            'vendorBadges', 'clientTags',
            // Logging & audit
            'activityLogs', 'auditLogs', 'systemLogs', 'accessLogs',
            'auditTrail', 'complianceLogs', 'complianceReports',
            'dataModificationLogs', 'deletionLogs', 'exportLogs',
            'approvalAuditTrail', 'incidents', 'incidentHistory', 'issues', 'exceptions',
            // Payments & finance
            'paymentHistory', 'mobilePayments', 'livreurCommissions',
            'transactions', 'financialMetrics', 'paymentInvoices', 'paymentWebhooks',
            'favoritedPaymentMethods', 'mobileMoneProviders',
            // Deliveries & routes
            'independentDeliveryMen', 'deliveryRoutes', 'routeOptimizations', 'routeStops',
            'transferReceipts', 'stockTransfers', 'receptionMedia',
            'lastKnownDeliveryIds', 'livreurPositions',
            // Stock & inventory
            'stockAnalysisABC', 'stockTrendHistory', 'stockPredictions',
            'expiryAlerts', 'reorderSuggestions',
            // Clients & users
            'favoriteClients', 'lastAccessedClients', 'recipients',
            'userAdditionRequests', 'userSuspensions', 'suspensionHistory',
            'orderApprovals', 'posDeleteRequests', 'posCreationRequests', 'timeOff',
            'posDataByLocation',
            // Cart & shopping
            'parkedCarts', 'reservationCart', 'returnCart', 'cart',
            'returnJustifications',
            // UI & preferences
            'budgets', 'alertHistory', 'alertPreferences',
            'dashboardLayouts', 'widgetConfigs', 'userPreferences', 'themeSettings',
            'keyboardShortcuts', 'silenceSchedules',
            // Communications
            'messages', 'messageTemplates', 'deliveryTicketTemplates', 'messageLog',
            'notificationHistory', 'dailyDigestConfigs', 'dailyDigestLogs',
            // Reports & sync
            'validationRules', 'reportSchedules', 'generatedReports',
            'recommendations', 'importExportHistory', 'externalSyncConfigs',
            // Media
            'productImages', 'newProductImages', 'newVariantImages',
            'attachments', 'pendingReceiptFiles', 'validationPhotos',
            // Geo
            'addressClusters', 'cities',
            // System
            'backups', 'pendingSyncs', 'syncHistory'
        ],

        // P5: Global sync push mutex — prevents concurrent push storms
        _isSyncPushing: false,
        _syncPushStart: 0,
        // P5: Per-collection failure tracking with exponential backoff
        _colFailures: {},  // { collectionName: { count: N, lastFail: timestamp } }

        _shouldSkipCollection(col) {
            var info = this._colFailures[col];
            if (!info || info.count === 0) return false;
            // Exponential backoff: 30s, 60s, 120s, 240s, max 300s
            var backoff = Math.min(30000 * Math.pow(2, info.count - 1), 300000);
            var elapsed = Date.now() - info.lastFail;
            if (elapsed < backoff) {
                console.log('[SYNC-BACKOFF] Skipping ' + col + ' (failed ' + info.count + 'x, retry in ' + Math.round((backoff - elapsed)/1000) + 's)');
                return true;
            }
            return false;
        },

        _recordColFailure(col) {
            if (!this._colFailures[col]) this._colFailures[col] = { count: 0, lastFail: 0 };
            this._colFailures[col].count++;
            this._colFailures[col].lastFail = Date.now();
        },

        _recordColSuccess(col) {
            if (this._colFailures[col]) this._colFailures[col] = { count: 0, lastFail: 0 };
        },

        /** Push only DIRTY collections to /sync endpoint (P4: incremental deltas, fallback to full PUT) */
        async syncDirtyToCloud(dirtyList) {
            if (!this.isAuthenticated() || !navigator.onLine) {
                var noAuthErr = new Error('Not authenticated or offline');
                noAuthErr.status = 0;
                noAuthErr._noAuth = true;
                throw noAuthErr;
            }

            // P5: Global mutex — only one push at a time
            if (this._isSyncPushing) {
                var pushAge = Date.now() - this._syncPushStart;
                if (pushAge < 90000) { // Allow auto-reset after 90s (was 120s — reduced to recover faster)
                    console.log('[SYNC-DIRTY] Another push in progress (' + Math.round(pushAge/1000) + 's) — skipping');
                    return true;
                }
                console.warn('[SYNC-DIRTY] Resetting stuck push lock after ' + Math.round(pushAge/1000) + 's');
            }
            this._isSyncPushing = true;
            this._syncPushStart = Date.now();

            try {
                return await this._syncDirtyToCloudInner(dirtyList);
            } finally {
                this._isSyncPushing = false;
            }
        },

        async _syncDirtyToCloudInner(dirtyList) {
            var dirty = dirtyList || CORE.getDirtyCollections();
            if (dirty.length === 0) {
                console.log('[SYNC-DIRTY] No dirty collections to push');
                return true;
            }

            // Helper: PUT fallback — send each dirty collection individually (no full /sync blob)
            var _putFallback = async (dirtyArr) => {
                var collections = {};
                for (var i = 0; i < dirtyArr.length; i++) {
                    var col = dirtyArr[i];
                    var data = CORE.db[col];
                    if (Array.isArray(data)) {
                        // v36: Deep-copy and strip bloated transfer/movement data before push
                        if (col === 'transferReceipts' || col === 'stockTransfers') {
                            var stripped = [];
                            for (var si = 0; si < data.length; si++) {
                                var copy = Object.assign({}, data[si]);
                                ['sendMedia', 'receptionMedia', 'rejectionMedia', 'media', 'photos', 'attachments'].forEach(function(mf) {
                                    if (Array.isArray(copy[mf])) {
                                        copy[mf] = copy[mf].map(function(m) {
                                            return m && m.stripped ? m : { type: m?.type, name: m?.name, stripped: true };
                                        });
                                    }
                                });
                                // Strip any string field > 5KB
                                Object.keys(copy).forEach(function(k) {
                                    if (typeof copy[k] === 'string' && copy[k].length > 5000 && k !== 'id' && k !== '_id' && k !== '_apiId') {
                                        copy[k] = copy[k].substring(0, 200) + '...[truncated]';
                                    }
                                });
                                stripped.push(copy);
                            }
                            collections[col] = stripped;
                        } else if (col === 'stockMovements') {
                            var strippedMov = [];
                            for (var smi = 0; smi < data.length; smi++) {
                                var mcopy = Object.assign({}, data[smi]);
                                delete mcopy.productSnapshot;
                                delete mcopy.beforeSnapshot;
                                delete mcopy.afterSnapshot;
                                if (mcopy.details && typeof mcopy.details === 'string' && mcopy.details.length > 500) {
                                    mcopy.details = mcopy.details.substring(0, 200) + '...[truncated]';
                                }
                                strippedMov.push(mcopy);
                            }
                            collections[col] = strippedMov;
                        } else {
                            collections[col] = data;
                        }
                    }
                }
                // P7: Filter out items with non-UUID IDs (integer IDs crash PostgreSQL UUID columns)
                // NOTE: Only filter collections that are stored in PostgreSQL tables with UUID primary keys.
                // stockMovements, stockTransfers, transferReceipts are stored as JSON blobs in tenant_data — no UUID filtering needed.
                // BUG FIX: Create shallow copies before mutating IDs for the push.
                // Previously, item.id = item._apiId mutated the ORIGINAL objects in CORE.db,
                // breaking all subsequent lookups by the original integer ID (getProduct, getProductStock, etc.).
                var _isUUID2 = function(v) { return typeof v === 'string' && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(v); };
                var uuidCols2 = ['products', 'orders', 'clients', 'categories', 'stores', 'deliveries', 'returns'];
                for (var uc2 = 0; uc2 < uuidCols2.length; uc2++) {
                    var ucol2 = uuidCols2[uc2];
                    if (collections[ucol2] && Array.isArray(collections[ucol2])) {
                        var mapped = [];
                        for (var mi = 0; mi < collections[ucol2].length; mi++) {
                            var item = collections[ucol2][mi];
                            if (item._apiId && _isUUID2(String(item._apiId))) {
                                // SHALLOW COPY — never mutate the original in CORE.db
                                mapped.push(Object.assign({}, item, { _origLocalId: item.id, id: item._apiId }));
                            } else if (_isUUID2(String(item.id))) {
                                mapped.push(item); // already has UUID id, safe to send as-is
                            }
                            // else: skip items with non-UUID ids and no _apiId
                        }
                        collections[ucol2] = mapped.length > 0 ? mapped : undefined;
                        if (!collections[ucol2]) delete collections[ucol2];
                    }
                }
                var keys = Object.keys(collections);
                if (keys.length === 0) {
                    console.log('[SYNC-DIRTY] No data in dirty collections');
                    CORE.clearDirty(dirtyArr);
                    return true;
                }
                // PERF: Use bulk PUT /sync to send ALL collections in a single HTTP request
                // instead of N sequential PUT /sync/:collection requests (saves N-1 round trips).
                console.log('[SYNC-DIRTY] PUT bulk for ' + keys.length + ' collections: ' + keys.join(', '));
                var pushedVersions = {};
                try {
                    var bulkResult = await this.request('/sync', {
                        method: 'PUT',
                        body: { collections: collections },
                        timeout: 30000  // Reduced from 45s — payloads are lighter after media stripping
                    });
                    if (bulkResult && bulkResult.versions) {
                        pushedVersions = bulkResult.versions;
                    }
                } catch(bulkErr) {
                    // Fallback: if bulk endpoint fails (404/500), try per-collection
                    console.warn('[SYNC-DIRTY] Bulk PUT failed, falling back to per-collection:', bulkErr.message);
                    if (bulkErr.data) console.warn('[SYNC-DIRTY] Server detail:', JSON.stringify(bulkErr.data));
                    // P5: Per-collection fallback with circuit-breaker and backoff
                    var _largeCols = { cities: 1, stockMovements: 1, products: 1, orders: 1, clients: 1, stockTransfers: 1, transferReceipts: 1 };
                    var consecutiveFails = 0;
                    var fallbackBudgetMs = 60000; // Max 60s total for all per-collection PUTs
                    var fallbackStart = Date.now();
                    for (var pi = 0; pi < keys.length; pi++) {
                        var pcol = keys[pi];
                        // Circuit-breaker: abort if 3 consecutive collections failed
                        if (consecutiveFails >= 3) {
                            console.warn('[SYNC-DIRTY] Circuit-breaker: ' + consecutiveFails + ' consecutive failures — aborting remaining ' + (keys.length - pi) + ' collections');
                            break;
                        }
                        // Time budget: abort if we've been in fallback too long
                        if (Date.now() - fallbackStart > fallbackBudgetMs) {
                            console.warn('[SYNC-DIRTY] Time budget exhausted (' + Math.round(fallbackBudgetMs/1000) + 's) — aborting remaining ' + (keys.length - pi) + ' collections');
                            break;
                        }
                        // Backoff: skip collections that recently failed
                        if (API._shouldSkipCollection(pcol)) continue;
                        var pData = collections[pcol] || [];
                        try {
                            var _putTimeout = _largeCols[pcol] ? 30000 : 15000; // Reduced timeouts to fail faster
                            var putResult = await this.request('/sync/' + encodeURIComponent(pcol), {
                                method: 'PUT',
                                body: { data: pData },
                                timeout: _putTimeout
                            });
                            if (putResult && typeof putResult.version === 'number') {
                                pushedVersions[pcol] = putResult.version;
                            }
                            consecutiveFails = 0;
                            API._recordColSuccess(pcol);
                        } catch(perColErr) {
                            console.warn('[SYNC-DIRTY] PUT ' + pcol + ' failed:', perColErr.message);
                            consecutiveFails++;
                            API._recordColFailure(pcol);
                        }
                    }
                }
                if (Object.keys(pushedVersions).length > 0) this.updateCloudVersions(pushedVersions);
                CORE.clearDirty(dirtyArr);
                CORE.clearChangeLog(dirtyArr);
                return true;
            };

            try {
                // P4: Try incremental delta sync first
                var deltas = CORE.getDeltas(dirty);
                var deltaKeys = Object.keys(deltas);
                if (deltaKeys.length > 0) {
                    // Count items for logging
                    var upsertCount = 0, deleteCount = 0;
                    for (var d = 0; d < deltaKeys.length; d++) {
                        upsertCount += (deltas[deltaKeys[d]].upserts || []).length;
                        deleteCount += (deltas[deltaKeys[d]].deletes || []).length;
                    }
                    var versions = this.getCloudVersions(deltaKeys);
                    console.log('[SYNC-DELTA] PATCH ' + deltaKeys.length + ' collections (' + upsertCount + ' upserts, ' + deleteCount + ' deletes)');
                    try {
                        var result = await this.request('/sync', {
                            method: 'PATCH',
                            body: { deltas: deltas, versions: versions }
                        });
                        console.log('[SYNC-DELTA] \u2705 Delta sync complete:', result);
                        if (result && result.versions) this.updateCloudVersions(result.versions);
                        CORE.clearChangeLog(deltaKeys);
                        CORE.clearDirty(dirty);
                        return true;
                    } catch(patchErr) {
                        // PATCH not supported by backend (404/405) — fallback to per-collection PUT
                        console.warn('[SYNC-DELTA] PATCH failed (' + (patchErr.status || 'network') + '), falling back to PUT...', patchErr.message || '');
                        return await _putFallback(dirty);
                    }
                }
                // No deltas tracked (e.g. bulk import) — send full collections via PUT
                return await _putFallback(dirty);
            } catch(err) {
                // P2: Handle 409 VERSION_CONFLICT
                if (err && err.status === 409) {
                    console.warn('[SYNC-DIRTY] \u26a0\ufe0f Version conflict! Pulling fresh data then retrying...');
                    if (typeof SyncIndicator !== 'undefined') SyncIndicator.show('conflict', 'Conflit de versions...');
                    var fallbackCollections = {};
                    for (var j = 0; j < dirty.length; j++) {
                        var c = dirty[j];
                        if (Array.isArray(CORE.db[c])) fallbackCollections[c] = CORE.db[c];
                    }
                    await this._resolveConflictAndRetry(fallbackCollections);
                    CORE.clearChangeLog(dirty);
                    return true;
                }
                console.error('[SYNC-DIRTY] \u274c Push failed:', err.message || err);
                // RE-THROW so the caller (CORE.save) can retry
                throw err;
            }
        },

        /** Push pending changes to cloud (events first, then dirty collections only) */
        async syncAllToCloud() {
            if (!this.isAuthenticated() || !navigator.onLine) return false;
            try {
                var _pushT0 = performance.now();
                try { await this.pushEvents(); } catch(e) { console.warn('[SYNC] pushEvents failed:', e.message); }
                var dirty = CORE.getDirtyCollections();
                if (!dirty || dirty.length === 0) {
                    console.log('[SYNC-ALL] No dirty collections to push');
                    return true;
                }
                console.log('[SYNC-ALL] Incremental push for ' + dirty.length + ' dirty collections');
                await this.syncDirtyToCloud(dirty);
                console.log('[SYNC-ALL] Incremental push complete in ' + (performance.now() - _pushT0).toFixed(0) + 'ms');
                return true;
            } catch(err) {
                console.error('[SYNC-ALL] Push failed:', err.message || err);
                return false;
            }
        },


        // --- P6: INTELLIGENT MERGE à timestamp-based field-level merge ---
        _smartMerge(localArr, cloudArr) {
            if (!Array.isArray(localArr) || localArr.length === 0) return cloudArr || [];
            if (!Array.isArray(cloudArr) || cloudArr.length === 0) return localArr || [];

            // Invalidate product/user indexes since we'll return a new array of objects
            if (typeof CORE !== 'undefined') { CORE._productIndex = null; CORE._userIndex = null; }

            // Build maps by ID for O(1) lookup
            var localMap = {};
            // BUG FIX: Also index local items by their _apiId so that cloud items
            // (which have UUID as id) can match local items (which have integer id + _apiId=UUID).
            // Without this, every merge creates duplicates: local(id=1) + cloud(id=UUID) for the same product.
            var localByApiId = {};
            for (var i = 0; i < localArr.length; i++) {
                var li = localArr[i];
                if (li && li.id != null) localMap[String(li.id)] = li;
                if (li && li._apiId) localByApiId[String(li._apiId)] = li;
            }
            var cloudMap = {};
            for (var j = 0; j < cloudArr.length; j++) {
                var ci = cloudArr[j];
                if (ci && ci.id != null) cloudMap[String(ci.id)] = ci;
            }

            var merged = [];
            var processedIds = {};  // tracks cloud IDs that were processed
            var processedLocalIds = {};  // tracks local integer IDs that were matched via _apiId

            // Pass 1: Process cloud items (cloud data is authoritative for items it has)
            for (var c = 0; c < cloudArr.length; c++) {
                var cloudItem = cloudArr[c];
                if (!cloudItem || cloudItem.id == null) { merged.push(cloudItem); continue; }
                var idStr = String(cloudItem.id);
                processedIds[idStr] = true;
                // Try direct ID match first, then match via _apiId
                var localItem = localMap[idStr] || localByApiId[idStr];

                if (!localItem) {
                    // Cloud-only item → take as-is
                    merged.push(cloudItem);
                } else {
                    // Exists in both — intelligent merge, preserving local integer ID and _apiId
                    var mergedItem = this._mergeItems(localItem, cloudItem);
                    // Preserve the local integer ID so CORE.create / getProduct lookups still work
                    if (typeof localItem.id === 'number' && typeof cloudItem.id === 'string') {
                        mergedItem.id = localItem.id;
                        mergedItem._apiId = cloudItem.id;
                    }
                    merged.push(mergedItem);
                    // Mark the local integer ID as processed so Pass 2 skips it
                    if (localItem.id != null) processedLocalIds[String(localItem.id)] = true;
                }
            }

            // Pass 2: Local-only items (not in cloud)
            for (var l = 0; l < localArr.length; l++) {
                var lItem = localArr[l];
                if (!lItem || lItem.id == null) continue;
                var lIdStr = String(lItem.id);
                // Skip if already processed by ID match or _apiId match
                if (processedIds[lIdStr] || processedLocalIds[lIdStr]) continue;
                merged.push(lItem);
            }

            return merged;
        },

        _mergeItems(local, cloud) {
            // Get timestamps for comparison
            var localTs = this._getTimestamp(local);
            var cloudTs = this._getTimestamp(cloud);

            // Case 1: Only one has a timestamp → that one wins entirely
            if (localTs && !cloudTs) return { ...cloud, ...local };
            if (cloudTs && !localTs) return { ...local, ...cloud };

            // Case 2: Both have timestamps — compare
            if (localTs && cloudTs) {
                var localTime = new Date(localTs).getTime();
                var cloudTime = new Date(cloudTs).getTime();

                // If timestamps differ by more than 2 seconds, newest wins entirely
                if (Math.abs(localTime - cloudTime) > 2000) {
                    if (localTime > cloudTime) {
                        // Local is newer — local fields win, but keep cloud-only fields
                        return this._fieldMerge(cloud, local);
                    } else {
                        // Cloud is newer — cloud fields win, but keep local-only fields
                        return this._fieldMerge(local, cloud);
                    }
                }
            }

            // Case 3: Same timestamp or no timestamps — field-level merge
            //   Non-null/non-undefined values from both sides are kept
            //   Cloud wins ties for same-named fields (cloud is authoritative)
            return this._fieldMerge(local, cloud);
        },

        _fieldMerge(loser, winner) {
            // Winner's fields take priority, but loser's unique fields are preserved
            // Internal/system fields are never merged from loser
            var skipFields = { '_apiId': 1, '_apiSynced': 1, '_syncedAt': 1 };
            var result = {};

            // Start with loser's fields (non-null, non-system)
            var loserKeys = Object.keys(loser);
            for (var i = 0; i < loserKeys.length; i++) {
                var k = loserKeys[i];
                if (skipFields[k]) continue;
                if (loser[k] !== null && loser[k] !== undefined) {
                    result[k] = loser[k];
                }
            }

            // Overwrite with winner's fields (these take priority)
            var winnerKeys = Object.keys(winner);
            for (var j = 0; j < winnerKeys.length; j++) {
                var wk = winnerKeys[j];
                if (winner[wk] !== null && winner[wk] !== undefined) {
                    // BUG FIX (v36): Deep-merge posStocks instead of replacing it.
                    // Without this, when cloud (winner) has posStocks={POS_A: {stock:10}}
                    // and local (loser) has posStocks={POS_A: {stock:10}, POS_B: {stock:5}},
                    // the POS_B entry (added via transfer reception) gets LOST because
                    // cloud wins and replaces the whole posStocks object.
                    // Same applies to posDataByLocation and other nested stock maps.
                    if (wk === 'posStocks' && typeof winner[wk] === 'object' && !Array.isArray(winner[wk])
                        && typeof result[wk] === 'object' && !Array.isArray(result[wk])) {
                        // Merge: keep all POS entries from both sides, winner's entries override loser's
                        var mergedStocks = {};
                        var loserStocks = result[wk] || {};
                        var winnerStocks = winner[wk];
                        // First, copy loser's entries (these may include transfer-received stock)
                        var lsKeys = Object.keys(loserStocks);
                        for (var ls = 0; ls < lsKeys.length; ls++) {
                            mergedStocks[lsKeys[ls]] = loserStocks[lsKeys[ls]];
                        }
                        // Then overlay winner's entries (cloud is authoritative for POS it knows about)
                        var wsKeys = Object.keys(winnerStocks);
                        for (var ws = 0; ws < wsKeys.length; ws++) {
                            var wsKey = wsKeys[ws];
                            if (mergedStocks[wsKey] && typeof mergedStocks[wsKey] === 'object' && typeof winnerStocks[wsKey] === 'object') {
                                // Both have this POS entry — compare timestamps to decide winner
                                var localEntry = mergedStocks[wsKey];
                                var cloudEntry = winnerStocks[wsKey];
                                var localTs = localEntry.lastUpdated || localEntry.lastTransfer || '';
                                var cloudTs = cloudEntry.lastUpdated || cloudEntry.lastTransfer || '';
                                if (localTs && cloudTs && new Date(localTs).getTime() > new Date(cloudTs).getTime()) {
                                    // Local entry is newer (e.g., just received a transfer) — keep local
                                    // but merge in cloud-only fields
                                    mergedStocks[wsKey] = Object.assign({}, cloudEntry, localEntry);
                                } else {
                                    // Cloud entry is newer or same — cloud wins but keep local-only fields
                                    mergedStocks[wsKey] = Object.assign({}, localEntry, cloudEntry);
                                }
                            } else {
                                // Only winner has this entry, or it's not an object — take winner's
                                mergedStocks[wsKey] = winnerStocks[wsKey];
                            }
                        }
                        result[wk] = mergedStocks;
                    } else {
                        result[wk] = winner[wk];
                    }
                }
            }

            // Ensure id comes from winner
            if (winner.id != null) result.id = winner.id;

            // Set merge timestamp
            result._mergedAt = new Date().toISOString();
            return result;
        },

        _getTimestamp(item) {
            if (!item) return null;
            return item.updatedAt || item.createdAt || item._mergedAt || null;
        },

        /**
         * Pull only critical collections (stockTransfers, notifications) from cloud.
         * PERF: Uses single bulk GET instead of 3 separate requests.
         * Used during light sync and idle cycles so incoming transfers appear promptly.
         * @returns {Promise<boolean>} true if any data was merged
         */
        async _pullCriticalCollections() {
            if (!this.isAuthenticated() || !navigator.onLine) return false;
            // PERF: Cooldown — skip if pulled less than 30s ago (prevents tab-switch spam)
            var now = Date.now();
            if (this._lastCriticalPull && (now - this._lastCriticalPull < 30000)) return false;
            this._lastCriticalPull = now;
            
            // PERF: Single bulk request for ALL critical collections instead of 3 sequential requests
            // This reduces idle request count from 3/cycle to 1/cycle (67% reduction)
            var criticalCols = ['stockTransfers', 'transferReceipts', 'notifications'];
            try {
                // Use /sync/meta to check if anything changed first
                var versionsParam = criticalCols.map(function(c) {
                    var v = API._cloudVersions ? (API._cloudVersions[c] || 0) : 0;
                    return c + ':' + v;
                }).join(',');
                var resp = await this.request('/sync/bulk?collections=' + criticalCols.join(',') + '&versions=' + encodeURIComponent(versionsParam) + '&light=1', {
                    method: 'GET', timeout: 15000, retries: 0
                });
                
                // If bulk endpoint not available (404), fall back to single most important collection
                if (!resp || resp._status === 404) {
                    // Fallback: just pull stockTransfers + transferReceipts in ONE call each (skip notifications)
                    var merged = false;
                    var fallbackCols = ['stockTransfers', 'transferReceipts'];
                    for (var fi = 0; fi < fallbackCols.length; fi++) {
                        var fc = fallbackCols[fi];
                        try {
                            var fr = await this.request('/sync/' + fc + '?light=1', { method: 'GET', timeout: 12000, retries: 0 });
                            if (fr && Array.isArray(fr.data) && fr.data.length > 0) {
                                var localArr = CORE.db[fc];
                                CORE.db[fc] = Array.isArray(localArr) ? this._smartMerge(localArr, fr.data) : fr.data;
                                if (typeof fr.version === 'number') this.updateCloudVersions({ [fc]: fr.version });
                                merged = true;
                            }
                        } catch(fe) { /* skip */ }
                    }
                    if (merged) CORE.save();
                    return merged;
                }
                
                // Bulk response: { collections: { stockTransfers: { data: [...], version: N }, ... } }
                var merged = false;
                if (resp && resp.collections) {
                    for (var ci = 0; ci < criticalCols.length; ci++) {
                        var col = criticalCols[ci];
                        var colResp = resp.collections[col];
                        if (colResp && Array.isArray(colResp.data) && colResp.data.length > 0) {
                            var localArr = CORE.db[col];
                            CORE.db[col] = Array.isArray(localArr) ? this._smartMerge(localArr, colResp.data) : colResp.data;
                            if (typeof colResp.version === 'number') this.updateCloudVersions({ [col]: colResp.version });
                            merged = true;
                        }
                    }
                }
                if (merged) CORE.save();
                return merged;
            } catch(e) {
                console.warn('[SYNC-CRITICAL] Pull failed:', e.message);
                return false;
            }
        },

        /** Pull ALL collections from /sync endpoint into CORE.db
         *  @param {boolean} force - bypass cooldown (used by full sync)
         */
        async syncAllFromCloud(force) {
            if (!this.isAuthenticated() || !navigator.onLine) return false;
            // PERF: Cooldown  skip if called less than 2 minutes ago (unless forced)
            var now = Date.now();
            if (!force && this._lastCloudPull && (now - this._lastCloudPull < 120000)) {
                console.log('[SYNC-ALL] Skipping pull  cooldown (' + Math.round((now - this._lastCloudPull)/1000) + 's since last pull)');
                return true;
            }
            try {
                var _pullT0 = performance.now();

                // STEP 1: Fetch metadata to know what changed
                var sinceISO = localStorage.getItem('raya_last_cloud_pull') || '';
                var metaUrl = '/sync/meta' + (sinceISO ? '?since=' + encodeURIComponent(sinceISO) : '');
                console.log('[SYNC-ALL] Checking metadata' + (sinceISO ? ' (since ' + sinceISO + ')' : ' (full)') + '...');
                var meta = await this.request(metaUrl, { method: 'GET', timeout: 8000, retries: 1 });
                var changedCols = (meta && meta.collections) ? meta.collections : [];
                if (changedCols.length === 0 && sinceISO) {
                    console.log('[SYNC-ALL] Nothing changed since last pull (' + (performance.now() - _pullT0).toFixed(0) + 'ms)');
                    this._lastCloudPull = now;
                    return true;
                }

                // STEP 2: Pull changed collections via specialized endpoints (/sync/:collection)
                var merged = 0;
                var PAGED_THRESHOLD = 500;
                for (var bi = 0; bi < changedCols.length; bi++) {
                    var bcol = changedCols[bi];
                    var cloudVersion = (bcol && typeof bcol.version === 'number') ? bcol.version : null;
                    if (cloudVersion !== null && this._cloudVersions[bcol.collection] === cloudVersion) {
                        console.log('[SYNC-ALL] Skip ' + bcol.collection + ' (version unchanged: ' + cloudVersion + ')');
                        continue;
                    }
                    var allData = [];
                    var offset = 0;
                    var pageSize = 1000;
                    var hasMore = (bcol.count > PAGED_THRESHOLD);
                    if (hasMore) console.log('[SYNC-ALL] Paging ' + bcol.collection + ' (' + bcol.count + ' items)...');
                    while (hasMore) {
                        var page = await this.request('/sync/' + bcol.collection + '?offset=' + offset + '&limit=' + pageSize + '&light=1', { method: 'GET' });
                        if (page && Array.isArray(page.data)) {
                            allData = allData.concat(page.data);
                            hasMore = !!page.hasMore;
                            offset += page.data.length;
                        } else { hasMore = false; }
                    }
                    if (allData.length === 0 && !hasMore) {
                        var single = await this.request('/sync/' + bcol.collection + '?light=1', { method: 'GET' });
                        allData = (single && Array.isArray(single.data)) ? single.data : [];
                        if (single && typeof single.version === 'number') {
                            this.updateCloudVersions({ [bcol.collection]: single.version });
                        }
                    }
                    var localArr = CORE.db[bcol.collection];
                    if (!Array.isArray(localArr)) { CORE.db[bcol.collection] = allData; }
                    else { CORE.db[bcol.collection] = API._smartMerge(localArr, allData); }
                    // Strip base64 images from products after cloud merge to prevent localStorage bloat
                    if (bcol.collection === 'products' && Array.isArray(CORE.db.products)) {
                        CORE.db.products.forEach(function(p) {
                            if (p.image && typeof p.image === 'string' && p.image.startsWith('data:')) {
                                p.image = '';
                            }
                        });
                    }
                    // Strip productImages entirely — images should be served from cloud/CDN
                    if (bcol.collection === 'productImages') { CORE.db.productImages = []; }
                    if (cloudVersion !== null) this.updateCloudVersions({ [bcol.collection]: cloudVersion });
                    merged++;
                    console.log('[SYNC-ALL] ' + bcol.collection + ': ' + allData.length + ' items merged');
                }

                // Filter out deleted users from merged data so they don't come back from cloud
                if (Array.isArray(CORE.db.users)) {
                    if (!CORE._deletedUserIds) {
                        try { CORE._deletedUserIds = JSON.parse(localStorage.getItem('_deletedUserIds') || '{}'); } catch(e) { CORE._deletedUserIds = {}; }
                    }
                    var delIds = CORE._deletedUserIds || {};
                    if (Object.keys(delIds).length > 0) {
                        var beforeCount = CORE.db.users.length;
                        CORE.db.users = CORE.db.users.filter(function(u) { return !delIds[u.id] && !delIds[String(u.id)] && !delIds[u._apiId]; });
                        if (CORE.db.users.length < beforeCount) console.log('[SYNC-ALL] Filtered out ' + (beforeCount - CORE.db.users.length) + ' deleted user(s) after cloud merge');
                    }
                }

                // Post-sync: strip any fake/demo data that cloud may have reintroduced
                if (merged > 0 && typeof CORE._sanitizeFakeData === 'function') {
                    var sanitized = CORE._sanitizeFakeData();
                    if (sanitized) console.log('[SYNC-ALL] Post-sync sanitizer removed fake data');
                }

                // Save the pull timestamp for next incremental sync
                this._lastCloudPull = now;
                localStorage.setItem('raya_last_cloud_pull', new Date().toISOString());
                console.log('[SYNC-ALL] Done: ' + merged + ' collections merged in ' + (performance.now() - _pullT0).toFixed(0) + 'ms');
                CORE.save();
                return true;
            } catch(err) {
                console.error('[SYNC-ALL] Pull failed:', err.message || err);
                return false;
            }
        },

        // P2: Conflict resolution — pull fresh, merge, re-push without version check
        async _resolveConflictAndRetry(localCollections) {
            try {
                console.log('[CONFLICT] Resolving version conflict...');
                // Step 1: Pull fresh data per conflicting collection (paged)
                var cloudCols = {};
                var mergedCollections = {};
                var conflictNames = Object.keys(localCollections);
                for (var i = 0; i < conflictNames.length; i++) {
                    var col = conflictNames[i];
                    var allData = [];
                    var offset = 0;
                    var limit = 1000;
                    var hasMore = true;
                    while (hasMore) {
                        var page = await this.request('/sync/' + encodeURIComponent(col) + '?offset=' + offset + '&limit=' + limit + '&light=1', { method: 'GET' });
                        var pageData = (page && Array.isArray(page.data)) ? page.data : [];
                        allData = allData.concat(pageData);
                        hasMore = !!(page && page.hasMore);
                        if (!hasMore) break;
                        offset += pageData.length;
                    }
                    cloudCols[col] = allData;

                    // Step 2: P6 intelligent merge — timestamp + field-level
                    var localData = localCollections[col] || [];
                    var cloudData = cloudCols[col] || [];
                    if (!Array.isArray(cloudData)) cloudData = [];
                    mergedCollections[col] = API._smartMerge(localData, cloudData);
                    CORE.db[col] = mergedCollections[col];
                }

                // Filter out deleted users after merge
                if (Array.isArray(CORE.db.users)) {
                    if (!CORE._deletedUserIds) {
                        try { CORE._deletedUserIds = JSON.parse(localStorage.getItem('_deletedUserIds') || '{}'); } catch(e) { CORE._deletedUserIds = {}; }
                    }
                    var delIds = CORE._deletedUserIds || {};
                    if (Object.keys(delIds).length > 0) {
                        CORE.db.users = CORE.db.users.filter(function(u) { return !delIds[u.id] && !delIds[String(u.id)] && !delIds[u._apiId]; });
                        if (mergedCollections.users) mergedCollections.users = CORE.db.users;
                    }
                }

                // Step 3: Push merged data incrementally (no full /sync blob)
                console.log('[CONFLICT] Pushing merged data for ' + conflictNames.length + ' collections (incremental)...');
                for (var ci = 0; ci < conflictNames.length; ci++) {
                    CORE.markDirty(conflictNames[ci]);
                }
                await this.syncDirtyToCloud(conflictNames);
                console.log('[CONFLICT] ✅ Conflict resolved successfully');
                CORE.save();
            } catch(mergeErr) {
                console.error('[CONFLICT] ❌ Merge failed:', mergeErr.message || mergeErr);
            }
        }
    ,

        // -----------------------------------------------------------
        // CRDT: Event-Based Sync — push/pull events across devices
        // -----------------------------------------------------------

        /** Push pending CRDT events from local queue to server */
        async pushEvents() {
            if (!this.isAuthenticated() || !navigator.onLine) return false;
            var queue = CORE._eventQueue;
            if (!queue || queue.length === 0) {
                return true;
            }
            try {
                var deviceId = DeviceId.get();
                console.log('[CRDT] Pushing ' + queue.length + ' events from device ' + deviceId.slice(0, 8) + '...');
                var result = await this.request('/sync/events', {
                    method: 'POST',
                    body: { deviceId: deviceId, events: queue }
                });
                if (result && typeof result.seqNo === 'number' && result.seqNo > 0) {
                    CORE._eventSeqNo = Math.max(CORE._eventSeqNo, result.seqNo);
                }
                // Clear pushed events
                CORE._eventQueue = [];
                CORE.saveEventQueue();
                console.log('[CRDT] \u2705 Pushed ' + queue.length + ' events, server seqNo=' + (result?.seqNo || '?'));
                return true;
            } catch(err) {
                console.warn('[CRDT] \u26a0 Push events failed:', err.message || err);
                return false;
            }
        },

        _pullEventsDepth: 0,
        _MAX_PULL_DEPTH: 5, // Max recursive batches per pull cycle (5 × 200 = 1000 events max)

        /** Pull new CRDT events from server and apply them locally */
        async pullEvents() {
            if (!this.isAuthenticated() || !navigator.onLine) return false;
            // Reset depth counter on top-level call
            if (!this._pullEventsDepth) this._pullEventsDepth = 0;
            try {
                var deviceId = DeviceId.get();
                var since = CORE._eventSeqNo || 0;
                // Guard: if seqNo looks corrupted, reset
                if (since > Number.MAX_SAFE_INTEGER || since < 0) {
                    console.warn('[CRDT] Corrupted seqNo=' + since + ', resetting to 0');
                    since = 0;
                    CORE._eventSeqNo = 0;
                    localStorage.removeItem(CORE._eventSeqKey);
                }
                // If seqNo=0 (fresh install or corruption-reset): DON'T replay all events.
                // Instead, do a lightweight probe (limit=1) to get server's current seqNo.
                // Full data will come from syncAllFromCloud() via REST.
                if (since === 0) {
                    console.log('[CRDT] seqNo=0 → probing server for current seqNo (skip full replay)...');
                    try {
                        var probe = await this.request('/sync/events?since=0&deviceId=' + encodeURIComponent(deviceId) + '&limit=1', {
                            method: 'GET',
                            timeout: 5000,
                            retries: 0
                        });
                        if (probe && typeof probe.serverSeqNo === 'number' && probe.serverSeqNo > 0 && probe.serverSeqNo <= Number.MAX_SAFE_INTEGER) {
                            CORE._eventSeqNo = probe.serverSeqNo;
                            CORE.saveEventQueue();
                            console.log('[CRDT] ✅ seqNo fast-forwarded to ' + probe.serverSeqNo + ' (skipped full event replay)');
                        } else {
                            console.log('[CRDT] No serverSeqNo in probe — will retry next cycle');
                        }
                    } catch(probeErr) {
                        console.warn('[CRDT] Probe failed (will retry next cycle):', probeErr.message);
                    }
                    this._pullEventsDepth = 0;
                    return false;
                }

                console.log('[CRDT] Pulling events since seqNo=' + since + ' (device=' + deviceId.slice(0, 8) + ')...');
                var result = await this.request('/sync/events?since=' + since + '&deviceId=' + encodeURIComponent(deviceId) + '&limit=200', {
                    method: 'GET',
                    timeout: 10000,   // 10s max — fail fast if server is slow
                    retries: 1        // Only 1 retry (not default 2)
                });
                if (!result || !result.events || result.events.length === 0) {
                    if (result && typeof result.serverSeqNo === 'number') {
                        // Guard server seqNo too
                        var srvSeq = result.serverSeqNo;
                        if (srvSeq > 0 && srvSeq <= Number.MAX_SAFE_INTEGER) {
                            CORE._eventSeqNo = Math.max(CORE._eventSeqNo, srvSeq);
                        }
                        CORE.saveEventQueue();
                    }
                    console.log('[CRDT] No new remote events');
                    this._pullEventsDepth = 0;
                    return true;
                }

                var events = result.events;
                console.log('[CRDT] Received ' + events.length + ' remote events');

                var modifiedCollections = {};
                for (var i = 0; i < events.length; i++) {
                    var evt = events[i];
                    if (!evt.collection || !evt.itemId) continue;
                    if (evt.hlc) HLC.merge(evt.hlc);
                    this._applyRemoteEvent(evt);
                    modifiedCollections[evt.collection] = true;
                }

                if (result.serverSeqNo && result.serverSeqNo > 0 && result.serverSeqNo <= Number.MAX_SAFE_INTEGER) {
                    CORE._eventSeqNo = Math.max(CORE._eventSeqNo, result.serverSeqNo);
                }
                CORE.saveEventQueue();

                var modCols = Object.keys(modifiedCollections);
                if (modCols.length > 0) {
                    console.log('[CRDT] \u2705 Applied events to ' + modCols.length + ' collections: ' + modCols.join(', '));
                    CORE.save();
                }

                if (result.hasMore) {
                    this._pullEventsDepth++;
                    if (this._pullEventsDepth >= this._MAX_PULL_DEPTH) {
                        console.warn('[CRDT] Max pull depth reached (' + this._MAX_PULL_DEPTH + ' batches) — stopping. Will continue next cycle.');
                        this._pullEventsDepth = 0;
                        return true;
                    }
                    console.log('[CRDT] More events available, pulling batch ' + (this._pullEventsDepth + 1) + '...');
                    return await this.pullEvents();
                }

                this._pullEventsDepth = 0;
                return true;
            } catch(err) {
                this._pullEventsDepth = 0;
                console.warn('[CRDT] \u26a0 Pull events failed:', err.message || err);
                return false;
            }
        },

        /** Apply a single remote event using LWW-per-field strategy */
        _applyRemoteEvent(evt) {
            var col = evt.collection;
            var itemId = evt.itemId;
            var operation = evt.operation;
            var fields = evt.fields || {};

            if (!Array.isArray(CORE.db[col])) {
                CORE.db[col] = [];
            }

            var items = CORE.db[col];
            var idx = items.findIndex(function(it) { return String(it.id) === String(itemId); });

            if (operation === 'delete') {
                if (idx !== -1) {
                    var localItem = items[idx];
                    var localHlc = localItem._hlc || '';
                    var remoteHlc = evt.hlc || '';
                    if (HLC.compare(remoteHlc, localHlc) >= 0) {
                        items.splice(idx, 1);
                        console.log('[CRDT] Deleted ' + col + '#' + itemId + ' from device ' + (evt.deviceId || '?').slice(0, 8));
                    }
                }
                return;
            }

            if (operation === 'create') {
                if (idx !== -1) {
                    this._lwwMergeFields(items[idx], fields);
                } else {
                    var newItem = { id: isNaN(Number(itemId)) ? itemId : Number(itemId) };
                    var fkeys = Object.keys(fields);
                    for (var j = 0; j < fkeys.length; j++) {
                        var fk = fkeys[j];
                        if (fk === '_deleted') continue;
                        newItem[fk] = fields[fk].v;
                    }
                    newItem._hlc = evt.hlc;
                    newItem._deviceId = evt.deviceId || '';
                    items.push(newItem);
                    console.log('[CRDT] Created ' + col + '#' + itemId + ' from device ' + (evt.deviceId || '?').slice(0, 8));
                }
                return;
            }

            if (operation === 'update') {
                if (idx !== -1) {
                    this._lwwMergeFields(items[idx], fields);
                    console.log('[CRDT] Updated ' + col + '#' + itemId + ' from device ' + (evt.deviceId || '?').slice(0, 8));
                }
                return;
            }
        },

        /** LWW-per-field merge: for each field, the highest HLC wins */
        _lwwMergeFields(localItem, remoteFields) {
            var fkeys = Object.keys(remoteFields);
            for (var i = 0; i < fkeys.length; i++) {
                var fieldName = fkeys[i];
                if (fieldName === '_deleted') continue;

                var remoteField = remoteFields[fieldName];
                if (!remoteField || !remoteField.hlc) continue;

                var localFieldHlc = '';
                if (localItem._fieldHlcs && localItem._fieldHlcs[fieldName]) {
                    localFieldHlc = localItem._fieldHlcs[fieldName];
                } else if (localItem._hlc) {
                    localFieldHlc = localItem._hlc;
                }

                if (HLC.compare(remoteField.hlc, localFieldHlc) >= 0) {
                    localItem[fieldName] = remoteField.v;
                    if (!localItem._fieldHlcs) localItem._fieldHlcs = {};
                    localItem._fieldHlcs[fieldName] = remoteField.hlc;
                }
            }
            if (localItem._fieldHlcs) {
                var maxHlc = localItem._hlc || '';
                var hkeys = Object.keys(localItem._fieldHlcs);
                for (var h = 0; h < hkeys.length; h++) {
                    if (HLC.compare(localItem._fieldHlcs[hkeys[h]], maxHlc) > 0) {
                        maxHlc = localItem._fieldHlcs[hkeys[h]];
                    }
                }
                localItem._hlc = maxHlc;
            }
        },

        /** Full CRDT sync cycle: push local events, then pull remote events */
        _crdtConsecutiveFails: 0,
        _crdtSkipUntil: 0,

        async syncEvents() {
            if (!this.isAuthenticated() || !navigator.onLine) return false;
            // Circuit breaker: if CRDT has failed 3+ times, skip for 2 minutes
            if (this._crdtConsecutiveFails >= 3 && Date.now() < this._crdtSkipUntil) {
                console.log('[CRDT] Circuit breaker open — skipping sync (' + this._crdtConsecutiveFails + ' fails)');
                return false;
            }
            try {
                await this.pushEvents();
                await this.pullEvents();
                this._crdtConsecutiveFails = 0; // reset on success
                return true;
            } catch(err) {
                this._crdtConsecutiveFails++;
                this._crdtSkipUntil = Date.now() + Math.min(300000, 60000 * this._crdtConsecutiveFails); // 1min, 2min, 3min... max 5min
                console.warn('[CRDT] Sync cycle failed (' + this._crdtConsecutiveFails + 'x):', err.message || err);
                return false;
            }
        }};

    // Alias for backward compatibility with CORE
    const RayaAPI = API;




    // =========================================================
    // =========================================================
    // APP CONTROLLER
    // =========================================================
    const App = {
        defer(fn, delay = 0) {
            if (typeof window.requestIdleCallback === 'function') {
                window.requestIdleCallback(fn, { timeout: 1200 });
            } else {
                setTimeout(fn, delay);
            }
        },
        init() {
            CORE.bootstrap();

            // --- CLOUD-FIRST ARCHITECTURE ---
            // If authenticated + online → load ALL data from cloud BEFORE rendering.
            // localStorage is just a cache for offline mode.
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() && navigator.onLine) {
                console.log('[CLOUD-FIRST] ☁ Loading data from server (source of truth)...');
                // Start proactive token refresh timer + keepalive
                API.startProactiveRefresh();
                API.startKeepalive();
                // Show loading overlay
                var appRoot = document.getElementById('app');
                if (appRoot) {
                    appRoot.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;font-family:system-ui;gap:16px;background:#f8fafc;">'
                        + '<div style="width:48px;height:48px;border:4px solid #e2e8f0;border-top-color:#3b82f6;border-radius:50%;animation:spin 0.8s linear infinite;"></div>'
                        + '<div style="color:#64748b;font-size:15px;font-weight:500;">Chargement depuis le serveur...</div>'
                        + '<style>@keyframes spin{to{transform:rotate(360deg)}}</style>'
                        + '</div>';
                }
                // WARMUP: Ping backend (Railway cold start can take 15-25s)
                // 3 attempts with increasing timeouts. If all fail, skip cloud sync → use local cache.
                (async function() {
                    var _warmBase = (API.baseUrl || _API_DEFAULT_URL).replace(/\/api\/?$/, '');
                    var _warmOk = false;
                    var _warmAttempts = 3;
                    var _warmTimeouts = [25000, 30000, 35000]; // Increasing timeouts for Railway cold-start (can take 30s+)

                    async function _pingBackend(timeoutMs) {
                        return new Promise(function(resolve, reject) {
                            var done = false;
                            var timer = setTimeout(function() {
                                if (!done) { done = true; reject(new Error('warmup timeout (' + (timeoutMs/1000) + 's)')); }
                            }, timeoutMs);
                            // Use XMLHttpRequest instead of fetch — avoids Edge Tracking Prevention
                            // blocking cross-origin fetch requests to railway.app
                            var xhr = new XMLHttpRequest();
                            xhr.open('GET', _warmBase + '/api/health', true);
                            xhr.timeout = timeoutMs;
                            xhr.onload = function() {
                                if (!done) { done = true; clearTimeout(timer); resolve(xhr.status); }
                            };
                            xhr.onerror = function() {
                                if (!done) { done = true; clearTimeout(timer); reject(new Error('network error')); }
                            };
                            xhr.ontimeout = function() {
                                if (!done) { done = true; clearTimeout(timer); reject(new Error('xhr timeout')); }
                            };
                            xhr.send();
                        });
                    }

                    // Update loading message to show warmup status
                    var _warmMsg = document.querySelector('#app div div:last-child');
                    var _warmMsgs = ['Démarrage du serveur...', 'Le serveur démarre, veuillez patienter...', 'Dernière tentative...'];

                    for (var _wi = 0; _wi < _warmAttempts; _wi++) {
                        try {
                            console.log('[CLOUD-FIRST] Warmup attempt ' + (_wi + 1) + '/' + _warmAttempts + ' (timeout: ' + (_warmTimeouts[_wi]/1000) + 's)...');
                            if (_warmMsg) _warmMsg.textContent = _warmMsgs[_wi] || 'Connexion au serveur...';
                            if (_wi > 0) {
                                await new Promise(function(r) { setTimeout(r, 2000); }); // 2s gap between retries
                            }
                            var _status = await _pingBackend(_warmTimeouts[_wi]);
                            console.log('[CLOUD-FIRST] Backend ready (' + _status + ')');
                            if (_warmMsg) _warmMsg.textContent = 'Chargement depuis le serveur...';
                            _warmOk = true;
                            break;
                        } catch(_pingErr) {
                            console.warn('[CLOUD-FIRST] Warmup attempt ' + (_wi + 1) + ' failed:', _pingErr.message || 'timeout');
                        }
                    }

                    if (!_warmOk) {
                        console.warn('[CLOUD-FIRST] ⚠ Backend unreachable after ' + _warmAttempts + ' attempts — using local cache');
                        App._cloudFirstDone = true;
                        App._finishInit();
                        return;
                    }
                    // Backend is warm — proceed with sync
                    try {
                        await API.syncEvents();
                        await API.syncAllFromCloud();
                        console.log('[CLOUD-FIRST] ✅ Server data merged into local');
                        CORE.save();
                        console.log('[CLOUD-FIRST] ☁ Pushing local data → server...');
                        await API.syncAllToCloud();
                        console.log('[CLOUD-FIRST] ✅ All data synced ↕ server ↔ client');
                        CORE.clearDirty();
                    } catch(syncErr) {
                        console.warn('[CLOUD-FIRST] ⚠ Server load failed, using local cache:', syncErr.message);
                    }
                    App._cloudFirstDone = true;
                    App._finishInit();
                })();
            } else {
                console.log('[CLOUD-FIRST] Offline or not authenticated → using local cache');
                this._cloudFirstDone = true;
                this._finishInit();

                // --- AUTO-REAUTH: If user exists but no token, try to re-authenticate ---
                if (typeof API !== 'undefined' && navigator.onLine && CORE.state.currentUser && (!API.isAuthenticated || !API.isAuthenticated())) {
                    console.log('[AUTO-REAUTH] User exists but no API token — attempting re-authentication...');
                    (async function() {
                        try {
                            // Step 1: Try refreshing existing token
                            var refreshed = false;
                            if (API._refreshAccessToken) {
                                refreshed = await API._refreshAccessToken();
                                if (refreshed) console.log('[AUTO-REAUTH] Token refreshed ✓');
                            }
                            // Step 2: Try refresh token (stored creds now delegates to refresh)
                            if (!refreshed && API._reLoginWithStoredCreds) {
                                refreshed = await API._reLoginWithStoredCreds();
                                if (refreshed) console.log('[AUTO-REAUTH] Re-login via refresh token ✓');
                            }
                            // SECURITY: No longer stores/uses plaintext passwords or hardcoded activation codes.
                            // If refresh token fails, user must re-login manually.
                            // Step 4: If we got authenticated, do a full sync
                            if (refreshed && API.isAuthenticated && API.isAuthenticated()) {
                                console.log('[AUTO-REAUTH] ✅ Authenticated! Running full cloud sync...');
                                API.startProactiveRefresh();
                                try { await API.syncAllFromCloud(); } catch(e) { console.warn('[AUTO-REAUTH] Pull failed:', e.message); }
                                try { await API.syncAllToCloud(); } catch(e) { console.warn('[AUTO-REAUTH] Push failed:', e.message); }
                                CORE.clearDirty();
                                console.log('[AUTO-REAUTH] ✅ Full sync complete');
                                if (typeof UI !== 'undefined' && UI.toast) UI.toast('☁ Synchronisation cloud activée', 'success', 3000);
                                App.rerender();
                            } else {
                                console.warn('[AUTO-REAUTH] ❌ Could not authenticate à data stays local only');
                            }
                        } catch(err) {
                            console.warn('[AUTO-REAUTH] Error:', err.message || err);
                        }
                    })();
                }
            }
        },

        _finishInit() {
            // Defer heavy boot tasks to avoid blocking first render
            this.defer(() => {
                try { VendeurModule?.init && VendeurModule.init(); } catch(e) { console.warn('[BOOT] VendeurModule.init failed:', e); }
                CORE.reconcileFinance();
                CORE.initDailyDigestScheduler();
                CORE.initPendingArrivalsScheduler();
                if (typeof OfflineManager !== 'undefined') {
                    OfflineManager.init();
                }
                CORE.save();
            }, 0);

            // ESC closes modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') UI.closeModal();
            });

            if (CORE.state.currentUser) {
                this.launchRole(CORE.state.currentUser.role);
                this.rerender();
            } else {
                this.renderOnboarding();
            }

            // --- INVITE LINK DETECTION ---
            // If URL contains ?invite=TOKEN, show a join modal
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const inviteToken = urlParams.get('invite');
                if (inviteToken && inviteToken.length > 10) {
                    console.log('[INVITE] Detected invite token in URL');
                    // Clean URL
                    const cleanUrl = window.location.origin + window.location.pathname;
                    window.history.replaceState({}, '', cleanUrl);
                    // Show join UI after short delay
                    setTimeout(function() { App._showJoinByLink(inviteToken); }, 500);
                }
            } catch(e) { console.warn('[INVITE] URL parse error:', e); }

            // === PERIODIC CLOUD SYNC (P1: smart intervals — PERF OPTIMIZED) ===
            // Light sync every 180s (push dirty + pull critical). Full sync every 5th cycle (~15 min).
            // PERF: Skip when tab hidden. Skip syncFromApi (redundant with syncAllFromCloud).
            this._syncCycleCount = 0;
            // P3-2: Store interval ID so it can be cleared on logout/role-switch
            if (App._syncIntervalId) clearInterval(App._syncIntervalId);
            App._syncIntervalId = setInterval(function() {
                // PERF: Skip sync entirely when tab is not visible (saves massive request volume)
                if (document.visibilityState !== 'visible') return;
                // Auto-reset stuck sync lock after 60s
                if (CORE._isSyncing && CORE._syncStart && (Date.now() - CORE._syncStart > 60000)) {
                    console.warn('[SYNC] Resetting stuck sync lock');
                    CORE._isSyncing = false;
                }
                if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() && CORE.state.isOnline && CORE.state.currentUser && !CORE._isSyncing) {
                    App._syncCycleCount = (App._syncCycleCount || 0) + 1;
                    // PERF: Circuit-breaker — after consecutive failures, skip cycles
                    App._syncFailures = App._syncFailures || 0;
                    if (App._syncFailures >= 6 && App._syncCycleCount % 5 !== 0) {
                        console.log('[SYNC] Circuit-breaker: ' + App._syncFailures + ' failures, skipping cycle #' + App._syncCycleCount);
                        return;
                    }
                    if (App._syncFailures >= 3 && App._syncCycleCount % 3 !== 0) {
                        console.log('[SYNC] Backoff: ' + App._syncFailures + ' failures, skipping cycle #' + App._syncCycleCount);
                        return;
                    }
                    var isFullSync = (App._syncCycleCount % 5 === 0); // Full sync every 5th cycle (~15 min with 180s interval)
                    CORE._isSyncing = true;
                    CORE._syncStart = Date.now();
                    var _cycleT0 = performance.now();

                    // Pre-check: attempt proactive refresh if token is old
                    var tokenAge = Date.now() - (API._tokenSetAt || 0);
                    var refreshPromise = (tokenAge > 45 * 60 * 1000)
                        ? API._refreshAccessToken().catch(function() { return false; })
                        : Promise.resolve(true);

                    refreshPromise.then(function() {
                    if (!API.isAuthenticated()) {
                        console.warn('[SYNC] Auth lost during sync — attempting re-login');
                        return API._reLoginWithStoredCreds().then(function(ok) {
                            if (!ok) { CORE._isSyncing = false; return; }
                        });
                    }

                    if (isFullSync) {
                        // PERF: Full sync = CRDT events + cloud pull + push dirty.
                        // Removed syncFromApi() — it duplicates syncAllFromCloud (saves 7 requests).
                        console.log('[SYNC] Full sync (#' + App._syncCycleCount + ')...');
                        if (typeof SyncIndicator !== 'undefined') SyncIndicator.show('syncing', 'Sync compl\u00e8te...');
                        var _ft0 = performance.now();
                        API.syncEvents().then(function() {
                            console.log('[SYNC-PERF] syncEvents: ' + (performance.now() - _ft0).toFixed(0) + 'ms');
                            var _ft2 = performance.now();
                            return API.syncAllFromCloud(true).then(function(r) { console.log('[SYNC-PERF] syncAllFromCloud: ' + (performance.now() - _ft2).toFixed(0) + 'ms'); return r; });
                        }).then(function() {
                            var _ft3 = performance.now();
                            return API.syncAllToCloud().then(function(r) { console.log('[SYNC-PERF] syncAllToCloud: ' + (performance.now() - _ft3).toFixed(0) + 'ms'); return r; });
                        }).then(function() {
                            console.log('[SYNC] ✅ Full sync complete in ' + (performance.now() - _cycleT0).toFixed(0) + 'ms');
                            if (typeof SyncIndicator !== 'undefined') SyncIndicator.show('success', 'Sync compl\u00e8te');
                            CORE.clearDirty(); // After full sync, everything is clean
                            CORE.clearChangeLog(); // P4: Clear delta log too
                            App._syncFailures = 0; // Reset circuit-breaker
                            // Periodic purge of soft-deleted items (every full sync = ~5min)
                            if (!CORE._lastPurge || Date.now() - CORE._lastPurge > 3600000) {
                                CORE.purgeAllDeleted(30);
                                CORE._lastPurge = Date.now();
                            }
                            CORE._isSyncing = false;
                            App.rerender();
                        }).catch(function(e) {
                            console.warn('[SYNC] Full sync error:', e);
                            if (typeof SyncIndicator !== 'undefined') SyncIndicator.show('error', 'Erreur sync');
                            App._syncFailures = (App._syncFailures || 0) + 1;
                            CORE._isSyncing = false;
                        });
                    } else if (CORE.hasDirty()) {
                        // Light sync: push dirty + pull critical collections (stockTransfers, notifications).
                        var dirtyCount = CORE.getDirtyCollections().length;
                        console.log('[SYNC] Light sync (#' + App._syncCycleCount + ', ' + dirtyCount + ' dirty)...');
                        if (typeof SyncIndicator !== 'undefined') SyncIndicator.show('syncing', dirtyCount + ' collection(s)...');
                        var _lt0 = performance.now();
                        // FIX: Also pull critical collections so incoming transfers appear promptly
                        API._pullCriticalCollections().then(function() {
                            return API.syncDirtyToCloud();
                        }).then(function() {
                            console.log('[SYNC] ✅ Light sync complete in ' + (performance.now() - _lt0).toFixed(0) + 'ms');
                            if (typeof SyncIndicator !== 'undefined') SyncIndicator.show('success', 'Sync OK');
                            App._syncFailures = 0;
                            CORE._isSyncing = false;
                            // Re-render to pick up new transfer notifications from cloud
                            App.rerender();
                        }).catch(function(e) {
                            console.warn('[SYNC] Light sync error:', e);
                            if (typeof SyncIndicator !== 'undefined') SyncIndicator.show('error', 'Erreur sync');
                            App._syncFailures = (App._syncFailures || 0) + 1;
                            CORE._isSyncing = false;
                        });
                    } else {
                        // No dirty data — still pull critical collections for incoming transfers/notifications.
                        var _idleT0 = performance.now();
                        API._pullCriticalCollections().then(function(pulled) {
                            if (pulled) {
                                console.log('[SYNC] Idle pull of critical collections in ' + (performance.now() - _idleT0).toFixed(0) + 'ms');
                                App.rerender();
                            }
                            CORE._isSyncing = false;
                        }).catch(function() { CORE._isSyncing = false; });
                    }
                    }); // end refreshPromise.then
                }
                // --- AUTO-REAUTH in periodic sync: if user but no token, try to re-authenticate ---
                else if (typeof API !== 'undefined' && CORE.state.isOnline && CORE.state.currentUser && !CORE._isSyncing && (!API.isAuthenticated || !API.isAuthenticated())) {
                    // Only attempt every ~2 minutes (every 2nd cycle) to avoid hammering
                    App._reauthAttemptCount = (App._reauthAttemptCount || 0) + 1;
                    if (App._reauthAttemptCount % 2 === 1) {
                        console.log('[SYNC-REAUTH] No API token — attempting auto-authentication (attempt #' + Math.ceil(App._reauthAttemptCount / 2) + ')...');
                        CORE._isSyncing = true;
                        CORE._syncStart = Date.now();
                        (async function() {
                            try {
                                var ok = false;
                                // Try refresh first
                                if (API._refreshAccessToken) ok = await API._refreshAccessToken();
                                // Then stored creds
                                if (!ok && API._reLoginWithStoredCreds) ok = await API._reLoginWithStoredCreds();
                                // Then stored creds (now delegates to refresh token)
                                if (!ok && API._reLoginWithStoredCreds) ok = await API._reLoginWithStoredCreds();
                                // SECURITY: No longer stores/uses plaintext passwords or hardcoded activation codes.
                                // If refresh token fails, user must re-login manually.
                                if (ok && API.isAuthenticated && API.isAuthenticated()) {
                                    console.log('[SYNC-REAUTH] ✅ Authenticated! Running full sync...');
                                    API.startProactiveRefresh();
                                    App._reauthAttemptCount = 0; // Reset counter on success
                                    try { await API.syncAllFromCloud(); } catch(e) { console.warn('[SYNC-REAUTH] syncAllFromCloud failed:', e.message); }
                                    try { await API.syncAllToCloud(); } catch(e) { console.warn('[SYNC-REAUTH] syncAllToCloud failed:', e.message); }
                                    CORE.clearDirty();
                                    CORE.clearChangeLog();
                                    if (typeof UI !== 'undefined' && UI.toast) UI.toast('☁ Synchronisation cloud activée', 'success', 3000);
                                    App.rerender();
                                } else {
                                    console.warn('[SYNC-REAUTH] Could not authenticate. Data stays local.');
                                }
                            } catch(err) { console.warn('[SYNC-REAUTH] Error:', err.message); }
                            CORE._isSyncing = false;
                        })();
                    }
                }
            }, 180000); // PERF: Sync every 180s (3 min) instead of 60s — reduces idle requests by 67%
            // Transfers still appear promptly via visibilityChange pull + forced 500ms push on action

            // SYNC FIX: Pull critical collections immediately when user switches back to this tab
            // This ensures transfers appear right away when a gestionnaire returns to the app
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible' &&
                    typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() &&
                    CORE.state.isOnline && CORE.state.currentUser && !CORE._isSyncing) {
                    // Throttle: don't pull if last pull was < 30s ago
                    var now = Date.now();
                    if (App._lastVisibilityPull && (now - App._lastVisibilityPull < 30000)) return;
                    App._lastVisibilityPull = now;
                    console.log('[SYNC] Tab became visible — pulling critical collections...');
                    CORE._isSyncing = true;
                    CORE._syncStart = now;
                    API._pullCriticalCollections().then(function(pulled) {
                        if (pulled) {
                            console.log('[SYNC] Visibility pull complete — re-rendering');
                            App.rerender();
                        }
                        CORE._isSyncing = false;
                    }).catch(function() { CORE._isSyncing = false; });
                }
            });
        },

        mount(html) { if (!html || html.length < 10) { console.error('[App] mount received empty/tiny html:', html); return; }
            const root = document.getElementById('app');
            root.innerHTML = html;
            if (root.querySelector('[data-requires-chartjs]') && window.Utils && typeof Utils.ensureChartJs === 'function') {
                Utils.ensureChartJs().catch(() => {});
            }
            // PERF: Throttle lucide icon scan — max once per 500ms
            clearTimeout(this._lucideTimer);
            this._lucideTimer = setTimeout(() => {
                if (window.lucide && typeof lucide.createIcons === 'function') lucide.createIcons();
            }, 100);

            // Restaurer le focus et la valeur sur le champ de recherche livreurs si present
            setTimeout(() => {
                const livreursSearchInput = document.getElementById('livreurs-search-input');
                if (livreursSearchInput && VendeurModule?.state?.livreursSearch) {
                    livreursSearchInput.value = VendeurModule.state.livreursSearch;
                    livreursSearchInput.focus();
                }
            }, 10);

            // Apply data-width to elements
            setTimeout(() => {
                document.querySelectorAll('[data-width]').forEach(el => {
                    el.style.width = el.dataset.width + '%';
                });
            }, 50);

            // Render AccountSwitcher section if present (PERF: single deferred call instead of 3)
            setTimeout(() => {
                if (document.getElementById('account-switcher-section') && window.AccountSwitcher) {
                    AccountSwitcher.renderSection();
                }
            }, 200);

            // Show return-to-previous-account floating button if needed
            setTimeout(() => {
                if (window.AccountSwitcher) AccountSwitcher.showReturnButton();
            }, 500);

            // Attacher le gestionnaire du bouton settings
            const settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const role = CORE.state.currentUser?.role;
                    console.log('Settings button clicked, role:', role);
                    try {
                        if (role === 'vendeur') {
                            console.log('Calling VendeurModule.showSettingsModal');
                            VendeurModule.showSettingsModal.call(VendeurModule);
                        }
                        else if (role === 'gestionnaire') GestionnaireModule.showSettingsModal.call(GestionnaireModule);
                        else if (role === 'livreur') LivreurModule.navigateTo('settings');
                        else if (role === 'manager') ManagerModule.showSettingsModal.call(ManagerModule);
                        else if (role === 'pdg') PDGModule.showSettingsModal.call(PDGModule);
                    } catch(err) {
                        console.error('Error opening settings:', err);
                        console.error('Stack:', err.stack);
                        UI.toast('Erreur: ' + err.message, 'error');
                    }
                }, false);
            }

            // Google Maps: init if present in view
            try { Maps.afterRender(); } catch(e) {}
        },

        // --- LAZY LOAD + MISSING METHODS (auto-injected) ---
        _lazyToken: 0,

        getActiveModule() {
            const u = CORE.state.currentUser;
            if (!u || !u.role) return null;
            const map = {
                vendeur: typeof VendeurModule !== 'undefined' ? VendeurModule : null,
                gestionnaire: typeof GestionnaireModule !== 'undefined' ? GestionnaireModule : null,
                manager: typeof ManagerModule !== 'undefined' ? ManagerModule : null,
                pdg: typeof PDGModule !== 'undefined' ? PDGModule : null,
                livreur: typeof LivreurModule !== 'undefined' ? LivreurModule : (typeof CourierModule !== 'undefined' ? CourierModule : null)
            };
            return map[u.role.toLowerCase()] || null;
        },

        getActiveViewKey(mod) {
            if (!mod) return 'dashboard';
            if (mod.state && mod.state.currentView) return mod.state.currentView;
            if (mod.currentView) return mod.currentView;
            return 'dashboard';
        },

        isHeavyView(mod, viewKey) {
            const heavy = ['analytics','analyticsDashboard','reports','rapports',
                           'admin','gestion','managerDashboard','pdgDashboard',
                           'finance','statistiques','stats'];
            if (heavy.includes(viewKey)) return true;
            if (mod && typeof mod.renderAnalyticsDashboard === 'function' && viewKey === 'dashboard') {
                const role = (CORE.state.currentUser && CORE.state.currentUser.role) || '';
                if (['manager','pdg'].includes(role.toLowerCase())) return true;
            }
            return false;
        },

        renderLazyShell(viewKey) {
            const label = viewKey.replace(/([A-Z])/g,' $1').trim();
            return '<div class="lazy-shell" style="padding:2rem;text-align:center">' +
                '<div style="display:inline-block;width:48px;height:48px;border:4px solid var(--primary,#6366f1);border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite"></div>' +
                '<p style="margin-top:1rem;color:#888">Chargement de <strong>' + label + '</strong>...</p>' +
            '</div>';
        },

        launchRole(role) {
            if (!role) role = CORE.state.currentUser && CORE.state.currentUser.role;
            if (!role) { this.renderOnboarding(); return; }
            role = role.toLowerCase().trim();
            // Normalize pos from storeId so all downstream code sees the correct POS
            const cu = CORE.state.currentUser;
            if (cu && !cu.pos && cu.storeId) { cu.pos = String(cu.storeId); }
            const mod = this.getActiveModule();
            if (mod) {
                try { if (typeof mod.applyTheme === 'function') mod.applyTheme(); } catch(e){ console.warn('[APP] Module applyTheme failed:', e); }
                try { if (typeof mod.init === 'function') mod.init(); } catch(e){ console.warn('[APP] Module init failed:', e); }
            }
            this.rerender();

            // PDG: start polling for pending employee requests
            if (role === 'pdg' && typeof API !== 'undefined' && API.isAuthenticated()) {
                App._checkPendingEmployees();
                if (!App._pendingEmployeePoll) {
                    App._pendingEmployeePoll = setInterval(function() {
                        if (API.isAuthenticated() && navigator.onLine && document.visibilityState === 'visible') App._checkPendingEmployees();
                    }, 300000); // PERF: Check every 5 min instead of 60s (saves 8 requests/5min)
                }
            }
        },

        async _checkPendingEmployees() {
            try {
                var [pm, jr] = await Promise.all([
                    API.request('/user-tenants/members/pending', { method: 'GET' }).catch(function() { return []; }),
                    API.request('/invitations/requests', { method: 'GET' }).catch(function() { return []; })
                ]);
                var pendingMembers = Array.isArray(pm) ? pm : [];
                var pendingMemberUserIds = new Set(
                    pendingMembers
                        .map(function(m) { return String(m.userId || m.user_id || ''); })
                        .filter(function(id) { return !!id; })
                );
                var pendingJoinReqs = Array.isArray(jr)
                    ? jr.filter(function(r) {
                        if (r.status !== 'PENDING') return false;
                        var requestUserId = String(r.userId || r.user_id || '');
                        return requestUserId ? !pendingMemberUserIds.has(requestUserId) : true;
                    })
                    : [];
                var total = pendingMembers.length + pendingJoinReqs.length;
                if (total > 0 && total !== App._lastPendingCount) {
                    UI.toast('👥 ' + total + ' employé(s) en attente de validation !', 'info', 8000);
                }
                App._lastPendingCount = total;
                // Store for dashboard banner & trigger re-render if changed
                if (App._pendingEmployeeTotal !== total) {
                    App._pendingEmployeeTotal = total;
                    try { App.rerender(); } catch(e) { console.warn('[POLL] App.rerender failed:', e); }
                }
            } catch(e) { console.warn('[POLL] Pending employee check failed:', e.message || e); }
        },
        _lastPendingCount: 0,
        _pendingEmployeeTotal: 0,
        _pendingEmployeePoll: null,

        // PERF: Debounced rerender — max 1 full render per 300ms
        _rerenderTimer: null,
        _rerenderForce: false,
        rerender(force) {
            if (force) { this._rerenderForce = true; }
            if (this._rerenderTimer) return; // already scheduled
            var self = this;
            this._rerenderTimer = setTimeout(function() {
                self._rerenderTimer = null;
                self._rerenderForce = false;
                self._doRerender();
            }, this._rerenderForce ? 0 : 300);
        },
        _doRerender() {
            var _t0 = performance.now();
            const mod = this.getActiveModule();
            if (!mod || typeof mod.render !== 'function') return;
            const viewKey = this.getActiveViewKey(mod);
            if (this.isHeavyView(mod, viewKey)) {
                var shell = this.renderLazyShell(viewKey);
                this.mount(shell);
                var token = ++this._lazyToken;
                var self = this;
                (window.requestIdleCallback || setTimeout)(function() {
                    if (self._lazyToken !== token) return;
                    try {
                        var html = mod.render();
                        if (self._lazyToken === token) {
                            self.mount(html);
                            console.log('[PERF] rerender (heavy): ' + (performance.now() - _t0).toFixed(0) + 'ms');
                        }
                    } catch(e) { console.error('Lazy render error', e); }
                }, { timeout: 200 });
            } else {
                try {
                    this.mount(mod.render());
                    console.log('[PERF] rerender: ' + (performance.now() - _t0).toFixed(0) + 'ms');
                } catch(e) { console.error('Render error', e); }
            }
        },

        logout() {
            // Fermer tous les modals/widgets ouverts
            try { UI.closeModal(); } catch(e){ console.warn('[LOGOUT] UI.closeModal failed:', e); }

            // === SaaS-grade logout: call backend to revoke session ===
            var sessionId = localStorage.getItem('raya_session_id');
            if (typeof API !== 'undefined' && API.isAuthenticated() && navigator.onLine) {
                API.request('/auth/logout', {
                    method: 'POST',
                    body: sessionId ? { sessionId: sessionId } : {}
                }).catch(function(e) { console.warn('[LOGOUT] Backend logout failed:', e.message); });
            }

            // Clear ALL auth tokens and credentials
            try { localStorage.removeItem('authToken'); } catch(e){}
            try { localStorage.removeItem('refreshToken'); } catch(e){}
            try { localStorage.removeItem('raya_token'); } catch(e){}
            try { localStorage.removeItem('raya_refresh_token'); } catch(e){}
            try { localStorage.removeItem('raya_session_id'); } catch(e){}
            try { localStorage.removeItem('raya_creds'); } catch(e){}  // clear any legacy stored credentials
            try { localStorage.removeItem('raya_api_tokens'); } catch(e){}

            // Stopper l'auto-sync
            try { if (typeof OfflineManager !== 'undefined') OfflineManager.stopAutoSync(); } catch(e){ console.warn('[LOGOUT] OfflineManager.stopAutoSync failed:', e); }
            // P3-2: Clear periodic sync interval
            if (App._syncIntervalId) { clearInterval(App._syncIntervalId); App._syncIntervalId = null; }
            if (App._pendingEmployeePoll) { clearInterval(App._pendingEmployeePoll); App._pendingEmployeePoll = null; }

            // P4: Clear module auto-refresh timers to prevent ghost rerenders
            try { if (typeof PDGModule !== 'undefined' && PDGModule._autoRefreshTimer) { clearInterval(PDGModule._autoRefreshTimer); PDGModule._autoRefreshTimer = null; } } catch(e){}
            try { if (typeof CloudStatusBanner !== 'undefined' && CloudStatusBanner._checkInterval) { clearInterval(CloudStatusBanner._checkInterval); CloudStatusBanner._checkInterval = null; } } catch(e){}

            // Nettoyer l'état utilisateur
            if (CORE.state) CORE.state.currentUser = null;
            CORE.save();

            // Nettoyer le modalContainer résiduel
            try { var mc = document.getElementById('modalContainer'); if (mc) mc.innerHTML = ''; } catch(e){}

            // Hide mobile hamburger, overlay and bottom nav
            try {
                var h = document.querySelector('.mobile-hamburger'); if (h) h.style.display = 'none';
                var o = document.querySelector('.mobile-sidebar-overlay'); if (o) o.style.display = 'none';
                var b = document.querySelector('.mobile-bottom-nav'); if (b) b.style.display = 'none';
            } catch(e){}

            this.renderOnboarding();
        },

        onboarding: {

            step: 1,

            authTab: 'login',  // 'login' ou 'register'

            contact: '',

            otp: '',

            otpSent: false,

            mode: null,

            companyName: '',

            activationCode: '',  // Code d'activation RAYA

            currency: 'FCFA',

            timezone: 'Africa/Abidjan',

            city: '',

            pos: '',

            fullName: '',

            password: '',

            joinCode: ''

        },



        onboardingSet(field, value) {

            if (!this.onboarding) this.onboarding = { step: 1 };

            this.onboarding[field] = value;

        },

        _extractApiErrorMessage(err) {
            try {
                if (err?.data?.message) {
                    return Array.isArray(err.data.message)
                        ? err.data.message.join(', ')
                        : String(err.data.message);
                }
            } catch(e) {}
            var msg = (err && err.message) ? String(err.message) : String(err || 'Erreur inconnue');
            try {
                var parsed = JSON.parse(msg);
                if (parsed?.message) {
                    return Array.isArray(parsed.message)
                        ? parsed.message.join(', ')
                        : String(parsed.message);
                }
            } catch(e) {}
            return msg;
        },

        _isAlreadyPendingError(err) {
            var msg = (this._extractApiErrorMessage(err) || '').toLowerCase();
            return msg.includes('déjà en attente') || msg.includes('deja en attente') || msg.includes('already pending');
        },



        setApiUrl() {

            const current = API.baseUrl || 'http://localhost:3000';

            const url = prompt('URL API', current);

            if (!url) return;

            API.setBaseUrl(url.trim());

            UI.toast('URL API mise � jour', 'success');

        },



        onboardingGo(step) {

            this.onboarding.step = step;

            this.renderOnboarding();

        },







        // Toggle password visibility

        togglePassword(inputId) {

            const input = document.getElementById(inputId);

            if (input) {

                input.type = input.type === 'password' ? 'text' : 'password';

            }

        },





        // Switch between login and register tabs

        switchAuthTab(tab) {

            const loginForm = document.getElementById('login-form');

            const registerForm = document.getElementById('register-form');

            const tabLogin = document.getElementById('tab-login');

            const tabRegister = document.getElementById('tab-register');



            if (tab === 'register') {

                loginForm?.classList.add('hidden');

                registerForm?.classList.remove('hidden');

                tabLogin?.classList.remove('bg-white', 'shadow-sm', 'font-semibold', 'text-slate-900');

                tabLogin?.classList.add('font-medium', 'text-slate-500');

                tabRegister?.classList.add('bg-white', 'shadow-sm', 'font-semibold', 'text-slate-900');

                tabRegister?.classList.remove('font-medium', 'text-slate-500');

            } else {

                loginForm?.classList.remove('hidden');

                registerForm?.classList.add('hidden');

                tabRegister?.classList.remove('bg-white', 'shadow-sm', 'font-semibold', 'text-slate-900');

                tabRegister?.classList.add('font-medium', 'text-slate-500');

                tabLogin?.classList.add('bg-white', 'shadow-sm', 'font-semibold', 'text-slate-900');

                tabLogin?.classList.remove('font-medium', 'text-slate-500');

            }

        },








// Login with Google (OAuth - �� configurer avec votre client ID)

        async loginWithGoogle() {

            UI.toast('Connexion Google en cours...', 'info');

            // En production, utiliser Google OAuth

            // Pour le moment, simulation

            try {

                // Simuler un d�lai r�seau

                await new Promise(r => setTimeout(r, 1000));

                UI.toast('Google OAuth non configur� - Utilisez email/mot de passe', 'warning');

            } catch (e) {

                UI.toast('Erreur Google: ' + e.message, 'error');

            }

        },



        // Login with Apple

        async loginWithApple() {

            UI.toast('Connexion Apple en cours...', 'info');

            try {

                await new Promise(r => setTimeout(r, 1000));

                UI.toast('Apple Sign-In non configur� - Utilisez email/mot de passe', 'warning');

            } catch (e) {

                UI.toast('Erreur Apple: ' + e.message, 'error');

            }

        },



        // Show forgot password modal

        showForgotPassword() {

            UI.modal({

                title: 'R�initialiser le mot de passe',

                icon: 'key',

                content: `

                    <div class="space-y-4">

                        <p class="text-sm text-slate-600">Entrez votre adresse email et nous vous enverrons un lien pour r�initialiser votre mot de passe.</p>

                        <div>

                            <label class="block text-sm font-medium text-slate-700 mb-1.5">Email</label>

                            <input type="email" id="reset-email" placeholder="vous@exemple.com"

                                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500 focus:border-transparent">

                        </div>

                        <button onclick="App.sendPasswordReset()"

                            class="w-full py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold transition-all">

                            Envoyer le lien

                        </button>

                    </div>

                `

            });

        },



        // Send password reset email

        async sendPasswordReset() {

            const email = document.getElementById('reset-email')?.value?.trim();

            if (!email) {

                UI.toast('Veuillez entrer votre email', 'warning');

                return;

            }



            UI.toast('Envoi en cours...', 'info');

            try {

                // API call pour reset password

                if (CORE.state.isOnline) {

                    await API.request('/auth/forgot-password', { method: 'POST', body: { email } });

                }

                UI.closeModal();

                UI.toast('Si un compte existe avec cet email, vous recevrez un lien de r�initialisation.', 'success', 5000);

            } catch (e) {

                // Ne pas r�v�ler si l'email existe ou non (s�curit�)

                UI.closeModal();

                UI.toast('Si un compte existe avec cet email, vous recevrez un lien de r�initialisation.', 'success', 5000);

            }

        },



        // Register with email

        async registerWithEmail() {

            const email = document.getElementById('register-email')?.value?.trim();

            const password = document.getElementById('register-password')?.value;



            if (!email) {

                UI.toast('Veuillez entrer votre email', 'warning');

                return;

            }

            if (!password || password.length < 8) {

                UI.toast('Le mot de passe doit contenir au moins 8 caract��res', 'warning');

                return;

            }



            // Sauvegarder pour l'�tape suivante

            this.onboarding.contact = email;

            this.onboarding.password = password;



            // Passer �� l'�tape 2 (choix: cr�er boutique ou rejoindre)

            this.onboardingGo(2);

        },



        // --- PENDING APPROVAL SCREEN ---
        _showPendingApprovalScreen() {
            const info = App._pendingApproval || {};
            const tenantName = info.tenantName || 'l\'entreprise';
            const role = info.role || 'VENDEUR';
            const firstName = info.firstName || '';

            const html = '<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-50 via-white to-indigo-50 p-4">' +
                '<div class="bg-white rounded-3xl shadow-2xl border border-slate-200 p-8 max-w-md w-full text-center space-y-6">' +
                    '<div class="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto">' +
                        '<svg class="w-10 h-10 text-amber-600 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' +
                    '</div>' +
                    '<h2 class="text-2xl font-black text-slate-900">En attente de validation</h2>' +
                    '<p class="text-slate-600 leading-relaxed">' +
                        'Bonjour <strong>' + firstName + '</strong>, votre demande pour rejoindre <strong>' + tenantName + '</strong> en tant que <strong>' + role + '</strong> est en cours de traitement.' +
                    '</p>' +
                    '<div class="bg-amber-50 border border-amber-200 rounded-2xl p-4">' +
                        '<p class="text-amber-800 text-sm font-bold">⏳ Le PDG ou un Manager doit valider votre accès.</p>' +
                        '<p class="text-amber-600 text-xs mt-1">Vous serez redirigé automatiquement une fois approuvé.</p>' +
                    '</div>' +
                    '<div id="pending-status-dot" class="flex items-center justify-center gap-2 text-sm text-slate-500">' +
                        '<span class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></span> Vérification en cours...' +
                    '</div>' +
                    '<button onclick="App._logoutFromPending()" class="px-6 py-3 bg-slate-200 text-slate-700 font-bold rounded-xl hover:bg-slate-300 transition w-full">Se déconnecter</button>' +
                '</div>' +
            '</div>';

            App.mount(html);

            // Poll every 10 seconds to check if approved
            if (App._pendingPollTimer) clearInterval(App._pendingPollTimer);
            App._pendingPollTimer = setInterval(async () => {
                try {
                    const res = await API.request('/user-tenants/my-status', { method: 'GET' });
                    if (res && res.status === 'ACTIVE') {
                        clearInterval(App._pendingPollTimer);
                        App._pendingPollTimer = null;
                        UI.toast('🎉 Votre accès a été validé !', 'success');
                        const user = CORE.state.currentUser;
                        if (user) {
                            App.launchRole(user.role);
                            App.rerender();
                        } else {
                            location.reload();
                        }
                    } else if (res && res.status === 'INACTIVE') {
                        clearInterval(App._pendingPollTimer);
                        App._pendingPollTimer = null;
                        UI.toast('❌ Votre demande a été refusée.', 'error');
                        App._logoutFromPending();
                    }
                } catch(e) {
                    console.warn('[PENDING] Poll error:', e.message);
                }
            }, 30000); // PERF: 30s instead of 10s (reduces pending-screen requests by 3x)
        },

        _logoutFromPending() {
            if (App._pendingPollTimer) { clearInterval(App._pendingPollTimer); App._pendingPollTimer = null; }
            App._pendingApproval = null;
            API.setToken(null);
            try { localStorage.removeItem('raya_refresh_token'); localStorage.removeItem('raya_session_id'); } catch(e) { console.warn('[AUTH] Failed to clear refresh/session tokens:', e); }
            CORE.state.currentUser = null;
            CORE.save();
            App.state.currentView = 'onboarding';
            App.rerender();
        },

        // Connexion depuis l'onboarding (onglet "Se connecter")

        async onboardingLogin() {
            // P5: Prevent double-submit (onsubmit + onkeypress firing simultaneously)
            if (this._loginInProgress) {
                console.log('[LOGIN] Already in progress — skipping duplicate call');
                return;
            }
            this._loginInProgress = true;
            try {
                return await this._doOnboardingLogin();
            } finally {
                this._loginInProgress = false;
            }
        },

        async _doOnboardingLogin() {
            const emailInput = document.getElementById('login-email');
            const passwordInput = document.getElementById('login-password');
            const errorDiv = document.getElementById('login-error');
            const email = (emailInput?.value || '').trim().toLowerCase();
            const password = (passwordInput?.value || '').trim();

            if (!email || !password) {
                if (errorDiv) { errorDiv.textContent = 'Veuillez entrer votre email et mot de passe'; errorDiv.style.display = 'block'; }
                return;
            }

            // Hide previous error
            if (errorDiv) errorDiv.style.display = 'none';

            // ===== PHASE 1: API login (cloud) =====
            if (CORE.state.isOnline && typeof API !== 'undefined') {
                try {
                    if (errorDiv) { errorDiv.textContent = 'Connexion au serveur...'; errorDiv.style.display = 'block'; errorDiv.style.background = '#eff6ff'; errorDiv.style.color = '#1d4ed8'; errorDiv.style.borderColor = '#93c5fd'; }

                    var apiResult = await API.login(email, password);

                    if (apiResult && apiResult.accessToken) {
                        // Store tokens
                        // API.login() already stored tokens & creds
                        // Ensure refreshToken and sessionId are stored
                        if (apiResult.sessionId) localStorage.setItem('raya_session_id', apiResult.sessionId);

                        var apiUser = apiResult.user || {};
                        var tenantId = apiUser.tenantId || 'default';
                        console.log('[LOGIN] API success:', email, '→ tenant:', tenantId, 'role:', apiUser.role);

                        // Set tenant on API
                        try { API.tenantId = tenantId; } catch(e) { console.warn('[LOGIN] Failed to set API.tenantId:', e); }

                        // Ensure tenant exists locally
                        if (typeof CORE.tenantExists === 'function' && !CORE.tenantExists(tenantId)) {
                            if (typeof CORE.createTenantWithAdmin === 'function') {
                                CORE.createTenantWithAdmin(tenantId, apiUser.tenantName || tenantId, {
                                    name: (apiUser.firstName || '') + ' ' + (apiUser.lastName || ''),
                                    username: apiUser.username || email,
                                    email: apiUser.email || email,
                                    _authMethod: 'api',  // no plaintext password stored
                                    role: (apiUser.role || 'pdg').toLowerCase(),
                                    avatar: ((apiUser.firstName || 'U')[0] + (apiUser.lastName || '')[0]).toUpperCase(),
                                    companyId: tenantId
                                });
                            }
                        }

                        CORE.switchTenant(tenantId);

                        // Find or create user in local DB
                        var localUser = (CORE.db.users || []).find(function(u) { return u.email === (apiUser.email || email) || u.username === (apiUser.username || email); });
                        if (!localUser) {
                            localUser = {
                                id: apiUser.id || CORE.uid(),
                                name: (apiUser.firstName || '') + ' ' + (apiUser.lastName || ''),
                                username: apiUser.username || email,
                                email: apiUser.email || email,
                                _authMethod: 'api',  // no plaintext password stored
                                role: (apiUser.role || 'pdg').toLowerCase(),
                                avatar: ((apiUser.firstName || 'U')[0] + (apiUser.lastName || '')[0]).toUpperCase(),
                                active: true,
                                companyId: tenantId,
                                storeId: apiUser.storeId || null,
                                pos: apiUser.storeId ? String(apiUser.storeId) : null
                            };
                            CORE.db.users.push(localUser);
                        } else {
                            // Update role and company from API
                            localUser.role = (apiUser.role || localUser.role || 'vendeur').toLowerCase();
                            localUser.companyId = tenantId;
                            localUser.storeId = apiUser.storeId || localUser.storeId;
                            localUser.pos = localUser.pos || (localUser.storeId ? String(localUser.storeId) : null);
                        }

                        // Sync data from API — DO IT IN BACKGROUND (don't block login)
                        // PERF: Removed syncFromApi() — syncAllFromCloud already fetches all data.
                        (async function() {
                            try {
                                console.log('[LOGIN] Background sync starting...');
                                await API.syncAllFromCloud();
                                console.log('[LOGIN] syncAllFromCloud done');
                                await API.syncAllToCloud();
                                console.log('[LOGIN] syncAllToCloud done');
                                CORE.save(true);
                                if (typeof App !== 'undefined') App.rerender();
                                UI.toast('☁ Données synchronisées', 'success', 3000);
                            } catch(syncErr) {
                                console.warn('[LOGIN] Background sync failed:', syncErr);
                            }
                        })();

                        // Mark only ESSENTIAL collections dirty — not all (prevents pushing massive payloads)
                        var _essentialCols = ['users', 'pointsOfSale', 'categories', 'products', 'notifications'];
                        for (var dk = 0; dk < _essentialCols.length; dk++) {
                            if (Array.isArray(CORE.db[_essentialCols[dk]]) && CORE.db[_essentialCols[dk]].length > 0) {
                                CORE.markDirty(_essentialCols[dk]);
                            }
                        }

                        if (errorDiv) { errorDiv.style.display = 'none'; }
                        CORE.state.currentUser = localUser;
                        CORE.save(true);

                        // Launch dashboard IMMEDIATELY — don't wait for membership check
                        this.launchRole(localUser.role);
                        this.rerender();
                        var companyName = (typeof CORE.getCompanyName === 'function' ? CORE.getCompanyName() : '') || tenantId;
                        UI.toast('Bienvenue, ' + localUser.name + ' — ' + companyName, 'success');

                        // Use membership status from login response (no extra API call needed)
                        var _ms = apiResult.membershipStatus;
                        if (_ms === 'PENDING') {
                            App._pendingApproval = {
                                tenantName: companyName,
                                role: apiUser.role || 'VENDEUR',
                                firstName: apiUser.firstName || localUser.name,
                                email: email,
                                token: apiResult.accessToken
                            };
                            App._showPendingApprovalScreen();
                        } else if (_ms === 'INACTIVE') {
                            UI.toast('❌ Votre accès a été refusé par l\'administrateur.', 'error');
                            API.setToken(null);
                        }

                        return;
                    } else {
                        // API returned something but no accessToken — unexpected response
                        console.warn('[LOGIN] API returned no token:', apiResult);
                        if (errorDiv) { errorDiv.textContent = '❌ Réponse inattendue du serveur. Réessayez.'; errorDiv.style.display = 'block'; }
                        return;
                    }
                } catch (apiErr) {
                    var errMsg = String(apiErr.message || apiErr || '');
                    var errStatus = apiErr.status || 0;
                    console.warn('[LOGIN] API error:', errMsg, 'status:', errStatus, 'type:', apiErr.name);
                    if (errorDiv) { errorDiv.style.background = ''; errorDiv.style.color = ''; errorDiv.style.borderColor = ''; }

                    // AUTH ERROR (401/403) — wrong credentials or locked account
                    if (errStatus === 401 || errStatus === 403) {
                        // Extract backend error message if available
                        var serverMsg = '';
                        try { serverMsg = apiErr.data?.message || ''; } catch(x){}
                        if (serverMsg && serverMsg.includes('verrouill')) {
                            if (errorDiv) { errorDiv.textContent = '🔒 ' + serverMsg; errorDiv.style.display = 'block'; }
                        } else {
                            if (errorDiv) { errorDiv.textContent = '❌ Email ou mot de passe incorrect'; errorDiv.style.display = 'block'; }
                        }
                        return;
                    }

                    // NETWORK / CORS / TIMEOUT ERROR — server unreachable
                    var isNetworkError = !errStatus || errStatus === 0
                        || apiErr._timeout
                        || apiErr.name === 'TypeError'
                        || errMsg.toLowerCase().includes('fetch')
                        || errMsg.toLowerCase().includes('network')
                        || errMsg.toLowerCase().includes('cors')
                        || errMsg.toLowerCase().includes('abort')
                        || errMsg.toLowerCase().includes('timeout')
                        || errMsg.toLowerCase().includes('net::');

                    if (isNetworkError) {
                        if (errorDiv) { errorDiv.textContent = '⏱ Connexion au serveur en cours... Veuillez patienter.'; errorDiv.style.display = 'block'; errorDiv.style.background = '#fef3c7'; errorDiv.style.color = '#92400e'; errorDiv.style.borderColor = '#fbbf24'; }
                        // Auto-retry once after 5s (Railway cold-start)
                        setTimeout(async function() {
                            try {
                                if (errorDiv) { errorDiv.textContent = '🔄 Nouvelle tentative...'; }
                                var retryResult = await API.login(email, password);
                                if (retryResult && retryResult.accessToken) {
                                    if (errorDiv) errorDiv.style.display = 'none';
                                    App.onboardingLogin();
                                }
                            } catch(retryErr) {
                                if (errorDiv) { errorDiv.textContent = '❌ Serveur injoignable. Vérifiez votre connexion internet et réessayez.'; errorDiv.style.background = '#fef2f2'; errorDiv.style.color = '#991b1b'; errorDiv.style.borderColor = '#fca5a5'; }
                            }
                        }, 5000);
                        return;
                    }

                    // ANY OTHER ERROR — show it and STOP (don't fall through)
                    if (errorDiv) {
                        if (errMsg.length > 120) errMsg = errMsg.substring(0, 120) + '...';
                        errorDiv.textContent = '❌ ' + (errMsg || 'Erreur de connexion');
                        errorDiv.style.display = 'block';
                    }
                    return; // DO NOT fall through to Phase 2 — it would overwrite the real error
                }
            }

            // ===== PHASE 2: Fallback to localStorage (offline mode) =====
            var globalEntry = typeof CORE.findUserGlobal === 'function' ? CORE.findUserGlobal(email, password) : null;
            if (globalEntry) {
                var targetTenant = globalEntry.companyId || 'default';
                console.log('[LOGIN] Global match:', email, '→ tenant:', targetTenant);
                CORE.switchTenant(targetTenant);
                var localUser2 = (CORE.db.users || []).find(function(u) { return (u.username === email || u.email === email) && u.active !== false; });
                if (!localUser2) {
                    if (errorDiv) { errorDiv.textContent = 'Erreur de synchronisation du compte. Contactez un admin.'; errorDiv.style.display = 'block'; errorDiv.style.background = ''; errorDiv.style.color = ''; }
                    return;
                }
                if (errorDiv) errorDiv.style.display = 'none';
                // Normaliser pos depuis storeId
                if (localUser2 && !localUser2.pos && localUser2.storeId) { localUser2.pos = String(localUser2.storeId); }
                CORE.state.currentUser = localUser2;
                CORE.save(true);
                this.launchRole(localUser2.role);
                this.rerender();
                var companyName2 = (typeof CORE.getCompanyName === 'function' ? CORE.getCompanyName() : '') || targetTenant;
                UI.toast('Bienvenue, ' + localUser2.name + ' — ' + companyName2, 'success');
                // ===== AUTO-REGISTER ON BACKEND + CLOUD SYNC =====
                if (CORE.state.isOnline && typeof API !== 'undefined') {
                    (async function() {
                        try {
                            var tok = null;
                            // Try login on backend (account should exist)
                            try {
                                var lr = await API.login(email, password);
                                if (lr && lr.accessToken) { tok = lr.accessToken; console.log('[AUTO-SYNC] Login OK'); }
                            } catch(e1) {
                                console.log('[AUTO-SYNC] Login failed:', e1.message);
                                // SECURITY: No hardcoded activation code. If login fails, user must bootstrap manually.
                            }
                            // If we got a token, sync all data to cloud
                            if (tok) {
                                API.setToken(tok);
                                console.log('[AUTO-SYNC] Syncing all data to cloud...');
                                try { await API.syncAllToCloud(); console.log('[AUTO-SYNC] syncAllToCloud OK'); } catch(e) { console.warn('[AUTO-SYNC] syncAllToCloud err:', e.message); }
                                try { await API.syncAllFromCloud(); console.log('[AUTO-SYNC] syncAllFromCloud OK'); } catch(e) { console.warn('[AUTO-SYNC] syncAllFromCloud err:', e.message); }
                            }
                        } catch(err) { console.warn('[AUTO-SYNC] Error:', err.message || err); }
                    })();
                }
                return;
            }

            // PHASE 3: Try local tenant fallback (plain password match)
            var localFallback = (CORE.db.users || []).find(function(u) { return (u.username === email || u.email === email) && u.active !== false && u.password === password; });
            if (localFallback) {
                console.log('[LOGIN] Local fallback match:', email);
                if (typeof CORE._ensureUsersCompanyId === 'function') CORE._ensureUsersCompanyId();
                if (typeof CORE._syncGlobalFromTenant === 'function') CORE._syncGlobalFromTenant();
                if (typeof CORE.saveGlobal === 'function') CORE.saveGlobal();
                if (errorDiv) errorDiv.style.display = 'none';
                CORE.state.currentUser = localFallback;
                CORE.save(true);
                this.launchRole(localFallback.role);
                this.rerender();
                UI.toast('Bienvenue, ' + localFallback.name + '! (mode hors-ligne)', 'success');
                // ===== AUTO-REGISTER ON BACKEND + CLOUD SYNC =====
                if (CORE.state.isOnline && typeof API !== 'undefined') {
                    (async function() {
                        try {
                            var tok = null;
                            // Try login on backend (no hardcoded activation code)
                            try {
                                var lr = await API.login(email, password);
                                if (lr && lr.accessToken) { tok = lr.accessToken; console.log('[AUTO-SYNC] Login OK'); }
                            } catch(e1) {
                                console.log('[AUTO-SYNC] Login failed:', e1.message);
                                // SECURITY: No hardcoded activation code. User must bootstrap manually.
                            }
                            if (tok) {
                                API.setToken(tok);
                                console.log('[AUTO-SYNC] Syncing all data to cloud...');
                                try { await API.syncAllToCloud(); console.log('[AUTO-SYNC] syncAllToCloud OK'); } catch(e) { console.warn('[AUTO-SYNC] syncAllToCloud err:', e.message); }
                                try { await API.syncAllFromCloud(); console.log('[AUTO-SYNC] syncAllFromCloud OK'); } catch(e) { console.warn('[AUTO-SYNC] syncAllFromCloud err:', e.message); }
                            }
                        } catch(err) { console.warn('[AUTO-SYNC] Error:', err.message || err); }
                    })();
                }
                return;
            }

            // No match at all
            if (errorDiv) {
                // If online but Phase 1 failed silently and Phase 2 found nothing,
                // provide more context than just "incorrect credentials"
                if (CORE.state.isOnline && typeof API !== 'undefined') {
                    errorDiv.textContent = 'Aucun compte trouvé. Vérifiez vos identifiants ou créez un nouveau compte.';
                } else {
                    errorDiv.textContent = 'Mode hors-ligne : aucun compte local trouvé. Connectez-vous à internet pour accéder au serveur.';
                }
                errorDiv.style.display = 'block';
                errorDiv.style.background = '';
                errorDiv.style.color = '';
            }
        },


        // Mode simulation OTP (quand le backend n'a pas l'endpoint)

        _simulatedOtp: null,



        async onboardingSendOtp() {

            const contact = (this.onboarding.contact || '').trim().toLowerCase();

            if (!contact) {

                UI.toast('Veuillez entrer un email ou un t&#233;l&#233;phone', 'warning');

                return;

            }

            if (!CORE.state.isOnline) {

                UI.toast('Connexion requise pour envoyer OTP', 'warning');

                return;

            }

            try {

                const res = await API.sendOtp(contact);

                this.onboarding.otpSent = true;

                this._simulatedOtp = null;

                if (res?.otp) {

                    UI.toast('OTP: ' + res.otp, 'info', 8000);

                    console.log('���? ��� ?� ��? � OTP:', res.otp);

                } else {

                    UI.toast('OTP envoy&#233;', 'success');

                }

            } catch (e) {

                // Backend n'a pas l'endpoint OTP - mode simulation

                if (e.message.includes('404') || e.message.includes('Not Found')) {

                    this._simulatedOtp = String(Math.floor(100000 + Math.random() * 900000));

                    this.onboarding.otpSent = true;

                    UI.toast('Mode D&#233;mo - Votre code OTP: ' + this._simulatedOtp, 'info', 8000);

                    console.log('���? ��� ?� ��? � OTP Simul&#233;:', this._simulatedOtp);

                } else {

                    UI.toast('Erreur OTP: ' + e.message, 'error');

                }

            }

        },



        async onboardingSubmitIdentify() {

            const contact = (this.onboarding.contact || '').trim();

            const otp = (this.onboarding.otp || '').trim();

            if (!contact) {

                UI.toast('Veuillez entrer un email ou un t&#233;l&#233;phone', 'warning');

                return;

            }

            if (!otp) {

                UI.toast('Veuillez entrer le code OTP', 'warning');

                return;

            }



            // Mode simulation - v�rifier l'OTP localement

            if (this._simulatedOtp) {

                if (otp === this._simulatedOtp) {

                    this._simulatedOtp = null;

                    UI.toast('OTP valid&#233; (mode d&#233;mo)', 'success');

                    this.onboardingGo(2);

                } else {

                    UI.toast('Code OTP incorrect', 'error');

                }

                return;

            }



            if (!CORE.state.isOnline) {

                UI.toast('Connexion requise pour v&#233;rifier OTP', 'warning');

                return;

            }

            try {

                await API.verifyOtp(contact, otp);

                this.onboardingGo(2);

            } catch (e) {

                UI.toast('OTP invalide', 'error');

            }

        },



        onboardingChooseMode(mode) {

            this.onboarding.mode = mode;

            this.onboardingGo(mode === 'create' ? 3 : 4);

        },



        async onboardingSubmitCreate() {

            const name = (this.onboarding.companyName || '').trim();

            const fullName = (this.onboarding.fullName || '').trim();

            const password = (this.onboarding.password || '').trim();

            const activationCode = (this.onboarding.activationCode || '').trim();



            if (!activationCode) {

                UI.toast('Veuillez entrer le code d\'activation RAYA', 'warning');

                return;

            }

            if (!name || !fullName || !password) {

                UI.toast('Veuillez renseigner le nom, votre nom et un mot de passe', 'warning');

                return;

            }



            const companyId = Utils.uid('ENT');

            const currency = this.onboarding.currency || 'XOF';

            const timezone = this.onboarding.timezone || 'Africa/Abidjan';

            const contact = (this.onboarding.contact || '').trim();

            const username = contact.includes('@') ? contact.split('@')[0] : (contact || Utils.uid('USER'));



            // Parse fullName into firstName and lastName

            const nameParts = fullName.trim().split(' ');

            const firstName = nameParts[0] || '';

            const lastName = nameParts.slice(1).join(' ') || '';



            if (CORE.state.isOnline) {

                try {

                    // Utiliser l'endpoint bootstrap avec code d'activation

                    UI.toast('Cr�ation de l\'entreprise avec RAYA...', 'info');

                    const res = await API.bootstrap({

                        activationCode,

                        tenantName: name,

                        email: contact,

                        password,

                        firstName,

                        lastName,

                        currency,

                        timezone,

                        city: (this.onboarding.city || '').trim(),

                        storeName: (this.onboarding.pos || '').trim()

                    });



                    const tenantId = res?.tenant?.id || res?.user?.tenantId;

                    const tenantCode = res?.tenant?.code;

                    const token = res?.accessToken;



                    console.log('Bootstrap r�ussi:', res);



                    if (token) {

                        API.setToken(token);

                    }



                    // Sauvegarder localement

                    const user = CORE.create('users', {

                        name: fullName,

                        username,

                        email: contact,

                        _authMethod: 'api',  // no plaintext password stored

                        role: 'pdg',

                        active: true,

                        pendingApproval: false,

                        companyId: String(tenantId),

                        permissions: []

                    });



                    CORE.state.currentUser = user;

                    CORE.db.systemConfig = CORE.db.systemConfig || {};

                    CORE.db.systemConfig.appName = name;

                    CORE.db.systemConfig.currency = currency;

                    CORE.db.systemConfig.timezone = timezone;

                    CORE.db.systemConfig.companyId = String(tenantId);

                    CORE.db.systemConfig.tenantCode = tenantCode;



                    // Créer le POS localement à partir de la réponse bootstrap

                    if (res?.store) {

                        const storeCityName = (res.store.city || (this.onboarding.city || '').trim() || '').trim();
                        CORE.db.cities = CORE.db.cities || [];
                        let cityId = null;
                        if (storeCityName) {
                            let cityEntry = CORE.db.cities.find(function(c) {
                                return String(c.name || '').trim().toLowerCase() === storeCityName.toLowerCase();
                            });
                            if (!cityEntry) {
                                const cityIds = CORE.db.cities.map(function(c) { return Number(c.id) || 0; });
                                const nextCityId = (cityIds.length > 0 ? Math.max.apply(null, cityIds) : 0) + 1;
                                cityEntry = { id: nextCityId, name: storeCityName, country: 'Congo' };
                                CORE.db.cities.push(cityEntry);
                            }
                            cityId = cityEntry.id;
                        }

                        CORE.db.stores = CORE.db.stores || [];

                        if (!CORE.db.stores.find(function(s) { return String(s.id) === String(res.store.id); })) {
                            CORE.db.stores.push({

                                id: String(res.store.id),

                                _apiId: String(res.store.id),

                                _apiSynced: true,

                                name: res.store.name,

                                storeCode: res.store.storeCode,

                                city: storeCityName,

                                type: res.store.type || 'MAIN',

                                isActive: true,

                                isDefault: true,

                                tenantId: String(tenantId),

                                companyId: String(tenantId)

                            });

                        }

                        CORE.db.pointsOfSale = CORE.db.pointsOfSale || [];
                        if (!(CORE.db.pointsOfSale || []).find(function(p) { return String(p.id) === String(res.store.id); })) {
                            CORE.db.pointsOfSale.push({
                                id: String(res.store.id),
                                _apiId: String(res.store.id),
                                _apiSynced: true,
                                name: res.store.name,
                                cityId: cityId,
                                employees: 1,
                                phone: null,
                                address: null,
                                isActive: true,
                                isDefault: true,
                                tenantId: String(tenantId),
                                companyId: String(tenantId)
                            });
                        }

                        if (typeof CORE.initializePOSData === 'function') {
                            CORE.initializePOSData(String(res.store.id), { forceReset: true });
                        }


                        user.pos = String(res.store.id);

                        user.storeId = String(res.store.id);

                    }

                    CORE.save();



                    this.launchRole('pdg');

                    this.rerender();

                    console.info('onboardingSubmitCreate - launched role pdg, App.state.currentView =', this.state.currentView, 'CORE.state.currentUser.role =', CORE.state.currentUser?.role);

                    UI.toast('Entreprise cr��e avec succ�s! Bienvenue ' + firstName + '!', 'success');

                    return;

                } catch (e) {

                    console.error('Bootstrap failed:', e);

                    if (e.message?.includes('activation') || e.message?.includes('Code')) {

                        UI.toast('Code d\'activation invalide. Contactez RAYA pour obtenir un code.', 'error');

                        return;

                    }

                    if (e.message?.includes('existe') || e.message?.includes('exist')) {

                        UI.toast('Cette adresse email est d�j� utilis�e', 'error');

                        return;

                    }

                    UI.toast('Erreur: ' + e.message, 'error');

                    return;

                }

            } else {

                UI.toast('Connexion internet requise pour cr�er une entreprise', 'warning');

                return;

            }

        },



        async onboardingSubmitJoin() {

            const code = (this.onboarding.joinCode || '').trim();

            const fullName = (this.onboarding.fullName || '').trim();

            const password = (this.onboarding.password || '').trim();

            const contact = (this.onboarding.contact || '').trim();



            if (!code || !fullName || !password || !contact) {

                UI.toast('Veuillez renseigner tous les champs (code, email, nom, mot de passe)', 'warning');

                return;

            }



            if (password.length < 8) {

                UI.toast('Le mot de passe doit contenir au moins 8 caractères', 'warning');

                return;

            }



            // Parser le nom complet en firstName et lastName

            const nameParts = fullName.split(' ');

            const firstName = nameParts[0] || fullName;

            const lastName = nameParts.slice(1).join(' ') || '';



            if (CORE.state.isOnline) {

                try {

                    // 1. Valider le code d'invitation pour obtenir tenantId et role

                    UI.toast('Validation du code...', 'info');

                    const validateRes = await API.request('/invitations/validate/' + code.toUpperCase(), { method: 'GET' });



                    if (!validateRes.valid) {

                        UI.toast('Code invalide ou expiré. Vérifiez le code et réessayez.', 'error');

                        return;

                    }



                    const tenantId = validateRes.tenantId;

                    const tenantName = validateRes.tenantName || '';

                    const role = validateRes.role || 'VENDEUR';

                    const inviteStoreId = validateRes.storeId || '';



                    // 2. S'inscrire avec le tenantId et role de l'invitation (non-fatal si compte existe déjà)

                    let registerRes = null;

                    try {

                        UI.toast('Création du compte...', 'info');

                        registerRes = await API.register({

                            email: contact,

                            password,

                            firstName,

                            lastName,

                            tenantId: String(tenantId),

                            role

                        });

                        console.log('[JOIN] Register OK');

                    } catch(regErr) {

                        console.warn('[JOIN] Register skipped (account may exist):', regErr.message);

                        // Account already exists — continue to login with provided credentials

                    }



                    // 3. Se connecter

                    UI.toast('Connexion...', 'info');

                    const loginRes = await API.login(contact, password);

                    if (!loginRes?.accessToken && !loginRes?.access_token) {

                        throw new Error('Échec de connexion. Vérifiez votre email et mot de passe.');

                    }

                    const token = loginRes?.accessToken || loginRes?.access_token;

                    API.setToken(token);

                    console.log('[JOIN] Login OK, token set');

                    if (loginRes?.refreshToken) {

                        try { localStorage.setItem('raya_refresh_token', loginRes.refreshToken); } catch(e) { console.warn('[AUTH] Failed to store refresh token:', e); }

                    }

                    if (loginRes?.sessionId) {

                        try { localStorage.setItem('raya_session_id', loginRes.sessionId); } catch(e) { console.warn('[AUTH] Failed to store session ID:', e); }

                    }



                    // 4. CRITICAL: Use the invitation code -> creates membership + marks invitation as used

                    UI.toast('Activation de l\'invitation...', 'info');

                    let usedStoreId = inviteStoreId;
                    let invitationActivated = false;
                    let joinRequestCreated = false;
                    let joinRequestAlreadyPending = false;

                    try {

                        const useRes = await API.request('/invitations/use/' + code.toUpperCase(), { method: 'POST' });

                        console.log('[JOIN] Invitation used:', useRes);
                        invitationActivated = true;

                        // Extract storeId from the used invitation response

                        if (useRes?.invitation?.storeId) usedStoreId = useRes.invitation.storeId;

                        else if (useRes?.invitation?.store_id) usedStoreId = useRes.invitation.store_id;

                    } catch(useErr) {

                        var useMsg = App._extractApiErrorMessage(useErr);
                        console.warn('[JOIN] use invitation error:', useMsg);

                    }

                    // 4b. Create join request ONLY as fallback if /invitations/use/ failed
                    if (!invitationActivated) {
                        try {
                            await API.request('/invitations/join-requests', {
                                method: 'POST',
                                body: { tenantId: String(tenantId), requestedRole: role, message: 'Rejoint via code d\'invitation: ' + code.toUpperCase() }
                            });
                            joinRequestCreated = true;
                            console.log('[JOIN] Join request created as fallback (invitation use failed)');
                        } catch(jrErr) {
                            var jrMsg = App._extractApiErrorMessage(jrErr);
                            joinRequestAlreadyPending = App._isAlreadyPendingError(jrErr);
                            console.warn('[JOIN] Join request creation skipped:', jrMsg);
                        }
                    }

                    if (!invitationActivated && !joinRequestCreated && !joinRequestAlreadyPending) {
                        throw new Error('Impossible de finaliser la demande d\'adhésion. Veuillez réessayer avec un nouveau code ou contacter le PDG.');
                    }

                    // 5. Resolve user info from login response (fallback to invitation storeId since membership is created AFTER login)

                    const apiUser = loginRes?.user || registerRes?.user || {};

                    const storeId = apiUser.storeId || loginRes?.user?.storeId || usedStoreId || null;



                    // 6. Set API tenant

                    try { API.tenantId = String(tenantId); } catch(e) { console.warn('[AUTH] Failed to set API.tenantId:', e); }



                    // 7. Ensure tenant exists locally

                    if (typeof CORE.tenantExists === 'function' && !CORE.tenantExists(String(tenantId))) {

                        if (typeof CORE.createTenantWithAdmin === 'function') {

                            CORE.createTenantWithAdmin(String(tenantId), tenantName || String(tenantId), {

                                name: fullName, username: contact.split('@')[0], email: contact,

                                _authMethod: 'api', role: role.toLowerCase(),

                                avatar: (firstName[0] + (lastName[0] || '')).toUpperCase(), companyId: String(tenantId)

                            });

                        }

                    }

                    CORE.switchTenant(String(tenantId));



                    // 8. Find or create user in local DB

                    var normalizedContact = String(contact || '').toLowerCase().trim();
                    var localUser = (CORE.db.users || []).find(function(u) {
                        var email = String(u.email || '').toLowerCase().trim();
                        var username = String(u.username || '').toLowerCase().trim();
                        return email === normalizedContact || username === normalizedContact;
                    });

                    if (!localUser) {

                        localUser = CORE.create('users', {

                            name: fullName, firstName, lastName, email: contact,

                            _authMethod: 'api', role: role.toLowerCase(),

                            active: true, pendingApproval: false,

                            companyId: String(tenantId), storeId: storeId,

                            pos: storeId ? String(storeId) : null,

                            avatar: (firstName[0] + (lastName[0] || '')).toUpperCase()

                        });

                    } else {

                        localUser.role = role.toLowerCase();

                        localUser.companyId = String(tenantId);

                        localUser.storeId = storeId;

                        localUser.pos = localUser.pos || (storeId ? String(storeId) : null);

                    }



                    CORE.state.currentUser = localUser;

                    CORE.db.systemConfig = CORE.db.systemConfig || {};

                    CORE.db.systemConfig.companyId = String(tenantId);

                    CORE.db.systemConfig.tenantName = tenantName;

                    CORE.save();

                    // Synchroniser les données de l'entreprise depuis le cloud
                    try {
                        await RayaAPI.syncAllFromCloud();
                        console.log('[JOIN] Cloud data synced after invitation join');
                    } catch(syncErr) {
                        console.warn('[JOIN] Cloud sync after join failed:', syncErr.message);
                    }

                    // 9. Show pending approval screen — employee must wait for PDG validation
                    App._pendingApproval = {
                        tenantName: tenantName || String(tenantId),
                        role: role,
                        firstName: firstName,
                        email: contact,
                        token: loginRes?.accessToken
                    };
                    App._showPendingApprovalScreen();
                    UI.toast('✅ Inscription réussie ! En attente de validation par le PDG.', 'success');

                    return;

                } catch (e) {

                    console.error('[JOIN] Failed:', e);

                    UI.toast('Erreur: ' + App._extractApiErrorMessage(e), 'error');

                }

            }



            // Fallback local

            const company = (CORE.db.companies || []).find(c => c.id === code || c.name === code);



            const pendingUser = CORE.create('users', {

                name: fullName,

                firstName,

                lastName,

                email: contact,

                _authMethod: 'api',  // no plaintext password stored

                role: 'vendeur',

                active: false,

                pendingApproval: true,

                companyId: company?.id || null

            });



            CORE.db.joinRequests = CORE.db.joinRequests || [];

            CORE.db.joinRequests.push({

                id: Utils.uid('JOIN'),

                contact,

                code,

                userId: pendingUser.id,

                status: 'pending',

                createdAt: new Date().toISOString()

            });

            CORE.save();

            UI.toast('Demande envoyee. En attente de validation.', 'success');

            this.onboardingGo(2);

        },

        // --- JOIN BY INVITATION LINK ---
        async _showJoinByLink(token) {
            try {
                // First validate the token to get invitation info
                const resp = await API.request('/invitations/link/' + token, { method: 'GET' }).catch(() => null);
                const invitation = resp?.invitation || resp;
                const tenantName = invitation?.tenantName || invitation?.tenant?.name || 'une entreprise';
                const role = invitation?.role || 'VENDEUR';
                const invCode = invitation?.invitationCode || invitation?.invitation_code || '';

                UI.modal('📨 Invitation reçue', '<div class="space-y-4">' +
                    '<div class="p-4 bg-purple-50 border border-purple-200 rounded-2xl text-center">' +
                        '<div class="text-lg font-black text-purple-800">Vous êtes invité à rejoindre</div>' +
                        '<div class="text-2xl font-black text-slate-900 mt-2">' + tenantName + '</div>' +
                        '<div class="text-sm text-purple-600 mt-1">Rôle : <b>' + role + '</b></div>' +
                    '</div>' +
                    (CORE.state.currentUser
                        ? '<p class="text-slate-600 text-sm text-center">Cliquez sur "Rejoindre" pour accéder à cette entreprise.</p>'
                        : '<p class="text-slate-600 text-sm text-center">Connectez-vous d\'abord, puis utilisez le code <b>' + invCode + '</b> pour rejoindre.</p>') +
                '</div>', [
                    CORE.state.currentUser
                        ? { label: '✅ Rejoindre', onclick: 'App._acceptInviteLink("' + token + '","' + invCode + '")', class: 'px-4 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition' }
                        : { label: '🔑 Se connecter', onclick: 'UI.closeModal(); App.renderOnboarding()', class: 'px-4 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition' },
                    { label: 'Fermer', onclick: 'UI.closeModal()' }
                ]);
            } catch(e) {
                UI.modal('❌ Invitation invalide', '<div class="p-4 bg-red-50 border border-red-200 rounded-xl text-center">' +
                    '<p class="text-red-700 font-bold">Ce lien d\'invitation est invalide ou a expiré.</p></div>', [
                    { label: 'OK', onclick: 'UI.closeModal()' }
                ]);
            }
        },

        async _acceptInviteLink(token, code) {
            UI.closeModal();
            try {
                await API.request('/invitations/use/' + code, { method: 'POST' });
                // /invitations/use/ already creates the pending membership — no need for a separate join request
                UI.toast('🎉 Vous avez rejoint l\'entreprise ! En attente de validation par le PDG.', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } catch(e) {
                UI.toast('Erreur: ' + App._extractApiErrorMessage(e), 'error');
            }
        },


        renderOnboarding() {
            const step = this.onboarding.step || 1;
            const tab = this.onboarding.authTab || 'login';
            const isLogin = tab === 'login';

            const leftPanel = `
                <div class="auth-left">
                    <div class="auth-branding">
                        <h1>🚀 RAYA</h1>
                        <p>La plateforme de gestion d'entreprise nouvelle génération. Gérez vos ventes, stocks, livraisons et équipes en temps réel depuis n'importe où.</p>
                        <div class="auth-features">
                            <div class="auth-feature">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                                Multi-entreprises
                            </div>
                            <div class="auth-feature">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                                Multi-utilisateurs
                            </div>
                            <div class="auth-feature">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                100% Sécurisé
                            </div>
                            <div class="auth-feature">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                                Temps réel
                            </div>
                        </div>
                    </div>
                </div>`;

            const logo = `
                <div class="auth-logo">
                    <div class="auth-logo-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                    </div>
                    <span class="auth-logo-text">RAYA</span>
                </div>`;

            let rightContent = '';

            // ====== STEP 1: Login / Register ======
            if (step === 1) {
                rightContent = `
                    ${logo}
                    <div class="auth-header">
                        <h2>${isLogin ? 'Bienvenue' : 'Créer un compte'}</h2>
                        <p>${isLogin ? 'Connectez-vous pour continuer' : 'Rejoignez RAYA en quelques secondes'}</p>
                    </div>

                    <div class="auth-tab-switcher">
                        <button class="auth-tab-btn ${isLogin ? 'active' : ''}" onclick="App.onboarding.authTab='login'; App.renderOnboarding()" type="button">Connexion</button>
                        <button class="auth-tab-btn ${!isLogin ? 'active' : ''}" onclick="App.onboarding.authTab='register'; App.renderOnboarding()" type="button">Inscription</button>
                    </div>

                    <div class="social-buttons">
                        <button class="btn-social" type="button" onclick="App.loginWithGoogle()">
                            <svg viewBox="0 0 24 24" width="20" height="20">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Continuer avec Google
                        </button>
                        <button class="btn-social btn-apple" type="button" onclick="App.loginWithApple()">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                            </svg>
                            Continuer avec Apple
                        </button>
                    </div>

                    <div class="auth-divider">ou</div>

                    <div id="login-error" class="auth-error"></div>

                    ${isLogin ? `
                    <form class="auth-form" onsubmit="event.preventDefault(); App.onboardingLogin()">
                        <div class="form-group">
                            <label for="login-email">Adresse email</label>
                            <input type="email" id="login-email" class="form-input" placeholder="vous@exemple.com" required autocomplete="email">
                        </div>
                        <div class="form-group">
                            <label for="login-password">Mot de passe</label>
                            <div class="input-wrapper">
                                <input type="password" id="login-password" class="form-input has-icon" placeholder="••••••••" required autocomplete="current-password" onkeypress="if(event.key==='Enter') App.onboardingLogin()">
                                <button type="button" class="input-toggle" onclick="App.togglePassword('login-password')">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-options">
                            <label class="checkbox-wrapper">
                                <input type="checkbox">
                                <span>Se souvenir de moi</span>
                            </label>
                            <a href="#" class="link-forgot" onclick="event.preventDefault(); App.showForgotPassword()">Mot de passe oublié ?</a>
                        </div>
                        <button type="submit" class="btn-submit">Se connecter</button>
                    </form>
                    <div class="auth-footer">
                        Pas encore de compte ? <a href="#" onclick="event.preventDefault(); App.onboarding.authTab='register'; App.renderOnboarding()">S'inscrire</a>
                    </div>
                    ` : `
                    <form class="auth-form" onsubmit="event.preventDefault(); App.registerWithEmail()">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="reg-firstName">Prénom</label>
                                <input type="text" id="reg-firstName" class="form-input" placeholder="Jean" required oninput="App.onboardingSet('firstName', this.value)">
                            </div>
                            <div class="form-group">
                                <label for="reg-lastName">Nom</label>
                                <input type="text" id="reg-lastName" class="form-input" placeholder="Dupont" required oninput="App.onboardingSet('lastName', this.value)">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="register-email">Adresse email</label>
                            <input type="email" id="register-email" class="form-input" placeholder="vous@exemple.com" required oninput="App.onboardingSet('contact', this.value)">
                        </div>
                        <div class="form-group">
                            <label for="reg-phone">Téléphone (optionnel)</label>
                            <input type="tel" id="reg-phone" class="form-input" placeholder="+XXX XX XXX XX XX" oninput="App.onboardingSet('phone', this.value)">
                        </div>
                        <div class="form-group">
                            <label for="register-password">Mot de passe</label>
                            <div class="input-wrapper">
                                <input type="password" id="register-password" class="form-input has-icon" placeholder="Minimum 8 caractères" required minlength="8" oninput="App.onboardingSet('password', this.value)">
                                <button type="button" class="input-toggle" onclick="App.togglePassword('register-password')">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                </button>
                            </div>
                        </div>
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="accept-terms" required>
                            <span>J'accepte les <a href="#" style="color:#667eea">Conditions d'utilisation</a></span>
                        </label>
                        <button type="submit" class="btn-submit">Créer mon compte</button>
                    </form>
                    <div class="auth-footer">
                        Déjà un compte ? <a href="#" onclick="event.preventDefault(); App.onboarding.authTab='login'; App.renderOnboarding()">Se connecter</a>
                    </div>
                    `}

                    <div style="border-top:1px solid #e5e7eb; margin-top:1rem; padding-top:1rem; text-align:center">
                        <span style="font-size:0.875rem; color:#64748b">Code d'invitation ? </span>
                        <a href="#" onclick="event.preventDefault(); App.onboardingGo(4)" style="font-size:0.875rem; color:#667eea; font-weight:600">Rejoindre une équipe</a>
                    </div>
                `;
            }

            // ====== STEP 2: Choose Create or Join ======
            else if (step === 2) {
                rightContent = `
                    ${logo}
                    <div class="auth-header">
                        <h2>Que voulez-vous faire ?</h2>
                        <p>Créez votre entreprise ou rejoignez une équipe existante</p>
                    </div>
                    <div style="display:grid; gap:1rem; margin:1.5rem 0">
                        <button type="button" onclick="App.onboardingChooseMode('create')" style="display:flex; align-items:flex-start; gap:1rem; padding:1.25rem; border:2px solid #e2e8f0; border-radius:1rem; background:white; cursor:pointer; text-align:left; transition:all .2s" onmouseover="this.style.borderColor='#667eea'" onmouseout="this.style.borderColor='#e2e8f0'">
                            <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;flex-shrink:0">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:700;color:#0f172a;font-size:1rem">Créer une entreprise</div>
                                <div style="color:#64748b;font-size:0.875rem;margin-top:4px">Devenez PDG et configurez votre boutique</div>
                            </div>
                        </button>
                        <button type="button" onclick="App.onboardingChooseMode('join')" style="display:flex; align-items:flex-start; gap:1rem; padding:1.25rem; border:2px solid #e2e8f0; border-radius:1rem; background:white; cursor:pointer; text-align:left; transition:all .2s" onmouseover="this.style.borderColor='#667eea'" onmouseout="this.style.borderColor='#e2e8f0'">
                            <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#f093fb,#f5576c);display:flex;align-items:center;justify-content:center;flex-shrink:0">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            </div>
                            <div>
                                <div style="font-weight:700;color:#0f172a;font-size:1rem">Rejoindre une entreprise</div>
                                <div style="color:#64748b;font-size:0.875rem;margin-top:4px">Entrez un code ou un lien d'invitation</div>
                            </div>
                        </button>
                    </div>
                    <button type="button" class="btn-submit" style="background:#f1f5f9;color:#475569;margin-top:0.5rem" onclick="App.onboardingGo(1)">← Retour</button>
                `;
            }

            // ====== STEP 3: Create Enterprise ======
            else if (step === 3) {
                rightContent = `
                    ${logo}
                    <div class="auth-header">
                        <h2>Créer votre entreprise</h2>
                        <p>Configurez votre espace de travail</p>
                    </div>
                    <div style="max-height:55vh;overflow-y:auto;padding-right:4px">
                    <form class="auth-form" onsubmit="event.preventDefault(); App.onboardingSubmitCreate()">
                        <div class="form-group" style="padding:1rem;background:linear-gradient(135deg,#f0fdf4,#ecfdf5);border:2px solid #10b981;border-radius:0.75rem">
                            <label for="activationCode" style="font-weight:700;color:#065f46">🔑 Code d'activation RAYA *</label>
                            <input id="activationCode" type="text" class="form-input" placeholder="Entrez votre code" required style="text-align:center;font-size:1.1rem;font-weight:700;letter-spacing:3px;text-transform:uppercase" oninput="App.onboardingSet('activationCode', this.value.toUpperCase())">
                            <small style="color:#059669;font-size:0.75rem">Entrez le code fourni par RAYA</small>
                        </div>
                        <div class="form-group">
                            <label for="companyName">🏪 Nom de l'entreprise *</label>
                            <input id="companyName" type="text" class="form-input" placeholder="Ex: Ma Boutique Pro" required oninput="App.onboardingSet('companyName', this.value)">
                        </div>
                        <div class="form-group">
                            <label for="fullName">👤 Votre nom complet *</label>
                            <input id="fullName" type="text" class="form-input" placeholder="Nom complet" required oninput="App.onboardingSet('fullName', this.value)">
                        </div>
                        <div class="form-group">
                            <label for="companyPassword">🔒 Mot de passe *</label>
                            <div class="input-wrapper">
                                <input id="companyPassword" type="password" class="form-input has-icon" placeholder="••••••••" required oninput="App.onboardingSet('password', this.value)">
                                <button type="button" class="input-toggle" onclick="App.togglePassword('companyPassword')">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>💱 Devise</label>
                                <select class="form-input" onchange="App.onboardingSet('currency', this.value)">
                                    <optgroup label="Afrique">
                                        <option value="XOF">XOF - Franc CFA (UEMOA)</option>
                                        <option value="XAF">XAF - Franc CFA (CEMAC)</option>
                                        <option value="NGN">NGN - Naira nigérian</option>
                                        <option value="ZAR">ZAR - Rand sud-africain</option>
                                        <option value="KES">KES - Shilling kényan</option>
                                        <option value="GHS">GHS - Cédi ghanéen</option>
                                        <option value="MAD">MAD - Dirham marocain</option>
                                        <option value="EGP">EGP - Livre égyptienne</option>
                                        <option value="TZS">TZS - Shilling tanzanien</option>
                                        <option value="CDF">CDF - Franc congolais</option>
                                        <option value="RWF">RWF - Franc rwandais</option>
                                        <option value="MGA">MGA - Ariary malgache</option>
                                    </optgroup>
                                    <optgroup label="International">
                                        <option value="EUR">EUR - Euro</option>
                                        <option value="USD">USD - Dollar US</option>
                                        <option value="GBP">GBP - Livre sterling</option>
                                        <option value="CAD">CAD - Dollar canadien</option>
                                        <option value="CHF">CHF - Franc suisse</option>
                                        <option value="CNY">CNY - Yuan chinois</option>
                                        <option value="JPY">JPY - Yen japonais</option>
                                        <option value="AED">AED - Dirham EAU</option>
                                        <option value="SAR">SAR - Riyal saoudien</option>
                                        <option value="BRL">BRL - Réal brésilien</option>
                                        <option value="INR">INR - Roupie indienne</option>
                                        <option value="TRY">TRY - Livre turque</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>🌍 Fuseau horaire</label>
                                <select class="form-input" onchange="App.onboardingSet('timezone', this.value)">
                                    <option value="Africa/Abidjan">Abidjan (UTC+0)</option>
                                    <option value="Africa/Lagos">Lagos (UTC+1)</option>
                                    <option value="Africa/Douala">Douala (UTC+1)</option>
                                    <option value="Africa/Nairobi">Nairobi (UTC+3)</option>
                                    <option value="Africa/Johannesburg">Johannesburg (UTC+2)</option>
                                    <option value="Africa/Casablanca">Casablanca (UTC+1)</option>
                                    <option value="Europe/Paris">Paris (UTC+1)</option>
                                    <option value="Europe/London">Londres (UTC+0)</option>
                                    <option value="America/New_York">New York (UTC-5)</option>
                                    <option value="Asia/Dubai">Dubaï (UTC+4)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>📍 Ville</label>
                                <input type="text" class="form-input" placeholder="Abidjan" oninput="App.onboardingSet('city', this.value)">
                            </div>
                            <div class="form-group">
                                <label>🏬 Point de vente</label>
                                <input type="text" class="form-input" placeholder="Boutique Plateau" oninput="App.onboardingSet('pos', this.value)">
                            </div>
                        </div>
                        <button type="submit" class="btn-submit">Créer l'entreprise</button>
                    </form>
                    </div>
                    <button type="button" class="btn-submit" style="background:#f1f5f9;color:#475569;margin-top:0.5rem" onclick="App.onboardingGo(2)">← Retour</button>
                `;
            }

            // ====== STEP 4: Join Enterprise ======
            else if (step === 4) {
                const prefillEmail = this.onboarding.contact || '';
                rightContent = `
                    ${logo}
                    <div class="auth-header">
                        <h2>Rejoindre une entreprise</h2>
                        <p>Entrez le code d'invitation fourni par votre employeur</p>
                    </div>
                    <form class="auth-form" onsubmit="event.preventDefault(); App.onboardingSubmitJoin()">
                        <div class="form-group">
                            <label for="joinCode">🔗 Code d'invitation *</label>
                            <input id="joinCode" type="text" class="form-input" placeholder="EX: KRKHWNVE" required style="text-align:center;font-size:1.05rem;font-weight:600;letter-spacing:2px;text-transform:uppercase" oninput="App.onboardingSet('joinCode', this.value)" value="${this.onboarding.joinCode || ''}">
                        </div>
                        <div class="form-group">
                            <label for="joinEmail">📧 Votre email *</label>
                            <input id="joinEmail" type="email" class="form-input" placeholder="votre@email.com" required oninput="App.onboardingSet('contact', this.value)" value="${prefillEmail}">
                        </div>
                        <div class="form-group">
                            <label for="joinFullName">👤 Votre nom complet *</label>
                            <input id="joinFullName" type="text" class="form-input" placeholder="Nom complet" required oninput="App.onboardingSet('fullName', this.value)" value="${this.onboarding.fullName || ''}">
                        </div>
                        <div class="form-group">
                            <label for="joinPassword">🔒 Mot de passe *</label>
                            <div class="input-wrapper">
                                <input id="joinPassword" type="password" class="form-input has-icon" placeholder="Min. 8 caractères" required oninput="App.onboardingSet('password', this.value)">
                                <button type="button" class="input-toggle" onclick="App.togglePassword('joinPassword')">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn-submit">Rejoindre l'entreprise</button>
                    </form>
                    <button type="button" class="btn-submit" style="background:#f1f5f9;color:#475569;margin-top:0.5rem" onclick="App.onboardingGo(2)">← Retour</button>
                `;
            }

            this.mount(`
                <div class="auth-page">
                    ${leftPanel}
                    <div class="auth-right">
                        <div class="auth-container animate-fade-in">
                            ${rightContent}
                        </div>
                    </div>
                </div>
            `);
        },



        showDeliveryHistory() {
            const user = CORE.state.currentUser;
            if (!user || user.role !== 'livreur') return;

            // ========== RÉCUPÉRATION ET TRI DES LIVRAISONS ==========
            const allDeliveries = CORE.getVisibleDeliveries().filter(d => d.livreurId === user.id);

            // Tri par date la plus récente (completedAt ou createdAt)
            const deliveries = allDeliveries
                .sort((a, b) => {
                    const dateA = new Date(a.completedAt || a.createdAt);
                    const dateB = new Date(b.completedAt || b.createdAt);
                    return dateB - dateA;
                })
                .slice(0, 20);

            // ========== STATISTIQUES ==========
            const completed = deliveries.filter(d => d.status === 'livré').length;
            const pending = deliveries.filter(d => d.status !== 'livré').length;
            const rated = deliveries.filter(d => d.customerRating && d.customerRating > 0).length;
            const avgRating = rated > 0
                ? (deliveries.reduce((sum, d) => sum + (d.customerRating || 0), 0) / rated).toFixed(1)
                : 'N/A';

            // ========== GROUPAGE PAR STATUT ==========
            const statusGroups = {
                'livré': deliveries.filter(d => d.status === 'livré'),
                'en-cours': deliveries.filter(d => d.status === 'en-cours'),
                'assigné': deliveries.filter(d => d.status === 'assigné'),
                'annulé': deliveries.filter(d => d.status === 'annulé')
            };

            // ========== GÉNÉRATION HTML DES LIVRAISONS ==========
            const getStatusBadge = (status) => {
                const statusMap = {
                    'livré': { bg: 'bg-emerald-100', text: 'text-emerald-700', icon: '✅' },
                    'en-cours': { bg: 'bg-blue-100', text: 'text-blue-700', icon: '🚚' },
                    'assigné': { bg: 'bg-amber-100', text: 'text-amber-700', icon: '📋' },
                    'annulé': { bg: 'bg-red-100', text: 'text-red-700', icon: '❌' }
                };
                const map = statusMap[status] || { bg: 'bg-slate-100', text: 'text-slate-700', icon: '❓' };
                return `<span class="px-3 py-1.5 rounded-lg text-xs font-black ${map.bg} ${map.text}">${map.icon} ${status}</span>`;
            };

            const getRatingStars = (rating) => {
                if (!rating) return '<span class="text-xs text-slate-400">Non noté</span>';
                return `<span class="text-xs font-bold">⭐ ${rating}/5</span>`;
            };

            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                if (date.toDateString() === today.toDateString()) {
                    return `Aujourd'hui à ${date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
                } else if (date.toDateString() === yesterday.toDateString()) {
                    return `Hier à ${date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
                } else {
                    return date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' });
                }
            };

            const deliveryItemHTML = (d, index) => `
                <div class="group p-4 bg-white border border-slate-200 rounded-xl hover:shadow-md hover:border-slate-300 transition">
                    <div class="flex items-start justify-between gap-3 mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-black text-slate-900">${d.orderRef}</span>
                                <span class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded">#${index + 1}</span>
                            </div>
                            <div class="text-sm text-slate-600 font-medium mt-1">👤 ${d.customerName}</div>
                        </div>
                        ${getStatusBadge(d.status)}
                    </div>

                    <div class="space-y-2 mb-3 text-xs">
                        <div class="flex justify-between items-center">
                            <span class="text-slate-600">📅 ${formatDate(d.completedAt || d.createdAt)}</span>
                            <span class="font-bold text-slate-900">${d.amount ? d.amount.toFixed(2) + '$' : '—'}</span>
                        </div>
                        ${d.address ? `<div class="text-slate-600 flex items-start gap-1"><span>📍</span><span class="line-clamp-1">${d.address}</span></div>` : ''}
                    </div>

                    <div class="flex items-center justify-between pt-3 border-t border-slate-100">
                        <div>
                            ${getRatingStars(d.customerRating)}
                        </div>
                        <div class="text-xs text-slate-500">
                            ${d.notes ? `💬 ${d.notes.substring(0, 20)}...` : 'Sans note'}
                        </div>
                    </div>
                </div>
            `;

            // ========== GÉNÉRATION DU MODAL COMPLET ==========
            const historyHTML = deliveries.length === 0
                ? '<div class="text-center py-8 text-slate-400"><div class="text-3xl mb-2">📭</div>Aucune livraison</div>'
                : deliveries.map((d, idx) => deliveryItemHTML(d, idx)).join('');

            const modalContent = `
                <div class="space-y-4">
                    <!-- SECTION: STATISTIQUES -->
                    <div class="grid grid-cols-4 gap-2">
                        <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-lg text-center">
                            <div class="text-lg font-black text-emerald-700">${completed}</div>
                            <div class="text-xs text-emerald-600 font-bold">Complétées</div>
                        </div>
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-center">
                            <div class="text-lg font-black text-blue-700">${pending}</div>
                            <div class="text-xs text-blue-600 font-bold">En attente</div>
                        </div>
                        <div class="p-3 bg-amber-50 border border-amber-200 rounded-lg text-center">
                            <div class="text-lg font-black text-amber-700">${rated}</div>
                            <div class="text-xs text-amber-600 font-bold">Notées</div>
                        </div>
                        <div class="p-3 bg-purple-50 border border-purple-200 rounded-lg text-center">
                            <div class="text-lg font-black text-purple-700">⭐ ${avgRating}</div>
                            <div class="text-xs text-purple-600 font-bold">Moyenne</div>
                        </div>
                    </div>

                    <!-- SECTION: FILTRES PAR STATUT -->
                    <div class="flex gap-2 pb-3 border-b border-slate-200">
                        <button onclick="this.parentElement.querySelectorAll('.delivery-item').forEach(e => e.style.display='block'); this.classList.add('bg-slate-900', 'text-white'); this.parentElement.querySelectorAll('button').forEach(b => { if (b !== this) b.classList.remove('bg-slate-900', 'text-white'); })" class="px-3 py-1.5 bg-slate-900 text-white text-xs font-bold rounded-lg transition">
                            📦 Tous (${deliveries.length})
                        </button>
                        ${completed > 0 ? `<button onclick="this.parentElement.parentElement.querySelectorAll('.delivery-item').forEach(e => e.classList.contains('status-livré') ? e.style.display='block' : e.style.display='none'); this.classList.add('bg-slate-900', 'text-white'); this.parentElement.querySelectorAll('button').forEach(b => { if (b !== this) b.classList.remove('bg-slate-900', 'text-white'); })" class="px-3 py-1.5 bg-slate-100 text-slate-700 text-xs font-bold rounded-lg hover:bg-slate-200 transition">✅ Livraisons (${completed})</button>` : ''}
                        ${pending > 0 ? `<button onclick="this.parentElement.parentElement.querySelectorAll('.delivery-item').forEach(e => !e.classList.contains('status-livré') ? e.style.display='block' : e.style.display='none'); this.classList.add('bg-slate-900', 'text-white'); this.parentElement.querySelectorAll('button').forEach(b => { if (b !== this) b.classList.remove('bg-slate-900', 'text-white'); })" class="px-3 py-1.5 bg-slate-100 text-slate-700 text-xs font-bold rounded-lg hover:bg-slate-200 transition">🔄 En attente (${pending})</button>` : ''}
                    </div>

                    <!-- SECTION: LISTE DES LIVRAISONS -->
                    <div class="space-y-3 max-h-[65vh] overflow-y-auto pr-2">
                        ${deliveries.map((d, idx) => `
                            <div class="delivery-item status-${d.status}">
                                ${deliveryItemHTML(d, idx)}
                            </div>
                        `).join('')}
                    </div>

                    <!-- SECTION: RÉSUMÉ DÉTAILLÉ -->
                    <div class="bg-slate-50 border border-slate-200 p-4 rounded-xl text-sm">
                        <div class="font-black text-slate-900 mb-3">📊 Résumé</div>
                        <div class="grid grid-cols-2 gap-3 text-xs">
                            <div>
                                <span class="text-slate-600">Total livraisons:</span>
                                <div class="font-bold text-slate-900">${allDeliveries.length}</div>
                            </div>
                            <div>
                                <span class="text-slate-600">Taux de réussite:</span>
                                <div class="font-bold text-emerald-600">${((completed / deliveries.length) * 100 || 0).toFixed(0)}%</div>
                            </div>
                            <div>
                                <span class="text-slate-600">Dernière livraison:</span>
                                <div class="font-bold text-slate-900">${deliveries[0] ? formatDate(deliveries[0].completedAt || deliveries[0].createdAt) : '—'}</div>
                            </div>
                            <div>
                                <span class="text-slate-600">Satisfaction:</span>
                                <div class="font-bold text-amber-600">${avgRating !== 'N/A' ? avgRating + '/5' : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            UI.modal(`📦 Historique de livraisons - 20 dernières`, modalContent, [
                { label: 'Exporter', onclick: 'alert("Fonctionnalité à implémenter")', class: 'px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            lucide.createIcons();
        },

        showDocumentsManagement() {
            const user = CORE.state.currentUser;
            if (!user || user.role !== 'livreur') return;

            // ========== DONNÉES DES DOCUMENTS ==========
            const documents = {
                license: {
                    name: 'Permis de conduire',
                    icon: '📋',
                    number: user.licenseNumber || 'Non renseigné',
                    expiry: user.licenseExpiry || 'Non renseigné',
                    status: user.licenseExpiry && new Date(user.licenseExpiry) > new Date() ? 'Valide' : 'Expiré',
                    uploaded: user.licenseUploadedAt ? new Date(user.licenseUploadedAt).toLocaleDateString('fr-FR') : 'Non téléchargé',
                    fileName: user.licenseFileName || 'permis_conduire.pdf',
                    size: user.licenseSize || '2.3 MB'
                },
                insurance: {
                    name: 'Assurance véhicule',
                    icon: '🛡️',
                    number: user.insuranceNumber || 'Non renseigné',
                    expiry: user.insuranceExpiry || 'Non renseigné',
                    status: user.insuranceExpiry && new Date(user.insuranceExpiry) > new Date() ? 'Valide' : 'Expiré',
                    uploaded: user.insuranceUploadedAt ? new Date(user.insuranceUploadedAt).toLocaleDateString('fr-FR') : 'Non téléchargé',
                    fileName: user.insuranceFileName || 'assurance_vehicule.pdf',
                    size: user.insuranceSize || '1.8 MB'
                },
                vehicle: {
                    name: 'Document du véhicule',
                    icon: '🚗',
                    number: user.vehicleRegistration || 'Non renseigné',
                    plate: user.vehicle || 'Non renseigné',
                    status: 'Valide',
                    uploaded: user.vehicleUploadedAt ? new Date(user.vehicleUploadedAt).toLocaleDateString('fr-FR') : 'Non téléchargé',
                    fileName: user.vehicleFileName || 'document_vehicule.pdf',
                    size: user.vehicleSize || '1.5 MB'
                }
            };

            // ========== FONCTION DE RENDU D'UN DOCUMENT ==========
            const renderDocument = (doc, type) => {
                const isExpired = doc.status === 'Expiré';
                const isUploaded = doc.uploaded !== 'Non téléchargé';
                const expiryDate = new Date(doc.expiry);
                const daysUntilExpiry = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));

                return `
                    <div class="p-5 border-2 border-slate-200 rounded-xl hover:shadow-lg transition">
                        <!-- HEADER DOCUMENT -->
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-start gap-3">
                                <div class="text-3xl">${doc.icon}</div>
                                <div>
                                    <h4 class="font-black text-slate-900">${doc.name}</h4>
                                    <p class="text-xs text-slate-500 mt-1">Type: ${type.toUpperCase()}</p>
                                </div>
                            </div>
                            <span class="px-3 py-1.5 rounded-lg text-xs font-black ${isExpired ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'}">
                                ${isExpired ? '⚠️ EXPIRÉ' : '✅ VALIDE'}
                            </span>
                        </div>

                        <!-- INFORMATIONS PRINCIPALES -->
                        <div class="bg-slate-50 p-4 rounded-lg mb-4 space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-600">🔢 Numéro:</span>
                                <span class="font-bold text-slate-900">${doc.number}</span>
                            </div>
                            ${type !== 'vehicle' ? `
                            <div class="flex justify-between">
                                <span class="text-slate-600">📅 Expiration:</span>
                                <span class="font-bold ${isExpired ? 'text-red-700' : 'text-slate-900'}">${doc.expiry}</span>
                            </div>
                            ${daysUntilExpiry !== Infinity && daysUntilExpiry > 0 && daysUntilExpiry <= 30 ? `
                            <div class="flex justify-between items-center bg-amber-50 -mx-4 -mb-2 px-4 py-2 rounded-b-lg border-t border-amber-100">
                                <span class="text-amber-600 text-xs font-bold">⏰ Expire dans ${daysUntilExpiry} jour(s)</span>
                            </div>
                            ` : ''}
                            ` : `
                            <div class="flex justify-between">
                                <span class="text-slate-600">🚗 Plaque:</span>
                                <span class="font-bold text-slate-900">${doc.plate}</span>
                            </div>
                            `}
                        </div>

                        <!-- INFORMATIONS DE TÉLÉCHARGEMENT -->
                        <div class="grid grid-cols-2 gap-3 mb-4 text-xs">
                            <div class="p-3 bg-blue-50 border border-blue-100 rounded-lg">
                                <div class="text-blue-600 font-bold">📁 Fichier</div>
                                <div class="text-blue-700 font-black text-lg">${isUploaded ? '✓' : '✗'}</div>
                                <div class="text-blue-600 text-[10px]">${doc.fileName}</div>
                                <div class="text-blue-500 text-[10px] mt-1">${doc.size}</div>
                            </div>
                            <div class="p-3 bg-purple-50 border border-purple-100 rounded-lg">
                                <div class="text-purple-600 font-bold">📤 Envoyé</div>
                                <div class="text-purple-700 font-black text-lg">${isUploaded ? '✓' : '✗'}</div>
                                <div class="text-purple-600 text-[10px]">${doc.uploaded}</div>
                                ${isUploaded ? '<div class="text-purple-500 text-[10px] mt-1">Approuvé ✅</div>' : '<div class="text-red-600 text-[10px] mt-1 font-bold">Requis</div>'}
                            </div>
                        </div>

                        <!-- BOUTONS D'ACTION -->
                        <div class="flex gap-2">
                            <button onclick="CourierModule.downloadDocument('${type}')" class="flex-1 px-4 py-2.5 bg-blue-600 text-white text-xs font-black rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                📥 Télécharger
                            </button>
                            <button onclick="CourierModule.uploadDocument('${type}')" class="flex-1 px-4 py-2.5 bg-emerald-600 text-white text-xs font-black rounded-lg hover:bg-emerald-700 transition flex items-center justify-center gap-2">
                                📤 ${isUploaded ? 'Remplacer' : 'Envoyer'}
                            </button>
                            <button onclick="CourierModule.viewDocument('${type}')" class="px-4 py-2.5 bg-slate-200 text-slate-700 text-xs font-black rounded-lg hover:bg-slate-300 transition" title="Prévisualiser le document">
                                👁️
                            </button>
                        </div>
                    </div>
                `;
            };

            // ========== GÉNÉRATION DU CONTENU ==========
            const modalContent = `
                <div class="space-y-5">
                    <!-- ALERTE IMPORTANTE -->
                    <div class="p-4 bg-red-50 border-l-4 border-red-500 rounded-lg">
                        <div class="flex gap-3 items-start">
                            <span class="text-xl">⚠️</span>
                            <div>
                                <div class="font-black text-red-900">Documents importants</div>
                                <p class="text-sm text-red-800 mt-1">Tous les documents doivent être à jour et valides. Les documents expirés peuvent affecter votre capacité à livrer.</p>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION: PERMIS DE CONDUIRE -->
                    <div>
                        <h3 class="text-sm font-black text-slate-900 mb-3">📋 DOCUMENTS D'IDENTITÉ</h3>
                        ${renderDocument(documents.license, 'license')}
                    </div>

                    <!-- SECTION: ASSURANCE -->
                    <div>
                        <h3 class="text-sm font-black text-slate-900 mb-3">🛡️ COUVERTURE ASSURANCE</h3>
                        ${renderDocument(documents.insurance, 'insurance')}
                    </div>

                    <!-- SECTION: VÉHICULE -->
                    <div>
                        <h3 class="text-sm font-black text-slate-900 mb-3">🚗 IMMATRICULATION VÉHICULE</h3>
                        ${renderDocument(documents.vehicle, 'vehicle')}
                    </div>

                    <!-- SECTION: RÉSUMÉ DE CONFORMITÉ -->
                    <div class="p-4 bg-gradient-to-r from-slate-50 to-slate-100 border border-slate-200 rounded-xl">
                        <div class="font-black text-slate-900 mb-3">✅ état de conformité</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full bg-emerald-500 flex items-center justify-center text-white text-xs">✓</span>
                                <span class="text-slate-700">Permis de conduire: <span class="font-bold">${documents.license.status}</span></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full ${documents.insurance.status === 'Expiré' ? 'bg-red-500' : 'bg-emerald-500'} flex items-center justify-center text-white text-xs">✓</span>
                                <span class="text-slate-700">Assurance: <span class="font-bold">${documents.insurance.status}</span></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full bg-emerald-500 flex items-center justify-center text-white text-xs">✓</span>
                                <span class="text-slate-700">Document véhicule: <span class="font-bold">${documents.vehicle.status}</span></span>
                            </div>
                        </div>
                        <div class="mt-3 p-2 bg-white rounded text-xs text-slate-600">
                            <span class="font-bold">✅ Profil:</span> ${documents.license.status === 'Valide' && documents.insurance.status === 'Valide' ? '🟢 CONFORME' : '🔴 À RÉGULARISER'}
                        </div>
                    </div>

                    <!-- INFORMATION SUPPLÉMENTAIRE -->
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-800">
                        <span class="font-bold">💡 Conseil:</span> Vérifiez régulièrement l'expiration de vos documents. Vous recevrez une notification 30 jours avant l'expiration.
                    </div>
                </div>
            `;

            UI.modal(`📄 Gestion des documents`, modalContent, [
                { label: 'Exporter liste', onclick: 'CourierModule.exportDocuments()', class: 'px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            lucide.createIcons();
        },

        // ========== FONCTIONS SUPPORT POUR DOCUMENTS ==========
        downloadDocument(type) {
            UI.toast(`Téléchargement du document (${type})...`, 'info');
            // Simulation: Dans un vrai système, cela déclencherait un téléchargement
            setTimeout(() => {
                UI.toast(`✅ Document téléchargé!`, 'success');
            }, 1500);
        },

        uploadDocument(type) {
            UI.toast(`Ouverture du sélecteur de fichier pour ${type}...`, 'info');
            // Simulation: Dans un vrai système, cela ouvrirait un sélecteur de fichier
            setTimeout(() => {
                UI.toast(`✅ Document envoyé avec succès!`, 'success');
                CourierModule.showDocumentsManagement();
            }, 1500);
        },

        viewDocument(type) {
            UI.toast(`Affichage du document ${type}...`, 'info');
            // Simulation: Dans un vrai système, cela afficherait l'aperçu du PDF
        },

        exportDocuments() {
            UI.toast(`Export des documents en cours...`, 'info');
            setTimeout(() => {
                UI.toast(`✅ Documents exportés en ZIP!`, 'success');
            }, 2000);
        },

        showCourierRatings() {
            const user = CORE.state.currentUser;
            if (!user || user.role !== 'livreur') return;

            const deliveries = CORE.getVisibleDeliveries().filter(d => d.livreurId === user.id && d.customerRating);
            const ratings = [5, 4, 3, 2, 1].map(rate => ({
                rate,
                count: deliveries.filter(d => d.customerRating === rate).length
            }));

            const ratingsHTML = ratings.map(r => `
                <div class="flex items-center gap-3">
                    <span class="text-sm font-bold">${'⭐'.repeat(r.rate)}</span>
                    <div class="flex-1 bg-slate-100 rounded-full h-2">
                        <div class="bg-amber-500 h-2 rounded-full progress-bar" data-width="${(r.count / deliveries.length * 100) || 0}"></div>
                    </div>
                    <span class="text-sm font-bold">${r.count}</span>
                </div>
            `).join('');

            UI.modal(`⭐ Notes des clients`, `
                <div class="space-y-4">
                    <div class="bg-gradient-to-r from-amber-100 to-amber-50 p-4 rounded-lg">
                        <div class="text-3xl font-black text-center mb-2">
                            ${(deliveries.reduce((sum, d) => sum + d.customerRating, 0) / deliveries.length).toFixed(1)} / 5
                        </div>
                        <div class="text-center text-sm text-slate-600">Basée sur ${deliveries.length} avis</div>
                    </div>
                    <div class="space-y-2">${ratingsHTML}</div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        // ========== GESTION DES SETTINGS GESTIONNAIRE ==========
        showGestionnaireSettings() {
            const user = CORE.state.currentUser;
            if (!user || user.role !== 'gestionnaire') return;

            // Récupérer les settings actuels ou initialiser
            if (!CORE.state.gestionnaireSettings) {
                CORE.state.gestionnaireSettings = {
                    deliveryPhotoValidationEnabled: true,
                    deliverySignatureEnabled: true,
                    deliveryNotesRequired: false,
                    autoOptimizeRoutes: true,
                    enableFinancialReports: true,
                    enableLiveTracking: true,
                    enableCustomerRatings: true,
                    enableDocumentManagement: true
                };
            }

            const settings = CORE.state.gestionnaireSettings;

            const settingsContent = `
                <div class="space-y-5">
                    <!-- TITRE -->
                    <div class="p-4 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl">
                        <h2 class="text-xl font-black">⚙️ Paramètres de gestion</h2>
                        <p class="text-sm opacity-90 mt-1">Contrôlez les fonctionnalités de l'application</p>
                    </div>

                    <!-- SECTION: LIVRAISONS -->
                    <div class="p-5 border-2 border-slate-200 rounded-xl">
                        <h3 class="font-black text-slate-900 mb-4 flex items-center gap-2">
                            <span class="text-lg">📦</span>
                            Livraisons
                        </h3>

                        <div class="space-y-4">
                            <!-- VALIDATION PAR PHOTO -->
                            <div class="p-4 bg-slate-50 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-black text-slate-900">📸 Validation par photo</h4>
                                    <p class="text-xs text-slate-600 mt-1">Permettre aux livreurs de valider les livraisons avec une photo de preuve</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle_photo_validation"
                                        ${settings.deliveryPhotoValidationEnabled ? 'checked' : ''}
                                        onchange="CourierModule.toggleFeature('deliveryPhotoValidationEnabled', this.checked)"
                                        class="sr-only peer">
                                    <div class="w-14 h-8 bg-slate-300 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-7 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all"></div>
                                </label>
                            </div>

                            <!-- SIGNATURE REQUISE -->
                            <div class="p-4 bg-slate-50 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-black text-slate-900">✍️ Signature du client</h4>
                                    <p class="text-xs text-slate-600 mt-1">Demander la signature numérique du client à la livraison</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle_signature"
                                        ${settings.deliverySignatureEnabled ? 'checked' : ''}
                                        onchange="CourierModule.toggleFeature('deliverySignatureEnabled', this.checked)"
                                        class="sr-only peer">
                                    <div class="w-14 h-8 bg-slate-300 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-7 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all"></div>
                                </label>
                            </div>

                            <!-- NOTES OBLIGATOIRES -->
                            <div class="p-4 bg-slate-50 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-black text-slate-900">📝 Notes obligatoires</h4>
                                    <p class="text-xs text-slate-600 mt-1">Exiger une note pour chaque livraison</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle_notes_required"
                                        ${settings.deliveryNotesRequired ? 'checked' : ''}
                                        onchange="CourierModule.toggleFeature('deliveryNotesRequired', this.checked)"
                                        class="sr-only peer">
                                    <div class="w-14 h-8 bg-slate-300 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-7 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all"></div>
                                </label>
                            </div>

                            <!-- OPTIMISATION AUTO -->
                            <div class="p-4 bg-slate-50 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-black text-slate-900">⚡ Optimisation auto des routes</h4>
                                    <p class="text-xs text-slate-600 mt-1">Calculer automatiquement les itinéraires optimaux</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle_auto_optimize"
                                        ${settings.autoOptimizeRoutes ? 'checked' : ''}
                                        onchange="CourierModule.toggleFeature('autoOptimizeRoutes', this.checked)"
                                        class="sr-only peer">
                                    <div class="w-14 h-8 bg-slate-300 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-7 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION: RAPPORTS & DONNÉES -->
                    <div class="p-5 border-2 border-slate-200 rounded-xl">
                        <h3 class="font-black text-slate-900 mb-4 flex items-center gap-2">
                            <span class="text-lg">📊</span>
                            Rapports et données
                        </h3>

                        <div class="space-y-4">
                            <!-- RAPPORTS FINANCIERS -->
                            <div class="p-4 bg-slate-50 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-black text-slate-900">💰 Rapports financiers</h4>
                                    <p class="text-xs text-slate-600 mt-1">Afficher les statistiques et rapports financiers</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle_financial_reports"
                                        ${settings.enableFinancialReports ? 'checked' : ''}
                                        onchange="CourierModule.toggleFeature('enableFinancialReports', this.checked)"
                                        class="sr-only peer">
                                    <div class="w-14 h-8 bg-slate-300 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-7 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all"></div>
                                </label>
                            </div>

                            <!-- SUIVI EN DIRECT -->
                            <div class="p-4 bg-slate-50 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-black text-slate-900">🗺️ Suivi GPS en direct</h4>
                                    <p class="text-xs text-slate-600 mt-1">Permettre le suivi en temps réel des livreurs</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle_live_tracking"
                                        ${settings.enableLiveTracking ? 'checked' : ''}
                                        onchange="CourierModule.toggleFeature('enableLiveTracking', this.checked)"
                                        class="sr-only peer">
                                    <div class="w-14 h-8 bg-slate-300 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-7 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all"></div>
                                </label>
                            </div>

                            <!-- NOTES CLIENTS -->
                            <div class="p-4 bg-slate-50 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-black text-slate-900">⭐ Notations des clients</h4>
                                    <p class="text-xs text-slate-600 mt-1">Permettre aux clients de noter les livreurs</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle_customer_ratings"
                                        ${settings.enableCustomerRatings ? 'checked' : ''}
                                        onchange="CourierModule.toggleFeature('enableCustomerRatings', this.checked)"
                                        class="sr-only peer">
                                    <div class="w-14 h-8 bg-slate-300 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-7 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION: DOCUMENTS & CONFORMITÉ -->
                    <div class="p-5 border-2 border-slate-200 rounded-xl">
                        <h3 class="font-black text-slate-900 mb-4 flex items-center gap-2">
                            <span class="text-lg">📄</span>
                            Documents et conformité
                        </h3>

                        <div class="space-y-4">
                            <!-- GESTION DOCUMENTS -->
                            <div class="p-4 bg-slate-50 rounded-lg flex items-center justify-between">
                                <div>
                                    <h4 class="font-black text-slate-900">📋 Gestion des documents</h4>
                                    <p class="text-xs text-slate-600 mt-1">Permettre le suivi des documents livreurs (permis, assurance...)</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle_document_management"
                                        ${settings.enableDocumentManagement ? 'checked' : ''}
                                        onchange="CourierModule.toggleFeature('enableDocumentManagement', this.checked)"
                                        class="sr-only peer">
                                    <div class="w-14 h-8 bg-slate-300 rounded-full peer peer-checked:bg-emerald-500 peer-checked:after:translate-x-7 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all"></div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- RÉSUMÉ DES CHANGEMENTS -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg text-sm">
                        <div class="font-black text-blue-900 mb-2">💡 À savoir</div>
                        <ul class="text-xs text-blue-800 space-y-1 list-disc list-inside">
                            <li>Les modifications s'appliquent immédiatement à tous les livreurs</li>
                            <li>Les fonctionnalités désactivées seront cachées de l'interface</li>
                            <li>Les données historiques restent accessibles</li>
                            <li>Vous pouvez réactiver une fonctionnalité à tout moment</li>
                        </ul>
                    </div>

                    <!-- ACTIONS RAPIDES -->
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="CourierModule.enableAllFeatures()" class="px-4 py-2.5 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 transition text-sm">
                            ✅ Tout activer
                        </button>
                        <button onclick="CourierModule.disableAllFeatures()" class="px-4 py-2.5 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition text-sm">
                            ❌ Tout désactiver
                        </button>
                    </div>
                </div>
            `;

            UI.modal(`⚙️ Paramètres gestionnaire`, settingsContent, [
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            lucide.createIcons();
        },

        toggleFeature(featureKey, isEnabled) {
            if (!CORE.state.gestionnaireSettings) {
                CORE.state.gestionnaireSettings = {};
            }

            CORE.state.gestionnaireSettings[featureKey] = isEnabled;

            // Log pour debugging
            console.log(`✅ Fonctionnalité "${featureKey}" ${isEnabled ? 'ACTIVéE' : 'DéSACTIVéE'}`);

            // Notification
            UI.toast(`${isEnabled ? '✅' : '❌'} ${featureKey.replace(/([A-Z])/g, ' $1').toLowerCase()} - ${isEnabled ? 'Activé' : 'Désactivé'}`, 'info');

            // Sauvegarde dans le localStorage
            localStorage.setItem('gestionnaireSettings', JSON.stringify(CORE.state.gestionnaireSettings));
        },

        enableAllFeatures() {
            if (!CORE.state.gestionnaireSettings) {
                CORE.state.gestionnaireSettings = {};
            }

            Object.keys(CORE.state.gestionnaireSettings).forEach(key => {
                CORE.state.gestionnaireSettings[key] = true;
            });

            localStorage.setItem('gestionnaireSettings', JSON.stringify(CORE.state.gestionnaireSettings));
            UI.toast('✅ Toutes les fonctionnalités activées!', 'success');
            CourierModule.showGestionnaireSettings();
        },

        disableAllFeatures() {
            if (!CORE.state.gestionnaireSettings) {
                CORE.state.gestionnaireSettings = {};
            }

            Object.keys(CORE.state.gestionnaireSettings).forEach(key => {
                CORE.state.gestionnaireSettings[key] = false;
            });

            localStorage.setItem('gestionnaireSettings', JSON.stringify(CORE.state.gestionnaireSettings));
            UI.toast('❌ Toutes les fonctionnalités désactivées!', 'warning');
            CourierModule.showGestionnaireSettings();
        },

        showVehicleManagement() {
            const user = CORE.state.currentUser;
            if (!user || user.role !== 'livreur') return;

            UI.modal(`🚗 Gestion des véhicules`, `
                <div class="space-y-4">
                    <div class="p-4 border border-slate-200 rounded-lg">
                        <div class="font-bold text-slate-900 mb-2">🚗 ${user.vehicle || 'Véhicule'}</div>
                        <div class="text-sm text-slate-600 mb-3">
                            Marque: BMW | Modèle: X1 | Année: 2022<br>
                            Plaque: XY-123-AB | Kilométrage: 45,230 km
                        </div>
                        <div class="space-y-2">
                            <button class="w-full px-3 py-1.5 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 transition">
                                🔧 Maintenance
                            </button>
                            <button class="w-full px-3 py-1.5 bg-amber-600 text-white text-xs font-bold rounded-lg hover:bg-amber-700 transition">
                                ⛽ Carburant
                            </button>
                        </div>
                    </div>
                </div>
            `, [{ label: 'Fermer', onclick: 'UI.closeModal()' }]);
        },

        showFinancialStats() {
            const user = CORE.state.currentUser;
            if (!user || user.role !== 'livreur') return;

            // ========== CALCULS FINANCIERS ==========
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const lastMonthDate = new Date(currentYear, currentMonth - 1, 1);

            const allDeliveries = CORE.getVisibleDeliveries().filter(d => d.livreurId === user.id && d.status === 'livré');

            // Total gagné
            const totalEarnings = allDeliveries.reduce((sum, d) => sum + (d.commission || 0), 0);

            // Ce mois
            const thisMonthDeliveries = allDeliveries.filter(d => {
                const d_date = new Date(d.completedAt);
                return d_date.getMonth() === currentMonth && d_date.getFullYear() === currentYear;
            });
            const thisMonthEarnings = thisMonthDeliveries.reduce((sum, d) => sum + (d.commission || 0), 0);

            // Mois dernier
            const lastMonthDeliveries = allDeliveries.filter(d => {
                const d_date = new Date(d.completedAt);
                return d_date.getMonth() === currentMonth - 1;
            });
            const lastMonthEarnings = lastMonthDeliveries.reduce((sum, d) => sum + (d.commission || 0), 0);

            // Aujourd'hui
            const todayStart = new Date(currentYear, currentMonth, now.getDate());
            const todayDeliveries = allDeliveries.filter(d => {
                const d_date = new Date(d.completedAt);
                return d_date >= todayStart;
            });
            const todayEarnings = todayDeliveries.reduce((sum, d) => sum + (d.commission || 0), 0);

            // Statistiques
            const avgPerDelivery = allDeliveries.length > 0 ? (totalEarnings / allDeliveries.length).toFixed(2) : 0;
            const avgThisMonth = thisMonthDeliveries.length > 0 ? (thisMonthEarnings / thisMonthDeliveries.length).toFixed(2) : 0;

            // Bonus de performance
            const performanceBonus = thisMonthDeliveries.length >= 20 ? 150 :
                                     thisMonthDeliveries.length >= 15 ? 100 :
                                     thisMonthDeliveries.length >= 10 ? 50 : 0;

            // Progression
            const monthGrowth = lastMonthEarnings > 0 ? (((thisMonthEarnings - lastMonthEarnings) / lastMonthEarnings) * 100).toFixed(0) : 0;

            // Objectifs
            const monthlyTarget = 2000;
            const targetProgress = Math.min(100, (thisMonthEarnings / monthlyTarget) * 100);

            const modalContent = `
                <div class="space-y-5">
                    <!-- CARTES PRINCIPALES -->
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        <!-- TOTAL GAGNÉ -->
                        <div class="p-5 bg-gradient-to-br from-emerald-500 to-emerald-600 text-white rounded-xl shadow-lg">
                            <div class="text-xs font-black uppercase opacity-90">Total gagné</div>
                            <div class="text-3xl font-black mt-2">${totalEarnings.toFixed(2)}$</div>
                            <div class="text-xs opacity-75 mt-1">Depuis le début</div>
                        </div>

                        <!-- CE MOIS -->
                        <div class="p-5 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl shadow-lg">
                            <div class="text-xs font-black uppercase opacity-90">Ce mois</div>
                            <div class="text-3xl font-black mt-2">${thisMonthEarnings.toFixed(2)}$</div>
                            <div class="text-xs opacity-75 mt-1">${thisMonthDeliveries.length} livraisons</div>
                        </div>

                        <!-- AUJOURD'HUI -->
                        <div class="p-5 bg-gradient-to-br from-amber-500 to-amber-600 text-white rounded-xl shadow-lg">
                            <div class="text-xs font-black uppercase opacity-90">Aujourd'hui</div>
                            <div class="text-3xl font-black mt-2">${todayEarnings.toFixed(2)}$</div>
                            <div class="text-xs opacity-75 mt-1">${todayDeliveries.length} livraisons</div>
                        </div>
                    </div>

                    <!-- OBJECTIF MENSUEL -->
                    <div class="p-5 bg-white border-2 border-purple-200 rounded-xl">
                        <div class="flex items-center justify-between mb-3">
                            <div class="font-black text-slate-900">🎯 Objectif mensuel</div>
                            <span class="text-sm font-black text-purple-700">${Math.round(targetProgress)}%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-4 overflow-hidden mb-2">
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 h-4 rounded-full transition-all" style="width: ${Math.min(100, Math.max(0, targetProgress))}%"></div>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-slate-600">${thisMonthEarnings.toFixed(2)}$ / ${monthlyTarget}$</span>
                            <span class="font-bold text-purple-700">${(monthlyTarget - thisMonthEarnings).toFixed(2)}$ manquants</span>
                        </div>
                    </div>

                    <!-- STATISTIQUES DÉTAILLÉES -->
                    <div class="p-5 bg-white border border-slate-200 rounded-xl">
                        <div class="font-black text-slate-900 mb-4">📊 Statistiques détaillées</div>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                <span class="text-slate-600">📦 Livraisons ce mois</span>
                                <span class="font-black text-lg text-blue-600">${thisMonthDeliveries.length}</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                <span class="text-slate-600">💵 Moyenne par livraison</span>
                                <span class="font-black text-lg text-emerald-600">${avgThisMonth}$</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                <span class="text-slate-600">📈 Croissance vs mois dernier</span>
                                <span class="font-black text-lg ${monthGrowth >= 0 ? 'text-emerald-600' : 'text-red-600'}">${monthGrowth >= 0 ? '+' : ''}${monthGrowth}%</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                <span class="text-slate-600">⭐ Total livraisons</span>
                                <span class="font-black text-lg text-purple-600">${allDeliveries.length}</span>
                            </div>
                        </div>
                    </div>

                    <!-- BONUS DE PERFORMANCE -->
                    <div class="p-5 bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-300 rounded-xl">
                        <div class="flex items-center justify-between mb-3">
                            <div class="font-black text-slate-900">🏆 Bonus de performance</div>
                            <span class="text-2xl font-black text-amber-600">${performanceBonus}$</span>
                        </div>
                        <div class="text-sm text-slate-700 mb-3">
                            ${performanceBonus > 0 ?
                                `<div class="text-amber-700 font-bold">✅ Bonus débloqué!</div>
                                 <div class="text-xs text-amber-600 mt-1">
                                    ${performanceBonus === 150 ? '🥇 Vous avez livré 20+ commandes ce mois' :
                                      performanceBonus === 100 ? '🥈 Vous avez livré 15+ commandes ce mois' :
                                      performanceBonus === 50 ? '🥉 Vous avez livré 10+ commandes ce mois' : ''}
                                 </div>`
                                :
                                `<div class="text-slate-700">
                                    Prochains paliers:
                                    <div class="mt-2 space-y-1 text-xs">
                                        <div>${thisMonthDeliveries.length}/10 - 50$ 🥉</div>
                                        <div>${thisMonthDeliveries.length}/15 - 100$ 🥈</div>
                                        <div>${thisMonthDeliveries.length}/20 - 150$ 🥇</div>
                                    </div>
                                 </div>`
                            }
                        </div>
                    </div>

                    <!-- DÉCOMPOSITION DES REVENUS -->
                    <div class="p-5 bg-white border border-slate-200 rounded-xl">
                        <div class="font-black text-slate-900 mb-4">💳 Décomposition</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between p-2">
                                <span class="text-slate-600">Commissions</span>
                                <span class="font-bold text-slate-900">${(totalEarnings * 0.85).toFixed(2)}$</span>
                            </div>
                            <div class="flex justify-between p-2">
                                <span class="text-slate-600">Bonus performance</span>
                                <span class="font-bold text-amber-600">+${performanceBonus}$</span>
                            </div>
                            <div class="flex justify-between p-2">
                                <span class="text-slate-600">Incitatifs</span>
                                <span class="font-bold text-emerald-600">+${(totalEarnings * 0.15).toFixed(2)}$</span>
                            </div>
                            <div class="border-t border-slate-200 flex justify-between p-2 mt-2 font-black">
                                <span>Total</span>
                                <span class="text-emerald-600">${(totalEarnings + performanceBonus).toFixed(2)}$</span>
                            </div>
                        </div>
                    </div>

                    <!-- CONSEIL -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-800">
                        <span class="font-bold">💡 Conseil:</span> Vous avez besoin de ${Math.max(0, Math.ceil((monthlyTarget - thisMonthEarnings) / (avgThisMonth || 1)))} livraisons supplémentaires pour atteindre votre objectif de ${monthlyTarget}$ ce mois!
                    </div>
                </div>
            `;

            UI.modal(`💰 Statistiques financières`, modalContent, [
                { label: 'Télécharger relevé', onclick: 'CourierModule.downloadFinancialStatement()', class: 'px-4 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            lucide.createIcons();
        },

        showMyRoutes() {
            const user = CORE.state.currentUser;
            if (!user || user.role !== 'livreur') return;

            // ========== GÉNÉRATION DE TOURNÉES ==========
            // Récupération des livraisons assignées
            const assignedDeliveries = CORE.getVisibleDeliveries().filter(d => d.livreurId === user.id && d.status !== 'livré');

            // Groupage par zone/région (simulation basée sur la lettre du code postal)
            const routes = {};
            assignedDeliveries.forEach(d => {
                const zone = d.address ? d.address.split(' ')[0].charAt(0).toUpperCase() : 'AUTRE';
                if (!routes[zone]) {
                    routes[zone] = [];
                }
                routes[zone].push(d);
            });

            // Tri des routes
            const sortedZones = Object.keys(routes).sort();
            const todayDeliveries = assignedDeliveries.filter(d => {
                const d_date = new Date(d.createdAt || d.assignedAt);
                const today = new Date();
                return d_date.toDateString() === today.toDateString();
            });

            // ========== FONCTION DE RENDU D'UNE ROUTE ==========
            const renderRoute = (zone, deliveries, index) => {
                const totalStops = deliveries.length;
                const estimatedDistance = (totalStops * 3.5).toFixed(1); // Estimation km
                const estimatedTime = Math.ceil(totalStops * 15); // 15 min par livraison

                const routeColor = ['from-blue-500 to-blue-600', 'from-emerald-500 to-emerald-600',
                                   'from-purple-500 to-purple-600', 'from-orange-500 to-orange-600',
                                   'from-pink-500 to-pink-600', 'from-cyan-500 to-cyan-600'];

                return `
                    <div class="p-5 border-2 border-slate-200 rounded-xl hover:shadow-lg transition">
                        <!-- HEADER ROUTE -->
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 rounded-lg bg-gradient-to-br ${routeColor[index % routeColor.length]} text-white flex items-center justify-center font-black text-lg">
                                    ${zone}
                                </div>
                                <div>
                                    <h4 class="font-black text-slate-900">Route Zone ${zone}</h4>
                                    <p class="text-xs text-slate-500 mt-1">${totalStops} arrêt(s)</p>
                                </div>
                            </div>
                            <button onclick="CourierModule.startRoute('${zone}')" class="px-3 py-1.5 bg-emerald-600 text-white text-xs font-black rounded-lg hover:bg-emerald-700 transition">
                                ▶️ Démarrer
                            </button>
                        </div>

                        <!-- STATISTIQUES ROUTE -->
                        <div class="grid grid-cols-3 gap-3 mb-4">
                            <div class="p-3 bg-blue-50 rounded-lg text-center">
                                <div class="text-lg font-black text-blue-600">${estimatedDistance}</div>
                                <div class="text-xs text-blue-600">km</div>
                            </div>
                            <div class="p-3 bg-purple-50 rounded-lg text-center">
                                <div class="text-lg font-black text-purple-600">${estimatedTime}</div>
                                <div class="text-xs text-purple-600">min</div>
                            </div>
                            <div class="p-3 bg-emerald-50 rounded-lg text-center">
                                <div class="text-lg font-black text-emerald-600">${(totalStops * 8).toFixed(0)}</div>
                                <div class="text-xs text-emerald-600">$</div>
                            </div>
                        </div>

                        <!-- LISTE DES LIVRAISONS -->
                        <div class="space-y-2 mb-3">
                            ${deliveries.slice(0, 3).map((d, i) => `
                                <div class="p-2 bg-slate-50 rounded-lg text-xs flex justify-between items-center">
                                    <span class="font-bold text-slate-900">${i + 1}. ${d.customerName}</span>
                                    <span class="px-2 py-0.5 rounded text-[10px] font-bold ${d.status === 'en-cours' ? 'bg-blue-100 text-blue-700' : 'bg-amber-100 text-amber-700'}">${d.status}</span>
                                </div>
                            `).join('')}
                            ${deliveries.length > 3 ? `<div class="p-2 text-xs text-slate-500 italic">+ ${deliveries.length - 3} autres arrêt(s)</div>` : ''}
                        </div>

                        <!-- BOUTONS ACTION -->
                        <div class="flex gap-2">
                            <button onclick="CourierModule.viewRouteMap('${zone}')" class="flex-1 px-3 py-2 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 transition">
                                🗺️ Carte
                            </button>
                            <button onclick="CourierModule.optimizeRoute('${zone}')" class="flex-1 px-3 py-2 bg-slate-600 text-white text-xs font-bold rounded-lg hover:bg-slate-700 transition">
                                ⚡ Optimiser
                            </button>
                        </div>
                    </div>
                `;
            };

            const modalContent = `
                <div class="space-y-5">
                    <!-- RÉSUMÉ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg text-center">
                            <div class="text-2xl font-black text-blue-700">${assignedDeliveries.length}</div>
                            <div class="text-xs text-blue-600 font-bold mt-1">Livraisons</div>
                        </div>
                        <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg text-center">
                            <div class="text-2xl font-black text-purple-700">${sortedZones.length}</div>
                            <div class="text-xs text-purple-600 font-bold mt-1">Routes</div>
                        </div>
                        <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-lg text-center">
                            <div class="text-2xl font-black text-emerald-700">${(assignedDeliveries.length * 3.5).toFixed(0)}</div>
                            <div class="text-xs text-emerald-600 font-bold mt-1">km</div>
                        </div>
                        <div class="p-4 bg-orange-50 border border-orange-200 rounded-lg text-center">
                            <div class="text-2xl font-black text-orange-700">${Math.ceil(assignedDeliveries.length * 15)}</div>
                            <div class="text-xs text-orange-600 font-bold mt-1">minutes</div>
                        </div>
                    </div>

                    <!-- ROUTES -->
                    <div class="space-y-3 max-h-[60vh] overflow-y-auto">
                        ${sortedZones.length === 0 ?
                            '<div class="text-center py-8 text-slate-400"><div class="text-3xl mb-2">📭</div>Aucune route assignée</div>' :
                            sortedZones.map((zone, idx) => renderRoute(zone, routes[zone], idx)).join('')
                        }
                    </div>

                    <!-- RÉSUMÉ OPTIMISATION -->
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-xl">
                        <div class="font-black text-slate-900 mb-3">📈 Optimisation</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-600">Itinéraire optimal</span>
                                <span class="font-bold text-emerald-600">✅ Calculé</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Temps estimé</span>
                                <span class="font-bold text-slate-900">${Math.ceil(assignedDeliveries.length * 15)} min</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Distance totale</span>
                                <span class="font-bold text-slate-900">${(assignedDeliveries.length * 3.5).toFixed(1)} km</span>
                            </div>
                        </div>
                    </div>

                    <!-- CONSEIL -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-800">
                        <span class="font-bold">💡 Conseil:</span> Cliquez sur "Optimiser" pour recalculer l'itinéraire le plus efficace et minimiser la distance.
                    </div>
                </div>
            `;

            UI.modal(`🚚 Mes feuilles de route`, modalContent, [
                { label: 'Tout démarrer', onclick: 'alert("Toutes les routes démarrées!")', class: 'px-4 py-2 bg-emerald-600 text-white font-bold rounded-lg hover:bg-emerald-700 transition' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);

            lucide.createIcons();
        },

        // ========== FONCTIONS SUPPORT ROUTES & FINANCES ==========
        downloadFinancialStatement() {
            UI.toast('Génération du relevé financier...', 'info');
            setTimeout(() => {
                UI.toast('✅ Relevé téléchargé en PDF!', 'success');
            }, 1500);
        },

        startRoute(zone) {
            UI.toast(`🚚 Route Zone ${zone} démarrée!`, 'success');
            UI.closeModal();
        },

        viewRouteMap(zone) {
            UI.toast(`Affichage de la carte Zone ${zone}...`, 'info');
        },

        optimizeRoute(zone) {
            UI.toast(`⚡ Optimisation de la route Zone ${zone}...`, 'info');
            setTimeout(() => {
                UI.toast('✅ Route optimisée! économie: 2.3 km', 'success');
            }, 1500);
        },
        // ========== VALIDATION DE LIVRAISON PAR IMAGE ==========
        validateDeliveryWithImage(deliveryId) {
            const delivery = CORE.getVisibleDeliveries().find(d => d.id === deliveryId);
            if (!delivery) return UI.toast('Livraison introuvable', 'error');

            const user = CORE.state.currentUser;
            if (!user || user.role !== 'livreur') return;

            // ========== VÉRIFIER SI LA FONCTIONNALITÉ EST ACTIVÉE ==========
            const settings = CORE.state.gestionnaireSettings || {};

            // Charger depuis localStorage si pas en mémoire
            if (!CORE.state.gestionnaireSettings) {
                const savedSettings = localStorage.getItem('gestionnaireSettings');
                CORE.state.gestionnaireSettings = savedSettings ? JSON.parse(savedSettings) : {
                    deliveryPhotoValidationEnabled: true
                };
            }

            // Vérifier si la fonctionnalité est activée
            if (!CORE.state.gestionnaireSettings.deliveryPhotoValidationEnabled) {
                return UI.toast('❌ La validation par photo est actuellement désactivée par le gestionnaire', 'warning');
            }

            // Initialiser si non existant
            if (!window._deliveryPhotos) {
                window._deliveryPhotos = {};
            }

            const modalContent = `
                <div class="space-y-5">
                    <!-- INFOS LIVRAISON -->
                    <div class="p-5 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl">
                        <div class="font-black text-slate-900 mb-3">📦 Commande: ${delivery.orderRef}</div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-600">👤 Client:</span>
                                <span class="font-bold">${delivery.customerName}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">📍 Adresse:</span>
                                <span class="font-bold">${delivery.address || '—'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">💰 Montant:</span>
                                <span class="font-bold text-emerald-600">${delivery.amount || 0}$</span>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION: CAPTURE PHOTO -->
                    <div class="p-5 border-2 border-slate-200 rounded-xl">
                        <h3 class="font-black text-slate-900 mb-4">📸 Preuve de livraison</h3>

                        <!-- ZONE DE PREVIEW -->
                        <div id="photo_preview_${deliveryId}" class="mb-4 p-4 bg-slate-100 rounded-lg text-center border-2 border-dashed border-slate-300 min-h-[200px] flex items-center justify-center">
                            <div>
                                <div class="text-4xl mb-2">📷</div>
                                <p class="text-sm text-slate-500">Aucune photo prise</p>
                                <p class="text-xs text-slate-400 mt-1">Cliquez sur "Prendre une photo"</p>
                            </div>
                        </div>

                        <!-- BOUTONS CAPTURE -->
                        <div class="flex gap-2 mb-4">
                            <button onclick="CourierModule.capturePhotoCamera('${deliveryId}')" class="flex-1 px-4 py-3 bg-blue-600 text-white font-black rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                                📷 Prendre une photo
                            </button>
                            <button onclick="CourierModule.uploadPhotoFile('${deliveryId}')" class="flex-1 px-4 py-3 bg-slate-600 text-white font-black rounded-lg hover:bg-slate-700 transition flex items-center justify-center gap-2">
                                📁 Importer
                            </button>
                        </div>

                        <!-- INPUT FICHIER CACHÉ -->
                        <input type="file" id="file_input_${deliveryId}" accept="image/*" style="display: none;" onchange="CourierModule.handlePhotoUpload('${deliveryId}', event)">
                    </div>

                    <!-- SECTION: SIGNATURE CLIENT (OPTIONNEL) -->
                    <div class="p-5 border border-amber-200 bg-amber-50 rounded-xl">
                        <h3 class="font-black text-slate-900 mb-3">✍️ Signature client (optionnel)</h3>
                        <div class="mb-3 p-3 bg-white border-2 border-dashed border-amber-300 rounded-lg min-h-[120px] text-center">
                            <p class="text-sm text-slate-500">Zone de signature - à implémenter</p>
                        </div>
                        <button onclick="alert('Fonctionnalité signature en développement')" class="w-full px-4 py-2 bg-amber-600 text-white font-black rounded-lg hover:bg-amber-700 transition">
                            ✍️ Demander une signature
                        </button>
                    </div>

                    <!-- SECTION: NOTES DE LIVRAISON -->
                    <div class="p-5 border border-slate-200 rounded-xl">
                        <h3 class="font-black text-slate-900 mb-3">📝 Notes de livraison</h3>
                        <textarea id="delivery_notes_${deliveryId}" placeholder="Notes: Client absent? Paquet endommagé? ..." class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm resize-none" rows="3"></textarea>

                        <div class="mt-3 space-y-2">
                            <button onclick="document.getElementById('notes_box_${deliveryId}').innerHTML = '✅ Livraison en bon état'; document.getElementById('delivery_notes_${deliveryId}').value = 'Livraison en bon état';" class="w-full text-left px-3 py-2 text-sm font-bold text-emerald-700 bg-emerald-50 border border-emerald-200 rounded-lg hover:bg-emerald-100 transition">
                                ✅ Livraison en bon état
                            </button>
                            <button onclick="document.getElementById('notes_box_${deliveryId}').innerHTML = '⚠️ Paquet endommagé'; document.getElementById('delivery_notes_${deliveryId}').value = 'Paquet endommagé';" class="w-full text-left px-3 py-2 text-sm font-bold text-red-700 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 transition">
                                ⚠️ Paquet endommagé
                            </button>
                            <button onclick="document.getElementById('notes_box_${deliveryId}').innerHTML = '❌ Client absent'; document.getElementById('delivery_notes_${deliveryId}').value = 'Client absent';" class="w-full text-left px-3 py-2 text-sm font-bold text-orange-700 bg-orange-50 border border-orange-200 rounded-lg hover:bg-orange-100 transition">
                                ❌ Client absent
                            </button>
                        </div>
                    </div>

                    <!-- SECTION: CHECKLIST -->
                    <div class="p-5 border border-slate-200 rounded-xl">
                        <h3 class="font-black text-slate-900 mb-3">✅ Checklist de livraison</h3>
                        <div class="space-y-2">
                            <label class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded cursor-pointer transition">
                                <input type="checkbox" id="check_customer_${deliveryId}" class="w-5 h-5">
                                <span class="text-sm font-bold text-slate-700">Client confirmé</span>
                            </label>
                            <label class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded cursor-pointer transition">
                                <input type="checkbox" id="check_photo_${deliveryId}" class="w-5 h-5">
                                <span class="text-sm font-bold text-slate-700">Photo prise</span>
                            </label>
                            <label class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded cursor-pointer transition">
                                <input type="checkbox" id="check_intact_${deliveryId}" class="w-5 h-5">
                                <span class="text-sm font-bold text-slate-700">Paquet intact</span>
                            </label>
                            <label class="flex items-center gap-3 p-2 hover:bg-slate-50 rounded cursor-pointer transition">
                                <input type="checkbox" id="check_receipt_${deliveryId}" class="w-5 h-5">
                                <span class="text-sm font-bold text-slate-700">Reçu fourni</span>
                            </label>
                        </div>
                    </div>

                    <!-- CONSEIL -->
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg text-xs text-blue-800">
                        <span class="font-bold">💡 Conseil:</span> Pour plus de transparence, prenez une photo claire de la livraison avec la signature ou le consentement du client.
                    </div>
                </div>
            `;

            UI.modal(`📸 Validation de livraison avec photo`, modalContent, [
                { label: 'Annuler', onclick: 'UI.closeModal()' },
                { label: 'Valider & Livrer', onclick: `CourierModule.confirmDeliveryWithPhoto('${deliveryId}')`, class: 'px-5 py-2.5 bg-emerald-600 text-white font-black rounded-xl hover:bg-emerald-700 transition' }
            ]);

            lucide.createIcons();
        },

        capturePhotoCamera(deliveryId) {
            // Simule l'accès à la caméra
            UI.toast('📷 Ouverture de la caméra...', 'info');

            // Simulation: génère une image de démonstration
            setTimeout(() => {
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 300;
                const ctx = canvas.getContext('2d');

                // Dégradé de démonstration
                const gradient = ctx.createLinearGradient(0, 0, 400, 300);
                gradient.addColorStop(0, '#3b82f6');
                gradient.addColorStop(1, '#1e40af');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 400, 300);

                // Texte
                ctx.fillStyle = 'white';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('📦 Photo de livraison', 200, 130);
                ctx.fillText('Horodatage: ' + new Date().toLocaleTimeString('fr-FR'), 200, 160);

                const imageData = canvas.toDataURL('image/jpeg');
                CourierModule.setDeliveryPhoto(deliveryId, imageData);
                UI.toast('✅ Photo capturée!', 'success');
            }, 500);
        },

        uploadPhotoFile(deliveryId) {
            const input = document.getElementById(`file_input_${deliveryId}`);
            if (input) {
                input.click();
            }
        },

        handlePhotoUpload(deliveryId, event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                return UI.toast('Veuillez sélectionner une image', 'error');
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                CourierModule.setDeliveryPhoto(deliveryId, e.target.result);
                UI.toast('✅ Photo importée!', 'success');
            };
            reader.readAsDataURL(file);
        },

        setDeliveryPhoto(deliveryId, imageData) {
            if (!window._deliveryPhotos) {
                window._deliveryPhotos = {};
            }

            window._deliveryPhotos[deliveryId] = {
                data: imageData,
                timestamp: new Date().toISOString(),
                size: imageData.length
            };

            // Mettre à jour le preview
            const preview = document.getElementById(`photo_preview_${deliveryId}`);
            if (preview) {
                if (imageData) {
                    const photoDate = new Date(window._deliveryPhotos[deliveryId].timestamp).toLocaleString('fr-FR');
                    preview.innerHTML = `
                        <div class="text-center">
                            <img src="${imageData}" alt="Photo de livraison" class="max-h-[180px] rounded-lg mx-auto mb-2 shadow-lg" onerror="this.style.display='none'; if(this.nextElementSibling) this.nextElementSibling.style.display='block'">
                            <div class="text-center text-slate-400" style="display:none">❌ Erreur chargement</div>
                            <p class="text-xs text-slate-600">📷 ${photoDate}</p>
                        </div>
                    `;
                } else {
                    preview.innerHTML = '<div><div class="text-4xl mb-2">📷</div><p class="text-sm text-slate-500">Aucune photo prise</p><p class="text-xs text-slate-400 mt-1">Cliquez sur "Prendre une photo"</p></div>';
                }
            }

            // Cocher automatiquement la case photo
            const photoCheck = document.getElementById(`check_photo_${deliveryId}`);
            if (photoCheck) {
                photoCheck.checked = true;
            }
        },

        confirmDeliveryWithPhoto(deliveryId) {
            const delivery = CORE.getVisibleDeliveries().find(d => d.id === deliveryId);
            if (!delivery) return UI.toast('Livraison introuvable', 'error');

            // Vérifier que la photo est présente
            if (!window._deliveryPhotos || !window._deliveryPhotos[deliveryId]) {
                return UI.toast('⚠️ Veuillez prendre une photo', 'warning');
            }

            // Vérifier les cases
            const allChecked = document.getElementById(`check_customer_${deliveryId}`)?.checked &&
                              document.getElementById(`check_photo_${deliveryId}`)?.checked &&
                              document.getElementById(`check_intact_${deliveryId}`)?.checked;

            if (!allChecked) {
                return UI.toast('⚠️ Veuillez compléter la checklist', 'warning');
            }

            // Récupérer les notes
            const notes = document.getElementById(`delivery_notes_${deliveryId}`)?.value || '';

            // Mettre à jour la livraison
            CORE.update('deliveries', deliveryId, {
                status: 'livree',
                completedAt: new Date().toISOString(),
                proofPhoto: window._deliveryPhotos[deliveryId].data,
                photoTimestamp: window._deliveryPhotos[deliveryId].timestamp,
                deliveryNotes: notes,
                validatedBy: CORE.state.currentUser.name,
                validationMethod: 'photo',
                deliveredAt: new Date().toISOString()
            });

            UI.closeModal();
            UI.toast(`✅ Livraison ${delivery.orderRef} validée avec photo!`, 'success');

            // Force immediate cloud sync
            CORE.save(true);
            if (typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated() && navigator.onLine) {
                API.syncDirtyToCloud().catch(function(e) { console.warn('[COURIER] Cloud sync after delivery validation failed:', e.message); });
            }

            // Rerender
            setTimeout(() => {
                App.rerender();
            }, 500);
        },

        viewDeliveryProofPhoto(deliveryId) {
            const delivery = CORE.getVisibleDeliveries().find(d => d.id === deliveryId);
            if (!delivery || !delivery.proofPhoto) {
                return UI.toast('Aucune photo de preuve', 'info');
            }

            const modalContent = `
                <div class="space-y-4">
                    ${delivery.proofPhoto ? `<img src="${delivery.proofPhoto}" alt="Preuve de livraison" class="w-full rounded-lg shadow-lg" onerror="this.style.display='none'; if(this.nextElementSibling) this.nextElementSibling.style.display='block'">` : ''}
                    <div class="text-center text-slate-400" ${delivery.proofPhoto ? 'style="display:none"' : ''}>❌ Aucune preuve photo</div>

                    <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-600">📅 Date/Heure:</span>
                            <span class="font-bold">${new Date(delivery.photoTimestamp).toLocaleString('fr-FR')}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">👤 Validé par:</span>
                            <span class="font-bold">${delivery.validatedBy}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-600">📋 Commande:</span>
                            <span class="font-bold">${delivery.orderRef}</span>
                        </div>
                        ${delivery.deliveryNotes ? `<div class="border-t border-slate-200 pt-2 mt-2"><span class="text-slate-600">📝 Notes:</span><p class="font-bold text-slate-900 mt-1">${delivery.deliveryNotes}</p></div>` : ''}
                    </div>
                </div>
            `;

            UI.modal(`📸 Preuve de livraison - ${delivery.orderRef}`, modalContent, [
                { label: 'Télécharger', onclick: 'alert("Téléchargement de la photo...")', class: 'px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition' },
                { label: 'Fermer', onclick: 'UI.closeModal()' }
            ]);
        }
    };

    // =========================================================
    // BOOTSTRAP - Start the application
    // =========================================================
    // ========== MOBILE RESPONSIVE NAVIGATION ==========
    (function() {
        // Create hamburger button
        function hideMobileNav() {
            var h = document.querySelector('.mobile-hamburger'); if (h) h.style.display = 'none';
            var o = document.querySelector('.mobile-sidebar-overlay'); if (o) o.style.display = 'none';
            var b = document.querySelector('.mobile-bottom-nav'); if (b) b.style.display = 'none';
            closeSidebar();
        }
        function showMobileNav() {
            var h = document.querySelector('.mobile-hamburger'); if (h) h.style.display = '';
            var o = document.querySelector('.mobile-sidebar-overlay'); if (o) o.style.display = '';
            var b = document.querySelector('.mobile-bottom-nav'); if (b) b.style.display = '';
        }
        function isLoggedIn() {
            return CORE && CORE.state && CORE.state.currentUser;
        }

        // === P3: SYNC STATUS INDICATOR ===
        var SyncIndicator = {
            _el: null,
            _hideTimer: null,
            _lastSync: null,

            _createEl: function() {
                if (this._el) return this._el;
                var div = document.createElement('div');
                div.id = 'syncIndicator';
                div.title = 'Cloud sync status';
                div.onclick = function() { SyncIndicator.hide(); };
                document.body.appendChild(div);
                this._el = div;
                return div;
            },

            _icons: {
                spinner: '<svg class="sync-icon sync-spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.22-8.56"/></svg>',
                check: '<svg class="sync-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>',
                error: '<svg class="sync-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
                conflict: '<svg class="sync-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
                cloud: '<svg class="sync-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 10h-1.26A8 8 0 109 20h9a5 5 0 000-10z"/></svg>'
            },

            show: function(state, msg) {
                if (!isLoggedIn()) return;
                var el = this._createEl();
                clearTimeout(this._hideTimer);

                // Remove state classes
                el.className = '';
                var icon, text, cls;
                switch(state) {
                    case 'syncing':
                        icon = this._icons.spinner;
                        text = msg || 'Synchronisation...';
                        cls = '';
                        break;
                    case 'success':
                        icon = this._icons.check;
                        text = msg || 'Sync OK';
                        cls = 'sync-ok';
                        this._lastSync = new Date();
                        break;
                    case 'error':
                        icon = this._icons.error;
                        text = msg || 'Erreur sync';
                        cls = 'sync-err';
                        break;
                    case 'conflict':
                        icon = this._icons.conflict;
                        text = msg || 'Conflit de versions';
                        cls = 'sync-conflict';
                        break;
                    default:
                        icon = this._icons.cloud;
                        text = msg || 'Cloud';
                        cls = '';
                }

                el.className = 'visible' + (cls ? ' ' + cls : '');
                var timeStr = this._lastSync ? '<span class="sync-time">' + this._formatTime(this._lastSync) + '</span>' : '';
                el.innerHTML = icon + '<span>' + text + '</span>' + timeStr;

                // Auto-hide after delay for success/error
                if (state === 'success') {
                    this._hideTimer = setTimeout(function() { SyncIndicator.hide(); }, 4000);
                } else if (state === 'error' || state === 'conflict') {
                    this._hideTimer = setTimeout(function() { SyncIndicator.hide(); }, 8000);
                }
            },

            hide: function() {
                if (this._el) {
                    this._el.className = '';
                    this._el.style.display = 'none';
                }
            },

            _formatTime: function(d) {
                if (!d) return '';
                var now = new Date();
                var diff = Math.floor((now - d) / 1000);
                if (diff < 5) return 'maintenant';
                if (diff < 60) return 'il y a ' + diff + 's';
                if (diff < 3600) return 'il y a ' + Math.floor(diff/60) + 'min';
                return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
            },

            getLastSyncText: function() {
                return this._lastSync ? this._formatTime(this._lastSync) : 'jamais';
            }
        };

        // --- FORCE FULL SYNC à manual cloud sync trigger ---
        window.forceFullSync = async function() {
            if (!CORE.state.currentUser) { UI.toast('Veuillez vous connecter d\'abord', 'warning'); return; }
            if (typeof SyncIndicator !== 'undefined') SyncIndicator.show('syncing', 'Synchronisation forcée...');

            // Step 1: Ensure authentication
            if (typeof API === 'undefined') { UI.toast('API non disponible', 'error'); return; }
            if (!API.isAuthenticated || !API.isAuthenticated()) {
                console.log('[FORCE-SYNC] Not authenticated — trying to authenticate...');
                UI.toast('Connexion au cloud en cours...', 'info', 3000);
                var ok = false;
                try { ok = await API._refreshAccessToken(); } catch(e) { console.warn('[FORCE-SYNC] _refreshAccessToken failed:', e.message); }
                if (!ok) try { ok = await API._reLoginWithStoredCreds(); } catch(e) { console.warn('[FORCE-SYNC] _reLoginWithStoredCreds failed:', e.message); }
                // SECURITY: No longer uses stored passwords or hardcoded activation codes.
                // If refresh token fails, user must re-login manually.
                if (!ok) {
                    UI.toast('❌ Impossible de se connecter au cloud. Vérifiez votre connexion internet.', 'error', 8000);
                    if (typeof SyncIndicator !== 'undefined') SyncIndicator.show('error', 'Auth échouée');
                    return;
                }
                API.startProactiveRefresh();
                API.startKeepalive();
            }

            // Step 2: Full bidirectional sync
            try {
                console.log('[FORCE-SYNC] ☁ Pulling from cloud...');
                await API.syncAllFromCloud();
                console.log('[FORCE-SYNC] ☁ Pushing ALL to cloud...');
                await API.syncAllToCloud();
                CORE.clearDirty();
                CORE.clearChangeLog();
                console.log('[FORCE-SYNC] ✅ Full sync complete');
                UI.toast('✅ Synchronisation cloud complète!', 'success', 5000);
                if (typeof SyncIndicator !== 'undefined') SyncIndicator.show('success', 'Sync complète');
                App.rerender();
            } catch(err) {
                console.error('[FORCE-SYNC] ❌ Error:', err.message || err);
                UI.toast('❌ Erreur de synchronisation: ' + (err.message || 'Erreur inconnue'), 'error', 8000);
                if (typeof SyncIndicator !== 'undefined') SyncIndicator.show('error', 'Erreur sync');
            }
        };

        // --- CLOUD STATUS BANNER à shows warning when sync is not active ---
        var CloudStatusBanner = {
            _el: null,
            _checkInterval: null,
            _loginFormVisible: false,

            init: function() {
                this._checkInterval = setInterval(function() { if (document.visibilityState === 'visible') CloudStatusBanner.update(); }, 60000); // PERF: 60s instead of 15s
                setTimeout(function() { CloudStatusBanner.update(); }, 5000);
            },

            update: function() {
                if (!isLoggedIn()) { this.hide(); return; }
                var isAuth = typeof API !== 'undefined' && API.isAuthenticated && API.isAuthenticated();
                var isOnline = navigator.onLine;
                if (isAuth && isOnline) {
                    this.hide();
                } else {
                    this.show(!isOnline ? 'offline' : 'noauth');
                }
            },

            show: function(reason) {
                if (!this._el) {
                    var div = document.createElement('div');
                    div.id = 'cloudStatusBanner';
                    div.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:99999;padding:8px 16px;font-size:13px;font-family:system-ui;display:flex;flex-direction:column;align-items:center;gap:6px;transition:all 0.3s;';
                    document.body.appendChild(div);
                    this._el = div;
                }
                if (reason === 'offline') {
                    this._el.style.background = '#fef3c7';
                    this._el.style.color = '#92400e';
                    this._el.innerHTML = '<div style="display:flex;align-items:center;gap:8px;">⚠ Mode hors-ligne à les données ne sont pas synchronisées</div>';
                } else {
                    this._el.style.background = '#fee2e2';
                    this._el.style.color = '#991b1b';
                    this._el.innerHTML = '<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:center;">'
                        + '⚠ Cloud non connecté à vos données ne sont PAS synchronisées '
                        + '<button onclick="CloudStatusBanner.toggleLogin()" style="background:#991b1b;color:white;border:none;padding:3px 12px;border-radius:4px;font-size:12px;cursor:pointer;font-weight:600;">Se reconnecter</button>'
                        + '</div>'
                        + '<div id="cloudLoginForm" style="display:none;width:100%;max-width:500px;">'
                        + '<form onsubmit="CloudStatusBanner.doLogin(event)" style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:center;">'
                        + '<input id="cloud-email" type="email" placeholder="Email" style="padding:4px 8px;border:1px solid #fca5a5;border-radius:4px;font-size:12px;width:160px;" required>'
                        + '<input id="cloud-password" type="password" placeholder="Mot de passe" style="padding:4px 8px;border:1px solid #fca5a5;border-radius:4px;font-size:12px;width:140px;" required>'
                        + '<button type="submit" id="cloud-login-btn" style="background:#16a34a;color:white;border:none;padding:4px 14px;border-radius:4px;font-size:12px;cursor:pointer;font-weight:700;">Connecter + Synchroniser</button>'
                        + '</form>'
                        + '<div id="cloud-login-status" style="font-size:11px;margin-top:4px;text-align:center;"></div>'
                        + '</div>';
                    // Pre-fill email from current user
                    var emailInput = document.getElementById('cloud-email');
                    if (emailInput && CORE.state.currentUser) {
                        emailInput.value = CORE.state.currentUser.email || CORE.state.currentUser.username || '';
                    }
                }
                this._el.style.display = 'flex';
            },

            toggleLogin: function() {
                var form = document.getElementById('cloudLoginForm');
                if (form) {
                    this._loginFormVisible = !this._loginFormVisible;
                    form.style.display = this._loginFormVisible ? 'block' : 'none';
                    if (this._loginFormVisible) {
                        var pwInput = document.getElementById('cloud-password');
                        if (pwInput) pwInput.focus();
                    }
                }
            },

            doLogin: async function(e) {
                if (e) e.preventDefault();
                var email = (document.getElementById('cloud-email')?.value || '').trim();
                var password = (document.getElementById('cloud-password')?.value || '').trim();
                var statusEl = document.getElementById('cloud-login-status');
                var btn = document.getElementById('cloud-login-btn');
                if (!email || !password) return;

                if (statusEl) { statusEl.textContent = 'Connexion en cours...'; statusEl.style.color = '#1d4ed8'; }
                if (btn) { btn.disabled = true; btn.textContent = 'Connexion...'; }

                try {
                    // Step 1: Login to API
                    var result = await API.login(email, password);
                    if (!result || !result.accessToken) throw new Error('Pas de token reçu');

                    if (statusEl) { statusEl.textContent = '✅ Connecté! Synchronisation en cours...'; statusEl.style.color = '#16a34a'; }

                    // Step 2: Set tenant
                    if (result.user && result.user.tenantId) {
                        try { API.tenantId = String(result.user.tenantId); } catch(e) { console.warn('[FORCE-SYNC] Failed to set API.tenantId:', e); }
                    }

                    // Step 3: Start proactive refresh + keepalive
                    API.startProactiveRefresh();
                    API.startKeepalive();

                    // Step 4: FULL BIDIRECTIONAL SYNC
                    try { await API.syncAllFromCloud(); } catch(e) { console.warn('[BANNER-LOGIN] Pull failed:', e.message); }
                    try { await API.syncAllToCloud(); } catch(e) { console.warn('[BANNER-LOGIN] Push failed:', e.message); }
                    CORE.clearDirty();
                    CORE.clearChangeLog();

                    if (statusEl) { statusEl.textContent = '✅ Synchronisation complète!'; }
                    UI.toast('✅ Cloud connecté et synchronisé!', 'success', 5000);

                    // Hide banner after success
                    setTimeout(function() { CloudStatusBanner.hide(); CloudStatusBanner._loginFormVisible = false; }, 2000);
                    App.rerender();
                } catch(err) {
                    console.error('[BANNER-LOGIN] Failed:', err.message || err);
                    if (statusEl) { statusEl.textContent = '❌ ' + (err.message || 'Erreur de connexion'); statusEl.style.color = '#dc2626'; }
                    if (btn) { btn.disabled = false; btn.textContent = 'Connecter + Synchroniser'; }
                }
            },

            hide: function() {
                if (this._el) { this._el.style.display = 'none'; this._loginFormVisible = false; }
            }
        };

        CloudStatusBanner.init();

        function createHamburger() {
            if (!isLoggedIn()) { hideMobileNav(); return; }
            // Pas de hamburger pour le livreur (pas de sidebar)
            if (CORE.state.currentUser?.role === 'livreur') {
                var existing = document.querySelector('.mobile-hamburger');
                if (existing) existing.style.display = 'none';
                return;
            }
            if (document.querySelector('.mobile-hamburger')) { showMobileNav(); return; }
            var btn = document.createElement('button');
            btn.className = 'mobile-hamburger';
            btn.setAttribute('aria-label', 'Menu');
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>';
            btn.onclick = function() { toggleSidebar(); };
            document.body.appendChild(btn);
        }

        // Create overlay
        function createOverlay() {
            if (!isLoggedIn()) return;
            if (document.querySelector('.mobile-sidebar-overlay')) return;
            var overlay = document.createElement('div');
            overlay.className = 'mobile-sidebar-overlay';
            overlay.onclick = function() { closeSidebar(); };
            document.body.appendChild(overlay);
        }

        // Create bottom nav
        function createBottomNav() {
            if (!isLoggedIn()) return;
            if (document.querySelector('.mobile-bottom-nav')) return;
            var nav = document.createElement('div');
            nav.className = 'mobile-bottom-nav';
            nav.id = 'mobileBottomNav';
            document.body.appendChild(nav);
            updateBottomNav();
        }

        function updateBottomNav() {
            var nav = document.getElementById('mobileBottomNav');
            if (!nav) return;
            var mod = null;
            var modName = '';
            if (typeof App !== 'undefined' && App.getActiveModule) mod = App.getActiveModule();
            if (!mod) return;
            // Detect module type by checking available methods
            var items = [];
            var pendingOrders = (CORE.db.orders || []).filter(function(o) { return o.status === 'pending' || o.status === 'new'; }).length;
            var pendingTransfers = (CORE.db.transferReceipts || []).filter(function(t) { return t.status === 'pending'; }).length;
            var pendingDeliveries = (CORE.getVisibleDeliveries ? CORE.getVisibleDeliveries().filter(function(d) { return d.status === 'pending' || d.status === 'assigned'; }).length : 0);
            var unreadNotifs = CORE.getUnreadNotificationCount();

            if (mod === VendeurModule || (typeof VendeurModule !== 'undefined' && mod.state && mod.state.posMode !== undefined)) {
                modName = 'VendeurModule';
                items = [
                    { view: 'dashboard', icon: 'layout-grid', label: 'Accueil', badge: unreadNotifs },
                    { view: 'pos', icon: 'shopping-cart', label: 'Vente' },
                    { view: 'clients', icon: 'users', label: 'Clients' },
                    { view: 'orders', icon: 'receipt', label: 'Commandes', badge: pendingOrders },
                    { view: 'stock', icon: 'package', label: 'Stock', badge: pendingTransfers }
                ];
            } else if (typeof ManagerModule !== 'undefined' && mod === ManagerModule) {
                modName = 'ManagerModule';
                items = [
                    { view: 'dashboard', icon: 'layout-grid', label: 'Accueil', badge: unreadNotifs },
                    { view: 'pos', icon: 'store', label: 'PDV' },
                    { view: 'commandes', icon: 'shopping-cart', label: 'Commandes', badge: pendingOrders },
                    { view: 'inventory', icon: 'box', label: 'Stock', badge: pendingTransfers },
                    { view: 'finance', icon: 'wallet', label: 'Finance' }
                ];
            } else if (typeof PDGModule !== 'undefined' && mod === PDGModule) {
                modName = 'PDGModule';
                items = [
                    { view: 'overview', icon: 'layout-grid', label: 'Accueil', badge: unreadNotifs },
                    { view: 'commandes', icon: 'shopping-cart', label: 'Commandes', badge: pendingOrders },
                    { view: 'deliveries', icon: 'truck', label: 'Livraisons', badge: pendingDeliveries },
                    { view: 'finance', icon: 'wallet', label: 'Finance' },
                    { view: 'reports', icon: 'bar-chart-2', label: 'Rapports' }
                ];
            } else if (typeof GestionnaireModule !== 'undefined' && mod === GestionnaireModule) {
                modName = 'GestionnaireModule';
                items = [
                    { view: 'dashboard', icon: 'layout-grid', label: 'Accueil', badge: unreadNotifs },
                    { view: 'stocks', icon: 'package', label: 'Stocks', badge: pendingTransfers },
                    { view: 'deliveries', icon: 'truck', label: 'Livraisons', badge: pendingDeliveries },
                    { view: 'team', icon: 'users', label: 'Équipe' },
                    { view: 'finance', icon: 'wallet', label: 'Finance' }
                ];
            } else {
                return;
            }
            var currentView = mod.state ? mod.state.currentView : '';
            nav.innerHTML = items.map(function(item) {
                var isActive = currentView === item.view;
                var badgeHtml = (item.badge && item.badge > 0) ? '<span style="position:absolute;top:2px;right:50%;transform:translateX(14px);min-width:16px;height:16px;background:#ef4444;color:#fff;font-size:10px;font-weight:800;border-radius:9999px;display:flex;align-items:center;justify-content:center;padding:0 4px;animation:pulse 2s infinite;box-shadow:0 0 8px rgba(239,68,68,0.4);">' + (item.badge > 99 ? '99+' : item.badge) + '</span>' : '';
                return '<button style="position:relative;" class="' + (isActive ? 'active' : '') + '" onclick="' + (modName || 'App.getActiveModule()') + '.navigateTo(\'' + item.view + '\'); closeSidebar();">' +
                    badgeHtml +
                    '<i data-lucide="' + item.icon + '"></i>' +
                    '<span>' + item.label + '</span>' +
                '</button>';
            }).join('');
            if (typeof lucide !== 'undefined') setTimeout(function() { lucide.createIcons(); }, 50);
        }

        function toggleSidebar() {
            var aside = document.querySelector('aside');
            if (!aside) return;
            var overlay = document.querySelector('.mobile-sidebar-overlay');
            aside.classList.toggle('mobile-open');
            if (overlay) overlay.classList.toggle('active', aside.classList.contains('mobile-open'));
        }

        function closeSidebar() {
            var aside = document.querySelector('aside');
            if (!aside) return;
            aside.classList.remove('mobile-open');
            var overlay = document.querySelector('.mobile-sidebar-overlay');
            if (overlay) overlay.classList.remove('active');
        }

        // Make closeSidebar global
        window.closeSidebar = closeSidebar;
        window.toggleSidebar = toggleSidebar;

        // Intercept navigation to close sidebar and update bottom nav
        var origRerender = App.rerender;
        App.rerender = function() {
            origRerender.call(App);
            setTimeout(function() {
                createHamburger();
                createOverlay();
                createBottomNav();
                // Auto-close sidebar on nav click
                closeSidebar();
            }, 100);
        };

        // Also hook into navigateTo for each module
        ['VendeurModule','ManagerModule','PDGModule','GestionnaireModule'].forEach(function(name) {
            try {
                var mod = window[name];
                if (mod && mod.navigateTo) {
                    var origNav = mod.navigateTo.bind(mod);
                    mod.navigateTo = function(view) {
                        origNav(view);
                        closeSidebar();
                        setTimeout(updateBottomNav, 150);
                    };
                }
            } catch(e) {}
        });

        // Initialize on first load
        setTimeout(function() {
            createHamburger();
            createOverlay();
            createBottomNav();
        }, 500);

        // Re-init on resize
        window.addEventListener('resize', function() {
            if (window.innerWidth >= 1024) {
                closeSidebar();
            }
        });
    })();

    // Charger la langue sauvegardée avant le rendu initial
    i18n.loadLang();

    App.init();
</script>

<!-- PWA Service Worker Registration -->
<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(reg => {
                console.log('[PWA] Service Worker enregistré:', reg.scope);
                // Check for updates every 30 minutes
                setInterval(() => reg.update(), 30 * 60 * 1000);
            })
            .catch(err => console.warn('[PWA] Erreur SW:', err));
    });
}

// PWA Install Prompt
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    // Show install button after 3 seconds if not already installed
    setTimeout(() => {
        if (deferredPrompt && !window.matchMedia('(display-mode: standalone)').matches) {
            showInstallBanner();
        }
    }, 3000);
});

function showInstallBanner() {
    const existing = document.getElementById('pwa-install-banner');
    if (existing) return;
    const banner = document.createElement('div');
    banner.id = 'pwa-install-banner';
    banner.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#059669,#047857);color:white;padding:14px 24px;border-radius:16px;display:flex;align-items:center;gap:14px;z-index:99999;box-shadow:0 8px 32px rgba(5,150,105,0.4);max-width:90vw;font-family:Inter,sans-serif;animation:slideUp 0.4s ease;';
    banner.innerHTML = '<div style="font-size:32px;">📲</div>'
        + '<div style="flex:1;">'
        + '<div style="font-weight:700;font-size:15px;">Installer RAYA OS</div>'
        + '<div style="font-size:12px;opacity:0.9;margin-top:2px;">Accédez à l\'app directement depuis votre écran d\'accueil</div>'
        + '</div>'
        + '<button id="pwa-install-btn" style="background:white;color:#059669;border:none;border-radius:10px;padding:10px 18px;font-weight:700;font-size:13px;cursor:pointer;white-space:nowrap;">Installer</button>'
        + '<button id="pwa-dismiss-btn" style="background:none;border:none;color:white;font-size:20px;cursor:pointer;padding:4px;opacity:0.7;" title="Fermer">✕</button>';

    // Add slide-up animation
    const style = document.createElement('style');
    style.textContent = '@keyframes slideUp{from{transform:translateX(-50%) translateY(100px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}';
    document.head.appendChild(style);

    document.body.appendChild(banner);

    document.getElementById('pwa-install-btn').addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const result = await deferredPrompt.userChoice;
            if (result.outcome === 'accepted') {
                console.log('[PWA] Installation acceptée');
            }
            deferredPrompt = null;
        }
        banner.remove();
    });

    document.getElementById('pwa-dismiss-btn').addEventListener('click', () => {
        banner.remove();
        // Don't show again for 7 days
        localStorage.setItem('pwa_dismiss_time', Date.now().toString());
    });
}

// Don't show banner if dismissed recently
window.addEventListener('beforeinstallprompt', () => {
    const dismissTime = localStorage.getItem('pwa_dismiss_time');
    if (dismissTime && (Date.now() - parseInt(dismissTime)) < 7 * 24 * 60 * 60 * 1000) {
        deferredPrompt = null;
    }
});

// Detect if running as installed app
window.addEventListener('appinstalled', () => {
    console.log('[PWA] App installée avec succès!');
    deferredPrompt = null;
    const banner = document.getElementById('pwa-install-banner');
    if (banner) banner.remove();
});
</script>
</body>
</html>
